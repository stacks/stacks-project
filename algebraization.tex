\input{preamble}

% OK, start here.
%
\begin{document}

\title{Algebraic and Formal Geometry}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter continues the study of formal algebraic geometry
and in particular the question of whether a formal object is
the completion of an algebraic one. A fundamental reference is \cite{SGA2}.
Here is a list of results we have already discussed
in the Stacks project:
\begin{enumerate}
\item The theorem on formal functions, see
Cohomology of Schemes, Section \ref{coherent-section-theorem-formal-functions}.
\item Coherent formal modules, see
Cohomology of Schemes, Section \ref{coherent-section-coherent-formal}.
\item Grothendieck's existence theorem, see
Cohomology of Schemes, Sections \ref{coherent-section-existence},
\ref{coherent-section-existence-proper}, and
\ref{coherent-section-existence-proper-support}.
\item Grothendieck's algebraization theorem, see
Cohomology of Schemes, Section \ref{coherent-section-algebraization}.
\item Grothendieck's existence theorem more generally, see
More on Flatness, Sections \ref{flat-section-existence} and
\ref{flat-section-existence-derived}.
\end{enumerate}
Let us give an overview of the contents of this chapter.

\medskip\noindent
Let $X$ be a scheme and let $\mathcal{I} \subset \mathcal{O}_X$
be a finite type quasi-coherent sheaf of ideals. Many questions
in this chapter have to do with inverse systems $(\mathcal{F}_n)$
of quasi-coherent $\mathcal{O}_X$-modules such that
$\mathcal{F}_n = \mathcal{F}_{n + 1}/\mathcal{I}^n\mathcal{F}_{n + 1}$.
An important special case is where $X$ is a scheme over a Noetherian
ring $A$ and $\mathcal{I} = I \mathcal{O}_X$ for some ideal $I \subset A$.
In Section \ref{section-ML-degree-zero}
we prove some elementary results on such systems of coherent modules.
In Section \ref{section-formal-functions-principal} we discuss
additional results when $I = (f)$ is a principal. In Section
\ref{section-formal-sections-cd-one} we work in the slightly
more general setting where $\text{cd}(A, I) = 1$. One of the themes
of this chapter will be to show that results proven in the case $I = (f)$
also hold true when we only assume $\text{cd}(A, I) = 1$.

\medskip\noindent
In Section \ref{section-derived-completion} we discuss derived completion
of modules on a ringed site $(\mathcal{C}, \mathcal{O})$
with respect to a finite type sheaf of ideals $\mathcal{I}$.
This section is the natural continuation of the theory of derived completion
in commutative algebra as described in
More on Algebra, Section \ref{more-algebra-section-derived-completion}.
The first main result is that derived completion exists.
The second main result is that for a morphism $f$ if ringed sites
derived completion commutes with derived pushforward:
$$
(Rf_*K)^\wedge = Rf_*(K^\wedge)
$$
if the ideal sheaf upstairs is locally generated by sections coming
from the ideal downstairs, see
Lemma \ref{lemma-pushforward-commutes-with-derived-completion}.
We stress that both main results are very elementary in case the
ideals in question are globally finitely generated which will
be true for all applications of this theory in this chapter.
The displayed equality is the ``correct'' version of the
theorem on formal functions, see discussion in
Section \ref{section-formal-functions}.

\medskip\noindent
Let $A$ be a Noetherian ring and let $I, J$ be two ideals of $A$.
Let $M$ be a finite $A$-module.
The next topic in this chapter is the map
$$
R\Gamma_J(M) \longrightarrow R\Gamma_J(M)^\wedge
$$
from local cohomology of $M$ into the derived $I$-adic completion
of the same. It turns out that if we impose suitable depth conditions
this map becomes an isomorphism on cohomology in a range of degrees.
In Section \ref{section-algebraization-sections-general}
we work essentially in the generality just mentioned.
In Section \ref{section-algebraization-punctured}
we assume $A$ is a local ring and $J = \mathfrak m$ is a maximal ideal.
We encourage the reader to read this section before the other two in
this part of the chapter.
Finally, in Section \ref{section-bootstrap} we bootstrap
the local case to obtain stronger results back in the general case.

\medskip\noindent
In the next part of this chapter we use the results on
completion of local cohomology to get a nonexhaustive list of results on
cohomology of the completion of coherent modules.
More precisely, let $A$ be a Noetherian ring, let $I \subset A$
be an ideal, and let $U \subset \Spec(A)$ be an open subscheme.
If $\mathcal{F}$ is a coherent $\mathcal{O}_U$-module, then
we may consider the maps
$$
H^i(U, \mathcal{F}) \longrightarrow \lim H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
and ask if we get an isomorphism in a certain range of degrees.
In Section \ref{section-algebraization-sections}
we work out some examples where $U$ is the punctured spectrum
of a local ring. In Section \ref{section-algebraization-sections-coherent}
we discuss the general case.
In Section \ref{section-connected} we apply some of the results
obtained to questions of connectedness in algebraic geometry.

\medskip\noindent
The remaining sections of this chapter are devoted to a discussion
of algebraization of coherent formal modules. In other words, given
an inverse system of coherent modules $(\mathcal{F}_n)$ on $U$
as above with
$\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$
we ask whether there exists a coherent $\mathcal{O}_U$-module
$\mathcal{F}$ such that
$\mathcal{F}_n = \mathcal{F}/I^n\mathcal{F}$
for all $n$. We encourage the reader to read
Section \ref{section-algebraization-modules}
for a precise statement of the question, a useful general result
(Lemma \ref{lemma-when-done}), and a nontrivial application
(Lemma \ref{lemma-algebraization-principal-variant}).
To prove a result going essentially beyond this case
quite a bit more theory has to be developed.
Please see Section \ref{section-algebraization-modules-conclusion}
for the strongest results of this type obtained in this chapter.



\section{Formal sections, I}
\label{section-ML-degree-zero}

\noindent
Let $A$ be a ring and $I \subset A$ an ideal. Let $X$ be a scheme
over $\Spec(A)$. In this section we prove some general facts on inverse
systems of $\mathcal{O}_X$-modules $\{\mathcal{F}_n\}$ such that
$\mathcal{F}_n = \mathcal{F}_{n + 1} / I^n \mathcal{F}_{n + 1}$.
In particular, we prove two lemmas on the behaviour of the inverse system
$\{H^0(X, \mathcal{F}_n)\}$.
These results have generalizations to higher cohomology groups
which we will add here if we need them.

\begin{lemma}
\label{lemma-ML-general}
Let $I$ be an ideal of a ring $A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules
such that $\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$.
Assume
$$
\bigoplus\nolimits_{n \geq 0} H^1(X, I^n\mathcal{F}_{n + 1})
$$
satisfies the ascending chain condition as a graded
$\bigoplus_{n \geq 0} I^n/I^{n + 1}$-module.
Then the inverse system $M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the
Mittag-Leffler condition.
\end{lemma}

\begin{proof}
Set $H^1_n = H^1(X, I^n\mathcal{F}_{n + 1})$ and let
$\delta_n : M_n \to H^1_n$ be the boundary map on cohomology. Then
$\bigoplus \Im(\delta_n) \subset \bigoplus H^1_n$ is a graded submodule.
Namely, if $s \in M_n$ and $f \in I^m$, then we have a commutative diagram
$$
\xymatrix{
0 \ar[r] &
I^n\mathcal{F}_{n + 1} \ar[d]_f \ar[r] &
\mathcal{F}_{n + 1} \ar[d]_f \ar[r] &
\mathcal{F}_n \ar[d]_f \ar[r] & 0 \\
0 \ar[r] &
I^{n + m}\mathcal{F}_{n + m + 1} \ar[r] &
\mathcal{F}_{n + m + 1} \ar[r] &
\mathcal{F}_{n + m} \ar[r] & 0
}
$$
The middle vertical map is given by lifting a local section of
$\mathcal{F}_{n + 1}$ to a section of $\mathcal{F}_{n + m + 1}$
and then multiplying by $f$; similarly for the other vertical arrows.
We conclude that $\delta_{n + m}(fs) = f \delta_n(s)$.
By assumption we can find $s_j \in M_{n_j}$, $j = 1, \ldots, N$
such that $\delta_{n_j}(s_j)$
generate $\bigoplus \Im(\delta_n)$ as a graded module. Let $n > c = \max(n_j)$.
Let $s \in M_n$. Then we can find $f_j \in I^{n - n_j}$ such that
$\delta_n(s) = \sum f_j \delta_{n_j}(s_j)$. We conclude that
$\delta(s - \sum f_j s_j) = 0$, i.e., we can find $s' \in M_{n + 1}$
mapping to $s - \sum f_js_j$ in $M_n$. It follows that
$$
\Im(M_{n + 1} \to M_{n - c}) = \Im(M_n \to M_{n - c})
$$
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-ML-general-better}
Let $I$ be an ideal of a ring $A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules
such that $\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$.
Given $n$ define
$$
H^1_n =
\bigcap\nolimits_{m \geq n}
\Im\left(
H^1(X, I^n\mathcal{F}_{m + 1}) \to H^1(X, I^n\mathcal{F}_{n + 1})
\right)
$$
If $\bigoplus H^1_n$ satisfies the ascending chain condition as a graded
$\bigoplus_{n \geq 0} I^n/I^{n + 1}$-module, then the inverse system
$M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the Mittag-Leffler condition.
\end{lemma}

\begin{proof}
The proof is exactly the same as the proof of Lemma \ref{lemma-ML-general}.
In fact, the result will follow from the arguments given there
as soon as we show that
$\bigoplus H^1_n$ is a graded $\bigoplus_{n \geq 0} I^n/I^{n + 1}$-submodule
of $\bigoplus H^1(X, I^n\mathcal{F}_{n + 1})$
and that the boundary maps $\delta_n$ have image contained in $H^1_n$.

\medskip\noindent
Suppose that $\xi \in H^1_n$ and $f \in I^k$.
Choose $m \gg n + k$. Choose
$\xi' \in H^1(X, I^n\mathcal{F}_{m + 1})$ lifting
$\xi$. We consider the diagram
$$
\xymatrix{
0 \ar[r] &
I^n\mathcal{F}_{m + 1} \ar[d]_f \ar[r] &
\mathcal{F}_{m + 1} \ar[d]_f \ar[r] &
\mathcal{F}_n \ar[d]_f \ar[r] & 0 \\
0 \ar[r] &
I^{n + k}\mathcal{F}_{m + 1} \ar[r] &
\mathcal{F}_{m + 1} \ar[r] &
\mathcal{F}_{n + k} \ar[r] & 0
}
$$
constructed as in the proof of Lemma \ref{lemma-ML-general}.
We get an induced map on cohomology and we see that
$f \xi' \in H^1(X, I^{n + k}\mathcal{F}_{m + 1})$
maps to $f \xi$. Since this is true for all $m \gg n + k$
we see that $f\xi$ is in $H^1_{n + k}$ as desired.

\medskip\noindent
To see the boundary maps $\delta_n$ have image contained in $H^1_n$
we consider the diagrams
$$
\xymatrix{
0 \ar[r] &
I^n\mathcal{F}_{m + 1} \ar[d] \ar[r] &
\mathcal{F}_{m + 1} \ar[d] \ar[r] &
\mathcal{F}_n \ar[d] \ar[r] & 0 \\
0 \ar[r] &
I^n\mathcal{F}_{n + 1} \ar[r] &
\mathcal{F}_{n + 1} \ar[r] &
\mathcal{F}_n \ar[r] & 0
}
$$
for $m \geq n$. Looking at the induced maps on cohomology we conclude.
\end{proof}

\begin{lemma}
\label{lemma-topology-I-adic-general}
Let $I$ be a finitely generated ideal of a ring $A$.
Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules such that
$\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$. Assume
$$
\bigoplus\nolimits_{n \geq 0} H^0(X, I^n\mathcal{F}_{n + 1})
$$
satisfies the ascending chain condition as a graded
$\bigoplus_{n \geq 0} I^n/I^{n + 1}$-module.
Then the limit topology on $M = \lim \Gamma(X, \mathcal{F}_n)$
is the $I$-adic topology.
\end{lemma}

\begin{proof}
Set $F^n = \Ker(M \to H^0(X, \mathcal{F}_n))$ for $n \geq 1$ and $F^0 = M$.
Observe that $I F^n \subset F^{n + 1}$. In particular $I^n M \subset F^n$
and we are trying to show that given $n$
there exists an $m \geq n$ such that $F^m \subset I^nM$.
We have an injective map of graded modules
$$
\bigoplus\nolimits_{n \geq 0} F^n/F^{n + 1}
\longrightarrow
\bigoplus\nolimits_{n \geq 0} H^0(X, I^n\mathcal{F}_{n + 1})
$$
By assumption the left hand side is generated by finitely many
homogeneous elements. Hence we can find $r$ and
$c_1, \ldots, c_r \geq 0$ and $a_i \in F^{c_i}$ whose
images in $\bigoplus F^n/F^{n + 1}$ generate.
Set $c = \max(c_i)$.

\medskip\noindent
For $n \geq c$ we claim that $I F^n = F^{n + 1}$.
Namely, suppose $a \in F^{n + 1}$. The image of
$a$ in $F^{n + 1}/F^{n + 2}$ is a linear combination
of our $a_i$. Therefore $a  - \sum f_i a_i \in F^{n + 2}$
for some $f_i \in I^{n + 1 - c_i}$. Since
$I^{n + 1 - c_i} = I \cdot I^{n - c_i}$ as $n \geq c_i$ we can write
$f_i = \sum g_{i, j} h_{i, j}$ with $g_{i, j} \in I$
and $h_{i, j}a_i \in F^n$. Thus we see that
$F^{n + 1} = F^{n + 2} + IF^n$.
A simple induction argument gives $F^{n + 1} = F^{n + e} + IF^n$
for all $e > 0$. It follows that $IF^n$ is dense in $F^{n + 1}$.
Choose generators $k_1, \ldots, k_r$ of $I$ and consider
the continuous map
$$
u : (F^n)^{\oplus r} \longrightarrow F^{n + 1},\quad
(x_1, \ldots, x_r) \mapsto \sum k_i x_i
$$
(in the limit topology).
By the above the image of $(F^m)^{\oplus r}$ under $u$ is dense in
$F^{m + 1}$ for all $m \geq n$. By the open mapping lemma
(More on Algebra, Lemma \ref{more-algebra-lemma-open-mapping}) we find
that $u$ is open. Hence $u$ is surjective. Hence $IF^n = F^{n + 1}$
for $n \geq c$. This concludes the proof.
\end{proof}

\begin{lemma}
\label{lemma-properties-system}
Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of quasi-coherent $\mathcal{O}_X$-modules
such that
$\mathcal{F}_n = \mathcal{F}_{n + 1}/\mathcal{I}^n\mathcal{F}_{n + 1}$.
Set $\mathcal{F} = \lim \mathcal{F}_n$. Then
\begin{enumerate}
\item $\mathcal{F} = R\lim \mathcal{F}_n$,
\item for any affine open $U \subset X$ we have
$H^p(U, \mathcal{F}) = 0$ for $p > 0$, and
\item for each $p$ there is a short exact sequence
$0 \to R^1\lim H^{p - 1}(X, \mathcal{F}_n) \to
H^p(X, \mathcal{F}) \to \lim H^p(X, \mathcal{F}_n) \to 0$.
\end{enumerate}
If moreover $\mathcal{I}$ is of finite type, then
\begin{enumerate}
\item[(4)]
$\mathcal{F}_n = \mathcal{F}/\mathcal{I}^n\mathcal{F}$, and
\item[(5)]
$\mathcal{I}^n \mathcal{F} = \lim_{m \geq n} \mathcal{I}^n\mathcal{F}_m$.
\end{enumerate}
\end{lemma}

\begin{proof}
Parts (1), (2), and (3) are general facts about inverse systems of
quasi-coherent modules with surjective transition maps, see
Derived Categories of Schemes, Lemma \ref{perfect-lemma-Rlim-quasi-coherent}
and Cohomology, Lemma \ref{cohomology-lemma-RGamma-commutes-with-Rlim}.
Next, assume $\mathcal{I}$ is of finite type.
Let $U \subset X$ be affine open. Say $U = \Spec(A)$ and $\mathcal{I}|_U$
corresponds to $I \subset A$. Observe that $I$ is a finitely generated ideal.
By the equivalence of categories between quasi-coherent $\mathcal{O}_U$-modules
and $A$-modules (Schemes, Lemma \ref{schemes-lemma-equivalence-quasi-coherent})
we find that $M_n = \mathcal{F}_n(U)$ is an inverse system
of $A$-modules with $M_n = M_{n + 1}/I^nM_{n + 1}$. Thus
$$
M = \mathcal{F}(U) = \lim \mathcal{F}_n(U) = \lim M_n
$$
is an $I$-adically complete module with $M/I^nM = M_n$ by
Algebra, Lemma \ref{algebra-lemma-limit-complete}. This proves (4).
Part (5) translates into the statement that
$\lim_{m \geq n} I^nM/I^mM = I^nM$.
Since $I^mM = I^{m - n} \cdot I^nM$ this is just the statement that
$I^mM$ is $I$-adically complete. This follows from
Algebra, Lemma \ref{algebra-lemma-hathat-finitely-generated}
and the fact that $M$ is complete.
\end{proof}





\section{Formal sections, II}
\label{section-formal-functions-principal}

\noindent
In this section we ask if completion and taking cohomology commute
for sheaves of modules on schemes over an affine base $A$ when completion
is with respect to a principal ideal in $A$. Of course, we have already
discussed the theorem on formal functions in
Cohomology of Schemes, Section \ref{coherent-section-theorem-formal-functions}.
Moreover, we will see in Section \ref{section-formal-functions}
that derived completion commutes with derived cohomology in great generality.
In this section we just collect a few simple special cases of this material
that will help us with future developments.

\begin{lemma}
\label{lemma-equivalent-f-good}
Let $(X, \mathcal{O}_X)$ be a ringed space.
Let $f \in \Gamma(X, \mathcal{O}_X)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be inverse system of $\mathcal{O}_X$-modules.
The following are equivalent
\begin{enumerate}
\item for all $n \geq 1$ the map
$f : \mathcal{F}_{n + 1} \to \mathcal{F}_{n + 1}$ factors
through $\mathcal{F}_{n + 1} \to \mathcal{F}_n$ to give a
short exact sequence
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_1 \to 0$,
\item for all $n \geq 1$ the map
$f^n : \mathcal{F}_{n + 1} \to \mathcal{F}_{n + 1}$
factors through $\mathcal{F}_{n + 1} \to \mathcal{F}_1$
to give a short exact sequence
$0 \to \mathcal{F}_1 \to \mathcal{F}_{n + 1} \to \mathcal{F}_n \to 0$
\item there exists an $\mathcal{O}_X$-module $\mathcal{G}$
which is $f$-divisible such that $\mathcal{F}_n = \mathcal{G}[f^n]$.
\end{enumerate}
If $X$ is a scheme and $\mathcal{F}_n$ is quasi-coherent, then these
are also equivalent to
\begin{enumerate}
\item[(4)] there exists an $\mathcal{O}_X$-module $\mathcal{F}$
which is $f$-torsion free such that
$\mathcal{F}_n = \mathcal{F}/f^n\mathcal{F}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We omit the proof of the equivalence of (1) and (2).
The condition that $\mathcal{G}$ is $f$-divisible means that
$f : \mathcal{G} \to \mathcal{G}$ is surjective.
Thus given $\mathcal{F}_n$ as in (1) we set
$\mathcal{G} = \colim \mathcal{F}_n$ where the maps
$\mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to \ldots$
are as in (1). This produces an $f$-divisible $\mathcal{O}_X$-module
with $\mathcal{F}_n = \mathcal{G}[f^n]$ as can be seen by
checking on stalks.
The condition that $\mathcal{F}$ is $f$-torsion free means that
$f : \mathcal{F} \to \mathcal{F}$ is injective.
If $X$ is a scheme and $\mathcal{F}_n$ is quasi-coherent,
then we set $\mathcal{F} = \lim \mathcal{F}_n$. Namely, for an
affine open $U \subset X$ the transition maps
$\mathcal{F}_{n + 1}(U) \to \mathcal{F}_n(U)$ are surjective
by vanishing of higher cohomology. This produces an $f$-torsion free
$\mathcal{O}_X$-module with
$\mathcal{F}_n = \mathcal{F}/f^n\mathcal{F}$
(Lemma \ref{lemma-properties-system}).
\end{proof}

\begin{lemma}
\label{lemma-topology-I-adic-f}
Suppose $X$, $f$, $(\mathcal{F}_n)$ is as in
Lemma \ref{lemma-equivalent-f-good}. Then the limit topology on
$H^p = \lim H^p(X, \mathcal{F}_n)$ is the $f$-adic topology.
\end{lemma}

\begin{proof}
Namely, it is clear that $f^t H^p$ maps to zero in $H^p(X, \mathcal{F}_t)$.
On the other hand, let $c \geq 1$. If $\xi = (\xi_n) \in H^p$ is small in the
limit topology, then $\xi_c = 0$, and hence $\xi_n$
maps to zero in $H^p(X, \mathcal{F}_c)$ for $n \geq c$.
Consider the inverse system of short exact sequences
$$
0 \to \mathcal{F}_{n - c} \xrightarrow{f^c} \mathcal{F}_n \to
\mathcal{F}_c \to 0
$$
and the corresponding inverse system of long exact cohomology sequences
$$
H^{p - 1}(X, \mathcal{F}_c) \to
H^p(X, \mathcal{F}_{n - c}) \to
H^p(X, \mathcal{F}_n) \to
H^p(X, \mathcal{F}_c)
$$
Since the term $H^{p - 1}(X, \mathcal{F}_c)$ is independent of
$n$ we can choose a compatible sequence of elements
$\xi'_n \in H^1(X, \mathcal{F}_{n - c})$
lifting $\xi_n$. Setting $\xi' = (\xi'_n)$ we see that
$\xi = f^{c + 1} \xi'$. This even shows that
$f^c H^p = \Ker(H^p \to H^p(X, \mathcal{F}_c))$ on the nose.
\end{proof}

\begin{lemma}
\label{lemma-limit-finite}
Let $A$ be a Noetherian ring complete with respect to a principal ideal $(f)$.
Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules. Assume
\begin{enumerate}
\item $\Gamma(X, \mathcal{F}_1)$ is a finite $A$-module,
\item the equivalent conditions of Lemma \ref{lemma-equivalent-f-good} hold.
\end{enumerate}
Then
$$
M = \lim \Gamma(X, \mathcal{F}_n)
$$
is a finite $A$-module, $f$ is a nonzerodivisor on $M$, and
$M/fM$ is the image of $M$ in $\Gamma(X, \mathcal{F}_1)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-topology-I-adic-f} and its proof we have
$M/fM \subset H^0(X, \mathcal{F}_1)$. From (1) and the Noetherian
property of $A$ we get that $M/fM$ is a finite $A$-module.
Observe that $\bigcap f^nM = 0$ as $f^nM$ maps to zero in
$H^0(X, \mathcal{F}_n)$. By
Algebra, Lemma \ref{algebra-lemma-finite-over-complete-ring}
we conclude that $M$ is finite over $A$.
\end{proof}

\begin{lemma}
\label{lemma-ML}
Let $A$ be a ring. Let $f \in A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules. Assume
\begin{enumerate}
\item either $H^1(X, \mathcal{F}_1)$ is an $A$-module of finite length
or $A$ is Noetherian and $H^1(X, \mathcal{F}_1)$ is a finite $A$-module,
\item the equivalent conditions of Lemma \ref{lemma-equivalent-f-good} hold.
\end{enumerate}
Then the inverse system $M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the
Mittag-Leffler condition.
\end{lemma}

\begin{proof}
Set $I = (f)$. We will use the criterion of Lemma \ref{lemma-ML-general}.
Observe that $f^n : \mathcal{F}_0 \to I^n\mathcal{F}_{n + 1}$
is an isomorphism for all $n \geq 0$.
Thus it suffices to show that
$$
\bigoplus\nolimits_{n \geq 1} H^1(X, \mathcal{F}_1) \cdot f^{n + 1}
$$
is a graded $S = \bigoplus_{n \geq 0} A/(f) \cdot f^n$-module satisfying the
ascending chain condition. If $A$ is not Noetherian, then
$H^1(X, \mathcal{F}_1)$ has finite length and the result holds.
If $A$ is Noetherian, then $S$ is a Noetherian ring and the result
holds as the module is finite over $S$ by the assumed finiteness
of $H^1(X, \mathcal{F}_1)$. Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-ML-better}
Let $A$ be a ring. Let $f \in A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules. Assume
\begin{enumerate}
\item either there is an $m \geq 1$ such that the image of
$H^1(X, \mathcal{F}_m) \to H^1(X, \mathcal{F}_1)$
is an $A$-module of finite length or $A$ is Noetherian
and the intersection of the images of
$H^1(X, \mathcal{F}_m) \to H^1(X, \mathcal{F}_1)$
is a finite $A$-module,
\item the equivalent conditions of Lemma \ref{lemma-equivalent-f-good} hold.
\end{enumerate}
Then the inverse system $M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the
Mittag-Leffler condition.
\end{lemma}

\begin{proof}
Set $I = (f)$. We will use the criterion of Lemma \ref{lemma-ML-general-better}
involving the modules $H^1_n$. For $m \geq n$ we have
$I^n\mathcal{F}_{m + 1} = \mathcal{F}_{m + 1 - n}$. Thus we see that
$$
H^1_n = \bigcap\nolimits_{m \geq 1} \Im\left(
H^1(X, \mathcal{F}_m) \to H^1(X, \mathcal{F}_1)
\right)
$$
is independent of $n$ and
$\bigoplus H^1_n = \bigoplus H^1_1 \cdot f^{n + 1}$.
Thus we conclude exactly as in the proof of Lemma \ref{lemma-ML}.
\end{proof}

\begin{lemma}
\label{lemma-formal-functions-principal}
\begin{reference}
\cite[Lemma 1.6]{Bhatt-local}
\end{reference}
Let $A$ be a ring and $f \in A$. Let $X$ be a scheme over $A$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume that $\mathcal{F}[f^n] = \Ker(f^n : \mathcal{F} \to \mathcal{F})$
stabilizes. Then
$$
R\Gamma(X, \lim \mathcal{F}/f^n\mathcal{F}) =
R\Gamma(X, \mathcal{F})^\wedge
$$
where the right hand side indicates the derived completion
with respect to the ideal $(f) \subset A$. Let $H^p$ be the
$p$th cohomology group of this complex. Then there are short
exact sequences
$$
0 \to R^1\lim H^{p - 1}(X, \mathcal{F}/f^n\mathcal{F})
\to H^p \to \lim H^p(X, \mathcal{F}/f^n\mathcal{F}) \to 0
$$
and
$$
0 \to H^0(H^p(X, \mathcal{F})^\wedge) \to H^p \to
T_f(H^{p + 1}(X, \mathcal{F})) \to 0
$$
where $T_f(-)$ denote the $f$-adic Tate module as in
More on Algebra, Example
\ref{more-algebra-example-spectral-sequence-principal}.
\end{lemma}

\begin{proof}
We start with the canonical identifications
\begin{align*}
R\Gamma(X, \mathcal{F})^\wedge
& =
R\lim R\Gamma(X, \mathcal{F}) \otimes_A^\mathbf{L} (A \xrightarrow{f^n} A) \\
& =
R\lim R\Gamma(X, \mathcal{F} \xrightarrow{f^n} \mathcal{F}) \\
& =
R\Gamma(X, R\lim (\mathcal{F} \xrightarrow{f^n} \mathcal{F}))
\end{align*}
The first equality holds by
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion-koszul}.
The second by the projection formula, see 
Cohomology, Lemma \ref{cohomology-lemma-projection-formula-perfect}.
The third by Cohomology, Lemma
\ref{cohomology-lemma-Rf-commutes-with-Rlim}.
Note that by
Derived Categories of Schemes, Lemma \ref{perfect-lemma-Rlim-quasi-coherent}
we have
$\lim \mathcal{F}/f^n\mathcal{F} = R\lim \mathcal{F}/f^n \mathcal{F}$.
Thus to finish the proof of the first statement of the lemma it suffices to
show that the pro-objects $(f^n : \mathcal{F} \to \mathcal{F})$
and $(\mathcal{F}/f^n \mathcal{F})$ are isomorphic. There is clearly
a map from the first inverse system to the second. Suppose that
$\mathcal{F}[f^c] = \mathcal{F}[f^{c + 1}] = \mathcal{F}[f^{c + 2}] = \ldots$.
Then we can define an arrow of inverse systems in $D(\mathcal{O}_X)$
in the other direction by the diagrams
$$
\xymatrix{
\mathcal{F}/\mathcal{F}[f^c] \ar[r]_-{f^{n + c}} \ar[d]_{f^c} &
\mathcal{F} \ar[d]^1 \\
\mathcal{F} \ar[r]^{f^n} & \mathcal{F}
}
$$
Since the top horizontal arrow is injective the complex
in the top row is quasi-isomorphic to $\mathcal{F}/f^{n + c}\mathcal{F}$.
Some details omitted.

\medskip\noindent
Since $R\Gamma(X, -)$ commutes with derived limits
(Injectives, Lemma \ref{injectives-lemma-RF-commutes-with-Rlim})
we see that
$$
R\Gamma(X, \lim \mathcal{F}/f^n\mathcal{F}) =
R\Gamma(X, R\lim \mathcal{F}/f^n\mathcal{F}) =
R\lim R\Gamma(X, \mathcal{F}/f^n\mathcal{F})
$$
(for first equality see first paragraph of proof).
By More on Algebra, Remark \ref{more-algebra-remark-compare-derived-limit}
we obtain exact sequences
$$
0 \to
R^1\lim H^{p - 1}(X, \mathcal{F}/f^n\mathcal{F}) \to
H^p(X, \lim \mathcal{F}/I^n\mathcal{F}) \to
\lim H^p(X, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
of $A$-modules. The second set of short exact sequences follow immediately
from the discussion in More on Algebra, Example
\ref{more-algebra-example-spectral-sequence-principal}.
\end{proof}








\section{Formal sections, III}
\label{section-formal-sections-cd-one}

\noindent
In this section we generalize some of the results of
Section \ref{section-formal-functions-principal}
to the case of an ideal $I \subset A$ of cohomological dimension $1$.

\begin{lemma}
\label{lemma-cd-one}
Let $I = (f_1, \ldots, f_r)$ be an ideal of a Noetherian ring $A$.
If $\text{cd}(A, I) = 1$, then there exist $c \geq 1$ and maps
$\varphi_j : I^c \to A$ such that $\sum f_j \varphi_j : I^c \to I$
is the inclusion map.
\end{lemma}

\begin{proof}
Since $\text{cd}(A, I) = 1$ the complement $U = \Spec(A) \setminus V(I)$
is affine (Local Cohomology, Lemma \ref{local-cohomology-lemma-cd-is-one}).
Say $U = \Spec(B)$. Then $IB = B$
and we can write $1 = \sum_{j = 1, \ldots, r} f_j b_j$
for some $b_j \in B$. By
Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
we can represent $b_j$ by maps $\varphi_j : I^c \to A$
for some $c \geq 0$. Then $\sum f_j \varphi_j : I^c \to I \subset A$
is the canonical embedding, after possibly replacing $c$ by a larger
integer, by the same lemma.
\end{proof}

\begin{lemma}
\label{lemma-cd-one-extend}
Let $I = (f_1, \ldots, f_r)$ be an ideal of a Noetherian ring $A$
with $\text{cd}(A, I) = 1$. Let $c \geq 1$ and $\varphi_j : I^c \to A$,
$j = 1, \ldots, r$ be as in Lemma \ref{lemma-cd-one}.
Then there is a unique graded $A$-algebra map
$$
\Phi : \bigoplus\nolimits_{n \geq 0} I^{nc} \to A[T_1, \ldots, T_r]
$$
with $\Phi(g) = \sum \varphi_j(g) T_j$ for $g \in I^c$.
Moreover, the composition of $\Phi$ with the map
$A[T_1, \ldots, T_r] \to \bigoplus_{n \geq 0} I^n$,
$T_j \mapsto f_j$ is the inclusion map
$\bigoplus_{n \geq 0} I^{nc} \to \bigoplus_{n \geq 0} I^n$.
\end{lemma}

\begin{proof}
For each $j$ and $m \geq c$ the restriction of $\varphi_j$ to
$I^m$ is a map $\varphi_j : I^m \to I^{m - c}$.
Given $j_1, \ldots, j_n \in \{1, \ldots, r\}$ we claim that the
composition
$$
\varphi_{j_1} \ldots \varphi_{j_n} :
I^{nc} \to I^{(n - 1)c} \to \ldots \to I^c \to A
$$
is independent of the order of the indices $j_1, \ldots, j_n$.
Namely, if $g = g_1 \ldots g_n$ with $g_i \in I^c$, then
we see that
$$
(\varphi_{j_1} \ldots \varphi_{j_n})(g) =
\varphi_{j_1}(g_1) \ldots \varphi_{j_n}(g_n)
$$
is independent of the ordering as multiplication in $A$ is commutative.
Thus we can define $\Phi$ by sending $g \in I^{nc}$ to
$$
\Phi(g) = \sum\nolimits_{e_1 + \ldots + e_r = n}
(\varphi_1^{e_1} \circ \ldots \circ \varphi_r^{e_r})(g)
T_1^{e_1} \ldots T_r^{e_r}
$$
It is straightforward to prove that this is a graded $A$-algebra
homomorphism with the desired property. Uniqueness is immediate
as is the final property. This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-cd-one-extend-to-module}
Let $I = (f_1, \ldots, f_r)$ be an ideal of a Noetherian ring $A$
with $\text{cd}(A, I) = 1$. Let $c \geq 1$ and $\varphi_j : I^c \to A$,
$j = 1, \ldots, r$ be as in Lemma \ref{lemma-cd-one}.
Let $A \to B$ be a ring map with $B$ Noetherian and let $N$ be
a finite $B$-module. Then, after possibly increasing $c$
and adjusting $\varphi_j$ accordingly, there is a unique
unique graded $B$-module map
$$
\Phi_N : \bigoplus\nolimits_{n \geq 0} I^{nc}N \to N[T_1, \ldots, T_r]
$$
with $\Phi_N(g x) = \Phi(g) x$ for $g \in I^{nc}$ and $x \in N$
where $\Phi$ is as in Lemma \ref{lemma-cd-one-extend}.
The composition of $\Phi_N$ with the map
$N[T_1, \ldots, T_r] \to \bigoplus_{n \geq 0} I^nN$,
$T_j \mapsto f_j$ is the inclusion map
$\bigoplus_{n \geq 0} I^{nc}N \to \bigoplus_{n \geq 0} I^nN$.
\end{lemma}

\begin{proof}
The uniqueness is clear from the formula and the uniqueness of $\Phi$ in
Lemma \ref{lemma-cd-one-extend}. Consider the Noetherian $A$-algebra
$B' = B \oplus N$ where $N$ is an ideal of square zero. To show
the existence of $\Phi_N$ it is enough
(via Lemma \ref{lemma-cd-one}) to show that $\varphi_j$ extends to
a map $\varphi'_j : I^cB' \to B'$ after possibly increasing $c$
to some $c'$ (and replacing $\varphi_j$ by the composition of the inclusion
$I^{c'} \to I^c$ with $\varphi_j$). Recall that $\varphi_j$ corresponds to a
section
$$
h_j \in \Gamma(\Spec(A) \setminus V(I), \mathcal{O}_{\Spec(A)})
$$
see Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}.
(This is in fact how we chose our $\varphi_j$ in the proof of
Lemma \ref{lemma-cd-one}.) Let us use the same lemma to represent the pullback
$$
h'_j \in \Gamma(\Spec(B') \setminus V(IB'), \mathcal{O}_{\Spec(B')})
$$
of $h_j$ by a $B'$-linear map
$\varphi'_j : I^{c'}B' \to B'$ for some $c' \geq c$.
The agreement with $\varphi_j$ will hold for $c'$
sufficiently large by a further application of the lemma:
namely we can test agreement on a finite list of generators of $I^{c'}$.
Small detail omitted.
\end{proof}

\begin{lemma}
\label{lemma-cd-is-one-for-system}
Let $I = (f_1, \ldots, f_r)$ be an ideal of a Noetherian ring $A$ with
$\text{cd}(A, I) = 1$. Let $c \geq 1$ and $\varphi_j : I^c \to A$,
$j = 1, \ldots, r$ be as in Lemma \ref{lemma-cd-one}.
Let $X$ be a Noetherian scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of coherent $\mathcal{O}_X$-modules
such that $\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$.
Set $\mathcal{F} = \lim \mathcal{F}_n$.
Then, after possibly increasing $c$ and adjusting $\varphi_j$ accordingly,
there exists a unique graded $\mathcal{O}_X$-module map
$$
\Phi_\mathcal{F} :
\bigoplus\nolimits_{n \geq 0} I^{nc}\mathcal{F}
\longrightarrow
\mathcal{F}[T_1, \ldots, T_r]
$$
with $\Phi_\mathcal{F}(g s) = \Phi(g) s$ for $g \in I^{nc}$ and
$s$ a local section of $\mathcal{F}$ where $\Phi$ is as in
Lemma \ref{lemma-cd-one-extend}. The composition of $\Phi_\mathcal{F}$
with the map
$\mathcal{F}[T_1, \ldots, T_r] \to \bigoplus_{n \geq 0} I^n\mathcal{F}$,
$T_j \mapsto f_j$
is the canonical inclusion
$\bigoplus_{n \geq 0} I^{nc}\mathcal{F} \to
\bigoplus_{n \geq 0} I^n\mathcal{F}$.
\end{lemma}

\begin{proof}
The uniqueness is immediate from the $\mathcal{O}_X$-linearity
and the requirement that $\Phi_\mathcal{F}(g s) = \Phi(g) s$ for
$g \in I^{nc}$ and $s$ a local section of $\mathcal{F}$.
Thus we may assume $X = \Spec(B)$ is affine.
Observe that $(\mathcal{F}_n)$ is an object of the category
$\textit{Coh}(X, I\mathcal{O}_X)$ introduced
in Cohomology of Schemes, Section \ref{coherent-section-coherent-formal}.
Let $B' = B^\wedge$ be the $I$-adic completion of $B$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-affine}
the object $(\mathcal{F}_n)$ corresponds to a finite $B'$-module $N$
in the sense that $\mathcal{F}_n$ is the coherent
module associated to the finite $B$-module $N/I^n N$.
Applying Lemma \ref{lemma-cd-one-extend-to-module}
to $I \subset A \to B'$ and $N$
we see that, after possibly increasing $c$ and adjusting
$\varphi_j$ accordingly, we get unique maps
$$
\Phi_N : \bigoplus\nolimits_{n \geq 0} I^{nc}N \to N[T_1, \ldots, T_r]
$$
with the corresponding properties. Note that in degree $n$ we obtain
an inverse system of maps $N/I^mN \to \bigoplus_{e_1 + \ldots + e_r = n}
N/I^{m - nc}N \cdot T_1^{e_1} \ldots T_r^{e_r}$ for $m \geq nc$.
Translating back into coherent
sheaves we see that $\Phi_N$ corresponds to a system of maps
$$
\Phi^n_m :
I^{nc}\mathcal{F}_m
\longrightarrow
\bigoplus\nolimits_{e_1 + \ldots + e_r = n}
\mathcal{F}_{m - nc} \cdot T_1^{e_1} \ldots T_r^{e_r}
$$
for varying $m \geq nc$ and $n \geq 1$. Taking the inverse limit of
these maps over $m$ we obtain $\Phi_\mathcal{F} = \bigoplus_n \lim_m \Phi^n_m$.
Note that $\lim_m I^t\mathcal{F}_m = I^t \mathcal{F}$ as can be seen by
evaluating on affines for example, but in fact we don't need this because
it is clear there is a map $I^t\mathcal{F} \to \lim_m I^t\mathcal{F}_m$.
\end{proof}

\begin{lemma}
\label{lemma-topology-I-adic}
Let $I$ be an ideal of a Noetherian ring $A$. Let $X$ be a Noetherian scheme
over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of coherent $\mathcal{O}_X$-modules
such that $\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$.
If $\text{cd}(A, I) = 1$, then for all $p \in \mathbf{Z}$ the limit topology on
$\lim H^p(X, \mathcal{F}_n)$ is $I$-adic.
\end{lemma}

\begin{proof}
First it is clear that $I^t \lim H^p(X, \mathcal{F}_n)$
maps to zero in $H^p(X, \mathcal{F}_t)$. Thus the $I$-adic topology
is finer than the limit topology. For the converse we set
$\mathcal{F} = \lim \mathcal{F}_n$, we pick generators $f_1, \ldots, f_r$
of $I$, we pick $c \geq 1$, and we choose
$\Phi_\mathcal{F}$ as in Lemma \ref{lemma-cd-is-one-for-system}.
We will use the results of Lemma \ref{lemma-properties-system}
without further mention. In particular we have a short exact
sequence
$$
0 \to R^1\lim H^{p - 1}(X, \mathcal{F}_n) \to H^p(X, \mathcal{F})
\to \lim H^p(X, \mathcal{F}_n) \to 0
$$
Thus we can lift any element $\xi$ of $\lim H^p(X, \mathcal{F}_n)$
to an element $\xi' \in H^p(X, \mathcal{F})$. Suppose $\xi$ maps to zero
in $H^p(X, \mathcal{F}_{nc})$ for some $n$, in other
words, suppose $\xi$ is ``small'' in the limit topology. We have a
short exact sequence
$$
0 \to I^{nc}\mathcal{F} \to \mathcal{F} \to \mathcal{F}_{nc} \to 0
$$
and hence the assumption means we can lift $\xi'$ to an element
$\xi'' \in H^p(X, I^{nc}\mathcal{F})$. Applying $\Phi_\mathcal{F}$
we get
$$
\Phi_\mathcal{F}(\xi'') = \sum\nolimits_{e_1 + \ldots + e_r = n}
\xi'_{e_1, \ldots, e_r} \cdot T_1^{e_1} \ldots T_r^{e_r}
$$
for some $\xi'_{e_1, \ldots, e_r} \in H^p(X, \mathcal{F})$.
Letting $\xi_{e_1, \ldots, e_r} \in \lim H^p(X, \mathcal{F}_n)$
be the images and using the final assertion of
Lemma \ref{lemma-cd-is-one-for-system}
we conclude that
$$
\xi = \sum f_1^{e_1} \ldots f_r^{e_r} \xi_{e_1, \ldots, e_r}
$$
is in $I^n \lim H^p(X, \mathcal{F}_n)$ as desired.
\end{proof}

\begin{example}
\label{example-not-I-adic}
Let $k$ be a field. Let $A = k[x, y][[s, t]]/(xs - yt)$.
Let $I = (s, t)$ and $\mathfrak a = (x, y, s, t)$.
Let $X = \Spec(A) - V(\mathfrak a)$ and
$\mathcal{F}_n = \mathcal{O}_X/I^n\mathcal{O}_X$.
Observe that the rational function
$$
g = \frac{t}{x} = \frac{s}{y}
$$
is regular in an open neighbourhood $V \subset X$ of
$V(I\mathcal{O}_X)$. Hence every power $g^e$ determines a section
$g^e \in M = \lim H^0(X, \mathcal{F}_n)$. Observe that
$g^e \to 0$ as $e \to \infty$ in the limit topology on $M$
since $g^e$ maps to zero in $\mathcal{F}_e$.
On the other hand, $g^e \not \in IM$ for any $e$
as the reader can see by computing $H^0(U, \mathcal{F}_n)$;
computation omitted. Observe that $\text{cd}(A, I) = 2$.
Thus the result of Lemma \ref{lemma-topology-I-adic} is sharp.
\end{example}








\section{Mittag-Leffler conditions}
\label{section-ML}

\noindent
When taking local cohomology with respect to the maximal ideal
of a local Noetherian ring, we often get the Mittag-Leffler condition
for free. This implies the same thing is true for higher cohomology
groups of an inverse system of coherent sheaves with surjective transition
maps on the puncture spectrum.

\begin{lemma}
\label{lemma-descending-chain}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
\begin{enumerate}
\item Let $M$ be a finite $A$-module. Then the $A$-module
$H^i_\mathfrak m(M)$ satisfies the descending chain condition
for any $i$.
\item Let $U = \Spec(A) \setminus \{\mathfrak m\}$ be the
punctured spectrum of $A$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
Then the $A$-module $H^i(U, \mathcal{F})$
satisfies the descending chain condition for $i > 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $A^\wedge$ be the completion of $A$. Since
$H^i_\mathfrak m(M)$ is $\mathfrak m$-power torsion, we see that
$H^i_\mathfrak m(M) = H^i_\mathfrak m(M) \otimes_A A^\wedge$. Moreover,
we have $H^i_\mathfrak m(M) \otimes_A A^\wedge =
H^i_{\mathfrak mA^\wedge}(M \otimes_A A^\wedge)$ by
Dualizing Complexes, Lemma \ref{dualizing-lemma-torsion-change-rings}.
Thus
$$
H^i_\mathfrak m(M) = H^i_{\mathfrak mA^\wedge}(M \otimes_A A^\wedge)
$$
and $A$-submodules of the left hand side are the same thing as
$A^\wedge$-submodules of the right hand side. Thus we reduce
to the case discussed in the next paragraph.

\medskip\noindent
Assume $A$ is complete. Then $A$ has a normalized dualizing complex
$\omega_A^\bullet$ (Dualizing Complexes, Lemma
\ref{dualizing-lemma-ubiquity-dualizing}).
By the local duality theorem (Dualizing Complexes, Lemma
\ref{dualizing-lemma-special-case-local-duality}) we find an isomorphism
$$
\Hom_A(H^i_\mathfrak m(M), E) =
\text{Ext}^{-i}_A(M, \omega_A^\bullet)^\wedge
$$
where $E$ is an injective hull of the residue field of $A$. The module
$\text{Ext}^{-i}_A(M, \omega_A^\bullet)$
on the right hand side is a finite $A$-module by
Dualizing Complexes, Lemma \ref{dualizing-lemma-dualizing}.
Since $A$ is complete, the completion isn't necessary.
Thus $H^i_\mathfrak m(M)$ has the descending chain condition
by Matlis duality, see 
Dualizing Complexes, Proposition \ref{dualizing-proposition-matlis}
and its addendum Remark \ref{dualizing-remark-matlis}.

\medskip\noindent
Part (2) follows from (1) via Local Cohomology,
Lemma \ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
\end{proof}

\begin{lemma}
\label{lemma-ML-local}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
\begin{enumerate}
\item Let $(M_n)$ be an inverse system of finite $A$-modules. Then the
inverse system $H^i_\mathfrak m(M_n)$ satisfies the Mittag-Leffler
condition for any $i$.
\item Let $U = \Spec(A) \setminus \{\mathfrak m\}$ be the
punctured spectrum of $A$.
Let $\mathcal{F}_n$ be an inverse system of
coherent $\mathcal{O}_U$-modules.
Then the inverse system $H^i(U, \mathcal{F}_n)$
satisfies the Mittag-Leffler condition for $i > 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-descending-chain}.
\end{proof}

\begin{lemma}
\label{lemma-terrific}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $(M_n)$ be an inverse system of finite $A$-modules.
Let $M \to \lim M_n$ be a map where $M$ is a finite $A$-module
such that for some $i$ the map
$H^i_\mathfrak m(M) \to \lim H^i_\mathfrak m(M_n)$
is an isomorphism.
Then the inverse system $H^i_\mathfrak m(M_n)$
is essentially constant with value $H^i_\mathfrak m(M)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-ML-local} the inverse system $H^i_\mathfrak m(M_n)$
satisfies the Mittag-Leffler condition. Let $E_n \subset H^i_\mathfrak m(M_n)$
be the image of $H^i_\mathfrak m(M_{n'})$ for $n' \gg n$.
Then $(E_n)$ is an inverse system with surjective transition maps
and $H^i_\mathfrak m(M) = \lim E_n$. Since $H^i_\mathfrak m(M)$
has the descending chain condition by
Lemma \ref{lemma-descending-chain}
we find there can only be a finite number of nontrivial
kernels of the surjections $H^i_\mathfrak m(M) \to E_n$.
Thus $E_n \to E_{n - 1}$ is an isomorphism for all $n \gg 0$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-derived-completion}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Then
$$
H^i(R\Gamma_\mathfrak m(M)^\wedge) = \lim H^i_\mathfrak m(M/I^nM)
$$
for all $i$ where $R\Gamma_\mathfrak m(M)^\wedge$ denotes
the derived $I$-adic completion.
\end{lemma}

\begin{proof}
Apply Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local}
and Lemma \ref{lemma-ML-local} to see the vanishing of the $R^1\lim$ terms.
\end{proof}








\section{Derived completion on a ringed site}
\label{section-derived-completion}

\noindent
We urge the reader to skip this section on a first reading.

\medskip\noindent
The algebra version of this material can be found in
More on Algebra, Section \ref{more-algebra-section-derived-completion}.
Let $\mathcal{O}$ be a sheaf of rings on a site $\mathcal{C}$.
Let $f$ be a global section of $\mathcal{O}$. We denote
$\mathcal{O}_f$ the sheaf associated to the presheaf of localizations
$U \mapsto \mathcal{O}(U)_f$.

\begin{lemma}
\label{lemma-map-twice-localize}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let $f$ be a global
section of $\mathcal{O}$.
\begin{enumerate}
\item For $L, N \in D(\mathcal{O}_f)$ we have
$R\SheafHom_\mathcal{O}(L, N) = R\SheafHom_{\mathcal{O}_f}(L, N)$.
In particular the two $\mathcal{O}_f$-structures on
$R\SheafHom_\mathcal{O}(L, N)$ agree.
\item For $K \in D(\mathcal{O})$ and
$L \in D(\mathcal{O}_f)$ we have
$$
R\SheafHom_\mathcal{O}(L, K) =
R\SheafHom_{\mathcal{O}_f}(L, R\SheafHom_\mathcal{O}(\mathcal{O}_f, K))
$$
In particular
$R\SheafHom_\mathcal{O}(\mathcal{O}_f,
R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)) =
R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)$.
\item If $g$ is a second global
section of $\mathcal{O}$, then
$$
R\SheafHom_\mathcal{O}(\mathcal{O}_f, R\SheafHom_\mathcal{O}(\mathcal{O}_g, K))
= R\SheafHom_\mathcal{O}(\mathcal{O}_{gf}, K).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $\mathcal{J}^\bullet$ be a K-injective complex of
$\mathcal{O}_f$-modules representing $N$. By Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-K-injective-flat} it follows that
$\mathcal{J}^\bullet$ is a K-injective complex of
$\mathcal{O}$-modules as well. Let $\mathcal{F}^\bullet$ be a complex of
$\mathcal{O}_f$-modules representing $L$. Then
$$
R\SheafHom_\mathcal{O}(L, N) =
R\SheafHom_\mathcal{O}(\mathcal{F}^\bullet, \mathcal{J}^\bullet) =
R\SheafHom_{\mathcal{O}_f}(\mathcal{F}^\bullet, \mathcal{J}^\bullet)
$$
by
Modules on Sites, Lemma \ref{sites-modules-lemma-epimorphism-modules}
because $\mathcal{J}^\bullet$ is a K-injective complex of $\mathcal{O}$
and of $\mathcal{O}_f$-modules.

\medskip\noindent
Proof of (2). Let $\mathcal{I}^\bullet$ be a K-injective complex of
$\mathcal{O}$-modules representing $K$.
Then $R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)$ is represented by
$\SheafHom_\mathcal{O}(\mathcal{O}_f, \mathcal{I}^\bullet)$ which is
a K-injective complex of $\mathcal{O}_f$-modules and of
$\mathcal{O}$-modules by
Cohomology on Sites, Lemmas \ref{sites-cohomology-lemma-hom-K-injective} and
\ref{sites-cohomology-lemma-K-injective-flat}.
Let $\mathcal{F}^\bullet$ be a complex of $\mathcal{O}_f$-modules
representing $L$. Then
$$
R\SheafHom_\mathcal{O}(L, K) =
R\SheafHom_\mathcal{O}(\mathcal{F}^\bullet, \mathcal{I}^\bullet) =
R\SheafHom_{\mathcal{O}_f}(\mathcal{F}^\bullet,
\SheafHom_\mathcal{O}(\mathcal{O}_f, \mathcal{I}^\bullet))
$$
by Modules on Sites, Lemma \ref{sites-modules-lemma-adjoint-hom-restrict}
and because $\SheafHom_\mathcal{O}(\mathcal{O}_f, \mathcal{I}^\bullet)$ is a
K-injective complex of $\mathcal{O}_f$-modules.

\medskip\noindent
Proof of (3). This follows from the fact that
$R\SheafHom_\mathcal{O}(\mathcal{O}_g, \mathcal{I}^\bullet)$
is K-injective as a complex of $\mathcal{O}$-modules and the fact that
$\SheafHom_\mathcal{O}(\mathcal{O}_f,
\SheafHom_\mathcal{O}(\mathcal{O}_g, \mathcal{H})) = 
\SheafHom_\mathcal{O}(\mathcal{O}_{gf}, \mathcal{H})$
for all sheaves of $\mathcal{O}$-modules $\mathcal{H}$.
\end{proof}

\noindent
Let $K \in D(\mathcal{O})$. We denote
$T(K, f)$ a derived limit (Derived Categories, Definition
\ref{derived-definition-derived-limit}) of the inverse system
$$
\ldots \to K \xrightarrow{f} K \xrightarrow{f} K
$$
in $D(\mathcal{O})$.

\begin{lemma}
\label{lemma-hom-from-Af}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let $f$ be a global
section of $\mathcal{O}$. Let $K \in D(\mathcal{O})$.
The following are equivalent
\begin{enumerate}
\item $R\SheafHom_\mathcal{O}(\mathcal{O}_f, K) = 0$,
\item $R\SheafHom_\mathcal{O}(L, K) = 0$ for all $L$ in $D(\mathcal{O}_f)$,
\item $T(K, f) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (2) implies (1). The implication (1) $\Rightarrow$ (2)
follows from Lemma \ref{lemma-map-twice-localize}.
A free resolution of the $\mathcal{O}$-module $\mathcal{O}_f$ is given by
$$
0 \to \bigoplus\nolimits_{n \in \mathbf{N}} \mathcal{O} \to
\bigoplus\nolimits_{n \in \mathbf{N}} \mathcal{O}
\to \mathcal{O}_f \to 0
$$
where the first map sends a local section $(x_0, x_1, \ldots)$ to
$(fx_0 - x_1, fx_1 - x_2, \ldots)$ and the second map sends
$(x_0, x_1, \ldots)$ to $x_0 + x_1/f + x_2/f^2 + \ldots$.
Applying $\SheafHom_\mathcal{O}(-, \mathcal{I}^\bullet)$
where $\mathcal{I}^\bullet$ is a K-injective complex of $\mathcal{O}$-modules
representing $K$ we get a short exact sequence of complexes
$$
0 \to \SheafHom_\mathcal{O}(\mathcal{O}_f, \mathcal{I}^\bullet) \to
\prod \mathcal{I}^\bullet \to \prod \mathcal{I}^\bullet \to 0
$$
because $\mathcal{I}^n$ is an injective $\mathcal{O}$-module.
The products are products in $D(\mathcal{O})$, see
Injectives, Lemma \ref{injectives-lemma-derived-products}.
This means that the object $T(K, f)$ is a representative of
$R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)$ in $D(\mathcal{O})$.
Thus the equivalence of (1) and (3).
\end{proof}

\begin{lemma}
\label{lemma-ideal-of-elements-complete-wrt}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let $K \in D(\mathcal{O})$.
The rule which associates to $U$ the set $\mathcal{I}(U)$
of sections $f \in \mathcal{O}(U)$ such that $T(K|_U, f) = 0$
is a sheaf of ideals in $\mathcal{O}$.
\end{lemma}

\begin{proof}
We will use the results of Lemma \ref{lemma-hom-from-Af} without further
mention. If $f \in \mathcal{I}(U)$, and $g \in \mathcal{O}(U)$, then
$\mathcal{O}_{U, gf}$ is an $\mathcal{O}_{U, f}$-module
hence $R\SheafHom_\mathcal{O}(\mathcal{O}_{U, gf}, K|_U) = 0$, hence
$gf \in \mathcal{I}(U)$. Suppose $f, g \in \mathcal{O}(U)$.
Then there is a short exact sequence
$$
0 \to \mathcal{O}_{U, f + g} \to
\mathcal{O}_{U, f(f + g)} \oplus \mathcal{O}_{U, g(f + g)} \to
\mathcal{O}_{U, gf(f + g)} \to 0
$$
because $f, g$ generate the unit ideal in $\mathcal{O}(U)_{f + g}$.
This follows from
Algebra, Lemma \ref{algebra-lemma-standard-covering}
and the easy fact that the last arrow is surjective.
Because $R\SheafHom_\mathcal{O}( - , K|_U)$ is an exact functor
of triangulated categories the vanishing of
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, f(f + g)}, K|_U)$,
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, g(f + g)}, K|_U)$, and
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, gf(f + g)}, K|_U)$,
implies the vanishing of 
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, f + g}, K|_U)$.
We omit the verification of the sheaf condition.
\end{proof}

\noindent
We can make the following definition for any ringed site.

\begin{definition}
\label{definition-derived-complete}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a sheaf of ideals.
Let $K \in D(\mathcal{O})$. We say that $K$ is
{\it derived complete with respect to $\mathcal{I}$}
if for every object $U$ of $\mathcal{C}$ and $f \in \mathcal{I}(U)$
the object $T(K|_U, f)$ of $D(\mathcal{O}_U)$ is zero.
\end{definition}

\noindent
It is clear that the full subcategory
$D_{comp}(\mathcal{O}) = D_{comp}(\mathcal{O}, \mathcal{I}) \subset
D(\mathcal{O})$ consisting of derived complete objects
is a saturated triangulated subcategory, see
Derived Categories, Definitions
\ref{derived-definition-triangulated-subcategory} and
\ref{derived-definition-saturated}. This subcategory is preserved
under products and homotopy limits in $D(\mathcal{O})$.
But it is not preserved under countable direct sums in general.

\begin{lemma}
\label{lemma-derived-complete-internal-hom}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a sheaf of ideals.
If $K \in D(\mathcal{O})$ and $L \in D_{comp}(\mathcal{O})$, then
$R\SheafHom_\mathcal{O}(K, L) \in D_{comp}(\mathcal{O})$.
\end{lemma}

\begin{proof}
Let $U$ be an object of $\mathcal{C}$ and let $f \in \mathcal{I}(U)$.
Recall that
$$
\Hom_{D(\mathcal{O}_U)}(\mathcal{O}_{U, f}, R\SheafHom_\mathcal{O}(K, L)|_U)
=
\Hom_{D(\mathcal{O}_U)}(
K|_U \otimes_{\mathcal{O}_U}^\mathbf{L} \mathcal{O}_{U, f}, L|_U)
$$
by Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-internal-hom}.
The right hand side is zero by Lemma \ref{lemma-hom-from-Af}
and the relationship between internal hom and actual hom, see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-section-RHom-over-U}.
The same vanishing holds for all $U'/U$. Thus the object
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, f},
R\SheafHom_\mathcal{O}(K, L)|_U)$ of $D(\mathcal{O}_U)$ has vanishing
$0$th cohomology sheaf (by locus citatus). Similarly for the other
cohomology sheaves, i.e., $R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, f},
R\SheafHom_\mathcal{O}(K, L)|_U)$ is zero in $D(\mathcal{O}_U)$.
By Lemma \ref{lemma-hom-from-Af} we conclude.
\end{proof}

\begin{lemma}
\label{lemma-restriction-derived-complete}
Let $\mathcal{C}$ be a site. Let $\mathcal{O} \to \mathcal{O}'$
be a homomorphism of sheaves of rings. Let $\mathcal{I} \subset \mathcal{O}$
be a sheaf of ideals. The inverse image of $D_{comp}(\mathcal{O}, \mathcal{I})$
under the restriction functor $D(\mathcal{O}') \to D(\mathcal{O})$ is
$D_{comp}(\mathcal{O}', \mathcal{I}\mathcal{O}')$.
\end{lemma}

\begin{proof}
Using Lemma \ref{lemma-ideal-of-elements-complete-wrt}
we see that $K' \in D(\mathcal{O}')$ is in
$D_{comp}(\mathcal{O}', \mathcal{I}\mathcal{O}')$
if and only if $T(K'|_U, f)$ is zero for every local section
$f \in \mathcal{I}(U)$. Observe that the cohomology sheaves of
$T(K'|_U, f)$ are computed in the category of abelian sheaves,
so it doesn't matter whether we think of $f$ as a section of
$\mathcal{O}$ or take the image of $f$ as a section of $\mathcal{O}'$.
The lemma follows immediately from this and the
definition of derived complete objects.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-derived-complete}
Let $f : (\Sh(\mathcal{D}), \mathcal{O}') \to (\Sh(\mathcal{C}), \mathcal{O})$
be a morphism of ringed topoi. Let $\mathcal{I} \subset \mathcal{O}$
and $\mathcal{I}' \subset \mathcal{O}'$ be sheaves of ideals such
that $f^\sharp$ sends $f^{-1}\mathcal{I}$ into $\mathcal{I}'$.
Then $Rf_*$ sends $D_{comp}(\mathcal{O}', \mathcal{I}')$
into $D_{comp}(\mathcal{O}, \mathcal{I})$.
\end{lemma}

\begin{proof}
We may assume $f$ is given by a morphism of ringed sites corresponding
to a continuous functor $\mathcal{C} \to \mathcal{D}$
(Modules on Sites, Lemma
\ref{sites-modules-lemma-morphism-ringed-topoi-comes-from-morphism-ringed-sites}
).
Let $U$ be an object of $\mathcal{C}$ and let $g$ be a section of
$\mathcal{I}$ over $U$. We have to show that
$\Hom_{D(\mathcal{O}_U)}(\mathcal{O}_{U, g}, Rf_*K|_U) = 0$
whenever $K$ is derived complete with respect to $\mathcal{I}'$.
Namely, by Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-section-RHom-over-U}
this, applied to all objects over $U$ and all shifts of $K$,
will imply that $R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, g}, Rf_*K|_U)$
is zero, which implies that $T(Rf_*K|_U, g)$ is zero
(Lemma \ref{lemma-hom-from-Af}) which is what we have to show
(Definition \ref{definition-derived-complete}).
Let $V$ in $\mathcal{D}$ be the image of $U$. Then
$$
\Hom_{D(\mathcal{O}_U)}(\mathcal{O}_{U, g}, Rf_*K|_U) =
\Hom_{D(\mathcal{O}'_V)}(\mathcal{O}'_{V, g'}, K|_V) = 0
$$
where $g' = f^\sharp(g) \in \mathcal{I}'(V)$. The second equality
because $K$ is derived complete and the first equality because
the derived pullback of $\mathcal{O}_{U, g}$ is $\mathcal{O}'_{V, g'}$
and
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-adjoint}.
\end{proof}

\noindent
The following lemma is the simplest case where one has derived completion.

\begin{lemma}
\label{lemma-derived-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed on a site. Let $f_1, \ldots, f_r$
be global sections of $\mathcal{O}$. Let $\mathcal{I} \subset \mathcal{O}$ be
the ideal sheaf generated by $f_1, \ldots, f_r$.
Then the inclusion functor $D_{comp}(\mathcal{O}) \to D(\mathcal{O})$
has a left adjoint, i.e., given any object $K$ of $D(\mathcal{O})$
there exists a map $K \to K^\wedge$ with $K^\wedge$ in $D_{comp}(\mathcal{O})$
such that the map
$$
\Hom_{D(\mathcal{O})}(K^\wedge, E) \longrightarrow \Hom_{D(\mathcal{O})}(K, E)
$$
is bijective whenever $E$ is in $D_{comp}(\mathcal{O})$. In fact
we have
$$
K^\wedge =
R\SheafHom_\mathcal{O}
(\mathcal{O} \to \prod\nolimits_{i_0} \mathcal{O}_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{f_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{f_1\ldots f_r}, K)
$$
functorially in $K$.
\end{lemma}

\begin{proof}
Define $K^\wedge$ by the last displayed formula of the lemma.
There is a map of complexes
$$
(\mathcal{O} \to \prod\nolimits_{i_0} \mathcal{O}_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{f_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{f_1\ldots f_r}) \longrightarrow \mathcal{O}
$$
which induces a map $K \to K^\wedge$. It suffices to prove that
$K^\wedge$ is derived complete and that $K \to K^\wedge$ is an
isomorphism if $K$ is derived complete.

\medskip\noindent
Let $f$ be a global section of $\mathcal{O}$.
By Lemma \ref{lemma-map-twice-localize} the object
$R\SheafHom_\mathcal{O}(\mathcal{O}_f, K^\wedge)$
is equal to
$$
R\SheafHom_\mathcal{O}(
(\mathcal{O}_f \to \prod\nolimits_{i_0} \mathcal{O}_{ff_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{ff_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{ff_1\ldots f_r}), K)
$$
If $f = f_i$ for some $i$, then $f_1, \ldots, f_r$ generate the
unit ideal in $\mathcal{O}_f$, hence the extended alternating
{\v C}ech complex
$$
\mathcal{O}_f \to \prod\nolimits_{i_0} \mathcal{O}_{ff_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{ff_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{ff_1\ldots f_r}
$$
is zero (even homotopic to zero). In this way we see that $K^\wedge$
is derived complete.

\medskip\noindent
If $K$ is derived complete, then $R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)$
is zero for all $f = f_{i_0} \ldots f_{i_p}$, $p \geq 0$. Thus
$K \to K^\wedge$ is an isomorphism in $D(\mathcal{O})$.
\end{proof}

\noindent
Next we explain why derived completion is a completion.

\begin{lemma}
\label{lemma-derived-completion-koszul}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed on a site. Let $f_1, \ldots, f_r$
be global sections of $\mathcal{O}$. Let $\mathcal{I} \subset \mathcal{O}$ be
the ideal sheaf generated by $f_1, \ldots, f_r$. Let $K \in D(\mathcal{O})$.
The derived completion $K^\wedge$ of Lemma \ref{lemma-derived-completion}
is given by the formula
$$
K^\wedge = R\lim K \otimes^\mathbf{L}_\mathcal{O} K_n
$$
where $K_n = K(\mathcal{O}, f_1^n, \ldots, f_r^n)$
is the Koszul complex on $f_1^n, \ldots, f_r^n$ over $\mathcal{O}$.
\end{lemma}

\begin{proof}
In More on Algebra, Lemma
\ref{more-algebra-lemma-extended-alternating-Cech-is-colimit-koszul}
we have seen that the extended alternating {\v C}ech complex
$$
\mathcal{O} \to \prod\nolimits_{i_0} \mathcal{O}_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{f_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{f_1\ldots f_r}
$$
is a colimit of the Koszul complexes
$K^n = K(\mathcal{O}, f_1^n, \ldots, f_r^n)$ sitting in
degrees $0, \ldots, r$. Note that $K^n$ is a finite chain complex
of finite free $\mathcal{O}$-modules with dual
$\SheafHom_\mathcal{O}(K^n, \mathcal{O}) = K_n$ where $K_n$ is the Koszul
cochain complex sitting in degrees $-r, \ldots, 0$ (as usual). By
Lemma \ref{lemma-derived-completion}
the functor $E \mapsto E^\wedge$ is gotten by taking
$R\SheafHom$ from the extended alternating {\v C}ech complex into $E$:
$$
E^\wedge = R\SheafHom(\colim K^n, E)
$$
This is equal to $R\lim (E \otimes_\mathcal{O}^\mathbf{L} K_n)$
by
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-colim-and-lim-of-duals}.
\end{proof}

\begin{lemma}
\label{lemma-all-rings}
There exist a way to construct
\begin{enumerate}
\item for every pair $(A, I)$ consisting of a ring $A$ and a finitely
generated ideal $I \subset A$ a complex $K(A, I)$ of $A$-modules,
\item a map $K(A, I) \to A$ of complexes of $A$-modules,
\item for every ring map $A \to B$ and finitely generated ideal $I \subset A$
a map of complexes $K(A, I) \to K(B, IB)$,
\end{enumerate}
such that
\begin{enumerate}
\item[(a)] for $A \to B$ and $I \subset A$ finitely generated the diagram
$$
\xymatrix{
K(A, I) \ar[r] \ar[d] & A \ar[d] \\
K(B, IB) \ar[r] & B
}
$$
commutes,
\item[(b)] for $A \to B \to C$ and $I \subset A$ finitely generated
the composition of the maps
$K(A, I) \to K(B, IB) \to K(C, IC)$ is the map $K(A, I) \to K(C, IC)$.
\item[(c)] for $A \to B$ and a finitely generated ideal $I \subset A$
the induced map $K(A, I) \otimes_A^\mathbf{L} B \to K(B, IB)$
is an isomorphism in $D(B)$, and
\item[(d)] if $I = (f_1, \ldots, f_r) \subset A$ then there is a commutative
diagram
$$
\xymatrix{
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \ar[r] \ar[d] &  K(A, I) \ar[d] \\
A \ar[r]^1 & A
}
$$
in $D(A)$ whose horizontal arrows are isomorphisms.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $S$ be the set of rings $A_0$ of the form
$A_0 = \mathbf{Z}[x_1, \ldots, x_n]/J$.
Every finite type $\mathbf{Z}$-algebra is isomorphic to
an element of $S$. Let $\mathcal{A}_0$ be the category whose objects
are pairs $(A_0, I_0)$ where $A_0 \in S$ and $I_0 \subset A_0$
is an ideal and whose morphisms $(A_0, I_0) \to (B_0, J_0)$ are
ring maps $\varphi : A_0 \to B_0$ such that $J_0 = \varphi(I_0)B_0$.

\medskip\noindent
Suppose we can construct $K(A_0, I_0) \to A_0$ functorially for
objects of $\mathcal{A}_0$ having properties (a), (b), (c), and (d).
Then we take
$$
K(A, I) = \colim_{\varphi : (A_0, I_0) \to (A, I)} K(A_0, I_0)
$$
where the colimit is over ring maps $\varphi : A_0 \to A$ such
that $\varphi(I_0)A = I$ with $(A_0, I_0)$ in $\mathcal{A}_0$.
A morphism between $(A_0, I_0) \to (A, I)$ and $(A_0', I_0') \to (A, I)$
are given by maps $(A_0, I_0) \to (A_0', I_0')$ in $\mathcal{A}_0$
commuting with maps to $A$.
The category of these $(A_0, I_0) \to (A, I)$ is filtered
(details omitted). Moreover, $\colim_{\varphi : (A_0, I_0) \to (A, I)} A_0 = A$
so that $K(A, I)$ is a complex of $A$-modules.
Finally, given $\varphi : A \to B$ and $I \subset A$
for every $(A_0, I_0) \to (A, I)$ in the colimit, the composition
$(A_0, I_0) \to (B, IB)$ lives in the colimit for $(B, IB)$.
In this way we get a map on colimits. Properties (a), (b), (c), and (d)
follow readily from this and the corresponding
properties of the complexes $K(A_0, I_0)$.

\medskip\noindent
Endow $\mathcal{C}_0 = \mathcal{A}_0^{opp}$ with the chaotic topology.
We equip $\mathcal{C}_0$ with the sheaf of rings
$\mathcal{O} : (A, I) \mapsto A$. The ideals $I$ fit together to give a
sheaf of ideals $\mathcal{I} \subset \mathcal{O}$.
Choose an injective resolution $\mathcal{O} \to \mathcal{J}^\bullet$.
Consider the object
$$
\mathcal{F}^\bullet = \bigcup\nolimits_n \mathcal{J}^\bullet[\mathcal{I}^n]
$$
Let $U = (A, I) \in \Ob(\mathcal{C}_0)$.
Since the topology in $\mathcal{C}_0$ is chaotic, the value
$\mathcal{J}^\bullet(U)$ is a resolution of $A$ by injective
$A$-modules. Hence the value $\mathcal{F}^\bullet(U)$ is an
object of $D(A)$ representing the image of $R\Gamma_I(A)$ in $D(A)$, see
Dualizing Complexes, Section \ref{dualizing-section-local-cohomology}.
Choose a complex of $\mathcal{O}$-modules $\mathcal{K}^\bullet$
and a commutative diagram
$$
\xymatrix{
\mathcal{O} \ar[r] & \mathcal{J}^\bullet \\
\mathcal{K}^\bullet \ar[r] \ar[u] & \mathcal{F}^\bullet \ar[u]
}
$$
where the horizontal arrows are quasi-isomorphisms. This is possible
by the construction of the derived category $D(\mathcal{O})$.
Set $K(A, I) = \mathcal{K}^\bullet(U)$ where $U = (A, I)$.
Properties (a) and (b) are clear and properties (c) and (d)
follow from Dualizing Complexes, Lemmas
\ref{dualizing-lemma-compute-local-cohomology-noetherian} and
\ref{dualizing-lemma-local-cohomology-change-rings}.
\end{proof}

\begin{lemma}
\label{lemma-global-extended-cech-complex}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let
$\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of ideals.
There exists a map $K \to \mathcal{O}$ in $D(\mathcal{O})$
such that for every $U \in \Ob(\mathcal{C})$ such that
$\mathcal{I}|_U$ is generated by $f_1, \ldots, f_r \in \mathcal{I}(U)$
there is an isomorphism
$$
(\mathcal{O}_U \to \prod\nolimits_{i_0} \mathcal{O}_{U, f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{U, f_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{U, f_1\ldots f_r}) \longrightarrow K|_U
$$
compatible with maps to $\mathcal{O}_U$.
\end{lemma}

\begin{proof}
Let $\mathcal{C}' \subset \mathcal{C}$ be the full subcategory
of objects $U$ such that $\mathcal{I}|_U$ is generated by
finitely many sections. Then $\mathcal{C}' \to \mathcal{C}$
is a special cocontinuous functor
(Sites, Definition \ref{sites-definition-special-cocontinuous-functor}).
Hence it suffices to work with $\mathcal{C}'$, see
Sites, Lemma \ref{sites-lemma-equivalence}.
In other words we may assume that for every
object $U$ of $\mathcal{C}$ there exists a finitely generated
ideal $I \subset \mathcal{I}(U)$ such that
$\mathcal{I}|_U = \Im(I \otimes \mathcal{O}_U \to \mathcal{O}_U)$.
We will say that $I$ generates $\mathcal{I}|_U$.
Warning: We do not know that $\mathcal{I}(U)$ is a finitely generated
ideal in $\mathcal{O}(U)$.

\medskip\noindent
Let $U$ be an object and $I \subset \mathcal{O}(U)$ a finitely
generated ideal which generates $\mathcal{I}|_U$.
On the category $\mathcal{C}/U$ consider the complex of presheaves
$$
K_{U, I}^\bullet : U'/U \longmapsto K(\mathcal{O}(U'), I\mathcal{O}(U'))
$$
with $K(-, -)$ as in Lemma \ref{lemma-all-rings}.
We claim that the sheafification of this is independent of
the choice of $I$. Indeed, if $I' \subset \mathcal{O}(U)$
is a finitely generated ideal which also generates $\mathcal{I}|_U$, then
there exists a covering $\{U_j \to U\}$ such that
$I\mathcal{O}(U_j) = I'\mathcal{O}(U_j)$. (Hint: this works because
both $I$ and $I'$ are finitely generated and generate $\mathcal{I}|_U$.)
Hence $K_{U, I}^\bullet$ and $K_{U, I'}^\bullet$ are the {\it same}
for any object lying over one of the $U_j$. The statement
on sheafifications follows. Denote $K_U^\bullet$ the common value.

\medskip\noindent
The independence of choice of $I$ also shows that
$K_U^\bullet|_{\mathcal{C}/U'} = K_{U'}^\bullet$
whenever we are given a morphism
$U' \to U$ and hence a localization morphism
$\mathcal{C}/U' \to \mathcal{C}/U$. Thus the complexes
$K_U^\bullet$ glue to give a single well defined complex $K^\bullet$
of $\mathcal{O}$-modules. The existence of the map $K^\bullet \to \mathcal{O}$
and the quasi-isomorphism of the lemma follow immediately from
the corresponding properties of the complexes $K(-, -)$ in
Lemma \ref{lemma-all-rings}.
\end{proof}

\begin{proposition}
\label{proposition-derived-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of
ideals. There exists a left adjoint to the inclusion
functor $D_{comp}(\mathcal{O}) \to D(\mathcal{O})$.
\end{proposition}

\begin{proof}
Let $K \to \mathcal{O}$ in $D(\mathcal{O})$ be as constructed in
Lemma \ref{lemma-global-extended-cech-complex}. Let $E \in D(\mathcal{O})$.
Then $E^\wedge = R\SheafHom(K, E)$ together with the map $E \to E^\wedge$
will do the job. Namely, locally on the site $\mathcal{C}$ we
recover the adjoint of Lemma \ref{lemma-derived-completion}.
This shows that $E^\wedge$ is always derived complete and that
$E \to E^\wedge$ is an isomorphism if $E$ is derived complete.
\end{proof}

\begin{remark}[Comparison with completion]
\label{remark-compare-with-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of
ideals. Let $K \mapsto K^\wedge$ be the derived completion functor
of Proposition \ref{proposition-derived-completion}.
For any $n \geq 1$ the object
$K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}/\mathcal{I}^n$
is derived complete as it is annihilated by powers of
local sections of $\mathcal{I}$. Hence there is a canonical factorization
$$
K \to K^\wedge \to K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}/\mathcal{I}^n
$$
of the canonical map
$K \to K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}/\mathcal{I}^n$.
These maps are compatible for varying $n$ and we obtain a comparison map
$$
K^\wedge
\longrightarrow
R\lim \left(K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}/\mathcal{I}^n\right)
$$
The right hand side is more recognizable as a kind of completion.
In general this comparison map is not an isomorphism.
\end{remark}

\begin{remark}[Localization and derived completion]
\label{remark-localization-and-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of
ideals. Let $K \mapsto K^\wedge$ be the derived completion functor
of Proposition \ref{proposition-derived-completion}. It follows
from the construction in the proof of the proposition that $K^\wedge|_U$
is the derived completion of $K|_U$ for any $U \in \Ob(\mathcal{C})$.
But we can also prove this as follows. From the definition
of derived complete objects it follows that $K^\wedge|_U$ is derived complete.
Thus we obtain a canonical map $a : (K|_U)^\wedge \to K^\wedge|_U$.
On the other hand, if $E$ is a derived complete object of
$D(\mathcal{O}_U)$, then $Rj_*E$ is a derived complete object of
$D(\mathcal{O})$ by Lemma \ref{lemma-pushforward-derived-complete}.
Here $j$ is the localization morphism
(Modules on Sites, Section \ref{sites-modules-section-localize}).
Hence we also obtain a canonical
map $b : K^\wedge \to Rj_*((K|_U)^\wedge)$. We omit the (formal) verification
that the adjoint of $b$ is the inverse of $a$.
\end{remark}

\begin{remark}[Completed tensor product]
\label{remark-completed-tensor-product}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let
$\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of ideals. 
Denote $K \mapsto K^\wedge$ the adjoint of
Proposition \ref{proposition-derived-completion}.
Then we set
$$
K \otimes^\wedge_\mathcal{O} L = (K \otimes_\mathcal{O}^\mathbf{L} L)^\wedge
$$
This {\it completed tensor product} defines a functor
$D_{comp}(\mathcal{O}) \times D_{comp}(\mathcal{O}) \to D_{comp}(\mathcal{O})$
such that we have
$$
\Hom_{D_{comp}(\mathcal{O})}(K, R\SheafHom_\mathcal{O}(L, M))
=
\Hom_{D_{comp}(\mathcal{O})}(K \otimes_\mathcal{O}^\wedge L, M)
$$
for $K, L, M \in D_{comp}(\mathcal{O})$. Note that
$R\SheafHom_\mathcal{O}(L, M) \in D_{comp}(\mathcal{O})$ by
Lemma \ref{lemma-derived-complete-internal-hom}.
\end{remark}

\begin{lemma}
\label{lemma-map-identifies-koszul-and-cech-complexes}
Let $\mathcal{C}$ be a site.
Assume $\varphi : \mathcal{O} \to \mathcal{O}'$ is a flat homomorphism
of sheaves of rings. Let $f_1, \ldots, f_r$ be global sections
of $\mathcal{O}$ such that
$\mathcal{O}/(f_1, \ldots, f_r) \cong \mathcal{O}'/(f_1, \ldots, f_r)$.
Then the map of extended alternating {\v C}ech complexes
$$
\xymatrix{
\mathcal{O} \to
\prod_{i_0} \mathcal{O}_{f_{i_0}} \to
\prod_{i_0 < i_1} \mathcal{O}_{f_{i_0}f_{i_1}} \to \ldots \to
\mathcal{O}_{f_1\ldots f_r} \ar[d] \\
\mathcal{O}' \to
\prod_{i_0} \mathcal{O}'_{f_{i_0}} \to
\prod_{i_0 < i_1} \mathcal{O}'_{f_{i_0}f_{i_1}} \to \ldots \to
\mathcal{O}'_{f_1\ldots f_r}
}
$$
is a quasi-isomorphism.
\end{lemma}

\begin{proof}
Observe that the second complex is the tensor product of the first
complex with $\mathcal{O}'$. We can write the first extended
alternating {\v C}ech complex as a colimit of the Koszul complexes
$K_n = K(\mathcal{O}, f_1^n, \ldots, f_r^n)$, see
More on Algebra, Lemma
\ref{more-algebra-lemma-extended-alternating-Cech-is-colimit-koszul}.
Hence it suffices to prove $K_n \to K_n \otimes_\mathcal{O} \mathcal{O}'$
is a quasi-isomorphism. Since $\mathcal{O} \to \mathcal{O}'$ is flat
it suffices to show that $H^i \to H^i \otimes_\mathcal{O} \mathcal{O}'$
is an isomorphism where $H^i$ is the $i$th cohomology sheaf
$H^i = H^i(K_n)$. These sheaves are annihilated by $f_1^n, \ldots, f_r^n$, see
More on Algebra, Lemma \ref{more-algebra-lemma-homotopy-koszul}.
Thus it suffices to show that
$\mathcal{O}/(f_1^n, \ldots, f_r^n) \to \mathcal{O}'/(f_1^n, \ldots, f_r^n)$
is an isomorphism. Equivalently, we will show that
$\mathcal{O}/(f_1, \ldots, f_r)^n \to \mathcal{O}'/(f_1, \ldots, f_r)^n$
is an isomorphism for all $n$. This holds for $n = 1$ by assumption.
It follows for all $n$ by induction using
Modules on Sites, Lemma \ref{sites-modules-lemma-flat-over-thickening}
applied to the ring map
$\mathcal{O}/(f_1, \ldots, f_r)^{n + 1} \to \mathcal{O}/(f_1, \ldots, f_r)^n$
and the module $\mathcal{O}'/(f_1, \ldots, f_r)^{n + 1}$.
\end{proof}

\begin{lemma}
\label{lemma-restriction-derived-complete-equivalence}
Let $\mathcal{C}$ be a site. Let $\mathcal{O} \to \mathcal{O}'$ be a
homomorphism of sheaves of rings. Let $\mathcal{I} \subset \mathcal{O}$
be a finite type sheaf of ideals.
If $\mathcal{O} \to \mathcal{O}'$ is flat and
$\mathcal{O}/\mathcal{I} \cong \mathcal{O}'/\mathcal{I}\mathcal{O}'$,
then the restriction functor $D(\mathcal{O}') \to D(\mathcal{O})$
induces an equivalence
$D_{comp}(\mathcal{O}', \mathcal{I}\mathcal{O}') \to
D_{comp}(\mathcal{O}, \mathcal{I})$.
\end{lemma}

\begin{proof}
Lemma \ref{lemma-pushforward-derived-complete} implies
restriction $r : D(\mathcal{O}') \to D(\mathcal{O})$
sends $D_{comp}(\mathcal{O}', \mathcal{I}\mathcal{O}')$
into $D_{comp}(\mathcal{O}, \mathcal{I})$. We will construct a
quasi-inverse $E \mapsto E'$.

\medskip\noindent
Let $K \to \mathcal{O}$ be the morphism of $D(\mathcal{O})$
constructed in Lemma \ref{lemma-global-extended-cech-complex}. 
Set $K' = K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}'$ in $D(\mathcal{O}')$.
Then $K' \to \mathcal{O}'$ is a map in $D(\mathcal{O}')$ which
satisfies the conclusions of Lemma \ref{lemma-global-extended-cech-complex}
with respect to $\mathcal{I}' = \mathcal{I}\mathcal{O}'$.
The map $K \to r(K')$ is a quasi-isomorphism by
Lemma \ref{lemma-map-identifies-koszul-and-cech-complexes}.
Now, for $E \in D_{comp}(\mathcal{O}, \mathcal{I})$ we set
$$
E' = R\SheafHom_\mathcal{O}(r(K'), E)
$$
viewed as an object in $D(\mathcal{O}')$ using the $\mathcal{O}'$-module
structure on $K'$. Since $E$ is derived complete
we have $E = R\SheafHom_\mathcal{O}(K, E)$, see
proof of Proposition \ref{proposition-derived-completion}.
On the other hand, since $K \to r(K')$ is an isomorphism in
we see that there is an isomorphism
$E \to r(E')$ in $D(\mathcal{O})$. To finish the proof we
have to show that, if $E = r(M')$ for an object $M'$ of
$D_{comp}(\mathcal{O}', \mathcal{I}')$, then
$E' \cong M'$. To get a map we use
$$
M' = R\SheafHom_{\mathcal{O}'}(\mathcal{O}', M') \to
R\SheafHom_\mathcal{O}(r(\mathcal{O}'), r(M')) \to
R\SheafHom_\mathcal{O}(r(K'), r(M')) = E'
$$
where the second arrow uses the map $K' \to \mathcal{O}'$.
To see that this is an isomorphism, one shows that $r$ applied
to this arrow is the same as the isomorphism $E \to r(E')$ above.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-derived-complete-adjoint}
Let $f : (\Sh(\mathcal{D}), \mathcal{O}') \to (\Sh(\mathcal{C}), \mathcal{O})$
be a morphism of ringed topoi. Let $\mathcal{I} \subset \mathcal{O}$
and $\mathcal{I}' \subset \mathcal{O}'$ 
be finite type sheaves of ideals such that $f^\sharp$ sends
$f^{-1}\mathcal{I}$ into $\mathcal{I}'$.
Then $Rf_*$ sends $D_{comp}(\mathcal{O}', \mathcal{I}')$
into $D_{comp}(\mathcal{O}, \mathcal{I})$ and has a left adjoint
$Lf_{comp}^*$ which is $Lf^*$ followed by derived completion.
\end{lemma}

\begin{proof}
The first statement we have seen in
Lemma \ref{lemma-pushforward-derived-complete}.
Note that the second statement makes sense as we have a derived
completion functor $D(\mathcal{O}') \to D_{comp}(\mathcal{O}', \mathcal{I}')$
by Proposition \ref{proposition-derived-completion}.
OK, so now let $K \in D_{comp}(\mathcal{O}, \mathcal{I})$
and $M \in D_{comp}(\mathcal{O}', \mathcal{I}')$. Then we have
$$
\Hom(K, Rf_*M) = \Hom(Lf^*K, M) = \Hom(Lf_{comp}^*K, M)
$$
by the universal property of derived completion.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-commutes-with-derived-completion}
\begin{reference}
Generalization of \cite[Lemma 6.5.9 (2)]{BS}. Compare with
\cite[Theorem 6.5]{HL-P} in the setting of quasi-coherent modules
and morphisms of (derived) algebraic stacks.
\end{reference}
Let $f : (\Sh(\mathcal{D}), \mathcal{O}') \to (\Sh(\mathcal{C}), \mathcal{O})$
be a morphism of ringed topoi. Let $\mathcal{I} \subset \mathcal{O}$
be a finite type sheaf of ideals. Let $\mathcal{I}' \subset \mathcal{O}'$
be the ideal generated by $f^\sharp(f^{-1}\mathcal{I})$.
Then $Rf_*$ commutes with derived completion, i.e.,
$Rf_*(K^\wedge) = (Rf_*K)^\wedge$.
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-derived-completion} the derived completion
functors exist. By Lemma \ref{lemma-pushforward-derived-complete} the object
$Rf_*(K^\wedge)$ is derived complete, and hence we obtain a canonical map
$(Rf_*K)^\wedge \to Rf_*(K^\wedge)$ by the universal property of derived
completion. We may check this map is an isomorphism locally on $\mathcal{C}$.
Thus, since derived completion commutes with localization
(Remark \ref{remark-localization-and-completion}) we may assume
that $\mathcal{I}$ is generated by global sections $f_1, \ldots, f_r$.
Then $\mathcal{I}'$ is generated by $g_i = f^\sharp(f_i)$. By
Lemma \ref{lemma-derived-completion-koszul}
we have to prove that
$$
R\lim \left(
Rf_*K \otimes^\mathbf{L}_\mathcal{O} K(\mathcal{O}, f_1^n, \ldots, f_r^n)
\right)
=
Rf_*\left(
R\lim
K \otimes^\mathbf{L}_{\mathcal{O}'} K(\mathcal{O}', g_1^n, \ldots, g_r^n)
\right)
$$
Because $Rf_*$ commutes with $R\lim$
(Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-Rf-commutes-with-Rlim})
it suffices to prove that
$$
Rf_*K \otimes^\mathbf{L}_\mathcal{O} K(\mathcal{O}, f_1^n, \ldots, f_r^n) =
Rf_*\left(
K \otimes^\mathbf{L}_{\mathcal{O}'} K(\mathcal{O}', g_1^n, \ldots, g_r^n)
\right)
$$
This follows from the projection formula (Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-projection-formula}) and the fact that
$Lf^*K(\mathcal{O}, f_1^n, \ldots, f_r^n) =
K(\mathcal{O}', g_1^n, \ldots, g_r^n)$.
\end{proof}

\begin{lemma}
\label{lemma-formal-functions-general}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Let $\mathcal{C}$ be a site and let $\mathcal{O}$ be a sheaf
of $A$-algebras. Let $\mathcal{F}$ be a sheaf of $\mathcal{O}$-modules.
Then we have
$$
R\Gamma(\mathcal{C}, \mathcal{F})^\wedge =
R\Gamma(\mathcal{C}, \mathcal{F}^\wedge)
$$
in $D(A)$ where $\mathcal{F}^\wedge$ is the derived
completion of $\mathcal{F}$ with respect to $I\mathcal{O}$ and on the
left hand wide we have the derived completion with respect to $I$.
This produces two spectral sequences
$$
E_2^{i, j} = H^i(H^j(\mathcal{C}, \mathcal{F})^\wedge)
\quad\text{and}\quad
E_2^{p, q} = H^p(\mathcal{C}, H^q(\mathcal{F}^\wedge))
$$
both converging to
$H^*(R\Gamma(\mathcal{C}, \mathcal{F})^\wedge) =
H^*(\mathcal{C}, \mathcal{F}^\wedge)$
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-pushforward-commutes-with-derived-completion}
to the morphism of ringed topoi $(\mathcal{C}, \mathcal{O}) \to (pt, A)$
and take cohomology to get the first statement. The second spectral sequence
is the second spectral sequence of
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
The first spectral sequence is the spectral sequence of
More on Algebra, Example
\ref{more-algebra-example-derived-completion-spectral-sequence}
applied to $R\Gamma(\mathcal{C}, \mathcal{F})^\wedge$.
\end{proof}

\begin{remark}
\label{remark-local-calculation-derived-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of
ideals. Let $K \mapsto K^\wedge$ be the derived completion of
Proposition \ref{proposition-derived-completion}.
Let $U \in \Ob(\mathcal{C})$ be an object such that $\mathcal{I}$
is generated as an ideal sheaf by $f_1, \ldots, f_r \in \mathcal{I}(U)$.
Set $A = \mathcal{O}(U)$ and $I = (f_1, \ldots, f_r) \subset A$.
Warning: it may not be the case that $I = \mathcal{I}(U)$.
Then we have
$$
R\Gamma(U, K^\wedge) = R\Gamma(U, K)^\wedge
$$
where the right hand side is the derived completion of
the object $R\Gamma(U, K)$ of $D(A)$ with respect to $I$.
This is true because derived completion commutes with localization
(Remark \ref{remark-localization-and-completion}) and
Lemma \ref{lemma-formal-functions-general}.
\end{remark}








\section{The theorem on formal functions}
\label{section-formal-functions}

\noindent
We interrupt the flow of the exposition to talk a little bit about
derived completion in the setting of quasi-coherent modules on schemes
and to use this to give a somewhat different proof of the theorem on
formal functions. We give some pointers to the literature in
Remark \ref{remark-references}.

\medskip\noindent
Lemma \ref{lemma-pushforward-commutes-with-derived-completion} is a
(very formal) derived version of the theorem on formal functions
(Cohomology of Schemes, Theorem \ref{coherent-theorem-formal-functions}).
To make this more explicit, suppose $f : X \to S$ is a morphism of schemes,
$\mathcal{I} \subset \mathcal{O}_S$ is a quasi-coherent sheaf of ideals
of finite type,
and $\mathcal{F}$ is a quasi-coherent sheaf on $X$. Then the lemma says that
\begin{equation}
\label{equation-formal-functions}
Rf_*(\mathcal{F}^\wedge) = (Rf_*\mathcal{F})^\wedge
\end{equation}
where $\mathcal{F}^\wedge$ is the derived completion of $\mathcal{F}$
with respect to $f^{-1}\mathcal{I} \cdot \mathcal{O}_X$ and the right
hand side is the derived completion of $Rf_*\mathcal{F}$
with respect to $\mathcal{I}$. To see that this gives back the theorem
on formal functions we have to do a bit of work.

\begin{lemma}
\label{lemma-sections-derived-completion-pseudo-coherent}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. Let $K$ be a
pseudo-coherent object of $D(\mathcal{O}_X)$ with derived completion
$K^\wedge$. Then
$$
H^p(U, K^\wedge) = \lim H^p(U, K)/I^nH^p(U, K) =
H^p(U, K)^\wedge
$$
for any affine open $U \subset X$
where $I = \mathcal{I}(U)$ and where on the right we have the derived
completion with respect to $I$.
\end{lemma}

\begin{proof}
Write $U = \Spec(A)$. The ring $A$ is Noetherian
and hence $I \subset A$ is finitely generated. Then we have
$$
R\Gamma(U, K^\wedge) = R\Gamma(U, K)^\wedge
$$
by Remark \ref{remark-local-calculation-derived-completion}.
Now $R\Gamma(U, K)$ is a pseudo-coherent complex of $A$-modules
(Derived Categories of Schemes, Lemma
\ref{perfect-lemma-pseudo-coherent-affine}).
By More on Algebra, Lemma
\ref{more-algebra-lemma-derived-completion-pseudo-coherent}
we conclude that the $p$th cohomology module of $R\Gamma(U, K^\wedge)$
is equal to the $I$-adic completion of $H^p(U, K)$.
This proves the first equality. The second (less important) equality
follows immediately from a second application of the lemma just used.
\end{proof}

\begin{lemma}
\label{lemma-derived-completion-pseudo-coherent}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals.
Let $K$ be an object of $D(\mathcal{O}_X)$. Then
\begin{enumerate}
\item the derived completion $K^\wedge$ is equal to
$R\lim (K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_X/\mathcal{I}^n)$.
\end{enumerate}
Let $K$ is a pseudo-coherent object of $D(\mathcal{O}_X)$. Then
\begin{enumerate}
\item[(2)] the cohomology sheaf $H^q(K^\wedge)$ is equal to
$\lim H^q(K)/\mathcal{I}^nH^q(K)$.
\end{enumerate}
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module\footnote{For example
$H^q(K)$ for $K$ pseudo-coherent on our locally Noetherian $X$.}. Then
\begin{enumerate}
\item[(3)] the derived completion $\mathcal{F}^\wedge$ is equal to
$\lim \mathcal{F}/\mathcal{I}^n\mathcal{F}$,
\item[(4)]
$\lim \mathcal{F}/I^n \mathcal{F} = R\lim \mathcal{F}/I^n \mathcal{F}$,
\item[(5)] $H^p(U, \mathcal{F}^\wedge) = 0$ for $p \not = 0$ for all
affine opens $U \subset X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). There is a canonical map
$$
K \longrightarrow
R\lim (K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_X/\mathcal{I}^n),
$$
see Remark \ref{remark-compare-with-completion}.
Derived completion commutes with passing to open subschemes
(Remark \ref{remark-localization-and-completion}).
Formation of $R\lim$ commutes with passsing to open subschemes.
It follows that to check our map is an isomorphism, we may work locally.
Thus we may assume $X = U = \Spec(A)$.
Say $I = (f_1, \ldots, f_r)$. Let
$K_n = K(A, f_1^n, \ldots, f_r^n)$ be the Koszul complex.
By More on Algebra, Lemma \ref{more-algebra-lemma-sequence-Koszul-complexes}
we have seen that the pro-systems $\{K_n\}$ and
$\{A/I^n\}$ of $D(A)$ are isomorphic.
Using the equivalence $D(A) = D_{\QCoh}(\mathcal{O}_X)$
of Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}
we see that the pro-systems $\{K(\mathcal{O}_X, f_1^n, \ldots, f_r^n)\}$
and $\{\mathcal{O}_X/\mathcal{I}^n\}$ are isomorphic in
$D(\mathcal{O}_X)$. This proves the second equality in
$$
K^\wedge = R\lim \left(
K \otimes_{\mathcal{O}_X}^\mathbf{L} K(\mathcal{O}_X, f_1^n, \ldots, f_r^n)
\right) =
R\lim (K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_X/\mathcal{I}^n)
$$
The first equality is
Lemma \ref{lemma-derived-completion-koszul}.

\medskip\noindent
Assume $K$ is pseudo-coherent. For $U \subset X$ affine open
we have $H^q(U, K^\wedge) = \lim H^q(U, K)/\mathcal{I}^n(U)H^q(U, K)$
by Lemma \ref{lemma-sections-derived-completion-pseudo-coherent}.
As this is true for every $U$ we see that
$H^q(K^\wedge) = \lim H^q(K)/\mathcal{I}^nH^q(K)$ as sheaves.
This proves (2).

\medskip\noindent
Part (3) is a special case of (2).
Parts (4) and (5) follow from
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-Rlim-quasi-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-formal-functions}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal. Let $X$ be a
Noetherian scheme over $A$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_X$-module. Assume that $H^p(X, \mathcal{F})$ is
a finite $A$-module for all $p$. Then there are short exact sequences
$$
0 \to R^1\lim H^{p - 1}(X, \mathcal{F}/I^n\mathcal{F}) \to
H^p(X, \mathcal{F})^\wedge \to \lim H^p(X, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
of $A$-modules where $H^p(X, \mathcal{F})^\wedge$ is the usual $I$-adic
completion. If $f$ is proper, then the $R^1\lim$ term is zero.
\end{lemma}

\begin{proof}
Consider the two spectral sequences of
Lemma \ref{lemma-formal-functions-general}.
The first degenerates by More on Algebra, Lemma
\ref{more-algebra-lemma-derived-completion-pseudo-coherent}.
We obtain $H^p(X, \mathcal{F})^\wedge$ in degree $p$.
This is where we use the assumption that $H^p(X, \mathcal{F})$ is
a finite $A$-module. The second degenerates because
$$
\mathcal{F}^\wedge = \lim \mathcal{F}/I^n\mathcal{F} =
R\lim \mathcal{F}/I^n\mathcal{F}
$$
is a sheaf by Lemma \ref{lemma-derived-completion-pseudo-coherent}.
We obtain $H^p(X, \lim \mathcal{F}/I^n\mathcal{F})$ in degree $p$.
Since $R\Gamma(X, -)$ commutes with derived limits
(Injectives, Lemma \ref{injectives-lemma-RF-commutes-with-Rlim})
we also get
$$
R\Gamma(X, \lim \mathcal{F}/I^n\mathcal{F}) =
R\Gamma(X, R\lim \mathcal{F}/I^n\mathcal{F}) =
R\lim R\Gamma(X, \mathcal{F}/I^n\mathcal{F})
$$
By More on Algebra, Remark
\ref{more-algebra-remark-how-unique}
we obtain exact sequences
$$
0 \to
R^1\lim H^{p - 1}(X, \mathcal{F}/I^n\mathcal{F}) \to
H^p(X, \lim \mathcal{F}/I^n\mathcal{F}) \to
\lim H^p(X, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
of $A$-modules. Combining the above we get the first statement of the lemma.
The vanishing of the $R^1\lim$ term follows from
Cohomology of Schemes, Lemma \ref{coherent-lemma-ML-cohomology-powers-ideal}.
\end{proof}

\begin{remark}
\label{remark-references}
Here are some references to discussions of related material the literature.
It seems that a ``derived formal functions theorem'' for proper maps
goes back to \cite[Theorem 6.3.1]{lurie-thesis}.
There is the discussion in \cite{dag12}, especially
Chapter 4 which discusses the affine story, see
More on Algebra, Section \ref{more-algebra-section-derived-completion}.
In \cite[Section 2.9]{G-R} one finds a discussion of proper base change and
derived completion using (ind) coherent modules.
An analogue of (\ref{equation-formal-functions})
for complexes of quasi-coherent modules can be found as
\cite[Theorem 6.5]{HL-P}
\end{remark}







\section{Algebraization of local cohomology, I}
\label{section-algebraization-sections-general}

\noindent
Let $A$ be a Noetherian ring and let $I$ and $J$ be two ideals of $A$.
Let $M$ be a finite $A$-module. In this section we study the
cohomology groups of the object
$$
R\Gamma_J(M)^\wedge
\quad\text{of}\quad
D(A)
$$
where ${}^\wedge$ denotes derived $I$-adic completion. Observe that in
Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local-H0}
we have shown, if $A$ is complete with respect to $I$,
that there is an isomorphism
$$
\colim H^0_Z(M) \longrightarrow H^0(R\Gamma_J(M)^\wedge)
$$
where the (directed) colimit is over the closed subsets $Z = V(J')$
with $J' \subset J$ and $V(J') \cap V(I) = V(J) \cap V(I)$.
The union of these closed subsets is
\begin{equation}
\label{equation-associated-subset}
T = \{\mathfrak p \in \Spec(A) :
V(\mathfrak p) \cap V(I) \subset V(J) \cap V(I)\}
\end{equation}
This is a subset of $\Spec(A)$ stable under specialization.
The result above becomes the statement that
$$
H^0_T(M) \longrightarrow H^0(R\Gamma_J(M)^\wedge)
$$
is an isomorphism provided $A$ is complete with respect to $I$, see
Local Cohomology, Lemma \ref{local-cohomology-lemma-adjoint-ext} and
Remark \ref{local-cohomology-remark-upshot}.
Our method to extend this isomorphism to higher cohomology groups
rests on the following lemma.

\begin{lemma}
\label{lemma-kill-completion-general}
Let $I, J$ be ideals of a Noetherian ring $A$.
Let $M$ be a finite $A$-module. Let $\mathfrak p \subset A$ be a prime.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item $\mathfrak p \not \in V(J) \cap V(I)$,
\item $\text{cd}(A, I) \leq d$, and
\item for all primes $\mathfrak p' \subset \mathfrak p$
we have
$\text{depth}_{A_{\mathfrak p'}}(M_{\mathfrak p'}) +
\dim((A/\mathfrak p')_\mathfrak q) > d + s$
for all $\mathfrak q \in V(\mathfrak p') \cap V(J) \cap V(I)$.
\end{enumerate}
Then there exists an $f \in A$, $f \not \in \mathfrak p$ which annihilates
$H^i(R\Gamma_J(M)^\wedge)$ for $i \leq s$ where ${}^\wedge$
indicates $I$-adic completion.
\end{lemma}

\begin{proof}
We will use that $R\Gamma_J = R\Gamma_{V(J)}$ and similarly for
$I + J$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-noetherian}.
Observe that
$R\Gamma_J(M)^\wedge = R\Gamma_I(R\Gamma_J(M))^\wedge =
R\Gamma_{I + J}(M)^\wedge$, see
Dualizing Complexes, Lemmas
\ref{dualizing-lemma-complete-and-local} and
\ref{dualizing-lemma-local-cohomology-ss}.
Thus we may replace $J$ by $I + J$ and assume $I \subset J$
and $\mathfrak p \not \in V(J)$.
Recall that
$$
R\Gamma_J(M)^\wedge = R\Hom_A(R\Gamma_I(A), R\Gamma_J(M))
$$
by the description of derived completion in
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion}
combined with the description of local cohomology in
Dualizing Complexes, Lemma
\ref{dualizing-lemma-compute-local-cohomology-noetherian}.
Assumption (3) means that $R\Gamma_I(A)$ has nonzero cohomology
only in degrees $\leq d$. Using the canonical truncations of
$R\Gamma_I(A)$ we find it suffices to show that
$$
\text{Ext}^i(N, R\Gamma_J(M))
$$
is annihilated by an $f \in A$, $f \not \in \mathfrak p$ for
$i \leq s + d$ and any $A$-module $N$.
In turn using the canonical truncations for $R\Gamma_J(M)$
we see that it suffices to show
$H^i_J(M)$ is annihilated by an $f \in A$, $f \not \in \mathfrak p$
for $i \leq s + d$.
This follows from Local Cohomology, Lemma
\ref{local-cohomology-lemma-kill-local-cohomology-at-prime}.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-weak-general}
Let $I, J$ be ideals of a Noetherian ring. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. With $T$ as in
(\ref{equation-associated-subset}) assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item if $\mathfrak p \in V(I)$, then no condition,
\item if $\mathfrak p \not \in V(I)$, $\mathfrak p \in T$, then
$\dim((A/\mathfrak p)_\mathfrak q) \leq d$ for some
$\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$,
\item if $\mathfrak p \not \in V(I)$, $\mathfrak p \not \in T$, then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
for all $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$.
\end{enumerate}
Then there exists an ideal $J_0 \subset J$ with
$V(J_0) \cap V(I) = V(J) \cap V(I)$ such that for any $J' \subset J_0$ with
$V(J') \cap V(I) = V(J) \cap V(I)$ the map
$$
R\Gamma_{J'}(M) \longrightarrow R\Gamma_{J_0}(M)
$$
induces an isomorphism in cohomology in degrees $\leq s$
and moreover these modules are annihilated by a power of $J_0I$.
\end{lemma}

\begin{proof}
Let us consider the set
$$
B = \{\mathfrak p \not \in V(I),\ \mathfrak p \in T,\text{ and }
\text{depth}(M_\mathfrak p) \leq s\}
$$
Choose $J_0 \subset J$ such that $V(J_0)$ is the closure of $B \cup V(J)$.

\medskip\noindent
Claim I: $V(J_0) \cap V(I) = V(J) \cap V(I)$.

\medskip\noindent
Proof of Claim I. The inclusion $\supset$ holds by construction.
Let $\mathfrak p$ be a minimal prime of $V(J_0)$.
If $\mathfrak p \in B \cup V(J)$, then either $\mathfrak p \in T$
or $\mathfrak p \in V(J)$ and in both cases
$V(\mathfrak p) \cap V(I) \subset V(J) \cap V(I)$ as desired.
If $\mathfrak p \not \in B \cup V(J)$, then
$V(\mathfrak p) \cap B$ is dense, hence infinite, and we conclude that
$\text{depth}(M_\mathfrak p) < s$ by
Local Cohomology, Lemma \ref{local-cohomology-lemma-depth-function}.
In fact, let
$V(\mathfrak p) \cap B = \{\mathfrak p_\lambda\}_{\lambda \in \Lambda}$.
Pick $\mathfrak q_\lambda \in V(\mathfrak p_\lambda) \cap V(J) \cap V(I)$
as in (3).
Let $\delta : \Spec(A) \to \mathbf{Z}$ be the dimension function
associated to a dualizing complex $\omega_A^\bullet$ for $A$.
Since $\Lambda$ is infinite and $\delta$ is bounded,
there exists an infinite subset $\Lambda' \subset \Lambda$ on which
$\delta(\mathfrak q_\lambda)$ is constant. For
$\lambda \in \Lambda'$ we have
$$
\text{depth}(M_{\mathfrak p_\lambda}) +
\delta(\mathfrak p_\lambda) - \delta(\mathfrak q_\lambda) =
\text{depth}(M_{\mathfrak p_\lambda}) +
\dim((A/\mathfrak p_\lambda)_{\mathfrak q_\lambda})
\leq d + s
$$
by (3) and the definition of $B$. By the semi-continuity of
the function $\text{depth} + \delta$ proved in
Duality for Schemes, Lemma \ref{duality-lemma-sitting-in-degrees}
we conclude that
$$
\text{depth}(M_\mathfrak p) +
\dim((A/\mathfrak p)_{\mathfrak q_\lambda}) =
\text{depth}(M_\mathfrak p) + \delta(\mathfrak p) - \delta(\mathfrak q_\lambda)
\leq d + s
$$
Since also $\mathfrak p \not \in V(I)$ we read off from (4) that
$\mathfrak p \in T$, i.e.,
$V(\mathfrak p) \cap V(I) \subset V(J) \cap V(I)$. This finishes the
proof of Claim I.

\medskip\noindent
Claim II: $H^i_{J_0}(M) \to H^i_J(M)$ is an isomorphism for $i \leq s$
and $J' \subset J_0$ with $V(J') \cap V(I) = V(J) \cap V(I)$.

\medskip\noindent
Proof of claim II. Choose $\mathfrak p \in V(J')$ not in $V(J_0)$.
It suffices to show that $H^i_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$
for $i \leq s$, see
Local Cohomology, Lemma \ref{local-cohomology-lemma-isomorphism}.
Observe that $\mathfrak p \in T$. Hence since $\mathfrak p$ is not in $B$
we see that $\text{depth}(M_\mathfrak p) > s$ and the groups vanish by
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}.

\medskip\noindent
Claim III. The final statement of the lemma is true.

\medskip\noindent
By Claim II for $i \leq s$ we have
$$
H^i_T(M) = H^i_{J_0}(M) = H^i_{J'}(M)
$$
for all ideals $J' \subset J_0$ with $V(J')  \cap V(I) = V(J) \cap V(I)$.
See Local Cohomology, Lemma \ref{local-cohomology-lemma-adjoint-ext}.
Let us check the hypotheses of Local Cohomology,
Proposition \ref{local-cohomology-proposition-annihilator}
for the subsets $T \subset T \cup V(I)$, the module $M$, and the integer $s$.
We have to show that given $\mathfrak p \subset \mathfrak q$
with $\mathfrak p \not \in T \cup V(I)$ and $\mathfrak q \in T$
we have
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s
$$
If $\text{depth}(M_\mathfrak p) \geq s$, then this is true because
the dimension of $(A/\mathfrak p)_\mathfrak q$ is at least $1$.
Thus we may assume $\text{depth}(M_\mathfrak p) < s$.
If $\mathfrak q \in V(I)$, then $\mathfrak q \in V(J) \cap V(I)$
and the inequality holds by (4). If $\mathfrak q \not \in V(I)$,
then we can use (3) to pick
$\mathfrak q' \in V(\mathfrak q) \cap V(J) \cap V(I)$ with
$\dim((A/\mathfrak q)_{\mathfrak q'}) \leq d$.
Then assumption (4) gives
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_{\mathfrak q'}) > s + d
$$
Since $A$ is catenary this implies the inequality we want.
Applying Local Cohomology,
Proposition \ref{local-cohomology-proposition-annihilator} we
find $J'' \subset A$ with $V(J'') \subset T \cup V(I)$
such that $J''$ annihilates $H^i_T(M)$ for $i \leq s$.
Then we can write $V(J'') \cup V(J_0) \cup V(I) = V(J'I)$
for some $J' \subset J_0$ with $V(J') \cap V(I) = V(J) \cap V(I)$.
Replacing $J_0$ by $J'$ the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-general}
In Lemma \ref{lemma-kill-colimit-weak-general} if instead of the empty
condition (2) we assume
\begin{enumerate}
\item[(2')] if $\mathfrak p \in V(I)$, $\mathfrak p \not \in V(J) \cap V(I)$,
then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s$
for all $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$,
\end{enumerate}
then the conditions also imply that $H^i_{J_0}(M)$ is a finite
$A$-module for $i \leq s$.
\end{lemma}

\begin{proof}
Recall that $H^i_{J_0}(M) = H^i_T(M)$, see proof of
Lemma \ref{lemma-kill-colimit-weak-general}. Thus it suffices to
check that for $\mathfrak p \not \in T$ and $\mathfrak q \in T$
with $\mathfrak p \subset \mathfrak q$ we have
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s$, see Local Cohomology,
Proposition \ref{local-cohomology-proposition-finiteness}.
Condition (2') tells us this is true for $\mathfrak p \in V(I)$.
Since we know $H^i_T(M)$ is annihilated by a power of $IJ_0$
we know the condition holds if $\mathfrak p \not \in V(IJ_0)$
by Local Cohomology, Proposition \ref{local-cohomology-proposition-annihilator}.
This covers all cases and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-support-general}
If in Lemma \ref{lemma-kill-colimit-weak-general} we additionally assume
\begin{enumerate}
\item[(6)] if $\mathfrak p \not \in V(I)$, $\mathfrak p \in T$, then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$,
\end{enumerate}
then $H^i_{J_0}(M) = H^i_J(M) = H^i_{J + I}(M)$ for $i \leq s$ and these
modules are annihilated by a power of $I$.
\end{lemma}

\begin{proof}
Choose $\mathfrak p \in V(J)$ or $\mathfrak p \in V(J_0)$ but
$\mathfrak p \not \in V(J + I) = V(J_0 + I)$.
It suffices to show that $H^i_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$
for $i \leq s$, see
Local Cohomology, Lemma \ref{local-cohomology-lemma-isomorphism}.
These groups vanish by condition (6) and
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}.
The final statement follows from
Local Cohomology, Proposition \ref{local-cohomology-proposition-annihilator}.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-local-cohomology-general}
Let $I, J$ be ideals of a Noetherian ring $A$.
Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. With $T$ as in
(\ref{equation-associated-subset}) assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $\mathfrak p \in V(I)$ no condition,
\item $\text{cd}(A, I) \leq d$,
\item if $\mathfrak p \not \in V(I)$, $\mathfrak p \not \in T$ then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
for all $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$,
\item if $\mathfrak p \not \in V(I)$, $\mathfrak p \not \in T$,
$V(\mathfrak p) \cap V(J) \cap V(I) \not = \emptyset$, and
$\text{depth}(M_\mathfrak p) < s$, then one
of the following holds\footnote{Our method
forces this additional condition. We will return to this
(insert future reference).}:
\begin{enumerate}
\item $\dim(\text{Supp}(M_\mathfrak p)) < s + 2$\footnote{For example
if $M$ satisfies Serre's condition $(S_s)$
on the complement of $V(I) \cup T$.}, or
\item  $\delta(\mathfrak p) > d + \delta_{max} - 1$
where $\delta$ is a dimension function and $\delta_{max}$
is the maximum of $\delta$ on $V(J) \cap V(I)$, or
\item $\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s + \delta_{max} - \delta_{min} - 2$
for all $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$.
\end{enumerate}
\end{enumerate}
Then there exists an ideal $J_0 \subset J$ with
$V(J_0) \cap V(I) = V(J) \cap V(I)$
such that for any $J' \subset J_0$ with
$V(J') \cap V(I) = V(J) \cap V(I)$ the map
$$
R\Gamma_{J'}(M) \longrightarrow R\Gamma_J(M)^\wedge
$$
induces an isomorphism on cohomology in degrees $\leq s$.
Here ${}^\wedge$ denotes derived $I$-adic completion.
\end{lemma}

\noindent
We encourage the reader to read the proof in the local case first
(Lemma \ref{lemma-algebraize-local-cohomology}) as it explains the structure
of the proof without having to deal with all the inequalities.

\begin{proof}
For an ideal $\mathfrak a \subset A$ we have
$R\Gamma_\mathfrak a = R\Gamma_{V(\mathfrak a)}$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-noetherian}.
Next, we observe that
$$
R\Gamma_J(M)^\wedge =
R\Gamma_I(R\Gamma_J(M))^\wedge =
R\Gamma_{I + J}(M)^\wedge =
R\Gamma_{I + J'}(M)^\wedge =
R\Gamma_I(R\Gamma_{J'}(M))^\wedge =
R\Gamma_{J'}(M)^\wedge
$$
by Dualizing Complexes, Lemmas \ref{dualizing-lemma-local-cohomology-ss} and
\ref{dualizing-lemma-complete-and-local}.
This explains how we define the arrow in the statement of the lemma.

\medskip\noindent
We claim that the hypotheses of Lemma \ref{lemma-kill-colimit-weak-general}
are implied by our current hypotheses on $M$.
The only thing to verify is hypothesis (3).
Thus let $\mathfrak p \not \in V(I)$, $\mathfrak p \in T$.
Then $V(\mathfrak p) \cap V(I)$ is nonempty as $I$ is
contained in the Jacobson radical of $A$
(Algebra, Lemma \ref{algebra-lemma-radical-completion}).
Since $\mathfrak p \in T$ we have
$V(\mathfrak p) \cap V(I) = V(\mathfrak p) \cap V(J) \cap V(I)$.
Let $\mathfrak q \in V(\mathfrak p) \cap V(I)$ be the
generic point of an irreducible component.
We have $\text{cd}(A_\mathfrak q, I_\mathfrak q) \leq d$
by Local Cohomology, Lemma \ref{local-cohomology-lemma-cd-local}.
We have $V(\mathfrak pA_\mathfrak q) \cap V(I_\mathfrak q) =
\{\mathfrak qA_\mathfrak q\}$ by our choice of $\mathfrak q$
and we conclude $\dim((A/\mathfrak p)_\mathfrak q) \leq d$
by Local Cohomology, Lemma \ref{local-cohomology-lemma-cd-bound-dim-local}.

\medskip\noindent
Observe that the lemma holds for $s < 0$. This is not a trivial case because
it is not a priori clear that $H^i(R\Gamma_J(M)^\wedge)$
is zero for $i < 0$. However, this vanishing was esthablished in
Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local}.
We will prove the lemma by induction for $s \geq 0$.

\medskip\noindent
The lemma for $s = 0$ follows immediately from
the conclusion of Lemma \ref{lemma-kill-colimit-weak-general}
and Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local-H0}.

\medskip\noindent
Assume $s > 0$ and the lemma has been shown for smaller values of $s$.
Let $M' \subset M$ be the maximal submodule whose support is contained
in $V(I) \cup T$. Then $M'$ is a finite $A$-module whose support
is contained in $V(J') \cup V(I)$ for some ideal $J' \subset J$
with $V(J') \cap V(I) = V(J) \cap V(I)$.
We claim that
$$
R\Gamma_{J'}(M') \to R\Gamma_J(M')^\wedge
$$
is an isomorphism for any choice of $J'$.
Namely, we can choose a short exact sequence
$0 \to M_1 \oplus M_2 \to M' \to N \to 0$ with
$M_1$ annihilated by a power of $J'$, with $M_2$ annihilated
by a power of $I$, and with $N$ annihilated by a power of $I + J'$.
Thus it suffices to show that the claim holds for $M_1$, $M_2$, and $N$.
In the case of $M_1$ we see that $R\Gamma_{J'}(M_1) = M_1$ and
since $M_1$ is a finite $A$-module and $I$-adically complete
we have $M_1^\wedge = M_1$. This proves the claim for $M_1$
by the initial remarks of the proof. In the case of $M_2$ we see that
$H^i_J(M_2) = H^i_{I + J}(M) = H^i_{I + J'}(M) = H^i_{J'}(M_2)$
are annihilated by a power of $I$ and hence derived complete.
Thus the claim in this case also. For $N$ we can use either of
the arguments just given. Considering the short exact sequence
$0 \to M' \to M \to M/M' \to 0$
we see that it suffices to prove the lemma for $M/M'$.
Thus we may assume $\text{Ass}(M) \cap (V(I) \cup T) = \emptyset$.

\medskip\noindent
Let $\mathfrak p \in \text{Ass}(M)$ be such that
$V(\mathfrak p) \cap V(J) \cap V(I) = \emptyset$.
Since $I$ is contained in the Jacobson radical of $A$ this implies
that $V(\mathfrak p) \cap V(J') = \emptyset$ for any
$J' \subset J$ with $V(J') \cap V(I) = V(J) \cap V(I)$.
Thus setting $N = H^0_\mathfrak p(M)$ we see that
$R\Gamma_J(N) = R\Gamma_{J'}(N) = 0$ for all
$J' \subset J$ with $V(J') \cap V(I) = V(J) \cap V(I)$.
In particular $R\Gamma_J(N)^\wedge = 0$.
Thus we may replace $M$ by $M/N$ as this changes the
structure of $M$ only in primes which do not play
a role in conditions (4) or (5). Repeating we may assume that
$V(\mathfrak p) \cap V(J) \cap V(I) \not = \emptyset$
for all $\mathfrak p \in \text{Ass}(M)$.

\medskip\noindent
Assume $\text{Ass}(M) \cap (V(I) \cup T) = \emptyset$ and that
$V(\mathfrak p) \cap V(J) \cap V(I) \not = \emptyset$
for all $\mathfrak p \in \text{Ass}(M)$.
Let $\mathfrak p \in \text{Ass}(M)$. We want to show that we may apply
Lemma \ref{lemma-kill-completion-general}.
It is in the verification of this that we will use the supplemental
condition (5). Choose $\mathfrak p' \subset \mathfrak p$
and $\mathfrak q' \subset V(\mathfrak p) \cap V(J) \cap V(I)$.
\begin{enumerate}
\item If $M_{\mathfrak p'} = 0$, then
$\text{depth}(M_{\mathfrak p'}) = \infty$ and
$\text{depth}(M_{\mathfrak p'}) +
\dim((A/\mathfrak p')_{\mathfrak q'}) > d + s$.
\item If $\text{depth}(M_{\mathfrak p'}) < s$, then
$\text{depth}(M_{\mathfrak p'}) +
\dim((A/\mathfrak p')_{\mathfrak q'}) > d + s$ by (4).
\end{enumerate}
In the remaining cases we have $M_{\mathfrak p'} \not = 0$ and
$\text{depth}(M_{\mathfrak p'}) \geq s$. In particular, we see that
$\mathfrak p'$ is in the support of $M$ and we can choose
$\mathfrak p'' \subset \mathfrak p'$ with $\mathfrak p'' \in \text{Ass}(M)$.
\begin{enumerate}
\item[(a)] Observe that
$\dim((A/\mathfrak p'')_{\mathfrak p'}) \geq \text{depth}(M_{\mathfrak p'})$
by Algebra, Lemma \ref{algebra-lemma-depth-dim-associated-primes}.
If equality holds, then we have
$$
\text{depth}(M_{\mathfrak p'}) + \dim((A/\mathfrak p')_{\mathfrak q'}) =
\text{depth}(M_{\mathfrak p''}) + \dim((A/\mathfrak p'')_{\mathfrak q'})
> s + d
$$
by (4) applied to $\mathfrak p''$ and we are done. This means we are
only in trouble if
$\dim((A/\mathfrak p'')_{\mathfrak p'}) > \text{depth}(M_{\mathfrak p'})$.
This implies that $\dim(M_\mathfrak p) \geq s + 2$.
Thus if (5)(a) holds, then this does not occur.
\item[(b)] If (5)(b) holds, then we get
$$
\text{depth}(M_{\mathfrak p'}) + \dim((A/\mathfrak p')_{\mathfrak q'})
\geq s + \delta(\mathfrak p') - \delta(\mathfrak q')
\geq s + 1 + \delta(\mathfrak p) - \delta_{max}
> s + d
$$
as desired.
\item[(c)] If (5)(c) holds, then we get
\begin{align*}
\text{depth}(M_{\mathfrak p'}) + \dim((A/\mathfrak p')_{\mathfrak q'})
& \geq
s + \delta(\mathfrak p') - \delta(\mathfrak q') \\
& \geq
s + 1 + \delta(\mathfrak p) - \delta(\mathfrak q') \\
& =
s + 1 + \delta(\mathfrak p) - \delta(\mathfrak q) +
\delta(\mathfrak q) - \delta(\mathfrak q') \\
& >
s + 1 + (s + d + \delta_{max} - \delta_{min} - 2) +
\delta(\mathfrak q) - \delta(\mathfrak q') \\
& \geq 
2s + d - 1 \geq s + d
\end{align*}
as desired. Observe that this argument works because
we know that a prime $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$
exists.
\end{enumerate}
Now we are ready to do the induction step.

\medskip\noindent
Choose an ideal $J_0$ as in Lemma \ref{lemma-kill-colimit-weak-general}
and an integer $t > 0$ such that $(J_0I)^t$ annihilates $H^s_J(M)$.
The assumptions of Lemma \ref{lemma-kill-completion-general}
are satisfied for every $\mathfrak p \in \text{Ass}(M)$
(see previous paragraph).
Thus the annihilator $\mathfrak a \subset A$ of
$H^s(R\Gamma_J(M)^\wedge)$
is not contained in $\mathfrak p$ for $\mathfrak p \in \text{Ass}(M)$.
Thus we can find an $f \in \mathfrak a(J_0I)^t$
not in any associated prime of $M$ which is an annihilator
of both $H^s(R\Gamma_J(M)^\wedge)$ and $H^s_J(M)$.
Then $f$ is a nonzerodivisor on $M$ and we can consider the
short exact sequence
$$
0 \to M \xrightarrow{f} M \to M/fM \to 0
$$
Our choice of $f$ shows that we obtain
$$
\xymatrix{
H^{s - 1}_{J'}(M) \ar[d] \ar[r] &
H^{s - 1}_{J'}(M/fM) \ar[d] \ar[r] &
H^s_{J'}(M) \ar[d] \ar[r] & 0 \\
H^{s - 1}(R\Gamma_J(M)^\wedge) \ar[r] &
H^{s - 1}(R\Gamma_J(M/fM)^\wedge) \ar[r] &
H^s(R\Gamma_J(M)^\wedge) \ar[r] & 0
}
$$
for any $J' \subset J_0$ with $V(J') \cap V(I) = V(J) \cap V(I)$.
Thus if we choose $J'$ such that it works for
$M$ and $M/fM$ and $s - 1$ (possible by induction hypothesis --
see next paragraph), then we conclude that the lemma is true.

\medskip\noindent
To finish the proof we have to show that the module
$M/fM$ satisfies the hypotheses (4) and (5) for $s - 1$.
Thus we let $\mathfrak p$ be a prime in the support
of $M/fM$ with $\text{depth}((M/fM)_\mathfrak p) < s - 1$
and with $V(\mathfrak p) \cap V(J) \cap V(I)$ nonempty.
Then $\dim(M_\mathfrak p) = \dim((M/fM)_\mathfrak p) + 1$
and $\text{depth}(M_\mathfrak p) = \text{depth}((M/fM)_\mathfrak p) + 1$.
In particular, we know (4) and (5) hold for $\mathfrak p$ and $M$
with the original value $s$.
The desired inequalities then follow by inspection.
\end{proof}

\begin{example}
\label{example-no-ML}
In Lemma \ref{lemma-algebraize-local-cohomology-general}
we do not know that the inverse systems $H^i_J(M/I^nM)$ satisfy the
Mittag-Leffler condition.
For example, suppose that $A = \mathbf{Z}_p[[x, y]]$, $I = (p)$,
$J = (p, x)$, and $M = A/(xy - p)$. Then the image of
$H^0_J(M/p^nM) \to H^0_J(M/pM)$
is the ideal generated by $y^n$ in $M/pM = A/(p, xy)$.
\end{example}





\section{Algebraization of local cohomology, II}
\label{section-algebraization-punctured}

\noindent
In this section we redo the arguments of
Section \ref{section-algebraization-sections-general}
when $(A, \mathfrak m)$ is a local ring and we take local cohomology
$R\Gamma_\mathfrak m$ with respect to $\mathfrak m$. As before our
main tool is the following lemma.

\begin{lemma}
\label{lemma-kill-completion}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module and
let $\mathfrak p \subset A$ be a prime. Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item $\text{cd}(A, I) \leq d$, and
\item
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s$.
\end{enumerate}
Then there exists an $f \in A \setminus \mathfrak p$ which annihilates
$H^i(R\Gamma_\mathfrak m(M)^\wedge)$ for $i \leq s$ where ${}^\wedge$
indicates $I$-adic completion.
\end{lemma}

\begin{proof}
According to Local Cohomology, Lemma
\ref{local-cohomology-lemma-sitting-in-degrees}
the function
$$
\mathfrak p' \longmapsto
\text{depth}_{A_{\mathfrak p'}}(M_{\mathfrak p'}) + \dim(A/\mathfrak p')
$$
is lower semi-continuous on $\Spec(A)$. Thus the value
of this function on $\mathfrak p' \subset \mathfrak p$
is $> s + d$. Thus our lemma is a special case of
Lemma \ref{lemma-kill-completion-general}
provided that $\mathfrak p \not = \mathfrak m$.
If $\mathfrak p = \mathfrak m$,
then we have $H^i_\mathfrak m(M) = 0$ for $i \leq s + d$ by
the relationship between depth and local cohomology
(Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}).
Thus the argument given in the proof of
Lemma \ref{lemma-kill-completion-general}
shows that $H^i(R\Gamma_\mathfrak m(M)^\wedge) = 0$
for $i \leq s$ in this (degenerate) case.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-weak}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item if $\mathfrak p \in V(I)$, then no condition,
\item if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) = \{\mathfrak m\}$, then
$\dim(A/\mathfrak p) \leq d$,
\item if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) \not = \{\mathfrak m\}$, then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s
$$
\end{enumerate}
Then there exists an ideal $J_0 \subset A$ with
$V(J_0) \cap V(I) = \{\mathfrak m\}$ such that for any $J \subset J_0$ with
$V(J) \cap V(I) = \{\mathfrak m\}$ the map
$$
R\Gamma_J(M) \longrightarrow R\Gamma_{J_0}(M)
$$
induces an isomorphism in cohomology in degrees $\leq s$
and moreover these modules are annihilated by a power of $J_0I$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-kill-colimit-weak-general}.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit}
In Lemma \ref{lemma-kill-colimit-weak} if instead of the empty
condition (2) we assume
\begin{enumerate}
\item[(2')] if $\mathfrak p \in V(I)$ and $\mathfrak p \not = \mathfrak m$,
then $\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > s$,
\end{enumerate}
then the conditions also imply that $H^i_{J_0}(M)$ is a finite
$A$-module for $i \leq s$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-kill-colimit-general}.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-support}
If in Lemma \ref{lemma-kill-colimit-weak} we additionally assume
\begin{enumerate}
\item[(6)] if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) = \{\mathfrak m\}$, then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$,
\end{enumerate}
then $H^i_{J_0}(M) = H^i_J(M) = H^i_\mathfrak m(M)$ for $i \leq s$
and these modules are annihilated by a power of $I$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-kill-colimit-support-general}.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-local-cohomology}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $\mathfrak p \in V(I)$, no condition,
\item $\text{cd}(A, I) \leq d$,
\item if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) \not = \{\mathfrak m\}$ then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s
$$
\end{enumerate}
Then there exists an ideal $J_0 \subset A$ with
$V(J_0) \cap V(I) = \{\mathfrak m\}$ such that for any $J \subset J_0$ with
$V(J) \cap V(I) = \{\mathfrak m\}$ the map
$$
R\Gamma_J(M) \longrightarrow
R\Gamma_J(M)^\wedge = R\Gamma_\mathfrak m(M)^\wedge
$$
induces an isomorphism in cohomology in degrees $\leq s$.
Here ${}^\wedge$ denotes derived $I$-adic completion.
\end{lemma}

\begin{proof}
This lemma is a special case of
Lemma \ref{lemma-algebraize-local-cohomology-general}
since condition (5)(c) is implied by condition (4)
as $\delta_{max} = \delta_{min} = \delta(\mathfrak m)$.
We will give the proof of this important special case
as it is somewhat easier (fewer things to check).

\medskip\noindent
There is no difference between $R\Gamma_\mathfrak a$ and
$R\Gamma_{V(\mathfrak a)}$ in our current situation, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-noetherian}.
Next, we observe that
$$
R\Gamma_\mathfrak m(M)^\wedge =
R\Gamma_I(R\Gamma_J(M))^\wedge =
R\Gamma_J(M)^\wedge
$$
by Dualizing Complexes, Lemmas \ref{dualizing-lemma-local-cohomology-ss} and
\ref{dualizing-lemma-complete-and-local}
which explains the equality sign in the statement of the lemma.

\medskip\noindent
Observe that the lemma holds for $s < 0$. This is not a trivial case because
it is not a priori clear that $H^s(R\Gamma_\mathfrak m(M)^\wedge)$
is zero for negative $s$. However, this vanishing was esthablished
in Lemma \ref{lemma-local-cohomology-derived-completion}.
We will prove the lemma by induction for $s \geq 0$.

\medskip\noindent
The assumptions of Lemma \ref{lemma-kill-colimit-weak}
are satisfied by Local Cohomology, Lemma
\ref{local-cohomology-lemma-cd-bound-dim-local}.
The lemma for $s = 0$ follows from Lemma \ref{lemma-kill-colimit-weak} and
Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local-H0}.

\medskip\noindent
Assume $s > 0$ and the lemma holds for smaller values of $s$.
Let $M' \subset M$ be the submodule of elements whose
support is condained in $V(I) \cup V(J)$ for some
ideal $J$ with $V(J) \cap V(I) = \{\mathfrak m\}$.
Then $M'$ is a finite $A$-module.
We claim that
$$
R\Gamma_J(M') \to R\Gamma_\mathfrak m(M')^\wedge
$$
is an isomorphism for any choice of $J$.
Namely, for any such module there is a short exact sequence
$0 \to M_1 \oplus M_2 \to M' \to N \to 0$ with
$M_1$ annihilated by a power of $J$, with $M_2$ annihilated
by a power of $I$ and with $N$ annihilated by a power of $\mathfrak m$.
In the case of $M_1$ we see that $R\Gamma_J(M_1) = M_1$ and
since $M_1$ is a finite $A$-module and $I$-adically complete
we have $M_1^\wedge = M_1$. Thus the claim holds for $M_1$.
In the case of $M_2$ we see that $H^i_J(M_2)$ is annihilated
by a power of $I$ and hence derived complete. Thus the claim
for $M_2$. By the same arguments the claim holds for $N$
and we conclude that the claim holds. Considering the
short exact sequence $0 \to M' \to M \to M/M' \to 0$
we see that it suffices to prove the lemma for $M/M'$.
This we may assume $\mathfrak p \in \text{Ass}(M)$
implies $V(\mathfrak p) \cap V(I) \not = \{\mathfrak m\}$, i.e.,
$\mathfrak p$ is a prime as in (4).

\medskip\noindent
Choose an ideal $J_0$ as in Lemma \ref{lemma-kill-colimit-weak}
and an integer $t > 0$ such that $(J_0I)^t$ annihilates $H^s_J(M)$.
Here $J$ denotes an arbitrary ideal $J \subset J_0$ with
$V(J) \cap V(I) = \{\mathfrak m\}$.
The assumptions of Lemma \ref{lemma-kill-completion}
are satisfied for every $\mathfrak p \in \text{Ass}(M)$
(see previous paragraph). Thus the annihilator $\mathfrak a \subset A$ of
$H^s(R\Gamma_\mathfrak m(M)^\wedge)$
is not contained in $\mathfrak p$ for $\mathfrak p \in \text{Ass}(M)$.
Thus we can find an $f \in \mathfrak a(J_0I)^t$
not in any associated prime of $M$ which is an annihilator
of both $H^s(R\Gamma_\mathfrak m(M)^\wedge)$ and $H^s_J(M)$.
Then $f$ is a nonzerodivisor on $M$ and we can consider the
short exact sequence
$$
0 \to M \xrightarrow{f} M \to M/fM \to 0
$$
Our choice of $f$ shows that we obtain
$$
\xymatrix{
H^{s - 1}_J(M) \ar[d] \ar[r] &
H^{s - 1}_J(M/fM) \ar[d] \ar[r] &
H^s_J(M) \ar[d] \ar[r] & 0 \\
H^{s - 1}(R\Gamma_\mathfrak m(M)^\wedge) \ar[r] &
H^{s - 1}(R\Gamma_\mathfrak m(M/fM)^\wedge) \ar[r] &
H^s(R\Gamma_\mathfrak m(M)^\wedge) \ar[r] & 0
}
$$
for any $J \subset J_0$ with $V(J) \cap V(I) = \{\mathfrak m\}$.
Thus if we choose $J$ such that it works for
$M$ and $M/fM$ and $s - 1$ (possible by induction hypothesis),
then we conclude that the lemma is true.
\end{proof}








\section{Algebraization of local cohomology, III}
\label{section-bootstrap}

\noindent
In this section we bootstrap the material in
Sections \ref{section-algebraization-sections-general} and
\ref{section-algebraization-sections}
to give a stronger result the following situation.

\begin{situation}
\label{situation-bootstrap}
Here $A$ is a Noetherian ring. We have an ideal $I \subset A$,
a finite $A$-module $M$, and a subset $T \subset V(I)$ stable under
specialization. We have integers $s$ and $d$. We assume
\begin{enumerate}
\item[(1)] $A$ has a dualizing complex,
\item[(3)] $\text{cd}(A, I) \leq d$,
\item[(4)] given primes $\mathfrak p \subset \mathfrak r \subset \mathfrak q$
with $\mathfrak p \not \in V(I)$,
$\mathfrak r \in V(I) \setminus T$,
$\mathfrak q \in T$ we have
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
\item[(6)] given $\mathfrak q \in T$ denoting
$A', \mathfrak m', I', M'$ are the usual $I$-adic completions
of $A_\mathfrak q, \mathfrak qA_\mathfrak q, I_\mathfrak q, M_\mathfrak q$
we have
$$
\text{depth}(M'_{\mathfrak p'}) > s
$$
for all $\mathfrak p' \in \Spec(A') \setminus V(I')$ with
$V(\mathfrak p') \cap V(I') = \{\mathfrak m'\}$.
\end{enumerate}
\end{situation}

\noindent
The following lemma explains why in Situation \ref{situation-bootstrap}
it suffices to look at triples
$\mathfrak p \subset \mathfrak r \subset \mathfrak q$ of primes in (4)
even though the actual assumption only involves $\mathfrak p$ and $\mathfrak q$.

\begin{lemma}
\label{lemma-helper-bootstrap}
In Situation \ref{situation-bootstrap} let $\mathfrak p \subset \mathfrak q$
be primes of $A$ with $\mathfrak p \not \in V(I)$ and
$\mathfrak q \in T$. If there does not exist an
$\mathfrak r \in V(I) \setminus T$ with
$\mathfrak p \subset \mathfrak r \subset \mathfrak q$
then $\text{depth}(M_\mathfrak p) > s$.
\end{lemma}

\begin{proof}
Choose $\mathfrak q' \in T$ with
$\mathfrak p \subset \mathfrak q' \subset \mathfrak q$
such that there is no prime in $T$ strictly
in between $\mathfrak p$ and $\mathfrak q'$. To prove the lemma
we may and do replace $\mathfrak q$ by $\mathfrak q'$.
Next, let $\mathfrak p' \subset A_\mathfrak q$ be the prime corresponding to
$\mathfrak p$. After doing this we obtain that
$V(\mathfrak p') \cap V(IA_\mathfrak q) = \{\mathfrak q A_\mathfrak q\}$
because of the nonexistence of a prime $\mathfrak r$ as in the lemma.
Let $A', I', \mathfrak m', M'$ be the $I$-adic completions of
$A_\mathfrak q, I_\mathfrak q, \mathfrak qA_\mathfrak q, M_\mathfrak q$.
Since $A_\mathfrak q \to A'$ is faithfully flat
(Algebra, Lemma \ref{algebra-lemma-completion-faithfully-flat})
we can choose $\mathfrak p'' \subset A'$ lying over $\mathfrak p'$
with $\dim(A'_{\mathfrak p''}/\mathfrak p' A'_{\mathfrak p''}) = 0$.
Then we see that
$$
\text{depth}(M'_{\mathfrak p''}) =
\text{depth}((M_\mathfrak q \otimes_{A_\mathfrak q} A')_{\mathfrak p''}) =
\text{depth}(M_\mathfrak p \otimes_{A_\mathfrak p} A'_{\mathfrak p''}) =
\text{depth}(M_\mathfrak p)
$$
by flatness of $A \to A'$ and our choice of $\mathfrak p''$, see
Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module}.
Since $\mathfrak p''$ lies over $\mathfrak p'$ we have
$V(\mathfrak p'') \cap V(I') = \{\mathfrak m'\}$. Thus
condition (6) in Situation \ref{situation-bootstrap} implies
$\text{depth}(M'_{\mathfrak p''}) > s$ which finishes the proof.
\end{proof}

\noindent
The following tedious lemma explains the relationships between various
collections of conditions one might impose.

\begin{lemma}
\label{lemma-bootstrap-inherited}
In Situation \ref{situation-bootstrap} we have
\begin{enumerate}
\item[(E)] if $T' \subset T$ is a smaller specialization stable subset, then
$A, I, T', M$ satisfies the assumptions of Situation \ref{situation-bootstrap},
\item[(F)] if $S \subset A$ is a multiplicative subset, then
$S^{-1}A, S^{-1}I, T', S^{-1}M$
satisfies the assumptions of Situation \ref{situation-bootstrap}
where $T' \subset V(S^{-1}I)$ is the inverse image of $T$,
\item[(G)] the quadruple $A', I', T', M'$
satisfies the assumptions of Situation \ref{situation-bootstrap}
where $A', I', M'$ are the usual $I$-adic completions of $A, I, M$
and $T' \subset V(I')$ is the inverse image of $T$.
\end{enumerate}
Let $I \subset \mathfrak a \subset A$ be an ideal such that
$V(\mathfrak a) \subset T$. Then
\begin{enumerate}
\item[(A)] if $I$ is contained in the Jacobson radical of $A$,
then all hypotheses of
Lemmas \ref{lemma-kill-colimit-weak-general} and
\ref{lemma-kill-colimit-support-general} are satisfied
for $A, I, \mathfrak a, M$,
\item[(B)] if $A$ is complete with respect to $I$, then
all hypotheses except for possibly (5) of
Lemma \ref{lemma-algebraize-local-cohomology-general}
are satisfied for $A, I, \mathfrak a, M$,
\item[(C)] if $A$ is local with maximal ideal $\mathfrak m = \mathfrak a$,
then all hypotheses of
Lemmas \ref{lemma-kill-colimit-weak} and \ref{lemma-kill-colimit-support}
hold for $A, \mathfrak m, I, M$,
\item[(D)] if $A$ is local with maximal ideal $\mathfrak m = \mathfrak a$
and $I$-adically complete, then all hypotheses of
Lemma \ref{lemma-algebraize-local-cohomology}
hold for $A, \mathfrak m, I, M$,
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (E). We have to prove assumptions (1), (3), (4), (6)
of Situation \ref{situation-bootstrap} hold for
$A, I, T, M$. Shrinking $T$ to $T'$
weakens assumption (6) and strengthens assumption (4). However, if we have
$\mathfrak p \subset \mathfrak r \subset \mathfrak q$ with
$\mathfrak p \not \in V(I)$, $\mathfrak r \in V(I) \setminus T'$,
$\mathfrak q \in T'$ as in assumption (4) for $A, I, T', M$, then
either we can pick $\mathfrak r \in V(I) \setminus T$ and
condition (4) for $A, I, T, M$ kicks in or we cannot
find such an $\mathfrak r$ in which case we get
$\text{depth}(M_\mathfrak p) > s$ by Lemma \ref{lemma-helper-bootstrap}.
This proves (4) holds for $A, I, T', M$ as desired.

\medskip\noindent
Proof of (F). This is straightforward and we omit the details.

\medskip\noindent
Proof of (G). We have to prove assumptions (1), (3), (4), (6)
of Situation \ref{situation-bootstrap} hold for the $I$-adic
completions $A', I', T', M'$. Please keep in mind that
$\Spec(A') \to \Spec(A)$ induces an isomorphism $V(I') \to V(I)$.

\medskip\noindent
Assumption (1): The ring $A'$ has a dualizing complex, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing}.

\medskip\noindent
Assumption (3): Since $I' = IA'$ this follows from Local Cohomology,
Lemma \ref{local-cohomology-lemma-cd-change-rings}.

\medskip\noindent
Assumption (4): If we have primes
$\mathfrak p' \subset \mathfrak r' \subset \mathfrak q'$ in $A'$
with $\mathfrak p' \not \in V(I')$,
$\mathfrak r' \in V(I') \setminus T'$,
$\mathfrak q' \in T'$ then their images
$\mathfrak p \subset \mathfrak r \subset \mathfrak q$ in
the spectrum of $A$
satisfy
$\mathfrak p \not \in V(I)$, $\mathfrak r \in V(I) \setminus T$,
$\mathfrak q \in T$.
Then we have
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
by assumption (4) for $A, I, T, M$. We have
$\text{depth}(M'_{\mathfrak p'}) \geq \text{depth}(M_\mathfrak p)$ and
$\text{depth}(M'_{\mathfrak p'}) +
\dim((A'/\mathfrak p')_{\mathfrak q'}) =
\text{depth}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q)$
by Local Cohomology, Lemma \ref{local-cohomology-lemma-change-completion}.
Thus assumption (4) holds for $A', I', T', M'$.

\medskip\noindent
Assumption (6): Let $\mathfrak q' \in T'$ lying over the
prime $\mathfrak q \in T$. Then $A'_{\mathfrak q'}$
and $A_\mathfrak q$ have isomorphic $I$-adic completions
and similarly for $M_\mathfrak q$ and $M'_{\mathfrak q'}$.
Thus assumption (6) for $A', I', T', M'$ is equivalent
to assumption (6) for $A, I, T, M$.

\medskip\noindent
Proof of (A). We have to check conditions (1), (2), (3), (4), and (6)
of Lemmas \ref{lemma-kill-colimit-weak-general} and
\ref{lemma-kill-colimit-support-general} for
$(A, I, \mathfrak a, M)$. Warning: the set $T$ in the statement of
these lemmas is not the same as the set $T$ above.

\medskip\noindent
Condition (1): This holds because we have assumed $A$ has a dualizing complex in
Situation \ref{situation-bootstrap}.

\medskip\noindent
Condition (2): This is empty.

\medskip\noindent
Condition (3): Let $\mathfrak p \subset A$ with
$V(\mathfrak p) \cap V(I) \subset V(\mathfrak a)$.
Since $I$ is contained in the Jacobson radical of $A$ we see
that $V(\mathfrak p) \cap V(I) \not = \emptyset$.
Let $\mathfrak q \in V(\mathfrak p) \cap V(I)$ be a generic point.
Since $\text{cd}(A_\mathfrak q, I_\mathfrak q) \leq d$
(Local Cohomology, Lemma \ref{local-cohomology-lemma-cd-local}) and since
$V(\mathfrak p A_\mathfrak q) \cap V(I_\mathfrak q) =
\{\mathfrak q A_\mathfrak q\}$ we get
$\dim((A/\mathfrak p)_\mathfrak q) \leq d$ by Local Cohomology,
Lemma \ref{local-cohomology-lemma-cd-bound-dim-local} which proves (3).

\medskip\noindent
Condition (4): Suppose $\mathfrak p \not \in V(I)$ and
$\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$.
It suffices to show
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
If there exists a prime $\mathfrak p \subset \mathfrak r \subset \mathfrak q$
with $\mathfrak r \in V(I) \setminus T$, then this follows
immediately from assumption (4) in Situation \ref{situation-bootstrap}.
If not, then $\text{depth}(M_\mathfrak p) > s$ by
Lemma \ref{lemma-helper-bootstrap}.

\medskip\noindent
Condition (6): Let $\mathfrak p \not \in V(I)$ with
$V(\mathfrak p) \cap V(I) \subset V(\mathfrak a)$.
Since $I$ is contained in the Jacobson radical of $A$ we see
that $V(\mathfrak p) \cap V(I) \not = \emptyset$.
Choose $\mathfrak q \in V(\mathfrak p) \cap V(I) \subset V(\mathfrak a)$.
It is clear there does not exist a prime
$\mathfrak p \subset \mathfrak r \subset \mathfrak q$
with $\mathfrak r \in V(I) \setminus T$.
By Lemma \ref{lemma-helper-bootstrap} we have
$\text{depth}(M_\mathfrak p) > s$ which proves (6).

\medskip\noindent
Proof of (B). We have to check conditions (1), (2), (3), (4) of
Lemma \ref{lemma-algebraize-local-cohomology-general}. Warning:
the set $T$ in the statement of
this lemma is not the same as the set $T$ above.

\medskip\noindent
Condition (1): This holds because $A$ is complete and has a dualizing complex.

\medskip\noindent
Condition (2): This is empty.

\medskip\noindent
Condition (3): This is the same as assumption (3) in
Situation \ref{situation-bootstrap}.

\medskip\noindent
Condition (4): This is the same as assumption (4) in
Lemma \ref{lemma-kill-colimit-weak-general} which we proved in (A).

\medskip\noindent
Proof of (C). This is true because the assumptions in
Lemmas \ref{lemma-kill-colimit-weak} and \ref{lemma-kill-colimit-support}
are the same as the assumptions in
Lemmas \ref{lemma-kill-colimit-weak-general} and
\ref{lemma-kill-colimit-support-general} in the local case
and we proved these hold in (A).

\medskip\noindent
Proof of (D). This is true because the assumptions in
Lemma \ref{lemma-algebraize-local-cohomology}
are the same as the assumptions (1), (2), (3), (4) in
Lemma \ref{lemma-algebraize-local-cohomology-general}
and we proved these hold in (B).
\end{proof}

\begin{lemma}
\label{lemma-algebraize-local-cohomology-bis}
In Situation \ref{situation-bootstrap} assume $A$ is local with
maximal ideal $\mathfrak m$ and $T = \{\mathfrak m\}$. Then
$H^i_\mathfrak m(M) \to \lim H^i_\mathfrak m(M/I^nM)$
is an isomorphism for $i \leq s$ and these modules are
annihilated by a power of $I$.
\end{lemma}

\begin{proof}
Let $A', I', \mathfrak m', M'$ be the usual $I$-adic completions
of $A, I, \mathfrak m, M$. Recall that we have
$H^i_\mathfrak m(M) \otimes_A A' = H^i_{\mathfrak m'}(M')$
by flatness of $A \to A'$ and Dualizing Complexes, Lemma
\ref{dualizing-lemma-torsion-change-rings}.
Since $H^i_\mathfrak m(M)$ is $\mathfrak m$-power torsion we have
$H^i_\mathfrak m(M) = H^i_\mathfrak m(M) \otimes_A A'$, see
More on Algebra, Lemma \ref{more-algebra-lemma-neighbourhood-equivalence}.
We conclude that $H^i_\mathfrak m(M) = H^i_{\mathfrak m'}(M')$.
The exact same arguments will show that
$H^i_\mathfrak m(M/I^nM) =  H^i_{\mathfrak m'}(M'/(I')^nM')$
for all $n$ and $i$.

\medskip\noindent
Lemmas \ref{lemma-algebraize-local-cohomology},
\ref{lemma-kill-colimit-weak}, and
\ref{lemma-kill-colimit-support}
apply to $A', \mathfrak m', I', M'$ by
Lemma \ref{lemma-bootstrap-inherited} parts (C) and (D).
Thus we get an isomorphism
$$
H^i_{\mathfrak m'}(M') \longrightarrow H^i(R\Gamma_{\mathfrak m'}(M')^\wedge)
$$
for $i \leq s$ where ${}^\wedge$ is derived $I'$-adic completion and these
modules are annihilated by a power of $I'$.
By Lemma \ref{lemma-local-cohomology-derived-completion}
we obtain isomorphisms
$$
H^i_{\mathfrak m'}(M') \longrightarrow
\lim H^i_{\mathfrak m'}(M'/(I')^nM'))
$$
for $i \leq s$. Combined with the already esthablished comparison
with local cohomology over $A$ we conclude the lemma is true.
\end{proof}

\begin{lemma}
\label{lemma-bootstrap-bis-bis}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $M$ be a finite $A$-module. Let $s$ and $d$ be integers.
If we assume
\begin{enumerate}
\item[(a)] $A$ has a dualizing complex,
\item[(b)] $\text{cd}(A, I) \leq d$,
\item[(c)] if $\mathfrak p \not \in V(I)$ and
$\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$ then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$ or
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s$.
\end{enumerate}
Then $A, I, V(\mathfrak a), M, s, d$ are as in
Situation \ref{situation-bootstrap}.
\end{lemma}

\begin{proof}
We have to show that assumptions (1), (3), (4), and (6) of
Situation \ref{situation-bootstrap} hold.
It is clear that (a) $\Rightarrow$ (1),
(b) $\Rightarrow$ (3), and (c) $\Rightarrow$ (4).
To finish the proof in the next paragraph we show (6) holds.

\medskip\noindent
Let $\mathfrak q \in V(\mathfrak a)$.
Denote $A', I', \mathfrak m', M'$
the $I$-adic completions of
$A_\mathfrak q, I_\mathfrak q, \mathfrak qA_\mathfrak q, M_\mathfrak q$.
Let $\mathfrak p' \subset A'$ be a nonmaximal prime with
$V(\mathfrak p') \cap V(I') = \{\mathfrak m'\}$.
Observe that this implies $\dim(A'/\mathfrak p') \leq d$
by Local Cohomology, Lemma \ref{local-cohomology-lemma-cd-bound-dim-local}.
Denote $\mathfrak p \subset A$ the image of $\mathfrak p'$.
We have
$\text{depth}(M'_{\mathfrak p'}) \geq \text{depth}(M_\mathfrak p)$ and
$\text{depth}(M'_{\mathfrak p'}) +
\dim(A'/\mathfrak p') =
\text{depth}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q)$
by Local Cohomology, Lemma \ref{local-cohomology-lemma-change-completion}.
By assumption (c) either we have
$\text{depth}(M'_{\mathfrak p'}) \geq \text{depth}(M_\mathfrak p) > s$
and we're done or we have
$\text{depth}(M'_{\mathfrak p'}) +
\dim(A'/\mathfrak p') > s + d$ which implies
$\text{depth}(M'_{\mathfrak p'}) > s$ because of the already shown
inequality $\dim(A'/\mathfrak p') \leq d$. In both cases we
obtain what we want.
\end{proof}

\begin{lemma}
\label{lemma-bootstrap}
In Situation \ref{situation-bootstrap} the inverse systems
$\{H^i_T(I^nM)\}_{n \geq 0}$ are pro-zero for $i \leq s$.
Moreover, there exists an integer $m_0$ such that for all
$m \geq m_0$ there exists an integer $m'(m) \geq m$ such that for
$k \geq m'(m)$ the image of
$H^{s + 1}_T(I^kM) \to H^{s + 1}_T(I^mM)$
maps injectively to $H^{s + 1}_T(I^{m_0}M)$.
\end{lemma}

\begin{proof}
Fix $m$. Let $\mathfrak q \in T$.
By Lemmas \ref{lemma-bootstrap-inherited} and
\ref{lemma-algebraize-local-cohomology-bis}
we see that
$$
H^i_\mathfrak q(M_\mathfrak q)
\longrightarrow
\lim H^i_\mathfrak q(M_\mathfrak q/I^nM_\mathfrak q)
$$
is an isomorphism for $i \leq s$. The inverse systems
$\{H^i_\mathfrak q(I^nM_\mathfrak q)\}_{n \geq 0}$ and
$\{H^i_\mathfrak q(M/I^nM)\}_{n \geq 0}$
satisfy the Mittag-Leffler condition for all $i$, see
Lemma \ref{lemma-ML-local}. Thus looking at the inverse system of
long exact sequences
$$
0 \to H^0_\mathfrak q(I^nM_\mathfrak q) \to
H^0_\mathfrak q(M_\mathfrak q) \to
H^0_\mathfrak q(M_\mathfrak q/I^nM_\mathfrak q) \to
H^1_\mathfrak q(I^nM_\mathfrak q) \to
H^1_\mathfrak q(M_\mathfrak q) \to \ldots
$$
we conclude (some details omitted) that there exists an integer
$m'(m, \mathfrak q) \geq m$ such that for all $k \geq m'(m, \mathfrak q)$
the map
$H^i_\mathfrak q(I^kM_\mathfrak q) \to H^i_\mathfrak q(I^mM_\mathfrak q)$
is zero for $i \leq s$ and the image of
$H^{s + 1}_\mathfrak q(I^kM_\mathfrak q) \to
H^{s + 1}_\mathfrak q(I^mM_\mathfrak q)$
is independent of $k \geq m'(m, \mathfrak q)$ and
maps injectively into $H^{s + 1}_\mathfrak q(M_\mathfrak q)$.

\medskip\noindent
Suppose we can show that $m'(m, \mathfrak q)$ can be chosen
independently of $\mathfrak q \in T$.
Then the lemma follows immediately from
Local Cohomology, Lemmas \ref{local-cohomology-lemma-zero} and
\ref{local-cohomology-lemma-essential-image}.

\medskip\noindent
Let $\omega_A^\bullet$ be a dualizing complex. Let
$\delta : \Spec(A) \to \mathbf{Z}$ be the corresponding
dimension function. Recall that $\delta$ attains only a
finite number of values, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-universally-catenary}.
Claim: for each $d \in \mathbf{Z}$ the integer
$m'(m, \mathfrak q)$ can be chosen independently
of $\mathfrak q \in T$ with $\delta(\mathfrak q) = d$.
Clearly the claim implies the lemma by what we said above.

\medskip\noindent
Pick $\mathfrak q \in T$ with $\delta(\mathfrak q) = d$.
Consider the ext modules
$$
E(n, j) = \text{Ext}^j_A(I^nM, \omega_A^\bullet)
$$
A key feature we will use is that these are finite $A$-modules.
Recall that $(\omega_A^\bullet)_\mathfrak q[-d]$ is a normalized
dualizing complex for $A_\mathfrak q$ by definition of the
dimension function associated to a dualizing complex, see
Dualizing Complexes, Section \ref{dualizing-section-dimension-function}.
The local duality theorem (Dualizing Complexes, Lemma
\ref{dualizing-lemma-special-case-local-duality}) tells us that
the $\mathfrak qA_\mathfrak q$-adic completion of
$E(n, -d - i)_\mathfrak q$ is Matlis dual to
$H^i_\mathfrak q(I^nM_\mathfrak q)$. Thus the choice of
$m'(m, \mathfrak q)$ for $i \leq s$ in the first paragraph tells us that
for $k \geq m'(m, \mathfrak q)$ and $j \geq -d - s$ the map
$$
E(m, j)_\mathfrak q \to E(k, j)_\mathfrak q
$$
is zero. Since these modules are finite and nonzero only
for a finite number of possible $j$ (small detail omitted),
we can find an open neighbourhood $W \subset \Spec(A)$ of $\mathfrak q$
such that
$$
E(m, j)_{\mathfrak q'} \to E(m'(m, \mathfrak q), j)_{\mathfrak q'}
$$
is zero for $j \geq -d - s$ for all $\mathfrak q' \in W$.
Then of course the maps $E(m, j)_{\mathfrak q'} \to E(k, j)_{\mathfrak q'}$
for $k \geq m'(m, \mathfrak q)$ are zero as well.

\medskip\noindent
For $i = s + 1$ corresponding to $j = - d - s - 1$ we obtain
from local duality and the results of the first paragraph that
$$
K_{k, \mathfrak q} =
\Ker(E(m, -d - s - 1)_\mathfrak q \to E(k, -d - s - 1)_\mathfrak q)
$$
is independent of $k \geq m'(m, \mathfrak q)$ and that
$$
E(0, -d - s - 1)_\mathfrak q \to
E(m, -d - s - 1)_\mathfrak q/K_{m'(m, \mathfrak q), \mathfrak q}
$$
is surjective. For $k \geq m'(m, \mathfrak q)$ set
$$
K_k = \Ker(E(m, -d - s - 1) \to E(k, -d - s - 1))
$$
Since $K_k$ is an increasing sequence of submodules of the finite
module $E(m, -d - s - 1)$ we see that, at the cost of increasing
$m'(m, \mathfrak q)$ a little bit, we may assume
$K_{m'(m, \mathfrak q)} = K_k$ for $k \geq m'(m, \mathfrak q)$.
After shrinking $W$ further if necessary, we may also assume that
$$
E(0, -d - s - 1)_{\mathfrak q'} \to
E(m, -d - s - 1)_{\mathfrak q'}/K_{m'(m, \mathfrak q), \mathfrak q'}
$$
is surjective for all $\mathfrak q' \in W$ (as before use that
these modules are finite
and that the map is surjective after localization at $\mathfrak q$).

\medskip\noindent
Any subset, in particular
$T_d = \{\mathfrak q \in T \text{ with }\delta(\mathfrak q) = d\}$,
of the Noetherian topological space $\Spec(A)$
with the endowed topology is Noetherian and hence quasi-compact.
Above we have seen that for every $\mathfrak q \in T_d$
there is an open neighbourhood $W$ where
$m'(m, \mathfrak q)$ works for all $\mathfrak q' \in T_d \cap W$.
We conclude that we can find an integer $m'(m, d)$ such that for all
$\mathfrak q \in T_d$ we have
$$
E(m, j)_\mathfrak q \to E(m'(m, d), j)_\mathfrak q
$$
is zero for $j \geq -d - s$ and with
$K_{m'(m, d)} = \Ker(E(m, -d - s - 1) \to E(m'(m, d), -d - s - 1))$
we have
$$
K_{m'(m, d), \mathfrak q} =
\Ker(E(m, -d - s - 1)_{\mathfrak q} \to E(k, -d - s - 1)_{\mathfrak q})
$$
for all $k \geq m'(m, d)$ and the map
$$
E(0, -d - s - 1)_\mathfrak q \to
E(m, -d - s - 1)_\mathfrak q/K_{m'(m, d), \mathfrak q}
$$
is surjective. Using the local duality theorem again (in the opposite
direction) we conclude that the claim is correct. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-final-bootstrap}
In Situation \ref{situation-bootstrap} there exists an integer $m_0 \geq 0$
such that
\begin{enumerate}
\item $\{H^i_T(M/I^nM)\}_{n \geq 0}$
satisfies the Mittag-Leffler condition for $i < s$.
\item $\{H^i_T(I^{m_0}M/I^nM)\}_{n \geq m_0}$
satisfies the Mittag-Leffler condition for $i \leq s$,
\item $H^i_T(M) \to \lim H^i_T(M/I^nM)$
is an isomorphism for $i < s$,
\item $H^s_T(I^{m_0}M) \to \lim H^s_T(I^{m_0}M/I^nM)$
is an isomorphism for $i \leq s$,
\item $H^s_T(M) \to \lim H^s_T(M/I^nM)$ is
injective with cokernel killed by $I^{m_0}$, and
\item $R^1\lim H^s_T(M/I^nM)$ is killed by $I^{m_0}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the long exact sequences
$$
0 \to H^0_T(I^nM) \to H^0_T(M) \to
H^0_T(M/I^nM) \to H^1_T(I^nM) \to
H^1_T(M) \to \ldots
$$
Parts (1) and (3) follows easily from this and Lemma \ref{lemma-bootstrap}.

\medskip\noindent
Let $m_0$ and $m'(-)$ be as in Lemma \ref{lemma-bootstrap}.
For $m \geq m_0$ consider the long exact sequence
$$
H^s_T(I^mM) \to H^s_T(I^{m_0}M) \to
H^s_T(I^{m_0}M/I^mM) \to H^{s + 1}_T(I^mM) \to
H^1_T(I^{m_0}M)
$$
Then for $k \geq m'(m)$ the image of
$H^{s + 1}_T(I^kM) \to H^{s + 1}_T(I^mM)$
maps injectively to $H^{s + 1}_T(I^{m_0}M)$.
Hence the image of
$H^s_T(I^{m_0}M/I^kM) \to H^s_T(I^{m_0}M/I^mM)$
maps to zero in $H^{s + 1}_T(I^mM)$ for all $k \geq m'(m)$.
We conclude that (2) and (4) hold.

\medskip\noindent
Consider the short exact sequences
$0 \to I^{m_0}M \to M \to M/I^{m_0} M \to 0$ and
$0 \to I^{m_0}M/I^nM \to M/I^nM \to M/I^{m_0} M \to 0$.
We obtain a diagram
$$
\xymatrix{
H^{s - 1}_T(M/I^{m_0}M) \ar[r] &
\lim H^s_T(I^{m_0}M/I^nM) \ar[r] &
\lim H^s_T(M/I^nM) \ar[r] &
H^s_T(M/I^{m_0}M) \\
H^{s - 1}_T(M/I^{m_0}M) \ar[r] \ar@{=}[u] &
H^s_T(I^{m_0}M) \ar[r] \ar[u]_{\cong} &
H^s_T(M) \ar[r] \ar[u] &
H^s_T(M/I^{m_0}M) \ar@{=}[u]
}
$$
whose lower row is exact. The top row is also exact
(at the middle two spots) by
Homology, Lemma \ref{homology-lemma-apply-Mittag-Leffler}.
Part (5) follows.

\medskip\noindent
Write $B_n = H^s_T(M/I^nM)$. Let $A_n \subset B_n$
be the image of $H^s_T(I^{m_0}M/I^nM) \to H^s_T(M/I^nM)$.
Then $(A_n)$ satisfies the Mittag-Leffler condition by (2) and
Homology, Lemma \ref{homology-lemma-Mittag-Leffler}.
Also $C_n = B_n/A_n$ is killed by $I^{m_0}$. Thus
$R^1\lim B_n \cong R^1\lim C_n$ is killed by $I^{m_0}$ and we get (6).
\end{proof}

\begin{theorem}
\label{theorem-final-bootstrap}
In Situation \ref{situation-bootstrap} the inverse system
$\{H^i_T(M/I^nM)\}_{n \geq 0}$ satisfies the
Mittag-Leffler condition for $i \leq s$, the map
$$
H^i_T(M) \longrightarrow \lim H^i_T(M/I^nM)
$$
is an isomorphism for $i \leq s$, and $H^i_T(M)$
is annihilated by a power of $I$ for $i \leq s$.
\end{theorem}

\begin{proof}
To prove the final assertion of the theorem we apply Local Cohomology,
Proposition \ref{local-cohomology-proposition-annihilator} with
$T \subset V(I) \subset \Spec(A)$. Namely, suppose
that $\mathfrak p \not \in V(I)$, $\mathfrak q \in T$
with $\mathfrak p \subset \mathfrak q$.
Then either there exists a prime
$\mathfrak p \subset \mathfrak r \subset \mathfrak q$
with $\mathfrak r \in V(I) \setminus T$ and we get
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
by (4) in Situation \ref{situation-bootstrap} or there does
not exist an $\mathfrak r$ and we get
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$ by
Lemma \ref{lemma-helper-bootstrap}.
In all three cases we see that
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s$.
Thus Local Cohomology, Proposition
\ref{local-cohomology-proposition-annihilator} (2)
holds and we find that a power of $I$ annihilates
$H^i_T(M)$ for $i \leq s$.

\medskip\noindent
We already know the other two assertions of the theorem hold
for $i < s$ by Lemma \ref{lemma-final-bootstrap} and for the
module $I^{m_0}M$ for $i = s$ and $m_0$ large enough.
To finish of the proof we will show that in fact these
assertions for $i = s$ holds for $M$.

\medskip\noindent
Let $M' = H^0_I(M)$ and $M'' = M/M'$ so that we have a short exact
sequence
$$
0 \to M' \to M \to M'' \to 0
$$
and $M''$ has $H^0_I(M') = 0$ by
Dualizing Complexes, Lemma \ref{dualizing-lemma-divide-by-torsion}.
By Artin-Rees (Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
we get short exact sequences
$$
0 \to M' \to M/I^n M \to M''/I^n M'' \to 0
$$
for $n$ large enough. Consider the long exact sequences
$$
H^s_T(M') \to
H^s_T(M/I^nM) \to
H^s_T(M''/I^nM'') \to
H^{s + 1}_T(M')
$$
Now it is a simple matter to see that if we have Mittag-Leffler
for the inverse system $\{H^s_T(M''/I^nM'')\}_{n \geq 0}$
then we have Mittag-Leffler for the inverse system
$\{H^s_T(M/I^nM)\}_{n \geq 0}$.
(Note that the ML condition for an inverse system of groups $G_n$
only depends on the values of the inverse system for sufficiently large $n$.)
Moreover the sequence
$$
H^s_T(M') \to
\lim H^s_T(M/I^nM) \to
\lim H^s_T(M''/I^nM'') \to
H^{s + 1}_T(M')
$$
is exact because we have ML in the required spots, see
Homology, Lemma \ref{homology-lemma-apply-Mittag-Leffler}.
Hence, if $H^s_T(M'') \to \lim H^s_T(M''/I^nM'')$
is an isomorphism, then
$H^s_T(M) \to \lim H^s_T(M/I^nM)$
is an isomorphism too by the five lemma
(Homology, Lemma \ref{homology-lemma-five-lemma}).
This reduces us to the case discussed in the next paragraph.

\medskip\noindent
Assume that $H^0_I(M) = 0$. Choose generators
$f_1, \ldots, f_r$ of $I^{m_0}$ where $m_0$ is the
integer found for $M$ in Lemma \ref{lemma-final-bootstrap}.
Then we consider the exact sequence
$$
0 \to M \xrightarrow{f_1, \ldots, f_r}
(I^{m_0}M)^{\oplus r} \to Q \to 0
$$
defining $Q$. Some observations: the first map is injective
exactly because $H^0_I(M) = 0$. The cokernel $Q$ of this injection
is a finite $A$-module such that for every $1 \leq j \leq r$
we have $Q_{f_j} \cong (M_{f_j})^{\oplus r - 1}$.
In particular, for a prime $\mathfrak p \subset A$
with $\mathfrak p \not \in V(I)$ we have
$Q_\mathfrak p \cong (M_\mathfrak p)^{\oplus r - 1}$.
Similarly, given $\mathfrak q \in T$ and
$\mathfrak p' \subset A' = (A_\mathfrak q)^\wedge$
not contained in $V(IA')$, we have
$Q'_{\mathfrak p'} \cong (M'_{\mathfrak p'})^{\oplus r - 1}$
where $Q' = (Q_\mathfrak q)^\wedge$ and $M' = (M_\mathfrak q)^\wedge$.
Thus the conditions in Situation \ref{situation-bootstrap}
hold for $A, I, T, Q$. (Observe that $Q$ may have
nonvanishing $H^0_I(Q)$ but this won't matter.)

\medskip\noindent
For any $n \geq 0$ we set $F^nM = M \cap I^n(I^{m_0}M)^{\oplus r}$
so that we get short exact sequences
$$
0 \to F^nM \to I^n(I^{m_0}M)^{\oplus r} \to I^nQ \to 0
$$
By Artin-Rees (Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
there exists a $c \geq 0$ such that
$I^n M \subset F^nM \subset I^{n - c}M$ for all $n \geq c$.
Let $m_0$ be the integer and let $m'(m)$
be the function defined for $m \geq m_0$
found in Lemma \ref{lemma-bootstrap}
applied to $M$. Note that the integer $m_0$
is the same as our integer $m_0$ chosen above (you don't need to
check this: you can just take the maximum of the two integers if
you like). Finally, by Lemma \ref{lemma-bootstrap}
applied to $Q$ for every integer $m$ there exists an integer
$m''(m) \geq m$ such that $H^s_T(I^kQ) \to H^s_T(I^mQ)$
is zero for all $k \geq m''(m)$.

\medskip\noindent
Fix $m \geq m_0$. Choose $k \geq m'(m''(m + c))$.
Choose $\xi \in H^{s + 1}_T(I^kM)$
which maps to zero in $H^{s + 1}_T(M)$.
We want to show that $\xi$ maps to zero in $H^{s + 1}_T(I^mM)$.
Namely, this will show that $\{H^s_T(M/I^nM)\}_{n \geq 0}$
is Mittag-Leffler exactly as in the proof of Lemma \ref{lemma-final-bootstrap}.
Picture to help vizualize the argument:
$$
\xymatrix{
&
H^{s + 1}_T(I^kM) \ar[r] \ar[d] &
H^{s + 1}_T(I^k(I^{m_0}M)^{\oplus r}) \ar[d] &
\\
H^s_T(I^{m''(m + c)}Q) \ar[r]_-\delta \ar[d] &
H^{s + 1}_T(F^{m''(m + c)}M) \ar[r] \ar[d] &
H^{s + 1}_T(I^{m''(m + c)}(I^{m_0}M)^{\oplus r}) \\
H^s_T(I^{m + c}Q) \ar[r] &
H^{s + 1}_T(F^{m + c}M) \ar[d] &
\\
&
H^{s + 1}_T(I^mM)
}
$$
The image of $\xi$ in $H^{s + 1}_T(I^k(I^{m_0}M)^{\oplus r})$
maps to zero in $H^{s + 1}_T((I^{m_0}M)^{\oplus r})$
and hence maps to zero in
$H^{s + 1}_T(I^{m''(m + c)}(I^{m_0}M)^{\oplus r})$
by choice of $m'(-)$.
Thus the image $\xi' \in H^{s + 1}_T(F^{m''(m + c)}M)$
maps to zero in $H^{s + 1}_T(I^{m''(m + c)}(I^{m_0}M)^{\oplus r})$
and hence $\xi' = \delta(\eta)$ for some
$\eta \in H^s_T(I^{m''(m + c)}Q)$.
By our choice of $m''(-)$ we find that $\eta$ maps to
zero in $H^s_T(I^{m + c}Q)$.
This in turn means that $\xi'$ maps to zero in
$H^{s + 1}_T(F^{m + c}M)$.
Since $F^{m + c}M \subset I^mM$ we conclude.

\medskip\noindent
Finally, we prove the statement on limits. Consider the short
exact sequences
$$
0 \to M/F^nM \to (I^{m_0}M)^{\oplus r}/I^n (I^{m_0}M)^{\oplus r}
\to Q/I^nQ \to 0
$$
We have $\lim H^s_T(M/I^nM) = \lim H^s_T(M/F^nM)$
as these inverse systems are pro-isomorphic. We obtain a commutative diagram
$$
\xymatrix{
H^{s - 1}_T(Q) \ar[r] \ar[d] &
\lim H^{s - 1}_T(Q/I^nQ) \ar[d] \\
H^s_T(M) \ar[r] \ar[d] &
\lim H^s_T(M/I^nM) \ar[d] \\
H^s_T((I^{m_0}M)^{\oplus r}) \ar[r] \ar[d] &
\lim H^s_T((I^{m_0}M)^{\oplus r}/I^n(I^{m_0}M)^{\oplus r}) \ar[d] \\
H^s_T(Q) \ar[r] &
\lim H^s_T(Q/I^nQ)
}
$$
The right column is exact because we have ML in the required spots, see
Homology, Lemma \ref{homology-lemma-apply-Mittag-Leffler}.
The lowest horizontal arrow is injective (!) by
part (5) of Lemma \ref{lemma-final-bootstrap}.
The horizontal arrow above it is bijective by
part (4) of Lemma \ref{lemma-final-bootstrap}.
The arrows in cohomological degrees $\leq s - 1$ are isomorphisms.
Thus we conclude $H^s_T(M) \to \lim H^s_T(M/I^nM)$
is an isomorphism by the five lemma
(Homology, Lemma \ref{homology-lemma-five-lemma}).
This finishes the proof of the theorem.
\end{proof}

\begin{lemma}
\label{lemma-combine-two}
Let $I \subset \mathfrak a \subset A$ be ideals of a Noetherian ring $A$
and let $M$ be a finite $A$-module. Let $s$ and $d$ be integers.
Suppose that
\begin{enumerate}
\item $A, I, V(\mathfrak a), M$ satisfy the assumptions of
Situation \ref{situation-bootstrap} for $s$ and $d$, and
\item $A, I, \mathfrak a, M$ satisfy the conditions of
Lemma \ref{lemma-algebraize-local-cohomology-general}
for $s + 1$ and $d$ with $J = \mathfrak a$.
\end{enumerate}
Then there exists an ideal
$J_0 \subset \mathfrak a$ with $V(J_0) \cap V(I) = V(\mathfrak a)$
such that for any $J \subset J_0$ with $V(J) \cap V(I) = V(\mathfrak a)$
the map
$$
H^{s + 1}_J(M) \longrightarrow \lim H^{s + 1}_\mathfrak a(M/I^nM)
$$
is an isomorphism.
\end{lemma}

\begin{proof}
Namely, we have the existence of $J_0$
and the isomorphism
$H^{s + 1}_J(M) = H^{s + 1}(R\Gamma_\mathfrak a(M)^\wedge)$
by Lemma \ref{lemma-algebraize-local-cohomology-general},
we have a short exact sequence
$$
0 \to R^1\lim H^s_\mathfrak a(M/I^nM) \to
H^{s + 1}(R\Gamma_\mathfrak a(M)^\wedge) \to
\lim H^{s + 1}_\mathfrak a(M/I^nM) \to 0
$$
by Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local},
and the module $R^1\lim H^s_\mathfrak a(M/I^nM)$ is zero because
$\{H^s_\mathfrak a(M/I^nM)\}_{n \geq 0}$ has Mittag-Leffler
by Theorem \ref{theorem-final-bootstrap}.
\end{proof}








\section{Algebraization of formal sections, I}
\label{section-algebraization-sections}

\noindent
In this section we study the problem of algebraization of
formal sections in the local case.
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let
$$
X = \Spec(A) \supset U = \Spec(A) \setminus \{\mathfrak m\}
$$
and denote $Y = V(I)$ the closed subscheme corresponding to $I$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
In this section we consider the limits
$$
\lim_n H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
This is closely related to the cohomology of the pullback
of $\mathcal{F}$ to the formal completion of $U$ along $Y$;
however, since we have not yet introduced formal schemes,
we cannot use this terminology here.

\begin{lemma}
\label{lemma-compare-with-derived-completion}
Let $U$ be the punctured spectrum of a Noetherian local ring $A$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
Let $I \subset A$ be an ideal. Then
$$
H^i(R\Gamma(U, \mathcal{F})^\wedge) =
\lim H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
for all $i$ where $R\Gamma(U, \mathcal{F})^\wedge$ denotes
the derived $I$-adic completion.
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-formal-functions-general} and
\ref{lemma-derived-completion-pseudo-coherent} we have
$$
R\Gamma(U, \mathcal{F})^\wedge =
R\Gamma(U, \mathcal{F}^\wedge) =
R\Gamma(U, R\lim \mathcal{F}/I^n\mathcal{F})
$$
Thus we obtain short exact sequences
$$
0 \to R^1\lim H^{i - 1}(U, \mathcal{F}/I^n\mathcal{F}) \to
H^i(R\Gamma(U, \mathcal{F})^\wedge) \to
\lim H^i(U, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
by Cohomology, Lemma \ref{cohomology-lemma-RGamma-commutes-with-Rlim}.
The $R^1\lim$ terms vanish because the inverse systems of groups
$H^i(U, \mathcal{F}/I^n\mathcal{F})$ satisfy the Mittag-Leffler condition
by Lemma \ref{lemma-ML-local}.
\end{proof}

\begin{theorem}
\label{theorem-algebraization-formal-sections}
\begin{reference}
The method of proof follows roughly the method of
proof of \cite[Theorem 1]{Faltings-algebraisation}
and \cite[Satz 2]{Faltings-uber}.
The result is almost the same as
\cite[Theorem 1.1]{MRaynaud-paper} (affine complement case) and
\cite[Theorem 3.9]{MRaynaud-book} (complement is union of few affines).
\end{reference}
Let $(A, \mathfrak m)$ be a Noetherian local ring which has a
dualizing complex and is complete with respect to an ideal $I$.
Set $X = \Spec(A)$, $Y = V(I)$, and $U = X \setminus \{\mathfrak m\}$.
Let $\mathcal{F}$ be a coherent sheaf on $U$.
Assume
\begin{enumerate}
\item $\text{cd}(A, I) \leq d$, i.e.,
$H^i(X \setminus Y, \mathcal{G}) = 0$ for $i \geq d$ and
quasi-coherent $\mathcal{G}$ on $X$,
\item for any $x \in X \setminus Y$ whose closure $\overline{\{x\}}$
in $X$ meets $U \cap Y$ we have
$$
\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) \geq s
\quad\text{or}\quad
\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x)
+ \dim(\overline{\{x\}}) > d + s
$$
\end{enumerate}
Then there exists an open $V_0 \subset U$ containing $U \cap Y$
such that for any open $V \subset V_0$ containing $U \cap Y$
the map
$$
H^i(V, \mathcal{F}) \to \lim H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
is an isomorphism for $i < s$. If in addition
$
\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) +
\dim(\overline{\{x\}}) > s
$
for all $x \in U \cap Y$, then these cohomology groups are finite $A$-modules.
\end{theorem}

\begin{proof}
Choose a finite $A$-module $M$ such that $\mathcal{F}$ is the
restriction to $U$ of the
coherent $\mathcal{O}_X$-module associated to $M$, see Local Cohomology,
Lemma \ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
Then the assumptions of
Lemma \ref{lemma-algebraize-local-cohomology}
are satisfied.
Pick $J_0$ as in that lemma and set $V_0 = X \setminus V(J_0)$.
Then opens $V \subset V_0$ containing $U \cap Y$
correspond $1$-to-$1$ with ideals $J \subset J_0$ with
$V(J) \cap V(I) = \{\mathfrak m\}$.
Moreover, for such a choice we have a distinguished triangle
$$
R\Gamma_J(M) \to M \to R\Gamma(V, \mathcal{F}) \to
R\Gamma_J(M)[1]
$$
We similarly have a distinguished triangle
$$
R\Gamma_\mathfrak m(M)^\wedge \to
M \to
R\Gamma(U, \mathcal{F})^\wedge \to
R\Gamma_\mathfrak m(M)^\wedge[1]
$$
involving derived $I$-adic completions.
The cohomology groups of $R\Gamma(U, \mathcal{F})^\wedge$ are
equal to the limits in the statement of the theorem by
Lemma \ref{lemma-compare-with-derived-completion}.
The canonical map between these triangles
and some easy arguments show that our
theorem follows from the main Lemma \ref{lemma-algebraize-local-cohomology}
(note that we have $i < s$ here whereas we have
$i \leq s$ in the lemma; this is because of the shift).
The finiteness of the cohomology groups
(under the additional assumption) follows from
Lemma \ref{lemma-kill-colimit}.
\end{proof}

\begin{lemma}
\label{lemma-application-theorem}
Let $(A, \mathfrak m)$ be a Noetherian local ring which has a
dualizing complex and is complete with respect to an ideal $I$.
Set $X = \Spec(A)$, $Y = V(I)$, and $U = X \setminus \{\mathfrak m\}$.
Let $\mathcal{F}$ be a coherent sheaf on $U$.
Assume for any associated point $x \in U$ of $\mathcal{F}$
we have $\dim(\overline{\{x\}}) > \text{cd}(A, I) + 1$
where $\overline{\{x\}}$ is the closure in $X$.
Then the map
$$
\colim H^0(V, \mathcal{F})
\longrightarrow
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})
$$
is an isomorphism of finite $A$-modules
where the colimit is over opens $V \subset U$
containing $U \cap Y$.
\end{lemma}

\begin{proof}
Apply Theorem \ref{theorem-algebraization-formal-sections} with $s = 1$
(we get finiteness too).
\end{proof}




\section{Algebraization of formal sections, II}
\label{section-algebraization-sections-coherent}

\noindent
It is a bit difficult to succintly state all possible
consequences of the results in
Sections \ref{section-algebraization-sections-general} and
\ref{section-bootstrap}
for cohomology of coherent sheaves on quasi-affine schemes
and their completion with respect to an ideal.
This section gives a nonexhaustive list of
applications to $H^0$. The next section contains
applications to higher cohomology.

\medskip\noindent
The following lemma will be superceded by
Proposition \ref{proposition-application-H0}.

\begin{lemma}
\label{lemma-application-H0-pre}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $\mathcal{F}$ be a coherent module on
$U = \Spec(A) \setminus V(\mathfrak a)$.
Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $x \in \text{Ass}(\mathcal{F})$, $x \not \in V(I)$,
$\overline{\{x\}} \cap V(I) \not \subset V(\mathfrak a)$
and $z \in \overline{\{x\}} \cap V(\mathfrak a)$, then
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) > \text{cd}(A, I) + 1$,
\item one of the following holds:
\begin{enumerate}
\item the restriction of $\mathcal{F}$ to $U \setminus V(I)$ is $(S_1)$
\item the dimension of $V(\mathfrak a)$ is at most $2$\footnote{In
the sense that the difference of the maximal and minimal values
on $V(\mathfrak a)$ of a dimension function on $\Spec(A)$ is at most $2$.}.
\end{enumerate}
\end{enumerate}
Then we obtain an isomorphism
$$
\colim H^0(V, \mathcal{F})
\longrightarrow
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})
$$
where the colimit is over opens $V \subset U$ containing $U \cap V(I)$.
\end{lemma}

\begin{proof}
Choose a finite $A$-module $M$ such that $\mathcal{F}$ is the restriction
to $U$ of the coherent module associated to $M$, see Local Cohomology,
Lemma \ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
Set $d = \text{cd}(A, I)$.
Let $\mathfrak p$ be a prime of $A$ not contained in $V(I)$
and let $\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$.
Then either $\mathfrak p$ is not an associated prime of $M$
and hence $\text{depth}(M_\mathfrak p) \geq 1$
or we have $\dim((A/\mathfrak p)_\mathfrak q) > d + 1$ by (2).
Thus the hypotheses of
Lemma \ref{lemma-algebraize-local-cohomology-general}
are satisfied for $s = 1$ and $d$; here we use condition (3).
Thus we find there exists an ideal
$J_0 \subset \mathfrak a$ with $V(J_0) \cap V(I) = V(\mathfrak a)$
such that for any $J \subset J_0$ with $V(J) \cap V(I) = V(\mathfrak a)$
the maps
$$
H^i_J(M) \longrightarrow H^i(R\Gamma_\mathfrak a(M)^\wedge)
$$
are isomorphisms for $i = 0, 1$. Consider the morphisms of
exact triangles
$$
\xymatrix{
R\Gamma_J(M)  \ar[d] \ar[r] &
M \ar[r] \ar[d] &
R\Gamma(V, \mathcal{F}) \ar[d] \ar[r] &
R\Gamma_J(M)[1]  \ar[d] \\
R\Gamma_J(M)^\wedge \ar[r] &
M \ar[r] &
R\Gamma(V, \mathcal{F})^\wedge \ar[r] &
R\Gamma_J(M)^\wedge[1] \\
R\Gamma_\mathfrak a(M)^\wedge \ar[r] \ar[u] &
M \ar[r] \ar[u] &
R\Gamma(U, \mathcal{F})^\wedge \ar[r] \ar[u] &
R\Gamma_\mathfrak a(M)^\wedge[1] \ar[u]
}
$$
where $V = \Spec(A) \setminus V(J)$. Recall that
$R\Gamma_\mathfrak a(M)^\wedge \to R\Gamma_J(M)^\wedge$
is an isomorphism (because $\mathfrak a$, $\mathfrak a + I$, and $J + I$
cut out the same closed subscheme, for example
see proof of Lemma \ref{lemma-algebraize-local-cohomology-general}).
Hence
$R\Gamma(U, \mathcal{F})^\wedge = R\Gamma(V, \mathcal{F})^\wedge$.
This produces a commutative diagram
$$
\xymatrix{
0 \ar[r] &
H^0_J(M) \ar[r] \ar[d] &
M \ar[r] \ar[d] \ar[r] &
\Gamma(V, \mathcal{F}) \ar[d] \ar[r] &
H^1_J(M) \ar[d] \ar[r] &
0 \\
0 \ar[r] &
H^0(R\Gamma_J(M)^\wedge) \ar[r] &
M \ar[r] &
H^0(R\Gamma(V, \mathcal{F})^\wedge) \ar[r] &
H^1(R\Gamma_J(M)^\wedge) \ar[r] &
0 \\
0 \ar[r] &
H^0(R\Gamma_\mathfrak a(M)^\wedge) \ar[r] \ar[u] &
M \ar[r] \ar[u] &
H^0(R\Gamma(U, \mathcal{F})^\wedge) \ar[r] \ar[u] &
H^1(R\Gamma_\mathfrak a(M)^\wedge) \ar[r] \ar[u] &
0
}
$$
with exact rows and isomorphisms for the lower vertical arrows. Hence
we obtain an isomorphism
$\Gamma(V, \mathcal{F}) \to H^0(R\Gamma(U, \mathcal{F})^\wedge)$.
By Lemmas \ref{lemma-formal-functions-general}
and \ref{lemma-derived-completion-pseudo-coherent} we have
$$
R\Gamma(U, \mathcal{F})^\wedge =
R\Gamma(U, \mathcal{F}^\wedge) =
R\Gamma(U, R\lim \mathcal{F}/I^n\mathcal{F})
$$
and we find $H^0(R\Gamma(U, \mathcal{F})^\wedge) =
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})$ by
Cohomology, Lemma \ref{cohomology-lemma-RGamma-commutes-with-Rlim}.
\end{proof}

\noindent
Now we bootstrap the preceding lemma to get rid of condition (3).

\begin{proposition}
\label{proposition-application-H0}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $\mathcal{F}$ be a coherent module on
$U = \Spec(A) \setminus V(\mathfrak a)$.
Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $x \in \text{Ass}(\mathcal{F})$, $x \not \in V(I)$,
$\overline{\{x\}} \cap V(I) \not \subset V(\mathfrak a)$
and $z \in \overline{\{x\}} \cap V(\mathfrak a)$, then
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) > \text{cd}(A, I) + 1$.
\end{enumerate}
Then we obtain an isomorphism
$$
\colim H^0(V, \mathcal{F})
\longrightarrow
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})
$$
where the colimit is over opens $V \subset U$ containing $U \cap V(I)$.
\end{proposition}

\begin{proof}
Let $T \subset U$ be the set of points $x$ with
$\overline{\{x\}} \cap V(I) \subset V(\mathfrak a)$.
Let $\mathcal{F} \to \mathcal{F}'$ be the surjection
of coherent modules on $U$ constructed in
Local Cohomology, Lemma \ref{local-cohomology-lemma-get-depth-1-along-Z}.
Since $\mathcal{F} \to \mathcal{F}'$ is an isomorphism
over an open $V \subset U$ containing $U \cap V(I)$
it suffices to prove the lemma with $\mathcal{F}$ replaced
by $\mathcal{F}'$. Hence we may and do assume
for $x \in U$ with $\overline{\{x\}} \cap V(I) \subset V(\mathfrak a)$
we have $\text{depth}(\mathcal{F}_x) \geq 1$.

\medskip\noindent
Let $\mathcal{V}$ be the set of open subschemes $V \subset U$
containing $U \cap V(I)$ ordered by reverse inclusion.
This is a directed set. We first claim that
$$
\mathcal{F}(V)
\longrightarrow
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})
$$
is injective for any $V \in \mathcal{F}$ (and in particular the map
of the lemma is injective). Namely, an associated point $x$ of $\mathcal{F}$
must have $\overline{\{x\}} \cap U \cap Y \not = \emptyset$
by the previous paragraph. If $y \in \overline{\{x\}} \cap U \cap Y$ then
$\mathcal{F}_x$ is a localization of $\mathcal{F}_y$
and $\mathcal{F}_y \subset \lim \mathcal{F}_y/I^n \mathcal{F}_y$
by Krull's intersection theorem
(Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero}).
This proves the claim as a section $s \in \mathcal{F}(V)$
in the kernel would have to have empty support, hence would have to be zero.

\medskip\noindent
Choose a finite $A$-module $M$ such that $\mathcal{F}$ is the restriction
of $\widetilde{M}$ to $U$, see Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
We may and do assume that $H^0_\mathfrak a(M) = 0$.
Let $\text{Ass}(M) \setminus V(I) = \{\mathfrak p_1, \ldots, \mathfrak p_n\}$.
We will prove the lemma by induction on $n$. After reordering we
may assume that $\mathfrak p_n$ is a minimal element of the set
$\{\mathfrak p_1, \ldots, \mathfrak p_n\}$ with respect to inclusion, i.e,
$\mathfrak p_n$ is a generic point of the support of $M$.
Set
$$
M' = H^0_{\mathfrak p_1 \ldots \mathfrak p_{n - 1} I}(M)
$$
and $M'' = M/M'$. Let $\mathcal{F}'$ and $\mathcal{F}''$ be the
coherent $\mathcal{O}_U$-modules corresponding to $M'$ and $M''$.
Dualizing Complexes, Lemma \ref{dualizing-lemma-divide-by-torsion}
implies that $M''$ has only one associated prime, namely $\mathfrak p_n$.
On the other hand, since
$\mathfrak p_n \not \in V(\mathfrak p_1 \ldots \mathfrak p_{n - 1} I)$
we see that $\mathfrak p_n$ is not an associated prime of $M'$.
Hence the induction hypothesis applies to $M'$; note
that since $\mathcal{F}' \subset \mathcal{F}$
the condition $\text{depth}(\mathcal{F}'_x) \geq 1$ at points $x$ with
$\overline{\{x\}} \cap V(I) \subset V(\mathfrak a)$ holds, see
Algebra, Lemma \ref{algebra-lemma-depth-in-ses}.

\medskip\noindent
Let $\hat s$ be an element of $\lim H^0(U, \mathcal{F}/I^n\mathcal{F})$.
Let $\hat s''$ be the image in $\lim H^0(U, \mathcal{F}''/I^n\mathcal{F}'')$.
Since $\mathcal{F}''$ has only one associated point, namely the point
corresponding to $\mathfrak p_n$, we see that
Lemma \ref{lemma-application-H0-pre} applies and we find an open
$U \cap V(I) \subset V \subset U$
and a section $s'' \in \mathcal{F}''(V)$ mapping to $\hat s''$.
Let $J \subset A$ be an ideal such that $V(J) = \Spec(A) \setminus V$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
after replacing $J$ by a power, we may assume
there is an $A$-linear map $\varphi : J \to M''$
corresponding to $s''$. Since $M \to M''$ is surjective, for
each $g \in J$ we can choose $m_g \in M$ mapping to
$\varphi(g) \in M''$. Then $\hat s'_g = g \hat s - m_g$
is in $\lim H^0(U, \mathcal{F}'/I^n\mathcal{F}')$.
By induction hypothesis there is a $V' \geq V$
section $s'_g \in \mathcal{F}'(V')$
mapping to $\hat s'_g$. All in all we conclude that
$g \hat s$ is in the image of
$\mathcal{F}(V') \to \lim H^0(U, \mathcal{F}/I^n\mathcal{F})$
for some $V' \subset V$ possibly depending on $g$.
However, since $J$ is finitely generated we can find a single
$V' \in \mathcal{V}$ which works for each of the generators
and it follows that $V'$ works for all $g$.

\medskip\noindent
Combining the previous paragraph with the injectivity
shown in the second paragraph we find there exists
a $V' \geq V$ and an $A$-module map $\psi : J \to \mathcal{F}(V')$
such that $\psi(g)$ maps to $g\hat s$. This determines a
map $\widetilde{J} \to (V' \to \Spec(A))_*\mathcal{F}|_{V'}$
whose restriction to $V'$ provides an element
$s \in \mathcal{F}(V')$ mapping to $\hat s$.
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-application-H0}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $\mathcal{F}$ be a coherent module on
$U = \Spec(A) \setminus V(\mathfrak a)$.
Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $x \in \text{Ass}(\mathcal{F})$, $x \not \in V(I)$,
$z \in V(\mathfrak a) \cap \overline{\{x\}}$, then
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) > \text{cd}(A, I) + 1$,
\item for $x \in U$ with $\overline{\{x\}} \cap V(I) \subset V(\mathfrak a)$
we have $\text{depth}(\mathcal{F}_x) \geq 2$,
\end{enumerate}
Then we obtain an isomorphism
$$
H^0(U, \mathcal{F})
\longrightarrow
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})
$$
\end{lemma}

\begin{proof}
Let $\hat s \in \lim H^0(U, \mathcal{F}/I^n\mathcal{F})$.
By Proposition \ref{proposition-application-H0}
we find that $\hat s$ is the image of an element $s \in \mathcal{F}(V)$
for some $V \subset U$ open containing $U \cap V(I)$.
However, condition (3) shows that $\text{depth}(\mathcal{F}_x) \geq 2$
for all $x \in U \setminus V$ and hence we find that
$\mathcal{F}(V) = \mathcal{F}(U)$ by
Divisors, Lemma \ref{divisors-lemma-depth-2-hartog}
and the proof is complete.
\end{proof}

\begin{example}
\label{example-H0}
Let $A$ be a Noetherian domain which has a dualizing complex
and which is complete with respect to a nonzero $f \in A$.
Let $f \in \mathfrak a \subset A$ be an ideal.
Assume every irreducible component of $Z = V(\mathfrak a)$
has codimension $> 2$ in $X = \Spec(A)$. Equivalently, assume every
irreducible component of $Z$ has codimension $> 1$ in $Y = V(f)$.
Then with
$U = X \setminus Z$ every element of
$$
\lim_n \Gamma(U, \mathcal{O}_U/f^n \mathcal{O}_U)
$$
is the restriction of a section of $\mathcal{O}_U$ defined on an
open neighbourhood of
$$
V(f) \setminus Z = V(f) \cap U = Y \setminus Z = U \cap Y
$$
In particular we see that $Y \setminus Z$ is connected. See
Lemma \ref{lemma-connected} below.
\end{example}

\begin{lemma}
\label{lemma-alternative-colim-H0}
Let $A$ be a Noetherian ring. Let $f \in \mathfrak a \subset A$
be an element of an ideal of $A$. Let $M$ be a finite $A$-module.
Assume
\begin{enumerate}
\item $A$ is $f$-adically complete,
\item $f$ is a nonzerodivisor on $M$,
\item $H^1_\mathfrak a(M/fM)$ is a finite $A$-module.
\end{enumerate}
Then with $U = \Spec(A) \setminus V(\mathfrak a)$ the map
$$
\colim_V \Gamma(V, \widetilde{M})
\longrightarrow
\lim \Gamma(U, \widetilde{M/f^nM})
$$
is an isomorphism where the colimit is over opens $V \subset U$
containing $U \cap V(f)$.
\end{lemma}

\begin{proof}
Set $\mathcal{F} = \widetilde{M}|_U$.
The finiteness of $H^1_\mathfrak a(M/fM)$ implies that
$H^0(U, \mathcal{F}/f\mathcal{F})$ is finite, see
Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
By Lemma \ref{lemma-limit-finite} (which applies as $f$ is a
nonzerodivisor on $\mathcal{F}$)
we see that $N = \lim H^0(U, \mathcal{F}/f^n\mathcal{F})$
is a finite $A$-module, is $f$-torsion free, and
$N/fN \subset H^0(U, \mathcal{F}/f\mathcal{F})$.
On the other hand, we have $M \to N$ and the map
$$
M/fM \longrightarrow H^0(U, \mathcal{F}/f\mathcal{F})
$$
is an isomorphism upon localization at any prime $\mathfrak q$ in
$U_0 = V(f) \setminus \{\mathfrak m\}$ (details omitted). Thus
$M_\mathfrak q \to N_\mathfrak q$ induces an isomorphism
$$
M_\mathfrak q/fM_\mathfrak q =
(M/fM)_\mathfrak q \to (N/fN)_\mathfrak q =
N_\mathfrak q/fN_\mathfrak q
$$
Since $f$ is a nonzerodivisor on both $N$ and $M$ we conclude
that $M_\mathfrak q \to N_\mathfrak q$ is an isomorphism (use
Nakayama to see surjectivity). We conclude that $M$ and $N$
determine isomorphic coherent modules over an open $V$
as in the statement of the lemma. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-alternative-H0}
Let $A$ be a Noetherian ring. Let $f \in \mathfrak a \subset A$
be an element of an ideal of $A$. Let $M$ be a finite $A$-module.
Assume
\begin{enumerate}
\item $A$ is $f$-adically complete,
\item $H^1_\mathfrak a(M)$ and $H^2_\mathfrak a(M)$ are
annihilated by a power of $f$.
\end{enumerate}
Then with $U = \Spec(A) \setminus V(\mathfrak a)$ the map
$$
\Gamma(U, \widetilde{M})
\longrightarrow
\lim \Gamma(U, \widetilde{M/f^nM})
$$
is an isomorphism.
\end{lemma}

\begin{proof}
We may apply
Lemma \ref{lemma-formal-functions-principal}
to $U$ and $\mathcal{F} = \widetilde{M}|_U$
because $\mathcal{F}$ is a Noetherian object in
the category of coherent $\mathcal{O}_U$-modules.
Since $H^1(U, \mathcal{F}) = H^2_\mathfrak a(M)$
(Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local})
is annihilated by a power of $f$, we see that
its $f$-adic Tate module is zero.
Hence the lemma shows $\lim H^0(U, \mathcal{F}/f^n \mathcal{F})$
is the $0$th cohomology group of the
derived $f$-adic completion of $H^0(U, \mathcal{F})$.
Consider the exact sequence
$$
0 \to H^0_\mathfrak a(M) \to M \to
\Gamma(U, \mathcal{F}) \to H^1_\mathfrak a(M) \to 0
$$
of Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
Since $H^1_\mathfrak a(M)$ is annihilated by a power of $f$
it is derived complete with respect to $(f)$.
Since $M$ and $H^0_\mathfrak a(M)$ are finite $A$-modules
they are complete
(Algebra, Lemma \ref{algebra-lemma-completion-tensor})
hence derived complete
(More on Algebra,
Proposition \ref{more-algebra-proposition-derived-complete-modules}).
By More on Algebra, Lemma \ref{more-algebra-lemma-serre-subcategory}
we conclude that $\Gamma(U, \mathcal{F})$ is derived complete
as desired.
\end{proof}







\section{Algebraization of formal sections, III}
\label{section-algebraization-sections-coherent-III}

\noindent
The next section contains a nonexhaustive list of
applications of the material
on completion of local cohomology to higher cohomology
of coherent modules on quasi-affine schemes and their
completion with respect to an ideal.

\begin{proposition}
\label{proposition-application-higher}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $\mathcal{F}$ be a coherent module on
$U = \Spec(A) \setminus V(\mathfrak a)$.
Let $s \geq 0$.
Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $x \in U \setminus V(I)$ then
$\text{depth}(\mathcal{F}_x) > s$ or
$$
\text{depth}(\mathcal{F}_x) +
\dim(\mathcal{O}_{\overline{\{x\}}, z}) > \text{cd}(A, I) + s + 1
$$
for all $z \in V(\mathfrak a) \cap \overline{\{x\}}$,
\item one of the following conditions holds:
\begin{enumerate}
\item the restriction of $\mathcal{F}$ to $U \setminus V(I)$
is $(S_{s + 1})$, or
\item the dimension of $V(\mathfrak a)$ is at most $2$\footnote{In
the sense that the difference of the maximal and minimal values
on $V(\mathfrak a)$ of a dimension function on $\Spec(A)$ is at most $2$.}.
\end{enumerate}
\end{enumerate}
Then the maps
$$
H^i(U, \mathcal{F})
\longrightarrow
\lim H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
are isomorphisms for $i < s$. Moreover we have an isomorphism
$$
\colim H^s(V, \mathcal{F})
\longrightarrow
\lim H^s(U, \mathcal{F}/I^n\mathcal{F})
$$
where the colimit is over opens $V \subset U$ containing $U \cap V(I)$.
\end{proposition}

\begin{proof}
We may assume $s > 0$ as the case $s = 0$ was done in
Proposition \ref{proposition-application-H0}.

\medskip\noindent
Choose a finite $A$-module $M$ such that $\mathcal{F}$ is the restriction
to $U$ of the coherent module associated to $M$, see Local Cohomology,
Lemma \ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
Set $d = \text{cd}(A, I)$.
Let $\mathfrak p$ be a prime of $A$ not contained in $V(I)$
and let $\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$.
Then either $\text{depth}(M_\mathfrak p) \geq s + 1 > s$
or we have $\dim((A/\mathfrak p)_\mathfrak q) > d + s + 1$ by (2).
By Lemma \ref{lemma-bootstrap-bis-bis} we conclude that the
assumptions of Situation \ref{situation-bootstrap}
are satisfied for $A, I, V(\mathfrak a), M, s, d$.
On the other hand, the hypotheses of
Lemma \ref{lemma-algebraize-local-cohomology-general}
are satisfied for $s + 1$ and $d$; this is where condition (3) is used.

\medskip\noindent
Applying Lemma \ref{lemma-algebraize-local-cohomology-general}
we find there exists an ideal
$J_0 \subset \mathfrak a$ with $V(J_0) \cap V(I) = V(\mathfrak a)$
such that for any $J \subset J_0$ with $V(J) \cap V(I) = V(\mathfrak a)$
the maps
$$
H^i_J(M) \longrightarrow H^i(R\Gamma_\mathfrak a(M)^\wedge)
$$
is an isomorphism for $i \leq s + 1$.

\medskip\noindent
For $i \leq s$ the map $H^i_\mathfrak a(M) \to H^i_J(M)$
is an isomorphism by Lemmas \ref{lemma-bootstrap-inherited} and
\ref{lemma-kill-colimit-support-general}.
Using the comparison of cohomology and local cohomology
(Local Cohomology, Lemma \ref{local-cohomology-lemma-local-cohomology})
we deduce
$H^i(U, \mathcal{F}) \to H^i(V,\mathcal{F})$
is an isomorphism for $V = \Spec(A) \setminus V(J)$ and
$i < s$.

\medskip\noindent
By Theorem \ref{theorem-final-bootstrap} we have
$H^i_\mathfrak a(M) = \lim H^i_\mathfrak a(M/I^nM)$
for $i \leq s$. By Lemma \ref{lemma-combine-two} we have
$H^{s + 1}_\mathfrak a(M) = \lim H^{s + 1}_\mathfrak a(M/I^nM)$.

\medskip\noindent
The isomorphism $H^0(U, \mathcal{F}) = H^0(V, \mathcal{F}) =
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})$ follows from the above and
Proposition \ref{proposition-application-H0}.
For $0 < i < s$ we get the desired isomorphisms
$H^i(U, \mathcal{F}) = H^i(V, \mathcal{F}) =
\lim H^i(U, \mathcal{F}/I^n\mathcal{F})$ in
the same manner using the relation between local cohomology
and cohomology; it is easier than the case $i = 0$
because for $i > 0$ we have
$$
H^i(U, \mathcal{F}) = H^{i + 1}_\mathfrak a(M),
\quad
H^i(V, \mathcal{F}) = H^{i + 1}_J(M),
\quad
H^i(R\Gamma(U, \mathcal{F})^\wedge) = 
H^{i + 1}(R\Gamma_\mathfrak a(M)^\wedge)
$$
Similarly for the final statement.
\end{proof}

\begin{lemma}
\label{lemma-alternative-higher}
Let $A$ be a Noetherian ring. Let $f \in \mathfrak a \subset A$
be an element of an ideal of $A$. Let $M$ be a finite $A$-module.
Let $s \geq 0$. Assume
\begin{enumerate}
\item $A$ is $f$-adically complete,
\item $H^i_\mathfrak a(M)$ is annihilated by a power of $f$
for $i \leq s + 1$.
\end{enumerate}
Then with $U = \Spec(A) \setminus V(\mathfrak a)$ the map
$$
H^i(U, \widetilde{M})
\longrightarrow
\lim H^i(U, \widetilde{M/f^nM})
$$
is an isomorphism for $i < s$.
\end{lemma}

\begin{proof}
The proof is the same as the proof of Lemma \ref{lemma-alternative-H0}.
We may apply Lemma \ref{lemma-formal-functions-principal}
to $U$ and $\mathcal{F} = \widetilde{M}|_U$
because $\mathcal{F}$ is a Noetherian object in
the category of coherent $\mathcal{O}_U$-modules.
Since $H^i(U, \mathcal{F}) = H^{i + 1}_\mathfrak a(M)$
(Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local})
is annihilated by a power of $f$ for $i \leq s$, we see that
its $f$-adic Tate module is zero.
Hence the lemma shows $\lim H^{i - 1}(U, \mathcal{F}/f^n \mathcal{F})$
is the $0$th cohomology group of the
derived $f$-adic completion of $H^{i - 1}(U, \mathcal{F})$.
However, if $s \geq i > 1$, then this equal to the $f$-power torsion
module $H^i_\mathfrak a(M)$ and hence equal to its own
(derived) completion. For $i = 0$, we refer to
Lemma \ref{lemma-alternative-H0}.
\end{proof}





\section{Application to connectedness}
\label{section-connected}

\noindent
In this section we discuss Grothendieck's connectedness theorem
and variants; the original version can be found as
\cite[Exposee XIII, Theorem 2.1]{SGA2}. There is a version
called Faltings' connectedness theorem in the literature;
our guess is that this refers to \cite[Theorem 6]{Faltings-some}.
Let us state and prove the optimal version for complete
local rings given in \cite[Theorem 1.6]{Varbaro}.

\begin{lemma}
\label{lemma-punctured-still-connected}
\begin{reference}
\cite[Theorem 1.6]{Varbaro}
\end{reference}
Let $(A, \mathfrak m)$ be a Noetherian complete local ring.
Let $I$ be a proper ideal of $A$.
Set $X = \Spec(A)$ and $Y = V(I)$.
Denote
\begin{enumerate}
\item $d$ the minimal dimension of an irreducible component of $X$, and
\item $c$ the minimal dimension of a closed subset $Z \subset X$
such that $X \setminus Z$ is disconnected.
\end{enumerate}
Then for $Z \subset Y$ closed we have $Y \setminus Z$ is connected if
$\dim(Z) < \min(c, d - 1) - \text{cd}(A, I)$. In particular, the punctured
spectrum of $A/I$ is connected if $\text{cd}(A, I) < \min(c, d - 1)$.
\end{lemma}

\begin{proof}
Let us first prove the final assertion. As a first case, if the punctured
spectrum of $A/I$ is empty, then
Local Cohomology, Lemma \ref{local-cohomology-lemma-cd-bound-dim-local}
shows every irreducible component of $X$ has dimension
$\leq \text{cd}(A, I)$ and we get $\min(c, d - 1) - \text{cd}(A, I) < 0$
which implies the lemma holds in this case. Thus we may assume
$U \cap Y$ is nonempty where $U = X \setminus \{\mathfrak m\}$
is the punctured spectrum of $A$. We may replace $A$ by its reduction.
Observe that $A$ has a dualizing complex
(Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing})
and that $A$ is complete with respect to $I$
(Algebra, Lemma \ref{algebra-lemma-complete-by-sub}).
If we assume $d - 1 > \text{cd}(A, I)$, then we may apply
Lemma \ref{lemma-application-theorem} to see that
$$
\colim H^0(V, \mathcal{O}_V)
\longrightarrow
\lim H^0(U, \mathcal{O}_U/I^n\mathcal{O}_U)
$$
is an isomorphism where the colimit is over opens $V \subset U$
containing $U \cap Y$. If $U \cap Y$ is disconnected, then
its $n$th infinitesimal neighbourhood in $U$ is disconnected
for all $n$ and we find the
right hand side has a nontrivial idempotent (here we use
that $U \cap Y$ is nonempty).
Thus we can find a $V$ which is disconnected.
Set $Z = X \setminus V$. By
Local Cohomology, Lemma \ref{local-cohomology-lemma-cd-bound-dim-local}
we see that every irreducible component of $Z$ has dimension
$\leq \text{cd}(A, I)$. Hence $c \leq \text{cd}(A, I)$ and this
indeed proves the final statement.

\medskip\noindent
We can deduce the statement of the lemma from what we just proved
as follows. Suppose that $Z \subset Y$ closed and $Y \setminus Z$ is
disconnected and $\dim(Z) = e$. Recall that a connected space is nonempty
by convention. Hence we conclude either (a) $Y = Z$ or (b)
$Y \setminus Z = W_1 \amalg W_2$ with $W_i$ nonempty, open, and closed
in $Y \setminus Z$. In case (b) we may pick points $w_i \in W_i$
which are closed in $U$, see
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-Jacobson-schemes}.
Then we can find $f_1, \ldots, f_e \in \mathfrak m$
such that $V(f_1, \ldots, f_e) \cap Z = \{\mathfrak m\}$
and in case (b) we may assume $w_i \in V(f_1, \ldots, f_e)$.
Namely, we can inductively using prime avoidance
choose $f_i$ such that $\dim V(f_1, \ldots, f_i) \cap Z = e - i$
and such that in case (b) we have $w_1, w_2 \in V(f_i)$.
It follows that the punctured spectrum of $A/I + (f_1, \ldots, f_e)$
is disconnected (small detail omitted). Since
$\text{cd}(A, I + (f_1, \ldots, f_e)) \leq \text{cd}(A, I) + e$ by
Local Cohomology, Lemmas \ref{local-cohomology-lemma-cd-sum} and
\ref{local-cohomology-lemma-bound-cd} we conclude that
$$
\text{cd}(A, I) + e \geq \min(c, d - 1)
$$
by the first part of the proof. This implies
$e \geq \min(c, d - 1) - \text{cd}(A, I)$ which is what we had to show.
\end{proof}

\begin{lemma}
\label{lemma-connected}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $\mathfrak p \subset A$ is a minimal prime not contained
in $V(I)$ and $\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$, then
$\dim((A/\mathfrak p)_\mathfrak q) > \text{cd}(A, I) + 1$,
\item any nonempty open $V \subset \Spec(A)$ which contains
$V(I) \setminus V(\mathfrak a)$ is connected\footnote{For example
if $A$ is a domain.}.
\end{enumerate}
Then $V(I) \setminus V(\mathfrak a)$ is either empty or connected.
\end{lemma}

\begin{proof}
We may replace $A$ by its reduction. Then we have the inequality
in (2) for all associated primes of $A$. By
Proposition \ref{proposition-application-H0} we see that
$$
\colim H^0(V, \mathcal{O}_V) = \lim H^0(T_n, \mathcal{O}_{T_n})
$$
where the colimit is over the opens $V$ as in (3) and $T_n$ is the
$n$th infinitesimal neighbourhood of $T = V(I) \setminus V(\mathfrak a)$
in $U = \Spec(A) \setminus V(\mathfrak a)$. Thus $T$ is either empty
or connected, since if not, then the right hand side would have a
nontrivial idempotent and we've assumed the left hand side does not.
Some details omitted.
\end{proof}






\section{The completion functor}
\label{section-completion}

\noindent
Let $X$ be a Noetherian scheme. Let $Y \subset X$ be a closed subscheme
with quasi-coherent sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$.
In this section we consider inverse systems of coherent
$\mathcal{O}_X$-modules $(\mathcal{F}_n)$ with $\mathcal{F}_n$
annihilated by $I^n$ such that the transition maps induce
isomorphisms $\mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1} \to \mathcal{F}_n$.
The category of these inverse systems was denoted
$$
\textit{Coh}(X, \mathcal{I})
$$
in Cohomology of Schemes, Section \ref{coherent-section-coherent-formal}.
This category is equivalent to the category of coherent modules
on the formal completion of $X$ along $Y$; however, since we have
not yet introduced formal schemes or coherent modules on them,
we cannot use this terminology here. We are particularly interested
in the completion functor
$$
\textit{Coh}(\mathcal{O}_X)
\longrightarrow
\textit{Coh}(X, \mathcal{I}),\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
See
Cohomology of Schemes, Equation (\ref{coherent-equation-completion-functor}).

\begin{lemma}
\label{lemma-completion-fully-faithful}
Let $X$ be a Noetherian scheme and let $Y \subset X$ be a closed subscheme.
Let $Y_n \subset X$ be the $n$th infinitesimal neighbourhood of $Y$ in $X$.
Consider the following conditions
\begin{enumerate}
\item $X$ is quasi-affine and
$\Gamma(X, \mathcal{O}_X) \to \lim \Gamma(Y_n, \mathcal{O}_{Y_n})$
is an isomorphism,
\item $X$ has an ample invertible module $\mathcal{L}$ and
$\Gamma(X, \mathcal{L}^{\otimes m}) \to
\lim \Gamma(Y_n, \mathcal{L}^{\otimes m}|_{Y_n})$
is an isomorphism for all $m \gg 0$,
\item for every finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ the map
$\Gamma(X, \mathcal{E}) \to \lim \Gamma(Y_n, \mathcal{E}|_{Y_n})$
is an isomorphism, and
\item the completion functor
$\textit{Coh}(\mathcal{O}_X) \to \textit{Coh}(X, \mathcal{I})$
is fully faithful on the full subcategory of finite locally free
objects.
\end{enumerate}
Then (1) $\Rightarrow$ (2) $\Rightarrow$ (3) $\Rightarrow$ (4)
and (4) $\Rightarrow$ (3).
\end{lemma}

\begin{proof}
Proof of (3) $\Rightarrow$ (4). If $\mathcal{F}$ and $\mathcal{G}$
are finite locally free on $X$, then considering
$\mathcal{H} = \SheafHom_{\mathcal{O}_X}(\mathcal{G}, \mathcal{F})$
and using Cohomology of Schemes, Lemma
\ref{coherent-lemma-completion-internal-hom}
we see that (3) implies (4).

\medskip\noindent
Proof of (2) $\rightarrow$ (3). Namely, let $\mathcal{L}$ be ample
on $X$ and suppose that $\mathcal{E}$ is a
finite locally free $\mathcal{O}_X$-module.
We claim we can find a universally exact sequence
$$
0 \to \mathcal{E} \to
(\mathcal{L}^{\otimes p})^{\oplus r} \to
(\mathcal{L}^{\otimes q})^{\oplus s}
$$
for some $r, s \geq 0$ and $0 \ll p \ll q$. If this holds, then
using the exact sequence
$$
0 \to \lim \Gamma(\mathcal{E}|_{Y_n}) \to
\lim \Gamma((\mathcal{L}^{\otimes p})^{\oplus r}|_{Y_n}) \to
\lim \Gamma((\mathcal{L}^{\otimes q})^{\oplus s}|_{Y_n})
$$
and the isomorphisms in (2) we get the isomorphism in (3).
To prove the claim, consider the dual locally free module
$\SheafHom_{\mathcal{O}_X}(\mathcal{E}, \mathcal{O}_X)$
and apply
Properties, Proposition \ref{properties-proposition-characterize-ample}
to find a surjection
$$
(\mathcal{L}^{\otimes -p})^{\oplus r}
\longrightarrow
\SheafHom_{\mathcal{O}_X}(\mathcal{E}, \mathcal{O}_X)
$$
Taking duals we obtain the first map in the exact sequence
(it is universally injective because being a surjection is universal).
Repeat with the cokernel to get the second. Some details omitted.

\medskip\noindent
Proof of (1) $\Rightarrow$ (2). This is true because if $X$ is quasi-affine
then $\mathcal{O}_X$ is an ample invertible module, see
Properties, Lemma \ref{properties-lemma-quasi-affine-O-ample}.

\medskip\noindent
We omit the proof of (4) $\Rightarrow$ (3).
\end{proof}

\noindent
Given a Noetherian scheme and a quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$ we will say
an object $(\mathcal{F}_n)$ of $\textit{Coh}(X, \mathcal{I})$
is {\it finite locally free} if each $\mathcal{F}_n$ is a finite
locally free $\mathcal{O}_X/\mathcal{I}^n$-module.

\begin{lemma}
\label{lemma-completion-fully-faithful-general}
Let $X$ be a Noetherian scheme and let $Y \subset X$ be a closed subscheme
with ideal sheaf $\mathcal{I} \subset \mathcal{O}_X$.
Let $Y_n \subset X$ be the $n$th infinitesimal neighbourhood of $Y$ in $X$.
Let $\mathcal{V}$ be the set of open subschemes $V \subset X$ containing $Y$
ordered by reverse inclusion.
\begin{enumerate}
\item $X$ is quasi-affine and
$$
\colim_\mathcal{V} \Gamma(V, \mathcal{O}_V)
\longrightarrow
\lim \Gamma(Y_n, \mathcal{O}_{Y_n})
$$
is an isomorphism,
\item $X$ has an ample invertible module $\mathcal{L}$ and
$$
\colim_\mathcal{V} \Gamma(V, \mathcal{L}^{\otimes m})
\longrightarrow
\lim \Gamma(Y_n, \mathcal{L}^{\otimes m}|_{Y_n})
$$
is an isomorphism for all $m \gg 0$,
\item for every $V \in \mathcal{V}$ and every finite locally free
$\mathcal{O}_V$-module $\mathcal{E}$ the map
$$
\colim_{V' \geq V} \Gamma(V', \mathcal{E}|_{V'})
\longrightarrow
\lim \Gamma(Y_n, \mathcal{E}|_{Y_n})
$$
is an isomorphism, and
\item the completion functor
$$
\colim_\mathcal{V} \textit{Coh}(\mathcal{O}_V)
\longrightarrow
\textit{Coh}(X, \mathcal{I}),
\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is fully faithful on the full subcategory of
finite locally free objects (see explanation above).
\end{enumerate}
Then (1) $\Rightarrow$ (2) $\Rightarrow$ (3) $\Rightarrow$ (4)
and (4) $\Rightarrow$ (3).
\end{lemma}

\begin{proof}
Observe that $\mathcal{V}$ is a directed set, so the colimits are
as in Categories, Section \ref{categories-section-directed-colimits}.
The rest of the argument is almost exactly the same as the argument
in the proof of Lemma \ref{lemma-completion-fully-faithful}; we urge
the reader to skip it.

\medskip\noindent
Proof of (3) $\Rightarrow$ (4). If $\mathcal{F}$ and $\mathcal{G}$
are finite locally free on $V \in \mathcal{V}$, then considering
$\mathcal{H} = \SheafHom_{\mathcal{O}_V}(\mathcal{G}, \mathcal{F})$
and using Cohomology of Schemes, Lemma
\ref{coherent-lemma-completion-internal-hom}
we see that (3) implies (4).

\medskip\noindent
Proof of (2) $\Rightarrow$ (3). Let $\mathcal{L}$ be ample
on $X$ and suppose that $\mathcal{E}$ is a
finite locally free $\mathcal{O}_V$-module
for some $V \in \mathcal{V}$.
We claim we can find a universally exact sequence
$$
0 \to \mathcal{E} \to
(\mathcal{L}^{\otimes p})^{\oplus r}|_{V} \to
(\mathcal{L}^{\otimes q})^{\oplus s}|_{V}
$$
for some $r, s \geq 0$ and $0 \ll p \ll q$. If this is true, then
the isomorphism in (2) will imply the isomorphism in (3).
To prove the claim, recall that $\mathcal{L}|_V$ is ample, see
Properties, Lemma \ref{properties-lemma-ample-on-locally-closed}.
Consider the dual locally free module
$\SheafHom_{\mathcal{O}_V}(\mathcal{E}, \mathcal{O}_V)$
and apply
Properties, Proposition \ref{properties-proposition-characterize-ample}
to find a surjection
$$
(\mathcal{L}^{\otimes -p})^{\oplus r}|_V \longrightarrow
\SheafHom_{\mathcal{O}_V}(\mathcal{E}, \mathcal{O}_V)
$$
(it is universally injective because being a surjection is universal).
Taking duals we obtain the first map in the exact sequence.
Repeat with the cokernel to get the second. Some details omitted.

\medskip\noindent
Proof of (1) $\Rightarrow$ (2). This is true because if $X$ is quasi-affine
then $\mathcal{O}_X$ is an ample invertible module, see
Properties, Lemma \ref{properties-lemma-quasi-affine-O-ample}.

\medskip\noindent
We omit the proof of (4) $\Rightarrow$ (3).
\end{proof}

\begin{lemma}
\label{lemma-recognize-formal-coherent-modules}
Let $X$ be a Noetherian scheme. Let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. The functor
$$
\textit{Coh}(X, \mathcal{I}) \longrightarrow \text{Pro-}\QCoh(\mathcal{O}_X)
$$
is fully faithful, see Categories, Remark \ref{categories-remark-pro-category}.
\end{lemma}

\begin{proof}
Let $(\mathcal{F}_n)$ and $(\mathcal{G}_n)$ be objects of
$\textit{Coh}(X, \mathcal{I})$. A morphism of pro-objects
$\alpha$ from $(\mathcal{F}_n)$ to $(\mathcal{G}_n)$ is given
by a system of maps
$\alpha_n : \mathcal{F}_{n'(n)} \to \mathcal{G}_n$
where $\mathbf{N} \to \mathbf{N}$, $n \mapsto n'(n)$
is an increasing function. Since
$\mathcal{F}_n = \mathcal{F}_{n'(n)}/\mathcal{I}^n\mathcal{F}_{n'(n)}$
and since $\mathcal{G}_n$ is annihilated by $\mathcal{I}^n$
we see that $\alpha_n$ induces a map $\mathcal{F}_n \to \mathcal{G}_n$.
\end{proof}

\noindent
Next we add some examples of the kind of fully faithfulness
result we will be able to prove using the work done earlier in this chapter.

\begin{lemma}
\label{lemma-fully-faithful}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $U = \Spec(A) \setminus V(\mathfrak a)$. Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item for any associated prime $\mathfrak p \subset A$,
$I \not \subset \mathfrak p$ and
$\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$ we have
$\dim((A/\mathfrak p)_\mathfrak q) > \text{cd}(A, I) + 1$.
\item for $\mathfrak p \subset A$, $I \not \subset \mathfrak p$ with
with $V(\mathfrak p) \cap V(I) \subset V(\mathfrak a)$
we have $\text{depth}(A_\mathfrak p) \geq 2$.
\end{enumerate}
Then the completion functor
$$
\textit{Coh}(\mathcal{O}_U)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U),
\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is fully faithful on the full subcategory of
finite locally free objects.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-fully-faithful}
it suffices to show that
$$
\Gamma(U, \mathcal{O}_U) =
\lim \Gamma(U, \mathcal{O}_U/I^n\mathcal{O}_U)
$$
This follows immediately from
Lemma \ref{lemma-application-H0}.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-simple-one}
Let $A$ be a Noetherian ring. Let $f \in \mathfrak a$ be an element of
an ideal of $A$. Let $U = \Spec(A) \setminus V(\mathfrak a)$. Assume
\begin{enumerate}
\item $A$ has a dualizing complex and is complete with respect to $f$,
\item $A_f$ is $(S_2)$ and for every minimal prime $\mathfrak p \subset A$,
$f \not \in \mathfrak p$ and
$\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$ we have
$\dim((A/\mathfrak p)_\mathfrak q) \geq 3$.
\end{enumerate}
Then the completion functor
$$
\textit{Coh}(\mathcal{O}_U)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U),
\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is fully faithful on the full subcategory of finite locally free objects.
\end{lemma}

\begin{proof}
We will show that Lemma \ref{lemma-fully-faithful} applies.
Assumption (1) of Lemma \ref{lemma-fully-faithful} holds.
Observe that $\text{cd}(A, (f)) \leq 1$, see
Local Cohomology, Lemma \ref{local-cohomology-lemma-bound-cd}.
Since $A_f$ is $(S_2)$ we see that every associated prime
$\mathfrak p \subset A$, $f \not \in \mathfrak p$ is a minimal prime.
Thus we get assumption (2) of Lemma \ref{lemma-fully-faithful}.
If $\mathfrak p \subset A$, $f \not \in \mathfrak p$ satisfies
$V(\mathfrak p) \cap V(I) \subset V(\mathfrak a)$ and if
$\mathfrak q \in V(\mathfrak p) \cap V(f)$ is a generic point,
then $\dim((A/\mathfrak p)_\mathfrak q) = 1$.
Then we obtain $\dim(A_\mathfrak p) \geq 2$ by looking at the minimal primes
$\mathfrak p_0 \subset \mathfrak p$ and using that
$\dim((A/\mathfrak p_0)_\mathfrak q) \geq 3$ by assumption. Thus
$\text{depth}(A_\mathfrak p) \geq 2$ by the $(S_2)$ assumption.
This verifies assumption (3) of Lemma \ref{lemma-fully-faithful}
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-alternative}
Let $A$ be a Noetherian ring. Let $f \in \mathfrak a \subset A$
be an element of an ideal of $A$. Let $U = \Spec(A) \setminus V(\mathfrak a)$.
Assume
\begin{enumerate}
\item $A$ is $f$-adically complete,
\item $H^1_\mathfrak a(A)$ and $H^2_\mathfrak a(A)$ are
annihilated by a power of $f$.
\end{enumerate}
Then the completion functor
$$
\textit{Coh}(\mathcal{O}_U)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U),
\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is fully faithful on the full subcategory of
finite locally free objects.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-fully-faithful}
it suffices to show that
$$
\Gamma(U, \mathcal{O}_U) =
\lim \Gamma(U, \mathcal{O}_U/I^n\mathcal{O}_U)
$$
This follows immediately from
Lemma \ref{lemma-alternative-H0}.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-simple-two}
Let $A$ be a Noetherian ring. Let $f \in \mathfrak a$ be an element of
an ideal of $A$. Let $U = \Spec(A) \setminus V(\mathfrak a)$. Assume
\begin{enumerate}
\item $A$ has a dualizing complex and is complete with respect to $f$,
\item for every prime $\mathfrak p \subset A$, $f \not \in \mathfrak p$
and $\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$ we have
$\text{depth}(A_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q) > 2$.
\end{enumerate}
Then the completion functor
$$
\textit{Coh}(\mathcal{O}_U)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U),
\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is fully faithful on the full subcategory of finite locally free objects.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-fully-faithful-alternative} and
Local Cohomology, Proposition \ref{local-cohomology-proposition-annihilator}.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-general}
Let $I \subset \mathfrak a \subset A$ be ideals of a Noetherian ring $A$.
Let $U = \Spec(A) \setminus V(\mathfrak a)$. Let $\mathcal{V}$ be
the set of open subschemes of $U$ containing $U \cap V(I)$
ordered by reverse inclusion. Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item for any associated prime
$\mathfrak p \subset A$ with
$I \not \subset \mathfrak p$ and
$V(\mathfrak p) \cap V(I) \not \subset V(\mathfrak a)$
and $\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$ we have
$\dim((A/\mathfrak p)_\mathfrak q) > \text{cd}(A, I) + 1$.
\end{enumerate}
Then the completion functor
$$
\colim_\mathcal{V} \textit{Coh}(\mathcal{O}_V)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U),
\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is fully faithful on the full subcategory of
finite locally free objects.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-fully-faithful-general}
it suffices to show that
$$
\colim_\mathcal{V} \Gamma(V, \mathcal{O}_V) =
\lim \Gamma(U, \mathcal{O}_U/I^n\mathcal{O}_U)
$$
This follows immediately from Proposition \ref{proposition-application-H0}.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-general-alternative}
Let $A$ be a Noetherian ring. Let $f \in \mathfrak a \subset A$
be an element of an ideal of $A$. Let $U = \Spec(A) \setminus V(\mathfrak a)$.
Let $\mathcal{V}$ be the set of open subschemes of $U$ containing $U \cap V(f)$
ordered by reverse inclusion. Assume
\begin{enumerate}
\item $A$ is $f$-adically complete,
\item $f$ is a nonzerodivisor,
\item $H^1_\mathfrak a(A/fA)$ is a finite $A$-module.
\end{enumerate}
Then the completion functor
$$
\colim_\mathcal{V} \textit{Coh}(\mathcal{O}_V)
\longrightarrow
\textit{Coh}(U, f\mathcal{O}_U),
\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is fully faithful on the full subcategory of finite locally free objects.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-fully-faithful-general}
it suffices to show that
$$
\colim_\mathcal{V} \Gamma(V, \mathcal{O}_V) =
\lim \Gamma(U, \mathcal{O}_U/I^n\mathcal{O}_U)
$$
This follows immediately from Lemma \ref{lemma-alternative-colim-H0}.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-very-general}
Let $I \subset \mathfrak a \subset A$ be ideals of a Noetherian ring $A$.
Let $U = \Spec(A) \setminus V(\mathfrak a)$. Let $\mathcal{V}$ be the set
of open subschemes of $U$ containing $U \cap V(I)$ ordered by reverse
inclusion. Let $\mathcal{F}$ and
$\mathcal{G}$ be coherent $\mathcal{O}_V$-modules for some
$V \in \mathcal{V}$. The map
$$
\colim_{V' \geq V} \Hom_V(\mathcal{G}|_{V'}, \mathcal{F}|_{V'})
\longrightarrow
\Hom_{\textit{Coh}(U, I\mathcal{O}_U)}(\mathcal{G}^\wedge, \mathcal{F}^\wedge)
$$
is bijective if the following assumptions hold:
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $x \in \text{Ass}(\mathcal{F})$, $x \not \in V(I)$,
$\overline{\{x\}} \cap V(I) \not \subset V(\mathfrak a)$
and $z \in \overline{\{x\}} \cap V(\mathfrak a)$, then
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) > \text{cd}(A, I) + 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may choose coherent $\mathcal{O}_U$-modules
$\mathcal{F}'$ and $\mathcal{G}'$ whose restriction to $V$
is $\mathcal{F}$ and $\mathcal{G}$, see
Properties, Lemma \ref{properties-lemma-extend-finite-presentation}.
We may modify our choice of $\mathcal{F}'$ to ensure that
$\text{Ass}(\mathcal{F}') \subset V$, see for example
Local Cohomology, Lemma \ref{local-cohomology-lemma-get-depth-1-along-Z}.
Thus we may and do replace $V$ by $U$ and $\mathcal{F}$ and $\mathcal{G}$
by $\mathcal{F}'$ and $\mathcal{G}'$.
Set $\mathcal{H} = \SheafHom_{\mathcal{O}_U}(\mathcal{G}, \mathcal{F})$.
This is a coherent $\mathcal{O}_U$-module. We have
$$
\Hom_V(\mathcal{G}|_V, \mathcal{F}|_V) =
H^0(V, \mathcal{H})
\quad\text{and}\quad
\lim H^0(U, \mathcal{H}/\mathcal{I}^n\mathcal{H}) =
\Mor_{\textit{Coh}(U, I\mathcal{O}_U)}
(\mathcal{G}^\wedge, \mathcal{F}^\wedge)
$$
See Cohomology of Schemes, Lemma \ref{coherent-lemma-completion-internal-hom}.
Thus if we can show that the assumptions of
Proposition \ref{proposition-application-H0}
hold for $\mathcal{H}$, then the proof is complete.
This holds because
$\text{Ass}(\mathcal{H}) \subset \text{Ass}(\mathcal{F})$.
See Cohomology of Schemes, Lemma
\ref{coherent-lemma-hom-into-depth}.
\end{proof}








\section{Algebraization of coherent formal modules, I}
\label{section-algebraization-modules}

\noindent
The essential surjectivity of the completion functor (see below)
was studied systematically in
\cite{SGA2}, \cite{MRaynaud-book}, and \cite{MRaynaud-paper}.
We work in the following affine situation.

\begin{situation}
\label{situation-algebraize}
Here $A$ is a Noetherian ring and $I \subset \mathfrak a \subset A$ are ideals.
We set $X = \Spec(A)$, $Y = V(I) = \Spec(A/I)$, and
$Z = V(\mathfrak a) = \Spec(A/\mathfrak a)$. Furthermore $U = X \setminus Z$.
\end{situation}

\noindent
In this section we try to find conditions that guarantee an object
of $\textit{Coh}(U, I\mathcal{O}_U)$ is in the image of the completion functor
$\textit{Coh}(\mathcal{O}_U) \to \textit{Coh}(U, I\mathcal{O}_U)$.
See Cohomology of Schemes, Section \ref{coherent-section-coherent-formal} and
Section \ref{section-completion}.

\begin{lemma}
\label{lemma-system-of-modules}
In Situation \ref{situation-algebraize}.
Consider an inverse system $(M_n)$ of $A$-modules such
that
\begin{enumerate}
\item $M_n$ is a finite $A$-module,
\item $M_n$ is annihilated by $I^n$,
\item the kernel and cokernel of $M_{n + 1}/I^nM_{n + 1} \to M_n$
are $\mathfrak a$-power torsion.
\end{enumerate}
Then $(\widetilde{M}_n|_U)$ is in $\textit{Coh}(U, I\mathcal{O}_U)$.
Conversely, every object of $\textit{Coh}(U, I\mathcal{O}_U)$
arises in this manner.
\end{lemma}

\begin{proof}
We omit the verification that $(\widetilde{M}_n|_U)$ is in
$\textit{Coh}(U, I\mathcal{O}_U)$. Let $(\mathcal{F}_n)$
be an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
By Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}
we see that $\mathcal{F}_n = \widetilde{M_n}$ for some finite
$A/I^n$-module $M_n$. After dividing $M_n$ by $H^0_\mathfrak a(M_n)$
we may assume $M_n \subset H^0(U, \mathcal{F}_n)$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-divide-by-torsion}
and the already referenced lemma.
After replacing inductively $M_{n + 1}$ by the inverse image
of $M_n$ under the map $M_{n + 1} \to H^0(U, \mathcal{F}_{n + 1})
\to H^0(U, \mathcal{F}_n)$, we may assume $M_{n + 1}$ maps into
$M_n$. This gives a inverse system $(M_n)$ satisfying (1) and (2)
such that $\mathcal{F}_n = \widetilde{M_n}$. To see that (3)
holds, use that $M_{n + 1}/I^nM_{n + 1} \to M_n$ is a map
of finite $A$-modules which induces an isomorphism after
applying $\widetilde{\ }$ and restriction to $U$
(here we use the first referenced lemma one more time).
\end{proof}

\noindent
In Situation \ref{situation-algebraize} we can study the completion functor
Cohomology of Schemes, Equation (\ref{coherent-equation-completion-functor})
\begin{equation}
\label{equation-completion}
\textit{Coh}(\mathcal{O}_U)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U),\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
\end{equation}
If $A$ is $I$-adically complete, then this functor is fully faithful
on suitable subcategories by our earlier work on algebraization of
formal sections, see Section \ref{section-completion} and
Lemma \ref{lemma-fully-faithful-inequalities} for some sample results.
Next, let $(\mathcal{F}_n)$ be an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
Still assuming $A$ is $I$-adically complete, we can ask:
When is $(\mathcal{F}_n)$ in the essential image of the completion
functor displayed above?

\begin{lemma}
\label{lemma-essential-image-completion}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$
be an object of $\textit{Coh}(U, I\mathcal{O}_U)$. Consider the
following conditions:
\begin{enumerate}
\item $(\mathcal{F}_n)$ is in the essential image
of the functor (\ref{equation-completion}),
\item $(\mathcal{F}_n)$ is the completion of a
coherent $\mathcal{O}_U$-module,
\item $(\mathcal{F}_n)$ is the completion of a coherent
$\mathcal{O}_V$-module for $U \cap Y \subset V \subset U$ open,
\item $(\mathcal{F}_n)$ is the completion of
the restriction to $U$ of a coherent $\mathcal{O}_X$-module,
\item $(\mathcal{F}_n)$ is the restriction to $U$ of
the completion of a coherent $\mathcal{O}_X$-module,
\item there exists an object $(\mathcal{G}_n)$ of
$\textit{Coh}(X, I\mathcal{O}_X)$ whose restriction
to $U$ is $(\mathcal{F}_n)$.
\end{enumerate}
Then conditions (1), (2), (3), (4), and (5) are equivalent and imply (6).
If $A$ is $I$-adically complete then condition (6) implies the others.
\end{lemma}

\begin{proof}
Parts (1) and (2) are equivalent, because the completion of a coherent
$\mathcal{O}_U$-module $\mathcal{F}$ is by definition the image of
$\mathcal{F}$ under the functor (\ref{equation-completion}).
If $V \subset U$ is an open subscheme containing $U \cap Y$, then we have
$$
\textit{Coh}(V, I\mathcal{O}_V) =
\textit{Coh}(U, I\mathcal{O}_U)
$$
since the category of coherent $\mathcal{O}_V$-modules supported on
$V \cap Y$ is the same as the category of coherent $\mathcal{O}_U$-modules
supported on $U \cap Y$. Thus the completion of a coherent
$\mathcal{O}_V$-module is an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
Having said this the equivalence of (2), (3), (4), and (5)
holds because the functors
$\textit{Coh}(\mathcal{O}_X) \to \textit{Coh}(\mathcal{O}_U) \to
\textit{Coh}(\mathcal{O}_V)$ are essentially surjective.
See Properties, Lemma \ref{properties-lemma-extend-finite-presentation}.

\medskip\noindent
It is always the case that (5) implies (6). Assume $A$ is $I$-adically complete.
Then any object of $\textit{Coh}(X, I\mathcal{O}_X)$ corresponds to a finite
$A$-module by Cohomology of Schemes, Lemma
\ref{coherent-lemma-inverse-systems-affine}.
Thus we see that (6) implies (5) in this case.
\end{proof}

\begin{example}
\label{example-not-algebraizable}
Let $k$ be a field. Let $A = k[x, y][[t]]$ with $I = (t)$ and
$\mathfrak a = (x, y, t)$. Let us use notation as in
Situation \ref{situation-algebraize}. Observe that
$U \cap Y = (D(x) \cap Y) \cup (D(y) \cap Y)$ is an affine
open covering. For $n \geq 1$ consider the invertible
module $\mathcal{L}_n$ of $\mathcal{O}_U/t^n\mathcal{O}_U$
given by glueing $A_x/t^nA_x$ and $A_y/t^nA_y$ via the invertible
element of $A_{xy}/t^nA_{xy}$ which is the image of any power series
of the form
$$
u = 1 + \frac{t}{xy} + \sum_{n \geq 2} a_n \frac{t^n}{(xy)^{\varphi(n)}}
$$
with $a_n \in k[x, y]$ and $\varphi(n) \in \mathbf{N}$.
Then $(\mathcal{L}_n)$ is an invertible object of
$\textit{Coh}(U, I\mathcal{O}_U)$ which is not the
completion of a coherent $\mathcal{O}_U$-module $\mathcal{L}$.
We only sketch the argument and we omit most of the details.
Let $y \in U \cap Y$. Then the completion of the stalk
$\mathcal{L}_y$ would be an invertible module hence $\mathcal{L}_y$
is invertible. Thus there would exist an open $V \subset U$
containing $U \cap Y$ such that $\mathcal{L}|_V$ is invertible.
By Divisors, Lemma \ref{divisors-lemma-extend-invertible-module}
we find an invertible $A$-module $M$ with
$\widetilde{M}|_V \cong \mathcal{L}|_V$. However the ring $A$
is a UFD hence we see $M \cong A$ which would imply
$\mathcal{L}_n \cong \mathcal{O}_U/I^n\mathcal{O}_U$.
Since $\mathcal{L}_2 \not \cong \mathcal{O}_U/I^2\mathcal{O}_U$
by construction we get a contradiction as desired.

\medskip\noindent
Note that if we take $a_n = 0$ for $n \geq 2$, then we see
that $\lim H^0(U, \mathcal{L}_n)$ is nonzero: in this case
we the function $x$ on $D(x)$ and the function $x + t/y$ on $D(y)$
glue. On the other hand, if we take $a_n = 1$ and $\varphi(n) = 2^n$
or even $\varphi(n) = n^2$ then the reader can show that
$\lim H^0(U, \mathcal{L}_n)$ is zero; this gives another proof
that $(\mathcal{L}_n)$ is not algebraizable in this case.
\end{example}

\noindent
If in Situation \ref{situation-algebraize} the ring $A$ is not
$I$-adically complete, then Lemma \ref{lemma-essential-image-completion}
suggests the correct thing is to ask whether $(\mathcal{F}_n)$
is in the essential image of the restriction functor
$$
\textit{Coh}(X, I\mathcal{O}_X)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U)
$$
However, we can no longer say that this means $(\mathcal{F}_n)$
is algebraizable. Thus we introduce the following terminology.

\begin{definition}
\label{definition-algebraizable}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(U, I\mathcal{O}_U)$. We say
{\it $(\mathcal{F}_n)$ extends to $X$} if there exists an object
$(\mathcal{G}_n)$ of $\textit{Coh}(X, I\mathcal{O}_X)$ whose restriction
to $U$ is isomorphic to $(\mathcal{F}_n)$.
\end{definition}

\noindent
This notion is equivalent to being algebraizable over the completion.

\begin{lemma}
\label{lemma-algebraizable}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(U, I\mathcal{O}_U)$. Let $A', I', \mathfrak a'$
be the $I$-adic completions of $A, I, \mathfrak a$. Set $X' = \Spec(A')$
and $U' = X' \setminus V(\mathfrak a')$. The following are equivalent
\begin{enumerate}
\item $(\mathcal{F}_n)$ extends to $X$, and
\item the pullback of $(\mathcal{F}_n)$ to $U'$ is the completion
of a coherent $\mathcal{O}_{U'}$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Recall that $A \to A'$ is a flat ring map which induces an isomorphism
$A/I \to A'/I'$. See
Algebra, Lemmas \ref{algebra-lemma-completion-flat} and
\ref{algebra-lemma-completion-complete}.
Thus $X' \to X$ is a
flat morphism inducing an isomorphism $Y' \to Y$. Thus $U' \to U$
is a flat morphism which induces an isomorphism $U' \cap Y' \to U \cap Y$.
This implies that in the commutative diagram
$$
\xymatrix{
\textit{Coh}(X', I\mathcal{O}_{X'}) \ar[r] &
\textit{Coh}(U', I\mathcal{O}_{U'}) \\
\textit{Coh}(X, I\mathcal{O}_X) \ar[u] \ar[r] &
\textit{Coh}(U, I\mathcal{O}_U) \ar[u]
}
$$
the vertical functors are equivalences. See
Cohomology of Schemes, Lemma
\ref{coherent-lemma-inverse-systems-pullback-equivalence}.
The lemma follows formally from this and the results of
Lemma \ref{lemma-essential-image-completion}.
\end{proof}

\noindent
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(U, I\mathcal{O}_U)$. To figure out if
$(\mathcal{F}_n)$ extends to $X$ it makes sense to look at the $A$-module
\begin{equation}
\label{equation-guess}
M = \lim H^0(U, \mathcal{F}_n)
\end{equation}
Observe that $M$ has a limit topology which is (a priori) coarser than
the $I$-adic topology since $M \to H^0(U, \mathcal{F}_n)$ annihilates $I^nM$.
There are canonical maps
$$
\widetilde{M}|_U \to \widetilde{M/I^nM}|_U \to
\widetilde{H^0(U, \mathcal{F}_n)}|_U \to
\mathcal{F}_n
$$
One could hope that $\widetilde{M}$ restricts to a coherent module
on $U$ and that $(\mathcal{F}_n)$ is the completion of this module.
This is naive because this has almost no chance of being true
if $A$ is not complete. But even if $A$ is $I$-adically complete
this notion is very difficult to work with.
A less naive approach is to consider the following requirement.

\begin{definition}
\label{definition-canonically-algebraizable}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(U, I\mathcal{O}_U)$. We say
{\it $(\mathcal{F}_n)$ canonically extends to $X$} if the the
inverse system
$$
\{\widetilde{H^0(U, \mathcal{F}_n)}\}_{n \geq 1}
$$
in $\QCoh(\mathcal{O}_X)$ is pro-isomorphic to an object
$(\mathcal{G}_n)$ of $\textit{Coh}(X, I\mathcal{O}_X)$.
\end{definition}

\noindent
We will see in Lemma \ref{lemma-canonically-algebraizable}
that the condition in Definition \ref{definition-canonically-algebraizable}
is stronger than the condition of Definition \ref{definition-algebraizable}.

\begin{lemma}
\label{lemma-canonically-algebraizable}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(U, I\mathcal{O}_U)$. If $(\mathcal{F}_n)$
canonically extends to $X$, then
\begin{enumerate}
\item $(\widetilde{H^0(U, \mathcal{F}_n)})$ is pro-isomorphic to an
object $(\mathcal{G}_n)$ of $\textit{Coh}(X, I \mathcal{O}_X)$
unique up to unique isomorphism,
\item the restriction of $(\mathcal{G}_n)$ to $U$ is isomorphic
to $(\mathcal{F}_n)$, i.e., $(\mathcal{F}_n)$ extends to $X$,
\item the inverse system $\{H^0(U, \mathcal{F}_n)\}$
satisfies the Mittag-Leffler condition, and
\item the module $M$ in (\ref{equation-guess}) is finite over the
$I$-adic completion of $A$ and the limit topology on
$M$ is the $I$-adic topology.
\end{enumerate}
\end{lemma}

\begin{proof}
The existence of $(\mathcal{G}_n)$ in (1) follows from
Definition \ref{definition-canonically-algebraizable}.
The uniqueness of $(\mathcal{G}_n)$ in (1) follows from
Lemma \ref{lemma-recognize-formal-coherent-modules}.
Write $\mathcal{G}_n = \widetilde{M_n}$.
Then $\{M_n\}$ is an inverse system of finite $A$-modules
with $M_n = M_{n + 1}/I^n M_{n + 1}$.
By Definition \ref{definition-canonically-algebraizable}
the inverse system $\{H^0(U, \mathcal{F}_n)\}$
is pro-isomorphic to $\{M_n\}$.
Hence we see that the inverse system $\{H^0(U, \mathcal{F}_n)\}$
satisfies the Mittag-Leffler condition and that
$M = \lim M_n$ (as topological modules).
Thus the properties of $M$ in (4) follow from
Algebra, Lemmas \ref{algebra-lemma-limit-complete},
\ref{algebra-lemma-finite-over-complete-ring}, and
\ref{algebra-lemma-hathat-finitely-generated}.
Since $U$ is quasi-affine the canonical maps
$$
\widetilde{H^0(U, \mathcal{F}_n)}|_U \to \mathcal{F}_n
$$
are isomorphisms (Properties, Lemma
\ref{properties-lemma-quasi-coherent-quasi-affine}).
We conclude that $(\mathcal{G}_n|_U)$ and $(\mathcal{F}_n)$ are
pro-isomorphic and hence isomorphic by
Lemma \ref{lemma-recognize-formal-coherent-modules}.
\end{proof}

\begin{lemma}
\label{lemma-canonically-extend-base-change}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(U, I\mathcal{O}_U)$. Let $A \to A'$ be a flat ring
map. Set $X' = \Spec(A')$, let $U' \subset X'$ be the inverse image of $U$,
and denote $g : U' \to U$ the induced morphism. Set
$(\mathcal{F}'_n) = (g^*\mathcal{F}_n)$, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-pullback}.
If $(\mathcal{F}_n)$ canonically extends to $X$, then
$(\mathcal{F}'_n)$ canonically extends to $X'$.
Moreover, the extension found in Lemma \ref{lemma-canonically-algebraizable}
for $(\mathcal{F}_n)$ pulls back to the extension for
$(\mathcal{F}'_n)$.
\end{lemma}

\begin{proof}
Let $f : X' \to X$ be the induced morphism.
We have $H^0(U', \mathcal{F}'_n) = H^0(U, \mathcal{F}_n) \otimes_A A'$ by
flat base change, see Cohomology of Schemes, Lemma
\ref{coherent-lemma-flat-base-change-cohomology}.
Thus if $(\mathcal{G}_n)$ in $\textit{Coh}(X, I\mathcal{O}_X)$
is pro-isomorphic to $(\widetilde{H^0(U, \mathcal{F}_n)})$, then
$(f^*\mathcal{G}_n)$ is pro-isomorphic to
$$
(f^*\widetilde{H^0(U, \mathcal{F}_n)}) =
(\widetilde{H^0(U, \mathcal{F}_n) \otimes_A A'}) =
(\widetilde{H^0(U', \mathcal{F}'_n)})
$$
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-when-done}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. Let $M$ be as in (\ref{equation-guess}).
Assume
\begin{enumerate}
\item[(a)] the inverse system $H^0(U, \mathcal{F}_n)$ has Mittag-Leffler,
\item[(b)] the limit topology on $M$ agrees with the $I$-adic topology, and
\item[(c)] the image of $M \to H^0(U, \mathcal{F}_n)$ is a finite $A$-module
for all $n$.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends canonically to $X$.
In particular, if $A$ is $I$-adically complete, then
$(\mathcal{F}_n)$ is the completion of a coherent $\mathcal{O}_U$-module.
\end{lemma}

\begin{proof}
Since $H^0(U, \mathcal{F}_n)$ has the Mittag-Leffler condition
and since the limit topology on $M$ is the $I$-adic topology
we see that $\{M/I^nM\}$ and $\{H^0(U, \mathcal{F}_n)\}$
are pro-isomorphic inverse systems of $A$-modules.
Thus if we set
$$
\mathcal{G}_n = \widetilde{M/I^n M}
$$
then we see that to verify the condition in
Definition \ref{definition-canonically-algebraizable}
it suffices to show that $M$ is a finite module over the
$I$-adic completion of $A$. This follows from
the fact that $M/I^n M$ is finite by condition (c)
and the above and
Algebra, Lemma \ref{algebra-lemma-finite-over-complete-ring}.
\end{proof}

\noindent
The following is in some sense the most straightforward possible application
Lemma \ref{lemma-when-done} above.

\begin{lemma}
\label{lemma-algebraization-principal-variant}
In Situation \ref{situation-algebraize} let
$(\mathcal{F}_n)$ be an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
Assume
\begin{enumerate}
\item $I = (f)$ is a principal ideal for a nonzerodivisor $f \in \mathfrak a$,
\item $\mathcal{F}_n$ is a finite locally free
$\mathcal{O}_U/f^n\mathcal{O}_U$-module,
\item $H^1_\mathfrak a(A/fA)$ and $H^2_\mathfrak a(A/fA)$
are finite $A$-modules.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends canonically to $X$. In particular, if $A$
is complete, then $(\mathcal{F}_n)$ is the completion of a coherent
$\mathcal{O}_U$-module.
\end{lemma}

\begin{proof}
We will prove this by verifying hypotheses (a), (b), and (c) of
Lemma \ref{lemma-when-done}.

\medskip\noindent
Since $\mathcal{F}_n$ is locally free over $\mathcal{O}_U/f^n\mathcal{O}_U$
we see that we have short exact sequences
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_1 \to 0$
for all $n$. Thus condition (b) holds by Lemma \ref{lemma-topology-I-adic-f}.

\medskip\noindent
As $f$ is a nonzerodivisor we obtain short exact sequences
$$
0 \to A/f^nA \xrightarrow{f} A/f^{n + 1}A \to A/fA \to 0
$$
and we have corresponding short exact sequences
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_1 \to 0$.
We will use
Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}
without further mention. Our assumptions imply that
$H^0(U, \mathcal{O}_U/f\mathcal{O}_U)$ and
$H^1(U, \mathcal{O}_U/f\mathcal{O}_U)$
are finite $A$-modules. Hence the same thing is true for $\mathcal{F}_1$, see
Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-for-finite-locally-free}.
Using induction and the short exact sequences we find that
$H^0(U, \mathcal{F}_n)$ are finite $A$-modules for all $n$.
In this way we see hypothesis (c) is satisfied.

\medskip\noindent
Finally, as $H^1(U, \mathcal{F}_1)$ is a finite $A$-module
we can apply Lemma \ref{lemma-ML} to see hypothesis (a) holds.
\end{proof}

\begin{remark}
\label{remark-interesting-case-variant}
In Lemma \ref{lemma-algebraization-principal-variant}
if $A$ is universally catenary with Cohen-Macaulay
formal fibres (for example if $A$ has a dualizing complex), then
the condition that
$H^1_\mathfrak a(A/fA)$ and $H^2_\mathfrak a(A/fA)$
are finite $A$-modules, is equivalent with
$$
\text{depth}((A/f)_\mathfrak q) + \dim((A/\mathfrak q)_\mathfrak p) > 2
$$
for all $\mathfrak q \in V(f) \setminus V(\mathfrak a)$
and $\mathfrak p \in V(\mathfrak q) \cap V(\mathfrak a)$
by Local Cohomology, Theorem \ref{local-cohomology-theorem-finiteness}.

\medskip\noindent
For example, if $A/fA$ is $(S_2)$ and if every irreducible
component of $Z = V(\mathfrak a)$ has codimension $\geq 3$
in $Y = \Spec(A/fA)$, then we get the finiteness of
$H^1_\mathfrak a(A/fA)$ and $H^2_\mathfrak a(A/fA)$.
This should be contrasted with the slightly weaker conditions
found in Lemma \ref{lemma-algebraization-principal}
(see also Remark \ref{remark-interesting-case}).
\end{remark}






\section{Algebraization of coherent formal modules, II}
\label{section-algebraization-modules-general}

\noindent
We continue the discussion started in
Section \ref{section-algebraization-modules}.
This section can be skipped on a first reading.

\begin{lemma}
\label{lemma-map-kernel-cokernel-on-closed}
In Situation \ref{situation-algebraize}. Let
$(\mathcal{F}_n) \to (\mathcal{F}'_n)$ be a morphism of
$\textit{Coh}(U, I\mathcal{O}_U)$
whose kernel and cokernel are annihilated by a power of $I$. Then
\begin{enumerate}
\item $(\mathcal{F}_n)$ extends to $X$ if and only if
$(\mathcal{F}'_n)$ extends to $X$, and
\item $(\mathcal{F}_n)$ is the completion of a coherent $\mathcal{O}_U$-module
if and only if $(\mathcal{F}'_n)$ is.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) follows immediately from
Cohomology of Schemes, Lemma \ref{coherent-lemma-existence-easy}.
To see part (1), we first use Lemma \ref{lemma-algebraizable}
to reduce to the case where $A$ is $I$-adically complete.
However, in that case (1) reduces to (2) by
Lemma \ref{lemma-essential-image-completion}.
\end{proof}

\noindent
The following two lemmas where originally used in the proof
of Lemma \ref{lemma-when-done}. We keep them here for the reader who is
interested to know what intermediate results one can obtain.

\begin{lemma}
\label{lemma-when-ML}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. If the inverse system
$H^0(U, \mathcal{F}_n)$ has Mittag-Leffler, then the canonical maps
$$
\widetilde{M/I^nM}|_U \to \mathcal{F}_n
$$
are surjective for all $n$ where $M$ is as in (\ref{equation-guess}).
\end{lemma}

\begin{proof}
Surjectivity may be checked on the stalk at some point $y \in Y \setminus Z$.
If $y$ corresponds to the prime $\mathfrak q \subset A$, then we can
choose $f \in \mathfrak a$, $f \not \in \mathfrak q$. Then it suffices
to show
$$
M_f \longrightarrow H^0(U, \mathcal{F}_n)_f = H^0(D(f), \mathcal{F}_n)
$$
is surjective as $D(f)$ is affine (equality holds by Properties,
Lemma \ref{properties-lemma-invert-f-sections}). Since we have the
Mittag-Leffler property, we find that
$$
\Im(M \to H^0(U, \mathcal{F}_n)) =
\Im(H^0(U, \mathcal{F}_m) \to H^0(U, \mathcal{F}_n))
$$
for some $m \geq n$. Using the long exact sequence of cohomology we see
that
$$
\Coker(H^0(U, \mathcal{F}_m) \to H^0(U, \mathcal{F}_n))
\subset
H^1(U, \Ker(\mathcal{F}_m \to \mathcal{F}_n))
$$
Since $U = X \setminus V(\mathfrak a)$ this $H^1$ is $\mathfrak a$-power
torsion. Hence after inverting $f$ the cokernel becomes zero.
\end{proof}

\begin{lemma}
\label{lemma-when-topology}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. Let $M$ be as in (\ref{equation-guess}).
Set
$$
\mathcal{G}_n = \widetilde{M/I^nM}.
$$
If the limit topology on $M$ agrees with the $I$-adic topology, then
$\mathcal{G}_n|_U$ is a coherent
$\mathcal{O}_U$-module and the map of inverse systems
$$
(\mathcal{G}_n|_U) \longrightarrow (\mathcal{F}_n)
$$
is injective in the abelian category $\textit{Coh}(U, I\mathcal{O}_U)$.
\end{lemma}

\begin{proof}
Observe that $\mathcal{G}_n$ is a quasi-coherent $\mathcal{O}_X$-module
annihilated by $I^n$ and that
$\mathcal{G}_{n + 1}/I^n\mathcal{G}_{n + 1} = \mathcal{G}_n$.
Consider
$$
M_n = \Im(M \longrightarrow H^0(U, \mathcal{F}_n))
$$
The assumption says that the inverse systems $(M_n)$ and
$(M/I^nM)$ are isomorphic as pro-objects of $\text{Mod}_A$.
Pick $f \in \mathfrak a$ so $D(f) \subset U$ is an affine open. Then we have
$$
(M_n)_f \subset H^0(U, \mathcal{F}_n)_f = H^0(D(f), \mathcal{F}_n)
$$
Equality holds by Properties, Lemma \ref{properties-lemma-invert-f-sections}.
Thus $\widetilde{M_n}|_U \to \mathcal{F}_n$ is injective.
It follows that $\widetilde{M_n}|_U$ is a coherent module
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-coherent-Noetherian-quasi-coherent-sub-quotient}).
Since $M \to M/I^nM$ is surjective and factors as
$M_{n'} \to M/I^nM$ for some $n' \geq n$ we find that $\mathcal{G}_n|_U$
is coherent as the quotient of a coherent module.
Combined with the initical remarks of the proof we conclude
that $(\mathcal{G}_n|_U)$ indeed forms an object
of $\textit{Coh}(U, I\mathcal{O}_U)$.
Finally, to show the injectivity of the map
it suffices to show that
$$
\lim (M/I^nM)_f = \lim H^0(D(f), \mathcal{G}_n) \to
\lim H^0(D(f), \mathcal{F}_n)
$$
is injective, see Cohomology of Schemes, Lemmas
\ref{coherent-lemma-inverse-systems-abelian} and
\ref{coherent-lemma-inverse-systems-affine}.
The injectivity of $\lim (M_n)_f \to \lim H^0(D(f), \mathcal{F}_n)$
is clear (see above) and by our remark on pro-systems we have
$\lim (M_n)_f = \lim (M/I^nM)_f$. This finishes the proof.
\end{proof}





\section{A distance function}
\label{section-distance}

\noindent
Let $Y$ be a Noetherian scheme and let $Z \subset Y$ be a closed subset.
We define a function
\begin{equation}
\label{equation-delta-Z}
\delta^Y_Z = \delta_Z : Y \longrightarrow \mathbf{Z}_{\geq 0} \cup \{\infty\}
\end{equation}
which measures the ``distance'' of a point of $Y$ from $Z$.
For an informal discussion, please see Remark \ref{remark-discussion}.
Let $y \in Y$. We set $\delta_Z(y) = \infty$ if $y$ is contained
in a connected component of $Y$ which does not meet $Z$.
If $y$ is contained in a connected component of $Y$ which meets $Z$,
then we can find $k \geq 0$ and a system
$$
V_0 \subset W_0 \supset V_1 \subset W_1 \supset \ldots \supset
V_k \subset W_k
$$
of integral closed subschemes of $Y$ such that $V_0 \subset Z$
and $y \in V_k$ is the generic point. Set
$c_i = \text{codim}(V_i, W_i)$ for $i = 0, \ldots, k$
and $b_i = \text{codim}(V_{i + 1}, W_i)$ for $i = 0, \ldots, k - 1$.
For such a system we set
$$
\delta(V_0, W_0, V_1, \ldots, W_k) =
k +
\max_{i = 0, 1, \ldots, k}
(c_i + c_{i + 1} + \ldots + c_k - b_i - b_{i + 1} - \ldots - b_{k - 1})
$$
This is $\geq k$ as we can take $i = k$ and we have $c_k \geq 0$.
Finally, we set
$$
\delta_Z(y) = \min \delta(V_0, W_0, V_1, \ldots, W_k)
$$
where the minimum is over all systems of integral closed subschemes of $Y$
as above.

\begin{lemma}
\label{lemma-discussion}
Let $Y$ be a Noetherian scheme and let $Z \subset Y$ be a closed subset.
\begin{enumerate}
\item For $y \in Y$ we have $\delta_Z(y) = 0 \Leftrightarrow y \in Z$.
\item The subsets $\{y \in Y \mid \delta_Z(y) \leq k\}$ are
stable under specialization.
\item For $y \in Y$ and $z \in \overline{\{y\}} \cap Z$ we have
$\dim(\mathcal{O}_{\overline{\{y\}}, z}) \geq \delta_Z(y)$.
\item If $\delta$ is a dimension function on $Y$, then
$\delta(y) \leq \delta_Z(y) + \delta_{max}$ where $\delta_{max}$
is the maximum value of $\delta$ on $Z$.
\item If $Y = \Spec(A)$ is the spectrum of a catenary Noetherian local ring
with maximal ideal $\mathfrak m$ and $Z = \{\mathfrak m\}$, then
$\delta_Z(y) = \dim(\overline{\{y\}})$.
\item Given a pattern of specializations
$$
\xymatrix{
& y'_0 \ar@{~>}[ld] \ar@{~>}[rd] &
& y'_1 \ar@{~>}[ld] & \ldots
& y'_{k - 1} \ar@{~>}[rd] &
\\
y_0 & &
y_1 & &
\ldots & &
y_k = y
}
$$
between points of $Y$ with $y_0 \in Z$ and $y_i' \leadsto y_i$
an immediate specialization, then $\delta_Z(y_k) \leq k$.
\item If $Y' \subset Y$ is an open subscheme, then
$\delta^{Y'}_{Y' \cap Z}(y') \geq \delta^Y_Z(y')$ for $y' \in Y'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is essentially true by definition. Namely, if $y \in Z$,
then we can take $k = 0$ and $V_0 = W_0 = \overline{\{y\}}$.

\medskip\noindent
Proof of (2). Let $y \leadsto y'$ be a nontrivial specialization and let
$V_0 \subset W_0 \supset V_1 \subset W_1 \supset \ldots \subset W_k$
is a system for $y$. Here there are two cases.
Case I: $V_k = W_k$, i.e., $c_k = 0$. In this case
we can set $V'_k = W'_k = \overline{\{y'\}}$.
An easy computation shows that
$\delta(V_0, W_0, \ldots, V'_k, W'_k) \leq
\delta(V_0, W_0, \ldots, V_k, W_k)$
because only $b_{k - 1}$ is changed into a bigger integer.
Case II: $V_k \not = W_k$, i.e., $c_k > 0$. Observe that
in this case $\max_{i = 0, 1, \ldots, k}
(c_i + c_{i + 1} + \ldots + c_k - b_i - b_{i + 1} - \ldots - b_{k - 1}) > 0$.
Hence if we set $V'_{k + 1} = W_{k + 1} = \overline{\{y'\}}$,
then although $k$ is replaced by $k + 1$, the maximum now looks like
$$
\max_{i = 0, 1, \ldots, k + 1}
(c_i + c_{i + 1} + \ldots + c_k + c_{k + 1}
- b_i - b_{i + 1} - \ldots - b_{k - 1} - b_k)
$$
with $c_{k + 1} = 0$ and $b_k = \text{codim}(V_{k + 1}, W_k) > 0$.
This is strictly smaller than
$\max_{i = 0, 1, \ldots, k}
(c_i + c_{i + 1} + \ldots + c_k - b_i - b_{i + 1} - \ldots - b_{k - 1})$
and hence
$\delta(V_0, W_0, \ldots, V'_{k + 1}, W'_{k + 1}) \leq
\delta(V_0, W_0, \ldots, V_k, W_k)$ as desired.

\medskip\noindent
Proof of (3). Given $y \in Y$ and $z \in \overline{\{y\}} \cap Z$
we get the system
$$
V_0 = \overline{\{z\}} \subset W_0 = \overline{\{y\}}
$$
and $c_0 = \text{codim}(V_0, W_0) = \dim(\mathcal{O}_{\overline{\{y\}}, z})$
by Properties, Lemma \ref{properties-lemma-codimension-local-ring}.
Thus we see that $\delta(V_0, W_0) = 0 + c_0 = c_0$ which proves
what we want.

\medskip\noindent
Proof of (4). Let $\delta$ be a dimension function on $Y$.
Let $V_0 \subset W_0 \supset V_1 \subset W_1 \supset \ldots \subset W_k$
be a system for $y$. Let $y'_i \in W_i$ and $y_i \in V_i$ be the
generic points, so $y_0 \in Z$ and $y_k = y$. Then we see that
$$
\delta(y_i) - \delta(y_{i - 1}) =
\delta(y'_{i - 1}) - \delta(y_{i - 1}) - \delta(y'_{i - 1}) + \delta(y_i) =
c_{i - 1} - b_{i - 1}
$$
Finally, we have $\delta(y'_k) - \delta(y_{k - 1}) = c_k$.
Thus we see that
$$
\delta(y) - \delta(y_0) =
c_0 + \ldots + c_k - b_0 - \ldots - b_{k - 1}
$$
We conclude
$\delta(V_0, W_0, \ldots, W_k) \geq k + \delta(y) - \delta(y_0)$
which proves what we want.

\medskip\noindent
Proof of (5). The function $\delta(y) = \dim(\overline{\{y\}})$
is a dimension function. Hence $\delta(y) \leq \delta_Z(y)$ by
part (4). By part (3) we have $\delta_Z(y) \leq \delta(y)$
and we are done.

\medskip\noindent
Proof of (6). Given such a sequence of points, we may assume
all the specializations $y'_i \leadsto y_{i + 1}$ are nontrivial
(otherwise we can shorten the chain of specializations).
Then we set $V_i = \overline{\{y_i\}}$ and $W_i = \overline{\{y'_i\}}$
and we compute $\delta(V_0, W_1, V_1, \ldots, W_{k - 1}) = k$ because all
the codimensions $c_i$ of $V_i \subset W_i$ are $1$ and all $b_i > 0$.
This implies $\delta_Z(y'_{k - 1}) \leq k$ as $y'_{k - 1}$ is the generic
point of $W_k$. Then $\delta_Z(y) \leq k$ by part (2) as $y$ is a
specialization of $y_{k - 1}$.

\medskip\noindent
Proof of (7). This is clear as their are fewer systems to consider
in the computation of $\delta^{Y'}_{Y' \cap Z}$.
\end{proof}

\begin{lemma}
\label{lemma-change-distance-function}
Let $Y$ be a universally catenary Noetherian scheme. Let $Z \subset Y$
be a closed subscheme. Let $f : Y' \to Y$ be a finite type
morphism all of whose fibres have dimension $\leq e$. Set $Z' = f^{-1}(Z)$.
Then
$$
\delta_Z(y) \leq \delta_{Z'}(y') + e - \text{trdeg}_{\kappa(y)}(\kappa(y'))
$$
for $y' \in Y'$ with image $y \in Y$.
\end{lemma}

\begin{proof}
If $\delta_{Z'}(y') = \infty$, then there is nothing to prove.
If $\delta_{Z'}(y') < \infty$, then we choose a system
of integral closed subschemes
$$
V'_0 \subset W'_0 \supset V'_1 \subset W'_1 \supset \ldots \subset W'_k
$$
of $Y'$ with $V'_0 \subset Z'$ and $y'$ the generic point of $W'_k$
such that $\delta_{Z'}(y') = \delta(V'_0, W'_0, \ldots, W'_k)$.
Denote
$$
V_0 \subset W_0 \supset V_1 \subset W_1 \supset \ldots \subset W_k
$$
the scheme theoretic images of the above schemes in $Y$. Observe
that $y$ is the generic point of $W_k$ and that $V_0 \subset Z$.
For each $i$ we look at the diagram
$$
\xymatrix{
V'_i \ar[r] \ar[d] & W'_i \ar[d] & V'_{i + 1} \ar[l] \ar[d] \\
V_i \ar[r] & W_i & V_{i + 1} \ar[l]
}
$$
Denote $n_i$ the relative dimension of $V'_i/V_i$ and
$m_i$ the relative dimension of $W'_i/W_i$; more precisely
these are the transcendence degrees of the corresponding extensions of
the function fields. Set
$c_i = \text{codim}(V_i, W_i)$,
$c'_i = \text{codim}(V'_i, W'_i)$,
$b_i = \text{codim}(V_{i + 1}, W_i)$, and
$b'_i = \text{codim}(V'_{i + 1}, W'_i)$.
By the dimension formula we have
$$
c_i = c'_i + n_i - m_i
\quad\text{and}\quad
b_i = b'_i + n_{i + 1} - m_i
$$
See Morphisms, Lemma \ref{morphisms-lemma-dimension-formula}.
Hence $c_i - b_i = c'_i - b'_i + n_i - n_{i + 1}$. Thus we see that
\begin{align*}
& c_i + c_{i + 1} + \ldots + c_k - b_i - b_{i + 1} - \ldots - b_{k - 1} \\
& =
c'_i + c'_{i + 1} + \ldots + c'_k - b'_i - b'_{i + 1} - \ldots - b'_{k - 1}
+ n_i - n_k + c_k - c'_k \\
& =
c'_i + c'_{i + 1} + \ldots + c'_k - b'_i - b'_{i + 1} - \ldots - b'_{k - 1}
+ n_i - m_k
\end{align*}
Thus we see that
\begin{align*}
\max_{i = 0, \ldots, k}
& (c_i + c_{i + 1} + \ldots + c_k - b_i - b_{i + 1} - \ldots - b_{k - 1}) \\
& =
\max_{i = 0, \ldots, k}
(c'_i + c'_{i + 1} + \ldots + c'_k - b'_i - b'_{i + 1} - \ldots - b'_{k - 1}
+ n_i - m_k) \\
& =
\max_{i = 0, \ldots, k}
(c'_i + c'_{i + 1} + \ldots + c'_k - b'_i - b'_{i + 1} - \ldots - b'_{k - 1}
+ n_i) - m_k \\
& \leq
\max_{i = 0, \ldots, k}
(c'_i + c'_{i + 1} + \ldots + c'_k - b'_i - b'_{i + 1} - \ldots - b'_{k - 1})
+ e - m_k
\end{align*}
Since $m_k = \text{trdeg}_{\kappa(y)}(\kappa(y'))$ we conclude that
$$
\delta(V_0, W_0, \ldots, W_k) \leq
\delta(V'_0, W'_0, \ldots, W'_k) + e - \text{trdeg}_{\kappa(y)}(\kappa(y'))
$$
as desired.
\end{proof}

\begin{remark}
\label{remark-discussion}
Let $Y$ be a Noetherian scheme and let $Z \subset Y$ be a closed subset.
By Lemma \ref{lemma-discussion} we have
$$
\delta_Z(y) \leq \min
\left\{ k \middle|
\begin{matrix}
\text{ there exist specializations in }Y \\
y_0 \leftarrow y'_0 \rightarrow y_1 \leftarrow y'_1 \rightarrow \ldots
\leftarrow y'_{k - 1} \rightarrow y_k = y \\
\text{ with }y_0 \in Z\text{ and }y_i' \leadsto y_i
\text{ immediate}
\end{matrix}
\right\}
$$
We claim that if $Y$ is of finite type over a field,
then equality holds. If we ever need this result we
will formulate a precise result and prove it here.
However, in general if we define $\delta_Z$
by the right hand side of this inequality, then we don't
know if Lemma \ref{lemma-change-distance-function} remains true.
\end{remark}

\begin{example}
\label{example-distance}
Let $k$ be a field and $Y = \mathbf{A}^n_k$. Denote
$\delta : Y \to \mathbf{Z}_{\geq 0}$ the usual dimension function.
\begin{enumerate}
\item If $Z = \{z\}$ for some closed point $z$, then
\begin{enumerate}
\item $\delta_Z(y) = \delta(y)$ if $y \leadsto z$ and
\item $\delta_Z(y) = \delta(y) + 1$ if $y \not \leadsto z$.
\end{enumerate}
\item If $Z$ is a closed subvariety and $W = \overline{\{y\}}$, then
\begin{enumerate}
\item $\delta_Z(y) = 0$ if $W \subset Z$,
\item $\delta_Z(y) = \dim(W) - \dim(Z)$ if $Z$ is contained in $W$,
\item $\delta_Z(y) = 1$ if $\dim(W) \leq \dim(Z)$ and $W \not \subset Z$,
\item $\delta_Z(y) = \dim(W) - \dim(Z) + 1$ if $\dim(W) > \dim(Z)$
and $Z \not \subset W$.
\end{enumerate}
\end{enumerate}
A generalization of case (1) is if $Y$ is of finite type over a field
and $Z = \{z\}$ is a closed point. Then $\delta_Z(y) = \delta(y) + t$
where $t$ is the minimum length of a chain of curves connecting
$z$ to a closed point of $\overline{\{y\}}$.
\end{example}







\section{Algebraization of coherent formal modules, III}
\label{section-uniqueness}

\noindent
We continue the discussion started in Sections
\ref{section-algebraization-modules} and
\ref{section-algebraization-modules-general}.
We will use the distance function of Section \ref{section-distance}
to formulate a some natural conditions on
coherent formal modules in Situation \ref{situation-algebraize}.

\medskip\noindent
In Situation \ref{situation-algebraize} given a point $y \in U \cap Y$
we can consider the $I$-adic completion
$$
\mathcal{O}_{X, y}^\wedge = \lim \mathcal{O}_{X, y}/I^n\mathcal{O}_{X, y}
$$
This is a Noetherian local ring complete with respect to
$I\mathcal{O}_{X, y}^\wedge$ with maximal ideal $\mathfrak m_y^\wedge$, see
Algebra, Section \ref{algebra-section-completion-noetherian}.
Let $(\mathcal{F}_n)$ be an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
Let us define the ``stalk'' of $(\mathcal{F}_n)$ at $y$ by the formula
$$
\mathcal{F}_y^\wedge = \lim \mathcal{F}_{n, y}
$$
This is a finite module over $\mathcal{O}_{X, y}^\wedge$. See
Algebra, Lemmas \ref{algebra-lemma-limit-complete} and
\ref{algebra-lemma-finite-over-complete-ring}.

\begin{definition}
\label{definition-s-d-inequalities}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. Let $a, b$ be integers.
Let $\delta^Y_Z$ be as in (\ref{equation-delta-Z}).
We say
{\it $(\mathcal{F}_n)$ satisfies the $(a, b)$-inequalities} if for
$y \in U \cap Y$ and a prime $\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$
with $\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$
\begin{enumerate}
\item if $V(\mathfrak p) \cap V(I\mathcal{O}_{X, y}^\wedge) \not =
\{\mathfrak m_y^\wedge\}$, then
$$
\text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) + \delta^Y_Z(y) \geq a
\quad\text{or}\quad
\text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) + \delta^Y_Z(y) > b
$$
\item if $V(\mathfrak p) \cap V(I\mathcal{O}_{X, y}^\wedge) =
\{\mathfrak m_y^\wedge\}$, then
$$
\text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) + \delta^Y_Z(y) > a
$$
\end{enumerate}
We say {\it $(\mathcal{F}_n)$ satisfies the strict $(a, b)$-inequalities}
if for $y \in U \cap Y$ and a prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$
we have
$$
\text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) + \delta^Y_Z(y) > a
\quad\text{or}\quad
\text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) + \delta^Y_Z(y) > b
$$
\end{definition}

\noindent
Here are some elementary observations.

\begin{lemma}
\label{lemma-elementary}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. Let $a, b$ be integers.
\begin{enumerate}
\item If $(\mathcal{F}_n)$ is annihilated by a power of $I$, then
$(\mathcal{F}_n)$ satisfies the $(a, b)$-inequalities for any $a, b$.
\item If $(\mathcal{F}_n)$ satisfies the $(a + 1, b)$-inequalities, then
$(\mathcal{F}_n)$ satisfies the strict $(a, b)$-inequalities.
\end{enumerate}
If $\text{cd}(A, I) \leq d$ and $A$ has a dualizing complex, then
\begin{enumerate}
\item[(3)] $(\mathcal{F}_n)$ satisfies the $(s, s + d)$-inequalities
if and only if for all $y \in U \cap Y$ the tuple
$\mathcal{O}_{X, y}^\wedge, I\mathcal{O}_{X, y}^\wedge,
\{\mathfrak m_y^\wedge\}, \mathcal{F}_y^\wedge, s - \delta^Y_Z(y), d$
is as in Situation \ref{situation-bootstrap}.
\item[(4)]
If $(\mathcal{F}_n)$ satisfies the strict $(s, s + d)$-inequalities, then
$(\mathcal{F}_n)$ satisfies the $(s, s + d)$-inequalities.
\end{enumerate}
\end{lemma}

\begin{proof}
Immediate except for part (4) which is a consequence of
Lemma \ref{lemma-bootstrap-bis-bis} and the translation in (3).
\end{proof}

\begin{lemma}
\label{lemma-explain-2-3-cd-1}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. If $\text{cd}(A, I) = 1$, then
$\mathcal{F}$ satisfies the $(2, 3)$-inequalities if and only if
$$
\text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) + \delta^Y_Z(y) > 3
$$
for all $y \in U \cap Y$ and $\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$
with $\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$.
\end{lemma}

\begin{proof}
Observe that for a prime $\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$,
$\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$
we have $V(\mathfrak p) \cap V(I\mathcal{O}_{X, y}^\wedge) =
\{\mathfrak m_y^\wedge\}
\Leftrightarrow \dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) = 1$
as $\text{cd}(A, I) = 1$.
See Local Cohomology, Lemmas
\ref{local-cohomology-lemma-cd-change-rings} and
\ref{local-cohomology-lemma-cd-bound-dim-local}.
OK, consider the three numbers
$\alpha = \text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) \geq 0$,
$\beta = \dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) \geq 1$, and
$\gamma = \delta^Y_Z(y) \geq 1$.
Then we see Definition \ref{definition-s-d-inequalities} requires
\begin{enumerate}
\item if $\beta > 1$, then
$\alpha + \gamma \geq 2$ or $\alpha + \beta + \gamma > 3$, and
\item if $\beta = 1$, then $\alpha + \gamma > 2$.
\end{enumerate}
It is trivial to see that this is equivalent to
$\alpha + \beta + \gamma > 3$.
\end{proof}

\noindent
In the rest of this section, which we suggest the reader skip on a first
reading, we will show that, when $A$ is $I$-adically complete,
the category of $(\mathcal{F}_n)$ of $\textit{Coh}(U, I\mathcal{O}_U)$
which extend to $X$ and satisfy the
strict $(1, 1 + \text{cd}(A, I))$-inequalities
is equivalent to a full subcategory of the category of coherent
$\mathcal{O}_U$-modules.

\begin{lemma}
\label{lemma-sanity}
In Situation \ref{situation-algebraize} let $\mathcal{F}$ be a
coherent $\mathcal{O}_U$-module and $d \geq 1$. Assume
\begin{enumerate}
\item $A$ is $I$-adically complete, has a dualizing complex, and
$\text{cd}(A, I) \leq d$,
\item the completion $\mathcal{F}^\wedge$ of $\mathcal{F}$
satisfies the strict $(1, 1 + d)$-inequalities.
\end{enumerate}
Let $x \in X$ be a point. Let $W = \overline{\{x\}}$.
If $W \cap Y$ has an irreducible component contained in $Z$
and one which is not, then $\text{depth}(\mathcal{F}_x) \geq 1$.
\end{lemma}

\begin{proof}
Let $W \cap Y = W_1 \cup \ldots \cup W_n$ be the decomposition into
irreducible components. By assumption, after renumbering, we can find
$0 < m < n$ such that $W_1, \ldots, W_m  \subset Z$ and
$W_{m + 1}, \ldots, W_n \not \subset Z$. We conclude that
$$
W \cap Y \setminus
\left((W_1 \cup \ldots \cup W_m) \cap (W_{m + 1} \cup \ldots \cup W_n)\right)
$$
is disconnected. By Lemma \ref{lemma-connected} we can find
$1 \leq i \leq m < j \leq n$ and
$z \in W_i \cap W_j$ such that $\dim(\mathcal{O}_{W, z}) \leq d + 1$.
Choose an immediate specialization $y \leadsto z$ with
$y \in W_j$, $y \not \in Z$; existence of $y$ follows from
Properties, Lemma \ref{properties-lemma-complement-closed-point-Jacobson}.
Observe that $\delta^Y_Z(y) = 1$ and $\dim(\mathcal{O}_{W, y}) \leq d$.
Let $\mathfrak p \subset \mathcal{O}_{X, y}$ be the prime corresponding to $x$.
Let $\mathfrak p' \subset \mathcal{O}_{X, y}^\wedge$ be a minimal prime
over $\mathfrak p\mathcal{O}_{X, y}^\wedge$. Then we have
$$
\text{depth}(\mathcal{F}_x) =
\text{depth}((\mathcal{F}^\wedge_y)_{\mathfrak p'})
\quad\text{and}\quad
\dim(\mathcal{O}_{W, y}) = \dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p')
$$
See Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module} and
Local Cohomology, Lemma \ref{local-cohomology-lemma-change-completion}.
Now we read off the conclusion from the inequalities given to us.
\end{proof}

\begin{lemma}
\label{lemma-recover}
In Situation \ref{situation-algebraize} let $\mathcal{F}$ be a
coherent $\mathcal{O}_U$-module and $d \geq 1$. Assume
\begin{enumerate}
\item $A$ is $I$-adically complete, has a dualizing complex, and
$\text{cd}(A, I) \leq d$,
\item the completion $\mathcal{F}^\wedge$ of $\mathcal{F}$
satisfies the strict $(1, 1+ d)$-inequalities, and
\item for $x \in U$ with $\overline{\{x\}} \cap Y \subset Z$
we have $\text{depth}(\mathcal{F}_x) \geq 2$.
\end{enumerate}
Then $H^0(U, \mathcal{F}) \to \lim H^0(U, \mathcal{F}/I^n\mathcal{F})$
is an isomorphism.
\end{lemma}

\begin{proof}
We will prove this by showing that Lemma \ref{lemma-application-H0} applies.
Thus we let $x \in \text{Ass}(\mathcal{F})$ with $x \not \in Y$.
Set $W = \overline{\{x\}}$.
By condition (3) we see that $W \cap Y \not \subset Z$.
By Lemma \ref{lemma-sanity} we see that no irreducible
component of $W \cap Y$ is contained in $Z$.
Thus if $z \in W \cap Z$, then there is an immediate
specialization $y \leadsto z$, $y \in W \cap Y$, $y \not \in Z$.
For existence of $y$ use
Properties, Lemma \ref{properties-lemma-complement-closed-point-Jacobson}.
Then $\delta^Y_Z(y) = 1$ and the assumption
implies that $\dim(\mathcal{O}_{W, y}) > d$.
Hence $\dim(\mathcal{O}_{W, z}) > 1 + d$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-inequalities}
In Situation \ref{situation-algebraize} let $\mathcal{F}$ be a
coherent $\mathcal{O}_U$-module and $d \geq 1$. Assume
\begin{enumerate}
\item $A$ is $I$-adically complete, has a dualizing complex, and
$\text{cd}(A, I) \leq d$,
\item the completion $\mathcal{F}^\wedge$ of $\mathcal{F}$
satisfies the strict $(1, 1 + d)$-inequalities, and
\item for $x \in U$ with $\overline{\{x\}} \cap Y \subset Z$
we have $\text{depth}(\mathcal{F}_x) \geq 2$.
\end{enumerate}
Then the map
$$
\Hom_U(\mathcal{G}, \mathcal{F})
\longrightarrow
\Hom_{\textit{Coh}(U, I\mathcal{O}_U)}(\mathcal{G}^\wedge, \mathcal{F}^\wedge)
$$
is bijective for every coherent $\mathcal{O}_U$-module $\mathcal{G}$. 
\end{lemma}

\begin{proof}
Set $\mathcal{H} = \SheafHom_{\mathcal{O}_U}(\mathcal{G}, \mathcal{F})$.
Using Cohomology of Schemes, Lemma
\ref{coherent-lemma-hom-into-depth} or
More on Algebra, Lemma \ref{more-algebra-lemma-hom-into-depth}
we see that the completion of $\mathcal{H}$
satisfies the strict $(1, 1 + d)$-inequalities and that for
$x \in U$ with $\overline{\{x\}} \cap Y \subset Z$
we have $\text{depth}(\mathcal{H}_x) \geq 2$. Details omitted.
Thus by Lemma \ref{lemma-recover} we have
$$
\Hom_U(\mathcal{G}, \mathcal{F}) =
H^0(U, \mathcal{H}) =
\lim H^0(U, \mathcal{H}/\mathcal{I}^n\mathcal{H}) =
\Mor_{\textit{Coh}(U, I\mathcal{O}_U)}
(\mathcal{G}^\wedge, \mathcal{F}^\wedge)
$$
See Cohomology of Schemes, Lemma \ref{coherent-lemma-completion-internal-hom}
for the final equality.
\end{proof}

\begin{lemma}
\label{lemma-construct-unique}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(U, I\mathcal{O}_U)$ and $d \geq 1$. Assume
\begin{enumerate}
\item $A$ is $I$-adically complete, has a dualizing complex, and
$\text{cd}(A, I) \leq d$,
\item $(\mathcal{F}_n)$ is the completion of a coherent $\mathcal{O}_U$-module,
\item $(\mathcal{F}_n)$ satisfies the strict $(1, 1 + d)$-inequalities.
\end{enumerate}
Then there exists a unique coherent $\mathcal{O}_U$-module $\mathcal{F}$
whose completion is $(\mathcal{F}_n)$ such that for
$x \in U$ with $\overline{\{x\}} \cap Y \subset Z$
we have $\text{depth}(\mathcal{F}_x) \geq 2$.
\end{lemma}

\begin{proof}
Choose a coherent $\mathcal{O}_U$-module $\mathcal{F}$ whose
completion is $(\mathcal{F}_n)$. Let
$T = \{x \in U \mid \overline{\{x\}} \cap Y \subset Z\}$.
We will construct $\mathcal{F}$ by applying Local Cohomology,
Lemma \ref{local-cohomology-lemma-make-S2-along-T-simple}
with $\mathcal{F}$ and $T$.
Then uniqueness will follow from the mapping property
of Lemma \ref{lemma-fully-faithful-inequalities}.

\medskip\noindent
Since $T$ is stable under specialization in $U$ the only
thing to check is the following. If $x' \leadsto x$ is an
immediate specialization of points of $U$ with $x \in T$
and $x' \not \in T$, then $\text{depth}(\mathcal{F}_{x'}) \geq 1$.
Set $W = \overline{\{x\}}$ and $W' = \overline{\{x'\}}$.
Since $x' \not \in T$ we see that $W' \cap Y$ is not contained in $Z$.
If $W' \cap Y$ contains an irreducible component contained in $Z$,
then we are done by Lemma \ref{lemma-sanity}.
If not, we choose an irreducible component $W_1$ of $W \cap Y$ and
an irreducible component $W'_1$ of $W' \cap Y$ with $W_1 \subset W'_1$.
Let $z \in W_1$ be the generic point. Let $y \leadsto z$, $y \in W'_1$
be an immediate specialization with $y \not \in Z$; existence of $y$
follows from $W'_1 \not \subset Z$ (see above) and
Properties, Lemma \ref{properties-lemma-complement-closed-point-Jacobson}.
Then we have the following $z \in Z$, $x \leadsto z$,
$x' \leadsto y \leadsto z$, $y \in Y \setminus Z$, and $\delta^Y_Z(y) = 1$.
By Local Cohomology, Lemma \ref{local-cohomology-lemma-cd-bound-dim-local}
and the fact that $z$
is a generic point of $W \cap Y$ we have
$\dim(\mathcal{O}_{W, z}) \leq d$.
Since $x' \leadsto x$ is an immediate specialization we have
$\dim(\mathcal{O}_{W', z}) \leq d + 1$.
Since $y \not = z$ we conclude
$\dim(\mathcal{O}_{W', y}) \leq d$.
If $\text{depth}(\mathcal{F}_{x'}) = 0$ then we would get
a contradiction with assumption (3); details about passage
from $\mathcal{O}_{X, y}$ to its completion omitted.
This finishes the proof.
\end{proof}








\section{Algebraization of coherent formal modules, IV}
\label{section-algebraization-modules-local}

\noindent
In this section we prove two stronger versions of
Lemma \ref{lemma-algebraization-principal-variant}
in the local case, namely, Lemmas \ref{lemma-algebraization-principal}
and \ref{lemma-algebraization-principal-bis}.
Although these lemmas will be obsoleted by the more general
Proposition \ref{proposition-cd-1}, their proofs are significantly
easier.

\begin{lemma}
\label{lemma-algebraization-principal}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ is local and $\mathfrak a = \mathfrak m$ is the maximal ideal,
\item $A$ has a dualizing complex,
\item $I = (f)$ is a principal ideal for a nonzerodivisor $f \in \mathfrak m$,
\item $\mathcal{F}_n$ is a finite locally free
$\mathcal{O}_U/f^n\mathcal{O}_U$-module,
\item if $\mathfrak p \in V(f) \setminus \{\mathfrak m\}$, then
$\text{depth}((A/f)_\mathfrak p) + \dim(A/\mathfrak p) > 1$, and
\item if $\mathfrak p \not \in V(f)$ and
$V(\mathfrak p) \cap V(f) \not = \{\mathfrak m\}$, then
$\text{depth}(A_\mathfrak p) + \dim(A/\mathfrak p) > 3$.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends canonically to $X$. In particular, if $A$
is complete, then $(\mathcal{F}_n)$ is the completion of a coherent
$\mathcal{O}_U$-module.
\end{lemma}

\begin{proof}
We will prove this by verifying hypotheses (a), (b), and (c) of
Lemma \ref{lemma-when-done}.

\medskip\noindent
Since $\mathcal{F}_n$ is locally free over $\mathcal{O}_U/f^n\mathcal{O}_U$
we see that we have short exact sequences
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_1 \to 0$
for all $n$. Thus condition (b) holds by Lemma \ref{lemma-topology-I-adic-f}.

\medskip\noindent
By induction on $n$ and the short exact sequences
$0 \to A/f^n \to A/f^{n + 1} \to A/f \to 0$ we see that
the associated primes of $A/f^nA$ agree with the associated
primes of $A/fA$. Since the associated points of $\mathcal{F}_n$
correspond to the associated primes of $A/f^nA$ not equal to $\mathfrak m$
by assumption (3), we conclude that
$M_n = H^0(U, \mathcal{F}_n)$ is a finite $A$-module by (5) and
Local Cohomology, Proposition \ref{local-cohomology-proposition-kollar}.
Thus hypothesis (c) holds.

\medskip\noindent
To finish the proof it suffices to show that there exists an $n > 1$
such that the image of
$$
H^1(U, \mathcal{F}_n) \longrightarrow H^1(U, \mathcal{F}_1)
$$
has finite length as an $A$-module. Namely, this will imply hypothesis (a)
by Lemma \ref{lemma-ML-better}. The image is independent
of $n$ for $n$ large enough by Lemma \ref{lemma-ML-local}.
Let $\omega_A^\bullet$ be a normalized dualizing complex for $A$.
By the local duality theorem and Matlis duality
(Dualizing Complexes, Lemma \ref{dualizing-lemma-special-case-local-duality}
and Proposition \ref{dualizing-proposition-matlis})
our claim is equivalent to: the image of
$$
\text{Ext}^{-2}_A(M_1, \omega_A^\bullet) \to
\text{Ext}^{-2}_A(M_n, \omega_A^\bullet)
$$
has finite length for $n \gg 1$. The modules in question are
finite $A$-modules supported at $V(f)$. Thus it suffices to show that this
map is zero after localization at a prime $\mathfrak q$
containing $f$ and different from $\mathfrak m$.
Let $\omega_{A_\mathfrak q}^\bullet$ be a normalized
dualizing complex on $A_\mathfrak q$ and recall that
$\omega_{A_\mathfrak q}^\bullet =
(\omega_A^\bullet)_\mathfrak q[\dim(A/\mathfrak q)]$ by
Dualizing Complexes, Lemma \ref{dualizing-lemma-dimension-function}.
Using the local structure of $\mathcal{F}_n$ given in (4)
we find that it suffices to show the vanishing of
$$
\text{Ext}^{-2 + \dim(A/\mathfrak q)}_{A_\mathfrak q}(
A_\mathfrak q/f, \omega_{A_\mathfrak q}^\bullet)
\to
\text{Ext}^{-2 + \dim(A/\mathfrak q)}_{A_\mathfrak q}(
A_\mathfrak q/f^n, \omega_{A_\mathfrak q}^\bullet)
$$
for $n$ large enough. If $\dim(A/\mathfrak q) > 3$, then this is immediate from
Local Cohomology, Lemma \ref{local-cohomology-lemma-sitting-in-degrees}.
For the other cases we will use the long exact sequence
$$
\ldots
\xrightarrow{f^n}
H^{-1}(\omega_{A_\mathfrak q}^\bullet)
\to
\text{Ext}^{-1}_{A_\mathfrak q}(
A_\mathfrak q/f^n, \omega_{A_\mathfrak q}^\bullet) \to
H^0(\omega_{A_\mathfrak q}^\bullet)
\xrightarrow{f^n}
H^0(\omega_{A_\mathfrak q}^\bullet)
\to
\text{Ext}^0_{A_\mathfrak q}(
A_\mathfrak q/f^n, \omega_{A_\mathfrak q}^\bullet) \to 0
$$
If $\dim(A/\mathfrak q) = 2$, then
$H^0(\omega_{A_\mathfrak q}^\bullet) = 0$
because $\text{depth}(A_\mathfrak q) \geq 1$ as
$f$ is a nonzerodivisor.
Thus the long exact sequence shows the condition is that
$$
f^{n - 1} :
H^{-1}(\omega_{A_\mathfrak q}^\bullet)/f \to
H^{-1}(\omega_{A_\mathfrak q}^\bullet)/f^n
$$
is zero. Now $H^{-1}(\omega^\bullet_\mathfrak q)$ is a finite
module supported in the primes $\mathfrak p \subset A_\mathfrak q$ such that
$\text{depth}(A_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q) \leq 1$.
Since $\dim((A/\mathfrak p)_\mathfrak q) = \dim(A/\mathfrak p) - 2$
condition (6) tells us these primes are contained in $V(f)$.
Thus the desired vanishing for $n$ large enough.
Finally, if $\dim(A/\mathfrak q) = 1$, then condition (5) combined
with the fact that $f$ is a nonzerodivisor
insures that $A_\mathfrak q$ has depth at least $2$. Hence
$H^0(\omega_{A_\mathfrak q}^\bullet) =
H^{-1}(\omega_{A_\mathfrak q}^\bullet) = 0$
and the long exact sequence shows the claim is
equivalent to the vanishing of
$$
f^{n - 1} :
H^{-2}(\omega_{A_\mathfrak q}^\bullet)/f \to
H^{-2}(\omega_{A_\mathfrak q}^\bullet)/f^n
$$
Now $H^{-2}(\omega^\bullet_\mathfrak q)$ is a finite
module supported in the primes $\mathfrak p \subset A_\mathfrak q$
such that $\text{depth}(A_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q)
\leq 2$. By condition (6) all of these primes are contained in $V(f)$.
Thus the desired vanishing for $n$ large enough.
\end{proof}

\begin{remark}
\label{remark-interesting-case}
Let $(A, \mathfrak m)$ be a complete Noetherian normal local domain
of dimension $\geq 4$ and let $f \in \mathfrak m$ be nonzero.
Then assumptions (1), (2), (3), (5), and (6) of
Lemma \ref{lemma-algebraization-principal}
are satisfied. Thus vectorbundles
on the formal completion of $U$ along $U \cap V(f)$
can be algebraized. In Lemma \ref{lemma-algebraization-principal-bis}
we will generalize this to more general coherent formal modules;
please also compare with Remark \ref{remark-interesting-case-bis}.
\end{remark}

\begin{lemma}
\label{lemma-helper-algebraize}
In Situation \ref{situation-algebraize} let $(M_n)$ be an inverse system of
$A$-modules as in Lemma \ref{lemma-system-of-modules} and let
$(\mathcal{F}_n)$ be the corresponding object of
$\textit{Coh}(U, I\mathcal{O}_U)$. Let $d \geq \text{cd}(A, I)$
and $s \geq 0$ be integers.
With notation as above assume
\begin{enumerate}
\item $A$ is local with maximal ideal $\mathfrak m = \mathfrak a$,
\item $A$ has a dualizing complex, and
\item $(\mathcal{F}_n)$ satisfies the $(s, s + d)$-inequalities
(Definition \ref{definition-s-d-inequalities}).
\end{enumerate}
Let $E$ be an injective hull of the residue field of $A$. Then for $i \leq s$
there exists a finite $A$-module $N$ annihilated by a power
of $I$ and for $n \gg 0$ compatible maps
$$
H^i_\mathfrak m(M_n) \to \Hom_A(N, E)
$$
whose cokernels are finite length $A$-modules and whose kernels $K_n$
form an inverse system such that $\Im(K_{n''} \to K_{n'})$ has finite
length for $n'' \gg n' \gg 0$.
\end{lemma}

\begin{proof}
Let $\omega_A^\bullet$ be a normalized dualizing complex. Then
$\delta^Y_Z = \delta$ is the dimension function associated with
this dualizing complex.
Observe that $\Ext^{-i}_A(M_n, \omega_A^\bullet)$ is a finite $A$-module
annihilated by $I^n$. Fix $0 \leq i \leq s$.
Below we will find $n_1 > n_0 > 0$ such that if we set
$$
N = \Im(\Ext^{-i}_A(M_{n_0}, \omega_A^\bullet) \to
\Ext^{-i}_A(M_{n_1}, \omega_A^\bullet))
$$
then the kernels of the maps
$$
N \to \Ext^{-i}_A(M_n, \omega_A^\bullet),\quad n \geq n_1
$$
are finite length $A$-modules and the cokernels $Q_n$ form a
system such that $\Im(Q_{n'} \to Q_{n''})$ has finite length
for $n'' \gg n' \gg n_1$. This is equivalent to the statement that
the system $\{\Ext^{-i}_A(M_n, \omega_A^\bullet)\}_{n \geq 1}$
is essentially constant in the quotient of the category of finite
$A$-modules modulo the Serre subcategory of finite length $A$-modules.
By the local duality theorem
(Dualizing Complexes, Lemma \ref{dualizing-lemma-special-case-local-duality})
and Matlis duality
(Dualizing Complexes, Proposition \ref{dualizing-proposition-matlis})
we conclude that there are maps
$$
H^i_\mathfrak m(M_n) \to \Hom_A(N, E),\quad n \geq n_1
$$
as in the statement of the lemma.

\medskip\noindent
Pick $f \in \mathfrak m$. Let $B = A_f^\wedge$ be the $I$-adic completion
of the localization $A_f$. Recall that
$\omega_{A_f}^\bullet = \omega_A^\bullet \otimes_A A_f$
and $\omega_B^\bullet = \omega_A^\bullet \otimes_A B$ are dualizing
complexes (Dualizing Complexes, Lemma \ref{dualizing-lemma-dualizing-localize}
and \ref{dualizing-lemma-completion-henselization-dualizing}).
Let $M$ be the finite $B$-module $\lim M_{n, f}$ (compare with
discussion in Cohomology of Schemes, Lemma
\ref{coherent-lemma-inverse-systems-affine}). Then
$$
\Ext^{-i}_A(M_n, \omega_A^\bullet)_f =
\Ext^{-i}_{A_f}(M_{n, f}, \omega_{A_f}^\bullet) =
\Ext^{-i}_B(M/I^n M, \omega_B^\bullet)
$$
Since $\mathfrak m$ can be generated by finitely many $f \in \mathfrak m$
it suffices to show that for each $f$ the system
$$
\{\Ext^{-i}_B(M/I^n M, \omega_B^\bullet)\}_{n \geq 1}
$$
is essentially constant. Some details omitted.

\medskip\noindent
Let $\mathfrak q \subset IB$ be a prime ideal. Then $\mathfrak q$ corresponds
to a point $y \in U \cap Y$. Observe that
$\delta(\mathfrak q) = \dim(\overline{\{y\}})$
is also the value of the dimension function associated to $\omega_B^\bullet$
(we omit the details; use that $\omega_B^\bullet$ is gotten from
$\omega_A^\bullet$ by tensoring up with $B$). Assumption
(3) guarantees via Lemma \ref{lemma-elementary}
that Lemma \ref{lemma-algebraize-local-cohomology-bis}
applies to
$B_\mathfrak q, IB_\mathfrak q, \mathfrak qB_\mathfrak q, M_\mathfrak q$
with $s$ replaced by $s - \delta(y)$. We obtain that
$$
H^{i - \delta(\mathfrak q)}_{\mathfrak qB_\mathfrak q}(M_\mathfrak q) =
\lim H^{i - \delta(\mathfrak q)}_{\mathfrak qB_\mathfrak q}(
(M/I^nM)_\mathfrak q)
$$
and this module is annihilated by a power of $I$.
By Lemma \ref{lemma-terrific} we find that the inverse systems
$H^{i - \delta(\mathfrak q)}_{\mathfrak qB_\mathfrak q}((M/I^nM)_\mathfrak q)$
are essentially constant with value
$H^{i - \delta(\mathfrak q)}_{\mathfrak qB_\mathfrak q}(M_\mathfrak q)$.
Since $(\omega_B^\bullet)_\mathfrak q[-\delta(\mathfrak q)]$ is a normalized
dualizing complex on $B_\mathfrak q$ the local duality theorem
shows that the system
$$
\Ext^{-i}_B(M/I^n M, \omega_B^\bullet)_\mathfrak q
$$
is essentially constant with value
$\Ext^{-i}_B(M, \omega_B^\bullet)_\mathfrak q$.

\medskip\noindent
To finish the proof we globalize as in the proof of
Lemma \ref{lemma-bootstrap}; the argument here is easier
because we know the value of our system already. Namely, consider the maps
$$
\alpha_n :
\Ext^{-i}_B(M/I^n M, \omega_B^\bullet)
\longrightarrow
\Ext^{-i}_B(M, \omega_B^\bullet)
$$
for varying $n$. By the above, for every $\mathfrak q$ we can find an
$n$ such that $\alpha_n$ is surjective after localization at $\mathfrak q$.
Since $B$ is Noetherian and $\Ext^{-i}_B(M, \omega_B^\bullet)$
a finite module, we can find an $n$ such that $\alpha_n$ is surjective.
For any $n$ such that $\alpha_n$ is surjective, given a prime
$\mathfrak q \in V(IB)$ we can find an $n' > n$ such that
$\Ker(\alpha_n)$ maps to zero in $\Ext^{-i}(M/I^{n'}M, \omega_B^\bullet)$
at least after localizing at $\mathfrak q$.
Since $\Ker(\alpha_n)$ is a finite $A$-module and since supports of
sections are quasi-compact, we can find an $n'$ such that
$\Ker(\alpha_n)$ maps to zero in $\Ext^{-i}(M/I^{n'}M, \omega_B^\bullet)$.
In this way we see that $\Ext^{-i}(M/I^n M, \omega_B^\bullet)$
is essentially constant with value $\Ext^{-i}(M, \omega_B^\bullet)$.
This finishes the proof.
\end{proof}

\noindent
Here is a more general version of Lemma \ref{lemma-algebraization-principal}.

\begin{lemma}
\label{lemma-algebraization-principal-bis}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ is local and $\mathfrak a = \mathfrak m$ is the maximal ideal,
\item $A$ has a dualizing complex,
\item $I = (f)$ is a principal ideal,
\item $(\mathcal{F}_n)$ satisfies the $(2, 3)$-inequalities.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends to $X$. In particular, if $A$ is
$I$-adically complete, then $(\mathcal{F}_n)$ is the completion
of a coherent $\mathcal{O}_U$-module. 
\end{lemma}

\begin{proof}
Recall that $\textit{Coh}(U, I\mathcal{O}_U)$ is an abelian category, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-abelian}.
Over affine opens of $U$ the object $(\mathcal{F}_n)$
corresponds to a finite module over a Noetherian ring
(Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-affine}).
Thus the kernels of the maps $f^N : (\mathcal{F}_n) \to (\mathcal{F}_n)$
stabilize for $N$ large enough. By
Lemmas \ref{lemma-map-kernel-cokernel-on-closed} and
\ref{lemma-essential-image-completion}
in order to prove the lemma
we may replace $(\mathcal{F}_n)$ by the image of such a map.
Thus we may assume $f$ is injective on $(\mathcal{F}_n)$.
After this replacement the equivalent conditions of
Lemma \ref{lemma-equivalent-f-good} hold for the inverse system
$(\mathcal{F}_n)$ on $U$. We will use this without further mention
in the rest of the proof.

\medskip\noindent
We will check hypotheses (a), (b), and (c) of
Lemma \ref{lemma-when-done}.
Hypothesis (b) holds by Lemma \ref{lemma-topology-I-adic-f}.

\medskip\noindent
Pick a inverse system of modules $\{M_n\}$ as in
Lemma \ref{lemma-system-of-modules}.
We may assume $H^0_\mathfrak m(M_n) = 0$ by replacing $M_n$ by
$M_n/H^0_\mathfrak m(M_n)$ if necessary. Then we obtain short exact
sequences
$$
0 \to M_n \to H^0(U, \mathcal{F}_n) \to H^1_\mathfrak m(M_n) \to 0
$$
for all $n$. Let $E$ be an injective hull of the residue field of $A$.
By Lemma \ref{lemma-helper-algebraize} and our current assumption (4)
we can choose, an integer $m \geq 0$, finite $A$-modules
$N_1$ and $N_2$ annihilated by $f^c$ for some $c \geq 0$ and
compatible systems of maps
$$
H^i_\mathfrak m(M_n) \to \Hom_A(N_i, E), \quad i = 1, 2
$$
for $n \geq m$
with the properties stated in the lemma.

\medskip\noindent
We know that $M = \lim H^0(U, \mathcal{F}_n)$ is an $A$-module whose
limit topology is the $f$-adic topology. Thus, given $n$, the module
$M/f^nM$ is a subquotient of $H^0(U, \mathcal{F}_N)$ for some $N \gg n$.
Looking at the information obtained above we see that
$f^cM/f^nM$ is a finite $A$-module. Since $f$ is a nonzerodivisor
on $M$ we conclude that $M/f^{n - c}M$ is a finite $A$-module.
In this way we see that hypothesis (c) of Lemma \ref{lemma-when-done} holds.

\medskip\noindent
Next, we study the module
$$
Ob = \lim H^1(U, \mathcal{F}_n) = \lim H^2_\mathfrak m(M_n)
$$
For $n \geq m$ let $K_n$ be the kernel of the map
$H^2_\mathfrak m(M_n) \to \Hom_A(N_2, E)$.
Set $K = \lim K_n$. We obtain an exact sequence
$$
0 \to K \to Ob \to \Hom_A(N_2, E)
$$
By the above the limit topology on $Ob = \lim H^2_\mathfrak m(M_n)$
is the $f$-adic topology. Since $N_2$ is annihilated by $f^c$
we conclude the same is true for the limit topology on $K = \lim K_n$.
Thus $K/fK$ is a subquotient of $K_n$ for $n \gg 1$.
However, since $\{K_n\}$ is pro-isomorphic to a inverse system of
finite length $A$-modules (by the conclusion of
Lemma \ref{lemma-helper-algebraize})
we conclude that $K/fK$ is a subquotient of a finite length
$A$-module. It follows that $K$ is a finite $A$-module, see
Algebra, Lemma \ref{algebra-lemma-finite-over-complete-ring}.
(In fact, we even see that $\dim(\text{Supp}(K)) = 1$ but
we will not need this.)

\medskip\noindent
Given $n \geq 1$ consider the boundary map
$$
\delta_n :
H^0(U, \mathcal{F}_n)
\longrightarrow
\lim_N H^1(U, f^n\mathcal{F}_N) \xrightarrow{f^{-n}} Ob
$$
(the second map is an isomorphism)
coming from the short exact sequences
$$
0 \to f^n\mathcal{F}_N \to \mathcal{F}_N \to \mathcal{F}_n \to 0
$$
For each $n$ set
$$
P_n = \Im(H^0(U, \mathcal{F}_{n + m}) \to H^0(U, \mathcal{F}_n))
$$
where $m$ is as above. Observe that $\{P_n\}$ is an inverse
system and that the map $f : \mathcal{F}_n \to \mathcal{F}_{n + 1}$
on global sections maps $P_n$ into $P_{n + 1}$.
If $p \in P_n$, then $\delta_n(p) \in K \subset Ob$
because $\delta_n(p)$ maps to zero in
$H^1(U, f^n\mathcal{F}_{n + m}) = H^2_\mathfrak m(M_m)$
and the composition of $\delta_n$ and $Ob \to \Hom_A(N_2, E)$
factors through $H^2_\mathfrak m(M_m)$ by our choice of $m$.
Hence
$$
\bigoplus\nolimits_{n \geq 0} \Im(P_n \to Ob)
$$
is a finite graded $A[T]$-module where $T$ acts via multiplication by $f$.
Namely, it is a graded submodule of $K[T]$ and $K$ is finite over $A$.
Arguing as in the proof of
Lemma \ref{lemma-ML-general}\footnote{Choose homogeneous generators
of the form $\delta_{n_j}(p_j)$ for the displayed module.
Then if $k = \max(n_j)$ we find that for $n \geq k$
and any $p \in P_n$ we can find $a_j \in A$ such that
$p - \sum a_j f^{n - n_j} p_j$ is in the kernel of $\delta_n$
and hence in the image of $P_{n'}$ for all $n' \geq n$.
Thus $\Im(P_n \to P_{n - k}) = \Im(P_{n'} \to P_{n - k})$
for all $n' \geq n$.}
we find that the inverse system $\{P_n\}$ satisfies ML.
Since $\{P_n\}$ is pro-isomorphic to $\{H^0(U, \mathcal{F}_n)\}$
we conclude that $\{H^0(U, \mathcal{F}_n)\}$ has ML.
Thus hypothesis (a) of Lemma \ref{lemma-when-done}
holds and the proof is complete.
\end{proof}

\noindent
We can unwind condition of
Lemma \ref{lemma-algebraization-principal-bis} as follows.

\begin{lemma}
\label{lemma-unwinding-conditions}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ is local with maximal ideal $\mathfrak a = \mathfrak m$,
\item $\text{cd}(A, I) = 1$.
\end{enumerate}
Then $(\mathcal{F}_n)$ satisfies the $(2, 3)$-inequalities if and only
if for all $y \in U \cap Y$ with $\dim(\{y\}) = 1$ and every prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$,
$\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$ we have
$$
\text{depth}((\mathcal{F}_y^\wedge)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) > 2
$$
\end{lemma}

\begin{proof}
We will use Lemma \ref{lemma-explain-2-3-cd-1}
without further mention. In particular, we see the condition is necessary.
Conversely, suppose the condition is true.
Note that $\delta^Y_Z(y) = \dim(\overline{\{y\}})$ by
Lemma \ref{lemma-discussion}. Let us write $\delta$ for this function.
Let $y \in U \cap Y$. If $\delta(y) > 2$, then the inequality
of Lemma \ref{lemma-explain-2-3-cd-1} holds.
Finally, suppose $\delta(y) = 2$. We have to show that
$$
\text{depth}((\mathcal{F}_y^\wedge)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) > 1
$$
Choose a specialization $y \leadsto y'$ with $\delta(y') = 1$. Then
there is a ring map $\mathcal{O}_{X, y'}^\wedge \to \mathcal{O}_{X, y}^\wedge$
which identifies the target with the completion of the localization
of $\mathcal{O}_{X, y'}^\wedge$ at a prime $\mathfrak q$
with $\dim(\mathcal{O}_{X, y'}^\wedge/\mathfrak q) = 1$.
Moreover, we then obtain
$$
\mathcal{F}_y^\wedge =
\mathcal{F}_{y'}^\wedge
\otimes_{\mathcal{O}_{X, y'}^\wedge}
\mathcal{O}_{X, y}^\wedge
$$
Let $\mathfrak p' \subset \mathcal{O}_{X, y'}^\wedge$ be the image
of $\mathfrak p$.
By Local Cohomology, Lemma \ref{local-cohomology-lemma-change-completion}
we have
\begin{align*}
\text{depth}((\mathcal{F}_y^\wedge)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p)
& =
\text{depth}((\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}) +
\dim((\mathcal{O}_{X, y}^\wedge/\mathfrak p)_{\mathfrak p'}) \\
& =
\text{depth}((\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p') - 1
\end{align*}
the last equality because the specialization is immediate.
Thus the lemma is prove by the assumed inequality for $y', \mathfrak p'$.
\end{proof}

\begin{lemma}
\label{lemma-unwinding-conditions-bis}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an object
of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ is local with maximal ideal $\mathfrak a = \mathfrak m$,
\item $A$ has a dualizing complex,
\item $\text{cd}(A, I) = 1$,
\item for $y \in U \cap Y$ the module $\mathcal{F}_y^\wedge$
is finite locally free outside $V(I\mathcal{O}_{X, y}^\wedge)$,
for example if $\mathcal{F}_n$ is a finite locally free
$\mathcal{O}_U/I^n\mathcal{O}_U$-module, and
\item one of the following is true
\begin{enumerate}
\item $A_f$ is $(S_2)$ and every irreducible component of $X$
not contained in $Y$ has dimension $\geq 4$, or
\item if $\mathfrak p \not \in V(f)$ and
$V(\mathfrak p) \cap V(f) \not = \{\mathfrak m\}$, then
$\text{depth}(A_\mathfrak p) + \dim(A/\mathfrak p) > 3$.
\end{enumerate}
\end{enumerate}
Then $(\mathcal{F}_n)$ satisfies the $(2, 3)$-inequalities.
\end{lemma}

\begin{proof}
We will use the criterion of Lemma \ref{lemma-unwinding-conditions}.
Let $y \in U \cap Y$ with $\dim(\overline{\{y\}} = 1$ and let
$\mathfrak p$ be a prime $\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$.
Condition (4) shows that
$\text{depth}((\mathcal{F}_y^\wedge)_\mathfrak p) =
\text{depth}((\mathcal{O}_{X, y}^\wedge)_\mathfrak p)$.
Thus we have to prove
$$
\text{depth}((\mathcal{O}_{X, y}^\wedge)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) > 2
$$
Let $\mathfrak p_0 \subset A$ be the image of $\mathfrak p$.
Let $\mathfrak q \subset A$ be the prime corresponding to $y$.
By Local Cohomology, Lemma
\ref{local-cohomology-lemma-change-completion}
we have
\begin{align*}
\text{depth}((\mathcal{O}_{X, y}^\wedge)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p)
& =
\text{depth}(A_{\mathfrak p_0}) + \dim((A/\mathfrak p_0)_\mathfrak q) \\
& =
\text{depth}(A_{\mathfrak p_0}) + \dim(A/\mathfrak p_0) - 1
\end{align*}
If (5)(a) holds, then we get that this is
$$
\geq \min(2, \dim(A_{\mathfrak p_0})) + \dim(A/\mathfrak p_0) - 1
$$
Note that in any case $\dim(A/\mathfrak p_0) \geq 2$. Hence if
we get $2$ for the minimum, then we are done. If not we get
$$
\dim(A_{\mathfrak p_0}) + \dim(A/\mathfrak p_0) - 1 \geq 4 - 1
$$
because every component of $\Spec(A)$ passing through $\mathfrak p_0$
has dimension $\geq 4$. If (5)(b) holds, then we win immediately.
\end{proof}

\begin{remark}
\label{remark-interesting-case-bis}
Let $(A, \mathfrak m)$ be a Noetherian local ring which has a
dualizing complex and is complete with respect to $f \in \mathfrak m$.
Let $(\mathcal{F}_n)$ be an object of $\textit{Coh}(U, f\mathcal{O}_U)$
where $U$ is the punctured spectrum of $A$.
Set $Y = V(f) \subset X = \Spec(A)$.
If for $y \in U \cap V(f)$ closed in $U$, i.e., with
$\dim(\overline{\{y\}}) = 1$, we assume the
$\mathcal{O}_{X, y}^\wedge$-module $\mathcal{F}_y^\wedge$
satisfies the following two conditions
\begin{enumerate}
\item $\mathcal{F}_y^\wedge[1/f]$ is $(S_2)$ as a
$\mathcal{O}_{X, y}^\wedge[1/f]$-module, and
\item for $\mathfrak p \in \text{Ass}(\mathcal{F}_y^\wedge[1/f])$
we have $\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) \geq 3$.
\end{enumerate}
Then $(\mathcal{F}_n)$ is the completion of a coherent module on $U$.
This follows from Lemmas \ref{lemma-algebraization-principal-bis}
and \ref{lemma-unwinding-conditions}.
\end{remark}
































\section{Improving coherent formal modules}
\label{section-improving-formal-modules}

\noindent
Let $X$ be a Noetherian scheme. Let $Y \subset X$ be a closed subscheme
with quasi-coherent sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$.
Let $(\mathcal{F}_n)$ be an object of $\textit{Coh}(X, \mathcal{I})$.
In this section we construct maps
$(\mathcal{F}_n) \to (\mathcal{F}'_n)$
similar to the maps constructed in
Local Cohomology, Section \ref{local-cohomology-section-improve}
for coherent modules. For a point $y \in Y$ we set
$$
\mathcal{O}_{X, y}^\wedge = \lim \mathcal{O}_{X, y}/\mathcal{I}^n_y, \quad
\mathcal{I}_y^\wedge = \lim \mathcal{I}_y/\mathcal{I}^n_y
\quad\text{and}\quad
\mathfrak m_y^\wedge = \lim \mathfrak m_y/\mathcal{I}_y^n
$$
Then $\mathcal{O}_{X, y}^\wedge$ is a Noetherian local ring
with maximal ideal $\mathfrak m_y^\wedge$ complete with respect to
$\mathcal{I}_y^\wedge = \mathcal{I}_y\mathcal{O}_{X, y}^\wedge$.
We also set
$$
\mathcal{F}_y^\wedge = \lim \mathcal{F}_{n, y}
$$
Then $\mathcal{F}_y^\wedge$ is a finite module over
$\mathcal{O}_{X, y}^\wedge$ with
$\mathcal{F}_y^\wedge/(\mathcal{I}_y^\wedge)^n\mathcal{F}_y^\wedge =
\mathcal{F}_{n, y}$ for all $n$, see Algebra, Lemmas
\ref{algebra-lemma-limit-complete} and
\ref{algebra-lemma-finite-over-complete-ring}.

\begin{lemma}
\label{lemma-divide-torsion-formal-coherent-module}
In the situation above assume $X$ locally has a dualizing complex.
Let $T \subset Y$ be a subset stable under specialization.
Assume for $y \in T$ and for a nonmaximal prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$V(\mathfrak p) \cap V(\mathcal{I}^\wedge_y) = \{\mathfrak m_y^\wedge\}$
we have
$$
\text{depth}_{(\mathcal{O}_{X, y})_\mathfrak p}
((\mathcal{F}^\wedge_y)_\mathfrak p) > 0
$$
Then there exists a canonical map
$(\mathcal{F}_n) \to (\mathcal{F}_n')$
of inverse systems of coherent $\mathcal{O}_X$-modules
with the following properties
\begin{enumerate}
\item for $y \in T$ we have $\text{depth}(\mathcal{F}'_{n, y}) \geq 1$,
\item $(\mathcal{F}'_n)$ is isomorphic as a pro-system to an object
$(\mathcal{G}_n)$ of $\textit{Coh}(X, \mathcal{I})$,
\item the induced morphism
$(\mathcal{F}_n) \to (\mathcal{G}_n)$ of
$\textit{Coh}(X, \mathcal{I})$ is surjective with kernel
annihilated by a power of $\mathcal{I}$.
\end{enumerate}
\end{lemma}

\begin{proof}
For every $n$ we let $\mathcal{F}_n \to \mathcal{F}'_n$ be the surjection
constructed in
Local Cohomology, Lemma \ref{local-cohomology-lemma-get-depth-1-along-Z}.
Since this is the quotient of $\mathcal{F}_n$ by the subsheaf
of sections supported on $T$ we see that we get canonical maps
$\mathcal{F}'_{n + 1} \to \mathcal{F}'_n$ such that we obtain
a map $(\mathcal{F}_n) \to (\mathcal{F}_n')$
of inverse systems of coherent $\mathcal{O}_X$-modules.
Property (1) holds by construction.

\medskip\noindent
To prove properties (2) and (3) we may assume that $X = \Spec(A_0)$ is
affine and $A_0$ has a dualizing complex. Let $I_0 \subset A_0$ be the
ideal corresponding to $Y$. Let $A, I$ be the $I$-adic completions of
$A_0, I_0$. For later use we observe that $A$ has a dualizing complex
(Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing}).
Let $M$ be the finite $A$-module corresponding to $(\mathcal{F}_n)$, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-affine}.
Then $\mathcal{F}_n$ corresponds to $M_n = M/I^nM$. Recall that
$\mathcal{F}'_n$ corresponds to the quotient $M'_n = M_n / H^0_T(M_n)$,
see Local Cohomology, Lemma \ref{local-cohomology-lemma-get-depth-1-along-Z}
and its proof.

\medskip\noindent
Set $s = 0$ and $d = \text{cd}(A, I)$.
We claim that $A, I, T, M, s, d$ satisfy assumptions (1), (3), (4), (6)
of Situation \ref{situation-bootstrap}.
Namely, (1) and (3) are immediate from the above, (4) is
the empty condition as $s = 0$, and (6) is the assumption
we made in the statement of the lemma.

\medskip\noindent
By Theorem \ref{theorem-final-bootstrap} we see that $\{H^0_T(M_n)\}$
is Mittag-Leffler, that $\lim H^0_T(M_n) = H^0_T(M)$, and that
$H^0_T(M)$ is killed by a power of $I$. Thus the
limit of the short exact sequences $0 \to H^0_T(M_n) \to M_n \to M'_n \to 0$
is the short exact sequence
$$
0 \to H^0_T(M) \to M \to \lim M'_n \to 0
$$
Setting $M' = \lim M'_n$ we find that $\mathcal{G}_n$ corresponds to
the finite $A_0$-module $M'/I^nM'$. To finish the prove we have to show
that the canonical map $\{M'/I^nM'\} \to \{M'_n\}$ is a pro-isomorphism.
This is equivalent to saying that
$\{H^0_T(M) + I^nM\} \to \{\ker(M \to M'_n)\}$ is a
pro-isomorphism. Which in turn says that
$\{H^0_T(M)/H^0_T(M) \cap I^nM\} \to \{H^0_T(M_n)\}$
is a pro-isomorphism. This is true because $\{H^0_T(M_n)\}$
is Mittag-Leffler, $\lim H^0_T(M_n) = H^0_T(M)$, and
$H^0_T(M)$ is killed by a power of $I$ (so that Artin-Rees
tells us that $H^0_T(M) \cap I^nM = 0$ for $n$ large enough).
\end{proof}

\begin{lemma}
\label{lemma-improvement-formal-coherent-module-better}
In the situation above assume $X$ locally has a dualizing complex.
Let $T' \subset T \subset Y$ be subsets stable under specialization.
Let $d \geq 0$ be an integer. Assume
\begin{enumerate}
\item[(a)] affine locally we have $X = \Spec(A_0)$ and $Y = V(I_0)$
and $\text{cd}(A_0, I_0) \leq d$,
\item[(b)] for $y \in T$ and a nonmaximal prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$V(\mathfrak p) \cap V(\mathcal{I}_y^\wedge) = \{\mathfrak m_y^\wedge\}$
we have
$$
\text{depth}_{(\mathcal{O}_{X, y})_\mathfrak p}
((\mathcal{F}^\wedge_y)_\mathfrak p) > 0
$$
\item[(c)] for $y \in T'$ and for a prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$\mathfrak p \not \in V(\mathcal{I}_y^\wedge)$
and $V(\mathfrak p) \cap V(\mathcal{I}_y^\wedge) \not =
\{\mathfrak m_y^\wedge\}$ we have
$$
\text{depth}_{(\mathcal{O}_{X, y})_\mathfrak p}
((\mathcal{F}^\wedge_y)_\mathfrak p) \geq 1
\quad\text{or}\quad
\text{depth}_{(\mathcal{O}_{X, y})_\mathfrak p}
((\mathcal{F}^\wedge_y)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) > 1 + d
$$
\item[(d)] for $y \in T'$ and a nonmaximal prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$V(\mathfrak p) \cap V(\mathcal{I}_y^\wedge) = \{\mathfrak m_y^\wedge\}$
we have
$$
\text{depth}_{(\mathcal{O}_{X, y})_\mathfrak p}
((\mathcal{F}^\wedge_y)_\mathfrak p) > 1
$$
\item[(e)] if $y \leadsto y'$ is an immediate specialization and
$y' \in T'$, then $y \in T$.
\end{enumerate}
Then there exists a canonical map $(\mathcal{F}_n) \to (\mathcal{F}_n'')$
of inverse systems of coherent $\mathcal{O}_X$-modules
with the following properties
\begin{enumerate}
\item for $y \in T$ we have $\text{depth}(\mathcal{F}''_{n, y}) \geq 1$,
\item for $y' \in T'$ we have $\text{depth}(\mathcal{F}''_{n, y'}) \geq 2$,
\item $(\mathcal{F}''_n)$ is isomorphic as a pro-system to an object
$(\mathcal{H}_n)$ of $\textit{Coh}(X, \mathcal{I})$,
\item the induced morphism $(\mathcal{F}_n) \to (\mathcal{H}_n)$ of
$\textit{Coh}(X, \mathcal{I})$ has kernel and cokernel
annihilated by a power of $\mathcal{I}$.
\end{enumerate}
\end{lemma}

\begin{proof}
As in Lemma \ref{lemma-divide-torsion-formal-coherent-module} and its proof
for every $n$ we let $\mathcal{F}_n \to \mathcal{F}'_n$ be the surjection
constructed in
Local Cohomology, Lemma \ref{local-cohomology-lemma-get-depth-1-along-Z}.
Next, we let $\mathcal{F}'_n \to \mathcal{F}''_n$ be the injection
constructed in
Local Cohomology, Lemma \ref{local-cohomology-lemma-make-S2-along-T}
and its proof. The constructions show that we get canonical maps
$\mathcal{F}''_{n + 1} \to \mathcal{F}''_n$ such that we obtain
maps
$$
(\mathcal{F}_n) \longrightarrow (\mathcal{F}_n') \longrightarrow
(\mathcal{F}''_n)
$$
of inverse systems of coherent $\mathcal{O}_X$-modules.
Properties (1) and (2) hold by construction.

\medskip\noindent
To prove properties (3) and (4) we may assume that $X = \Spec(A_0)$ is
affine and $A_0$ has a dualizing complex. Let $I_0 \subset A_0$ be the
ideal corresponding to $Y$. Let $A, I$ be the $I$-adic completions of
$A_0, I_0$. For later use we observe that $A$ has a dualizing complex
(Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing}).
Let $M$ be the finite $A$-module corresponding to $(\mathcal{F}_n)$, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-affine}.
Then $\mathcal{F}_n$ corresponds to $M_n = M/I^nM$. Recall that
$\mathcal{F}'_n$ corresponds to the quotient $M'_n = M_n / H^0_T(M_n)$.
Also, recall that $M' = \lim M'_n$ is the quotient of $M$ by
$H^0_T(M)$ and that $\{M'_n\}$ and $\{M'/I^nM'\}$ are isomorphic
as pro-systems. Finally, we see that $\mathcal{F}''_n$ corresponds
to an extension
$$
0 \to M'_n \to M''_n \to H^1_{T'}(M'_n) \to 0
$$
see proof of
Local Cohomology, Lemma \ref{local-cohomology-lemma-make-S2-along-T}.

\medskip\noindent
Set $s = 1$. We claim that $A, I, T', M', s, d$ satisfy assumptions
(1), (3), (4), (6) of Situation \ref{situation-bootstrap}. Namely, (1) and (3)
are immediate, (4) is implied by (c), and (6) follows from (d).
We omit the details of the verification (c) $\Rightarrow$ (4).

\medskip\noindent
By Theorem \ref{theorem-final-bootstrap} we see that $\{H^1_{T'}(M'/I^nM')\}$
is Mittag-Leffler, that $H^1_{T'}(M') = \lim H^1_{T'}(M'/I^nM')$, and that
$H^1_{T'}(M')$ is killed by a power of $I$. We deduce
$\{H^1_{T'}(M'_n)\}$ is Mittag-Leffler and $H^1_{T'}(M') = \lim H^1_{T'}(M'_n)$.
Thus the limit of the short exact sequences displayed above
is the short exact sequence
$$
0 \to M' \to \lim M''_n \to H^1_{T'}(M') \to 0
$$
Set $M'' = \lim M''_n$. It follows from
Local Cohomology, Proposition \ref{local-cohomology-proposition-finiteness}
that $H^1_{T'}(M')$
and hence $M''$ are finite $A$-modules.
Thus we find that $\mathcal{H}_n$ corresponds to
the finite $A_0$-module $M''/I^nM''$. To finish the prove we have to show
that the canonical map $\{M''/I^nM''\} \to \{M''_n\}$ is a pro-isomorphism.
Since we already know that $\{M'/I^nM'\}$ is pro-isomorphic to
$\{M'_n\}$ the reader verifies (omitted) this is equivalent to asking
$\{H^1_{T'}(M')/I^nH^1_{T'}(M')\} \to \{H^1_{T'}(M'_n)\}$
to be a pro-isomorphism. This is true because $\{H^1_{T'}(M'_n)\}$
is Mittag-Leffler, $H^1_{T'}(M') = \lim H^1_{T'}(M'_n)$, and
$H^1_{T'}(M')$ is killed by a power of $I$.
\end{proof}

\begin{lemma}
\label{lemma-improvement-application}
In Situation \ref{situation-algebraize} assume that $A$ has
a dualizing complex. Let $d \geq \text{cd}(A, I)$. Let $(\mathcal{F}_n)$
be an object of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
$(\mathcal{F}_n)$ satisfies the $(2, 2 + d)$-inequalities, see
Definition \ref{definition-s-d-inequalities}.
Then there exists a canonical map $(\mathcal{F}_n) \to (\mathcal{F}_n'')$
of inverse systems of coherent $\mathcal{O}_U$-modules
with the following properties
\begin{enumerate}
\item if $\text{depth}(\mathcal{F}''_{n, y}) + \delta^Y_Z(y) \geq 3$
for all $y \in U \cap Y$,
\item $(\mathcal{F}''_n)$ is isomorphic as a pro-system to an object
$(\mathcal{H}_n)$ of $\textit{Coh}(U, I\mathcal{O}_U)$,
\item the induced morphism $(\mathcal{F}_n) \to (\mathcal{H}_n)$ of
$\textit{Coh}(U, I\mathcal{O}_U)$ has kernel and cokernel
annihilated by a power of $I$,
\item the modules $H^0(U, \mathcal{F}''_n)$ and $H^1(U, \mathcal{F}''_n)$
are finite $A$-modules for all $n$.
\end{enumerate}
\end{lemma}

\begin{proof}
The existence and properties (2), (3), (4) follow immediately from
Lemma \ref{lemma-improvement-formal-coherent-module-better} applied
to $U$, $U \cap Y$, $T = \{y \in U \cap Y : \delta^Y_Z(y) \leq 2\}$,
$T' = \{y \in U \cap Y : \delta^Y_Z(y) \leq 1\}$, and $(\mathcal{F}_n)$.
The finiteness of the modules $H^0(U, \mathcal{F}''_n)$ and
$H^1(U, \mathcal{F}''_n)$ follows from
Local Cohomology, Lemma \ref{local-cohomology-lemma-finiteness-Rjstar}
and the elementary properties of the function $\delta^Y_Z(-)$
proved in Lemma \ref{lemma-discussion}.
\end{proof}











\section{Algebraization of coherent formal modules, V}
\label{section-algebraization-modules-conclusion}

\noindent
In this section we prove our most general results on algebraization
of coherent formal modules. We first prove it in case
the ideal has cohomological dimension $1$. Then we apply this
to a blowup to prove a more general result.

\begin{lemma}
\label{lemma-cd-1-canonical}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$
be an object of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ has a dualizing complex and $\text{cd}(A, I) = 1$,
\item $(\mathcal{F}_n)$ is pro-isomorphic to an inverse system
$(\mathcal{F}_n'')$ of coherent $\mathcal{O}_U$-modules such that
$\text{depth}(\mathcal{F}''_{n, y}) + \delta^Y_Z(y) \geq 3$
for all $y \in U \cap Y$.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends canonically to $X$, see
Definition \ref{definition-canonically-algebraizable}.
\end{lemma}

\begin{proof}
We will check hypotheses (a), (b), and (c) of Lemma \ref{lemma-when-done}.
Before we start, let us point out that the modules
$H^0(U, \mathcal{F}''_n)$ and $H^1(U, \mathcal{F}''_n)$
are finite $A$-modules for all $n$ by
Local Cohomology, Lemma \ref{local-cohomology-lemma-finiteness-Rjstar}.

\medskip\noindent
Observe that for each $p \geq 0$
the limit topology on $\lim H^p(U, \mathcal{F}_n)$
is the $I$-adic topology by Lemma \ref{lemma-topology-I-adic}.
In particular, hypothesis (b) holds.

\medskip\noindent
We know that $M = \lim H^0(U, \mathcal{F}_n)$ is an $A$-module whose
limit topology is the $I$-adic topology. Thus, given $n$, the module
$M/I^nM$ is a subquotient of $H^0(U, \mathcal{F}_N)$ for some $N \gg n$.
Since the inverse system $\{H^0(U, \mathcal{F}_N)\}$ is pro-isomorphic to an
inverse system of finite $A$-modules, namely $\{H^0(U, \mathcal{F}''_N)\}$,
we conclude that $M/I^nM$ is finite. It follows that $M$ is finite, see
Algebra, Lemma \ref{algebra-lemma-finite-over-complete-ring}.
In particular hypothesis (c) holds.

\medskip\noindent
For each $n \geq 0$ let us write $Ob_n = \lim_N H^1(U, I^n\mathcal{F}_N)$.
A special case is $Ob = Ob_0 = \lim_N H^1(U, \mathcal{F}_N)$.
Arguing exactly as in the previous paragraph we find that $Ob$
is a finite $A$-module. (In fact, we also know that $Ob/I Ob$ is annihilated
by a power of $\mathfrak a$, but it seems somewhat difficult to use this.)

\medskip\noindent
We set $\mathcal{F} = \lim \mathcal{F}_n$, we pick generators
$f_1, \ldots, f_r$ of $I$, we pick $c \geq 1$, and we choose
$\Phi_\mathcal{F}$ as in Lemma \ref{lemma-cd-is-one-for-system}.
We will use the results of Lemma \ref{lemma-properties-system}
without further mention. In particular, for each $n \geq 1$ there are maps
$$
\delta_n :
H^0(U, \mathcal{F}_n)
\longrightarrow
H^1(U, I^n\mathcal{F})
\longrightarrow
Ob_n
$$
The first comes from the short exact sequence
$0 \to I^n\mathcal{F} \to \mathcal{F} \to \mathcal{F}_n \to 0$
and the second from $I^n\mathcal{F} = \lim I^n\mathcal{F}_N$.
We will later use that if $\delta_n(s) = 0$ for $s \in H^0(U, \mathcal{F}_n)$
then we can for each $n' \geq n$ find $s' \in H^0(U, \mathcal{F}_{n'})$
mapping to $s$.
Observe that there are commutative diagrams
$$
\xymatrix{
H^0(U, \mathcal{F}_{nc}) \ar[r] \ar[dd] &
H^1(U, I^{nc}\mathcal{F}) \ar[dd] \ar[rd]^{\Phi_\mathcal{F}} \\
& &
\bigoplus_{e_1 + \ldots + e_r = n}
H^1(U, \mathcal{F}) \cdot T_1^{e_1} \ldots T_r^{e_r} \ar[ld] \\
H^0(U, \mathcal{F}_n) \ar[r] &
H^1(U, I^n\mathcal{F})
}
$$
We conclude that the obstruction map
$H^0(U, \mathcal{F}_n) \to Ob_n$
sends the image of
$H^0(U, \mathcal{F}_{nc}) \to H^0(U, \mathcal{F}_n)$
into the submodule
$$
Ob'_n =
\Im\left(
\bigoplus\nolimits_{e_1 + \ldots + e_r = n}
Ob \cdot T_1^{e_1} \ldots T_r^{e_r} \to Ob_n
\right)
$$
where on the summand $Ob \cdot T_1^{e_1} \ldots T_r^{e_r}$
we use the map on cohomology coming from the reductions modulo
powers of $I$ of the multiplication map
$f_1^{e_1} \ldots f_r^{e_r} : \mathcal{F} \to I^n\mathcal{F}$.
By construction
$$
\bigoplus\nolimits_{n \geq 0} Ob'_n
$$
is a finite graded module over the Rees algebra $\bigoplus_{n \geq 0} I^n$.
For each $n$ we set
$$
M_n = \{s \in H^0(U, \mathcal{F}_n) \mid \delta_n(s) \in Ob'_n\}
$$
Observe that $\{M_n\}$ is an inverse system and that
$f_j : \mathcal{F}_n \to \mathcal{F}_{n + 1}$ on global
sections maps $M_n$ into $M_{n + 1}$.
By exactly the same argument as in the proof of
Lemma \ref{lemma-ML-general}
we find that $\{M_n\}$ is ML. Namely, because the Rees algebra
is Noetherian we can choose a finite number of homogeneous generators
of the form $\delta_{n_j}(z_j)$ with $z_j \in M_{n_j}$ for the graded submodule
$\bigoplus_{n \geq 0} \Im(M_n \to Ob'_n)$.
Then if $k = \max(n_j)$ we find that for $n \geq k$
and any $z \in M_n$ we can find $a_j \in I^{n - n_j}$ such that
$z - \sum a_j z_j$ is in the kernel of $\delta_n$
and hence in the image of $M_{n'}$ for all $n' \geq n$
(because the vanishing of $\delta_n$ means that we can
lift $z - \sum a_j z_j$ to an element $z' \in H^0(U, \mathcal{F}_{n'c})$
for all $n' \ge n$ and then the image of $z'$ in $H^0(U, \mathcal{F}_{n'})$
is in $M_{n'}$ by what we proved above).
Thus $\Im(M_n \to M_{n - k}) = \Im(M_{n'} \to M_{n - k})$
for all $n' \geq n$.

\medskip\noindent
Choose $n$. By the Mittag-Leffler property of $\{M_n\}$ we just established
we can find an $n' \geq n$ such that the image of $M_{n'} \to M_n$
is the same as the image of $M' \to M_n$. By the above we see that
the image of $M' \to M_n$ contains the image of
$H^0(U, \mathcal{F}_{n'c}) \to H^0(U, \mathcal{F}_n)$.
Thus we see that $\{M_n\}$ and $\{H^0(U, \mathcal{F}_n)\}$
are pro-isomorphic. Therefore $\{H^0(U, \mathcal{F}_n)\}$
has ML and we finally conclude that hypothesis (a) holds.
This concludes the proof.
\end{proof}

\begin{proposition}[Algebraization in cohomological dimension 1]
\label{proposition-cd-1}
\begin{reference}
The local case of this result is \cite[IV Corollaire 2.9]{MRaynaud-book}.
\end{reference}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$
be an object of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ has a dualizing complex and $\text{cd}(A, I) = 1$,
\item $(\mathcal{F}_n)$ satisfies the $(2, 3)$-inequalities, see
Definition \ref{definition-s-d-inequalities}.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends to $X$. In particular, if $A$ is
$I$-adically complete, then $(\mathcal{F}_n)$ is the completion
of a coherent $\mathcal{O}_U$-module.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-map-kernel-cokernel-on-closed}
we may replace $(\mathcal{F}_n)$ by the object $(\mathcal{H}_n)$
of $\textit{Coh}(U, I\mathcal{O}_U)$ found in
Lemma \ref{lemma-improvement-application}.
Thus we may assume that $(\mathcal{F}_n)$ is pro-isomorphic
to a inverse system $(\mathcal{F}_n'')$ with the properties
mentioned in Lemma \ref{lemma-improvement-application}.
In Lemma \ref{lemma-cd-1-canonical} we proved that
$(\mathcal{F}_n)$ canonically extends to $X$.
The final statement follows from Lemma \ref{lemma-canonically-algebraizable}.
\end{proof}

\begin{lemma}
\label{lemma-blowup}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$
be an object of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item all fibres of the blowing up $b : X' \to X$ of $I$
have dimension $\leq d - 1$,
\item one of the following is true
\begin{enumerate}
\item $(\mathcal{F}_n)$ satisfies the $(d + 1, d + 2)$-inequalities
(Definition \ref{definition-s-d-inequalities}), or
\item for $y \in U \cap Y$ and a prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$
we have
$$
\text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) + \delta^Y_Z(y) > d + 2
$$
\end{enumerate}
\end{enumerate}
Then $(\mathcal{F}_n)$ extends to $X$.
\end{lemma}

\begin{proof}
Let $Y' \subset X'$ be the exceptional divisor.
Let $Z' \subset Y'$ be the inverse image of $Z \subset Y$.
Then $U' = X' \setminus Z'$ is the inverse image of $U$.
With $\delta^{Y'}_{Z'}$ as in (\ref{equation-delta-Z}) we set
$$
T' = \{y' \in Y' \mid \delta^{Y'}_{Z'}(y') = 1\text{ or }2\}
\subset
T = \{y' \in Y' \mid \delta^{Y'}_{Z'}(y') = 1\}
$$
These are specialization stable subsets of
$U' \cap Y' = Y' \setminus Z'$. Consider the
object $(b|_{U'}^*\mathcal{F}_n)$ of $\textit{Coh}(U', I\mathcal{O}_{U'})$,
see Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-pullback}.
For $y' \in U' \cap Y'$ let us denote
$$
\mathcal{F}_{y'}^\wedge = \lim (b|_{U'}^*\mathcal{F}_n)_{y'}
$$
the ``stalk'' of this pullback at $y'$. We claim that conditions
(a), (b), (c), (d), and (e) of
Lemma \ref{lemma-improvement-formal-coherent-module-better}
hold for the object $(b|_{U'}^*\mathcal{F}_n)$ on $U'$ with $d$
replaced by $1$ and the subsets $T' \subset T \subset U' \cap Y'$.
Condition (a) holds because $Y'$ is an effective Cartier divisor
and hence locally cut out by $1$ equation. Condition (e) holds
by Lemma \ref{lemma-discussion} parts (1) and (2).
To prove (b), (c), and (d) we need some preparation.

\medskip\noindent
Let $y' \in U' \cap Y'$ and let
$\mathfrak p' \subset \mathcal{O}_{X', y'}^\wedge$
be a prime ideal not contained in $V(I\mathcal{O}_{X', y'}^\wedge)$.
Denote $y = b(y') \in U \cap Y$. Choose $f \in I$ such that
$y'$ is contained in the spectrum of the affine blowup algebra
$A[\frac{I}{f}]$, see Divisors, Lemma \ref{divisors-lemma-blowing-up-affine}.
For any $A$-algebra $B$ denote $B' = B[\frac{IB}{f}]$ the corresponding affine
blowup algebra. Denote $I$-adic completion by ${\ }^\wedge$.
By our choice of $f$ we get a ring map
$(\mathcal{O}_{X, y}^\wedge)' \to \mathcal{O}_{X', y'}^\wedge$.
If we let $\mathfrak q' \subset (\mathcal{O}_{X, y}^\wedge)'$
be the inverse image of $\mathfrak m_{y'}^\wedge$, then
we see that
$((\mathcal{O}_{X, y}^\wedge)'_{\mathfrak q'})^\wedge =
\mathcal{O}_{X', y'}^\wedge$.
Let $\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ be the corresponding
prime. At this point we have a commutative diagram
$$
\xymatrix{
\mathcal{O}_{X, y}^\wedge \ar[d] \ar[r] &
(\mathcal{O}_{X, y}^\wedge)' \ar[d]_\alpha \ar[r] &
(\mathcal{O}_{X, y}^\wedge)'_{\mathfrak q'} \ar[d] \ar[r]_\beta &
\mathcal{O}_{X', y'}^\wedge \ar[d] \\
\mathcal{O}_{X, y}^\wedge/\mathfrak p \ar[r] &
(\mathcal{O}_{X, y}^\wedge/\mathfrak p)' \ar[r] &
(\mathcal{O}_{X, y}^\wedge/\mathfrak p)'_{\mathfrak q'} \ar[r]^\gamma &
((\mathcal{O}_{X, y}^\wedge/\mathfrak p)'_{\mathfrak q'})^\wedge \ar[d] \\
 & & &
\mathcal{O}_{X', y'}^\wedge/\mathfrak p'
}
$$
whose vertical arrows are surjective. By
More on Algebra, Lemma \ref{more-algebra-lemma-completion-dimension}
and the dimension formula
(Algebra, Lemma \ref{algebra-lemma-dimension-formula})
we have
$$
\dim(((\mathcal{O}_{X, y}^\wedge/\mathfrak p)'_{\mathfrak q'})^\wedge) =
\dim((\mathcal{O}_{X, y}^\wedge/\mathfrak p)'_{\mathfrak q'}) =
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p)
- \text{trdeg}(\kappa(y')/\kappa(y))
$$
Tracing through the definitions of pullbacks, stalks, localizations,
and completions we find
$$
(\mathcal{F}_y^\wedge)_{\mathfrak p}
\otimes_{(\mathcal{O}_{X, y}^\wedge)_\mathfrak p}
(\mathcal{O}_{X', y'}^\wedge)_{\mathfrak p'}
=
(\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}
$$
Details omitted. The ring maps $\beta$ and $\gamma$ in the diagram
are flat with Gorenstein (hence Cohen-Macaulay) fibres, as these are
completions of rings having a dualizing complex. See
Dualizing Complexes, Lemmas
\ref{dualizing-lemma-formal-fibres-gorenstein} and
\ref{dualizing-lemma-dualizing-gorenstein-formal-fibres}
and the discussion in More on Algebra, Section
\ref{more-algebra-section-properties-formal-fibres}.
Observe that $(\mathcal{O}_{X, y}^\wedge)_\mathfrak p =
(\mathcal{O}_{X, y}^\wedge)'_{\tilde{\mathfrak p}}$
where $\tilde{\mathfrak p}$ is the kernel of $\alpha$
in the diagram. On the other hand,
$(\mathcal{O}_{X, y}^\wedge)'_{\tilde{\mathfrak p}}
\to (\mathcal{O}_{X', y'}^\wedge)_{\mathfrak p'}$
is flat with CM fibres by the above. Whence
$(\mathcal{O}_{X, y}^\wedge)_\mathfrak p  \to
(\mathcal{O}_{X', y'}^\wedge)_{\mathfrak p'}$ is flat with CM fibres.
Using Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module}
we see that
$$
\text{depth}((\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}) =
\text{depth}((\mathcal{F}_y^\wedge)_{\mathfrak p}) +
\dim(F_\mathfrak r)
$$
where $F$ is the generic formal fibre of
$(\mathcal{O}_{X, y}^\wedge/\mathfrak p)'_{\mathfrak q'}$
and $\mathfrak r$ is the prime corresponding to $\mathfrak p'$.
Since $(\mathcal{O}_{X, y}^\wedge/\mathfrak p)'_{\mathfrak q'}$
is a universally catenary local domain, its $I$-adic completion
is equidimensional and (universally) catenary by Ratliff's theorem
(More on Algebra, Proposition \ref{more-algebra-proposition-ratliff}).
It then follows that
$$
\dim(((\mathcal{O}_{X, y}^\wedge/\mathfrak p)'_{\mathfrak q'})^\wedge) =
\dim(F_\mathfrak r) + \dim(\mathcal{O}_{X', y'}^\wedge/\mathfrak p')
$$
Combined with Lemma \ref{lemma-change-distance-function}
we get
\begin{equation}
\label{equation-one}
\begin{aligned}
&
\text{depth}((\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}) +
\delta^{Y'}_{Z'}(y') \\
& =
\text{depth}((\mathcal{F}_y^\wedge)_{\mathfrak p}) +
\dim(F_\mathfrak r) + \delta^{Y'}_{Z'}(y') \\
& \geq
\text{depth}((\mathcal{F}_y^\wedge)_{\mathfrak p}) + \delta^Y_Z(y) +
\dim(F_\mathfrak r) + \text{trdeg}(\kappa(y')/\kappa(y)) - (d - 1) \\
& =
\text{depth}((\mathcal{F}_y^\wedge)_{\mathfrak p}) + \delta^Y_Z(y) - (d - 1)
+ \dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) -
\dim(\mathcal{O}_{X', y'}^\wedge/\mathfrak p')
\end{aligned}
\end{equation}
Please keep in mind that
$\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) \geq
\dim(\mathcal{O}_{X', y'}^\wedge/\mathfrak p')$. Rewriting this we get
\begin{equation}
\label{equation-two}
\begin{aligned}
&
\text{depth}((\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}) +
\dim(\mathcal{O}_{X', y'}^\wedge/\mathfrak p') +
\delta^{Y'}_{Z'}(y') \\
& \geq
\text{depth}((\mathcal{F}_y^\wedge)_{\mathfrak p}) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) +
\delta^Y_Z(y) - (d - 1)
\end{aligned}
\end{equation}
This inequality will allow us to check the remaning conditions.

\medskip\noindent
Conditions (b) and (d) of
Lemma \ref{lemma-improvement-formal-coherent-module-better}. Assume
$V(\mathfrak p') \cap V(I\mathcal{O}_{X', y'}^\wedge) =
\{\mathfrak m_{y'}^\wedge\}$.
This implies that $\dim(\mathcal{O}_{X', y'}^\wedge/\mathfrak p') = 1$
because $Z'$ is an effective Cartier divisor.
The combination of (b) and (d) is equivalent with
$$
\text{depth}((\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}) + \delta^{Y'}_{Z'}(y')
> 2
$$
If $(\mathcal{F}_n)$ satisfies the inequalities in (3)(b)
then we immediately conclude this is true by applying (\ref{equation-two}).
If $(\mathcal{F}_n)$ satisfies (3)(a), i.e., the
$(d + 1, d + 2)$-inequalities, then we see that in any case
$$
\text{depth}((\mathcal{F}_y^\wedge)_{\mathfrak p}) + \delta^Y_Z(y)
\geq d + 1
\quad\text{or}\quad
\text{depth}((\mathcal{F}_y^\wedge)_{\mathfrak p}) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) +
\delta^Y_Z(y) > d + 2
$$
Looking at (\ref{equation-one}) and (\ref{equation-two}) above this gives
what we want except possibly if
$\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) = 1$.
However, if $\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) = 1$, then we have
$V(\mathfrak p) \cap V(I\mathcal{O}_{X, y}^\wedge) = \{\mathfrak m_y^\wedge\}$
and we see that actually
$$
\text{depth}((\mathcal{F}_y^\wedge)_{\mathfrak p}) + \delta^Y_Z(y) > d + 1
$$
as $(\mathcal{F}_n)$ satisfies the $(d + 1, d + 2)$-inequalities and we
conclude again.

\medskip\noindent
Condition (c) of
Lemma \ref{lemma-improvement-formal-coherent-module-better}. Assume
$V(\mathfrak p') \cap V(I\mathcal{O}_{X', y'}^\wedge) \not =
\{\mathfrak m_{y'}^\wedge\}$. Then condition (c) is equivalent to
$$
\text{depth}((\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}) + \delta^{Y'}_{Z'}(y')
\geq 2
\quad\text{or}\quad
\text{depth}((\mathcal{F}_{y'}^\wedge)_{\mathfrak p'}) +
\dim(\mathcal{O}_{X', y'}^\wedge/\mathfrak p') +
\delta^{Y'}_{Z'}(y') > 3
$$
If $(\mathcal{F}_n)$ satisfies the inequalities in (3)(b)
then we see the second of the two displayed inequalities holds true
by applying (\ref{equation-two}). If $(\mathcal{F}_n)$ satisfies (3)(a), i.e.,
the $(d + 1, d + 2)$-inequalities, then this follows immediately from
(\ref{equation-one}) and (\ref{equation-two}).
This finishes the proof of our claim.

\medskip\noindent
Choose $(b|_{U'}^*\mathcal{F}_n) \to (\mathcal{F}_n'')$
and $(\mathcal{H}_n)$ in $\textit{Coh}(U', I\mathcal{O}_{U'})$
as in Lemma \ref{lemma-improvement-formal-coherent-module-better}.
For any affine open $W \subset X'$ observe that
$\delta^{W \cap Y'}_{W \cap Z'}(y') \geq \delta^{Y'}_{Z'}(y')$ by
Lemma \ref{lemma-discussion} part (7). Hence we see that
$(\mathcal{H}_n|_W)$ satisfies the assumptions of
Lemma \ref{lemma-cd-1-canonical}.
Thus $(\mathcal{H}_n|_W)$ extends canonically to $W$.
Let $(\mathcal{G}_{W, n})$ in $\textit{Coh}(W, I\mathcal{O}_W)$
be the canonical extension as in
Lemma \ref{lemma-canonically-algebraizable}.
By Lemma \ref{lemma-canonically-extend-base-change}
we see that for $W' \subset W$ there is a unique isomorphism
$$
(\mathcal{G}_{W, n}|_{W'}) \longrightarrow
(\mathcal{G}_{W', n})
$$
compatible with the given isomorphisms
$(\mathcal{G}_{W, n}|_{W \cap U}) \cong (\mathcal{H}_n|_{W \cap U})$.
We conclude that there exists an object
$(\mathcal{G}_n)$ of $\textit{Coh}(X', I\mathcal{O}_{X'})$
whose restriction to $U$ is isomorphic to $(\mathcal{H}_n)$.

\medskip\noindent
If $A$ is $I$-adically complete we can finish the proof as follows.
By Grothedieck's existence theorem
(Cohomology of Schemes, Lemma \ref{coherent-lemma-existence-projective})
we see that $(\mathcal{G}_n)$ is the completion of a coherent
$\mathcal{O}_{X'}$-module. Then by
Cohomology of Schemes, Lemma \ref{coherent-lemma-existence-easy}
we see that $(b|_{U'}^*\mathcal{F}_n)$
is the completion of a coherent $\mathcal{O}_{U'}$-module
$\mathcal{F}'$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-push-pull}
we see that there is a map
$$
(\mathcal{F}_n) \longrightarrow ((b|_{U'})_*\mathcal{F}')^\wedge
$$
whose kernel and cokernel is annihilated by a power of $I$.
Then finally, we win by applying
Lemma \ref{lemma-map-kernel-cokernel-on-closed}.

\medskip\noindent
If $A$ is not complete, then, before starting the proof, we may replace $A$
by its completion, see Lemma \ref{lemma-algebraizable}.
After completion the assumptions still hold: this is immediate
for condition (3), follows from
Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing}
for condition (1), and from
Divisors, Lemma \ref{divisors-lemma-flat-base-change-blowing-up}
for condition (2).
Thus the complete case implies the general case.
\end{proof}

\begin{proposition}[Algebraization for ideals with few generators]
\label{proposition-d-generators}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$
be an object of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item $V(I) = V(f_1, \ldots, f_d)$ for some $d \geq 1$ and
$f_1, \ldots, f_d \in A$,
\item one of the following is true
\begin{enumerate}
\item $(\mathcal{F}_n)$ satisfies the $(d + 1, d + 2)$-inequalities
(Definition \ref{definition-s-d-inequalities}), or
\item for $y \in U \cap Y$ and a prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$
we have
$$
\text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) + \delta^Y_Z(y) > d + 2
$$
\end{enumerate}
\end{enumerate}
Then $(\mathcal{F}_n)$ extends to $X$. In particular, if $A$ is
$I$-adically complete, then $(\mathcal{F}_n)$ is the completion
of a coherent $\mathcal{O}_U$-module. 
\end{proposition}

\begin{proof}
We may assume $I = (f_1, \ldots, f_d)$, see
Cohomology of Schemes, Lemma
\ref{coherent-lemma-inverse-systems-ideals-equivalence}.
Then we see that
all fibres of the blowup of $X$ in $I$ have dimension at most $d - 1$.
Thus we get the extension from Lemma \ref{lemma-blowup}.
The final statement follows from Lemma \ref{lemma-essential-image-completion}.
\end{proof}

\noindent
Please compare the next lemma with
Remarks \ref{remark-interesting-case-variant},
\ref{remark-interesting-case},
\ref{remark-interesting-case-bis}, and
\ref{remark-interesting-case-ter}.

\begin{lemma}
\label{lemma-interesting-case-final}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$
be an object of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ is a local ring which has a dualizing complex,
\item all irreducible components of $X$ have the same dimension,
\item the scheme $X \setminus Y$ is Cohen-Macaulay,
\item $I$ is generated by $d$ elements,
\item $\dim(X) - \dim(Z) > d + 2$, and
\item for $y \in U \cap Y$ the module $\mathcal{F}_y^\wedge$
is finite locally free outside $V(I\mathcal{O}_{X, y}^\wedge)$,
for example if $\mathcal{F}_n$ is a finite locally free
$\mathcal{O}_U/I^n\mathcal{O}_U$-module.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends to $X$. In particular if $A$ is $I$-adically
complete, then $(\mathcal{F}_n)$ is the completion of a coherent
$\mathcal{O}_U$-module.
\end{lemma}

\begin{proof}
We will show that the hypotheses (1), (2), (3)(b) of
Proposition \ref{proposition-d-generators} are satisfied.
This is clear for (1) and (2).

\medskip\noindent
Let $y \in U \cap Y$ and let $\mathfrak p$ be a prime
$\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$ with
$\mathfrak p \not \in V(I\mathcal{O}_{X, y}^\wedge)$.
The last condition shows that
$\text{depth}((\mathcal{F}_y^\wedge)_\mathfrak p) =
\text{depth}((\mathcal{O}_{X, y}^\wedge)_\mathfrak p)$.
Since $X \setminus Y$ is Cohen-Macaulay we see that
$(\mathcal{O}_{X, y}^\wedge)_\mathfrak p$ is Cohen-Macaulay.
Thus we see that
\begin{align*}
& \text{depth}((\mathcal{F}^\wedge_y)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) + \delta^Y_Z(y) \\
& =
\dim((\mathcal{O}_{X, y}^\wedge)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) + \delta^Y_Z(y) \\
& =
\dim(\mathcal{O}_{X, y}^\wedge) + \delta^Y_Z(y)
\end{align*}
The final equality because $\mathcal{O}_{X, y}$ is equidimensional
by the second condition.
Let $\delta(y) = \dim(\overline{\{y\}})$. This is a dimension function
as $A$ is a catenary local ring.
By Lemma \ref{lemma-discussion}
we have $\delta^Y_Z(y) \geq \delta(y) - \dim(Z)$. Since $X$ is
equidimensional we get
$$
\dim(\mathcal{O}_{X, y}^\wedge) + \delta^Y_Z(y)
\geq \dim(\mathcal{O}_{X, y}^\wedge) + \delta(y) - \dim(Z)
= \dim(X) - \dim(Z)
$$
Thus we get the desired inequality and we win.
\end{proof}

\begin{remark}
\label{remark-question}
We are unable to prove or disprove the analogue of
Proposition \ref{proposition-d-generators}
where the assumption that $I$ has $d$ generators
is replaced with the assumption $\text{cd}(A, I) \leq d$.
If you know a proof or have a counter example, please email
\href{mailto:stacks.project@gmail.com}{stacks.project@gmail.com}.
Another obvious question is to what extend the conditions in
Proposition \ref{proposition-d-generators}
are necessary.
\end{remark}




\section{Algebraization of coherent formal modules, VI}
\label{section-algebraization-modules-yet-more}

\noindent
In this section we add a few more easier to prove cases.

\begin{proposition}
\label{proposition-algebraization-regular-sequence}
In Situation \ref{situation-algebraize} let
$(\mathcal{F}_n)$ be an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
Assume
\begin{enumerate}
\item there exist $f_1, \ldots, f_d \in I$ such that
for $y \in U \cap Y$ the ideal $I\mathcal{O}_{X, y}$
is generated by $f_1, \ldots, f_d$ and
$f_1, \ldots, f_d$ form a $\mathcal{F}_y^\wedge$-regular sequence,
\item $H^0(U, \mathcal{F}_1)$ and $H^1(U, \mathcal{F}_1)$
are finite $A$-modules.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends canonically to $X$. In particular, if $A$
is complete, then $(\mathcal{F}_n)$ is the completion of a coherent
$\mathcal{O}_U$-module.
\end{proposition}

\begin{proof}
We will prove this by verifying hypotheses (a), (b), and (c) of
Lemma \ref{lemma-when-done}.
For every $n$ we have a short exact sequence
$$
0 \to I^n\mathcal{F}_{n + 1} \to \mathcal{F}_{n + 1} \to \mathcal{F}_n \to 0
$$
Since $f_1, \ldots, f_d$ forms a regular sequence (and hence
quasi-regular, see Algebra, Lemma \ref{algebra-lemma-regular-quasi-regular})
on each of the ``stalks'' $\mathcal{F}_y^\wedge$ and since we have
$I\mathcal{F}_n = (f_1, \ldots, f_d)\mathcal{F}_n$ for all $n$,
we find that
$$
I^n\mathcal{F}_{n + 1} =
\bigoplus\nolimits_{e_1 + \ldots + e_d = n} \mathcal{F}_1 \cdot
f_1^{e_1} \ldots f_d^{e_d}
$$
by checking on stalks. Using the assumption of finiteness of
$H^0(U, \mathcal{F}_1)$ and induction, we first conclude that
$M_n = H^0(U, \mathcal{F}_n)$ is a finite $A$-module for all $n$.
In this way we see that condition (c) of Lemma \ref{lemma-when-done} holds.
We also see that
$$
\bigoplus\nolimits_{n \geq 0} H^1(U, I^n\mathcal{F}_{n + 1})
$$
is a finite graded $R = \bigoplus I^n/I^{n +1}$-module.
By Lemma \ref{lemma-ML-general} we conclude that condition (a) of
Lemma \ref{lemma-when-done} is satisfied. Finally, condition (b) of
Lemma \ref{lemma-when-done} is satisfied because
$\bigoplus H^0(U, I^n\mathcal{F}_{n + 1})$ is a finite graded $R$-module
and we can apply Lemma \ref{lemma-topology-I-adic-general}.
\end{proof}

\begin{remark}
\label{remark-interesting-case-ter}
In the situation of
Proposition \ref{proposition-algebraization-regular-sequence}
if we assume $A$ has a dualizing complex, then
the condition that $H^0(U, \mathcal{F}_1)$ and
$H^1(U, \mathcal{F}_1)$ are finite is equivalent to
$$
\text{depth}(\mathcal{F}_{1, y}) +
\dim(\mathcal{O}_{\overline{\{y\}}, z}) > 2
$$
for all $y \in U \cap Y$ and $z \in Z \cap \overline{\{y\}}$.
See Local Cohomology, Lemma \ref{local-cohomology-lemma-finiteness-Rjstar}.
This holds for example if $\mathcal{F}_1$ is a finite locally free
$\mathcal{O}_{U \cap Y}$-module, $Y$ is $(S_2)$, and
$\text{codim}(Z', Y') \geq 3$ for every pair of irreducible components
$Y'$ of $Y$, $Z'$ of $Z$ with $Z' \subset Y'$.
\end{remark}

\begin{proposition}
\label{proposition-algebraization-flat}
In Situation \ref{situation-algebraize} let
$(\mathcal{F}_n)$ be an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
Assume there is Noetherian local ring $(R, \mathfrak m)$ and a ring
map $R \to A$ such that
\begin{enumerate}
\item $I = \mathfrak m A$,
\item for $y \in U \cap Y$ the stalk $\mathcal{F}_y^\wedge$ is $R$-flat,
\item $H^0(U, \mathcal{F}_1)$ and $H^1(U, \mathcal{F}_1)$ are finite
$A$-modules.
\end{enumerate}
Then $(\mathcal{F}_n)$ extends canonically to $X$. In particular, if $A$
is complete, then $(\mathcal{F}_n)$ is the completion of a coherent
$\mathcal{O}_U$-module.
\end{proposition}

\begin{proof}
The proof is exactly the same as the proof of
Proposition \ref{proposition-algebraization-regular-sequence}.
Namely, if $\kappa = R/\mathfrak m$ then for $n \geq 0$
there is an isomorphism
$$
I^n \mathcal{F}_{n + 1} \cong
\mathcal{F}_1 \otimes_\kappa \mathfrak m^n/\mathfrak m^{n + 1}
$$
and the right hand side is a finite direct sum of copies
of $\mathcal{F}_1$. This can be checked by looking at stalks.
Everything else is exactly the same.
\end{proof}

\begin{remark}
\label{remark-interesting-case-quater}
Proposition \ref{proposition-algebraization-flat} is a local version
of \cite[Theorem 2.10 (i)]{Baranovsky}. It is straightforward to deduce
the global results from the local one; we will sketch the argument.
Namely, suppose $(R, \mathfrak m)$
is a complete Noetherian local ring and $X \to \Spec(R)$ is a proper morphism.
For $n \geq 1$ set $X_n = X \times_{\Spec(R)} \Spec(R/\mathfrak m^n)$.
Let $Z \subset X_1$ be a closed subset of the special fibre.
Set $U = X \setminus Z$ and denote $j : U \to X$ the inclusion morphism.
Suppose given an object
$$
(\mathcal{F}_n) \text{ of } \textit{Coh}(U, \mathfrak m\mathcal{O}_U)
$$
which is flat over $R$ in the sense that $\mathcal{F}_n$ is flat over
$R/\mathfrak m^n$ for all $n$.
Assume that $j_*\mathcal{F}_1$ and $R^1j_*\mathcal{F}_1$ are coherent
modules. Then affine locally on $X$ we get a canonical extension
of $(\mathcal{F}_n)$ by
Proposition \ref{proposition-algebraization-flat}
and formation of this extension commutes with localization
(by Lemma \ref{lemma-algebraization-principal-variant}).
Thus we get a canonical global object $(\mathcal{G}_n)$ of
$\textit{Coh}(X, \mathfrak m\mathcal{O}_X)$
whose restriction of $U$ is $(\mathcal{F}_n)$.
By Grothendieck's existence theorem
(Cohomology of Schemes, Proposition
\ref{coherent-proposition-existence-proper})
we see there exists a coherent $\mathcal{O}_X$-module
$\mathcal{G}$ whose completion is $(\mathcal{G}_n)$.
In this way we see that $(\mathcal{F}_n)$ is algebraizable, i.e.,
it is the completion of a coherent $\mathcal{O}_U$-module.

\medskip\noindent
We add that the coherence of $j_*\mathcal{F}_1$ and $R^1j_*\mathcal{F}_1$
is a condition on the special fibre. Namely, if we denote
$j_1 : U_1 \to X_1$ the special fibre of $j : U \to X$, then we can
think of $\mathcal{F}_1$ as a coherent sheaf on $U_1$ and we have
$j_*\mathcal{F}_1 = j_{1, *}\mathcal{F}_1$ and
$R^1j_*\mathcal{F}_1 = R^1j_{1, *}\mathcal{F}_1$.
Hence for example if $X_1$ is $(S_2)$ and irreducible, we have
$\dim(X_1) - \dim(Z) \geq 3$, and $\mathcal{F}_1$ is a locally free
$\mathcal{O}_{U_1}$-module, then $j_{1, *}\mathcal{F}_1$ and
$R^1j_{1, *}\mathcal{F}_1$ are coherent modules.
\end{remark}








\section{Application to the completion functor}
\label{section-completion-application}

\noindent
In this section we just combine some already obtained results
in order to conveniently reference them. There are many
(stronger) results we could state here.

\begin{lemma}
\label{lemma-equivalence-better}
In Situation \ref{situation-algebraize} assume
\begin{enumerate}
\item $A$ has a dualizing complex and is $I$-adically complete,
\item $I = (f)$ generated by a single element,
\item $A$ is local with maximal ideal $\mathfrak a = \mathfrak m$,
\item one of the following is true
\begin{enumerate}
\item $A_f$ is $(S_2)$ and for $\mathfrak p \subset A$,
$f \not \in \mathfrak p$ minimal we have $\dim(A/\mathfrak p) \geq 4$, or
\item if $\mathfrak p \not \in V(f)$ and
$V(\mathfrak p) \cap V(f) \not = \{\mathfrak m\}$, then
$\text{depth}(A_\mathfrak p) + \dim(A/\mathfrak p) > 3$.
\end{enumerate}
\end{enumerate}
Then with $U_0 = U \cap V(f)$ the completion functor
$$
\colim_{U_0 \subset U' \subset U\text{ open}}
\textit{Coh}(\mathcal{O}_{U'})
\longrightarrow
\textit{Coh}(U, f\mathcal{O}_U)
$$
is an equivalence on the full subcategories of finite locally free objects.
\end{lemma}

\begin{proof}
It follows from Lemma \ref{lemma-fully-faithful-general}
that the functor is fully faithful (details omitted).
Let us prove essential surjectivity. Let $(\mathcal{F}_n)$ be a finite locally
free object of $\textit{Coh}(U, f\mathcal{O}_U)$. By either
Lemma \ref{lemma-algebraization-principal-bis} or
Proposition \ref{proposition-cd-1}
there exists a coherent $\mathcal{O}_U$-module $\mathcal{F}$
such that $(\mathcal{F}_n)$ is the completion of $\mathcal{F}$.
Namely, for the application of either result the only thing to
check is that $(\mathcal{F}_n)$ satisfies the $(2, 3)$-inequalities.
This is done in Lemma \ref{lemma-unwinding-conditions-bis}. If $y \in U_0$,
then the $f$-adic completion of the stalk $\mathcal{F}_y$ is isomorphic to
a finite free module over the $f$-adic completion of $\mathcal{O}_{U, y}$.
Hence $\mathcal{F}$ is finite locally free in an open neighbourhood
$U'$ of $U_0$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-equivalence}
In Situation \ref{situation-algebraize} assume
\begin{enumerate}
\item $I = (f)$ is principal,
\item $A$ is $f$-adically complete,
\item $f$ is a nonzerodivisor,
\item $H^1_\mathfrak a(A/fA)$ and $H^2_\mathfrak a(A/fA)$
are finite $A$-modules.
\end{enumerate}
Then with $U_0 = U \cap V(f)$ the completion functor
$$
\colim_{U_0 \subset U' \subset U\text{ open}}
\textit{Coh}(\mathcal{O}_{U'})
\longrightarrow
\textit{Coh}(U, f\mathcal{O}_U)
$$
is an equivalence on the full subcategories of finite locally free objects.
\end{lemma}

\begin{proof}
The functor is fully faithful by
Lemma \ref{lemma-fully-faithful-general-alternative}.
Essential surjectivity follows from
Lemma \ref{lemma-algebraization-principal-variant}.
\end{proof}








\section{Coherent triples}
\label{section-coherent-triples}

\noindent
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $f \in \mathfrak m$ be a nonzerodivisor. Set
$X = \Spec(A)$, $X_0 = \Spec(A/fA)$, $U = X \setminus V(\mathfrak m)$, and
$U_0 = U \cap X_0$.
We say $(\mathcal{F}, \mathcal{F}_0, \alpha)$ is a {\it coherent triple}
if we have
\begin{enumerate}
\item $\mathcal{F}$ is a coherent $\mathcal{O}_U$-module such that
$f : \mathcal{F} \to \mathcal{F}$ is injective,
\item $\mathcal{F}_0$ is a coherent $\mathcal{O}_{X_0}$-module,
\item $\alpha : \mathcal{F}/f\mathcal{F} \to \mathcal{F}_0|_{U_0}$
is an isomorphism.
\end{enumerate}
There is an obvious notion of a {\it morphism of coherent triples}
which turns the collection of all coherent triples into a category.

\medskip\noindent
The category of coherent triples is additive but not abelian.
However, it is clear what a short exact sequence of coherent
triples is.

\medskip\noindent
Given two coherent triples $(\mathcal{F}, \mathcal{F}_0, \alpha)$
and $(\mathcal{G}, \mathcal{G}_0, \beta)$ it may not be the case that
$(\mathcal{F} \otimes_{\mathcal{O}_U} \mathcal{G},
\mathcal{F}_0  \otimes_{\mathcal{O}_{X_0}} \mathcal{G}_0,
\alpha \otimes \beta)$ is a coherent triple\footnote{Namely, it
isn't necessarily the case that $f$
is injective on $\mathcal{F} \otimes_{\mathcal{O}_U} \mathcal{G}$.}.
However, if the stalks $\mathcal{G}_x$ are
free for all $x \in U_0$, then this does hold.

\medskip\noindent
We will say the coherent triple $(\mathcal{G}, \mathcal{G}_0, \beta)$
is {\it locally free}, resp.\ {\it invertible}
if $\mathcal{G}$ and $\mathcal{G}_0$
are locally free, resp.\ invertible modules. In this case tensoring
with $(\mathcal{G}, \mathcal{G}_0, \beta)$ makes sense (see above)
and turns short exact sequences of coherent triples into short exact
sequences of coherent triples.

\begin{lemma}
\label{lemma-prepare-chi-triple}
For any coherent triple $(\mathcal{F}, \mathcal{F}_0, \alpha)$
there exists a coherent $\mathcal{O}_X$-module $\mathcal{F}'$
such that $f : \mathcal{F}' \to \mathcal{F}'$ is injective,
an isomorphism $\alpha' : \mathcal{F}'|_U \to \mathcal{F}$, and a map
$\alpha'_0 : \mathcal{F}'/f\mathcal{F}' \to \mathcal{F}_0$
such that $\alpha \circ (\alpha' \bmod f) = \alpha'_0|_{U_0}$.
\end{lemma}

\begin{proof}
Choose a finite $A$-module $M$ such that $\mathcal{F}$ is the restriction
to $U$ of the coherent $\mathcal{O}_X$-module associated to $M$, see
Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
Since $\mathcal{F}$ is $f$-torsion free, we may replace $M$ by
its quotient by $f$-power torsion.
On the other hand, let $M_0 = \Gamma(X_0, \mathcal{F}_0)$
so that $\mathcal{F}_0$ is the coherent $\mathcal{O}_{X_0}$-module
associated to the finite $A/fA$-module $M_0$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
there exists an $n$ such that the
isomorphism $\alpha_0$ corresponds to an $A/fA$-module homomorphism
$\mathfrak m^n M/fM \to M_0$ (whose kernel and cokernel
are annihilated by a power of $\mathfrak m$, but we don't need this).
Thus if we take $M' = \mathfrak m^n M$ and we let
$\mathcal{F}'$ be the coherent $\mathcal{O}_X$-module
associated to $M'$, then the lemma is clear.
\end{proof}

\noindent
Let $(\mathcal{F}, \mathcal{F}_0, \alpha)$ be a coherent triple.
Choose $\mathcal{F}', \alpha', \alpha'_0$ as in
Lemma \ref{lemma-prepare-chi-triple}. Set
\begin{equation}
\label{equation-chi-triple}
\chi(\mathcal{F}, \mathcal{F}_0, \alpha) =
\text{length}_A(\Coker(\alpha'_0)) - 
\text{length}_A(\Ker(\alpha'_0))
\end{equation}
The expression on the right makes sense as $\alpha'_0$ is an isomorphism
over $U_0$ and hence its kernel and coherent are coherent modules supported
on $\{\mathfrak m\}$ which therefore have finite length
(Algebra, Lemma \ref{algebra-lemma-support-point}).

\begin{lemma}
\label{lemma-well-defined-chi-triple}
The quantity $\chi(\mathcal{F}, \mathcal{F}_0, \alpha)$ in
(\ref{equation-chi-triple}) does not depend on the choice of
$\mathcal{F}', \alpha', \alpha'_0$ as in Lemma \ref{lemma-prepare-chi-triple}.
\end{lemma}

\begin{proof}
Let $\mathcal{F}', \alpha', \alpha'_0$ and
$\mathcal{F}'', \alpha'', \alpha''_0$ be two such choices.
For $n > 0$ set $\mathcal{F}'_n = \mathfrak m^n \mathcal{F}'$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
for some $n$
there exists an $\mathcal{O}_X$-module map $\mathcal{F}'_n \to \mathcal{F}''$
agreeing with the identification
$\mathcal{F}''|_U = \mathcal{F}'|_U$ determined by $\alpha'$ and $\alpha''$.
Then the diagram
$$
\xymatrix{
\mathcal{F}'_n/f\mathcal{F}'_n \ar[r] \ar[d] &
\mathcal{F}'/f\mathcal{F}' \ar[d]^{\alpha_0'} \\
\mathcal{F}''/f\mathcal{F}'' \ar[r]^{\alpha_0''} &
\mathcal{F}_0
}
$$
is commutative after restricting to $U_0$. Hence by
Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
it is commutative after restricting to
$\mathfrak m^l(\mathcal{F}'_n/f\mathcal{F}'_n)$ for some $l > 0$. Since
$\mathcal{F}'_{n + l}/f\mathcal{F}'_{n + l} \to \mathcal{F}'_n/f\mathcal{F}'_n$
factors through $\mathfrak m^l(\mathcal{F}'_n/f\mathcal{F}'_n)$
we see that after replacing $n$ by $n + l$ the diagram
is commutative. In other words, we have found a third choice
$\mathcal{F}''', \alpha''', \alpha'''_0$
such that there are maps $\mathcal{F}''' \to \mathcal{F}''$
and $\mathcal{F}''' \to \mathcal{F}'$ over $X$
compatible with the maps over $U$ and $X_0$. This reduces us to
the case discussed in the next paragraph.

\medskip\noindent
Assume we have a map $\mathcal{F}'' \to \mathcal{F}'$ over $X$ compatible with
$\alpha', \alpha''$ over $U$ and with $\alpha'_0, \alpha''_0$ over $X_0$.
Observe that $\mathcal{F}'' \to \mathcal{F}'$ is injective as it is an
isomorphism over $U$ and since $f : \mathcal{F}'' \to \mathcal{F}''$
is injective. Clearly $\mathcal{F}'/\mathcal{F}''$ is supported on
$\{\mathfrak m\}$ hence has finite length. We have the maps
of coherent $\mathcal{O}_{X_0}$-modules
$$
\mathcal{F}''/f\mathcal{F}'' \to
\mathcal{F}'/f\mathcal{F}' \xrightarrow{\alpha'_0}
\mathcal{F}_0
$$
whose composition is $\alpha''_0$ and which are isomorphisms over $U_0$.
Elementary homological algebra gives a $6$-term exact sequence
$$
\begin{matrix}
0 \to
\Ker(\mathcal{F}''/f\mathcal{F}'' \to \mathcal{F}'/f\mathcal{F}') \to
\Ker(\alpha''_0) \to
\Ker(\alpha'_0) \to \\
\Coker(\mathcal{F}''/f\mathcal{F}'' \to \mathcal{F}'/f\mathcal{F}') \to
\Coker(\alpha''_0) \to
\Coker(\alpha'_0) \to 0
\end{matrix}
$$
By additivity of lengths (Algebra, Lemma \ref{algebra-lemma-length-additive})
we find that it suffices to show that
$$
\text{length}_A(
\Coker(\mathcal{F}''/f\mathcal{F}'' \to \mathcal{F}'/f\mathcal{F}')) -
\text{length}_A(
\Ker(\mathcal{F}''/f\mathcal{F}'' \to \mathcal{F}'/f\mathcal{F}')) = 0
$$
This follows from applying the snake lemma to
the diagram
$$
\xymatrix{
0 \ar[r] &
\mathcal{F}'' \ar[r]_f \ar[d] &
\mathcal{F}'' \ar[r] \ar[d] &
\mathcal{F}''/f\mathcal{F}'' \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\mathcal{F}' \ar[r]^f &
\mathcal{F}' \ar[r] &
\mathcal{F}'/f\mathcal{F}' \ar[r] &
0
}
$$
and the fact that $\mathcal{F}'/\mathcal{F}''$ has finite length.
\end{proof}

\begin{lemma}
\label{lemma-ses-chi-triple}
We have
$\chi(\mathcal{G}, \mathcal{G}_0, \beta) =
\chi(\mathcal{F}, \mathcal{F}_0, \alpha) +
\chi(\mathcal{H}, \mathcal{H}_0, \gamma)$ if
$$
0 \to
(\mathcal{F}, \mathcal{F}_0, \alpha) \to
(\mathcal{G}, \mathcal{G}_0, \beta) \to
(\mathcal{H}, \mathcal{H}_0, \gamma)
\to 0
$$
is a short exact sequence of coherent triples.
\end{lemma}

\begin{proof}
Choose $\mathcal{G}', \beta', \beta'_0$ as in
Lemma \ref{lemma-prepare-chi-triple}
for the triple $(\mathcal{G}, \mathcal{G}_0, \beta)$.
Denote $j : U \to X$ the inclusion morphism.
Let $\mathcal{F}' \subset \mathcal{G}'$
be the kernel of the composition
$$
\mathcal{G}' \xrightarrow{\beta'} j_*\mathcal{G} \to j_*\mathcal{H}
$$
Observe that $\mathcal{H}' = \mathcal{G}'/\mathcal{F}'$
is a coherent subsheaf of $j_*\mathcal{H}$ and hence
$f : \mathcal{H}' \to \mathcal{H}'$ is injective.
Hence by the snake lemma we obtain a short exact sequence
$$
0 \to \mathcal{F}'/f\mathcal{F}' \to
\mathcal{G}'/f\mathcal{G}' \to
\mathcal{H}'/f\mathcal{H}' \to 0
$$
We have isomorphisms
$\alpha' : \mathcal{F}'|_U \to \mathcal{F}$,
$\beta' : \mathcal{G}'|_U \to \mathcal{G}$, and
$\gamma' : \mathcal{H}'|_U \to \mathcal{H}$ by construction.
To finish the proof we'll need to construct maps
$\alpha'_0 : \mathcal{F}'/f\mathcal{F}' \to \mathcal{F}_0$ and
$\gamma'_0 : \mathcal{H}'/f\mathcal{H}' \to \mathcal{H}_0$ as in
Lemma \ref{lemma-prepare-chi-triple} and fitting into
a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\mathcal{F}'/f\mathcal{F}' \ar[r] \ar@{..>}[d]^{\alpha'_0} &
\mathcal{G}'/f\mathcal{G}' \ar[r] \ar[d]^{\beta'_0} &
\mathcal{H}'/f\mathcal{H}' \ar[r] \ar@{..>}[d]^{\gamma'_0} &
0 \\
0 \ar[r] &
\mathcal{F}_0 \ar[r] &
\mathcal{G}_0 \ar[r] &
\mathcal{H}_0 \ar[r] &
0
}
$$
However, this may not be possible with our initial choice of $\mathcal{G}'$.
From the displayed diagram we see the obstruction is
exactly the composition
$$
\delta :
\mathcal{F}'/f\mathcal{F}' \to
\mathcal{G}'/f\mathcal{G}' \xrightarrow{\beta'_0}
\mathcal{G}_0 \to
\mathcal{H}_0
$$
Note that the restriction of $\delta$ to $U_0$ is zero by our choice of
$\mathcal{F}'$ and $\mathcal{H}'$. Hence by
Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
there exists an $k > 0$ such that
$\delta$ vanishes on $\mathfrak m^k \cdot (\mathcal{F}'/f\mathcal{F}')$.
For $n > k$ set $\mathcal{G}'_n = \mathfrak m^n \mathcal{G}'$,
$\mathcal{F}'_n = \mathcal{G}'_n \cap \mathcal{F}'$, and
$\mathcal{H}'_n = \mathcal{G}'_n/\mathcal{F}'_n$.
Observe that $\beta'_0$ can be composed with
$\mathcal{G}'_n/f\mathcal{G}'_n \to \mathcal{G}'/f\mathcal{G}'$
to give a map
$\beta'_{n, 0} : \mathcal{G}'_n/f\mathcal{G}'_n \to \mathcal{G}_0$
as in Lemma \ref{lemma-prepare-chi-triple}.
By Artin-Rees (Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
we may choose $n$ such that
$\mathcal{F}'_n \subset \mathfrak m^k \mathcal{F}'$.
As above the maps
$f : \mathcal{F}'_n \to \mathcal{F}'_n$,
$f : \mathcal{G}'_n \to \mathcal{G}'_n$, and
$f : \mathcal{H}'_n \to \mathcal{H}'_n$ are injective
and as above using the snake lemma we obtain a short exact
sequence
$$
0 \to \mathcal{F}'_n/f\mathcal{F}'_n \to
\mathcal{G}'_n/f\mathcal{G}'_n \to
\mathcal{H}'_n/f\mathcal{H}'_n \to 0
$$
As above we have isomorphisms
$\alpha'_n : \mathcal{F}'_n|_U \to \mathcal{F}$,
$\beta'_n : \mathcal{G}'_n|_U \to \mathcal{G}$, and
$\gamma'_n : \mathcal{H}'_n|_U \to \mathcal{H}$.
We consider the obstruction
$$
\delta_n :
\mathcal{F}'_n/f\mathcal{F}'_n \to
\mathcal{G}'_n/f\mathcal{G}'_n
\xrightarrow{\beta'_{n, 0}}
\mathcal{G}_0 \to
\mathcal{H}_0
$$
as before. However, the commutative diagram
$$
\xymatrix{
\mathcal{F}'_n/f\mathcal{F}'_n \ar[r] \ar[d] &
\mathcal{G}'_n/f\mathcal{G}'_n \ar[r]_{\beta'_{n, 0}} \ar[d] &
\mathcal{G}_0 \ar[r] \ar[d] &
\mathcal{H}_0 \ar[d] \\
\mathcal{F}'/f\mathcal{F}' \ar[r] &
\mathcal{G}'/f\mathcal{G}' \ar[r]^{\beta'_0} &
\mathcal{G}_0 \ar[r] &
\mathcal{H}_0
}
$$
our choice of $n$ and our observation about $\delta$
show that $\delta_n = 0$.
This produces the desired maps
$\alpha'_{n, 0} : \mathcal{F}'_n/f\mathcal{F}'_n \to \mathcal{F}_0$, and
$\gamma'_{n, 0} : \mathcal{H}'_n/f\mathcal{H}'_n \to \mathcal{H}_0$.
OK, so we may use
$\mathcal{F}'_n, \alpha'_n, \alpha'_{n, 0}$,
$\mathcal{G}'_n, \beta'_n, \beta'_{n, 0}$, and
$\mathcal{H}'_n, \gamma'_n, \gamma'_{n, 0}$
to compute
$\chi(\mathcal{F}, \mathcal{F}_0, \alpha)$,
$\chi(\mathcal{G}, \mathcal{G}_0, \beta)$, and
$\chi(\mathcal{H}, \mathcal{H}_0, \gamma)$.
Now finally the lemma follows from
an application of the snake lemma to
$$
\xymatrix{
0 \ar[r] &
\mathcal{F}'_n/f\mathcal{F}'_n \ar[r] \ar[d] &
\mathcal{G}'_n/f\mathcal{G}'_n \ar[r] \ar[d] &
\mathcal{H}'_n/f\mathcal{H}'_n \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\mathcal{F}_0 \ar[r] &
\mathcal{G}_0 \ar[r] &
\mathcal{H}_0 \ar[r] &
0
}
$$
and additivity of lengths (Algebra, Lemma \ref{algebra-lemma-length-additive}).
\end{proof}

\begin{proposition}
\label{proposition-hilbert-triple}
Let $(\mathcal{F}, \mathcal{F}_0, \alpha)$ be a coherent triple.
Let $(\mathcal{L}, \mathcal{L}_0, \lambda)$ be an invertible coherent
triple. Then the function
$$
\mathbf{Z} \longrightarrow \mathbf{Z},\quad
n \longmapsto
\chi((\mathcal{F}, \mathcal{F}_0, \alpha) \otimes
(\mathcal{L}, \mathcal{L}_0, \lambda)^{\otimes n})
$$
is a polynomial of degree $\leq \dim(\text{Supp}(\mathcal{F}))$.
\end{proposition}

\noindent
More precisely, if $\mathcal{F} = 0$, then the function is constant.
If $\mathcal{F}$ has finite support in $U$, then the function is constant.
If the support of $\mathcal{F}$ in $U$ has dimension $1$, i.e., the
closure of the support of $\mathcal{F}$ in $X$ has dimension $2$, then
the function is linear, etc.

\begin{proof}
We will prove this by induction on the dimension of the support of
$\mathcal{F}$.

\medskip\noindent
The base case is when $\mathcal{F} = 0$. Then either
$\mathcal{F}_0$ is zero or its support is $\{\mathfrak m\}$.
In this case we have
$$
(\mathcal{F}, \mathcal{F}_0, \alpha) \otimes
(\mathcal{L}, \mathcal{L}_0, \lambda)^{\otimes n} =
(0, \mathcal{F}_0 \otimes \mathcal{L}_0^{\otimes n}, 0) \cong
(0, \mathcal{F}_0, 0)
$$
Thus the function of the lemma is constant with value equal
to the length of $\mathcal{F}_0$.

\medskip\noindent
Induction step. Assume the support of $\mathcal{F}$ is nonempty.
Let $\mathcal{G}_0 \subset \mathcal{F}_0$ denote the submodule
of sections supported on $\{\mathfrak m\}$. Then we get a short
exact sequence
$$
0 \to (0, \mathcal{G}_0, 0) \to
(\mathcal{F}, \mathcal{F}_0, \alpha) \to
(\mathcal{F}, \mathcal{F}_0/\mathcal{G}_0, \alpha) \to 0
$$
This sequence remains exact if we tensor by the invertible
coherent triple $(\mathcal{L}, \mathcal{L}_0, \lambda)$, see
discussion above. Thus by additivity of $\chi$
(Lemma \ref{lemma-ses-chi-triple})
and the base case explained above, it suffices to prove
the induction step for
$(\mathcal{F}, \mathcal{F}_0/\mathcal{G}_0, \alpha)$.
In this way we see that we may assume $\mathfrak m$ is not
an associated point of $\mathcal{F}_0$.

\medskip\noindent
Let $T = \text{Ass}(\mathcal{F}) \cup \text{Ass}(\mathcal{F}/f\mathcal{F})$.
Since $U$ is quasi-affine, we can find $s \in \Gamma(U, \mathcal{L})$
which does not vanish at any $u \in T$, see
Properties, Lemma
\ref{properties-lemma-quasi-affine-invertible-nonvanishing-section}.
After multiplying $s$ by a suitable element of $\mathfrak m$
we may assume $\lambda(s \bmod f) = s_0|_{U_0}$ for some
$s_0 \in \Gamma(X_0, \mathcal{L}_0)$; details omitted.
We obtain a morphism
$$
(s, s_0) :
(\mathcal{O}_U, \mathcal{O}_{X_0}, 1)
\longrightarrow
(\mathcal{L}, \mathcal{L}_0, \lambda)
$$
in the category of coherent triples. Let
$\mathcal{G} = \Coker(s : \mathcal{F} \to \mathcal{F} \otimes \mathcal{L})$
and
$\mathcal{G}_0 = \Coker(s_0 : \mathcal{F}_0 \to
\mathcal{F}_0 \otimes \mathcal{L}_0)$. Observe that $s_0 : \mathcal{F}_0 \to
\mathcal{F}_0 \otimes \mathcal{L}_0$ is injective as it is injective
on $U_0$ by our choice of $s$ and as $\mathfrak m$ isn't an
associated point of $\mathcal{F}_0$. It follows that
there exists an
isomorphism $\beta : \mathcal{G}/f\mathcal{G} \to \mathcal{G}_0|_{U_0}$
such that we obtain a short exact sequence
$$
0 \to
(\mathcal{F}, \mathcal{F}_0, \alpha) \to
(\mathcal{F}, \mathcal{F}_0, \alpha) \otimes
(\mathcal{L}, \mathcal{L}_0, \lambda) \to
(\mathcal{G}, \mathcal{G}_0, \beta) \to 0
$$
By induction on the dimension of the support we know the proposition
holds for the coherent triple $(\mathcal{G}, \mathcal{G}_0, \beta)$.
Using the additivity of Lemma \ref{lemma-ses-chi-triple}
we see that
$$
n \longmapsto 
\chi((\mathcal{F}, \mathcal{F}_0, \alpha) \otimes
(\mathcal{L}, \mathcal{L}_0, \lambda)^{\otimes n + 1})
-
\chi((\mathcal{F}, \mathcal{F}_0, \alpha) \otimes
(\mathcal{L}, \mathcal{L}_0, \lambda)^{\otimes n})
$$
is a polynomial. We conclude by a variant of
Algebra, Lemma \ref{algebra-lemma-numerical-polynomial}
for functions defined for all integers (details omitted).
\end{proof}

\begin{lemma}
\label{lemma-nonnegative-chi-triple}
Assume $\text{depth}(A) \geq 3$ or equivalently
$\text{depth}(A/fA) \geq 2$. Let $(\mathcal{L}, \mathcal{L}_0, \lambda)$
be an invertible coherent triple. Then
$$
\chi(\mathcal{L}, \mathcal{L}_0, \lambda) =
\text{length}_A \Coker(\Gamma(U, \mathcal{L}) \to \Gamma(U_0, \mathcal{L}_0))
$$
and in particular this is $\geq 0$. Moreover, 
$\chi(\mathcal{L}, \mathcal{L}_0, \lambda) = 0$ if and only if
$\mathcal{L} \cong \mathcal{O}_U$.
\end{lemma}

\begin{proof}
The equivalence of the depth conditions follows from
Algebra, Lemma \ref{algebra-lemma-depth-drops-by-one}.
By the depth condition we see that
$\Gamma(U, \mathcal{O}_U) = A$ and
$\Gamma(U_0, \mathcal{O}_{U_0}) = A/fA$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth} and
Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
Using Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-for-finite-locally-free}
we find that $M = \Gamma(U, \mathcal{L})$ is a finite $A$-module.
This in turn implies $\text{depth}(M) \geq 2$ for example by
part (4) of Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}
or by Divisors, Lemma \ref{divisors-lemma-depth-pushforward}.
Also, we have $\mathcal{L}_0 \cong \mathcal{O}_{X_0}$
as $X_0$ is a local scheme. Hence we also see that
$M_0 = \Gamma(X_0, \mathcal{L}_0) = \Gamma(U_0, \mathcal{L}_0|_{U_0})$
and that this module is isomorphic to $A/fA$.

\medskip\noindent
By the above $\mathcal{F}' = \widetilde{M}$ is a coherent
$\mathcal{O}_X$-module whose restriction to $U$ is isomorphic to $\mathcal{L}$.
The isomorphism $\lambda : \mathcal{L}/f\mathcal{L} \to \mathcal{L}_0|_{U_0}$
determines a map $M/fM \to M_0$ on global sections
which is an isomorphism over $U_0$.
Since $\text{depth}(M) \geq 2$ we see
that $H^0_\mathfrak m(M/fM) = 0$ and it follows that
$M/fM \to M_0$ is injective. Thus by definition
$$
\chi(\mathcal{L}, \mathcal{L}_0, \lambda) =
\text{length}_A \Coker(M/fM \to M_0)
$$
which gives the first statement of the lemma.

\medskip\noindent
Finally, if this length is $0$, then $M \to M_0$ is surjective.
Hence we can find $s \in M = \Gamma(U, \mathcal{L})$
mapping to a trivializing section of $\mathcal{L}_0$.
Consider the finite $A$-modules $K$, $Q$ defined by the exact
sequence
$$
0 \to K \to A \xrightarrow{s} M \to Q \to 0
$$
The supports of $K$ and $Q$ do not meet $U_0$ because $s$
is nonzero at points of $U_0$. Using
Algebra, Lemma \ref{algebra-lemma-depth-in-ses}
we see that $\text{depth}(K) \geq 2$ (observe that
$As \subset M$ has $\text{depth} \geq 1$ as a submodule of $M$).
Thus the support of $K$ if nonempty has dimension $\geq 2$ by
Algebra, Lemma \ref{algebra-lemma-bound-depth}.
This contradicts $\text{Supp}(M) \cap V(f) \subset \{\mathfrak m\}$
unless $K = 0$. When $K = 0$ we find that
$\text{depth}(Q) \geq 2$ and we conclude
$Q = 0$ as before. Hence $A \cong M$ and
$\mathcal{L}$ is trivial.
\end{proof}







\section{Invertible modules on punctured spectra, I}
\label{section-local-lefschetz-for-pic}

\noindent
In this section we prove some local Lefschetz theorems for the Picard group.
Some of the ideas are taken from
\cite{Kollar-pic}, \cite{Bhatt-local}, and \cite{Kollar-map-pic}.

\begin{lemma}
\label{lemma-injective-torsion-in-pic}
Let $(A, \mathfrak m)$ be a Noetherian local ring. Let $f \in \mathfrak m$
be a nonzerodivisor and assume that $\text{depth}(A/fA) \geq 2$, or equivalently
$\text{depth}(A) \geq 3$. Let $U$, resp.\ $U_0$ be the punctured
spectrum of $A$, resp.\ $A/fA$. The map
$$
\Pic(U) \to \Pic(U_0)
$$
is injective on torsion.
\end{lemma}

\begin{proof}
Let $\mathcal{L}$ be an invertible $\mathcal{O}_U$-module.
Observe that $\mathcal{L}$ maps to $0$ in $\text{Pic}(U_0)$
if and only if we can extend $\mathcal{L}$ to an invertible
coherent triple $(\mathcal{L}, \mathcal{L}_0, \lambda)$
as in Section \ref{section-coherent-triples}.
By Proposition \ref{proposition-hilbert-triple}
the function
$$
n \longmapsto \chi((\mathcal{L}, \mathcal{L}_0, \lambda)^{\otimes n})
$$
is a polynomial. By Lemma \ref{lemma-nonnegative-chi-triple}
the value of this polynomial is zero if and only if
$\mathcal{L}^{\otimes n}$ is trivial.
Thus if $\mathcal{L}$ is torsion, then this
polynomial has infinitely many zeros, hence is
identically zero, hence $\mathcal{L}$ is trivial.
\end{proof}

\begin{proposition}[Koll\'ar]
\label{proposition-injective-pic}
\begin{reference}
\cite[Theorem 1.9]{Kollar-map-pic}
\end{reference}
Let $(A, \mathfrak m)$ be a Noetherian local ring. Let $f \in \mathfrak m$.
Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item $f$ is a nonzerodivisor,
\item $\text{depth}(A/fA) \geq 2$, or equivalently $\text{depth}(A) \geq 3$,
\item if $f \in \mathfrak p \subset A$ is a prime ideal with
$\dim(A/\mathfrak p) = 2$, then $\text{depth}(A_\mathfrak p) \geq 2$.
\end{enumerate}
Let $U$, resp.\ $U_0$ be the punctured spectrum of $A$, resp.\ $A/fA$. The map
$$
\Pic(U) \to \Pic(U_0)
$$
is injective. Finally, if (1), (2), (3), $A$ is $(S_2)$, and
$\dim(A) \geq 4$, then (4) holds.
\end{proposition}

\begin{proof}
Let $\mathcal{L}$ be an invertible $\mathcal{O}_U$-module.
Observe that $\mathcal{L}$ maps to $0$ in $\text{Pic}(U_0)$
if and only if we can extend $\mathcal{L}$ to an invertible
coherent triple $(\mathcal{L}, \mathcal{L}_0, \lambda)$
as in Section \ref{section-coherent-triples}.
By Proposition \ref{proposition-hilbert-triple}
the function
$$
n \longmapsto \chi((\mathcal{L}, \mathcal{L}_0, \lambda)^{\otimes n})
$$
is a polynomial $P$. By Lemma \ref{lemma-nonnegative-chi-triple}
we have
$P(n) \geq 0$ for all $n \in \mathbf{Z}$ with equality if and only if
$\mathcal{L}^{\otimes n}$ is trivial. In particular $P(0) = 0$
and $P$ is either identically zero and we win or $P$ has even degree $\geq 2$.

\medskip\noindent
Set $M = \Gamma(U, \mathcal{L})$ and
$M_0 = \Gamma(X_0, \mathcal{L}_0) = \Gamma(U_0, \mathcal{L}_0)$.
Then $M$ is a finite $A$-module of depth $\geq 2$
and $M_0 \cong A/fA$, see proof of Lemma \ref{lemma-nonnegative-chi-triple}.
Note that $H^2_\mathfrak m(M)$ is finite $A$-module by
Local Cohomology, Lemma
\ref{local-cohomology-lemma-local-finiteness-for-finite-locally-free}
and the fact that $H^i_\mathfrak m(A) = 0$ for $i = 0, 1, 2$
since $\text{depth}(A) \geq 3$.
Consider the short exact sequence
$$
0 \to M/fM \to M_0 \to Q \to 0
$$
Lemma \ref{lemma-nonnegative-chi-triple} tells us $Q$ has finite length
equal to $\chi(\mathcal{L}, \mathcal{L}_0, \lambda)$.
We obtain $Q = H^1_\mathfrak m(M/fM)$ and
$H^i_\mathfrak m(M/fM) = H^i_\mathfrak m(M_0) \cong H^i_\mathfrak m(A/fA)$
for $i > 1$ from the long exact sequence of local cohomology
associated to the displayed short exact sequence. Consider the long
exact sequence of local cohomology associated to the sequence
$0 \to M \to M \to M/fM \to 0$. It starts with
$$
0 \to Q \to H^2_\mathfrak m(M) \to H^2_\mathfrak m(M) \to
H^2_\mathfrak m(A/fA)
$$
Using additivity of lengths we see that
$\chi(\mathcal{L}, \mathcal{L}_0, \lambda)$
is equal to the length of the image of
$H^2_\mathfrak m(M) \to H^2_\mathfrak m(A/fA)$.

\medskip\noindent
Let prove the lemma in a special case to elucidate the rest of the proof.
Namely, assume for a moment that $H^2_\mathfrak m(A/fA)$ is
a finite length module. Then
we would have $P(1) \leq \text{length}_A H^2_\mathfrak m(A/fA)$.
The exact same argument applied to $\mathcal{L}^{\otimes n}$ shows that
$P(n) \leq \text{length}_A H^2_\mathfrak m(A/fA)$ for all $n$.
Thus $P$ cannot have positive degree and we win.
In the rest of the proof we will modify this argument to give
a linear upper bound for $P(n)$ which suffices.

\medskip\noindent
Let us study the map
$H^2_\mathfrak m(M) \to H^2_\mathfrak m(M_0) \cong H^2_\mathfrak m(A/fA)$.
Choose a normalized dualizing complex $\omega_A^\bullet$ for $A$.
By local duality
(Dualizing Complexes, Lemma \ref{dualizing-lemma-special-case-local-duality})
this map is Matlis dual to the map
$$
\text{Ext}^{-2}_A(M, \omega_A^\bullet)
\longleftarrow
\text{Ext}^{-2}_A(M_0, \omega_A^\bullet)
$$
whose image therefore has the same (finite) length.
The support (if nonempty) of the finite $A$-module
$\text{Ext}^{-2}_A(M_0, \omega_A^\bullet)$ consists of
$\mathfrak m$ and a finite number of primes
$\mathfrak p_1, \ldots, \mathfrak p_r$ containing $f$ with
$\dim(A/\mathfrak p_i) = 1$. Namely, by
Local Cohomology, Lemma \ref{local-cohomology-lemma-sitting-in-degrees}
the support is contained in the set of primes $\mathfrak p \subset A$ with
$\text{depth}_{A_\mathfrak p}(M_{0, \mathfrak p}) + \dim(A/\mathfrak p) \leq 2$.
Thus it suffices to show there is no prime $\mathfrak p$ containing $f$ with
$\dim(A/\mathfrak p) = 2$ and
$\text{depth}_{A_\mathfrak p}(M_{0, \mathfrak p}) = 0$.
However, because $M_{0, \mathfrak p} \cong (A/fA)_\mathfrak p$
this would give $\text{depth}(A_\mathfrak p) = 1$ which contradicts
assumption (4).
Choose a section $t \in \Gamma(U, \mathcal{L}^{\otimes -1})$
which does not vanish in the points $\mathfrak p_1, \ldots, \mathfrak p_r$, see
Properties, Lemma
\ref{properties-lemma-quasi-affine-invertible-nonvanishing-section}.
Multiplication by $t$ determines a map $t : M \to A$ which defines an
isomorphism $M_{\mathfrak p_i} \to A_{\mathfrak p_i}$ for
$i = 1, \ldots, r$.
Via $M_0 \cong A/fA$ we may and do
view $t \bmod f$ as an element $t_0 \in A/fA$.
We conclude that there is a commutative diagram
$$
\xymatrix{
\text{Ext}^{-2}_A(M, \omega_A^\bullet) &
\text{Ext}^{-2}_A(M_0, \omega_A^\bullet) \ar[l] \\
\text{Ext}^{-2}_A(A, \omega_A^\bullet) \ar[u]^t &
\text{Ext}^{-2}_A(A/fA, \omega_A^\bullet) \ar[l] \ar[u]_{t_0}
}
$$
It follows that the length of the image of the top horizontal
map is at most the length of $\text{Ext}^{-2}_A(A/fA, \omega_A^\bullet)$
plus the length of the cokernel of $t_0$.

\medskip\noindent
However, if we replace $\mathcal{L}$ by $\mathcal{L}^n$ for $n > 1$,
then we can use
$$
t^n :
M_n = \Gamma(U, \mathcal{L}^{\otimes n})
\longrightarrow
\Gamma(U_0, \mathcal{L}_0^{\otimes n}) = M_{n, 0}
$$
instead of $t$. This replaces $t_0 \in A/fA$ by its $n$th power.
Thus the length of the image of the map
$\text{Ext}^{-2}_A(M_n, \omega_A^\bullet) \leftarrow
\text{Ext}^{-2}_A(M_{n, 0}, \omega_A^\bullet)$
is at most the length of $\text{Ext}^{-2}_A(A/fA, \omega_A^\bullet)$
plus the length of the cokernel of
$$
t_0^n : 
\text{Ext}^{-2}_A(A/fA, \omega_A^\bullet)
\longrightarrow
\text{Ext}^{-2}_A(A/fA, \omega_A^\bullet)
$$
Since $\text{Ext}^{-2}_A(A/fA, \omega_A^\bullet)$ is a finite $A$-module
with support of dimension $1$ as indicated above this length
grows linearly in $n$ by
Algebra, Lemma \ref{algebra-lemma-support-dimension-d}.

\medskip\noindent
To finish the proof we prove the final assertion. Assume
$f \in \mathfrak m \subset A$ satisfies
(1), (2), (3), $A$ is $(S_2)$, and $\dim(A) \geq 4$.
Condition (1) implies $A$ is catenary, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-universally-catenary}.
Then $\Spec(A)$ is equidimensional by Local Cohomology, Lemma
\ref{local-cohomology-lemma-catenary-S2-equidimensional}.
Thus $\dim(A_\mathfrak p) + \dim(A/\mathfrak p) \geq 4$
for every prime $\mathfrak p$ of $A$. Then
$\text{depth}(A_\mathfrak p) \geq \min(2, \dim(A_\mathfrak p))
\geq \min(2, 4 - \dim(A/\mathfrak p))$ and hence (4) holds.
\end{proof}

\begin{remark}
\label{remark-compare-SGA2}
In SGA2 we find the following result. Let $(A, \mathfrak m)$ be a
Noetherian local ring. Let $f \in \mathfrak m$. Assume $A$
is a quotient of a regular ring, the element
$f$ is a nonzerodivisor, and
\begin{enumerate}
\item[(a)] if $\mathfrak p \subset A$ is a prime ideal with
$\dim(A/\mathfrak p) = 1$, then $\text{depth}(A_\mathfrak p) \geq 2$, and
\item[(b)] $\text{depth}(A/fA) \geq 3$, or equivalently
$\text{depth}(A) \geq 4$.
\end{enumerate}
Let $U$, resp.\ $U_0$ be the punctured spectrum of $A$, resp.\ $A/fA$. Then
the map
$$
\Pic(U) \to \Pic(U_0)
$$
is injective. This is \cite[Exposee XI, Lemma 3.16]{SGA2}\footnote{Condition
(a) follows from condition (b), see
Algebra, Lemma \ref{algebra-lemma-depth-localization}.}. This result
from SGA2 follows from Proposition \ref{proposition-injective-pic}
because
\begin{enumerate}
\item a quotient of a regular ring has a dualizing complex (see
Dualizing Complexes, Lemma \ref{dualizing-lemma-regular-gorenstein} and
Proposition \ref{dualizing-proposition-dualizing-essentially-finite-type}), and
\item if $\text{depth}(A) \geq 4$ then $\text{depth}(A_\mathfrak p) \geq 2$
for all primes $\mathfrak p$ with $\dim(A/\mathfrak p) = 2$, see
Algebra, Lemma \ref{algebra-lemma-depth-localization}.
\end{enumerate}
\end{remark}






\section{Invertible modules on punctured spectra, II}
\label{section-local-lefschetz-for-pic-surjective}

\noindent
Next we turn to surjectivity in local Lefschetz for the Picard group.
First to extend an invertible module on $U_0$ to an open neighbourhood
we have the following simple criterion.

\begin{lemma}
\label{lemma-surjective-Pic-first}
Let $(A, \mathfrak m)$ be a Noetherian local ring and $f \in \mathfrak m$.
Assume
\begin{enumerate}
\item $A$ is $f$-adically complete,
\item $f$ is a nonzerodivisor,
\item $H^1_\mathfrak m(A/fA)$ and $H^2_\mathfrak m(A/fA)$
are finite $A$-modules, and
\item $H^3_\mathfrak m(A/fA) = 0$\footnote{Observe that (3) and (4) hold
if $\text{depth}(A/fA) \geq 4$, or equivalently $\text{depth}(A) \geq 5$.}.
\end{enumerate}
Let $U$, resp.\ $U_0$ be the punctured spectrum of $A$, resp.\ $A/fA$.
Then
$$
\colim_{U_0 \subset U' \subset U\text{ open}} \Pic(U')
\longrightarrow
\Pic(U_0)
$$
is surjective.
\end{lemma}

\begin{proof}
Let $U_0 \subset U_n \subset U$ be the $n$th infinitesimal neighbourhood
of $U_0$. Observe that the ideal sheaf of $U_n$ in $U_{n + 1}$ is
isomorphic to $\mathcal{O}_{U_0}$ as $U_0 \subset U$ is the principal
closed subscheme cut out by the nonzerodivisor $f$. Hence we have
an exact sequence of abelian groups
$$
\Pic(U_{n + 1}) \to \Pic(U_n) \to
H^2(U_0, \mathcal{O}_{U_0}) = H^3_\mathfrak m(A/fA) = 0
$$
see More on Morphisms, Lemma
\ref{more-morphisms-lemma-picard-group-first-order-thickening}.
Thus every invertible $\mathcal{O}_{U_0}$-module is the restriction
of an invertible coherent formal module, i.e., an invertible object of
$\textit{Coh}(U, f\mathcal{O}_U)$. We conclude by applying
Lemma \ref{lemma-equivalence}.
\end{proof}

\begin{remark}
\label{remark-surjective-Pic-second}
Let $(A, \mathfrak m)$ be a Noetherian local ring and $f \in \mathfrak m$.
The conclusion of Lemma \ref{lemma-surjective-Pic-first} holds if we assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item $A$ is $f$-adically complete,
\item $f$ is a nonzerodivisor,
\item one of the following is true
\begin{enumerate}
\item $A_f$ is $(S_2)$ and for $\mathfrak p \subset A$,
$f \not \in \mathfrak p$ minimal we have $\dim(A/\mathfrak p) \geq 4$, or
\item if $\mathfrak p \not \in V(f)$ and
$V(\mathfrak p) \cap V(f) \not = \{\mathfrak m\}$, then
$\text{depth}(A_\mathfrak p) + \dim(A/\mathfrak p) > 3$.
\end{enumerate}
\item $H^3_{\mathfrak m}(A/fA) = 0$.
\end{enumerate}
The proof is exactly the same as the proof of
Lemma \ref{lemma-surjective-Pic-first}
using Lemma \ref{lemma-equivalence-better} instead of
Lemma \ref{lemma-equivalence}.
Two points need to be made here: (a)
it seems hard to find examples where one knows
$H^3_{\mathfrak m}(A/fA) = 0$ without assuming
$\text{depth}(A/fA) \geq 4$, and
(b) the proof of Lemma \ref{lemma-equivalence-better} is a
good deal harder than the proof of Lemma \ref{lemma-equivalence}.
\end{remark}

\begin{lemma}
\label{lemma-surjective-Pic-first-better}
Let $(A, \mathfrak m)$ be a Noetherian local ring and $f \in \mathfrak m$.
Assume
\begin{enumerate}
\item the conditions of Lemma \ref{lemma-surjective-Pic-first} hold, and
\item for every maximal ideal $\mathfrak p \subset A_f$
the punctured spectrum of $(A_f)_\mathfrak p$ has trivial Picard group.
\end{enumerate}
Let $U$, resp.\ $U_0$ be the punctured spectrum of $A$, resp.\ $A/fA$.
Then
$$
\Pic(U) \longrightarrow \Pic(U_0)
$$
is surjective.
\end{lemma}

\begin{proof}
Let $\mathcal{L}_0 \in \Pic(U_0)$. By
Lemma \ref{lemma-surjective-Pic-first}
there exists an open $U_0 \subset U' \subset U$
and $\mathcal{L}' \in \Pic(U')$ whose restriction
to $U_0$ is $\mathcal{L}_0$.
Since $U' \supset U_0$ we see that $U \setminus U'$
consists of points corresponding to prime ideals
$\mathfrak p_1, \ldots, \mathfrak p_n$ as in (2).
By assumption we can find invertible modules
$\mathcal{L}'_i$ on $\Spec(A_{\mathfrak p_i})$ agreeing with
$\mathcal{L}'$ over the punctured spectrum
$U' \times_U \Spec(A_{\mathfrak p_i})$ since
trivial invertible modules always extend.
By Limits, Lemma \ref{limits-lemma-glueing-near-closed-point-modules}
applied $n$ times we see that $\mathcal{L}'$ extends to an
invertible module on $U$.
\end{proof}

\begin{lemma}
\label{lemma-local-pic-to-completion}
Let $(A, \mathfrak m)$ be a Noetherian local ring of depth $\geq 2$.
Let $A^\wedge$ be its completion. Let $U$, resp.\ $U^\wedge$
be the punctured spectrum of $A$, resp.\ $A^\wedge$. Then
$\Pic(U) \to \Pic(U^\wedge)$ is injective.
\end{lemma}

\begin{proof}
Let $\mathcal{L}$ be an invertible $\mathcal{O}_U$-module
with pullback $\mathcal{L}^\wedge$ on $U^\wedge$.
We have $H^0(U, \mathcal{O}_U) = A$ by our assumption on depth and
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth} and
Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}.
Thus $\mathcal{L}$ is trivial if and only if
$M = H^0(U, \mathcal{L})$ is isomorphic to $A$ as an $A$-module.
(Details omitted.) Since $A \to A^\wedge$ is flat
we have $M \otimes_A A^\wedge = \Gamma(U^\wedge, \mathcal{L}^\wedge)$
by flat base change, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology}.
Finally, it is easy to see that $M \cong A$ if and only if
$M \otimes_A A^\wedge \cong A^\wedge$.
\end{proof}

\begin{lemma}
\label{lemma-trivial-local-pic-regular}
Let $(A, \mathfrak m)$ be a regular local ring. Then the Picard
group of the punctured spectrum of $A$ is trivial.
\end{lemma}

\begin{proof}
Combine Divisors, Lemma \ref{divisors-lemma-extend-invertible-module}
with More on Algebra, Lemma \ref{more-algebra-lemma-regular-local-UFD}.
\end{proof}

\noindent
Now we can bootstrap the earlier results to prove that
Picard groups are trivial for punctured spectra
of complete intersections of dimension $\geq 4$.
Recall that a Noetherian local ring is called a complete
intersection if its completion is the quotient of a
regular local ring by the ideal generated by a regular sequence.
See the discussion in Divided Power Algebra, Section \ref{dpa-section-lci}.

\begin{proposition}[Grothendieck]
\label{proposition-trivial-local-pic-complete-intersection}
Let $(A, \mathfrak m)$ be a Noetherian local ring. If $A$ is a
complete intersection of dimension $\geq 4$, then the Picard
group of the punctured spectrum of $A$ is trivial.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-local-pic-to-completion} we may assume that $A$ is
a complete local ring. By assumption we can write
$A = B/(f_1, \ldots, f_r)$ where $B$ is a complete regular local
ring and $f_1, \ldots, f_r$ is a regular sequence.
We will finish the proof by induction on $r$.
The base case is $r = 0$ which follows from
Lemma \ref{lemma-trivial-local-pic-regular}.

\medskip\noindent
Assume that $A = B/(f_1, \ldots, f_r)$ and that the proposition
holds for $r - 1$. Set $A' = B/(f_1, \ldots, f_{r - 1})$ and apply
Lemma \ref{lemma-surjective-Pic-first-better} to $f_r \in A'$.
This is permissible:
\begin{enumerate}
\item condition (1) of Lemma \ref{lemma-surjective-Pic-first} holds
because our local rings are complete,
\item condition (2) of Lemma \ref{lemma-surjective-Pic-first} holds
holds as $f_1, \ldots, f_r$ is a regular sequence,
\item condition (3) and (4) of Lemma \ref{lemma-surjective-Pic-first} hold
as $A = A'/f_r A'$ is Cohen-Macaulay of dimension $\dim(A) \geq 4$,
\item condition (2) of Lemma \ref{lemma-surjective-Pic-first-better}
holds by induction hypothesis as
$\dim((A'_{f_r})_\mathfrak p) \geq 4$ for a maximal
prime $\mathfrak p$ of $A'_{f_r}$ and as
$(A'_{f_r})_\mathfrak p = B_\mathfrak q/(f_1, \ldots, f_{r - 1})$
for some prime ideal $\mathfrak q \subset B$ and $B_\mathfrak q$ is regular.
\end{enumerate}
This finishes the proof.
\end{proof}

\begin{example}
\label{example-grothendieck-sharp}
The dimension bound in
Proposition \ref{proposition-trivial-local-pic-complete-intersection}
is sharp. For example the Picard group of the punctured spectrum of
$A = k[[x, y, z, w]]/(xy - zw)$ is nontrivial. Namely, the
ideal $I = (x, z)$ cuts out an effective Cartier divisor $D$ on the punctured
spectrum $U$ of $A$ as it is easy to see that $I_x, I_y, I_z, I_w$
are invertible ideals in $A_x, A_y, A_z, A_w$. But on the other hand,
$A/I$ has depth $\geq 1$ (in fact $2$), hence $I$ has depth $\geq 2$
(in fact $3$), hence
$I = \Gamma(U, \mathcal{O}_U(-D))$. Thus if $\mathcal{O}_U(-D)$
were trivial, then we'd have $I \cong \Gamma(U, \mathcal{O}_U) = A$
which isn't true as $I$ isn't generated by $1$ element.
\end{example}

\begin{example}
\label{example-grothendieck-sharp-bis}
Proposition \ref{proposition-trivial-local-pic-complete-intersection}
cannot be extended to quotients
$$
A = B/(f_1, \ldots, f_r)
$$
where $B$ is regular and $\dim(B) - r \geq 4$. In other words, the condition
that $f_1, \ldots, f_r$ be a regular sequence is (in general) needed
for vanishing of the Picard group of the punctured spectrum of $A$.
Namely, let $k$ be a field and set
$$
A = k[[a, b, x, y, z, u, v, w]]/(a^3, b^3, xa^2 + yab + zb^2, w^2)
$$
Observe that $A = A_0[w]/(w^2)$ with
$A_0 = k[[a, b, x, y, z, u, v]]/(a^3, b^3, xa^2 + yab + zb^2)$.
We will show below that $A_0$ has depth $2$.
Denote $U$ the punctured spectrum of $A$ and $U_0$ the punctured
spectrum of $A_0$. Observe there is a short exact sequence
$0 \to A_0 \to A \to A_0 \to 0$ where the first arrow is
given by multiplication by $w$.
By More on Morphisms, Lemma
\ref{more-morphisms-lemma-picard-group-first-order-thickening}
we find that there is an exact sequence
$$
H^0(U, \mathcal{O}_U^*) \to
H^0(U_0, \mathcal{O}_{U_0}^*) \to
H^1(U_0, \mathcal{O}_{U_0}) \to
\Pic(U)
$$
Since the depth of $A_0$ and hence $A$ is $2$ we see that
$H^0(U_0, \mathcal{O}_{U_0}) = A_0$ and $H^0(U, \mathcal{O}_U) = A$
and that $H^1(U_0, \mathcal{O}_{U_0})$ is nonzero, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth} and
Local Cohomology, Lemma \ref{local-cohomology-lemma-local-cohomology}.
Thus the last arrow displayed above is nonzero and we conclude
that $\Pic(U)$ is nonzero.

\medskip\noindent
To show that $A_0$ has depth $2$ it suffices to show that
$A_1 = k[[a, b, x, y, z]]/(a^3, b^3, xa^2 + yab + zb^2)$
has depth $0$. This is true because $a^2b^2$ maps to
a nonzero element of $A_1$ which is annihilated
by each of the variables $a, b, x, y, z$. For example
$ya^2b^2 = (yab)(ab) = - (xa^2 + zb^2)(ab) = -xa^3b - yab^3 = 0$ in $A_1$.
The other cases are similar.
\end{example}










\section{Application to Lefschetz theorems}
\label{section-lefschetz}

\noindent
In this section we discuss the relation between coherent sheaves on a
projective scheme $P$ and coherent modules on formal completion along
an ample divisor $Q$.

\medskip\noindent
Let $k$ be a field. Let $P$ be a proper scheme over $k$.
Let $\mathcal{L}$ be an ample invertible $\mathcal{O}_P$-module.
Let $s \in \Gamma(P, \mathcal{L})$ be a section\footnote{We do not
require $s$ to be a regular section. Correspondingly, $Q$ is only
a locally principal closed subscheme of $P$ and not necessarily an effective
Cartier divisor.} and let
$Q = Z(s)$ be the zero scheme, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.
For all $n \geq 1$ we denote $Q_n = Z(s^n)$
the $n$th infinitesimal neighbourhood of $Q$.
If $\mathcal{F}$ is a coherent $\mathcal{O}_P$-module, then we denote
$\mathcal{F}_n = \mathcal{F}|_{Q_n}$ the restriction, i.e.,
the pullback of $\mathcal{F}$ by the closed immersion
$Q_n \to P$.

\begin{proposition}
\label{proposition-lefschetz}
In the situation above assume for all points $p \in P \setminus Q$ we have
$$
\text{depth}(\mathcal{F}_p) + \dim(\overline{\{p\}}) > s
$$
Then the map
$$
H^i(P, \mathcal{F}) \longrightarrow \lim H^i(Q_n, \mathcal{F}_n)
$$
is an isomorphism for $0 \leq i < s$.
\end{proposition}

\begin{proof}
We will use More on Morphisms, Lemma \ref{more-morphisms-lemma-apply-proj-spec}
and we will use the notation used and results found
More on Morphisms, Section \ref{more-morphisms-section-proj-spec}
without further mention; this proof will not make sense without
at least understanding the statement of the lemma.
Observe that in our case
$A = \bigoplus_{m \geq 0} \Gamma(P, \mathcal{L}^{\otimes m})$
is a finite type $k$-algebra
all of whose graded parts are finite dimensional $k$-vector spaces, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-proper-ample}.

\medskip\noindent
We may and do think of $s$ as an element $f \in A_1 \subset A$, i.e.,
a homogeneous element of degree $1$ of $A$. Denote
$Y = V(f) \subset X$ the closed subscheme defined by $f$.
Then $U \cap Y = (\pi|_U)^{-1}(Q)$ scheme theoretically.
Recall the notation
$\mathcal{F}_U = \pi^*\mathcal{F}|_U = (\pi|_U)^*\mathcal{F}$.
This is a coherent $\mathcal{O}_U$-module.
Choose a finite $A$-module $M$ such that
$\mathcal{F}_U = \widetilde{M}|_U$
(for existence see Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}).
We claim that $H^i_Z(M)$ is annihilated by
a power of $f$ for $i \leq s + 1$.

\medskip\noindent
To prove the claim we will apply
Local Cohomology, Proposition \ref{local-cohomology-proposition-annihilator}.
Translating into geometry we see that it suffices to prove
for $u \in U$, $u \not \in Y$ and $z \in \overline{\{u\}} \cap Z$
that
$$
\text{depth}(\mathcal{F}_{U, u}) +
\dim(\mathcal{O}_{\overline{\{u\}}, z}) > s + 1
$$
This requires only a small amount of thought.

\medskip\noindent
Observe that $Z = \Spec(A_0)$ is a finite set of closed points of $X$ because
$A_0$ is a finite dimensional $k$-algebra.
(The reader who would like $Z$ to be a singleton can replace the
finite $k$-algebra $A_0$ by $k$; it won't affect anything else in the proof.)

\medskip\noindent
The morphism $\pi : L \to P$ and its restriction $\pi|_U : U \to P$
are smooth of relative dimension $1$.
Let $u \in U$, $u \not \in Y$ and $z \in \overline{\{u\}} \cap Z$.
Let $p = \pi(u) \in P \setminus Q$ be its image.
Then either $u$ is a generic
point of the fibre of $\pi$ over $p$ or a closed point of the fibre.
If $u$ is a generic point of the fibre, then
$\text{depth}(\mathcal{F}_{U, u}) = \text{depth}(\mathcal{F}_p)$
and
$\dim(\overline{\{u\}}) = \dim(\overline{\{p\}}) + 1$.
If $u$ is a closed point of the fibre, then
$\text{depth}(\mathcal{F}_{U, u}) = \text{depth}(\mathcal{F}_p) + 1$
and
$\dim(\overline{\{u\}}) = \dim(\overline{\{p\}})$.
In both cases we have
$\dim(\overline{\{u\}}) = \dim(\mathcal{O}_{\overline{\{u\}}, z})$
because every point of $Z$ is closed. Thus the desired
inequality follows from the assumption in the statement of
the lemma.

\medskip\noindent
Let $A'$ be the $f$-adic completion of $A$. So $A \to A'$ is flat by
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
Denote $U' \subset X' = \Spec(A')$ the inverse image of
$U$ and similarly for $Y'$ and $Z'$. Let $\mathcal{F}'$
on $U'$ be the pullback of $\mathcal{F}_U$ and let
$M' = M \otimes_A A'$.
By flat base change for local cohomology
(Local Cohomology, Lemma \ref{local-cohomology-lemma-torsion-change-rings})
we have
$$
H^i_{Z'}(M') = H^i_Z(M) \otimes_A A'
$$
and we find that for $i \leq s + 1$ these are annihilated by a power of $f$.
Consider the diagram
$$
\xymatrix{
& H^i(U, \mathcal{F}_U) \ar[ld] \ar[d] \ar[r] &
\lim H^i(U, \mathcal{F}_U/f^n\mathcal{F}_U) \ar@{=}[d] \\
H^i(U, \mathcal{F}_U) \otimes_A A' \ar@{=}[r] &
H^i(U', \mathcal{F}') \ar[r] &
\lim H^i(U', \mathcal{F}'/f^n\mathcal{F}')
}
$$
The lower horizontal arrow is an isomorphism for $i < s$ by
Lemma \ref{lemma-alternative-higher} and the torsion
property we just proved. The horizontal equal sign is flat base change
(Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology})
and the vertical equal sign is because $U \cap Y$ and $U' \cap Y'$
as well as their $n$th infinitesimal neighbourhoods
are mapped isomorphically onto each other (as we are
completing with respect to $f$).

\medskip\noindent
Applying More on Morphisms, Equation
(\ref{more-morphisms-equation-cohomology-torsor})
we have compatible direct sum decompositions
$$
\lim H^i(U, \mathcal{F}_U/f^n\mathcal{F}_U) =
\lim
\left(
\bigoplus\nolimits_{m \in \mathbf{Z}}
H^i(Q_n, \mathcal{F}_n \otimes \mathcal{L}^{\otimes m})
\right)
$$
and
$$
H^i(U, \mathcal{F}_U) =
\bigoplus\nolimits_{m \in \mathbf{Z}}
H^i(P, \mathcal{F} \otimes \mathcal{L}^{\otimes m})
$$
Thus we conclude by Algebra, Lemma \ref{algebra-lemma-daniel-litt}.
\end{proof}

\begin{lemma}
\label{lemma-lefschetz-addendum}
Let $k$ be a field. Let $X$ be a proper scheme over $k$.
Let $\mathcal{L}$ be an ample invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$. Let $Y = Z(s)$ be the
zero scheme of $s$ with $n$th infinitesimal neighbourhood $Y_n = Z(s^n)$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Assume that for all $x \in X \setminus Y$ we have
$$
\text{depth}(\mathcal{F}_x) + \dim(\overline{\{x\}}) > 1
$$
Then $\Gamma(V, \mathcal{F}) \to \lim \Gamma(Y_n, \mathcal{F}|_{Y_n})$
is an isomorphism for any open subscheme $V \subset X$ containing $Y$.
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-lefschetz} this is true for $V = X$.
Thus it suffices to show that the map
$\Gamma(V, \mathcal{F}) \to \lim \Gamma(Y_n, \mathcal{F}|_{Y_n})$
is injective. If $\sigma \in \Gamma(V, \mathcal{F})$
maps to zero, then its support is disjoint from $Y$ (details omitted; hint:
use Krull's intersection theorem). Then the closure $T \subset X$
of $\text{Supp}(\sigma)$ is disjoint from $Y$.
Whence $T$ is proper over $k$ (being closed in $X$)
and affine (being closed in the affine scheme $X \setminus Y$, see
Morphisms, Lemma \ref{morphisms-lemma-proper-ample-delete-affine})
and hence finite over $k$
(Morphisms, Lemma \ref{morphisms-lemma-finite-proper}).
Thus $T$ is a finite set of closed points of $X$.
Thus $\text{depth}(\mathcal{F}_x) \geq 2$ is at least $1$
for $x \in T$ by our assumption. We conclude that
$\Gamma(V, \mathcal{F}) \to \Gamma(V \setminus T, \mathcal{F})$
is injective and $\sigma = 0$ as desired.
\end{proof}


\begin{example}
\label{example-lefschetz}
Let $k$ be a field and let $X$ be a proper variety over $k$.
Let $Y \subset X$ be an effective Cartier divisor such that
$\mathcal{O}_X(Y)$ is ample and
denote $Y_n$ its $n$th infinitesimal neighbourhood.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module.
Here are some special cases of Proposition \ref{proposition-lefschetz}.
\begin{enumerate}
\item If $X$ is a curve, we don't learn anything.
\item If $X$ is a Cohen-Macaulay (for example normal) surface, then
$$
H^0(X, \mathcal{E}) \to \lim H^0(Y_n, \mathcal{E}|_{Y_n})
$$
is an isomorphism.
\item If $X$ is a Cohen-Macaulay threefold, then
$$
H^0(X, \mathcal{E}) \to \lim H^0(Y_n, \mathcal{E}|_{Y_n})
\quad\text{and}\quad
H^1(X, \mathcal{E}) \to \lim H^1(Y_n, \mathcal{E}|_{Y_n})
$$
are isomorphisms.
\end{enumerate}
Presumably the pattern is clear. If $X$ is a normal threefold, then
we can conclude the result for $H^0$ but not for $H^1$.
\end{example}

\noindent
Before we prove the next main result, we need a lemma.

\begin{lemma}
\label{lemma-Gm-equivariant-extend-canonically}
In Situation \ref{situation-algebraize} let $(\mathcal{F}_n)$ be an
object of $\textit{Coh}(U, I\mathcal{O}_U)$. Assume
\begin{enumerate}
\item $A$ is a graded ring, $\mathfrak a = A_+$, and
$I$ is a homogeneous ideal,
\item $(\mathcal{F}_n) = (\widetilde{M_n}|_U)$ where $(M_n)$
is an inverse system of graded $A$-modules, and
\item $(\mathcal{F}_n)$ extends canonically to $X$.
\end{enumerate}
Then there is a finite graded $A$-module $N$ such that
\begin{enumerate}
\item[(a)] the inverse systems $(N/I^nN)$ and $(M_n)$ are pro-isomorphic
in the category of graded $A$-modules modulo $A_+$-power torsion
modules, and
\item[(b)] $(\mathcal{F}_n)$ is the completion of of the coherent
module associated to $N$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $(\mathcal{G}_n)$ be the canonical extension as in
Lemma \ref{lemma-canonically-algebraizable}.
The grading on $A$ and $M_n$ determines an action
$$
a : \mathbf{G}_m \times X \longrightarrow X
$$
of the group scheme $\mathbf{G}_m$ on $X$ such that
$(\widetilde{M_n})$ becomes an inverse system of
$\mathbf{G}_m$-equivariant quasi-coherent $\mathcal{O}_X$-modules, see
Groupoids, Example \ref{groupoids-example-Gm-on-affine}.
Since $\mathfrak a$ and $I$ are homogeneous ideals
the closed subschemes $Z$, $Y$ and the open subscheme $U$
are $\mathbf{G}_m$-invariant closed and open subschemes.
The restriction $(\mathcal{F}_n)$ of $(\widetilde{M_n})$
is an inverse system of $\mathbf{G}_m$-equivariant
coherent $\mathcal{O}_U$-modules. In other words, $(\mathcal{F}_n)$
is a $\mathbf{G}_m$-equivariant coherent formal module,
in the sense that there is an isomorphism
$$
\alpha : (a^*\mathcal{F}_n) \longrightarrow (p^*\mathcal{F}_n)
$$
over $\mathbf{G}_m \times U$ satisfying a suitable cocycle condition.
Since $a$ and $p$ are flat morphisms of affine schemes,
by Lemma \ref{lemma-canonically-extend-base-change}
we conclude that there exists a unique isomorphism
$$
\beta : (a^*\mathcal{G}_n) \longrightarrow (p^*\mathcal{G}_n)
$$
over $\mathbf{G}_m \times X$ restricting to $\alpha$ on
$\mathbf{G}_m \times U$. The uniqueness guarantees that
$\beta$ satisfies the corresponding cocycle condition.
In this way each $\mathcal{G}_n$ becomes
a $\mathbf{G}_m$-equivariant coherent $\mathcal{O}_X$-module
in a manner compatible with transition maps.

\medskip\noindent
By Groupoids, Lemma \ref{groupoids-lemma-Gm-equivariant-module}
we see that $\mathcal{G}_n$ with its $\mathbf{G}_m$-equivariant
structure corresponds to a graded $A$-module $N_n$. The transition maps
$N_{n + 1} \to N_n$ are graded module maps. Note that $N_n$ is a finite
$A$-module and $N_n = N_{n + 1}/I^n N_{n + 1}$ because
$(\mathcal{G}_n)$ is an object of $\textit{Coh}(X, I\mathcal{O}_X)$.
Let $N$ be the finite graded $A$-module foud in
Algebra, Lemma \ref{algebra-lemma-finiteness-graded}.
Then $N_n = N/I^nN$, whence $(\mathcal{G}_n)$
is the completion of the coherent module
associated to $N$, and a fortiori we see that (b) is true.

\medskip\noindent
To see (a) we have to unwind the situation described above a bit more.
First, observe that the kernel and cokernel of $M_n \to H^0(U, \mathcal{F}_n)$
is $A_+$-power torsion (Local Cohomology, Lemma
\ref{local-cohomology-lemma-finiteness-pushforwards-and-H1-local}).
Observe that $H^0(U, \mathcal{F}_n)$ comes with a natural grading
such that these maps and the transition maps of the system are
graded $A$-module map; for example we can use that
$(U \to X)_*\mathcal{F}_n$ is a $\mathbf{G}_m$-equivariant module
on $X$ and use 
Groupoids, Lemma \ref{groupoids-lemma-Gm-equivariant-module}.
Next, recall that $(N_n)$ and $(H^0(U, \mathcal{F}_n))$
are pro-isomorphic by Definition \ref{definition-canonically-algebraizable}
and Lemma \ref{lemma-canonically-algebraizable}.
We omit the verification that the maps defining this
pro-isomorphism are graded module maps.
Thus $(N_n)$ and $(M_n)$ are pro-isomorphic in the category of
graded $A$-modules modulo $A_+$-power torsion modules.
\end{proof}

\noindent
Let $k$ be a field. Let $P$ be a proper scheme over $k$.
Let $\mathcal{L}$ be an ample invertible $\mathcal{O}_P$-module.
Let $s \in \Gamma(P, \mathcal{L})$ be a section and let
$Q = Z(s)$ be the zero scheme, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.
Let $\mathcal{I} \subset \mathcal{O}_P$ be the ideal sheaf of $Q$.
We will use $\textit{Coh}(P, \mathcal{I})$ to denote the category
of coherent formal modules introduced in
Cohomology of Schemes, Section \ref{coherent-section-coherent-formal}.

\begin{proposition}
\label{proposition-lefschetz-existence}
In the situation above let $(\mathcal{F}_n)$ be an object of
$\textit{Coh}(P, \mathcal{I})$. Assume for all $q \in Q$ and for
all primes $\mathfrak p \in \mathcal{O}_{P, q}^\wedge$,
$\mathfrak p \not \in V(\mathcal{I}_q^\wedge)$ we have
$$
\text{depth}((\mathcal{F}_q^\wedge)_\mathfrak p) +
\dim(\mathcal{O}_{P, q}^\wedge/\mathfrak p) +
\dim(\overline{\{q\}}) > 2
$$
Then $(\mathcal{F}_n)$ is the completion of a coherent
$\mathcal{O}_P$-module.
\end{proposition}

\begin{proof}
By Cohomology of Schemes, Lemma \ref{coherent-lemma-existence-easy}
to prove the lemma, we may replace $(\mathcal{F}_n)$ by an object
differing from it by $\mathcal{I}$-torsion (see below for more precision).
Let $T' = \{q \in Q \mid \dim(\overline{\{q\}}) = 0\}$
and $T = \{q \in Q \mid \dim(\overline{\{q\}}) \leq 1\}$.
The assumption in the proposition is exactly that
$Q \subset P$, $(\mathcal{F}_n)$, and $T' \subset T \subset Q$
satisfy the conditions of
Lemma \ref{lemma-improvement-formal-coherent-module-better}
with $d = 1$; besides trivial manipulations of inequalities, use that
$V(\mathfrak p) \cap V(\mathcal{I}^\wedge_y) = \{\mathfrak m^\wedge_y\}
\Leftrightarrow \dim(\mathcal{O}_{P, q}^\wedge/\mathfrak p) = 1$
as $\mathcal{I}_y^\wedge$ is generated by $1$ element.
Combining these two remarks, we may replace $(\mathcal{F}_n)$ by the
object $(\mathcal{H}_n)$ of $\textit{Coh}(P, \mathcal{I})$ found in
Lemma \ref{lemma-improvement-formal-coherent-module-better}.
Thus we may and do assume $(\mathcal{F}_n)$ is pro-isomorphic to
an inverse system $(\mathcal{F}_n'')$ of coherent $\mathcal{O}_P$-modules
such that $\text{depth}(\mathcal{F}''_{n, q}) + \dim(\overline{\{q\}}) \geq 2$
for all $q \in Q$.

\medskip\noindent
We will use More on Morphisms, Lemma \ref{more-morphisms-lemma-apply-proj-spec}
and we will use the notation used and results found
More on Morphisms, Section \ref{more-morphisms-section-proj-spec}
without further mention; this proof will not make sense without
at least understanding the statement of the lemma.
Observe that in our case
$A = \bigoplus_{m \geq 0} \Gamma(P, \mathcal{L}^{\otimes m})$
is a finite type $k$-algebra
all of whose graded parts are finite dimensional $k$-vector spaces, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-proper-ample}.

\medskip\noindent
By Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-pullback}
the pull back by $\pi|_U : U \to P$ is an object
$(\pi|_U^*\mathcal{F}_n)$ of $\textit{Coh}(U, f\mathcal{O}_U)$
which is pro-isomorphic to the inverse system
$(\pi|_U^*\mathcal{F}_n'')$ of coherent $\mathcal{O}_U$-modules.
We claim
$$
\text{depth}(\pi|_U^*\mathcal{F}''_{n, y}) + \delta_Z^Y(y) \geq 3
$$
for all $y \in U \cap Y$. Since all the points of $Z$ are closed, we
see that $\delta_Z^Y(y) \geq \dim(\overline{\{y\}})$ for all
$y \in U \cap Y$, see Lemma \ref{lemma-discussion}.
Let $q \in Q$ be the image of $y$. Since the morphism $\pi : U \to P$ is
smooth of relative dimension $1$ we see that either $y$ is a closed point
of a fibre of $\pi$ or a generic point.
Thus we see that
$$
\text{depth}(\pi^*\mathcal{F}''_{n, y}) + \delta_Z^Y(y)
\geq
\text{depth}(\pi^*\mathcal{F}''_{n, y}) + \dim(\overline{\{y\}}) =
\text{depth}(\mathcal{F}''_{n, q}) + \dim(\overline{\{q\}}) + 1
$$
because either the depth goes up by $1$ or the dimension.
This proves the claim.

\medskip\noindent
By Lemma \ref{lemma-cd-1-canonical} we conclude that
$(\pi|_U^*\mathcal{F}_n)$ canonically extends to $X$.
Observe that
$$
M_n = \Gamma(U, \pi|_U^*\mathcal{F}_n) =
\bigoplus\nolimits_{m \in \mathbf{Z}}
\Gamma(P, \mathcal{F}_n \otimes_{\mathcal{O}_P} \mathcal{L}^{\otimes m})
$$
is canonically a graded $A$-module, see
More on Morphisms, Equation (\ref{more-morphisms-equation-cohomology-torsor}).
By Properties, Lemma \ref{properties-lemma-quasi-coherent-quasi-affine}
we have $\pi|_U^*\mathcal{F}_n = \widetilde{M_n}|_U$.
Thus we may apply Lemma \ref{lemma-Gm-equivariant-extend-canonically}
to find a finite graded $A$-module $N$ such that
$(M_n)$ and $(N/I^nN)$ are pro-isomorphic in the category
of graded $A$-modules modulo $A_+$-torsion modules.
Let $\mathcal{F}$ be the coherent $\mathcal{O}_P$-module
associated to $N$, see
Cohomology of Schemes, Proposition
\ref{coherent-proposition-coherent-modules-on-proj-general}.
The same proposition tells us that $(\mathcal{F}/\mathcal{I}^n\mathcal{F})$
is pro-isomorphic to $(\mathcal{F}_n)$.
Since both are objects of $\textit{Coh}(P, \mathcal{I})$
we win by Lemma \ref{lemma-recognize-formal-coherent-modules}.
\end{proof}

\begin{example}
\label{example-lefschetz-existence}
Let $k$ be a field and let $X$ be a proper variety over $k$.
Let $Y \subset X$ be an effective Cartier divisor such that
$\mathcal{O}_X(Y)$ is ample and denote
$\mathcal{I} \subset \mathcal{O}_X$ the corresponding
sheaf of ideals. Let $(\mathcal{E}_n)$ an object
of $\textit{Coh}(X, \mathcal{I})$ with $\mathcal{E}_n$
finite locally free.
Here are some special cases of
Proposition \ref{proposition-lefschetz-existence}.
\begin{enumerate}
\item If $X$ is a curve or a surface, we don't learn anything.
\item If $X$ is a Cohen-Macaulay threefold, then
$(\mathcal{E}_n)$ is the completion of a coherent
$\mathcal{O}_X$-module $\mathcal{E}$.
\item More generally, if $\dim(X) \geq 3$ and $X$ is $(S_3)$, then
$(\mathcal{E}_n)$ is the completion of a coherent
$\mathcal{O}_X$-module $\mathcal{E}$.
\end{enumerate}
Of course, if $\mathcal{E}$ exists, then $\mathcal{E}$ is finite locally
free in an open neighbourhood of $Y$.
\end{example}

\begin{proposition}
\label{proposition-lefschetz-equivalence}
Let $k$ be a field. Let $X$ be a proper scheme over $k$.
Let $\mathcal{L}$ be an ample invertible $\mathcal{O}_X$-module
and let $s \in \Gamma(X, \mathcal{L})$. Let $Y = Z(s)$
be the zero scheme of $s$ and denote $\mathcal{I} \subset \mathcal{O}_X$
the corresponding sheaf of ideals.
Let $\mathcal{V}$ be the set of open subschemes of $X$ containing $Y$
ordered by reverse inclusion.
Assume that for all $x \in X \setminus Y$ we have
$$
\text{depth}(\mathcal{O}_{X, x}) + \dim(\overline{\{x\}}) > 2
$$
Then the completion functor
$$
\colim_\mathcal{V}
\textit{Coh}(\mathcal{O}_V)
\longrightarrow
\textit{Coh}(X, \mathcal{I})
$$
is an equivalence on the full subcategories of finite locally free objects.
\end{proposition}

\begin{proof}
To prove fully faithfulness it suffices to prove that
$$
\colim_\mathcal{V} \Gamma(V, \mathcal{L}^{\otimes m})
\longrightarrow
\lim \Gamma(Y_n, \mathcal{L}^{\otimes m}|_{Y_n})
$$
is an isomorphism for all $m$, see
Lemma \ref{lemma-completion-fully-faithful-general}.
This follows from Lemma \ref{lemma-lefschetz-addendum}.

\medskip\noindent
Essential surjectivity. Let $(\mathcal{F}_n)$ be a finite locally
free object of $\textit{Coh}(X, \mathcal{I})$. Then for $y \in Y$ we have
$\mathcal{F}_y^\wedge = \lim \mathcal{F}_{n, y}$ is
is a finite free $\mathcal{O}_{X, y}^\wedge$-module.
Let $\mathfrak p \subset \mathcal{O}_{X, y}^\wedge$
be a prime with $\mathfrak p \not \in V(\mathcal{I}_y^\wedge)$.
Then $\mathfrak p$ lies over a prime $\mathfrak p_0 \subset \mathcal{O}_{X, y}$
which corresponds to a specialization $x \leadsto y$ with
$x \not \in Y$. By Local Cohomology, Lemma
\ref{local-cohomology-lemma-change-completion}
and some dimension theory
(see Varieties, Section \ref{varieties-section-algebraic-schemes})
we have
$$
\text{depth}((\mathcal{O}_{X, y}^\wedge)_\mathfrak p) +
\dim(\mathcal{O}_{X, y}^\wedge/\mathfrak p) =
\text{depth}(\mathcal{O}_{X, x}) +
\dim(\overline{\{x\}}) - \dim(\overline{\{y\}})
$$
Thus our assumptions imply the assumptions of
Proposition \ref{proposition-lefschetz-existence}
are satisfied and we find that $(\mathcal{F}_n)$
is the completion of a coherent $\mathcal{O}_X$-module $\mathcal{F}$.
It then follows that $\mathcal{F}_y$ is finite free for all $y \in Y$
and hence $\mathcal{F}$ is finite locally free in an open
neighbourhood $V$ of $Y$. This finishes the proof.
\end{proof}









\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
