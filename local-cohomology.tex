\input{preamble}

% OK, start here.
%
\begin{document}

\title{Local Cohomology}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter continues the study of local cohomology.
A reference is \cite{SGA2}.
The definition of local cohomology can be found in
Dualizing Complexes, Section \ref{dualizing-section-local-cohomology}.
For Noetherian rings taking local cohomology is the same
as deriving a suitable torsion functor as is shown in
Dualizing Complexes, Section
\ref{dualizing-section-local-cohomology-noetherian}.
The relationship with depth can be found in
Dualizing Complexes, Section
\ref{dualizing-section-depth}.

\medskip\noindent
In the first part of this chapter we discuss finiteness properties of
local cohomology leading to a proof of a fairly general version of
Grothendieck's finiteness theorem, see Theorem \ref{theorem-finiteness}
and Lemma \ref{lemma-finiteness-Rjstar} (higher direct images
of coherent modules under open immersions).
Our methods incorporate a few very slick arguments the reader
can find in papers of Faltings, see
\cite{Faltings-annulators} and \cite{Faltings-finiteness}.

\medskip\noindent
The second part of this chapter is devoted to theorems on
formal functions and algebraization of formal functions,
mainly in the local Noetherian case (we discuss
the global case elsewhere -- insert future reference here).
Section \ref{section-formal-functions-principal}
discusses some of the tricks one has in the case
of formal functions along an effective Cartier divisor
cut out by a global regular function.
Section \ref{section-derived-completion}
discusses derived completion with respect to
a finite type sheaf of ideals in complete generality.
We show how this material relates to the usual
theorem on formal functions in Section \ref{section-formal-functions}.
In Sections \ref{section-algebraization-sections} and
\ref{section-algebraization-modules}
we algebraize formal sections and coherent formal modules.




\section{Generalities}
\label{section-generalities}

\noindent
The following lemma tells us that the functor $R\Gamma_Z$
is related to cohomology with supports.

\begin{lemma}
\label{lemma-local-cohomology-is-local-cohomology}
Let $A$ be a ring and let $I$ be a finitely generated ideal.
Set $Z = V(I) \subset X = \Spec(A)$. For $K \in D(A)$ corresponding
to $\widetilde{K} \in D_\QCoh(\mathcal{O}_X)$ via
Derived Categories of Schemes, Lemma \ref{perfect-lemma-affine-compare-bounded}
there is a functorial isomorphism
$$
R\Gamma_Z(K) = R\Gamma_Z(X, \widetilde{K})
$$
where on the left we have
Dualizing Complexes, Equation (\ref{dualizing-equation-local-cohomology})
and on the right we have the functor of
Cohomology, Section \ref{cohomology-section-cohomology-support}.
\end{lemma}

\begin{proof}
By Cohomology, Section \ref{cohomology-section-cohomology-support}
there exists a distinguished triangle
$$
R\Gamma_Z(X, \widetilde{K})
\to R\Gamma(X, \widetilde{K})
\to R\Gamma(U, \widetilde{K})
\to R\Gamma_Z(X, \widetilde{K})[1]
$$
where $U = X \setminus Z$. We know that $R\Gamma(X, \widetilde{K}) = K$
by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
Say $I = (f_1, \ldots, f_r)$. Then we obtain a finite affine
open covering $\mathcal{U} : U = D(f_1) \cup \ldots \cup D(f_r)$.
By Derived Categories of Schemes, Lemma
\ref{perfect-lemma-alternating-cech-complex-complex-computes-cohomology}
the alternating {\v C}ech complex
$\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U},
\widetilde{K^\bullet}))$
computes $R\Gamma(U, \widetilde{K})$ where $K^\bullet$ is any
complex of $A$-modules representing $K$. Working through the
definitions we find
$$
R\Gamma(U, \widetilde{K}) =
\text{Tot}\left(
K^\bullet \otimes_A
(\prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
$$
It is clear that
$K^\bullet = R\Gamma(X, \widetilde{K^\bullet}) \to
R\Gamma(U, \widetilde{K}^\bullet)$
is induced by the diagonal map from $A$ into $\prod A_{f_i}$.
Hence we conclude that
$$
R\Gamma_Z(X, \mathcal{F}^\bullet) =
\text{Tot}\left(
K^\bullet \otimes_A
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
$$
By Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-adjoint}
this complex computes $R\Gamma_Z(K)$ and we see the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Set $X = \Spec(A)$, $Z = V(I)$, $U = X \setminus Z$, and $j : U \to X$
the inclusion morphism. Let $\mathcal{F}$ be a quasi-coherent
$\mathcal{O}_U$-module. Then
\begin{enumerate}
\item there exists an $A$-module $M$ such that $\mathcal{F}$ is the
restriction of $\widetilde{M}$ to $U$,
\item given $M$ there is an exact sequence
$$
0 \to H^0_Z(M) \to M \to H^0(U, \mathcal{F}) \to H^1_Z(M) \to 0
$$
and isomorphisms $H^p(U, \mathcal{F}) = H^{p + 1}_Z(M)$ for $p \geq 1$,
\item we may take $M = H^0(U, \mathcal{F})$ in which case
we have $H^0_Z(M) = H^1_Z(M) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The existence of $M$ follows from
Properties, Lemma \ref{properties-lemma-extend-trivial}
and the fact that quasi-coherent sheaves on $X$ correspond
to $A$-modules (Schemes, Lemma \ref{schemes-lemma-equivalence-quasi-coherent}).
Then we look at the distinguished triangle
$$
R\Gamma_Z(X, \widetilde{M}) \to R\Gamma(X, \widetilde{M}) \to
R\Gamma(U, \widetilde{M}|_U) \to R\Gamma_Z(X, \widetilde{M})[1]
$$
of Cohomology, Section \ref{cohomology-section-cohomology-support}.
Since $X$ is affine we have $R\Gamma(X, \widetilde{M}) = M$
by Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
By our choice of $M$ we have $\mathcal{F} = \widetilde{M}|_U$
and hence this produces an exact sequence
$$
0 \to H^0_Z(X, \widetilde{M}) \to M \to H^0(U, \mathcal{F}) \to
H^1_Z(X, \widetilde{M}) \to 0
$$
and isomorphisms $H^p(U, \mathcal{F}) = H^{p + 1}_Z(X, \widetilde{M})$
for $p \geq 1$. By Lemma \ref{lemma-local-cohomology-is-local-cohomology}
we have $H^i_Z(M) = H^i_Z(X, \widetilde{M})$ for all $i$.
Thus (1) and (2) do hold.
Finally, setting $M' = H^0(U, \mathcal{F})$ we see that
the kernel and cokernel of $M \to M'$ are $I$-power torsion.
Therefore $\widetilde{M}|_U \to \widetilde{M'}|_U$ is an isomorphism
and we can indeed use $M'$ as predicted in (3). It goes without saying
that we obtain zero for both $H^0_Z(M')$ and $H^0_Z(M')$.
\end{proof}

\begin{lemma}
\label{lemma-already-torsion}
Let $I, J \subset A$ be finitely generated ideals of a ring $A$.
If $M$ is an $I$-power torsion module, then the
canonical map
$$
H^i_{V(I) \cap V(J)}(M) \to H^i_{V(J)}(M)
$$
is an isomorphism for all $i$.
\end{lemma}

\begin{proof}
Use the spectral sequence of
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-ss}
to reduce to the statement $R\Gamma_I(M) = M$ which is immediate
from the construction of local cohomology
in Dualizing Complexes, Section \ref{dualizing-section-local-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-multiplicative}
Let $S \subset A$ be a multiplicative set of a ring $A$.
Let $M$ be an $A$-module with $S^{-1}M = 0$. Then
$\colim_{f \in S} H^0_{V(f)}(M) = M$ and
$\colim_{f \in S} H^1_{V(f)}(M) = 0$.
\end{lemma}

\begin{proof}
The statement on $H^0$ follows directly from the definitions.
To see the statement on $H^1$ observe that $R\Gamma_{V(f)}$
and $H^1_{V(f)}$ commute with colimits. Hence we may assume
$M$ is annihilated by some $f \in S$. Then
$H^1_{V(ff')}(M) = 0$ for all $f' \in S$ (for example by
Lemma \ref{lemma-already-torsion}).
\end{proof}

\begin{lemma}
\label{lemma-elements-come-from-bigger}
Let $I \subset A$ be a finitely generated ideal of a ring $A$.
Let $\mathfrak p$ be a prime ideal. Let $M$ be an $A$-module.
Let $i \geq 0$ be an integer and consider the map
$$
\Psi :
\colim_{f \in A, f \not \in \mathfrak p} H^i_{V((I, f))}(M)
\longrightarrow
H^i_{V(I)}(M)
$$
Then
\begin{enumerate}
\item $\Im(\Psi)$ is the set of elements which map to zero in
$H^i_{V(I)}(M)_\mathfrak p$,
\item if $H^{i - 1}_{V(I)}(M)_\mathfrak p = 0$, then $\Psi$ is injective,
\item if $H^{i - 1}_{V(I)}(M)_\mathfrak p = H^i_{V(I)}(M)_\mathfrak p = 0$,
then $\Psi$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
For $f \in A$, $f \not \in \mathfrak p$ the spectral sequence of
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-ss}
degenerates to give short exact sequences
$$
0 \to H^1_{V(f)}(H^{i - 1}_{V(I)}(M)) \to
H^i_{V((I, f))}(M) \to H^0_{V(f)}(H^i_{V(I)}(M)) \to 0
$$
This proves (1) and part (2) follows from this and
Lemma \ref{lemma-multiplicative}.
Part (3) is a formal consequence.
\end{proof}

\begin{lemma}
\label{lemma-isomorphism}
Let $I \subset I' \subset A$ be finitely generated ideals of a
Noetherian ring $A$. Let $M$ be an $A$-module. Let $i \geq 0$ be an integer.
Consider the map
$$
\Psi : H^i_{V(I')}(M) \to H^i_{V(I)}(M)
$$
The following are true:
\begin{enumerate}
\item if $H^i_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$
for all $\mathfrak p \in V(I) \setminus V(I')$, then
$\Psi$ is surjective,
\item if $H^{i - 1}_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$
for all $\mathfrak p \in V(I) \setminus V(I')$, then
$\Psi$ is injective,
\item if $H^i_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) =
H^{i - 1}_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$
for all $\mathfrak p \in V(I) \setminus V(I')$, then
$\Psi$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1).
Let $\xi \in H^i_{V(I)}(M)$. Since $A$ is Noetherian, there exists a
largest ideal $I \subset I'' \subset I'$ such that $\xi$ is the image
of some $\xi'' \in H^i_{V(I'')}(M)$. If $V(I'') = V(I')$, then we are
done. If not, choose a generic point $\mathfrak p \in V(I'')$ not in $V(I')$.
Then we have $H^i_{V(I'')}(M)_\mathfrak p =
H^i_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$ by assumption.
By Lemma \ref{lemma-elements-come-from-bigger} we can increase $I''$
which contradicts maximality.

\medskip\noindent
Proof of (2). Let $\xi' \in H^i_{V(I')}(M)$ be in the kernel of $\Psi$.
Since $A$ is Noetherian, there exists a
largest ideal $I \subset I'' \subset I'$ such that $\xi'$
maps to zero in $H^i_{V(I'')}(M)$. If $V(I'') = V(I')$, then we are
done. If not, then choose a generic point $\mathfrak p  \in V(I'')$
not in $V(I')$. Then we have $H^{i - 1}_{V(I'')}(M)_\mathfrak p =
H^{i - 1}_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$ by assumption.
By Lemma \ref{lemma-elements-come-from-bigger} we can increase $I''$
which contradicts maximality.

\medskip\noindent
Part (3) is formal from parts (1) and (2).
\end{proof}








\section{Cohomological dimension}
\label{section-cd}

\noindent
A quick section about cohomological dimension.

\begin{lemma}
\label{lemma-cd}
Let $I \subset A$ be a finitely generated ideal of a ring $A$.
Set $Y = V(I) \subset X = \Spec(A)$. Let $d \geq -1$ be an integer.
The following are equivalent
\begin{enumerate}
\item $H^i_Y(A) = 0$ for $i > d$,
\item $H^i_Y(M) = 0$ for $i > d$ for every $A$-module $M$, and
\item if $d = -1$, then $Y = \emptyset$, if $d = 0$, then
$Y$ is open and closed in $X$, and if $d > 0$ then
$H^i(X \setminus Y, \mathcal{F}) = 0$ for $i \geq d$
for every quasi-coherent $\mathcal{O}_{X \setminus Y}$-module $\mathcal{F}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Observe that $R\Gamma_Y(-)$ has finite cohomological dimension by
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-adjoint}
for example. Hence we can choose a large integer $N$ such that
$H^i_Y(M) = 0$ for all $A$-modules $M$.

\medskip\noindent
Let us prove that (1) and (2) are equivalent. It is immediate that
(2) implies (1). Assume (1). Choose any $A$-module $M$ and fit it into
a short exact sequence $0 \to N \to F \to M \to 0$ where $F$ is a
free $A$-module. Since $R\Gamma_Y$ is a right adjoint, we see that
$H^i_Y(-)$ commutes with direct sums. Hence $H^i_Y(F) = 0$
for $i > d$ by assumption (1). Then we see that
$H^i_Y(M) = H^{i + 1}_Y(N)$ for all $i > d$.
Thus if we've shown the vanishing of $H^j_Y(N)$ for some
$j > d + 1$ and all $A$-modules $N$, then we obtain the
vanishing of $H^{j - 1}_Y(M)$ for all $A$-modules $M$.
By induction we find that (2) is true.

\medskip\noindent
Assume $d = -1$ and (2) holds. Then $0 = H^0_Y(A/I) = A/I \Rightarrow A = I
\Rightarrow Y = \emptyset$. Thus (3) holds. We omit the proof of the converse.

\medskip\noindent
Assume $d = 0$ and (2) holds. Set
$J = H^0_I(A) = \{x \in A \mid I^nx = 0 \text{ for some }n > 0\}$.
Then
$$
H^1_Y(A) = \Coker(A \to \Gamma(X \setminus Y, \mathcal{O}_{X \setminus Y}))
\quad\text{and}\quad
H^1_Y(I) = \Coker(I \to \Gamma(X \setminus Y, \mathcal{O}_{X \setminus Y}))
$$
and the kernel of the first map is equal to $J$. See
Lemma \ref{lemma-local-cohomology}.
We conclude from (2) that $I(A/J) = A/J$.
Thus we may pick $f \in I$
mapping to $1$ in $A/J$. Then $1 - f \in J$ so $I^n(1 - f) = 0$ for some
$n > 0$. Hence $f^n = f^{n + 1}$. Then $e = f^n \in I$ is an idempotent.
Consider the complementary idempotent $e' = 1 - f^n \in J$.
For any element $g \in I$ we have $g^m e' = 0$ for some $m > 0$.
Thus $I$ is contained in the radical of ideal $(e) \subset I$.
This means $Y = V(I) = V(e)$ is open and closed in $X$ as predicted in (3).
Conversely, if $Y = V(I)$ is open and closed, then the functor
$H^0_Y(-)$ is exact and has vanshing higher derived functors.

\medskip\noindent
If $d > 0$, then we see immediately from
Lemma \ref{lemma-local-cohomology} that (2) is equivalent to (3).
\end{proof}

\begin{definition}
\label{definition-cd}
Let $I \subset A$ be a finitely generated ideal of a ring $A$.
The smallest integer $d \geq -1$ satisfying the equivalent conditions
of Lemma \ref{lemma-cd} is called the
{\it cohomological dimension of $I$ in $A$} and is
denoted $\text{cd}(A, I)$.
\end{definition}

\noindent
Thus we have $\text{cd}(A, I) = -1$ if
$I = A$ and $\text{cd}(A, I) = 0$ if $I$ is locally nilpotent
or generated by an idempotent.
Observe that $\text{cd}(A, I)$ exists by the following lemma.

\begin{lemma}
\label{lemma-bound-cd}
Let $I \subset A$ be a finitely generated ideal of a ring $A$.
Then
\begin{enumerate}
\item $\text{cd}(A, I)$ is at most equal to the number of
generators of $I$,
\item $\text{cd}(A, I) \leq r$ if there exist $f_1, \ldots, f_r \in A$
such that $V(f_1, \ldots, f_r) = V(I)$,
\item $\text{cd}(A, I) \leq c$ if $\Spec(A) \setminus V(I)$
can be covered by $c$ affine opens.
\end{enumerate}
\end{lemma}

\begin{proof}
The explicit description for $R\Gamma_Y(-)$ given in
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-adjoint}
shows that (1) is true. We can deduce (2) from (1) using the
fact that $R\Gamma_Z$ depends only on the closed subset
$Z$ and not on the choice of the finitely generated ideal
$I \subset A$ with $V(I) = Z$. This follows either from the
construction of local cohomology in
Dualizing Complexes, Section \ref{dualizing-section-local-cohomology}
combined with
More on Algebra, Lemma \ref{more-algebra-lemma-local-cohomology-closed}.
or it follows from Lemma \ref{lemma-local-cohomology-is-local-cohomology}.
To see (3) we use Lemma \ref{lemma-cd}
and the vanishing result of Cohomology of Schemes, Lemma
\ref{coherent-lemma-vanishing-nr-affines}.
\end{proof}

\begin{lemma}
\label{lemma-cd-sum}
Let $I, J \subset A$ be finitely generated ideals of a ring $A$.
Then $\text{cd}(A, I + J) \leq \text{cd}(A, I) + \text{cd}(A, J)$.
\end{lemma}

\begin{proof}
Use the definition and Dualizing Complexes, Lemma
\ref{dualizing-lemma-local-cohomology-ss}.
\end{proof}

\begin{lemma}
\label{lemma-cd-change-rings}
Let $A \to B$ be a ring map. Let $I \subset A$ be a finitely generated ideal.
Then $\text{cd}(B, IB) \leq \text{cd}(A, I)$. If $A \to B$ is faithfully
flat, then equality holds.
\end{lemma}

\begin{proof}
Use the definition and
Dualizing Complexes, Lemma \ref{dualizing-lemma-torsion-change-rings}.
\end{proof}

\begin{lemma}
\label{lemma-cd-local}
Let $I \subset A$ be a finitely generated ideal of a ring $A$.
Then $\text{cd}(A, I) = \max \text{cd}(A_\mathfrak p, I_\mathfrak p)$.
\end{lemma}

\begin{proof}
Let $Y = V(I)$ and $Y' = V(I_\mathfrak p) \subset \Spec(A_\mathfrak p)$.
Recall that
$R\Gamma_Y(A) \otimes_A A_\mathfrak p = R\Gamma_{Y'}(A_\mathfrak p)$
by Dualizing Complexes, Lemma \ref{dualizing-lemma-torsion-change-rings}.
Thus we conclude by Algebra, Lemma \ref{algebra-lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-cd-dimension}
Let $I \subset A$ be a finitely generated ideal of a ring $A$.
If $M$ is a finite $A$-module, then
$H^i_{V(I)}(M) = 0$ for $i > \dim(\text{Supp}(M))$.
In particular, we have $\text{cd}(A, I) \leq \dim(A)$.
\end{lemma}

\begin{proof}
We first prove the second statement.
Recall that $\dim(A)$ denotes the Krull dimension. By
Lemma \ref{lemma-cd-local} we may assume $A$ is local.
If $V(I) = \emptyset$, then the result is true.
If $V(I) \not = \emptyset$, then
$\dim(\Spec(A) \setminus V(I)) < \dim(A)$ because
the closed point is missing. Observe that
$U = \Spec(A) \setminus V(I)$ is a quasi-compact
open of the spectral space $\Spec(A)$, hence a spectral space itself.
See Algebra, Lemma \ref{algebra-lemma-spec-spectral} and
Topology, Lemma \ref{topology-lemma-spectral-sub}.
Thus Cohomology, Proposition
\ref{cohomology-proposition-cohomological-dimension-spectral}
implies $H^i(U, \mathcal{F}) = 0$ for $i \geq \dim(A)$
which implies what we want by Lemma \ref{lemma-cd}.
In the Noetherian case the reader may use
Grothendieck's Cohomology, Proposition
\ref{cohomology-proposition-vanishing-Noetherian}.

\medskip\noindent
We will deduce the first statement from the second.
Let $\mathfrak a$ be the annihilator of the finite $A$-module $M$.
Set $B = A/\mathfrak a$. Recall that $\Spec(B) = \text{Supp}(M)$, see
Algebra, Lemma \ref{algebra-lemma-support-closed}.
Set $J = IB$. Then $M$ is a $B$-module
and $H^i_{V(I)}(M) = H^i_{V(J)}(M)$, see
Dualizing Complexes, Lemma
\ref{dualizing-lemma-local-cohomology-and-restriction}.
Since $\text{cd}(B, J) \leq \dim(B) = \dim(\text{Supp}(M))$
by the first part we conclude.
\end{proof}

\begin{lemma}
\label{lemma-cd-is-one}
Let $I \subset A$ be a finitely generated ideal of a ring $A$. If
$\text{cd}(A, I) = 1$ then $\Spec(A) \setminus V(I)$ is nonempty affine.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-cd} and
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-compact-h1-zero-covering}.
\end{proof}

\begin{lemma}
\label{lemma-cd-maximal}
Let $(A, \mathfrak m)$ be a Noetherian local ring of dimension $d$.
Then $H^d_\mathfrak m(A)$ is nonzero and $\text{cd}(A, \mathfrak m) = d$.
\end{lemma}

\begin{proof}
By one of the characterizations of dimension, there exists
an ideal of definition for $A$ generated by $d$ elements, see
Algebra, Proposition \ref{algebra-proposition-dimension}.
Hence $\text{cd}(A, \mathfrak m) \leq d$ by
Lemma \ref{lemma-bound-cd}. Thus $H^d_\mathfrak m(A)$ is
nonzero if and only if $\text{cd}(A, \mathfrak m) = d$ if and only if
$\text{cd}(A, \mathfrak m) \geq d$.

\medskip\noindent
Let $A \to A^\wedge$ be the map from $A$ to its completion.
Observe that $A^\wedge$ is a Noetherian local ring of the
same dimension as $A$ with maximal ideal $\mathfrak m A^\wedge$.
See Algebra, Lemmas
\ref{algebra-lemma-completion-Noetherian-Noetherian},
\ref{algebra-lemma-completion-complete}, and
\ref{algebra-lemma-completion-faithfully-flat} and
More on Algebra, Lemma \ref{more-algebra-lemma-completion-dimension}.
By Lemma \ref{lemma-cd-change-rings}
it suffices to prove the lemma for $A^\wedge$.

\medskip\noindent
By the previous paragraph we may assume that $A$ is
a complete local ring. Then $A$ has a normalized dualizing complex
$\omega_A^\bullet$ (Dualizing Complexes, Lemma
\ref{dualizing-lemma-ubiquity-dualizing}).
The local duality theorem (in the form of
Dualizing Complexes, Lemma \ref{dualizing-lemma-special-case-local-duality})
tells us $H^d_\mathfrak m(A)$ is Matlis dual to
$\text{Ext}^{-d}(A, \omega_A^\bullet) = H^{-d}(\omega_A^\bullet)$
which is nonzero for example by
Dualizing Complexes, Lemma
\ref{dualizing-lemma-nonvanishing-generically-local}.
\end{proof}

\begin{lemma}
\label{lemma-cd-bound-dim-local}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be a proper ideal.
Let $\mathfrak p \subset A$ be a prime ideal
such that $V(\mathfrak p) \cap V(I) = \{\mathfrak m\}$.
Then $\dim(A/\mathfrak p) \leq \text{cd}(A, I)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-cd-change-rings} we have
$\text{cd}(A, I) \geq \text{cd}(A/\mathfrak p, I(A/\mathfrak p))$.
Since $V(I) \cap V(\mathfrak p) = \{\mathfrak m\}$ we have
$\text{cd}(A/\mathfrak p, I(A/\mathfrak p)) =
\text{cd}(A/\mathfrak p, \mathfrak m/\mathfrak p)$.
By Lemma \ref{lemma-cd-maximal} this is equal to $\dim(A/\mathfrak p)$.
\end{proof}





\section{More general supports}
\label{section-supports}

\noindent
Let $A$ be a Noetherian ring. Let $M$ be an $A$-module.
Let $T \subset \Spec(A)$ be a subset stable under specialization
(Topology, Definition \ref{topology-definition-specialization}).
Let us define
$$
H^0_T(M) = \colim_{Z \subset T} H^0_Z(M)
$$
where the colimit is over the directed partially ordered set of
closed subsets $Z$ of $\Spec(A)$ contained in
$T$\footnote{Since $T$ is stable under specialization
we have $T = \bigcup_{Z \subset T} Z$, see
Topology, Lemma \ref{topology-lemma-stable-specialization}.}.
In other words, an element $m$ of $M$ is in $H^0_T(M) \subset M$
if and only if the support $V(\text{Ann}_R(m))$ of $m$
is contained in $T$.

\begin{lemma}
\label{lemma-support}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$ be a subset stable
under specialization. For an $A$-module $M$ the following are equivalent
\begin{enumerate}
\item $H^0_T(M) = M$, and
\item $\text{Supp}(M) \subset T$.
\end{enumerate}
The category of such $A$-modules is a Serre subcategory
of the category $A$-modules closed under direct sums.
\end{lemma}

\begin{proof}
The equivalence holds because the support of an element of $M$
is contained in the support of $M$ and conversely the support of
$M$ is the union of the supports of its elements.
The category of these modules is a Serre subcategory
(Homology, Definition \ref{homology-definition-serre-subcategory})
of $\text{Mod}_A$ by
Algebra, Lemma \ref{algebra-lemma-support-quotient}.
We omit the proof of the statement on direct sums.
\end{proof}

\noindent
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$ be a subset stable
under specialization. Let us denote $\text{Mod}_{A, T} \subset \text{Mod}_A$
the Serre subcategory described in Lemma \ref{lemma-support}.
Let us denote $D_T(A) \subset D(A)$ the
strictly full saturated triangulated subcategory of $D(A)$
(Derived Categories, Lemma \ref{derived-lemma-cohomology-in-serre-subcategory})
consisting of complexes of $A$-modules whose cohomology modules
are in $\text{Mod}_{A, T}$. We obtain functors
$$
D(\text{Mod}_{A, T}) \to D_T(A) \to D(A)
$$
See discussion in
Derived Categories, Section \ref{derived-section-triangulated-sub}.
Denote $RH^0_T : D(A) \to D(\text{Mod}_{A, T})$ the right
derived extension of $H^0_T$. We will denote
$$
R\Gamma_T : D^+(A) \to D^+_T(A),
$$
the composition of $RH^0_T : D^+(A) \to D^+(\text{Mod}_{A, T})$ with
$D^+(\text{Mod}_{A, T}) \to D^+_T(A)$. If the dimension of $A$ is
finite\footnote{If $\dim(A) = \infty$ the construction
may have unexpected properties on unbounded complexes.},
then we will denote
$$
R\Gamma_T : D(A) \to D_T(A)
$$
the composition of $RH^0_T$ with
$D(\text{Mod}_{A, T}) \to D_T(A)$.

\begin{lemma}
\label{lemma-adjoint}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$
be a subset stable under specialization. The functor
$RH^0_T$ is the right adjoint to the functor
$D(\text{Mod}_{A, T}) \to D(A)$.
\end{lemma}

\begin{proof}
This follows from the fact that the functor $H^0_T(-)$ is
the right adjoint to the inclusion functor
$\text{Mod}_{A, T} \to \text{Mod}_A$, see
Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.
\end{proof}

\begin{lemma}
\label{lemma-adjoint-ext}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$
be a subset stable under specialization.
For any object $K$ of $D(A)$ we have
$$
H^i(RH^0_T(K)) = \colim_{Z \subset T\text{ closed}} H^i_Z(K)
$$
\end{lemma}

\begin{proof}
Let $J^\bullet$ be a K-injective complex representing $K$.
By definition $RH^0_T$ is represented by the complex
$$
H^0_T(J^\bullet) = \colim H^0_Z(J^\bullet)
$$
where the equality follows from our definition of $H^0_T$.
Since filtered colimits are exact the cohomology of this
complex in degree $i$ is
$\colim H^i(H^0_Z(J^\bullet)) = \colim H^i_Z(K)$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-equal-plus}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$ be a subset stable
under specialization. The functor $D^+(\text{Mod}_{A, T}) \to D^+_T(A)$
is an equivalence.
\end{lemma}

\begin{proof}
Let $M$ be an object of $\text{Mod}_{A, T}$. Choose an embedding
$M \to J$ into an injective $A$-module. By
Dualizing Complexes, Proposition
\ref{dualizing-proposition-structure-injectives-noetherian}
the module $J$ is a direct sum of injective hulls of residue fields.
Let $E$ be an injective hull of the residue field of $\mathfrak p$.
Since $E$ is $\mathfrak p$-power torsion we see that
$H^0_T(E) = 0$ if $\mathfrak p \not \in T$ and
$H^0_T(E) = E$ if $\mathfrak p \in T$.
Thus $H^0_T(J)$ is injective as a direct sum of injective hulls
(by the proposition) and we have an embedding $M \to H^0_T(J)$.
Thus every object $M$ of $\text{Mod}_{A, T}$ has an injective resolution
$M \to J^\bullet$ with $J^n$ also in $\text{Mod}_{A, T}$. It follows
that $RH^0_T(M) = M$.

\medskip\noindent
Next, suppose that $K \in D_T^+(A)$. Then the spectral sequence
$$
R^qH^0_T(H^p(K)) \Rightarrow R^{p + q}H^0_T(K)
$$
(Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor})
converges and above we have seen that only the terms with $q = 0$
are nonzero. Thus we see that $RH^0_T(K) \to K$ is an isomorphism.
Thus the functor $D^+(\text{Mod}_{A, T}) \to D^+_T(A)$
is an equivalence with quasi-inverse given by $RH^0_T$.
\end{proof}

\begin{lemma}
\label{lemma-equal-full}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$ be a subset stable
under specialization. If $\dim(A) < \infty$, then functor
$D(\text{Mod}_{A, T}) \to D_T(A)$ is an equivalence.
\end{lemma}

\begin{proof}
Say $\dim(A) = d$. Then we see that $H^i_Z(M) = 0$ for $i > d$
for every closed subset $Z$ of $\Spec(A)$, see
Lemma \ref{lemma-cd-dimension}.
By Lemma \ref{lemma-adjoint-ext} we find that $H^0_T$ has bounded
cohomological dimension.

\medskip\noindent
Let $K \in D_T(A)$. We claim that $RH^0_T(K) \to K$ is an
isomorphism. We know this is true when $K$ is bounded below, see
Lemma \ref{lemma-equal-plus}. However, since $H^0_T$ has bounded
cohomological dimension, we see that the $i$th cohomology of
$RH_T^0(K)$ only depends on $\tau_{\geq -d + i}K$ and we conclude.
Thus $D(\text{Mod}_{A, T}) \to D_T(A)$ is an equivalence with
quasi-inverse $RH^0_T$.
\end{proof}

\begin{remark}
\label{remark-upshot}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$ be a
subset stable under specialization.
The upshot of the discussion above is that
$R\Gamma_T : D^+(A) \to D_T^+(A)$ is the right adjoint
to the inclusion functor $D_T^+(A) \to D^+(A)$.
If $\dim(A) < \infty$, then
$R\Gamma_T : D(A) \to D_T(A)$ is the right adjoint
to the inclusion functor $D_T(A) \to D(A)$.
In both cases we have
$$
H^i_T(K) = H^i(R\Gamma_T(K)) = R^iH^0_T(K) =
\colim_{Z \subset T\text{ closed}} H^i_Z(K)
$$
This follows by combining
Lemmas \ref{lemma-adjoint}, \ref{lemma-adjoint-ext},
\ref{lemma-equal-plus}, and \ref{lemma-equal-full}.
\end{remark}

\begin{lemma}
\label{lemma-torsion-change-rings}
Let $A \to B$ be a flat homomorphism of Noetherian rings.
Let $T \subset \Spec(A)$ be a subset stable under specialization.
Let $T' \subset \Spec(B)$ be the inverse image of $T$.
Then the canonical map
$$
R\Gamma_T(K) \otimes_A^\mathbf{L} B
\longrightarrow
R\Gamma_{T'}(K \otimes_A^\mathbf{L} B)
$$
is an isomorphism for $K \in D^+(A)$. If $A$ and $B$ have finite
dimension, then this is true for $K \in D(A)$.
\end{lemma}

\begin{proof}
From the map $R\Gamma_T(K) \to K$ we get a map
$R\Gamma_T(K) \otimes_A^\mathbf{L} B \to K \otimes_A^\mathbf{L} B$.
The cohomology modules of $R\Gamma_T(K) \otimes_A^\mathbf{L} B$
are supported on $T'$ and hence we get the arrow of the lemma.
This arrow is an isomorphism if $T$ is a closed subset of $\Spec(A)$ by
Dualizing Complexes, Lemma \ref{dualizing-lemma-torsion-change-rings}.
Recall that $H^i_T(K)$ is the colimit of $H^i_Z(K)$ where $Z$ runs over
the (directed set of) closed subsets of $T$, see
Lemma \ref{lemma-adjoint-ext}.
Correspondingly
$H^i_{T'}(K \otimes_A^\mathbf{L} B) =
\colim H^i_{Z'}(K \otimes_A^\mathbf{L} B)$ where $Z'$ is the inverse
image of $Z$. Thus the result because $\otimes_A B$ commutes
with filtered colimits and there are no higher Tors.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-ss}
Let $A$ be a ring and let $T, T' \subset \Spec(A)$ subsets
stable under specialization. For $K \in D^+(A)$
there is a spectral sequence
$$
E_2^{p, q} = H^p_T(H^p_{T'}(K)) \Rightarrow H^{p + q}_{T \cap T'}(K)
$$
as in Derived Categories, Lemma
\ref{derived-lemma-grothendieck-spectral-sequence}.
\end{lemma}

\begin{proof}
Let $E$ be an object of $D_{T \cap T'}(A)$. Then we have
$$
\Hom(E, R\Gamma_T(R\Gamma_{T'}(K))) =
\Hom(E, R\Gamma_{T'}(K)) =
\Hom(E, K)
$$
The first equality by the adjointness property of $R\Gamma_T$
and the second by the adjointness property of $R\Gamma_{T'}$.
On the other hand, if $J^\bullet$ is a bounded below complex
of injectives representing $K$, then $H^0_{T'}(J^\bullet)$
is a complex of injective $A$-modules representing $R\Gamma_{T'}(K)$
and hence $H^0_T(H^0_{T'}(J^\bullet))$ is a complex representing
$R\Gamma_T(R\Gamma_{T'}(K))$. Thus $R\Gamma_T(R\Gamma_{T'}(K))$
is an object of $D^+_{T \cap T'}(A)$. Combining these two
facts we find that $R\Gamma_{T \cap T'} = R\Gamma_T \circ R\Gamma_{T'}$.
This produces the spectral sequence by the lemma referenced
in the statement.
\end{proof}

\begin{lemma}
\label{lemma-torsion-tensor-product}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$ be a subset
stable under specialization. Assume $A$ has finite dimension. Then
$$
R\Gamma_T(K) = R\Gamma_T(A) \otimes_A^\mathbf{L} K
$$
for $K \in D(A)$. For $K, L \in D(A)$ we have
$$
R\Gamma_T(K \otimes_A^\mathbf{L} L) =
K \otimes_A^\mathbf{L} R\Gamma_T(L) =
R\Gamma_T(K) \otimes_A^\mathbf{L} L =
R\Gamma_T(K) \otimes_A^\mathbf{L} R\Gamma_T(L)
$$
If $K$ or $L$ is in $D_T(A)$ then so is $K \otimes_A^\mathbf{L} L$.
\end{lemma}

\begin{proof}
By construction we may represent $R\Gamma_T(A)$ by a complex $J^\bullet$ in
$\text{Mod}_{A, T}$. Thus if we represent $K$ by a K-flat complex $K^\bullet$
then we see that $R\Gamma_T(A) \otimes_A^\mathbf{L} K$ is represented
by the complex $\text{Tot}(J^\bullet \otimes_A K^\bullet)$ in
$\text{Mod}_{A, T}$. Using the map $R\Gamma_T(A) \to A$ we obtain
a map $R\Gamma_T(A) \otimes_A^\mathbf{L} K\to K$. Thus by the adjointness
property of $R\Gamma_T$ we obtain a canonical map
$$
R\Gamma_T(A) \otimes_A^\mathbf{L} K \longrightarrow R\Gamma_T(K)
$$
factoring the just constructed map. Observe that $R\Gamma_T$ commutes
with direct sums in $D(A)$ for example by Lemma \ref{lemma-adjoint-ext},
the fact that directed colimits commute with direct sums, and the
fact that usual local cohomology commutes with direct sums
(for example by Dualizing Complexes, Lemma
\ref{dualizing-lemma-local-cohomology-adjoint}).
Thus by More on Algebra, Remark \ref{more-algebra-remark-P-resolution}
it suffices to check the map is an isomorphism for
$K = A[k]$ where $k \in \mathbf{Z}$. This is clear.

\medskip\noindent
The final statements follow from the result we've just shown
by transitivity of derived tensor products.
\end{proof}

\begin{lemma}
\label{lemma-filter-local-cohomology}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$
be a subset stable under specialization. Let $T' \subset T$ be
the set of nonminimal primes in $T$. Then $T'$
is a subset of $\Spec(A)$ stable under specialization
and for every $A$-module $M$ there is an exact sequence
$$
\bigoplus\nolimits_{Z, f} H^1_f(H^{i - 1}_Z(M)) \to
H^i_{T'}(M) \to H^i_T(M) \to
\bigoplus\nolimits_{\mathfrak p \in T \setminus T'}
H^i_{\mathfrak p A_\mathfrak p}(M_\mathfrak p)
$$
where on the left we index over closed subsets $Z \subset T$
and $f \in A$ with $V(f) \cap Z \subset T'$.
\end{lemma}

\begin{proof}
For every $Z$ and $f$ the spectral sequence of
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-ss}
degenerates to give short exact sequences
$$
0 \to H^1_f(H^{i - 1}_Z(M)) \to
H^i_{Z \cap V(f)}(M) \to H^0_f(H^i_Z(M)) \to 0
$$
We will use this without further mention below.

\medskip\noindent
Let $\xi \in H^i_T(M)$ map to zero in the direct sum.
Then we first write $\xi$ as the image of some $\xi' \in H^i_Z(M)$
for some closed subset $Z \subset T$, see Lemma \ref{lemma-adjoint-ext}.
Then $\xi'$ maps to zero in $H^i_{\mathfrak p A_\mathfrak p}(M_\mathfrak p)$
for every $\mathfrak p \in Z$, $\mathfrak p \not \in T'$.
Since there are finitely many of these primes,
we may choose $f \in A$ not contained in any of these
such that $f$ annihilates $\xi'$. Then $\xi'$
is the image of some $\xi'' \in H^i_{Z'}(M)$
where $Z' = Z \cap V(f)$. By our choice of $f$ we have
$Z' \subset T'$ and we get exactness at the penultimate spot.

\medskip\noindent
Let $\xi \in H^i_{T'}(M)$ map to zero in $H^i_T(M)$.
Choose closed subsets $Z' \subset Z$ with $Z' \subset T'$
and $Z \subset T$ such that $\xi$ comes from $\xi' \in H^i_{Z'}(M)$
and maps to zero in $H^i_Z(M)$. Then we can find $f \in A$
with $V(f) \cap Z = Z'$ and we conclude.
\end{proof}

\begin{lemma}
\label{lemma-zero}
Let $A$ be a Noetherian ring of finite dimension.
Let $T \subset \Spec(A)$ be a subset stable under specialization.
Let $\{M_n\}_{n \geq 0}$ be an inverse system of $A$-modules.
Let $i \geq 0$ be an integer. Assume the dimension of $A$
is finite and that for every $m$ there
exists an integer $m'(m) > m$ such  that for all
$\mathfrak p \in T$ the induced map
$$
H^i_{\mathfrak p A_\mathfrak p}(M_{k, \mathfrak p})
\longrightarrow
H^i_{\mathfrak p A_\mathfrak p}(M_{m, \mathfrak p})
$$
is zero for $k \geq m'(m)$. Then for every $m$ there exists
an integer $m''(m)$ such that the map
$H^i_T(M_k) \to H^i_T(M_m)$ is zero for all $k \geq m''(m)$.
\end{lemma}

\begin{proof}
We first make a general remark: suppose we have an exact
sequence
$$
(A_n) \to (B_n) \to (C_n)
$$
of inverse systems of abelian groups. Suppose that for every
$m$ there exists an integer $m'(m) > m$ such that
$$
A_k \to A_m
\quad\text{and}\quad
C_k \to C_m
$$
are zero for $k \geq m'(m)$. Then for $k \geq m'(m'(m))$
the map $B_k \to B_m$ is zero.

\medskip\noindent
We will prove the lemma by induction on $\dim(T)$ which is
finite because $\dim(A)$ is finite. Let $T' \subset T$ be
the set of nonminimal primes in $T$. Then $T'$
is a subset of $\Spec(A)$ stable under specialization
and the hyptoheses of the lemma apply to $T'$.
Since $\dim(T') < \dim(T)$ we the lemma holds for $T'$.
For every $A$-module $M$ there is an exact sequence
$$
H^i_{T'}(M) \to H^i_T(M) \to
\bigoplus\nolimits_{\mathfrak p \in T \setminus T'}
H^i_{\mathfrak p A_\mathfrak p}(M_\mathfrak p)
$$
by Lemma \ref{lemma-filter-local-cohomology}.
Thus we conclude by the initial remark of the proof.
\end{proof}

\begin{lemma}
\label{lemma-essential-image}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$ be a subset
stable under specialization. Let $\{M_n\}_{n \geq 0}$ be an inverse system
of $A$-modules. Let $i \geq 0$ be an integer. Assume the dimension of $A$
is finite and that for every $m$ there exists an integer $m'(m) > m$
such that for all $\mathfrak p \in T$ we have
\begin{enumerate}
\item $H^{i - 1}_{\mathfrak p A_\mathfrak p}(M_{k, \mathfrak p})
\to H^{i - 1}_{\mathfrak p A_\mathfrak p}(M_{m, \mathfrak p})$
is zero for $k \geq m'(m)$, and
\item $ H^i_{\mathfrak p A_\mathfrak p}(M_{k, \mathfrak p}) \to
H^i_{\mathfrak p A_\mathfrak p}(M_{m, \mathfrak p})$
has image $G(\mathfrak p, m)$ independent of $k \geq m'(m)$ and moreover
$G(\mathfrak p, m)$ maps injectively into
$H^i_{\mathfrak p A_\mathfrak p}(M_{0, \mathfrak p})$.
\end{enumerate}
Then there exists an integer $m_0$ such that for every $m \geq m_0$
there exists an integer $m''(m) > m$ such that
for $k \geq m''(m)$ the image of $H^i_T(M_k) \to H^i_T(M_m)$
maps injectively into $H^i_T(M_{m_0})$.
\end{lemma}

\begin{proof}
We first make a general remark: suppose we have an exact
sequence
$$
(A_n) \to (B_n) \to (C_n) \to (D_n)
$$
of inverse systems of abelian groups. Suppose that there exists
an integer $m_0$ such that for every $m \geq m_0$
there exists an integer $m'(m) > m$ such that the maps
$$
\Im(B_k \to B_m) \longrightarrow B_{m_0}
\quad\text{and}\quad
\Im(D_k \to D_m) \longrightarrow D_{m_0}
$$
are injective for $k \geq m'(m)$ and $A_k \to A_m$ is zero
for $k \geq m'(m)$. Then for $m \geq m'(m_0)$ and $k \geq m'(m'(m))$
the map
$$
\Im(C_k \to C_m) \to C_{m'(m_0)}
$$
is injective. Namely, let $c_0 \in C_m$ be the image of $c_3 \in C_k$
and say $c_0$ maps to zero in $C_{m'(m_0)}$. Picture
$$
C_k \to C_{m'(m'(m))} \to C_{m'(m)} \to C_m \to C_{m'(m_0)},\quad
c_3 \mapsto c_2 \mapsto c_1 \mapsto c_0 \mapsto 0
$$
We have to show $c_0 = 0$.
The image $d_3$ of $c_3$ maps to zero in $C_{m_0}$ and hence
we see that the image $d_1 \in D_{m'(m)}$ is zero.
Thus we can choose $b_1 \in B_{m'(m)}$ mapping to
the image $c_1$. Since $c_3$ maps to zero in
$C_{m'(m_0)}$ we find an element $a_{-1} \in A_{m'(m_0)}$
which maps to the image $b_{-1} \in B_{m'(m_0)}$ of $b_1$.
Since $a_{-1}$ maps to zero in $A_{m_0}$ we conclude that
$b_1$ maps to zero in $B_{m_0}$. Thus the image $b_0 \in B_m$
is zero which of course implies $c_0 = 0$ as desired.

\medskip\noindent
We will prove the lemma by induction on $\dim(T)$ which is
finite because $\dim(A)$ is finite. Let $T' \subset T$ be
the set of nonminimal primes in $T$. Then $T'$ is a subset
of $\Spec(A)$ stable under specialization
and the hyptoheses of the lemma apply to $T'$.
Since $\dim(T') < \dim(T)$ we know the lemma holds for $T'$.
For every $A$-module $M$ there is an exact sequence
$$
\bigoplus\nolimits_{Z, f} H^1_f(H^{i - 1}_Z(M)) \to
H^i_{T'}(M) \to H^i_T(M) \to
\bigoplus\nolimits_{\mathfrak p \in T \setminus T'}
H^i_{\mathfrak p A_\mathfrak p}(M_\mathfrak p)
$$
by Lemma \ref{lemma-filter-local-cohomology}.
Thus we conclude by the initial remark of the proof
and the fact that we've seen the system of groups
$$
\left\{\bigoplus\nolimits_{Z, f} H^1_f(H^{i - 1}_Z(M_n))\right\}_{n \geq 0}
$$
is pro-zero in Lemma \ref{lemma-zero} (this uses that the function
$m''(m)$ in that lemma for $H^{i - 1}_Z(M)$
can be chosen independently of $Z$).
\end{proof}








\section{Finiteness of local cohomology, I}
\label{section-finiteness}

\noindent
We will follow Faltings approach to finiteness of local cohomology
modules, see \cite{Faltings-annulators} and \cite{Faltings-finiteness}.
Here is a lemma which shows that it suffices to prove
local cohomology modules have an annihilator in order to prove that
they are finite modules.

\begin{lemma}
\label{lemma-check-finiteness-local-cohomology-by-annihilator}
\begin{reference}
\cite[Lemma 3]{Faltings-annulators}
\end{reference}
Let $A$ be a Noetherian ring. Let $T \subset \Spec(A)$ be a subset stable
under specialization. Let $M$ be a finite $A$-module. Let $n \geq 0$.
The following are equivalent
\begin{enumerate}
\item $H^i_T(M)$ is finite for $i \leq n$,
\item there exists an ideal $J \subset A$ with $V(J) \subset T$
such that $J$ annihilates $H^i_T(M)$ for $i \leq n$.
\end{enumerate}
If $T = V(I)$ for an ideal $I \subset A$, then these are also
equivalent to
\begin{enumerate}
\item[(3)] there exists an $e \geq 0$ such that $I^e$ annihilates
$H^i_Z(M)$ for $i \leq n$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove the equivalence of (1) and (2) by induction on $n$.
For $n = 0$ we have $H^0_T(M) \subset M$ is finite. Hence (1) is true.
Since $H^0_T(M) = \colim H^0_{V(J)}(M)$ with $J$ as in (2) we see
that (2) is true. Assume that $n > 0$.

\medskip\noindent
Assume (1) is true. Recall that $H^i_J(M) = H^i_{V(J)}(M)$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-noetherian}.
Thus $H^i_T(M) = \colim H^i_J(M)$ where the colimit is over ideals
$J \subset A$ with $V(J) \subset T$, see
Lemma \ref{lemma-adjoint-ext}. Since $H^i_T(M)$ is finitely generated
for $i \leq n$ we can find a $J \subset A$ as in (2) such that
$H^i_J(M) \to H^i_T(M)$ is surjective for $i \leq n$.
Thus the finite list of generators are $J$-power torsion elements
and we see that (2) holds with $J$ replaced by some power.

\medskip\noindent
Assume we have $J$ as in (2). Let $N = H^0_T(M)$ and $M' = M/N$.
By construction of $R\Gamma_T$ we find that
$H^i_T(N) = 0$ for $i > 0$ and $H^0_T(N) = N$, see
Remark \ref{remark-upshot}. Thus we find that
$H^0_T(M') = 0$ and $H^i_T(M') = H^i_T(M)$ for $i > 0$.
We conclude that we may replace $M$ by $M'$.
Thus we may assume that $H^0_T(M) = 0$.
This means that the finite set of associated primes of $M$
are not in $T$. By prime avoidance (Algebra, Lemma \ref{algebra-lemma-silly})
we can find $f \in J$ not contained in any of the associated primes of $M$.
Then the long exact local cohomology sequence associated to the short
exact sequence
$$
0 \to M \to M \to M/fM \to 0
$$
turns into short exact sequences
$$
0 \to H^i_T(M) \to H^i_T(M/fM) \to H^{i + 1}_T(M) \to 0
$$
for $i < n$. We conclude that $J^2$ annihilates $H^i_T(M/fM)$
for $i < n$. By induction hypothesis we see that $H^i_T(M/fM)$
is finite for $i < n$. Using the short exact sequence once more
we see that $H^{i + 1}_T(M)$ is finite for $i < n$ as desired.

\medskip\noindent
We omit the proof of the equivalence of (2) and (3)
in case $T = V(I)$.
\end{proof}

\noindent
The following result of Faltings allows us to prove finiteness
of local cohomology at the level of local rings.

\begin{lemma}
\label{lemma-check-finiteness-local-cohomology-locally}
\begin{reference}
This is a special case of \cite[Satz 1]{Faltings-finiteness}.
\end{reference}
Let $A$ be a Noetherian ring, $I \subset A$ an ideal, $M$ a finite
$A$-module, and $n \geq 0$ an integer. Let $Z = V(I)$.
The following are equivalent
\begin{enumerate}
\item the modules $H^i_Z(M)$ are finite for $i \leq n$, and
\item for all $\mathfrak p \in \Spec(A)$ the modules
$H^i_Z(M)_\mathfrak p$, $i \leq n$ are finite $A_\mathfrak p$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is immediate. We prove the converse
by induction on $n$. The case $n = 0$ is clear because both (1) and
(2) are always true in that case.

\medskip\noindent
Assume $n > 0$ and that (2) is true. Let $N = H^0_Z(M)$ and $M' = M/N$.
By Dualizing Complexes, Lemma \ref{dualizing-lemma-divide-by-torsion}
we may replace $M$ by $M'$.
Thus we may assume that $H^0_Z(M) = 0$.
This means that $\text{depth}_I(M) > 0$
(Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}).
Pick $f \in I$ a nonzerodivisor on $M$ and consider the short
exact sequence
$$
0 \to M \to M \to M/fM \to 0
$$
which produces a long exact sequence
$$
0 \to H^0_Z(M/fM) \to H^1_Z(M) \to H^1_Z(M) \to H^1_Z(M/fM) \to
H^2_Z(M) \to \ldots
$$
and similarly after localization. Thus assumption (2) implies that
the modules $H^i_Z(M/fM)_\mathfrak p$ are finite for $i < n$. Hence
by induction assumption $H^i_Z(M/fM)$ are finite for $i < n$.

\medskip\noindent
Let $\mathfrak p$ be a prime of $A$ which is associated to
$H^i_Z(M)$ for some $i \leq n$. Say $\mathfrak p$ is the annihilator
of the element $x \in H^i_Z(M)$. Then $\mathfrak p \in Z$, hence
$f \in \mathfrak p$. Thus $fx = 0$ and hence $x$ comes from an
element of $H^{i - 1}_Z(M/fM)$ by the boundary map $\delta$ in the long
exact sequence above. It follows that $\mathfrak p$ is an associated
prime of the finite module $\Im(\delta)$. We conclude that
$\text{Ass}(H^i_Z(M))$ is finite for $i \leq n$, see
Algebra, Lemma \ref{algebra-lemma-finite-ass}.

\medskip\noindent
Recall that
$$
H^i_Z(M) \subset
\prod\nolimits_{\mathfrak p \in \text{Ass}(H^i_Z(M))}
H^i_Z(M)_\mathfrak p
$$
by Algebra, Lemma \ref{algebra-lemma-zero-at-ass-zero}. Since by
assumption the modules on the right hand side are finite and $I$-power
torsion, we can find integers $e_{\mathfrak p, i} \geq 0$, $i \leq n$,
$\mathfrak p \in \text{Ass}(H^i_Z(M))$ such that
$I^{e_{\mathfrak p, i}}$ annihilates $H^i_Z(M)_\mathfrak p$. We conclude
that $I^e$ with $e = \max\{e_{\mathfrak p, i}\}$ annihilates $H^i_Z(M)$
for $i \leq n$. By
Lemma \ref{lemma-check-finiteness-local-cohomology-by-annihilator}
we see that $H^i_Z(M)$ is finite for $i \leq n$.
\end{proof}

\begin{lemma}
\label{lemma-annihilate-local-cohomology}
Let $A$ be a ring and let $J \subset I \subset A$ be finitely generated ideals.
Let $i \geq 0$ be an integer. Set $Z = V(I)$. If
$H^i_Z(A)$ is annihilated by $J^n$ for some $n$, then
$H^i_Z(M)$ annihilated by $J^m$ for some $m = m(M)$
for every finitely presented $A$-module $M$ such that
$M_f$ is a finite locally free $A_f$-module for all $f \in I$.
\end{lemma}

\begin{proof}
Consider the annihilator $\mathfrak a$ of $H^i_Z(M)$.
Let $\mathfrak p \subset A$ with $\mathfrak p \not \in Z$.
By assumption there exists an $f \in I$, $f \not \in \mathfrak p$
and an isomorphism $\varphi : A_f^{\oplus r} \to M_f$
of $A_f$-modules. Clearing denominators (and using that
$M$ is of finite presentation) we find maps
$$
a : A^{\oplus r} \longrightarrow M
\quad\text{and}\quad
b : M \longrightarrow A^{\oplus r}
$$
with $a_f = f^N \varphi$ and $b_f = f^N \varphi^{-1}$ for some $N$.
Moreover we may assume that $a \circ b$ and $b \circ a$ are equal to
multiplication by $f^{2N}$. Thus we see that $H^i_Z(M)$ is annihilated by
$f^{2N}J^n$, i.e., $f^{2N}J^n \subset \mathfrak a$.

\medskip\noindent
As $U = \Spec(A) \setminus Z$ is quasi-compact we can find finitely many
$f_1, \ldots, f_t$ and $N_1, \ldots, N_t$ such that $U = \bigcup D(f_j)$ and
$f_j^{2N_j}J^n \subset \mathfrak a$. Then $V(I) = V(f_1, \ldots, f_t)$
and since $I$ is finitely generated we conclude
$I^M \subset (f_1, \ldots, f_t)$ for some $M$.
All in all we see that $J^m \subset \mathfrak a$ for
$m \gg 0$, for example $m = M (2N_1 + \ldots + 2N_t) n$ will do.
\end{proof}

\begin{lemma}
\label{lemma-local-finiteness-for-finite-locally-free}
Let $A$ be a Noetherian ring. Let $I \subset A$ be an ideal. Set $Z = V(I)$.
Let $n \geq 0$ be an integer. If $H^i_Z(A)$ is finite for $0 \leq i \leq n$,
then the same is true for $H^i_Z(M)$, $0 \leq i \leq n$ for
any finite $A$-module $M$ such that $M_f$ is a finite locally free
$A_f$-module for all $f \in I$.
\end{lemma}

\begin{proof}
The assumption that $H^i_Z(A)$ is finite for $0 \leq i \leq n$
implies there exists an $e \geq 0$ such that $I^e$ annihilates
$H^i_Z(A)$ for $0 \leq i \leq n$, see
Lemma \ref{lemma-check-finiteness-local-cohomology-by-annihilator}.
Then Lemma \ref{lemma-annihilate-local-cohomology}
implies that $H^i_Z(M)$, $0 \leq i \leq n$ is annihilated
by $I^m$ for some $m = m(M, i)$. We may take the same $m$
for all $0 \leq i \leq n$. Then
Lemma \ref{lemma-check-finiteness-local-cohomology-by-annihilator}
implies that $H^i_Z(M)$ is finite for $0 \leq i \leq n$
as desired.
\end{proof}





\section{Finiteness of pushforwards, I}
\label{section-finiteness-pushforward}

\noindent
In this section we discuss the easiest nontrivial case of the
finiteness theorem, namely, the finiteness of the first local
cohomology or what is equivalent, finiteness of $j_*\mathcal{F}$
where $j : U \to X$ is an open immersion, $X$ is locally Noetherian, and
$\mathcal{F}$ is a coherent sheaf on $U$. Following a method of Koll\'ar
(\cite{Kollar-variants} and \cite{Kollar-local-global-hulls})
we find a necessary and sufficient condition, see
Proposition \ref{proposition-kollar}. The reader who is interested
in higher direct images or higher local cohomology groups should skip
ahead to Section \ref{section-finiteness-pushforward-II} or
Section \ref{section-finiteness-II} (which are developed
independently of the rest of this section).

\begin{lemma}
\label{lemma-check-finiteness-pushforward-on-associated-points}
Let $X$ be a locally Noetherian scheme. Let $j : U \to X$ be the inclusion
of an open subscheme with complement $Z$. For $x \in U$ let
$i_x : W_x \to U$ be the integral closed subscheme with generic point $x$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
The following are equivalent
\begin{enumerate}
\item for all $x \in \text{Ass}(\mathcal{F})$ the
$\mathcal{O}_X$-module $j_*i_{x, *}\mathcal{O}_{W_x}$ is coherent,
\item $j_*\mathcal{F}$ is coherent.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove that (1) implies (2). Assume (1) holds.
The statement is local on $X$, hence we may assume $X$ is affine.
Then $U$ is quasi-compact, hence $\text{Ass}(\mathcal{F})$ is finite
(Divisors, Lemma \ref{divisors-lemma-finite-ass}). Thus we may argue by
induction on the number of associated points. Let $x \in U$ be a generic
point of an irreducible component of the support of $\mathcal{F}$.
By Divisors, Lemma \ref{divisors-lemma-finite-ass} we have
$x \in \text{Ass}(\mathcal{F})$. By our choice of $x$ we have
$\dim(\mathcal{F}_x) = 0$ as $\mathcal{O}_{X, x}$-module.
Hence $\mathcal{F}_x$ has finite length as an $\mathcal{O}_{X, x}$-module
(Algebra, Lemma \ref{algebra-lemma-support-point}).
Thus we may use induction on this length.

\medskip\noindent
Set $\mathcal{G} = j_*i_{x, *}\mathcal{O}_{W_x}$. This is a coherent
$\mathcal{O}_X$-module by assumption. We have $\mathcal{G}_x = \kappa(x)$.
Choose a nonzero map
$\varphi_x : \mathcal{F}_x \to \kappa(x) = \mathcal{G}_x$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-map-stalks-local-map}
there is an open $x \in V \subset U$ and a map
$\varphi_V : \mathcal{F}|_V \to \mathcal{G}|_V$ whose stalk
at $x$ is $\varphi_x$. Choose $f \in \Gamma(X, \mathcal{O}_X)$
which does not vanish at $x$ such that $D(f) \subset V$. By
Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
(for example) we see that $\varphi_V$ extends to
$f^n\mathcal{F} \to \mathcal{G}|_U$ for some $n$.
Precomposing with multiplication by $f^n$ we obtain a map
$\mathcal{F} \to \mathcal{G}|_U$ whose stalk at $x$ is nonzero.
Let $\mathcal{F}' \subset \mathcal{F}$ be the kernel.
Note that $\text{Ass}(\mathcal{F}') \subset \text{Ass}(\mathcal{F})$, see
Divisors, Lemma \ref{divisors-lemma-ses-ass}.
Since
$\text{length}_{\mathcal{O}_{X, x}}(\mathcal{F}') = 
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{F}) - 1$
we may apply the
induction hypothesis to conclude $j_*\mathcal{F}'$ is coherent.
Since $\mathcal{G} = j_*(\mathcal{G}|_U) = j_*i_{x, *}\mathcal{O}_{W_x}$
is coherent, we can consider the exact sequence
$$
0 \to j_*\mathcal{F}' \to j_*\mathcal{F} \to \mathcal{G}
$$
By Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
the sheaf $j_*\mathcal{F}$ is quasi-coherent.
Hence the image of $j_*\mathcal{F}$ in $j_*(\mathcal{G}|_U)$
is coherent by Cohomology of Schemes, Lemma
\ref{coherent-lemma-coherent-Noetherian-quasi-coherent-sub-quotient}.
Finally, $j_*\mathcal{F}$ is coherent by
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.

\medskip\noindent
Assume (2) holds. Exactly in the same manner as above we reduce
to the case $X$ affine. We pick $x \in \text{Ass}(\mathcal{F})$
and we set $\mathcal{G} = j_*i_{x, *}\mathcal{O}_{W_x}$.
Then we choose a nonzero map
$\varphi_x : \mathcal{G}_x = \kappa(x) \to \mathcal{F}_x$
which exists exactly because $x$ is an associated point of $\mathcal{F}$.
Arguing exactly as above we may assume $\varphi_x$
extends to an $\mathcal{O}_U$-module map
$\varphi : \mathcal{G}|_U \to \mathcal{F}$.
Then $\varphi$ is injective (for example by
Divisors, Lemma \ref{divisors-lemma-check-injective-on-ass})
and we find and injective map
$\mathcal{G} = j_*(\mathcal{G}|_V) \to j_*\mathcal{F}$.
Thus (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-finiteness-pushforwards-and-H1-local}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
Set $X = \Spec(A)$, $Z = V(I)$, $U = X \setminus Z$, and $j : U \to X$
the inclusion morphism. Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
Then
\begin{enumerate}
\item there exists a finite $A$-module $M$ such that $\mathcal{F}$ is the
restriction of $\widetilde{M}$ to $U$,
\item given $M$ there is an exact sequence
$$
0 \to H^0_Z(M) \to M \to H^0(U, \mathcal{F}) \to H^1_Z(M) \to 0
$$
and isomorphisms $H^p(U, \mathcal{F}) = H^{p + 1}_Z(M)$ for $p \geq 1$,
\item given $M$ and $p \geq 0$ the following are equivalent
\begin{enumerate}
\item $R^pj_*\mathcal{F}$ is coherent,
\item $H^p(U, \mathcal{F})$ is a finite $A$-module,
\item $H^{p + 1}_Z(M)$ is a finite $A$-module,
\end{enumerate}
\item if the equivalent conditions in (3) hold for $p = 0$, we may take
$M = \Gamma(U, \mathcal{F})$ in which case we have $H^0_Z(M) = H^1_Z(M) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Properties, Lemma \ref{properties-lemma-extend-finite-presentation}
there exists a coherent $\mathcal{O}_X$-module $\mathcal{F}'$
whose restriction to $U$ is isomorphic to $\mathcal{F}$.
Say $\mathcal{F}'$ corresponds to the finite $A$-module $M$
as in (1).
Note that $R^pj_*\mathcal{F}$ is quasi-coherent
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images})
and corresponds to the $A$-module $H^p(U, \mathcal{F})$.
By Lemma \ref{lemma-local-cohomology-is-local-cohomology}
and the general facts in
Cohomology, Section \ref{cohomology-section-cohomology-support}
we obtain an exact sequence
$$
0 \to H^0_Z(M) \to M \to H^0(U, \mathcal{F}) \to H^1_Z(M) \to 0
$$
and isomorphisms $H^p(U, \mathcal{F}) = H^{p + 1}_Z(M)$ for $p \geq 1$.
Here we use that $H^j(X, \mathcal{F}') = 0$ for $j > 0$ as $X$ is affine
and $\mathcal{F}'$ is quasi-coherent (Cohomology of Schemes,
Lemma \ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}).
This proves (2).
Parts (3) and (4) are straightforward from (2); see also
Lemma \ref{lemma-local-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-finiteness-pushforward}
Let $X$ be a locally Noetherian scheme.
Let $j : U \to X$ be the inclusion of an
open subscheme with complement $Z$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_U$-module. Assume
\begin{enumerate}
\item $X$ is Nagata,
\item $X$ is universally catenary, and
\item for $x \in \text{Ass}(\mathcal{F})$ and
$z \in Z \cap \overline{\{x\}}$ we have
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) \geq 2$.
\end{enumerate}
Then $j_*\mathcal{F}$ is coherent.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-check-finiteness-pushforward-on-associated-points}
it suffices to prove $j_*i_{x, *}\mathcal{O}_{W_x}$ is coherent
for $x \in \text{Ass}(\mathcal{F})$.
Let $\pi : Y \to X$ be the normalization of $X$ in $\Spec(\kappa(x))$, see
Morphisms, Section \ref{morphisms-section-normalization}. By
Morphisms, Lemma \ref{morphisms-lemma-nagata-normalization-finite-general}
the morphism $\pi$ is finite. Since $\pi$ is finite
$\mathcal{G} = \pi_*\mathcal{O}_Y$ is a coherent $\mathcal{O}_X$-module by
Cohomology of Schemes, Lemma \ref{coherent-lemma-finite-pushforward-coherent}.
Observe that $W_x = U \cap \pi(Y)$. Thus
$\pi|_{\pi^{-1}(U)} : \pi^{-1}(U) \to U$ factors through $i_x : W_x \to U$
and we obtain a canonical map
$$
i_{x, *}\mathcal{O}_{W_x}
\longrightarrow
(\pi|_{\pi^{-1}(U)})_*(\mathcal{O}_{\pi^{-1}(U)}) =
(\pi_*\mathcal{O}_Y)|_U = \mathcal{G}|_U
$$
This map is injective (for example by Divisors, Lemma
\ref{divisors-lemma-check-injective-on-ass}). Hence
$j_*i_{x, *}\mathcal{O}_{W_x} \subset j_*\mathcal{G}|_U$
and it suffices to show that $j_*\mathcal{G}|_U$ is coherent.

\medskip\noindent
It remains to prove that $j_*(\mathcal{G}|_U)$ is coherent. We claim
Divisors, Lemma \ref{divisors-lemma-depth-2-hartog}
applies to
$$
\mathcal{G} \longrightarrow j_*(\mathcal{G}|_U)
$$
which finishes the proof. It suffices to show that
$\text{depth}(\mathcal{G}_z) \geq 2$ for $z \in Z$.
Let $y_1, \ldots, y_n \in Y$ be the points mapping to $z$.
By Algebra, Lemma \ref{algebra-lemma-depth-goes-down-finite}
it suffices to show that
$\text{depth}(\mathcal{O}_{Y, y_i}) \geq 2$ for $i = 1, \ldots, n$.
If not, then by Properties, Lemma \ref{properties-lemma-criterion-normal}
we see that $\dim(\mathcal{O}_{Y, y_i}) = 1$ for some $i$.
This is impossible by the dimension formula
(Morphisms, Lemma \ref{morphisms-lemma-dimension-formula})
for $\pi : Y \to \overline{\{x\}}$ and assumption (3).
\end{proof}

\begin{lemma}
\label{lemma-sharp-finiteness-pushforward}
Let $X$ be an integral locally Noetherian scheme. Let $j : U \to X$
be the inclusion of a nonempty open subscheme with complement $Z$. Assume
that for all $z \in Z$ and any associated prime $\mathfrak p$ of
the completion $\mathcal{O}_{X, z}^\wedge$
we have $\dim(\mathcal{O}_{X, z}^\wedge/\mathfrak p) \geq 2$.
Then $j_*\mathcal{O}_U$ is coherent.
\end{lemma}

\begin{proof}
We may assume $X$ is affine.
Using Lemmas \ref{lemma-check-finiteness-local-cohomology-locally} and
\ref{lemma-finiteness-pushforwards-and-H1-local} we reduce to
$X = \Spec(A)$ where $(A, \mathfrak m)$ is a Noetherian local domain
and $\mathfrak m \in Z$.
Then we can use induction on $d = \dim(A)$.
(The base case is $d = 0, 1$ which do not happen by
our assumption on the local rings.)
Set $V = \Spec(A) \setminus \{\mathfrak m\}$.
Observe that the local rings of $V$ have dimension strictly smaller than $d$.
Repeating the arguments for $j' : U \to V$ we
and using induction we conclude that $j'_*\mathcal{O}_U$ is
a coherent $\mathcal{O}_V$-module.
Pick a nonzero $f \in A$ which vanishes on $Z$.
Since $D(f) \cap V \subset U$ we find an $n$ such that
multiplication by $f^n$ on $U$ extends to a map
$f^n : j'_*\mathcal{O}_U \to \mathcal{O}_V$ over $V$
(for example by Cohomology of Schemes, Lemma
\ref{coherent-lemma-homs-over-open}). This map is injective
hence there is an injective map
$$
j_*\mathcal{O}_U = j''_* j'_* \mathcal{O}_U \to j''_*\mathcal{O}_V
$$
on $X$ where $j'' : V \to X$ is the inclusion morphism.
Hence it suffices to show that $j''_*\mathcal{O}_V$ is coherent.
In other words, we may assume that $X$ is the spectrum
of a local Noetherian domain and that $Z$
consists of the closed point.

\medskip\noindent
Assume $X = \Spec(A)$ with $(A, \mathfrak m)$ local and $Z = \{\mathfrak m\}$.
Let $A^\wedge$ be the completion of $A$.
Set $X^\wedge = \Spec(A^\wedge)$, $Z^\wedge = \{\mathfrak m^\wedge\}$,
$U^\wedge = X^\wedge \setminus Z^\wedge$, and
$\mathcal{F}^\wedge = \mathcal{O}_{U^\wedge}$.
The ring $A^\wedge$ is universally catenary and Nagata (Algebra, Remark
\ref{algebra-remark-Noetherian-complete-local-ring-universally-catenary} and
Lemma \ref{algebra-lemma-Noetherian-complete-local-Nagata}).
Moreover, condition (3) of Lemma \ref{lemma-finiteness-pushforward}
for $X^\wedge, Z^\wedge, U^\wedge, \mathcal{F}^\wedge$
holds by assumption! Thus we see that
$(U^\wedge \to X^\wedge)_*\mathcal{O}_{U^\wedge}$
is coherent. Since the morphism $c : X^\wedge \to X$
is flat we conclude that the pullback of $j_*\mathcal{O}_U$ is
$(U^\wedge \to X^\wedge)_*\mathcal{O}_{U^\wedge}$
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-flat-base-change-cohomology}).
Finally, since $c$ is faithfully flat we conclude that
$j_*\mathcal{O}_U$ is coherent by
Descent, Lemma \ref{descent-lemma-finite-type-descends}.
\end{proof}

\begin{remark}
\label{remark-closure}
Let $j : U \to X$ be an open immersion of locally Noetherian schemes.
Let $x \in U$. Let $i_x : W_x \to U$ be the integral closed subscheme
with generic point $x$ and let $\overline{\{x\}}$ be the closure in $X$.
Then we have a commutative diagram
$$
\xymatrix{
W_x \ar[d]_{i_x} \ar[r]_{j'} & \overline{\{x\}} \ar[d]^i \\
U \ar[r]^j & X
}
$$
We have $j_*i_{x, *}\mathcal{O}_{W_x} = i_*j'_*\mathcal{O}_{W_x}$.
As the left vertical arrow is a closed immersion we see that
$j_*i_{x, *}\mathcal{O}_{W_x}$ is coherent if and only of
$j'_*\mathcal{O}_{W_x}$ is coherent.
\end{remark}

\begin{remark}
\label{remark-no-finiteness-pushforward}
Let $X$ be a locally Noetherian scheme. Let $j : U \to X$ be the inclusion of
an open subscheme with complement $Z$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_U$-module. If there exists an $x \in \text{Ass}(\mathcal{F})$ and
$z \in Z \cap \overline{\{x\}}$ such that
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) \leq 1$, then $j_*\mathcal{F}$ is not
coherent. To prove this we can do a flat base change to the spectrum
of $\mathcal{O}_{X, z}$. Let $X' = \overline{\{x\}}$.
The assumption implies $\mathcal{O}_{X' \cap U} \subset \mathcal{F}$.
Thus it suffices to see that $j_*\mathcal{O}_{X' \cap U}$ is not
coherent. This is clear because $X' = \{x, z\}$, hence
$j_*\mathcal{O}_{X' \cap U}$ corresponds to $\kappa(x)$ as an
$\mathcal{O}_{X, z}$-module which cannot be finite as $x$ is not
a closed point.

\medskip\noindent
In fact, the converse of Lemma \ref{lemma-sharp-finiteness-pushforward}
holds true: given an open immersion $j : U \to X$ of integral Noetherian
schemes and there exists a $z \in X \setminus U$ and an associated prime
$\mathfrak p$ of the completion $\mathcal{O}_{X, z}^\wedge$
with $\dim(\mathcal{O}_{X, z}^\wedge/\mathfrak p) = 1$,
then $j_*\mathcal{O}_U$ is not coherent. Namely, you can pass to
the local ring, you can enlarge $U$ to the punctured spectrum,
you can pass to the completion, and then the argument above gives
the nonfiniteness.
\end{remark}

\begin{proposition}[Koll\'ar]
\label{proposition-kollar}
\begin{reference}
Theorem of Koll\'ar stated in an email dated Wed, 1 Jul 2015.
\end{reference}
\begin{slogan}
Weak analogue of Hartogs' Theorem: On Noetherian schemes, the
restriction of a coherent sheaf to an open set with complement
of codimension 2 in the sheaf's support, is coherent.
\end{slogan}
Let $j : U \to X$ be an open immersion of locally Noetherian schemes
with complement $Z$. Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
The following are equivalent
\begin{enumerate}
\item $j_*\mathcal{F}$ is coherent,
\item for $x \in \text{Ass}(\mathcal{F})$ and
$z \in Z \cap \overline{\{x\}}$ and any associated prime
$\mathfrak p$ of the completion $\mathcal{O}_{\overline{\{x\}}, z}^\wedge$
we have $\dim(\mathcal{O}_{\overline{\{x\}}, z}^\wedge/\mathfrak p) \geq 2$.
\end{enumerate}
\end{proposition}

\begin{proof}
If (2) holds we get (1) by a combination of
Lemmas \ref{lemma-check-finiteness-pushforward-on-associated-points},
Remark \ref{remark-closure}, and
Lemma \ref{lemma-sharp-finiteness-pushforward}.
If (2) does not hold, then $j_*i_{x, *}\mathcal{O}_{W_x}$ is not finite
for some $x \in \text{Ass}(\mathcal{F})$ by the discussion in
Remark \ref{remark-no-finiteness-pushforward}
(and Remark \ref{remark-closure}).
Thus $j_*\mathcal{F}$ is not coherent by
Lemma \ref{lemma-check-finiteness-pushforward-on-associated-points}.
\end{proof}

\begin{lemma}
\label{lemma-kollar-finiteness-H1-local}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
Set $Z = V(I)$. Let $M$ be a finite $A$-module. The following
are equivalent
\begin{enumerate}
\item $H^1_Z(M)$ is a finite $A$-module, and
\item for all $\mathfrak p \in \text{Ass}(M)$, $\mathfrak p \not \in Z$
and all $\mathfrak q \in V(\mathfrak p + I)$ the completion of
$(A/\mathfrak p)_\mathfrak q$ does not have associated primes
of dimension $1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows immediately from Proposition \ref{proposition-kollar}
via Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}.
\end{proof}

\noindent
The formulation in the following lemma has the advantage that conditions
(1) and (2) are inherited by schemes of finite type over $X$.
Moreover, this is the form of finiteness which we will generalize
to higher direct images in Section \ref{section-finiteness-pushforward-II}.

\begin{lemma}
\label{lemma-finiteness-pushforward-general}
Let $X$ be a locally Noetherian scheme.
Let $j : U \to X$ be the inclusion of an
open subscheme with complement $Z$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_U$-module. Assume
\begin{enumerate}
\item $X$ is universally catenary,
\item for every $z \in Z$ the formal fibres of $\mathcal{O}_{X, z}$
are $(S_1)$.
\end{enumerate}
In this situation the following are equivalent
\begin{enumerate}
\item[(a)] for $x \in \text{Ass}(\mathcal{F})$ and
$z \in Z \cap \overline{\{x\}}$ we have
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) \geq 2$, and
\item[(b)] $j_*\mathcal{F}$ is coherent.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $x \in \text{Ass}(\mathcal{F})$. By Proposition \ref{proposition-kollar}
it suffices to check that $A = \mathcal{O}_{\overline{\{x\}}, z}$ satisfies
the condition of the proposition on associated primes of its completion
if and only if $\dim(A) \geq 2$.
Observe that $A$ is universally catenary (this is clear)
and that its formal fibres are $(S_1)$ as follows from
More on Algebra, Lemma \ref{more-algebra-lemma-formal-fibres-normal} and
Proposition \ref{more-algebra-proposition-finite-type-over-P-ring}.
Let $\mathfrak p' \subset A^\wedge$ be an associated prime.
As $A \to A^\wedge$ is flat,
by Algebra, Lemma \ref{algebra-lemma-bourbaki},
we find that $\mathfrak p'$ lies over $(0) \subset A$.
The formal fibre $A^\wedge \otimes_A F$ is $(S_1)$ where $F$ is
the fraction field of $A$. We conclude that $\mathfrak p'$ is a
minimal prime, see
Algebra, Lemma \ref{algebra-lemma-criterion-no-embedded-primes}.
Since $A$ is universally catenary it is formally catenary
by More on Algebra, Proposition \ref{more-algebra-proposition-ratliff}.
Hence $\dim(A^\wedge/\mathfrak p') = \dim(A)$ which
proves the equivalence.
\end{proof}






\section{Depth and dimension}
\label{section-dept-dimension}

\noindent
Some helper lemmas.

\begin{lemma}
\label{lemma-ideal-depth-function}
Let $A$ be a Noetherian ring. Let $I \subset A$ be an ideal.
Let $M$ be a finite $A$-module. Let $\mathfrak p \in V(I)$
be a prime ideal. Assume
$e = \text{depth}_{IA_\mathfrak p}(M_\mathfrak p) < \infty$.
Then there exists a nonempty open $U \subset V(\mathfrak p)$
such that $\text{depth}_{IA_\mathfrak q}(M_\mathfrak q) \geq e$
for all $\mathfrak q \in U$.
\end{lemma}

\begin{proof}
By definition of depth we have $IM_\mathfrak p \not = M_\mathfrak p$
and there exists an $M_\mathfrak p$-regular sequence
$f_1, \ldots, f_e \in IA_\mathfrak p$. After replacing $A$ by
a principal localization we may assume $f_1, \ldots, f_e \in I$
form an $M$-regular sequence, see
Algebra, Lemma \ref{algebra-lemma-regular-sequence-in-neighbourhood}.
Consider the module $M' = M/IM$. Since $\mathfrak p \in \text{Supp}(M')$
and since the support of a finite module is closed, we find
$V(\mathfrak p) \subset \text{Supp}(M')$. Thus
for $\mathfrak q \in V(\mathfrak p)$ we get
$IM_\mathfrak q \not = M_\mathfrak q$. Hence, using that
localization is exact, we see that
$\text{depth}_{IA_\mathfrak q}(M_\mathfrak q) \geq e$
for any $\mathfrak q \in V(I)$ by definition of depth.
\end{proof}

\begin{lemma}
\label{lemma-depth-function}
Let $A$ be a Noetherian ring. Let $M$ be a finite $A$-module.
Let $\mathfrak p$ be a prime ideal. Assume
$e = \text{depth}_{A_\mathfrak p}(M_\mathfrak p) < \infty$.
Then there exists a nonempty open $U \subset V(\mathfrak p)$
such that $\text{depth}_{A_\mathfrak q}(M_\mathfrak q) \geq e$
for all $\mathfrak q \in U$ and
for all but finitely many $\mathfrak q \in U$ we have
$\text{depth}_{A_\mathfrak q}(M_\mathfrak q) > e$.
\end{lemma}

\begin{proof}
By definition of depth we have $\mathfrak p M_\mathfrak p \not = M_\mathfrak p$
and there exists an $M_\mathfrak p$-regular sequence
$f_1, \ldots, f_e \in \mathfrak p A_\mathfrak p$. After replacing $A$ by
a principal localization we may assume $f_1, \ldots, f_e \in \mathfrak p$
form an $M$-regular sequence, see
Algebra, Lemma \ref{algebra-lemma-regular-sequence-in-neighbourhood}.
Consider the module $M' = M/(f_1, \ldots, f_e)M$.
Since $\mathfrak p \in \text{Supp}(M')$
and since the support of a finite module is closed, we find
$V(\mathfrak p) \subset \text{Supp}(M')$. Thus
for $\mathfrak q \in V(\mathfrak p)$ we get
$\mathfrak q M_\mathfrak q \not = M_\mathfrak q$. Hence, using that
localization is exact, we see that
$\text{depth}_{A_\mathfrak q}(M_\mathfrak q) \geq e$
for any $\mathfrak q \in V(I)$ by definition of depth.
Moreover, as soon as $\mathfrak q$ is not an associated
prime of the module $M'$, then the depth goes up.
Thus we see that the final statement holds by
Algebra, Lemma \ref{algebra-lemma-finite-ass}.
\end{proof}

\begin{lemma}
\label{lemma-finite-nr-points-next-S}
Let $X$ be a Noetherian scheme with dualizing complex $\omega_X^\bullet$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. Let $k \geq 0$
be an integer. Assume $\mathcal{F}$ is $(S_k)$.
Then there is a finite number of points $x \in X$ such that
$$
\text{depth}(\mathcal{F}_x) = k
\quad\text{and}\quad
\dim(\text{Supp}(\mathcal{F}_x)) > k
$$
\end{lemma}

\begin{proof}
If $k$ is zero, the lemma says that $\mathcal{F}$ has a finite number
of embedded associated points, which is follows from
Divisors, Lemma \ref{divisors-lemma-finite-ass}.
For higher $k$ we will use the assumption
that $X$ has a dualizing complex (some assumption
on $X$ and/or $\mathcal{F}$ is probably needed for the lemma to be true).
Let $\delta : X \to \mathbf{Z}$ be the dimension function associated
to $\omega_X^\bullet$, see Duality for Schemes, Lemma
\ref{duality-lemma-dimension-function-scheme}.
For $d \in \mathbf{Z}$ consider the set
$$
E(d) = \{x \in X \mid
\text{depth}(\mathcal{F}_x) = k,
\ \dim(\text{Supp}(\mathcal{F}_x)) > k,
\ \delta(x) \leq d\}
$$
With $\mathcal{E}^i$ as in
Duality for Schemes, Lemma
\ref{duality-lemma-sitting-in-degrees}
consider the closed subset
$$
Z(i) = \text{Supp}(\bigoplus\nolimits_{j \leq i} \mathcal{E}^j) =
\{x \in X \mid \text{depth}(\mathcal{F}_x) + \delta(x) \leq i \}
$$
of $X$. Then $E(d) \subset Z(d + k)$.

\medskip\noindent
Since $X$ is quasi-compact the function $\delta$ is bounded.
Hence for sufficiently small $d$ the set $E(d)$ is empty,
in particular finite. Assume $E(d + 1)$ is infinite but $E(d)$
finite to get a contradiction.
Let $Z$ be an irreducible component of the closure of
$E(d + 1)$ which contains infinitely many elements fof $E(d + 1)$.
Let $x \in Z$ be the generic point.
By properties of dimension
functions we have $\delta(x) > d + 1$.
Since $x \in Z(d + 1 + k)$ by closedness of this set we see that
$$
\text{depth}(\mathcal{F}_x) + \delta(x) \leq k + d + 1
$$
Hence $\text{depth}(\mathcal{F}_x) < k$.
Hence $\dim(\text{Supp}(\mathcal{F}_x)) = \text{depth}(\mathcal{F}_x)$
as $\mathcal{F}$ is $(S_k)$.
Now if $x \leadsto x' \in E(d + 1)$ is a specialization
with $x' \not \in E(d)$, then we have
$$
\delta(x) - \delta(x') =
\dim(\text{Supp}(\mathcal{F}_{x'})) -
\dim(\text{Supp}(\mathcal{F}_x))
$$
because $\delta$ is a dimension function on the spectrum of
$\mathcal{O}_{X, x'}$; small detail omitted. We conclude that
$$
\text{depth}(\mathcal{F}_x) + \delta(x) =
\dim(\text{Supp}(\mathcal{F}_x)) + \delta(x) =
\dim(\text{Supp}(\mathcal{F}_{x'})) + \delta(x') > k + d + 1
$$
which is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-sitting-in-degrees}
Let $(A, \mathfrak m)$ be a Noetherian local ring with
normalized dualizing complex $\omega_A^\bullet$.
Let $M$ be a finite $A$-module.
Set $E^i = \text{Ext}_A^{-i}(M, \omega_A^\bullet)$.
Then
\begin{enumerate}
\item $E^i$ is a finite $A$-module nonzero only for
$0 \leq i \leq \dim(\text{Supp}(M))$,
\item $\dim(\text{Supp}(E^i)) \leq i$,
\item $\text{depth}(M)$ is the smallest integer $\delta \geq 0$ such that
$E^\delta \not = 0$,
\item $\mathfrak p \in \text{Supp}(E^0 \oplus \ldots \oplus E^i)
\Leftrightarrow
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) \leq i$,
\item the annihilator of $E^i$ is equal to the annihilator
of $H^i_\mathfrak m(M)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Parts (1), (2), and (3) are copies of the statements in
Dualizing Complexes, Lemma \ref{dualizing-lemma-sitting-in-degrees}.
For a prime $\mathfrak p$ of $A$ we have that
$(\omega_A^\bullet)_\mathfrak p[-\dim(A/\mathfrak p)]$
is a normalized dualzing complex for $A_\mathfrak p$.
See Dualizing Complexes, Lemma \ref{dualizing-lemma-dimension-function}.
Thus
$$
E^i_\mathfrak p =
\text{Ext}^{-i}_A(M, \omega_A^\bullet)_\mathfrak p =
\text{Ext}^{-i + \dim(A/\mathfrak p)}_{A_\mathfrak p}
(M_\mathfrak p, (\omega_A^\bullet)_\mathfrak p[-\dim(A/\mathfrak p)])
$$
is zero for
$i - \dim(A/\mathfrak p) < \text{depth}_{A_\mathfrak p}(M_\mathfrak p)$
and nonzero for
$i = \dim(A/\mathfrak p) + \text{depth}_{A_\mathfrak p}(M_\mathfrak p)$
by part (3) over $A_\mathfrak p$.
This proves part (4).
If $E$ is an injective hull of the residue field of $A$, then we have
$$
\Hom_A(H^i_\mathfrak m(M), E) =
\text{Ext}^{-i}_A(M, \omega_A^\bullet)^\wedge =
(E^i)^\wedge =
E^i \otimes_A A^\wedge
$$
by the local duality theorem (in the form of
Dualizing Complexes, Lemma \ref{dualizing-lemma-special-case-local-duality}).
Since $A \to A^\wedge$ is faithfully flat, we find (5) is true by
Matlis duality
(Dualizing Complexes, Proposition \ref{dualizing-proposition-matlis}).
\end{proof}






\section{Improving coherent modules}
\label{section-improve}

\noindent
Similar constructions can be found in \cite{EGA} and more recently in
\cite{Kollar-local-global-hulls} and \cite{Kollar-variants}.

\begin{lemma}
\label{lemma-get-depth-1-along-Z}
Let $X$ be a Noetherian scheme. Let $Z \subset X$ be a closed subscheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Then there is a canonical surjection $\mathcal{F} \to \mathcal{F}'$
of coherent $\mathcal{O}_X$-modules such that
\begin{enumerate}
\item $\mathcal{F}|_{X \setminus Z} \to \mathcal{F}'|_{X \setminus Z}$
is an isomorphism,
\item for $z \in Z$ we have
$\text{depth}_{\mathcal{O}_{X, z}}(\mathcal{F}'_z) \geq 1$.
\end{enumerate}
If $f : Y \to X$ is a flat morphism with $Y$ Noetherian, then
$f^*\mathcal{F} \to f^*\mathcal{F}'$ is the corresponding
quotient for $f^{-1}(Z) \subset Y$ and $f^*\mathcal{F}$.
\end{lemma}

\begin{proof}
Condition (2) on $\mathcal{F}'$ just means that $\mathcal{F}'$
has no associated points in $Z$. For example if
$Z = X$, then $\mathcal{F}' = 0$ is the solution.
The statement on pullbacks follows from
Divisors, Lemma \ref{divisors-lemma-bourbaki}.

\medskip\noindent
Existence of $\mathcal{F} \to \mathcal{F}'$.
Let $\mathcal{G} \subset \mathcal{F}$
be the quasi-coherent subsheaf of sections supported in $Z$, see
Properties, Definition
\ref{properties-definition-subsheaf-sections-supported-on-closed}.
Set $\mathcal{F}' = \mathcal{F}/\mathcal{G}$.
Since $\mathcal{F}'$ does not have any nonzero section
whose support is contained in $Z$ we see that
$\text{Ass}(\mathcal{F}') \cap Z = \emptyset$
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-get-depth-2-along-Z}
Let $X$ be a Noetherian scheme. Let $Z \subset X$ be a closed subscheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. Denote
$j : X \setminus Z \to X$ the inclusion morphism.
Assume $\mathcal{F}' = j_*(\mathcal{F}|_{X \setminus Z})$
is coherent (Proposition \ref{proposition-kollar} and
Lemma \ref{lemma-finiteness-pushforward-general}).
Then $\mathcal{F} \to \mathcal{F}'$ is the unique map
of coherent $\mathcal{O}_X$-modules such that
\begin{enumerate}
\item $\mathcal{F}|_{X \setminus Z} \to \mathcal{F}'|_{X \setminus Z}$
is an isomorphism,
\item for $z \in Z$ we have
$\text{depth}_{\mathcal{O}_{X, z}}(\mathcal{F}'_z) \geq 2$.
\end{enumerate}
If $f : Y \to X$ is a flat morphism with $Y$ Noetherian, then
$f^*\mathcal{F} \to f^*\mathcal{F}'$ is the corresponding
map for $f^{-1}(Z) \subset Y$ and $f^*\mathcal{F}$.
\end{lemma}

\begin{proof}
Let us show that $\text{depth}_{\mathcal{O}_{X, z}}(\mathcal{F}'_z) \geq 2$
for $z \in Z$. Namely, let $U$ be the punctured spectrum of
$\mathcal{O}_{X, z}$. Then $U$ contains the inverse image of
$X \setminus Z$ along $\Spec(\mathcal{O}_{X, z}) \to X$.
Since $\mathcal{F}' = j_*(\mathcal{F}|_{X \setminus Z}) =
j_*(\mathcal{F}'|_{X \setminus Z})$, the same is true after
base change by the flat morphism $\Spec(\mathcal{O}_{X, z}) \to X$
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-flat-base-change-cohomology}).
A fortiori, the canonical map
$\mathcal{F}'_z \to H^0(U, \mathcal{F}'|_U)$
is an isomorphism. This means that $H^i_{\mathfrak m_z}(\mathcal{F}'_z)$
is zero for $i = 0, 1$, see
Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}.
Thus the depth is at least $2$.
We omit the proof of the other statements.
\end{proof}

\begin{lemma}
\label{lemma-make-S2-along-Z}
Let $X$ be a Noetherian scheme. Let $Z \subset X$ be a closed subscheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. Assume
$X$ is universally catenary and the formal fibres of
local rings have $(S_1)$.
Then there exists a canonical map $\mathcal{F} \to \mathcal{F}'$
of coherent $\mathcal{O}_X$-modules such that
\begin{enumerate}
\item $\mathcal{F}|_{X \setminus Z} \to \mathcal{F}'|_{X \setminus Z}$
is an isomorphism,
\item for $z \in Z$ we have either
\begin{enumerate}
\item $\text{depth}_{\mathcal{O}_{X, z}}(\mathcal{F}'_z) \geq 2$, or
\item there is an $x \in \text{Ass}(\mathcal{F}|_{X \setminus Z})$
with $z \in \overline{\{x\}}$ and
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) = 1$
and in this case $\mathcal{F}_z \to \mathcal{F}'_z$ is the unique
surjection with $\text{depth}_{\mathcal{O}_{X, z}}(\mathcal{F}'_z) = 1$.
\end{enumerate}
\end{enumerate}
If $f : Y \to X$ is a Cohen-Macaulay morphism with $Y$ Noetherian,
then $f^*\mathcal{F} \to f^*\mathcal{F}'$ satisfies the same properties
with respect to $f^{-1}(Z) \subset Y$ and $f^*\mathcal{F}$.
\end{lemma}

\begin{proof}
We first replace $\mathcal{F}$ by the quotient of it constructed in
Lemma \ref{lemma-get-depth-1-along-Z}. Recall that
$\text{Ass}(\mathcal{F}) = \{x_1, \ldots, x_n\}$
is finite (and $x_i \not \in Z$ by our choice of $\mathcal{F}$).
Let $Y_i$ be the closure of $\{x_i\}$. Let
$Z_{i, j}$ be the irreducible components of $Z \cap Y_i$.
Observe that $\text{Supp}(\mathcal{F}) \cap Z = \bigcup Z_{i, j}$.
Let $z_{i, j} \in Z_{i, j}$ be the generic point.
Let
$$
d_{i, j} = \dim(\mathcal{O}_{\overline{\{x_i\}}, z_{i, j}})
$$
If $d_{i, j} = 1$, then condition (2)(b) holds for
$\mathcal{F}$ at $z_{i, j}$. Thus we do not need to modify
$\mathcal{F}$ at these points. Furthermore, still assuming
$d_{i, j} = 1$, using Lemma \ref{lemma-depth-function}
we can find an open neighbourhood
$z_{i, j} \in V_{i, j} \subset X$ such that
$\text{depth}_{\mathcal{O}_{X, z}}(\mathcal{F}_z) \geq 2$
for $z \in Z_{i, j} \cap V_{i, j}$, $z \not = z_{i, j}$.
Set
$$
Z' = X \setminus
\left(
X \setminus Z \cup \bigcup\nolimits_{d_{i, j} = 1} V_{i, j})
\right)
$$
Denote $j' : X \setminus Z' \to X$. By our choice of $Z'$
the assumptions of Lemma \ref{lemma-finiteness-pushforward-general}
are satisfied.
We conclude by setting $\mathcal{F}' = j'_*(\mathcal{F}|_{X \setminus Z'})$
and applying Lemma \ref{lemma-get-depth-2-along-Z}.

\medskip\noindent
The final statement follows from the formula for the change in
depth along a flat local homomorphism, see
Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module}
and the assumption on the fibres of $f$ inherent in $f$ being
Cohen-Macaulay. Details omitted.
\end{proof}







\section{Annihilators of local chomology}
\label{section-annihilators}

\noindent
This section discusses a result due to Faltings, see
\cite{Faltings-annulators}.

\begin{proposition}
\label{proposition-annihilator}
\begin{reference}
\cite{Faltings-annulators}.
\end{reference}
Let $A$ be a Noetherian ring which has a dualizing complex.
Let $T \subset T' \subset \Spec(A)$ be subsets stable under
specialization. Let $s \geq 0$ an integer. Let $M$ be a finite $A$-module.
The following are equivalent
\begin{enumerate}
\item there exists an ideal $J \subset A$ with $V(J) \subset T'$
such that $J$ annihilates $H^i_T(M)$ for $i \leq s$, and
\item for all $\mathfrak p \not \in T'$,
$\mathfrak q \in T$ with $\mathfrak p \subset \mathfrak q$
we have
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s
$$
\end{enumerate}
\end{proposition}

\begin{proof}
Let $\omega_A^\bullet$ be a dualizing complex. Let $\delta$ be its
dimension function, see Dualizing Complexes, Section
\ref{dualizing-section-dimension-function}.
An important role will be played by the finite $A$-modules
$$
E^i = \Ext_A^i(M, \omega_A^\bullet)
$$
For $\mathfrak p \subset A$ we will write $H^i_\mathfrak p$ to denote the
local cohomology of an $A_\mathfrak p$-module with respect to
$\mathfrak pA_\mathfrak p$. Then we see that
the $\mathfrak pA_\mathfrak p$-adic completion of
$$
(E^i)_\mathfrak p =
\Ext^{\delta(\mathfrak p) + i}_{A_\mathfrak p}(M_\mathfrak p,
(\omega_A^\bullet)_\mathfrak p[-\delta(\mathfrak p)])
$$
is Matlis dual to
$$
H^{-\delta(\mathfrak p) - i}_{\mathfrak p}(M_\mathfrak p)
$$
by
Dualizing Complexes, Lemma \ref{dualizing-lemma-special-case-local-duality}.
In particular we deduce from this the
following fact: an ideal $J \subset A$ annihilates
$(E^i)_\mathfrak p$ if and only if $J$ annihilates
$H^{-\delta(\mathfrak p) - i}_{\mathfrak p}(M_\mathfrak p)$.

\medskip\noindent
Set $T_n = \{\mathfrak p \in T \mid \delta(\mathfrak p) \leq n\}$.
As $\delta$ is a bounded function, we see that
$T_a = \emptyset$ for $a \ll 0$ and $T_b = T$ for $b \gg 0$.

\medskip\noindent
Assume (2). Let us prove the existence of $J$ as in (1).
We will use a double induction to do this. For $i \leq s$
consider the induction hypothesis $IH_i$:
$H^a_T(M)$ is annihilated by some $J \subset A$ with $V(J) \subset T'$
for $0 \leq a \leq i$. The case $IH_0$ is trivial
because $H^0_T(M)$ is a submodule of $M$ and hence finite
and hence is annihilated by some ideal $J$ with $V(J) \subset T$.

\medskip\noindent
Induction step. Assume $IH_{i - 1}$ holds for some $0 < i \leq s$.
Pick $J'$ with $V(J') \subset T'$ annihilating $H^a_T(M)$ for
$0 \leq a \leq i - 1$ (the induction hypothesis guarantees we can
do this). We will show by descending induction on $n$
that there exists an ideal $J$ with $V(J) \subset T'$ such that the
associated primes of $J H^i_T(M)$ are in $T_n$.
For $n \ll 0$ this implies $JH^i_Z(M) = 0$ 
(Algebra, Lemma \ref{algebra-lemma-ass-zero})
and hence $IH_i$ will hold.
The base case $n \gg 0$ is trivial because $T = T_n$ in this case
and all associated primes of $H^i_T(M)$ are in $T$.

\medskip\noindent
Thus we assume given $J$ with the property for $n$.
Let $\mathfrak q \in T_n$. Let $T_\mathfrak q \subset \Spec(A_\mathfrak q)$
be the inverse image of $T$. We have
$H^j_T(M)_\mathfrak q = H^j_{T_\mathfrak q}(M_\mathfrak q)$
by Lemma \ref{lemma-torsion-change-rings}.
Consider the spectral sequence
$$
H_\mathfrak q^p(H^q_{T_\mathfrak q}(M_\mathfrak q))
\Rightarrow
H^{p + q}_\mathfrak q(M_\mathfrak q)
$$
of Lemma \ref{lemma-local-cohomology-ss}.
Below we will find an ideal $J'' \subset A$ with $V(J'') \subset T'$
such that $H^i_\mathfrak q(M_\mathfrak q)$ is annihilated by $J''$ for all
$\mathfrak q \in T_n \setminus T_{n - 1}$.
Claim: $J (J')^i J''$ will work for $n - 1$.
Namely, let $\mathfrak q \in Z_n \setminus Z_{n - 1}$.
The spectral sequence above defines a filtration
$$
E_\infty^{0, i} = E_{i + 2}^{0, i} \subset \ldots \subset E_3^{0, i} \subset
E_2^{0, i} = H^0_\mathfrak q(H^i_{T_\mathfrak q}(M_\mathfrak q))
$$
The module $E_\infty^{0, i}$ is annihilated by $J''$.
The subquotients $E_j^{0, i}/E_{j + 1}^{0, i}$ for $i + 1 \geq j \geq 2$
are annihilated by $J'$ because the target of $d_j^{0, i}$
is a subquotient of
$$
H^j_\mathfrak q(H^{i - j + 1}_{T_\mathfrak q}(M_\mathfrak q)) =
H^j_\mathfrak q(H^{i - j + 1}_T(M)_\mathfrak q)
$$
and $H^{i - j + 1}_T(M)_\mathfrak q$ is annihilated by $J'$ by choice of $J'$.
Finally, by our choice of $J$ we have
$J H^i_T(M)_\mathfrak q \subset H^0_\mathfrak q(H^i_T(M)_\mathfrak q)$
since the non-closed points of $\Spec(A_\mathfrak q)$ have higher
$\delta$ values. Thus $\mathfrak q$ cannot be an associated prime of
$J(J')^iJ'' H^i_Z(M)$ as desired.

\medskip\noindent
By our initial remarks we see that $J''$ should annihilate
$$
(E^{-\delta(\mathfrak q) - i})_\mathfrak q =
(E^{-n - i})_\mathfrak q
$$
for all $\mathfrak q \in T_n \setminus T_{n - 1}$.
But if $J''$ works for one $\mathfrak q$, then it works for all
$\mathfrak q$ in an open neighbourhood of $\mathfrak q$
as the modules $E^{-n - i}$ are finite.
Since every subset of $\Spec(A)$ is Noetherian with the induced
topology (Topology, Lemma \ref{topology-lemma-Noetherian}),
we conclude that it suffices
to prove the existence of $J''$ for one $\mathfrak q$.

\medskip\noindent
Since the ext modules are finite the existence of $J''$ is
equivalent to
$$
\text{Supp}(E^{-n - i}) \cap \Spec(A_\mathfrak q) \subset T'.
$$
This is equivalent to showing the localization of $E^{-n - i}$ at every
$\mathfrak p \subset \mathfrak q$, $\mathfrak p \not \in T'$
is zero. Using local duality over $A_\mathfrak p$ we find that we need
to prove that
$$
H^{\delta(\mathfrak p) + n + i}_\mathfrak p(M_\mathfrak p) =
H^{i - \dim((A/\mathfrak p)_\mathfrak q)}_\mathfrak p(M_\mathfrak p)
$$
is zero (this uses that $\delta$ is a dimension function).
This vanishes by the assumption in the lemma and $i \leq s$ and
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}.

\medskip\noindent
To prove the converse implication we assume (2) does not hold
and we work backwards through the arguments above. First, we pick a
$\mathfrak q \in T$, $\mathfrak p \subset \mathfrak q$
with $\mathfrak p \not \in T'$ such that
$$
i = \text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) \leq s
$$
is minimal. Then
$H^{i - \dim((A/\mathfrak p)_\mathfrak q)}_\mathfrak p(M_\mathfrak p)$
is nonzero by the nonvanishing in
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}.
Set $n = \delta(\mathfrak q)$. Then
there does not exist an ideal $J \subset A$ with $V(J) \subset T'$
such that $J(E^{-n - i})_\mathfrak q = 0$.
Thus $H^i_\mathfrak q(M_\mathfrak q)$ is not
annihilated by an ideal $J \subset A$ with $V(J) \subset T'$.
By minimality of $i$ it follows from the spectral sequence displayed above
that the module $H^i_T(M)_\mathfrak q$
is not annihilated by an ideal $J \subset A$
with $V(J) \subset T'$. Thus $H^i_T(M)$
is not annihilated by an ideal $J \subset A$
with $V(J) \subset T'$. This finishes the proof of the proposition.
\end{proof}

\begin{proposition}
\label{proposition-finiteness}
\begin{reference}
\cite{Faltings-annulators}.
\end{reference}
Let $A$ be a Noetherian ring which has a dualizing complex.
Let $T \subset \Spec(A)$ be a subset stable under specialization.
Let $s \geq 0$ an integer. Let $M$ be a finite $A$-module.
The following are equivalent
\begin{enumerate}
\item $H^i_T(M)$ is a finite $A$-module for $i \leq s$, and
\item for all $\mathfrak p \not \in T$, $\mathfrak q \in T$ with
$\mathfrak p \subset \mathfrak q$ we have
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s
$$
\end{enumerate}
\end{proposition}

\begin{proof}
Formal consequence of Proposition \ref{proposition-annihilator} and
Lemma \ref{lemma-check-finiteness-local-cohomology-by-annihilator}.
\end{proof}

\begin{lemma}
\label{lemma-kill-local-cohomology-at-prime}
Let $I$ be an ideal of a Noetherian ring $A$.
Let $M$ be a finite $A$-module, let $\mathfrak p \subset A$ be a prime
ideal, and let $s \geq 0$ be an integer. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item $\mathfrak p \not \in V(I)$, and
\item for all primes $\mathfrak p' \subset \mathfrak p$
and $\mathfrak q \in V(I)$ with $\mathfrak p' \subset \mathfrak q$ we have
$$
\text{depth}_{A_{\mathfrak p'}}(M_{\mathfrak p'}) +
\dim((A/\mathfrak p')_\mathfrak q) > s
$$
\end{enumerate}
Then there exists an $f \in A$, $f \not \in \mathfrak p$ which annihilates
$H^i_{V(I)}(M)$ for $i \leq s$.
\end{lemma}

\begin{proof}
Consider the sets
$$
T = V(I)
\quad\text{and}\quad
T' = \bigcup\nolimits_{f \in A, f \not \in \mathfrak p} V(f)
$$
These are subsets of $\Spec(A)$ stable under specialization.
Observe that $T \subset T'$ and $\mathfrak p \not \in T'$.
Assumption (3) says that hypothesis (2) of
Proposition \ref{proposition-annihilator} holds.
Hence we can find $J \subset A$ with $V(J) \subset T'$
such that $J H^i_{V(I)}(M) = 0$ for $i \leq s$.
Choose $f \in A$, $f \not \in \mathfrak p$ with $V(J) \subset V(f)$.
A power of $f$ annihilates $H^i_{V(I)}(M)$ for $i \leq s$.
\end{proof}





\section{Finiteness of local cohomology, II}
\label{section-finiteness-II}

\noindent
We continue the discussion of finiteness of local cohomology
started in Section \ref{section-finiteness}.
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
Set $X = \Spec(A)$ and $Z = V(I) \subset X$. Let $M$ be a finite $A$-module.
We define
\begin{equation}
\label{equation-cutoff}
s_{A, I}(M) =
\min \{
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q)
\mid
\mathfrak p \in X \setminus Z, \mathfrak q \in Z,
\mathfrak p \subset \mathfrak q
\}
\end{equation}
Our conventions on depth are that the depth of $0$ is $\infty$
thus we only need to consider primes $\mathfrak p$ in the support
of $M$. It will turn out that $s_{A, I}(M)$ is an important invariant of
the situation.

\begin{lemma}
\label{lemma-cutoff}
Let $A \to B$ be a finite homomorphism of Noetherian rings.
Let $I \subset A$ be an ideal and set $J = IB$. Let $M$ be
a finite $B$-module. If $A$ is universally catenary, then
$s_{B, J}(M) = s_{A, I}(M)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset \mathfrak q \subset A$ be primes with
$I \subset \mathfrak q$ and $I \not \subset \mathfrak p$.
Since $A \to B$ is finite there are finitely many primes
$\mathfrak p_i$ lying over $\mathfrak p$. By
Algebra, Lemma \ref{algebra-lemma-depth-goes-down-finite}
we have
$$
\text{depth}(M_\mathfrak p) = \min \text{depth}(M_{\mathfrak p_i})
$$
Let $\mathfrak p_i \subset \mathfrak q_{ij}$ be primes lying
over $\mathfrak q$. By going up for $A \to B$
(Algebra, Lemma \ref{algebra-lemma-integral-going-up})
there is at least one $\mathfrak q_{ij}$ for each $i$.
Then we see that
$$
\dim((B/\mathfrak p_i)_{\mathfrak q_{ij}}) =
\dim((A/\mathfrak p)_\mathfrak q)
$$
by the dimension formula, see
Algebra, Lemma \ref{algebra-lemma-dimension-formula}.
This implies that the minimum of the quantities
used to define $s_{B, J}(M)$
for the pairs $(\mathfrak p_i, \mathfrak q_{ij})$
is equal to the quantity for the pair $(\mathfrak p, \mathfrak q)$.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-cutoff-completion}
Let $A$ be a universally catenary Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be
a finite $A$-module. Then
$$
s_{A, I}(M) \geq s_{A^\wedge, I^\wedge}(M^\wedge)
$$
If the formal fibres of $A$ are $(S_n)$, then
$\min(n + 1, s_{A, I}(M)) \leq s_{A^\wedge, I^\wedge}(M^\wedge)$.
\end{lemma}

\begin{proof}
Write $X = \Spec(A)$, $X^\wedge = \Spec(A^\wedge)$, $Z = V(I) \subset X$, and
$Z^\wedge = V(I^\wedge)$.
Let $\mathfrak p' \subset \mathfrak q' \subset A^\wedge$
be primes with $\mathfrak p' \not \in Z^\wedge$ and
$\mathfrak q' \in Z^\wedge$. Let $\mathfrak p \subset \mathfrak q$
be the corresponding primes of $A$. Then $\mathfrak p \not \in Z$
and $\mathfrak q \in Z$. Picture
$$
\xymatrix{
\mathfrak p' \ar[r] & \mathfrak q' \ar[r] & A^\wedge \\
\mathfrak p \ar[r] \ar@{-}[u] &
\mathfrak q \ar[r] \ar@{-}[u] & A \ar[u]
}
$$
Let us write
\begin{align*}
a & = \dim(A/\mathfrak p) = \dim(A^\wedge/\mathfrak pA^\wedge),\\
b & = \dim(A/\mathfrak q) = \dim(A^\wedge/\mathfrak qA^\wedge),\\
a' & = \dim(A^\wedge/\mathfrak p'),\\
b' & = \dim(A^\wedge/\mathfrak q')
\end{align*}
Equalities by
More on Algebra, Lemma \ref{more-algebra-lemma-completion-dimension}.
We also write
\begin{align*}
p & = \dim(A^\wedge_{\mathfrak p'}/\mathfrak p A^\wedge_{\mathfrak p'}) =
\dim((A^\wedge/\mathfrak p A^\wedge)_{\mathfrak p'}) \\
q & = \dim(A^\wedge_{\mathfrak q'}/\mathfrak p A^\wedge_{\mathfrak q'}) =
\dim((A^\wedge/\mathfrak q A^\wedge)_{\mathfrak q'})
\end{align*}
Since $A$ is universally catenary we see that
$A^\wedge/\mathfrak pA^\wedge = (A/\mathfrak p)^\wedge$
is equidimensional of dimension $a$
(More on Algebra, Proposition \ref{more-algebra-proposition-ratliff}).
Hence $a = a' + p$. Similarly $b = b' + q$.
By Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module}
applied to the flat local ring map
$A_\mathfrak p \to A^\wedge_{\mathfrak p'}$
we have
$$
\text{depth}(M^\wedge_{\mathfrak p'})
=
\text{depth}(M_\mathfrak p) +
\text{depth}(A^\wedge_{\mathfrak p'} / \mathfrak p A^\wedge_{\mathfrak p'})
$$
The quantity we are minimizing for $s_{A, I}(M)$ is
$$
s(\mathfrak p, \mathfrak q) =
\text{depth}(M_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q) =
\text{depth}(M_\mathfrak p) + a - b
$$
(last equality as $A$ is catenary). The quantity we are minimizing
for $s_{A^\wedge, I^\wedge}(M^\wedge)$
is
$$
s(\mathfrak p', \mathfrak q') =
\text{depth}(M^\wedge_{\mathfrak p'}) +
\dim((A^\wedge/\mathfrak p')_{\mathfrak q'}) =
\text{depth}(M^\wedge_{\mathfrak p'}) + a' - b'
$$
(last equality as $A^\wedge$ is catenary).
Now we have enough notation in place to start the proof.

\medskip\noindent
Let $\mathfrak p \subset \mathfrak q \subset A$ be primes
with $\mathfrak p \not \in Z$ and $\mathfrak q \in Z$ such that
$s_{A, I}(M) = s(\mathfrak p, \mathfrak q)$.
Then we can pick $\mathfrak q'$ minimal over $\mathfrak q A^\wedge$
and $\mathfrak p' \subset \mathfrak q'$ minimal over
$\mathfrak p A^\wedge$ (using going down for $A \to A^\wedge$).
Then we have four primes as above with $p = 0$ and $q = 0$.
Moreover, we have
$\text{depth}(A^\wedge_{\mathfrak p'} / \mathfrak p A^\wedge_{\mathfrak p'})=0$
also because $p = 0$. This means that
$s(\mathfrak p', \mathfrak q') = s(\mathfrak p, \mathfrak q)$.
Thus we get the first inequality.

\medskip\noindent
Assume that the formal fibres of $A$ are $(S_n)$. Then
$\text{depth}(A^\wedge_{\mathfrak p'} / \mathfrak p A^\wedge_{\mathfrak p'})
\geq \min(n, p)$.
Hence
$$
s(\mathfrak p', \mathfrak q') \geq
s(\mathfrak p, \mathfrak q) + q + \min(n, p) - p \geq
s_{A, I}(M) + q + \min(n, p) - p
$$
Thus the only way we can get in trouble is if $p > n$. If this happens
then
\begin{align*}
s(\mathfrak p', \mathfrak q')
& =
\text{depth}(M^\wedge_{\mathfrak p'}) +
\dim((A^\wedge/\mathfrak p')_{\mathfrak q'}) \\
& =
\text{depth}(M_\mathfrak p) +
\text{depth}(A^\wedge_{\mathfrak p'} / \mathfrak p A^\wedge_{\mathfrak p'}) +
\dim((A^\wedge/\mathfrak p')_{\mathfrak q'}) \\
& \geq
0 + n + 1
\end{align*}
because $(A^\wedge/\mathfrak p')_{\mathfrak q'}$ has at least two primes.
This proves the second inequality.
\end{proof}

\noindent
The method of proof of the following lemma works more generally,
but the stronger results one gets will be subsumed in
Theorem \ref{theorem-finiteness} below.

\begin{lemma}
\label{lemma-local-annihilator}
\begin{reference}
This is a special case of
\cite[Satz 1]{Faltings-annulators}.
\end{reference}
Let $A$ be a Gorenstein Noetherian local ring. Let $I \subset A$
be an ideal and set $Z = V(I) \subset \Spec(A)$.
Let $M$ be a finite $A$-module. Let $s = s_{A, I}(M)$ as in
(\ref{equation-cutoff}). Then $H^i_Z(M)$ is finite for $i < s$,
but $H^s_Z(M)$ is not finite.
\end{lemma}

\begin{proof}
Since a Gorenstein local ring has a dualizing complex,
this is a special case of Proposition \ref{proposition-finiteness}.
It would be helpful to have a short proof of this special case,
which will be used in the proof of a general finiteness theorem below.
\end{proof}

\noindent
Observe that the hypotheses of the following theorem are satisfied
by excellent Noetherian rings (by definition),
by Noetherian rings which have a dualizing complex
(Dualizing Complexes, Lemma \ref{dualizing-lemma-universally-catenary} and
Dualizing Complexes, Lemma
\ref{dualizing-lemma-dualizing-gorenstein-formal-fibres}), and
by quotients of regular Noetherian rings.

\begin{theorem}
\label{theorem-finiteness}
\begin{reference}
This is a special case of \cite[Satz 2]{Faltings-finiteness}.
\end{reference}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
Set $Z = V(I) \subset \Spec(A)$. Let $M$ be a finite $A$-module.
Set $s = s_{A, I}(M)$ as in (\ref{equation-cutoff}).
Assume that
\begin{enumerate}
\item $A$ is universally catenary,
\item the formal fibres of the local rings of $A$ are Cohen-Macaulay.
\end{enumerate}
Then $H^i_Z(M)$ is finite for $0 \leq i < s$ and
$H^s_Z(M)$ is not finite.
\end{theorem}

\begin{proof}
By Lemma \ref{lemma-check-finiteness-local-cohomology-locally}
we may assume that $A$ is a local ring.

\medskip\noindent
If $A$ is a Noetherian complete local ring, then we can write $A$
as the quotient of a regular complete local ring $B$ by
Cohen's structure theorem
(Algebra, Theorem \ref{algebra-theorem-cohen-structure-theorem}).
Using Lemma \ref{lemma-cutoff} and
Dualizing Complexes, Lemma
\ref{dualizing-lemma-local-cohomology-and-restriction}
we reduce to the case
of a regular local ring which is a consequence of
Lemma \ref{lemma-local-annihilator}
because a regular local ring is Gorenstein
(Dualizing Complexes, Lemma \ref{dualizing-lemma-regular-gorenstein}).

\medskip\noindent
Let $A$ be a Noetherian local ring. Let $\mathfrak m$ be the maximal ideal.
We may assume $I \subset \mathfrak m$, otherwise the lemma is trivial.
Let $A^\wedge$ be the completion of $A$, let $Z^\wedge = V(IA^\wedge)$, and
let $M^\wedge = M \otimes_A A^\wedge$ be the completion of $M$
(Algebra, Lemma \ref{algebra-lemma-completion-tensor}).
Then $H^i_Z(M) \otimes_A A^\wedge = H^i_{Z^\wedge}(M^\wedge)$ by
Dualizing Complexes, Lemma \ref{dualizing-lemma-torsion-change-rings}
and flatness of $A \to A^\wedge$
(Algebra, Lemma \ref{algebra-lemma-completion-flat}).
Hence it suffices to show that $H^i_{Z^\wedge}(M^\wedge)$ is
finite for $i < s$ and not finite for $i = s$, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
Since we know the result is true for $A^\wedge$ it suffices
to show that $s_{A, I}(M) = s_{A^\wedge, I^\wedge}(M^\wedge)$.
This follows from Lemma \ref{lemma-cutoff-completion}.
\end{proof}

\begin{remark}
\label{remark-astute-reader}
The astute reader will have realized that we can get away with a
slightly weaker condition on the formal fibres of the local rings
of $A$. Namely, in the situation of Theorem \ref{theorem-finiteness}
assume $A$ is universally catenary but make no assumptions on
the formal fibres. Suppose we have an $n$ and we want to prove that
$H^i_Z(M)$ are finite for $i \leq n$. Then the exact same proof
shows that it suffices that $s_{A, I}(M) > n$ and that
the formal fibres of local rings of $A$ are $(S_n)$.
On the other hand, if we want to show that $H^s_Z(M)$
is not finite where $s = s_{A, I}(M)$, then our arguments prove
this if the formal fibres are $(S_{s - 1})$.
\end{remark}







\section{Finiteness of pushforwards, II}
\label{section-finiteness-pushforward-II}

\noindent
This section is the continuation of
Section \ref{section-finiteness-pushforward}.
In this section we reap the fruits of the labor done in
Section \ref{section-finiteness-II}.

\begin{lemma}
\label{lemma-finiteness-Rjstar}
Let $X$ be a locally Noetherian scheme. Let $j : U \to X$ be the inclusion
of an open subscheme with complement $Z$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_U$-module. Let $n \geq 0$ be an integer. Assume
\begin{enumerate}
\item $X$ is universally catenary,
\item for every $z \in Z$ the formal fibres of
$\mathcal{O}_{X, z}$ are $(S_n)$.
\end{enumerate}
In this situation the following are equivalent
\begin{enumerate}
\item[(a)] for $x \in \text{Supp}(\mathcal{F})$ and
$z \in Z \cap \overline{\{x\}}$ we have
$\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) +
\dim(\mathcal{O}_{\overline{\{x\}}, z}) > n$,
\item[(b)] $R^pj_*\mathcal{F}$ is coherent for $0 \leq p < n$.
\end{enumerate}
\end{lemma}

\begin{proof}
The statement is local on $X$, hence we may assume $X$ is affine.
Say $X = \Spec(A)$ and $Z = V(I)$. Let $M$ be a finite $A$-module
whose associated coherent $\mathcal{O}_X$-module restricts
to $\mathcal{F}$ over $U$, see
Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}.
This lemma also tells us that $R^pj_*\mathcal{F}$ is coherent
if and only if $H^{p + 1}_Z(M)$ is a finite $A$-module.
Observe that the minimum of the expressions
$\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) +
\dim(\mathcal{O}_{\overline{\{x\}}, z})$
is the number $s_{A, I}(M)$ of (\ref{equation-cutoff}).
Having said this the lemma follows from
Theorem \ref{theorem-finiteness}
as elucidated by Remark \ref{remark-astute-reader}.
\end{proof}

\begin{lemma}
\label{lemma-finiteness-for-finite-locally-free}
Let $X$ be a locally Noetherian scheme. Let $j : U \to X$ be the inclusion
of an open subscheme with complement $Z$. Let $n \geq 0$ be an integer.
If $R^pj_*\mathcal{O}_U$ is coherent for $0 \leq p < n$, then
the same is true for $R^pj_*\mathcal{F}$, $0 \leq p < n$
for any finite locally free $\mathcal{O}_U$-module $\mathcal{F}$.
\end{lemma}

\begin{proof}
The question is local on $X$, hence we may assume $X$ is affine.
Say $X = \Spec(A)$ and $Z = V(I)$. Via
Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}
our lemma follows from
Lemma \ref{lemma-local-finiteness-for-finite-locally-free}.
\end{proof}

\begin{lemma}
\label{lemma-annihilate-Hp}
\begin{reference}
\cite[Lemma 1.9]{Bhatt-local}
\end{reference}
Let $A$ be a ring and let $J \subset I \subset A$ be finitely generated ideals.
Let $p \geq 0$ be an integer. Set $U = \Spec(A) \setminus V(I)$. If
$H^p(U, \mathcal{O}_U)$ is annihilated by $J^n$ for some $n$, then
$H^p(U, \mathcal{F})$ annihilated by $J^m$ for some $m = m(\mathcal{F})$
for every finite locally free $\mathcal{O}_U$-module $\mathcal{F}$.
\end{lemma}

\begin{proof}
Consider the annihilator $\mathfrak a$ of $H^p(U, \mathcal{F})$.
Let $u \in U$. There exists an open neighbourhood $u \in U' \subset U$
and an isomorphism
$\varphi : \mathcal{O}_{U'}^{\oplus r} \to \mathcal{F}|_{U'}$.
Pick $f \in A$ such that $u \in D(f) \subset U'$.
There exist maps
$$
a : \mathcal{O}_U^{\oplus r} \longrightarrow \mathcal{F}
\quad\text{and}\quad
b : \mathcal{F} \longrightarrow \mathcal{O}_U^{\oplus r}
$$
whose restriction to $D(f)$ are equal to $f^N \varphi$
and $f^N \varphi^{-1}$ for some $N$. Moreover we may assume that
$a \circ b$ and $b \circ a$ are equal to multiplication by $f^{2N}$.
This follows from Properties, Lemma
\ref{properties-lemma-section-maps-backwards}
since $U$ is quasi-compact ($I$ is finitely generated), separated, and
$\mathcal{F}$ and $\mathcal{O}_U^{\oplus r}$ are finitely presented.
Thus we see that $H^p(U, \mathcal{F})$ is annihilated by
$f^{2N}J^n$, i.e., $f^{2N}J^n \subset \mathfrak a$.

\medskip\noindent
As $U$ is quasi-compact we can find finitely many $f_1, \ldots, f_t$
and $N_1, \ldots, N_t$ such that $U = \bigcup D(f_i)$ and
$f_i^{2N_i}J^n \subset \mathfrak a$. Then $V(I) = V(f_1, \ldots, f_t)$
and since $I$ is finitely generated we conclude
$I^M \subset (f_1, \ldots, f_t)$ for some $M$.
All in all we see that $J^m \subset \mathfrak a$ for
$m \gg 0$, for example $m = M (2N_1 + \ldots + 2N_t) n$  will do.
\end{proof}







\section{Hartshorne-Lichtenbaum vanishing}
\label{section-Hartshorne-Lichtenbaum-vanishing}

\noindent
This and much else besides can be found in \cite{CD}.

\begin{lemma}
\label{lemma-cd-top-vanishing}
Let $A$ be a Noetherian ring of dimension $d$. Let $I \subset I' \subset A$
be ideals. If $I'$ is contained in the Jacobson radical
of $A$ and $\text{cd}(A, I') < d$, then $\text{cd}(A, I) < d$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-cd-dimension} we know $\text{cd}(A, I) \leq d$.
We will use Lemma \ref{lemma-isomorphism} to show
$$
H^d_{V(I')}(A) \to H^d_{V(I)}(A)
$$
is surjective which will finish the proof. Pick
$\mathfrak p \in V(I) \setminus V(I')$. By our assumption
on $I'$ we see that $\mathfrak p$ is not a maximal ideal of $A$.
Hence $\dim(A_\mathfrak p) < d$. Then
$H^d_{\mathfrak pA_\mathfrak p}(A_\mathfrak p) = 0$
by Lemma \ref{lemma-cd-dimension}.
\end{proof}

\begin{lemma}
\label{lemma-cd-top-vanishing-some-module}
Let $A$ be a Noetherian ring of dimension $d$. Let $I \subset A$
be an ideal. If $H^d_{V(I)}(M) = 0$ for some finite $A$-module
whose support contains all the irreducible components of
dimension $d$, then $\text{cd}(A, I) < d$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-cd-dimension} we know $\text{cd}(A, I) \leq d$.
Thus for any finite $A$-module $N$ we have $H^i_{V(I)}(N) = 0$
for $i > d$. Let us say property $\mathcal{P}$ holds for the
finite $A$-module $N$ if $H^d_{V(I)}(N) = 0$.
One of our assumptions is that $\mathcal{P}(M)$ holds.
Observe that $\mathcal{P}(N_1 \oplus N_2)
\Leftrightarrow (\mathcal{P}(N_1) \wedge \mathcal{P}(N_2))$.
Observe that if $N \to N'$ is surjective, then
$\mathcal{P}(N) \Rightarrow \mathcal{P}(N')$ as we
have the vanishing of $H^{d + 1}_{V(I)}$ (see above).
Let $\mathfrak p_1, \ldots, \mathfrak p_n$ be the
minimal primes of $A$ with $\dim(A/\mathfrak p_i) = d$.
Observe that $\mathcal{P}(N)$ holds if the support
of $N$ is disjoint from $\{\mathfrak p_1, \ldots, \mathfrak p_n\}$
for dimension reasons, see Lemma \ref{lemma-cd-dimension}.
For each $i$ set $M_i = M/\mathfrak p_i M$.
This is a finite $A$-module annihilated by $\mathfrak p_i$
whose support is equal to
$V(\mathfrak p_i)$ (here we use the assumption on the support of $M$).
Finally, if $J \subset A$ is an ideal, then we have $\mathcal{P}(JM_i)$
as $JM_i$ is a quotient of a direct sum of copies of $M$.
Thus it follows from Cohomology of Schemes, Lemma
\ref{coherent-lemma-property-higher-rank-cohomological}
that $\mathcal{P}$ holds for every finite $A$-module.
\end{proof}

\begin{lemma}
\label{lemma-top-coh-divisible}
Let $A$ be a Noetherian local ring of dimension $d$. Let $f \in A$
be an element which is not contained in any minimal prime of
dimension $d$. Then $f : H^d_{V(I)}(M) \to H^d_{V(I)}(M)$
is surjective for any finite $A$-module $M$ and any ideal $I \subset A$.
\end{lemma}

\begin{proof}
The support of $M/fM$ has dimension $< d$ by our assumption on $f$.
Thus $H^d_{V(I)}(M/fM) = 0$ by Lemma \ref{lemma-cd-dimension}.
Thus $H^d_{V(I)}(fM) \to H^d_{V(I)}(M)$ is surjective.
Since by Lemma \ref{lemma-cd-dimension} we know $\text{cd}(A, I) \leq d$
we also see that the surjection $M \to fM$, $x \mapsto fx$
induces a surjection $H^d_{V(I)}(M) \to H^d_{V(I)}(fM)$.
\end{proof}

\begin{lemma}
\label{lemma-cd-bound-dualizing}
Let $A$ be a Noetherian local ring with
normalized dualizing complex $\omega_A^\bullet$.
Let $I \subset A$ be an ideal.
If $H^0_{V(I)}(\omega_A^\bullet) = 0$, then $\text{cd}(A, I) < \dim(A)$.
\end{lemma}

\begin{proof}
Set $d = \dim(A)$. Let $\mathfrak p_1, \ldots, \mathfrak p_n \subset A$
be the minimal primes of dimension $d$.
Recall that the finite $A$-module
$H^{-i}(\omega_A^\bullet)$ is nonzero only for
$i \in \{0, \ldots, d\}$ and that the support
of $H^{-i}(\omega_A^\bullet)$ has dimension $\leq i$, see
Lemma \ref{lemma-sitting-in-degrees}.
Set $\omega_A = H^{-d}(\omega_A^\bullet)$.
By prime avoidence (Algebra, Lemma \ref{algebra-lemma-silly})
we can find $f \in A$, $f \not \in \mathfrak p_i$
which annihilates $H^{-i}(\omega_A^\bullet)$ for $i < d$.
Consider the distinguished triangle
$$
\omega_A[d] \to \omega_A^\bullet \to
\tau_{\geq -d + 1}\omega_A^\bullet \to \omega_A[d + 1]
$$
See Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle}.
By Derived Categories, Lemma \ref{derived-lemma-trick-vanishing-composition}
we see that $f^d$ induces the zero endomorphism of
$\tau_{\geq -d + 1}\omega_A^\bullet$.
Using the axioms of a triangulated category, we find a map
$$
\omega_A^\bullet \to \omega_A[d]
$$
whose composition with $\omega_A[d] \to \omega_A^\bullet$ is
multiplication by $f^d$ on $\omega_A[d]$.
Thus we conclude that $f^d$ annihilates $H^d_{V(I)}(\omega_A)$.
By Lemma \ref{lemma-top-coh-divisible} we conlude $H^d_{V(I)}(\omega_A) = 0$.
Then we conclude by Lemma \ref{lemma-cd-top-vanishing-some-module}
and the fact that $(\omega_A)_{\mathfrak p_i}$ is nonzero
(see for example
Dualizing Complexes, Lemma
\ref{dualizing-lemma-nonvanishing-generically-local}).
\end{proof}

\begin{lemma}
\label{lemma-inverse-system-symbolic-powers}
Let $(A, \mathfrak m)$ be a complete Noetherian local domain. Let
$\mathfrak p \subset A$ be a prime ideal of dimension $1$.
For every $n \geq 1$ there is an $m \geq n$ such that
$\mathfrak p^{(m)} \subset \mathfrak p^n$.
\end{lemma}

\begin{proof}
Recall that the symbolic power $\mathfrak p^{(m)}$ is defined as the
kernel of $A \to A_\mathfrak p/\mathfrak p^mA_\mathfrak p$.
Since localization is exact we conclude that in the short exact sequence
$$
0 \to \mathfrak a_n \to A/\mathfrak p^n \to A/\mathfrak p^{(n)} \to 0
$$
the support of $\mathfrak a_n$ is contained in $\{\mathfrak m\}$.
In particular, the inverse system $(\mathfrak a_n)$ is Mittag-Leffler
as each $\mathfrak a_n$ is an Artinian $A$-module.
We conclude that the lemma is equivalent to the requirement
that $\lim \mathfrak a_n = 0$. Let $f \in \lim \mathfrak a_n$.
Then $f$ is an element of $A = \lim A/\mathfrak p^n$
(here we use that $A$ is complete)
which maps to zero in the completion $A_\mathfrak p^\wedge$
of $A_\mathfrak p$. Since $A_\mathfrak p \to A_\mathfrak p^\wedge$
is faithfully flat, we see that $f$ maps to zero in $A_\mathfrak p$.
Since $A$ is a domain we see that $f$ is zero as desired.
\end{proof}

\begin{proposition}
\label{proposition-Hartshorne-Lichtenbaum-vanishing}
\begin{reference}
\cite[Theorem 3.1]{CD}
\end{reference}
Let $A$ be a Noetherian local ring with completion $A^\wedge$.
Let $I \subset A$ be an ideal such that
$$
\dim V(IA^\wedge + \mathfrak p) \geq 1
$$
for every minimal prime $\mathfrak p \subset A^\wedge$ of dimension $\dim(A)$.
Then $\text{cd}(A, I) < \dim(A)$.
\end{proposition}

\begin{proof}
Since $A \to A^\wedge$ is faithfully flat we have
$H^d_{V(I)}(A) \otimes_A A^\wedge = H^d_{V(IA^\wedge)}(A^\wedge)$
by Dualizing Complexes, Lemma \ref{dualizing-lemma-torsion-change-rings}.
Thus we may assume $A$ is complete.

\medskip\noindent
Assume $A$ is complete. Let $\mathfrak p_1, \ldots, \mathfrak p_n \subset A$
be the minimal primes of dimension $d$. Consider the complete local ring
$A_i = A/\mathfrak p_i$. We have $H^d_{V(I)}(A_i) = H^d_{V(IA_i)}(A_i)$
by Dualizing Complexes, Lemma
\ref{dualizing-lemma-local-cohomology-and-restriction}.
By Lemma \ref{lemma-cd-top-vanishing-some-module}
it suffices to prove the lemma for $(A_i, IA_i)$.
Thus we may assume $A$ is a complete local domain.

\medskip\noindent
Assume $A$ is a complete local domain. We can choose a prime ideal
$\mathfrak p \supset I$ with $\dim(A/\mathfrak p) = 1$.
By Lemma \ref{lemma-cd-top-vanishing}
it suffices to prove the lemma for $\mathfrak p$.

\medskip\noindent
By Lemma \ref{lemma-cd-bound-dualizing} it suffices to show that
$H^0_{V(\mathfrak p)}(\omega_A^\bullet) = 0$.
Recall that
$$
H^0_{V(\mathfrak p)}(\omega_A^\bullet) =
\colim \text{Ext}^0_A(A/\mathfrak p^n, \omega_A^\bullet)
$$
By Lemma \ref{lemma-inverse-system-symbolic-powers}
we see that the colimit is the same as
$$
\colim \text{Ext}^0_A(A/\mathfrak p^{(n)}, \omega_A^\bullet)
$$
Since $\text{depth}(A/\mathfrak p^{(n)}) = 1$ we see that
these ext groups are zero by Lemma \ref{lemma-sitting-in-degrees}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-affine-complement}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Assume $A$ is excellent,
normal, and $\dim V(I) \geq 1$. Then $\text{cd}(A, I) < \dim(A)$.
In particular, if $\dim(A) = 2$, then $\Spec(A) \setminus V(I)$ is affine.
\end{lemma}

\begin{proof}
By More on Algebra, Lemma
\ref{more-algebra-lemma-completion-normal-local-ring}
the completion $A^\wedge$ is normal and hence a domain.
Thus the assumption of
Proposition \ref{proposition-Hartshorne-Lichtenbaum-vanishing}
holds and we conclude. The statement on affineness
follows from Lemma \ref{lemma-cd-is-one}.
\end{proof}





\section{Formal functions for a principal ideal}
\label{section-formal-functions-principal}

\noindent
In this section we ask if completion and taking cohomology commute
for sheaves of modules on schemes over an affine base $A$ when completion
is with respect to a principal ideal in $A$. Of course, we have already
discussed the theorem on formal functions in
Cohomology of Schemes, Section \ref{coherent-section-theorem-formal-functions}.
Moreover, we will see in Section \ref{section-formal-functions}
that derived completion commutes with derived cohomology in great generality.
In this section we just collect a few simple special cases of this material
that will help us with future developments.

\begin{lemma}
\label{lemma-limit-finite}
Let $A$ be a Noetherian ring complete with respect to a principal ideal $(f)$.
Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_2 \to \mathcal{F}_1 \to \mathcal{F}_0
$$
be an inverse system of $\mathcal{O}_X$-modules. Assume
\begin{enumerate}
\item $\Gamma(X, \mathcal{F}_0)$ is a finite $A$-module,
\item multiplication by $f$ on $\mathcal{F}_{n + 1}$ factors
through $\mathcal{F}_{n + 1} \to \mathcal{F}_n$ to give a
short exact sequence
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_0 \to 0$
\end{enumerate}
Then
$$
M = \lim \Gamma(X, \mathcal{F}_n)
$$
is a finite $A$-module, $f$ is a nonzerodivisor on $M$, and
$M/fM$ is the image of $M$ in $\Gamma(X, \mathcal{F}_0)$.
\end{lemma}

\begin{proof}
Assumption (2) implies that $\mathcal{F}_0$ is annihilated by $f$
and then by induction that $\mathcal{F}_n$ is annihilated by $f^{n + 1}$.
Set $M_n = \Gamma(X, \mathcal{F}_n)$. Since $f^{n + 1}$ annihilates
$M_n$ we see that $\bigcap f^nM = 0$. Since the kernel of
$f : M_{n + 1} \to M_{n + 1}$ dies in $M_n$ by (2) we see that
$f : M \to M$ is injective. The cokernel of $f : M \to M$
is the image of $M \to M_0$. Namely, if $m = (m_n)$ is an element
of $M$ with $m_0 = 0$, then each $m_{n + 1}$ is in the image of
$M_n \to M_{n + 1}$ by assumption (2).
If $m'_n \in M_n$ maps to $m_{n + 1}$ then $f(m'_n) = (m_n)$ in $M$.
Since $A$ is Noetherian and $M_0$ is finite, we see that
$M/fM \subset M_0$ is a finite module. By
Algebra, Lemma \ref{algebra-lemma-finite-over-complete-ring}
we conclude that $M$ is finite over $A$.
\end{proof}

\begin{lemma}
\label{lemma-ML}
Let $A$ be a ring. Let $f \in A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_2 \to \mathcal{F}_1 \to \mathcal{F}_0
$$
be an inverse system of $\mathcal{O}_X$-modules. Assume
\begin{enumerate}
\item $H^1(X, \mathcal{F}_0)$ is an $A$-module of finite length,
\item multiplication by $f$ on $\mathcal{F}_{n + 1}$ factors
through $\mathcal{F}_{n + 1} \to \mathcal{F}_n$ to give a
short exact sequence
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_0 \to 0$,
\end{enumerate}
Then the system $M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the
Mittag-Leffler condition.
\end{lemma}

\begin{proof}
By the short exact sequences and induction we see that
$H^1_n = H^1(X, \mathcal{F}_n)$ is an $A$-module of finite
length for all $n$. Fix $n$. Our goal is to show that
$$
Q_m = \Coker(M_m \to M_n),\quad m \geq n
$$
stabilizes for $m \gg n$. Note that $Q_m \subset H^1_{m - n}$ has finite length
and that we have surjective maps $Q_{m + 1} \to Q_m$ for all $m \geq n$.
Applying cohomology to the short exact sequence
$$
0 \to \mathcal{F}_{m - n} \to \mathcal{F}_m \to \mathcal{F}_n \to 0
$$
we get an exact sequence
$$
0 \to Q_m \to H^1_{m - n} \to H^1_m \to H^1_n
$$
of finite length modules.
Set $q_m = \text{length}_A(Q_m)$ and $l_m = \text{length}_A(H^1_m)$.
Then we conclude that
$$
l_m \leq l_{m - n} - q_m + l_n
$$
Above we have seen that $q_{m + 1} \geq q_m$ for all $n$. If the sequence
does not stabilize then for some $m_0$ we have $q_m > l_n$ for all
$m \geq m_0$. Then we would get
$$
l_m \leq l_{m - n} - q_m + l_n \leq l_{m - n} - 1
$$
provided $m \geq m_0$. This would imply that the sequence
$l_{m_0}, l_{m_0 + n}, l_{m_0 + 2n}, \ldots$ is strictly decreasing
contradicting the fact that $l_m > q_m$ and the sequence $q_m$
is nondecreasing. Thus the sequence stabilizes.
\end{proof}

\begin{lemma}
\label{lemma-ML-better}
Let $A$ be a ring. Let $f \in A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_2 \to \mathcal{F}_1 \to \mathcal{F}_0
$$
be an inverse system of $\mathcal{O}_X$-modules. Assume
\begin{enumerate}
\item for every $n$ there is an $m > n$ such that the image of
$H^1(X, \mathcal{F}_m) \to H^1(X, \mathcal{F}_n)$
is an $A$-module of finite length,
\item multiplication by $f$ on $\mathcal{F}_{n + 1}$ factors
through $\mathcal{F}_{n + 1} \to \mathcal{F}_n$ to give a
short exact sequence
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_0 \to 0$,
\end{enumerate}
Then the system $M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the
Mittag-Leffler condition.
\end{lemma}

\begin{proof}
Observe that condition (1) implies that the system
$H^1(X, \mathcal{F}_n)$ has the Mittag-Leffler condition.
Denote $H^1_n \subset H^1(X, \mathcal{F}_n)$ the stable image
which is a finite length $A$-module by condition (1).
For any $m' > m > n$ we have a map of short exact sequences
$$
\xymatrix{
0 \ar[r] &
\mathcal{F}_{m' - n} \ar[r] \ar[d] &
\mathcal{F}_{m'} \ar[r] \ar[d] &
\mathcal{F}_n \ar[r] \ar@{=}[d] & 0 \\
0 \ar[r] &
\mathcal{F}_{m - n} \ar[r] &
\mathcal{F}_m \ar[r] &
\mathcal{F}_n \ar[r] & 0
}
$$
In particular, the boundary maps
$\delta : M_n \to H^1(X, \mathcal{F}_{m - n})$
have image in $H^1_{m - n}$.
Consider the six term sequence
$$
0 \to M_{m - n} \to M_m \to M_n \to H^1_{m - n} \to H^1_m \to H^1_n
$$
This is exact, except possibly at $H^1_m$. However, it is easy to show
exactness there as well: let $\xi \in H^1_m$ map to zero in $H^1_n$.
Then choose a very large $m' > m$ and a lift $\xi' \in H^1_{m'}$
mapping to $\xi$. Then $\xi'$ maps to zero in
$H^1_n \subset H^1(X, \mathcal{F}_n)$. Thus we can lift $\xi'$
to an element $\xi'' \in H^1(X, \mathcal{F}_{m' - n})$.
Since $m'$ was chosen large enough, the image of $\xi''$
in $H^1(X, \mathcal{F}_{m - n})$ lies in $H^1_{m - n}$
and maps to $\xi$ as desired.

\medskip\noindent
To finish the proof argue exactly as in the proof of
Lemma \ref{lemma-ML}.
\end{proof}

\begin{lemma}
\label{lemma-formal-functions-principal}
\begin{reference}
\cite[Lemma 1.6]{Bhatt-local}
\end{reference}
Let $A$ be a ring and $f \in A$. Let $X$ be a scheme over $A$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume that $\mathcal{F}[f^n] = \Ker(f^n : \mathcal{F} \to \mathcal{F})$
stabilizes. Then
$$
R\Gamma(X, \lim \mathcal{F}/f^n\mathcal{F}) =
R\Gamma(X, \mathcal{F})^\wedge
$$
where the right hand side indicates the derived completion
with respect to the ideal $(f) \subset A$. Let $H^p$ be the
$p$th cohomology group of this complex. Then there are short
exact sequences
$$
0 \to R^1\lim H^{p - 1}(X, \mathcal{F}/f^n\mathcal{F})
\to H^p \to \lim H^p(X, \mathcal{F}/f^n\mathcal{F}) \to 0
$$
and
$$
0 \to H^0(H^p(X, \mathcal{F})^\wedge) \to H^p \to
T_f(H^{p + 1}(X, \mathcal{F})) \to 0
$$
where $T_f(-)$ denote the $f$-adic Tate module as in
More on Algebra, Example
\ref{more-algebra-example-spectral-sequence-principal}.
\end{lemma}

\begin{proof}
We start with the canonical identifications
\begin{align*}
R\Gamma(X, \mathcal{F})^\wedge
& =
R\lim R\Gamma(X, \mathcal{F}) \otimes_A^\mathbf{L} (A \xrightarrow{f^n} A) \\
& =
R\lim R\Gamma(X, \mathcal{F} \xrightarrow{f^n} \mathcal{F}) \\
& =
R\Gamma(X, R\lim (\mathcal{F} \xrightarrow{f^n} \mathcal{F}))
\end{align*}
The first equality holds by
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion-koszul}.
The second by the projection formula, see 
Cohomology, Lemma \ref{cohomology-lemma-projection-formula-perfect}.
The third by Cohomology, Lemma
\ref{cohomology-lemma-Rf-commutes-with-Rlim}.
Note that by
Derived Categories of Schemes, Lemma \ref{perfect-lemma-Rlim-quasi-coherent}
we have
$\lim \mathcal{F}/f^n\mathcal{F} = R\lim \mathcal{F}/f^n \mathcal{F}$.
Thus to finish the proof of the first statement of the lemma it suffices to
show that the pro-objects $(f^n : \mathcal{F} \to \mathcal{F})$
and $(\mathcal{F}/f^n \mathcal{F})$ are isomorphic. There is clearly
a map from the first system to the second. Suppose that
$\mathcal{F}[f^c] = \mathcal{F}[f^{c + 1}] = \mathcal{F}[f^{c + 2}] = \ldots$.
Then we can define an arrow of systems in $D(\mathcal{O}_X)$
in the other direction by the diagrams
$$
\xymatrix{
\mathcal{F}/\mathcal{F}[f^c] \ar[r]_-{f^{n + c}} \ar[d]_{f^c} &
\mathcal{F} \ar[d]^1 \\
\mathcal{F} \ar[r]^{f^n} & \mathcal{F}
}
$$
Since the top horizontal arrow is injective the complex
in the top row is quasi-isomorphic to $\mathcal{F}/f^{n + c}\mathcal{F}$.
Some details omitted.

\medskip\noindent
Since $R\Gamma(X, -)$ commutes with derived limits
(Injectives, Lemma \ref{injectives-lemma-RF-commutes-with-Rlim})
we see that
$$
R\Gamma(X, \lim \mathcal{F}/f^n\mathcal{F}) =
R\Gamma(X, R\lim \mathcal{F}/f^n\mathcal{F}) =
R\lim R\Gamma(X, \mathcal{F}/f^n\mathcal{F})
$$
(for first equality see first paragraph of proof).
By More on Algebra, Remark \ref{more-algebra-remark-compare-derived-limit}
we obtain exact sequences
$$
0 \to
R^1\lim H^{p - 1}(X, \mathcal{F}/f^n\mathcal{F}) \to
H^p(X, \lim \mathcal{F}/I^n\mathcal{F}) \to
\lim H^p(X, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
of $A$-modules. The second set of short exact sequences follow immediately
from the discussion in More on Algebra, Example
\ref{more-algebra-example-spectral-sequence-principal}.
\end{proof}








\section{Generalities on derived completion}
\label{section-derived-completion}

\noindent
We urge the reader to skip this section on a first reading.

\medskip\noindent
The algebra version of this material can be found in
More on Algebra, Section \ref{more-algebra-section-derived-completion}.
Let $\mathcal{O}$ be a sheaf of rings on a site $\mathcal{C}$.
Let $f$ be a global section of $\mathcal{O}$. We denote
$\mathcal{O}_f$ the sheaf associated to the presheaf of localizations
$U \mapsto \mathcal{O}(U)_f$.

\begin{lemma}
\label{lemma-map-twice-localize}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let $f$ be a global
section of $\mathcal{O}$.
\begin{enumerate}
\item For $L, N \in D(\mathcal{O}_f)$ we have
$R\SheafHom_\mathcal{O}(L, N) = R\SheafHom_{\mathcal{O}_f}(L, N)$.
In particular the two $\mathcal{O}_f$-structures on
$R\SheafHom_\mathcal{O}(L, N)$ agree.
\item For $K \in D(\mathcal{O})$ and
$L \in D(\mathcal{O}_f)$ we have
$$
R\SheafHom_\mathcal{O}(L, K) =
R\SheafHom_{\mathcal{O}_f}(L, R\SheafHom_\mathcal{O}(\mathcal{O}_f, K))
$$
In particular
$R\SheafHom_\mathcal{O}(\mathcal{O}_f,
R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)) =
R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)$.
\item If $g$ is a second global
section of $\mathcal{O}$, then
$$
R\SheafHom_\mathcal{O}(\mathcal{O}_f, R\SheafHom_\mathcal{O}(\mathcal{O}_g, K))
= R\SheafHom_\mathcal{O}(\mathcal{O}_{gf}, K).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $\mathcal{J}^\bullet$ be a K-injective complex of
$\mathcal{O}_f$-modules representing $N$. By Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-K-injective-flat} it follows that
$\mathcal{J}^\bullet$ is a K-injective complex of
$\mathcal{O}$-modules as well. Let $\mathcal{F}^\bullet$ be a complex of
$\mathcal{O}_f$-modules representing $L$. Then
$$
R\SheafHom_\mathcal{O}(L, N) =
R\SheafHom_\mathcal{O}(\mathcal{F}^\bullet, \mathcal{J}^\bullet) =
R\SheafHom_{\mathcal{O}_f}(\mathcal{F}^\bullet, \mathcal{J}^\bullet)
$$
by
Modules on Sites, Lemma \ref{sites-modules-lemma-epimorphism-modules}
because $\mathcal{J}^\bullet$ is a K-injective complex of $\mathcal{O}$
and of $\mathcal{O}_f$-modules.

\medskip\noindent
Proof of (2). Let $\mathcal{I}^\bullet$ be a K-injective complex of
$\mathcal{O}$-modules representing $K$.
Then $R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)$ is represented by
$\SheafHom_\mathcal{O}(\mathcal{O}_f, \mathcal{I}^\bullet)$ which is
a K-injective complex of $\mathcal{O}_f$-modules and of
$\mathcal{O}$-modules by
Cohomology on Sites, Lemmas \ref{sites-cohomology-lemma-hom-K-injective} and
\ref{sites-cohomology-lemma-K-injective-flat}.
Let $\mathcal{F}^\bullet$ be a complex of $\mathcal{O}_f$-modules
representing $L$. Then
$$
R\SheafHom_\mathcal{O}(L, K) =
R\SheafHom_\mathcal{O}(\mathcal{F}^\bullet, \mathcal{I}^\bullet) =
R\SheafHom_{\mathcal{O}_f}(\mathcal{F}^\bullet,
\SheafHom_\mathcal{O}(\mathcal{O}_f, \mathcal{I}^\bullet))
$$
by Modules on Sites, Lemma \ref{sites-modules-lemma-adjoint-hom-restrict}
and because $\SheafHom_\mathcal{O}(\mathcal{O}_f, \mathcal{I}^\bullet)$ is a
K-injective complex of $\mathcal{O}_f$-modules.

\medskip\noindent
Proof of (3). This follows from the fact that
$R\SheafHom_\mathcal{O}(\mathcal{O}_g, \mathcal{I}^\bullet)$
is K-injective as a complex of $\mathcal{O}$-modules and the fact that
$\SheafHom_\mathcal{O}(\mathcal{O}_f,
\SheafHom_\mathcal{O}(\mathcal{O}_g, \mathcal{H})) = 
\SheafHom_\mathcal{O}(\mathcal{O}_{gf}, \mathcal{H})$
for all sheaves of $\mathcal{O}$-modules $\mathcal{H}$.
\end{proof}

\noindent
Let $K \in D(\mathcal{O})$. We denote
$T(K, f)$ a derived limit (Derived Categories, Definition
\ref{derived-definition-derived-limit}) of the system
$$
\ldots \to K \xrightarrow{f} K \xrightarrow{f} K
$$
in $D(\mathcal{O})$.

\begin{lemma}
\label{lemma-hom-from-Af}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let $f$ be a global
section of $\mathcal{O}$. Let $K \in D(\mathcal{O})$.
The following are equivalent
\begin{enumerate}
\item $R\SheafHom_\mathcal{O}(\mathcal{O}_f, K) = 0$,
\item $R\SheafHom_\mathcal{O}(L, K) = 0$ for all $L$ in $D(\mathcal{O}_f)$,
\item $T(K, f) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (2) implies (1). The implication (1) $\Rightarrow$ (2)
follows from Lemma \ref{lemma-map-twice-localize}.
A free resolution of the $\mathcal{O}$-module $\mathcal{O}_f$ is given by
$$
0 \to \bigoplus\nolimits_{n \in \mathbf{N}} \mathcal{O} \to
\bigoplus\nolimits_{n \in \mathbf{N}} \mathcal{O}
\to \mathcal{O}_f \to 0
$$
where the first map sends a local section $(x_0, x_1, \ldots)$ to
$(fx_0 - x_1, fx_1 - x_2, \ldots)$ and the second map sends
$(x_0, x_1, \ldots)$ to $x_0 + x_1/f + x_2/f^2 + \ldots$.
Applying $\SheafHom_\mathcal{O}(-, \mathcal{I}^\bullet)$
where $\mathcal{I}^\bullet$ is a K-injective complex of $\mathcal{O}$-modules
representing $K$ we get a short exact sequence of complexes
$$
0 \to \SheafHom_\mathcal{O}(\mathcal{O}_f, \mathcal{I}^\bullet) \to
\prod \mathcal{I}^\bullet \to \prod \mathcal{I}^\bullet \to 0
$$
because $\mathcal{I}^n$ is an injective $\mathcal{O}$-module.
The products are products in $D(\mathcal{O})$, see
Injectives, Lemma \ref{injectives-lemma-derived-products}.
This means that the object $T(K, f)$ is a representative of
$R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)$ in $D(\mathcal{O})$.
Thus the equivalence of (1) and (3).
\end{proof}

\begin{lemma}
\label{lemma-ideal-of-elements-complete-wrt}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let $K \in D(\mathcal{O})$.
The rule which associates to $U$ the set $\mathcal{I}(U)$
of sections $f \in \mathcal{O}(U)$ such that $T(K|_U, f) = 0$
is a sheaf of ideals in $\mathcal{O}$.
\end{lemma}

\begin{proof}
We will use the results of Lemma \ref{lemma-hom-from-Af} without further
mention. If $f \in \mathcal{I}(U)$, and $g \in \mathcal{O}(U)$, then
$\mathcal{O}_{U, gf}$ is an $\mathcal{O}_{U, f}$-module
hence $R\SheafHom_\mathcal{O}(\mathcal{O}_{U, gf}, K|_U) = 0$, hence
$gf \in \mathcal{I}(U)$. Suppose $f, g \in \mathcal{O}(U)$.
Then there is a short exact sequence
$$
0 \to \mathcal{O}_{U, f + g} \to
\mathcal{O}_{U, f(f + g)} \oplus \mathcal{O}_{U, g(f + g)} \to
\mathcal{O}_{U, gf(f + g)} \to 0
$$
because $f, g$ generate the unit ideal in $\mathcal{O}(U)_{f + g}$.
This follows from
Algebra, Lemma \ref{algebra-lemma-standard-covering}
and the easy fact that the last arrow is surjective.
Because $R\SheafHom_\mathcal{O}( - , K|_U)$ is an exact functor
of triangulated categories the vanishing of
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, f(f + g)}, K|_U)$,
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, g(f + g)}, K|_U)$, and
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, gf(f + g)}, K|_U)$,
implies the vanishing of 
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, f + g}, K|_U)$.
We omit the verification of the sheaf condition.
\end{proof}

\noindent
We can make the following definition for any ringed site.

\begin{definition}
\label{definition-derived-complete}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a sheaf of ideals.
Let $K \in D(\mathcal{O})$. We say that $K$ is
{\it derived complete with respect to $\mathcal{I}$}
if for every object $U$ of $\mathcal{C}$ and $f \in \mathcal{I}(U)$
the object $T(K|_U, f)$ of $D(\mathcal{O}_U)$ is zero.
\end{definition}

\noindent
It is clear that the full subcategory
$D_{comp}(\mathcal{O}) = D_{comp}(\mathcal{O}, \mathcal{I}) \subset
D(\mathcal{O})$ consisting of derived complete objects
is a saturated triangulated subcategory, see
Derived Categories, Definitions
\ref{derived-definition-triangulated-subcategory} and
\ref{derived-definition-saturated}. This subcategory is preserved
under products and homotopy limits in $D(\mathcal{O})$.
But it is not preserved under countable direct sums in general.

\begin{lemma}
\label{lemma-derived-complete-internal-hom}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a sheaf of ideals.
If $K \in D(\mathcal{O})$ and $L \in D_{comp}(\mathcal{O})$, then
$R\SheafHom_\mathcal{O}(K, L) \in D_{comp}(\mathcal{O})$.
\end{lemma}

\begin{proof}
Let $U$ be an object of $\mathcal{C}$ and let $f \in \mathcal{I}(U)$.
Recall that
$$
\Hom_{D(\mathcal{O}_U)}(\mathcal{O}_{U, f}, R\SheafHom_\mathcal{O}(K, L)|_U)
=
\Hom_{D(\mathcal{O}_U)}(
K|_U \otimes_{\mathcal{O}_U}^\mathbf{L} \mathcal{O}_{U, f}, L|_U)
$$
by Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-internal-hom}.
The right hand side is zero by Lemma \ref{lemma-hom-from-Af}
and the relationship between internal hom and actual hom, see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-section-RHom-over-U}.
The same vanishing holds for all $U'/U$. Thus the object
$R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, f},
R\SheafHom_\mathcal{O}(K, L)|_U)$ of $D(\mathcal{O}_U)$ has vanishing
$0$th cohomology sheaf (by locus citatus). Similarly for the other
cohomology sheaves, i.e., $R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, f},
R\SheafHom_\mathcal{O}(K, L)|_U)$ is zero in $D(\mathcal{O}_U)$.
By Lemma \ref{lemma-hom-from-Af} we conclude.
\end{proof}

\begin{lemma}
\label{lemma-restriction-derived-complete}
Let $\mathcal{C}$ be a site. Let $\mathcal{O} \to \mathcal{O}'$
be a homomorphism of sheaves of rings. Let $\mathcal{I} \subset \mathcal{O}$
be a sheaf of ideals. The inverse image of $D_{comp}(\mathcal{O}, \mathcal{I})$
under the restriction functor $D(\mathcal{O}') \to D(\mathcal{O})$ is
$D_{comp}(\mathcal{O}', \mathcal{I}\mathcal{O}')$.
\end{lemma}

\begin{proof}
Using Lemma \ref{lemma-ideal-of-elements-complete-wrt}
we see that $K' \in D(\mathcal{O}')$ is in
$D_{comp}(\mathcal{O}', \mathcal{I}\mathcal{O}')$
if and only if $T(K'|_U, f)$ is zero for every local section
$f \in \mathcal{I}(U)$. Observe that the cohomology sheaves of
$T(K'|_U, f)$ are computed in the category of abelian sheaves,
so it doesn't matter whether we think of $f$ as a section of
$\mathcal{O}$ or take the image of $f$ as a section of $\mathcal{O}'$.
The lemma follows immediately from this and the
definition of derived complete objects.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-derived-complete}
Let $f : (\Sh(\mathcal{D}), \mathcal{O}') \to (\Sh(\mathcal{C}), \mathcal{O})$
be a morphism of ringed topoi. Let $\mathcal{I} \subset \mathcal{O}$
and $\mathcal{I}' \subset \mathcal{O}'$ be sheaves of ideals such
that $f^\sharp$ sends $f^{-1}\mathcal{I}$ into $\mathcal{I}'$.
Then $Rf_*$ sends $D_{comp}(\mathcal{O}', \mathcal{I}')$
into $D_{comp}(\mathcal{O}, \mathcal{I})$.
\end{lemma}

\begin{proof}
We may assume $f$ is given by a morphism of ringed sites corresponding
to a continuous functor $\mathcal{C} \to \mathcal{D}$
(Modules on Sites, Lemma
\ref{sites-modules-lemma-morphism-ringed-topoi-comes-from-morphism-ringed-sites}
).
Let $U$ be an object of $\mathcal{C}$ and let $g$ be a section of
$\mathcal{I}$ over $U$. We have to show that
$\Hom_{D(\mathcal{O}_U)}(\mathcal{O}_{U, g}, Rf_*K|_U) = 0$
whenever $K$ is derived complete with respect to $\mathcal{I}'$.
Namely, by Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-section-RHom-over-U}
this, applied to all objects over $U$ and all shifts of $K$,
will imply that $R\SheafHom_{\mathcal{O}_U}(\mathcal{O}_{U, g}, Rf_*K|_U)$
is zero, which implies that $T(Rf_*K|_U, g)$ is zero
(Lemma \ref{lemma-hom-from-Af}) which is what we have to show
(Definition \ref{definition-derived-complete}).
Let $V$ in $\mathcal{D}$ be the image of $U$. Then
$$
\Hom_{D(\mathcal{O}_U)}(\mathcal{O}_{U, g}, Rf_*K|_U) =
\Hom_{D(\mathcal{O}'_V)}(\mathcal{O}'_{V, g'}, K|_V) = 0
$$
where $g' = f^\sharp(g) \in \mathcal{I}'(V)$. The second equality
because $K$ is derived complete and the first equality because
the derived pullback of $\mathcal{O}_{U, g}$ is $\mathcal{O}'_{V, g'}$
and
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-adjoint}.
\end{proof}

\noindent
The following lemma is the simplest case where one has derived completion.

\begin{lemma}
\label{lemma-derived-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed on a site. Let $f_1, \ldots, f_r$
be global sections of $\mathcal{O}$. Let $\mathcal{I} \subset \mathcal{O}$ be
the ideal sheaf generated by $f_1, \ldots, f_r$.
Then the inclusion functor $D_{comp}(\mathcal{O}) \to D(\mathcal{O})$
has a left adjoint, i.e., given any object $K$ of $D(\mathcal{O})$
there exists a map $K \to K^\wedge$ with $K^\wedge$ in $D_{comp}(\mathcal{O})$
such that the map
$$
\Hom_{D(\mathcal{O})}(K^\wedge, E) \longrightarrow \Hom_{D(\mathcal{O})}(K, E)
$$
is bijective whenever $E$ is in $D_{comp}(\mathcal{O})$. In fact
we have
$$
K^\wedge =
R\SheafHom_\mathcal{O}
(\mathcal{O} \to \prod\nolimits_{i_0} \mathcal{O}_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{f_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{f_1\ldots f_r}, K)
$$
functorially in $K$.
\end{lemma}

\begin{proof}
Define $K^\wedge$ by the last displayed formula of the lemma.
There is a map of complexes
$$
(\mathcal{O} \to \prod\nolimits_{i_0} \mathcal{O}_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{f_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{f_1\ldots f_r}) \longrightarrow \mathcal{O}
$$
which induces a map $K \to K^\wedge$. It suffices to prove that
$K^\wedge$ is derived complete and that $K \to K^\wedge$ is an
isomorphism if $K$ is derived complete.

\medskip\noindent
Let $f$ be a global section of $\mathcal{O}$.
By Lemma \ref{lemma-map-twice-localize} the object
$R\SheafHom_\mathcal{O}(\mathcal{O}_f, K^\wedge)$
is equal to
$$
R\SheafHom_\mathcal{O}(
(\mathcal{O}_f \to \prod\nolimits_{i_0} \mathcal{O}_{ff_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{ff_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{ff_1\ldots f_r}), K)
$$
If $f = f_i$ for some $i$, then $f_1, \ldots, f_r$ generate the
unit ideal in $\mathcal{O}_f$, hence the extended alternating
{\v C}ech complex
$$
\mathcal{O}_f \to \prod\nolimits_{i_0} \mathcal{O}_{ff_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{ff_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{ff_1\ldots f_r}
$$
is zero (even homotopic to zero). In this way we see that $K^\wedge$
is derived complete.

\medskip\noindent
If $K$ is derived complete, then $R\SheafHom_\mathcal{O}(\mathcal{O}_f, K)$
is zero for all $f = f_{i_0} \ldots f_{i_p}$, $p \geq 0$. Thus
$K \to K^\wedge$ is an isomorphism in $D(\mathcal{O})$.
\end{proof}

\noindent
Next we explain why derived completion is a completion.

\begin{lemma}
\label{lemma-derived-completion-koszul}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed on a site. Let $f_1, \ldots, f_r$
be global sections of $\mathcal{O}$. Let $\mathcal{I} \subset \mathcal{O}$ be
the ideal sheaf generated by $f_1, \ldots, f_r$. Let $K \in D(\mathcal{O})$.
The derived completion $K^\wedge$ of Lemma \ref{lemma-derived-completion}
is given by the formula
$$
K^\wedge = R\lim K \otimes^\mathbf{L}_\mathcal{O} K_n
$$
where $K_n = K(\mathcal{O}, f_1^n, \ldots, f_r^n)$
is the Koszul complex on $f_1^n, \ldots, f_r^n$ over $\mathcal{O}$.
\end{lemma}

\begin{proof}
In More on Algebra, Lemma
\ref{more-algebra-lemma-extended-alternating-Cech-is-colimit-koszul}
we have seen that the extended alternating {\v C}ech complex
$$
\mathcal{O} \to \prod\nolimits_{i_0} \mathcal{O}_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{f_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{f_1\ldots f_r}
$$
is a colimit of the Koszul complexes
$K^n = K(\mathcal{O}, f_1^n, \ldots, f_r^n)$ sitting in
degrees $0, \ldots, r$. Note that $K^n$ is a finite chain complex
of finite free $\mathcal{O}$-modules with dual
$\SheafHom_\mathcal{O}(K^n, \mathcal{O}) = K_n$ where $K_n$ is the Koszul
cochain complex sitting in degrees $-r, \ldots, 0$ (as usual). By
Lemma \ref{lemma-derived-completion}
the functor $E \mapsto E^\wedge$ is gotten by taking
$R\SheafHom$ from the extended alternating {\v C}ech complex into $E$:
$$
E^\wedge = R\SheafHom(\colim K^n, E)
$$
This is equal to $R\lim (E \otimes_\mathcal{O}^\mathbf{L} K_n)$
by
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-colim-and-lim-of-duals}.
\end{proof}

\begin{lemma}
\label{lemma-all-rings}
There exist a way to construct
\begin{enumerate}
\item for every pair $(A, I)$ consisting of a ring $A$ and a finitely
generated ideal $I \subset A$ a complex $K(A, I)$ of $A$-modules,
\item a map $K(A, I) \to A$ of complexes of $A$-modules,
\item for every ring map $A \to B$ and finitely generated ideal $I \subset A$
a map of complexes $K(A, I) \to K(B, IB)$,
\end{enumerate}
such that
\begin{enumerate}
\item[(a)] for $A \to B$ and $I \subset A$ finitely generated the diagram
$$
\xymatrix{
K(A, I) \ar[r] \ar[d] & A \ar[d] \\
K(B, IB) \ar[r] & B
}
$$
commutes,
\item[(b)] for $A \to B \to C$ and $I \subset A$ finitely generated
the composition of the maps
$K(A, I) \to K(B, IB) \to K(C, IC)$ is the map $K(A, I) \to K(C, IC)$.
\item[(c)] for $A \to B$ and a finitely generated ideal $I \subset A$
the induced map $K(A, I) \otimes_A^\mathbf{L} B \to K(B, IB)$
is an isomorphism in $D(B)$, and
\item[(d)] if $I = (f_1, \ldots, f_r) \subset A$ then there is a commutative
diagram
$$
\xymatrix{
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \ar[r] \ar[d] &  K(A, I) \ar[d] \\
A \ar[r]^1 & A
}
$$
in $D(A)$ whose horizontal arrows are isomorphisms.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $S$ be the set of rings $A_0$ of the form
$A_0 = \mathbf{Z}[x_1, \ldots, x_n]/J$.
Every finite type $\mathbf{Z}$-algebra is isomorphic to
an element of $S$. Let $\mathcal{A}_0$ be the category whose objects
are pairs $(A_0, I_0)$ where $A_0 \in S$ and $I_0 \subset A_0$
is an ideal and whose morphisms $(A_0, I_0) \to (B_0, J_0)$ are
ring maps $\varphi : A_0 \to B_0$ such that $J_0 = \varphi(I_0)B_0$.

\medskip\noindent
Suppose we can construct $K(A_0, I_0) \to A_0$ functorially for
objects of $\mathcal{A}_0$ having properties (a), (b), (c), and (d).
Then we take
$$
K(A, I) = \colim_{\varphi : (A_0, I_0) \to (A, I)} K(A_0, I_0)
$$
where the colimit is over ring maps $\varphi : A_0 \to A$ such
that $\varphi(I_0)A = I$ with $(A_0, I_0)$ in $\mathcal{A}_0$.
A morphism between $(A_0, I_0) \to (A, I)$ and $(A_0', I_0') \to (A, I)$
are given by maps $(A_0, I_0) \to (A_0', I_0')$ in $\mathcal{A}_0$
commuting with maps to $A$.
The category of these $(A_0, I_0) \to (A, I)$ is filtered
(details omitted). Moreover, $\colim_{\varphi : (A_0, I_0) \to (A, I)} A_0 = A$
so that $K(A, I)$ is a complex of $A$-modules.
Finally, given $\varphi : A \to B$ and $I \subset A$
for every $(A_0, I_0) \to (A, I)$ in the colimit, the composition
$(A_0, I_0) \to (B, IB)$ lives in the colimit for $(B, IB)$.
In this way we get a map on colimits. Properties (a), (b), (c), and (d)
follow readily from this and the corresponding
properties of the complexes $K(A_0, I_0)$.

\medskip\noindent
Endow $\mathcal{C}_0 = \mathcal{A}_0^{opp}$ with the chaotic topology.
We equip $\mathcal{C}_0$ with the sheaf of rings
$\mathcal{O} : (A, I) \mapsto A$. The ideals $I$ fit together to give a
sheaf of ideals $\mathcal{I} \subset \mathcal{O}$.
Choose an injective resolution $\mathcal{O} \to \mathcal{J}^\bullet$.
Consider the object
$$
\mathcal{F}^\bullet = \bigcup\nolimits_n \mathcal{J}^\bullet[\mathcal{I}^n]
$$
Let $U = (A, I) \in \Ob(\mathcal{C}_0)$.
Since the topology in $\mathcal{C}_0$ is chaotic, the value
$\mathcal{J}^\bullet(U)$ is a resolution of $A$ by injective
$A$-modules. Hence the value $\mathcal{F}^\bullet(U)$ is an
object of $D(A)$ representing the image of $R\Gamma_I(A)$ in $D(A)$, see
Dualizing Complexes, Section \ref{dualizing-section-local-cohomology}.
Choose a complex of $\mathcal{O}$-modules $\mathcal{K}^\bullet$
and a commutative diagram
$$
\xymatrix{
\mathcal{O} \ar[r] & \mathcal{J}^\bullet \\
\mathcal{K}^\bullet \ar[r] \ar[u] & \mathcal{F}^\bullet \ar[u]
}
$$
where the horizontal arrows are quasi-isomorphisms. This is possible
by the construction of the derived category $D(\mathcal{O})$.
Set $K(A, I) = \mathcal{K}^\bullet(U)$ where $U = (A, I)$.
Properties (a) and (b) are clear and properties (c) and (d)
follow from Dualizing Complexes, Lemmas
\ref{dualizing-lemma-compute-local-cohomology-noetherian} and
\ref{dualizing-lemma-local-cohomology-change-rings}.
\end{proof}

\begin{lemma}
\label{lemma-global-extended-cech-complex}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let
$\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of ideals.
There exists a map $K \to \mathcal{O}$ in $D(\mathcal{O})$
such that for every $U \in \Ob(\mathcal{C})$ such that
$\mathcal{I}|_U$ is generated by $f_1, \ldots, f_r \in \mathcal{I}(U)$
there is an isomorphism
$$
(\mathcal{O}_U \to \prod\nolimits_{i_0} \mathcal{O}_{U, f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} \mathcal{O}_{U, f_{i_0}f_{i_1}} \to
\ldots \to \mathcal{O}_{U, f_1\ldots f_r}) \longrightarrow K|_U
$$
compatible with maps to $\mathcal{O}_U$.
\end{lemma}

\begin{proof}
Let $\mathcal{C}' \subset \mathcal{C}$ be the full subcategory
of objects $U$ such that $\mathcal{I}|_U$ is generated by
finitely many sections. Then $\mathcal{C}' \to \mathcal{C}$
is a special cocontinuous functor
(Sites, Definition \ref{sites-definition-special-cocontinuous-functor}).
Hence it suffices to work with $\mathcal{C}'$, see
Sites, Lemma \ref{sites-lemma-equivalence}.
In other words we may assume that for every
object $U$ of $\mathcal{C}$ there exists a finitely generated
ideal $I \subset \mathcal{I}(U)$ such that
$\mathcal{I}|_U = \Im(I \otimes \mathcal{O}_U \to \mathcal{O}_U)$.
We will say that $I$ generates $\mathcal{I}|_U$.
Warning: We do not know that $\mathcal{I}(U)$ is a finitely generated
ideal in $\mathcal{O}(U)$.

\medskip\noindent
Let $U$ be an object and $I \subset \mathcal{O}(U)$ a finitely
generated ideal which generates $\mathcal{I}|_U$.
On the category $\mathcal{C}/U$ consider the complex of presheaves
$$
K_{U, I}^\bullet : U'/U \longmapsto K(\mathcal{O}(U'), I\mathcal{O}(U'))
$$
with $K(-, -)$ as in Lemma \ref{lemma-all-rings}.
We claim that the sheafification of this is independent of
the choice of $I$. Indeed, if $I' \subset \mathcal{O}(U)$
is a finitely generated ideal which also generates $\mathcal{I}|_U$, then
there exists a covering $\{U_j \to U\}$ such that
$I\mathcal{O}(U_j) = I'\mathcal{O}(U_j)$. (Hint: this works because
both $I$ and $I'$ are finitely generated and generate $\mathcal{I}|_U$.)
Hence $K_{U, I}^\bullet$ and $K_{U, I'}^\bullet$ are the {\it same}
for any object lying over one of the $U_j$. The statement
on sheafifications follows. Denote $K_U^\bullet$ the common value.

\medskip\noindent
The independence of choice of $I$ also shows that
$K_U^\bullet|_{\mathcal{C}/U'} = K_{U'}^\bullet$
whenever we are given a morphism
$U' \to U$ and hence a localization morphism
$\mathcal{C}/U' \to \mathcal{C}/U$. Thus the complexes
$K_U^\bullet$ glue to give a single well defined complex $K^\bullet$
of $\mathcal{O}$-modules. The existence of the map $K^\bullet \to \mathcal{O}$
and the quasi-isomorphism of the lemma follow immediately from
the corresponding properties of the complexes $K(-, -)$ in
Lemma \ref{lemma-all-rings}.
\end{proof}

\begin{proposition}
\label{proposition-derived-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of
ideals. There exists a left adjoint to the inclusion
functor $D_{comp}(\mathcal{O}) \to D(\mathcal{O})$.
\end{proposition}

\begin{proof}
Let $K \to \mathcal{O}$ in $D(\mathcal{O})$ be as constructed in
Lemma \ref{lemma-global-extended-cech-complex}. Let $E \in D(\mathcal{O})$.
Then $E^\wedge = R\SheafHom(K, E)$ together with the map $E \to E^\wedge$
will do the job. Namely, locally on the site $\mathcal{C}$ we
recover the adjoint of Lemma \ref{lemma-derived-completion}.
This shows that $E^\wedge$ is always derived complete and that
$E \to E^\wedge$ is an isomorphism if $E$ is derived complete.
\end{proof}

\begin{remark}[Comparison with completion]
\label{remark-compare-with-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of
ideals. Let $K \mapsto K^\wedge$ be the derived completion functor
of Proposition \ref{proposition-derived-completion}.
For any $n \geq 1$ the object
$K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}/\mathcal{I}^n$
is derived complete as it is annihilated by powers of
local sections of $\mathcal{I}$. Hence there is a canonical factorization
$$
K \to K^\wedge \to K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}/\mathcal{I}^n
$$
of the canonical map
$K \to K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}/\mathcal{I}^n$.
These maps are compatible for varying $n$ and we obtain a comparison map
$$
K^\wedge
\longrightarrow
R\lim \left(K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}/\mathcal{I}^n\right)
$$
The right hand side is more recognizable as a kind of completion.
In general this comparison map is not an isomorphism.
\end{remark}

\begin{remark}[Localization and derived completion]
\label{remark-localization-and-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of
ideals. Let $K \mapsto K^\wedge$ be the derived completion functor
of Proposition \ref{proposition-derived-completion}. It follows
from the construction in the proof of the proposition that $K^\wedge|_U$
is the derived completion of $K|_U$ for any $U \in \Ob(\mathcal{C})$.
But we can also prove this as follows. From the definition
of derived complete objects it follows that $K^\wedge|_U$ is derived complete.
Thus we obtain a canonical map $a : (K|_U)^\wedge \to K^\wedge|_U$.
On the other hand, if $E$ is a derived complete object of
$D(\mathcal{O}_U)$, then $Rj_*E$ is a derived complete object of
$D(\mathcal{O})$ by Lemma \ref{lemma-pushforward-derived-complete}.
Here $j$ is the localization morphism
(Modules on Sites, Section \ref{sites-modules-section-localize}).
Hence we also obtain a canonical
map $b : K^\wedge \to Rj_*((K|_U)^\wedge)$. We omit the (formal) verification
that the adjoint of $b$ is the inverse of $a$.
\end{remark}

\begin{remark}[Completed tensor product]
\label{remark-completed-tensor-product}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let
$\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of ideals. 
Denote $K \mapsto K^\wedge$ the adjoint of
Proposition \ref{proposition-derived-completion}.
Then we set
$$
K \otimes^\wedge_\mathcal{O} L = (K \otimes_\mathcal{O}^\mathbf{L} L)^\wedge
$$
This {\it completed tensor product} defines a functor
$D_{comp}(\mathcal{O}) \times D_{comp}(\mathcal{O}) \to D_{comp}(\mathcal{O})$
such that we have
$$
\Hom_{D_{comp}(\mathcal{O})}(K, R\SheafHom_\mathcal{O}(L, M))
=
\Hom_{D_{comp}(\mathcal{O})}(K \otimes_\mathcal{O}^\wedge L, M)
$$
for $K, L, M \in D_{comp}(\mathcal{O})$. Note that
$R\SheafHom_\mathcal{O}(L, M) \in D_{comp}(\mathcal{O})$ by
Lemma \ref{lemma-derived-complete-internal-hom}.
\end{remark}

\begin{lemma}
\label{lemma-map-identifies-koszul-and-cech-complexes}
Let $\mathcal{C}$ be a site.
Assume $\varphi : \mathcal{O} \to \mathcal{O}'$ is a flat homomorphism
of sheaves of rings. Let $f_1, \ldots, f_r$ be global sections
of $\mathcal{O}$ such that
$\mathcal{O}/(f_1, \ldots, f_r) \cong \mathcal{O}'/(f_1, \ldots, f_r)$.
Then the map of extended alternating {\v C}ech complexes
$$
\xymatrix{
\mathcal{O} \to
\prod_{i_0} \mathcal{O}_{f_{i_0}} \to
\prod_{i_0 < i_1} \mathcal{O}_{f_{i_0}f_{i_1}} \to \ldots \to
\mathcal{O}_{f_1\ldots f_r} \ar[d] \\
\mathcal{O}' \to
\prod_{i_0} \mathcal{O}'_{f_{i_0}} \to
\prod_{i_0 < i_1} \mathcal{O}'_{f_{i_0}f_{i_1}} \to \ldots \to
\mathcal{O}'_{f_1\ldots f_r}
}
$$
is a quasi-isomorphism.
\end{lemma}

\begin{proof}
Observe that the second complex is the tensor product of the first
complex with $\mathcal{O}'$. We can write the first extended
alternating {\v C}ech complex as a colimit of the Koszul complexes
$K_n = K(\mathcal{O}, f_1^n, \ldots, f_r^n)$, see
More on Algebra, Lemma
\ref{more-algebra-lemma-extended-alternating-Cech-is-colimit-koszul}.
Hence it suffices to prove $K_n \to K_n \otimes_\mathcal{O} \mathcal{O}'$
is a quasi-isomorphism. Since $\mathcal{O} \to \mathcal{O}'$ is flat
it suffices to show that $H^i \to H^i \otimes_\mathcal{O} \mathcal{O}'$
is an isomorphism where $H^i$ is the $i$th cohomology sheaf
$H^i = H^i(K_n)$. These sheaves are annihilated by $f_1^n, \ldots, f_r^n$, see
More on Algebra, Lemma \ref{more-algebra-lemma-homotopy-koszul}.
Thus it suffices to show that
$\mathcal{O}/(f_1^n, \ldots, f_r^n) \to \mathcal{O}'/(f_1^n, \ldots, f_r^n)$
is an isomorphism. Equivalently, we will show that
$\mathcal{O}/(f_1, \ldots, f_r)^n \to \mathcal{O}'/(f_1, \ldots, f_r)^n$
is an isomorphism for all $n$. This holds for $n = 1$ by assumption.
It follows for all $n$ by induction using
Modules on Sites, Lemma \ref{sites-modules-lemma-flat-over-thickening}
applied to the ring map
$\mathcal{O}/(f_1, \ldots, f_r)^{n + 1} \to \mathcal{O}/(f_1, \ldots, f_r)^n$
and the module $\mathcal{O}'/(f_1, \ldots, f_r)^{n + 1}$.
\end{proof}

\begin{lemma}
\label{lemma-restriction-derived-complete-equivalence}
Let $\mathcal{C}$ be a site. Let $\mathcal{O} \to \mathcal{O}'$ be a
homomorphism of sheaves of rings. Let $\mathcal{I} \subset \mathcal{O}$
be a finite type sheaf of ideals.
If $\mathcal{O} \to \mathcal{O}'$ is flat and
$\mathcal{O}/\mathcal{I} \cong \mathcal{O}'/\mathcal{I}\mathcal{O}'$,
then the restriction functor $D(\mathcal{O}') \to D(\mathcal{O})$
induces an equivalence
$D_{comp}(\mathcal{O}', \mathcal{I}\mathcal{O}') \to
D_{comp}(\mathcal{O}, \mathcal{I})$.
\end{lemma}

\begin{proof}
Lemma \ref{lemma-pushforward-derived-complete} implies
restriction $r : D(\mathcal{O}') \to D(\mathcal{O})$
sends $D_{comp}(\mathcal{O}', \mathcal{I}\mathcal{O}')$
into $D_{comp}(\mathcal{O}, \mathcal{I})$. We will construct a
quasi-inverse $E \mapsto E'$.

\medskip\noindent
Let $K \to \mathcal{O}$ be the morphism of $D(\mathcal{O})$
constructed in Lemma \ref{lemma-global-extended-cech-complex}. 
Set $K' = K \otimes_\mathcal{O}^\mathbf{L} \mathcal{O}'$ in $D(\mathcal{O}')$.
Then $K' \to \mathcal{O}'$ is a map in $D(\mathcal{O}')$ which
satisfies the conclusions of Lemma \ref{lemma-global-extended-cech-complex}
with respect to $\mathcal{I}' = \mathcal{I}\mathcal{O}'$.
The map $K \to r(K')$ is a quasi-isomorphism by
Lemma \ref{lemma-map-identifies-koszul-and-cech-complexes}.
Now, for $E \in D_{comp}(\mathcal{O}, \mathcal{I})$ we set
$$
E' = R\SheafHom_\mathcal{O}(r(K'), E)
$$
viewed as an object in $D(\mathcal{O}')$ using the $\mathcal{O}'$-module
structure on $K'$. Since $E$ is derived complete
we have $E = R\SheafHom_\mathcal{O}(K, E)$, see
proof of Proposition \ref{proposition-derived-completion}.
On the other hand, since $K \to r(K')$ is an isomorphism in
we see that there is an isomorphism
$E \to r(E')$ in $D(\mathcal{O})$. To finish the proof we
have to show that, if $E = r(M')$ for an object $M'$ of
$D_{comp}(\mathcal{O}', \mathcal{I}')$, then
$E' \cong M'$. To get a map we use
$$
M' = R\SheafHom_{\mathcal{O}'}(\mathcal{O}', M') \to
R\SheafHom_\mathcal{O}(r(\mathcal{O}'), r(M')) \to
R\SheafHom_\mathcal{O}(r(K'), r(M')) = E'
$$
where the second arrow uses the map $K' \to \mathcal{O}'$.
To see that this is an isomorphism, one shows that $r$ applied
to this arrow is the same as the isomorphism $E \to r(E')$ above.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-derived-complete-adjoint}
Let $f : (\Sh(\mathcal{D}), \mathcal{O}') \to (\Sh(\mathcal{C}), \mathcal{O})$
be a morphism of ringed topoi. Let $\mathcal{I} \subset \mathcal{O}$
and $\mathcal{I}' \subset \mathcal{O}'$ 
be finite type sheaves of ideals such that $f^\sharp$ sends
$f^{-1}\mathcal{I}$ into $\mathcal{I}'$.
Then $Rf_*$ sends $D_{comp}(\mathcal{O}', \mathcal{I}')$
into $D_{comp}(\mathcal{O}, \mathcal{I})$ and has a left adjoint
$Lf_{comp}^*$ which is $Lf^*$ followed by derived completion.
\end{lemma}

\begin{proof}
The first statement we have seen in
Lemma \ref{lemma-pushforward-derived-complete}.
Note that the second statement makes sense as we have a derived
completion functor $D(\mathcal{O}') \to D_{comp}(\mathcal{O}', \mathcal{I}')$
by Proposition \ref{proposition-derived-completion}.
OK, so now let $K \in D_{comp}(\mathcal{O}, \mathcal{I})$
and $M \in D_{comp}(\mathcal{O}', \mathcal{I}')$. Then we have
$$
\Hom(K, Rf_*M) = \Hom(Lf^*K, M) = \Hom(Lf_{comp}^*K, M)
$$
by the universal property of derived completion.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-commutes-with-derived-completion}
\begin{reference}
Generalization of \cite[Lemma 6.5.9 (2)]{BS}. Compare with
\cite[Theorem 6.5]{HL-P} in the setting of quasi-coherent modules
and morphisms of (derived) algebraic stacks.
\end{reference}
Let $f : (\Sh(\mathcal{D}), \mathcal{O}') \to (\Sh(\mathcal{C}), \mathcal{O})$
be a morphism of ringed topoi. Let $\mathcal{I} \subset \mathcal{O}$
be a finite type sheaf of ideals. Let $\mathcal{I}' \subset \mathcal{O}'$
be the ideal generated by $f^\sharp(f^{-1}\mathcal{I})$.
Then $Rf_*$ commutes with derived completion, i.e.,
$Rf_*(K^\wedge) = (Rf_*K)^\wedge$.
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-derived-completion} the derived completion
functors exist. By Lemma \ref{lemma-pushforward-derived-complete} the object
$Rf_*(K^\wedge)$ is derived complete, and hence we obtain a canonical map
$(Rf_*K)^\wedge \to Rf_*(K^\wedge)$ by the universal property of derived
completion. We may check this map is an isomorphism locally on $\mathcal{C}$.
Thus, since derived completion commutes with localization
(Remark \ref{remark-localization-and-completion}) we may assume
that $\mathcal{I}$ is generated by global sections $f_1, \ldots, f_r$.
Then $\mathcal{I}'$ is generated by $g_i = f^\sharp(f_i)$. By
Lemma \ref{lemma-derived-completion-koszul}
we have to prove that
$$
R\lim \left(
Rf_*K \otimes^\mathbf{L}_\mathcal{O} K(\mathcal{O}, f_1^n, \ldots, f_r^n)
\right)
=
Rf_*\left(
R\lim
K \otimes^\mathbf{L}_{\mathcal{O}'} K(\mathcal{O}', g_1^n, \ldots, g_r^n)
\right)
$$
Because $Rf_*$ commutes with $R\lim$
(Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-Rf-commutes-with-Rlim})
it suffices to prove that
$$
Rf_*K \otimes^\mathbf{L}_\mathcal{O} K(\mathcal{O}, f_1^n, \ldots, f_r^n) =
Rf_*\left(
K \otimes^\mathbf{L}_{\mathcal{O}'} K(\mathcal{O}', g_1^n, \ldots, g_r^n)
\right)
$$
This follows from the projection formula (Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-projection-formula}) and the fact that
$Lf^*K(\mathcal{O}, f_1^n, \ldots, f_r^n) =
K(\mathcal{O}', g_1^n, \ldots, g_r^n)$.
\end{proof}

\begin{lemma}
\label{lemma-formal-functions-general}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Let $\mathcal{C}$ be a site and let $\mathcal{O}$ be a sheaf
of $A$-algebras. Let $\mathcal{F}$ be a sheaf of $\mathcal{O}$-modules.
Then we have
$$
R\Gamma(\mathcal{C}, \mathcal{F})^\wedge =
R\Gamma(\mathcal{C}, \mathcal{F}^\wedge)
$$
in $D(A)$ where $\mathcal{F}^\wedge$ is the derived
completion of $\mathcal{F}$ with respect to $I\mathcal{O}$ and on the
left hand wide we have the derived completion with respect to $I$.
This produces two spectral sequences
$$
E_2^{i, j} = H^i(H^j(\mathcal{C}, \mathcal{F})^\wedge)
\quad\text{and}\quad
E_2^{p, q} = H^p(\mathcal{C}, H^q(\mathcal{F}^\wedge))
$$
both converging to
$H^*(R\Gamma(\mathcal{C}, \mathcal{F})^\wedge) =
H^*(\mathcal{C}, \mathcal{F}^\wedge)$
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-pushforward-commutes-with-derived-completion}
to the morphism of ringed topoi $(\mathcal{C}, \mathcal{O}) \to (pt, A)$
and take cohomology to get the first statement. The second spectral sequence
is just the Leray spectral sequence for this morphism, see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-Leray}.
The first spectral sequence is the spectral sequence of
More on Algebra, Example
\ref{more-algebra-example-derived-completion-spectral-sequence}
applied to $R\Gamma(\mathcal{C}, \mathcal{F})^\wedge$.
\end{proof}

\begin{remark}
\label{remark-local-calculation-derived-completion}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
Let $\mathcal{I} \subset \mathcal{O}$ be a finite type sheaf of
ideals. Let $K \mapsto K^\wedge$ be the derived completion of
Proposition \ref{proposition-derived-completion}.
Let $U \in \Ob(\mathcal{C})$ be an object such that $\mathcal{I}$
is generated as an ideal sheaf by $f_1, \ldots, f_r \in \mathcal{I}(U)$.
Set $A = \mathcal{O}(U)$ and $I = (f_1, \ldots, f_r) \subset A$.
Warning: it may not be the case that $I = \mathcal{I}(U)$.
Then we have
$$
R\Gamma(U, K^\wedge) = R\Gamma(U, K)^\wedge
$$
where the right hand side is the derived completion of
the object $R\Gamma(U, K)$ of $D(A)$ with respect to $I$.
This is true because derived completion commutes with localization
(Remark \ref{remark-localization-and-completion}) and
Lemma \ref{lemma-formal-functions-general}.
\end{remark}








\section{Application to theorem on formal functions}
\label{section-formal-functions}

\noindent
We interrupt the flow of the exposition to talk a little bit about
derived completion in the setting of quasi-coherent modules on schemes
and to use this to give a somewhat different proof of the theorem on
formal functions. We give some pointers to the literature in
Remark \ref{remark-references}.

\medskip\noindent
Lemma \ref{lemma-pushforward-commutes-with-derived-completion} is a
(very formal) derived version of the theorem on formal functions
(Cohomology of Schemes, Theorem \ref{coherent-theorem-formal-functions}).
To make this more explicit, suppose $f : X \to S$ is a morphism of schemes,
$\mathcal{I} \subset \mathcal{O}_S$ is a quasi-coherent sheaf of ideals
of finite type,
and $\mathcal{F}$ is a quasi-coherent sheaf on $X$. Then the lemma says that
\begin{equation}
\label{equation-formal-functions}
Rf_*(\mathcal{F}^\wedge) = (Rf_*\mathcal{F})^\wedge
\end{equation}
where $\mathcal{F}^\wedge$ is the derived completion of $\mathcal{F}$
with respect to $f^{-1}\mathcal{I} \cdot \mathcal{O}_X$ and the right
hand side is the derived completion of $\mathcal{F}$
with respect to $\mathcal{I}$. To see that this gives back the theorem
on formal functions we have to do a bit of work.

\begin{lemma}
\label{lemma-sections-derived-completion-pseudo-coherent}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. Let $K$ be a
pseudo-coherent object of $D(\mathcal{O}_X)$ with derived completion
$K^\wedge$. Then
$$
H^p(U, K^\wedge) = \lim H^p(U, K)/I^nH^p(U, K) =
H^p(U, K)^\wedge
$$
for any affine open $U \subset X$
where $I = \mathcal{I}(U)$ and where on the right we have the derived
completion with respect to $I$.
\end{lemma}

\begin{proof}
Write $U = \Spec(A)$. The ring $A$ is Noetherian
and hence $I \subset A$ is finitely generated. Then we have
$$
R\Gamma(U, K^\wedge) = R\Gamma(U, K)^\wedge
$$
by Remark \ref{remark-local-calculation-derived-completion}.
Now $R\Gamma(U, K)$ is a pseudo-coherent complex of $A$-modules
(Derived Categories of Schemes, Lemma
\ref{perfect-lemma-pseudo-coherent-affine}).
By More on Algebra, Lemma
\ref{more-algebra-lemma-derived-completion-pseudo-coherent}
we conclude that the $p$th cohomology module of $R\Gamma(U, K^\wedge)$
is equal to the $I$-adic completion of $H^p(U, K)$.
This proves the first equality. The second (less important) equality
follows immediately from a second application of the lemma just used.
\end{proof}

\begin{lemma}
\label{lemma-derived-completion-pseudo-coherent}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{I} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals.
Let $K$ be an object of $D(\mathcal{O}_X)$. Then
\begin{enumerate}
\item the derived completion $K^\wedge$ is equal to
$R\lim (K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_X/\mathcal{I}^n)$.
\end{enumerate}
Let $K$ is a pseudo-coherent object of $D(\mathcal{O}_X)$. Then
\begin{enumerate}
\item[(2)] the cohomology sheaf $H^q(K^\wedge)$ is equal to
$\lim H^q(K)/\mathcal{I}^nH^q(K)$.
\end{enumerate}
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module\footnote{For example
$H^q(K)$ for $K$ pseudo-coherent on our locally Noetherian $X$.}. Then
\begin{enumerate}
\item[(3)] the derived completion $\mathcal{F}^\wedge$ is equal to
$\lim \mathcal{F}/\mathcal{I}^n\mathcal{F}$,
\item[(4)]
$\lim \mathcal{F}/I^n \mathcal{F} = R\lim \mathcal{F}/I^n \mathcal{F}$,
\item[(5)] $H^p(U, \mathcal{F}^\wedge) = 0$ for $p \not = 0$ for all
affine opens $U \subset X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). There is a canonical map
$$
K \longrightarrow
R\lim (K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_X/\mathcal{I}^n),
$$
see Remark \ref{remark-compare-with-completion}.
Derived completion commutes with passing to open subschemes
(Remark \ref{remark-localization-and-completion}).
Formation of $R\lim$ commutes with passsing to open subschemes.
It follows that to check our map is an isomorphism, we may work locally.
Thus we may assume $X = U = \Spec(A)$.
Say $I = (f_1, \ldots, f_r)$. Let
$K_n = K(A, f_1^n, \ldots, f_r^n)$ be the Koszul complex.
By More on Algebra, Lemma \ref{more-algebra-lemma-sequence-Koszul-complexes}
we have seen that the pro-systems $\{K_n\}$ and
$\{A/I^n\}$ of $D(A)$ are isomorphic.
Using the equivalence $D(A) = D_{\QCoh}(\mathcal{O}_X)$
of Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}
we see that the pro-systems $\{K(\mathcal{O}_X, f_1^n, \ldots, f_r^n)\}$
and $\{\mathcal{O}_X/\mathcal{I}^n\}$ are isomorphic in
$D(\mathcal{O}_X)$. This proves the second equality in
$$
K^\wedge = R\lim \left(
K \otimes_{\mathcal{O}_X}^\mathbf{L} K(\mathcal{O}_X, f_1^n, \ldots, f_r^n)
\right) =
R\lim (K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_X/\mathcal{I}^n)
$$
The first equality is
Lemma \ref{lemma-derived-completion-koszul}.

\medskip\noindent
Assume $K$ is pseudo-coherent. For $U \subset X$ affine open
we have $H^q(U, K^\wedge) = \lim H^q(U, K)/\mathcal{I}^n(U)H^q(U, K)$
by Lemma \ref{lemma-sections-derived-completion-pseudo-coherent}.
As this is true for every $U$ we see that
$H^q(K^\wedge) = \lim H^q(K)/\mathcal{I}^nH^q(K)$ as sheaves.
This proves (2).

\medskip\noindent
Part (3) is a special case of (2).
Parts (4) and (5) follow from
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-Rlim-quasi-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-formal-functions}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal. Let $X$ be a
Noetherian scheme over $A$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_X$-module. Assume that $H^p(X, \mathcal{F})$ is
a finite $A$-module for all $p$. Then there are short exact sequences
$$
0 \to R^1\lim H^{p - 1}(X, \mathcal{F}/I^n\mathcal{F}) \to
H^p(X, \mathcal{F})^\wedge \to \lim H^p(X, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
of $A$-modules where $H^p(X, \mathcal{F})^\wedge$ is the usual $I$-adic
completion. If $f$ is proper, then the $R^1\lim$ term is zero.
\end{lemma}

\begin{proof}
Consider the two spectral sequences of
Lemma \ref{lemma-formal-functions-general}.
The first degenerates by More on Algebra, Lemma
\ref{more-algebra-lemma-derived-completion-pseudo-coherent}.
We obtain $H^p(X, \mathcal{F})^\wedge$ in degree $p$.
This is where we use the assumption that $H^p(X, \mathcal{F})$ is
a finite $A$-module. The second degenerates because
$$
\mathcal{F}^\wedge = \lim \mathcal{F}/I^n\mathcal{F} =
R\lim \mathcal{F}/I^n\mathcal{F}
$$
is a sheaf by Lemma \ref{lemma-derived-completion-pseudo-coherent}.
We obtain $H^p(X, \lim \mathcal{F}/I^n\mathcal{F})$ in degree $p$.
Since $R\Gamma(X, -)$ commutes with derived limits
(Injectives, Lemma \ref{injectives-lemma-RF-commutes-with-Rlim})
we also get
$$
R\Gamma(X, \lim \mathcal{F}/I^n\mathcal{F}) =
R\Gamma(X, R\lim \mathcal{F}/I^n\mathcal{F}) =
R\lim R\Gamma(X, \mathcal{F}/I^n\mathcal{F})
$$
By More on Algebra, Remark
\ref{more-algebra-remark-how-unique}
we obtain exact sequences
$$
0 \to
R^1\lim H^{p - 1}(X, \mathcal{F}/I^n\mathcal{F}) \to
H^p(X, \lim \mathcal{F}/I^n\mathcal{F}) \to
\lim H^p(X, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
of $A$-modules. Combining the above we get the first statement of the lemma.
The vanishing of the $R^1\lim$ term follows from
Cohomology of Schemes, Lemma \ref{coherent-lemma-ML-cohomology-powers-ideal}.
\end{proof}

\begin{remark}
\label{remark-references}
Here are some references to discussions of related material the literature.
It seems that a ``derived formal functions theorem'' for proper maps
goes back to \cite[Theorem 6.3.1]{lurie-thesis}.
There is the discussion in \cite{dag12}, especially
Chapter 4 which discusses the affine story, see
More on Algebra, Section \ref{more-algebra-section-derived-completion}.
In \cite[Section 2.9]{G-R} one finds a discussion of proper base change and
derived completion using (ind) coherent modules.
An analogue of (\ref{equation-formal-functions})
for complexes of quasi-coherent modules can be found as
\cite[Theorem 6.5]{HL-P}
\end{remark}







\section{Algebraization of local cohomology}
\label{section-algebraization-sections-general}

\noindent
Let $A$ be a Noetherian ring and let $I$ and $J$ be two ideals of $A$.
Let $M$ be a finite $A$-module. In this section we study the
cohomology groups of the object
$$
R\Gamma_J(M)^\wedge
\quad\text{of}\quad
D(A)
$$
where ${}^\wedge$ denotes derived $I$-adic completion. Observe that in
Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local-H0}
we have shown, if $A$ is complete with respect to $I$,
that there is an isomorphism
$$
\colim H^0_Z(M) \longrightarrow H^0(R\Gamma_J(M)^\wedge)
$$
where the (directed) colimit is over the closed subsets $Z = V(J')$
with $J' \subset J$ and $V(J') \cap V(I) = V(J) \cap V(I)$.
The union of these closed subsets is
\begin{equation}
\label{equation-associated-subset}
T = \{\mathfrak p \in \Spec(A) :
V(\mathfrak p) \cap V(I) \subset V(J) \cap V(I)\}
\end{equation}
This is a subset of $\Spec(A)$ stable under specialization.
The result above becomes the statement that
$$
H^0_T(M) \longrightarrow H^0(R\Gamma_J(M)^\wedge)
$$
is an isomorphism provided $A$ is complete with respect to $I$, see
Lemma \ref{lemma-adjoint-ext} and
Remark \ref{remark-upshot}.
Our method to extend this isomorphism to higher cohomology groups
rests on the following lemma.

\begin{lemma}
\label{lemma-kill-completion-general}
Let $I, J$ be ideals of a Noetherian ring $A$.
Let $M$ be a finite $A$-module. Let $\mathfrak p \subset A$ be a prime.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item $\mathfrak p \not \in V(J) \cap V(I)$,
\item $\text{cd}(A, I) \leq d$, and
\item for all primes $\mathfrak p' \subset \mathfrak p$
we have
$\text{depth}_{A_{\mathfrak p'}}(M_{\mathfrak p'}) +
\dim((A/\mathfrak p')_\mathfrak q) > d + s$
for all $\mathfrak q \in V(\mathfrak p') \cap V(J) \cap V(I)$.
\end{enumerate}
Then there exists an $f \in A$, $f \not \in \mathfrak p$ which annihilates
$H^i(R\Gamma_J(M)^\wedge)$ for $i \leq s$ where ${}^\wedge$
indicates $I$-adic completion.
\end{lemma}

\begin{proof}
We will use that $R\Gamma_J = R\Gamma_{V(J)}$ and similarly for
$I + J$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-noetherian}.
Observe that
$R\Gamma_J(M)^\wedge = R\Gamma_I(R\Gamma_J(M))^\wedge =
R\Gamma_{I + J}(M)^\wedge$, see
Dualizing Complexes, Lemmas
\ref{dualizing-lemma-complete-and-local} and
\ref{dualizing-lemma-local-cohomology-ss}.
Thus we may replace $J$ by $I + J$ and assume $I \subset J$
and $\mathfrak p \not \in V(J)$.
Recall that
$$
R\Gamma_J(M)^\wedge = R\Hom_A(R\Gamma_I(A), R\Gamma_J(M))
$$
by the description of derived completion in
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion}
combined with the description of local cohomology in
Dualizing Complexes, Lemma
\ref{dualizing-lemma-compute-local-cohomology-noetherian}.
Assumption (3) means that $R\Gamma_I(A)$ has nonzero cohomology
only in degrees $\leq d$. Using the canonical truncations of
$R\Gamma_I(A)$ we find it suffices to show that
$$
\text{Ext}^i(N, R\Gamma_J(M))
$$
is annihilated by an $f \in A$, $f \not \in \mathfrak p$ for
$i \leq s + d$ and any $A$-module $N$.
In turn using the canonical truncations for $R\Gamma_J(M)$
we see that it suffices to show
$H^i_J(M)$ is annihilated by an $f \in A$, $f \not \in \mathfrak p$
for $i \leq s + d$.
This follows from Lemma \ref{lemma-kill-local-cohomology-at-prime}.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-weak-general}
Let $I, J$ be ideals of a Noetherian ring. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. With $T$ as in
(\ref{equation-associated-subset}) assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item if $\mathfrak p \in V(I)$, then no condition,
\item if $\mathfrak p \not \in V(I)$, $\mathfrak p \in T$, then
$\dim((A/\mathfrak p)_\mathfrak q) \leq d$ for some
$\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$,
\item if $\mathfrak p \not \in V(I)$, $\mathfrak p \not \in T$, then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
for all $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$.
\end{enumerate}
Then there exists an ideal $J_0 \subset J$ with
$V(J_0) \cap V(I) = V(J) \cap V(I)$ such that for any $J' \subset J_0$ with
$V(J') \cap V(I) = V(J) \cap V(I)$ the map
$$
R\Gamma_{J'}(M) \longrightarrow R\Gamma_{J_0}(M)
$$
induces an isomorphism in cohomology in degrees $\leq s$
and moreover these modules are annihilated by a power of $J_0I$.
\end{lemma}

\begin{proof}
Let us consider the set
$$
B = \{\mathfrak p \not \in V(I),\ \mathfrak p \in T,\text{ and }
\text{depth}(M_\mathfrak p) \leq s\}
$$
Choose $J_0 \subset J$ such that $V(J_0)$ is the closure of $B \cup V(J)$.

\medskip\noindent
Claim I: $V(J_0) \cap V(I) = V(J) \cap V(I)$.

\medskip\noindent
Proof of Claim I. The inclusion $\supset$ holds by construction.
Let $\mathfrak p$ be a minimal prime of $V(J_0)$.
If $\mathfrak p \in B \cup V(J)$, then either $\mathfrak p \in T$
or $\mathfrak p \in V(J)$ and in both cases
$V(\mathfrak p) \cap V(I) \subset V(J) \cap V(I)$ as desired.
If $\mathfrak p \not \in B \cup V(J)$, then
$V(\mathfrak p) \cap B$ is dense, hence infinite, and we conclude that
$\text{depth}(M_\mathfrak p) < s$ by Lemma \ref{lemma-depth-function}.
In fact, let
$V(\mathfrak p) \cap B = \{\mathfrak p_\lambda\}_{\lambda \in \Lambda}$.
Pick $\mathfrak q_\lambda \in V(\mathfrak p_\lambda) \cap V(J) \cap V(I)$
as in (3).
Let $\delta : \Spec(A) \to \mathbf{Z}$ be the dimension function
associated to a dualizing complex $\omega_A^\bullet$ for $A$.
Since $\Lambda$ is infinite and $\delta$ is bounded,
there exists an infinite subset $\Lambda' \subset \Lambda$ on which
$\delta(\mathfrak q_\lambda)$ is constant. For
$\lambda \in \Lambda'$ we have
$$
\text{depth}(M_{\mathfrak p_\lambda}) +
\delta(\mathfrak p_\lambda) - \delta(\mathfrak q_\lambda) =
\text{depth}(M_{\mathfrak p_\lambda}) +
\dim((A/\mathfrak p_\lambda)_{\mathfrak q_\lambda})
\leq d + s
$$
by (3) and the definition of $B$. By the semi-continuity of
the function $\text{depth} + \delta$ proved in
Duality for Schemes, Lemma \ref{duality-lemma-sitting-in-degrees}
we conclude that
$$
\text{depth}(M_\mathfrak p) +
\dim((A/\mathfrak p)_{\mathfrak q_\lambda}) =
\text{depth}(M_\mathfrak p) + \delta(\mathfrak p) - \delta(\mathfrak q_\lambda)
\leq d + s
$$
Since also $\mathfrak p \not \in V(I)$ we read off from (4) that
$\mathfrak p \in T$, i.e.,
$V(\mathfrak p) \cap V(I) \subset V(J) \cap V(I)$. This finishes the
proof of Claim I.

\medskip\noindent
Claim II: $H^i_{J_0}(M) \to H^i_J(M)$ is an isomorphism for $i \leq s$
and $J' \subset J_0$ with $V(J') \cap V(I) = V(J) \cap V(I)$.

\medskip\noindent
Proof of claim II. Choose $\mathfrak p \in V(J')$ not in $V(J_0)$.
It suffices to show that $H^i_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$
for $i \leq s$, see Lemma \ref{lemma-isomorphism}.
Observe that $\mathfrak p \in T$. Hence since $\mathfrak p$ is not in $B$
we see that $\text{depth}(M_\mathfrak p) > s$ and the groups vanish by
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}.

\medskip\noindent
Claim III. The final statement of the lemma is true.

\medskip\noindent
By Claim II for $i \leq s$ we have
$$
H^i_T(M) = H^i_{J_0}(M) = H^i_{J'}(M)
$$
for all ideals $J' \subset J_0$ with $V(J')  \cap V(I) = V(J) \cap V(I)$.
See Lemma \ref{lemma-adjoint-ext}.
Let us check the hypotheses of
Proposition \ref{proposition-annihilator}
for the subsets $T \subset T \cup V(I)$, the module $M$, and the integer $s$.
We have to show that given $\mathfrak p \subset \mathfrak q$
with $\mathfrak p \not \in T \cup V(I)$ and $\mathfrak q \in T$
we have
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s
$$
If $\text{depth}(M_\mathfrak p) \geq s$, then this is true because
the dimension of $(A/\mathfrak p)_\mathfrak q$ is at least $1$.
Thus we may assume $\text{depth}(M_\mathfrak p) < s$.
If $\mathfrak q \in V(I)$, then $\mathfrak q \in V(J) \cap V(I)$
and the inequality holds by (4). If $\mathfrak q \not \in V(I)$,
then we can use (3) to pick
$\mathfrak q' \in V(\mathfrak q) \cap V(J) \cap V(I)$ with
$\dim((A/\mathfrak q)_{\mathfrak q'}) \leq d$.
Then assumption (4) gives
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_{\mathfrak q'}) > s + d
$$
Since $A$ is catenary this implies the inequality we want.
Applying Proposition \ref{proposition-annihilator} we
find $J'' \subset A$ with $V(J'') \subset T \cup V(I)$
such that $J''$ annihilates $H^i_T(M)$ for $i \leq s$.
Then we can write $V(J'') \cup V(J_0) \cup V(I) = V(J'I)$
for some $J' \subset J_0$ with $V(J') \cap V(I) = V(J) \cap V(I)$.
Replacing $J_0$ by $J'$ the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-general}
In Lemma \ref{lemma-kill-colimit-weak-general} if instead of the empty
condition (2) we assume
\begin{enumerate}
\item[(2')] if $\mathfrak p \in V(I)$, $\mathfrak p \not \in V(J) \cap V(I)$,
then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s$
for all $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$,
\end{enumerate}
then the conditions also imply that $H^i_{J_0}(M)$ is a finite
$A$-module for $i \leq s$.
\end{lemma}

\begin{proof}
Recall that $H^i_{J_0}(M) = H^i_T(M)$, see proof of
Lemma \ref{lemma-kill-colimit-weak-general}. Thus it suffices to
check that for $\mathfrak p \not \in T$ and $\mathfrak q \in T$
with $\mathfrak p \subset \mathfrak q$ we have
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > s$, see
Proposition \ref{proposition-finiteness}.
Condition (2') tells us this is true for $\mathfrak p \in V(I)$.
Since we know $H^i_T(M)$ is annihilated by a power of $IJ_0$
we know the condition holds if $\mathfrak p \not \in V(IJ_0)$
by Proposition \ref{proposition-annihilator}.
This covers all cases and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-support-general}
If in Lemma \ref{lemma-kill-colimit-weak-general} we additionally assume
\begin{enumerate}
\item[(6)] if $\mathfrak p \not \in V(I)$, $\mathfrak p \in T$, then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$,
\end{enumerate}
then $H^i_{J_0}(M) = H^i_J(M) = H^i_{J + I}(M)$ for $i \leq s$ and these
modules are annihilated by a power of $I$.
\end{lemma}

\begin{proof}
Choose $\mathfrak p \in V(J)$ or $\mathfrak p \in V(J_0)$ but
$\mathfrak p \not \in V(J + I) = V(J_0 + I)$.
It suffices to show that $H^i_{\mathfrak pA_\mathfrak p}(M_\mathfrak p) = 0$
for $i \leq s$, see Lemma \ref{lemma-isomorphism}.
These groups vanish by condition (6) and
Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}.
The final statement follows from
 Proposition \ref{proposition-annihilator}.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-local-cohomology-general}
Let $I, J$ be ideals of a Noetherian ring $A$.
Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. With $T$ as in
(\ref{equation-associated-subset}) assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $\mathfrak p \in V(I)$ no condition,
\item $\text{cd}(A, I) \leq d$,
\item if $\mathfrak p \not \in V(I)$, $\mathfrak p \not \in T$ then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
for all $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$,
\item if $\mathfrak p \not \in V(I)$, $\mathfrak p \not \in T$,
$V(\mathfrak p) \cap V(J) \cap V(I) \not = \emptyset$, and
$\text{depth}(M_\mathfrak p) < s$, then one
of the following holds\footnote{Our method
forces this additonal condition. We will return to this
(insert future reference).}:
\begin{enumerate}
\item $\dim(\text{Supp}(M_\mathfrak p)) < s + 2$\footnote{For example
if $M$ satisfies Serre's condition $(S_s)$
on the complement of $V(I) \cup T$.}, or
\item  $\delta(\mathfrak p) > d + \delta_{max} - 1$
where $\delta$ is a dimension function and $\delta_{max}$
is the maximum of $\delta$ on $V(J) \cap V(I)$, or
\item $\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s + \delta_{max} - \delta_{min} - 2$
for all $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$.
\end{enumerate}
\end{enumerate}
Then there exists an ideal $J_0 \subset J$ with
$V(J_0) \cap V(I) = V(J) \cap V(I)$
such that for any $J' \subset J_0$ with
$V(J') \cap V(I) = V(J) \cap V(I)$ the map
$$
R\Gamma_{J'}(M) \longrightarrow R\Gamma_J(M)^\wedge
$$
induces an isomorphism on cohomology in degrees $\leq s$.
Here ${}^\wedge$ denotes derived $I$-adic completion.
\end{lemma}

\noindent
We encourage the reader to read the proof in the local case first
(Lemma \ref{lemma-algebraize-local-cohomology}) as it explains the structure
of the proof without having to deal with all the inequalities.

\begin{proof}
For an ideal $\mathfrak a \subset A$ we have
$R\Gamma_\mathfrak a = R\Gamma_{V(\mathfrak a)}$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-noetherian}.
Next, we observe that
$$
R\Gamma_J(M)^\wedge =
R\Gamma_I(R\Gamma_J(M))^\wedge =
R\Gamma_{I + J}(M)^\wedge =
R\Gamma_{I + J'}(M)^\wedge =
R\Gamma_I(R\Gamma_{J'}(M))^\wedge =
R\Gamma_{J'}(M)^\wedge
$$
by Dualizing Complexes, Lemmas \ref{dualizing-lemma-local-cohomology-ss} and
\ref{dualizing-lemma-complete-and-local}.
This explains how we define the arrow in the statement of the lemma.

\medskip\noindent
We claim that the hypotheses of Lemma \ref{lemma-kill-colimit-weak-general}
are implied by our current hypotheses on $M$.
The only thing to verify is hypothesis (3).
Thus let $\mathfrak p \not \in V(I)$, $\mathfrak p \in T$.
Then $V(\mathfrak p) \cap V(I)$ is nonempty as $I$ is
contained in the radical of $A$
(Algebra, Lemma \ref{algebra-lemma-radical-completion}).
Since $\mathfrak p \in T$ we have
$V(\mathfrak p) \cap V(I) = V(\mathfrak p) \cap V(J) \cap V(I)$.
Let $\mathfrak q \in V(\mathfrak p) \cap V(I)$ be the
generic point of an irreducible component.
We have $\text{cd}(A_\mathfrak q, I_\mathfrak q) \leq d$
by Lemma \ref{lemma-cd-local}.
We have $V(\mathfrak pA_\mathfrak q) \cap V(I_\mathfrak q) =
\{\mathfrak qA_\mathfrak q\}$ by our choice of $\mathfrak q$
and we conclude $\dim((A/\mathfrak p)_\mathfrak q) \leq d$
by Lemma \ref{lemma-cd-bound-dim-local}.

\medskip\noindent
Observe that the lemma holds for $s < 0$. This is not a trivial case because
it is not a priori clear that $H^i(R\Gamma_J(M)^\wedge)$
is zero for $i < 0$. However, this vanishing was esthablished in
Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local}.
We will prove the lemma by induction for $s \geq 0$.

\medskip\noindent
The lemma for $s = 0$ follows immediately from
the conclusion of Lemma \ref{lemma-kill-colimit-weak-general}
and Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local-H0}.

\medskip\noindent
Assume $s > 0$ and the lemma has been shown for smaller values of $s$.
Let $M' \subset M$ be the maximal submodule whose support is contained
in $V(I) \cup T$. Then $M'$ is a finite $A$-module whose support
is contained in $V(J') \cup V(I)$ for some ideal $J' \subset J$
with $V(J') \cap V(I) = V(J) \cap V(I)$.
We claim that
$$
R\Gamma_{J'}(M') \to R\Gamma_J(M')^\wedge
$$
is an isomorphism for any choice of $J'$.
Namely, we can choose a short exact sequence
$0 \to M_1 \oplus M_2 \to M' \to N \to 0$ with
$M_1$ annihilated by a power of $J'$, with $M_2$ annihilated
by a power of $I$, and with $N$ annihilated by a power of $I + J'$.
Thus it suffices to show that the claim holds for $M_1$, $M_2$, and $N$.
In the case of $M_1$ we see that $R\Gamma_{J'}(M_1) = M_1$ and
since $M_1$ is a finite $A$-module and $I$-adically complete
we have $M_1^\wedge = M_1$. This proves the claim for $M_1$
by the initial remarks of the proof. In the case of $M_2$ we see that
$H^i_J(M_2) = H^i_{I + J}(M) = H^i_{I + J'}(M) = H^i_{J'}(M_2)$
are annihilated by a power of $I$ and hence derived complete.
Thus the claim in this case also. For $N$ we can use either of
the arguments just given. Considering the short exact sequence
$0 \to M' \to M \to M/M' \to 0$
we see that it suffices to prove the lemma for $M/M'$.
Thus we may assume $\text{Ass}(M) \cap (V(I) \cup T) = \emptyset$.

\medskip\noindent
Let $\mathfrak p \in \text{Ass}(M)$ be such that
$V(\mathfrak p) \cap V(J) \cap V(I) = \emptyset$.
Since $I$ is contained in the radical of $A$ this implies
that $V(\mathfrak p) \cap V(J') = \emptyset$ for any
$J' \subset J$ with $V(J') \cap V(I) = V(J) \cap V(I)$.
Thus setting $N = H^0_\mathfrak p(M)$ we see that
$R\Gamma_J(N) = R\Gamma_{J'}(N) = 0$ for all
$J' \subset J$ with $V(J') \cap V(I) = V(J) \cap V(I)$.
In particular $R\Gamma_J(N)^\wedge = 0$.
Thus we may replace $M$ by $M/N$ as this changes the
structure of $M$ only in primes which do not play
a role in conditions (4) or (5). Repeating we may assume that
$V(\mathfrak p) \cap V(J) \cap V(I) \not = \emptyset$
for all $\mathfrak p \in \text{Ass}(M)$.

\medskip\noindent
Assume $\text{Ass}(M) \cap (V(I) \cup T) = \emptyset$ and that
$V(\mathfrak p) \cap V(J) \cap V(I) \not = \emptyset$
for all $\mathfrak p \in \text{Ass}(M)$.
Let $\mathfrak p \in \text{Ass}(M)$. We want to show that we may apply
Lemma \ref{lemma-kill-completion-general}.
It is in the verification of this that we will use the supplemental
condition (5). Choose $\mathfrak p' \subset \mathfrak p$
and $\mathfrak q' \subset V(\mathfrak p) \cap V(J) \cap V(I)$.
\begin{enumerate}
\item If $M_{\mathfrak p'} = 0$, then
$\text{depth}(M_{\mathfrak p'}) = \infty$ and
$\text{depth}(M_{\mathfrak p'}) +
\dim((A/\mathfrak p')_{\mathfrak q'}) > d + s$.
\item If $\text{depth}(M_{\mathfrak p'}) < s$, then
$\text{depth}(M_{\mathfrak p'}) +
\dim((A/\mathfrak p')_{\mathfrak q'}) > d + s$ by (4).
\end{enumerate}
In the remaining cases we have $M_{\mathfrak p'} \not = 0$ and
$\text{depth}(M_{\mathfrak p'}) \geq s$. In particular, we see that
$\mathfrak p'$ is in the support of $M$ and we can choose
$\mathfrak p'' \subset \mathfrak p'$ with $\mathfrak p'' \in \text{Ass}(M)$.
\begin{enumerate}
\item[(a)] Observe that
$\dim((A/\mathfrak p'')_{\mathfrak p'}) \geq \text{depth}(M_{\mathfrak p'})$
by Algebra, Lemma \ref{algebra-lemma-depth-dim-associated-primes}.
If equality holds, then we have
$$
\text{depth}(M_{\mathfrak p'}) + \dim((A/\mathfrak p')_{\mathfrak q'}) =
\text{depth}(M_{\mathfrak p''}) + \dim((A/\mathfrak p'')_{\mathfrak q'})
> s + d
$$
by (4) applied to $\mathfrak p''$ and we are done. This means we are
only in trouble if
$\dim((A/\mathfrak p'')_{\mathfrak p'}) > \text{depth}(M_{\mathfrak p'})$.
This implies that $\dim(M_\mathfrak p) \geq s + 2$.
Thus if (5)(a) holds, then this does not occur.
\item[(b)] If (5)(b) holds, then we get
$$
\text{depth}(M_{\mathfrak p'}) + \dim((A/\mathfrak p')_{\mathfrak q'})
\geq s + \delta(\mathfrak p') - \delta(\mathfrak q')
\geq s + 1 + \delta(\mathfrak p) - \delta_{max}
> s + d
$$
as desired.
\item[(c)] If (5)(c) holds, then we get
\begin{align*}
\text{depth}(M_{\mathfrak p'}) + \dim((A/\mathfrak p')_{\mathfrak q'})
& \geq
s + \delta(\mathfrak p') - \delta(\mathfrak q') \\
& \geq
s + 1 + \delta(\mathfrak p) - \delta(\mathfrak q') \\
& =
s + 1 + \delta(\mathfrak p) - \delta(\mathfrak q) +
\delta(\mathfrak q) - \delta(\mathfrak q') \\
& >
s + 1 + (s + d + \delta_{max} - \delta_{min} - 2) +
\delta(\mathfrak q) - \delta(\mathfrak q') \\
& \geq 
2s + d - 1 \geq s + d
\end{align*}
as desired. Observe that this argument works because
we know that a prime $\mathfrak q \in V(\mathfrak p) \cap V(J) \cap V(I)$
exists.
\end{enumerate}
Now we are ready to do the induction step.

\medskip\noindent
Choose an ideal $J_0$ as in Lemma \ref{lemma-kill-colimit-weak-general}
and an integer $t > 0$ such that $(J_0I)^t$ annihilates $H^s_J(M)$.
The assumptions of Lemma \ref{lemma-kill-completion-general}
are satisfied for every $\mathfrak p \in \text{Ass}(M)$
(see previous paragraph).
Thus the annihilator $\mathfrak a \subset A$ of
$H^s(R\Gamma_J(M)^\wedge)$
is not contained in $\mathfrak p$ for $\mathfrak p \in \text{Ass}(M)$.
Thus we can find an $f \in \mathfrak a(J_0I)^t$
not in any associated prime of $M$ which is an annihilator
of both $H^s(R\Gamma_J(M)^\wedge)$ and $H^s_J(M)$.
Then $f$ is a nonzerodivisor on $M$ and we can consider the
short exact sequence
$$
0 \to M \xrightarrow{f} M \to M/fM \to 0
$$
Our choice of $f$ shows that we obtain
$$
\xymatrix{
H^{s - 1}_{J'}(M) \ar[d] \ar[r] &
H^{s - 1}_{J'}(M/fM) \ar[d] \ar[r] &
H^s_{J'}(M) \ar[d] \ar[r] & 0 \\
H^{s - 1}(R\Gamma_J(M)^\wedge) \ar[r] &
H^{s - 1}(R\Gamma_J(M/fM)^\wedge) \ar[r] &
H^s(R\Gamma_J(M)^\wedge) \ar[r] & 0
}
$$
for any $J' \subset J_0$ with $V(J') \cap V(I) = V(J) \cap V(I)$.
Thus if we choose $J'$ such that it works for
$M$ and $M/fM$ and $s - 1$ (possible by induction hypothesis --
see next paragraph), then we conclude that the lemma is true.

\medskip\noindent
To finish the proof we have to show that the module
$M/fM$ satisfies the hypotheses (4) and (5) for $s - 1$.
Thus we let $\mathfrak p$ be a prime in the support
of $M/fM$ with $\text{depth}((M/fM)_\mathfrak p) < s - 1$
and with $V(\mathfrak p) \cap V(J) \cap V(I)$ nonempty.
Then $\dim(M_\mathfrak p) = \dim((M/fM)_\mathfrak p) + 1$
and $\text{depth}(M_\mathfrak p) = \text{depth}((M/fM)_\mathfrak p) + 1$.
In particular, we know (4) and (5) hold for $\mathfrak p$ and $M$
with the original value $s$.
The desired inequalities then follow by inspection.
\end{proof}

\begin{example}
\label{example-no-ML}
In Lemma \ref{lemma-algebraize-local-cohomology-general}
we do not know that the inverse systems $H^i_J(M/I^nM)$ satisfy the
Mittag-Leffler condition.
For example, suppose that $A = \mathbf{Z}_p[[x, y]]$, $I = (p)$,
$J = (p, x)$, and $M = A/(xy - p)$. Then the image of
$H^0_J(M/p^nM) \to H^0_J(M/pM)$
is the ideal generated by $y^n$ in $M/pM = A/(p, xy)$.
\end{example}



\section{Mittag-Leffler conditions}
\label{section-ML}

\noindent
When taking local cohomology with respect to the maximal ideal
of a local Noetherian ring, we often get the Mittag-Leffler condition
for free.

\begin{lemma}
\label{lemma-descending-chain}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
\begin{enumerate}
\item Let $M$ be a finite $A$-module. Then the $A$-module
$H^i_\mathfrak m(M)$ satisfies the descending chain condition
for any $i$.
\item Let $U = \Spec(A) \setminus \{\mathfrak m\}$ be the
punctured spectrum of $A$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
Then the $A$-module $H^i(U, \mathcal{F})$
satisfies the descending chain condition for $i > 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $A^\wedge$ be the completion of $A$. Since
$H^i_\mathfrak m(M)$ is $\mathfrak m$-power torsion, we see that
$H^i_\mathfrak m(M) = H^i_\mathfrak m(M) \otimes_A A^\wedge$. Moreover,
we have $H^i_\mathfrak m(M) \otimes_A A^\wedge =
H^i_{\mathfrak mA^\wedge}(M \otimes_A A^\wedge)$ by
Dualizing Complexes, Lemma \ref{dualizing-lemma-torsion-change-rings}.
Thus
$$
H^i_\mathfrak m(M) = H^i_{\mathfrak mA^\wedge}(M \otimes_A A^\wedge)
$$
and $A$-submodules of the left hand side are the same thing as
$A^\wedge$-submodules of the right hand side. Thus we reduce
to the case discussed in the next paragraph.

\medskip\noindent
Assume $A$ is complete. Then $A$ has a normalized dualizing complex
$\omega_A^\bullet$ (Dualizing Complexes, Lemma
\ref{dualizing-lemma-ubiquity-dualizing}).
By the local duality theorem (Dualizing Complexes, Lemma
\ref{dualizing-lemma-special-case-local-duality}) we find an isomorphism
$$
\Hom_A(H^i_\mathfrak m(M), E) =
\text{Ext}^{-i}_A(M, \omega_A^\bullet)^\wedge
$$
where $E$ is an injective hull of the residue field of $A$. The module
$\text{Ext}^{-i}_A(M, \omega_A^\bullet)$
on the right hand side is a finite $A$-module by
Dualizing Complexes, Lemma \ref{dualizing-lemma-dualizing}.
Since $A$ is complete, the completion isn't necessary.
Thus $H^i_\mathfrak m(M)$ has the descending chain condition
by Matlis duality, see 
Dualizing Complexes, Proposition \ref{dualizing-proposition-matlis}
and its addendum Remark \ref{dualizing-remark-matlis}.

\medskip\noindent
Part (2) follows from (1) via
Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}.
\end{proof}

\begin{lemma}
\label{lemma-ML-local}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
\begin{enumerate}
\item Let $(M_n)$ be an inverse system of finite $A$-modules. Then the
inverse system $H^i_\mathfrak m(M_n)$ satisfies the Mittag-Leffler
condition for any $i$.
\item Let $U = \Spec(A) \setminus \{\mathfrak m\}$ be the
punctured spectrum of $A$.
Let $\mathcal{F}_n$ be an inverse system of
coherent $\mathcal{O}_U$-modules.
Then the inverse system $H^i(U, \mathcal{F}_n)$
satisfies the Mittag-Leffler condition for $i > 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-descending-chain}.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-derived-completion}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Then
$$
H^i(R\Gamma_\mathfrak m(M)^\wedge) = \lim H^i_\mathfrak m(M/I^nM)
$$
for all $i$ where $R\Gamma_\mathfrak m(M)^\wedge$ denotes
the derived $I$-adic completion.
\end{lemma}

\begin{proof}
Apply Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local}
and Lemma \ref{lemma-ML-local} to see the vanishing of the $R^1\lim$ terms.
\end{proof}





\section{Algebraization of local cohomology; local case}
\label{section-algebraization-punctured}

\noindent
In this section we redo the arguments of
Section \ref{section-algebraization-sections-general}
when $(A, \mathfrak m)$ is a local ring and we take local cohomology
$R\Gamma_\mathfrak m$ with respect to $\mathfrak m$. As before our
main tool is the following lemma.

\begin{lemma}
\label{lemma-kill-completion}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module and
let $\mathfrak p \subset A$ be a prime. Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item $\text{cd}(A, I) \leq d$, and
\item
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s$.
\end{enumerate}
Then there exists an $f \in A \setminus \mathfrak p$ which annihilates
$H^i(R\Gamma_\mathfrak m(M)^\wedge)$ for $i \leq s$ where ${}^\wedge$
indicates $I$-adic completion.
\end{lemma}

\begin{proof}
According to Lemma \ref{lemma-sitting-in-degrees}
the function
$$
\mathfrak p' \longmapsto
\text{depth}_{A_{\mathfrak p'}}(M_{\mathfrak p'}) + \dim(A/\mathfrak p')
$$
is lower semi-continuous on $\Spec(A)$. Thus the value
of this function on $\mathfrak p' \subset \mathfrak p$
is $> s + d$. Thus our lemma is a special case of
Lemma \ref{lemma-kill-completion-general}
provided that $\mathfrak p \not = \mathfrak m$.
If $\mathfrak p = \mathfrak m$,
then we have $H^i_\mathfrak m(M) = 0$ for $i \leq s + d$ by
the relationship between depth and local cohomology
(Dualizing Complexes, Lemma \ref{dualizing-lemma-depth}).
Thus the argument given in the proof of
Lemma \ref{lemma-kill-completion-general}
shows that $H^i(R\Gamma_\mathfrak m(M)^\wedge) = 0$
for $i \leq s$ in this (degenerate) case.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-weak}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item if $\mathfrak p \in V(I)$, then no condition,
\item if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) = \{\mathfrak m\}$, then
$\dim(A/\mathfrak p) \leq d$,
\item if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) \not = \{\mathfrak m\}$, then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s
$$
\end{enumerate}
Then there exists an ideal $J_0 \subset A$ with
$V(J_0) \cap V(I) = \{\mathfrak m\}$ such that for any $J \subset J_0$ with
$V(J) \cap V(I) = \{\mathfrak m\}$ the map
$$
R\Gamma_J(M) \longrightarrow R\Gamma_{J_0}(M)
$$
induces an isomorphism in cohomology in degrees $\leq s$
and moreover these modules are annihilated by a power of $J_0I$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-kill-colimit-weak-general}.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit}
In Lemma \ref{lemma-kill-colimit-weak} if instead of the empty
condition (2) we assume
\begin{enumerate}
\item[(2')] if $\mathfrak p \in V(I)$ and $\mathfrak p \not = \mathfrak m$,
then $\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > s$,
\end{enumerate}
then the conditions also imply that $H^i_{J_0}(M)$ is a finite
$A$-module for $i \leq s$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-kill-colimit-general}.
\end{proof}

\begin{lemma}
\label{lemma-kill-colimit-support}
If in Lemma \ref{lemma-kill-colimit-weak} we additionally assume
\begin{enumerate}
\item[(6)] if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) = \{\mathfrak m\}$, then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$,
\end{enumerate}
then $H^i_{J_0}(M) = H^i_J(M) = H^i_\mathfrak m(M)$ for $i \leq s$
and these modules are annihilated by a power of $I$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-kill-colimit-support-general}.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-local-cohomology}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $\mathfrak p \in V(I)$, no condition,
\item $\text{cd}(A, I) \leq d$,
\item if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) \not = \{\mathfrak m\}$ then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s
$$
\end{enumerate}
Then there exists an ideal $J_0 \subset A$ with
$V(J_0) \cap V(I) = \{\mathfrak m\}$ such that for any $J \subset J_0$ with
$V(J) \cap V(I) = \{\mathfrak m\}$ the map
$$
R\Gamma_J(M) \longrightarrow
R\Gamma_J(M)^\wedge = R\Gamma_\mathfrak m(M)^\wedge
$$
induces an isomorphism in cohomology in degrees $\leq s$.
Here ${}^\wedge$ denotes derived $I$-adic completion.
\end{lemma}

\begin{proof}
This lemma is a special case of
Lemma \ref{lemma-algebraize-local-cohomology-general}
since condition (5)(c) is implied by condition (4)
as $\delta_{max} = \delta_{min} = \delta(\mathfrak m)$.
We will give the proof of this important special case
as it is somewhat easier (fewer things to check).

\medskip\noindent
There is no difference between $R\Gamma_\mathfrak a$ and
$R\Gamma_{V(\mathfrak a)}$ in our current situation, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-noetherian}.
Next, we observe that
$$
R\Gamma_\mathfrak m(M)^\wedge =
R\Gamma_I(R\Gamma_J(M))^\wedge =
R\Gamma_J(M)^\wedge
$$
by Dualizing Complexes, Lemmas \ref{dualizing-lemma-local-cohomology-ss} and
\ref{dualizing-lemma-complete-and-local}
which explains the equality sign in the statement of the lemma.

\medskip\noindent
Observe that the lemma holds for $s < 0$. This is not a trivial case because
it is not a priori clear that $H^s(R\Gamma_\mathfrak m(M)^\wedge)$
is zero for negative $s$. However, this vanishing was esthablished
in Lemma \ref{lemma-local-cohomology-derived-completion}.
We will prove the lemma by induction for $s \geq 0$.

\medskip\noindent
The assumptions of Lemma \ref{lemma-kill-colimit-weak}
are satisfied by Lemma \ref{lemma-cd-bound-dim-local}.
The lemma for $s = 0$ follows from Lemma \ref{lemma-kill-colimit-weak} and
Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local-H0}.

\medskip\noindent
Assume $s > 0$ and the lemma holds for smaller values of $s$.
Let $M' \subset M$ be the submodule of elements whose
support is condained in $V(I) \cup V(J)$ for some
ideal $J$ with $V(J) \cap V(I) = \{\mathfrak m\}$.
Then $M'$ is a finite $A$-module.
We claim that
$$
R\Gamma_J(M') \to R\Gamma_\mathfrak m(M')^\wedge
$$
is an isomorphism for any choice of $J$.
Namely, for any such module there is a short exact sequence
$0 \to M_1 \oplus M_2 \to M' \to N \to 0$ with
$M_1$ annihilated by a power of $J$, with $M_2$ annihilated
by a power of $I$ and with $N$ annihilated by a power of $\mathfrak m$.
In the case of $M_1$ we see that $R\Gamma_J(M_1) = M_1$ and
since $M_1$ is a finite $A$-module and $I$-adically complete
we have $M_1^\wedge = M_1$. Thus the claim holds for $M_1$.
In the case of $M_2$ we see that $H^i_J(M_2)$ is annihilated
by a power of $I$ and hence derived complete. Thus the claim
for $M_2$. By the same arguments the claim holds for $N$
and we conclude that the claim holds. Considering the
short exact sequence $0 \to M' \to M \to M/M' \to 0$
we see that it suffices to prove the lemma for $M/M'$.
This we may assume $\mathfrak p \in \text{Ass}(M)$
implies $V(\mathfrak p) \cap V(I) \not = \{\mathfrak m\}$, i.e.,
$\mathfrak p$ is a prime as in (4).

\medskip\noindent
Choose an ideal $J_0$ as in Lemma \ref{lemma-kill-colimit-weak}
and an integer $t > 0$ such that $(J_0I)^t$ annihilates $H^s_J(M)$.
Here $J$ denotes an arbitrary ideal $J \subset J_0$ with
$V(J) \cap V(I) = \{\mathfrak m\}$.
The assumptions of Lemma \ref{lemma-kill-completion}
are satisfied for every $\mathfrak p \in \text{Ass}(M)$
(see previous paragraph). Thus the annihilator $\mathfrak a \subset A$ of
$H^s(R\Gamma_\mathfrak m(M)^\wedge)$
is not contained in $\mathfrak p$ for $\mathfrak p \in \text{Ass}(M)$.
Thus we can find an $f \in \mathfrak a(J_0I)^t$
not in any associated prime of $M$ which is an annihilator
of both $H^s(R\Gamma_\mathfrak m(M)^\wedge)$ and $H^s_J(M)$.
Then $f$ is a nonzerodivisor on $M$ and we can consider the
short exact sequence
$$
0 \to M \xrightarrow{f} M \to M/fM \to 0
$$
Our choice of $f$ shows that we obtain
$$
\xymatrix{
H^{s - 1}_J(M) \ar[d] \ar[r] &
H^{s - 1}_J(M/fM) \ar[d] \ar[r] &
H^s_J(M) \ar[d] \ar[r] & 0 \\
H^{s - 1}(R\Gamma_\mathfrak m(M)^\wedge) \ar[r] &
H^{s - 1}(R\Gamma_\mathfrak m(M/fM)^\wedge) \ar[r] &
H^s(R\Gamma_\mathfrak m(M)^\wedge) \ar[r] & 0
}
$$
for any $J \subset J_0$ with $V(J) \cap V(I) = \{\mathfrak m\}$.
Thus if we choose $J$ such that it works for
$M$ and $M/fM$ and $s - 1$ (possible by induction hypothesis),
then we conclude that the lemma is true.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-local-cohomology-bis}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item[(3)] $\text{cd}(A, I) \leq d$,
\item[(4)] if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) \not = \{\mathfrak m\}$ then
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s
$$
\item[(6)] if $\mathfrak p' \in \Spec(A') \setminus V(I')$ and
$V(\mathfrak p') \cap V(I') = \{\mathfrak m'\}$, then
$\text{depth}(M'_{\mathfrak p'}) > s$
where $A', \mathfrak m', I', M'$ are the usual $I$-adic completions
of $A, \mathfrak m, I, M$.
\end{enumerate}
Then
\begin{enumerate}
\item[(a)] the hypotheses of
Lemmas \ref{lemma-kill-colimit-weak} and \ref{lemma-kill-colimit-support}
hold for $A, \mathfrak m, I, M$
\item[(b)] the hypotheses of
Lemmas \ref{lemma-algebraize-local-cohomology},
\ref{lemma-kill-colimit-weak}, and \ref{lemma-kill-colimit-support}
hold for $A', \mathfrak m', I', M'$, and
\item[(c)] $H^i_\mathfrak m(M) \to \lim H^i_\mathfrak m(M/I^nM)$
is an isomorphism for $i \leq s$ and these modules are
annihilated by a power of $I$.
\end{enumerate}
\end{lemma}

\begin{proof}
Observe that $A'$ has a dualizing complex by
Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing}.
Observe that $\text{cd}(A', I') \leq d$ by Lemma \ref{lemma-cd-change-rings}.
Moreover condition (3) implies condition (3) of
Lemma \ref{lemma-kill-colimit-weak} by
Lemma \ref{lemma-cd-bound-dim-local}
for both $(A, \mathfrak m, I)$ and $(A', \mathfrak m', I')$.
Let $\mathfrak p' \subset A'$ be a prime ideal lying over
$\mathfrak p \subset A$. Then
$$
\text{depth}(M'_{\mathfrak p'}) =
\text{depth}(M_\mathfrak p) +
\text{depth}(A'_{\mathfrak p'}/\mathfrak p A'_{\mathfrak p'})
\geq \text{depth}(M_\mathfrak p)
$$
by flatness of $A \to A'$, see
Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module}.
Since the fibres of $A \to A'$ are Cohen-Macaulay
(Dualizing Complexes, Lemma
\ref{dualizing-lemma-dualizing-gorenstein-formal-fibres} and
More on Algebra, Section
\ref{more-algebra-section-properties-formal-fibres})
we see that
$\text{depth}(A'_{\mathfrak p'}/\mathfrak p A'_{\mathfrak p'}) =
\dim(A'_{\mathfrak p'}/\mathfrak p A'_{\mathfrak p'})$.
Thus we obtain
\begin{align*}
\text{depth}(M'_{\mathfrak p'}) +
\dim(A'/\mathfrak p')
& =
\text{depth}(M_\mathfrak p) +
\dim(A'_{\mathfrak p'}/\mathfrak p A'_{\mathfrak p'}) +
\dim(A'/\mathfrak p') \\
& =
\text{depth}(M_\mathfrak p) +
\dim(A'/\mathfrak p A') \\
& =
\text{depth}(M_\mathfrak p) +
\dim(A/\mathfrak p)
\end{align*}
Second equality because $A'$ is catenary and third equality by
More on Algebra, Lemma \ref{more-algebra-lemma-completion-dimension}.
Thus we see that condition (4) implies condition (4) for
$(A', \mathfrak m', I', M')$. Conversely, if
$\mathfrak p \subset A$, $\mathfrak p \not \in V(I)$,
$V(\mathfrak p) \cap V(I) = \{\mathfrak m\}$, then
we can pick $\mathfrak p' \subset A'$ lying over $\mathfrak p$ with
$\dim(A'_{\mathfrak p'}/\mathfrak p A'_{\mathfrak p'}) = 0$.
Then $\mathfrak p' \in \Spec(A') \setminus V(I')$ and
$V(\mathfrak p') \cap V(I') = \{\mathfrak m'\}$
and we see that condition (6) implies condition (6) as formulated
in Lemma \ref{lemma-kill-colimit-support} for $(A, \mathfrak m, I, M)$.
This proves parts (a) and (b). 

\medskip\noindent
Recall that we have
$H^i_\mathfrak m(M) \otimes_A A' = H^i_{\mathfrak m'}(M')$
by flatness of $A \to A'$ and Dualizing Complexes, Lemma
\ref{dualizing-lemma-torsion-change-rings}.
Lemma \ref{lemma-kill-colimit-support} applies to $(A, \mathfrak m, I, M)$
by the arguments of the first paragraph. Thus
the modules $H^i_\mathfrak m(M)$, $i \leq s$
are annihilated by a power of $I$ and hence
$H^i_\mathfrak m(M) \to H^i_\mathfrak m(M) \otimes_A A'$
is an isomorphism for $i \leq s$.
We conclude that $H^i_\mathfrak m(M) = H^i_{\mathfrak m'}(M')$
for $i \leq s$. The exact same arguments show that
$H^i_\mathfrak m(M/I^nM) =  H^i_{\mathfrak m'}(M'/(I')^nM')$
for all $n$ and $i$.

\medskip\noindent
Lemmas \ref{lemma-algebraize-local-cohomology},
\ref{lemma-kill-colimit-weak}, and \ref{lemma-kill-colimit-support}
apply to $(A', \mathfrak m', I', M')$ by the arguments of the first paragraph.
Thus we get an isomorphism
$$
H^i_{\mathfrak m'}(M') \longrightarrow
H^i(R\Gamma_{\mathfrak m'}(M')^\wedge)
$$
for $i \leq s$ where ${}^\wedge$ is derived $I'$-adic completion.
By Lemma \ref{lemma-local-cohomology-derived-completion}
we obtain isomorphisms
$$
H^i_{\mathfrak m'}(M') \longrightarrow
\lim H^i_{\mathfrak m'}(M'/(I')^nM'))
$$
for $i \leq s$. Combined with the already esthablished comparison
with local cohomology over $A$ we conclude the lemma is true.
\end{proof}

\noindent
The only point of the next lemma is that it is easier to state
than the previous one.

\begin{lemma}
\label{lemma-algebraize-local-cohomology-bis-bis}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item[(a)] $A$ has a dualizing complex,
\item[(b)] $\text{cd}(A, I) \leq d$,
\item[(c)] if $\mathfrak p \not \in V(I)$ then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$ or
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s$.
\end{enumerate}
Then the assumptions of
Lemma \ref{lemma-algebraize-local-cohomology-bis} hold and
$H^i_\mathfrak m(M) \to \lim H^i_\mathfrak m(M/I^nM)$
is an isomorphism for $i \leq s$ and these modules are
annihilated by a power of $I$.
\end{lemma}

\begin{proof}
We have seen that
$\text{depth}(M'_{\mathfrak p'}) \geq \text{depth}(M_\mathfrak p)$
and
$
\text{depth}(M'_{\mathfrak p'}) + \dim(A'/\mathfrak p') =
\text{depth}(M_\mathfrak p) + \dim(A/\mathfrak p)
$
for a prime $\mathfrak p'$ of the $I$-adic completion $A'$
lying over the prime $\mathfrak p$ of $A$. Now if
$\mathfrak p' \in \Spec(A') \setminus V(I')$ and
$V(\mathfrak p') \cap V(I') = \{\mathfrak m'\}$
then we have $\dim(A'/\mathfrak p') \leq d$
(again this was esthablished in the proof of
Lemma \ref{lemma-algebraize-local-cohomology-bis}).
Hence either
$\text{depth}(M'_{\mathfrak p'}) \geq
\text{depth}(M_\mathfrak p) > s$ or
$$
\text{depth}(M'_{\mathfrak p'}) + \dim(A'/\mathfrak p') =
\text{depth}(M_\mathfrak p) + \dim(A/\mathfrak p) > s + d
$$
which would force
$\text{depth}(M'_{\mathfrak p'}) > s$ by the inequality
for the dimension given above.
In both cases we have
$\text{depth}(M'_{\mathfrak p'}) > s$ as desired.
\end{proof}







\section{Algebraization of local cohomology, bootstrap}
\label{section-bootstrap}

\noindent
In this section we revisit the material in
Sections \ref{section-algebraization-sections-general} and
\ref{section-algebraization-sections}
in the following situation.

\begin{situation}
\label{situation-bootstrap}
Here $A$ is a Noetherian ring. We have ideals
$I \subset \mathfrak a \subset A$ and a finite $A$-module $M$.
We have integers $s$ and $d$. We assume
\begin{enumerate}
\item[(1)] $A$ has a dualizing complex,
\item[(3)] $\text{cd}(A, I) \leq d$,
\item[(4)] given primes $\mathfrak p \subset \mathfrak r \subset \mathfrak q$
with $\mathfrak p \not \in V(I)$,
$\mathfrak r \in V(I) \setminus V(\mathfrak a)$,
$\mathfrak q \in V(\mathfrak a)$ we have
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
\item[(6)] if $\mathfrak q \in V(\mathfrak a)$ then
$(A_\mathfrak q, \mathfrak q A_\mathfrak q, I_\mathfrak q, M_\mathfrak q)$
satisfies condition (6) of Lemma \ref{lemma-algebraize-local-cohomology-bis}.
\end{enumerate}
\end{situation}

\begin{lemma}
\label{lemma-bootstrap-inherited}
In Situation \ref{situation-bootstrap}
\begin{enumerate}
\item[(a)] for every $\mathfrak q \in V(\mathfrak a)$ the hypotheses of
Lemma \ref{lemma-algebraize-local-cohomology-bis}
are satisfied for
$(A_\mathfrak q, \mathfrak q A_\mathfrak q, I_\mathfrak q, M_\mathfrak q)$,
\item[(b)] if $I$ is contained in the radical of $A$, then
the hypotheses of Lemmas \ref{lemma-kill-colimit-weak-general} and
\ref{lemma-kill-colimit-support-general}
are satisfied for $(A, I, \mathfrak a, M)$,
\item[(c)] if $S \subset A$ is a multiplicative subset, then
$(S^{-1}A, S^{-1}I, S^{-1}\mathfrak a, S^{-1}M)$
satisfies the assumptions
of Situation \ref{situation-bootstrap},
\item[(d)] all hypotheses except for possibly (5) of
Lemma \ref{lemma-algebraize-local-cohomology-general}
are satisfied for the ususal $I$-adic completions
$(A', I', \mathfrak a', M')$ of $(A, I, \mathfrak a, M)$.
\item[(e)] $(A', I', \mathfrak a', M')$
satisfies the assumptions
of Situation \ref{situation-bootstrap}.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (a). Take $\mathfrak q \in V(\mathfrak a)$. We have to check
conditions (1), (3), (4), and (6) of
Lemma \ref{lemma-algebraize-local-cohomology-bis}.
The ring $A_\mathfrak q$ has a dualizing complex, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing}.
This proves (1).
We have $\text{cd}(A_\mathfrak q, I_\mathfrak q) \leq d$
by Lemma \ref{lemma-cd-change-rings}. This proves (3).
Let $\mathfrak p' \in \Spec(A_\mathfrak q)$ with
$\mathfrak p' \not \in V(I)$ and
$V(\mathfrak p') \cap V(IA_\mathfrak q) \not = \{\mathfrak q A_\mathfrak q\}$.
To prove (4) we have to show
$$
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) \geq s
\quad\text{or}\quad
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s
$$
where $\mathfrak p \subset A$ is the corresponding prime.
If there exists a prime
$\mathfrak p \subset \mathfrak r \subset \mathfrak q$ with
$\mathfrak r \in V(I) \setminus V(\mathfrak a)$, then
this follows immedately from assumption (4) in
Situation \ref{situation-bootstrap}.
If not, then we will show that $\text{depth}(M_\mathfrak p) > s$.
To do this we may replace $\mathfrak q$ with a generic point
$\mathfrak q' \in V(\mathfrak p) \cap V(\mathfrak a)$
of an irreducible component containig $\mathfrak q$.
After doing this we obtain that
$V(\mathfrak p') \cap V(IA_\mathfrak q) = \{\mathfrak q A_\mathfrak q)$
(because of the nonexistence of a prime $\mathfrak r$ above).
Let $B = (A_\mathfrak q)^\wedge$ be the $I$-adic completion of $A_\mathfrak q$.
Choose $\mathfrak b \subset B$ lying over $\mathfrak p'$
with $\dim(B_\mathfrak b/\mathfrak p' B_\mathfrak b) = 0$.
Then we see that
$$
\text{depth}((M \otimes_A B)_\mathfrak b =
\text{depth}(M_\mathfrak p)
$$
by flatness of $A \to B$ and our choice of $\mathfrak b$, see
Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module}.
On the other hand, by condition (6) for
$(A_\mathfrak q, \mathfrak q A_\mathfrak q, I_\mathfrak q)$ we have
$\text{depth}((M \otimes_A B)_\mathfrak b > s$. This finishes
the proof of (4). Finally, condition (6)
was assumed in Situation \ref{situation-bootstrap}.

\medskip\noindent
Proof of (b). We have to check conditions (1), (2), (3), (4), and (6)
of Lemmas \ref{lemma-kill-colimit-weak-general} and
\ref{lemma-kill-colimit-support-general} for
$(A, I, \mathfrak a, M)$. Condition (1) follows from
Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing}.
Condition (2) is empty.
To prove conditions (3) and (6) we note that if
$\mathfrak p$ is a prime of $A$ then $V(\mathfrak p) \cap V(I)$
is nonempty as $I$ is contained in the radical of $A$.
Hence if $V(\mathfrak p) \cap V(I) \subset V(\mathfrak a)$,
then $\emptyset \not = V(\mathfrak p) \cap V(I) \subset V(\mathfrak a)$.
Let $\mathfrak q \in V(\mathfrak p) \cap V(I)$ be a generic point.
Since $\text{cd}(A_\mathfrak q, I_\mathfrak q) \leq d$
(Lemma \ref{lemma-cd-local}) and since
$V(\mathfrak p A_\mathfrak q) \cap V(I_\mathfrak q) =
\{\mathfrak q A_\mathfrak q\}$ we get
$\dim((A/\mathfrak p)_\mathfrak q) \leq d$ by
Lemma \ref{lemma-cd-bound-dim-local} which proves (3).
Moreover, there does not exist a prime
$\mathfrak p \subset \mathfrak r \subset \mathfrak q$
with $\mathfrak r \in V(I) \setminus V(\mathfrak a)$.
We have seen in the proof of (a) above that this implies
$\text{depth}(M_\mathfrak p) > s$ which proves (6).
To see condition (4) suppose $\mathfrak p \subset A$ and
$\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$.
Then $\mathfrak p$ corresponds to a prime $\mathfrak p'$
of $A_\mathfrak q$. If
$V(\mathfrak p') \cap V(I_\mathfrak q) \not = \{\mathfrak q A_\mathfrak q\}$
then we get condition (4) from the corresponding condition
of Lemma \ref{lemma-algebraize-local-cohomology-bis} for
$(A_\mathfrak q, \mathfrak q A_\mathfrak q, I_\mathfrak q, M_\mathfrak q)$
which we've shown applies in part (a).
On the other hand, if 
$V(\mathfrak p') \cap V(I_\mathfrak q) = \{\mathfrak q A_\mathfrak q\}$
then we get $\text{depth}(M_\mathfrak p) > s$ by
part (6) of Lemma \ref{lemma-kill-colimit-support} for
$(A_\mathfrak q, \mathfrak q A_\mathfrak q, I_\mathfrak q, M_\mathfrak q)$
which applies by part (a) and part (a) of
Lemma \ref{lemma-algebraize-local-cohomology-bis} .

\medskip\noindent
Proof of (c). This is straightforward and we omit the details.

\medskip\noindent
Proof of (e). We have to check conditions (1), (3), (4), and (6)
of Situation \ref{situation-bootstrap} for $(A', I', \mathfrak a', M')$.
Part (1) follows from
Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing}.
Part (3) follows from
Lemma \ref{lemma-cd-change-rings}.
For primes $\mathfrak p' \subset \mathfrak q' \subset A'$ lying over
$\mathfrak p \subset \mathfrak q \subset A$
we have
$$
\text{depth}(M'_{\mathfrak p'}) =
\text{depth}(M_\mathfrak p) +
\text{depth}(A'_{\mathfrak p'}/\mathfrak p A'_{\mathfrak p'})
\geq \text{depth}(M_\mathfrak p)
$$
by flatness of $A \to A'$, see
Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module}.
Since the fibres of $A \to A'$ are Cohen-Macaulay
(Dualizing Complexes, Lemma
\ref{dualizing-lemma-dualizing-gorenstein-formal-fibres} and
More on Algebra, Section
\ref{more-algebra-section-properties-formal-fibres})
we conclude that
$\text{depth}(A'_{\mathfrak p'}/\mathfrak p A'_{\mathfrak p'})
= \dim(A'_{\mathfrak p'}/\mathfrak p A'_{\mathfrak p'})$
and by catenary property of $A$ we obtain
$$
\text{depth}(M'_{\mathfrak p'}) + 
\dim((A'/\mathfrak p')_{\mathfrak q'})
=
\text{depth}(M_\mathfrak p) + 
\dim((A/\mathfrak p)_\mathfrak q)
$$
It follows that condition (4) for $(A, I, \mathfrak a, M)$
implies condition (4) for $(A', I', \mathfrak a', M')$.
Let $\mathfrak q' \subset A'$ be a prime ideal contained in
$V(\mathfrak a')$ lying over $\mathfrak q \in V(\mathfrak a)$.
Then the ring map $A_\mathfrak q \to A'_{\mathfrak q'}$ induces
an isomorphism on $I$-adic completions.
Thus condition (6) of Lemma \ref{lemma-algebraize-local-cohomology-bis} for 
$(A_\mathfrak q, \mathfrak q A_\mathfrak q, I_\mathfrak q, M_\mathfrak q)$
implies condition (6) of Lemma \ref{lemma-algebraize-local-cohomology-bis} for
$(A'_{\mathfrak q'}, \mathfrak q' A'_{\mathfrak q'}, I'_{\mathfrak q'},
M'_{\mathfrak q'})$.

\medskip\noindent
Proof of (d). We have to check conditions (1), (2), (3), and (4)
of Lemma \ref{lemma-algebraize-local-cohomology-general} for
$(A', I', \mathfrak a', M')$.
Using (e) we know $(A', I', \mathfrak a', M')$
is as in Situation \ref{situation-bootstrap}.
Thus (1), (2), (3) are clear.
Moreover $1 + I'$ consists of units
(Algebra, Lemma \ref{algebra-lemma-radical-completion}).
Hence by part (b) implies (4) as this is the same as
assumption (4) in Lemma \ref{lemma-kill-colimit-weak-general}.
\end{proof}

\begin{lemma}
\label{lemma-bootstrap-bis-bis}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $M$ be a finite $A$-module. Let $s$ and $d$ be integers.
If we assume
\begin{enumerate}
\item[(a)] $A$ has a dualizing complex,
\item[(b)] $\text{cd}(A, I) \leq d$,
\item[(c)] if $\mathfrak p \not \in V(I)$ and
$\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$ then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$ or
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q) > d + s$.
\end{enumerate}
Then $(A, \mathfrak a, I, M, s, d)$ are as in
Situation \ref{situation-bootstrap}.
\end{lemma}

\begin{proof}
We have to show that conditions (1), (3), (4), and (6) of
Situation \ref{situation-bootstrap} hold.
It is clear that (a) $\Rightarrow$ (1),
(b) $\Rightarrow$ (2), and (c) $\Rightarrow$ (3).
Observe that (a), (b), (c) are inherited by
$(A_\mathfrak q, \mathfrak q A_\mathfrak q, I_\mathfrak q, M_\mathfrak q)$.
Thus condition (6) follows by
Lemma \ref{lemma-algebraize-local-cohomology-bis-bis}.
\end{proof}

\begin{lemma}
\label{lemma-bootstrap}
In Situation \ref{situation-bootstrap} the inverse systems
$\{H^i_\mathfrak a(I^nM)\}_{n \geq 0}$ are pro-zero for $i \leq s$.
Moreover, there exists an integer $m_0$ such that for all
$m \geq m_0$ there exists an integer $m'(m) > m$ such that for
$k \geq m'(m)$ the image of
$H^{s + 1}_\mathfrak a(I^kM) \to H^{s + 1}_\mathfrak a(I^mM)$
maps injectively to $H^{s + 1}_\mathfrak a(I^{m_0}M)$.
\end{lemma}

\begin{proof}
Fix $m$. Let $\mathfrak q \in V(\mathfrak a)$.
By Lemmas \ref{lemma-bootstrap-inherited} and
\ref{lemma-algebraize-local-cohomology-bis}
we see that
$$
H^i_\mathfrak q(M_\mathfrak q)
\longrightarrow
\lim H^i_\mathfrak q(M_\mathfrak q/I^nM_\mathfrak q)
$$
is an isomorphism for $i \leq s$. The systems
$\{H^i_\mathfrak q(I^nM_\mathfrak q)\}_{n \geq 0}$ and
$\{H^i_\mathfrak q(M/I^nM)\}_{n \geq 0}$
satisfy the Mittag-Leffler condition for all $i$, see
Lemma \ref{lemma-ML-local}. Thus looking at the system of
long exact sequences
$$
0 \to H^0_\mathfrak q(I^nM_\mathfrak q) \to
H^0_\mathfrak q(M_\mathfrak q) \to
H^0_\mathfrak q(M_\mathfrak q/I^nM_\mathfrak q) \to
H^1_\mathfrak q(I^nM_\mathfrak q) \to
H^1_\mathfrak q(M_\mathfrak q) \to \ldots
$$
we conclude (some details omitted)
that there exists an integer $m'(m, \mathfrak q) > m$
such that for all $k \geq m'(m, \mathfrak q)$ the map
$H^i_\mathfrak q(I^kM_\mathfrak q) \to H^i_\mathfrak q(I^mM_\mathfrak q)$
is zero for $i \leq s$ and the image of
$H^{s + 1}_\mathfrak q(I^kM_\mathfrak q) \to
H^{s + 1}_\mathfrak q(I^mM_\mathfrak q)$
is independent of $k \geq m'(m)$ and
maps injectively into $H^{s + 1}_\mathfrak q(M_\mathfrak q)$.

\medskip\noindent
Let $\omega_A^\bullet$ be a dualizing complex. Let
$\delta : \Spec(A) \to \mathbf{Z}$ be the corresponding
dimension function. Recall that $\delta$ attains only a
finite number of values, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-universally-catenary}.
Claim: for each $d \in \mathbf{Z}$ the integer
$m'(m, \mathfrak q)$ can be chosen independently
of $\mathfrak q$ with $\delta(\mathfrak q) = d$.
This will prove we can choose a single $m'(m)$ which works
for all $\mathfrak q$.

\medskip\noindent
Pick $\mathfrak q$ with $\delta(\mathfrak q) = d$.
Consider the ext modules
$$
E(n, j) = \text{Ext}^j_A(I^nM, \omega_A^\bullet)
$$
A key feature we will use is that these are finite $A$-modules.
Recall that $(\omega_A^\bullet)_\mathfrak q[-d]$ is a normalized
dualizing complex for $A_\mathfrak q$ by definition of the
dimension function associated to a dualizing complex, see
Dualizing Complexes, Section \ref{dualizing-section-dimension-function}.
The local duality theorem (Dualizing Complexes, Lemma
\ref{dualizing-lemma-special-case-local-duality}) tells us that
the $\mathfrak qA_\mathfrak q$-adic completion of
$E(n, -d - i)_\mathfrak q$ is Matlis dual to
$H^i_\mathfrak q(I^nM_\mathfrak q)$. Thus the choice of
$m'(m, \mathfrak q)$ in the previous paragraph tells us that
for $k \geq m'(\mathfrak q)$ and $j \geq -d - s$ the map
$$
E(m, j)_\mathfrak q \to E(k, j)_\mathfrak q
$$
is zero and that
$$
K_{m, \mathfrak q} =
\Ker(E(m, -d - s - 1)_\mathfrak q \to E(k, -d - s - 1)_\mathfrak q)
$$
is independent of $k \geq m'(m, \mathfrak q)$ and that
$$
E(0, -d - s - 1)_\mathfrak q \to
E(m, -d - s - 1)_\mathfrak q/K_{m, \mathfrak q}
$$
is surjective. Since these modules are finite and nonzero only
for a finite number of possible $j$ (small detail omitted),
we can find an open neighbourhood $W \subset \Spec(A)$ of $\mathfrak q$
such that
$$
E(m, j)_{\mathfrak q'} \to E(m'(m, \mathfrak q), j)_{\mathfrak q'}
$$
is zero for $j \geq -d - s$ for all $\mathfrak q' \in W$.
Then of course the maps $E(m, j)_{\mathfrak q'} \to E(k, j)_{\mathfrak q'}$
for $k \geq m'(m, \mathfrak q)$ are zero as well.
Set
$$
K_m = \Ker(E(m, -d - s - 1) \to E(m'(m, \mathfrak q), -d - s - 1))
$$
After shrinking $W$ we may assume that every
$\mathfrak p \in \text{Ass}(K_m) \cap W$ is
contained in $\mathfrak q$.
We conclude that for $\mathfrak q' \in W$ and $k \geq m'(m, \mathfrak q)$
we have
$$
K_{m, \mathfrak q'} =
\Ker(E(m, -d - s - 1)_{\mathfrak q'} \to E(k, -d - s - 1)_{\mathfrak q'})
$$
Namely, the associated primes of $K_{m, \mathfrak q'}$
are all primes $\mathfrak q'' \subset \mathfrak q \cap \mathfrak q'$
by our choice of $W$. Hence $K_{m, \mathfrak q'}$ is a submodule
of a product of localizations of $K_{m, \mathfrak q}$ at these
primes $\mathfrak q''$. And by our choice of $m'(m, \mathfrak q)$
the kernels of the maps
$E(m, j)_{\mathfrak q''} \to E(m'(m, \mathfrak q), j)_{\mathfrak q''}$
are equal to $K_{m, \mathfrak q''}$.
After shrinking $W$ further if necessary, we may also assume that
$$
E(0, -d - s - 1)_{\mathfrak q'} \to
E(m, -d - s - 1)_{\mathfrak q'}/K_{m, \mathfrak q'}
$$
is surjective for all $\mathfrak q' \in W$ (as before use that
these modules are finite
and that the map is surjective after localization at $\mathfrak q$).

\medskip\noindent
Since any subset of the Noetherian topological space $\Spec(A)$
with the endowed topology is Noetherian we conclude that we
can find $m'(m, d)$ such that for all $\mathfrak q$ with
$d = \delta(\mathfrak q)$ we have
$$
E(m, j)_\mathfrak q \to E(m'(m, \mathfrak q), j)_\mathfrak q
$$
is zero for $j \geq -d - s$ for all $\mathfrak q' \in W$ and
with $K_m = \Ker(E(m, -d - s - 1) \to E(m'(d), -d - s - 1))$
we have
$$
K_{m, \mathfrak q} =
\Ker(E(m, -d - s - 1)_{\mathfrak q} \to E(k, -d - s - 1)_{\mathfrak q})
$$
for all $k \geq m'(d)$ and the map
$$
E(0, -d - s - 1)_\mathfrak q \to
E(m, -d - s - 1)_\mathfrak q/K_{m, \mathfrak q}
$$
is surjective. Using the local duality theorem again (in the opposite
direction) we conclude that the claim is correct.

\medskip\noindent
Thus we have the integer $m'(m)$ which works for all
$\mathfrak q \in V(\mathfrak a)$. By Lemma \ref{lemma-zero}
this means that there exists an integer $m''(m)$
such that the map
$$
H^i_\mathfrak a(I^kM) \longrightarrow H^i_\mathfrak a(I^mM)
$$
is zero for all $k \geq m''(m)$ which is what we wanted to prove.
For the statement about the system $H^{s + 1}_\mathfrak a(I^nM)$
we use Lemma \ref{lemma-essential-image}.
This ends the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-final-bootstrap}
In Situation \ref{situation-bootstrap} we have an integer $m_0 \geq 0$
such that
\begin{enumerate}
\item $\{H^i_\mathfrak a(M/I^nM)\}_{n \geq 0}$
satisfy the Mittag-Leffler condition for $i < s$.
\item $\{H^i_\mathfrak a(I^{m_0}M/I^nM)\}_{n \geq m_0}$
satisfy the Mittag-Leffler condition for $i \leq s$,
\item $H^i_\mathfrak a(M) \to \lim H^i_\mathfrak a(M/I^nM)$
is an isomorphism for $i < s$,
\item $H^s_\mathfrak a(I^{m_0}M) \to \lim H^s_\mathfrak a(I^{m_0}M/I^nM)$
is an isomorphism for $i \leq s$,
\item $H^s_\mathfrak a(M) \to \lim H^s_\mathfrak a(M/I^nM)$ is
injective with cokernel killed by $I^{m_0}$, and
\item $R^1\lim H^s_\mathfrak a(M/I^nM)$ is killed by $I^{m_0}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the long exact sequences
$$
0 \to H^0_\mathfrak a(I^nM) \to H^0_\mathfrak a(M) \to
H^0_\mathfrak a(M/I^nM) \to H^1_\mathfrak a(I^nM) \to
H^1_\mathfrak a(M) \to \ldots
$$
Parts (1) and (3) follows easily from this and Lemma \ref{lemma-bootstrap}.

\medskip\noindent
Let $m_0$ and $m'(-)$ be as in Lemma \ref{lemma-bootstrap}.
For $m \geq m_0$ consider the long exact sequence
$$
H^s_\mathfrak a(I^mM) \to H^s_\mathfrak a(I^{m_0}M) \to
H^s_\mathfrak a(I^{m_0}M/I^mM) \to H^{s + 1}_\mathfrak a(I^mM) \to
H^1_\mathfrak a(I^{m_0}M)
$$
Then for $k \geq m'(m)$ the image of
$H^{s + 1}_\mathfrak a(I^kM) \to H^{s + 1}_\mathfrak a(I^mM)$
maps injectively to $H^{s + 1}_\mathfrak a(I^{m_0}M)$.
Hence the image of
$H^s_\mathfrak a(I^{m_0}M/I^kM) \to H^s_\mathfrak a(I^{m_0}M/I^mM)$
maps to zero in $H^{s + 1}_\mathfrak a(I^mM)$ for all $k \geq m'(m)$.
We conclude that (2) and (4) hold.

\medskip\noindent
Consider the short exact sequences
$0 \to I^{m_0}M \to M \to M/I^{m_0} M \to 0$ and
$0 \to I^{m_0}M/I^nM \to M/I^nM \to M/I^{m_0} M \to 0$.
We obtain a diagram
$$
\xymatrix{
H^{s - 1}_\mathfrak a(M/I^{m_0}M) \ar[r] &
\lim H^s_\mathfrak a(I^{m_0}M/I^nM) \ar[r] &
\lim H^s_\mathfrak a(M/I^nM) \ar[r] &
H^s_\mathfrak a(M/I^{m_0}M) \\
H^{s - 1}_\mathfrak a(M/I^{m_0}M) \ar[r] \ar@{=}[u] &
H^s_\mathfrak a(I^{m_0}M) \ar[r] \ar[u]_{\cong} &
H^s_\mathfrak a(M) \ar[r] \ar[u] &
H^s_\mathfrak a(M/I^{m_0}M) \ar@{=}[u]
}
$$
whose lower row is exact. The top row is also exact
(at the middle two spots) by
Homology, Lemma \ref{homology-lemma-apply-Mittag-Leffler}.
Part (5) follows.

\medskip\noindent
Write $B_n = H^s_\mathfrak a(M/I^nM)$. Let $A_n \subset B_n$
be the image of $H^s_\mathfrak a(I^{m_0}M/I^nM) \to H^s_\mathfrak a(M/I^nM)$.
Then $(A_n)$ satisfies the Mittag-Leffler condition by (2) and
Homology, Lemma \ref{homology-lemma-Mittag-Leffler}.
Also $C_n = B_n/A_n$ is killed by $I^{m_0}$. Thus
$R^1\lim B_n \cong R^1\lim C_n$ is killed by $I^{m_0}$ and we get (6).
\end{proof}

\begin{lemma}
\label{lemma-combine-one}
In Situation \ref{situation-bootstrap} if $A$ is $I$-adically complete
and condition (5) of
Lemma \ref{lemma-algebraize-local-cohomology-general}
holds, then in addition to the results of
Lemma \ref{lemma-final-bootstrap} we have
$H^s_\mathfrak a(M) = \lim H^s_\mathfrak a(M/I^nM)$.
\end{lemma}

\begin{proof}
Combining Lemmas \ref{lemma-bootstrap-inherited},
\ref{lemma-algebraize-local-cohomology-general}, and
\ref{lemma-kill-colimit-support-general}
we see that the first map of
$$
H^s_\mathfrak a(M) \to H^s(R\Gamma_\mathfrak a(M)^\wedge) \to
\lim H^s_\mathfrak a(M/I^nM)
$$
is an isomorphism and
Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local}
implies the second map is surjective.
\end{proof}

\begin{lemma}
\label{lemma-combine-two}
Let $I \subset \mathfrak a \subset A$ be ideals of a Noetherian ring $A$
and let $M$ be a finite $A$-module. Let $s$ and $d$ be integers.
Suppose that
\begin{enumerate}
\item $A, I, \mathfrak a, M$ satisfy the conditions of
Situation \ref{situation-bootstrap} for $s$ and $d$, and
\item $A, I, \mathfrak a, M$ satisfy the conditions of
Lemma \ref{lemma-algebraize-local-cohomology-general}
for $s + 1$ and $d$ with $J = \mathfrak a$.
\end{enumerate}
Then there exists an ideal
$J_0 \subset \mathfrak a$ with $V(J_0) \cap V(I) = V(\mathfrak a)$
such that for any $J \subset J_0$ with $V(J) \cap V(I) = V(\mathfrak a)$
the map
$$
H^{s + 1}_J(M) \longrightarrow \lim H^{s + 1}_\mathfrak a(M/I^nM)
$$
is surjective with kernel annihilated by a power of $I$.
\end{lemma}

\begin{proof}
Namely, we have the existence of $J_0$
and the isomorphism
$H^{s + 1}_J(M) = H^{s + 1}(R\Gamma_\mathfrak a(M)^\wedge)$
by Lemma \ref{lemma-algebraize-local-cohomology-general},
we have $H^{s + 1}(R\Gamma_\mathfrak a(M)^\wedge)$ sandwiched
between the limit and $R^1\lim H^s_\mathfrak a(M/I^nM)$ by
Dualizing Complexes, Lemma \ref{dualizing-lemma-completion-local},
and the module
$R^1\lim H^s_\mathfrak a(M/I^nM)$
is annihilated by a power of $I$
by Lemma \ref{lemma-final-bootstrap}.
\end{proof}








\section{Algebraization of formal sections on punctured spectra}
\label{section-algebraization-sections}

\noindent
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let
$$
X = \Spec(A) \supset U = \Spec(A) \setminus \{\mathfrak m\}
$$
and denote $Y = V(I)$ the closed subscheme corresponding to $I$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
In this section we consider the limits
$$
\lim_n H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
This is closely related to the cohomology of the pullback
of $\mathcal{F}$ to the formal completion of $U$ along $Y$;
however, since we have not yet introduced formal schemes,
we cannot use this terminology here.

\begin{lemma}
\label{lemma-compare-with-derived-completion}
Let $U$ be the punctured spectrum of a Noetherian local ring $A$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
Let $I \subset A$ be an ideal. Then
$$
H^i(R\Gamma(U, \mathcal{F})^\wedge) =
\lim H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
for all $i$ where $R\Gamma(U, \mathcal{F})^\wedge$ denotes
the derived $I$-adic completion.
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-formal-functions-general} and
\ref{lemma-derived-completion-pseudo-coherent} we have
$$
R\Gamma(U, \mathcal{F})^\wedge =
R\Gamma(U, \mathcal{F}^\wedge) =
R\Gamma(U, R\lim \mathcal{F}/I^n\mathcal{F})
$$
Thus we obtain short exact sequences
$$
0 \to R^1\lim H^{i - 1}(U, \mathcal{F}/I^n\mathcal{F}) \to
H^i(R\Gamma(U, \mathcal{F})^\wedge) \to
\lim H^i(U, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
by Cohomology, Lemma \ref{cohomology-lemma-RGamma-commutes-with-Rlim}.
The $R^1\lim$ terms vanish because the systems of groups
$H^i(U, \mathcal{F}/I^n\mathcal{F})$ satisfy the Mittag-Leffler condition
by Lemma \ref{lemma-ML-local}.
\end{proof}

\begin{theorem}
\label{theorem-algebraization-formal-sections}
\begin{reference}
The method of proof follows roughly the method of
proof of \cite[Theorem 1]{Faltings-algebraisation}
and \cite[Satz 2]{Faltings-uber}.
The result is almost the same as
\cite[Theorem 1.1]{MRaynaud-paper} (affine complement case) and
\cite[Theorem 3.9]{MRaynaud-book} (complement is union of few affines).
\end{reference}
Let $(A, \mathfrak m)$ be a Noetherian local ring which has a
dualizing complex and is complete with respect to an ideal $I$.
Set $X = \Spec(A)$, $Y = V(I)$, and $U = X \setminus \{\mathfrak m\}$.
Let $\mathcal{F}$ be a coherent sheaf on $U$.
Assume
\begin{enumerate}
\item $\text{cd}(A, I) \leq d$, i.e.,
$H^i(X \setminus Y, \mathcal{G}) = 0$ for $i \geq d$ and
quasi-coherent $\mathcal{G}$ on $X$,
\item for any $x \in X \setminus Y$ whose closure $\overline{\{x\}}$
in $X$ meets $Y \cap U$ we have
$$
\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) \geq s
\quad\text{or}\quad
\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x)
+ \dim(\overline{\{x\}}) > d + s
$$
\end{enumerate}
Then there exists an open $V_0 \subset U$ containing $Y \cap U$
such that for any open $V \subset V_0$ containing $Y \cap U$
the map
$$
H^i(V, \mathcal{F}) \to \lim H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
is an isomorphism for $i < s$. If in addition
$
\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) +
\dim(\overline{\{x\}}) > s
$
for all $x \in Y \cap U$, then these cohomology groups are finite $A$-modules.
\end{theorem}

\begin{proof}
Choose a finite $A$-module $M$ such that $\mathcal{F}$ is the
restriction to $U$ of the
coherent $\mathcal{O}_X$-module associated to $M$, see
Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}.
Then the assumptions of
Lemma \ref{lemma-algebraize-local-cohomology}
are satisfied.
Pick $J_0$ as in that lemma and set $V_0 = X \setminus V(J_0)$.
Then opens $V \subset V_0$ containing $Y \cap U$
correspond $1$-to-$1$ with ideals $J \subset J_0$ with
$V(J) \cap V(I) = \{\mathfrak m\}$.
Moreover, for such a choice we have a distinguished triangle
$$
R\Gamma_J(M) \to M \to R\Gamma(V, \mathcal{F}) \to
R\Gamma_J(M)[1]
$$
We similarly have a distinguished triangle
$$
R\Gamma_\mathfrak m(M)^\wedge \to
M \to
R\Gamma(U, \mathcal{F})^\wedge \to
R\Gamma_\mathfrak m(M)^\wedge[1]
$$
involving derived $I$-adic completions.
The cohomology groups of $R\Gamma(U, \mathcal{F})^\wedge$ are
equal to the limits in the statement of the theorem by
Lemma \ref{lemma-compare-with-derived-completion}.
The canonical map between these triangles
and some easy arguments show that our
theorem follows from the main Lemma \ref{lemma-algebraize-local-cohomology}
(note that we have $i < s$ here whereas we have
$i \leq s$ in the lemma; this is because of the shift).
The finiteness of the cohomology groups
(under the additional assumption) follows from
Lemma \ref{lemma-kill-colimit}.
\end{proof}

\begin{lemma}
\label{lemma-application-theorem}
Let $(A, \mathfrak m)$ be a Noetherian local ring which has a
dualizing complex and is complete with respect to an ideal $I$.
Set $X = \Spec(A)$, $Y = V(I)$, and $U = X \setminus \{\mathfrak m\}$.
Let $\mathcal{F}$ be a coherent sheaf on $U$.
Assume
\begin{enumerate}
\item $\text{cd}(A, I) \leq d$,
\item for any $x \in U$ which is an associated point of $\mathcal{F}$
we have $\dim(\overline{\{x\}}) > d + 1$.
\end{enumerate}
Then the map
$$
\colim H^0(V, \mathcal{F})
\longrightarrow
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})
$$
is an isomorphism of finite $A$-modules
where the colimit is over opens $V \subset U$
containing $Y \cap U$.
\end{lemma}

\begin{proof}
Apply Theorem \ref{theorem-algebraization-formal-sections} with $s = 1$
(we get finiteness too).
\end{proof}




\section{Algebraization of formal sections}
\label{section-algebraization-sections-coherent}

\noindent
It is a bit difficult to succintly state all possible
consequences of the results in
Sections \ref{section-algebraization-sections-general} and
\ref{section-bootstrap}
for cohomology of coherent sheaves on quasi-affine schemes
and their completion with respect to an ideal.
Perhaps the most interesting applications are for $H^0$.
Here is an example result; there are many variant conditions
one could impose -- the one we chose has the advantage that
it is fairly short to state.

\begin{proposition}
\label{proposition-application-H0}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $\mathcal{F}$ be a coherent module on
$U = \Spec(A) \setminus V(\mathfrak a)$.
Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $x \in \text{Ass}(\mathcal{F})$, $x \not \in V(I)$,
$z \in V(\mathfrak a) \cap \overline{\{x\}}$, then
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) > \text{cd}(A, I) + 1$,
\item one of the following holds:
\begin{enumerate}
\item the restriction of $\mathcal{F}$ to $U \setminus V(I)$ is $(S_1)$
\item the dimension of $V(\mathfrak a)$ is at most $2$\footnote{In
the sense that the difference of the maximal and minimal values
on $V(\mathfrak a)$ of a dimension function on $\Spec(A)$ is at most $2$.}.
\end{enumerate}
\end{enumerate}
Then we obtain an isomorphism
$$
\colim H^0(V, \mathcal{F})
\longrightarrow
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})
$$
where the colimit is over opens $V \subset U$ containing $U \cap V(I)$.
\end{proposition}

\begin{proof}
Choose a finite $A$-module $M$ such that $\mathcal{F}$ is the restriction
to $U$ of the coherent module associated to $M$, see
Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}.
Set $d = \text{cd}(A, I)$.
Let $\mathfrak p$ be a prime of $A$ not contained in $V(I)$
and let $\mathfrak q \in V(\mathfrak a) \cap V(I)$.
Then either $\mathfrak p$ is not an associated prime of $M$
and hence $\text{depth}(M_\mathfrak p) \geq 1$
or we have $\dim((A/\mathfrak p)_\mathfrak q) > d + 1$ by (2).
Thus the hypotheses of
Lemma \ref{lemma-algebraize-local-cohomology-general}
are satisfied for $s = 1$ and $d$; here we use condition (3).
Thus we find there exists an ideal
$J_0 \subset \mathfrak a$ with $V(J_0) \cap V(I) = V(\mathfrak a)$
such that for any $J \subset J_0$ with $V(J) \cap V(I) = V(\mathfrak a)$
the maps
$$
H^i_J(M) \longrightarrow H^i(R\Gamma_\mathfrak a(M)^\wedge)
$$
are isomorphisms for $i = 0, 1$. Consider the morphisms of
exact triangles
$$
\xymatrix{
R\Gamma_J(M)  \ar[d] \ar[r] &
M \ar[r] \ar[d] &
R\Gamma(V, \mathcal{F}) \ar[d] \ar[r] &
R\Gamma_J(M)[1]  \ar[d] \\
R\Gamma_J(M)^\wedge \ar[r] &
M \ar[r] &
R\Gamma(V, \mathcal{F})^\wedge \ar[r] &
R\Gamma_J(M)^\wedge[1] \\
R\Gamma_\mathfrak a(M)^\wedge \ar[r] \ar[u] &
M \ar[r] \ar[u] &
R\Gamma(U, \mathcal{F})^\wedge \ar[r] \ar[u] &
R\Gamma_\mathfrak a(M)^\wedge[1] \ar[u]
}
$$
where $V = \Spec(A) \setminus V(J)$. Recall that
$R\Gamma_\mathfrak a(M)^\wedge \to R\Gamma_J(M)^\wedge$
is an isomorphism (because $\mathfrak a$, $\mathfrak a + I$, and $J + I$
cut out the same closed subscheme, for example
see proof of Lemma \ref{lemma-algebraize-local-cohomology-general}).
Hence
$R\Gamma(U, \mathcal{F})^\wedge = R\Gamma(V, \mathcal{F})^\wedge$.
This produces a commutative diagram
$$
\xymatrix{
0 \ar[r] &
H^0_J(M) \ar[r] \ar[d] &
M \ar[r] \ar[d] \ar[r] &
\Gamma(V, \mathcal{F}) \ar[d] \ar[r] &
H^1_J(M) \ar[d] \ar[r] &
0 \\
0 \ar[r] &
H^0(R\Gamma_J(M)^\wedge) \ar[r] &
M \ar[r] &
H^0(R\Gamma(V, \mathcal{F})^\wedge) \ar[r] &
H^1(R\Gamma_J(M)^\wedge) \ar[r] &
0 \\
0 \ar[r] &
H^0(R\Gamma_\mathfrak a(M)^\wedge) \ar[r] \ar[u] &
M \ar[r] \ar[u] &
H^0(R\Gamma(U, \mathcal{F})^\wedge) \ar[r] \ar[u] &
H^1(R\Gamma_\mathfrak a(M)^\wedge) \ar[r] \ar[u] &
0
}
$$
with exact rows and isomorphisms for the lower vertical arrows. Hence
we obtain an isomorphism
$\Gamma(V, \mathcal{F}) \to H^0(R\Gamma(U, \mathcal{F})^\wedge)$.
By Lemmas \ref{lemma-formal-functions-general}
and \ref{lemma-derived-completion-pseudo-coherent} we have
$$
R\Gamma(U, \mathcal{F})^\wedge =
R\Gamma(U, \mathcal{F}^\wedge) =
R\Gamma(U, R\lim \mathcal{F}/I^n\mathcal{F})
$$
and we find $H^0(R\Gamma(U, \mathcal{F})^\wedge) =
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})$ by
Cohomology, Lemma \ref{cohomology-lemma-RGamma-commutes-with-Rlim}.
\end{proof}

\begin{example}
\label{example-H0}
Let $A$ be a Noetherian domain which has a dualizing complex
and which is complete with respect to a nonzero $f \in A$.
Let $f \in \mathfrak a \subset A$ be an ideal.
Assume every irreducible component of $Z = V(\mathfrak a)$
has codimension $> 2$ in $X = \Spec(A)$. Equivalently, assume every
irreducible component of $Z$ has codimension $> 1$ in $Y = V(f)$.
Then with
$U = X \setminus Z$ every element of
$$
\lim_n \Gamma(U, \mathcal{O}_U/f^n \mathcal{O}_U)
$$
is the restriction of a section of $\mathcal{O}_U$ defined on an
open neighbourhood of
$$
V(f) \setminus Z = V(f) \cap U = Y \setminus Z = Y \cap U
$$
In particular we see that $Y \setminus Z$ is connected. See
Lemma \ref{lemma-connected} below.
\end{example}

\begin{proposition}
\label{proposition-application-higher}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Let $\mathcal{F}$ be a coherent module on
$U = \Spec(A) \setminus V(\mathfrak a)$.
Let $s \geq 0$.
Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $x \in U \setminus V(I)$ then
$\text{depth}(\mathcal{F}_x) > s$ or
$$
\text{depth}(\mathcal{F}_x) +
\dim(\mathcal{O}_{\overline{\{x\}}, z}) > \text{cd}(A, I) + s + 1
$$
for all $z \in V(\mathfrak a) \cap \overline{\{x\}}$,
\item one of the following conditions holds:
\begin{enumerate}
\item the restriction of $\mathcal{F}$ to $U \setminus V(I)$
is $(S_{s + 1})$, or
\item the dimension of $V(\mathfrak a)$ is at most $2$\footnote{In
the sense that the difference of the maximal and minimal values
on $V(\mathfrak a)$ of a dimension function on $\Spec(A)$ is at most $2$.}.
\end{enumerate}
\end{enumerate}
Then the maps
$$
H^i(U, \mathcal{F})
\longrightarrow
\lim H^i(U, \mathcal{F}/I^n\mathcal{F})
$$
are isomorphisms for $i < s$. Moreover we have a surjection
$$
\colim H^s(V, \mathcal{F})
\longrightarrow
\lim H^s(U, \mathcal{F}/I^n\mathcal{F})
$$
with kernel annihilated by a power of $I$
where the colimit is over opens $V \subset U$ containing $U \cap V(I)$.
\end{proposition}

\begin{proof}
We may assume $s > 0$ as the case $s = 0$ was done in
Proposition \ref{proposition-application-H0}.

\medskip\noindent
Choose a finite $A$-module $M$ such that $\mathcal{F}$ is the restriction
to $U$ of the coherent module associated to $M$, see
Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}.
Set $d = \text{cd}(A, I)$.
Let $\mathfrak p$ be a prime of $A$ not contained in $V(I)$
and let $\mathfrak q \in V(\mathfrak a) \cap V(I)$.
Then either $\text{depth}(M_\mathfrak p) \geq s + 1 > s$
or we have $\dim((A/\mathfrak p)_\mathfrak q) > d + s + 1$ by (2).
By Lemma \ref{lemma-bootstrap-bis-bis} we conclude that the
assumptions of Situation \ref{situation-bootstrap}
are satisfied for $s$ and $d$.
On the other hand, the hypotheses of
Lemma \ref{lemma-algebraize-local-cohomology-general}
are satisfied for $s + 1$ and $d$; this is where condition (3) is used.

\medskip\noindent
Applying Lemma \ref{lemma-algebraize-local-cohomology-general}
we find there exists an ideal
$J_0 \subset \mathfrak a$ with $V(J_0) \cap V(I) = V(\mathfrak a)$
such that for any $J \subset J_0$ with $V(J) \cap V(I) = V(\mathfrak a)$
the maps
$$
H^i_J(M) \longrightarrow H^i(R\Gamma_\mathfrak a(M)^\wedge)
$$
is an isomorphism for $i \leq s + 1$.

\medskip\noindent
For $i \leq s$ the map $H^i_\mathfrak a(M) \to H^i_J(M)$
is an isomorphism by Lemmas \ref{lemma-bootstrap-inherited} and
\ref{lemma-kill-colimit-support-general}.
Using the relation between local cohomology and cohomology
(Lemma \ref{lemma-local-cohomology})
implies that $H^i(U, \mathcal{F}) \to H^i(U,\mathcal{F})$
is an isomorphism for $V = \Spec(A) \setminus V(J)$ and
$i < s$.

\medskip\noindent
By Lemmas \ref{lemma-final-bootstrap}, \ref{lemma-combine-one}, and
\ref{lemma-combine-two} we have the Mittag-Leffler condition for
$H^i_\mathfrak a(M/I^nM)$ for $i < s$, we have
$H^i_\mathfrak a(M) = \lim H^i_\mathfrak a(M/I^nM)$ for $i \leq s$,
and we have a surjection
$H^{s + 1}_\mathfrak a(M) \to \lim H^{s + 1}_\mathfrak a(M/I^nM)$
whose kernel is killed by a power of $I$.

\medskip\noindent
The isomorphism $H^0(U, \mathcal{F}) = H^0(V, \mathcal{F}) =
\lim H^0(U, \mathcal{F}/I^n\mathcal{F})$ follows from the above and
Proposition \ref{proposition-application-H0}.
For $0 < i < s$ we get the desired isomorphisms
$H^i(U, \mathcal{F}) = H^i(V, \mathcal{F}) =
\lim H^i(U, \mathcal{F}/I^n\mathcal{F})$ in
the same manner using the relation between local cohomology
and cohomology; it is easier than the case $i = 0$
because for $i > 0$ we have
$$
H^i(U, \mathcal{F}) = H^{i + 1}_\mathfrak a(M),
\quad
H^i(V, \mathcal{F}) = H^{i + 1}_J(M),
\quad
H^i(R\Gamma(U, \mathcal{F})^\wedge) = 
H^{i + 1}(R\Gamma_\mathfrak a(M)^\wedge)
$$
Similarly for the final statement.
\end{proof}





\section{Application to connectedness}
\label{section-connected}

\noindent
In this section we discuss Grothendieck's connectedness theorem
and variants; the original version can be found as
\cite[Exposee XIII, Theorem 2.1]{SGA2}. There is a version
called Faltings' connectedness theorem in the literature;
our guess is that this refers to \cite[Theorem 6]{Faltings-some}.
Let us state and prove the optimal version for complete
local rings given in \cite[Theorem 1.6]{Varbaro}.

\begin{lemma}
\label{lemma-punctured-still-connected}
\begin{reference}
\cite[Theorem 1.6]{Varbaro}
\end{reference}
Let $(A, \mathfrak m)$ be a Noetherian complete local ring.
Let $I$ be a proper ideal of $A$.
Set $X = \Spec(A)$ and $Y = V(I)$.
Denote
\begin{enumerate}
\item $d$ the minimal dimension of an irreducible component of $X$, and
\item $c$ the minimal dimension of a closed subset $Z \subset X$
such that $X \setminus Z$ is disconnected.
\end{enumerate}
Then for $Z \subset Y$ closed we have $Y \setminus Z$ is connected if
$\dim(Z) < \min(c, d - 1) - \text{cd}(A, I)$. In particular, the punctured
spectrum of $A/I$ is connected if $\text{cd}(A, I) < \min(c, d - 1)$.
\end{lemma}

\begin{proof}
Let us first prove the final assertion. As a first case, if the punctured
spectrum of $A/I$ is empty, then Lemma \ref{lemma-cd-bound-dim-local}
shows every irreducible component of $X$ has dimension
$\leq \text{cd}(A, I)$ and we get $\min(c, d - 1) - \text{cd}(A, I) < 0$
which implies the lemma holds in this case. Thus we may assume
$Y \cap U$ is nonempty where $U = X \setminus \{\mathfrak m\}$
is the punctured spectrum of $A$. We may replace $A$ by its reduction.
Observe that $A$ has a dualizing complex
(Dualizing Complexes, Lemma \ref{dualizing-lemma-ubiquity-dualizing})
and that $A$ is complete with respect to $I$
(Algebra, Lemma \ref{algebra-lemma-complete-by-sub}).
If we assume $d - 1 > \text{cd}(A, I)$, then we may apply
Lemma \ref{lemma-application-theorem} to see that
$$
\colim H^0(V, \mathcal{O}_V)
\longrightarrow
\lim H^0(U, \mathcal{O}_U/I^n\mathcal{O}_U)
$$
is an isomorphism where the colimit is over opens $V \subset U$
containing $Y \cap U$. If $Y \cap U$ is disconnected, then
its $n$th infinitesimal neighbourhood in $U$ is disconnected
for all $n$ and we find the
right hand side has a nontrivial idempotent (here we use
that $Y \cap U$ is nonempty).
Thus we can find a $V$ which is disconnected.
Set $Z = X \setminus V$. By Lemma \ref{lemma-cd-bound-dim-local}
we see that every irreducible component of $Z$ has dimension
$\leq \text{cd}(A, I)$. Hence $c \leq \text{cd}(A, I)$ and this
indeed proves the final statement.

\medskip\noindent
We can deduce the statement of the lemma from what we just proved
as follows. Suppose that $Z \subset Y$ closed and $Y \setminus Z$ is
disconnected and $\dim(Z) = e$. Recall that a connected space is nonempty
by convention. Hence we conclude either (a) $Y = Z$ or (b)
$Y \setminus Z = W_1 \amalg W_2$ with $W_i$ nonempty, open, and closed
in $Y \setminus Z$. In case (b) we may pick points $w_i \in W_i$
which are closed in $U$, see
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-Jacobson-schemes}.
Then we can find $f_1, \ldots, f_e \in \mathfrak m$
such that $V(f_1, \ldots, f_e) \cap Z = \{\mathfrak m\}$
and in case (b) we may assume $w_i \in V(f_1, \ldots, f_e)$.
Namely, we can inductively using prime avoidance
choose $f_i$ such that $\dim V(f_1, \ldots, f_i) \cap Z = e - i$
and such that in case (b) we have $w_1, w_2 \in V(f_i)$.
It follows that the punctured spectrum of $A/I + (f_1, \ldots, f_e)$
is disconnected (small detail omitted). Since
$\text{cd}(A, I + (f_1, \ldots, f_e)) \leq \text{cd}(A, I) + e$
by Lemmas \ref{lemma-cd-sum} and \ref{lemma-bound-cd} we conclude that
$$
\text{cd}(A, I) + e \geq \min(c, d - 1)
$$
by the first part of the proof. This implies
$e \geq \min(c, d - 1) - \text{cd}(A, I)$ which is what we had to show.
\end{proof}

\begin{lemma}
\label{lemma-connected}
Let $I \subset \mathfrak a$ be ideals of a Noetherian ring $A$.
Assume
\begin{enumerate}
\item $A$ is $I$-adically complete and has a dualizing complex,
\item if $\mathfrak p \subset A$ is a minimal prime not contained
in $V(I)$ and $\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$, then
$\dim((A/\mathfrak p)_\mathfrak q) > \text{cd}(A, I) + 1$,
\item any nonempty open $V \subset \Spec(A)$ which contains
$V(I) \setminus V(\mathfrak a)$ is connected\footnote{For example
if $A$ is a domain.}.
\end{enumerate}
Then $V(I) \setminus V(\mathfrak a)$ is either empty or connected.
\end{lemma}

\begin{proof}
We may assume $A$ is reduced. Then $A$ is $(S_1)$ by
Algebra, Lemma \ref{algebra-lemma-criterion-reduced}.
By Proposition \ref{proposition-application-H0} we see that
$$
\colim H^0(V, \mathcal{O}_V) = \lim H^0(T_n, \mathcal{O}_{T_n})
$$
where the colimit is over the opens $V$ as in (3) and
$T_n$ is the $n$th infinitesimal neighbourhood of
$T = V(I) \setminus V(\mathfrak a)$ in $U = \Spec(A) \setminus V(\mathfrak a)$.
Thus $T$ is either empty or connected, since if not, then the right hand side
would have a nontrivial idempotent and we've assumed the left hand
side does not. Some details omitted.
\end{proof}




\section{Algebraization of coherent formal modules}
\label{section-algebraization-modules}

\noindent
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let
$$
X = \Spec(A) \supset U = \Spec(A) \setminus \{\mathfrak m\}
$$
and denote $Y = V(I)$ the closed subscheme corresponding to $I$.
In this section we consider inverse systems of coherent
$\mathcal{O}_U$-modules $(\mathcal{F}_n)$ with $\mathcal{F}_n$
annihilated by $I^n$ such that the transition maps induce
isomorphisms $\mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1} \to \mathcal{F}_n$.
The category of these systems was denoted
$$
\textit{Coh}(U, I\mathcal{O}_U)
$$
in Cohomology of Schemes, Section \ref{coherent-section-existence}.
This category is equivalent to the category of coherent modules
on the formal completion of $U$ along $Y$; however, since we have
not yet introduced formal schemes or coherent modules on them,
we cannot use this terminology here.

\begin{lemma}
\label{lemma-system-of-modules}
With $A, \mathfrak m, I, X, U$ as above.
Consider an inverse system $(M_n)$ of finite $A$-modules such
that $M_n$ is annihilated by $I^n$ and the kernel and cokernel of
$M_{n + 1}/I^nM_{n + 1} \to M_n$ have finite length.
Then $\widetilde{M}_n|_U$ is in $\textit{Coh}(U, I\mathcal{O}_U)$.
Conversely, every object of $\textit{Coh}(U, I\mathcal{O}_U)$
is of this form.
\end{lemma}

\begin{proof}
Omitted, but see Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}.
\end{proof}

\noindent
If $A$ is $I$-adically complete, then an important question
is whether the completion functor Cohomology of Schemes,
Equation (\ref{coherent-equation-completion-functor})
$$
\textit{Coh}(\mathcal{O}_U)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U),\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is essentially surjective. Fully faithfullness of this functor
is often a consequence of the results in
Section \ref{section-algebraization-sections}
applied to suitable $\SheafHom$'s.
The essential surjectivity of the completion functor
was studied systematically in
\cite{SGA2}, \cite{MRaynaud-book}, and \cite{MRaynaud-paper}.
We will discuss this material (insert future reference here).
In this section we discuss only the case where the closed
subset $Y$ is cut out by a single nonzerodivisor and we only
deal with algebraization of formal vector bundles.

\begin{lemma}
\label{lemma-algebraization-principal}
With $A, \mathfrak m, I, X, U$ as above let
$(\mathcal{F}_n)$ be an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
Assume
\begin{enumerate}
\item $A$ has a dualizing complex and is complete with respect to $I$,
\item $I = (f)$ is a principal ideal for a nonzerodivisor $f \in \mathfrak m$,
\item $\mathcal{F}_n$ is a finite locally free
$\mathcal{O}_U/f^n\mathcal{O}_U$-module,
\item if $\mathfrak p \in V(f) \setminus \{\mathfrak m\}$, then
$\text{depth}((A/f)_\mathfrak p) + \dim(A/\mathfrak p) > 1$, and
\item if $\mathfrak p \not \in V(f)$ and
$V(\mathfrak p) \cap V(f) \not = \{\mathfrak m\}$, then
$\text{depth}(A_\mathfrak p) + \dim(A/\mathfrak p) > 3$.
\end{enumerate}
Then there exists a coherent $\mathcal{O}_U$-module
$\mathcal{F}$ such that $(\mathcal{F}_n)$ is the completion of $\mathcal{F}$.
\end{lemma}

\begin{proof}
By induction on $n$ and the short exact sequences
$0 \to A/f^n \to A/f^{n + 1} \to A/f \to 0$ we see that
the associate primes of $A/f^nA$ agree with the associated
primes of $A/fA$. Since the associated points of $\mathcal{F}_n$
correspond to the associated primes of $A/f^nA$ not equal to $\mathfrak m$
by condition (3), we conclude that
$M_n = H^0(U, \mathcal{F}_n)$ is a finite $A$-module by
(4) and Proposition \ref{proposition-kollar}.

\medskip\noindent
We claim that for any $n > 0$ and $m \gg n$ the image of
$$
H^1(U, \mathcal{F}_m) \longrightarrow H^1(U, \mathcal{F}_n)
$$
has finite length as an $A$-module. The image is independent
of $m$ for $m$ large enough by Lemma \ref{lemma-ML-local}.
Let $\omega_A^\bullet$ be a normalized dualizing complex for $A$.
By the local duality theorem and Matlis duality
(Dualizing Complexes, Lemma \ref{dualizing-lemma-special-case-local-duality}
and Proposition \ref{dualizing-proposition-matlis})
our claim is equivalent to: the image of
$$
\text{Ext}^{-2}_A(M_n, \omega_A^\bullet) \to
\text{Ext}^{-2}_A(M_m, \omega_A^\bullet)
$$
has finite length for $m \gg n$. The modules in question are
finite $A$-modules supported at $V(f)$. Thus it suffices to show that this
map is zero after localization at a prime $\mathfrak q$
containing $f$ and different from $\mathfrak m$.
Let $\omega_{A_\mathfrak q}^\bullet$ be a normalized
dualizing complex on $A_\mathfrak q$ and recall that
$\omega_{A_\mathfrak q}^\bullet =
(\omega_A^\bullet)_\mathfrak q[\dim(A/\mathfrak q)]$ by
Dualizing Complexes, Lemma \ref{dualizing-lemma-dimension-function}.
Using the local structure of $\mathcal{F}_n$ given in (3)
we find that it suffices to show the vanishing of
$$
\text{Ext}^{-2 + \dim(A/\mathfrak q)}_{A_\mathfrak q}(
A_\mathfrak q/f^n, \omega_{A_\mathfrak q}^\bullet)
\to
\text{Ext}^{-2 + \dim(A/\mathfrak q)}_{A_\mathfrak q}(
A_\mathfrak q/f^m, \omega_{A_\mathfrak q}^\bullet)
$$
If $\dim(A/\mathfrak q) > 3$, then this is immediate from
Lemma \ref{lemma-sitting-in-degrees}. We will use the
long exact sequence
$$
\ldots
\xrightarrow{f^m}
H^{-1}(\omega_{A_\mathfrak q}^\bullet)
\to
\text{Ext}^{-1}_{A_\mathfrak q}(
A_\mathfrak q/f^m, \omega_{A_\mathfrak q}^\bullet) \to
H^0(\omega_{A_\mathfrak q}^\bullet)
\xrightarrow{f^m}
H^0(\omega_{A_\mathfrak q}^\bullet)
\to
\text{Ext}^0_{A_\mathfrak q}(
A_\mathfrak q/f^m, \omega_{A_\mathfrak q}^\bullet) \to 0
$$
If $\dim(A/\mathfrak q) = 2$, then
$H^0(\omega_{A_\mathfrak q}^\bullet) = 0$ as
the depth of $A_\mathfrak q$ is zero by dint of
$f$ being a nonzerodivisor.
Thus the long exact sequence shows the condition is that
$$
f^{m - n} :
H^{-1}(\omega_{A_\mathfrak q}^\bullet)/f^n \to
H^{-1}(\omega_{A_\mathfrak q}^\bullet)/f^m
$$
is zero. Now $H^{-1}(\omega^\bullet_\mathfrak q)$ is a finite
module supported in the primes $\mathfrak p \subset A_\mathfrak q$
such that $\text{depth}(A_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q)
\leq 1$. By condition (5) all of these primes are contained in $V(f)$.
Thus the desired vanishing for $m$ large enough.
If $\dim(A/\mathfrak q) = 1$, then condition (4) combined
with the fact that $f$ is a nonzerodivisor
insures that $A_\mathfrak q$ has depth at least $2$. Hence
$H^0(\omega_{A_\mathfrak q}^\bullet) =
H^{-1}(\omega_{A_\mathfrak q}^\bullet) = 0$
and the long exact sequence shows the claim is
equivalent to the vanishing of
$$
f^{m - n} :
H^{-2}(\omega_{A_\mathfrak q}^\bullet)/f^n \to
H^{-2}(\omega_{A_\mathfrak q}^\bullet)/f^m
$$
Now $H^{-2}(\omega^\bullet_\mathfrak q)$ is a finite
module supported in the primes $\mathfrak p \subset A_\mathfrak q$
such that $\text{depth}(A_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q)
\leq 2$. By condition (5) all of these primes are contained in $V(f)$.
Thus the desired vanishing for $m$ large enough proving the claim.

\medskip\noindent
By Lemmas \ref{lemma-limit-finite} and \ref{lemma-ML-better} 
the system of modules $(M_n)$ satisfies the Mittag-Leffler
condition, $M = \lim M_n$ is a finite $A$-module, $f$ is a
nonzerodivisor on $M$ and that $M/fM \subset M_1$. To finish the proof,
we will show that $M/f^nM \to M_n$ is an isomorphism after
localizing at any prime $\mathfrak q \in V(f)$,
$\mathfrak q \not = \mathfrak m$. Namely, by the Mittag-Leffler
condition, we know that $M/fM \subset M_1$ is the image of
$M_m \to M_1$ for some $m \gg 1$. Since the cokernel of
$M_m \to M_1$ is contained in $H^1(U, \mathcal{F}_{m -  1})$
which is $\mathfrak m$-power torsion, we conclude that
$M/fM \to M_1$ becomes an isomorphism after localizing at $\mathfrak q$.
Using induction and suitable short exact sequences the reader
conlcudes the same is true for $M/f^n M \to M_n$.
\end{proof}

\begin{remark}
\label{remark-interesting-case}
Let $(A, \mathfrak m)$ be a complete Noetherian normal local domain
of dimension $\geq 4$ and let $f \in \mathfrak m$ be nonzero.
Then assumptions (1), (2), (4), (5) of
Lemma \ref{lemma-algebraization-principal}
are satisfied. Thus vectorbundles
on the formal completion of $U$ along $U \cap V(f)$
can be algebraized.
\end{remark}

\begin{lemma}
\label{lemma-algebraization-principal-variant}
With $A, \mathfrak m, I, X, U$ as above let
$(\mathcal{F}_n)$ be an object of $\textit{Coh}(U, I\mathcal{O}_U)$.
Assume
\begin{enumerate}
\item $I = (f)$ is a principal ideal for a nonzerodivisor $f \in \mathfrak m$,
\item $A$ is complete with respect to $I = (f)$,
\item $\mathcal{F}_n$ is a finite locally free
$\mathcal{O}_U/f^n\mathcal{O}_U$-module,
\item $H^1_\mathfrak m(A/fA)$ and $H^2_\mathfrak m(A/fA)$
are finite $A$-modules.
\end{enumerate}
Then there exists a coherent $\mathcal{O}_U$-module
$\mathcal{F}$ such that $(\mathcal{F}_n)$ is the completion of $\mathcal{F}$.
\end{lemma}

\begin{proof}
This lemma is a variant of
Lemma \ref{lemma-algebraization-principal}
and if $A$ is a complete local ring, then it follows from that
lemma\footnote{Namely, the condition that
$H^1_\mathfrak m(A/fA)$ and $H^2_\mathfrak m(A/fA)$
are finite $A$-modules, is equivalent with
$\text{depth}((A/f)_\mathfrak q) + \dim(A/\mathfrak q) > 2$
for all $\mathfrak q \in V(f)$, $\mathfrak q \not = \mathfrak m$
by Theorem \ref{theorem-finiteness}. As $f$ is a nonzerodivisor
for such a prime
$\text{depth}(A_\mathfrak q) + \dim(A/\mathfrak q) > 3$. The locus
of these primes is open by Lemma \ref{lemma-sitting-in-degrees}.
Hence assumption (5) of Lemma \ref{lemma-algebraization-principal}
follows from condition (4) of this lemma.}.
We suggest the reader skip the proof.

\medskip\noindent
As $f$ is a nonzerodivisor we obtain short exact sequences
$$
0 \to A/f^nA \xrightarrow{f} A/f^{n + 1}A \to A/fA \to 0
$$
and we have corresponding short exact sequences
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_1 \to 0$.
We will use Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}
without further mention. Our assumptions imply that
$H^0(U, \mathcal{O}_U/f\mathcal{O}_U)$ and
$H^1(U, \mathcal{O}_U/f\mathcal{O}_U)$
are finite $A$-modules. Hence the same thing is true for $\mathcal{F}_1$, see
Lemma \ref{lemma-finiteness-for-finite-locally-free}.
Thus $H^0(U, \mathcal{F}_1)$ is a finite $A$-module
and $H^1(U, \mathcal{F}_1)$ has finite length
(as a finite $A$-module which is $\mathfrak m$-power torsion).
Thus Lemmas \ref{lemma-limit-finite} and
\ref{lemma-ML} apply to the system above. Setting
$M_n = \Gamma(U, \mathcal{F}_n)$ we find
the system of modules $(M_n)$ satisfies the Mittag-Leffler
condition, $M = \lim M_n$ is a finite $A$-module, $f$ is a
nonzerodivisor on $M$ and that $M/fM \subset M_1$. To finish the proof,
we will show that $M/f^nM \to M_n$ is an isomorphism after
localizing at any prime $\mathfrak q \in V(f)$,
$\mathfrak q \not = \mathfrak m$. Namely, by the Mittag-Leffler
condition, we know that $M/fM \subset M_1$ is the image of
$M_m \to M_1$ for some $m \gg 1$. Since the cokernel of
$M_m \to M_1$ is contained in $H^1(U, \mathcal{F}_{m -  1})$
which is $\mathfrak m$-power torsion, we conclude that
$M/fM \to M_1$ becomes an isomorphism after localizing at $\mathfrak q$.
Using induction and suitable short exact sequences the reader
conlcude the same is true for $M/f^n M \to M_n$.
\end{proof}






\section{Frobenius action}
\label{section-frobenius}

\noindent
Let $p$ be a prime number. Let $A$ be a ring with $p = 0$ in $A$.
The {\it Frobenius endomorphism} of $A$ is the map
$$
F : A \longrightarrow A,
\quad
a \longmapsto a^p
$$
In this section we prove lemmas on modules which have
Frobenius actions.

\begin{lemma}
\label{lemma-annihilator-frobenius-module}
Let $p$ be a prime number. Let $(A, \mathfrak m, \kappa)$
be a Noetherian local ring
with $p = 0$ in $A$. Let $M$ be a finite $A$-module
such that $M \otimes_{A, F} A \cong M$. Then $M$ is finite free.
\end{lemma}

\begin{proof}
Choose a presentation $A^{\oplus m} \to A^{\oplus n} \to M$
which induces an isomorphism $\kappa^{\oplus n} \to M/\mathfrak m M$.
Let $T = (a_{ij})$ be the matrix of the map $A^{\oplus m} \to A^{\oplus n}$.
Observe that $a_{ij} \in \mathfrak m$. Applying base change by
$F$, using right exactness of base change, we get a presentation
$A^{\oplus m} \to A^{\oplus n} \to M$ where the matrix is
$T = (a_{ij}^p)$. Thus we have a presentation with
$a_{ij} \in \mathfrak m^p$. Repeating this construction we
find that for each $e \geq 1$ there exists a presentation with
$a_{ij} \in \mathfrak m^e$. This implies the fitting ideals
(More on Algebra, Definition \ref{more-algebra-definition-fitting-ideal})
$\text{Fit}_k(M)$ for $k < n$ are contained in
$\bigcap_{e \geq 1} \mathfrak m^e$. Since this is zero by
Krull's intersection theorem
(Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero})
we conclude that
$M$ is free of rank $n$ by
More on Algebra, Lemma
\ref{more-algebra-lemma-fitting-ideal-finite-locally-free}.
\end{proof}

\noindent
In this section, we say elements $f_1, \ldots, f_r$ of a ring $A$
are {\it independent} if $\sum a_if_i = 0$ implies
$a_i \in (f_1, \ldots, f_r)$. In other words, with $I = (f_1, \ldots, f_r)$
we have $I/I^2$ is free over $A/I$ with basis $f_1, \ldots, f_r$.

\begin{lemma}
\label{lemma-1}
\begin{reference}
See \cite{Lech-inequalities} and \cite[Lemma 1 page 299]{MatCA}.
\end{reference}
Let $A$ be a ring. If $f_1, \ldots, f_{r - 1}, f_rg_r$
are independent, then $f_1, \ldots, f_r$ are independent.
\end{lemma}

\begin{proof}
Say $\sum a_if_i = 0$. Then $\sum a_ig_rf_i = 0$.
Hence $a_r \in (f_1, \ldots, f_{r - 1}, f_rg_r)$.
Write $a_r = \sum_{i < r} b_i f_i + b f_rg_r$.
Then $0 = \sum_{i < r} (a_i + b_if_r)f_i + bf_r^2g_r$.
Thus $a_i + b_i f_r \in (f_1, \ldots, f_{r - 1}, f_rg_r)$
which implies $a_i \in (f_1, \ldots, f_r)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-2}
\begin{reference}
See \cite{Lech-inequalities} and \cite[Lemma 2 page 300]{MatCA}.
\end{reference}
Let $A$ be a ring. If $f_1, \ldots, f_{r - 1}, f_rg_r$
are independent and if the $A$-module
$A/(f_1, \ldots, f_{r - 1}, f_rg_r)$ has finite length, then
\begin{align*}
& \text{length}_A(A/(f_1, \ldots, f_{r - 1}, f_rg_r)) \\
& =
\text{length}_A(A/(f_1, \ldots, f_{r - 1}, f_r)) +
\text{length}_A(A/(f_1, \ldots, f_{r - 1}, g_r))
\end{align*}
\end{lemma}

\begin{proof}
We claim there is an exact sequence
$$
0 \to
A/(f_1, \ldots, f_{r - 1}, g_r) \xrightarrow{f_r}
A/(f_1, \ldots, f_{r - 1}, f_rg_r) \to
A/(f_1, \ldots, f_{r - 1}, f_r) \to 0
$$
Namely, if $a f_r \in (f_1, \ldots, f_{r - 1}, f_rg_r)$, then
$\sum_{i < r} a_i f_i + (a + bg_r)f_r = 0$
for some $b, a_i \in A$. Hence
$\sum_{i < r} a_i g_r f_i + (a + bg_r)g_rf_r = 0$
which implies $a + bg_r \in (f_1, \ldots, f_{r - 1}, f_rg_r)$
which means that $a$ maps to zero in $A/(f_1, \ldots, f_{r - 1}, g_r)$.
This proves the claim.
To finish use additivity of lengths
(Algebra, Lemma \ref{algebra-lemma-length-additive}).
\end{proof}

\begin{lemma}
\label{lemma-3}
\begin{reference}
See \cite{Lech-inequalities} and \cite[Lemma 3 page 300]{MatCA}.
\end{reference}
Let $(A, \mathfrak m)$ be a local ring. If $\mathfrak m = (x_1, \ldots, x_r)$
and $x_1^{e_1}, \ldots, x_r^{e_r}$ are independent for some $e_i > 0$,
then $\text{length}_A(A/(x_1^{e_1}, \ldots, x_r^{e_r})) = e_1\ldots e_r$.
\end{lemma}

\begin{proof}
Use Lemmas \ref{lemma-1} and \ref{lemma-2} and induction.
\end{proof}

\begin{lemma}
\label{lemma-flat-extension-independent}
Let $\varphi : A \to B$ be a flat ring map.
If $f_1, \ldots, f_r \in A$ are independent, then
$\varphi(f_1), \ldots, \varphi(f_r) \in B$ are independent.
\end{lemma}

\begin{proof}
Let $I = (f_1, \ldots, f_r)$ and $J = F(I)B$. By flatness we have
$I/I^2 \otimes_A B = J/J^2$. Hence freeness of $I/I^2$ over $A/I$
implies freeness of $J/J^2$ over $B/J$.
\end{proof}

\begin{lemma}[Kunz]
\label{lemma-frobenius-flat-regular}
\begin{reference}
\cite{Kunz-flat}
\end{reference}
Let $p$ be a prime number.
Let $A$ be a Noetherian ring with $p = 0$.
The following are equivalent
\begin{enumerate}
\item $A$ is regular, and
\item $F : A \to A$, $a \mapsto a^p$ is flat.
\end{enumerate}
\end{lemma}

\begin{proof}
Observe that $\Spec(F) : \Spec(A) \to \Spec(A)$ is the identity map.
Being regular is defined in terms of the local rings and being flat
is something about local rings, see
Algebra, Lemma \ref{algebra-lemma-flat-localization}.
Thus we may and do assume $A$ is a Noetherian
local ring with maximal ideal $\mathfrak m$.

\medskip\noindent
Assume $A$ is regular. Let $x_1, \ldots, x_d$ be a
system of parameters for $A$. Applying $F$ we find
$F(x_1), \ldots, F(x_d) = x_1^p, \ldots, x_d^p$,
which is a system of parameters for $A$. Hence $F$ is flat, see
Algebra, Lemmas \ref{algebra-lemma-CM-over-regular-flat} and
\ref{algebra-lemma-regular-ring-CM}.

\medskip\noindent
Conversely, assume $F$ is flat. Write $\mathfrak m = (x_1, \ldots, x_r)$
with $r$ minimal. Then $x_1, \ldots, x_r$ are independent in the sense
defined above. Since $F$ is flat, we see that $x_1^p, \ldots, x_r^p$
are independent, see Lemma \ref{lemma-flat-extension-independent}.
Hence $\text{length}_A(A/(x_1^p, \ldots, x_r^p)) = p^r$ by
Lemma \ref{lemma-3}.
Let $\chi(n) = \text{length}_A(A/\mathfrak m^n)$ and recall
that this is a numerical polynomial of degree $\dim(A)$, see
Algebra, Proposition \ref{algebra-proposition-dimension}.
Choose $n \gg 0$. Observe that
$$
\mathfrak m^{pn + pr} \subset F(\mathfrak m^n)A \subset \mathfrak m^{pn}
$$
as can be seen by looking at monomials in $x_1, \ldots, x_r$. We have
$$
A/F(\mathfrak m^n)A = A/\mathfrak m^n \otimes_{A, F} A
$$
By flatness of $F$ this has length $\chi(n) \text{length}_A(A/F(\mathfrak m)A)$
(Algebra, Lemma \ref{algebra-lemma-pullback-module})
which is equal to $p^r\chi(n)$ by the above. We conclude
$$
\chi(pn + pr) \geq p^r\chi(n) \geq \chi(pn)
$$
Looking at the leading terms this implies $r = \dim(A)$, i.e., $A$ is regular.
\end{proof}




\section{Structure of certain modules}
\label{section-structure}

\noindent
Some results on the structure of certain types of
modules over regular local rings. These types of
results and much more can be found in
\cite{Huneke-Sharp}, \cite{Lyubeznik}, \cite{Lyubeznik2}.

\begin{lemma}
\label{lemma-structure-torsion-D-module-regular}
\begin{reference}
Special case of \cite[Theorem 2.4]{Lyubeznik}
\end{reference}
Let $k$ be a field of characteristic $0$. Let $d \geq 1$.
Let $A = k[[x_1, \ldots, x_d]]$ with maximal ideal $\mathfrak m$.
Let $M$ be an $\mathfrak m$-power torsion $A$-module endowed with
additive operators $D_1, \ldots, D_d$ satisfying the leibniz rule
$$
D_i(fz) = \partial_i(f) z + f D_i(z)
$$
for $f \in A$ and $z \in M$. Here $\partial_i$ is
differentiation with respect to $x_i$.
Then $M$ is isomorphic to a direct sum
of copies of the injective hull $E$ of $k$.
\end{lemma}

\begin{proof}
Choose a set $J$ and an $A$-module homorphism
$\varphi : M \to \bigoplus_{j \in J} E$ which maps
$M[\mathfrak m]$ isomorphically onto
$(\bigoplus_{j \in J} E)[\mathfrak m] = \bigoplus_{j \in J} k$.
We claim that $\varphi$ is an isomorphism, i.e., bijective.

\medskip\noindent
Injective. Let $z \in M$ be nonzero. Since $M$ is $\mathfrak m$-power torsion
we can choose an element $f \in A$ such that $fz \in M[\mathfrak m]$ and
$fz \not = 0$. Then $\varphi(fz) = f\varphi(z)$ is nonzero, hence
$\varphi(z)$ is nonzero.

\medskip\noindent
Surjective. Let $z \in M$. Then $x_1^n z = 0$ for some $n \geq 0$.
We will prove that $z \in x_1M$ by induction on $n$.
If $n = 0$, then $z = 0$ and the result is true.
If $n > 0$, then applying $D_1$ we find $0 = n x_1^{n - 1} z + x_1^nD_1(z)$.
Hence $x_1^{n - 1}(nz + x_1D_1(z)) = 0$. By induction we get
$nz + x_1D_1(z) \in x_1M$. Since $n$ is invertible, we conclude
$z \in x_1M$. Thus we see that $M$ is $x_1$-divisible.
If $\varphi$ is not surjective, then we can choose
$e \in \bigoplus_{j \in J} E$ not in $M$.
Arguing as above we may assume $\mathfrak m e \subset M$,
in particular $x_1 e \in M$. There exists an element
$z_1 \in M$ with $x_1 z_1 = x_1 e$. Hence
$x_1(z_1 - e) = 0$. Replacing $e$ by $e - z_1$
we may assume $e$ is annihilated by $x_1$.
Thus it suffices to prove that
$$
\varphi[x_1] :
M[x_1]
\longrightarrow
\left(\bigoplus\nolimits_{j \in J} E\right)[x_1] =
\bigoplus\nolimits_{j \in J} E[x_1]
$$
is surjective. If $d = 1$, this is true by construction of $\varphi$.
If $d > 1$, then we observe that $E[x_1]$ is the injective hull
of the residue field of $k[[x_2, \ldots, x_d]]$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-quotient}.
Observe that $M[x_1]$ as a module over $k[[x_2, \ldots, x_d]]$
is $\mathfrak m/(x_1)$-power torsion and comes
equipped with operators $D_2, \ldots, D_d$ satisfying
the displayed Leibniz rule.
Thus by induction on $d$ we conclude that $\varphi[x_1]$
is surjective as desired.
\end{proof}

\begin{lemma}
\label{lemma-structure-torsion-Frobenius-regular}
\begin{reference}
Follows from \cite[Corollary 3.6]{Huneke-Sharp} with a
little bit of work. Also follows directly from
\cite[Theorem 1.4]{Lyubeznik2}.
\end{reference}
Let $p$ be a prime number. Let $(A, \mathfrak m, k)$
be a regular local ring with $p = 0$. Denote $F : A \to A$, $a \mapsto a^p$
be the Frobenius endomorphism. Let $M$ be a $\mathfrak m$-power torsion module
such that $M \otimes_{A, F} A \cong M$. Then $M$ is isomorphic to a direct sum
of copies of the injective hull $E$ of $k$.
\end{lemma}

\begin{proof}
Choose a set $J$ and an $A$-module homorphism
$\varphi : M \to \bigoplus_{j \in J} E$ which maps
$M[\mathfrak m]$ isomorphically onto
$(\bigoplus_{j \in J} E)[\mathfrak m] = \bigoplus_{j \in J} k$.
We claim that $\varphi$ is an isomorphism, i.e., bijective.

\medskip\noindent
Injective. Let $z \in M$ be nonzero. Since $M$ is $\mathfrak m$-power torsion
we can choose an element $f \in A$ such that $fz \in M[\mathfrak m]$ and
$fz \not = 0$. Then $\varphi(fz) = f\varphi(z)$ is nonzero, hence
$\varphi(z)$ is nonzero.

\medskip\noindent
Surjective. Recall that $F$ is flat, see
Lemma \ref{lemma-frobenius-flat-regular}.
Let $x_1, \ldots, x_d$ be a minimal system of generators of
$\mathfrak m$. Denote
$$
M_n = M[x_1^{p^n}, \ldots, x_d^{p^n}]
$$
the submodule of $M$ consisting of elements killed by
$x_1^{p^n}, \ldots, x_d^{p^n}$. So $M_0 = M[\mathfrak m]$
is a vector space over $k$. Also $M = \bigcup M_n$ by our
assumption that $M$ is $\mathfrak m$-power torsion. Since $F^n$ is flat and
$F^n(x_i) = x_i^{p^n}$ we have
$$
M_n \cong (M \otimes_{A, F^n} A)[x_1^{p^n}, \ldots, x_d^{p^n}] =
M[x_1, \ldots, x_d] \otimes_{A, F} A =
M_0 \otimes_k A/(x_1^{p^n}, \ldots, x_d^{p^n})
$$
Thus $M_n$ is free over $A/(x_1^{p^n}, \ldots, x_d^{p^n})$.
A computation shows that every element of $A/(x_1^{p^n}, \ldots, x_d^{p^n})$
annihilated by $x_1^{p^n - 1}$ is divisible by $x_1$; for example
you can use that $A/(x_1^{p^n}, \ldots, x_d^{p^n}) \cong
k[x_1, \ldots, x_d]/(x_1^{p^n}, \ldots, x_d^{p^n})$ by Algebra, Lemma
\ref{algebra-lemma-regular-complete-containing-coefficient-field}.
Thus the same is true for every element of $M_n$.
Since every element of $M$ is in $M_n$ for all $n \gg 0$
and since every element of $M$ is killed by some power of
$x_1$, we conclude that $M$ is $x_1$-divisible.

\medskip\noindent
Let $x = x_1$. Above we have seen that $M$ is $x$-divisible.
If $\varphi$ is not surjective, then we can choose
$e \in \bigoplus_{j \in J} E$ not in $M$.
Arguing as above we may assume $\mathfrak m e \subset M$,
in particular $x e \in M$. There exists an element
$z_1 \in M$ with $x z_1 = x e$. Hence
$x(z_1 - e) = 0$. Replacing $e$ by $e - z_1$
we may assume $e$ is annihilated by $x$.
Thus it suffices to prove that
$$
\varphi[x] :
M[x]
\longrightarrow
\left(\bigoplus\nolimits_{j \in J} E\right)[x] =
\bigoplus\nolimits_{j \in J} E[x]
$$
is surjective. If $d = 1$, this is true by construction of $\varphi$.
If $d > 1$, then we observe that $E[x]$ is the injective hull
of the residue field of the regular ring $A/xA$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-quotient}.
Observe that $M[x]$ as a module over $A/xA$
is $\mathfrak m/(x)$-power torsion and we have
\begin{align*}
M[x] \otimes_{A/xA, F} A/xA
& = M[x] \otimes_{A, F} A \otimes_A A/xA \\
& = (M \otimes_{A, F} A)[x^p] \otimes_A A/xA \\
& \cong M[x^p] \otimes_A A/xA
\end{align*}
Argue using flatness of $F$ as before.
We claim that $M[x^p] \otimes_A A/xA \to M[x]$,
$z \otimes 1 \mapsto x^{p - 1}z$ is an isomorphism.
This can be seen by proving it for
each of the modules $M_n$, $n > 0$ defined above
where it follows by the same result for
$A/(x_1^{p^n}, \ldots, x_d^{p^n})$ and $x = x_1$.
Thus by induction on $\dim(A)$ we conclude that $\varphi[x]$
is surjective as desired.
\end{proof}





\section{Additional structure on local cohomology}
\label{section-additional}

\noindent
Here is a sample result.

\begin{lemma}
\label{lemma-derivation}
Let $A$ be a ring. Let $I \subset A$ be a finitely generated ideal.
Set $Z = V(I)$.
For each derivation $\theta : A \to A$ there exists a canonical
additive operator $D$ on the local cohomology modules
$H^i_Z(A)$ satisfying the Leibniz rule with respect to $\theta$.
\end{lemma}

\begin{proof}
Let $f_1, \ldots, f_r$ be elements generating $I$.
Recall that $R\Gamma_Z(A)$ is computed by the complex
$$
A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}}
\to \ldots \to A_{f_1\ldots f_r}
$$
See Dualizing Complexes, Lemma \ref{dualizing-lemma-local-cohomology-adjoint}.
Since $\theta$ extends uniquely to an additive operator on
any localization of $A$ satisfying the Leibniz rule with
respect to $\theta$, the lemma is clear.
\end{proof}

\begin{lemma}
\label{lemma-frobenius}
Let $p$ be a prime number. Let $A$ be a ring with $p = 0$.
Denote $F : A \to A$, $a \mapsto a^p$ the Frobenius endomorphism.
Let $I \subset A$ be a finitely generated ideal. Set $Z = V(I)$.
There exists an isomorphism
$R\Gamma_Z(A) \otimes_{A, F}^\mathbf{L} A \cong R\Gamma_Z(A)$.
\end{lemma}

\begin{proof}
Follows from Dualizing Complexes, Lemma
\ref{dualizing-lemma-torsion-change-rings}
and the fact that $Z = V(f_1^p, \ldots, f_r^p)$
if $I = (f_1, \ldots, f_r)$.
\end{proof}

\begin{lemma}
\label{lemma-etale-derivation}
Let $A$ be a ring. Let $V \to \Spec(A)$ be quasi-compact, quasi-separated,
and \'etale. For each derivation $\theta : A \to A$ there exists a canonical
additive operator $D$ on $H^i(V, \mathcal{O}_V)$
satisfying the Leibniz rule with respect to $\theta$.
\end{lemma}

\begin{proof}
If $V$ is separated, then we can argue using an affine open covering
$V = \bigcup_{j = 1, \ldots m} V_j$. Namely, because $V$ is separated
we may write $V_{j_0 \ldots j_p} = \Spec(B_{j_0 \ldots j_p})$.
See Schemes, Lemma \ref{schemes-lemma-characterize-separated}. Then we
find that the $A$-module $H^i(V, \mathcal{O}_V)$
is the $i$th cohomology group of the {\v C}ech complex
$$
\prod B_{j_0} \to
\prod B_{j_0j_1} \to
\prod B_{j_0j_1j_2} \to \ldots
$$
See Cohomology of Schemes, Lemma
\ref{coherent-lemma-cech-cohomology-quasi-coherent}.
Each $B = B_{j_0 \ldots j_p}$ is an \'etale $A$-algebra.
Hence $\Omega_B = \Omega_A \otimes_A B$ and we conclude
$\theta$ extends uniquely to a derivation $\theta_B : B \to B$.
These maps define an endomorphism of the {\v C}ech complex
and define the desired operators on the cohomology groups.

\medskip\noindent
In the general case we use a hypercovering of $V$ by
affine opens, exactly as in the first part of the proof of
Cohomology of Schemes, Lemma \ref{coherent-lemma-hypercoverings}.
We omit the details.
\end{proof}

\begin{remark}
\label{remark-higher-order-operators}
We can upgrade Lemmas \ref{lemma-derivation} and \ref{lemma-etale-derivation}
to include higher order differential operators.
If we ever need this we will state and prove a
precise lemma here.
\end{remark}

\begin{lemma}
\label{lemma-etale-frobenius}
Let $p$ be a prime number. Let $A$ be a ring with $p = 0$.
Denote $F : A \to A$, $a \mapsto a^p$ the Frobenius endomorphism.
If $V \to \Spec(A)$ is quasi-compact, quasi-separated,
and \'etale, then there exists an isomorphism
$R\Gamma(V, \mathcal{O}_V) \otimes_{A, F}^\mathbf{L} A \cong
R\Gamma(V, \mathcal{O}_V)$.
\end{lemma}

\begin{proof}
Observe that the relative Frobenius morphism
$$
V \longrightarrow V \times_{\Spec(A), \Spec(F)} \Spec(A)
$$
of $V$ over $A$ is an isomorphism, see
\'Etale Morphisms, Lemma \ref{etale-lemma-relative-frobenius-etale}.
Thus the lemma follows from cohomology and base change, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-compare-base-change}.
Observe that since $V$ is \'etale over $A$, it is flat over $A$.
\end{proof}





\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
