\input{preamble}

% OK, start here.
%
\begin{document}

\title{Derived Categories of Stacks}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we write about derived categories associated to
algebraic stacks. This means in particular derived categories
of quasi-coherent sheaves, i.e., we prove analogues of the results
on schemes (see
Derived Categories of Schemes, Section \ref{perfect-section-introduction})
and algebraic spaces (see
Derived Categories of Spaces, Section
\ref{spaces-perfect-section-introduction}). The results in this chapter
are different from those in \cite{LM-B} mainly because we consistently
use the ``big sites''. Before reading this chapter please take a quick
look at the chapters ``Sheaves on Algebraic Stacks'' and
``Cohomology of Algebraic Stacks'' where the terminology we use here is
introduced.



\section{Conventions, notation, and abuse of language}
\label{section-conventions}

\noindent
We continue to use the conventions and the abuse of language
introduced in
Properties of Stacks, Section \ref{stacks-properties-section-conventions}.
We use notation as explained in
Cohomology of Stacks, Section \ref{stacks-cohomology-section-notation}.












\section{The lisse-\'etale and the flat-fppf sites}
\label{section-lisse-etale}

\noindent
The section is the analogue of
Cohomology of Stacks, Section \ref{stacks-cohomology-section-lisse-etale}
for derived categories.

\begin{lemma}
\label{lemma-shriek-derived}
Let $\mathcal{X}$ be an algebraic stack.
Notation as in
Cohomology of Stacks,
Lemmas \ref{stacks-cohomology-lemma-lisse-etale} and
\ref{stacks-cohomology-lemma-lisse-etale-modules}.
\begin{enumerate}
\item The functor
$g_! : \textit{Ab}(\mathcal{X}_{lisse,\etale}) \to
\textit{Ab}(\mathcal{X}_\etale)$
has a left derived functor
$$
Lg_! :
D(\mathcal{X}_{lisse,\etale})
\longrightarrow
D(\mathcal{X}_\etale)
$$
which is left adjoint to $g^{-1}$ and such that $g^{-1}Lg_! = \text{id}$.
\item The functor $g_! : 
\textit{Mod}(\mathcal{X}_{lisse,\etale},
\mathcal{O}_{\mathcal{X}_{lisse,\etale}}) \to
\textit{Mod}(\mathcal{X}_\etale, \mathcal{O}_{\mathcal{X}})$
has a left derived functor
$$
Lg_! :
D(\mathcal{O}_{\mathcal{X}_{lisse,\etale}})
\longrightarrow
D(\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
$$
which is left adjoint to $g^*$ and such that $g^*Lg_! = \text{id}$.
\item The functor $g_! : \textit{Ab}(\mathcal{X}_{flat,fppf}) \to
\textit{Ab}(\mathcal{X}_{fppf})$
has a left derived functor
$$
Lg_! :
D(\mathcal{X}_{flat, fppf})
\longrightarrow
D(\mathcal{X}_{fppf})
$$
which is left adjoint to $g^{-1}$ and such that $g^{-1}Lg_! = \text{id}$.
\item The functor $g_! :
\textit{Mod}(\mathcal{X}_{flat,fppf},
\mathcal{O}_{\mathcal{X}_{flat,fppf}}) \to
\textit{Mod}(\mathcal{X}_{fppf}, \mathcal{O}_{\mathcal{X}})$
has a left derived functor
$$
Lg_! :
D(\mathcal{O}_{\mathcal{X}_{flat, fppf}})
\longrightarrow
D(\mathcal{O}_\mathcal{X})
$$
which is left adjoint to $g^*$ and such that $g^*Lg_! = \text{id}$.
\end{enumerate}
Warning: It is not clear (a priori) that $Lg_!$ on modules agrees
with $Lg_!$ on abelian sheaves, see
Cohomology on Sites, Remark
\ref{sites-cohomology-remark-when-derived-shriek-equal}.
\end{lemma}

\begin{proof}
The existence of the functor $Lg_!$ and adjointness to $g^*$ is
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-existence-derived-lower-shriek}.
(For the case of abelian sheaves use the constant sheaf $\mathbf{Z}$
as the structure sheaves.)
Moreover, it is computed on a complex $\mathcal{H}^\bullet$
by taking a suitable left resolution
$\mathcal{K}^\bullet \to \mathcal{H}^\bullet$
and applying the functor $g_!$ to $\mathcal{K}^\bullet$.
Since $g^{-1}g_!\mathcal{K}^\bullet = \mathcal{K}^\bullet$ by
Cohomology of Stacks,
Lemmas \ref{stacks-cohomology-lemma-lisse-etale-modules} and
\ref{stacks-cohomology-lemma-lisse-etale}
we see that the final assertion holds in each case.
\end{proof}

\begin{lemma}
\label{lemma-lisse-etale-functorial-derived}
With assumptions and notation as in
Cohomology of Stacks,
Lemma \ref{stacks-cohomology-lemma-lisse-etale-functorial}.
We have
$$
g^{-1} \circ Rf_* = Rf'_* \circ (g')^{-1}
\quad\text{and}\quad
L(g')_! \circ (f')^{-1} = f^{-1} \circ Lg_!
$$
on unbounded derived categories
(both for the case of modules and for the case of abelian sheaves).
\end{lemma}

\begin{proof}
Let $\mathcal{F}$ be an abelian sheaf on $\mathcal{X}_\etale$
(resp.\ $\mathcal{X}_{fppf}$). We first show that the canonical
(base change) map
$$
g^{-1} Rf_*\mathcal{F} \longrightarrow Rf'_* (g')^{-1}\mathcal{F}
$$
is an isomorphism. To do this let $y$ be an object of
$\mathcal{Y}_{lisse,\etale}$ (resp.\ $\mathcal{Y}_{flat,fppf}$).
Say $y$ lies over the scheme $V$ such that $y : V \to \mathcal{Y}$ is
smooth (resp.\ flat). Since $g^{-1}$ is the restriction we find that
$$
\left(g^{-1}R^pf_*\mathcal{F}\right)(y) =
H^p_\tau(V \times_{y, \mathcal{Y}} \mathcal{X},\ \text{pr}^{-1}\mathcal{F})
$$
where $\tau = \etale$ (resp.\ $\tau = fppf$), see 
Sheaves on Stacks, Lemma \ref{stacks-sheaves-lemma-pushforward-restriction}.
By
Cohomology of Stacks, Equation
(\ref{stacks-cohomology-equation-pushforward-lisse-etale}) 
for any sheaf $\mathcal{H}$ on
$\mathcal{X}_{lisse,\etale}$ (resp.\ $\mathcal{X}_{flat,fppf}$)
$$
f'_*\mathcal{H}(y) =
\Gamma((V \times_{y, \mathcal{Y}} \mathcal{X})',
\ (\text{pr}')^{-1}\mathcal{H})
$$
An object of $(V \times_{y, \mathcal{Y}} \mathcal{X})'$ can be seen
as a pair $(x, \varphi)$ where $x$ is an object of
$\mathcal{X}_{lisse,\etale}$ (resp.\ $\mathcal{X}_{flat,fppf}$)
and $\varphi : f(x) \to y$ is a morphism in $\mathcal{Y}$.
We can also think of $\varphi$ as a section of $(f')^{-1}h_y$ over $x$.
Thus $(V \times_\mathcal{Y} \mathcal{X})'$ is the localization
of the site $\mathcal{X}_{lisse,\etale}$
(resp. $\mathcal{X}_{flat,fppf}$) at the sheaf of sets $(f')^{-1}h_y$, see
Sites, Lemma \ref{sites-lemma-localize-topos-site}. The morphism
$$
\text{pr}' : (V \times_{y, \mathcal{Y}} \mathcal{X})'
\to \mathcal{X}_{lisse,\etale}
\ (\text{resp. }
\text{pr}' : (V \times_{y, \mathcal{Y}} \mathcal{X})'
\to \mathcal{X}_{flat,fppf})
$$
is the localization morphism.
In particular, the pullback $(\text{pr}')^{-1}$ preserves
injective abelian sheaves, see
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-cohomology-on-sheaf-sets}.
At this point exactly the same argument as in
Sheaves on Stacks, Lemma \ref{stacks-sheaves-lemma-pushforward-restriction}
shows that
\begin{equation}
\label{equation-higher-direct-image-lisse-etale}
R^pf'_*\mathcal{H}(y) =
H^p_\tau((V \times_{y, \mathcal{Y}} \mathcal{X})',
\ (\text{pr}')^{-1}\mathcal{H})
\end{equation}
where $\tau = \etale$ (resp.\ $\tau = fppf$). Since $(g')^{-1}$
is given by restriction we conclude that
$$
\left(R^pf'_*(g')^*\mathcal{F}\right)(y) =
H^p_\tau((V \times_{y, \mathcal{Y}} \mathcal{X})',
\ \text{pr}^{-1}\mathcal{F}|_{(V \times_{y, \mathcal{Y}} \mathcal{X})'})
$$
Finally, we can apply
Sheaves on Stacks, Lemma \ref{stacks-sheaves-lemma-cohomology-on-subcategory}
to see that
$$
H^p_\tau((V \times_{y, \mathcal{Y}} \mathcal{X})',
\ \text{pr}^{-1}\mathcal{F}|_{(V \times_{y, \mathcal{Y}} \mathcal{X})'})
=
H^p_\tau(V \times_{y, \mathcal{Y}} \mathcal{X},\ \text{pr}^{-1}\mathcal{F})
$$
are equal as desired; although we omit the verification of the assumptions
of the lemma we note that the fact that $V \to \mathcal{Y}$ is smooth
(resp.\ flat) is used to verify the second condition.

\medskip\noindent
The rest of the proof is formal. Since cohomology of abelian groups and
sheaves of modules agree we also conclude that 
$g^{-1} Rf_*\mathcal{F} = Rf'_* (g')^{-1}\mathcal{F}$ when $\mathcal{F}$
is a sheaf of modules on $\mathcal{X}_\etale$
(resp.\ $\mathcal{X}_{fppf}$).

\medskip\noindent
Next we show that for $\mathcal{G}$ (either sheaf of modules
or abelian groups) on
$\mathcal{Y}_{lisse,\etale}$ (resp.\ $\mathcal{Y}_{flat,fppf}$)
the canonical map
$$
L(g')_!(f')^{-1}\mathcal{G} \to f^{-1}Lg_!\mathcal{G}
$$
is an isomorphism. To see this it is enough to prove for any
injective sheaf $\mathcal{I}$ on $\mathcal{X}_\etale$
(resp.\ $\mathcal{X}_{fppf}$) that the induced map
$$
\Hom(L(g')_!(f')^{-1}\mathcal{G}, \mathcal{I}[n])
\leftarrow
\Hom(f^{-1}Lg_!\mathcal{G}, \mathcal{I}[n])
$$
is an isomorphism for all $n \in \mathbf{Z}$. (Hom's taken
in suitable derived categories.) By the adjointness of
$f^{-1}$ and $Rf_*$, the adjointness of $Lg_!$ and $g^{-1}$, and
their ``primed'' versions this follows from the isomorphism
$g^{-1} Rf_*\mathcal{I} \to Rf'_* (g')^{-1}\mathcal{I}$ proved above.

\medskip\noindent
In the case of a bounded complex $\mathcal{G}^\bullet$
(of modules or abelian groups) on
$\mathcal{Y}_{lisse,\etale}$ (resp.\ $\mathcal{Y}_{fppf}$)
the canonical map
\begin{equation}
\label{equation-to-show}
L(g')_!(f')^{-1}\mathcal{G}^\bullet \to f^{-1}Lg_!\mathcal{G}^\bullet
\end{equation}
is an isomorphism as follows from the case of a sheaf by the usual arguments
involving truncations and the fact that the functors
$L(g')_!(f')^{-1}$ and $f^{-1}Lg_!$ are exact functors of
triangulated categories.

\medskip\noindent
Suppose that $\mathcal{G}^\bullet$ is a bounded above complex
(of modules or abelian groups) on
$\mathcal{Y}_{lisse,\etale}$ (resp.\ $\mathcal{Y}_{fppf}$).
The canonical map (\ref{equation-to-show})
is an isomorphism because we can use the stupid truncations
$\sigma_{\geq -n}$ (see
Homology, Section \ref{homology-section-truncations}) to write
$\mathcal{G}^\bullet$ as a colimit
$\mathcal{G}^\bullet = \colim \mathcal{G}_n^\bullet$
of bounded complexes. This gives a distinguished triangle
$$
\bigoplus\nolimits_{n \geq 1} \mathcal{G}_n^\bullet \to
\bigoplus\nolimits_{n \geq 1} \mathcal{G}_n^\bullet \to
\mathcal{G}^\bullet \to \ldots
$$
and each of the functors $L(g')_!$, $(f')^{-1}$, $f^{-1}$, $Lg_!$
commutes with direct sums (of complexes).

\medskip\noindent
If $\mathcal{G}^\bullet$ is an arbitrary complex
(of modules or abelian groups) on
$\mathcal{Y}_{lisse,\etale}$ (resp.\ $\mathcal{Y}_{fppf}$)
then we use the canonical truncations $\tau_{\leq n}$ (see
Homology, Section \ref{homology-section-truncations})
to write $\mathcal{G}^\bullet$ as a colimit of bounded above complexes
and we repeat the argument of the paragraph above.

\medskip\noindent
Finally, by the adjointness of
$f^{-1}$ and $Rf_*$, the adjointness of $Lg_!$ and $g^{-1}$, and
their ``primed'' versions we conclude that the first
identity of the lemma follows from the second in full generality.
\end{proof}

\begin{lemma}
\label{lemma-higher-shriek-quasi-coherent}
Let $\mathcal{X}$ be an algebraic stack. Notation as in
Cohomology of Stacks,
Lemma \ref{stacks-cohomology-lemma-lisse-etale}.
\begin{enumerate}
\item Let $\mathcal{H}$ be a quasi-coherent
$\mathcal{O}_{\mathcal{X}_{lisse,\etale}}$-module 
on the lisse-\'etale site of $\mathcal{X}$. For all $p \in \mathbf{Z}$
the sheaf $H^p(Lg_!\mathcal{H})$ is a locally quasi-coherent module with
the flat base change property on $\mathcal{X}$.
\item Let $\mathcal{H}$ be a quasi-coherent
$\mathcal{O}_{\mathcal{X}_{flat,fppf}}$-module 
on the flat-fppf site of $\mathcal{X}$. For all $p \in \mathbf{Z}$
the sheaf $H^p(Lg_!\mathcal{H})$ is a locally quasi-coherent module with the
flat base change property on $\mathcal{X}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Pick a scheme $U$ and a surjective smooth morphism $x : U \to \mathcal{X}$. By
Modules on Sites, Definition \ref{sites-modules-definition-site-local}
there exists an \'etale (resp.\ fppf) covering
$\{U_i \to U\}_{i \in I}$ such that each pullback $f_i^{-1}\mathcal{H}$
has a global presentation (see
Modules on Sites, Definition \ref{sites-modules-definition-global}).
Here $f_i : U_i \to \mathcal{X}$ is the composition
$U_i \to U \to \mathcal{X}$ which is a morphism of algebraic stacks.
(Recall that the pullback ``is'' the restriction to $\mathcal{X}/f_i$, see
Sheaves on Stacks, Definition \ref{stacks-sheaves-definition-pullback}
and the discussion following.)
After refining the covering we may assume each $U_i$ is an affine scheme.
Since each $f_i$ is smooth (resp.\ flat) by
Lemma \ref{lemma-lisse-etale-functorial-derived}
we see that $f_i^{-1}Lg_!\mathcal{H} = Lg_{i, !}(f'_i)^{-1}\mathcal{H}$.
Using
Cohomology of Stacks,
Lemma \ref{stacks-cohomology-lemma-check-lqc-fbc-on-covering}
we reduce the statement of the lemma to the case where $\mathcal{H}$
has a global presentation and where $\mathcal{X} = (\Sch/X)_{fppf}$
for some affine scheme $X = \Spec(A)$.

\medskip\noindent
Say our presentation looks like
$$
\bigoplus\nolimits_{j \in J} \mathcal{O} \longrightarrow
\bigoplus\nolimits_{i \in I} \mathcal{O} \longrightarrow
\mathcal{H} \longrightarrow 0
$$
where $\mathcal{O} = \mathcal{O}_{\mathcal{X}_{lisse,\etale}}$
(resp.\ $\mathcal{O} = \mathcal{O}_{\mathcal{X}_{flat,fppf}}$).
Note that the site $\mathcal{X}_{lisse,\etale}$
(resp.\ $\mathcal{X}_{flat,fppf}$) has a final object, namely
$X/X$ which is quasi-compact (see
Cohomology on Sites, Section \ref{sites-cohomology-section-limits}).
Hence we have
$$
\Gamma(\bigoplus\nolimits_{i \in I} \mathcal{O}) =
\bigoplus\nolimits_{i \in I} A
$$
by Sites, Lemma \ref{sites-lemma-directed-colimits-sections}. Hence the map
in the presentation corresponds to a similar presentation
$$
\bigoplus\nolimits_{j \in J} A \longrightarrow
\bigoplus\nolimits_{i \in I} A \longrightarrow
M \longrightarrow 0
$$
of an $A$-module $M$. Moreover, $\mathcal{H}$ is equal to the restriction
to the lisse-\'etale (resp.\ flat-fppf) site of the quasi-coherent sheaf
$M^a$ associated to $M$. Choose a resolution
$$
\ldots \to F_2 \to F_1 \to F_0 \to M \to 0
$$
by free $A$-modules. The complex
$$
\ldots \mathcal{O} \otimes_A F_2 \to \mathcal{O} \otimes_A F_1 \to
\mathcal{O} \otimes_A F_0 \to \mathcal{H} \to 0
$$
is a resolution of $\mathcal{H}$ by free $\mathcal{O}$-modules because
for each object $U/X$ of $\mathcal{X}_{lisse,\etale}$
(resp.\ $\mathcal{X}_{flat,fppf}$) the structure morphism $U \to X$
is flat. Hence by construction the value of $Lg_!\mathcal{H}$ is
$$
\ldots \to
\mathcal{O}_\mathcal{X} \otimes_A F_2 \to
\mathcal{O}_\mathcal{X} \otimes_A F_1 \to
\mathcal{O}_\mathcal{X} \otimes_A F_0 \to 0 \to \ldots
$$
Since this is a complex of quasi-coherent modules on
$\mathcal{X}_\etale$ (resp.\ $\mathcal{X}_{fppf}$)
it follows from
Cohomology of Stacks,
Proposition \ref{stacks-cohomology-proposition-lcq-flat-base-change}
that $H^p(Lg_!\mathcal{H})$ is quasi-coherent.
\end{proof}






\section{Derived categories of quasi-coherent modules}
\label{section-derived}

\noindent
Let $\mathcal{X}$ be an algebraic stack. As the inclusion functor
$\QCoh(\mathcal{O}_\mathcal{X}) \to
\textit{Mod}(\mathcal{O}_\mathcal{X})$ isn't exact, we cannot define
$D_\QCoh(\mathcal{O}_\mathcal{X})$ as the full subcategory
of $D(\mathcal{O}_\mathcal{X})$ consisting of complexes with quasi-coherent
cohomology sheaves. In stead we define the category as follows.

\begin{definition}
\label{definition-derived}
Let $\mathcal{X}$ be an algebraic stack. Let
$\mathcal{M}_\mathcal{X} \subset \textit{Mod}(\mathcal{O}_\mathcal{X})$
denote the category of locally quasi-coherent
$\mathcal{O}_\mathcal{X}$-modules with the flat base change property.
Let $\mathcal{P}_\mathcal{X} \subset \mathcal{M}_\mathcal{X}$
be the full subcategory consisting of parasitic objects.
We define the {\it derived category of $\mathcal{O}_\mathcal{X}$-modules with
quasi-coherent cohomology sheaves} as the Verdier quotient\footnote{This
definition is different from the one in the literature, see
\cite[6.3]{olsson_sheaves}, but it agrees with that definition
by Lemma \ref{lemma-derived-quasi-coherent}.}
$$
D_\QCoh(\mathcal{O}_\mathcal{X}) =
D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})/
D_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})
$$
\end{definition}

\noindent
This definition makes sense: By
Cohomology of Stacks,
Proposition \ref{stacks-cohomology-proposition-lcq-flat-base-change}
we see that $\mathcal{M}_\mathcal{X}$ is a weak Serre subcategory
of $\textit{Mod}(\mathcal{O}_\mathcal{X})$
hence $D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$
is a strictly full, saturated triangulated subcategory of
$D(\mathcal{O}_\mathcal{X})$, see
Derived Categories, Lemma \ref{derived-lemma-cohomology-in-serre-subcategory}.
Since parasitic modules form a Serre subcategory of
$\textit{Mod}(\mathcal{O}_\mathcal{X})$ (by
Cohomology of Stacks,
Lemma \ref{stacks-cohomology-lemma-parasitic}) we see that
$\mathcal{P}_\mathcal{X} = \text{Parasitic} \cap \mathcal{M}_\mathcal{X}$
is a weak Serre subcategory of $\textit{Mod}(\mathcal{O}_\mathcal{X})$ and
hence $D_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$
is a strictly full, saturated triangulated subcategory of
$D(\mathcal{O}_\mathcal{X})$. Since clearly
$$
D_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})
\subset
D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})
$$
we conclude that the first is a strictly full, saturated triangulated
subcategory of the second. Hence the Verdier quotient exists. A morphism
$a : E \to E'$ of
$D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$ becomes an
isomorphism in $D_\QCoh(\mathcal{O}_\mathcal{X})$ if and
only if the cone $C(a)$ has parasitic cohomology sheaves, see
Derived Categories, Section \ref{derived-section-quotients} and especially
Lemma \ref{derived-lemma-operations}.

\medskip\noindent
Consider the functors
$$
D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})
\xrightarrow{H^i}
\mathcal{M}_\mathcal{X}
\xrightarrow{Q}
\QCoh(\mathcal{O}_\mathcal{X})
$$
Note that $Q$ annihilates the subcategory $\mathcal{P}_\mathcal{X}$, see
Cohomology of Stacks,
Lemma \ref{stacks-cohomology-lemma-adjoint-kernel-parasitic}.
By
Derived Categories, Lemma \ref{derived-lemma-universal-property-quotient}
we obtain a cohomological functor
\begin{equation}
\label{equation-Hi-quasi-coherent}
H^i :
D_\QCoh(\mathcal{O}_\mathcal{X})
\longrightarrow
\QCoh(\mathcal{O}_\mathcal{X})
\end{equation}
Moreover, note that $E \in D_\QCoh(\mathcal{O}_\mathcal{X})$
is zero if and only if $H^i(E) = 0$ for all $i \in \mathbf{Z}$.

\medskip\noindent
Note that the categories $\mathcal{P}_\mathcal{X}$ and
$\mathcal{M}_\mathcal{X}$ are also weak Serre subcategories of the
abelian category
$\textit{Mod}(\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})$
of modules in the \'etale topology, see
Cohomology of Stacks,
Proposition \ref{stacks-cohomology-proposition-lcq-flat-base-change} and
Lemma \ref{stacks-cohomology-lemma-parasitic}.
Hence the statement of the following lemma makes sense.

\begin{lemma}
\label{lemma-compare-etale-fppf-QCoh}
Let $\mathcal{X}$ be an algebraic stack. The comparison morphism
$\epsilon : \mathcal{X}_{fppf} \to \mathcal{X}_\etale$
induces a commutative diagram
$$
\xymatrix{
D_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X}) \ar[r] &
D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X}) \ar[r] &
D(\mathcal{O}_\mathcal{X}) \\
D_{\mathcal{P}_\mathcal{X}}(
\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
\ar[r] \ar[u]^{\epsilon^*} &
D_{\mathcal{M}_\mathcal{X}}(
\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
\ar[r] \ar[u]^{\epsilon^*} &
D(\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
\ar[u]^{\epsilon^*}
}
$$
Moreover, the left two vertical arrows are equivalences of triangulated
categories, hence we also obtain an equivalence
$$
D_{\mathcal{M}_\mathcal{X}}(
\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
/
D_{\mathcal{P}_\mathcal{X}}(
\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
\longrightarrow
D_\QCoh(\mathcal{O}_\mathcal{X})
$$
\end{lemma}

\begin{proof}
Since $\epsilon^*$ is exact it is clear that we obtain a diagram as
in the statement of the lemma. We will show the middle vertical
arrow is an equivalence by applying
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-compare-topologies-derived-adequate-modules}
to the following situation:
$\mathcal{C} = \mathcal{X}$,
$\tau = fppf$,
$\tau' = \etale$,
$\mathcal{O} = \mathcal{O}_\mathcal{X}$,
$\mathcal{A} = \mathcal{M}_\mathcal{X}$, and
$\mathcal{B}$ is the set of objects of $\mathcal{X}$ lying over
affine schemes. To see the lemma applies we have to check conditions
(1), (2), (3), (4). Conditions (1) and (2) are clear from the discussion
above (explicitly this follows from
Cohomology of Stacks,
Proposition \ref{stacks-cohomology-proposition-lcq-flat-base-change}).
Condition (3) holds because every scheme has a Zariski
open covering by affines. Condition (4) follows from
Descent, Lemma \ref{descent-lemma-quasi-coherent-and-flat-base-change}.

\medskip\noindent
We omit the verification that the equivalence of
categories $\epsilon^* : 
D_{\mathcal{M}_\mathcal{X}}(
\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
\to
D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$
induces an equivalence of the subcategories of complexes
with parasitic cohomology sheaves.
\end{proof}

\noindent
It turns out that $D_\QCoh(\mathcal{O}_\mathcal{X})$
is the same as the derived category of complexes of modules
with quasi-coherent cohomology sheaves on the lisse-\'etale or
flat-fppf site.

\begin{lemma}
\label{lemma-derived-quasi-coherent}
Let $\mathcal{X}$ be an algebraic stack.
\begin{enumerate}
\item
Let $\mathcal{F}^\bullet$ be an object of
$D_{\mathcal{M}_\mathcal{X}}(\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})$.
With $g$ as in
Cohomology of Stacks,
Lemma \ref{stacks-cohomology-lemma-lisse-etale}
for the lisse-\'etale site we have
\begin{enumerate}
\item $g^{-1}\mathcal{F}^\bullet$ is in
$D_\QCoh(\mathcal{O}_{\mathcal{X}_{lisse,\etale}})$,
\item $g^{-1}\mathcal{F}^\bullet = 0$ if and only if
$\mathcal{F}^\bullet$ is in
$D_{\mathcal{P}_\mathcal{X}}(\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})$,
\item $Lg_!\mathcal{H}^\bullet$ is in
$D_{\mathcal{M}_\mathcal{X}}(
\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})$
for $\mathcal{H}^\bullet$ in
$D_\QCoh(\mathcal{O}_{\mathcal{X}_{lisse,\etale}})$, and
\item the functors $g^{-1}$ and $Lg_!$ define mutually inverse functors
$$
\xymatrix{
D_\QCoh(\mathcal{O}_\mathcal{X}) \ar@<1ex>[r]^-{g^{-1}} &
D_\QCoh(\mathcal{O}_{\mathcal{X}_{lisse,\etale}})
\ar@<1ex>[l]^-{Lg_!}
}
$$
\end{enumerate}
\item
Let $\mathcal{F}^\bullet$ be an object of
$D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$. With $g$ as in
Cohomology of Stacks,
Lemma \ref{stacks-cohomology-lemma-lisse-etale}
for the flat-fppf site we have
\begin{enumerate}
\item $g^{-1}\mathcal{F}^\bullet$ is in
$D_\QCoh(\mathcal{O}_{\mathcal{X}_{flat, fppf}})$,
\item $g^{-1}\mathcal{F}^\bullet = 0$ if and only if
$\mathcal{F}^\bullet$ is in
$D_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$,
\item $Lg_!\mathcal{H}^\bullet$ is in
$D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$
for $\mathcal{H}^\bullet$ in
$D_\QCoh(\mathcal{O}_{\mathcal{X}_{flat,fppf}})$, and
\item the functors $g^{-1}$ and $Lg_!$ define mutually inverse functors
$$
\xymatrix{
D_\QCoh(\mathcal{O}_\mathcal{X}) \ar@<1ex>[r]^-{g^{-1}} &
D_\QCoh(\mathcal{O}_{\mathcal{X}_{flat,fppf}}) \ar@<1ex>[l]^-{Lg_!}
}
$$
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
The functor $g^{-1}$ is exact, hence (1)(a), (2)(a), (1)(b), and (2)(b)
follow from Cohomology of Stacks,
Lemmas \ref{stacks-cohomology-lemma-quasi-coherent} and
\ref{stacks-cohomology-lemma-parasitic-in-terms-flat-fppf}.

\medskip\noindent
Proof of (1)(c) and (2)(c).
The construction of $Lg_!$ in Lemma \ref{lemma-shriek-derived}
(via Cohomology on Sites,
Lemma \ref{sites-cohomology-lemma-existence-derived-lower-shriek}
which in turn uses
Derived Categories, Proposition \ref{derived-proposition-left-derived-exists})
shows that $Lg_!$ on any object $\mathcal{H}^\bullet$ of
$D(\mathcal{O}_{\mathcal{X}_{lisse,\etale}})$ is computed
as
$$
Lg_!\mathcal{H}^\bullet = \colim g_!\mathcal{K}_n^\bullet =
g_! \colim \mathcal{K}_n^\bullet
$$
(termwise colimits) where the quasi-isomorphism
$\colim \mathcal{K}_n^\bullet \to \mathcal{H}^\bullet$
induces quasi-isomorphisms
$\mathcal{K}_n^\bullet \to \tau_{\leq n} \mathcal{H}^\bullet$.
Since
$\mathcal{M}_\mathcal{X} \subset
\textit{Mod}(\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})$
(resp.\ $\mathcal{M}_\mathcal{X} \subset \textit{Mod}(\mathcal{O}_\mathcal{X})$)
is preserved under colimits we see that it suffices to prove (c)
on bounded above complexes $\mathcal{H}^\bullet$ in
$D_\QCoh(\mathcal{O}_{\mathcal{X}_{lisse,\etale}})$
(resp.\ $D_\QCoh(\mathcal{O}_{\mathcal{X}_{flat,fppf}})$).
In this case to show that $H^n(Lg_!\mathcal{H}^\bullet)$ is
in $\mathcal{M}_\mathcal{X}$ we can argue by induction on the integer
$m$ such that $\mathcal{H}^i = 0$ for $i > m$. If $m < n$, then
$H^n(Lg_!\mathcal{H}^\bullet) = 0$ and the result holds. In general
consider the distinguished triangle
$$
\tau_{\leq m - 1}\mathcal{H}^\bullet \to \mathcal{H}^\bullet \to
H^m(\mathcal{H}^\bullet)[-m] \to \ldots
$$
(Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle})
and apply the functor $Lg_!$. Since $\mathcal{M}_\mathcal{X}$
is a weak Serre subcategory of the module category it suffices to
prove (c) for two out of three. We have the result for
$Lg_!\tau_{\leq m - 1}\mathcal{H}^\bullet$ by induction and we
have the result for $Lg_!H^m(\mathcal{H}^\bullet)[-m]$ by
Lemma \ref{lemma-higher-shriek-quasi-coherent}. Whence (c) holds.

\medskip\noindent
Let us prove (2)(d). By (2)(a) and (2)(b) the functor $g^{-1} = g^*$ induces
a functor
$$
c :
D_\QCoh(\mathcal{O}_\mathcal{X})
\longrightarrow
D_\QCoh(\mathcal{O}_{\mathcal{X}_{flat, fppf}})
$$
see
Derived Categories, Lemma \ref{derived-lemma-universal-property-quotient}.
Thus we have the following diagram of triangulated categories
$$
\xymatrix{
D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})
\ar[rd]^{g^{-1}} \ar[rr]_q & &
D_\QCoh(\mathcal{O}_\mathcal{X}) \ar[ld]^c \\
& D_\QCoh(\mathcal{O}_{\mathcal{X}_{flat, fppf}})
\ar@<1ex>[lu]^{Lg_!}
}
$$
where $q$ is the quotient functor, the inner triangle is commutative, and
$g^{-1}Lg_! = \text{id}$.
For any object of $E$ of $D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$
the map $a : Lg_!g^{-1}E \to E$ maps to a quasi-isomorphism in
$D(\mathcal{O}_{\mathcal{X}_{flat, fppf}})$. Hence the cone on
$a$ maps to zero under $g^{-1}$ and by (2)(b) we see that $q(a)$ is
an isomorphism. Thus $q \circ Lg_!$ is a quasi-inverse to $c$.

\medskip\noindent
In the case of the lisse-\'etale site exactly the same argument as above
proves that
$$
D_{\mathcal{M}_\mathcal{X}}(
\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
/
D_{\mathcal{P}_\mathcal{X}}(
\mathcal{X}_\etale, \mathcal{O}_\mathcal{X})
$$
is equivalent to
$D_\QCoh(\mathcal{O}_{\mathcal{X}_{lisse,\etale}})$.
Applying the last equivalence of
Lemma \ref{lemma-compare-etale-fppf-QCoh}
finishes the proof.
\end{proof}

\noindent
The following lemma tells us that the quotient functor
$D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X}) \to
D_\QCoh(\mathcal{O}_\mathcal{X})$ is a Bousfield
colocalization (insert future reference here).

\begin{lemma}
\label{lemma-bousfield-colocalization}
Let $\mathcal{X}$ be an algebraic stack.
Let $E$ be an object of $D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$.
There exists a canonical distinguished triangle
$$
E' \to E \to P \to E'[1]
$$
in $D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$ such that
$P$ is in $D_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$
and
$$
\Hom_{D(\mathcal{O}_\mathcal{X})}(E', P') = 0
$$
for all $P'$ in $D_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$.
\end{lemma}

\begin{proof}
Consider the morphism of ringed topoi
$g : \Sh(\mathcal{X}_{flat, fppf}) \longrightarrow \Sh(\mathcal{X}_{fppf})$.
Set $E' = Lg_!g^{-1}E$ and let $P$ be the cone on the adjunction
map $E' \to E$. Since $g^{-1}E' \to g^{-1}E$ is an isomorphism we see that
$P$ is an object of $D_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$ by
Lemma \ref{lemma-derived-quasi-coherent} (2)(b).
Finally, $\Hom(E', P') = \Hom(Lg_!g^{-1}E, P') = \Hom(g^{-1}E, g^{-1}P') = 0$
as $g^{-1}P' = 0$.

\medskip\noindent
Uniqueness. Suppose that $E'' \to E \to P'$ is a second distinguished
triangle as in the statement of the lemma. Since $\Hom(E', P') = 0$
the morphism $E' \to E$ factors as $E' \to E'' \to E$, see
Derived Categories, Lemma \ref{derived-lemma-representable-homological}.
Similarly, the morphism $E'' \to E$ factors as $E'' \to E' \to E$.
Consider the composition $\varphi : E' \to E'$ of the maps $E' \to E''$ and
$E'' \to E'$. Note that $\varphi - 1 : E' \to E'$ fits into the commutative
diagram
$$
\xymatrix{
E' \ar[d]^{\varphi - 1} \ar[r] & E \ar[d]^0 \\
E' \ar[r] & E
}
$$
hence factors through $P[-1] \to E$. Since $\Hom(E', P[-1]) = 0$
we see that $\varphi = 1$. Whence the maps $E' \to E''$ and $E'' \to E'$
are inverse to each other.
\end{proof}






\section{Derived pushforward of quasi-coherent modules}
\label{section-derived-pushforward}

\noindent
As a first application of the material above we construct the derived
pushforward. In
Examples, Section \ref{examples-section-derived-push-quasi-coherent}
the reader can find an example of a quasi-compact and quasi-separated
morphism $f : \mathcal{X} \to \mathcal{Y}$ of algebraic stacks such
that the direct image functor $Rf_*$ does not induce a functor
$D_\QCoh(\mathcal{O}_\mathcal{X}) \to
D_\QCoh(\mathcal{O}_\mathcal{Y})$. Thus restricting to bounded
below complexes is necessary.

\begin{proposition}
\label{proposition-derived-direct-image-quasi-coherent}
Let $f : \mathcal{X} \to \mathcal{Y}$ be a quasi-compact and
quasi-separated morphism of algebraic stacks.
The functor $Rf_*$ induces a commutative diagram
$$
\xymatrix{
D^{+}_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})
\ar[r] \ar[d]^{Rf_*} &
D^{+}_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})
\ar[r] \ar[d]^{Rf_*} &
D(\mathcal{O}_\mathcal{X})
\ar[d]^{Rf_*} \\
D^{+}_{\mathcal{P}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y}) \ar[r] &
D^{+}_{\mathcal{M}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y}) \ar[r] &
D(\mathcal{O}_\mathcal{Y})
}
$$
and hence induces a functor
$$
Rf_{\QCoh, *} :
D^{+}_\QCoh(\mathcal{O}_\mathcal{X})
\longrightarrow
D^{+}_\QCoh(\mathcal{O}_\mathcal{Y})
$$
on quotient categories. Moreover, the functor $R^if_\QCoh$
of
Cohomology of Stacks,
Proposition \ref{stacks-cohomology-proposition-direct-image-quasi-coherent}
are equal to $H^i \circ Rf_{\QCoh, *}$ with $H^i$ as in
(\ref{equation-Hi-quasi-coherent}).
\end{proposition}

\begin{proof}
We have to show that $Rf_*E$ is an object of
$D^{+}_{\mathcal{M}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y})$ for
$E$ in $D^{+}_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$.
This follows from
Cohomology of Stacks,
Proposition \ref{stacks-cohomology-proposition-lcq-flat-base-change}
and the spectral sequence $R^if_*H^j(E) \Rightarrow R^{i + j}f_*E$.
The case of parasitic modules works the same way using
Cohomology of Stacks, Lemma
\ref{stacks-cohomology-lemma-pushforward-parasitic}.
The final statement is clear from the definition of
$H^i$ in (\ref{equation-Hi-quasi-coherent}).
\end{proof}




\section{Derived pullback of quasi-coherent modules}
\label{section-derived-pullback}

\noindent
Derived pullback of complexes with quasi-coherent cohomology
sheaves exists in general.

\begin{proposition}
\label{proposition-derived-pullback-quasi-coherent}
Let $f : \mathcal{X} \to \mathcal{Y}$ be a morphism of algebraic stacks.
The exact functor $f^*$ induces a commutative diagram
$$
\xymatrix{
D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X}) \ar[r] &
D(\mathcal{O}_\mathcal{X}) \\
D_{\mathcal{M}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y})
\ar[r] \ar[u]^{f^*} &
D(\mathcal{O}_\mathcal{Y}) \ar[u]^{f^*}
}
$$
The composition
$$
D_{\mathcal{M}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y})
\xrightarrow{f^*}
D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})
\xrightarrow{q_\mathcal{X}}
D_\QCoh(\mathcal{O}_\mathcal{X})
$$
is left derivable with respect to the localization
$D_{\mathcal{M}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y}) \to
D_\QCoh(\mathcal{O}_\mathcal{Y})$
and we may define $Lf^*_\QCoh$ as its left derived functor
$$
Lf_\QCoh^* :
D_\QCoh(\mathcal{O}_\mathcal{Y})
\longrightarrow
D_\QCoh(\mathcal{O}_\mathcal{X})
$$
(see
Derived Categories,
Definitions \ref{derived-definition-right-derived-functor-defined} and
\ref{derived-definition-everywhere-defined}). If $f$ is quasi-compact
and quasi-separated, then $Lf^*_\QCoh$ and $Rf_{\QCoh, *}$
satisfy the following adjointness:
$$
\Hom_{D_\QCoh(\mathcal{O}_\mathcal{X})}(Lf^*_\QCoh A, B)
=
\Hom_{D_\QCoh(\mathcal{O}_\mathcal{Y})}(A, Rf_{\QCoh, *}B)
$$
for $A \in D_\QCoh(\mathcal{O}_\mathcal{Y})$ and
$B \in D^{+}_\QCoh(\mathcal{O}_\mathcal{X})$.
\end{proposition}

\begin{proof}
To prove the first statement, we have to show that $f^*E$ is an object of
$D_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$ for
$E$ in $D_{\mathcal{M}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y})$.
Since $f^* = f^{-1}$ is exact this follows immediately from the fact that
$f^*$ maps $\mathcal{M}_\mathcal{Y}$ into $\mathcal{M}_\mathcal{X}$.

\medskip\noindent
Set $\mathcal{D} = D_{\mathcal{M}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y})$.
Let $S$ be the collection of morphisms in $\mathcal{D}$
whose cone is an object of
$D_{\mathcal{P}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y})$.
Set $\mathcal{D}' = D_\QCoh(\mathcal{O}_\mathcal{X})$.
Set $F = q_\mathcal{X} \circ f^* : \mathcal{D} \to \mathcal{D}'$.
Then $\mathcal{D}, S, \mathcal{D}', F$ are as in
Derived Categories, Situation \ref{derived-situation-derived-functor} and
Definition \ref{derived-definition-right-derived-functor-defined}.
Let us prove that $LF(E)$ is defined for any object $E$ of $\mathcal{D}$.
Namely, consider the triangle
$$
E' \to E \to P \to E'[1]
$$
constructed in Lemma \ref{lemma-bousfield-colocalization}.
Note that $s : E' \to E$ is an element of $S$. We claim that $E'$ computes
$LF$. Namely, suppose that $s' : E'' \to E$ is another element of $S$, i.e.,
fits into a triangle $E'' \to E \to P' \to E''[1]$ with $P'$ in
$D_{\mathcal{P}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y})$. By
Lemma \ref{lemma-bousfield-colocalization} (and its proof)
we see that $E' \to E$ factors through $E'' \to E$. Thus we see that
$E' \to E$ is cofinal in the system $S/E$. Hence it is clear that
$E'$ computes $LF$.

\medskip\noindent
To see the final statement, write $B = q_\mathcal{X}(H)$ and
$A = q_\mathcal{Y}(E)$.
Choose $E' \to E$ as above.
We will use on the one hand that
$Rf_{\QCoh, *}(B) = q_\mathcal{Y}(Rf_*H)$
and on the other that
$Lf^*_\QCoh(A) = q_\mathcal{X}(f^*E')$.
\begin{align*}
\Hom_{D_\QCoh(\mathcal{O}_\mathcal{X})}(Lf^*_\QCoh A, B)
& = 
\Hom_{D_\QCoh(\mathcal{O}_\mathcal{X})}(q_\mathcal{X}(f^*E'),
q_\mathcal{X}(H)) \\
& = 
\colim_{H \to H'} \Hom_{D(\mathcal{O}_\mathcal{X})}(f^*E', H') \\
& = \colim_{H \to H'} \Hom_{D(\mathcal{O}_\mathcal{Y})}(E', Rf_*H') \\
& = \Hom_{D(\mathcal{O}_\mathcal{Y})}(E', Rf_*H) \\
& =
\Hom_{D_\QCoh(\mathcal{O}_\mathcal{Y})}(A, Rf_{\QCoh, *}B)
\end{align*}
Here the colimit is over morphisms $s : H \to H'$ in
$D^+_{\mathcal{M}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$
whose cone $P(s)$ is an object of
$D^+_{\mathcal{P}_\mathcal{X}}(\mathcal{O}_\mathcal{X})$.
The first equality we've seen above.
The second equality holds by construction of the Verdier quotient.
The third equality holds by
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-adjoint}.
Since $Rf_*P(s)$ is an object of
$D^+_{\mathcal{P}_\mathcal{Y}}(\mathcal{O}_\mathcal{Y})$ by
Proposition \ref{proposition-derived-direct-image-quasi-coherent}
we see that $\Hom_{D(\mathcal{O}_\mathcal{Y})}(E', Rf_*P(s)) = 0$.
Thus the fourth equality holds. The final equality
holds by construction of $E'$.
\end{proof}








\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
