\input{preamble}


% OK, start here.
%
\begin{document}

\title{Formal Deformation Theory}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
This chapter develops formal deformation theory in a form applicable
later in the Stacks project, closely following Rim \cite[Exposee VI]{SGA7-I}
and Schlessinger \cite{Sch}. We strongly encourage the reader new to
this topic to read the paper by Schlessinger first, as it is sufficiently
general for most applications, and Schlessinger's results are indeed
used in most papers that use this kind of formal deformation theory.

\medskip\noindent
Let $\Lambda$ be a complete Noetherian local ring with residue field $k$,
and let $\mathcal{C}_\Lambda$ denote the category of Artinian local
$\Lambda$-algebras with residue field $k$. Given a functor
$F : \mathcal{C}_\Lambda \to \textit{Sets}$ such that $F(k)$
is a one element set, Schlessinger's paper introduced conditions
(H1)-(H4) such that:
\begin{enumerate}
\item $F$ has a ``hull'' if and only if (H1)-(H3) hold.
\item $F$ is prorepresentable if and only (H1)-(H4) hold.
\end{enumerate}
The purpose of this chapter is to generalize these results in two ways
exactly as is done in Rim's paper:
\begin{enumerate}
\item[(A)] The functor $F$ is replaced by a category $\mathcal{F}$ cofibered
in groupoids over $\mathcal{C}_\Lambda$, see
Section \ref{section-CLambda}.
\item[(B)] We let $\Lambda$ be a Noetherian ring and $\Lambda \to k$
a finite ring map to a field. The category $\mathcal{C}_\Lambda$ is
the category of Artinian local $\Lambda$-algebras $A$ endowed with a
given identification $A/\mathfrak m_A = k$.
\end{enumerate}
The analogue of the condition that $F(k)$ is a  one element set is that
$\mathcal{F}(k)$ is the trivial groupoid. If $\mathcal{F}$ satisfies this
condition then we say it is a {\it predeformation category}, but in  general
we do not make this assumption.  Rim's paper \cite[Exposee VI]{SGA7-I} is the
original source for the results in this document. We also mention the useful
paper \cite{Talpo-Vistoli}, which discusses deformation theory with groupoids but
in less generality than we do here.

\medskip\noindent
An important role is played by the ``completion''
$\widehat{\mathcal{C}}_\Lambda$ of the category $\mathcal{C}_\Lambda$.
An object of $\widehat{\mathcal{C}}_\Lambda$ is a Noetherian complete
local $\Lambda$-algebra $R$ whose residue field is identified with $k$, see
Section \ref{section-category-completion-CLambda}.
On the one hand $\mathcal{C}_\Lambda \subset \widehat{\mathcal{C}}_\Lambda$
is a strictly full subcategory and on the other hand
$\widehat{\mathcal{C}}_\Lambda$ is a full subcategory of the category
of pro-objects of $\mathcal{C}_\Lambda$. A functor
$\mathcal{C}_\Lambda \to \textit{Sets}$ is {\it prorepresentable}
if it is isomorphic to the restriction of a representable functor
$\underline{R} = \Mor_{\widehat{\mathcal{C}}_\Lambda}(R, -)$
to $\mathcal{C}_\Lambda$ where
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$.

\medskip\noindent
{\it Categories cofibred in groupoids} are dual to categories fibred in
groupoids; we introduce them in Section \ref{section-preliminary}.
A {\it smooth} morphism of categories cofibred in groupoids over
$\mathcal{C}_\Lambda$ is one that satisfies the infinitesimal lifting
criterion for objects, see
Section \ref{section-smooth-morphisms}.
This is analogous to the definition of a formally smooth ring map, see
Algebra, Definition \ref{algebra-definition-formally-smooth}
and is exactly dual to the notion in
Criteria for Representability, Section \ref{criteria-section-formally-smooth}.
This is an important notion as we eventually want to prove that certain
kinds of categories cofibred in groupoids have a smooth prorepresentable
presentation, much like the characterization of algebraic stacks in
Algebraic Stacks, Sections \ref{algebraic-section-stack-to-presentation} and
\ref{algebraic-section-smooth-groupoid-gives-algebraic-stack}.
A {\it versal formal object} of a category $\mathcal{F}$ cofibred
in groupoids over $\mathcal{C}_\Lambda$ is an object
$\xi \in \widehat{\mathcal{F}}(R)$ of the completion such that the
associated morphism
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
is smooth.

\medskip\noindent
In
Section \ref{section-schlessinger-conditions},
we define conditions (S1) and (S2) on $\mathcal{F}$ generalizing
Schlessinger's (H1) and (H2). The analogue of Schlessinger's
(H3)---the condition that $\mathcal{F}$ has finite dimensional
tangent space---is not given a name.
A key step in the development of the theory is the existence of
versal formal objects for predeformation categories satisfying
(S1), (S2) and (H3), see
Lemma \ref{lemma-versal-object-existence}.
Schlessinger's notion of a {\it hull} for a functor
$F : \mathcal{C}_\Lambda \to \textit{Sets}$
is, in our terminology, a versal formal object $\xi \in \widehat{F}(R)$
such that the induced map of tangent spaces
$d\underline{\xi} : T\underline{R}|_{\mathcal{C}_\Lambda} \to TF$
is an isomorphism.
In the literature a hull is often called a ``miniversal'' object.
We do not do so, and here is why. It can happen that a functor has a
versal formal object without having a hull. Moreover, we show in
Section \ref{section-minimal-versal}
that if a predeformation category has a versal formal object, then
it always has a {\it minimal} one (as defined in
Definition \ref{definition-minimal-versal})
which is unique up to isomorphism, see
Lemma \ref{lemma-minimal-versal}.
But it can happen that the minimal versal formal object does not
induce an isomorphism on tangent spaces! (See
Examples \ref{example-do-not-get-S2} and
\ref{example-smooth-continued}.)

\medskip\noindent
Keeping in mind the differences pointed out above,
Theorem \ref{theorem-miniversal-object-existence}
is the direct generalization of (1) above: it recovers Schlessinger's
result in the case that $\mathcal{F}$ is a functor and it characterizes
minimal versal formal objects, in the presence of conditions
(S1) and (S2), in terms of the map
$d\underline{\xi} : T\underline{R}|_{\mathcal{C}_\Lambda} \to TF$
on tangent spaces.

\medskip\noindent
In Section \ref{section-RS-condition},
we define Rim's condition (RS) on $\mathcal{F}$ generalizing
Schlessinger's (H4). A {\it deformation category} is defined as a
predeformation category satisfying (RS).
The analogue to prorepresentable functors are the categories
cofibred in groupoids over $\mathcal{C}_\Lambda$ which have
a {\it presentation by a smooth prorepresentable groupoid in functors}
on $\mathcal{C}_\Lambda$, see
Definitions \ref{definition-groupoid-in-functors},
\ref{definition-prorepresentable-groupoid-in-functors}, and
\ref{definition-smooth-groupoid-in-functors}.
This notion of a presentation takes into account the groupoid structure
of the fibers of $\mathcal{F}$. In
Theorem \ref{theorem-presentation-deformation-groupoid}
we prove that $\mathcal{F}$ has a presentation by a smooth prorepresentable
groupoid in functors if and only if $\mathcal{F}$ has a finite dimensional
tangent space and finite dimensional infinitesimal automorphism space.
This is the generalization of (2) above: it reduces to Schlessinger's result
in the case that $\mathcal{F}$ is a functor.
There is a final
Section \ref{section-minimality}
where we discuss how to use minimal versal formal objects
to produce a (unique up to isomorphism) minimal presentation
by a smooth prorepresentable groupoid in functors.

\medskip\noindent
We also find the following conceptual explanation for Schlessinger's
conditions. If a predeformation category $\mathcal{F}$ satisfies (RS),
then the associated functor of isomorphism classes
$\overline{\mathcal{F}}: \mathcal{C}_\Lambda \to \textit{Sets}$
satisfies (H1) and (H2)
(Lemmas \ref{lemma-RS-implies-S1-S2} and
\ref{lemma-S1-S2-associated-functor}).
Conversely, if a functor
$F : \mathcal{C}_\Lambda \to \textit{Sets}$
arises naturally as the functor of isomorphism classes of
a category $\mathcal{F}$ cofibered in groupoids, then it seems to happen in
practice that an argument showing $F$ satisfies (H1) and (H2) will also show
$\mathcal{F}$ satisfies (RS). Examples are discussed in
Deformation Problems, Section
\ref{examples-defos-section-introduction}.
Moreover, if $\mathcal{F}$ satisfies (RS), then condition
(H4) for $\overline{\mathcal{F}}$ has a simple interpretation in terms of
extending automorphisms of objects of $\mathcal{F}$
(Lemma \ref{lemma-RS-associated-functor}).
These observations suggest that (RS) should be regarded as the
fundamental deformation theoretic glueing condition.




\section{Notation and Conventions}
\label{section-notations-conventions}

\noindent
A ring is commutative with $1$. The  maximal ideal of a local ring $A$
is denoted by $\mathfrak{m}_A$. The set of positive integers is denoted
by $\mathbf{N} = \{1, 2, 3, \ldots\}$. If $U$ is an object of a
category $\mathcal{C}$, we denote by $\underline{U}$
the functor
$\Mor_\mathcal{C}(U, -): \mathcal{C} \to \textit{Sets}$, see
Remarks \ref{remarks-cofibered-groupoids} (\ref{item-definition-yoneda}).
Warning: this may conflict with the notation in other chapters where we
sometimes use $\underline{U}$ to denote $h_U(-) = \Mor_\mathcal{C}(-, U)$.

\medskip\noindent
Throughout this chapter $\Lambda$ is a Noetherian ring and
$\Lambda \to k$ is a finite ring map from $\Lambda$ to a field.
The kernel of this map is denoted $\mathfrak m_\Lambda$ and the
image $k' \subset k$. It turns out that $\mathfrak m_\Lambda$ is
a maximal ideal, $k' = \Lambda/\mathfrak m_\Lambda$ is a field, and
the extension $k' \subset k$ is finite. See discussion surrounding
(\ref{equation-k-prime}).


\section{The base category}
\label{section-CLambda}

\noindent
Motivation. An important application of formal deformation theory is
to criteria for representability by algebraic spaces. Suppose given a
locally Noetherian base $S$ and a functor
$F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $k$ be a finite type field over $S$, i.e., we are given a
finite type morphism $\Spec(k) \to S$.
One of Artin's criteria is that for any element $x \in F(\Spec(k))$
the predeformation functor associated to
the triple $(S, k, x)$ should be prorepresentable. By
Morphisms, Lemma \ref{morphisms-lemma-point-finite-type}
the condition that $k$ is of finite type over $S$ means that there exists
an affine open $\Spec(\Lambda) \subset S$ such that $k$
is a finite $\Lambda$-algebra. This motivates why we work throughout
this chapter with a base category as follows.

\begin{definition}
\label{definition-CLambda}
Let $\Lambda$ be a Noetherian ring and let $\Lambda \to k$ be a finite
ring map where $k$ is a field. We define {\it $\mathcal{C}_\Lambda$} to be
the category with
\begin{enumerate}
\item objects are pairs $(A, \varphi)$ where $A$ is an Artinian local
$\Lambda$-algebra and where $\varphi : A/\mathfrak m_A \to k$ is a
$\Lambda$-algebra isomorphism, and
\item morphisms $f : (B, \psi) \to (A, \varphi)$ are local $\Lambda$-algebra
homomorphisms such that $\varphi \circ (f \bmod \mathfrak m) = \psi$.
\end{enumerate}
We say we are in the {\it classical case} if $\Lambda$ is a Noetherian
complete local ring and $k$ is its residue field.
\end{definition}

\noindent
Note that if $\Lambda \to k$ is surjective and if $A$ is an Artinian local
$\Lambda$-algebra, then the identification $\varphi$, if it exists,
is unique. Moreover, in this case any $\Lambda$-algebra map $A \to B$ is
going to be compatible with the identifications. Hence in this case
$\mathcal{C}_\Lambda$ is just the category of local Artinian $\Lambda$-algebras
whose residue field ``is'' $k$. By abuse of notation we also denote objects of
$\mathcal{C}_\Lambda$ simply $A$ in the general case. Moreover, we will
often write $A/\mathfrak m = k$, i.e., we will pretend all rings in
$\mathcal{C}_\Lambda$ have residue field $k$ (since all ring maps in
$\mathcal{C}_\Lambda$ are compatible with the given identifications this
should never cause any problems).
Throughout the rest of this chapter the base ring $\Lambda$ and the
field $k$ are fixed. The category $\mathcal{C}_\Lambda$ will be the base
category for the cofibered categories considered below.

\begin{definition}
\label{definition-small-extension}
Let $f: B \to A$ be a ring map in $\mathcal{C}_\Lambda$.  We say $f$
is a {\it small extension} if it is surjective and $\Ker(f)$ is a nonzero
principal ideal which is annihilated by $\mathfrak{m}_B$.
\end{definition}

\noindent
By the following lemma we can often reduce arguments involving surjective ring
maps in $\mathcal{C}_\Lambda$ to the case of small extensions.

\begin{lemma}
\label{lemma-factor-small-extension}
Let $f: B \to A$ be a surjective ring map in $\mathcal{C}_\Lambda$.
Then $f$ can be factored as a composition of small extensions.
\end{lemma}

\begin{proof}
Let $I$ be the kernel of $f$.  The maximal ideal $\mathfrak{m}_B$ is
nilpotent since $B$ is Artinian, say $\mathfrak{m}_B^n = 0$. Hence we get a
factorization
$$
B = B/I\mathfrak{m}_B^{n-1} \to B/I\mathfrak{m}_B^{n-2} \to
\ldots \to B/I \cong A
$$
of $f$ into a composition of surjective maps whose kernels are annihilated by
the maximal ideal.  Thus it suffices to prove the lemma when $f$ itself is such
a map, i.e.\ when $I$ is annihilated by $\mathfrak{m}_B$. In this case
$I$ is a $k$-vector space, which has finite dimension, see
Algebra, Lemma \ref{algebra-lemma-artinian-finite-length}.
Take a basis $x_1, \ldots, x_n$ of $I$ as a $k$-vector space to get a
factorization
$$
B \to B/(x_1) \to \ldots \to  B/(x_1, \ldots, x_n) \cong  A
$$
of $f$ into a composition of small extensions.
\end{proof}

\noindent
The next lemma says that we can compute the length of a module over a local
$\Lambda$-algebra with residue field $k$ in terms of the length over
$\Lambda$. To explain the notation in the statement, let $k' \subset k$
be the image of our fixed finite ring map $\Lambda \to k$. Note
that $k/k'$ is a finite extension of rings. Hence $k'$ is a field
and $k'/k$ is a finite extension, see
Algebra, Lemma \ref{algebra-lemma-integral-under-field}.
Moreover, as $\Lambda \to k'$ is surjective we see that its kernel
is a maximal ideal $\mathfrak m_\Lambda$. Thus
\begin{equation}
\label{equation-k-prime}
[k : k'] = [k : \Lambda/\mathfrak m_\Lambda] < \infty
\end{equation}
and in the classical case we have $k = k'$. The notation
$k' = \Lambda/\mathfrak m_\Lambda$ will be fixed throughout this chapter.

\begin{lemma}
\label{lemma-length}
Let $A$ be a local $\Lambda$-algebra with residue field $k$.
Let $M$ be an $A$-module. Then
$[k : k'] \text{length}_A(M) = \text{length}_\Lambda(M)$.
In the classical case we have
$\text{length}_A(M) = \text{length}_\Lambda(M)$.
\end{lemma}

\begin{proof}
If $M$ is a simple $A$-module then $M \cong k$ as an $A$-module, see
Algebra, Lemma \ref{algebra-lemma-characterize-length-1}.
In this case $\text{length}_A(M) = 1$ and
$\text{length}_\Lambda(M) = [k' : k]$, see
Algebra, Lemma \ref{algebra-lemma-dimension-is-length}.
If $\text{length}_A(M)$ is finite, then the result follows on
choosing a filtration of $M$ by $A$-submodules with simple quotients
using additivity, see
Algebra, Lemma \ref{algebra-lemma-length-additive}.
If $\text{length}_A(M)$ is infinite, the result follows from the obvious
inequality $\text{length}_A(M) \leq \text{length}_\Lambda(M)$.
\end{proof}

\begin{lemma}
\label{lemma-surjective}
Let $A \to B$ be a ring map in $\mathcal{C}_\Lambda$.
The following are equivalent
\begin{enumerate}
\item $f$ is surjective,
\item $\mathfrak m_A/\mathfrak m_A^2 \to \mathfrak m_B/\mathfrak m_B^2$
is surjective, and
\item $\mathfrak m_A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)
\to \mathfrak m_B/(\mathfrak m_\Lambda B + \mathfrak m_B^2)$ is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
For any ring map $f : A \to B$ in $\mathcal{C}_\Lambda$ we have
$f(\mathfrak m_A) \subset \mathfrak m_B$ for example because
$\mathfrak m_A$, $\mathfrak m_B$ is the set of nilpotent elements of
$A$, $B$. Suppose $f$ is surjective. Let $y \in \mathfrak m_B$.
Choose $x \in A$ with $f(x) = y$. Since $f$ induces an isomorphism
$A/\mathfrak m_A \to B/\mathfrak m_B$ we see that $x \in \mathfrak m_A$.
Hence the induced map
$\mathfrak m_A/\mathfrak m_A^2 \to \mathfrak m_B/\mathfrak m_B^2$
is surjective. In this way we see that (1) implies (2).

\medskip\noindent
It is clear that (2) implies (3). The map $A \to B$ gives rise
to a canonical commutative diagram
$$
\xymatrix{
\mathfrak m_\Lambda/\mathfrak m_\Lambda^2 \otimes_{k'} k \ar[r] \ar[d] &
\mathfrak m_A/\mathfrak m_A^2 \ar[r] \ar[d] &
\mathfrak m_A/(\mathfrak m_\Lambda A + \mathfrak m_A^2) \ar[r] \ar[d] & 0 \\
\mathfrak m_\Lambda/\mathfrak m_\Lambda^2 \otimes_{k'} k \ar[r] &
\mathfrak m_B/\mathfrak m_B^2 \ar[r] &
\mathfrak m_B/(\mathfrak m_\Lambda B + \mathfrak m_B^2) \ar[r] & 0
}
$$
with exact rows. Hence if (3) holds, then so does (2).

\medskip\noindent
Assume (2). To show that $A \to B$ is surjective it suffices by
Nakayama's lemma (Algebra, Lemma \ref{algebra-lemma-NAK})
to show that $A/\mathfrak m_A \to B/\mathfrak m_AB$ is surjective.
(Note that $\mathfrak m_A$ is a nilpotent ideal.)
As $k = A/\mathfrak m_A = B/\mathfrak m_B$ it suffices to show that
$\mathfrak m_AB \to \mathfrak m_B$ is surjective. Applying
Nakayama's lemma once more we see that it suffices to see that
$\mathfrak m_AB/\mathfrak m_A\mathfrak m_B \to \mathfrak m_B/\mathfrak m_B^2$
is surjective which is what we assumed.
\end{proof}

\noindent
If $A \to B$ is a ring map in $\mathcal{C}_\Lambda$, then the map
$\mathfrak m_A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)
\to \mathfrak m_B/(\mathfrak m_\Lambda B + \mathfrak m_B^2)$
is the map on relative cotangent spaces. Here is a formal definition.

\begin{definition}
\label{definition-tangent-space-ring}
Let $R \to S$ be a local homomorphism of local rings. The
{\it relative cotangent space}\footnote{Caution: We will see later
that in our general setting the tangent
space of an object $A \in \mathcal{C}_\Lambda$ over $\Lambda$ should
not be defined simply as the $k$-linear dual of the relative
cotangent space. In fact, the correct definition of the relative
cotangent space is
$\Omega_{S/R} \otimes_S S/\mathfrak m_S$.} of $R$ over $S$ is the
$S/\mathfrak m_S$-vector space
$\mathfrak m_S/(\mathfrak m_R S + \mathfrak m_S^2)$.
\end{definition}

\noindent
If $f_1: A_1 \to A$ and $f_2: A_2 \to A$ are two ring maps, then the fiber
product $A_1 \times_A A_2$ is the subring of $A_1 \times A_2$ consisting of
elements whose two projections to $A$ are equal. Throughout this chapter we
will be considering conditions involving such a fiber product when $f_1$
and $f_2$ are in $\mathcal{C}_\Lambda$. It isn't always the case that the
fibre product is an object of $\mathcal{C}_\Lambda$.

\begin{example}
\label{example-fibre-product}
Let $p$ be a prime number and let $n \in \mathbf{N}$.
Let $\Lambda = \mathbf{F}_p(t_1, t_2, \ldots, t_n)$ and let
$k = \mathbf{F}_p(x_1, \ldots, x_n)$ with map $\Lambda \to k$ given
by $t_i \mapsto x_i^p$. Let $A = k[\epsilon] = k[x]/(x^2)$.
Then $A$ is an object of $\mathcal{C}_\Lambda$. Suppose that
$D : k \to k$ is a derivation of $k$ over $\Lambda$, for example
$D = \partial/\partial x_i$. Then the map
$$
f_D : k \longrightarrow k[\epsilon], \quad
a \mapsto a + D(a)\epsilon
$$
is a morphism of $\mathcal{C}_\Lambda$. Set $A_1 = A_2 = k$ and set
$f_1 = f_{\partial/\partial x_1}$ and $f_2(a) = a$. Then
$A_1 \times_A A_2 = \{a \in k \mid \partial/\partial x_1(a) = 0\}$
which does not surject onto $k$. Hence the fibre product isn't
an object of $\mathcal{C}_\Lambda$.
\end{example}

\noindent
It turns out that this problem can only occur if the residue field
extension $k' \subset k$ (\ref{equation-k-prime}) is inseparable
and neither $f_1$ nor $f_2$ is surjective.

\begin{lemma}
\label{lemma-fiber-product-CLambda}
Let $f_1 : A_1 \to A$ and $f_2 : A_2 \to A$ be ring maps in
$\mathcal{C}_\Lambda$. Then:
\begin{enumerate}
\item If $f_1$ or $f_2$ is surjective, then
$A_1 \times_A A_2$ is in $\mathcal{C}_\Lambda$.
\item If $f_2$ is a small extension, then so is
$A_1 \times_A A_2 \to A_1$.
\item If the field extension $k' \subset k$ is separable, then
$A_1 \times_A A_2$ is in $\mathcal{C}_\Lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
The ring $A_1 \times_A A_2$ is a $\Lambda$-algebra via  the map
$\Lambda \to A_1 \times_A A_2$ induced by the maps
$\Lambda \to A_1$ and $\Lambda \to A_2$. It is a local ring with unique
maximal ideal
$$
\mathfrak m_{A_1} \times_{\mathfrak m_A} \mathfrak m_{A_2} =
\Ker(A_1 \times_A A_2 \longrightarrow k)
$$
A ring is Artinian if and only if it has finite length as a module
over itself, see
Algebra, Lemma \ref{algebra-lemma-artinian-finite-length}.
Since $A_1$ and $A_2$ are Artinian, Lemma \ref{lemma-length} implies
$\text{length}_\Lambda(A_1)$ and $\text{length}_\Lambda(A_2)$,
and hence $\text{length}_\Lambda(A_1 \times A_2)$, are all finite.  As
$A_1 \times_A A_2 \subset A_1 \times A_2$ is a $\Lambda$-submodule, this
implies
$\text{length}_{A_1 \times_A A_2}(A_1 \times_A A_2) \leq
\text{length}_\Lambda(A_1 \times_A A_2)$ is finite. So $A_1
\times_A A_2$ is Artinian. Thus the only thing that is keeping
$A_1 \times_A A_2$ from being an object of $\mathcal{C}_\Lambda$ is
the possibility that its residue field maps to a proper subfield of $k$
via the map $A_1 \times_A A_2 \to A \to A/\mathfrak m_A = k$ above.

\medskip\noindent
Proof of (1). If $f_2$ is surjective, then the projection
$A_1 \times_A A_2 \to A_1$ is surjective. Hence the composition
$A_1 \times_A A_2 \to A_1 \to A_1/\mathfrak m_{A_1} = k$ is surjective
and we conclude that $A_1 \times_A A_2$ is an object of $\mathcal{C}_\Lambda$.

\medskip\noindent
Proof of (2). If $f_2$ is a small extension then $A_2 \to A$ and
$A_1 \times_A A_2  \to A_1$ are both surjective with the same kernel.
Hence the kernel of $A_1 \times_A A_2  \to A_1$ is a $1$-dimensional
$k$-vector space and we see that $A_1 \times_A A_2  \to A_1$ is a small
extension.

\medskip\noindent
Proof of (3). Choose $\overline{x} \in k$ such that
$k = k'(\overline{x})$ (see
Fields, Lemma \ref{fields-lemma-primitive-element}).
Let $P'(T) \in k'[T]$ be the minimal polynomial of $\overline{x}$ over $k'$.
Since $k/k'$ is separable we see that
$\text{d}P/\text{d}T(\overline{x}) \not = 0$.
Choose a monic $P \in \Lambda[T]$ which maps to $P'$ under the surjective map
$\Lambda[T] \to k'[T]$. Because $A, A_1, A_2$ are henselian, see
Algebra, Lemma \ref{algebra-lemma-local-dimension-zero-henselian},
we can find $x, x_1, x_2 \in A, A_1, A_2$ with $P(x) = 0, P(x_1) = 0,
P(x_2) = 0$ and such that the image of $x, x_1, x_2$ in $k$ is $\overline{x}$.
Then $(x_1, x_2) \in A_1 \times_A A_2$ because $x_1, x_2$
map to $x \in A$ by uniqueness, see
Algebra, Lemma \ref{algebra-lemma-uniqueness}.
Hence the residue field of
$A_1 \times_A A_2$ contains a generator of $k$ over $k'$ and we win.
\end{proof}

\noindent
Next we define essential surjections in $\mathcal{C}_\Lambda$. A necessary
and sufficient condition for a surjection in $\mathcal{C}_\Lambda$ to be
essential is given in Lemma \ref{lemma-essential-surjection}.

\begin{definition}
\label{definition-essential-surjection}
Let $f: B \to A$ be a ring map in $\mathcal{C}_\Lambda$.  We say $f$
is an {\it essential surjection} if it has the following properties:
\begin{enumerate}
\item $f$ is surjective.
\item If $g: C \to B$ is a ring map in $\mathcal{C}_\Lambda$ such that
$f \circ g$ is surjective, then $g$ is surjective.
\end{enumerate}
\end{definition}

\noindent
Using Lemma \ref{lemma-surjective}, we can characterize
essential surjections in $\mathcal{C}_\Lambda$ as follows.

\begin{lemma}
\label{lemma-essential-surjection-mod-squares}
Let $f: B \to A$ be a ring map in $\mathcal{C}_\Lambda$.
The following are equivalent
\begin{enumerate}
\item $f$ is an essential surjection,
\item the map $B/\mathfrak m_B^2 \to A/\mathfrak m_A^2$ is an essential
surjection, and
\item the map
$B/(\mathfrak m_\Lambda B + \mathfrak m_B^2) \to
A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)$ is an essential surjection.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (3). Let $C \to B$ be a ring map in $\mathcal{C}_\Lambda$ such
that $C \to A$ is surjective. Then
$C \to A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)$ is surjective
too. We conclude that $C \to B/(\mathfrak m_\Lambda B + \mathfrak m_B^2)$
is surjective by our assumption. Hence $C \to B$ is surjective by applying
Lemma \ref{lemma-surjective} (2 times).

\medskip\noindent
Assume (1). Let $C \to B/(\mathfrak m_\Lambda B + \mathfrak m_B^2)$
be a morphism of $\mathcal{C}_\Lambda$ such that
$C \to A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)$ is surjective. Set
$C' = C \times_{B/(\mathfrak m_\Lambda B + \mathfrak m_B^2)} B$
which is an object of $\mathcal{C}_\Lambda$ by
Lemma \ref{lemma-fiber-product-CLambda}.
Note that $C' \to A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)$
is still surjective, hence $C' \to A$ is surjective by
Lemma \ref{lemma-surjective}.
Thus $C' \to B$ is surjective by our assumption. This implies
that $C' \to B/(\mathfrak m_\Lambda B + \mathfrak m_B^2)$ is
surjective, which implies by the construction of $C'$ that
$C \to B/(\mathfrak m_\Lambda B + \mathfrak m_B^2)$ is surjective.

\medskip\noindent
In the first paragraph we proved (3) $\Rightarrow$ (1) and in the second
paragraph we proved (1) $\Rightarrow$ (3). The equivalence of
(2) and (3) is a special case of the equivalence of (1) and (3), hence
we are done.
\end{proof}

\noindent
To analyze essential surjections in $\mathcal{C}_\Lambda$ a bit more
we introduce some notation. Suppose that $A$ is an object
of $\mathcal{C}_\Lambda$ or more generally any $\Lambda$-algebra
equipped with a $\Lambda$-algebra surjection $A \to k$.
There is a canonical exact sequence
\begin{equation}
\label{equation-sequence}
\mathfrak m_A/\mathfrak m_A^2 \xrightarrow{\text{d}_A}
\Omega_{A/\Lambda} \otimes_A k \to
\Omega_{k/\Lambda} \to 0
\end{equation}
see
Algebra, Lemma \ref{algebra-lemma-differential-seq}.
Note that $\Omega_{k/\Lambda} = \Omega_{k/k'}$ with $k'$ as
in (\ref{equation-k-prime}). Let $H_1(L_{k/\Lambda})$
be the first homology module of the naive cotangent complex of $k$
over $\Lambda$, see
Algebra, Definition \ref{algebra-definition-naive-cotangent-complex}.
Then we can extend (\ref{equation-sequence})
to the exact sequence
\begin{equation}
\label{equation-sequence-extended}
H_1(L_{k/\Lambda}) \to
\mathfrak m_A/\mathfrak m_A^2 \xrightarrow{\text{d}_A}
\Omega_{A/\Lambda} \otimes_A k \to
\Omega_{k/\Lambda} \to 0,
\end{equation}
see
Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL}.
If $B \to A$ is a ring map in $\mathcal{C}_\Lambda$
or more generally a map of $\Lambda$-algebras equipped
with $\Lambda$-algebra surjections onto $k$, then we obtain a
commutative diagram
\begin{equation}
\label{equation-sequence-functorial}
\vcenter{
\xymatrix{
H_1(L_{k/\Lambda}) \ar[r] \ar@{=}[d] &
\mathfrak m_B/\mathfrak m_B^2 \ar[r]_{\text{d}_B} \ar[d] &
\Omega_{B/\Lambda} \otimes_B k \ar[r] \ar[d] &
\Omega_{k/\Lambda} \ar[r] \ar@{=}[d] & 0 \\
H_1(L_{k/\Lambda}) \ar[r] &
\mathfrak m_A/\mathfrak m_A^2 \ar[r]^{\text{d}_A} &
\Omega_{A/\Lambda} \otimes_A k \ar[r] &
\Omega_{k/\Lambda} \ar[r] & 0
}
}
\end{equation}
with exact rows.

\begin{lemma}
\label{lemma-H1-separable-case}
There is a canonical map
$$
\mathfrak m_\Lambda/\mathfrak m_\Lambda^2 \longrightarrow H_1(L_{k/\Lambda}).
$$
If $k' \subset k$ is separable (for example if the characteristic
of $k$ is zero), then this map induces an isomorphism
$\mathfrak m_\Lambda/\mathfrak m_\Lambda^2 \otimes_{k'} k = H_1(L_{k/\Lambda})$.
If $k = k'$ (for example in the classical case), then
$\mathfrak m_\Lambda/\mathfrak m_\Lambda^2 = H_1(L_{k/\Lambda})$.
The composition
$$
\mathfrak m_\Lambda/\mathfrak m_\Lambda^2 \longrightarrow
H_1(L_{k/\Lambda}) \longrightarrow \mathfrak m_A/\mathfrak m_A^2
$$
comes from the canonical map $\mathfrak m_\Lambda \to \mathfrak m_A$.
\end{lemma}

\begin{proof}
Note that $H_1(L_{k'/\Lambda}) = \mathfrak m_\Lambda/\mathfrak m_\Lambda^2$
as $\Lambda \to k'$ is surjective with kernel $\mathfrak m_\Lambda$.
The map arises from functoriality of the naive cotangent complex.
If $k' \subset k$ is separable, then $k' \to k$ is an \'etale ring map, see
Algebra, Lemma \ref{algebra-lemma-etale-over-field}.
Thus its naive cotangent complex has trivial homology groups, see
Algebra, Definition \ref{algebra-definition-etale}.
Then
Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL}
applied to the ring maps $\Lambda \to k' \to k$ implies that
$\mathfrak m_\Lambda/\mathfrak m_\Lambda^2 \otimes_{k'} k = H_1(L_{k/\Lambda})$.
We omit the proof of the final statement.
\end{proof}

\begin{lemma}
\label{lemma-essential-surjection}
Let $f: B \to A$ be a ring map in $\mathcal{C}_\Lambda$.
Notation as in (\ref{equation-sequence-functorial}).
\begin{enumerate}
\item The equivalent conditions of
Lemma \ref{lemma-essential-surjection-mod-squares}
characterizing when $f$ is surjective are also equivalent to
\begin{enumerate}
\item $\Im(\text{d}_B) \to \Im(\text{d}_A)$ is surjective, and
\item the map $\Omega_{B/\Lambda} \otimes_B k \to
\Omega_{A/\Lambda} \otimes_A k$ is surjective.
\end{enumerate}
\item The following are equivalent
\begin{enumerate}
\item $f$ is an essential surjection,
\item the map $\Im(\text{d}_B) \to \Im(\text{d}_A)$ is an
isomorphism, and
\item the map $\Omega_{B/\Lambda} \otimes_B k \to
\Omega_{A/\Lambda} \otimes_A k$ is an isomorphism.
\end{enumerate}
\item If $k/k'$ is separable, then $f$ is an essential surjection if
and only if the map
$\mathfrak m_B/(\mathfrak m_\Lambda B + \mathfrak m_B^2) \to
\mathfrak m_A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)$
is an isomorphism.
\item If $f$ is a small extension, then $f$ is not essential if and only if
$f$ has a section $s: A \to B$ in $\mathcal{C}_\Lambda$
with $f \circ s = \text{id}_A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). It follows from (\ref{equation-sequence-functorial})
that (1)(a) and (1)(b) are equivalent. Also, if
$A \to B$ is surjective, then (1)(a) and (1)(b) hold. Assume (1)(a).
Since the kernel of $\text{d}_A$ is the image of
$H_1(L_{k/\Lambda})$ which also maps to
$\mathfrak m_B/\mathfrak m_B^2$ we conclude that
$\mathfrak m_B/\mathfrak m_B^2 \to \mathfrak m_A/\mathfrak m_A^2$
is surjective. Hence $B \to A$ is surjective by
Lemma \ref{lemma-surjective}. This finishes the proof of (1).

\medskip\noindent
Proof of (2). The equivalence of (2)(b) and (2)(c) is immediate from
(\ref{equation-sequence-functorial}).

\medskip\noindent
Assume (2)(b). Let $g : C \to B$ be a ring map in $\mathcal{C}_\Lambda$
such that $f \circ g$ is surjective. We conclude that
$\mathfrak m_C/\mathfrak m_C^2 \to \mathfrak m_A/\mathfrak m_A^2$
is surjective by
Lemma \ref{lemma-surjective}.
Hence
$\Im(\text{d}_C) \to \Im(\text{d}_A)$ is surjective
and by the assumption we see that
$\Im(\text{d}_C) \to \Im(\text{d}_B)$ is surjective.
It follows that $C \to B$ is surjective by (1).

\medskip\noindent
Assume (2)(a). Then $f$ is surjective and we see that
$\Omega_{B/\Lambda} \otimes_B k \to \Omega_{A/\Lambda} \otimes_A k$
is surjective. Let $K$ be the kernel. Note that
$K = \text{d}_B(\Ker(\mathfrak m_B/\mathfrak m_B^2 \to
\mathfrak m_A/\mathfrak m_A^2))$ by (\ref{equation-sequence-functorial}).
Choose a splitting
$$
\Omega_{B/\Lambda} \otimes_B k =
\Omega_{A/\Lambda} \otimes_A k \oplus K
$$
of $k$-vector space. The map $\text{d} : B \to \Omega_{B/\Lambda}$
induces via the projection onto $K$ a map $D : B \to K$. Set
$C = \{b \in B \mid D(b) = 0\}$. The Leibniz rule shows that this is
a $\Lambda$-subalgebra of $B$. Let $\overline{x} \in k$. Choose $x \in B$
mapping to $\overline{x}$. If $D(x) \not = 0$, then we can find an element
$y \in \mathfrak m_B$ such that $D(y) = D(x)$. Hence $x - y \in C$ is
an element which maps to $\overline{x}$. Thus $C \to k$ is surjective
and $C$ is an object of $\mathcal{C}_\Lambda$. Similarly, pick
$\omega \in \Im(\text{d}_A)$. We can find $x \in \mathfrak m_B$
such that $\text{d}_B(x)$ maps to $\omega$ by (1). If $D(x) \not = 0$, then
we can find an element $y \in \mathfrak m_B$ which maps to zero
in $\mathfrak m_A/\mathfrak m_A^2$ such that $D(y) = D(x)$.
Hence $z = x - y$ is an element of $\mathfrak m_C$ whose
image $\text{d}_C(z) \in \Omega_{C/k} \otimes_C k$ maps to $\omega$.
Hence $\Im(\text{d}_C) \to \Im(\text{d}_A)$ is surjective.
We conclude that $C \to A$ is surjective by (1). Hence $C \to B$ is
surjective by assumption. Hence $D = 0$, i.e., $K = 0$, i.e., (2)(c) holds.
This finishes the proof of (2).

\medskip\noindent
Proof of (3). If $k'/k$ is separable, then
$H_1(L_{k/\Lambda}) =
\mathfrak m_\Lambda/\mathfrak m_\Lambda^2 \otimes_{k'} k$, see
Lemma \ref{lemma-H1-separable-case}.
Hence $\Im(\text{d}_A) =
\mathfrak m_A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)$
and similarly for $B$. Thus (3) follows from (2).

\medskip\noindent
Proof of (4). A section $s$ of $f$ is not surjective (by definition a
small extension has nontrivial kernel), hence $f$ is not essentially
surjective. Conversely, assume $f$ is a small extension but not an
essential surjection. Choose a ring map $C \to B$ in $\mathcal{C}_\Lambda$
which is not surjective, such that $C \to A$ is surjective. Let
$C' \subset B$ be the image of $C \to B$. Then $C' \not = B$ but
$C'$ surjects onto $A$. Since $f : B \to A$ is a small extension,
$\text{length}_C(B) = \text{length}_C(A) + 1$. Thus
$\text{length}_C(C') \leq \text{length}_C(A)$ since
$C'$ is a proper subring of $B$. But $C' \to A$ is surjective, so in
fact we must have $\text{length}_C(C') = \text{length}_C(A)$ and
$C' \to A$ is an isomorphism which gives us our section.
\end{proof}

\begin{example}
\label{example-essential-surjection}
Let $\Lambda = k[[x]]$ be the power series ring in $1$ variable over $k$.
Set $A = k$ and $B = \Lambda/(x^2)$. Then $B \to A$ is an essential
surjection by
Lemma \ref{lemma-essential-surjection}
because it is a small extension and the map $B \to A$ does not have a
right inverse (in the category $\mathcal{C}_\Lambda$). But the map
$$
k \cong \mathfrak m_B/\mathfrak m_B^2
\longrightarrow
\mathfrak m_A/\mathfrak m_A^2 = 0
$$
is not an isomorphism. Thus in
Lemma \ref{lemma-essential-surjection} (3)
it is necessary to consider the map of relative cotangent spaces
$\mathfrak m_B/(\mathfrak m_\Lambda B + \mathfrak m_B^2) \to
\mathfrak m_A/(\mathfrak m_\Lambda A + \mathfrak m_A^2)$.
\end{example}







\section{The completed base category}
\label{section-category-completion-CLambda}

\noindent
The following ``completion'' of the category $\mathcal{C}_\Lambda$ will serve
as the base category of the completion of a category cofibered in groupoids
over $\mathcal{C}_\Lambda$
(Section \ref{section-formal-objects}).

\begin{definition}
\label{definition-completion-CLambda}
Let $\Lambda$ be a Noetherian ring and let $\Lambda \to k$ be a finite
ring map where $k$ is a field. We define {\it $\widehat{\mathcal{C}}_\Lambda$}
to be the category with
\begin{enumerate}
\item objects are pairs $(R, \varphi)$ where $R$ is a Noetherian complete
local $\Lambda$-algebra and where $\varphi : R/\mathfrak m_R \to k$ is a
$\Lambda$-algebra isomorphism, and
\item morphisms $f : (S, \psi) \to (R, \varphi)$ are local $\Lambda$-algebra
homomorphisms such that $\varphi \circ (f \bmod \mathfrak m) = \psi$.
\end{enumerate}
\end{definition}

\noindent
As in the discussion following
Definition \ref{definition-CLambda}
we will usually denote an object of $\widehat{\mathcal{C}}_\Lambda$
simply $R$, with the identification $R/\mathfrak m_R = k$ understood.
In this section we discuss some basic properties of objects and morphisms
of the category $\widehat{\mathcal{C}}_\Lambda$ paralleling our discussion of
the category $\mathcal{C}_\Lambda$ in the previous section.

\medskip\noindent
Our first observation is that any object $A \in \mathcal{C}_\Lambda$
is an object of $\widehat{\mathcal{C}}_\Lambda$ as an Artinian local
ring is always Noetherian and complete with respect to its maximal ideal
(which is after all a nilpotent ideal). Moreover, it is clear from the
definitions that
$\mathcal{C}_\Lambda \subset \widehat{\mathcal{C}}_\Lambda$
is the strictly full subcategory consisting of all Artinian rings.
As it turns out, conversely every object of
$\widehat{\mathcal{C}}_\Lambda$ is a limit of objects of
$\mathcal{C}_\Lambda$.

\medskip\noindent
Suppose that $R$ is an object of $\widehat{\mathcal{C}}_\Lambda$.
Consider the rings $R_n = R/\mathfrak m_R^n$ for $n \in \mathbf{N}$.
These are Noetherian local rings with a unique nilpotent prime ideal, hence
Artinian, see
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}.
The ring maps
$$
\ldots \to R_{n + 1} \to R_n \to \ldots \to R_2 \to R_1 = k
$$
are all surjective. Completeness of $R$ by definition means
that $R = \lim R_n$. If $f : R \to S$ is a ring map in
$\widehat{\mathcal{C}}_\Lambda$ then we obtain a system of ring maps
$f_n : R_n \to S_n$ whose limit is the given map.

\begin{lemma}
\label{lemma-surjective-cotangent-space}
Let $f: R \to S$ be a ring map in $\widehat{\mathcal{C}}_\Lambda$.
The following are equivalent
\begin{enumerate}
\item $f$ is surjective,
\item the map
$\mathfrak m_R/\mathfrak m_R^2 \to \mathfrak m_S/\mathfrak m_S^2$
is surjective, and
\item the map
$\mathfrak m_R/(\mathfrak m_\Lambda R + \mathfrak m_R^2) \to
\mathfrak m_S/(\mathfrak m_\Lambda S + \mathfrak m_S^2)$
is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that for $n \geq 2$ we have the equality of relative cotangent spaces
$$
\mathfrak m_R/(\mathfrak m_\Lambda R + \mathfrak m_R^2)
=
\mathfrak m_{R_n}/(\mathfrak m_\Lambda R_n + \mathfrak m_{R_n}^2)
$$
and similarly for $S$. Hence by
Lemma \ref{lemma-surjective}
we see that $R_n \to S_n$ is surjective for all $n$.
Now let $K_n$ be the kernel of $R_n \to S_n$.  Then the sequences
$$
0 \to K_n \to R_n \to S_n \to 0
$$
form an exact sequence of directed inverse systems. The system $(K_n)$ is
Mittag-Leffler since each $K_n$ is Artinian. Hence by
Algebra, Lemma \ref{algebra-lemma-ML-exact-sequence}
taking limits preserves exactness. So
$\lim R_n \to \lim S_n$ is surjective, i.e., $f$ is surjective.
\end{proof}

\begin{lemma}
\label{lemma-CLambdahat-pushouts}
The category $\widehat{\mathcal{C}}_\Lambda$ admits pushouts.
\end{lemma}

\begin{proof}
Let $R \to S_1$ and $R \to S_2$ be morphisms of
$\widehat{\mathcal{C}}_\Lambda$. Consider the ring
$C = S_1 \otimes_R S_2$.
This ring has a finitely generated maximal ideal
$\mathfrak m = \mathfrak m_{S_1} \otimes S_2 +
S_1 \otimes \mathfrak m_{S_2}$ with residue field $k$.
Set $C^\wedge$ equal to the completion of $C$ with respect to $\mathfrak m$.
Then $C^\wedge$ is a Noetherian ring complete with respect to
the maximal ideal $\mathfrak m^\wedge = \mathfrak mC^\wedge$
whose residue field is identified with $k$, see
Algebra, Lemma \ref{algebra-lemma-completion-Noetherian}.
Hence $C^\wedge$ is an object of $\widehat{\mathcal{C}}_\Lambda$.
Then $S_1 \to C^\wedge$ and $S_2 \to C^\wedge$ turn $C^\wedge$
into a pushout over $R$ in $\widehat{\mathcal{C}}_\Lambda$ (details omitted).
\end{proof}

\noindent
We will not need the following lemma.

\begin{lemma}
\label{lemma-CLambdahat-coproducts}
The category $\widehat{\mathcal{C}}_\Lambda$ admits coproducts
of pairs of objects.
\end{lemma}

\begin{proof}
Let $R$ and $S$ be objects of $\widehat{\mathcal{C}}_\Lambda$.
Consider the ring $C = R \otimes_\Lambda S$. There is a canonical
surjective map $C \to R \otimes_\Lambda S \to k \otimes_\Lambda k \to k$
where the last map is the multiplication map. The kernel of
$C \to k$ is a maximal ideal $\mathfrak m$. Note that $\mathfrak m$
is generated by $\mathfrak m_R C$, $\mathfrak m_S C$ and finitely many
elements of $C$ which map to generators of the kernel of
$k \otimes_\Lambda k \to k$. Hence $\mathfrak m$ is a finitely
generated ideal. Set
$C^\wedge$ equal to the completion of $C$ with respect to $\mathfrak m$.
Then $C^\wedge$ is a Noetherian ring complete with respect to
the maximal ideal $\mathfrak m^\wedge = \mathfrak mC^\wedge$
with residue field $k$, see
Algebra, Lemma \ref{algebra-lemma-completion-Noetherian}.
Hence $C^\wedge$ is an object of $\widehat{\mathcal{C}}_\Lambda$.
Then $R \to C^\wedge$ and $S \to C^\wedge$ turn $C^\wedge$
into a coproduct in $\widehat{\mathcal{C}}_\Lambda$ (details omitted).
\end{proof}

\noindent
An empty coproduct in a category is an initial object of the category.
In the classical case $\widehat{\mathcal{C}}_\Lambda$ has an initial
object, namely $\Lambda$ itself. More generally, if $k' = k$, then
the completion $\Lambda^\wedge$ of $\Lambda$ with respect to
$\mathfrak m_\Lambda$ is an initial object. More generally still, if
$k' \subset k$ is separable, then $\widehat{\mathcal{C}}_\Lambda$ has an
initial object too. Namely, choose a monic polynomial $P \in \Lambda[T]$
such that $k \cong k'[T]/(P')$ where $p' \in k'[T]$ is the image
of $P$. Then $R = \Lambda^\wedge[T]/(P)$ is an initial object, see proof of
Lemma \ref{lemma-fiber-product-CLambda}.

\medskip\noindent
If $R$ is an initial object as above, then we have
$\mathcal{C}_\Lambda = \mathcal{C}_R$ and
$\widehat{\mathcal{C}}_\Lambda = \widehat{\mathcal{C}}_R$ which effectively
brings the whole discussion in this chapter back to the classical case.
But, if $k' \subset k$ is inseparable, then an initial object does not
exist.

\begin{lemma}
\label{lemma-derivations-finite}
Let $S$ be an object of $\widehat{\mathcal{C}}_\Lambda$.
Then $\dim_k \text{Der}_\Lambda(S, k) < \infty$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n \in \mathfrak m_S$ map to a $k$-basis
for the relative cotangent space
$\mathfrak m_S/(\mathfrak m_\Lambda S + \mathfrak m_S^2)$.
Choose $y_1, \ldots, y_m \in S$ whose images in $k$ generate $k$
over $k'$. We claim that $\dim_k \text{Der}_\Lambda(S, k) \leq n + m$.
To see this it suffices to prove that if $D(x_i) = 0$ and
$D(y_j) = 0$, then $D = 0$. Let $a \in S$. We can find a
polynomial $P = \sum \lambda_J y^J$ with $\lambda_J \in \Lambda$
whose image in $k$ is the same as the image of $a$ in $k$.
Then we see that $D(a - P) = D(a) - D(P) = D(a)$ by our assumption
that $D(y_j) = 0$ for all $j$. Thus we may assume $a \in \mathfrak m_S$.
Write $a = \sum a_i x_i$ with $a_i \in S$. By the Leibniz rule
$$
D(a) = \sum x_iD(a_i) + \sum a_iD(x_i) = \sum x_iD(a_i)
$$
as we assumed $D(x_i) = 0$. We have $\sum x_iD(a_i) = 0$
as multiplication by $x_i$ is zero on $k$.
\end{proof}

\begin{lemma}
\label{lemma-derivations-surjective}
Let $f : R \to S$ be a morphism of $\widehat{\mathcal{C}}_\Lambda$.
If $\text{Der}_\Lambda(S, k) \to \text{Der}_\Lambda(R, k)$ is injective,
then $f$ is surjective.
\end{lemma}

\begin{proof}
If $f$ is not surjective, then
$\mathfrak m_S/(\mathfrak m_R S + \mathfrak m_S^2)$ is nonzero by
Lemma \ref{lemma-surjective-cotangent-space}.
Then also $Q = S/(f(R) + \mathfrak m_R S + \mathfrak m_S^2)$ is nonzero.
Note that $Q$ is a $k = R/\mathfrak m_R$-vector space via $f$. We turn
$Q$ into an $S$-module via $S \to k$. The quotient
map $D : S \to Q$ is an $R$-derivation: if $a_1, a_2 \in S$, we can write
$a_1 = f(b_1) + a_1'$ and $a_2 = f(b_2) + a_2'$ for some
$b_1, b_2 \in R$ and $a_1', a_2' \in \mathfrak m_S$. Then
$b_i$ and $a_i$ have the same image in $k$ for $i = 1, 2$ and
\begin{align*}
a_1a_2 & = (f(b_1) + a_1')(f(b_2) + a_2') \\
& = f(b_1)a_2' + f(b_2)a_1' \\
& = f(b_1)(f(b_2) + a_2') + f(b_2)(f(b_1) + a_1') \\
& = f(b_1)a_2 + f(b_2)a_1
\end{align*}
in $Q$ which proves the Leibniz rule. Hence $D : S \to Q$ is a
$\Lambda$-derivation which is zero on composing with $R \to S$.
Since $Q \not = 0$ there also exist derivations $D : S \to k$ which
are zero on composing with $R \to S$, i.e.,
$\text{Der}_\Lambda(S, k) \to \text{Der}_\Lambda(R, k)$ is not injective.
\end{proof}

\begin{lemma}
\label{lemma-m-adic-topology}
Let $R$ be an object of $\widehat{\mathcal{C}}_\Lambda$. Let $(J_n)$ be a
decreasing sequence of ideals such that $\mathfrak m_R^n \subset J_n$.
Set $J = \bigcap J_n$. Then the sequence $(J_n/J)$ defines the
$\mathfrak m_{R/J}$-adic topology on $R/J$.
\end{lemma}

\begin{proof}
It is clear that $\mathfrak m_{R/J}^n \subset J_n/J$. Thus it suffices
to show that for every $n$ there exists an $N$ such that
$J_N/J \subset \mathfrak m_{R/J}^n$. This is equivalent to
$J_N \subset \mathfrak m_R^n + J$. For each $n$ the ring $R/\mathfrak m_R^n$
is Artinian, hence there exists a $N_n$ such that
$$
J_{N_n} + \mathfrak m_R^n = J_{N_n + 1} + \mathfrak m_R^n = \ldots
$$
Set $E_n = (J_{N_n} + \mathfrak m_R^n)/\mathfrak m_R^n$.
Set $E = \lim E_n \subset \lim R/\mathfrak m_R^n = R$.
Note that $E \subset J$ as for any $f \in E$ and any $m$
we have $f \in J_m + \mathfrak m_R^n$ for all $n \gg 0$, so
$f \in J_m$ by Artin-Rees, see
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero}.
Since the transition maps $E_n \to E_{n - 1}$ are all surjective,
we see that $J$ surjects onto $E_n$. Hence for $N = N_n$ works.
\end{proof}

\begin{lemma}
\label{lemma-limit-artinian}
Let $\ldots \to A_3 \to A_2 \to A_1$ be a sequence of surjective
ring maps in $\mathcal{C}_\Lambda$. If
$\dim_k (\mathfrak m_{A_n}/\mathfrak m_{A_n}^2)$ is bounded, then
$S = \lim A_n$ is an object in $\widehat{\mathcal{C}}_\Lambda$
and the ideals $I_n = \Ker(S \to A_n)$ define the
$\mathfrak m_S$-adic topology on $S$.
\end{lemma}

\begin{proof}
We will use freely that the maps $S \to A_n$ are surjective for all $n$.
Note that the maps
$\mathfrak m_{A_{n + 1}}/\mathfrak m_{A_{n + 1}}^2 \to
\mathfrak m_{A_n}/\mathfrak m_{A_n}^2$ are surjective, see
Lemma \ref{lemma-surjective-cotangent-space}.
Hence for $n$ sufficiently large the dimension
$\dim_k (\mathfrak m_{A_n}/\mathfrak m_{A_n}^2)$ stabilizes to an
integer, say $r$.
Thus we can find $x_1, \ldots, x_r \in \mathfrak m_S$ whose images in
$A_n$ generate $\mathfrak m_{A_n}$. Moreover, pick $y_1, \ldots, y_t \in S$
whose images in $k$ generate $k$ over $\Lambda$. Then we get a ring map
$P = \Lambda[z_1, \ldots, z_{r + t}] \to S$, $z_i \mapsto x_i$ and
$z_{r + j} \mapsto y_j$ such that the composition
$P \to S \to A_n$ is surjective for all $n$. Let $\mathfrak m \subset P$
be the kernel of $P \to k$. Let $R = P^\wedge$ be the $\mathfrak m$-adic
completion of $P$; this is an object of $\widehat{\mathcal{C}}_\Lambda$.
Since we still have the compatible system of (surjective) maps $R \to A_n$
we get a map $R \to S$. Set $J_n = \Ker(R \to A_n)$.
Set $J = \bigcap J_n$. By
Lemma \ref{lemma-m-adic-topology}
we see that $R/J = \lim R/J_n = \lim A_n = S$
and that the ideals $J_n/J = I_n$ define the $\mathfrak m$-adic topology.
(Note that for each $n$ we have $\mathfrak m_R^{N_n} \subset J_n$ for
some $N_n$ and not necessarily $N_n = n$, so a renumbering of the ideals
$J_n$ may be necessary before applying the lemma.)
\end{proof}

\begin{lemma}
\label{lemma-power-series}
Let $R', R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$. Suppose that
$R = R' \oplus I$ for some ideal $I$ of $R$. Let $x_1, \ldots, x_r \in I$
map to a basis of $I/\mathfrak m_R I$. Set $S = R'[[X_1, \ldots, X_r]]$
and consider the $R'$-algebra map $S \to R$ mapping $X_i$ to $x_i$.
Assume that for every $n \gg 0$ the map
$S/\mathfrak m_S^n \to R/\mathfrak m_R^n$ has a left inverse in
$\mathcal{C}_\Lambda$. Then $S \to R$ is an isomorphism.
\end{lemma}

\begin{proof}
As $R = R' \oplus I$ we have
$$
\mathfrak m_R/\mathfrak m_R^2 =
\mathfrak m_{R'}/\mathfrak m_{R'}^2 \oplus I/\mathfrak m_RI
$$
and similarly
$$
\mathfrak m_S/\mathfrak m_S^2 =
\mathfrak m_{R'}/\mathfrak m_{R'}^2 \oplus \bigoplus kX_i
$$
Hence for $n > 1$ the map $S/\mathfrak m_S^n \to R/\mathfrak m_R^n$
induces an isomorphism on cotangent spaces. Thus a left inverse
$h_n : R/\mathfrak m_R^n \to S/\mathfrak m_S^n$ is surjective by
Lemma \ref{lemma-surjective-cotangent-space}.
Since $h_n$ is injective as a left inverse it is an isomorphism.
Thus the canonical surjections $S/\mathfrak m_S^n \to R/\mathfrak m_R^n$
are all isomorphisms and we win.
\end{proof}




\section{Categories cofibered in groupoids}
\label{section-preliminary}

\noindent
In developing the theory we work with categories {\it cofibered} in groupoids.
 We assume as known the definition and basic properties of categories
{\it fibered} in groupoids, see
Categories, Section \ref{categories-section-fibred-groupoids}.

\begin{definition}
\label{definition-category-cofibred-groupoids}
Let $\mathcal{C}$ be a category.  A {\it category cofibered in groupoids over
$\mathcal{C}$} is a category $\mathcal{F}$ equipped with a functor
$p: \mathcal{F} \to \mathcal{C}$ such that $\mathcal{F}^{opp}$ is a category
fibered in groupoids over $\mathcal{C}^{opp}$ via
$p^{opp}: \mathcal{F}^{opp} \to \mathcal{C}^{opp}$.
\end{definition}

\noindent
Explicitly, $p: \mathcal{F} \to \mathcal{C}$ is cofibered in groupoids if
the following two conditions hold:
\begin{enumerate}
\item For every morphism $f: U \to V$ in $\mathcal{C}$ and every object
$x$ lying over $U$, there is a morphism $x \to y$ of $\mathcal{F}$ lying
over $f$.
\item For every pair of morphisms $a: x \to y$ and $b: x \to z$
of $\mathcal{F}$ and any morphism $f: p(y) \to p(z)$ such that $p(b) = f
\circ p(a)$, there exists a unique morphism $c: y \to z$ of $\mathcal
F$ lying over $f$ such that $b = c \circ a$.
\end{enumerate}

\begin{remarks}
\label{remarks-cofibered-groupoids}
Everything about categories fibered in groupoids translates directly to the
cofibered setting. The following remarks are meant to fix notation.
Let $\mathcal{C}$ be a category.
\begin{enumerate}
\item We often omit the functor $p: \mathcal{F} \to \mathcal{C}$ from the
notation.
\item The fiber category over an object $U$ in $\mathcal{C}$ is denoted by
$\mathcal{F}(U)$. Its objects are those of $\mathcal{F}$ lying over $U$ and its
morphisms are those of $\mathcal{F}$ lying over $\text{id}_U$.
If $x, y$  are objects of $\mathcal{F}(U)$, we sometimes write
$\Mor_U(x, y)$ for $\Mor_{\mathcal{F}(U)}(x, y)$.
\item The fibre categories $\mathcal{F}(U)$ are groupoids, see
Categories, Lemma \ref{categories-lemma-fibred-groupoids}.
Hence the morphisms in $\mathcal{F}(U)$ are all isomorphisms.
We sometimes write $\text{Aut}_U(x)$ for $\Mor_{\mathcal{F}(U)}(x, x)$.
\item
\label{item-pushforward}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}$, let $f: U \to V$ be a morphism in $\mathcal{C}$, and
let $x \in \Ob(\mathcal{F}(U))$.
A {\it pushforward} of $x$ along $f$ is a morphism
$x \to y$ of $\mathcal{F}$ lying over $f$. A pushforward
is unique up to unique isomorphism (see the discussion following
Categories, Definition \ref{categories-definition-cartesian-over-C}).
We sometimes write $x \to f_*x$ for ``the'' pushforward of $x$
along $f$.
\item A {\it choice of pushforwards for $\mathcal{F}$} is the choice of
a pushforward of $x$ along $f$ for every pair $(x, f)$ as above. We can make
such a choice of pushforwards for $\mathcal{F}$ by the axiom of choice.
\item Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}$. Given a choice of pushforwards for $\mathcal{F}$, there
is an associated pseudo-functor $\mathcal{C} \to \textit{Groupoids}$.
We will never use this construction so we give no details.
\item
\label{item-cofibered-morphism}
A morphism of categories cofibered in groupoids over $\mathcal{C}$ is a
functor commuting with the projections to $\mathcal{C}$. If $\mathcal{F}$
and $\mathcal{F}'$ are categories cofibered in groupoids over
$\mathcal{C}$, we denote the morphisms from $\mathcal{F}$ to $\mathcal{F}'$
by $\Mor_\mathcal{C}(\mathcal{F}, \mathcal{F}')$.
\item
\label{item-definition-cofibered-groupoids-2-category}
Categories cofibered in groupoids form a $(2, 1)$-category
$\text{Cof}(\mathcal{C})$. Its 1-morphisms are the morphisms described in
(\ref{item-cofibered-morphism}). If $p : \mathcal{F} \to C$ and
$p': \mathcal{F}' \to \mathcal{C}$ are categories cofibered in groupoids
and $\varphi, \psi : \mathcal{F} \to \mathcal{F}'$ are $1$-morphisms, then
a 2-morphism $t : \varphi \to \psi$ is a morphism of functors such that
$p'(t_x) = \text{id}_{p(x)}$ for all $x \in \Ob(\mathcal{F})$.
\item
\label{item-construction-associated-cofibered-groupoid}
Let $F : \mathcal{C} \to \textit{Groupoids}$ be a functor. There
is a category cofibered in groupoids $\mathcal{F} \to \mathcal{C}$
associated to $F$ as follows. An object of $\mathcal{F}$ is a pair $(U, x)$
where $U \in \Ob(\mathcal{C})$ and $x \in \Ob(F(U))$. A
morphism $(U, x) \to (V, y)$ is a pair $(f, a)$ where
$f \in \Mor_\mathcal{C}(U, V)$ and
$a \in \Mor_{F(V)}(F(f)(x), y)$.
The functor $\mathcal{F} \to \mathcal{C}$ sends $(U, x)$ to $U$. See
Categories, Section \ref{categories-section-presheaves-groupoids}.
\item
\label{item-associated-functor-isomorphism-classes}
Let $\mathcal{F}$ be cofibered in groupoids over $\mathcal{C}$.
For $U \in \Ob(\mathcal{C})$ set $\overline{\mathcal{F}}(U)$ equal to
the set of isomorphisms classes of the category $\mathcal{F}(U)$.
If $f : U \to V$ is a morphism of $\mathcal{C}$, then we obtain a
map of sets $\overline{\mathcal{F}}(U) \to \overline{\mathcal{F}}(V)$ by
mapping the isomorphism class of $x$ to the isomorphism class of a pushforward
$f_*x$ of $x$ see (\ref{item-pushforward}). Then
$\overline{\mathcal{F}} : \mathcal{C} \to \textit{Sets}$ is a
functor. Similarly, if $\varphi : \mathcal{F} \to \mathcal{G}$ is a
morphism of cofibered categories, we denote by
$\overline{\varphi}: \overline{\mathcal{F}} \to  \overline{\mathcal{G}}$
the associated morphism of functors.
\item
\label{item-convention-cofibered-sets}
Let $F: \mathcal{C} \to \textit{Sets}$ be a functor. We can think of a
set as a discrete category, i.e., as a groupoid with only identity morphisms.
Then the construction (\ref{item-construction-associated-cofibered-groupoid})
associates to $F$ a category cofibered in sets. This defines a fully
faithful embedding of the category of functors $\mathcal{C} \to \textit{Sets}$
to the category of categories cofibered in groupoids over $\mathcal{C}$.
We identify the category of functors with its image under this embedding.
Hence if $F : \mathcal{C} \to \textit{Sets}$ is a functor, we denote the
associated category cofibered in sets also by $F$; and if
$\varphi : F \to G$ is a morphism of functors, we denote still by $\varphi$
the corresponding morphism of categories cofibered in sets, and vice-versa.
See Categories, Section \ref{categories-section-fibred-in-sets}.
\item
\label{item-definition-yoneda}
Let $U$ be an object of $\mathcal{C}$.  We write $\underline{U}$ for the
functor
$\Mor_\mathcal{C}(U, -): \mathcal{C} \to
\textit{Sets}$.  This defines a fully faithful embedding of $\mathcal
C^{opp}$ into the category of functors $\mathcal{C} \to
\textit{Sets}$. Hence, if $f : U \to V$ is a morphism, we are
justified in denoting still by $f$ the induced morphism $\underline{V}
\to \underline{U}$, and vice-versa.
\item
\label{item-fibre-product}
Fiber products of categories cofibered in groupoids: If $\mathcal{F}
\to \mathcal{H}$ and $\mathcal{G} \to \mathcal{H}$ are morphisms
of categories cofibered in groupoids over $\mathcal{C}_\Lambda$, then a
construction of their 2-fiber product is given by the construction for their
2-fiber product as categories over $\mathcal{C}_\Lambda$, as described in
Categories, Lemma \ref{categories-lemma-2-product-categories-over-C}.
\item
\label{item-product}
Products of categories cofibered in groupoids: If $\mathcal{F}$ and
$\mathcal{G}$ are categories cofibered in groupoids over
$\mathcal{C}_\Lambda$ then their product is defined to be the $2$-fiber product
$\mathcal{F} \times_{\mathcal{C}_\Lambda} \mathcal{G}$ as described in
Categories, Lemma \ref{categories-lemma-2-product-categories-over-C}.
\item
\label{item-definition-restricting-base-category}
Restricting the base category: Let $p : \mathcal{F} \to \mathcal{C}$ be a
category cofibered in groupoids, and let $\mathcal{C}'$ be a full
subcategory of $\mathcal{C}$. The restriction $\mathcal{F}|_{\mathcal{C}'}$
is the full subcategory of $\mathcal{F}$ whose objects lie over
objects of $\mathcal{C}'$. It is a category cofibered in groupoids via
the functor
$p|_{\mathcal{C}'}: \mathcal{F}|_{\mathcal{C}'} \to \mathcal{C}'$.
\end{enumerate}
\end{remarks}









\section{Prorepresentable functors and predeformation categories}
\label{section-cofibered-groupoids}

\noindent
Our basic goal is to understand categories cofibered in groupoids over
$\mathcal{C}_\Lambda$ and $\widehat{\mathcal{C}}_\Lambda$. Since
$\mathcal{C}_\Lambda$ is a full subcategory of
$\widehat{\mathcal{C}}_\Lambda$ we can restrict categories cofibred in
groupoids over $\widehat{\mathcal{C}}_\Lambda$ to $\mathcal{C}_\Lambda$, see
Remarks \ref{remarks-cofibered-groupoids}
(\ref{item-definition-restricting-base-category}).
In particular we can do this with functors, in particular with
representable functors. The functors on $\mathcal{C}_\Lambda$
one obtains in this way are called
prorepresentable functors.

\begin{definition}
\label{definition-prorepresentable}
Let $F : \mathcal{C}_\Lambda \to \textit{Sets}$ be a functor.
We say $F$ is {\it prorepresentable} if there exists an isomorphism
$F \cong \underline{R}|_{\mathcal{C}_\Lambda}$ of functors for some
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$.
\end{definition}

\noindent
Note that if $F : \mathcal{C}_\Lambda \to \textit{Sets}$ is prorepresentable
by $R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$, then
$$
F(k) = \Mor_{\widehat{\mathcal{C}}_\Lambda}(R, k) = \{*\}
$$
is a singleton. The categories cofibered in groupoids over
$\mathcal{C}_\Lambda$ that are arise in deformation theory will often satisfy
an analogous condition.

\begin{definition}
\label{definition-predeformation-category}
A {\it predeformation category} $\mathcal{F}$ is a category cofibered
in groupoids over $\mathcal{C}_\Lambda$ such that $\mathcal{F}(k)$ is
equivalent to a category with a single object and a single morphism,
i.e., $\mathcal{F}(k)$ contains at least one object and there is a
unique morphism between any two objects. A {\it morphism of predeformation
categories} is a morphism of categories cofibered in groupoids over
$\mathcal{C}_\Lambda$.
\end{definition}

\noindent
A feature of a predeformation category is the following.
Let $x_0 \in \Ob(\mathcal{F}(k))$. Then every object of
$\mathcal{F}$ comes equipped with a unique morphism to $x_0$.
Namely, if $x$ is an object of $\mathcal{F}$ over $A$, then we
can choose a pushforward $x \to q_*x$ where $q : A \to k$ is the quotient
map. There is a unique isomorphism $q_*x \to x_0$ and the composition
$x \to q_*x \to x_0$ is the desired morphism.

\begin{remark}
\label{remark-predeformation-functor}
We say that a functor $F: \mathcal{C}_\Lambda \to \textit{Sets}$
is a {\it predeformation functor} if the associated cofibered set is a
predeformation category, i.e.\ if $F(k)$ is a one element set.  Thus if
$\mathcal{F}$ is a predeformation category, then $\overline{\mathcal{F}}$ is a
predeformation functor.
\end{remark}

\begin{remark}
\label{remark-localize-cofibered-groupoid}
Let $p : \mathcal{F} \to \mathcal{C}_\Lambda$ be a category cofibered in
groupoids, and let $x \in \Ob(\mathcal{F}(k))$.  We denote by
$\mathcal{F}_x$ the category of objects over $x$.
An object of $\mathcal{F}_x$ is an arrow $y \to x$.
A morphism $(y \to x) \to (z \to x)$ in $\mathcal{F}_x$ is a commutative
diagram
$$
\xymatrix{
y \ar[rr] \ar[dr] & & z \ar[dl] \\
& x &
}
$$
There is a forgetful functor $\mathcal{F}_x \to \mathcal{F}$. We define
the functor $p_x : \mathcal{F}_x \to \mathcal{C}_\Lambda$ as the
composition
$\mathcal{F}_x \to \mathcal{F} \xrightarrow{p} \mathcal{C}_\Lambda$.
Then $p_x : \mathcal{F}_x \to \mathcal{C}_\Lambda$ is a
predeformation category (proof omitted). In this way we can pass from an
arbitrary category cofibered in groupoids over $\mathcal{C}_\Lambda$
to a predeformation category at any $x \in \Ob(\mathcal{F}(k))$.
\end{remark}






\section{Formal objects and completion categories}
\label{section-formal-objects}

\noindent
In this section we discuss how to go between categories cofibred in
groupoids over $\mathcal{C}_\Lambda$ to categories cofibred in
groupoids over $\widehat{\mathcal{C}}_\Lambda$ and vice versa.

\begin{definition}
\label{definition-formal-objects}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. The {\it category $\widehat{\mathcal{F}}$ of formal
objects of  $\mathcal{F}$} is the category with the following objects and
morphisms.
\begin{enumerate}
\item A {\it formal object $\xi = (R, \xi_n, f_n)$ of $\mathcal{F}$}
consists of an object $R$ of $\widehat{\mathcal{C}}_\Lambda$, and a collection
indexed by $n \in \mathbf{N}$ of objects $\xi_n$ of
$\mathcal{F}(R/\mathfrak m_R^n)$ and morphisms
$f_n : \xi_{n + 1} \to \xi_n$ lying over the projection
$R/\mathfrak m_R^{n + 1} \to R/\mathfrak m_R^n$.
\item Let $\xi = (R, \xi_n, f_n)$ and $\eta = (S, \eta_n, g_n)$ be
formal objects of $\mathcal{F}$.  A {\it morphism $a : \xi \to \eta$ of
formal objects} consists of a map $a_0 : R \to S$ in
$\widehat{\mathcal{C}}_\Lambda$ and a collection $a_n : \xi_n \to \eta_n$
of morphisms of $\mathcal{F}$ lying over
$R/\mathfrak m_R^n \to S/\mathfrak m_S^n$,
such that for every $n$ the diagram
$$
\xymatrix{
\xi_{n + 1} \ar[r]_{f_n} \ar[d]_{a_{n + 1}} & \xi_n \ar[d]^{a_n} \\
\eta_{n + 1} \ar[r]^{g_n} & \eta_n
}
$$
commutes.
\end{enumerate}
\end{definition}

\noindent
The category of formal objects comes with a functor $\widehat{p}:
\widehat{\mathcal{F}} \to \widehat{\mathcal{C}}_\Lambda$ which sends an
object $(R, \xi_n, f_n)$ to $R$ and a morphism
$(R, \xi_n, f_n) \to (S, \eta_n, g_n)$ to the map $R \to S$.

\begin{lemma}
\label{lemma-completion-cofibred}
Let $p : \mathcal{F} \to \mathcal{C}_\Lambda$ be a category cofibered in
groupoids. Then
$\widehat{p} : \widehat{\mathcal{F}} \to \widehat{\mathcal{C}}_\Lambda$
is a category cofibered in groupoids.
\end{lemma}

\begin{proof}
Let $R \to S$ be a ring map in $\widehat{\mathcal{C}}_\Lambda$.
Let $(R, \xi_n, f_n)$ be an object of $\widehat{\mathcal{F}}$.
For each $n$ choose a pushforward $\xi_n \to \eta_n$ of $\xi_n$
along $R/\mathfrak m_R^n \to S/\mathfrak m_S^n$. For each $n$ there
exists a unique morphism $g_n : \eta_{n + 1} \to \eta_n$ in $\mathcal{F}$
lying over $S/\mathfrak m_S^{n + 1} \to S/\mathfrak m_S^n$ such that
$$
\xymatrix{
\xi_{n + 1} \ar[d] \ar[r]_{f_n} & \xi_n \ar[d] \\
\eta_{n + 1} \ar[r]^{g_n} & \eta_n
}
$$
commutes (by the first axiom of a category cofibred in groupoids).
Hence we obtain a morphism $(R, \xi_n, f_n) \to (S, \eta_n, g_n)$
lying over $R \to S$, i.e., the first axiom of a category cofibred in
groupoids holds for $\widehat{\mathcal{F}}$. To see the second axiom
suppose that we have morphisms
$a : (R, \xi_n, f_n) \to (S, \eta_n, g_n)$ and
$b : (R, \xi_n, f_n) \to (T, \theta_n, h_n)$ in $\widehat{\mathcal{F}}$
and a morphism $c_0 : S \to T$ in $\widehat{\mathcal{C}}_\Lambda$ such that
$c_0 \circ a_0 = b_0$. By the second axiom of a category cofibred in groupoids
for $\mathcal{F}$ we obtain unique maps $c_n : \eta_n \to \theta_n$
lying over $S/\mathfrak m_S^n \to T/\mathfrak m_T^n$ such that
$c_n \circ a_n = b_n$. Setting $c = (c_n)_{n \geq 0}$ gives the desired
morphism $c : (S, \eta_n, g_n) \to (T, \theta_n, h_n)$ in
$\widehat{\mathcal{F}}$ (we omit the verification that
$h_n \circ c_{n + 1} = c_n \circ g_n$).
\end{proof}

\begin{definition}
\label{definition-completion}
Let $p : \mathcal{F} \to \mathcal{C}_\Lambda$ be a category cofibered in
groupoids. The category cofibered in groupoids
$\widehat{p} : \widehat{\mathcal  F} \to \widehat{\mathcal{C}}_\Lambda$
is called the {\it completion of $\mathcal{F}$}.
\end{definition}

\noindent
If $\mathcal{F}$ is a category cofibered in groupoids over $\mathcal
C_\Lambda$, we have defined $\widehat{\mathcal{F}}(R)$ for $R \in
\Ob(\widehat{\mathcal{C}}_\Lambda)$ in terms of the filtration of
$R$ by powers of its maximal ideal.  But suppose $\mathcal{I} = (I_n)$ is a
filtration of $R$ by ideals inducing the $\mathfrak{m}_R$-adic topology.  We
define $\widehat{\mathcal{F}}_\mathcal{I}(R)$ to be the category with the
following objects and morphisms:
\begin{enumerate}
\item An object is a collection $(\xi_n, f_n)_{n \in \mathbf{N}}$ of
objects $\xi_n$ of $\mathcal{F}(R/I_n)$ and morphisms
$f_n : \xi_{n + 1} \to \xi_n$ lying over the projections
$R/I_{n + 1} \to R/I_n$.
\item A morphism $a : (\xi_n, f_n) \to (\eta_n, g_n)$ consists of a
collection $a_n : \xi_n \to \eta_n$ of morphisms in
$\mathcal{F}(R/I_n)$, such that for every $n$ the diagram
$$
\xymatrix{
\xi_{n + 1} \ar[r]^{f_n} \ar[d]_{a_{n + 1}} & \xi_n \ar[d]^{a_n} \\
\eta_{n + 1} \ar[r]^{g_n} & \eta_n
}
$$
commutes.
\end{enumerate}

\begin{lemma}
\label{lemma-formal-objects-different-filtration}
In the situation above, $\widehat{\mathcal{F}}_\mathcal{I}(R)$ is equivalent
to the category $\widehat{\mathcal{F}}(R)$.
\end{lemma}

\begin{proof}
An equivalence
$\widehat{\mathcal{F}}_\mathcal{I}(R) \to \widehat{\mathcal{F}}(R)$
can be defined as follows.  For each $n$, let $m(n)$ be the least $m$
that $I_m \subset \mathfrak m_R^n$.  Given an object
$(\xi_n, f_n)$ of $\widehat{\mathcal{F}}_\mathcal{I}(R)$, let
$\eta_n$ be the pushforward of $\xi_{m(n)}$ along
$R/I_{m(n)} \to R/\mathfrak m_R^n$. Let $g_n : \eta_{n + 1} \to \eta_n$
be the unique morphism of $\mathcal{F}$ lying over
$R/\mathfrak m_R^{n + 1} \to R/\mathfrak m_R^n$ such that
$$
\xymatrix{
\xi_{m(n + 1)} \ar[rrr]_{f_{m(n)} \circ \ldots \circ f_{m(n + 1) - 1}} \ar[d]
& & & \xi_{m(n)} \ar[d] \\
\eta_{n + 1} \ar[rrr]^{g_n} & & & \eta_n
}
$$
commutes (existence and uniqueness is guaranteed by the axioms of a
cofibred category). The functor
$\widehat{\mathcal{F}}_\mathcal{I}(R) \to \widehat{\mathcal{F}}(R)$
sends $(\xi_n, f_n)$ to $(R, \eta_n, g_n)$. We omit the
verification that this is indeed an equivalence of categories.
\end{proof}

\begin{remark}
\label{remark-different-sequence-ideals}
Let $p : \mathcal{F} \to \mathcal{C}_\Lambda$ be a category cofibered in
groupoids. Suppose that for each
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$ we are given a filtration
$\mathcal{I}_R$ of $R$ by ideals. If
$\mathcal{I}_R$ induces the $\mathfrak m_R$-adic topology on $R$ for all $R$,
then one can define a category
$\widehat{\mathcal{F}}_\mathcal{I}$ by mimicking
the definition of $\widehat{\mathcal{F}}$. This category comes equipped with a
morphism
$\widehat{p}_\mathcal{I} : \widehat{\mathcal{F}}_\mathcal{I} \to
\widehat{\mathcal{C}}_\Lambda$ making it into a category cofibered in
groupoids such that $\widehat{\mathcal{F}}_\mathcal{I}(R)$ is isomorphic to
$\widehat{\mathcal{F}}_{\mathcal{I}_R}(R)$ as defined above. The categories
cofibered in groupoids $\widehat{\mathcal{F}}_\mathcal{I}$ and
$\widehat{\mathcal{F}}$ are equivalent, by using over an object
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$
the equivalence of
Lemma \ref{lemma-formal-objects-different-filtration}.
\end{remark}

\begin{remark}
\label{remark-completion-functor}
Let $F: \mathcal{C}_\Lambda \to \textit{Sets}$ be a functor.
Identifying functors with cofibered sets, the completion of $F$ is the functor
$\widehat{F} : \widehat{\mathcal{C}}_\Lambda \to \textit{Sets}$
given by $\widehat{F}(S) = \lim F(S/\mathfrak{m}_S^{n})$.  This agrees
with the definition in Schlessinger's paper \cite{Sch}.
\end{remark}

\begin{remark}
\label{remark-restrict-completion}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$. We claim that there is a canonical
equivalence
$$
can :
\widehat{\mathcal{F}}|_{\mathcal{C}_\Lambda}
\longrightarrow
\mathcal{F}.
$$
Namely, let $A \in \Ob(\mathcal{C}_\Lambda)$ and let
$(A, \xi_n, f_n)$ be an object of
$\widehat{\mathcal{F}}|_{\mathcal{C}_\Lambda}(A)$.
Since $A$ is Artinian there is a minimal $m \in \mathbf{N}$
such that $\mathfrak m_A^m = 0$. Then $can$ sends $(A, \xi_n, f_n)$ to $\xi_m$.
This functor is an equivalence of categories cofibered in groupoids by
Categories, Lemma \ref{categories-lemma-equivalence-fibred-categories}
because it is an equivalence on all fibre categories by
Lemma \ref{lemma-formal-objects-different-filtration}
and the fact that the $\mathfrak m_A$-adic topology on a local
Artinian ring $A$ comes from the zero ideal. We will frequently identify
$\mathcal{F}$ with a full subcategory of $\widehat{\mathcal{F}}$ via a
quasi-inverse to the functor $can$.
\end{remark}

\begin{remark}
\label{remark-completion-morphism}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a morphism of categories
cofibered in groupoids over $\mathcal{C}_\Lambda$. Then there is an induced
morphism
$\widehat{\varphi}: \widehat{\mathcal{F}} \to \widehat{\mathcal{G}}$
of categories cofibered in groupoids over $\widehat{\mathcal{C}}_\Lambda$.
It sends an object $\xi = (R, \xi_n, f_n)$ of
$\widehat{\mathcal{F}}$ to $(R, \varphi(\xi_n), \varphi(f_n))$, and it sends a
morphism $(a_0 : R \to S, a_n : \xi_n \to \eta_n)$ between
objects $\xi$ and $\eta$ of $\widehat{\mathcal{F}}$ to
$(a_0 : R \to S, \varphi(a_n) : \varphi(\xi_n) \to \varphi(\eta_n))$.
Finally, if $t : \varphi \to \varphi'$ is a $2$-morphism between
$1$-morphisms $\varphi, \varphi': \mathcal{F} \to \mathcal{G}$ of
categories cofibred in groupoids, then we obtain a $2$-morphism
$\widehat{t} : \widehat{\varphi} \to \widehat{\varphi}'$. Namely, for
$\xi = (R, \xi_n, f_n)$ as above we set
$\widehat{t}_\xi = (t_{\varphi(\xi_n)})$. Hence completion defines a
functor between $2$-categories
$$
\widehat{~} :
\text{Cof}(\mathcal{C}_\Lambda)
\longrightarrow
\text{Cof}(\widehat{\mathcal{C}}_\Lambda)
$$
from the $2$-category of categories cofibred in groupoids over
$\mathcal{C}_\Lambda$ to the $2$-category of categories cofibred
in groupoids over $\widehat{\mathcal{C}}_\Lambda$.
\end{remark}

\begin{remark}
\label{remark-completion-restriction-adjoint}
We claim the completion functor of
Remark \ref{remark-completion-morphism}
and the restriction functor
$|_{\mathcal{C}_\Lambda} : \text{Cof}(\widehat{\mathcal{C}}_\Lambda)
\to \text{Cof}(\mathcal{C}_\Lambda)$ of
Remarks \ref{remarks-cofibered-groupoids}
(\ref{item-definition-restricting-base-category})
are ``2-adjoint'' in the following precise sense. Let
$\mathcal{F} \in \Ob(\text{Cof}(\mathcal{C}_\Lambda))$
and let
$\mathcal{G} \in \Ob(\text{Cof}(\widehat{\mathcal{C}}_\Lambda))$.
Then there is an equivalence of categories
$$
\Phi :
\Mor_{\mathcal{C}_\Lambda}(
\mathcal{G}|_{\mathcal{C}_\Lambda}, \mathcal{F})
\longrightarrow
\Mor_{\widehat{\mathcal{C}}_\Lambda}(\mathcal{G}, \widehat{\mathcal{F}})
$$
To describe this equivalence, we
define canonical morphisms
$\mathcal{G} \to \widehat{\mathcal{G}|_{\mathcal{C}_\Lambda}}$ and
$\widehat{\mathcal{F}}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$ as follows
\begin{enumerate}
\item Let $R \in \Ob(\widehat{\mathcal{C}}_\Lambda))$ and let $\xi$
be an object of the fiber category $\mathcal{G}(R)$.
Choose a pushforward $\xi \to \xi_n$ of $\xi$ to
$R/\mathfrak m_R^n$ for each $n \in \mathbf{N}$, and let
$f_n : \xi_{n + 1} \to \xi_n$ be the induced morphism.
Then $\mathcal{G} \to \widehat{\mathcal{G}|_{\mathcal{C}_\Lambda}}$
sends $\xi$ to $(R, \xi_n, f_n)$.
\item This is the equivalence
$can : \widehat{\mathcal{F}}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
of
Remark \ref{remark-restrict-completion}.
\end{enumerate}
Having said this, the equivalence
$\Phi : \Mor_{\mathcal{C}_\Lambda}(
\mathcal{G}|_{\mathcal{C}_\Lambda}, \mathcal{F})  \to
\Mor_{\widehat{\mathcal{C}}_\Lambda}(\mathcal{G},
\widehat{\mathcal{F}})$
sends a morphism
$\varphi : \mathcal{G}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
to
$$
\mathcal{G} \to \widehat{\mathcal{G}|_{\mathcal{C}_\Lambda}}
\xrightarrow{\widehat{\varphi}} \widehat{\mathcal{F}}
$$
There is a quasi-inverse
$\Psi :
\Mor_{\widehat{\mathcal{C}}_\Lambda}(
\mathcal{G}, \widehat{\mathcal{F}}) \to
\Mor_{\mathcal{C}_\Lambda}(
\mathcal{G}|_{\mathcal{C}_\Lambda}, \mathcal{F})$
to $\Phi$ which sends $\psi : \mathcal{G} \to \widehat{\mathcal{F}}$ to
$$
\mathcal{G}|_{\mathcal{C}_\Lambda} \xrightarrow{\psi|_{\mathcal{C}_\Lambda}}
\widehat{\mathcal{F}}|_{\mathcal{C}_\Lambda} \to \mathcal{F}.
$$
We omit the verification that $\Phi$ and $\Psi$ are quasi-inverse.
We also do not address functoriality of $\Phi$ (because it would
lead into 3-category territory which we want to avoid at all cost).
\end{remark}

\begin{remark}
\label{remark-completion-restriction-cofset-adjoint}
For a category $\mathcal{C}$ we denote by $\text{CofSet}(\mathcal{C})$ the
category of cofibered sets over $\mathcal{C}$. It is a $1$-category
isomorphic the category of functors $\mathcal{C} \to \textit{Sets}$.
See Remarks \ref{remarks-cofibered-groupoids}
(\ref{item-convention-cofibered-sets}).
The completion and restriction functors restrict to functors
$\widehat{~} : \text{CofSet}(\mathcal{C}_\Lambda) \to
\text{CofSet}(\widehat{\mathcal{C}}_\Lambda)$ and
$|_{\mathcal{C}_\Lambda} : \text{CofSet}(\widehat{\mathcal{C}}_\Lambda) \to
\text{CofSet}(\mathcal{C}_\Lambda)$ which we denote by the same symbols.
As functors on the categories of cofibered sets, completion and restriction
are adjoints in the usual 1-categorical sense: the same construction as in
Remark \ref{remark-completion-restriction-adjoint} defines a functorial
bijection
$$
\Mor_{\mathcal{C}_\Lambda}(G|_{\mathcal{C}_\Lambda}, F)
\longrightarrow
\Mor_{\widehat{\mathcal{C}}_\Lambda}(G, \widehat{F})
$$
for $F \in \Ob(\text{CofSet}(\mathcal{C}_\Lambda))$ and
$G \in \Ob(\text{CofSet}(\widehat{\mathcal{C}}_\Lambda))$.
Again the map $\widehat{F}|_{\mathcal{C}_\Lambda} \to F$ is an
isomorphism.
\end{remark}

\begin{remark}
\label{remark-restrict-complete-continuous-functor}
Let $G : \widehat{\mathcal{C}}_\Lambda \to \textit{Sets}$
be a functor that commutes with limits.
Then the map $G \to \widehat{G|_{\mathcal{C}_\Lambda}}$ described in
Remark \ref{remark-completion-restriction-adjoint}
is an isomorphism. Indeed, if $S$ is  an object of
$\widehat{\mathcal{C}}_\Lambda$, then we have canonical bijections
$$
\widehat{G|_{\mathcal{C}_\Lambda}}(S) =
\lim_n G(S/\mathfrak{m}_S^n) =
G(\lim_n S/\mathfrak{m}_S^n) = G(S).
$$
In particular, if $R$ is an object of $\widehat{\mathcal{C}}_\Lambda$ then
$\underline{R} = \widehat{\underline{R}|_{\mathcal{C}_\Lambda}}$ because
the representable functor $\underline{R}$ commutes with limits by definition
of limits.
\end{remark}

\begin{remark}
\label{remark-formal-objects-yoneda}
Let $R$ be an object of $\widehat{\mathcal{C}}_\Lambda$.  It defines a functor
$\underline{R}: \widehat{\mathcal{C}}_\Lambda \to \textit{Sets}$
as described in
Remarks \ref{remarks-cofibered-groupoids} (\ref{item-definition-yoneda}).
As usual we identify this functor with the
associated cofibered set.  If $\mathcal{F}$ is a cofibered category over
$\mathcal{C}_\Lambda$, then there is an equivalence of categories
\begin{equation}
\label{equation-formal-objects-maps}
\Mor_{\mathcal{C}_\Lambda}(
\underline{R}|_{\mathcal{C}_\Lambda}, \mathcal{F})
\longrightarrow
\widehat{\mathcal{F}}(R).
\end{equation}
It is given by the composition
$$
\Mor_{\mathcal{C}_\Lambda}(
\underline{R}|_{\mathcal{C}_\Lambda}, \mathcal{F})
\xrightarrow{\Phi}
\Mor_{\widehat{\mathcal{C}}_\Lambda}(
\underline{R}, \widehat{\mathcal{F}})
\xrightarrow{\sim}
\widehat{\mathcal{F}}(R)
$$
where $\Phi$ is as in
Remark \ref{remark-completion-restriction-adjoint}
and the second equivalence comes from the 2-Yoneda lemma
(the cofibered analogue of
Categories, Lemma \ref{categories-lemma-yoneda-2category}).
Explicitly, the equivalence sends a morphism
$\varphi : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
to the formal object
$(R, \varphi(R \to R/\mathfrak{m}_R^n), \varphi(f_n))$ in
$\widehat{\mathcal{F}}(R)$, where
$f_n : R/\mathfrak m_R^{n + 1} \to R/\mathfrak m_R^n$ is the projection.

\medskip\noindent
Assume a choice of pushforwards for $\mathcal{F}$ has been made.
Given any $\xi \in \Ob(\widehat{\mathcal{F}}(R))$ we construct
an explicit
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
which maps to $\xi$ under (\ref{equation-formal-objects-maps}).
Namely, say $\xi = (R, \xi_n, f_n)$. An object $\alpha$ in
$\underline{R}|_{\mathcal{C}_\Lambda}$ is the same thing as a morphism
$\alpha : R \to A$ of $\widehat{\mathcal{C}}_\Lambda$ with $A$
Artinian. Let $m \in \mathbf{N}$ be minimal such that $\mathfrak m_A^m = 0$.
Then $\alpha$ factors through a unique $\alpha_m : R/\mathfrak m_R^m \to A$
and we can set $\underline{\xi}(\alpha) = \alpha_{m, *}\xi_m$.
We omit the description of $\underline{\xi}$ on morphisms and we
omit the proof that $\underline{\xi}$ maps to $\xi$
via (\ref{equation-formal-objects-maps}).

\medskip\noindent
Assume a choice of pushforwards for $\widehat{\mathcal{F}}$ has been made.
In this case the proof of
Categories, Lemma \ref{categories-lemma-yoneda-2category}
gives an explicit quasi-inverse
$$
\iota :
\widehat{\mathcal{F}}(R) \longrightarrow
\Mor_{\widehat{\mathcal{C}}_\Lambda}(
\underline{R}, \widehat{\mathcal{F}})
$$
to the 2-Yoneda equivalence which takes $\xi$ to the morphism
$\iota(\xi) : \underline{R} \to \widehat{\mathcal{F}}$ sending
$f \in \underline{R}(S) = \Mor_{\mathcal{C}_\Lambda}(R, S)$
to $f_*\xi$. A quasi-inverse to (\ref{equation-formal-objects-maps})
is then
$$
\widehat{\mathcal{F}}(R)
\xrightarrow{\iota}
\Mor_{\widehat{\mathcal{C}}_\Lambda}(
\underline{R}, \widehat{\mathcal{F}})
\xrightarrow{\Psi}
\Mor_{\mathcal{C}_\Lambda}(
\underline{R}|_{\mathcal{C}_\Lambda}, \mathcal{F})
$$
where $\Psi$ is as in
Remark \ref{remark-completion-restriction-adjoint}.
Given $\xi \in \Ob(\widehat{\mathcal{F}}(R))$ we have
$\Psi(\iota(\xi)) \cong \underline{\xi}$ where $\underline{\xi}$
is as in the previous paragraph, because both are mapped to $\xi$
under the equivalence of categories (\ref{equation-formal-objects-maps}).
Using $\underline{R} = \widehat{\underline{R}|_{\mathcal{C}_\Lambda}}$
(see Remark \ref{remark-restrict-complete-continuous-functor})
and unwinding the definitions of $\Phi$ and $\Psi$ we conclude that
$\iota(\xi)$ is isomorphic to the completion of $\underline{\xi}$.
\end{remark}

\begin{remark}
\label{remark-formal-objects-yoneda-map}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$. Let $\xi = (R, \xi_n, f_n)$ and
$\eta = (S, \eta_n, g_n)$ be formal objects of $\mathcal{F}$.
Let $a = (a_n) : \xi \to \eta$ be a morphism of formal objects, i.e.,
a morphism of $\widehat{\mathcal{F}}$. Let
$f = \widehat{p}(a) = a_0 : R \to S$ be the projection of $a$ in
$\widehat{\mathcal{C}}_\Lambda$. Then we obtain a $2$-commutative
diagram
$$
\xymatrix{
\underline{R}|_{\mathcal{C}_\Lambda} \ar[rd]_{\underline{\xi}} & &
\underline{S}|_{\mathcal{C}_\Lambda} \ar[ll]^f \ar[ld]^{\underline{\eta}} \\
& \mathcal{F}
}
$$
where $\underline{\xi}$ and $\underline{\eta}$ are the morphisms
constructed in
Remark \ref{remark-formal-objects-yoneda}.
To see this let $\alpha : S \to A$ be an object of
$\underline{S}|_{\mathcal{C}_\Lambda}$ (see loc.\ cit.).
Let $m \in \mathbf{N}$ be minimal such that $\mathfrak m_A^m = 0$.
We get a commutative diagram
$$
\xymatrix{
R \ar[d]^f \ar[r] & R/\mathfrak m_R^m \ar[d]_{f_m} \ar[rd]^{\beta_m} \\
S \ar[r] & S/\mathfrak m_S^m \ar[r]^{\alpha_m} & A
}
$$
such that the bottom arrows compose to give $\alpha$.
Then $\underline{\eta}(\alpha) = \alpha_{m, *}\eta_m$ and
$\underline{\xi}(\alpha \circ f) = \beta_{m, *}\xi_m$. The morphism
$a_m : \xi_m \to \eta_m$ lies over $f_m$ hence we obtain a canonical
morphism
$$
\underline{\xi}(\alpha \circ f) = \beta_{m, *}\xi_m
\longrightarrow
\underline{\eta}(\alpha) = \alpha_{m, *}\eta_m
$$
lying over $\text{id}_A$ such that
$$
\xymatrix{
\xi_m \ar[r] \ar[d]^{a_m} &  \beta_{m, *}\xi_m \ar[d] \\
\eta_m \ar[r] &  \alpha_{m, *}\eta_m
}
$$
commutes by the axioms of a category cofibred in groupoids. This defines
a transformation of functors $\underline{\xi} \circ f \to \underline{\eta}$
which witnesses the 2-commutativity of the first diagram of this remark.
\end{remark}

\begin{remark}
\label{remark-spell-out-formal-object}
According to Remark \ref{remark-formal-objects-yoneda}, giving a formal object
$\xi$ of $\mathcal{F}$ is equivalent to giving a prorepresentable functor
$U : \mathcal{C}_\Lambda \to \textit{Sets}$ and a morphism
$U \to \mathcal{F}$.
\end{remark}




\section{Smooth morphisms}
\label{section-smooth-morphisms}

\noindent
In this section we discuss smooth morphisms of categories
cofibered in groupoids over $\mathcal{C}_\Lambda$.

\begin{definition}
\label{definition-smooth-morphism}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a morphism of categories
cofibered in groupoids over $\mathcal{C}_\Lambda$.  We say  $\varphi$ is
{\it smooth} if it satisfies the following condition: Let $B \to A$ be
a surjective ring map in $\mathcal{C}_\Lambda$.  Let $y \in
\Ob(\mathcal{G}(B)), x \in \Ob(\mathcal{F}(A))$, and $y
\to \varphi(x)$ be a morphism lying over $B \to A$.  Then there
exists $x' \in \Ob(\mathcal{F}(B))$, a morphism $x' \to x$
lying over $B \to A$, and a morphism $\varphi(x') \to y$ lying
over $\text{id}: B \to B$, such that the diagram
$$
\xymatrix{
\varphi(x') \ar[r] \ar[dr] & y \ar[d] \\
& \varphi(x)
}
$$
commutes.
\end{definition}

\begin{lemma}
\label{lemma-smoothness-small-extensions}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a morphism of categories
cofibered in groupoids over $\mathcal{C}_\Lambda$.  Then $\varphi$ is smooth
if the condition in Definition \ref{definition-smooth-morphism} is assumed to
hold only for small extensions $B \to A$.
\end{lemma}

\begin{proof}
Let $B \to A$ be a surjective ring map in $\mathcal{C}_\Lambda$.
Let $y \in \Ob(\mathcal{G}(B))$, $x \in \Ob(\mathcal{F}(A))$,
and $y \to \varphi(x)$ be a morphism lying over $B \to A$. By
Lemma \ref{lemma-factor-small-extension} we can factor $B \to A$ into
small extensions $B = B_n \to B_{n-1} \to \ldots \to B_0 = A$.
We argue by induction on $n$. If $n = 1$ the result is true by assumption.
If $n > 1$, then denote $f : B = B_n \to B_{n - 1}$ and denote
$g : B_{n - 1} \to B_0 = A$. Choose a pushforward
$y \to f_* y$ of $y$ along $f$, so that the morphism $y \to \varphi(x)$
factors as $y \to f_* y \to \varphi(x)$. By the induction hypothesis
we can find $x_{n - 1} \to x$ lying over $g : B_{n - 1} \to A$ and
$a : \varphi(x_{n - 1}) \to f_*y$ lying over
$\text{id} : B_{n - 1} \to B_{n - 1}$ such that
$$
\xymatrix{
\varphi(x_{n - 1}) \ar[r]_-a \ar[dr] & f_*y \ar[d] \\
& \varphi(x)
}
$$
commutes. We can apply the assumption to the composition
$y \to \varphi(x_{n - 1})$ of
$y \to f_*y$ with $a^{-1} : f_*y \to \varphi(x_{n - 1})$. We obtain
$x_n \to x_{n - 1}$ lying over $B_n \to B_{n - 1}$ and
$\varphi(x_n) \to y$ lying over  $\text{id} : B_n \to B_n$ so that the diagram
$$
\xymatrix{
\varphi(x_n) \ar[r] \ar[d] & y \ar[d] \\
\varphi(x_{n - 1}) \ar[r]^-a \ar[dr] & f_*y \ar[d] \\
& \varphi(x)
}
$$
commutes. Then the composition $x_n \to x_{n - 1} \to x$ and
$\varphi(x_n) \to y$ are the morphisms required by the definition of
smoothness.
\end{proof}

\begin{remark}
\label{remark-smoothness-2-categorical}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a morphism of categories
cofibered in groupoids over $\mathcal{C}_\Lambda$.  Let $B \to A$ be a
ring map in $\mathcal{C}_\Lambda$.  Choices of pushforwards along $B
\to A$ for objects in the fiber categories $\mathcal{F}(B)$ and
$\mathcal{G}(B)$ determine functors $\mathcal{F}(B) \to \mathcal{F}(A)$
and $\mathcal{G}(B) \to \mathcal{G}(A)$ fitting into a $2$-commutative
diagram
$$
\xymatrix{
\mathcal{F}(B) \ar[r]^{\varphi} \ar[d] & \mathcal{G}(B) \ar[d] \\
\mathcal{F}(A) \ar[r]^{\varphi}        & \mathcal{G}(A) .
}
$$
Hence there is an induced functor $\mathcal{F}(B) \to \mathcal{F}(A)
\times_{\mathcal{G}(A)} \mathcal{G}(B)$.  Unwinding the definitions shows that
$\varphi : \mathcal{F} \to \mathcal{G}$ is smooth if and only if this
induced functor is essentially surjective whenever $B \to A$ is
surjective (or equivalently, by
Lemma \ref{lemma-smoothness-small-extensions},
whenever $B \to A$ is a small extension).
\end{remark}

\begin{remark}
\label{remark-compare-smooth-schlessinger}
The characterization of smooth morphisms in
Remark \ref{remark-smoothness-2-categorical}
is analogous to Schlessinger's notion of
a smooth morphism of functors, cf.\ \cite[Definition 2.2.]{Sch}. In
fact, when $\mathcal{F}$ and $\mathcal{G}$ are cofibered in sets
then our notion is equivalent to Schlessinger's. Namely, in this case
let $F, G : \mathcal{C}_\Lambda \to \textit{Sets}$ be the corresponding
functors, see
Remarks \ref{remarks-cofibered-groupoids}
(\ref{item-convention-cofibered-sets}).
Then $F \to G$ is smooth if and only if for every surjection of rings
$B \to A$ in $\mathcal{C}_\Lambda$ the map $F(B) \to F(A) \times_{G(A)} G(B)$
is surjective.
\end{remark}

\begin{remark}
\label{remark-smooth-to-iso-classes}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Then the morphism
$\mathcal{F} \to \overline{\mathcal{F}}$ is smooth.
Namely, suppose that $f : B \to A$ is a ring map in $\mathcal{C}_\Lambda$.
Let $x \in \Ob(\mathcal{F}(A))$ and let
$\overline{y} \in \overline{\mathcal{F}}(B)$
be the isomorphism class of $y \in \Ob(\mathcal{F}(B))$ such that
$\overline{f_*y} = \overline{x}$. Then we simply take $x' = y$, the
implied morphism $x' = y \to x$ over $B \to A$, and the equality
$\overline{x'} = \overline{y}$ as the solution to
the problem posed in Definition \ref{definition-smooth-morphism}.
\end{remark}

\noindent
If $R \to S$ is a ring map $\widehat{\mathcal{C}}_\Lambda$, then there
is an induced morphism $\underline{S} \to \underline{R}$ between the
functors $\underline{S}, \underline{R}: \widehat{\mathcal{C}}_\Lambda
\to \textit{Sets}$.  In this situation, smoothness of the
restriction $\underline{S}|_{\mathcal{C}_\Lambda} \to
\underline{R}|_{\mathcal{C}_\Lambda}$ is a familiar notion:

\begin{lemma}
\label{lemma-smooth-morphism-power-series}
Let $R \to S$ be a ring map in $\widehat{\mathcal{C}}_\Lambda$. Then
the induced morphism
$\underline{S}|_{\mathcal{C}_\Lambda} \to \underline{R}|_{\mathcal{C}_\Lambda}$
is smooth if and only if $S$ is a power series ring over $R$.
\end{lemma}

\begin{proof}
Assume $S$ is a power series ring over $R$. Say $S = R[[x_1, \ldots, x_n]]$.
Smoothness of
$\underline{S}|_{\mathcal{C}_\Lambda} \to \underline{R}|_{\mathcal{C}_\Lambda}$
means the following (see Remark \ref{remark-compare-smooth-schlessinger}):
Given a surjective ring map $B \to A$ in
$\mathcal{C}_\Lambda$, a ring map $R \to B$, a ring map $S \to A$ such that
the solid diagram
$$
\xymatrix{
S \ar[r] \ar@{..>}[rd] & A \\
R \ar[u] \ar[r] & B \ar[u]
}
$$
is commutative then a dotted arrow exists making the diagram commute.
(Note the similarity with
Algebra, Definition \ref{algebra-definition-formally-smooth}.)
To construct the dotted arrow choose elements $b_i \in B$ whose images
in $A$ are equal to the images of $x_i$ in $A$. Note that
$b_i \in \mathfrak m_B$ as $x_i$ maps to an element of $\mathfrak m_A$.
Hence there is a unique $R$-algebra map $R[[x_1, \ldots, x_n]] \to B$
which maps $x_i$ to $b_i$ and which can serve as our dotted arrow.

\medskip\noindent
Conversely, assume
$\underline{S}|_{\mathcal{C}_\Lambda} \to \underline{R}|_{\mathcal{C}_\Lambda}$
is smooth. Let $x_1, \ldots, x_n \in S$ be elements whose images
form a basis in the relative cotangent space
$\mathfrak m_S/(\mathfrak m_R S + \mathfrak m_S^2)$ of $S$ over $R$.
Set $T = R[[X_1, \ldots, X_n]]$. Note that both
$$
S/(\mathfrak m_R S + \mathfrak m_S^2) \cong
R/\mathfrak m_R[x_1, \ldots, x_n]/(x_ix_j)
$$
and
$$
T/(\mathfrak m_R T + \mathfrak m_T^2) \cong
R/\mathfrak m_R[X_1, \ldots, X_n]/(X_iX_j).
$$
Let
$S/(\mathfrak m_R S + \mathfrak m_S^2) \to
T/(\mathfrak m_R T + \mathfrak m_T^2)$
be the local $R$-algebra isomorphism given by mapping
the class of $x_i$ to the class of $X_i$. Let
$f_1 : S \to T/(\mathfrak m_R T + \mathfrak m_T^2)$ be the
composition
$S \to S/(\mathfrak m_R S + \mathfrak m_S^2)
\to T/(\mathfrak m_R T + \mathfrak m_T^2)$.
The assumption that
$\underline{S}|_{\mathcal{C}_\Lambda} \to \underline{R}|_{\mathcal{C}_\Lambda}$
is smooth means we can lift $f_1$ to a map
$f_2 : S \to T/\mathfrak{m}_T^2$, then to a map
$f_3 : S \to T/\mathfrak{m}_T^3$, and so on, for all $n \geq 1$. Thus
we get an induced map $f : S \to T = \lim T/\mathfrak m_T^n$
of local $R$-algebras. By our choice of $f_1$, the map $f$ induces an
isomorphism
$\mathfrak m_S/(\mathfrak m_R S + \mathfrak m_S^2) \to
\mathfrak m_T/(\mathfrak m_R T + \mathfrak m_T^2)$
of relative cotangent spaces.
Hence $f$ is surjective by
Lemma \ref{lemma-surjective-cotangent-space}
(where we think of $f$ as a map in $\widehat{\mathcal{C}}_R$).
Choose preimages $y_i \in S$ of $X_i \in T$ under $f$. As $T$ is a
power series ring over $R$ there exists a local
$R$-algebra homomorphism $s : T \to S$ mapping $X_i$ to $y_i$.
By construction $f \circ s = \text{id}$. Then $s$ is injective.
But $s$ induces an isomorphism on relative cotangent spaces since
$f$ does, so it is also surjective by
Lemma \ref{lemma-surjective-cotangent-space}
again. Hence $s$ and $f$ are isomorphisms.
\end{proof}

\noindent
Smooth morphisms satisfy the following functorial properties.

\begin{lemma}
\label{lemma-smooth-properties}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ and $\psi : \mathcal{G}
\to \mathcal{H}$ be morphisms of categories cofibered in groupoids over
$\mathcal{C}_\Lambda$.
\begin{enumerate}
\item If $\varphi$ and $\psi$ are smooth, then $\psi \circ \varphi$ is smooth.
\item If $\varphi$ is essentially surjective and $\psi \circ \varphi$ is
smooth, then $\psi$ is smooth.
\item If $\mathcal{G}' \to \mathcal{G}$ is a morphism of categories
cofibered in groupoids and $\varphi$ is smooth, then
$\mathcal{F} \times_\mathcal{G} \mathcal{G}' \to \mathcal{G}'$ is smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Statements (1) and (2) follow immediately from the definitions.
Proof of (3) omitted. Hints: use the formulation of smoothness given in
Remark \ref{remark-smoothness-2-categorical}
and use that $\mathcal{F} \times_\mathcal{G} \mathcal{G}'$
is the $2$-fibre product, see
Remarks \ref{remarks-cofibered-groupoids} (\ref{item-fibre-product}).
\end{proof}

\begin{lemma}
\label{lemma-smooth-morphism-essentially-surjective}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a smooth morphism of
categories cofibered in groupoids over $\mathcal{C}_\Lambda$.  Assume
$\varphi : \mathcal{F}(k) \to \mathcal{G}(k)$ is essentially surjective.
Then $\varphi : \mathcal{F} \to \mathcal{G}$ and
$\widehat{\varphi} : \widehat{\mathcal{F}} \to \widehat{\mathcal{G}}$
are essentially surjective.
\end{lemma}

\begin{proof}
Let $y$ be an object of $\mathcal{G}$ lying over
$A \in \Ob(\mathcal{C}_\Lambda)$. Let $y \to y_0$ be a pushforward
of $y$ along $A \to k$. By the assumption on essential surjectivity of
$\varphi : \mathcal{F}(k) \to \mathcal{G}(k)$ there exist an object
$x_0$ of $\mathcal{F}$ lying over $k$ and an isomorphism
$y_0 \to \varphi(x_0)$. Smoothness of $\varphi$ implies there exists
an object $x$ of $\mathcal{F}$ over $A$ whose image $\varphi(x)$
is isomorphic to $y$. Thus $\varphi : \mathcal{F} \to \mathcal{G}$
is essentially surjective.

\medskip\noindent
Let $\eta = (R, \eta_n, g_n)$ be an object of $\widehat{\mathcal{G}}$.  We
construct an object $\xi$ of $\widehat{\mathcal{F}}$ with an isomorphism
$\eta \to \varphi(\xi)$. By the assumption on essential surjectivity of
$\varphi : \mathcal{F}(k) \to \mathcal{G}(k)$, there exists a morphism
$\eta_1 \to \varphi(\xi_1)$ in $\mathcal{G}(k)$ for some
$\xi_1 \in \Ob(\mathcal{F}(k))$. The morphism
$\eta_2 \xrightarrow{g_1} \eta_1 \to \varphi(\xi_1)$
lies over the surjective ring map $R/\mathfrak m_R^2 \to k$, hence
by smoothness of $\varphi$ there exists
$\xi_2 \in \Ob(\mathcal{F}(R/\mathfrak m_R^2))$, a
morphism $f_1: \xi_2 \to \xi_1$ lying over
$R/\mathfrak m_R^2 \to k$, and a morphism
$\eta_2 \to \varphi(\xi_2)$ such that
$$
\xymatrix{
\varphi(\xi_2)  \ar[r]^{\varphi(f_1)} &  \varphi(\xi_{1})   \\
\eta_2   \ar[u] \ar[r]^{g_1}  & \eta_1  \ar[u] \\
}
$$
commutes. Continuing in this way we construct an object
$\xi = (R, \xi_n, f_n)$ of $\widehat{\mathcal{F}}$ and a morphism
$\eta \to \varphi(\xi) = (R, \varphi(\xi_n), \varphi(f_n))$
in $\widehat{\mathcal{G}}(R)$.
\end{proof}

\noindent
Later we are interested in producing smooth morphisms from
prorepresentable functors to predeformation categories $\mathcal{F}$.
By the discussion in
Remark \ref{remark-formal-objects-yoneda}
these morphisms correspond to certain formal objects of $\mathcal{F}$.
More precisely, these are the so-called versal formal objects of $\mathcal{F}$.

\begin{definition}
\label{definition-versal}
Let $\mathcal{F}$ be a category cofibered in groupoids.  Let $\xi$ be a formal
object of $\mathcal{F}$ lying over $R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$.
We say $\xi$ is {\it versal} if the corresponding morphism
$\underline{\xi}: \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
of Remark \ref{remark-formal-objects-yoneda} is smooth.
\end{definition}

\begin{remark}
\label{remark-versal-object}
Let $\mathcal{F}$ be a category cofibered in groupoids over $\mathcal
C_\Lambda$, and let $\xi$ be a formal object of $\mathcal{F}$.  It follows
from the definition of smoothness that versality of $\xi$ is equivalent to the
following condition: If
$$
\xymatrix{
& y \ar[d] \\
\xi \ar[r] & x
}
$$
is a diagram in $\widehat{\mathcal{F}}$ such that $y \to x$ lies over a
surjective map $B \to A$ of Artinian rings (we may assume it is a small
extension),  then there exists a morphism $\xi \to y$ such that
$$
\xymatrix{
& y \ar[d] \\
\xi \ar[r] \ar[ur] & x
}
$$
commutes. In particular, the condition that $\xi$ be versal does not depend on
the choices of pushforwards made in the construction of
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$ in
Remark \ref{remark-formal-objects-yoneda}.
\end{remark}

\begin{lemma}
\label{lemma-versal-object-quasi-initial}
Let $\mathcal{F}$ be a predeformation category.
Let $\xi$ be a versal formal object of $\mathcal{F}$.
For any formal object $\eta$ of $\widehat{\mathcal{F}}$,
there exists a morphism $\xi \to \eta$.
\end{lemma}

\begin{proof}
By assumption the morphism
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
is smooth. Then
$\iota(\xi) : \underline{R} \to \widehat{\mathcal{F}}$
is the completion of $\underline{\xi}$, see
Remark \ref{remark-formal-objects-yoneda}.
By
Lemma \ref{lemma-smooth-morphism-essentially-surjective}
there exists an object $f$ of $\underline{R}$ such that
$\iota(\xi)(f) = \eta$. Then $f$ is
a ring map $f : R \to S$ in $\widehat{\mathcal{C}}_\Lambda$. And
$\iota(\xi)(f) = \eta$ means that
$f_*\xi \cong \eta$ which means exactly that there is a morphism
$\xi \to \eta$ lying over $f$.
\end{proof}





\section{Smooth or unobstructed categories}
\label{section-smooth}

\noindent
Let $p : \mathcal{F} \to \mathcal{C}_\Lambda$ be a category cofibered in
groupoids. We can consider $\mathcal{C}_\Lambda$ as a category
cofibered in groupoids over $\mathcal{C}_\Lambda$ using the identity
functor. In this way
$p : \mathcal{F} \longrightarrow \mathcal{C}_\Lambda$
becomes
a morphism of categories cofibered in groupoids over $\mathcal{C}_\Lambda$.

\begin{definition}
\label{definition-cofibered-groupoid-projection-smooth}
Let $p : \mathcal{F} \to \mathcal{C}_\Lambda$ be a category cofibered in
groupoids. We say $\mathcal{F}$ is {\it smooth} or {\it unobstructed}
if its structure morphism $p$ is smooth
in the sense of Definition \ref{definition-smooth-morphism}.
\end{definition}

\noindent
This is the ``absolute'' notion of smoothness for a
category cofibered in groupoids over $\mathcal{C}_\Lambda$, although
it would be more correct to say that $\mathcal{F}$ is smooth over $\Lambda$.
One has to be careful with the phrase ``{\it $\mathcal{F}$ is unobstructed}'':
it may happen that
$\mathcal{F}$ has an obstruction theory with nonvanishing obstruction spaces
even though $\mathcal{F}$ is smooth.

\begin{remark}
\label{remark-smooth-on-top}
Suppose $\mathcal{F}$ is a predeformation category admitting a smooth morphism
$\varphi : \mathcal U \to \mathcal{F}$ from a predeformation category
$\mathcal{U}$.  Then by
Lemma \ref{lemma-smooth-morphism-essentially-surjective}
$\varphi$ is essentially surjective, so by
Lemma \ref{lemma-smooth-properties}
$p: \mathcal{F} \to \mathcal{C}_\Lambda$ is smooth if and only if the
composition $\mathcal U \xrightarrow{\varphi} \mathcal{F} \xrightarrow{p}
\mathcal{C}_\Lambda$ is smooth, i.e.\ $\mathcal{F}$ is smooth if and only if
$\mathcal{U}$ is smooth.
\end{remark}

\begin{lemma}
\label{lemma-smooth}
Let $R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$. The following are
equivalent
\begin{enumerate}
\item $\underline{R}|_{\mathcal{C}_\Lambda}$ is smooth,
\item $\Lambda \to R$ is formally smooth in the $\mathfrak m_R$-adic topology,
\item $\Lambda \to R$ is flat and $R \otimes_\Lambda k'$ is
geometrically regular over $k'$, and
\item $\Lambda \to R$ is flat and $k' \to R \otimes_\Lambda k'$ is
formally smooth in the $\mathfrak m_R$-adic topology.
\end{enumerate}
In the classical case, these are also equivalent to
\begin{enumerate}
\item[(5)] $R$ is isomorphic to $\Lambda[[x_1, \ldots, x_n]]$
for some $n$.
\end{enumerate}
\end{lemma}

\begin{proof}
Smoothness of
$p : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{C}_\Lambda$
means that given $B \to A$ surjective in $\mathcal{C}_\Lambda$
and given $R \to A$ we can find the dotted arrow in the
diagram
$$
\xymatrix{
R \ar[r] \ar@{-->}[rd] & A \\
\Lambda \ar[r] \ar[u] & B \ar[u]
}
$$
This is certainly true if $\Lambda \to R$ is formally smooth in the
$\mathfrak m_R$-adic topology, see
More on Algebra, Definitions
\ref{more-algebra-definition-formally-smooth-adic} and
\ref{more-algebra-definition-formally-smooth}.
Conversely, if this holds, then we see that
$\Lambda \to R$ is formally smooth in the $\mathfrak m_R$-adic
topology by More on Algebra, Lemma \ref{more-algebra-lemma-fs-local}.
Thus (1) and (2) are equivalent.

\medskip\noindent
The equivalence of (2), (3), and (4) is
More on Algebra, Proposition \ref{more-algebra-proposition-fs-flat-fibre-fs}.
The equivalence with (5) follows for example from
Lemma \ref{lemma-smooth-morphism-power-series}
and the fact that $\mathcal{C}_\Lambda$ is the same
as $\underline{\Lambda}|_{\mathcal{C}_\Lambda}$ in the classical case.
\end{proof}

\begin{lemma}
\label{lemma-smooth-power-series-classical}
Let $\mathcal{F}$ be a predeformation category.
Let $\xi$ be a versal formal object of $\mathcal{F}$ lying over
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$. The following are
equivalent
\begin{enumerate}
\item $\mathcal{F}$ is unobstructed, and
\item $\Lambda \to R$ is formally smooth in the $\mathfrak m_R$-adic topology.
\end{enumerate}
In the classical case these are also equivalent to
\begin{enumerate}
\item[(3)] $R \cong \Lambda[[x_1, \ldots, x_n]]$ for some $n$.\
\end{enumerate}
\end{lemma}

\begin{proof}
If (1) holds, i.e., if $\mathcal{F}$ is unobstructed, then the composition
$$
\underline{R}|_{\mathcal{C}_\Lambda}
\xrightarrow{\underline{\xi}}
\mathcal{F}
\to
\mathcal{C}_\Lambda
$$
is smooth, see Lemma \ref{lemma-smooth-properties}.
Hence we see that (2) holds by Lemma \ref{lemma-smooth}.
Conversely, if (2) holds, then the composition is smooth
and moreover the first arrow is essentially surjective by
Lemma \ref{lemma-versal-object-quasi-initial}. Hence we
find that the second arrow is smooth by Lemma \ref{lemma-smooth-properties}
which means that $\mathcal{F}$ is unobstructed by definition.
The equivalence with (3) in the classical case follows
from Lemma \ref{lemma-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-exists-smooth}
There exists an $R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$
such that the equivalent conditions of Lemma \ref{lemma-smooth}
hold and moreover $H_1(L_{k/\Lambda}) = \mathfrak m_R/\mathfrak m_R^2$
and $\Omega_{R/\Lambda} \otimes_R k = \Omega_{k/\Lambda}$.
\end{lemma}

\begin{proof}
In the classical case we choose $R = \Lambda$. More generally, if
the residue field extension $k/k'$ is separable, then there exists
a unique finite \'etale extension $\Lambda^\wedge \to R$
(Algebra, Lemmas \ref{algebra-lemma-complete-henselian} and
\ref{algebra-lemma-henselian-cat-finite-etale})
of the completion $\Lambda^\wedge$ of $\Lambda$
inducing the extension $k/k'$ on residue fields.

\medskip\noindent
In the general case we proceed as follows. Choose a smooth
$\Lambda$-algebra $P$ and a $\Lambda$-algebra surjection $P \to k$.
(For example, let $P$ be a polynomial algebra.)
Denote $\mathfrak m_P$ the kernel of $P \to k$. The Jacobi-Zariski sequence,
see (\ref{equation-sequence-extended}) and 
Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL}, is an
exact sequence
$$
0 \to H_1(\NL_{k/\Lambda}) \to
\mathfrak m_P/\mathfrak m_P^2 \to
\Omega_{P/\Lambda} \otimes_P k \to
\Omega_{k/\Lambda} \to 0
$$
We have the $0$ on the left because $P/k$ is smooth, hence
$\NL_{P/\Lambda}$ is quasi-isomorphic to a finite projective module
placed in degree $0$, hence $H_1(\NL_{P/\Lambda} \otimes_P k) = 0$.
Suppose $f \in \mathfrak m_P$ maps to a nonzero element
of $\Omega_{P/\Lambda} \otimes_P k$. Setting $P' = P/(f)$ we have a
$\Lambda$-algebra surjection $P' \to k$.
Observe that $P'$ is smooth at $\mathfrak m_{P'}$:
this follows from More on Morphisms, Lemma
\ref{more-morphisms-lemma-slice-smooth-given-element}.
Thus after replacing $P$ by a principal localization
of $P'$, we see that $\dim(\mathfrak m_P/\mathfrak m_P^2)$
decreases. Repeating finitely many times, we may assume
the map $\mathfrak m_P/\mathfrak m_P^2 \to
\Omega_{P/\Lambda} \otimes_P k$ is zero so that
the exact sequence breaks into isomorphisms
$H_1(L_{k/\Lambda}) = \mathfrak m_P/\mathfrak m_P^2$ and
$\Omega_{P/\Lambda} \otimes_P k = \Omega_{k/\Lambda}$.

\medskip\noindent
Let $R$ be the $\mathfrak m_P$-adic completion of $P$.
Then $R$ is an object of $\widehat{\mathcal{C}}_\Lambda$.
Namely, it is a complete local Noetherian ring (see
Algebra, Lemma \ref{algebra-lemma-completion-Noetherian-Noetherian})
and its residue field is identified with $k$.
We claim that $R$ works.

\medskip\noindent
First observe that the map $P \to R$ induces isomorphisms
$\mathfrak m_P/\mathfrak m_P^2 = \mathfrak m_R/\mathfrak m_R^2$
and $\Omega_{P/\Lambda} \otimes_P k = \Omega_{R/\Lambda} \otimes_R k$.
This is true because both $\mathfrak m_P/\mathfrak m_P^2$
and $\Omega_{P/\Lambda} \otimes_P k$ only depend on the
$\Lambda$-algebra $P/\mathfrak m_P^2$, see
Algebra, Lemma \ref{algebra-lemma-differential-mod-power-ideal},
the same holds for $R$ and we have $P/\mathfrak m_P^2 = R/\mathfrak m_R^2$.
Using the functoriality of the Jacobi-Zariski sequence
(\ref{equation-sequence-functorial})
we deduce that $H_1(L_{k/\Lambda}) = \mathfrak m_R/\mathfrak m_R^2$ and
$\Omega_{R/\Lambda} \otimes_R k = \Omega_{k/\Lambda}$
as the same is true for $P$.

\medskip\noindent
Finally, since $\Lambda \to P$ is smooth we see that
$\Lambda \to P$ is formally smooth by
Algebra, Proposition \ref{algebra-proposition-smooth-formally-smooth}.
Then $\Lambda \to P$ is formally smooth for the $\mathfrak m_P$-adic
topology by More on Algebra, Lemma \ref{more-algebra-lemma-formally-smooth}.
This property is inherited by the completion $R$ by
More on Algebra, Lemma \ref{more-algebra-lemma-formally-smooth-completion}
and the proof is complete.
In fact, it turns out that whenever $\underline{R}|_{\mathcal{C}_\Lambda}$
is smooth, then $R$ is isomorphic to a completion of a smooth
algebra over $\Lambda$, but we won't use this.
\end{proof}

\begin{example}
\label{example-smooth-explicit}
Here is a more explicit example of an $R$ as in
Lemma \ref{lemma-exists-smooth}.
Let $p$ be a prime number and let $n \in \mathbf{N}$.
Let $\Lambda = \mathbf{F}_p(t_1, t_2, \ldots, t_n)$ and let
$k = \mathbf{F}_p(x_1, \ldots, x_n)$ with map $\Lambda \to k$ given
by $t_i \mapsto x_i^p$. Then we can take
$$
R = \Lambda[x_1, \ldots, x_n]^\wedge_{(x_1^p - t_1, \ldots, x_n^p - t_n)}
$$
We cannot do ``better'' in this example, i.e., we cannot approximate
$\mathcal{C}_\Lambda$ by a smaller smooth object of
$\widehat{\mathcal{C}}_\Lambda$ (one can argue that the dimension of $R$
has to be at least $n$ since the map
$\Omega_{R/\Lambda} \otimes_R k \to \Omega_{k/\Lambda}$ is
surjective). We will discuss this phenomenon later in more detail.
\end{example}







\section{Schlessinger's conditions}
\label{section-schlessinger-conditions}

\noindent
In the following we often consider fibre products $A_1 \times_A A_2$
of rings in the category $\mathcal{C}_\Lambda$. We have seen in
Example \ref{example-fibre-product}
that such a fibre product may not always be an object of
$\mathcal{C}_\Lambda$. However, in virtually all cases below one of the
two maps $A_i \to A$ is surjective and $A_1 \times_A A_2$ will be
an object of $\mathcal{C}_\Lambda$ by
Lemma \ref{lemma-fiber-product-CLambda}.
We will use this result without further mention.

\medskip\noindent
We denote by $k[\epsilon]$ the ring of dual numbers over $k$.  More
generally, for a $k$-vector space $V$, we denote by $k[V]$ the $k$-algebra
whose underlying vector space is $k \oplus V$ and whose multiplication is given
by $(a, v) \cdot (a', v') = (aa', av' + a'v)$.  When $V = k$, $k[V]$ is the ring
of dual numbers over $k$.  For any finite dimensional $k$-vector space $V$
the ring $k[V]$ is in $\mathcal{C}_\Lambda$.

\begin{definition}
\label{definition-S1-S2}
Let $\mathcal{F}$ be a category cofibered in groupoids over $\mathcal
C_\Lambda$. We define {\it conditions (S1) and (S2)}
on $\mathcal{F}$ as follows:
\begin{enumerate}
\item[(S1)] Every diagram in $\mathcal{F}$
$$
\vcenter{
\xymatrix{
           & x_2 \ar[d] \\
x_1 \ar[r] & x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
           & A_2 \ar[d] \\
A_1 \ar[r] & A
}
}
$$
in $\mathcal{C}_\Lambda$ with $A_2 \to A$ surjective can be completed
to a commutative diagram
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d] & x_2 \ar[d] \\
x_1 \ar[r]      & x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A_1 \times_A A_2 \ar[r] \ar[d] & A_2 \ar[d] \\
A_1 \ar[r]      & A.
}
}
$$
\item[(S2)]
The condition of (S1) holds for diagrams in $\mathcal{F}$ lying over
a diagram in $\mathcal{C}_\Lambda$ of the form
$$
\xymatrix{
          & k[\epsilon] \ar[d] \\
A  \ar[r] & k.
}
$$
Moreover, if we have two commutative diagrams in $\mathcal{F}$
$$
\vcenter{
\xymatrix{
y \ar[r]_c \ar[d]_a & x_\epsilon \ar[d]^e \\
x \ar[r]^d          & x_0
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
y' \ar[r]_{c'} \ar[d]_{a'} & x_\epsilon \ar[d]^e \\
x \ar[r]^d                 & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[\epsilon] \ar[r] \ar[d] & k[\epsilon] \ar[d] \\
A  \ar[r] & k
}
}
$$
then there exists a morphism $b : y \to y'$ in
$\mathcal{F}(A \times_k k[\epsilon])$ such that $a = a' \circ b$.
\end{enumerate}
\end{definition}

\noindent
We can partly explain the meaning of conditions (S1) and (S2) in terms of
fibre categories. Suppose that $f_1 : A_1 \to A$ and $f_2 : A_2 \to A$ are
ring maps in $\mathcal{C}_\Lambda$ with $f_2$ surjective.
Denote $p_i : A_1 \times_A A_2 \to A_i$ the projection maps.
Assume a choice of pushforwards for $\mathcal{F}$ has been made.
Then the commutative diagram of rings translates into a $2$-commutative diagram
$$
\xymatrix{
\mathcal{F}(A_1 \times_A A_2) \ar[r]_-{p_{2, *}} \ar[d]_{p_{1, *}} &
\mathcal{F}(A_2) \ar[d]^{f_{2, *}} \\
\mathcal{F}(A_1) \ar[r]^{f_{1, *}} & \mathcal{F}(A)
}
$$
of fibre categories whence a functor
\begin{equation}
\label{equation-compare}
\mathcal{F}(A_1 \times_A A_2) \to
\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)
\end{equation}
into the $2$-fibre product of categories.
Condition (S1) requires that this functor be essentially surjective.
The first part of condition (S2) requires that this functor be a
essentially surjective if $f_2$ equals the map $k[\epsilon] \to k$.
Moreover in this case, the second part of (S2) implies that two objects
which become isomorphic in the target are isomorphic in the source
(but it is {\it not} equivalent to this statement).
The advantage of stating the conditions as in the definition
is that no choices have to be made.

\begin{lemma}
\label{lemma-S1-small-extensions}
Let $\mathcal{F}$ be a category cofibered in groupoids over $\mathcal
C_\Lambda$. Then $\mathcal{F}$ satisfies (S1) if the condition of (S1)
is assumed to hold only when $A_2 \to A$ is a small extension.
\end{lemma}

\begin{proof}
Proof omitted. Hints: apply Lemma \ref{lemma-factor-small-extension}
and use induction similar to the proof of
Lemma \ref{lemma-smoothness-small-extensions}.
\end{proof}

\begin{remark}
\label{remark-compare-S1-S2-schlessinger}
When $\mathcal{F}$ is cofibered in sets, conditions (S1) and (S2) are exactly
conditions (H1) and (H2) from Schlessinger's paper \cite{Sch}.
Namely, for a functor $F: \mathcal{C}_\Lambda \to
\textit{Sets}$, conditions (S1) and (S2) state:
\begin{enumerate}
\item [(S1)] If $A_1 \to A$ and $A_2 \to A$ are maps in
$\mathcal{C}_\Lambda$ with $A_2 \to A$ surjective, then the induced
map $F(A_1 \times_A A_2) \to F(A_1) \times_{F(A)} F(A_2)$ is
surjective.
\item [(S2)]  If $A \to k$ is a map in $\mathcal{C}_\Lambda$, then the
induced map
$F(A \times_k k[\epsilon]) \to F(A) \times_{F(k)} F(k[\epsilon])$
is bijective.
\end{enumerate}
The injectivity of the map
$F(A \times_k k[\epsilon]) \to F(A) \times_{F(k)} F(k[\epsilon])$
comes from the second part of condition (S2) and the fact that morphisms
are identities.
\end{remark}

\begin{lemma}
\label{lemma-S2-extensions}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$. If $\mathcal{F}$ satisfies (S2), then the
condition of (S2) also holds when $k[\epsilon]$ is replaced by $k[V]$
for any finite dimensional $k$-vector space $V$.
\end{lemma}

\begin{proof}
In the case that $\mathcal{F}$ is cofibred in sets, i.e., corresponds
to a functor $F : \mathcal{C}_\Lambda \to \textit{Sets}$ this follows
from the description of (S2) for $F$ in
Remark \ref{remark-compare-S1-S2-schlessinger}
and the fact that
$k[V] \cong k[\epsilon] \times_k \ldots \times_k k[\epsilon]$
with $\dim_k V$ factors. The case of functors is what we will use in
the rest of this chapter.

\medskip\noindent
We prove the general case by induction on $\dim(V)$. If $\dim(V) = 1$, then
$k[V] \cong k[\epsilon]$ and the result holds by assumption.
If $\dim(V) > 1$ we write $V = V' \oplus k\epsilon$. Pick a diagram
$$
\vcenter{
\xymatrix{
& x_V \ar[d] \\
x \ar[r] & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
& k[V] \ar[d] \\
A \ar[r] & k
}
}
$$
Choose a morphism $x_V \to x_{V'}$ lying over $k[V] \to k[V']$
and a morphism $x_V \to x_\epsilon$ lying over $k[V] \to k[\epsilon]$.
Note that the morphism $x_V \to x_0$ factors as
$x_V \to x_{V'} \to x_0$ and as $x_V \to x_\epsilon \to x_0$.
By induction hypothesis we can find a diagram
$$
\vcenter{
\xymatrix{
y' \ar[d] \ar[r] & x_{V'} \ar[d] \\
x \ar[r] & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[V'] \ar[d] \ar[r] & k[V'] \ar[d] \\
A \ar[r] & k
}
}
$$
This gives us a commutative diagram
$$
\vcenter{
\xymatrix{
& x_\epsilon \ar[d] \\
y' \ar[r] & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
& k[\epsilon] \ar[d] \\
A \times_k k[V'] \ar[r] & k
}
}
$$
Hence by (S2) we get a commutative diagram
$$
\vcenter{
\xymatrix{
y \ar[d] \ar[r] & x_\epsilon \ar[d] \\
y' \ar[r] & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
(A \times_k k[V']) \times_k k[\epsilon] \ar[d] \ar[r] & k[\epsilon] \ar[d] \\
A \times_k k[V'] \ar[r] & k
}
}
$$
Note that
$(A \times_k k[V']) \times_k k[\epsilon] = A \times_k k[V' \oplus k\epsilon]
= A \times_k k[V]$. We claim that $y$ fits into the correct commutative
diagram. To see this we let $y \to y_V$ be a morphism lying over
$A \times_k k[V] \to k[V]$. We can factor the morphisms
$y \to y' \to x_{V'}$ and $y \to x_\epsilon$ through the morphism
$y \to y_V$ (by the axioms of categories cofibred in groupoids).
Hence we see that both $y_V$ and $x_V$ fit into commutative diagrams
$$
\vcenter{
\xymatrix{
y_V \ar[r] \ar[d] & x_\epsilon \ar[d] \\
x_{V'} \ar[r]          & x_0
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
x_V \ar[r] \ar[d] & x_\epsilon \ar[d] \\
x_{V'} \ar[r]                 & x_0
}
}
$$
and hence by the second part of (S2) there exists an isomorphism
$y_V \to x_V$ compatible with $y_V \to x_{V'}$ and $x_V \to x_{V'}$
and in particular compatible with the maps to $x_0$.
The composition $y \to y_V \to x_V$ then fits into the required commutative
diagram
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d] & x_V \ar[d] \\
x \ar[r] & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[V] \ar[d] \ar[r] & k[V] \ar[d] \\
A \ar[r] & k
}
}
$$
In this way we see that the first part of $(S2)$ holds with $k[\epsilon]$
replaced by $k[V]$.

\medskip\noindent
To prove the second part suppose given two commutative
diagrams
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d] & x_V \ar[d] \\
x \ar[r] & x_0
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
y' \ar[r] \ar[d] & x_V \ar[d] \\
x \ar[r] & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[V] \ar[d] \ar[r] & k[V] \ar[d] \\
A \ar[r] & k
}
}
$$
We will use the morphisms $x_V \to x_{V'} \to x_0$ and
$x_V \to x_\epsilon \to x_0$ introduced in the first paragraph of the proof.
Choose morphisms $y \to y_{V'}$ and $y' \to y'_{V'}$
lying over $A \times_k k[V] \to A \times_k k[V']$. The axioms of a
cofibred category imply we can find commutative diagrams
$$
\vcenter{
\xymatrix{
y_{V'} \ar[r] \ar[d] & x_{V'} \ar[d] \\
x \ar[r] & x_0
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
y'_{V'} \ar[r] \ar[d] & x_{V'} \ar[d] \\
x \ar[r] & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[V'] \ar[d] \ar[r] & k[V'] \ar[d] \\
A \ar[r] & k
}
}
$$
By induction hypothesis we obtain an isomorphism
$b : y_{V'} \to y'_{V'}$
compatible with the morphisms $y_{V'} \to x$ and $y'_{V'} \to x$,
in particular compatible with the morphisms to $x_0$.
Then we have commutative diagrams
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d] & x_\epsilon \ar[d] \\
y'_{V'} \ar[r] & x_0
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
y' \ar[r] \ar[d] & x_\epsilon \ar[d] \\
y'_{V'} \ar[r] & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[\epsilon] \ar[d] \ar[r] & k[\epsilon] \ar[d] \\
A \ar[r] & k
}
}
$$
where the morphism $y \to y'_{V'}$ is the composition
$y \to y_{V'} \xrightarrow{b} y'_{V'}$ and where the morphisms
$y \to x_\epsilon$ and $y' \to x_\epsilon$ are the compositions of
the maps $y \to x_V$ and $y' \to x_V$ with the morphism $x_V \to x_\epsilon$.
Then the second part of (S2) guarantees the existence of an isomorphism
$y \to y'$ compatible with the maps to $y'_{V'}$, in particular compatible
with the maps to $x$ (because $b$ was compatible with the maps to $x$).
\end{proof}

\begin{lemma}
\label{lemma-S1-S2-associated-functor}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$.
\begin{enumerate}
\item If $\mathcal{F}$ satisfies (S1), then so does
$\overline{\mathcal{F}}$.
\item If $\mathcal{F}$ satisfies (S2), then so does
$\overline{\mathcal{F}}$ provided at least one of the following conditions is
satisfied
\begin{enumerate}
\item $\mathcal{F}$ is a predeformation category,
\item the category $\mathcal{F}(k)$ is a set or a setoid, or
\item for any morphism $x_\epsilon \to x_0$ of $\mathcal{F}$
lying over $k[\epsilon] \to k$ the pushforward map
$\text{Aut}_{k[\epsilon]}(x_\epsilon) \to \text{Aut}_k(x_0)$
is surjective.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $\mathcal{F}$ has (S1).
Suppose we have ring maps $f_i : A_i \to A$ in $\mathcal{C}_\Lambda$
with $f_2$ surjective. Let $x_i \in \mathcal{F}(A_i)$ such that
the pushforwards $f_{1, *}(x_1)$ and $f_{2, *}(x_2)$ are isomorphic.
Then we can denote $x$ an object of $\mathcal{F}$ over $A$ isomorphic
to both of these and we obtain a diagram as in (S1). Hence we find
an object $y$ of $\mathcal{F}$ over $A_1 \times_A A_2$ whose pushforward
to $A_1$, resp.\ $A_2$ is isomorphic to $x_1$, resp.\ $x_2$. In this way
we see that (S1) holds for $\overline{\mathcal{F}}$.

\medskip\noindent
Assume $\mathcal{F}$ has (S2).
The first part of (S2) for $\overline{\mathcal{F}}$ follows as in
the argument above. The second part of (S2) for
$\overline{\mathcal{F}}$ signifies that the map
$$
\overline{\mathcal{F}}(A \times_k k[\epsilon]) \to
\overline{\mathcal{F}}(A)
\times_{\overline{\mathcal{F}}(k)} \overline{\mathcal{F}}(k[\epsilon])
$$
is injective for any ring $A$ in $\mathcal{C}_\Lambda$. Suppose that
$y, y' \in \mathcal{F}(A \times_k k[\epsilon])$. Using the axioms
of cofibred categories we can choose commutative diagrams
$$
\vcenter{
\xymatrix{
y \ar[r]_c \ar[d]_a & x_\epsilon \ar[d]^e \\
x \ar[r]^d          & x_0
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
y' \ar[r]_{c'} \ar[d]_{a'} & x'_\epsilon \ar[d]^{e'} \\
x' \ar[r]^{d'}                 & x'_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[\epsilon] \ar[d] \ar[r] & k[\epsilon] \ar[d] \\
A \ar[r] & k
}
}
$$
Assume that there exist isomorphisms
$\alpha : x \to x'$ in $\mathcal{F}(A)$ and
$\beta : x_\epsilon \to x'_\epsilon$ in $\mathcal{F}(k[\epsilon])$.
This also means there exists an isomorphism $\gamma : x_0 \to x'_0$
compatible with $\alpha$. To prove (S2) for $\overline{\mathcal{F}}$
we have to show that there exists an isomorphism $y \to y'$ in
$\mathcal{F}(A \times_k k[\epsilon])$.
By (S2) for $\mathcal{F}$ such a morphism will exist if we can
choose the isomorphisms $\alpha$ and $\beta$ and $\gamma$ such that
$$
\xymatrix{
x \ar[d]^\alpha \ar[r] & x_0 \ar[d]^\gamma &
x_\epsilon \ar[d]^\beta \ar[l]^e \\
x' \ar[r] & x'_0 & x'_\epsilon \ar[l]_{e'}
}
$$
is commutative (because then we can replace $x$ by $x'$ and $x_\epsilon$
by $x'_\epsilon$ in the previous displayed diagram). The left hand square
commutes by our choice of $\gamma$. We can factor $e' \circ \beta$ as
$\gamma' \circ e$ for some second map
$\gamma' : x_0 \to x'_0$. Now the question is whether we can arrange it so
that $\gamma = \gamma'$? This is clear if $\mathcal{F}(k)$ is a set, or a
setoid. Moreover, if
$\text{Aut}_{k[\epsilon]}(x_\epsilon) \to \text{Aut}_k(x_0)$
is surjective, then we can adjust the choice of $\beta$ by precomposing
with an automorphism of $x_\epsilon$ whose image is
$\gamma^{-1} \circ \gamma'$ to make things work.
\end{proof}

\begin{lemma}
\label{lemma-S1-S2-localize}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Let $x_0 \in \Ob(\mathcal{F}(k))$.
Let $\mathcal{F}_{x_0}$ be the category cofibred in groupoids over
$\mathcal{C}_\Lambda$ constructed in
Remark \ref{remark-localize-cofibered-groupoid}.
\begin{enumerate}
\item If $\mathcal{F}$ satisfies (S1), then so does $\mathcal{F}_{x_0}$.
\item If $\mathcal{F}$ satisfies (S2), then so does $\mathcal{F}_{x_0}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Any diagram as in
Definition \ref{definition-S1-S2}
in $\mathcal{F}_{x_0}$ gives rise to a diagram in $\mathcal{F}$
and the output of condition (S1) or (S2) for this diagram in $\mathcal{F}$
can be viewed as an output for $\mathcal{F}_{x_0}$ as well.
\end{proof}

\begin{lemma}
\label{lemma-lifting-section}
Let $p: \mathcal{F} \to \mathcal{C}_\Lambda$ be a category cofibered in
groupoids. Consider a diagram of $\mathcal{F}$
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d]_a & x_\epsilon \ar[d]_e \\
x \ar[r]^d        & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[\epsilon] \ar[r] \ar[d] & k[\epsilon] \ar[d] \\
A \ar[r] & k.
}
}
$$
in $\mathcal{C}_\Lambda$. Assume $\mathcal{F}$ satisfies (S2).
Then there exists a morphism $s : x \to y$ with $a \circ s = \text{id}_x$
if and only if there exists a morphism $s_\epsilon : x \to x_\epsilon$
with $e \circ s_\epsilon = d$.
\end{lemma}

\begin{proof}
The ``only if'' direction is clear.  Conversely, assume there exists a
morphism $s_\epsilon : x \to x_\epsilon$ with $e \circ s_\epsilon = d$.
Note that $p(s_\epsilon) : A \to k[\epsilon]$ is a ring map compatible
with the map $A \to k$. Hence we obtain
$$
\sigma = (\text{id}_A, p(s_\epsilon)) : A \to A \times_k k[\epsilon].
$$
Choose a pushforward $x \to \sigma_*x$. By construction we can factor
$s_\epsilon$ as $x \to \sigma_*x \to x_\epsilon$. Moreover, as $\sigma$
is a section of $A \times_k k[\epsilon] \to A$, we get a morphism
$\sigma_*x \to x$ such that $x \to \sigma_*x \to x$ is $\text{id}_x$.
Because $e \circ s_\epsilon = d$ we find that the diagram
$$
\xymatrix{
\sigma_*x \ar[r] \ar[d] & x_\epsilon \ar[d]_e \\
x \ar[r]^d        & x_0
}
$$
is commutative. Hence by (S2) we obtain a morphism $\sigma_*x \to y$
such that $\sigma_*x \to y \to x$ is the given map $\sigma_*x \to x$.
The solution to the problem is now to take $a : x \to y$ equal to
the composition $x \to \sigma_*x \to y$.
\end{proof}

\begin{lemma}
\label{lemma-lifting-along-small-extension}
Consider a commutative diagram in a predeformation category $\mathcal{F}$
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d] & x_2 \ar[d]^{a_2} \\
x_1 \ar[r]^{a_1}        & x
}
}
\quad\text{lying over}
\vcenter{
\xymatrix{
A_1 \times_A A_2 \ar[r] \ar[d] & A_2 \ar[d]^{f_2} \\
A_1 \ar[r]^{f_1} & A
}
}
$$
in $\mathcal{C}_\Lambda$ where
$f_2 : A_2 \to A$ is a small extension.
Assume there is a map $h : A_1 \to A_2$ such that $f_2 = f_1 \circ h$.
Let $I = \Ker(f_2)$. Consider the ring map
$$
g : A_1 \times_A A_2 \longrightarrow k[I] = k \oplus I, \quad
(u, v) \longmapsto \overline{u} \oplus (v - h(u))
$$
Choose a pushforward $y \to g_*y$. Assume $\mathcal{F}$ satisfies (S2).
If there exists a morphism $x_1 \to g_*y$, then there exists a
morphism $b: x_1 \to x_2$ such that $a_1 =  a_2 \circ b$.
\end{lemma}

\begin{proof}
Note that
$\text{id}_{A_1} \times g : A_1 \times_A A_2 \to A_1 \times_k k[I]$
is an isomorphism and that $k[I] \cong k[\epsilon]$. Hence we have a diagram
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d] & g_*y \ar[d] \\
x_1 \ar[r]        & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A_1 \times_k k[\epsilon] \ar[r] \ar[d] & k[\epsilon] \ar[d] \\
A_1 \ar[r] & k.
}
}
$$
where $x_0$ is an object of $\mathcal{F}$ lying over $k$ (every object
of $\mathcal{F}$ has a unique morphism to $x_0$, see
discussion following Definition \ref{definition-predeformation-category}).
If we have a morphism $x_1 \to g_*y$ then
Lemma \ref{lemma-lifting-section}
provides us with a section $s : x_1 \to y$ of the map $y \to x_1$.
Composing this with the map $y \to x_2$ we obtain $b : x_1 \to x_2$
which has the property that $a_1 =  a_2 \circ b$ because
the diagram of the lemma commutes and because $s$ is a section.
\end{proof}





\section{Tangent spaces of functors}
\label{section-tangent-spaces-functors}

\noindent
Let $R$ be a ring. We write $\text{Mod}_R$ for the category of
$R$-modules and $\text{Mod}^{fg}_R$ for the category of finitely
generated $R$-modules.

\begin{definition}
\label{definition-linear}
Let $L: \text{Mod}^{fg}_R \to \text{Mod}_R$,
resp.\ $L: \text{Mod}_R \to \text{Mod}_R$
be a functor.  We say that $L$ is {\it $R$-linear} if for every
pair of objects $M, N$ of $\text{Mod}^{fg}_R$, resp.\ $\text{Mod}_R$
the map
$$
L : \Hom_R(M, N) \longrightarrow \Hom_R(L(M), L(N))
$$
is a map of $R$-modules.
\end{definition}

\begin{remark}
\label{remark-linear-enriched-over-modules}
One can define the notion of an $R$-linearity for any functor between
categories enriched over $\text{Mod}_R$. We made the definition
specifically for functors $L: \text{Mod}^{fg}_R \to \text{Mod}_R$ and
$L: \text{Mod}_R \to \text{Mod}_R$
because these are the cases that we have needed so far.
\end{remark}

\begin{remark}
\label{remark-linear-functor}
If $L: \text{Mod}^{fg}_R \to \text{Mod}_R$ is an $R$-linear functor,
then $L$ preserves finite products and sends the zero module to the zero
module, see
Homology, Lemma \ref{homology-lemma-additive-additive}.
On the other hand, if a functor $\text{Mod}^{fg}_R \to \textit{Sets}$
preserves finite products and sends the zero module to a one element set,
then it has a unique lift to a $R$-linear functor, see
Lemma \ref{lemma-linear-functor}.
\end{remark}

\begin{lemma}
\label{lemma-linear-functor}
Let $L: \text{Mod}^{fg}_R \to \textit{Sets}$,
resp.\ $L: \text{Mod}_R \to \textit{Sets}$ be a
functor.  Suppose $L(0)$ is a one element set and $L$ preserves finite
products.  Then there exists a unique $R$-linear functor
$\widetilde{L} : \text{Mod}^{fg}_R \to \text{Mod}_R$,
resp.\  $\widetilde{L} : \text{Mod}^{fg}_R \to \text{Mod}_R$,
such that
$$
\vcenter{
\xymatrix{
& \text{Mod}_R \ar[dr]^{\text{forget}} &   \\
\text{Mod}^{fg}_R  \ar[ur]^{\widetilde{L}} \ar[rr]^{L} &  &
\textit{Sets}
}
}
\quad\text{resp.}\quad
\vcenter{
\xymatrix{
& \text{Mod}_R \ar[dr]^{\text{forget}} &   \\
\text{Mod}_R  \ar[ur]^{\widetilde{L}} \ar[rr]^{L} &  &
\textit{Sets}
}
}
$$
commutes.
\end{lemma}

\begin{proof}
We only prove this in case $L: \text{Mod}^{fg}_R \to \textit{Sets}$.
Let $M$ be a finitely generated $R$-module. We define $\widetilde{L}(M)$ to be
the set $L(M)$ with the following $R$-module structure.

\medskip\noindent
Multiplication: If $r \in R$, multiplication by $r$ on $L(M)$ is defined to be
the map $L(M) \to L(M)$ induced by the multiplication map
$r \cdot : M \to M$.

\medskip\noindent
Addition: The sum map $M \times M \to M: (m_1, m_2) \mapsto m_1 + m_2$
induces a map $L(M \times M) \to L(M)$. By assumption $L(M \times M)$
is canonically isomorphic to $L(M) \times L(M)$.  Addition on $L(M)$ is defined
by the map $L(M) \times L(M) \cong L(M \times M) \to L(M)$.

\medskip\noindent
Zero: There is a unique map $0 \to M$. The zero element of $L(M)$ is
the image of $L(0) \to L(M)$.

\medskip\noindent
We omit the verification that this defines an $R$-module $\widetilde{L}(M)$,
the unique such that is $R$-linearly functorial in $M$.
\end{proof}

\begin{lemma}
\label{lemma-morphism-linear-functors}
Let $L_1, L_2: \text{Mod}^{fg}_R \to \textit{Sets}$ be
functors that take $0$ to a one element set and preserve finite products.
Let $t : L_1 \to L_2$ be a morphism of functors. Then $t$ induces a morphism
$\widetilde{t} : \widetilde{L}_1 \to \widetilde{L}_2$ between the
functors guaranteed by Lemma \ref{lemma-linear-functor}, which is given simply
by $\widetilde{t}_M = t_M: \widetilde{L}_1(M) \to \widetilde{L}_2(M)$
for each $M \in \Ob(\text{Mod}^{fg}_R)$. In other words,
$t_M: \widetilde{L}_1(M) \to \widetilde{L}_2(M)$ is a map of $R$-modules.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
In the case $R = K$ is a field, a $K$-linear functor
$L : \text{Mod}^{fg}_K \to \text{Mod}_K$ is determined by its value $L(K)$.

\begin{lemma}
\label{lemma-linear-functor-over-field}
Let $K$ be a field. Let $L: \text{Mod}^{fg}_K \to
\text{Mod}_K$ be a $K$-linear functor.  Then $L$ is isomorphic to the
functor $L(K) \otimes_K - : \text{Mod}^{fg}_K \to
\text{Mod}_K$.
\end{lemma}

\begin{proof}
For $V \in \Ob(\text{Mod}^{fg}_K)$, the isomorphism
$L(K) \otimes_K V \to L(V)$ is given on pure tensors by
$x \otimes v \mapsto L(f_v)(x)$, where $f_v: K \to V$ is the $K$-linear map
sending $1 \mapsto v$.  When $V = K$, this is the isomorphism
$L(K) \otimes_K K \to L(K)$ given by multiplication by $K$.
For general $V$, it is an isomorphism by the case $V = K$ and the
fact that $L$ commutes with finite
products (Remark \ref{remark-linear-functor}).
\end{proof}

\noindent
For a ring $R$ and an $R$-module $M$, let $R[M]$ be the $R$-algebra whose
underlying $R$-module is $R \oplus M$ and whose multiplication is given by
$(r, m) \cdot (r', m') = (rr', rm' + r'm)$.  When $M = R$ this is the ring of
dual numbers over $R$, which we denote by $R[\epsilon]$.

\medskip\noindent
Now let $S$ be a ring and assume $R$ is an $S$-algebra.
Then the assignment $M \mapsto R[M]$ determines a functor
$\text{Mod}_R \to S\text{-Alg}/R$, where $S\text{-Alg}/R$
denotes the category of $S$-algebras over $R$. Note that
$S\text{-Alg}/R$ admits finite products: if $A_1 \to R$ and
$A_2 \to R$ are two objects, then $A_1 \times_R A_2$ is a product.

\begin{lemma}
\label{lemma-preserves-products}
Let $R$ be an $S$-algebra. Then the functor
$\text{Mod}_R \to S\text{-Alg}/R$ described above preserves finite products.
\end{lemma}

\begin{proof}
This is merely the statement that if $M$ and $N$ are $R$-modules, then the map
$R[M \times N] \to R[M] \times_R R[N]$ is an isomorphism in
$S\text{-Alg}/R$.
\end{proof}

\begin{lemma}
\label{lemma-tangent-space-functor}
Let $R$ be an $S$-algebra, and let $\mathcal{C}$ be a strictly full
subcategory of $S\text{-Alg}/R$ containing $R[M]$ for all
$M \in \Ob(\text{Mod}^{fg}_R)$.
Let $F: \mathcal{C} \to \textit{Sets}$ be a functor. Suppose that
$F(R)$ is a one element set and that for any $M, N \in
\Ob(\text{Mod}^{fg}_R)$, the induced map
$$
F(R[M] \times_R R[N]) \to F(R[M]) \times F(R[N])
$$
is a bijection. Then $F(R[M])$ has a natural $R$-module structure for any $M
\in \Ob(\text{Mod}^{fg}_R)$.
\end{lemma}

\begin{proof}
Note that $R \cong R[0]$ and $R[M] \times_R R[N] \cong R[M \times N]$ hence
$R$ and $R[M] \times_R R[N]$ are objects of $\mathcal{C}$ by our assumptions on
$\mathcal{C}$. Thus the conditions on $F$ make sense.
The functor $\text{Mod}_R \to S\text{-Alg}/R$ of
Lemma \ref{lemma-preserves-products}
restricts to a functor $\text{Mod}^{fg}_R \to \mathcal{C}$
by the assumption on $\mathcal{C}$. Let $L$ be the composition
$\text{Mod}^{fg}_R \to \mathcal{C} \to \textit{Sets}$, i.e.,
$L(M) = F(R[M])$.
Then $L$ preserves finite products by
Lemma \ref{lemma-preserves-products}
and the assumption on $F$. Hence
Lemma \ref{lemma-linear-functor}
shows that $L(M) = F(R[M])$ has a natural $R$-module structure for any
$M \in \Ob(\text{Mod}^{fg}_R)$.
\end{proof}

\begin{definition}
\label{definition-tangent-space-over-R}
Let $\mathcal{C}$ be a category as in
Lemma \ref{lemma-tangent-space-functor}.
Let $F : \mathcal{C} \to \textit{Sets}$ be a functor such that
$F(R)$ is a one element set. The {\it tangent space $TF$ of $F$} is
$F(R[\epsilon])$.
\end{definition}

\noindent
When $F : \mathcal{C} \to \textit{Sets}$ satisfies the hypotheses of
Lemma \ref{lemma-tangent-space-functor},
the tangent space $TF$ has a natural $R$-module structure.

\begin{example}
\label{example-tangent-space-functor}
Since $\mathcal{C}_\Lambda$ contains all $k[V]$ for finite dimensional
vector spaces $V$ we see that
Definition \ref{definition-tangent-space-over-R} applies with
$S = \Lambda$, $R = k$, $\mathcal{C} = \mathcal{C}_\Lambda$, and
$F : \mathcal{C}_\Lambda \to \textit{Sets}$ a
predeformation functor. The tangent space is $TF = F(k[\epsilon])$.
\end{example}

\begin{example}
\label{example-tangent-space-prorepresentable-functor}
Let us work out the tangent space of
Example \ref{example-tangent-space-functor}
when $F : \mathcal{C}_\Lambda \to \textit{Sets}$ is a
prorepresentable functor, say $F = \underline{S}|_{\mathcal{C}_\Lambda}$
for $S \in \Ob(\widehat{\mathcal{C}}_\Lambda)$. Then $F$ commutes
with arbitrary limits and thus satisfies the hypotheses of
Lemma \ref{lemma-tangent-space-functor}.
We compute
$$
TF = F(k[\epsilon]) = \Mor_{\mathcal{C}_\Lambda}(S, k[\epsilon])
= \text{Der}_\Lambda(S, k)
$$
and more generally for a finite dimensional $k$-vector space $V$ we have
$$
F(k[V]) = \Mor_{\mathcal{C}_\Lambda}(S, k[V]) = \text{Der}_\Lambda(S, V).
$$
Explicitly, a $\Lambda$-algebra map $f : S \to k[V]$ compatible with
the augmentations $q : S \to k$ and $k[V] \to k$ corresponds to the derivation
$D$ defined by $s \mapsto f(s) - q(s)$. Conversely, a
$\Lambda$-derivation $D : S \to V$ corresponds to $f : S \to k[V]$
in $\mathcal{C}_\Lambda$ defined by the rule $f(s) = q(s) + D(s)$. Since
these identifications are functorial we see that the $k$-vector spaces
structures on $TF$ and $\text{Der}_\Lambda(S, k)$ correspond (see
Lemma \ref{lemma-morphism-linear-functors}).
It follows that $\dim_k TF$ is finite by
Lemma \ref{lemma-derivations-finite}.
\end{example}

\begin{example}
\label{example-tangent-space-classical-prorepresentable-functor}
The computation of
Example \ref{example-tangent-space-prorepresentable-functor}
simplifies in the classical case. Namely, in this case
the tangent space of the functor
$F = \underline{S}|_{\mathcal{C}_\Lambda}$ is simply the
relative cotangent space of $S$ over $\Lambda$, in a formula
$TF = T_{S/\Lambda}$. In fact, this works more generally when the
field extension $k' \subset k$ is separable. See
Exercises, Exercise \ref{exercises-exercise-tangent-space-Zariski}.
\end{example}

\begin{lemma}
\label{lemma-morphism-tangent-spaces}
Let $F, G: \mathcal{C} \to \textit{Sets}$ be functors satisfying
the hypotheses of
Lemma \ref{lemma-tangent-space-functor}.
Let $t : F \to G$ be a morphism of functors. For any
$M \in \Ob(\text{Mod}^{fg}_R)$, the map
$t_{R[M]}: F(R[M]) \to G(R[M])$ is a map of $R$-modules, where
$F(R[M])$ and $G(R[M])$ are given the $R$-module structure from
Lemma \ref{lemma-tangent-space-functor}.
In particular, $t_{R[\epsilon]} : TF \to TG$ is a map of $R$-modules.
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-morphism-linear-functors}.
\end{proof}

\begin{example}
\label{example-tangent-space-map-prorepresentable-functor}
Suppose that $f : R \to S$ is a ring map in $\widehat{\mathcal{C}}_\Lambda$.
Set $F = \underline{R}|_{\mathcal{C}_\Lambda}$ and
$G = \underline{S}|_{\mathcal{C}_\Lambda}$. The ring map
$f$ induces a transformation of functors $G \to F$. By
Lemma \ref{lemma-morphism-tangent-spaces}
we get a $k$-linear map $TG \to TF$. This is the map
$$
TG = \text{Der}_\Lambda(S, k) \longrightarrow \text{Der}_\Lambda(R, k) = TF
$$
as follows from the canonical identifications
$F(k[V]) = \text{Der}_\Lambda(R, V)$ and
$G(k[V]) = \text{Der}_\Lambda(S, V)$ of
Example \ref{example-tangent-space-prorepresentable-functor}
and the rule for computing the map on tangent spaces.
\end{example}

\begin{lemma}
\label{lemma-tangent-space-tensor}
Let $F: \mathcal{C} \to \textit{Sets}$ be a functor satisfying the
hypotheses of
Lemma \ref{lemma-tangent-space-functor}.
Assume $R = K$ is a field. Then $F(K[V]) \cong TF \otimes_K V$
for any finite dimensional $K$-vector space $V$.
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-linear-functor-over-field}.
\end{proof}






\section{Tangent spaces of predeformation categories}
\label{section-tangent-spaces}

\noindent
We will define tangent spaces of predeformation functors using the general
Definition \ref{definition-tangent-space-over-R}.
We have spelled this out in
Example \ref{example-tangent-space-functor}.
It applies to predeformation categories by looking at the associated
functor of isomorphism classes.

\begin{definition}
\label{definition-tangent-space}
Let $\mathcal{F}$ be a predeformation category.
The {\it tangent space $T \mathcal{F}$ of $\mathcal{F}$}
is the set $\overline{\mathcal{F}}(k[\epsilon])$
of isomorphism classes of objects in the fiber category $\mathcal
F(k[\epsilon])$.
\end{definition}

\noindent
Thus $T \mathcal{F}$ is nothing but the tangent space of the associated
functor $\overline{\mathcal{F}}: \mathcal{C}_\Lambda \to \textit{Sets}$.
It has a natural vector space structure when $\mathcal{F}$ satisfies (S2),
or, in fact, as long as $\overline{\mathcal{F}}$ does.

\begin{lemma}
\label{lemma-tangent-space-vector-space}
Let $\mathcal{F}$ be a predeformation category such that
$\overline{\mathcal{F}}$ satisfies (S2)\footnote{For example
if $\mathcal{F}$ satisfies (S2), see
Lemma \ref{lemma-S1-S2-associated-functor}.}. Then $T \mathcal{F}$ has a
natural $k$-vector space structure. For any finite dimensional
vector space $V$ we have
$\overline{\mathcal{F}}(k[V]) = T\mathcal{F} \otimes_k V$
functorially in $V$.
\end{lemma}

\begin{proof}
Let us write
$F = \overline{\mathcal{F}} : \mathcal{C}_\Lambda \to \textit{Sets}$.
This is a predeformation functor and $F$ satisfies (S2). By
Lemma \ref{lemma-S2-extensions}
(and the translation of
Remark \ref{remark-compare-S1-S2-schlessinger})
we see that
$$
F(A \times_k k[V]) \longrightarrow F(A) \times F(k[V])
$$
is a bijection for every finite dimensional vector space $V$ and every
$A \in \Ob(\mathcal{C}_\Lambda)$. In particular, if $A = k[W]$
then we see that $F(k[W] \times_k k[V]) = F(k[W]) \times F(k[V])$.
In other words, the hypotheses of
Lemma \ref{lemma-tangent-space-functor}
hold and we see that $TF = T \mathcal{F}$
has a natural $k$-vector space structure.
The final assertion follows from
Lemma \ref{lemma-tangent-space-tensor}.
\end{proof}

\noindent
A morphism of predeformation categories induces a map on tangent spaces.

\begin{definition}
\label{definition-differential}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a morphism predeformation
categories. The
{\it differential $d \varphi : T \mathcal{F} \to T \mathcal{G}$ of $\varphi$}
is the map obtained by evaluating the morphism of functors
$\overline{\varphi}: \overline{\mathcal{F}} \to \overline{\mathcal{G}}$
at $A = k[\epsilon]$.
\end{definition}

\begin{lemma}
\label{lemma-k-linear-differential}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a morphism of predeformation
categories. Assume $\overline{\mathcal{F}}$ and $\overline{\mathcal{G}}$ both
satisfy (S2). Then $d \varphi : T \mathcal{F} \to T \mathcal{G}$ is $k$-linear.
\end{lemma}

\begin{proof}
In the proof of
Lemma \ref{lemma-tangent-space-vector-space}
we have seen that $\overline{\mathcal{F}}$ and $\overline{\mathcal{G}}$
satisfy the hypotheses of
Lemma \ref{lemma-tangent-space-functor}.
Hence the lemma follows from
Lemma \ref{lemma-morphism-tangent-spaces}.
\end{proof}

\begin{remark}
\label{remark-tangent-space-cofibered-groupoid}
We can globalize the notions of tangent space and differential to arbitrary
categories cofibered in groupoids as follows. Let $\mathcal{F}$ be a category
cofibered in groupoids over $\mathcal{C}_\Lambda$, and let
$x \in \Ob(\mathcal{F}(k))$. As in
Remark \ref{remark-localize-cofibered-groupoid},
we get a predeformation category $\mathcal{F}_x$. We define
$$
T_x\mathcal{F} = T\mathcal{F}_x
$$
to be the {\it tangent space of $\mathcal{F}$ at $x$}. If
$\varphi : \mathcal{F} \to \mathcal{G}$ is a morphism of categories cofibered
in groupoids over $\mathcal{C}_\Lambda$ and $x \in \Ob(\mathcal{F}(k))$,
then there is an induced morphism
$\varphi_x: \mathcal{F}_x \to \mathcal{G}_{\varphi(x)}$. We define the
{\it differential
$d_x \varphi : T_x \mathcal{F} \to T_{\varphi(x)} \mathcal{G}$
of $\varphi$ at $x$} to be the map
$d \varphi_x: T \mathcal{F}_x \to T \mathcal{G}_{\varphi(x)}$.
If both $\mathcal{F}$ and $\mathcal{G}$ satisfy (S2) then
all of these tangent spaces have a natural $k$-vector space structure
and all the differentials
$d_x \varphi : T_x \mathcal{F} \to T_{\varphi(x)} \mathcal{G}$
are $k$-linear (use
Lemmas \ref{lemma-S1-S2-localize} and \ref{lemma-k-linear-differential}).
\end{remark}

\noindent
The following observations are uninteresting in the classical case or when
$k' \subset k$ is a separable field extension, because then
$\text{Der}_\Lambda(k, k)$ and $\text{Der}_\Lambda(k, V)$ are zero.
There is a canonical identification
$$
\Mor_{\mathcal{C}_\Lambda}(k, k[\epsilon]) =
\text{Der}_\Lambda(k, k).
$$
Namely, for $D \in \text{Der}_\Lambda(k, k)$ let $f_D : k \to k[\epsilon]$
be the map $a \mapsto a + D(a)\epsilon$. More generally, given a finite
dimensional vector space $V$ over $k$ we have
$$
\Mor_{\mathcal{C}_\Lambda}(k, k[V]) =
\text{Der}_\Lambda(k, V)
$$
and we will use the same notation $f_D$ for the map associated to the
derivation $D$. We also have
$$
\Mor_{\mathcal{C}_\Lambda}(k[W], k[V]) =
\Hom_k(V, W) \oplus \text{Der}_\Lambda(k, V)
$$
where $(\varphi, D)$ corresponds to the map
$f_{\varphi, D} : a + w \mapsto a + \varphi(w) + D(a)$. We will sometimes write
$f_{1, D} : a + v \to a + v + D(a)$ for the automorphism
of $k[V]$ determined by the derivation $D : k \to V$. Note that
$f_{1, D} \circ f_{1, D'} = f_{1, D + D'}$.

\medskip\noindent
Let $\mathcal{F}$ be a predeformation category over $\mathcal{C}_\Lambda$.
Let $x_0 \in \Ob(\mathcal{F}(k))$. By the above there is a canonical
map
$$
\gamma_V :
\text{Der}_\Lambda(k, V)
\longrightarrow
\overline{\mathcal{F}}(k[V])
$$
defined by $D \mapsto f_{D, *}(x_0)$. Moreover, there is an action
$$
a_V : \text{Der}_\Lambda(k, V) \times \overline{\mathcal{F}}(k[V])
\longrightarrow
\overline{\mathcal{F}}(k[V])
$$
defined by $(D, x) \mapsto f_{1, D, *}(x)$. These two maps are compatible,
i.e., $f_{1, D, *}f_{D', *}x_0 = f_{D + D', *}x_0$ as follows from a
computation of the compositions of these maps. Note that the maps
$\gamma_V$ and $a_V$ are independent of the choice of $x_0$ as there
is a unique $x_0$ up to isomorphism.

\begin{lemma}
\label{lemma-action-linear}
Let $\mathcal{F}$ be a predeformation category over $\mathcal{C}_\Lambda$.
If $\overline{\mathcal{F}}$ has (S2) then the maps $\gamma_V$ are
$k$-linear and we have $a_V(D, x) = x + \gamma_V(D)$.
\end{lemma}

\begin{proof}
In the proof of
Lemma \ref{lemma-tangent-space-vector-space}
we have seen that the functor $V \mapsto \overline{\mathcal{F}}(k[V])$
transforms $0$ to a singleton and products to products. The same is
true of the functor $V \mapsto \text{Der}_\Lambda(k, V)$.
Hence $\gamma_V$ is linear by
Lemma \ref{lemma-morphism-linear-functors}.
Let $D : k \to V$ be a $\Lambda$-derivation.
Set $D_1 : k \to V^{\oplus 2}$ equal to $a \mapsto (D(a), 0)$.
Then
$$
\xymatrix{
k[V \times V] \ar[r]_{+} \ar[d]^{f_{1, D_1}} & k[V] \ar[d]^{f_{1, D}} \\
k[V \times V] \ar[r]^{+} & k[V]
}
$$
commutes. Unwinding the definitions and using that
$\overline{F}(V \times V) = \overline{F}(V) \times \overline{F}(V)$
this means that $a_D(x_1) + x_2 = a_D(x_1 + x_2)$ for all
$x_1, x_2 \in \overline{F}(V)$. Thus it suffices to show that
$a_V(D, 0) = 0 + \gamma_V(D)$ where $0 \in \overline{F}(V)$ is
the zero vector. By definition this is the element $f_{0, *}(x_0)$.
Since $f_D = f_{1, D} \circ f_0$ the desired result follows.
\end{proof}

\noindent
A special case of the constructions above are the map
\begin{equation}
\label{equation-map}
\gamma : \text{Der}_\Lambda(k, k) \longrightarrow T\mathcal{F}
\end{equation}
and the action
\begin{equation}
\label{equation-action}
a : \text{Der}_\Lambda(k, k) \times T\mathcal{F} \longrightarrow T\mathcal{F}
\end{equation}
defined for any predeformation category $\mathcal{F}$.
Note that if $\varphi : \mathcal{F} \to \mathcal{G}$ is a morphism
of predeformation categories, then we get commutative diagrams
$$
\vcenter{
\xymatrix{
\text{Der}_\Lambda(k, k) \ar[r]_-\gamma \ar[rd]_\gamma &
T\mathcal{F} \ar[d]_{d\varphi} \\
& T\mathcal{G}
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
\text{Der}_\Lambda(k, k) \times T\mathcal{F} \ar[r]_-a
\ar[d]_{1 \times d\varphi} &
T\mathcal{F} \ar[d]^{d\varphi} \\
\text{Der}_\Lambda(k, k) \times T\mathcal{G} \ar[r]^-a &
T\mathcal{G}
}
}
$$










\section{Versal formal objects}
\label{section-versal-objects}

\noindent
The existence of a versal formal object forces $\mathcal{F}$ to have
property (S1).

\begin{lemma}
\label{lemma-versal-object-S1}
Let $\mathcal{F}$ be a predeformation category.
Assume $\mathcal{F}$ has a versal formal object.
Then $\mathcal{F}$ satisfies (S1).
\end{lemma}

\begin{proof}
Let $\xi$ be a versal formal object of $\mathcal{F}$. Let
$$
\xymatrix{
           & x_2 \ar[d] \\
x_1 \ar[r] & x
}
$$
be a diagram in $\mathcal{F}$ such that $x_2 \to x$ lies over a
surjective ring map. Since the natural morphism
$\widehat{\mathcal{F}}|_{\mathcal{C}_\Lambda} \xrightarrow{\sim} \mathcal{F}$
is an equivalence (see
Remark \ref{remark-restrict-completion}), we can consider this
diagram also as a diagram in $\widehat{\mathcal{F}}$. By
Lemma \ref{lemma-versal-object-quasi-initial} there exists a morphism
$\xi \to x_1$, so by
Remark \ref{remark-versal-object} we also get a
morphism $\xi \to x_2$ making the diagram
$$
\xymatrix{
\xi \ar[r] \ar[d]          & x_2 \ar[d] \\
x_1 \ar[r] & x
}
$$
commute. If $x_1 \to x$ and $x_2 \to x$ lie above ring maps
$A_1 \to A$ and $A_2 \to A$ then taking the pushforward of
$\xi$ to $A_1 \times_A A_2$ gives an object $y$ as required by (S1).
\end{proof}

\noindent
In the case that our cofibred category satisfies (S1) and (S2)
we can characterize the versal formal objects as follows.

\begin{lemma}
\label{lemma-versal-criterion}
Let $\mathcal{F}$ be a predeformation category satisfying (S1) and
(S2). Let $\xi$ be a formal object of $\mathcal{F}$ corresponding to
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$, see
Remark \ref{remark-formal-objects-yoneda}.
Then $\xi$ is versal if and only if the following two conditions hold:
\begin{enumerate}
\item the map
$d\underline{\xi} : T\underline{R}|_{\mathcal{C}_\Lambda} \to T\mathcal{F}$
on tangent spaces is surjective, and
\item given a diagram in $\widehat{\mathcal{F}}$
$$
\vcenter{
\xymatrix{
            &  y \ar[d] \\
\xi \ar[r]  &  x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
         &   B  \ar[d]^{f} \\
R \ar[r] &   A
}
}
$$
in $\widehat{\mathcal{C}}_\Lambda$ with $B \to A$ a small extension of
Artinian rings, then there exists a ring map $R \to B$ such that
$$
\xymatrix{
         &   B  \ar[d]^{f} \\
R \ar[ur] \ar[r] &   A
}
$$
commutes.
\end{enumerate}
\end{lemma}

\begin{proof}
If $\xi$ is versal then (1) holds by
Lemma \ref{lemma-smooth-morphism-essentially-surjective}
and (2) holds by
Remark \ref{remark-versal-object}.
Assume (1) and (2) hold. By
Remark \ref{remark-versal-object}
we must show that given a diagram in $\widehat{\mathcal{F}}$ as in (2),
there exists $\xi \to y$ such that
$$
\xymatrix{
            &  y \ar[d] \\
\xi \ar[ur] \ar[r]  &  x
}
$$
commutes. Let $b : R \to B$ be the map guaranteed by (2). Denote
$y' = b_*\xi$ and choose a factorization $\xi \to y' \to x$
lying over $R \to B \to A$ of the given morphism $\xi \to x$.
By (S1) we obtain a commutative diagram
$$
\vcenter{
\xymatrix{
z  \ar[r] \ar[d]          &  y \ar[d] \\
y' \ar[r]  &  x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
B \times_A B \ar[d] \ar[r] &   B  \ar[d]^{f} \\
B \ar[r]^{f} &   A .
}
}
$$
Set $I = \Ker(f)$. Let $\overline{g} : B \times_A B \to k[I]$
be the ring map $(u, v) \mapsto \overline{u} \oplus (v - u)$,
cf.\ Lemma \ref{lemma-lifting-along-small-extension}.
By (1) there exists a morphism $\xi \to \overline{g}_*z$ which lies over a ring
map $i : R \to k[\epsilon]$. Choose an Artinian quotient
$b_1 : R \to B_1$ such that both $b : R \to B$ and $i : R \to k[\epsilon]$
factor through $R \to B_1$, i.e., giving
$h : B_1 \to B$ and $i' : B_1 \to k[\epsilon]$.
Choose a pushforward $y_1 = b_{1, *}\xi$, a factorization
$\xi \to y_1 \to y'$ lying over $R \to B_1 \to B$ of $\xi \to y'$, and a
factorization $\xi \to y_1 \to \overline{g}_*z$ lying over
$R \to B_1 \to k[\epsilon]$ of $\xi \to \overline{g}_*z$.
Applying (S1) once more we obtain
$$
\vcenter{
\xymatrix{
z_1  \ar[r] \ar[d] & z \ar[r] \ar[d] & y \ar[d] \\
y_1 \ar[r] & y' \ar[r] &  x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
B_1 \times_A B \ar[d] \ar[r] & B \times_A B \ar[r] \ar[d] & B \ar[d]^{f} \\
B_1 \ar[r]  & B \ar[r] &  A .
}
}
$$
Note that the map $g : B_1 \times_A B \to k[I]$ of
Lemma \ref{lemma-lifting-along-small-extension}
(defined using $h$)
is the composition of $B_1 \times_A B \to B \times_A B$ and the map
$\overline{g}$ above. By construction there exists a morphism
$y_1 \to g_*z_1 \cong \overline{g}_*z$! Hence
Lemma \ref{lemma-lifting-along-small-extension}
applies (to the outer rectangles in the diagrams above)
to give a morphism $y_1 \to y$ and precomposing
with $\xi \to y_1$ gives the desired morphism $\xi \to y$.
\end{proof}

\noindent
If $\mathcal{F}$ has property (S1) then the ``largest quotient where
a lift exists'' exists. Here is a precise statement.

\begin{lemma}
\label{lemma-largest-closed-where-lift}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$ which has (S1). Let $B \to A$ be a surjection
in $\mathcal{C}_\Lambda$ with kernel $I$ annihilated by $\mathfrak m_B$.
Let $x \in \mathcal{F}(A)$. The set of ideals
$$
\mathcal{J} = \{ J \subset I \mid
\text{there exists an }y \to x\text{ lying over }B/J \to A\}
$$
has a smallest element.
\end{lemma}

\begin{proof}
Note that $\mathcal{J}$ is nonempty as $I \in \mathcal{J}$.
Also, if $J \in \mathcal{J}$ and $J \subset J' \subset I$ then
$J' \in \mathcal{J}$ because we can pushforward the object $y$ to an
object $y'$ over $B/J'$. Let $J$ and $K$ be elements of the displayed set.
We claim that $J \cap K \in \mathcal{J}$ which will prove the lemma.
Since $I$ is a $k$-vector space we can find an ideal $J \subset J' \subset I$
such that $J \cap K = J' \cap K$ and such that $J' + K = I$. By the above
we may replace $J$ by $J'$ and assume that $J + K = I$. In this case
$$
A/(J \cap K) = A/J \times_{A/I} A/K.
$$
Hence the existence of an element $z \in \mathcal{F}(A/(J \cap K))$
mapping to $x$ follows, via (S1), from the existence of the elements we have
assumed exist over $A/J$ and $A/K$.
\end{proof}

\noindent
We will improve on the following result later.

\begin{lemma}
\label{lemma-versal-object-existence}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$. Assume the following conditions hold:
\begin{enumerate}
\item $\mathcal{F}$ is a predeformation category.
\item $\mathcal{F}$ satisfies (S1).
\item $\mathcal{F}$ satisfies (S2).
\item $\dim_k T\mathcal{F}$ is finite.
\end{enumerate}
Then $\mathcal{F}$ has a versal formal object.
\end{lemma}

\begin{proof}
Assume (1), (2), (3), and (4) hold. Choose an object
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$
such that $\underline{R}|_{\mathcal{C}_\Lambda}$ is smooth.
See Lemma \ref{lemma-exists-smooth}.
Let $r = \dim_k T\mathcal{F}$ and put $S = R[[X_1, \ldots, X_r]]$.

\medskip\noindent
We are going to inductively construct for $n \geq 2$ pairs
$(J_n, f_{n - 1} : \xi_n \to \xi_{n - 1})$
where $J_n \subset S$ is an decreasing sequence of ideals and
$f_{n - 1} : \xi_n \to \xi_{n - 1}$ is a morphism of
$\mathcal{F}$ lying over the projection $S/J_n \to S/J_{n - 1}$.

\medskip\noindent
Step 1. Let $J_1 = \mathfrak m_S$. Let $\xi_1$ be the unique
(up to unique isomorphism) object of $\mathcal{F}$ over
$k = S/J_1 = S/\mathfrak m_S$

\medskip\noindent
Step 2. Let
$J_2 = \mathfrak m_S^2 + \mathfrak{m}_R S$. Then
$S/J_2 = k[V]$ with $V = kX_1 \oplus \ldots \oplus kX_r$
By (S2) for $\overline{\mathcal{F}}$ we get a bijection
$$
\overline{\mathcal{F}}(S/J_2)
\longrightarrow
T\mathcal{F} \otimes_k V,
$$
see
Lemmas \ref{lemma-S1-S2-associated-functor} and
\ref{lemma-tangent-space-vector-space}.
Choose a basis $\theta_1, \ldots, \theta_r$ for $T\mathcal{F}$ and set
$\xi_2 = \sum \theta_i \otimes X_i \in \Ob(\mathcal{F}(S/J_2))$.
The point of this choice is that
$$
d\xi_2 :
\Mor_{\mathcal{C}_\Lambda}(S/J_2, k[\epsilon])
\longrightarrow
T\mathcal{F}
$$
is surjective. Let $f_1 : \xi_2 \to \xi_1$ be the unique morphism.

\medskip\noindent
Induction step. Assume $(J_n, f_{n - 1} : \xi_n \to \xi_{n - 1})$ has been
constructed for some $n \geq 2$. There is a minimal element $J_{n + 1}$ of
the set of ideals $J \subset S$ satisfying:
(a) $\mathfrak m_S J_n \subset J \subset J_n$ and
(b) there exists a morphism $\xi_{n + 1} \to \xi_n$ lying over
$S/J \to S/J_n$, see
Lemma \ref{lemma-largest-closed-where-lift}.
Let $f_n : \xi_{n + 1} \to \xi_n$ be any morphism of $\mathcal{F}$
lying over $S/J_{n + 1} \to S/J_n$.

\medskip\noindent
Set $J = \bigcap J_n$. Set $\overline{S} = S/J$. Set $\overline{J}_n = J_n/J$.
By
Lemma \ref{lemma-m-adic-topology}
the sequence of ideals $(\overline{J}_n)$ induces the
$\mathfrak m_{\overline{S}}$-adic topology on $\overline{S}$.
Since $(\xi_n, f_n)$ is an object of
$\widehat{\mathcal{F}}_\mathcal{I}(\overline{S})$, where $\mathcal{I}$
is the filtration $(\overline{J}_n)$ of $\overline{S}$,
we see that $(\xi_n, f_n)$
induces an object $\xi$ of $\widehat{\mathcal{F}}(\overline{S})$.
see
Lemma \ref{lemma-formal-objects-different-filtration}.

\medskip\noindent
We prove $\xi$ is versal. For versality it suffices to check
conditions (1) and (2) of
Lemma \ref{lemma-versal-criterion}.
Condition (1) follows from our choice of $\xi_2$ in Step 2 above.
Suppose given a diagram in $\widehat{\mathcal{F}}$
$$
\vcenter{
\xymatrix{
            &  y \ar[d] \\
\eta \ar[r]  &  x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
         &   B  \ar[d]^{f} \\
\overline{S} \ar[r] &   A
}
}
$$
in $\widehat{\mathcal{C}}_\Lambda$ with $f: B \to A$ a small extension
of Artinian rings. We have to show there is a map $\overline{S} \to B$ fitting
into the diagram on the right. Choose $n$ such that
$\overline{S} \to A$ factors through $\overline{S} \to S/J_n$. This is
possible as the sequence $(\overline{J}_n)$ induces the
$\mathfrak m_{\overline{S}}$-adic topology as we saw above.
The pushforward of $\xi$ along $\overline{S} \to S/J_n$ is $\xi_n$.
We may factor $\xi \to x$ as $\xi \to \xi_n \to x$ hence we get a diagram
in $\mathcal{F}$
$$
\vcenter{
\xymatrix{
            &  y \ar[d] \\
\xi_n \ar[r]  &  x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
         &   B  \ar[d]^{f} \\
S/J_n \ar[r] &   A .
}
}
$$
To check condition (2) of
Lemma \ref{lemma-versal-criterion}
it suffices to complete the diagram
$$
\xymatrix{
S/J_{n + 1} \ar[d] \ar@{-->}[r] & B \ar[d]^{f} \\
S/J_n   \ar[r] & A
}
$$
or equivalently, to complete the diagram
$$
\xymatrix{
  &  S/J_n \times_A B \ar[d]^{p_1} \\
S/J_{n + 1} \ar@{-->}[ur] \ar[r] &  S/J_n.
}
$$
If $p_1$ has a section we are done. If not, by
Lemma \ref{lemma-fiber-product-CLambda} (2)
$p_1$ is a small extension, so by
Lemma \ref{lemma-essential-surjection} (4)
$p_1$ is an essential surjection. Recall that $S = R[[X_1, \ldots, X_r]]$
and that we chose $R$ such that $\underline{R}|_{\mathcal{C}_\Lambda}$
is smooth. Hence there exists a map $h : R \to B$ lifting the map
$R \to S \to S/J_n \to A$. By the universal property of a power series
ring there is an $R$-algebra map $h : S = R[[X_1, \ldots, X_2]] \to B$
lifting the given map $S \to S/J_n \to A$. This induces a map
$g: S \to S/J_n \times_A B$ making the solid square in the diagram
$$
\xymatrix{
S \ar[d] \ar[r]_-g  &  S/J_n \times_A B \ar[d]^{p_1} \\
S/J_{n + 1} \ar@{-->}[ur] \ar[r] &  S/J_n
}
$$
commute. Then $g$ is a surjection since $p_1$ is an essential surjection.
We claim the ideal $K = \Ker(g)$ of $S$ satisfies conditions (a) and
(b) of the construction of $J_{n + 1}$ in the induction step above.
Namely, $K \subset J_n$ is clear and $\mathfrak m_SJ_n \subset K$ as $p_1$
is a small extension; this proves (a). By (S1) applied to
$$
\xymatrix{
            &  y \ar[d] \\
\xi_n \ar[r]  &  x,
}
$$
there exists a lifting of $\xi_n$ to $S/K \cong S/J_n \times_A B$, so (b)
holds. Since $J_{n + 1}$ was the minimal ideal with properties (a) and (b)
this implies $J_{n + 1} \subset K$. Thus the desired map
$S/J_{n+1} \to S/K \cong S/J_n \times_A B$ exists.
\end{proof}

\begin{remark}
\label{remark-compare-schlessinger-H3-pre}
Let $F : \mathcal{C}_\Lambda \to \textit{Sets}$ be a predeformation functor
satisfying (S1) and (S2). The condition $\dim_k TF < \infty$
is precisely condition (H3) from Schlessinger's paper.
Recall that (S1) and (S2) correspond to conditions (H1) and (H2), see
Remark \ref{remark-compare-S1-S2-schlessinger}.
Thus Lemma \ref{lemma-versal-object-existence} tells us
$$
(H1) + (H2) + (H3)
\Rightarrow
\text{ there exists a versal formal object}
$$
for predeformation functors. We will make the link with hulls in
Remark \ref{remark-compare-schlessinger-H3}.
\end{remark}





\section{Minimal versal formal objects}
\label{section-minimal-versal}

\noindent
We do a little bit of work to try and understand (non)uniqueness
of versal formal objects. It turns out that if a predeformation category
has a versal formal object, then it has a minimal versal formal
object and any two such are isomorphic. Moreover, all versal formal
objects are ``more or less'' the same up to replacing the base ring
by a power series extension.

\medskip\noindent
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$. For every object $x$ of $\mathcal{F}$
lying over $A \in \Ob(\mathcal{C}_\Lambda)$ consider the
category $\mathcal{S}_x$ with objects
$$
\Ob(\mathcal{S}_x) =
\{x' \to x \mid x' \to x\text{ lies over }A' \subset A\}
$$
and morphisms are morphisms over $x$. For every $y \to x$ in
$\mathcal{F}$ lying over $f : B \to A$
in $\mathcal{C}_\Lambda$ there is a functor
$f_* : \mathcal{S}_y \to \mathcal{S}_x$ defined as follows:
Given $y' \to y$ lying over $B' \subset B$ set $A' = f(B')$
and let $y' \to x'$ be over $B' \to f(B')$ be the pushforward of $y'$.
By the axioms of a category cofibred in groupoids we obtain a
unique morphism $x' \to x$ lying over $f(B') \to A$ such that
$$
\xymatrix{
y' \ar[d] \ar[r] & x' \ar[d] \\
y \ar[r] & x
}
$$
commutes. Then $x' \to x$ is an object of $\mathcal{S}_x$. We say an
object $x' \to x$ of $\mathcal{S}_x$ is {\it minimal} if any morphism
$(x'_1 \to x) \to (x' \to x)$ in $\mathcal{S}_x$ is an isomorphism, i.e.,
$x'$ and $x'_1$ are defined over the same subring of $A$. Since
$A$ has finite length as a $\Lambda$-module we see that minimal objects
always exist.

\begin{lemma}
\label{lemma-smallest-where-descends}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$ which has (S1).
\begin{enumerate}
\item For $y \to x$ in $\mathcal{F}$ a minimal
object in $\mathcal{S}_y$ maps to a minimal object of $\mathcal{S}_x$.
\item For $y \to x$ in $\mathcal{F}$ lying over a surjection
$f : B \to A$ in $\mathcal{C}_\Lambda$ every minimal object
of $\mathcal{S}_x$ is the image of a minimal object of
$\mathcal{S}_y$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Say $y \to x$ lies over $f : B \to A$. Let $y' \to y$
lying over $B' \subset B$ be a minimal object of $\mathcal{S}_y$. Let
$$
\vcenter{
\xymatrix{
y' \ar[d] \ar[r] & x' \ar[d] \\
y \ar[r] & x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
B' \ar[d] \ar[r] & f(B') \ar[d] \\
B \ar[r] & A
}
}
$$
be as in the construction of $f_*$ above. Suppose that
$(x'' \to x) \to (x' \to x)$ is a morphism of $\mathcal{S}_x$
with $x'' \to x'$ lying over $A'' \subset f(B')$. By (S1)
there exists $y'' \to y'$ lying over $B' \times_{f(B')} A'' \to B'$.
Since $y' \to y$ is minimal we conclude that
$B' \times_{f(B')} A'' \to B'$ is an isomorphism, which implies that
$A'' = f(B')$, i.e., $x' \to x$ is minimal.

\medskip\noindent
Proof of (2). Suppose $f : B \to A$ is surjective and $y \to x$ lies over $f$.
Let $x' \to x$ be a minimal object of $\mathcal{S}_x$ lying over $A' \subset A$.
By (S1) there exists $y' \to y$ lying over
$B' = f^{-1}(A') = B \times_A A' \to B$ whose image in $\mathcal{S}_x$ is
$x' \to x$. So $f_*(y' \to y) = x' \to x$.
Choose a morphism $(y'' \to y) \to (y' \to y)$ in
$\mathcal{S}_y$ with $y'' \to y$ a minimal object (this is possible by
the remark on lengths above the lemma). Then $f_*(y'' \to y)$ is an
object of $\mathcal{S}_x$ which maps to $x' \to x$ (by functoriality of
$f_*$) hence is isomorphic to $x' \to x$ by minimality of $x' \to x$.
\end{proof}

\begin{lemma}
\label{lemma-smallest-where-descends-versal}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$ which has (S1). Let $\xi$ be a versal formal object
of $\mathcal{F}$ lying over $R$. There exists a morphism $\xi' \to \xi$
lying over $R' \subset R$ with the following minimality properties
\begin{enumerate}
\item for every $f : R \to A$ with $A \in \Ob(\mathcal{C}_\Lambda)$
the pushforwards
$$
\vcenter{
\xymatrix{
\xi' \ar[d] \ar[r] & x' \ar[d] \\
\xi \ar[r] & x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
R' \ar[d] \ar[r] & f(R') \ar[d] \\
R \ar[r] & A
}
}
$$
produce a minimal object $x' \to x$ of $\mathcal{S}_x$, and
\item for any morphism of formal objects $\xi'' \to \xi'$
the corresponding morphism $R'' \to R'$ is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
Write $\xi = (R, \xi_n, f_n)$. Set $R'_1 = k$ and
$\xi'_1 = \xi_1$. Suppose that we have constructed
minimal objects $\xi'_m \to \xi_m$ of $\mathcal{S}_{\xi_m}$
lying over $R'_m \subset R/\mathfrak m_R^m$ for $m \leq n$
and morphisms $f'_m : \xi'_{m + 1} \to \xi'_m$ compatible with $f_m$
for $m \leq n - 1$. By
Lemma \ref{lemma-smallest-where-descends} (2)
there exists a minimal object $\xi'_{n + 1} \to \xi_{n + 1}$ lying over
$R'_{n + 1} \subset R/\mathfrak m_R^{n + 1}$ whose image
is $\xi'_n \to \xi_n$ over $R'_n \subset R/\mathfrak m_R^n$.
This produces the commutative diagram
$$
\xymatrix{
\xi'_{n + 1} \ar[r]_{f'_n} \ar[d] & \xi'_n \ar[d] \\
\xi_{n + 1} \ar[r]^{f_n} & \xi_n
}
$$
by construction. Moreover the ring map $R'_{n + 1} \to R'_n$
is surjective. Set $R' = \lim_n R'_n$. Then $R' \to R$ is injective.

\medskip\noindent
However, it isn't a priori clear that $R'$ is Noetherian. To prove this
we use that $\xi$ is versal. Namely, versality implies that there exists
a morphism $\xi \to \xi'_n$ in $\widehat{\mathcal{F}}$, see
Lemma \ref{lemma-versal-object-quasi-initial}.
The corresponding map $R \to R'_n$ has to be surjective (as
$\xi'_n \to \xi_n$ is minimal in $\mathcal{S}_{\xi_n}$).
Thus the dimensions of the cotangent spaces are bounded and
Lemma \ref{lemma-limit-artinian}
implies $R'$ is Noetherian, i.e., an object of $\widehat{\mathcal{C}}_\Lambda$.
By
Lemma \ref{lemma-formal-objects-different-filtration}
(plus the result on filtrations of
Lemma \ref{lemma-limit-artinian})
the sequence of elements $\xi'_n$ defines a formal object $\xi'$ over $R'$
and we have a map $\xi' \to \xi$.

\medskip\noindent
By construction (1) holds for $R \to R/\mathfrak m_R^n$ for each $n$.
Since each $R \to A$ as in (1) factors through $R \to R/\mathfrak m_R^n \to A$
we see that (1) for $x' \to x$ over $f(R) \subset A$ follows from the
minimality of $\xi'_n \to \xi_n$ over $R'_n \to R/\mathfrak m_R^n$ by
Lemma \ref{lemma-smallest-where-descends} (1).

\medskip\noindent
If $R'' \to R'$ as in (2) is not surjective, then $R'' \to R' \to R'_n$
would not be surjective for some $n$ and $\xi'_n \to \xi_n$ wouldn't
be minimal, a contradiction. This contradiction proves (2).
\end{proof}

\begin{lemma}
\label{lemma-descends-versal}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$ which has (S1). Let $\xi$ be a versal formal object
of $\mathcal{F}$ lying over $R$. Let $\xi' \to \xi$ be a morphism
of formal objects lying over $R' \subset R$ as constructed in
Lemma \ref{lemma-smallest-where-descends-versal}.
Then
$$
R \cong R'[[x_1, \ldots, x_r]]
$$
is a power series ring over $R'$.
Moreover, $\xi'$ is a versal formal object too.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-versal-object-quasi-initial}
there exists a morphism $\xi \to \xi'$. By
Lemma \ref{lemma-smallest-where-descends-versal}
the corresponding map $f : R \to R'$ induces a surjection
$f|_{R'} : R' \to R'$. This is an isomorphism by
Algebra, Lemma \ref{algebra-lemma-surjective-endo-noetherian-ring-is-iso}.
Hence $I = \Ker(f)$ is an ideal of $R$ such that $R = R' \oplus I$.
Let $x_1, \ldots, x_n \in I$ be elements which form a basis for
$I/\mathfrak m_RI$. Consider the map
$S = R'[[X_1, \ldots, X_r]] \to R$ mapping $X_i$ to $x_i$.
For every $n \geq 1$ we get a surjection of Artinian $R'$-algebras
$B = S/\mathfrak m_S^n \to R/\mathfrak m_R^n = A$. Denote
$y \in \Ob(\mathcal{F}(B)$, resp.\ $x \in \Ob(\mathcal{F}(A))$
the pushforward of $\xi'$ along $R' \to S \to B$, resp.\ $R' \to S \to A$.
Note that $x$ is also the pushforward of $\xi$ along $R \to A$ as
$\xi$ is the pushforward of $\xi'$ along $R' \to R$.
Thus we have a solid diagram
$$
\vcenter{
\xymatrix{
& y \ar[d] \\
\xi \ar[r] \ar@{..>}[ru] & x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
& S/\mathfrak m_S^n \ar[d] \\
R \ar[r] \ar@{..>}[ru] & R/\mathfrak m_R^n
}
}
$$
Because $\xi$ is versal, using
Remark \ref{remark-versal-object}
we obtain the dotted arrows fitting into these diagrams.
In particular, the maps $S/\mathfrak m_S^n \to R/\mathfrak m_R^n$
have sections $h_n : R/\mathfrak m_R^n \to S/\mathfrak m_S^n$.
It follows from
Lemma \ref{lemma-power-series}
that $S \to R$ is an isomorphism.

\medskip\noindent
As $\xi$ is a pushforward of $\xi'$ along $R' \to R$ we obtain from
Remark \ref{remark-formal-objects-yoneda-map}
a commutative diagram
$$
\xymatrix{
\underline{R}|_{\mathcal{C}_\Lambda} \ar[rr] \ar[rd]_{\underline{\xi}} & &
\underline{R'}|_{\mathcal{C}_\Lambda} \ar[ld]^{\underline{\xi'}} \\
& \mathcal{F}
}
$$
Since $R' \to R$ has a left inverse (namely $R \to R/I = R'$) we see that
$\underline{R}|_{\mathcal{C}_\Lambda} \to
\underline{R'}|_{\mathcal{C}_\Lambda}$ is essentially surjective.
Hence by
Lemma \ref{lemma-smooth-properties}
we see that $\underline{\xi'}$ is smooth, i.e., $\xi'$ is a versal
formal object.
\end{proof}

\noindent
Motivated by the preceding lemmas we make the following definition.

\begin{definition}
\label{definition-minimal-versal}
Let $\mathcal{F}$ be a predeformation category.
We say a versal formal object $\xi$ of $\mathcal{F}$ is
{\it minimal}\footnote{This may be nonstandard terminology. Many
authors tie this notion in with properties of tangent spaces.
We will make the link in
Section \ref{section-miniversal-objects-existence}.}
if for any morphism of formal objects
$\xi' \to \xi$ the underlying map on rings is surjective.
Sometimes a minimal versal formal object is called {\it miniversal}.
\end{definition}

\noindent
The work in this section shows this definition is reasonable.
First of all, the existence of a versal formal object implies that
$\mathcal{F}$ has (S1). Then the preceding lemmas
show there exists a minimal versal formal object. Finally, any
two minimal versal formal objects are isomorphic. Here is a summary
of our results (with detailed proofs).

\begin{lemma}
\label{lemma-minimal-versal}
Let $\mathcal{F}$ be a predeformation category which
has a versal formal object. Then
\begin{enumerate}
\item $\mathcal{F}$ has a minimal versal formal object,
\item minimal versal objects are unique up to isomorphism, and
\item any versal object is the pushforward of a minimal versal
object along a power series ring extension.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $\mathcal{F}$ has a versal formal object $\xi$ over $R$.
Then it satisfies (S1), see
Lemma \ref{lemma-versal-object-S1}.
Let $\xi' \to \xi$ over $R' \subset R$ be any of the morphisms constructed in
Lemma \ref{lemma-smallest-where-descends-versal}.
By
Lemma \ref{lemma-descends-versal}
we see that $\xi'$ is versal, hence it is a minimal versal formal
object (by construction). This proves (1).
Also, $R \cong R'[[x_1, \ldots, x_n]]$ which proves (3).

\medskip\noindent
Suppose that $\xi_i/R_i$ are two minimal versal formal objects. By
Lemma \ref{lemma-versal-object-quasi-initial}
there exist morphisms $\xi_1 \to \xi_2$ and $\xi_2 \to \xi_1$.
The corresponding ring maps $f : R_1 \to R_2$ and $g : R_2 \to R_1$
are surjective by minimality. Hence the compositions
$g \circ f : R_1 \to R_1$ and $f \circ g : R_2 \to R_2$ are
isomorphisms by
Algebra, Lemma \ref{algebra-lemma-surjective-endo-noetherian-ring-is-iso}.
Thus $f$ and $g$ are isomorphisms whence the maps
$\xi_1 \to \xi_2$ and $\xi_2 \to \xi_1$ are isomorphisms
(because $\widehat{\mathcal{F}}$ is cofibred in groupoids by
Lemma \ref{lemma-completion-cofibred}). This proves (2) and
finishes the proof of the lemma.
\end{proof}








\section{Miniversal formal objects and tangent spaces}
\label{section-miniversal-objects-existence}

\noindent
The general notion of minimality introduced in
Definition \ref{definition-minimal-versal}
can sometimes be deduced from the behaviour on tangent spaces.
Let $\xi$ be a formal object of the predeformation category
$\mathcal{F}$ and let
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
be the corresponding morphism. Then we can consider the following
the condition
\begin{equation}
\label{equation-bijective}
d\underline{\xi} : \text{Der}_\Lambda(R, k) \to T\mathcal{F} 
\text{ is bijective}
\end{equation}
and the condition
\begin{equation}
\label{equation-bijective-orbits}
d\underline{\xi} : \text{Der}_\Lambda(R, k) \to T\mathcal{F} 
\text{ is bijective on }\text{Der}_\Lambda(k, k)\text{-orbits.}
\end{equation}
Here we are using the identification
$T\underline{R}|_{\mathcal{C}_\Lambda} = \text{Der}_\Lambda(R, k)$ of
Example \ref{example-tangent-space-prorepresentable-functor}
and the action (\ref{equation-action}) of derivations
on the tangent spaces. If $k' \subset k$ is separable, then
$\text{Der}_\Lambda(k, k) = 0$ and the two conditions are equivalent.
It turns out that, in the presence of condition (S2) a versal formal
object is minimal if and only if $\underline{\xi}$ satisfies
(\ref{equation-bijective-orbits}).
Moreover, if $\underline{\xi}$ satisfies (\ref{equation-bijective}), then
$\mathcal{F}$ satisfies (S2).

\begin{lemma}
\label{lemma-miniversal-object-unique}
Let $\mathcal{F}$ be a predeformation category.
Let $\xi$ be a versal formal object of $\mathcal{F}$ such that
(\ref{equation-bijective-orbits}) holds.
Then $\xi$ is a minimal versal formal object.
In particular, such $\xi$ are unique up to isomorphism.
\end{lemma}

\begin{proof}
If $\xi$ is not minimal, then there exists a morphism
$\xi' \to \xi$ lying over $R' \to R$ such that
$R = R'[[x_1, \ldots, x_n]]$ with $n > 0$, see
Lemma \ref{lemma-minimal-versal}.
Thus $d\underline{\xi}$ factors as
$$
\text{Der}_\Lambda(R, k) \to
\text{Der}_\Lambda(R', k) \to T\mathcal{F}
$$
and we see that (\ref{equation-bijective-orbits}) cannot hold
because $D : f \mapsto \partial/\partial x_1(f) \bmod \mathfrak m_R$
is an element of the kernel of the first arrow which is not in the image of
$\text{Der}_\Lambda(k, k) \to \text{Der}_\Lambda(R, k)$.
\end{proof}

\begin{lemma}
\label{lemma-miniversal-object-existence-1}
Let $\mathcal{F}$ be a predeformation category.
Let $\xi$ be a versal formal object of $\mathcal{F}$ such that
(\ref{equation-bijective}) holds. Then
\begin{enumerate}
\item $\mathcal{F}$ satisfies (S1).
\item $\mathcal{F}$ satisfies (S2).
\item $\dim_k T\mathcal{F}$ is finite.
\end{enumerate}
\end{lemma}

\begin{proof}
Condition (S1) holds by
Lemma \ref{lemma-versal-object-S1}.
The first part of (S2) holds since (S1) holds. Let
$$
\vcenter{
\xymatrix{
y \ar[r]_c \ar[d]_a & x_\epsilon \ar[d]^e \\
x \ar[r]^d          & x_0
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
y' \ar[r]_{c'} \ar[d]_{a'} & x_\epsilon \ar[d]^e \\
x \ar[r]^d                 & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A \times_k k[\epsilon] \ar[r] \ar[d] & k[\epsilon] \ar[d] \\
A  \ar[r] & k
}
}
$$
be diagrams as in the second part of (S2). As above we can find
morphisms $b : \xi \to y$ and $b' : \xi \to y'$ such that
$$
\xymatrix{
\xi \ar[r]^{b'} \ar[d]_b          & y' \ar[d]^{a'} \\
y \ar[r]^{a} & x
}
$$
commutes. Let $p : \mathcal{F} \to \mathcal{C}_\Lambda$ denote the
structure morphism. Say $\widehat{p}(\xi) = R$, i.e., $\xi$ lies over
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$. We see that the
pushforward of $\xi$ via $p(c) \circ p(b)$ is $x_\epsilon$
and that the pushforward of $\xi$ via $p(c') \circ p(b')$ is $x_\epsilon$.
Since $\xi$ satisfies (\ref{equation-bijective}), we see that
$p(c) \circ p(b) = p(c') \circ p(b')$
as maps $R \to k[\epsilon]$. Hence $p(b) = p(b')$ as maps from
$R \to A \times_k k[\epsilon]$. Thus we see that $y$ and $y'$ are
isomorphic to the pushforward of $\xi$ along this map and we get
a unique morphism $y \to y'$ over $A \times_k k[\epsilon]$
compatible with $b$ and $b'$ as desired.

\medskip\noindent
Finally, by
Example \ref{example-tangent-space-prorepresentable-functor}
we see
$\dim_k T\mathcal{F} = \dim_k T\underline{R}|_{\mathcal{C}_\Lambda}$
is finite.
\end{proof}

\begin{example}
\label{example-do-not-get-S2}
There exist predeformation categories which have a versal formal
object satisfying (\ref{equation-bijective-orbits}) but which do not
satisfy (S2). A quick example is to take $F = \underline{k[\epsilon]}/G$
where $G \subset \text{Aut}_{\mathcal{C}_\Lambda}(k[\epsilon])$
is a finite nontrivial subgroup. Namely, the map
$\underline{k[\epsilon]} \to F$ is smooth, but the tangent space
of $F$ does not have a natural $k$-vector space structure (as it is
a quotient of a $k$-vector space by a finite group).
\end{example}

\begin{lemma}
\label{lemma-construct-bijective-orbits}
Let $\mathcal{F}$ be a predeformation category satisfying
(S2) which has a versal formal object. Then its minimal versal
formal object satisfies (\ref{equation-bijective-orbits}).
\end{lemma}

\begin{proof}
Let $\xi$ be a minimal versal formal object for $\mathcal{F}$, see
Lemma \ref{lemma-minimal-versal}.
Say $\xi$ lies over $R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$.
In order to parse (\ref{equation-bijective-orbits}) we point out
that $T\mathcal{F}$ has a natural $k$-vector space structure
(see
Lemma \ref{lemma-tangent-space-vector-space}),
that $d\underline{\xi} : \text{Der}_\Lambda(R, k) \to T\mathcal{F}$
is linear (see
Lemma \ref{lemma-k-linear-differential}),
and that the action of $\text{Der}_\Lambda(k, k)$ is
given by addition (see
Lemma \ref{lemma-action-linear}).
Consider the diagram
$$
\xymatrix{
& \Hom_k(\mathfrak m_R/\mathfrak m_R^2, k) \\
K \ar[r] & \text{Der}_\Lambda(R, k) \ar[r]^{d\underline{\xi}} \ar[u] &
T\mathcal{F} \\
& \text{Der}_\Lambda(k, k) \ar[u] \ar[ru]
}
$$
The vector space $K$ is the kernel of $d\underline{\xi}$.
Note that the middle column is exact in the middle as it is dual to the
sequence (\ref{equation-sequence}). If (\ref{equation-bijective-orbits})
fails, then we can find a nonzero element $D \in K$ which
does not map to zero in $\Hom_k(\mathfrak m_R/\mathfrak m_R^2, k)$.
This means there exists an $t \in \mathfrak m_R$ such that
$D(t) = 1$. Set $R' = \{a \in R \mid D(a) = 0\}$. As $D$ is a derivation
this is a subring of $R$. Since $D(t) = 1$ we see that $R' \to k$
is surjective (compare with the proof of
Lemma \ref{lemma-essential-surjection}).
Note that $\mathfrak m_{R'} = \Ker(D : \mathfrak m_R \to k)$
is an ideal of $R$ and $\mathfrak m_R^2 \subset \mathfrak m_{R'}$. Hence
$$
\mathfrak m_R/\mathfrak m_R^2 =
\mathfrak m_{R'}/\mathfrak m_R^2 + k\overline{t}
$$
which implies that the map
$$
R'/\mathfrak m_R^2 \times_k k[\epsilon] \to R/\mathfrak m_R^2
$$
sending $\epsilon$ to $\overline{t}$ is an isomorphism. In particular
there is a map $R/\mathfrak m_R^2 \to R'/\mathfrak m_R^2$.

\medskip\noindent
Let $\xi \to y$ be a morphism lying over $R \to R/\mathfrak m_R^2$.
Let $y \to x$ be a morphism lying over
$R/\mathfrak m_R^2 \to R'/\mathfrak m_R^2$.
Let $y \to x_\epsilon$ be a morphism lying over
$R/\mathfrak m_R^2 \to k[\epsilon]$. Let $x_0$ be the unique (up to unique
isomorphism) object of $\mathcal{F}$ over $k$.
By the axioms of a category cofibred in groupoids we obtain
a commutative diagram
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d] & x_\epsilon \ar[d] \\
x \ar[r]   & x_0
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
R'/\mathfrak m_R^2 \times_k k[\epsilon] \ar[r] \ar[d] & k[\epsilon] \ar[d] \\
R'/\mathfrak m_R^2 \ar[r] & k.
}
}
$$
Because $D \in K$ we see that $x_\epsilon$ is isomorphic
to $0 \in \mathcal{F}(k[\epsilon])$, i.e., $x_\epsilon$ is
the pushforward of $x_0$ via $k \to k[\epsilon], a \mapsto a$.
Hence by
Lemma \ref{lemma-lifting-section}
we see that there exists a morphism $x \to y$. Since
$\text{length}_\Lambda(R'/\mathfrak m_R^2) <
\text{length}_\Lambda(R/\mathfrak m_R^2)$
the corresponding ring map $R'/\mathfrak m_R^2 \to R/\mathfrak m_R^2$
is not surjective. This contradicts the minimality of
$\xi/R$, see part (1) of
Lemma \ref{lemma-smallest-where-descends-versal}.
This contradiction shows that such a $D$ cannot exist, hence
we win.
\end{proof}

\begin{theorem}
\label{theorem-miniversal-object-existence}
Let $\mathcal{F}$ be a predeformation category.
Consider the following conditions
\begin{enumerate}
\item $\mathcal{F}$ has a minimal versal formal object satisfying
(\ref{equation-bijective}),
\item $\mathcal{F}$ has a minimal versal formal object satisfying
(\ref{equation-bijective-orbits}),
\item the following conditions hold:
\begin{enumerate}
\item $\mathcal{F}$ satisfies (S1).
\item $\mathcal{F}$ satisfies (S2).
\item $\dim_k T\mathcal{F}$ is finite.
\end{enumerate}
\end{enumerate}
We always have
$$
(1) \Rightarrow (3) \Rightarrow (2).
$$
If $k' \subset k$ is separable, then all three are equivalent.
\end{theorem}

\begin{proof}
Lemma \ref{lemma-miniversal-object-existence-1}
shows that (1) $\Rightarrow$ (3).
Lemmas \ref{lemma-versal-object-existence} and
\ref{lemma-construct-bijective-orbits}
show that (3) $\Rightarrow$ (2). If $k' \subset k$ is separable
then $\text{Der}_\Lambda(k, k) = 0$ and we see that
(\ref{equation-bijective}) $=$ (\ref{equation-bijective-orbits}), i.e.,
(1) is the same as (2).

\medskip\noindent
An alternative proof of (3) $\Rightarrow$ (1) in the classical case
is to add a few words to the proof of
Lemma \ref{lemma-versal-object-existence}
to see that one can right away construct a versal object which
satisfies (\ref{equation-bijective}) in this case. This avoids the use of
Lemma \ref{lemma-versal-object-existence}
in the classical case. Details omitted.
\end{proof}

\begin{remark}
\label{remark-compare-schlessinger-H3}
Let $F : \mathcal{C}_\Lambda \to \textit{Sets}$ be a predeformation functor
satisfying (S1) and (S2) and $\dim_k TF < \infty$.
Recall that these conditions correspond to the conditions
(H1), (H2), and (H3) from Schlessinger's paper, see
Remark \ref{remark-compare-schlessinger-H3-pre}.
Now, in the classical case (or if $k' \subset k$ is separable)
following Schlessinger we introduce the notion of a hull: a {\it hull}
is a versal formal object $\xi \in \widehat{F}(R)$ such that
$d\underline{\xi} : T\underline{R}|_{\mathcal{C}_\Lambda} \to TF$
is an isomorphism, i.e., (\ref{equation-bijective}) holds.
Thus Theorem \ref{theorem-miniversal-object-existence} tells us
$$
(H1) + (H2) + (H3)
\Rightarrow
\text{ there exists a hull}
$$
in the classical case. In other words, our theorem
recovers Schlessinger's theorem on the existence of hulls.
\end{remark}

\begin{remark}
\label{remark-compose-minimal-into-iso-classes}
Let $\mathcal{F}$ be a predeformation category. Recall that
$\mathcal{F} \to \overline{\mathcal{F}}$ is smooth, see
Remark \ref{remark-smooth-to-iso-classes}. Hence if
$\xi \in \widehat{\mathcal{F}}(R)$ is a versal formal object,
then the composition
$$
\underline{R}|_{\mathcal{C}_\Lambda} \longrightarrow
\mathcal{F} \longrightarrow \overline{\mathcal{F}}
$$
is smooth (Lemma \ref{lemma-smooth-properties}) and we conclude
that the image $\overline{\xi}$ of $\xi$ in
$\overline{\mathcal{F}}$ is a versal formal object.
If (\ref{equation-bijective}) holds, then $\overline{\xi}$
induces an isomorphism
$T\underline{R}|_{\mathcal{C}_\Lambda} \to T\overline{\mathcal{F}}$
because $\mathcal{F} \to \overline{\mathcal{F}}$ identifies tangent spaces.
Hence in this case $\overline{\xi}$
is a hull for $\overline{\mathcal{F}}$, see
Remark \ref{remark-compare-schlessinger-H3}.
By Theorem \ref{theorem-miniversal-object-existence}
we can always find such a $\xi$ if $k' \subset k$ is separable and
$\mathcal{F}$ is a predeformation category satisfying
(S1), (S2), and $\dim_k T\mathcal{F} < \infty$.
\end{remark}

\begin{example}
\label{example-smooth-continued}
In Lemma \ref{lemma-exists-smooth} we constructed objects
$R \in \widehat{\mathcal{C}}_\Lambda$ such that
$\underline{R}|_{\mathcal{C}_\Lambda}$ is smooth
and such that
$$
H_1(L_{k/\Lambda}) = \mathfrak m_R/\mathfrak m_R^2
\quad\text{and}\quad
\Omega_{R/\Lambda} \otimes_R k = \Omega_{k/\Lambda}
$$
Let us reinterpret this using the theorem above. Namely,
consider $\mathcal{F} = \mathcal{C}_\Lambda$
as a category cofibred in groupoids over itself
(using the identity functor).
Then $\mathcal{F}$ is a predeformation category,
satisfies (S1) and (S2), and we have $T\mathcal{F} = 0$.
Thus $\mathcal{F}$ satisfies condition (3) of
Theorem \ref{theorem-miniversal-object-existence}.
The theorem implies that (2) holds, i.e.,
we can find a minimal versal formal object
$\xi \in \widehat{\mathcal{F}}(S)$
over some $S \in \widehat{\mathcal{C}}_\Lambda$
satisfying (\ref{equation-bijective-orbits}).
Lemma \ref{lemma-smooth} shows that
$\Lambda \to S$ is formally smooth in the $\mathfrak m_S$-adic
topology (because
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to
\mathcal{F} = \mathcal{C}_\Lambda$ is smooth).
Now condition (\ref{equation-bijective-orbits})
tells us that $\text{Der}_\Lambda(S, k) \to 0$ is bijective on
$\text{Der}_\Lambda(k, k)$-orbits. This means the injection
$\text{Der}_\Lambda(k, k) \to \text{Der}_\Lambda(S, k)$ is also surjective.
In other words, we have
$\Omega_{S/\Lambda} \otimes_S k = \Omega_{k/\Lambda}$.
Since $\Lambda \to S$ is formally smooth in the $\mathfrak m_S$-adic
topology, we can apply More on Algebra, Lemma
\ref{more-algebra-lemma-formally-smooth-JZ}
to conclude the exact sequence (\ref{equation-sequence-extended})
turns into a pair of identifications
$$
H_1(L_{k/\Lambda}) = \mathfrak m_S/\mathfrak m_S^2
\quad\text{and}\quad
\Omega_{S/\Lambda} \otimes_S k = \Omega_{k/\Lambda}
$$
Reading the argument backwards, we find that the $R$ constructed
in Lemma \ref{lemma-exists-smooth} carries a minimal versal object.
By the uniqueness of minimal versal objects
(Lemma \ref{lemma-minimal-versal})
we also conclude $R \cong S$, i.e., the two constructions give
the same answer.
\end{example}







\section{Rim-Schlessinger conditions and deformation categories}
\label{section-RS-condition}

\noindent
There is a very natural property of categories fibred in groupoids
over $\mathcal{C}_\Lambda$ which is easy to check in practice
and which implies Schlessinger's properties (S1) and (S2) we
have introduced earlier.

\begin{definition}
\label{definition-RS}
Let $\mathcal{F}$ be a category cofibered in groupoids over $\mathcal
C_\Lambda$.  We say that $\mathcal{F}$ satisfies {\it condition (RS)}
if for every diagram in $\mathcal{F}$
$$
\vcenter{
\xymatrix{
           & x_2 \ar[d] \\
x_1 \ar[r] & x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
           & A_2 \ar[d] \\
A_1 \ar[r] & A
}
}
$$
in $\mathcal{C}_\Lambda$ with $A_2 \to A$ surjective, there exists a
fiber product $x_1 \times_x x_2$ in $\mathcal{F}$ such that the diagram
$$
\vcenter{
\xymatrix{
x_1 \times_x x_2 \ar[r] \ar[d] & x_2 \ar[d] \\
x_1 \ar[r]      & x
}
}
\quad\text{lies over}\quad
\vcenter{
\xymatrix{
A_1 \times_A A_2 \ar[r] \ar[d] & A_2 \ar[d] \\
A_1 \ar[r]      & A.
}
}
$$
\end{definition}

\begin{lemma}
\label{lemma-RS-fiber-square}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$ satisfying (RS). Given a commutative diagram
in $\mathcal{F}$
$$
\vcenter{
\xymatrix{
y \ar[r] \ar[d] & x_2 \ar[d]   \\
x_1 \ar[r]      & x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A_1 \times_A A_2 \ar[r] \ar[d] & A_2 \ar[d] \\
A_1 \ar[r]      & A.
}
}
$$
with $A_2 \to A$ surjective, then it is a fiber square.
\end{lemma}

\begin{proof}
Since $\mathcal{F}$ satisfies (RS), there exists a fiber product diagram
$$
\vcenter{
\xymatrix{
x_1 \times_x x_2 \ar[r] \ar[d] & x_2 \ar[d] \\
x_1 \ar[r]      & x
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
A_1 \times_A A_2 \ar[r] \ar[d] & A_2 \ar[d] \\
A_1 \ar[r]      & A.
}
}
$$
The induced map $y \to x_1 \times_x x_2$ lies over
$\text{id} : A_1 \times_A A_1 \to A_1 \times_A A_1$, hence it is an
isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-RS-small-extension}
Let $\mathcal{F}$ be a category cofibered in groupoids over $\mathcal
C_\Lambda$. Then $\mathcal{F}$ satisfies (RS) if the condition in
Definition \ref{definition-RS} is assumed to hold only when $A_2 \to A$
is a small extension.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-factor-small-extension}.  The proof is similar to that
of Lemma \ref{lemma-smoothness-small-extensions}.
\end{proof}

\begin{lemma}
\label{lemma-RS-2-categorical}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ satisfies (RS),
\item the functor
$\mathcal{F}(A_1 \times_A A_2) \to
\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)$
see (\ref{equation-compare}) is an equivalence of
categories whenever $A_2 \to A$ is surjective, and
\item same as in (2) whenever $A_2 \to A$ is a small extension.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). By
Lemma \ref{lemma-RS-fiber-square}
we see that every object of $\mathcal{F}(A_1 \times_A A_2)$
is of the form $x_1 \times_x x_2$. Moreover
$$
\Mor_{A_1 \times_A A_2}(x_1 \times_x x_2, y_1 \times_y y_2) =
\Mor_{A_1}(x_1, y_1) \times_{\Mor_A(x, y)}
\Mor_{A_2}(x_2, y_2).
$$
Hence we see that $\mathcal{F}(A_1 \times_A A_2)$ is a $2$-fibre product
of $\mathcal{F}(A_1)$ with $\mathcal{F}(A_2)$ over $\mathcal{F}(A)$ by
Categories, Remark \ref{categories-remark-other-description-2-fibre-product}.
In other words, we see that (2) holds.

\medskip\noindent
The implication (2) $\Rightarrow$ (3) is immediate.

\medskip\noindent
Assume (3). Let $q_1 : A_1 \to A$ and $q_2 : A_2 \to A$ be given with
$q_2$ a small extension. We will use the description of the $2$-fibre product
$\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)$ from
Categories, Remark \ref{categories-remark-other-description-2-fibre-product}.
Hence let $y \in \mathcal{F}(A_1 \times_A A_2)$ correspond to
$(x_1, x_2, x, a_1 : x_1 \to x, a_2 : x_2 \to x)$.
Let $z$ be an object of $\mathcal{F}$ lying over $C$. Then
\begin{align*}
\Mor_\mathcal{F}(z, y) & =
\{(f, \alpha) \mid f : C \to A_1 \times_A A_2,
\alpha : f_*z \to y\} \\
& = \{(f_1, f_2, \alpha_1, \alpha_2) \mid
f_i : C \to A_i, \ \alpha_i : f_{i, *}z \to x_i, \\
& \quad\quad\quad\quad
q_1 \circ f_1 = q_2 \circ f_2, \ q_{1, *} \alpha_1 = q_{2, *}\alpha_2\} \\
& =
\Mor_\mathcal{F}(z, x_1) \times_{\Mor_\mathcal{F}(z, x)}
\Mor_\mathcal{F}(z, x_2)
\end{align*}
whence $y$ is a fibre product of $x_1$ and $x_2$ over $x$. Thus we see
that $\mathcal{F}$ satisfies (RS) in case $A_2 \to A$ is a small extension.
Hence (RS) holds by
Lemma \ref{lemma-RS-small-extension}.
\end{proof}

\begin{remark}
\label{remark-compare-schlessinger-H4}
When $\mathcal{F}$ is cofibered in sets, condition (RS) is exactly condition
(H4) from Schlessinger's paper \cite[Theorem 2.11]{Sch}.  Namely, for
a functor $F: \mathcal{C}_\Lambda \to \textit{Sets}$, condition
(RS) states: If $A_1 \to A$ and $A_2 \to A$ are maps in
$\mathcal{C}_\Lambda$ with $A_2 \to A$ surjective, then the induced
map $F(A_1 \times_A A_2) \to F(A_1) \times_{F(A)} F(A_2)$ is
bijective.
\end{remark}

\begin{lemma}
\label{lemma-RS-implies-S1-S2}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. The condition (RS) for $\mathcal{F}$
implies both (S1) and (S2) for $\mathcal{F}$.
\end{lemma}

\begin{proof}
Using the reformulation of
Lemma \ref{lemma-RS-2-categorical}
and the explanation of (S1) following
Definition \ref{definition-S1-S2}
it is immediate that (RS) implies (S1).
This proves the first part of (S2). The second part of (S2)
follows because
Lemma \ref{lemma-RS-fiber-square}
tells us that $y = x_1 \times_{d, x_0, e} x_2 = y'$ if
$y, y'$ are as in the second part of the definition of (S2) in
Definition \ref{definition-S1-S2}. (In fact the morphism
$y \to y'$ is compatible with both $a, a'$ and $c, c'$!)
\end{proof}

\noindent
The following lemma is the analogue of
Lemma \ref{lemma-S1-S2-associated-functor}.
Recall that if $\mathcal{F}$ is a category cofibred in groupoids over
$\mathcal{C}_\Lambda$ and $x$ is an object of $\mathcal{F}$
lying over $A$, then we denote
$\text{Aut}_A(x) = \Mor_A(x, x) = \Mor_{\mathcal{F}(A)}(x, x)$.
If $x' \to x$ is a morphism of $\mathcal{F}$ lying over $A' \to A$
then there is a well defined map of groups
$\text{Aut}_{A'}(x') \to \text{Aut}_A(x)$.

\begin{lemma}
\label{lemma-RS-associated-functor}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$ satisfying (RS).
The following conditions are equivalent:
\begin{enumerate}
\item $\overline{\mathcal{F}}$ satisfies (RS).
\item Let $f_1: A_1 \to A$ and $f_2: A_2 \to A$ be ring maps in
$\mathcal{C}_\Lambda$ with $f_2$ surjective. The induced map
of sets of isomorphism classes
$$
\overline{\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)}
\to \overline{\mathcal{F}}(A_1) \times_{\overline{\mathcal{F}}(A)}
\overline{\mathcal{F}}(A_2)
$$
is injective.
\item For every morphism $x' \to x$ in $\mathcal{F}$ lying over a
surjective ring map $A' \to A$, the map
$\text{Aut}_{A'}(x') \to \text{Aut}_A(x)$ is surjective.
\item For every morphism $x' \to x$ in $\mathcal{F}$ lying over a small
extension $A' \to A$, the map
$\text{Aut}_{A'}(x') \to \text{Aut}_A(x)$ is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove that (1) is equivalent to (2) and (2) is equivalent to (3).  The
equivalence of (3) and (4) follows from Lemma
\ref{lemma-factor-small-extension}.

\medskip\noindent
Let $f_1: A_1 \to A$ and $f_2: A_2 \to A$ be ring maps in
$\mathcal{C}_\Lambda$ with $f_2$ surjective. By
Remark \ref{remark-compare-schlessinger-H4}
we see $\overline{\mathcal{F}}$ satisfies (RS) if and
only if the map
$$
\overline{\mathcal{F}}(A_1 \times_A A_2) \to \overline{\mathcal
F}(A_1) \times_{\overline{\mathcal{F}}(A)} \overline{\mathcal{F}}(A_2)
$$
is bijective for any such $f_1, f_2$.
This map is at least surjective since that
is the condition of (S1) and $\overline{\mathcal{F}}$ satisfies (S1) by
Lemmas \ref{lemma-RS-implies-S1-S2} and
\ref{lemma-S1-S2-associated-functor}.
Moreover, this map factors as
$$
\overline{\mathcal{F}}(A_1 \times_A A_2)
\longrightarrow
\overline{\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)}
\longrightarrow
\overline{\mathcal{F}}(A_1) \times_{\overline{\mathcal{F}}(A)}
\overline{\mathcal{F}}(A_2),
$$
where the first map is a bijection since
$$
\mathcal{F}(A_1 \times_A A_2)
\longrightarrow
\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)
$$
is an equivalence by (RS) for $\mathcal{F}$. Hence (1) is equivalent to (2).

\medskip\noindent
Assume (2) holds. Let $x' \to x$ be a morphism in $\mathcal{F}$ lying
over a surjective ring map $f: A' \to A$. Let
$a \in \text{Aut}_A(x)$. The
objects
$$
(x', x', a : x \to x), \ (x', x', \text{id} : x \to x)
$$
of
$\mathcal{F}(A') \times_{\mathcal{F}(A)} \mathcal{F}(A')$
have the same image in
$\overline{\mathcal{F}}(A') \times_{\overline{\mathcal{F}}(A)}
\overline{\mathcal{F}}(A')$. By (2) there exists maps
$b_1, b_2 : x' \to x'$ such that
$$
\xymatrix{
x \ar[r]_a \ar[d]_{f_*b_1} & x \ar[d]^{f_*b_2} \\
x \ar[r]^{\text{id}} & x
}
$$
commutes. Hence $b_2^{-1} \circ b_1 \in \text{Aut}_{A'}(x')$ has image
$a \in \text{Aut}_A(x)$. Hence (3) holds.

\medskip\noindent
Assume (3) holds. Suppose
$$
(x_1, x_2, a : (f_1)_*x_1 \to (f_2)_*x_2),
\ (x'_1, x'_2, a' : (f_1)_*x'_1 \to (f_2)_*x'_2)
$$
are objects of
$\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)$
with the same image in
$\overline{\mathcal{F}}(A_1) \times_{\overline{\mathcal{F}}(A)}
\overline{\mathcal{F}}(A_2)$. Then there are morphisms $b_1: x_1 \to
x'_1$ in $\mathcal{F}(A_1)$ and $b_2: x_2 \to x'_2$ in $\mathcal
F(A_2)$. By (3) we can modify $b_2$ by an automorphism of $x_2$ over $A_2$ so
that the diagram
$$
\xymatrix{
(f_1)_*x_1 \ar[r]_a \ar[d]_{(f_1)_*b_1} & (f_2)_*x_2 \ar[d]^{(f_2)_*b_2} \\
(f_1)_*x'_1 \ar[r]^{a'} & (f_2)_*x'_2.
}
$$
commutes. This proves $(x_1, x_2, a) \cong (x'_1, x'_2, a')$ in
$\overline{\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)}$.
Hence (2) holds.
\end{proof}

\noindent
Finally we define the notion of a deformation category.

\begin{definition}
\label{definition-deformation-category}
A {\it deformation category} is a predeformation category $\mathcal{F}$
satisfying (RS). A morphism of deformation categories is a morphism of
categories over $\mathcal{C}_\Lambda$.
\end{definition}

\begin{remark}
\label{remark-deformation-functor}
We say that a functor $F: \mathcal{C}_\Lambda \to \textit{Sets}$
is a {\it deformation functor} if the associated cofibered set is a
deformation category, i.e.\ if $F(k)$ is a one element set and $F$ satisfies
(RS). If $\mathcal{F}$ is a deformation category, then
$\overline{\mathcal{F}}$
is a predeformation functor but not necessarily a deformation functor, as
Lemma \ref{lemma-RS-associated-functor} shows.
\end{remark}

\begin{example}
\label{example-prorepresentable-deformation-functor}
A prorepresentable functor $F$ is a deformation functor. Namely, suppose
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$ and
$F(A) = \Mor_{\widehat{\mathcal{C}}_\Lambda}(R, A)$.
There is a unique morphism $R \to k$, so $F(k)$ is a one element set.
Since
$$
\Hom_\Lambda(R, A_1 \times_A A_2) =
\Hom_\Lambda(R, A_1) \times_{\Hom_\Lambda(R, A)}
\Hom_\Lambda(R, A_2)
$$
the same is true for maps in $\widehat{\mathcal{C}}_\Lambda$ and
we see that $F$ has (RS).
\end{example}

\noindent
The following is one of our typical remarks on passing from a category
cofibered in groupoids to the predeformation category at a point over $k$: it
says that this process preserves (RS).

\begin{lemma}
\label{lemma-localize-RS}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Let $x_0 \in \Ob(\mathcal{F}(k))$.
Let $\mathcal{F}_{x_0}$ be the category cofibred in groupoids over
$\mathcal{C}_\Lambda$ constructed in
Remark \ref{remark-localize-cofibered-groupoid}.
If $\mathcal{F}$ satisfies (RS), then so does $\mathcal{F}_{x_0}$.
In particular, $\mathcal{F}_{x_0}$ is a deformation category.
\end{lemma}

\begin{proof}
Any diagram as in
Definition \ref{definition-RS}
in $\mathcal{F}_{x_0}$ gives rise to a diagram in $\mathcal{F}$
and the output of (RS) for this diagram in $\mathcal{F}$
can be viewed as an output for $\mathcal{F}_{x_0}$ as well.
\end{proof}

\noindent
The following lemma is the analogue of the fact that $2$-fibre products
of algebraic stacks are algebraic stacks.

\begin{lemma}
\label{lemma-RS-fiber-product-morphisms}
Let
$$
\xymatrix{
\mathcal{H} \times_\mathcal{F} \mathcal{G} \ar[r] \ar[d] &
\mathcal{G} \ar[d]^g \\
\mathcal{H} \ar[r]^f & \mathcal{F}
}
$$
be $2$-fibre product of categories cofibered in groupoids over
$\mathcal{C}_\Lambda$. If $\mathcal{F}, \mathcal{G}, \mathcal{H}$
all satisfy (RS), then $\mathcal{H} \times_\mathcal{F} \mathcal{G}$
satisfies (RS).
\end{lemma}

\begin{proof}
If $A$ is an object of $\mathcal{C}_\Lambda$, then an object of the fiber
category of $\mathcal{H} \times_\mathcal{F} \mathcal{G}$ over $A$
is a triple $(u, v, a)$ where $u \in \mathcal{H}(A)$, $v \in \mathcal{G}(A)$,
and $a : f(u) \to g(v)$ is a morphism in $\mathcal{F}(A)$. Consider
a diagram in $\mathcal{H} \times_\mathcal{F} \mathcal{G}$
$$
\vcenter{
\xymatrix{
           & (u_2, v_2, a_2) \ar[d] \\
(u_1, v_1, a_1) \ar[r] & (u, v, a)
}
}
\quad\text{lying over}\quad
\vcenter{
\xymatrix{
           & A_2 \ar[d] \\
A_1 \ar[r] & A
}
}
$$
in $\mathcal{C}_\Lambda$ with $A_2 \to A$ surjective. Since
$\mathcal{H}$ and $\mathcal{G}$ satisfy (RS), there are fiber
products $u_1 \times_u u_2$ and $v_1 \times_v v_2$ lying over
$A_1 \times_A A_2$. Since $\mathcal{F}$ satisfies (RS),
Lemma \ref{lemma-RS-fiber-square} shows
$$
\vcenter{
\xymatrix{
f(u_1 \times_u u_2) \ar[r] \ar[d] & f(u_2) \ar[d] \\
f(u_1) \ar[r] & f(u)
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
g(v_1 \times_v v_2) \ar[r] \ar[d] & g(v_2) \ar[d] \\
g(v_1) \ar[r] & g(v)
}
}
$$
are both fiber squares in $\mathcal{F}$. Thus we can view
$a_1 \times_a a_2$ as a morphism from $f(u_1 \times_u u_2)$ to
$g(v_1 \times_v v_2)$ over $A_1 \times_A A_2$.
It follows that
$$
\xymatrix{
 (u_1 \times_u u_2, v_1 \times_v v_2, a_{1} \times_a a_2) \ar[d] \ar[r] &
(u_2, v_2, a_2) \ar[d] \\
(u_1, v_1, a_1) \ar[r] & (u, v, a)
}
$$
is a fiber square in $\mathcal{H} \times_\mathcal{F} \mathcal{G}$
as desired.
\end{proof}


















\section{Lifts of objects}
\label{section-lifts}

\noindent
The content of this section is that the tangent space has a principal
homogeneous action on the set of lifts along a small extension
in the case of a deformation category.

\begin{definition}
\label{definition-lifts}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Let $f: A' \to A$ be a map in $\mathcal{C}_\Lambda$.
Let $x \in \mathcal{F}(A)$. The category $\textit{Lift}(x, f)$ of lifts of $x$
along $f$ is the category with the following objects and
morphisms.
\begin{enumerate}
\item Objects: A {\it lift of $x$ along $f$} is a morphism $x' \to x$
lying over $f$.
\item Morphisms: A {\it morphism of lifts} from $a_1 : x'_1 \to x$ to
$a_2 : x'_2 \to x$ is a morphism $b : x'_1 \to x'_2$ in
$\mathcal{F}(A')$ such that $a_2 = a_1 \circ b$.
\end{enumerate}
The set $\text{Lift}(x, f)$ of lifts of $x$ along $f$ is the set of
isomorphism classes of $\textit{Lift}(x, f)$.
\end{definition}

\begin{remark}
\label{remark-omit-arrow}
When the map $f: A' \to A$ is clear from the context, we may write
$\textit{Lift}(x, A')$ and $\text{Lift}(x, A')$ in place of
$\textit{Lift}(x, f)$ and $\text{Lift}(x, f)$.
\end{remark}

\begin{remark}
\label{remark-tangent-space-lifting}
Let $\mathcal{F}$ be a category cofibred in groupoids over
$\mathcal{C}_\Lambda$. Let $x_0 \in \Ob(\mathcal{F}(k))$.
Let $V$ be a finite dimensional vector space.
Then $\text{Lift}(x_0, k[V])$ is the set of isomorphism classes
of $\mathcal{F}_{x_0}(k[V])$ where $\mathcal{F}_{x_0}$ is the
predeformation category of objects in $\mathcal{F}$ lying over
$x_0$, see
Remark \ref{remark-localize-cofibered-groupoid}.
Hence if $\mathcal{F}$ satisfies (S2), then so does
$\mathcal{F}_{x_0}$ (see
Lemma \ref{lemma-S1-S2-localize})
and by
Lemma \ref{lemma-tangent-space-vector-space}
we see that
$$
\text{Lift}(x_0, k[V]) = T\mathcal{F}_{x_0} \otimes_k V
$$
as $k$-vector spaces.
\end{remark}

\begin{remark}
\label{remark-lift-bijections}
Let $\mathcal{F}$ be a category cofibered in groupoids over $\mathcal
C_\Lambda$ satisfying (RS).  Let
$$
\xymatrix{
A_1 \times_A A_2 \ar[r] \ar[d] & A_2 \ar[d] \\
A_1 \ar[r] & A
}
$$
be a fibre square in $\mathcal{C}_\Lambda$ such that either
$A_1 \to A$ or $A_2 \to A$ is surjective. Let
$x \in \Ob(\mathcal{F}(A))$. Given
lifts $x_1 \to x$ and $x_2 \to x$ of $x$ to $A_1$ and $A_2$, we get by
(RS) a lift $x_1 \times_x x_2 \to x$ of $x$ to $A_1 \times_A A_2$.
Conversely, by
Lemma \ref{lemma-RS-fiber-square}
any lift of $x$ to $A_1 \times_A A_2$ is of this form.
Hence a bijection
$$
\text{Lift}(x, A_1) \times \text{Lift}(x, A_2)
\longrightarrow
\text{Lift}(x, A_1 \times_A A_2).
$$
Similarly, if $x_1 \to x$ is a fixed lifting of $x$ to $A_1$, then
there is a bijection
$$
\text{Lift}(x_1, A_1 \times_A A_2)
\longrightarrow
\text{Lift}(x, A_2).
$$
Now let
$$
\xymatrix{
A_1' \times_A A_2 \ar[r] \ar[d] & A_1 \times_A A_2 \ar[r] \ar[d] & A_2
\ar[d] \\
A_1' \ar[r] & A_1 \ar[r] & A
}
$$
be a composition of fibre squares in $\mathcal{C}_\Lambda$ with
both $A'_1 \to A_1$ and $A_1 \to A$ surjective. Let $x_1 \to x$ be a morphism
lying over $A_1 \to A$. Then by the above we have bijections
\begin{align*}
\text{Lift}(x_1, A_1' \times_A A_2)
& = \text{Lift}(x_1, A_1') \times \text{Lift}(x_1, A_1 \times_A A_2) \\
& = \text{Lift}(x_1, A_1') \times \text{Lift}(x, A_2).
\end{align*}
\end{remark}

\begin{lemma}
\label{lemma-free-transitive-action}
Let $\mathcal{F}$ be a deformation category.
Let $A' \to A$ be a surjective ring map in
$\mathcal{C}_\Lambda$ whose kernel $I$ is annihilated
by $\mathfrak m_{A'}$. Let $x \in \Ob(\mathcal{F}(A))$.
If $\text{Lift}(x, A')$ is nonempty,
then there is a free and transitive action of
$T\mathcal{F} \otimes_k I$ on $\text{Lift}(x, A')$.
\end{lemma}

\begin{proof}
Consider the ring map $g : A' \times_A A' \to k[I]$ defined by the
rule $g(a_1, a_2) = \overline{a_1} \oplus a_2 - a_1$ (compare with
Lemma \ref{lemma-lifting-along-small-extension}).
There is an isomorphism
$$
A' \times_A A' \xrightarrow{\sim} A' \times_k k[I]
$$
given by $(a_1, a_2) \mapsto (a_1, g(a_1, a_2))$.
This isomorphism commutes with the projections to $A'$ on the first
factor, and hence with the projections of
$A' \times_A A'$ and $A' \times_k k[I]$ to $A$. Thus there is a bijection
\begin{equation}
\label{equation-one}
\text{Lift}(x, A' \times_A A')
\longrightarrow
\text{Lift}(x, A' \times_k k[I])
\end{equation}
By Remark \ref{remark-lift-bijections} there is a bijection
\begin{equation}
\label{equation-two}
\text{Lift}(x, A') \times \text{Lift}(x, A')
\longrightarrow
\text{Lift}(x, A' \times_A A')
\end{equation}
There is a commutative diagram
$$
\xymatrix{
A' \times_k k[I] \ar[r] \ar[d] & A \times_k k[I] \ar[r] \ar[d] & k[I] \ar[d] \\
A' \ar[r] & A \ar[r] & k.
}
$$
Thus if we choose a pushforward $x \to x_0$ of $x$ along
$A \to k$, we obtain by the end of
Remark \ref{remark-lift-bijections}
a bijection
\begin{equation}
\label{equation-three}
\text{Lift}(x, A' \times_k k[I])
\longrightarrow
\text{Lift}(x, A') \times \text{Lift}(x_0, k[I])
\end{equation}
Composing (\ref{equation-two}), (\ref{equation-one}), and
(\ref{equation-three})
we get a bijection
$$
\Phi :
\text{Lift}(x, A') \times \text{Lift}(x, A')
\longrightarrow
\text{Lift}(x, A') \times \text{Lift}(x_0, k[I]).
$$
This bijection commutes with the projections on the first factors.
By Remark \ref{remark-tangent-space-lifting}
we see that $\text{Lift}(x_0, k[I]) = T\mathcal{F} \otimes_k I$.
If $\text{pr}_2$ is the second projection of
$\text{Lift}(x, A') \times \text{Lift}(x, A')$, then we get a map
$$
a = \text{pr}_2 \circ \Phi^{-1} :
\text{Lift}(x, A') \times (T\mathcal{F} \otimes_k I)
\longrightarrow
\text{Lift}(x, A').
$$
Unwinding all the above we see that $a(x' \to x, \theta)$
is the unique lift $x'' \to x$ such that $g_*(x', x'') = \theta$
in $\text{Lift}(x_0, k[I]) = T\mathcal{F} \otimes_k I$.
To see this is an action of $T\mathcal{F} \otimes_k I$ on $\text{Lift}(x, A')$
we have to show the following: if $x', x'', x'''$ are lifts of $x$ and
$g_*(x', x'') = \theta$, $g_*(x'', x''') = \theta'$, then
$g_*(x', x''') = \theta + \theta'$. This follows from the commutative
diagram
$$
\xymatrix{
A' \times_A A' \times_A A'
\ar[rrrrr]_-{(a_1, a_2, a_3) \mapsto (g(a_1, a_2), g(a_2, a_3))}
\ar[rrrrrd]_{(a_1, a_2, a_3) \mapsto g(a_1, a_3)} & & & & &
k[I] \times_k k[I] = k[I \times I] \ar[d]^{+} \\
& & & & & k[I]
}
$$
The action is free and transitive because $\Phi$ is bijective.
\end{proof}

\begin{remark}
\label{remark-free-transitive-action-functorial}
The action of Lemma \ref{lemma-free-transitive-action} is functorial.
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a morphism of deformation
categories. Let $A' \to A$ be a surjective ring map whose kernel $I$
is annihilated by $\mathfrak m_{A'}$. Let
$x \in \Ob(\mathcal{F}(A))$.
In this situation $\varphi$ induces the vertical arrows
in the following commutative diagram
$$
\xymatrix{
\text{Lift}(x, A') \times (T\mathcal{F} \otimes_k I)
\ar[d]_{(\varphi, d\varphi \otimes \text{id}_I)} \ar[r] &
\text{Lift}(x, A') \ar[d]^\varphi \\
\text{Lift}(\varphi(x), A') \times (T\mathcal{G} \otimes_k I) \ar[r] &
\text{Lift}(\varphi(x), A')
}
$$
The commutativity follows as each of the maps
(\ref{equation-two}), (\ref{equation-one}), and (\ref{equation-three})
of the proof of
Lemma \ref{lemma-free-transitive-action}
gives rise to a similar commutative diagram.
\end{remark}






\section{Schlessinger's theorem on prorepresentable functors}
\label{section-schlessingers-theorem}

\noindent
We deduce Schlessinger's theorem characterizing prorepresentable functors on
$\mathcal{C}_\Lambda$.

\begin{lemma}
\label{lemma-minimal-smooth-morphism-functors}
Let $F, G: \mathcal{C}_\Lambda \to \textit{Sets}$ be deformation
functors. Let $\varphi : F \to G$ be a smooth morphism which induces
an isomorphism $d\varphi : TF \to TG$ of tangent
spaces. Then $\varphi$ is an isomorphism.
\end{lemma}

\begin{proof}
We prove $F(A) \to G(A)$ is a bijection for all $A \in
\Ob(\mathcal{C}_\Lambda)$ by induction on
$\text{length}_A(A)$.  For $A = k$ the statement follows from the
assumption that $F$ and $G$ are deformation functors. Suppose that the
statement holds for rings of length less than $n$ and let $A'$ be a ring of
length $n$. Choose a small extension $f : A' \to A$.  We have a
commutative diagram
$$
\xymatrix{
F(A') \ar[r] \ar[d]_{F(f)} & G(A') \ar[d]^{G(f)} \\
F(A) \ar[r]^{\sim} & G(A)
}
$$
where the map $F(A) \to G(A)$ is a bijection.  By smoothness of $F
\to G$, $F(A') \to G(A')$ is surjective (Lemma
\ref{lemma-smooth-morphism-essentially-surjective}).  Thus we can check
bijectivity by checking it on fibers $F(f)^{-1}(x) \to
G(f)^{-1}(\varphi(x))$ for $x \in F(A)$ such that $F(f)^{-1}(x)$ is nonempty.
These fibers are precisely $\text{Lift}(x, A')$ and
$\text{Lift}(\varphi(x), A')$ and by assumption we have an isomorphism
$d\varphi \otimes \text{id} :
TF \otimes_k \Ker(f)  \to TG \otimes_k \Ker(f)$.
Thus, by
Lemma \ref{lemma-free-transitive-action} and
Remark \ref{remark-free-transitive-action-functorial},
for $x \in F(A)$ such that $F(f)^{-1}(x)$ is nonempty the map
$F(f)^{-1}(x) \to G(f)^{-1}(\varphi(x))$ is a map of sets commuting
with free transitive actions by $TF \otimes_k \Ker(f)$.
Hence it is bijective.
\end{proof}

\noindent
Note that in case $k' \subset k$ is separable condition (c) in
the theorem below is empty.

\begin{theorem}
\label{theorem-Schlessinger-prorepresentability}
Let $F: \mathcal{C}_\Lambda \to \textit{Sets}$ be a functor.
Then $F$ is prorepresentable if and only if
(a) $F$ is a deformation functor,
(b) $\dim_k TF$ is finite, and (c) $\gamma : \text{Der}_\Lambda(k, k) \to TF$
is injective.
\end{theorem}

\begin{proof}
Assume $F$ is prorepresentable by $R \in \widehat{\mathcal{C}}_\Lambda$.
We see $F$ is a deformation functor by
Example \ref{example-prorepresentable-deformation-functor}.
We see $\dim_k TF$ is finite by
Example \ref{example-tangent-space-prorepresentable-functor}.
Finally, $\text{Der}_\Lambda(k, k) \to TF$ is identified with
$\text{Der}_\Lambda(k, k) \to \text{Der}_\Lambda(R, k)$ by
Example \ref{example-tangent-space-map-prorepresentable-functor}
which is injective because $R \to k$ is surjective.

\medskip\noindent
Conversely, assume (a), (b), and (c) hold. By
Lemma \ref{lemma-RS-implies-S1-S2}
we see that (S1) and (S2) hold. Hence by
Theorem \ref{theorem-miniversal-object-existence}
there exists a minimal versal formal object $\xi$ of $F$ such that
(\ref{equation-bijective-orbits}) holds. Say $\xi$ lies over $R$.
The map
$$
d\underline{\xi} : \text{Der}_\Lambda(R, k) \to T\mathcal{F}
$$
is bijective on $\text{Der}_\Lambda(k, k)$-orbits. Since the action
of $\text{Der}_\Lambda(k, k)$ on the left hand side is free by (c) and
Lemma \ref{lemma-action-linear}
we see that the map is bijective. Thus we see that $\underline{\xi}$
is an isomorphism by
Lemma \ref{lemma-minimal-smooth-morphism-functors}.
\end{proof}




\section{Infinitesimal automorphisms}
\label{section-infinitesimal-automorphisms}

\noindent
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Given a morphism $x' \to x$ in $\mathcal{F}$ lying over
$A' \to A$, there is an induced homomorphism
$$
\text{Aut}_{A'}(x') \to \text{Aut}_A(x).
$$
Lemma \ref{lemma-RS-associated-functor}
says that the cokernel of this homomorphism determines whether
condition (RS) on $\mathcal{F}$ passes to $\overline{\mathcal{F}}$.
In this section we study the kernel of this homomorphism. We will see
that it also gives a measure of how far $\mathcal{F}$
is from $\overline{\mathcal{F}}$.

\begin{definition}
\label{definition-relative-infinitesimal-auts}
Let $\mathcal{F}$ be a category cofibered in groupoids over $\mathcal
C_\Lambda$. Let $x' \to x$ be a morphism in $\mathcal{F}$ lying over
$A' \to A$. The kernel
$$
\text{Inf}(x'/x) = \Ker(\text{Aut}_{A'}(x') \to \text{Aut}_A(x))
$$
is the {\it group of infinitesimal automorphisms of $x'$ over $x$}.
\end{definition}

\begin{definition}
\label{definition-infinitesimal-auts}
Let $\mathcal{F}$ be a category cofibered in groupoids over $\mathcal
C_\Lambda$. Let $x_0 \in \Ob(\mathcal{F}(k))$. Assume a choice of
pushforward $x_0 \to x_0'$ of $x_0$ along the map
$k \to k[\epsilon], a \mapsto a$ has been made.
Then there is a unique map $x'_0 \to x_0$ such that
$x_0 \to x_0' \to x_0$ is the identity on $x_0$.
Then
$$
\text{Inf}_{x_0}(\mathcal F) = \text{Inf}(x'_0/x_0)
$$
is the {\it group of infinitesimal automorphisms of $x_0$}
\end{definition}

\begin{remark}
\label{remark-choice-pushforward-immaterial-infinitesimal-aut}
Up to canonical isomorphism $\text{Inf}_{x_0}(\mathcal{F})$
does not depend on the choice of pushforward $x_0 \to x_0'$
because any two pushforwards are canonically isomorphic.
Moreover, if $y_0 \in \mathcal{F}(k)$ and $x_0 \cong y_0$ in
$\mathcal{F}(k)$, then
$\text{Inf}_{x_0}(\mathcal{F}) \cong \text{Inf}_{y_0}(\mathcal{F})$
where the isomorphism depends (only) on the choice of an isomorphism
$x_0 \to y_0$. In particular, $\text{Aut}_k(x_0)$
acts on $\text{Inf}_{x_0}(\mathcal{F})$.
\end{remark}

\begin{remark}
\label{remark-trivial-aut-point}
Assume $\mathcal{F}$ is a predeformation category. Then
\begin{enumerate}
\item for $x_0 \in \Ob(\mathcal{F}(k))$ the automorphism group
$\text{Aut}_k(x_0)$ is trivial and hence
$\text{Inf}_{x_0}(\mathcal{F}) = \text{Aut}_{k[\epsilon]}(x'_0)$, and
\item for $x_0, y_0 \in \Ob(\mathcal{F}(k))$ there is a unique
isomorphism $x_0 \to y_0$ and hence a canonical identification
$\text{Inf}_{x_0}(\mathcal{F}) = \text{Inf}_{y_0}(\mathcal{F})$.
\end{enumerate}
Since $\mathcal{F}(k)$ is nonempty, choosing $x_0 \in \Ob(\mathcal{F}(k))$
and setting
$$
\text{Inf}(\mathcal{F}) = \text{Inf}_{x_0}(\mathcal{F})
$$
we get a well defined {\it group of infinitesimal automorphisms
of $\mathcal{F}$}. With this notation we have
$\text{Inf}(\mathcal{F}_{x_0}) = \text{Inf}_{x_0}(\mathcal{F})$.
Please compare with the equality
$T\mathcal{F}_{x_0} = T_{x_0}\mathcal{F}$
in Remark \ref{remark-tangent-space-cofibered-groupoid}.
\end{remark}

\noindent
We will see that $\text{Inf}_{x_0}(\mathcal{F})$ has a natural $k$-vector
space structure when $\mathcal{F}$ satisfies (RS). At the same time, we will
see that if $\mathcal{F}$ satisfies (RS), then the infinitesimal automorphisms
$\text{Inf}(x'/x)$ of a morphism $x' \to x$ lying over a small
extension are governed by $\text{Inf}_{x_0}(\mathcal{F})$, where $x_0$ is
a pushforward of $x$ to $\mathcal{F}(k)$. In order to do this, we introduce
the automorphism functor for any object $x \in \Ob(\mathcal{F})$ as
follows.

\begin{definition}
\label{definition-automorphism-functor}
Let $p : \mathcal{F} \to \mathcal{C}$ be a category cofibered in groupoids
over an arbitrary base category $\mathcal{C}$. Assume a choice of pushforwards
has been made. Let $x \in \Ob(\mathcal{F})$ and let $U = p(x)$.
Let $U/\mathcal{C}$ denote the category of objects under $U$. The
{\it automorphism functor of $x$} is the functor
$\mathit{Aut}(x) : U/\mathcal{C} \to \textit{Sets}$ sending an object
$f : U \to V$ to $\text{Aut}_V(f_*x)$ and sending a morphism
$$
\xymatrix{
V' \ar[rr] &                    & V\\
          & U \ar[ul]^{f'}  \ar[ur]_f &
}
$$
to the homomorphism
$\text{Aut}_{V'}(f'_*x) \to \text{Aut}_V(f_*x)$
coming from the unique morphism $f'_*x \to f_*x$ lying over
$V' \to V$ and compatible with $x \to f'_*x$ and $x \to f_*x$.
\end{definition}

\noindent
We will be concerned with the automorphism functors of objects in a category
cofibered in groupoids $\mathcal{F}$ over $\mathcal{C}_\Lambda$. If
$A \in \Ob(\mathcal{C}_\Lambda)$, then the category
$A/\mathcal{C}_\Lambda$ is nothing but the category $\mathcal{C}_A$,
i.e.\ the category defined in Section \ref{section-CLambda}
where we take $\Lambda = A$ and $k = A/\mathfrak m_A$.
Hence the automorphism functor of an object
$x \in \Ob(\mathcal{F}(A))$ is a functor
$\mathit{Aut}(x) : \mathcal{C}_A \to \textit{Sets}$.

\medskip\noindent
The following lemma could be deduced from
Lemma \ref{lemma-RS-fiber-product-morphisms}
by thinking about the ``inertia'' of a category cofibred in groupoids,
see for example
Stacks, Section \ref{stacks-section-the-inertia-stack}
and
Categories, Section \ref{categories-section-inertia}.
However, it is easier to see it directly.

\begin{lemma}
\label{lemma-Aut-functor-RS}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$ satisfying (RS). Let
$x \in \Ob(\mathcal{F}(A))$. Then
$\mathit{Aut}(x): \mathcal{C}_A \to \textit{Sets}$ satisfies (RS).
\end{lemma}

\begin{proof}
It follows that $\mathit{Aut}(x)$ satisfies (RS) from the fully
faithfulness of the functor
$\mathcal{F}(A_1 \times_A A_2) \to
\mathcal{F}(A_1) \times_{\mathcal{F}(A)} \mathcal{F}(A_2)$ in
Lemma \ref{lemma-RS-2-categorical}.
\end{proof}

\begin{lemma}
\label{lemma-Aut-functor-tangent-space}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$ satisfying (RS). Let
$x \in \Ob(\mathcal{F}(A))$. Let $x_0$ be a pushforward of $x$ to
$\mathcal{F}(k)$.
\begin{enumerate}
\item $T_{\text{id}_{x_0}} \mathit{Aut}(x)$ has a natural $k$-vector
space structure such that addition agrees with composition in
$T_{\text{id}_{x_0}} \mathit{Aut}(x)$. In particular, composition in
$T_{\text{id}_{x_0}} \mathit{Aut}(x)$ is commutative.
\item There is a canonical isomorphism
$T_{\text{id}_{x_0}} \mathit{Aut}(x) \to
T_{\text{id}_{x_0}} \mathit{Aut}(x_0)$
of $k$-vector spaces.
\end{enumerate}
\end{lemma}

\begin{proof}
We apply
Remark \ref{remark-localize-cofibered-groupoid}
to the functor $\mathit{Aut}(x) : \mathcal{C}_A \to \textit{Sets}$
and the element $\text{id}_{x_0} \in \mathit{Aut}(x)(k)$ to get
a predeformation functor $F = \mathit{Aut}(x)_{\text{id}_{x_0}}$. By
Lemmas \ref{lemma-Aut-functor-RS} and \ref{lemma-localize-RS}
$F$ is a deformation functor. By definition
$T_{\text{id}_{x_0}} \mathit{Aut}(x) = TF = F(k[\epsilon])$
which has a natural
$k$-vector space structure specified by Lemma
\ref{lemma-tangent-space-functor}.

\medskip\noindent
Addition is defined as the composition
$$
F(k[\epsilon]) \times F(k[\epsilon]) \longrightarrow
F(k[\epsilon] \times_k k[\epsilon]) \longrightarrow
F(k[\epsilon])
$$
where the first map is the inverse of the bijection guaranteed by (RS) and the
second is induced by the $k$-algebra map
$k[\epsilon] \times_k k[\epsilon] \to k[\epsilon]$
which maps $(\epsilon, 0)$ and $(0, \epsilon)$ to $\epsilon$.
If $A \to B$ is a ring map in $\mathcal{C}_\Lambda$, then $F(A) \to F(B)$
is a homomorphism where $F(A) = \mathit{Aut}(x)_{\text{id}_{x_0}}(A)$ and
$F(B) = \mathit{Aut}(x)_{\text{id}_{x_0}}(B)$ are groups under
composition. We conclude that
$+ : F(k[\epsilon]) \times F(k[\epsilon])\to F(k[\epsilon])$
is a homomorphism where $F(k[\epsilon])$ is regarded as a
group under composition. With $\text{id} \in F(k[\epsilon])$ the
unit element we see that $+(v, \text{id}) =
+(\text{id}, v) = v$ for any $v \in F(k[\epsilon])$ because
$(\text{id}, v)$ is the pushforward of $v$ along the ring map
$k[\epsilon] \to k[\epsilon] \times_k k[\epsilon]$ with
$\epsilon \mapsto (\epsilon, 0)$.
In general, given a group $G$ with multiplication $\circ$
and $+ : G \times G \to G$ is a homomorphism such that
$+(g, 1) = +(1, g) = g$, where $1$ is the identity of $G$, then $+ = \circ$.
This shows addition in the $k$-vector space structure on $F(k[\epsilon])$
agrees with composition.

\medskip\noindent
Finally, (2) is a matter of unwinding the definitions. Namely
$T_{\text{id}_{x_0}} \mathit{Aut}(x)$ is the set of
automorphisms $\alpha$ of the pushforward of $x$ along
$A \to k \to k[\epsilon]$ which are trivial modulo $\epsilon$.
On the other hand $T_{\text{id}_{x_0}} \mathit{Aut}(x_0)$ is the set of
automorphisms of the pushforward of $x_0$ along
$k \to k[\epsilon]$ which are trivial modulo $\epsilon$.
Since $x_0$ is the pushforward of $x$ along $A \to k$ the result
is clear.
\end{proof}

\begin{remark}
\label{remark-infaut-lifting-equalities}
We point out some basic relationships between infinitesimal automorphism
groups, liftings, and tangent spaces to automorphism functors. Let
$\mathcal{F}$ be a category cofibered in groupoids over $\mathcal{C}_\Lambda$.
Let $x' \to x$ be a morphism lying over a ring map $A' \to A$.
Then from the definitions we have an equality
$$
\text{Inf}(x'/x) = \text{Lift}(\text{id}_x, A')
$$
where the liftings are of $\text{id}_x$ as an object of
$\mathit{Aut}(x')$.  If $x_0 \in \Ob(\mathcal{F}(k))$ and $x'_0$
is the pushforward to $\mathcal{F}(k[\epsilon])$, then applying this to
$x'_0 \to x_0$ we get
$$
\text{Inf}_{x_0}(\mathcal{F}) =
\text{Lift}(\text{id}_{x_0}, k[\epsilon]) =
T_{\text{id}_{x_0}} \mathit{Aut}(x_0),
$$
the last equality following directly from the definitions.
\end{remark}

\begin{lemma}
\label{lemma-infaut-vector-space}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$ satisfying (RS). Let $x_0 \in \Ob(\mathcal{F}(k))$.
Then $\text{Inf}_{x_0}(\mathcal{F})$ is equal as a set to
$T_{\text{id}_{x_0}} \mathit{Aut}(x_0)$, and so has a natural $k$-vector
space structure such that addition agrees with composition of automorphisms.
\end{lemma}

\begin{proof}
The equality of sets is as in the end of
Remark \ref{remark-infaut-lifting-equalities}
and the statement about the vector space structure follows from
Lemma \ref{lemma-Aut-functor-tangent-space}.
\end{proof}

\begin{lemma}
\label{lemma-k-linear-infaut}
Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a morphism of categories
cofibred in groupoids over $\mathcal{C}_\Lambda$ satisfying (RS).
Let $x_0 \in \Ob(\mathcal{F}(k))$. Then $\varphi$ induces a $k$-linear
map $\text{Inf}_{x_0}(\mathcal{F}) \to \text{Inf}_{\varphi(x_0)}(\mathcal{G})$.
\end{lemma}

\begin{proof}
It is clear that $\varphi$ induces a morphism from
$\mathit{Aut}(x_0) \to \mathit{Aut}(\varphi(x_0))$
which maps the identity to the identity. Hence this follows from
the result for tangent spaces, see
Lemma \ref{lemma-k-linear-differential}.
\end{proof}

\begin{lemma}
\label{lemma-lifted-automorphisms-torsor}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$ satisfying (RS). Let $x' \to x$ be a
morphism lying over a surjective ring map $A' \to A$ with kernel $I$
annihilated by $\mathfrak m_{A'}$. Let $x_0$ be a pushforward of $x$ to
$\mathcal{F}(k)$. Then $\text{Inf}(x'/x)$ has a free and transitive action by
$T_{\text{id}_{x_0}} \mathit{Aut}(x') \otimes_k I
= \text{Inf}_{x_0}(\mathcal{F}) \otimes_k I$.
\end{lemma}

\begin{proof}
This is just the analogue of
Lemma \ref{lemma-free-transitive-action}
in the setting of automorphism sheaves.
To be precise, we apply
Remark \ref{remark-localize-cofibered-groupoid}
to the functor $\mathit{Aut}(x') : \mathcal{C}_{A'} \to \textit{Sets}$
and the element $\text{id}_{x_0} \in \mathit{Aut}(x)(k)$ to get
a predeformation functor $F = \mathit{Aut}(x')_{\text{id}_{x_0}}$. By
Lemmas \ref{lemma-Aut-functor-RS} and \ref{lemma-localize-RS}
$F$ is a deformation functor. Hence
Lemma \ref{lemma-free-transitive-action}
gives a free and transitive action
of $TF \otimes_k I$ on $\text{Lift}(\text{id}_x, A')$, because as
$\text{Lift}(\text{id}_x, A')$ is a group it is always nonempty.
Note that we have equalities of vector spaces
$$
TF = T_{\text{id}_{x_0}} \mathit{Aut}(x') \otimes_k I =
\text{Inf}_{x_0}(\mathcal{F}) \otimes_k I
$$
by
Lemma \ref{lemma-Aut-functor-tangent-space}.
The equality $\text{Inf}(x'/x) = \text{Lift}(\text{id}_x, A')$ of
Remark \ref{remark-infaut-lifting-equalities}
finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-infaut-trivial}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$ satisfying (RS). Let $x' \to x$ be a morphism
in $\mathcal{F}$ lying over a surjective ring map. Let $x_0$ be a pushforward
of $x$ to $\mathcal{F}(k)$. If $\text{Inf}_{x_0}(\mathcal{F}) = 0$ then
$\text{Inf}(x'/x) = 0$.
\end{lemma}

\begin{proof}
Follows from
Lemmas \ref{lemma-factor-small-extension} and
\ref{lemma-lifted-automorphisms-torsor}.
\end{proof}

\begin{lemma}
\label{lemma-infdef-trivial}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$ satisfying (RS). Let
$x_0 \in \Ob(\mathcal{F}(k))$. Then $\text{Inf}_{x_0}(\mathcal{F}) = 0$
if and only if the natural morphism
$\mathcal{F}_{x_0} \to \overline{\mathcal{F}_{x_0}}$ of
categories cofibered in groupoids is an equivalence.
\end{lemma}

\begin{proof}
The morphism $\mathcal{F}_{x_0} \to \overline{\mathcal{F}_{x_0}}$ is an
equivalence if and only if $\mathcal{F}_{x_0}$ is fibered in setoids,
cf.\ Categories, Section \ref{categories-section-fibred-in-setoids}
(a setoid is by definition a groupoid in
which the only automorphism of any object is the identity). We prove that
$\text{Inf}_{x_0}(\mathcal{F}) = 0$ if and only if this condition holds
for $\mathcal{F}_{x_0}$.  Obviously if $\mathcal{F}_{x_0}$ is fibered in
setoids then $\text{Inf}_{x_0}(\mathcal{F}) = 0$.  Conversely assume
$\text{Inf}_{x_0}(\mathcal{F}) = 0$.  Let $A$ be an object of
$\mathcal{C}_\Lambda$. Then by
Lemma \ref{lemma-infaut-trivial},
$\text{Inf}(x/x_0) = 0$ for any object $x \to x_0$ of
$\mathcal{F}_{x_0}(A)$. Since by definition $\text{Inf}(x/x_0)$
equals the group of automorphisms of $x \to x_0$ in $\mathcal{F}_{x_0}(A)$,
this proves $\mathcal{F}_{x_0}(A)$ is a setoid.
\end{proof}








\section{Applications}
\label{section-applications}

\noindent
We collect some results on deformation categories we will use later.

\begin{lemma}
\label{lemma-deformation-categories-fiber-product-morphisms}
Let $f : \mathcal{H} \to \mathcal{F}$ and $g : \mathcal{G} \to \mathcal{F}$
be $1$-morphisms of deformation categories. Then
\begin{enumerate}
\item $\mathcal{W} = \mathcal{H} \times_\mathcal{F} \mathcal{G}$ is a
deformation category, and
\item we have a $6$-term exact sequence of vector spaces
$$
0 \to \text{Inf}(\mathcal{W})
\to \text{Inf}(\mathcal{H}) \oplus \text{Inf}(\mathcal{G})
\to \text{Inf}(\mathcal{F}) \to
T\mathcal{W} \to T\mathcal{H} \oplus T\mathcal{G} \to T\mathcal{F}
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from Lemma \ref{lemma-RS-fiber-product-morphisms}
and the fact that $\mathcal{W}(k)$ is the fibre product of
two setoids with a unique isomorphism class over a setoid with
a unique isomorphism class.

\medskip\noindent
Part (2). Let $w_0 \in \Ob(\mathcal{W}(k))$ and let $x_0, y_0, z_0$ be
the image of $w_0$ in $\mathcal{F}, \mathcal{H}, \mathcal{G}$.
Then $\text{Inf}(\mathcal{W}) = \text{Inf}_{w_0}(\mathcal{W})$
and simlarly for $\mathcal{H}$, $\mathcal{G}$, and $\mathcal{F}$, see
Remark \ref{remark-trivial-aut-point}.
We apply Lemmas \ref{lemma-k-linear-differential} and
\ref{lemma-k-linear-infaut} to get all the linear maps
except for the ``boundary map''
$\delta : \text{Inf}_{x_0}(\mathcal{F}) \to T\mathcal{W}$.
We will insert suitable signs later.

\medskip\noindent
Construction of $\delta$. Choose a pushforward $w_0 \to w'_0$ along
$k \to k[\epsilon]$. Denote $x'_0, y'_0, z'_0$ the images of $w'_0$ in
$\mathcal{F}, \mathcal{H}, \mathcal{G}$. In particular
we obtain isomorphisms $b' : f(y'_0) \to x'_0$ and $c' : x'_0 \to g(z'_0)$.
Denote $b : f(y_0) \to x_0$ and $c : x_0 \to g(z_0)$ the pushforwards
along $k[\epsilon] \to k$. Observe that this means
$w'_0 = (k[\epsilon], y'_0, z'_0, c' \circ b')$ and
$w_0 = (k, y_0, z_0, c \circ b)$ in terms of the explicit form
of the fibre product of categories,
see Remarks \ref{remarks-cofibered-groupoids} (\ref{item-fibre-product}).
Given $\alpha : x'_0 \to x'_0$ we set
$\delta(\alpha) = (k[\epsilon], y'_0, z'_0, c' \circ \alpha \circ b')$
which is indeed an object of $\mathcal{W}$ over $k[\epsilon]$ and comes
with a morphism $(k[\epsilon], y'_0, z'_0, c' \circ \alpha \circ b') \to w_0$
over $k[\epsilon] \to k$ as $\alpha$ pushes forward to the identity over $k$.
More generally, for any $k$-vector space $V$ we can define a map
$$
\text{Lift}(\text{id}_{x_0}, k[V])
\longrightarrow
\text{Lift}(w_0, k[V])
$$
using exactly the same formulae. This construction is functorial
in the vector space $V$ (details omitted). Hence $\delta$ is $k$-linear
by an application of
Lemma \ref{lemma-morphism-linear-functors}.

\medskip\noindent
Having constructed these maps it is straightforward to show the sequence
is exact. Injectivity of the first map comes from the fact that
$f \times g : \mathcal{W} \to \mathcal{H} \times \mathcal{G}$
is faithful. If
$(\beta, \gamma) \in
\text{Inf}_{y_0}(\mathcal{H}) \oplus \text{Inf}_{z_0}(\mathcal{G})$
map to the same element of $\text{Inf}_{x_0}(\mathcal{F})$ then
$(\beta, \gamma)$ defines an automorphism of
$w'_0 = (k[\epsilon], y'_0, z'_0, c' \circ b')$ whence exactness
at the second spot. If $\alpha$ as above gives the trivial deformation
$(k[\epsilon], y'_0, z'_0, c' \circ \alpha \circ b')$
of $w_0$, then the isomorphism
$w'_0 = (k[\epsilon], y'_0, z'_0, c' \circ b') \to
(k[\epsilon], y'_0, z'_0, c' \circ \alpha \circ b')$
produces a pair $(\beta, \gamma)$ which is a preimage of $\alpha$.
If $w = (k[\epsilon], y, z, \phi)$ is a deformation of $w_0$
such that $y'_0 \cong y$ and $z \cong z'_0$ then the map
$$
f(y'_0) \to f(y) \xrightarrow{\phi} g(z) \to g(z'_0)
$$
is an $\alpha$ which maps to $w$ under $\delta$.
Finally, if $y$ and $z$ are deformations of $y_0$ and $z_0$
and there exists an isomorphism $\phi : f(y) \to g(z)$ of deformations
of $f(y_0) = x_0 = g(z_0)$ then we get a preimage
$w = (k[\epsilon], y, z, \phi)$ of $(x, y)$ in $T\mathcal{W}$.
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-map-fibre-products-smooth}
Let $\mathcal{H}_1 \to \mathcal{G}$, $\mathcal{H}_2 \to \mathcal{G}$, and
$\mathcal{G} \to \mathcal{F}$ be maps of categories cofibred in groupoids
over $\mathcal{C}_\Lambda$. Assume
\begin{enumerate}
\item $\mathcal{F}$ and $\mathcal{G}$ are deformation categories,
\item $T\mathcal{G} \to T\mathcal{F}$ is injective, and
\item $\text{Inf}(\mathcal{G}) \to \text{Inf}(\mathcal{F})$ is surjective.
\end{enumerate}
Then $\mathcal{H}_1 \times_\mathcal{G} \mathcal{H}_2 \to
\mathcal{H}_1 \times_\mathcal{F} \mathcal{H}_2$ is smooth.
\end{lemma}

\begin{proof}
Denote $p_i : \mathcal{H}_i \to \mathcal{G}$ and
$q : \mathcal{G} \to \mathcal{F}$ be the given maps.
Let $A' \to A$ be a small extension in $\mathcal{C}_\Lambda$.
An object of $\mathcal{H}_1 \times_\mathcal{F} \mathcal{H}_2$
over $A'$ is a triple $(x'_1, x'_2, a')$ where
$x'_i$ is an object of $\mathcal{H}_i$ over $A'$ and
$a' : q(p_1(x'_1)) \to q(p_2(x'_2))$ is a morphism
of the fibre category of $\mathcal{F}$ over $A'$.
By pushforward along $A' \to A$ we get
$(x_1, x_2, a)$. Lifting this to an object of
$\mathcal{H}_1 \times_\mathcal{G} \mathcal{H}_2$
over $A$ means finding a morphism
$b : p_1(x_1) \to p_2(x_2)$ over $A$ with $q(b) = a$.
Thus we have to show that we can lift $b$ to a morphism
$b' : p_1(x'_1) \to p_2(x'_2)$ whose image under $q$ is $a'$.

\medskip\noindent
Observe that we can think of
$$
p_1(x'_1) \to p_1(x_1) \xrightarrow{b} p_2(x_2)
\quad\text{and}\quad
p_2(x'_2) \to p_2(x_2)
$$
as two objects of $\textit{Lift}(p_2(x_2), A' \to A)$.
The functor $q$ sends these objects to the two objects
$$
q(p_1(x'_1)) \to q(p_1(x_1)) \xrightarrow{b} q(p_2(x_2))
\quad\text{and}\quad
q(p_2(x'_2)) \to q(p_2(x_2))
$$
of $\textit{Lift}(q(p_2(x_2)), A' \to A)$
which are isomorphic using the map $a' : q(p_1(x'_1)) \to q(p_2(x'_2))$.
On the other hand, the functor
$$
q : \textit{Lift}(p_2(x_2), A' \to A) \to
\textit{Lift}(q(p_2(x_2)), A' \to A)
$$
defines a injection on isomorphism classes by
Lemma \ref{lemma-free-transitive-action}
and our assumption on tangent spaces. Thus we see that there is a morphism
$b' : p_1(x_1') \to p_2(x'_2)$ whose pushforward to $A$ is $b$.
However, we may need to adjust our choice of $b'$
to achieve $q(b') = a'$. For this it suffices to see that
$q : \text{Inf}(p_2(x'_2)/p_2(x_2)) \to \text{Inf}(q(p_2(x'_2))/q(p_2(x_2)))$
is surjective. This follows from our assumption on
infinitesimal automorphisms and Lemma \ref{lemma-lifted-automorphisms-torsor}.
\end{proof}

\begin{lemma}
\label{lemma-easy-check-smooth}
Let $f : \mathcal{F} \to \mathcal{G}$ be a map of deformation
categories. Let $x_0 \in \Ob(\mathcal{F}(k))$ with image
$y_0 \in \Ob(\mathcal{G}(k))$. If
\begin{enumerate}
\item the map $T\mathcal{F} \to T\mathcal{G}$ is surjective, and
\item for every small extension $A' \to A$ in $\mathcal{C}_\Lambda$
and $x \in \mathcal{F}(A)$ with image $y \in \mathcal{G}(A)$
if there is a lift of $y$ to $A'$, then there is a lift
of $x$ to $A'$,
\end{enumerate}
then $\mathcal{F} \to \mathcal{G}$ is smooth (and vice versa).
\end{lemma}

\begin{proof}
Let $A' \to A$ be a small extension. Let $x \in \mathcal{F}(A)$.
Let $y' \to f(x)$ be a morphism in $\mathcal{G}$ over $A' \to A$.
Consider the functor $\text{Lift}(A', x) \to \text{Lift}(A', f(x))$
induced by $f$.
We have to show that there exists an object $x' \to x$
of $\text{Lift}(A', x)$ mapping to $y' \to f(x)$, see
Lemma \ref{lemma-smoothness-small-extensions}.
By condition (2) we know that $\text{Lift}(A', x)$
is not the empty category.
By condition (2) and
Lemma \ref{lemma-free-transitive-action}
we conlude that the map on isomorphism classes
is surjective as desired.
\end{proof}

\begin{lemma}
\label{lemma-map-between-smooth}
Let $\mathcal{F} \to \mathcal{G} \to \mathcal{H}$ be maps of categories
cofibred in groupoids over $\mathcal{C}_\Lambda$. If
\begin{enumerate}
\item $\mathcal{F}$, $\mathcal{G}$ are deformation categories
\item the map $T\mathcal{F} \to T\mathcal{G}$ is surjective, and
\item $\mathcal{F} \to \mathcal{H}$ is smooth.
\end{enumerate}
Then $\mathcal{F} \to \mathcal{G}$ is smooth.
\end{lemma}

\begin{proof}
Let $A' \to A$ be a small extension in $\mathcal{C}_\Lambda$
and let $x \in \mathcal{F}(A)$ with image $y \in \mathcal{G}(A)$.
Assume there is a lift $y' \in \mathcal{G}(A')$. According to
Lemma \ref{lemma-easy-check-smooth} all we have to do is check
that $x$ has a lift too. Take the image $z' \in \mathcal{H}(A')$
of $y'$. Since $\mathcal{F} \to \mathcal{H}$ is smooth, there is
an $x' \in \mathcal{F}(A')$ mapping to both $x \in \mathcal{F}(A)$
and $z' \in \mathcal{H}(A')$, see
Definition \ref{definition-smooth-morphism}. This finishes the proof.
\end{proof}





\section{Groupoids in functors on an arbitrary category}
\label{section-groupoids-arbitrary}

\noindent
We begin with generalities on groupoids in functors on an
arbitrary category. In the next section we will
pass to the category $\mathcal{C}_\Lambda$.
For clarity we shall sometimes refer to an ordinary groupoid,
i.e., a category whose morphisms are all isomorphisms, as a groupoid category.

\begin{definition}
\label{definition-groupoid-in-functors}
Let $\mathcal{C}$ be a category. The
{\it category of groupoids in functors on $\mathcal{C}$}
is the category with the following objects and morphisms.
\begin{enumerate}
\item Objects: A {\it groupoid in functors on $\mathcal{C}$} is a quintuple
$(U, R, s, t, c)$ where $U, R : \mathcal{C} \to \textit{Sets}$ are
functors and $s, t : R \to U$ and $c : R \times_{s, U, t} R \to R$
are morphisms with the following property: For any object $T$ of $\mathcal{C}$,
the quintuple
$$
(U(T), R(T), s, t, c)
$$
is a groupoid category.
\item Morphisms: A {\it morphism $(U, R, s, t, c) \to (U', R', s', t', c')$ of
groupoids in functors on $\mathcal{C}$} consists of morphisms $U \to U'$
and $R \to R'$ with the following property: For any object $T$ of
$\mathcal{C}$, the induced maps $U(T) \to U'(T)$ and
$R(T) \to R'(T)$ define a functor between groupoid categories
$$
(U(T), R(T), s, t, c) \to (U'(T), R'(T), s', t', c').
$$
\end{enumerate}
\end{definition}

\begin{remark}
\label{remark-confusion-groupoids-in-functors}
A groupoid in functors on $\mathcal{C}$ amounts to the data of a functor
$\mathcal{C} \to \textit{Groupoids}$, and a morphism of groupoids
in functors on $\mathcal{C}$ amounts to a morphism of the corresponding
functors
$\mathcal{C} \to \textit{Groupoids}$ (where
$\textit{Groupoids}$ is regarded as a 1-category).  However, for our
purposes it is more convenient to use the terminology of groupoids in functors.
In fact, thinking of a groupoid in functors as the corresponding functor
$\mathcal{C} \to \textit{Groupoids}$, or equivalently as the
category cofibered in groupoids associated to that functor, can lead to
confusion (Remark \ref{remark-smooth-groupoid-in-functors-warning}).
\end{remark}

\begin{remark}
\label{remark-identity-inverse}
Let $(U, R, s, t, c)$ be a groupoid in functors on a category $\mathcal{C}$.
There are unique morphisms $e : U \to R$ and $i : R \to R$ such that
for every object $T$ of $\mathcal{C}$, $e: U(T) \to R(T)$ sends
$x \in U(T)$ to the identity morphism on $x$ and $i: R(T) \to R(T)$ sends
$a \in U(T)$ to the inverse of $a$ in the groupoid category
$(U(T), R(T), s, t, c)$. We will sometimes refer to $s$, $t$, $c$, $e$,
and $i$ as ``source'', ``target'', ``composition'', ``identity'', and
``inverse''.
\end{remark}

\begin{definition}
\label{definition-representable}
Let $\mathcal{C}$ be a category. A groupoid in functors on $\mathcal{C}$ is
{\it representable} if it is isomorphic to one of the form
$(\underline{U}, \underline{R}, s, t, c)$ where $U$ and $R$ are objects of
$\mathcal{C}$ and the pushout $R \amalg_{s, U, t} R$ exists.
\end{definition}

\begin{remark}
\label{remark-reason-existence-coproduct}
Hence a representable groupoid in functors on $\mathcal{C}$ is given by
objects $U$ and $R$ of $\mathcal{C}$ and morphisms $s, t : U \to R$ and
$c : R \to R \amalg_{s, U, t} R$ such that
$(\underline{U}, \underline{R}, s, t, c)$ satisfies the condition of
Definition \ref{definition-groupoid-in-functors}. The reason for requiring
the existence of the pushout $R \amalg_{s, U, t} R$ is so that the composition
morphism $c$ is defined at the level of morphisms in $\mathcal{C}$.
This requirement will always be satisfied below when we consider
representable groupoids in functors on
$\widehat{\mathcal{C}}_\Lambda$, since by
Lemma \ref{lemma-CLambdahat-pushouts}
the category $\widehat{\mathcal{C}}_\Lambda$ admits pushouts.
\end{remark}

\begin{remark}
\label{remark-simplify-terminology}
We will say ``{\it let $(\underline{U}, \underline{R}, s, t, c)$ be a
groupoid in functors on $\mathcal{C}$}'' to mean that we have
a representable groupoid in functors. Thus this means that
$U$ and $R$ are objects of $\mathcal{C}$, there are morphisms
$s, t : U \to R$, the pushout $R \amalg_{s, U, t} R$ exists,
there is a morphism $c : R \to R \amalg_{s, U, t} R$, and
$(\underline{U}, \underline{R}, s, t, c)$ is a
groupoid in functors on $\mathcal{C}$.
\end{remark}

\noindent
We introduce notation for restriction of groupoids in functors. This will be
relevant below in situations where we restrict from $\widehat{\mathcal
C}_\Lambda$ to $\mathcal{C}_\Lambda$.

\begin{definition}
\label{definition-restricting-groupoids-in-functors}
Let $(U, R, s, t, c)$ be a groupoid in functors on a category $\mathcal{C}$.
Let $\mathcal{C}'$ be a subcategory of $\mathcal{C}$. The
{\it restriction $(U, R, s, t, c)|_{\mathcal{C}'}$ of $(U, R, s, t, c)$
to $\mathcal{C}'$} is the groupoid
in functors on $\mathcal{C}'$ given by $(U|_{\mathcal{C}'}, R|_{\mathcal
C'}, s|_{\mathcal{C}'}, t|_{\mathcal{C}'}, c|_{\mathcal{C}'})$.
\end{definition}

\begin{remark}
\label{remark-notation-restriction}
In the situation of Definition
\ref{definition-restricting-groupoids-in-functors}, we often denote
$s|_{\mathcal{C}'}, t|_{\mathcal{C}'}, c|_{\mathcal{C}'}$ simply by $s, t, c$.
\end{remark}

\begin{definition}
\label{definition-quotient}
Let $(U, R, s, t, c)$ be a groupoid in functors on a category $\mathcal{C}$.
\begin{enumerate}
\item The assignment $T \mapsto  (U(T), R(T), s, t, c)$ determines a functor
$\mathcal{C} \to \textit{Groupoids}$. The {\it quotient category
cofibered in groupoids $[U/R] \to \mathcal{C}$} is the category
cofibered in groupoids over $\mathcal{C}$ associated to this functor (as in
Remarks \ref{remarks-cofibered-groupoids}
(\ref{item-construction-associated-cofibered-groupoid})).
\item The {\it quotient morphism $U \to [U/R]$} is the morphism of
categories cofibered in groupoids over $\mathcal{C}$ defined by the
rules
\begin{enumerate}
\item $x \in U(T)$ maps to the object $(T, x) \in \Ob([U/R](T))$, and
\item $x \in U(T)$ and $f : T \to T'$ give rise to the morphism
$(f, \text{id}_{U(f)(x)}): (T, x) \to (T, U(f)(x))$ lying over
$f : T \to T'$.
\end{enumerate}
\end{enumerate}
\end{definition}





\section{Groupoids in functors on the base category}
\label{section-prorepresentable-groupoids-in-functors}

\noindent
In this section we discuss groupoids in functors on $\mathcal{C}_\Lambda$.
Our eventual goal is to show that prorepresentable groupoids
in functors on $\mathcal{C}_\Lambda$ serve as ``presentations''
for well-behaved deformation categories in the same way that
smooth groupoids in algebraic spaces serve as presentations for
algebraic stacks,
cf.\ Algebraic Stacks, Section \ref{algebraic-section-stack-to-presentation}.

\begin{definition}
\label{definition-prorepresentable-groupoid-in-functors}
A groupoid in functors on $\mathcal{C}_\Lambda$ is {\it prorepresentable}
if it is isomorphic to
$(\underline{R_0}, \underline{R_1}, s, t, c)|_{\mathcal{C}_\Lambda}$
for some representable groupoid in functors
$(\underline{R_0}, \underline{R_1}, s, t, c)$ on the category
$\widehat{\mathcal{C}}_\Lambda$.
\end{definition}

\noindent
Let $(U, R, s, t, c)$ be a groupoid in functors on $\mathcal{C}_\Lambda$.
Taking completions, we get a quintuple
$(\widehat{U}, \widehat{R}, \widehat{s}, \widehat{t}, \widehat{c})$. By
Remark \ref{remark-completion-restriction-cofset-adjoint}
completion as a functor on $\text{CofSet}(\mathcal{C}_\Lambda)$ is a right
adjoint, so it commutes with limits. In particular, there is a canonical
isomorphism
$$
\widehat{R \times_{s, U, t} R}
\longrightarrow
\widehat{R} \times_{\widehat{s}, \widehat{U}, \widehat{t}} \widehat{R},
$$
so $\widehat{c}$ can be regarded as a functor
$\widehat{R} \times_{\widehat{s}, \widehat{U}, \widehat{t}} \widehat{R} \to
\widehat{R}$. Then
$(\widehat{U}, \widehat{R}, \widehat{s}, \widehat{t}, \widehat{c})$
is a groupoid in functors on $\widehat{\mathcal{C}}_\Lambda$, with
identity and inverse morphisms being the completions of those of
$(U, R, s, t, c)$.

\begin{definition}
\label{definition-completion-groupoid-in-functors}
Let $(U, R, s, t, c)$ be a groupoid in functors on $\mathcal{C}_\Lambda$.
The {\it completion $(U, R, s, t, c)^{\wedge}$ of $(U, R, s, t, c)$} is the
groupoid in functors
$(\widehat{U}, \widehat{R}, \widehat{s}, \widehat{t}, \widehat{c})$
on $\widehat{\mathcal{C}}_\Lambda$ described above.
\end{definition}

\begin{remark}
\label{remark-groupoid-in-functors-complete-restrict}
Let $(U, R, s, t, c)$ be a groupoid in functors on $\mathcal{C}_\Lambda$.
Then there is a canonical isomorphism
$(U, R, s, t, c)^{\wedge}|_{\mathcal{C}_\Lambda} \cong (U, R, s, t, c)$, see
Remark \ref{remark-restrict-completion}.
On the other hand, let $(U, R, s, t, c)$ be a groupoid in functors on
$\widehat{\mathcal{C}}_\Lambda$ such that
$U, R : \widehat{\mathcal{C}}_\Lambda \to \textit{Sets}$
both commute with limits, e.g.\ if $U, R$ are representable.
Then there is a canonical isomorphism
$((U, R, s, t, c)|_{\mathcal{C}_\Lambda})^{\wedge} \cong (U, R, s, t, c)$.
This follows from
Remark \ref{remark-restrict-complete-continuous-functor}.
\end{remark}

\begin{lemma}
\label{lemma-groupoid-in-functors-prorep-equivalences}
Let $(U, R, s, t, c)$ be a groupoid in functors on $\mathcal{C}_\Lambda$.
\begin{enumerate}
\item $(U, R, s, t, c)$ is prorepresentable if and only if its completion is
representable as a groupoid in functors on $\widehat{\mathcal{C}}_\Lambda$.
\item $(U, R, s, t, c)$ is prorepresentable if and only if $U$ and $R$ are
prorepresentable.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from
Remark \ref{remark-groupoid-in-functors-complete-restrict}.
For (2), the ``only if'' direction is clear from the definition
of a prorepresentable groupoid in functors. Conversely, assume $U$ and $R$
are prorepresentable, say $U \cong \underline{R_0}|_{\mathcal{C}_\Lambda}$
and $R \cong \underline{R_1}|_{\mathcal{C}_\Lambda}$ for objects $R_0$ and
$R_1$ of $\widehat{\mathcal{C}}_\Lambda$.
Since $\underline{R_0} \cong \widehat{\underline{R_0}|_{\mathcal{C}_\Lambda}}$
and $\underline{R_1} \cong \widehat{\underline{R_1}|_{\mathcal{C}_\Lambda}}$
by
Remark \ref{remark-restrict-complete-continuous-functor}
we see that the completion $(U, R, s, t, c)^\wedge$ is a groupoid in
functors of the form
$(\underline{R_0}, \underline{R_1}, \widehat{s}, \widehat{t}, \widehat{c})$.
By
Lemma \ref{lemma-CLambdahat-pushouts}
the pushout
$\underline{R_1} \times_{\widehat{s}, \underline{R_1}, \widehat{t}}
\underline{R_1}$ exists. Hence
$(\underline{R_0}, \underline{R_1}, \widehat{s}, \widehat{t}, \widehat{c})$
is a representable groupoid in functors on $\widehat{\mathcal{C}}_\Lambda$.
Finally, the restriction
$(\underline{R_0}, \underline{R_1}, s, t, c)|_{\mathcal{C}_\Lambda}$
gives back $(U, R, s, t, c)$ by
Remark \ref{remark-groupoid-in-functors-complete-restrict}
hence $(U, R, s, t, c)$ is prorepresentable by definition.
\end{proof}






\section{Smooth groupoids in functors on the base category}
\label{section-smooth-minimal-groupoids-in-functors}

\noindent
The notion of smoothness for groupoids in functors on $\mathcal{C}_\Lambda$ is
defined as follows.

\begin{definition}
\label{definition-smooth-groupoid-in-functors}
Let $(U, R, s, t, c)$ be a groupoid in functors on $\mathcal{C}_\Lambda$. We
say $(U, R, s, t, c)$ is {\it smooth} if $s, t: R \to U$ are smooth.
\end{definition}

\begin{remark}
\label{remark-smooth-groupoid-in-functors-warning}
We note that this terminology is potentially confusing:
if $(U, R, s, t, c)$ is a smooth groupoid in functors, then the quotient
$[U/R]$ need not be a smooth category cofibred in groupoids as defined in
Definition \ref{definition-cofibered-groupoid-projection-smooth}.
However smoothness of $(U, R, s, t, c)$ does imply (in fact is equivalent to)
smoothness of the quotient morphism $U \to [U/R]$ as we shall
see in
Lemma \ref{lemma-smooth-quotient-morphism}.
\end{remark}

\begin{remark}
\label{remark-smooth-power-series-prorepresentable-smooth-groupoid-in-functors}
Let $(\underline{R_0}, \underline{R_1}, s, t, c)|_{\mathcal{C}_\Lambda}$
be a prorepresentable groupoid in functors on $\mathcal{C}_\Lambda$.
Then $(\underline{R_0}, \underline{R_1}, s, t, c)|_{\mathcal{C}_\Lambda}$
is smooth if and only if $R_1$ is a power series over $R_0$ via both $s$
and $t$. This follows from
Lemma \ref{lemma-smooth-morphism-power-series}.
\end{remark}

\begin{lemma}
\label{lemma-smooth-quotient-morphism}
Let $(U, R, s, t, c)$ be a groupoid in functors on $\mathcal{C}_\Lambda$.
The following are equivalent:
\begin{enumerate}
\item The groupoid in functors $(U, R, s, t, c)$ is smooth.
\item The morphism $s : R \to U$ is smooth.
\item The morphism $t : R \to U$ is smooth.
\item The quotient morphism $U \to [U/R]$ is smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Statement (2) is equivalent to (3) since the inverse $i: R \to R$ of
$(U, R, s, t, c)$ is an isomorphism and $t = s \circ i$. By definition (1) is
equivalent to (2) and (3) together, hence it is equivalent to either of them
individually.

\medskip\noindent
Finally we prove (2) is equivalent to (4). Unwinding the definitions:
\begin{enumerate}
\item[(2)] Smoothness of $s: R \to U$ amounts to the following
condition: If $f: B \to A$ is a surjective ring map in
$\mathcal{C}_\Lambda$, $a \in R(A)$, and $y \in U(B)$ such that
$s(a) = U(f)(y)$, then there exists $a' \in R(B)$ such that
$R(f)(a') = a$ and $s(a') = y$.
\item[(4)] Smoothness of $U \to [U/R]$ amounts to the following
condition: If $f: B \to A$ is a surjective ring map in
$\mathcal{C}_\Lambda$ and $(f, a) : (B, y) \to (A, x)$
is a morphism of $[U/R]$, then there exists $x' \in U(B)$ and
$b \in R(B)$ with $s(b) = x'$, $t(b) = y$
such that $c(a, R(f)(b)) = e(x)$.  Here $e : U \to R$ denotes the
identity and the notation $(f, a)$ is as in Remarks
\ref{remarks-cofibered-groupoids}
(\ref{item-construction-associated-cofibered-groupoid});
in particular $a \in R(A)$ with $s(a) = U(f)(y)$ and $t(a) = x$.
\end{enumerate}
If (4) holds and $f, a, y$ as in (2) are given, let $x = t(a)$ so that
we have a morphism $(f, a): (B, y) \to (A, x)$.
Then (4) produces $x'$ and $b$, and $a' = i(b)$ satisfies the requirements
of (2). Conversely, assume (2) holds and let $(f, a): (B, y) \to (A, x)$
as in (4) be given. Then (2) produces $a' \in R(B)$, and $x' = t(a')$ and
$b = i(a')$ satisfy the requirements of (4).
\end{proof}





\section{Deformation categories as quotients of groupoids in functors}
\label{section-deformation-categories-as-quotients}

\noindent
We discuss conditions on a groupoid in functors on $\mathcal{C}_\Lambda$ which
guarantee that the quotient is a deformation category, and we calculate the
tangent and infinitesimal automorphism spaces of such a quotient.

\begin{lemma}
\label{lemma-smooth-RS-groupoid-in-functors-quotient}
Let $(U, R, s, t, c)$ be a smooth groupoid in functors on $\mathcal{C}_\Lambda$.
Assume $U$ and $R$ satisfy (RS). Then $[U/R]$ satisfies (RS).
\end{lemma}

\begin{proof}
Let
$$
\xymatrix{
                           &     (A_2, x_2) \ar[d]^{(f_2, a_2)} \\
(A_1, x_1) \ar[r]^{(f_1, a_1)} &     (A, x)
}
$$
be a diagram in $[U/R]$ such that $f_2: A_2 \to A$ is surjective. The
notation is as in
Remarks \ref{remarks-cofibered-groupoids}
(\ref{item-construction-associated-cofibered-groupoid}).
Hence $f_1: A_1 \to A, f_2: A_2 \to A$ are maps in
$\mathcal{C}_\Lambda$, $x \in U(A)$, $x_1 \in U(A_1)$, $x_2 \in U(A_2)$,
and $a_1, a_2 \in R(A)$ with $s(a_1) = U(f_1)(x_1)$,
$t(a_1) = x$ and $s(a_2) = U(f_2)(x_2)$, $t(a_2) = x$.
We construct a fiber product lying over $A_1 \times_A A_2$
for this diagram in $[U/R]$ as follows.

\medskip\noindent
Let $a = c(i(a_1), a_2)$, where $i: R \to R$ is the inverse morphism.
Then $a \in R(A)$, $x_2 \in U(A_2)$ and $s(a) = U(f_2)(x_2)$.
Hence an element $(a, x_2) \in R(A) \times_{s, U(A), U(f_2)} U(A_2)$.
By smoothness of $s : R \to U$ there is an element
$\widetilde{a} \in R(A_2)$ with $R(f_2)(\widetilde{a}) = a$ and
$s(\widetilde{a}) = x_2$. In particular
$U(f_2)(t(\widetilde{a})) = t(a) = U(f_1)(x_1)$. Thus $x_1$ and
$t(\widetilde{a})$ define an element
$$
(x_1, t(\widetilde{a})) \in U(A_1) \times_{U(A)} U(A_2).
$$
By the assumption that $U$ satisfies (RS), we have an identification
$U(A_1) \times_{U(A)} U(A_2) = U(A_1 \times_A A_2)$. Let us denote
$x_1 \times t(\widetilde{a}) \in U(A_1 \times_A A_2)$ the element
corresponding to $(x_1, t(\widetilde{a})) \in U(A_1) \times_{U(A)} U(A_2)$.
Let $p_1, p_2$ be the projections of $A_1 \times_A A_2$.  We claim
$$
\xymatrix{
(A_1 \times_A A_2, x_1 \times t(\widetilde{a})) \ar[d]_{(p_1, e(x_1))}
\ar[rr]_-{(p_2, i(\widetilde{a}))} & & (A_2, x_2) \ar[d]^{(f_2, a_2)} \\
(A_1, x_1) \ar[rr]^{(f_1, a_1)} & & (A, x)
}
$$
is a fiber square in $[U/R]$. (Note $e: U \to R$ denotes the identity.)

\medskip\noindent
The diagram is commutative because
$c(a_2, R(f_2)(i(\widetilde{a}))) = c(a_2, i(a)) = a_1$.
To check it is a fiber square, let
$$
\xymatrix{
(B, z) \ar[d]_{(g_1, b_1)} \ar[rr]_{(g_2, b_2)} & & (A_2, x_2)
\ar[d]^{(f_2, a_2)} \\
(A_1, x_1) \ar[rr]^{(f_1, a_1)} & & (A, x)
}
$$
be a commutative diagram in $[U/R]$. We will show there is a unique morphism
$(g, b) : (B, z) \to (A_1 \times_A A_2, x_1 \times t(\widetilde{a}))$
compatible with the morphisms to $(A_1, x_1)$ and $(A_2, x_2)$.
We must take $g = (g_1, g_2) : B \to A_1 \times_A A_2$.
Since by assumption $R$ satisfies (RS), we have an identification
$R(A_1 \times_A A_2) = R(A_1) \times_{R(A)} R(A_2)$.
Hence we can write $b = (b'_1, b'_2)$ for some
$b'_1 \in R(A_1)$, $b'_2 \in R(A_2)$ which agree in $R(A)$.
Then
$((g_1, g_2), (b'_1, b'_2)) : (B, z) \to
(A_1 \times_A A_2, x_1 \times t(\widetilde{a}))$
will commute with the projections if and only if
$b'_1 = b_1$ and $b'_2 = c(\widetilde{a}, b_2)$ proving unicity and
existence.
\end{proof}

\begin{lemma}
\label{lemma-deformation-groupoid-quotient}
Let $(U, R, s, t, c)$ be a smooth groupoid in functors on $\mathcal{C}_\Lambda$.
Assume $U$ and $R$ are deformation functors. Then:
\begin{enumerate}
\item The quotient $[U/R]$ is a deformation category.
\item The tangent space of $[U/R]$ is
$$
T[U/R] = \Coker(ds-dt: TR \to TU).
$$
\item The space of infinitesimal automorphisms of $[U/R]$ is
$$
\text{Inf}([U/R]) =
\Ker(ds \oplus dt : TR \to TU \oplus TU).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Since $U$ and $R$ are deformation functors $[U/R]$ is a predeformation
category. Since (RS) holds for deformation functors by
definition we see that (RS) holds for [U/R] by
Lemma \ref{lemma-smooth-RS-groupoid-in-functors-quotient}.
Hence $[U/R]$ is a deformation category. Statements (2) and (3)
follow directly from the definitions.
\end{proof}







\section{Presentations of categories cofibered in groupoids}
\label{section-presentation-categories-cofibred-in-groupoids}

\noindent
A presentation is defined as follows.

\begin{definition}
\label{definition-presentation}
Let $\mathcal{F}$ be a category cofibered in groupoids over a category
$\mathcal{C}$. Let $(U, R, s, t, c)$ be a groupoid in functors on
$\mathcal{C}$. A
{\it presentation of $\mathcal{F}$ by $(U, R, s, t, c)$} is an equivalence
$\varphi : [U/R] \to \mathcal{F}$ of categories cofibered in groupoids
over $\mathcal{C}$.
\end{definition}

\noindent
The following two general lemmas will be used to get presentations.

\begin{lemma}
\label{lemma-presentation-construction}
Let $\mathcal{F}$ be category cofibered in groupoids over a category
$\mathcal{C}$. Let $U : \mathcal{C} \to \textit{Sets}$ be a functor.
Let $f : U \to \mathcal{F}$ be a morphism of categories cofibered in groupoids
over $\mathcal{C}$. Define $R, s, t, c$ as follows:
\begin{enumerate}
\item $R : \mathcal{C} \to \textit{Sets}$ is the functor
$U \times_{f, \mathcal{F}, f} U$.
\item $t, s : R \to U$ are the first and second projections,
respectively.
\item $c : R \times_{s, U, t} R \to R$ is the morphism given by projection
onto the first and last factors of
$U \times_{f, \mathcal{F}, f} U \times_{f, \mathcal{F}, f} U$
under the canonical isomorphism
$R \times_{s, U, t} R \to
U \times_{f, \mathcal{F}, f} U \times_{f, \mathcal{F}, f} U$.
\end{enumerate}
Then $(U, R, s, t, c)$ is a groupoid in functors on $\mathcal{C}$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-presentation-morphism}
Let $\mathcal{F}$ be category cofibered in groupoids over a category
$\mathcal{C}$. Let $U : \mathcal{C} \to \textit{Sets}$ be a functor.
Let $f : U \to \mathcal{F}$ be a morphism of categories cofibered in groupoids
over $\mathcal{C}$. Let $(U, R, s, t, c)$ be the groupoid in functors on
$\mathcal{C}$ constructed from $f : U \to \mathcal{F}$ in
Lemma \ref{lemma-presentation-construction}.
Then there is a natural morphism $[f] : [U/R] \to \mathcal{F}$ such that:
\begin{enumerate}
\item $[f]: [U/R] \to \mathcal{F}$ is fully faithful.
\item $[f]: [U/R] \to \mathcal{F}$ is an equivalence if and only if
$f : U \to \mathcal{F}$ is essentially surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}







\section{Presentations of deformation categories}
\label{section-presentation-deformation-categories}

\noindent
According to the next lemma, a smooth morphism from a predeformation functor to
a predeformation category $\mathcal{F}$ gives rise to a presentation of
$\mathcal{F}$ by a smooth groupoid in functors.

\begin{lemma}
\label{lemma-smooth-groupoid-in-functors-construction}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Let $U : \mathcal{C}_\Lambda \to \textit{Sets}$
be a functor. Let $f : U \to \mathcal{F}$ be a smooth morphism of
categories cofibered in groupoids. Then:
\begin{enumerate}
\item If $(U, R, s, t, c)$ is the groupoid in functors on
$\mathcal{C}_\Lambda$ constructed from $f : U \to \mathcal{F}$ in
Lemma \ref{lemma-presentation-construction}, then $(U, R, s, t, c)$
is smooth.
\item If $f : U(k) \to \mathcal{F}(k)$ is essentially surjective,
then the morphism $[f] : [U/R] \to \mathcal{F}$ of
Lemma \ref{lemma-presentation-morphism}
is an equivalence.
\end{enumerate}
\end{lemma}

\begin{proof}
From the construction of
Lemma \ref{lemma-presentation-construction}
we have a commutative diagram
$$
\xymatrix{
R = U \times_{f, \mathcal{F}, f} U \ar[r]_-s \ar[d]_t & U
\ar[d]^f \\
U \ar[r]^f & \mathcal{F}
}
$$
where $t, s$ are the first and second projections.  So $t, s$ are smooth by
Lemma \ref{lemma-smooth-properties}.  Hence (1) holds.

\medskip\noindent
If the assumption of (2) holds, then by
Lemma \ref{lemma-smooth-morphism-essentially-surjective}
the morphism $f : U \to \mathcal{F}$ is essentially surjective. Hence by
Lemma \ref{lemma-presentation-morphism}
the morphism $[f] : [U/R] \to \mathcal{F}$ is an equivalence.
\end{proof}

\begin{lemma}
\label{lemma-deformation-functor-diagonal}
Let $\mathcal{F}$ be a deformation category.
Let $U : \mathcal{C}_\Lambda \to \textit{Sets}$ be a deformation functor.
Let $f: U \to \mathcal{F}$ be a morphism of categories cofibered in groupoids.
Then $U \times_{f, \mathcal{F}, f} U$ is a deformation functor
with tangent space fitting into an exact sequence of $k$-vector spaces
$$
0 \to \text{Inf}(\mathcal{F}) \to
T(U \times_{f, \mathcal{F}, f} U) \to TU \oplus TU
$$
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-deformation-categories-fiber-product-morphisms}
and the fact that $\text{Inf}(U) = (0)$.
\end{proof}

\begin{lemma}
\label{lemma-prorepresentable-groupoid-in-functors-construction}
Let $\mathcal{F}$ be a deformation category.
Let $U : \mathcal{C}_\Lambda \to \textit{Sets}$ be a prorepresentable functor.
Let $f : U \to \mathcal{F}$ be a morphism of categories cofibered in groupoids.
Let $(U, R, s, t, c)$ be the groupoid in functors on $\mathcal{C}_\Lambda$
constructed from $f : U \to \mathcal{F}$ in
Lemma \ref{lemma-presentation-construction}. If
$\dim_k \text{Inf}(\mathcal{F}) < \infty$, then
$(U, R, s, t, c)$ is prorepresentable.
\end{lemma}

\begin{proof}
Note that $U$ is a deformation functor by
Example \ref{example-prorepresentable-deformation-functor}.
By
Lemma \ref{lemma-deformation-functor-diagonal}
we see that $R = U \times_{f, \mathcal{F}, f} U$
is a deformation functor whose tangent space
$TR = T(U \times_{f, \mathcal{F}, f} U)$ sits in an exact sequence
$0 \to \text{Inf}(\mathcal{F}) \to TR \to TU \oplus TU$.
Since we have assumed the first space has finite dimension and since
$TU$ has finite dimension by
Example \ref{example-tangent-space-prorepresentable-functor}
we see that $\dim TR < \infty$. The map
$\gamma : \text{Der}_\Lambda(k, k) \to TR$ see (\ref{equation-map})
is injective because its composition with $TR \to TU$ is injective by
Theorem \ref{theorem-Schlessinger-prorepresentability}
for the prorepresentable functor $U$. Thus $R$ is prorepresentable by
Theorem \ref{theorem-Schlessinger-prorepresentability}.
It follows from
Lemma \ref{lemma-groupoid-in-functors-prorep-equivalences}
that $(U, R, s, t, c)$ is prorepresentable.
\end{proof}

\begin{theorem}
\label{theorem-presentation-deformation-groupoid}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Then $\mathcal{F}$ admits a presentation by a
smooth prorepresentable groupoid in functors on $\mathcal{C}_\Lambda$
if and only if the following conditions hold:
\begin{enumerate}
\item $\mathcal{F}$ is a deformation category.
\item $\dim_k T\mathcal{F}$ is finite.
\item $\dim_k \text{Inf}(\mathcal{F})$ is finite.
\end{enumerate}
\end{theorem}

\begin{proof}
Recall that a prorepresentable functor is a deformation functor, see
Example \ref{example-prorepresentable-deformation-functor}. Thus
if $\mathcal{F}$ is equivalent to a smooth prorepresentable groupoid in
functors, then conditions (1), (2), and (3) follow from
Lemma \ref{lemma-deformation-groupoid-quotient} (1), (2), and (3).

\medskip\noindent
Conversely, assume conditions (1), (2), and (3) hold. Condition (1)
implies that (S1) and (S2) are satisfied, see
Lemma \ref{lemma-RS-implies-S1-S2}.
By
Lemma \ref{lemma-versal-object-existence}
there exists a versal formal object $\xi$. Setting
$U = \underline{R}|_{\mathcal{C}_\Lambda}$ the
associated map $\underline{\xi} : U \to \mathcal{F}$ is smooth (this is
the definition of a versal formal object).
Let $(U, R, s, t, c)$ be the groupoid in functors constructed in
Lemma \ref{lemma-presentation-construction}
from the map $\underline{\xi}$. By
Lemma \ref{lemma-smooth-groupoid-in-functors-construction}
we see that $(U, R, s, t, c)$ is a smooth groupoid in functors and that
$[U/R] \to \mathcal{F}$ is an equivalence. By
Lemma \ref{lemma-prorepresentable-groupoid-in-functors-construction}
we see that $(U, R, s, t, c)$ is prorepresentable.
Hence $[U/R] \to \mathcal{F}$ is the desired presentation of $\mathcal{F}$.
\end{proof}








\section{Remarks regarding minimality}
\label{section-minimality}

\noindent
The main theorem of this chapter is
Theorem \ref{theorem-presentation-deformation-groupoid}
above. It describes completely those categories cofibred in groupoids
over $\mathcal{C}_\Lambda$ which have a presentation by a
smooth prorepresentable groupoid in functors. In this section we briefly
discuss how the minimality discussed in
Sections \ref{section-minimal-versal} and
\ref{section-miniversal-objects-existence}
can be used to obtain a ``minimal'' smooth prorepresentable presentation.

\begin{definition}
\label{definition-minimal-groupoid-in-functors}
Let $(U, R, s, t, c)$ be a smooth prorepresentable groupoid in functors
on $\mathcal{C}_\Lambda$.
\begin{enumerate}
\item We say $(U, R, s, t, c)$ is {\it normalized} if the groupoid
$(U(k[\epsilon]), R(k[\epsilon]), s, t, c)$ is totally disconnected,
i.e., there are no morphisms between distinct objects.
\item We say $(U, R, s, t, c)$ is {\it minimal} if the $U \to [U/R]$
is given by a minimal versal formal object of $[U/R]$.
\end{enumerate}
\end{definition}

\noindent
The difference between the two notions is related to the difference between
conditions (\ref{equation-bijective}) and (\ref{equation-bijective-orbits})
and disappears when $k' \subset k$ is separable. Also a
normalized smooth prorepresentable groupoid in functors is minimal
as the following lemma shows. Here is a precise statement.

\begin{lemma}
\label{lemma-characterize-minimal-groupoid-in-functors}
Let $(U, R, s, t, c)$ be a smooth prorepresentable groupoid in
functors on $\mathcal{C}_\Lambda$.
\begin{enumerate}
\item $(U, R, s, t, c)$ is normalized if and only if the morphism
$U \to [U/R]$ induces an isomorphism on tangent spaces, and
\item $(U, R, s, t, c)$ is minimal if and only if the kernel of
$TU \to T[U/R]$ is contained in the image of
$\text{Der}_\Lambda(k, k) \to TU$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows immediately from the definitions.
To see part (2) set $\mathcal{F} = [U/R]$. Since $\mathcal{F}$
has a presentation it is a deformation category, see
Theorem \ref{theorem-presentation-deformation-groupoid}.
In particular it satisfies (RS), (S1), and (S2), see
Lemma \ref{lemma-RS-implies-S1-S2}.
Recall that minimal versal formal objects are unique up to isomorphism, see
Lemma \ref{lemma-minimal-versal}.
By
Theorem \ref{theorem-miniversal-object-existence}
a minimal versal object induces a map
$\underline{\xi} : \underline{R}|_{\mathcal{C}_\Lambda} \to \mathcal{F}$
satisfying (\ref{equation-bijective-orbits}). Since
$U \cong \underline{R}|_{\mathcal{C}_\Lambda}$ over $\mathcal{F}$
we see that $TU \to T\mathcal{F} = T[U/R]$ satisfies the property
as stated in the lemma.
\end{proof}

\noindent
The quotient of a minimal prorepresentable groupoid in functors on $\mathcal
C_\Lambda$ does not admit autoequivalences which are not automorphisms.  To
prove this, we first note the following lemma.

\begin{lemma}
\label{lemma-surjective-morphism-prorepresentable-functor}
Let $U: \mathcal{C}_\Lambda \to \textit{Sets}$ be a
prorepresentable functor. Let $\varphi : U \to U$ be a morphism such
that $d\varphi : TU \to TU$ is an isomorphism.  Then $\varphi$ is an
isomorphism.
\end{lemma}

\begin{proof}
If $U \cong \underline{R}|_{\mathcal{C}_\Lambda}$ for some
$R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$,
then completing $\varphi$ gives a morphism $\underline{R} \to \underline{R}$.
If $f: R \to R$ is the corresponding morphism in
$\widehat{\mathcal{C}}_\Lambda$, then $f$ induces an isomorphism
$\text{Der}_\Lambda(R, k) \to \text{Der}_\Lambda(R, k)$, see
Example \ref{example-tangent-space-map-prorepresentable-functor}.
In particular $f$ is a surjection by
Lemma \ref{lemma-derivations-surjective}.
As a surjective endomorphism of a Noetherian ring is an isomorphism (see
Algebra, Lemma \ref{algebra-lemma-surjective-endo-noetherian-ring-is-iso})
we conclude $f$, hence $\underline{R}
\to \underline{R}$, hence $\varphi : U \to U$
is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-minimal-prorepresentable-groupoid-autoequivalence}
Let $(U, R, s, t, c)$ be a minimal smooth prorepresentable groupoid in
functors on $\mathcal{C}_\Lambda$. If $\varphi : [U/R] \to [U/R]$ is an
equivalence of categories cofibered in groupoids, then $\varphi$ is an
isomorphism.
\end{lemma}

\begin{proof}
A morphism $\varphi : [U/R] \to [U/R]$ is the same thing as a
morphism $\varphi : (U, R, s, t, c) \to (U, R, s, t, c)$ of
groupoids in functors over $\mathcal{C}_\Lambda$ as defined in
Definition \ref{definition-groupoid-in-functors}.
Denote $\phi : U \to U$ and $\psi : R \to R$ the corresponding morphisms.
Because the diagram
$$
\xymatrix{
& \text{Der}_\Lambda(k, k) \ar[dr]_\gamma \ar[dl]^\gamma \\
TU \ar[rr]_{d\phi} \ar[d] & & TU \ar[d]  \\
T[U/R] \ar[rr]^{d\varphi} & & T[U/R]
}
$$
is commutative, since $d\varphi$ is bijective, and since we have
the characterization of minimality in
Lemma \ref{lemma-characterize-minimal-groupoid-in-functors}
we conclude that $d\phi$ is injective (hence bijective by dimension reasons).
Thus $\phi : U \to U$ is an isomorphism by
Lemma \ref{lemma-surjective-morphism-prorepresentable-functor}.
We can use a similar argument, using the exact sequence
$$
0 \to \text{Inf}([U/R]) \to TR \to TU \oplus TU
$$
of
Lemma \ref{lemma-deformation-functor-diagonal}
to prove that $\psi : R \to R$ is an isomorphism. But is also a consequence
of the fact that $R = U \times_{[U/R]} U$ and that $\varphi$ and $\phi$
are isomorphisms.
\end{proof}

\begin{lemma}
\label{lemma-minimal-prorepresentable-groupoid-equivalence}
Let $(U, R, s, t, c)$ and $(U', R', s', t', c')$ be minimal smooth
prorepresentable groupoids in functors on $\mathcal{C}_\Lambda$. If
$\varphi : [U/R] \to [U'/R']$ is an equivalence of categories cofibered
in groupoids, then $\varphi$ is an isomorphism.
\end{lemma}

\begin{proof}
Let $\psi : [U'/R'] \to [U/R]$ be a quasi-inverse to $\varphi$.
Then $\psi \circ \varphi$ and $\varphi \circ \psi$ are isomorphisms by
Lemma \ref{lemma-minimal-prorepresentable-groupoid-autoequivalence},
hence $\varphi$ and $\psi$ are isomorphisms.
\end{proof}

\noindent
The following lemma summarizes some of the things we have seen earlier
in this chapter.

\begin{lemma}
\label{lemma-minimal-groupoid-in-functors-construction}
Let $\mathcal{F}$ be a deformation category such that
$\dim_k T\mathcal{F} <\infty$ and
$\dim_k \text{Inf}(\mathcal{F}) < \infty$.
Then there exists a minimal versal formal object $\xi$ of $\mathcal{F}$.
Say $\xi$ lies over $R \in \Ob(\widehat{\mathcal{C}}_\Lambda)$.
Let $U = \underline{R}|_{\mathcal{C}_\Lambda}$.
Let $f = \underline{\xi} : U \to \mathcal{F}$ be the associated
morphism. Let $(U, R, s, t, c)$ be the groupoid in functors on
$\mathcal{C}_\Lambda$ constructed from $f : U \to \mathcal{F}$ in
Lemma \ref{lemma-presentation-construction}.
Then $(U, R, s, t, c)$ is a minimal smooth prorepresentable
groupoid in functors on $\mathcal{C}_\Lambda$ and there
is an equivalence $[U/R] \to \mathcal{F}$.
\end{lemma}

\begin{proof}
As $\mathcal{F}$ is a deformation category it satisfies (S1) and (S2), see
Lemma \ref{lemma-RS-implies-S1-S2}.
By
Lemma \ref{lemma-versal-object-existence}
there exists a versal formal object. By
Lemma \ref{lemma-minimal-versal}
there exists a minimal versal formal object $\xi/R$ as in the statement
of the lemma. Setting
$U = \underline{R}|_{\mathcal{C}_\Lambda}$ the
associated map $\underline{\xi} : U \to \mathcal{F}$ is smooth (this is
the definition of a versal formal object).
Let $(U, R, s, t, c)$ be the groupoid in functors constructed in
Lemma \ref{lemma-presentation-construction}
from the map $\underline{\xi}$. By
Lemma \ref{lemma-smooth-groupoid-in-functors-construction}
we see that $(U, R, s, t, c)$ is a smooth groupoid in functors and that
$[U/R] \to \mathcal{F}$ is an equivalence. By
Lemma \ref{lemma-prorepresentable-groupoid-in-functors-construction}
we see that $(U, R, s, t, c)$ is prorepresentable.
Finally, $(U, R, s, t, c)$ is minimal because $U \to [U/R] = \mathcal{F}$
corresponds to the minimal versal formal object $\xi$.
\end{proof}

\noindent
Presentations by minimal prorepresentable groupoids in functors satisfy the
following uniqueness property.

\begin{lemma}
\label{lemma-minimal-presentations-equivalent}
Let $\mathcal{F}$ be category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Assume there exist presentations of
$\mathcal{F}$ by minimal smooth prorepresentable groupoids
in functors $(U, R, s, t, c)$ and $(U', R', s', t', c')$.
Then $(U, R, s, t, c)$ and $(U', R', s', t', c')$ are isomorphic.
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-minimal-prorepresentable-groupoid-equivalence}
and the observation that a morphism
$[U/R] \to [U'/R']$ is the same thing as a morphism
of groupoids in functors (by our explicit construction of $[U/R]$ in
Definition \ref{definition-quotient}).
\end{proof}

\noindent
In summary we have proved the following theorem.

\begin{theorem}
\label{theorem-minimal-smooth-prorepresentable-presentations}
Let $\mathcal{F}$ be a category cofibered in groupoids over
$\mathcal{C}_\Lambda$. Consider the following conditions
\begin{enumerate}
\item $\mathcal{F}$ admits a presentation by a normalized
smooth prorepresentable groupoid in functors on $\mathcal{C}_\Lambda$,
\item $\mathcal{F}$ admits a presentation by a
smooth prorepresentable groupoid in functors on $\mathcal{C}_\Lambda$,
\item $\mathcal{F}$ admits a presentation by a minimal
smooth prorepresentable groupoid in functors on $\mathcal{C}_\Lambda$, and
\item $\mathcal{F}$ satisfies the following conditions
\begin{enumerate}
\item $\mathcal{F}$ is a deformation category.
\item $\dim_k T\mathcal{F}$ is finite.
\item $\dim_k \text{Inf}(\mathcal{F})$ is finite.
\end{enumerate}
\end{enumerate}
Then (2), (3), (4) are equivalent and are implied by (1).
If $k' \subset k$ is separable, then (1), (2), (3), (4) are all equivalent.
Furthermore, the minimal smooth prorepresentable groupoids in functors
which provide a presentation of $\mathcal{F}$ are unique up to isomorphism.
\end{theorem}

\begin{proof}
We see that (1) implies (3) and is equivalent to (3) if
$k' \subset k$ is separable from
Lemma \ref{lemma-characterize-minimal-groupoid-in-functors}.
It is clear that (3) implies (2). We see that (2) implies (4) by
Theorem \ref{theorem-presentation-deformation-groupoid}.
We see that (4) implies (3) by
Lemma \ref{lemma-minimal-groupoid-in-functors-construction}.
This proves all the implications.
The final uniqueness statement follows from
Lemma \ref{lemma-minimal-presentations-equivalent}.
\end{proof}








\section{Uniqueness of versal rings}
\label{section-uniqueness}

\noindent
Given $R, S$ in $\widehat{\mathcal{C}}_\Lambda$ we say maps
$f, g : R \to S$ are {\it formally homotopic} if there exists an
$r \geq 0$ and maps $h : R \to R[[t_1, \ldots, t_r]]$ and
$k : R[[t_1, \ldots, t_r]] \to S$ in $\widehat{\mathcal{C}}_\Lambda$
such that for all $a \in R$ we have
\begin{enumerate}
\item $h(a) \bmod (t_1, \ldots, t_r) = a$,
\item $f(a) = k(a)$,
\item $g(a) = k(h(a))$.
\end{enumerate}
We will say $(r, h, k)$ is a {\it formal homotopy} between $f$ and $g$.

\begin{lemma}
\label{lemma-homotopy}
Being formally homotopic is an equivalence relation on
sets of morphisms in $\widehat{\mathcal{C}}_\Lambda$.
\end{lemma}

\begin{proof}
Suppose we have any $r \geq 1$ and two maps
$h_1, h_2 : R \to R[[t_1, \ldots, t_r]]$ such that
$h_1(a) \bmod (t_1, \ldots, t_r) =  h_2(a) \bmod (t_1, \ldots, t_r) = a$
for all $a \in R$ and a map $k : R[[t_1, \ldots, t_r]] \to S$.
Then we claim $k \circ h_1$ is formally homotopic to $k \circ h_2$.
The symmetric inherent in this claim will show that our notion
of formally homotopic is symmetric. Namely, the map
$$
\Psi :
R[[t_1, \ldots, t_r]]
\longrightarrow
R[[t_1, \ldots, t_r]],\quad
\sum a_I t^I \longmapsto \sum h_1(a_I)t^I
$$
is an isomorphism. Set $h(a) = \Psi^{-1}(h_2(a))$ for $a \in R$ and
$k' = k \circ \Psi$, then we see that $(r, h, k')$ is a formal
homotopy between $k \circ h_1$ and $k \circ h_2$, proving the claim

\medskip\noindent
Say we have three maps $f_1, f_2, f_3 : R \to S$ as above
and a formal homotopy $(r_1, h_1, k_1)$ between $f_1$ and $f_2$
and a formal homotopy $(r_2, h_2, k_2)$ between $f_3$ and $f_2$ (!).
After relabeling the coordinates we may assume
$h_2 : R \to R[[t_{r_1 + 1}, \ldots, t_{r_1 + r_2}]]$
and
$k_2 : R[[t_{r_1 + 1}, \ldots, t_{r_1 + r_2}]] \to S$.
By choosing a suitable isomorphism
$$
R[[t_1, \ldots, t_{r_1 + r_2}]]
\longrightarrow
R[[t_{r_1 + 1}, \ldots, t_{r_1 + r_2}]]
\widehat{\otimes}_{h_2, R, h_1}
R[[t_1, \ldots, t_{r_1}]]
$$
we may fit these maps into a commutative diagram
$$
\xymatrix{
R \ar[r]_{h_1} \ar[d]^{h_2} &
R[[t_1, \ldots, t_{r_1}]] \ar[d]^{h_2'} \\
R[[t_{r_1 + 1}, \ldots, t_{r_1 + r_2}]] \ar[r]^{h_1'} &
R[[t_1, \ldots, t_{r_1 + r_2}]]
}
$$
with $h_2'(t_i) = t_i$ for $1 \leq i \leq r_1$ and
$h_1'(t_i) = t_i$ for $r_1 + 1 \leq i \leq r_2$.
Some details omitted.
Since this diagram is a pushout in the category
$\widehat{\mathcal{C}}_\Lambda$ (see proof of
Lemma \ref{lemma-CLambdahat-pushouts})
and since $k_1 \circ h_1 = f_2 = k_2 \circ h_2$ we conclude
there exists a map
$$
k : R[[t_1, \ldots, t_{r_1 + r_2}]] \to S
$$
with $k_1 = k \circ h_2'$ and $k_2 = k \circ h_1'$.
Denote $h = h_1' \circ h_2 = h_2' \circ h_1$.
Then we have
\begin{enumerate}
\item $k(h_1'(a)) = k_2(a) = f_3(a)$, and
\item $k(h_2'(a)) = k_1(a) = f_1(a)$.
\end{enumerate}
By the claim in the first paragraph of the proof this shows that
$f_1$ and $f_3$ are formally homotopic.
\end{proof}

\begin{lemma}
\label{lemma-composition-homotopic}
In the category $\widehat{\mathcal{C}}_\Lambda$, if $f_1, f_2 : R \to S$
are formally homotopic and $g : S \to S'$ is a morphism, then
$g \circ f_1$ and $g \circ f_2$ are formally homotopic.
\end{lemma}

\begin{proof}
Namely, if $(r, h, k)$ is a formal homotopy between $f_1$ and $f_2$, then
$(r, h, g \circ k)$ is a formal homotopy between $g \circ f_1$ and
$g \circ f_2$.
\end{proof}

\begin{lemma}
\label{lemma-versal-unique-up-to-homotopy}
Let $\mathcal{F}$ be a deformation category over $\mathcal{C}_\Lambda$
with $\dim_k T\mathcal{F} < \infty$ and
$\dim_k \text{Inf}(\mathcal{F}) < \infty$. Let $\xi$ be a versal formal
object lying over $R$. Let $\eta$ be a formal object lying over $S$.
Then any two maps
$$
f, g : R \to S
$$
such that $f_*\xi \cong \eta \cong g_*\xi$ are formally homotopic.
\end{lemma}

\begin{proof}
By Theorem \ref{theorem-presentation-deformation-groupoid}
and its proof, $\mathcal{F}$ has a presentation by
a smooth prorepresentable groupoid
$$
(\underline{R}, \underline{R_1}, s, t, c, e, i)|_{\mathcal{C}_\Lambda}
$$
in functors on $\mathcal{C}_\lambda$ such that $\mathcal{F}$.
Then the maps $s : R \to R_1$ and $t : R \to R_1$ are formally
smooth ring maps and $e : R_1 \to R$ is a section.
In particular, we can choose an isomorphism
$R_1 = R[[t_1, \ldots, t_r]]$ for some $r \geq 0$ such
that $s$ is the embedding $R \subset R[[t_1, \ldots, t_r]]$
and $t$ corresponds to a map $h : R \to R[[t_1, \ldots, t_r]]$
with $h(a) \bmod (t_1, \ldots, t_r) = a$ for all $a \in R$.
The existence of the isomorphism $\alpha : f_*\xi \to g_*\xi$
means exactly that there is a map $k : R_1 \to S$
such that $f = k \circ s$ and $g = k \circ t$.
This exactly means that $(r, h, k)$ is a formal homotopy between
$f$ and $g$.
\end{proof}

\begin{lemma}
\label{lemma-homotopic-minimal-prime}
In the category $\widehat{\mathcal{C}}_\Lambda$, if $f_1, f_2 : R \to S$
are formally homotopic and $\mathfrak p \subset R$ is a minimal
prime ideal, then $f_1(\mathfrak p)S = f_2(\mathfrak p)S$ as ideals.
\end{lemma}

\begin{proof}
Suppose $(r, h, k)$ is a formal homotopy between $f_1$ and $f_2$.
We claim that
$\mathfrak pR[[t_1, \ldots, t_r]] = h(\mathfrak p)R[[t_1, \ldots, t_r]]$.
The claim implies the lemma by further composing with $k$.
To prove the claim, observe that the map
$\mathfrak p \mapsto \mathfrak pR[[t_1, \ldots, t_r]]$
is a bijection between the minimal prime ideals of $R$ and the
minimal prime ideals of $R[[t_1, \ldots, t_r]]$.
Finally, $h(\mathfrak p)R[[t_1, \ldots, t_r]]$ is a minimal
prime as $h$ is flat, and hence of the form
$\mathfrak q R[[t_1, \ldots, t_r]]$ for some minimal
prime $\mathfrak q \subset R$ by what we just said.
But since $h \bmod (t_1, \ldots, t_r) = \text{id}_R$ by
definition of a formal homotopy, we conclude that
$\mathfrak q = \mathfrak p$ as desired.
\end{proof}











\section{Change of residue field}
\label{section-change-of-field}

\noindent
In this section we quickly discuss what happens if we replace the residue
field $k$ by a finite extension. Let $\Lambda$ be a Noetherian ring and
let $\Lambda \to k$ be a finite ring map where $k$ is a field. Throughout
this whole chapter we have used $\mathcal{C}_\Lambda$ to denote the
category of Artinian local $\Lambda$-algebras whose residue field is
identified with $k$, see Definition \ref{definition-CLambda}.
However, since in this section we will discuss what happen when we change
$k$ we will instead use the notation $\mathcal{C}_{\Lambda, k}$ to
indicate the dependence on $k$.

\begin{situation}
\label{situation-change-of-fields}
Let $\Lambda$ be a Noetherian ring and let $\Lambda \to k \to l$ be a finite
ring maps where $k$ and $l$ are fields. Thus $l/k$ is a finite
extensions of fields. A typical object of $\mathcal{C}_{\Lambda, l}$ will be
denoted $B$ and a typical object of $\mathcal{C}_{\Lambda, k}$ will be
denoted $A$. We define
\begin{equation}
\label{equation-comparison}
\mathcal{C}_{\Lambda, l} \longrightarrow \mathcal{C}_{\Lambda, k},
\quad
B \longmapsto B \times_l k
\end{equation}
Given a category cofibred in groupoids
$p : \mathcal{F} \to \mathcal{C}_{\Lambda, k}$ we obtain
an associated category cofibred in groupoids
$$
p_{l/k} : \mathcal{F}_{l/k} \longrightarrow \mathcal{C}_{\Lambda, l}
$$
by setting $\mathcal{F}_{l/k}(B) = \mathcal{F}(B \times_l k)$.
\end{situation}

\noindent
The functor (\ref{equation-comparison}) makes sense:
because $B \times_l k \subset B$ we have
\begin{align*}
[k : k']\ \text{length}_{B \times_l k}(B \times_l k) & =
\text{length}_\Lambda(B \times_l k) \\
& \leq \text{length}_\Lambda(B) \\
& = [l : k']\ \text{length}_B(B) < \infty
\end{align*}
(see Lemma \ref{lemma-length}) hence $B \times_l k$ is Artinian
(see Algebra, Lemma \ref{algebra-lemma-artinian-finite-length}).
Thus $B \times_l k$ is an Artinian local ring with
residue field $k$. Note that (\ref{equation-comparison})
commutes with fibre products
$$
(B_1 \times_B B_2) \times_l k =
(B_1 \times_l k) \times_{(B \times_l k)} (B_2 \times_l k)
$$
and transforms surjective ring maps into surjective ring maps.
We use the ``expensive'' notation $\mathcal{F}_{l/k}$ to prevent confusion
with the construction of Remark \ref{remark-localize-cofibered-groupoid}.
Here are some elementary observations.

\begin{lemma}
\label{lemma-elementary-properties-change-of-field}
With notation and assumptions as in Situation \ref{situation-change-of-fields}.
\begin{enumerate}
\item We have $\overline{\mathcal{F}_{l/k}} = (\overline{\mathcal{F}})_{l/k}$.
\item If $\mathcal{F}$ is a predeformation category, then $\mathcal{F}_{l/k}$
is a predeformation category.
\item If $\mathcal{F}$ satisfies (S1), then $\mathcal{F}_{l/k}$
satisfies (S1).
\item If $\mathcal{F}$ satisfies (S2), then $\mathcal{F}_{l/k}$
satisfies (S2).
\item If $\mathcal{F}$ satisfies (RS), then $\mathcal{F}_{l/k}$
satisfies (RS).
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is immediate from the definitions.

\medskip\noindent
Since $\mathcal{F}_{l/k}(l) = \mathcal{F}(k)$ part (2) follows from the
definition, see Definition \ref{definition-predeformation-category}.

\medskip\noindent
Part (3) follows as the functor (\ref{equation-comparison}) commutes with
fibre products and transforms surjective maps into surjective maps, see
Definition \ref{definition-S1-S2}.

\medskip\noindent
Part (4). To see this consider a diagram
$$
\xymatrix{
          & l[\epsilon] \ar[d] \\
B  \ar[r] & l
}
$$
in $\mathcal{C}_{\Lambda, l}$ as in Definition \ref{definition-S1-S2}.
Applying the functor (\ref{equation-comparison}) we obtain
$$
\xymatrix{
          & k[l\epsilon] \ar[d] \\
B \times_l k  \ar[r] & k
}
$$
where $l\epsilon$ denotes the finite dimensional $k$-vector space
$l\epsilon \subset l[\epsilon]$. According to Lemma \ref{lemma-S2-extensions}
the condition of (S2) for $\mathcal{F}$ also holds for this diagram.
Hence (S2) holds for $\mathcal{F}_{l/k}$.

\medskip\noindent
Part (5) follows from the characterization of (RS) in
Lemma \ref{lemma-RS-2-categorical} part (2) and the fact that
(\ref{equation-comparison}) commutes with fibre products.
\end{proof}

\noindent
The following lemma applies in particular when $\mathcal{F}$
satisfies (S2) and is a predeformation category, see
Lemma \ref{lemma-S1-S2-associated-functor}.

\begin{lemma}
\label{lemma-tangent-space-change-of-field}
With notation and assumptions as in Situation \ref{situation-change-of-fields}.
Assume $\mathcal{F}$ is a predeformation category and
$\overline{\mathcal{F}}$ satisfies (S2). Then there is a
canonical $l$-vector space isomorphism
$$
T\mathcal{F} \otimes_k l \longrightarrow T\mathcal{F}_{l/k}
$$
of tangent spaces.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-elementary-properties-change-of-field} we may replace
$\mathcal{F}$ by $\overline{\mathcal{F}}$. Moreover we see that
$T\mathcal{F}$, resp.\ $T\mathcal{F}_{l/k}$ has a canonical
$k$-vector space structure, resp.\ $l$-vector space structure, see
Lemma \ref{lemma-tangent-space-vector-space}. Then
$$
T\mathcal{F}_{l/k} = \mathcal{F}_{l/k}(l[\epsilon])
= \mathcal{F}(k[l\epsilon]) = T\mathcal{F} \otimes_k l
$$
the last equality by Lemma \ref{lemma-tangent-space-vector-space}.
More generally, given a finite dimensional $l$-vector space $V$ we have
$$
\mathcal{F}_{l/k}(l[V]) = \mathcal{F}(k[V_k]) = T\mathcal{F} \otimes_k V_k
$$
where $V_k$ denotes $V$ seen as a $k$-vector space. We conclude that
the functors $V \mapsto \mathcal{F}_{l/k}(l[V])$ and
$V \mapsto T\mathcal{F} \otimes_k V_k$ are canonically identified
as functors to the category of sets. By Lemma \ref{lemma-linear-functor}
we see there is at most one way to turn either functor into an $l$-linear
functor. Hence the isomorphisms are compatible with the $l$-vector space
structures and we win.
\end{proof}

\begin{lemma}
\label{lemma-inf-aut-change-of-field}
With notation and assumptions as in Situation \ref{situation-change-of-fields}.
Assume $\mathcal{F}$ is a deformation category.
Then there is a
canonical $l$-vector space isomorphism
$$
\text{Inf}(\mathcal{F}) \otimes_k l
\longrightarrow
\text{Inf}(\mathcal{F}_{l/k})
$$
of infinitesimal automorphism spaces.
\end{lemma}

\begin{proof}
Let $x_0 \in \Ob(\mathcal{F}(k))$ and denote $x_{l, 0}$ the corresponding
object of $\mathcal{F}_{l/k}$ over $l$. Recall that
$\text{Inf}(\mathcal{F}) = \text{Inf}_{x_0}(\mathcal{F})$ and
$\text{Inf}(\mathcal{F}_{l/k}) = \text{Inf}_{x_{l, 0}}(\mathcal{F}_{l/k})$,
see Remark \ref{remark-trivial-aut-point}.
Recall that the vector space structure on
$\text{Inf}_{x_0}(\mathcal{F})$ comes from identifying it with the tangent
space of the functor $\mathit{Aut}(x_0)$ which is defined on
the category $\mathcal{C}_{k, k}$ of Artinian local $k$-algebras with
residue field $k$. Similarly, $\text{Inf}_{x_{l, 0}}(\mathcal{F}_{l/k})$
is the tangent space of $\mathit{Aut}(x_{l, 0})$ which is defined on the
category $\mathcal{C}_{l, l}$ of Artinian local $l$-algebras with residue
field $l$. Unwinding the definitions we see that
$\mathit{Aut}(x_{l, 0})$ is the restriction of $\mathit{Aut}(x_0)_{l/k}$
(which lives on $\mathcal{C}_{k, l}$) to $\mathcal{C}_{l, l}$. Since
there is no difference between the tangent space of
$\mathit{Aut}(x_0)_{l/k}$ seen as a functor on $\mathcal{C}_{k, l}$ or
$\mathcal{C}_{l, l}$, the lemma follows from 
Lemma \ref{lemma-tangent-space-change-of-field}
and the fact that $\mathit{Aut}(x_0)$ satisfies (RS) by
Lemma \ref{lemma-Aut-functor-RS} (whence we have (S2) by
Lemma \ref{lemma-RS-implies-S1-S2}).
\end{proof}

\begin{lemma}
\label{lemma-change-of-fields-smooth}
With notation and assumptions as in Situation \ref{situation-change-of-fields}.
If $\mathcal{F} \to \mathcal{G}$ is a smooth morphism of categories cofibred
in groupoids over $\mathcal{C}_{\Lambda, k}$, then
$\mathcal{F}_{l/k} \to \mathcal{G}_{l/k}$ is a smooth morphism of categories
cofibred in groupoids over $\mathcal{C}_{\Lambda, l}$.
\end{lemma}

\begin{proof}
This follows immediately from the definitions and the fact that
(\ref{equation-comparison}) preserves surjections.
\end{proof}

\noindent
There are many more things you can say about the relationship between
$\mathcal{F}$ and $\mathcal{F}_{l/k}$ (in particular about the relationship
between versal deformations) and we will add these here as needed.

\begin{lemma}
\label{lemma-change-of-field-versal-ring}
With notation and assumptions as in Situation \ref{situation-change-of-fields}.
Let $\xi$ be a versal formal object for $\mathcal{F}$ lying over
$R \in \Ob(\widehat{\mathcal{C}}_{\Lambda, k})$. Then there exist
\begin{enumerate}
\item an $S \in \Ob(\widehat{\mathcal{C}}_{\Lambda, l})$
and a local $\Lambda$-algebra homomorphism $R \to S$ which is
formally smooth in the $\mathfrak m_S$-adic topology and induces
the given field extension $l/k$ on residue fieds, and
\item a versal formal object of $\mathcal{F}_{l/k}$ lying over $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Construction of $S$. Choose a surjection $R[x_1, \ldots, x_n] \to l$
of $R$-algebras. The kernel is a maximal ideal $\mathfrak m$.
Set $S$ equal to the $\mathfrak m$-adic completion of the Noetherian ring
$R[x_1, \ldots, x_n]$. Then $S$ is in $\widehat{\mathcal{C}}_{\Lambda, l}$
by Algebra, Lemma \ref{algebra-lemma-completion-Noetherian-Noetherian}.
The map $R \to S$ is formally smooth in the $\mathfrak m_S$-adic topology by
More on Algebra, Lemmas
\ref{more-algebra-lemma-formally-smooth} and
\ref{more-algebra-lemma-formally-smooth-completion}
and the fact that $R \to R[x_1, \ldots, x_n]$ is formally smooth.
(Compare with the proof Lemma \ref{lemma-exists-smooth}.)

\medskip\noindent
Since $\xi$ is versal, the transformation
$\underline{\xi} : \underline{R}|_{\mathcal{C}_{\Lambda, k}} \to \mathcal{F}$
is smooth. By Lemma \ref{lemma-change-of-fields-smooth} the induced map
$$
(\underline{R}|_{\mathcal{C}_{\Lambda, k}})_{l/k}
\longrightarrow
\mathcal{F}_{l/k}
$$
is smooth. Thus it suffices to construct a smooth morphism
$\underline{S}|_{\mathcal{C}_{\Lambda, l}} \to
(\underline{R}|_{\mathcal{C}_{\Lambda, k}})_{l/k}$.
To give such a map means for every object $B$ of $\mathcal{C}_{\Lambda, l}$
a map of sets
$$
\Mor_{\widehat{\mathcal{C}}_{\Lambda, l}}(S, B)
\longrightarrow
\Mor_{\widehat{\mathcal{C}}_{\Lambda, k}}(R, B \times_l k)
$$
functorial in $B$. Given an element $\varphi : S \to B$
on the left hand side we send it to the composition $R \to S \to B$
whose image is contained in the sub $\Lambda$-algebra $B \times_l k$.
Smoothness of the map means that given a surjection
$B' \to B$ and a commutative diagram
$$
\xymatrix{
S \ar[r] & B \ar@{=}[r] & B \\
R \ar[u] \ar[r] & B' \times_l k \ar[u] \ar[r] & B' \ar[u]
}
$$
we have to find a ring map $S \to B'$ fitting into the outer rectangle.
The existence of this map is guaranteed as we chose $R \to S$ to be
formally smooth in the $\mathfrak m_S$-adic topology, see
More on Algebra, Lemma \ref{more-algebra-lemma-lift-continuous}.
\end{proof}





















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
