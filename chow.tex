\input{preamble}

% OK, start here.
%
\begin{document}

\title{Chow Homology and Chern Classes}

\maketitle

\phantomsection
\label{section-phantom}


\tableofcontents


\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss Chow homology groups and the construction
of chern classes of vector bundles as elements of operational
Chow cohomology groups (everything with $\mathbf{Z}$-coefficients).

\medskip\noindent
We start this chapter by giving the shortest possible
algebraic proof of the Key Lemma \ref{lemma-milnor-gersten-low-degree}.
We first define the Herbrand quotient
(Section \ref{section-periodic-complexes})
and we compute it in some cases
(Section \ref{section-calculation}).
Next, we prove some simple algebra lemmas on
existence of suitable factorizations after modifications
(Section \ref{section-preparation-tame-symbol}).
Using these we construct/define the tame symbol in
Section \ref{section-tame-symbol}.
Only the most basic properties of the tame symbol
are needed to prove the Key Lemma, which we do
in Section \ref{section-key-lemma}.

\medskip\noindent
Next, we introduce the basic setup we work with in the rest of this
chapter in Section \ref{section-setup}. To make the material a little
bit more challenging we decided to treat a somewhat more general case
than is usually done. Namely we assume our schemes $X$ are locally of
finite type over a fixed locally Noetherian base scheme which is universally
catenary and is endowed with a dimension function. These assumptions suffice
to be able to define the Chow homology groups $\CH_*(X)$ and the action of
capping with chern classes on them. This is an indication that we should
be able to define these also for algebraic stacks locally of finite type
over such a base.

\medskip\noindent
Next, we follow the first few chapters of \cite{F} in order to define
cycles, flat pullback, proper pushforward, and rational equivalence,
except that we have been less precise about the supports of the cycles
involved.

\medskip\noindent
We diverge from the presentation given in \cite{F} by using the
Key lemma mentioned above to prove a basic commutativity relation in
Section \ref{section-key}. Using this we prove that the operation
of intersecting with an invertible sheaf passes through rational
equivalence and is commutative, see Section \ref{section-commutativity}.
One more application of the Key
lemma proves that the Gysin map of an effective Cartier divisor
passes through rational equivalence, see Section \ref{section-gysin}.
Having proved this, it is straightforward to define chern
classes of vector bundles, prove additivity, prove the splitting principle,
introduce chern characters, Todd classes, and state the
Grothendieck-Riemann-Roch theorem.

\medskip\noindent
There are two appendices. In Appendix A (Section \ref{section-appendix-A})
we discuss an alternative (longer) construction of the
tame symbol and corresponding proof of the Key Lemma.
Finally, in Appendix B (Section \ref{section-appendix-chow})
we briefly discuss the relationship with $K$-theory of coherent
sheaves and we discuss some blowup lemmas.
We suggest the reader look at their introductions for
more information.

\medskip\noindent
We will return to the Chow groups $\CH_*(X)$ for smooth projective varieties
over algebraically closed fields in the next chapter. Using a moving
lemma as in \cite{Samuel}, \cite{ChevalleyI}, and \cite{ChevalleyII}
and Serre's Tor-formula
(see \cite{Serre_local_algebra} or \cite{Serre_algebre_locale})
we will define a ring structure on $\CH_*(X)$. See
Intersection Theory, Section \ref{intersection-section-introduction} ff.








\section{Periodic complexes and Herbrand quotients}
\label{section-periodic-complexes}

\noindent
Of course there is a very general notion of periodic complexes.
We can require periodicity of the maps, or periodicity of the objects.
We will add these here as needed. For the moment we only need
the following cases.

\begin{definition}
\label{definition-periodic-complex}
Let $R$ be a ring.
\begin{enumerate}
\item A {\it $2$-periodic complex} over $R$ is given
by a quadruple $(M, N, \varphi, \psi)$ consisting of
$R$-modules $M$, $N$ and $R$-module maps $\varphi : M \to N$,
$\psi : N \to M$ such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
N \ar[r]^\psi &
M \ar[r]^\varphi &
N \ar[r] & \ldots
}
$$
is a complex. In this setting we define the {\it cohomology modules}
of the complex to be the $R$-modules
$$
H^0(M, N, \varphi, \psi) = \Ker(\varphi)/\Im(\psi)
\quad\text{and}\quad
H^1(M, N, \varphi, \psi) = \Ker(\psi)/\Im(\varphi).
$$
We say the $2$-periodic complex is {\it exact} if the cohomology
groups are zero.
\item A {\it $(2, 1)$-periodic complex} over $R$ is given
by a triple $(M, \varphi, \psi)$ consisting of an $R$-module $M$ and
$R$-module maps $\varphi : M \to M$, $\psi : M \to M$
such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
M \ar[r]^\psi &
M \ar[r]^\varphi &
M \ar[r] & \ldots
}
$$
is a complex. Since this is a special case of a $2$-periodic complex
we have its {\it cohomology modules} $H^0(M, \varphi, \psi)$,
$H^1(M, \varphi, \psi)$ and a notion of exactness.
\end{enumerate}
\end{definition}

\noindent
In the following we will use any result proved for $2$-periodic
complexes without further mention for $(2, 1)$-periodic complexes.
It is clear that the collection of $2$-periodic complexes forms a
category with morphisms
$(f, g) : (M, N, \varphi, \psi) \to (M', N', \varphi', \psi')$
pairs of morphisms $f : M \to M'$ and $g : N \to N'$ such
that $\varphi' \circ f = f \circ \varphi$ and $\psi' \circ g = g \circ \psi$.
We obtain an abelian category, with kernels and cokernels as in
Homology, Lemma \ref{homology-lemma-cat-chain-abelian}.

\begin{definition}
\label{definition-periodic-length}
Let $(M, N, \varphi, \psi)$ be a $2$-periodic complex
over a ring $R$ whose cohomology modules have finite length.
In this case we define the {\it multiplicity} of $(M, N, \varphi, \psi)$
to be the integer
$$
e_R(M, N, \varphi, \psi) =
\text{length}_R(H^0(M, N, \varphi, \psi))
-
\text{length}_R(H^1(M, N, \varphi, \psi))
$$
In the case of a $(2, 1)$-periodic complex $(M, \varphi, \psi)$,
we denote this by $e_R(M, \varphi, \psi)$ and we will sometimes call this
the {\it (additive) Herbrand quotient}.
\end{definition}

\noindent
If the cohomology groups of $(M, \varphi, \psi)$
are finite abelian groups, then it is customary to call the
{\it (multiplicative) Herbrand quotient}
$$
q(M, \varphi, \psi) =
\frac{\# H^0(M, \varphi, \psi)}{\# H^1(M, \varphi, \psi)}
$$
In words: the multiplicative Herbrand quotient is the number of elements of
$H^0$ divided by the number of elements of $H^1$. If $R$ is local and if
the residue field of $R$ is finite with $q$ elements, then we see that
$$
q(M, \varphi, \psi) = q^{e_R(M, \varphi, \psi)}
$$

\medskip\noindent
An example of a $(2, 1)$-periodic complex over a ring $R$ is any triple of
the form $(M, 0, \psi)$ where $M$ is an $R$-module and $\psi$ is an
$R$-linear map. If the kernel and cokernel of $\psi$ have finite length,
then we obtain
\begin{equation}
\label{equation-multiplicity-coker-ker}
e_R(M, 0, \psi) = \text{length}_R(\Coker(\psi)) - \text{length}_R(\Ker(\psi))
\end{equation}
We state and prove the obligatory lemmas on these notations.

\begin{lemma}
\label{lemma-additivity-periodic-length}
Let $R$ be a ring. Suppose that we have a short exact sequence of
$2$-periodic complexes
$$
0 \to (M_1, N_1, \varphi_1, \psi_1)
\to (M_2, N_2, \varphi_2, \psi_2)
\to (M_3, N_3, \varphi_3, \psi_3)
\to 0
$$
If two out of three have cohomology modules of finite length so does
the third and we have
$$
e_R(M_2, N_2, \varphi_2, \psi_2) =
e_R(M_1, N_1, \varphi_1, \psi_1) +
e_R(M_3, N_3, \varphi_3, \psi_3).
$$
\end{lemma}

\begin{proof}
We abbreviate $A = (M_1, N_1, \varphi_1, \psi_1)$,
$B = (M_2, N_2, \varphi_2, \psi_2)$ and $C = (M_3, N_3, \varphi_3, \psi_3)$.
We have a long exact cohomology sequence
$$
\ldots
\to H^1(C)
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to H^1(C)
\to \ldots
$$
This gives a finite exact sequence
$$
0 \to I
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to K \to 0
$$
with $0 \to K \to H^1(C) \to I \to 0$ a filtration. By additivity of
the length function (Algebra, Lemma \ref{algebra-lemma-length-additive})
we see the result.
\end{proof}

\begin{lemma}
\label{lemma-finite-periodic-length}
Let $R$ be a ring. If $(M, N, \varphi, \psi)$ is a $2$-periodic complex
such that $M$, $N$ have finite length, then
$e_R(M, N, \varphi, \psi) = \text{length}_R(M) - \text{length}_R(N)$.
In particular, if $(M, \varphi, \psi)$ is a $(2, 1)$-periodic complex
such that $M$ has finite length, then
$e_R(M, \varphi, \psi) = 0$.
\end{lemma}

\begin{proof}
This follows from the additity of
Lemma \ref{lemma-additivity-periodic-length}
and the short exact sequence
$0 \to (M, 0, 0, 0) \to (M, N, \varphi, \psi) \to (0, N, 0, 0) \to 0$.
\end{proof}

\begin{lemma}
\label{lemma-compare-periodic-lengths}
Let $R$ be a ring. Let $f : (M, \varphi, \psi) \to (M', \varphi', \psi')$
be a map of $(2, 1)$-periodic complexes whose cohomology modules
have finite length. If $\Ker(f)$ and $\Coker(f)$ have finite length,
then $e_R(M, \varphi, \psi) = e_R(M', \varphi', \psi')$.
\end{lemma}

\begin{proof}
Apply the additivity of Lemma \ref{lemma-additivity-periodic-length}
and observe that $(\Ker(f), \varphi, \psi)$ and
$(\Coker(f), \varphi', \psi')$ have vanishing multiplicity by
Lemma \ref{lemma-finite-periodic-length}.
\end{proof}




\section{Calculation of some multiplicities}
\label{section-calculation}

\noindent
To prove equality of certain cycles later on we need to
compute some multiplicities. Our main tool, besides the
elementary lemmas on multiplicities given in the previous section,
will be Algebra, Lemma \ref{algebra-lemma-order-vanishing-determinant}.

\begin{lemma}
\label{lemma-length-multiplication}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module. Let $x \in R$. Assume that
\begin{enumerate}
\item $\dim(\text{Supp}(M)) \leq 1$, and
\item $\dim(\text{Supp}(M/xM)) \leq 0$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$.
Then
$$
e_R(M, 0, x) =
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(x)
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
\end{lemma}

\begin{proof}
We first make some preparatory remarks.
The result of the lemma holds if $M$ has finite length, i.e., if $t = 0$,
because both the left hand side and the right hand side are zero
in this case, see Lemma \ref{lemma-finite-periodic-length}.
Also, if we have a short exact sequence $0 \to M \to M' \to M'' \to 0$
of modules satisfying (1) and (2), then lemma for 2 out of 3
of these implies the lemma for the third by the
additivity of length (Algebra, Lemma \ref{algebra-lemma-length-additive}) and
additivty of multiplicities (Lemma \ref{lemma-additivity-periodic-length}).

\medskip\noindent
Denote $M_i$ the image of $M$ in $M_{\mathfrak q_i}$, so
$\text{Supp}(M_i) = \{\mathfrak m, \mathfrak q_i\}$.
The kernel and cokernel of the map $M \to \bigoplus M_i$
have support $\{\mathfrak m\}$ and hence have finite length.
By our preparatory remarks, it follows that it suffices to
prove the lemma for each $M_i$. Thus we may assume that
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$.
In this case we can filter $M$ by powers of $\mathfrak q$.
Again additivity shows that it suffices to prove the lemma
in the case $M$ is annihilated by $\mathfrak q$.
In this case we can view $M$ as a $R/\mathfrak q$-module,
i.e., we may assume that $R$ is a Noetherian local domain
of dimension $1$ with fraction field $K$.
Dividing by the torsion submodule, i.e., by the
kernel of $M \to M \otimes_R K = V$ (the torsion has
finite length hence is handled by our preliminary remarks)
we may assume that $M \subset V$ is a lattice
(Algebra, Definition \ref{algebra-definition-lattice}).
Then $x : M \to M$ is injective and
$\text{length}_R(M/xM) = d(M, xM)$
(Algebra, Definition \ref{algebra-definition-distance}). Since
$\text{length}_K(V) = \dim_K(V)$
we see that $\det(x : V \to V) = x^{\dim_K(V)}$ and
$\text{ord}_R(\det(x : V \to V)) = \dim_K(V) \text{ord}_R(x)$.
Thus the desired equality follows from
Algebra, Lemma \ref{algebra-lemma-order-vanishing-determinant}
in this case.
\end{proof}

\begin{lemma}
\label{lemma-additivity-divisors-restricted}
Let $R$ be a Noetherian local ring.
Let $x \in R$. If $M$ is a finite Cohen-Macaulay module over $R$
with $\dim(\text{Supp}(M)) = 1$ and $\dim(\text{Supp}(M/xM)) = 0$, then
$$
\text{length}_R(M/xM)
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the
minimal primes of the support of $M$. If $I \subset R$ is an ideal
such that $x$ is a nonzerodivisor on $R/I$ and $\dim(R/I) = 1$, then
$$
\text{length}_R(R/(x, I))
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}((R/I)_{\mathfrak q_i})
$$
where $\mathfrak q_1, \ldots, \mathfrak q_n$ are the minimal
primes over $I$.
\end{lemma}

\begin{proof}
These are special cases of Lemma \ref{lemma-length-multiplication}.
\end{proof}

\noindent
Here is another case where we can determine the value of a multiplicity.

\begin{lemma}
\label{lemma-powers-period-length-zero}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $\varphi : M \to M$ be an endomorphism and $n > 0$
such that $\varphi^n = 0$ and such that $\Ker(\varphi)/\Im(\varphi^{n - 1})$
has finite length as an $R$-module.
Then
$$
e_R(M, \varphi^i, \varphi^{n - i}) = 0
$$
for $i = 0, \ldots, n$.
\end{lemma}

\begin{proof}
The cases $i = 0, n$ are trivial as $\varphi^0 = \text{id}_M$ by convention.
Let us think of $M$ as an $R[t]$-module where multiplication by $t$
is given by $\varphi$. Let us write
$K_i = \Ker(t^i : M \to M)$ and
$$
a_i = \text{length}_R(K_i/t^{n - i}M),\quad
b_i = \text{length}_R(K_i/tK_{i + 1}),\quad
c_i = \text{length}_R(K_1/t^iK_{i + 1})
$$
Boundary values are $a_0 = a_n = b_0 = c_0 = 0$.
The $c_i$ are integers for $i < n$ as $K_1/t^iK_{i + 1}$
is a quotient of $K_1/t^{n - 1}M$ which is assumed to have finite length.
We will use frequently that $K_i \cap t^jM = t^jK_{i + j}$.
For $0 < i < n - 1$ we have an exact sequence
$$
0 \to
K_1/t^{n - i - 1}K_{n - i} \to
K_{i + 1}/t^{n - i - 1}M \xrightarrow{t} K_i/t^{n - i}M
\to K_i/tK_{i + 1} \to 0
$$
By induction on $i$ we conclude that $a_i$ and $b_i$ are
integers for $i < n$ and that
$$
c_{n - i - 1} - a_{i + 1} + a_i - b_i = 0
$$
For $0 < i < n - 1$ there is a short exact sequence
$$
0 \to
K_i/tK_{i + 1} \to
K_{i + 1}/tK_{i + 2} \xrightarrow{t^i}
K_1/t^{i + 1}K_{i + 2} \to
K_1/t^iK_{i + 1} \to 0
$$
which gives
$$
b_i - b_{i + 1} + c_{i + 1} - c_i = 0
$$
Since $b_0 = c_0$ we conclude that $b_i = c_i$ for $i < n$.
Then we see that
$$
a_2 = a_1 + b_{n - 2} - b_1,\quad
a_3 = a_2 + b_{n - 3} - b_2,\quad \ldots
$$
It is straighforward to see that this implies $a_i = a_{n - i}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-multiply-period-length}
Let $(R, \mathfrak m)$ be a Noetherian local ring. Let
$(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$
with $M$ finite and with cohomology groups of finite length over $R$.
Let $x \in R$ be such that $\dim(\text{Supp}(M/xM)) \leq 0$. Then
$$
e_R(M, x\varphi, \psi) = e_R(M, \varphi, \psi) - e_R(\Im(\varphi), 0, x)
$$
and
$$
e_R(M, \varphi, x\psi) = e_R(M, \varphi, \psi) + e_R(\Im(\psi), 0, x)
$$
\end{lemma}

\begin{proof}
We will only prove the first formula as the second is proved
in exactly the same manner.
Let $M' = M[x^\infty]$ be the $x$-power torsion submodule of $M$.
Consider the short exact sequence $0 \to M' \to M \to M'' \to 0$.
Then $M''$ is $x$-power torsion free (More on Algebra, Lemma
\ref{more-algebra-lemma-divide-by-torsion}).
Since $\varphi$, $\psi$ map $M'$ into $M'$
we obtain a short exact sequence
$$
0 \to (M', \varphi', \psi') \to (M, \varphi, \psi) \to
(M'', \varphi'', \psi'') \to 0
$$
of $(2, 1)$-periodic complexes. Also, we get a short exact sequence
$0 \to M' \cap \Im(\varphi) \to \Im(\varphi) \to \Im(\varphi'') \to 0$.
We have
$e_R(M', \varphi, \psi) = e_R(M', x\varphi, \psi) =
e_R(M' \cap \Im(\varphi), 0, x) = 0$
by Lemma \ref{lemma-compare-periodic-lengths}.
By additivity (Lemma \ref{lemma-additivity-periodic-length})
we see that it suffices to prove the lemma for $(M'', \varphi'', \psi'')$.
This reduces us to the case discussed in the next paragraph.

\medskip\noindent
Assume $x : M \to M$ is injective.
In this case $\Ker(x\varphi) = \Ker(\varphi)$.
On the other hand we have a short exact sequence
$$
0 \to \Im(\varphi)/x\Im(\varphi) \to
\Ker(\psi)/\Im(x\varphi) \to \Ker(\psi)/\Im(\varphi) \to 0
$$
This together with (\ref{equation-multiplicity-coker-ker}) proves the formula.
\end{proof}







\section{Preparation for tame symbols}
\label{section-preparation-tame-symbol}

\noindent
In this section we put some lemma that will help us define the
tame symbol in the next section.

\begin{lemma}
\label{lemma-glue-at-max}
Let $A$ be a Noetherian ring. Let $\mathfrak m_1, \ldots, \mathfrak m_r$
be pairwise distinct maximal ideals of $A$. For $i = 1, \ldots, r$ let
$\varphi_i : A_{\mathfrak m_i} \to B_i$ be a ring map whose
kernel and cokernel are annihilated by a power
of $\mathfrak m_i$. Then there exists a ring map $\varphi : A \to B$ such
that
\begin{enumerate}
\item the localization of $\varphi$ at $\mathfrak m_i$ is
isomorphic to $\varphi_i$, and
\item $\Ker(\varphi)$ and $\Coker(\varphi)$ are annihilated
by a power of $\mathfrak m_1 \cap \ldots \cap \mathfrak m_r$.
\end{enumerate}
Moreover, if each $\varphi_i$ is finite, injective, or
surjective then so is $\varphi$.
\end{lemma}

\begin{proof}
Set $I = \mathfrak m_1 \cap \ldots \cap \mathfrak m_r$. Set
$A_i = A_{\mathfrak m_i}$ and $A' = \prod A_i$.
Then $IA' = \prod \mathfrak m_i A_i$ and $A \to A'$
is a flat ring map such that $A/I \cong A'/IA'$.
Thus we may use More on Algebra, Lemma
\ref{more-algebra-lemma-application-formal-glueing}
to see that there exists an $A$-module map $\varphi : A \to B$
with $\varphi_i$ isomorphic to the localization of $\varphi$
at $\mathfrak m_i$. Then we can use the discussion in
More on Algebra, Remark \ref{more-algebra-remark-formal-glueing-algebras}
to endow $B$ with an $A$-algebra structure
matching the given $A$-algebra structure on $B_i$.
The final statement of the lemma follows easily from
the fact that $\Ker(\varphi)_{\mathfrak m_i} \cong \Ker(\varphi_i)$
and $\Coker(\varphi)_{\mathfrak m_i} \cong \Coker(\varphi_i)$.
\end{proof}

\noindent
The following lemma is very similar to
Algebra, Lemma \ref{algebra-lemma-nonregular-dimension-one}.

\begin{lemma}
\label{lemma-Noetherian-domain-dim-1-two-elements}
Let $(R, \mathfrak m)$ be a Noetherian local ring of dimension $1$.
Let $a, b \in R$ be nonzerodivisors.
There exists a finite ring extension $R \subset R'$
with $R'/R$ annihilated by a power of $\mathfrak m$
and nonzerodivisors $t, a', b' \in R'$ such that
$a = ta'$ and $b = tb'$ and $R' = a'R' + b'R'$.
\end{lemma}

\begin{proof}
If $a$ or $b$ is a unit, then the lemma is true with $R = R'$.
Thus we may assume $a, b \in \mathfrak m$.
Set $I = (a, b)$. The idea is to blow up $R$ in $I$.
Instead of doing the algebraic argument we work geometrically.
Let $X = \text{Proj}(\bigoplus_{d \geq 0} I^d)$.
By Divisors, Lemma
\ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
the morphism $X \to \Spec(R)$ is an isomorphism over
the punctured spectrum $U = \Spec(R) \setminus \{\mathfrak m\}$.
Thus we may and do view $U$ as an open subscheme of $X$.
The morphism $X \to \Spec(R)$ is projective by
Divisors, Lemma \ref{divisors-lemma-blowing-up-projective}.
Also, every generic point of $X$ lies in $U$, for example
by Divisors, Lemma \ref{divisors-lemma-blow-up-and-irreducible-components}.
It follows from Varieties, Lemma \ref{varieties-lemma-finite-in-codim-1}
that $X \to \Spec(R)$ is finite. Thus $X = \Spec(R')$ is
affine and $R \to R'$ is finite. We have $R_a \cong R'_a$ as $U = D(a)$.
Hence a power of $a$ annihilates the finite $R$-module $R'/R$.
As $\mathfrak m = \sqrt{(a)}$ we see that $R'/R$ is annihilated
by a power of $\mathfrak m$. By
Divisors, Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
we see that $IR'$ is a locally principal ideal.
Since $R'$ is semi-local we see that $IR'$ is principal,
see Algebra, Lemma \ref{algebra-lemma-locally-free-semi-local-free},
say $IR' = (t)$. Then we have $a = a't$ and $b = b't$ and everything is
clear.
\end{proof}

\begin{lemma}
\label{lemma-not-infinitely-divisible}
Let $(R, \mathfrak m)$ be a Noetherian local ring of dimension $1$.
Let $a, b \in R$ be nonzerodivisors with $a \in \mathfrak m$.
There exists an integer $n = n(R, a, b)$ such that for a finite ring
extension $R \subset R'$ if $b = a^m c$ for some $c \in R'$, then $m \leq n$.
\end{lemma}

\begin{proof}
Choose a minimal prime $\mathfrak q \subset R$. Observe that
$\dim(R/\mathfrak q) = 1$, in particular $R/\mathfrak q$ is not a field.
We can choose a discrete valuation ring $A$ dominating $R/\mathfrak q$
with the same fraction field, see
Algebra, Lemma \ref{algebra-lemma-dominate-by-dimension-1}. Observe that
$a$ and $b$ map to nonzero elements of $A$ as nonzerodivisors in $R$
are not contained in $\mathfrak q$. Let $v$ be the discrete valuation on $A$.
Then $v(a) > 0$ as $a \in \mathfrak m$.
We claim $n = v(b)/v(a)$ works.

\medskip\noindent
Let $R \subset R'$ be given. Set $A' = A \otimes_R R'$.
Since $\Spec(R') \to \Spec(R)$ is surjective
(Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective})
also $\Spec(A') \to \Spec(A)$ is surjective
(Algebra, Lemma \ref{algebra-lemma-surjective-spec-radical-ideal}).
Pick a prime $\mathfrak q' \subset A'$ lying over $(0) \subset A$.
Then $A \subset A'' = A'/\mathfrak q'$ is a finite extension of rings
(again inducing a surjection on spectra).
Pick a maximal ideal $\mathfrak m'' \subset A''$
lying over the maximal ideal of $A$ and a discrete valuation ring
$A'''$ dominating $A''_{\mathfrak m''}$ (see lemma cited above).
Then $A \to A'''$ is an extension of discrete valuation rings
and we have $b = a^m c$ in $A'''$. Thus $v'''(b) \geq mv'''(a)$.
Since $v''' = ev$ where $e$ is the ramification index
of $A'''/A$, we find that $m \leq n$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-prepare-tame-symbol}
Let $(A, \mathfrak m)$ be a Noetherian local ring of dimension $1$.
Let $r \geq 2$ and let $a_1, \ldots, a_r \in A$ be nonzerodivisors
not all units.
Then there exist
\begin{enumerate}
\item a finite ring extension $A \subset B$ with
$B/A$ annihilated by a power of $\mathfrak m$,
\item for each of maximal ideal $\mathfrak m_j \subset B$
a nonzerodivisor $\pi_j \in B_j = B_{\mathfrak m_j}$, and
\item factorizations $a_i = u_{i, j} \pi_j^{e_{i, j}}$ in $B_j$
with $u_{i, j} \in B_j$ units and $e_{i, j} \geq 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since at least one $a_i$ is not a unit and we find that $\mathfrak m$
is not an associated prime of $A$. Moreover, for any $A \subset B$
as in the statement $\mathfrak m$ is not an associated prime of $B$
and $\mathfrak m_j$ is not an associate prime of $B_j$.
Keeping this in mind will help check the arguments below.

\medskip\noindent
First, we claim that it suffices to prove the lemma for $r = 2$.
We will argue this by induction on $r$; we suggest the reader
skip the proof. Suppose we are given $A \subset B$ and $\pi_j$ in
$B_j = B_{\mathfrak m_j}$ and factorizations
$a_i = u_{i, j} \pi_j^{e_{i, j}}$ for $i = 1, \ldots, r - 1$ in $B_j$
with $u_{i, j} \in B_j$ units and $e_{i, j} \geq 0$.
Then by the case $r = 2$ for $\pi_j$ and $a_r$ in $B_j$
we can find extensions $B_j \subset C_j$ and for every maximal ideal
$\mathfrak m_{j, k}$ of $C_j$ a nonzerodivisor
$\pi_{j, k} \in C_{j, k} = (C_j)_{\mathfrak m_{j, k}}$
and factorizations
$$
\pi_j = v_{j, k} \pi_{j, k}^{f_{j, k}}
\quad\text{and}\quad
a_r = w_{j, k} \pi_{j, k}^{g_{j, k}}
$$
as in the lemma. There exists a unique finite extension $B \subset C$
with $C/B$ annihilated by a power of $\mathfrak m$ such
that $C_j \cong C_{\mathfrak m_j}$ for all $j$, see
Lemma \ref{lemma-glue-at-max}.
The maximal ideals of $C$ correspond $1$-to-$1$
to the maximal ideals $\mathfrak m_{j, k}$ in the localizations
and in these localizations we have
$$
a_i = u_{i, j} \pi_j^{e_{i, j}} =
u_{i, j} v_{j, k}^{e_{i, j}} \pi_{j, k}^{e_{i, j}f_{j, k}}
$$
for $i \leq r - 1$. Since $a_r$ factors correctly too the
proof of the induction step is complete.

\medskip\noindent
Proof of the case $r = 2$. We will use induction on
$$
\ell = \min(\text{length}_A(A/a_1A),\ \text{length}_A(A/a_2A)).
$$
If $\ell = 0$, then either $a_1$ or $a_2$ is a unit and
the lemma holds with $A = B$. Thus we may and do assume $\ell > 0$.

\medskip\noindent
Suppose we have a finite extension of rings $A \subset A'$ such that
$A'/A$ is annihilated by a power of $\mathfrak m$ and such that
$\mathfrak m$ is not an associated prime of $A'$.
Let $\mathfrak m_1, \ldots, \mathfrak m_r \subset A'$
be the maximal ideals and set $A'_i = A'_{\mathfrak m_i}$.
If we can solve the problem for $a_1, a_2$ in each $A'_i$,
then we can apply Lemma \ref{lemma-glue-at-max}
to produce a solution for $a_1, a_2$ in $A$.
Choose $x \in \{a_1, a_2\}$ such that $\ell = \text{length}_A(A/xA)$.
By Lemma \ref{lemma-compare-periodic-lengths} 
and (\ref{equation-multiplicity-coker-ker})
we have $\text{length}_A(A/xA) = \text{length}_A(A'/xA')$.
On the other hand, we have
$$
\text{length}_A(A'/xA') =
\sum [\kappa(\mathfrak m_i) : \kappa(\mathfrak m)]
\text{length}_{A'_i}(A'_i/xA'_i)
$$
by Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
Since $x \in \mathfrak m$ we see that each term on the right hand side
is positive. We conclude that the induction hypothesis applies
to $a_1, a_2$ in each $A'_i$ if $r > 1$ or if $r = 1$ and
$[\kappa(\mathfrak m_1) : \kappa(\mathfrak m)] > 1$.
We conclude that we may assume each $A'$ as above is local with
the same residue field as $A$.

\medskip\noindent
Applying the discussion of the previous paragraph,
we may replace $A$ by the ring constructed in
Lemma \ref{lemma-Noetherian-domain-dim-1-two-elements}
for $a_1, a_2 \in A$. Then since $A$ is local we find,
after possibly switching $a_1$ and $a_2$, that $a_2 \in (a_1)$.
Write $a_2 = a_1^m c$ with $m > 0$ maximal. In fact, by
Lemma \ref{lemma-not-infinitely-divisible}
we may assume $m$ is maximal even after replacing $A$
by any finite extension $A \subset A'$ as in the previous paragraph.
If $c$ is a unit, then we are done. If not, then we replace
$A$ by the ring constructed in
Lemma \ref{lemma-Noetherian-domain-dim-1-two-elements}
for $a_1, c \in A$. Then either (1) $c = a_1 c'$ or
(2) $a_1 = c a'_1$. The first case cannot happen since
it would give $a_2 = a_1^{m + 1} c'$ contradicting the
maximality of $m$. In the second case we get
$a_1 = c a'_1$ and $a_2 = c^{m + 1} (a'_1)^m$.
Then it suffices to prove the lemma for $A$ and $c, a'_1$.
If $a'_1$ is a unit we're done and if not, then
$\text{length}_A(A/cA) < \ell$ because $cA$ is a strictly
bigger ideal than $a_1A$. Thus we win by induction hypothesis.
\end{proof}






\section{Tame symbols}
\label{section-tame-symbol}

\noindent
Consider a Noetherian local ring $(A, \mathfrak m)$ of dimension $1$.
We denote $Q(A)$ the total ring of fractions of $A$, see
Algebra, Example \ref{algebra-example-localize-at-prime}.
The {\it tame symbol} will be a map
$$
\partial_A(-, -) : Q(A)^* \times Q(A)^* \longrightarrow \kappa(\mathfrak m)^*
$$
satisfying the following properties:
\begin{enumerate}
\item $\partial_A(f, gh) = \partial_A(f, g) \partial_A(f, h)$
\label{item-bilinear}
for $f, g, h \in Q(A)^*$,
\item $\partial_A(f, g) \partial_A(g, f) = 1$
\label{item-skew}
for $f, g \in Q(A)^*$,
\item $\partial_A(f, 1 - f) = 1$
\label{item-1-x}
for $f \in Q(A)^*$ such that $1 - f \in Q(A)^*$,
\item $\partial_A(aa', b) = \partial_A(a, b)\partial_A(a', b)$
\label{item-bilinear-better}
and $\partial_A(a, bb') = \partial_A(a, b)\partial_A(a, b')$
for $a, a', b, b' \in A$ nonzerodivisors,
\item $\partial_A(b, b) = (-1)^m$
\label{item-skew-better}
with $m = \text{length}_A(A/bA)$
for $b \in A$ a nonzerodivisor,
\item $\partial_A(u, b) = u^m \bmod \mathfrak m$
\label{item-normalization}
with $m = \text{length}_A(A/bA)$ for $u \in A$ a unit and
$b \in A$ a nonzerodivisor, and
\item
\label{item-1-x-better}
$\partial_A(a, b - a)\partial_A(b, b) = \partial_A(b, b - a)\partial_A(a, b)$
for $a, b \in A$ such that $a, b, b - a$ are nonzerodivisors.
\end{enumerate}
Since it is easier to work with elements of $A$ we will
often think of $\partial_A$ as a map defined on pairs of
nonzerodivisors of $A$ satisfying (\ref{item-bilinear-better}),
(\ref{item-skew-better}), (\ref{item-normalization}),
(\ref{item-1-x-better}). It is an exercise to see that
setting
$$
\partial_A(\frac{a}{b}, \frac{c}{d}) =
\partial_A(a, b) \partial_A(a, d)^{-1} \partial_A(b, c)^{-1} \partial_A(b, d)
$$
we get a well defined map $Q(A)^* \times Q(A)^* \to \kappa(\mathfrak m)^*$
satisfying (\ref{item-bilinear}), (\ref{item-skew}), (\ref{item-1-x})
as well as the other properties.

\medskip\noindent
We do not claim there is a unique map with these properties.
Instead, we will give a recipe for constructing such a map.
Namely, given $a_1, a_2 \in A$ nonzerodivisors, we choose
a ring extension $A \subset B$ and local factorizations
as in Lemma \ref{lemma-prepare-tame-symbol}.
Then we define
\begin{equation}
\label{equation-tame-symbol}
\partial_A(a_1, a_2) = \prod\nolimits_j
\text{Norm}_{\kappa(\mathfrak m_j)/\kappa(\mathfrak m)}
((-1)^{e_{1, j}e_{2, j}}u_{1, j}^{e_{2, j}}u_{2, j}^{-e_{1, j}}
\bmod \mathfrak m_j)^{m_j}
\end{equation}
where $m_j = \text{length}_{B_j}(B_j/\pi_j B_j)$ and the product
is taken over the maximal ideals $\mathfrak m_1, \ldots, \mathfrak m_r$ of $B$.

\begin{lemma}
\label{lemma-well-defined-tame-symbol}
The formula (\ref{equation-tame-symbol}) determines a
well defined element of $\kappa(\mathfrak m)^*$. In other words, the
right hand side does not depend on the choice of the
local factorizations or the choice of $B$.
\end{lemma}

\begin{proof}
Independence of choice of factorizations. Suppose we have
a Noetherian $1$-dimensional local ring $B$, elements $a_1, a_2 \in B$,
and nonzerodivisors $\pi, \theta$ such that we can write
$$
a_1 = u_1 \pi^{e_1} = v_1 \theta^{f_1},\quad
a_2 = u_2 \pi^{e_2} = v_2 \theta^{f_2}
$$
with $e_i, f_i \geq 0$ integers and $u_i, v_i$ units in $B$.
Observe that this implies
$$
a_1^{e_2} = u_1^{e_2}u_2^{-e_1}a_2^{e_1},\quad
a_1^{f_2} = v_1^{f_2}v_2^{-f_1}a_2^{f_1}
$$
On the other hand, setting
$m = \text{length}_B(B/\pi B)$ and $k = \text{length}_B(B/\theta B)$
we find $e_2 m = \text{length}_B(B/a_2 B) = f_2 k$.
Expanding $a_1^{e_2m} = a_1^{f_2 k}$ using the above we find
$$
(u_1^{e_2}u_2^{-e_1})^m =  (v_1^{f_2}v_2^{-f_1})^k
$$
This proves the desired equality up to signs. To see the signs
work out we have to show $me_1e_2$ is even if and only if
$kf_1f_2$ is even. This follows as both $me_2 = kf_2$ and
$me_1 = kf_1$ (same argument as above).

\medskip\noindent
Independence of choice of $B$. Suppose given two extensions
$A \subset B$ and $A \subset B'$ as in Lemma \ref{lemma-prepare-tame-symbol}.
Then
$$
C = (B \otimes_A B')/(\mathfrak m\text{-power torsion})
$$
will be a third one. Thus we may assume we have
$A \subset B \subset C$ and factorizations over the
local rings of $B$ and we have to show that using
the same factorizations over the local rings of $C$
gives the same element of $\kappa(\mathfrak m)$.
By transitivity of norms
(Fields, Lemma \ref{fields-lemma-trace-and-norm-tower})
this comes down to the following problem:
if $B$ is a Noetherian local ring of dimension $1$
and $\pi \in B$ is a nonzerodivisor, then
$$
\lambda^m = \prod \text{Norm}_{\kappa_k/\kappa}(\lambda)^{m_k}
$$
Here we have used the following notation:
(1) $\kappa$ is the residue field of $B$,
(2) $\lambda$ is an element of $\kappa$,
(3) $\mathfrak m_k \subset C$ are the maximal ideals of $C$,
(4) $\kappa_k = \kappa(\mathfrak m_k)$ is the residue field of
$C_k = C_{\mathfrak m_k}$,
(5) $m = \text{length}_B(B/\pi B)$, and
(6) $m_k = \text{length}_{C_k}(C_k/\pi C_k)$.
The displayed equality holds because
$\text{Norm}_{\kappa_k/\kappa}(\lambda) = \lambda^{[\kappa_k : \kappa]}$
as $\lambda \in \kappa$ and because $m = \sum m_k[\kappa_k:\kappa]$.
First, we have $m = \text{length}_B(B/xB) = \text{length}_B(C/\pi C)$
by Lemma \ref{lemma-compare-periodic-lengths} 
and (\ref{equation-multiplicity-coker-ker}).
Finally, we have $\text{length}_B(C/\pi C) = \sum m_k[\kappa_k:\kappa]$
by Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
\end{proof}

\begin{lemma}
\label{lemma-tame-symbol}
The tame symbol (\ref{equation-tame-symbol}) satisfies
(\ref{item-bilinear-better}), (\ref{item-skew-better}),
(\ref{item-normalization}), (\ref{item-1-x-better}) and hence
gives a map $\partial_A : Q(A)^* \times Q(A)^* \to \kappa(\mathfrak m)^*$
satisfying (\ref{item-bilinear}), (\ref{item-skew}), (\ref{item-1-x}).
\end{lemma}

\begin{proof}
Let us prove (\ref{item-bilinear-better}).
Let $a_1, a_2, a_3 \in A$ be nonzerodivisors.
Choose $A \subset B$ as in Lemma \ref{lemma-prepare-tame-symbol}
for $a_1, a_2, a_3$. Then the equality
$$
\partial_A(a_1a_2, a_3) = \partial_A(a_1, a_3) \partial_A(a_2, a_3)
$$
follows from the equality
$$
(-1)^{(e_{1, j} + e_{2, j})e_{3, j}}
(u_{1, j}u_{2, j})^{e_{3, j}}u_{3, j}^{-e_{1, j} - e_{2, j}} =
(-1)^{e_{1, j}e_{3, j}}
u_{1, j}^{e_{3, j}}u_{3, j}^{-e_{1, j}}
(-1)^{e_{2, j}e_{3, j}}
u_{2, j}^{e_{3, j}}u_{3, j}^{-e_{2, j}}
$$
in $B_j$. Properties (\ref{item-skew-better}) and
(\ref{item-normalization}) are equally immediate.

\medskip\noindent
Let us prove (\ref{item-1-x-better}). Let $a_1, a_2, a_1 - a_2 \in A$
be nonzerodivisors and set $a_3 = a_1 - a_2$.
Choose $A \subset B$ as in Lemma \ref{lemma-prepare-tame-symbol}
for $a_1, a_2, a_3$. Then it suffices to show
$$
(-1)^{e_{1, j}e_{2, j} + e_{1, j}e_{3, j} + e_{2, j}e_{3, j} + e_{2, j}}
u_{1, j}^{e_{2, j} - e_{3, j}}
u_{2, j}^{e_{3, j} - e_{1, j}}
u_{3, j}^{e_{1, j} - e_{2, j}} \bmod \mathfrak m_j = 1
$$
This is clear if $e_{1, j} = e_{2, j} = e_{3, j}$.
Say $e_{1, j} > e_{2, j}$. Then we see that $e_{3, j} = e_{2, j}$
because $a_3 = a_1 - a_2$ and we see that $u_{3, j}$
has the same residue class as $-u_{2, j}$. Hence
the formula is true -- the signs work out as well
and this verification is the reason for the choice of signs
in (\ref{equation-tame-symbol}).
The other cases are handled in exactly the same manner.
\end{proof}

\begin{lemma}
\label{lemma-norm-down-tame-symbol}
Let $(A, \mathfrak m)$ be a Noetherian local ring of dimension $1$.
Let $A \subset B$ be a finite ring extension with $B/A$
annihilated by a power of $\mathfrak m$ and $\mathfrak m$ not
an associated prime of $B$.
For $a, b \in A$ nonzerodivisors we have
$$
\partial_A(a, b) = \prod
\text{Norm}_{\kappa(\mathfrak m_j)/\kappa(\mathfrak m)}(\partial_{B_j}(a, b))
$$
where the product is over the maximal ideals $\mathfrak m_j$ of $B$
and $B_j = B_{\mathfrak m_j}$.
\end{lemma}

\begin{proof}
Choose $B_j \subset C_j$ as in
Lemma \ref{lemma-prepare-tame-symbol} for $a, b$.
By Lemma \ref{lemma-glue-at-max} we can choose a finite ring
extension $B \subset C$ with $C_j \cong C_{\mathfrak m_j}$ for all $j$.
Let $\mathfrak m_{j, k} \subset C$ be the maximal ideals of $C$
lying over $\mathfrak m_j$. Let
$$
a = u_{j, k}\pi_{j, k}^{f_{j, k}},\quad
b = v_{j, k}\pi_{j, k}^{g_{j, k}}
$$
be the local factorizations which exist by our choice of
$C_j \cong C_{\mathfrak m_j}$. By definition we have
$$
\partial_A(a, b) = 
\prod\nolimits_{j, k}
\text{Norm}_{\kappa(\mathfrak m_{j, k})/\kappa(\mathfrak m)}
((-1)^{f_{j, k}g_{j, k}}u_{j, k}^{g_{j, k}}v_{j, k}^{-f_{j, k}}
\bmod \mathfrak m_{j, k})^{m_{j, k}}
$$
and
$$
\partial_{B_j}(a, b) = 
\prod\nolimits_k
\text{Norm}_{\kappa(\mathfrak m_{j, k})/\kappa(\mathfrak m_j)}
((-1)^{f_{j, k}g_{j, k}}u_{j, k}^{g_{j, k}}v_{j, k}^{-f_{j, k}}
\bmod \mathfrak m_{j, k})^{m_{j, k}}
$$
The result follows by transitivity of norms
for $\kappa(\mathfrak m_{j, k})/\kappa(\mathfrak m_j)/\kappa(\mathfrak m)$, see
Fields, Lemma \ref{fields-lemma-trace-and-norm-tower}.
\end{proof}

\begin{lemma}
\label{lemma-tame-symbol-formally-smooth}
Let $(A, \mathfrak m, \kappa) \to (A', \mathfrak m', \kappa')$
be a local homomorphism of Noetherian local rings of dimension $1$.
If $A \to A'$ is flat, $\mathfrak m' = \mathfrak m A'$, and $\kappa'/\kappa$
is separable, then for $a_1, a_2 \in A$ nonzerodivisors the tame symbol
$\partial_A(a_1, a_2)$ maps to $\partial_{A'}(a_1, a_2)$.
\end{lemma}

\begin{proof}
If $a_1, a_2$ are both units, then $\partial_A(a_1, a_2) = 1$
and $\partial_{A'}(a_1, a_2) = 1$ and the result is true.
If not, then we can choose a ring extension $A \subset B$ and
local factorizations as in Lemma \ref{lemma-prepare-tame-symbol}.
Set $B' = A' \otimes_A B$. Since $A'$ is flat over $A$ we see
that $A' \subset B'$ is a ring extension with $B'/A'$ annihilated
by a power of $\mathfrak m'$. Let $\mathfrak m_1, \ldots, \mathfrak m_m$
be the maximal ideals of $B$. For each $j \in \{1, \ldots, m\}$
denote $\kappa_j = \kappa(\mathfrak m_j)$ the residue field.
Then
$$
\kappa_j \otimes_\kappa \kappa' =
\prod\nolimits_{l = 1, \ldots, n_j} \kappa'_{j, l}
$$
is a product of fields each finite over $\kappa'$ because $\kappa'/\kappa$
is a separable field extension
(Algebra, Lemma \ref{algebra-lemma-separable-extension-preserves-reducedness}).
It follows that $B'$ has corresponding maximal ideals $\mathfrak m'_{j, l}$
lying over $\mathfrak m_j$. As factorizations in
$B'_{j, l} = B'_{\mathfrak m'_{j, l}}$ we use the image of the factorizations
$a_i = u_{i, j} \pi_j^{e_{i, j}}$ given to us in $B_j$.
Thus we obtain
$$
\partial_A(a_1, a_2) = \prod\nolimits_j
\text{Norm}_{\kappa_j/\kappa}
((-1)^{e_{1, j}e_{2, j}}u_{1, j}^{e_{2, j}}u_{2, j}^{-e_{1, j}}
\bmod \mathfrak m_j)^{m_j}
$$
by definition and similarly
$$
\partial_{A'}(a_1, a_2) = \prod\nolimits_{j, l}
\text{Norm}_{\kappa'_{j, l}/\kappa'}
((-1)^{e_{1, j}e_{2, j}}u_{1, j}^{e_{2, j}}u_{2, j}^{-e_{1, j}}
\bmod \mathfrak m'_{j, l})^{m_j}
$$
To finish the proof we observe that if $u \in \kappa_j$
has image $u_l \in \kappa'_{j, l}$, then
$\text{Norm}_{\kappa_j/\kappa}(u)$ in $\kappa$ maps to
$\prod_l \text{Norm}_{\kappa'_{j, l}/\kappa'}(u_l)$ in $\kappa'$.
This follows from the fact that taking determinants of linear
maps commutes with ground field extension.
\end{proof}






\section{A key lemma}
\label{section-key-lemma}

\noindent
In this section we apply the results above to prove
Lemma \ref{lemma-milnor-gersten-low-degree}.
This lemma is a low degree case of the statement
that there is a complex for Milnor K-theory similar
to the Gersten-Quillen complex in Quillen's K-theory.
See Remark \ref{remark-gersten-complex-milnor}.

\begin{lemma}
\label{lemma-perpare-key}
Let $(A, \mathfrak m)$ be a $2$-dimensional Noetherian local ring.
Let $t \in \mathfrak m$ be a nonzerodivisor. Say
$V(t) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_r\}$.
Let $A_{\mathfrak q_i} \subset B_i$ be a finite ring
extension with $B_i/A_{\mathfrak q_i}$ annihilated by a power of
$t$. Then there exists a finite extension $A \subset B$ of
local rings identifying residue fields
with $B_i \cong B_{\mathfrak q_i}$ and $B/A$ annihilated
by a power of $t$.
\end{lemma}

\begin{proof}
Choose $n > 0$ such that $B_i \subset t^{-n}A_{\mathfrak q_i}$.
Let $M \subset t^{-n}A$, resp.\ $M' \subset t^{-2n}A$ be the
$A$-submodule consisting of elements mapping to $B_i$ in
$t^{-n}A_{\mathfrak q_i}$, resp.\ $t^{-2n}A_{\mathfrak q_i}$.
Then $M \subset M'$ are finite $A$-modules as $A$ is Noetherian
and $M_{\mathfrak q_i} = M'_{\mathfrak q_i} = B_i$ as localization
is exact. Thus $M'/M$ is annihilated by $\mathfrak m^c$ for some
$c > 0$. Observe that $M \cdot M \subset M'$ under the multiplication
$t^{-n}A \times t^{-n}A \to t^{-2n}A$. Hence
$B = A + \mathfrak m^{c + 1}M$ is a finite $A$-algebra with the correct
localizations. We omit the verification that $B$ is local with
maximal ideal $\mathfrak m + \mathfrak m^{c + 1}M$.
\end{proof}

\begin{lemma}
\label{lemma-key-nonzerodivisors}
Let $(A, \mathfrak m)$ be a $2$-dimensional Noetherian local ring.
Let $a, b \in A$ be nonzerodivisors.
Then we have
$$
\sum
\text{ord}_{A/\mathfrak q}(\partial_{A_{\mathfrak q}}(a, b))
=
0
$$
where the sum is over the height $1$ primes $\mathfrak q$ of $A$.
\end{lemma}

\begin{proof}
If $\mathfrak q$ is a height $1$ prime of $A$ such that $a, b$
map to a unit of $A_\mathfrak q$, then $\partial_{A_\mathfrak q}(a, b) = 1$.
Thus the sum is finite. In fact, if
$V(ab) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_r\}$
then the sum is over $i = 1, \ldots, r$.
For each $i$ we pick an extension $A_{\mathfrak q_i} \subset B_i$
as in Lemma \ref{lemma-prepare-tame-symbol} for $a, b$.
By Lemma \ref{lemma-perpare-key} with $t = ab$ and the given list of primes
we may assume we have a finite local extension $A \subset B$
with $B/A$ annihilated by a power of $ab$ and such that
for each $i$ the $B_{\mathfrak q_i} \cong B_i$.
Observe that if $\mathfrak q_{i, j}$ are the primes of $B$
lying over $\mathfrak q_i$ then we have
$$
\text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(a, b))
=
\sum\nolimits_j
\text{ord}_{B/\mathfrak q_{i, j}}(\partial_{B_{\mathfrak q_{i, j}}}(a, b))
$$
by Lemma \ref{lemma-norm-down-tame-symbol} and
Algebra, Lemma \ref{algebra-lemma-finite-extension-dim-1}.
Thus we may replace $A$ by $B$ and
reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume for each $i$ there is a nonzerodivisor
$\pi_i \in A_{\mathfrak q_i}$ and units $u_i, v_i \in A_{\mathfrak q_i}$
such that for some integers $e_i, f_i \geq 0$ we have
$$
a = u_i \pi_i^{e_i},\quad b = v_i \pi_i^{f_i}
$$
in $A_{\mathfrak q_i}$. Setting
$m_i = \text{length}_{A_{\mathfrak q_i}}(A_{\mathfrak q_i}/\pi_i)$
we have
$\partial_{A_{\mathfrak q_i}}(a, b) =
((-1)^{e_if_i}u_i^{f_i}v_i^{-e_i})^{m_i}$ by definition.
Since $a, b$ are nonzerodivisors the
$(2, 1)$-periodic complex $(A/(ab), a, b)$ has vanishing cohomology.
Denote $M_i$ the image of $A/(ab)$ in $A_{\mathfrak q_i}/(ab)$.
Then we have a map
$$
A/(ab) \longrightarrow \bigoplus M_i
$$
whose kernel and cokernel are supported in $\{\mathfrak m\}$
and hence have finite length. Thus we see that
$$
\sum e_A(M_i, a, b) = 0
$$
by Lemma \ref{lemma-compare-periodic-lengths}. Hence it suffices to show
$e_A(M_i, a, b) =
- \text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(a, b))$.

\medskip\noindent
Let us prove this first, in case $\pi_i, u_i, v_i$ are the images
of elements $\pi_i, u_i, v_i \in A$ (using the same symbols
should not cause any confusion). In this case we get
\begin{align*}
e_A(M_i, a, b) & =
e_A(M_i, u_i\pi_i^{e_i}, v_i\pi_i^{f_i}) \\
& =
e_A(M_i, \pi_i^{e_i}, \pi_i^{f_i}) -
e_A(\pi_i^{e_i}M_i, 0, u_i) +
e_A(\pi_i^{f_i}M_i, 0, v_i) \\
& =
0 -
f_im_i\text{ord}_{A/\mathfrak q_i}(u_i) +
e_im_i\text{ord}_{A/\mathfrak q_i}(v_i) \\
& =
-m_i\text{ord}_{A/\mathfrak q_i}(u_i^{f_i}v_i^{-e_i}) =
-\text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(a, b))
\end{align*}
The second equality holds by Lemma \ref{lemma-multiply-period-length}.
Observe that
$M_i \subset (M_i)_{\mathfrak q_i} = A_{\mathfrak q_i}/(\pi_i^{e_i + f_i})$
and
$(\pi_i^{e_i}M_i)_{\mathfrak q_i} \cong A_{\mathfrak q_i}/\pi_i^{f_i}$ and
$(\pi_i^{f_i}M_i)_{\mathfrak q_i} \cong A_{\mathfrak q_i}/\pi_i^{e_i}$.
The $0$ in the third equality comes from
Lemma \ref{lemma-powers-period-length-zero}
and the other two terms come from
Lemma \ref{lemma-length-multiplication}.
The last two equalities follow from multiplicativity of
the order function and from the definition of our tame symbol.

\medskip\noindent
In general, we may first choose $c \in A$, $c \not \in \mathfrak q_i$
such that $c\pi_i \in A$. After replacing $\pi_i$ by $c\pi_i$
and $u_i$ by $c^{-e_i}u_i$ and $v_i$ by $c^{-f_i}v_i$
we may and do assume $\pi_i$ is in $A$.
Next, choose an $c \in A$, $c \not \in \mathfrak q_i$
with $cu_i, cv_i \in A$. Then we observe that
$$
e_A(M_i, ca, cb) = e_A(M_i, a, b) - e_A(aM_i, 0, c) + e_A(bM_i, 0, c)
$$
by Lemma \ref{lemma-length-multiplication}.
On the other hand, we have
$$
\partial_{A_{\mathfrak q_i}}(ca, cb) =
c^{m_i(f_i - e_i)}\partial_{A_{\mathfrak q_i}}(a, b)
$$
in $\kappa(\mathfrak q_i)^*$ because $c$ is a unit in $A_{\mathfrak q_i}$.
The arguments in the previous paragraph show that
$e_A(M_i, ca, cb) = -
\text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(ca, cb))$.
Thus it suffices to prove
$$
e_A(aM_i, 0, c) = \text{ord}_{A/\mathfrak q_i}(c^{m_if_i})
\quad\text{and}\quad
e_A(bM_i, 0, c) = \text{ord}_{A/\mathfrak q_i}(c^{m_ie_i})
$$
and this follows from Lemma \ref{lemma-length-multiplication}
by the description (see above)
of what happens when we localize at $\mathfrak q_i$.
\end{proof}

\begin{lemma}[Key Lemma]
\label{lemma-milnor-gersten-low-degree}
\begin{reference}
When $A$ is an excellent ring this is \cite[Proposition 1]{Kato-Milnor-K}.
\end{reference}
Let $A$ be a $2$-dimensional Noetherian local domain with fraction field $K$.
Let $f, g \in K^*$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the height
$1$ primes $\mathfrak q$ of $A$ such that either $f$ or $g$ is not an
element of $A^*_{\mathfrak q}$.
Then we have
$$
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(f, g))
=
0
$$
We can also write this as
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(\partial_{A_{\mathfrak q}}(f, g))
=
0
$$
since at any height $1$ prime $\mathfrak q$
of $A$ where $f, g \in A^*_{\mathfrak q}$
we have $\partial_{A_{\mathfrak q}}(f, g) = 1$.
\end{lemma}

\begin{proof}
Since the tame symbols $\partial_{A_{\mathfrak q}}(f, g)$ are
bilinear and the order functions $\text{ord}_{A/\mathfrak q}$
are additive it suffices to prove the formula when
$f$ and $g$ are elements of $A$. This case is proven in
Lemma \ref{lemma-key-nonzerodivisors}.
\end{proof}

\begin{remark}[Milnor K-theory]
\label{remark-gersten-complex-milnor}
For a field $k$ let us denote $K^M_*(k)$ the quotient of
the tensor algebra on $k^*$ divided by the two-sided ideal
generated by the elements $x \otimes 1 - x$. Thus $K^M_0(k) = \mathbf{Z}$,
$K_1^M(k) = k^*$, and
$$
K^M_2(k) = k^* \otimes_\mathbf{Z} k^* / \langle x \otimes 1 - x \rangle
$$
If $(A, \mathfrak m)$ is a $1$-dimensional Noetherian local domain
with fraction field $Q(A)$ and residue field $\kappa$ there is a
tame symbol
$$
\partial_A : K_{i + 1}^M(Q(A)) \to K_i^M(\kappa(\mathfrak m))
$$
You can use the method of Section \ref{section-tame-symbol}
to define these maps, provided you extend the norm map
to $K_i^M$ for all $i$. Next, let $X$ be a Noetherian scheme with a
dimension function $\delta$. Then we can use these tame symbols
to get the arrows in the following:
$$
\bigoplus\nolimits_{\delta(x) = j + 1} K^M_{i + 1}(\kappa(x))
\longrightarrow
\bigoplus\nolimits_{\delta(x) = j} K^M_i(\kappa(x))
\longrightarrow
\bigoplus\nolimits_{\delta(x) = j - 1} K^M_{i - 1}(\kappa(x))
$$
However, it is not clear, if you define the maps as suggested above,
that the composition is zero. When $i = 1$ and $j$ arbitrary, this
follows from Lemma \ref{lemma-milnor-gersten-low-degree}.
For excellent $X$ this follows from \cite{Kato-Milnor-K}
modulo the verification that Kato's maps are the same as ours.
\end{remark}





















\section{Setup}
\label{section-setup}

\noindent
We will throughout work over a locally Noetherian universally
catenary base $S$ endowed with a dimension function $\delta$.
Although it is likely possible to generalize (parts of) the
discussion in the chapter, it seems that this is a good first
approximation. It is exactly the generality discussed in \cite{Thorup}.
We usually do not assume our schemes are
separated or quasi-compact. Many interesting algebraic stacks
are non-separated and/or non-quasi-compact and this is a good
case study to see how to develop a reasonable theory for those as well.
In order to reference these hypotheses we give it a number.

\begin{situation}
\label{situation-setup}
Here $S$ is a locally Noetherian, and universally catenary scheme.
Moreover, we assume $S$ is endowed with a dimension function
$\delta : S \longrightarrow \mathbf{Z}$.
\end{situation}

\noindent
See Morphisms, Definition \ref{morphisms-definition-universally-catenary}
for the notion of a universally catenary scheme, and see
Topology, Definition \ref{topology-definition-dimension-function}
for the notion of a dimension function. Recall that any locally
Noetherian catenary scheme locally has a dimension function, see
Properties, Lemma \ref{properties-lemma-catenary-dimension-function}.
Moreover, there are lots of schemes which are universally catenary,
see Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Any scheme $X$ locally of finite type over $S$ is locally Noetherian
and catenary. In fact, $X$ has a canonical dimension function
$$
\delta = \delta_{X/S} : X \longrightarrow \mathbf{Z}
$$
associated to $(f : X \to S, \delta)$ given by the rule
$\delta_{X/S}(x) = \delta(f(x)) + \text{trdeg}_{\kappa(f(x))}\kappa(x)$.
See Morphisms, Lemma \ref{morphisms-lemma-dimension-function-propagates}.
Moreover, if $h : X \to Y$ is a morphism of schemes locally of finite
type over $S$, and $x \in X$, $y = h(x)$,
then obviously
$\delta_{X/S}(x) = \delta_{Y/S}(y) + \text{trdeg}_{\kappa(y)}\kappa(x)$.
We will freely use this function and its properties in the following.

\medskip\noindent
Here are the basic examples of setups as above.
In fact, the main interest lies in the case where the base
is the spectrum of a field, or the case where the base
is the spectrum of a Dedekind ring (e.g.\ $\mathbf{Z}$,
or a discrete valuation ring).

\begin{example}
\label{example-field}
Here $S = \Spec(k)$ and $k$ is a field.
We set $\delta(pt) = 0$ where $pt$ indicates the unique point of $S$.
The pair $(S, \delta)$ is an example of a situation as in
Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\begin{example}
\label{example-domain-dimension-1}
Here $S = \Spec(A)$, where $A$ is a Noetherian domain
of dimension $1$.
For example we could consider $A = \mathbf{Z}$.
We set $\delta(\mathfrak p) = 0$ if
$\mathfrak p$ is a maximal ideal and $\delta(\mathfrak p) = 1$
if $\mathfrak p = (0)$ corresponds to the generic point.
This is an example of Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\begin{example}
\label{example-CM-irreducible}
Here $S$ is a Cohen-Macaulay scheme. Then $S$ is universally catenary by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
We set $\delta(s) = -\dim(\mathcal{O}_{S, s})$.
If $s' \leadsto s$ is a nontrivial specialization of points of $S$,
then $\mathcal{O}_{S, s'}$ is the localization of $\mathcal{O}_{S, s}$
at a nonmaximal prime ideal $\mathfrak p \subset \mathcal{O}_{S, s}$, see
Schemes, Lemma \ref{schemes-lemma-specialize-points}.
Thus $\dim(\mathcal{O}_{S, s}) =
\dim(\mathcal{O}_{S, s'}) + \dim(\mathcal{O}_{S, s}/\mathfrak p) >
\dim(\mathcal{O}_{S, s'})$ by
Algebra, Lemma \ref{algebra-lemma-CM-dim-formula}.
Hence $\delta(s') > \delta(s)$. If $s' \leadsto s$ is
an immediate specialization, then there is no prime
ideal strictly between $\mathfrak p$ and $\mathfrak m_s$
and we find $\delta(s') = \delta(s) + 1$. Thus $\delta$
is a dimension function. In other words, the pair $(S, \delta)$
is an example of Situation \ref{situation-setup}.
\end{example}

\noindent
If $S$ is Jacobson and $\delta$ sends closed points to zero, then $\delta$
is the function sending a point to the dimension of its closure.

\begin{lemma}
\label{lemma-delta-is-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Assume in addition $S$ is a Jacobson scheme, and $\delta(s) = 0$ for every
closed point $s$ of $S$. Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be an integral closed subscheme and let
$\xi \in Z$ be its generic point. The following integers are the same:
\begin{enumerate}
\item $\delta_{X/S}(\xi)$,
\item $\dim(Z)$, and
\item $\dim(\mathcal{O}_{Z, z})$ where $z$ is a closed point of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X \to S$, $\xi \in Z \subset X$ be as in the lemma.
Since $X$ is locally of finite type over $S$ we see that
$X$ is Jacobson, see
Morphisms, Lemma \ref{morphisms-lemma-Jacobson-universally-Jacobson}.
Hence closed points of $X$ are dense in every closed subset of $Z$
and map to closed points of $S$. Hence given any chain
of irreducible closed subsets of $Z$ we can end it with a closed point of $Z$.
It follows that $\dim(Z) = \sup_z(\dim(\mathcal{O}_{Z, z})$
(see Properties, Lemma \ref{properties-lemma-codimension-local-ring})
where $z \in Z$ runs over the closed points of $Z$.
Note that $\dim(\mathcal{O}_{Z, z}) = \delta(\xi) - \delta(z)$
by the properties of a dimension function.
For each closed $z \in Z$ the field extension
$\kappa(z) \supset \kappa(f(z))$ is finite, see Morphisms,
Lemma \ref{morphisms-lemma-jacobson-finite-type-points}.
Hence $\delta_{X/S}(z) = \delta(f(z)) = 0$ for $z \in Z$ closed.
It follows that all three integers are equal.
\end{proof}

\noindent
In the situation of the lemma above the
value of $\delta$ at the generic point of a closed irreducible subset
is the dimension of the irreducible closed subset.
However, in general we cannot expect the equality to hold.
For example if $S = \Spec(\mathbf{C}[[t]])$ and
$X = \Spec(\mathbf{C}((t)))$ then we would get
$\delta(x) = 1$ for the unique point of $X$, but $\dim(X) = 0$.
Still we want to think of $\delta_{X/S}$ as giving the
dimension of the irreducible closed subschemes. Thus we introduce
the following terminology.

\begin{definition}
\label{definition-delta-dimension}
Let $(S, \delta)$ as in Situation \ref{situation-setup}.
For any scheme $X$ locally of finite type over $S$
and any irreducible closed subset $Z \subset X$ we define
$$
\dim_\delta(Z) = \delta(\xi)
$$
where $\xi \in Z$ is the generic point of $Z$.
We will call this the {\it $\delta$-dimension of $Z$}.
If $Z$ is a closed subscheme of $X$, then we define
$\dim_\delta(Z)$ as the supremum of the $\delta$-dimensions
of its irreducible components.
\end{definition}







\section{Cycles}
\label{section-cycles}

\noindent
Since we are not assuming our schemes are quasi-compact we have
to be a little careful when defining cycles. We have to allow
infinite sums because a rational function may have infinitely many
poles for example. In any case, if $X$ is quasi-compact then a
cycle is a finite sum as usual.

\begin{definition}
\label{definition-cycles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item A {\it cycle on $X$} is a formal sum
$$
\alpha = \sum n_Z [Z]
$$
where the sum is over integral closed subschemes $Z \subset X$,
each $n_Z \in \mathbf{Z}$, and the collection
$\{Z; n_Z \not = 0\}$ is locally finite
(Topology, Definition \ref{topology-definition-locally-finite}).
\item A {\it $k$-cycle} on $X$ is a cycle
$$
\alpha = \sum n_Z [Z]
$$
where $n_Z \not = 0 \Rightarrow \dim_\delta(Z) = k$.
\item The abelian group of all $k$-cycles on $X$ is denoted $Z_k(X)$.
\end{enumerate}
\end{definition}

\noindent
In other words, a $k$-cycle on $X$
is a locally finite formal $\mathbf{Z}$-linear
combination of integral closed subschemes of $\delta$-dimension $k$.
Addition of $k$-cycles $\alpha = \sum n_Z[Z]$ and
$\beta = \sum m_Z[Z]$ is given by
$$
\alpha + \beta = \sum (n_Z + m_Z)[Z],
$$
i.e., by adding the coefficients.




\section{Cycle associated to a closed subscheme}
\label{section-cycle-of-closed-subscheme}

\begin{lemma}
\label{lemma-multiplicity-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item Let $Z' \subset Z$ be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi} < \infty
$$
\item If $\dim_\delta(Z) \leq k$ and $\xi \in Z$ with
$\delta(\xi) = k$, then $\xi$ is a generic point of an
irreducible component of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $Z' \subset Z$, $\xi \in Z'$ be as in (1).
Then $\dim(\mathcal{O}_{Z, \xi}) = 0$ (for example by
Properties, Lemma \ref{properties-lemma-codimension-local-ring}).
Hence $\mathcal{O}_{Z, \xi}$ is Noetherian
local ring of dimension zero, and hence has finite length over
itself (see
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}).
Hence, it also has finite length over $\mathcal{O}_{X, \xi}$, see
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.

\medskip\noindent
Assume $\xi \in Z$ and $\delta(\xi) = k$.
Consider the closure $Z' = \overline{\{\xi\}}$. It is an irreducible
closed subscheme with $\dim_\delta(Z') = k$ by definition.
Since $\dim_\delta(Z) = k$ it must be an irreducible component
of $Z$. Hence we see (2) holds.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-closed-subscheme}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item For any irreducible component $Z' \subset Z$ with generic point $\xi$
the integer
$m_{Z', Z} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi}$
(Lemma \ref{lemma-multiplicity-finite})
is called the {\it multiplicity of $Z'$ in $Z$}.
\item Assume $\dim_\delta(Z) \leq k$.
The {\it $k$-cycle associated to $Z$} is
$$
[Z]_k
=
\sum m_{Z', Z}[Z']
$$
where the sum is over the irreducible components of $Z$
of $\delta$-dimension $k$. (This is a $k$-cycle by
Divisors, Lemma \ref{divisors-lemma-components-locally-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[Z]_k$ if the $\delta$-dimension
of $Z$ does not exceed $k$. In other words, by convention, if we write
$[Z]_k$ then this implies that $\dim_\delta(Z) \leq k$.



\section{Cycle associated to a coherent sheaf}
\label{section-cycle-of-coherent-sheaf}



\begin{lemma}
\label{lemma-length-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item The collection of irreducible components of the support of
$\mathcal{F}$ is locally finite.
\item Let $Z' \subset \text{Supp}(\mathcal{F})$
be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi < \infty
$$
\item If $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$
and $\xi \in Z$ with $\delta(\xi) = k$, then $\xi$ is a
generic point of an irreducible component of $\text{Supp}(\mathcal{F})$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}
the support $Z$ of $\mathcal{F}$ is a closed subset of $X$.
We may think of $Z$ as a reduced closed subscheme of $X$
(Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
Hence (1) follows from
Divisors, Lemma \ref{divisors-lemma-components-locally-finite} applied to $Z$
and (3) follows from
Lemma \ref{lemma-multiplicity-finite} applied to $Z$.

\medskip\noindent
Let $\xi \in Z'$ be as in (2). In this case for any specialization
$\xi' \leadsto \xi$ in $X$ we have $\mathcal{F}_{\xi'} = 0$.
Recall that the non-maximal primes of $\mathcal{O}_{X, \xi}$ correspond
to the points of $X$ specializing to $\xi$
(Schemes, Lemma \ref{schemes-lemma-specialize-points}).
Hence $\mathcal{F}_\xi$ is a finite $\mathcal{O}_{X, \xi}$-module
whose support is $\{\mathfrak m_\xi\}$. Hence it has finite length
by Algebra, Lemma \ref{algebra-lemma-support-point}.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-coherent-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any irreducible component $Z' \subset \text{Supp}(\mathcal{F})$
with generic point $\xi$ the integer
$m_{Z', \mathcal{F}} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi$
(Lemma \ref{lemma-length-finite})
is called the {\it multiplicity of $Z'$ in $\mathcal{F}$}.
\item Assume $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
The {\it $k$-cycle associated to $\mathcal{F}$} is
$$
[\mathcal{F}]_k
=
\sum m_{Z', \mathcal{F}}[Z']
$$
where the sum is over the irreducible components of
$\text{Supp}(\mathcal{F})$ of $\delta$-dimension $k$.
(This is a $k$-cycle by Lemma \ref{lemma-length-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[\mathcal{F}]_k$
if $\mathcal{F}$ is coherent and the $\delta$-dimension
of $\text{Supp}(\mathcal{F})$ does not exceed $k$. In other words,
by convention, if we write $[\mathcal{F}]_k$ then this implies that
$\mathcal{F}$ is coherent on $X$ and
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-cycle-closed-coherent}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
If $\dim_\delta(Z) \leq k$, then $[Z]_k = [{\mathcal O}_Z]_k$.
\end{lemma}

\begin{proof}
This is because in this case the multiplicities $m_{Z', Z}$ and
$m_{Z', \mathcal{O}_Z}$ agree by definition.
\end{proof}

\begin{lemma}
\label{lemma-additivity-sheaf-cycle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0$
be a short exact sequence of coherent sheaves on $X$.
Assume that the $\delta$-dimension of the supports
of $\mathcal{F}$, $\mathcal{G}$, and $\mathcal{H}$ is $\leq k$.
Then $[\mathcal{G}]_k = [\mathcal{F}]_k + [\mathcal{H}]_k$.
\end{lemma}

\begin{proof}
Follows immediately from additivity of lengths, see
Algebra, Lemma \ref{algebra-lemma-length-additive}.
\end{proof}









\section{Preparation for proper pushforward}
\label{section-preparation-pushforward}

\begin{lemma}
\label{lemma-equal-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $X$, $Y$ integral and $\dim_\delta(X) = \dim_\delta(Y)$.
Then either $f(X)$ is contained in a proper closed subscheme
of $Y$, or $f$ is dominant and the extension of function fields
$R(Y) \subset R(X)$ is finite.
\end{lemma}

\begin{proof}
The closure $\overline{f(X)} \subset Y$ is irreducible as $X$
is irreducible (Topology, Lemmas
\ref{topology-lemma-image-irreducible-space} and
\ref{topology-lemma-irreducible}).
If $\overline{f(X)} \not = Y$, then we are done.
If $\overline{f(X)} = Y$, then $f$ is dominant and by
Morphisms,
Lemma \ref{morphisms-lemma-dominant-finite-number-irreducible-components}
we see that the generic point $\eta_Y$ of $Y$ is in the image of $f$.
Of course this implies that $f(\eta_X) = \eta_Y$, where $\eta_X \in X$
is the generic point of $X$. Since $\delta(\eta_X) = \delta(\eta_Y)$
we see that $R(Y) = \kappa(\eta_Y) \subset \kappa(\eta_X) = R(X)$
is an extension of transcendence degree $0$.
Hence $R(Y) \subset R(X)$ is a finite extension by
Morphisms, Lemma \ref{morphisms-lemma-finite-degree}
(which applies by
Morphisms, Lemma \ref{morphisms-lemma-permanence-finite-type}).
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is quasi-compact, and $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $X$.
Then $\{\overline{f(Z_i)}\}_{i \in I}$ is a locally finite
collection of closed subsets of $Y$.
\end{lemma}

\begin{proof}
Let $V \subset Y$ be a quasi-compact open subset.
Since $f$ is quasi-compact the open $f^{-1}(V)$ is
quasi-compact. Hence the set
$\{i \in I \mid Z_i \cap f^{-1}(V) \not = \emptyset \}$
is finite by a simple topological argument which we omit.
Since this is the same as the set
$$
\{i \in I \mid f(Z_i) \cap V \not = \emptyset \} =
\{i \in I \mid \overline{f(Z_i)} \cap V \not = \emptyset \}
$$
the lemma is proved.
\end{proof}









\section{Proper pushforward}
\label{section-proper-pushforward}

\begin{definition}
\label{definition-proper-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is proper.
\begin{enumerate}
\item Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = k$. We define
$$
f_*[Z] =
\left\{
\begin{matrix}
0 & \text{if} & \dim_\delta(f(Z))< k, \\
\deg(Z/f(Z)) [f(Z)] & \text{if} & \dim_\delta(f(Z)) = k.
\end{matrix}
\right.
$$
Here we think of $f(Z) \subset Y$ as an integral closed subscheme.
The degree of $Z$ over $f(Z)$ is finite if
$\dim_\delta(f(Z)) = \dim_\delta(Z)$
by Lemma \ref{lemma-equal-dimension}.
\item Let $\alpha = \sum n_Z [Z]$ be a $k$-cycle on $X$. The
{\it pushforward} of $\alpha$ as the sum
$$
f_* \alpha = \sum n_Z f_*[Z]
$$
where each $f_*[Z]$ is defined as above. The sum is locally finite
by Lemma \ref{lemma-quasi-compact-locally-finite} above.
\end{enumerate}
\end{definition}

\noindent
By definition the proper pushforward of cycles
$$
f_* : Z_k(X) \longrightarrow Z_k(Y)
$$
is a homomorphism of abelian groups. It turns $X \mapsto Z_k(X)$
into a covariant functor on the category of schemes locally of
finite type over $S$ with morphisms equal to proper morphisms.

\begin{lemma}
\label{lemma-compose-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$, and $Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be proper morphisms.
Then $g_* \circ f_* = (g \circ f)_*$ as maps $Z_k(X) \to Z_k(Z)$.
\end{lemma}

\begin{proof}
Let $W \subset X$ be an integral closed subscheme of dimension $k$.
Consider $W' = f(Z) \subset Y$ and $W'' = g(f(Z)) \subset Z$.
Since $f$, $g$ are proper we see that $W'$ (resp.\ $W''$) is
an integral closed subscheme of $Y$ (resp.\ $Z$).
We have to show that $g_*(f_*[W]) = (f \circ g)_*[W]$.
If $\dim_\delta(W'') < k$, then both sides are zero.
If $\dim_\delta(W'') = k$, then we see the induced morphisms
$$
W \longrightarrow
W' \longrightarrow
W''
$$
both satisfy the hypotheses of Lemma \ref{lemma-equal-dimension}. Hence
$$
g_*(f_*[W]) = \deg(W/W')\deg(W'/W'')[W''],
\quad
(f \circ g)_*[W] = \deg(W/W'')[W''].
$$
Then we can apply
Morphisms, Lemma \ref{morphisms-lemma-degree-composition}
to conclude.
\end{proof}

\noindent
A closed immersion is proper. If $i : Z \to X$ is a closed immersion
then the maps
$$
i_* : Z_k(Z) \longrightarrow Z_k(X)
$$
are all {\it injective}.

\begin{lemma}
\label{lemma-exact-sequence-closed}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let $X_1, X_2 \subset X$
be closed subschemes such that $X = X_1 \cup X_2$ set theoretically.
For every $k \in \mathbf{Z}$ the sequence of abelian groups
$$
\xymatrix{
Z_k(X_1 \cap X_2) \ar[r] &
Z_k(X_1) \oplus Z_k(X_2) \ar[r] &
Z_k(X) \ar[r] &
0
}
$$
is exact. Here $X_1 \cap X_2$ is the scheme theoretic intersection and
the maps are the pushforward maps with one multiplied by $-1$.
\end{lemma}

\begin{proof}
First assume $X$ is quasi-compact. Then $Z_k(X)$ is a free $\mathbf{Z}$-module
with basis given by the elements $[Z]$ where $Z \subset X$ is integral
closed of $\delta$-dimension $k$. The groups
$Z_k(X_1)$, $Z_k(X_2)$, $Z_k(X_1 \cap X_2)$ are free on the subset of these
$Z$ such that $Z \subset X_1$, $Z \subset X_2$, $Z \subset X_1 \cap X_2$.
This immediately proves the lemma in this case. The general case is similar
and the proof is omitted.
\end{proof}

\begin{lemma}
\label{lemma-cycle-push-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a proper morphism of schemes which are
locally of finite type over $S$.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme with $\dim_\delta(Z) \leq k$.
Then
$$
f_*[Z]_k = [f_*{\mathcal O}_Z]_k.
$$
\item Let $\mathcal{F}$ be a coherent sheaf on $X$ such that
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$. Then
$$
f_*[\mathcal{F}]_k = [f_*{\mathcal F}]_k.
$$
\end{enumerate}
Note that the statement makes sense since $f_*\mathcal{F}$ and
$f_*\mathcal{O}_Z$ are coherent $\mathcal{O}_Y$-modules by
Cohomology of Schemes, Proposition
\ref{coherent-proposition-proper-pushforward-coherent}.
\end{lemma}

\begin{proof}
Part (1) follows from (2) and Lemma \ref{lemma-cycle-closed-coherent}.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Assume that $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}
there exists a closed subscheme $i : Z \to X$ and a coherent
$\mathcal{O}_Z$-module $\mathcal{G}$ such that
$i_*\mathcal{G} \cong \mathcal{F}$ and such that the support
of $\mathcal{F}$ is $Z$. Let $Z' \subset Y$ be the scheme theoretic image
of $f|_Z : Z \to Y$. Consider the commutative diagram of schemes
$$
\xymatrix{
Z \ar[r]_i \ar[d]_{f|_Z} &
X \ar[d]^f \\
Z' \ar[r]^{i'} & Y
}
$$
We have $f_*\mathcal{F} = f_*i_*\mathcal{G} = i'_*(f|_Z)_*\mathcal{G}$
by going around the diagram in two ways. Suppose we know the result holds
for closed immersions and for $f|_Z$. Then we see that
$$
f_*[\mathcal{F}]_k = f_*i_*[\mathcal{G}]_k
= (i')_*(f|_Z)_*[\mathcal{G}]_k =
(i')_*[(f|_Z)_*\mathcal{G}]_k =
[(i')_*(f|_Z)_*\mathcal{G}]_k = [f_*\mathcal{F}]_k
$$
as desired. The case of a closed immersion is straightforward (omitted).
Note that $f|_Z : Z \to Z'$ is a dominant morphism (see
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-scheme-theoretic-image}).
Thus we have reduced to the case where
$\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.

\medskip\noindent
Assume $\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.
Since $f$ is dominant, for every irreducible component $Z \subset Y$
with generic point $\eta$ there exists a point $\xi \in X$ such
that $f(\xi) = \eta$. Hence $\delta(\eta) \leq \delta(\xi) \leq k$.
Thus we see that in the expressions
$$
f_*[\mathcal{F}]_k = \sum n_Z[Z],
\quad
\text{and}
\quad
[f_*\mathcal{F}]_k = \sum m_Z[Z].
$$
whenever $n_Z \not = 0$, or $m_Z \not = 0$ the integral closed
subscheme $Z$ is actually an irreducible component of $Y$ of
$\delta$-dimension $k$. Pick such an integral closed subscheme
$Z \subset Y$ and denote $\eta$ its generic point. Note that for
any $\xi \in X$ with $f(\xi) = \eta$ we have $\delta(\xi) \geq k$
and hence $\xi$ is a generic point of an irreducible component
of $X$ of $\delta$-dimension $k$ as well
(see Lemma \ref{lemma-multiplicity-finite}). Since $f$ is quasi-compact
and $X$ is locally Noetherian, there can be only finitely many of
these and hence $f^{-1}(\{\eta\})$ is finite.
By Morphisms, Lemma \ref{morphisms-lemma-generically-finite} there exists
an open neighbourhood $\eta \in V \subset Y$ such that $f^{-1}(V) \to V$
is finite. Replacing $Y$ by $V$ and $X$ by $f^{-1}(V)$ we reduce to the
case where $Y$ is affine, and $f$ is finite.

\medskip\noindent
Write $Y = \Spec(R)$ and $X = \Spec(A)$ (possible as
a finite morphism is affine).
Then $R$ and $A$ are Noetherian rings and $A$ is finite over $R$.
Moreover $\mathcal{F} = \widetilde{M}$ for some finite $A$-module
$M$. Note that $f_*\mathcal{F}$ corresponds to $M$ viewed as an $R$-module.
Let $\mathfrak p \subset R$ be the minimal prime corresponding
to $\eta \in Y$. The coefficient of $Z$ in $[f_*\mathcal{F}]_k$
is clearly $\text{length}_{R_{\mathfrak p}}(M_{\mathfrak p})$.
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the primes of $A$
lying over $\mathfrak p$. Then $A_{\mathfrak p} = \prod A_{\mathfrak q_i}$
since $A_{\mathfrak p}$ is an Artinian ring being finite over the
dimension zero local Noetherian ring $R_{\mathfrak p}$.
Clearly the coefficient of $Z$ in $f_*[\mathcal{F}]_k$ is
$$
\sum\nolimits_{i = 1, \ldots, t}
[\kappa(\mathfrak q_i) : \kappa(\mathfrak p)]
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
$$
Hence the desired equality follows from
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
\end{proof}




















\section{Preparation for flat pullback}
\label{section-preparation-flat-pullback}


\noindent
Recall that a morphism $f : X \to Y$ which is locally of finite type
is said to have relative dimension $r$ if every nonempty fibre
is equidimensional of dimension $r$. See
Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}.

\begin{lemma}
\label{lemma-flat-inverse-image-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
For any closed subset $Z \subset Y$ we have
$$
\dim_\delta(f^{-1}(Z)) = \dim_\delta(Z) + r.
$$
provided $f^{-1}(Z)$ is nonempty.
If $Z$ is irreducible and $Z' \subset f^{-1}(Z)$ is an irreducible
component, then $Z'$ dominates $Z$ and
$\dim_\delta(Z') = \dim_\delta(Z) + r$.
\end{lemma}

\begin{proof}
It suffices to prove the final statement.
We may replace $Y$ by the integral closed subscheme $Z$ and
$X$ by the scheme theoretic inverse image $f^{-1}(Z) = Z \times_Y X$.
Hence we may assume $Z = Y$ is integral and $f$ is a flat morphism
of relative dimension $r$. Since $Y$ is locally Noetherian the
morphism $f$ which is locally of finite type,
is actually locally of finite presentation. Hence
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}
applies and we see that $f$ is open.
Let $\xi \in X$ be a generic point of an irreducible component
of $X$. By the openness of $f$ we see that $f(\xi)$ is the
generic point $\eta$ of $Z = Y$. Note that $\dim_\xi(X_\eta) = r$
by assumption that $f$ has relative dimension $r$. On the other
hand, since $\xi$ is a generic point of $X$ we see that
$\mathcal{O}_{X, \xi} = \mathcal{O}_{X_\eta, \xi}$ has only one
prime ideal and hence has dimension $0$. Thus by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
we conclude that the transcendence
degree of $\kappa(\xi)$ over $\kappa(\eta)$ is $r$.
In other words, $\delta(\xi) = \delta(\eta) + r$ as desired.
\end{proof}

\noindent
Here is the lemma that we will use to prove that the flat pullback
of a locally finite collection of closed subschemes is locally finite.

\begin{lemma}
\label{lemma-inverse-image-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $Y$.
Then $\{f^{-1}(Z_i)\}_{i \in I}$ is a locally finite
collection of closed subsets of $X$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be a quasi-compact open subset.
Since the image $f(U) \subset Y$ is a quasi-compact subset
there exists a quasi-compact open $V \subset Y$ such that
$f(U) \subset V$. Note that
$$
\{i \in I \mid f^{-1}(Z_i) \cap U \not = \emptyset \}
\subset
\{i \in I \mid Z_i \cap V \not = \emptyset \}.
$$
Since the right hand side is finite by assumption we win.
\end{proof}



\section{Flat pullback}
\label{section-flat-pullback}

\noindent
In the following we use $f^{-1}(Z)$ to denote the
{\it scheme theoretic inverse image} of a closed subscheme
$Z \subset Y$ for a morphism of schemes $f : X \to Y$.
We recall that the scheme theoretic inverse image is the fibre product
$$
\xymatrix{
f^{-1}(Z) \ar[r] \ar[d] & X \ar[d] \\
Z \ar[r] & Y
}
$$
and it is also the closed subscheme of $X$ cut out by the
quasi-coherent sheaf of ideals $f^{-1}(\mathcal{I})\mathcal{O}_X$, if
$\mathcal{I} \subset \mathcal{O}_Y$ is the quasi-coherent sheaf of ideals
corresponding to $Z$ in $Y$.
(This is discussed in
Schemes, Section \ref{schemes-section-closed-immersion} and
Lemma \ref{schemes-lemma-fibre-product-immersion}
and Definition \ref{schemes-definition-inverse-image-closed-subscheme}.)

\begin{definition}
\label{definition-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be an integral closed subscheme of
$\delta$-dimension $k$. We define $f^*[Z]$ to be the
$(k+r)$-cycle on $X$ to the scheme theoretic inverse image
$$
f^*[Z] = [f^{-1}(Z)]_{k+r}.
$$
This makes sense since $\dim_\delta(f^{-1}(Z)) = k + r$
by Lemma \ref{lemma-flat-inverse-image-dimension}.
\item Let $\alpha = \sum n_i [Z_i]$ be
a $k$-cycle on $Y$. The {\it flat pullback of $\alpha$ by $f$}
is the sum
$$
f^* \alpha = \sum n_i f^*[Z_i]
$$
where each $f^*[Z_i]$ is defined as above.
The sum is locally finite by Lemma \ref{lemma-inverse-image-locally-finite}.
\item We denote $f^* : Z_k(Y) \to Z_{k + r}(X)$ the map of abelian
groups so obtained.
\end{enumerate}
\end{definition}

\noindent
An open immersion is flat. This is an important though trivial special
case of a flat morphism. If $U \subset X$ is open then sometimes the
pullback by $j : U \to X$ of a cycle is called the {\it restriction} of the
cycle to $U$. Note that in this case the maps
$$
j^* : Z_k(X) \longrightarrow Z_k(U)
$$
are all {\it surjective}. The reason is that given any integral closed
subscheme $Z' \subset U$, we can take the closure of $Z$ of $Z'$ in $X$
and think of it as a reduced closed subscheme of $X$ (see
Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
And clearly $Z \cap U = Z'$, in other words
$j^*[Z] = [Z']$ whence the surjectivity. In fact a little bit more
is true.

\begin{lemma}
\label{lemma-exact-sequence-open}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
For every $k \in \mathbf{Z}$ the sequence
$$
\xymatrix{
Z_k(Y) \ar[r]^{i_*} & Z_k(X) \ar[r]^{j^*} & Z_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
First assume $X$ is quasi-compact. Then $Z_k(X)$ is a free $\mathbf{Z}$-module
with basis given by the elements $[Z]$ where $Z \subset X$ is integral
closed of $\delta$-dimension $k$. Such a basis element maps
either to the basis element $[Z \cap U]$ or to zero if $Z \subset Y$.
Hence the lemma is clear in this case. The general case is similar
and the proof is omitted.
\end{proof}

\begin{lemma}
\label{lemma-compose-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X, Y, Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be flat morphisms of relative dimensions
$r$ and $s$. Then $g \circ f$ is flat of relative dimension
$r + s$ and
$$
f^* \circ g^* = (g \circ f)^*
$$
as maps $Z_k(Z) \to Z_{k + r + s}(X)$.
\end{lemma}

\begin{proof}
The composition is flat of relative dimension $r + s$ by
Morphisms, Lemma \ref{morphisms-lemma-composition-relative-dimension-d}.
Suppose that
\begin{enumerate}
\item $W \subset Z$ is a closed integral subscheme of $\delta$-dimension $k$,
\item $W' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s$ with $W' \subset g^{-1}(W)$, and
\item $W'' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s + r$ with $W'' \subset f^{-1}(W')$.
\end{enumerate}
We have to show that the coefficient $n$ of $[W'']$ in
$(g \circ f)^*[W]$ agrees with the coefficient $m$ of
$[W'']$ in $f^*(g^*[W])$. That it suffices to check the lemma in these
cases follows from Lemma \ref{lemma-flat-inverse-image-dimension}.
Let $\xi'' \in W''$, $\xi' \in W'$
and $\xi \in W$ be the generic points. Consider the local rings
$A = \mathcal{O}_{Z, \xi}$, $B = \mathcal{O}_{Y, \xi'}$
and $C = \mathcal{O}_{X, \xi''}$. Then we have local flat ring maps
$A \to B$, $B \to C$ and moreover
$$
n = \text{length}_C(C/\mathfrak m_AC),
\quad
\text{and}
\quad
m = \text{length}_C(C/\mathfrak m_BC) \text{length}_B(B/\mathfrak m_AB)
$$
Hence the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-transitive}.
\end{proof}

\begin{lemma}
\label{lemma-pullback-coherent}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be a closed subscheme with
$\dim_\delta(Z) \leq k$. Then we have
$\dim_\delta(f^{-1}(Z)) \leq k + r$
and $[f^{-1}(Z)]_{k + r} = f^*[Z]_k$ in $Z_{k + r}(X)$.
\item Let $\mathcal{F}$ be a coherent sheaf on $Y$ with
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
Then we have $\dim_\delta(\text{Supp}(f^*\mathcal{F})) \leq k + r$
and
$$
f^*[{\mathcal F}]_k = [f^*{\mathcal F}]_{k+r}
$$
in $Z_{k + r}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The statements on dimensions follow immediately from
Lemma \ref{lemma-flat-inverse-image-dimension}.
Part (1) follows from part (2) by Lemma \ref{lemma-cycle-closed-coherent}
and the fact that $f^*\mathcal{O}_Z = \mathcal{O}_{f^{-1}(Z)}$.

\medskip\noindent
Proof of (2).
As $X$, $Y$ are locally Noetherian we may apply
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} to see
that $\mathcal{F}$ is of finite type, hence $f^*\mathcal{F}$ is
of finite type (Modules, Lemma \ref{modules-lemma-pullback-finite-type}),
hence $f^*\mathcal{F}$ is coherent
(Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} again).
Thus the lemma makes sense. Let $W \subset Y$ be an integral closed
subscheme of $\delta$-dimension $k$, and let $W' \subset X$ be
an integral closed subscheme of dimension $k + r$ mapping into $W$
under $f$. We have to show that the coefficient $n$ of
$[W']$ in $f^*[{\mathcal F}]_k$ agrees with the coefficient
$m$ of $[W']$ in $[f^*{\mathcal F}]_{k+r}$. Let $\xi \in W$ and
$\xi' \in W'$ be the generic points. Let
$A = \mathcal{O}_{Y, \xi}$, $B = \mathcal{O}_{X, \xi'}$
and set $M = \mathcal{F}_\xi$ as an $A$-module. (Note that
$M$ has finite length by our dimension assumptions, but we
actually do not need to verify this. See
Lemma \ref{lemma-length-finite}.)
We have $f^*\mathcal{F}_{\xi'} = B \otimes_A M$.
Thus we see that
$$
n = \text{length}_B(B \otimes_A M)
\quad
\text{and}
\quad
m = \text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
$$
Thus the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-module}.
\end{proof}



\section{Push and pull}
\label{section-push-pull}

\noindent
In this section we verify that proper pushforward and flat pullback
are compatible when this makes sense. By the work we did above this
is a consequence of cohomology and base change.

\begin{lemma}
\label{lemma-flat-pullback-proper-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
be a fibre product diagram of schemes locally of finite type over $S$.
Assume $f : X \to Y$ proper and $g : Y' \to Y$ flat of relative dimension $r$.
Then also $f'$ is proper and $g'$ is flat of relative dimension $r$.
For any $k$-cycle $\alpha$ on $X$ we have
$$
g^*f_*\alpha = f'_*(g')^*\alpha
$$
in $Z_{k + r}(Y')$.
\end{lemma}

\begin{proof}
The assertion that $f'$ is proper follows from
Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}.
The assertion that $g'$ is flat of relative dimension $r$ follows from
Morphisms, Lemmas \ref{morphisms-lemma-base-change-relative-dimension-d}
and \ref{morphisms-lemma-base-change-flat}.
It suffices to prove the equality of cycles when $\alpha = [W]$
for some integral closed subscheme $W \subset X$ of $\delta$-dimension $k$.
Note that in this case we have $\alpha = [\mathcal{O}_W]_k$, see
Lemma \ref{lemma-cycle-closed-coherent}.
By Lemmas \ref{lemma-cycle-push-sheaf} and
\ref{lemma-pullback-coherent} it therefore suffices
to show that $f'_*(g')^*\mathcal{O}_W$ is isomorphic to
$g^*f_*\mathcal{O}_W$. This follows from cohomology and
base change, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-finite-flat}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a finite locally free morphism
of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Then $f$ is both proper and flat of relative dimension $0$, and
$$
f_*f^*\alpha = d\alpha
$$
for every $\alpha \in Z_k(Y)$.
\end{lemma}

\begin{proof}
A finite locally free morphism is flat and finite by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat},
and a finite morphism is proper
by Morphisms, Lemma \ref{morphisms-lemma-finite-proper}.
We omit showing that a finite
morphism has relative dimension $0$. Thus the formula makes sense.
To prove it, let $Z \subset Y$ be an integral closed subscheme
of $\delta$-dimension $k$. It suffices to prove the formula
for $\alpha = [Z]$. Since the base change of a finite locally free
morphism is finite locally free
(Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-locally-free})
we see that $f_*f^*\mathcal{O}_Z$ is a finite locally free sheaf of
rank $d$ on $Z$. Hence
$$
f_*f^*[Z] = f_*f^*[\mathcal{O}_Z]_k =
[f_*f^*\mathcal{O}_Z]_k = d[Z]
$$
where we have used Lemmas \ref{lemma-pullback-coherent} and
\ref{lemma-cycle-push-sheaf}.
\end{proof}








\section{Preparation for principal divisors}
\label{section-preparation-principal-divisors}

\noindent
Some of the material in this section partially overlaps with the
discussion in Divisors, Section \ref{divisors-section-Weil-divisors}.

\begin{lemma}
\label{lemma-divisor-delta-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral.
\begin{enumerate}
\item If $Z \subset X$ is an integral closed subscheme, then
the following are equivalent:
\begin{enumerate}
\item $Z$ is a prime divisor,
\item $Z$ has codimension $1$ in $X$, and
\item $\dim_\delta(Z) = \dim_\delta(X) - 1$.
\end{enumerate}
\item If $Z$ is an irreducible component of an effective Cartier
divisor on $X$, then $\dim_\delta(Z) = \dim_\delta(X) - 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from the definition of a prime divisor
(Divisors, Definition \ref{divisors-definition-Weil-divisor})
and the definition of a dimension function
(Topology, Definition \ref{topology-definition-dimension-function}).
Let $\xi \in Z$ be the generic point of an irreducible component $Z$ of
an effective Cartier divisor $D \subset X$.
Then $\dim(\mathcal{O}_{D, \xi}) = 0$ and
$\mathcal{O}_{D, \xi} = \mathcal{O}_{X, \xi}/(f)$ for some
nonzerodivisor $f \in \mathcal{O}_{X, \xi}$ (Divisors,
Lemma \ref{divisors-lemma-effective-Cartier-in-points}).
Then $\dim(\mathcal{O}_{X, \xi}) = 1$ by
Algebra, Lemma \ref{algebra-lemma-one-equation}. Hence $Z$ is as in (1) by
Properties, Lemma \ref{properties-lemma-codimension-local-ring}
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-finite-in-codimension-one}
Let $f : X \to Y$ be a morphism of schemes.
Let $\xi \in Y$ be a point.
Assume that
\begin{enumerate}
\item $X$, $Y$ are integral,
\item $Y$ is locally Noetherian
\item $f$ is proper, dominant and $R(X) \subset R(Y)$ is finite, and
\item $\dim(\mathcal{O}_{Y, \xi}) = 1$.
\end{enumerate}
Then there exists an open neighbourhood $V \subset Y$ of $\xi$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
This lemma is a special case of
Varieties, Lemma \ref{varieties-lemma-finite-in-codim-1}.
Here is a direct argument in this case.
By Cohomology of Schemes,
Lemma \ref{coherent-lemma-proper-finite-fibre-finite-in-neighbourhood}
it suffices to prove that $f^{-1}(\{\xi\})$ is finite.
We replace $Y$ by an affine open, say $Y = \Spec(R)$.
Note that $R$ is Noetherian, as $Y$ is assumed locally Noetherian.
Since $f$ is proper it is quasi-compact. Hence we can find a finite
affine open covering $X = U_1 \cup \ldots \cup U_n$ with
each $U_i = \Spec(A_i)$. Note that $R \to A_i$ is a
finite type injective homomorphism of domains such that
the induced extension of fraction fields is finite.
Thus the lemma follows
from Algebra, Lemma \ref{algebra-lemma-finite-in-codim-1}.
\end{proof}


\section{Principal divisors}
\label{section-principal-divisors}

\noindent
The following definition is the analogue of
Divisors, Definition \ref{divisors-definition-principal-divisor}
in our current setup.

\begin{definition}
\label{definition-principal-divisor}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral with $\dim_\delta(X) = n$.
Let $f \in R(X)^*$. The {\it principal divisor
associated to $f$} is the $(n - 1)$-cycle
$$
\text{div}(f) = \text{div}_X(f) = \sum \text{ord}_Z(f) [Z]
$$
defined in Divisors, Definition \ref{divisors-definition-principal-divisor}.
This makes sense because prime divisors have $\delta$-dimension $n - 1$ by
Lemma \ref{lemma-divisor-delta-dimension}.
\end{definition}

\noindent
In the situation of the definition for $f, g \in R(X)^*$ we have
$$
\text{div}_X(fg) = \text{div}_X(f) + \text{div}_X(g)
$$
in $Z_{n - 1}(X)$. See Divisors, Lemma \ref{divisors-lemma-div-additive}.
The following lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-rational-equivalence}.

\begin{lemma}
\label{lemma-flat-pullback-principal-divisor}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $g \in R(Y)^*$. Then
$$
f^*(\text{div}_Y(g)) = \text{div}_X(g)
$$
in $Z_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Note that since $f$ is flat it is dominant so that
$f$ induces an embedding $R(Y) \subset R(X)$, and hence
we may think of $g$ as an element of $R(X)^*$.
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n + r - 1$. Let $\xi \in Z$
be its generic point. If $\dim_\delta(f(Z)) > n - 1$,
then we see that the coefficient of $[Z]$ in the left and
right hand side of the equation is zero.
Hence we may assume that $Z' = \overline{f(Z)}$ is an
integral closed subscheme of $Y$ of $\delta$-dimension $n - 1$.
Let $\xi' = f(\xi)$. It is the generic point of $Z'$.
Set $A = \mathcal{O}_{Y, \xi'}$, $B = \mathcal{O}_{X, \xi}$.
The ring map $A \to B$ is a flat local homomorphism of
Noetherian local domains of dimension $1$.
We have $g$ in the fraction field of $A$. What we have to show is that
$$
\text{ord}_A(g) \text{length}_B(B/\mathfrak m_AB)
=
\text{ord}_B(g).
$$
This follows from Algebra, Lemma \ref{algebra-lemma-pullback-module}
(details omitted).
\end{proof}











\section{Principal divisors and pushforward}
\label{section-two-fun}

\noindent
The first lemma implies that the pushforward of a principal
divisor along a generically finite morphism is a principal divisor.

\begin{lemma}
\label{lemma-proper-pushforward-alteration}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(X) = \dim_\delta(Y)$.
Let $p : X \to Y$ be a dominant proper morphism.
Let $f \in R(X)^*$. Set
$$
g = \text{Nm}_{R(X)/R(Y)}(f).
$$
Then we have
$p_*\text{div}(f) = \text{div}(g)$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be an integral closed subscheme of $\delta$-dimension
$n - 1$. We want to show that the coefficient of $[Z]$ in
$p_*\text{div}(f)$ and $\text{div}(g)$ are equal. We may apply
Lemma \ref{lemma-finite-in-codimension-one}
to the morphism $p : X \to Y$ and the generic point $\xi \in Z$.
Hence we may replace $Y$ by an
affine open neighbourhood of $\xi$ and assume that $p : X \to Y$ is finite.
Write $Y = \Spec(R)$ and $X = \Spec(A)$ with $p$ induced
by a finite homomorphism $R \to A$ of Noetherian domains which induces
an finite field extension $L/K$ of fraction fields.
Now we have $f \in L$, $g = \text{Nm}(f) \in K$,
and a prime $\mathfrak p \subset R$ with $\dim(R_{\mathfrak p}) = 1$.
The coefficient of $[Z]$ in $\text{div}_Y(g)$ is
$\text{ord}_{R_\mathfrak p}(g)$.
The coefficient of $[Z]$ in $p_*\text{div}_X(f)$ is
$$
\sum\nolimits_{\mathfrak q\text{ lying over }\mathfrak p}
[\kappa(\mathfrak q) : \kappa(\mathfrak p)]
\text{ord}_{A_{\mathfrak q}}(f)
$$
The desired equality therefore follows from
Algebra, Lemma \ref{algebra-lemma-finite-extension-dim-1}.
\end{proof}

\noindent
An important role in the discussion of principal divisors
is played by the ``universal'' principal divisor $[0] - [\infty]$
on $\mathbf{P}^1_S$. To make this more precise, let us denote
\begin{equation}
\label{equation-zero-infty}
D_0, D_\infty \subset
\mathbf{P}^1_S = \underline{\text{Proj}}_S(\mathcal{O}_S[T_0, T_1])
\end{equation}
the closed subscheme cut out by the section $T_1$, resp.\ $T_0$
of $\mathcal{O}(1)$. These are effective Cartier divisors, see
Divisors, Definition \ref{divisors-definition-effective-Cartier-divisor}
and Lemma \ref{divisors-lemma-characterize-OD}.
The following lemma says that loosely speaking we have
``$\text{div}(T_1/T_0) = [D_0] - [D_1]$'' and that this is the
universal principal divisor.

\begin{lemma}
\label{lemma-rational-function}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$. Let $f \in R(X)^*$.
Let $U \subset X$ be a nonempty open such that $f$
corresponds to a section $f \in \Gamma(U, \mathcal{O}_X^*)$.
Let $Y \subset X \times_S \mathbf{P}^1_S$ be the
closure of the graph of $f : U \to \mathbf{P}^1_S$.
Then
\begin{enumerate}
\item the projection morphism $p : Y \to X$ is proper,
\item $p|_{p^{-1}(U)} : p^{-1}(U) \to U$ is an isomorphism,
\item the pullbacks $Y_0 = q^{-1}D_0$ and $Y_\infty = q^{-1}D_\infty$
via the morphism $q : Y \to \mathbf{P}^1_S$ are defined
(Divisors, Definition
\ref{divisors-definition-pullback-effective-Cartier-divisor}),
\item we have
$$
\text{div}_Y(f) = [Y_0]_{n - 1} - [Y_\infty]_{n - 1}
$$
\item we have
$$
\text{div}_X(f) = p_*\text{div}_Y(f)
$$
\item if we view $Y_0$ and $Y_\infty$ as closed subschemes of $X$
via the morphism $p$ then we have
$$
\text{div}_X(f) = [Y_0]_{n - 1} - [Y_\infty]_{n - 1}
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Since $X$ is integral, we see that $U$ is integral.
Hence $Y$ is integral, and $(1, f)(U) \subset Y$ is an open dense subscheme.
Also, note that the closed subscheme $Y \subset X \times_S \mathbf{P}^1_S$
does not depend on the choice of the open $U$, since after all it is
the closure of the one point set $\{\eta'\} = \{(1, f)(\eta)\}$
where $\eta \in X$ is the generic point. Having said this let us
prove the assertions of the lemma.

\medskip\noindent
For (1) note that $p$ is the composition of the closed immersion
$Y \to X \times_S \mathbf{P}^1_S = \mathbf{P}^1_X$ with the proper
morphism $\mathbf{P}^1_X \to X$. As a composition of proper morphisms
is proper (Morphisms, Lemma \ref{morphisms-lemma-composition-proper})
we conclude.

\medskip\noindent
It is clear that $Y \cap U \times_S \mathbf{P}^1_S = (1, f)(U)$.
Thus (2) follows. It also follows that $\dim_\delta(Y) = n$.

\medskip\noindent
Note that $q(\eta') = f(\eta)$ is not contained in $D_0$ or $D_\infty$
since $f \in R(X)^*$. Hence (3) by
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}.
We obtain $\dim_\delta(Y_0) = n - 1$
and $\dim_\delta(Y_\infty) = n - 1$ from
Lemma \ref{lemma-divisor-delta-dimension}.

\medskip\noindent
Consider the effective Cartier divisor $Y_0$.
At every point $\xi \in Y_0$ we have $f \in \mathcal{O}_{Y, \xi}$ and
the local equation for $Y_0$ is given by $f$.
In particular, if $\delta(\xi) = n - 1$ so $\xi$ is the generic point
of a integral closed subscheme $Z$ of $\delta$-dimension $n - 1$,
then we see that the coefficient of $[Z]$ in $\text{div}_Y(f)$ is
$$
\text{ord}_Z(f) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{Y, \xi}/f\mathcal{O}_{Y, \xi}) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{Y_0, \xi})
$$
which is the coefficient of $[Z]$ in $[Y_0]_{n - 1}$. A similar
argument using the rational function $1/f$ shows that
$-[Y_\infty]$ agrees with the terms with negative coefficients in
the expression for $\text{div}_Y(f)$. Hence (4) follows.

\medskip\noindent
Note that $D_0 \to S$ is an isomorphism. Hence we see that
$X \times_S D_0 \to X$ is an isomorphism as well. Clearly
we have $Y_0 = Y \cap X \times_S D_0$ (scheme theoretic intersection)
inside $X \times_S \mathbf{P}^1_S$. Hence it is really the case that
$Y_0 \to X$ is a closed immersion. It follows that
$$
p_*\mathcal{O}_{Y_0} = \mathcal{O}_{Y'_0}
$$
where $Y'_0 \subset X$ is the image of $Y_0 \to X$.
By Lemma \ref{lemma-cycle-push-sheaf} we
have $p_*[Y_0]_{n - 1} = [Y'_0]_{n - 1}$. The same
is true for $D_\infty$ and $Y_\infty$. Hence (6) is a consequence of (5).
Finally, (5) follows immediately from
Lemma \ref{lemma-proper-pushforward-alteration}.
\end{proof}

\noindent
The following lemma says that the degree of a principal divisor on
a proper curve is zero.

\begin{lemma}
\label{lemma-curve-principal-divisor}
Let $K$ be any field. Let $X$ be a $1$-dimensional integral scheme
endowed with a proper morphism $c : X \to \Spec(K)$.
Let $f \in K(X)^*$ be an invertible rational function.
Then
$$
\sum\nolimits_{x \in X \text{ closed}}
[\kappa(x) : K] \text{ord}_{\mathcal{O}_{X, x}}(f)
=
0
$$
where $\text{ord}$ is as in
Algebra, Definition \ref{algebra-definition-ord}.
In other words, $c_*\text{div}(f) = 0$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
Y \ar[r]_p \ar[d]_q & X \ar[d]^c \\
\mathbf{P}^1_K \ar[r]^-{c'} & \Spec(K)
}
$$
that we constructed in Lemma \ref{lemma-rational-function}
starting with $X$ and the rational function $f$ over $S = \Spec(K)$.
We will use all the results of this lemma without further mention.
We have to show that $c_*\text{div}_X(f) = c_*p_*\text{div}_Y(f) = 0$.
This is the same as proving that $c'_*q_*\text{div}_Y(f) = 0$.
If $q(Y)$ is a closed point of $\mathbf{P}^1_K$ then we
see that $\text{div}_X(f) = 0$ and the lemma holds.
Thus we may assume that $q$ is dominant.
Suppose we can show that $q : Y \to \mathbf{P}^1_K$ is finite
locally free of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Since $\text{div}_Y(f) = [q^{-1}D_0]_0 - [q^{-1}D_\infty]_0$
we see (by definition of flat pullback) that
$\text{div}_Y(f) = q^*([D_0]_0 - [D_\infty]_0)$.
Then by Lemma \ref{lemma-finite-flat} we get
$q_*\text{div}_Y(f) = d([D_0]_0 - [D_\infty]_0)$.
Since clearly $c'_*[D_0]_0 = c'_*[D_\infty]_0$ we win.

\medskip\noindent
It remains to show that $q$ is finite locally free.
(It will automatically have some given degree as $\mathbf{P}^1_K$
is connected.)
Since $\dim(\mathbf{P}^1_K) = 1$ we see that $q$ is finite for example
by Lemma \ref{lemma-finite-in-codimension-one}.
All local rings of $\mathbf{P}^1_K$ at
closed points are regular local rings of dimension $1$
(in other words discrete valuation rings), since they are
localizations of $K[T]$ (see
Algebra, Lemma \ref{algebra-lemma-dim-affine-space}).
Hence for $y\in Y$ closed the local ring $\mathcal{O}_{Y, y}$
will be flat over $\mathcal{O}_{\mathbf{P}^1_K, q(y)}$ as soon as
it is torsion free (More on Algebra, Lemma
\ref{more-algebra-lemma-dedekind-torsion-free-flat}).
This is obviously the case as
$\mathcal{O}_{Y, y}$ is a domain and $q$ is dominant.
Thus $q$ is flat. Hence $q$ is finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
\end{proof}





\section{Rational equivalence}
\label{section-rational-equivalence}

\noindent
In this section we define {\it rational equivalence} on $k$-cycles.
We will allow locally finite sums of images of
principal divisors (under closed immersions). This leads to some
pretty strange phenomena, see Example \ref{example-weird}.
However, if we do not allow these then we do not know how to prove that
capping with chern classes of line bundles factors through rational
equivalence.

\begin{definition}
\label{definition-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item Given any locally finite collection $\{W_j \subset X\}$
of integral closed subschemes with $\dim_\delta(W_j) = k + 1$,
and any $f_j \in R(W_j)^*$ we may consider
$$
\sum (i_j)_*\text{div}(f_j) \in Z_k(X)
$$
where $i_j : W_j \to X$ is the inclusion morphism.
This makes sense as the morphism
$\coprod i_j : \coprod W_j \to X$ is proper.
\item We say that $\alpha \in Z_k(X)$ is {\it rationally equivalent to zero}
if $\alpha$ is a cycle of the form displayed above.
\item We say $\alpha, \beta \in Z_k(X)$ are
{\it rationally equivalent} and we write $\alpha \sim_{rat} \beta$
if $\alpha - \beta$ is rationally equivalent to zero.
\item We define
$$
\CH_k(X) = Z_k(X) / \sim_{rat}
$$
to be the {\it Chow group of $k$-cycles on $X$}. This is sometimes called
the {\it Chow group of $k$-cycles modulo rational equivalence on $X$}.
\end{enumerate}
\end{definition}

\noindent
There are many other interesting (adequate) equivalence relations.
Rational equivalence is the coarsest one of them all.
A very simple but important lemma is the following.

\begin{lemma}
\label{lemma-restrict-to-open}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
Let $k \in \mathbf{Z}$.
Suppose $\alpha, \beta \in Z_k(X)$.
If $\alpha|_U \sim_{rat} \beta|_U$ then there exist a cycle
$\gamma \in Z_k(Y)$ such that
$$
\alpha \sim_{rat} \beta + i_*\gamma.
$$
In other words, the sequence
$$
\xymatrix{
\CH_k(Y) \ar[r]^{i_*} & \CH_k(X) \ar[r]^{j^*} & \CH_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be a locally finite collection of integral closed
subschemes of $U$ of $\delta$-dimension $k + 1$, and let $f_j \in R(W_j)^*$
be elements such that $(\alpha - \beta)|_U = \sum (i_j)_*\text{div}(f_j)$
as in the definition. Set $W_j' \subset X$ equal
to the closure of $W_j$. Suppose that $V \subset X$ is a quasi-compact
open. Then also $V \cap U$ is quasi-compact open in $U$ as
$V$ is Noetherian. Hence the set
$\{j \in J \mid W_j \cap V \not = \emptyset\}
= \{j \in J \mid W'_j \cap V \not = \emptyset\}$
is finite since $\{W_j\}$ is locally finite. In other words we see that
$\{W'_j\}$ is also locally finite. Since $R(W_j) = R(W'_j)$ we see
that
$$
\alpha - \beta - \sum (i'_j)_*\text{div}(f_j)
$$
is a cycle supported on $Y$ and the lemma follows (see
Lemma \ref{lemma-exact-sequence-open}).
\end{proof}

\begin{lemma}
\label{lemma-exact-sequence-closed-chow}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let $X_1, X_2 \subset X$
be closed subschemes such that $X = X_1 \cup X_2$ set theoretically.
For every $k \in \mathbf{Z}$ the sequence of abelian groups
$$
\xymatrix{
\CH_k(X_1 \cap X_2) \ar[r] &
\CH_k(X_1) \oplus \CH_k(X_2) \ar[r] &
\CH_k(X) \ar[r] &
0
}
$$
is exact. Here $X_1 \cap X_2$ is the scheme theoretic intersection and the
maps are the pushforward maps with one multiplied by $-1$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-exact-sequence-closed} the arrow
$\CH_k(X_1) \oplus \CH_k(X_2) \to \CH_k(X)$ is surjective.
Suppose that $(\alpha_1, \alpha_2)$ maps to zero under this map.
Write $\alpha_1 = \sum n_{1, i}[W_{1, i}]$ and
$\alpha_2 = \sum n_{2, i}[W_{2, i}]$. Then we obtain a locally
finite collection $\{W_j\}_{j \in J}$ of integral closed
subschemes of $X$ of $\delta$-dimension $k + 1$ and $f_j \in R(W_j)^*$
such that
$$
\sum n_{1, i}[W_{1, i}] + \sum n_{2, i}[W_{2, i}] = \sum (i_j)_*\text{div}(f_j)
$$
as cycles on $X$ where $i_j : W_j \to X$ is the inclusion morphism.
Choose a disjoint union decomposition $J = J_1 \amalg J_2$ such that
$W_j \subset X_1$ if $j \in J_1$ and $W_j \subset X_2$ if $j \in J_2$.
(This is possible because the $W_j$ are integral.) Then we can write
the equation above as
$$
\sum n_{1, i}[W_{1, i}] - \sum\nolimits_{j \in J_1} (i_j)_*\text{div}(f_j) =
- \sum n_{2, i}[W_{2, i}] + \sum\nolimits_{j \in J_2} (i_j)_*\text{div}(f_j)
$$
Hence this expression is a cycle (!) on $X_1 \cap X_2$. In other words
the element $(\alpha_1, \alpha_2)$ is in the image of the first arrow
and the proof is complete.
\end{proof}

\begin{example}
\label{example-weird}
Here is a ``strange'' example.
Suppose that $S$ is the spectrum of a field $k$
with $\delta$ as in Example \ref{example-field}.
Suppose that $X = C_1 \cup C_2 \cup \ldots$ is an infinite
union of curves $C_j \cong \mathbf{P}^1_k$ glued together
in the following way: The point $\infty \in C_j$ is glued
transversally to the point $0 \in C_{j + 1}$ for $j = 1, 2, 3, \ldots$.
Take the point $0 \in C_1$. This gives a zero cycle
$[0] \in Z_0(X)$. The ``strangeness'' in this situation is
that actually $[0] \sim_{rat} 0$! Namely we can choose
the rational function $f_j \in R(C_j)$ to be the function
which has a simple zero at $0$ and a simple pole at $\infty$
and no other zeros or poles. Then we see that the sum
$\sum (i_j)_*\text{div}(f_j)$ is exactly the $0$-cycle
$[0]$. In fact it turns out that $\CH_0(X) = 0$ in this example.
If you find this too bizarre, then you can just
make sure your spaces are always quasi-compact
(so $X$ does not even exist for you).
\end{example}

\begin{remark}
\label{remark-infinite-sums-rational-equivalences}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose we have infinite collections $\alpha_i, \beta_i \in Z_k(X)$,
$i \in I$ of $k$-cycles on $X$. Suppose that the supports
of $\alpha_i$ and $\beta_i$ form locally finite collections
of closed subsets of $X$ so that $\sum \alpha_i$
and $\sum \beta_i$ are defined as cycles. Moreover, assume that
$\alpha_i \sim_{rat} \beta_i$ for each $i$. Then it is not
clear that $\sum \alpha_i \sim_{rat} \sum \beta_i$. Namely,
the problem is that the rational equivalences may be
given by locally finite
families $\{W_{i, j}, f_{i, j} \in R(W_{i, j})^*\}_{j \in J_i}$
but the union $\{W_{i, j}\}_{i \in I, j\in J_i}$ may not
be locally finite.

\medskip\noindent
In many cases in practice, one has a locally finite family of closed
subsets $\{T_i\}_{i \in I}$ such that $\alpha_i, \beta_i$
are supported on $T_i$ and such that $\alpha_i = \beta_i$
in $\CH_k(T_i)$, in other words, the families
$\{W_{i, j}, f_{i, j} \in R(W_{i, j})^*\}_{j \in J_i}$
consist of subschemes $W_{i, j} \subset T_i$. In this case it is true that
$\sum \alpha_i \sim_{rat} \sum \beta_i$ on $X$, simply because
the family $\{W_{i, j}\}_{i \in I, j\in J_i}$ is automatically
locally finite in this case.
\end{remark}






\section{Rational equivalence and push and pull}
\label{section-properties-rational-equivalence}

\noindent
In this section we show that flat pullback and proper pushforward
commute with rational equivalence.

\begin{lemma}
\label{lemma-prepare-flat-pullback-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Assume $Y$ integral with $\dim_\delta(Y) = k$.
Let $f : X \to Y$ be a flat morphism of
relative dimension $r$. Then for $g \in R(Y)^*$ we have
$$
f^*\text{div}_Y(g) =
\sum n_j i_{j, *}\text{div}_{X_j}(g \circ f|_{X_j})
$$
as $(k + r - 1)$-cycles on $X$ where the sum is over the irreducible
components $X_j$ of $X$ and $n_j$ is the multiplicity of $X_j$ in $X$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension
$k + r - 1$. We have to show that the coefficient $n$ of $[Z]$ in
$f^*\text{div}(g)$ is equal to the coefficient
$m$ of $[Z]$ in $\sum i_{j, *} \text{div}(g \circ f|_{X_j})$.
Let $Z'$ be the closure of $f(Z)$ which is an integral closed
subscheme of $Y$. By Lemma \ref{lemma-flat-inverse-image-dimension}
we have $\dim_\delta(Z') \geq k - 1$. Thus either $Z' = Y$
or $Z'$ is a prime divisor on $Y$. If $Z' = Y$, then the coefficients
$n$ and $m$ are both zero: this is clear for $n$ by definition
of $f^*$ and follows for $m$ because $g \circ f|_{X_j}$ is
a unit in any point of $X_j$ mapping to the generic point of $Y$.
Hence we may assume that $Z' \subset Y$ is a prime divisor.

\medskip\noindent
We are going to translate the equality of $n$ and $m$ into algebra.
Namely, let $\xi' \in Z'$ and $\xi \in Z$ be the generic points.
Set $A = \mathcal{O}_{Y, \xi'}$ and $B = \mathcal{O}_{X, \xi}$.
Note that $A$, $B$ are Noetherian, $A \to B$ is flat, local,
$A$ is a domain, and $\mathfrak m_AB$ is an ideal of definition
of the local ring $B$. The rational function $g$ is an element
of the fraction field $Q(A)$ of $A$.
By construction, the closed subschemes $X_j$
which meet $\xi$ correspond $1$-to-$1$ with minimal primes
$$
\mathfrak q_1, \ldots, \mathfrak q_s \subset B
$$
The integers $n_j$ are the corresponding lengths
$$
n_i = \text{length}_{B_{\mathfrak q_i}}(B_{\mathfrak q_i})
$$
The rational functions $g \circ f|_{X_j}$ correspond to the image
$g_i \in \kappa(\mathfrak q_i)^*$ of $g \in Q(A)$.
Putting everything together we see that
$$
n = \text{ord}_A(g) \text{length}_B(B/\mathfrak m_AB)
$$
and that
$$
m = \sum \text{ord}_{B/\mathfrak q_i}(g_i)
\text{length}_{B_{\mathfrak q_i}}(B_{\mathfrak q_i})
$$
Writing $g = x/y$ for some nonzero $x, y \in A$ we see that it suffices
to prove
$$
\text{length}_A(A/(x)) \text{length}_B(B/\mathfrak m_AB) =
\text{length}_B(B/xB)
$$
(equality uses Algebra, Lemma \ref{algebra-lemma-pullback-module})
equals
$$
\sum\nolimits_{i = 1, \ldots, s}
\text{length}_{B/\mathfrak q_i}(B/(x, \mathfrak q_i))
\text{length}_{B_{\mathfrak q_i}}(B_{\mathfrak q_i})
$$
and similarly for $y$. As $A \to B$ is flat it follows that $x$
is a nonzerodivisor in $B$. Hence the desired equality follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha \sim_{rat} \beta$ be rationally equivalent $k$-cycles on $Y$.
Then $f^*\alpha \sim_{rat} f^*\beta$ as $(k + r)$-cycles on $X$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow Y
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $g_j \in R(W_j)^*$. Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $Y$.
Then we have to show that
$$
f^*(\sum i_{j, *}\text{div}(g_j)) = \sum f^*i_{j, *}\text{div}(g_j)
$$
is rationally equivalent to zero on $X$. The sum on the right
makes sense as $\{W_j\}$ is locally finite in $X$ by
Lemma \ref{lemma-inverse-image-locally-finite}.

\medskip\noindent
Consider the fibre products
$$
i'_j : W'_j = W_j \times_Y X \longrightarrow X.
$$
and denote $f_j : W'_j \to W_j$ the first projection.
By Lemma \ref{lemma-flat-pullback-proper-pushforward}
we can write the sum above as
$$
\sum i'_{j, *}(f_j^*\text{div}(g_j))
$$
By Lemma \ref{lemma-prepare-flat-pullback-rational-equivalence}
we see that each $f_j^*\text{div}(g_j)$ is rationally equivalent
to zero on $W'_j$. Hence each $i'_{j, *}(f_j^*\text{div}(g_j))$
is rationally equivalent to zero. Then the same is true for
the displayed sum by the discussion in
Remark \ref{remark-infinite-sums-rational-equivalences}.
\end{proof}

\begin{lemma}
\label{lemma-proper-pushforward-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Suppose $\alpha, \beta \in Z_k(X)$ are rationally equivalent.
Then $p_*\alpha$ is rationally equivalent to $p_*\beta$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow X
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $f_j \in R(W_j)^*$.
Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $X$.
Then we have to show that
$$
p_*\left(\sum i_{j, *}\text{div}(f_j)\right)
$$
is rationally equivalent to zero on $X$.

\medskip\noindent
Note that the sum is equal to
$$
\sum p_*i_{j, *}\text{div}(f_j).
$$
Let $W'_j \subset Y$ be the integral closed subscheme which is the
image of $p \circ i_j$. The collection $\{W'_j\}$ is locally finite
in $Y$ by Lemma \ref{lemma-quasi-compact-locally-finite}.
Hence it suffices to show, for a given $j$, that either
$p_*i_{j, *}\text{div}(f_j) = 0$ or that it
is equal to $i'_{j, *}\text{div}(g_j)$ for some $g_j \in R(W'_j)^*$.

\medskip\noindent
The arguments above therefore reduce us to the case of a since
integral closed subscheme $W \subset X$ of $\delta$-dimension $k + 1$.
Let $f \in R(W)^*$. Let $W' = p(W)$ as above.
We get a commutative diagram of morphisms
$$
\xymatrix{
W \ar[r]_i \ar[d]_{p'} & X \ar[d]^p \\
W' \ar[r]^{i'} & Y
}
$$
Note that $p_*i_*\text{div}(f) = i'_*(p')_*\text{div}(f)$ by
Lemma \ref{lemma-compose-pushforward}. As explained above
we have to show that $(p')_*\text{div}(f)$
is the divisor of a rational function on $W'$ or zero.
There are three cases to distinguish.

\medskip\noindent
The case $\dim_\delta(W') < k$. In this case automatically
$(p')_*\text{div}(f) = 0$ and there is nothing to prove.

\medskip\noindent
The case $\dim_\delta(W') = k$. Let us show that $(p')_*\text{div}(f) = 0$
in this case. Let $\eta \in W'$ be the generic point.
Note that $c : W_\eta \to \Spec(K)$
is a proper integral curve over $K = \kappa(\eta)$
whose function field $K(W_\eta)$ is identified with $R(W)$.
Here is a diagram
$$
\xymatrix{
W_\eta \ar[r] \ar[d]_c & W \ar[d]^{p'} \\
\Spec(K) \ar[r] & W'
}
$$
Let us denote $f_\eta \in K(W_\eta)^*$ the rational function
corresponding to $f \in R(W)^*$.
Moreover, the closed points $\xi$ of $W_\eta$ correspond $1 - 1$ to the
closed integral subschemes $Z = Z_\xi \subset W$ of $\delta$-dimension $k$
with $p'(Z) = W'$. Note that the multiplicity
of $Z_\xi$ in $\text{div}(f)$ is equal to
$\text{ord}_{\mathcal{O}_{W_\eta, \xi}}(f_\eta)$ simply because the
local rings $\mathcal{O}_{W_\eta, \xi}$ and $\mathcal{O}_{W, \xi}$
are identified (as subrings of their fraction fields).
Hence we see that the multiplicity of $[W']$ in
$(p')_*\text{div}(f)$ is equal to the multiplicity of
$[\Spec(K)]$ in $c_*\text{div}(f_\eta)$.
By Lemma \ref{lemma-curve-principal-divisor} this is zero.

\medskip\noindent
The case $\dim_\delta(W') = k + 1$. In this case
Lemma \ref{lemma-proper-pushforward-alteration} applies,
and we see that indeed $p'_*\text{div}(f) = \text{div}(g)$
for some $g \in R(W')^*$ as desired.
\end{proof}















\section{Rational equivalence and the projective line}
\label{section-different-rational-equivalence}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Given any closed subscheme
$Z \subset X \times_S \mathbf{P}^1_S = X \times \mathbf{P}^1$
we let $Z_0$, resp.\ $Z_\infty$ be the scheme theoretic closed
subscheme $Z_0 = \text{pr}_2^{-1}(D_0)$,
resp.\ $Z_\infty = \text{pr}_2^{-1}(D_\infty)$.
Here $D_0$, $D_\infty$ are as in (\ref{equation-zero-infty}).

\begin{lemma}
\label{lemma-rational-equivalence-family}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $W \subset X \times_S \mathbf{P}^1_S$ be an integral
closed subscheme of $\delta$-dimension $k + 1$.
Assume $W \not = W_0$, and $W \not = W_\infty$. Then
\begin{enumerate}
\item $W_0$, $W_\infty$ are effective Cartier divisors of $W$,
\item $W_0$, $W_\infty$ can be viewed as closed subschemes
of $X$ and
$$
[W_0]_k \sim_{rat} [W_\infty]_k,
$$
\item for any locally finite family of
integral closed subschemes
$W_i \subset X \times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$ with $W_i \not = (W_i)_0$ and
$W_i \not = (W_i)_\infty$ we have
$\sum ([(W_i)_0]_k - [(W_i)_\infty]_k) \sim_{rat} 0$
on $X$, and
\item for any $\alpha \in Z_k(X)$ with $\alpha \sim_{rat} 0$
there exists a locally finite family of
integral closed subschemes $W_i \subset X \times_S \mathbf{P}^1_S$
as above such that $\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}
since the generic point
of $W$ is not mapped into $D_0$ or $D_\infty$ under the projection
$X \times_S \mathbf{P}^1_S \to \mathbf{P}^1_S$ by assumption.

\medskip\noindent
Since $X \times_S D_0 \to X$ is a closed immersion, we see that $W_0$
is isomorphic to a closed subscheme of $X$. Similarly for $W_\infty$.
The morphism $p : W \to X$ is proper as a composition of
the closed immersion $W \to X \times_S \mathbf{P}^1_S$ and the
proper morphism $X \times_S \mathbf{P}^1_S \to X$. By
Lemma \ref{lemma-rational-function} we have
$[W_0]_k \sim_{rat} [W_\infty]_k$ as cycles on $W$. Hence part (2) follows from
Lemma \ref{lemma-proper-pushforward-rational-equivalence} as clearly
$p_*[W_0]_k = [W_0]_k$ and similarly for $W_\infty$.

\medskip\noindent
The only content of statement (3) is, given parts (1) and (2), that
the collection $\{(W_i)_0, (W_i)_\infty\}$ is a locally finite collection
of closed subschemes of $X$. This is clear.

\medskip\noindent
Suppose that $\alpha \sim_{rat} 0$.
By definition this means there exist integral closed subschemes
$V_i \subset X$ of $\delta$-dimension $k + 1$ and rational
functions $f_i \in R(V_i)^*$ such that the family
$\{V_i\}_{i \in I}$ is locally finite in $X$ and such that
$\alpha = \sum (V_i \to X)_*\text{div}(f_i)$.
Let
$$
W_i \subset V_i \times_S \mathbf{P}^1_S \subset X \times_S \mathbf{P}^1_S
$$
be the closure of the graph of the rational map $f_i$ as in
Lemma \ref{lemma-rational-function}.
Then we have that $(V_i \to X)_*\text{div}(f_i)$
is equal to $[(W_i)_0]_k - [(W_i)_\infty]_k$ by that same lemma.
Hence the result is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-subscheme-cross-p1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $Z$ be a closed subscheme of $X \times \mathbf{P}^1$.
Assume
\begin{enumerate}
\item $\dim_\delta(Z) \leq k + 1$,
\item $\dim_\delta(Z_0) \leq k$, $\dim_\delta(Z_\infty) \leq k$, and
\item for any embedded point $\xi$ (Divisors, Definition
\ref{divisors-definition-embedded}) of $Z$ either
$\xi \not \in Z_0 \cup Z_\infty$ or $\delta(\xi) < k$.
\end{enumerate}
Then $[Z_0]_k \sim_{rat} [Z_\infty]_k$ as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $Z$ which have $\delta$-dimension $k + 1$.
Write
$$
[Z]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by
Divisors, Lemma \ref{divisors-lemma-components-locally-finite}.
We claim that
$$
[Z_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[Z_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[Z_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $I \subset A$ be the ideal cutting out $Z$, in other words so that
$A/I = \mathcal{O}_{Z, \xi}$. Let $t \in A$ be the element cutting
out $X \times_S D_0$ (i.e., the coordinate of $\mathbf{P}^1$ at zero
pulled back). By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(A/I) = 1$. Since $\xi$ is not an embedded point by
assumption (3) we see that $A/I$ is Cohen-Macaulay. Since $\dim_\delta(Z_0)
= k$ we see that $\dim(A/(t, I)) = 0$ which implies that $t$
is a nonzerodivisor on $A/I$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$I \subset \mathfrak q_i$ over $I$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(A/(t, I))
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i))
\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}
$$
Thus the result follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cross-p1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X \times \mathbf{P}^1$.
Let $i_0, i_\infty : X \to X \times \mathbf{P}^1$ be the closed immersion
such that $i_t(x) = (x, t)$. Denote $\mathcal{F}_0 = i_0^*\mathcal{F}$ and
$\mathcal{F}_\infty = i_\infty^*\mathcal{F}$.
Assume
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$,
\item $\dim_\delta(\text{Supp}(\mathcal{F}_0)) \leq k$,
$\dim_\delta(\text{Supp}(\mathcal{F}_\infty)) \leq k$, and
\item for any embedded associated point $\xi$ of $\mathcal{F}$ either
$\xi \not \in (X \times \mathbf{P}^1)_0 \cup (X \times \mathbf{P}^1)_\infty$
or $\delta(\xi) < k$.
\end{enumerate}
Then $[\mathcal{F}_0]_k \sim_{rat} [\mathcal{F}_\infty]_k$ as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$.
Write
$$
[\mathcal{F}]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by Lemma \ref{lemma-length-finite}.
We claim that
$$
[\mathcal{F}_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[\mathcal{F}_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[\mathcal{F}_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Let $t \in A$ be the element cutting out $X \times_S D_0$
(i.e., the coordinate of $\mathbf{P}^1$ at zero pulled back).
By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(\text{Supp}(M)) = 1$. Since $\xi$ is not an associated point
of $\mathcal{F}$ by assumption (3) we see that $M$ is a Cohen-Macaulay module.
Since $\dim_\delta(\text{Supp}(\mathcal{F}_0)) = k$
we see that $\dim(\text{Supp}(M/tM)) = 0$ which implies that $t$
is a nonzerodivisor on $M$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Ass}(M)$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(M/tM)
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i)A)
\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}
$$
Thus the result follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}








\section{Chow groups and K-groups}
\label{section-chow-and-K}

\noindent
In this section we are going to compare $K_0$ of the
category of coherent sheaves to the chow groups.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
We denote $\textit{Coh}(X) = \textit{Coh}(\mathcal{O}_X)$
the category of coherent sheaves on $X$.
It is an abelian category, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.
For any $k \in \mathbf{Z}$ we let $\textit{Coh}_{\leq k}(X)$
be the full subcategory of $\textit{Coh}(X)$
consisting of those coherent sheaves $\mathcal{F}$
having $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-Serre-subcategories}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
The categories $\textit{Coh}_{\leq k}(X)$ are Serre subcategories
of the abelian category $\textit{Coh}(X)$.
\end{lemma}

\begin{proof}
The definition of a Serre subcategory is
Homology, Definition \ref{homology-definition-serre-subcategory}.
The proof of the lemma is straightforward and omitted.
\end{proof}

\begin{lemma}
\label{lemma-cycles-k-group}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
The maps
$$
Z_k(X)
\longrightarrow
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X)),
\quad
\sum n_Z[Z] \mapsto
\left[\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}\right]
-
\left[\bigoplus\nolimits_{n_Z < 0} \mathcal{O}_Z^{\oplus -n_Z}\right]
$$
and
$$
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow
Z_k(X),\quad
\mathcal{F} \longmapsto [\mathcal{F}]_k
$$
are mutually inverse isomorphisms.
\end{lemma}

\begin{proof}
Note that if $\sum n_Z[Z]$ is in $Z_k(X)$, then
the direct sums
$\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}$ and
$\bigoplus\nolimits_{n_Z < 0} \mathcal{O}_Z^{\oplus -n_Z}$
are coherent sheaves on $X$ since the family $\{Z \mid n_Z > 0\}$
is locally finite on $X$.
The map $\mathcal{F} \to [\mathcal{F}]_k$ is additive
on $\textit{Coh}_{\leq k}(X)$, see
Lemma \ref{lemma-additivity-sheaf-cycle}. And $[\mathcal{F}]_k = 0$
if $\mathcal{F} \in \textit{Coh}_{\leq k - 1}(X)$. By part (1)
of Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
this implies that the second map is well defined too.
It is clear that the composition of the first map with the second
map is the identity.

\medskip\noindent
Conversely, say we start with a coherent sheaf $\mathcal{F}$
on $X$. Write $[\mathcal{F}]_k = \sum_{i \in I} n_i[Z_i]$
with $n_i > 0$ and $Z_i \subset X$, $i \in I$
pairwise distinct integral closed subschemes of $\delta$-dimension $k$.
We have to show that
$$
[\mathcal{F}] = [\bigoplus\nolimits_{i \in I} \mathcal{O}_{Z_i}^{\oplus n_i}]
$$
in $K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Denote $\xi_i \in Z_i$ the generic point.
If we set
$$
\mathcal{F}' = \Ker(\mathcal{F} \to \bigoplus \xi_{i, *}\mathcal{F}_{\xi_i})
$$
then $\mathcal{F}'$ is the maximal coherent submodule of $\mathcal{F}$
whose support has dimension $\leq k - 1$. In particular $\mathcal{F}$
and $\mathcal{F}/\mathcal{F}'$ have the same class in
$K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Thus after replacing $\mathcal{F}$ by $\mathcal{F}/\mathcal{F}'$
we may and do assume that the kernel $\mathcal{F}'$ displayed
above is zero.

\medskip\noindent
For each $i \in I$ we choose a filtration
$$
\mathcal{F}_{\xi_i} = \mathcal{F}_i^0 \supset \mathcal{F}_i^1 \supset
\ldots \supset \mathcal{F}_i^{n_i} = 0
$$
such that the successive quotients are of dimension $1$ over the residue
field at $\xi_i$. This is possible as the length of $\mathcal{F}_{\xi_i}$
over $\mathcal{O}_{X, \xi_i}$ is $n_i$.
For $p > n_i$ set $\mathcal{F}_i^p = 0$. For $p \geq 0$ we denote
$$
\mathcal{F}^p =
\Ker\left(\mathcal{F} \longrightarrow \bigoplus
\xi_{i, *}(\mathcal{F}_{\xi_i}/\mathcal{F}_i^p)\right)
$$
Then $\mathcal{F}^p$ is coherent, $\mathcal{F}^0 = \mathcal{F}$, and
$\mathcal{F}^p/\mathcal{F}^{p + 1}$ is isomorphic to a free
$\mathcal{O}_{Z_i}$-module of rank $1$ (if $n_i > p$) or $0$
(if $n_i \leq p$) in an open neighbourhood of $\xi_i$. Moreover,
$\mathcal{F}' = \bigcap \mathcal{F}^p = 0$. Since every quasi-compact
open $U \subset X$ contains only a finite number of $\xi_i$
we conclude that $\mathcal{F}^p|_U$ is zero for $p \gg 0$.
Hence $\bigoplus_{p \geq 0} \mathcal{F}^p$ is a coherent
$\mathcal{O}_X$-module. Consider the short exact sequences
$$
0 \to
\bigoplus\nolimits_{p > 0} \mathcal{F}^p \to
\bigoplus\nolimits_{p \geq 0} \mathcal{F}^p \to
\bigoplus\nolimits_{p > 0} \mathcal{F}^p/\mathcal{F}^{p + 1} \to 0
$$
and
$$
0 \to
\bigoplus\nolimits_{p > 0} \mathcal{F}^p \to
\bigoplus\nolimits_{p \geq 0} \mathcal{F}^p \to
\mathcal{F} \to 0
$$
of coherent $\mathcal{O}_X$-modules. This already shows that
$$
[\mathcal{F}] = [\bigoplus \mathcal{F}^p/\mathcal{F}^{p + 1}]
$$
in $K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Next, for every $p \geq 0$ and $i \in I$ such that $n_i > p$
we choose a nonzero ideal sheaf $\mathcal{I}_{i, p} \subset \mathcal{O}_{Z_i}$
and a map $\mathcal{I}_{i, p} \to \mathcal{F}^p/\mathcal{F}^{p + 1}$ on $X$
which is an isomorphism over the open neighbourhood of $\xi_i$
mentioned above. This is possible by
Cohomology of Schemes, Lemma \ref{coherent-lemma-extend-coherent}.
Then we consider the short exact sequence
$$
0 \to
\bigoplus\nolimits_{p \geq 0, i \in I, n_i > p} \mathcal{I}_{i, p}
\to
\bigoplus \mathcal{F}^p/\mathcal{F}^{p + 1} \to
\mathcal{Q} \to 0
$$
and the short exact sequence
$$
0 \to
\bigoplus\nolimits_{p \geq 0, i \in I, n_i > p} \mathcal{I}_{i, p}
\to
\bigoplus\nolimits_{p \geq 0, i \in I, n_i > p} \mathcal{O}_{Z_i}
\to
\mathcal{Q}' \to 0
$$
Observe that both $\mathcal{Q}$ and $\mathcal{Q}'$ are zero in a neighbourhood
of the points $\xi_i$ and that they are supported on $\bigcup Z_i$.
Hence $\mathcal{Q}$ and $\mathcal{Q}'$ are in
$\textit{Coh}_{\leq k - 1}(X)$.
Since
$$
\bigoplus\nolimits_{i \in I} \mathcal{O}_{Z_i}^{\oplus n_i} \cong
\bigoplus\nolimits_{p \geq 0, i \in I, n_i > p} \mathcal{O}_{Z_i}
$$
this concludes the proof.
\end{proof}

\begin{lemma}
\label{lemma-finite-cycles-k-group}
Let $\pi : X \to Y$ be a finite morphism of schemes locally of finite type
over $(S, \delta)$ as in Situation \ref{situation-setup}. Then
$\pi_* : \textit{Coh}(X) \to \textit{Coh}(Y)$ is an exact functor
which sends $\textit{Coh}_{\leq k}(X)$ into $\textit{Coh}_{\leq k}(Y)$
and induces homomorphisms on $K_0$ of these categories and
their quotients. The maps of Lemma \ref{lemma-cycles-k-group}
fit into a commutative diagram
$$
\xymatrix{
Z_k(X) \ar[d]^{\pi_*} \ar[r] &
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\ar[d]^{\pi_*} \ar[r] &
Z_k(X) \ar[d]^{\pi_*} \\
Z_k(Y) \ar[r] &
K_0(\textit{Coh}_{\leq k}(Y)/\textit{Coh}_{\leq k - 1}(Y)) \ar[r] &
Z_k(Y)
}
$$
\end{lemma}

\begin{proof}
A finite morphism is affine, hence pushforward of quasi-coherent
modules along $\pi$ is an exact functor by
Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-vanishing}.
A finite morphism is proper, hence $\pi_*$ sends coherent sheaves
to coherent sheaves, see Cohomology of Schemes, Proposition
\ref{coherent-proposition-proper-pushforward-coherent}.
The statement on dimensions of supports is clear.
Commutativity on the right follows immediately from
Lemma \ref{lemma-cycle-push-sheaf}.
Since the horizontal arrows are bijections, we find that
we have commutativity on the left as well.
\end{proof}

\begin{lemma}
\label{lemma-from-chow-to-K}
Let $X$ be a scheme locally of finite type over $(S, \delta)$
as in Situation \ref{situation-setup}. There is a canonical map
$$
\CH_k(X)
\longrightarrow
K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))
$$
induced by the map
$Z_k(X) \to K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$
from Lemma \ref{lemma-cycles-k-group}.
\end{lemma}

\begin{proof}
We have to show that an element $\alpha$ of $Z_k(X)$ which is rationally
equivalent to zero, is mapped to zero in
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Write $\alpha = \sum (i_j)_*\text{div}(f_j)$ as in
Definition \ref{definition-rational-equivalence}.
Observe that
$$
\pi = \coprod i_j : W = \coprod W_j \longrightarrow X
$$
is a finite morphism as each $i_j : W_j \to X$ is a closed immersion
and the family of $W_j$ is locally finite in $X$. Hence we may use
Lemma \ref{lemma-finite-cycles-k-group} to reduce to the case of $W$.
Since $W$ is a disjoint union of intregral scheme, we reduce
to the case discussed in the next paragraph.

\medskip\noindent
Assume $X$ is integral of $\delta$-dimension $k + 1$.
Let $f$ be a nonzero rational function on $X$.
Let $\alpha = \text{div}(f)$. We have to show that
$\alpha$ is mapped to zero in
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal of denominators
of $f$, see Divisors, Definition
\ref{divisors-definition-regular-meromorphic-ideal-denominators}.
Then we have short exact sequences
$$
0 \to \mathcal{I} \to \mathcal{O}_X \to \mathcal{O}_X/\mathcal{I} \to 0
$$
and
$$
0 \to \mathcal{I} \xrightarrow{f} \mathcal{O}_X \to
\mathcal{O}_X/f\mathcal{I} \to 0
$$
See Divisors, Lemma
\ref{divisors-lemma-regular-meromorphic-ideal-denominators}.
We claim that
$$
[\mathcal{O}_X/\mathcal{I}]_k - [\mathcal{O}_X/f\mathcal{I}]_k =
\text{div}(f)
$$
The claim implies the element $\alpha = \text{div}(f)$ is represented by
$[\mathcal{O}_X/\mathcal{I}] - [\mathcal{O}_X/f\mathcal{I}]$
in $K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Then the short exact sequences show that this element maps to
zero in $K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.

\medskip\noindent
To prove the claim, let $Z \subset X$ be an integral closed subscheme
of $\delta$-dimension $k$ and let $\xi \in Z$ be its generic point.
Then $I = \mathcal{I}_\xi \subset A = \mathcal{O}_{X, \xi}$
is an ideal such that $fI \subset A$. Now the coefficient of
$[Z]$ in $\text{div}(f)$ is $\text{ord}_A(f)$. (Of course as usual
we identify the function field of $X$ with the fraction field of $A$.)
On the other hand, the coefficient of $[Z]$ in
$[\mathcal{O}_X/\mathcal{I}] - [\mathcal{O}_X/f\mathcal{I}]$
is
$$
\text{length}_A(A/I) - \text{length}_A(A/fI)
$$
Using the distance fuction of
Algebra, Definition \ref{algebra-definition-distance}
we can rewrite this as
$$
d(A, I) - d(A, fI) = d(I, fI) = \text{ord}_A(f)
$$
The equalities hold by Algebra, Lemmas
\ref{algebra-lemma-properties-distance-function} and
\ref{algebra-lemma-order-vanishing-determinant}.
(Using these lemmas isn't necessary, but convenient.)
\end{proof}

\begin{remark}
\label{remark-good-cases-K-A}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
We will see later (in Lemma \ref{lemma-cycles-rational-equivalence-K-group})
that the map
$$
\CH_k(X)
\longrightarrow
K_0(\textit{Coh}_{k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))
$$
of Lemma \ref{lemma-from-chow-to-K} is injective.
Composing with the canonical map
$$
K_0(\textit{Coh}_{k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow
K_0(\textit{Coh}(X)/\textit{Coh}_{\leq k - 1}(X))
$$
we obtain a canonical map
$$
\CH_k(X)
\longrightarrow
K_0(\textit{Coh}(X)/\textit{Coh}_{\leq k - 1}(X)).
$$
We have not been able to find a statement or conjecture in the
literature as to whether this map is should be injective or not.
It seems reasonable to expect the kernel of this map to be torsion.
We will return to this question (insert future reference).
\end{remark}

\begin{lemma}
\label{lemma-K-coherent-supported-on-closed}
Let $X$ be a locally Noetherian scheme. Let $Z \subset X$ be a closed
subscheme. Denote $\textit{Coh}_Z(X) \subset \textit{Coh}(X)$
the Serre subcategory of coherent $\mathcal{O}_X$-modules whose
set theoretic support is contained in $Z$. Then the exact inclusion
functor $\textit{Coh}(Z) \to \textit{Coh}_Z(X)$ induces
an isomorphism
$$
K'_0(Z) = K_0(\textit{Coh}(Z)) \longrightarrow K_0(\textit{Coh}_Z(X))
$$
\end{lemma}

\begin{proof}
Let $\mathcal{F}$ be an object of $\textit{Coh}_Z(X)$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent
ideal sheaf of $Z$. Consider the descending filtration
$$
\ldots \subset
\mathcal{F}^p = \mathcal{I}^p \mathcal{F} \subset
\mathcal{F}^{p - 1} \subset \ldots \subset \mathcal{F}^0 = \mathcal{F}
$$
Exactly as in the proof of Lemma \ref{lemma-from-chow-to-K} this filtration
is locally finite and hence
$\bigoplus_{p \geq 0} \mathcal{F}^p$,
$\bigoplus_{p \geq 1} \mathcal{F}^p$, and
$\bigoplus_{p \geq 0} \mathcal{F}^p/\mathcal{F}^{p + 1}$
are coherent $\mathcal{O}_X$-modules supported on $Z$.
Hence we get
$$
[\mathcal{F}] =
[\bigoplus\nolimits_{p \geq 0} \mathcal{F}^p/\mathcal{F}^{p + 1}]
$$
in $K_0(\textit{Coh}_Z(X))$ exactly as in the proof of
Lemma \ref{lemma-from-chow-to-K}. Since the coherent module
$\bigoplus_{p \geq 0} \mathcal{F}^p/\mathcal{F}^{p + 1}$
is annihilated by $\mathcal{I}$ we conclude that
$[\mathcal{F}]$ is in the image. Actually, we claim that the map
$$
\mathcal{F} \longmapsto 
c(\mathcal{F}) =
[\bigoplus\nolimits_{p \geq 0} \mathcal{F}^p/\mathcal{F}^{p + 1}]
$$
factors through $K_0(\textit{Coh}_Z(X))$ and is an inverse to
the map in the statement of the lemma. To see this all we have
to show is that if
$$
0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0
$$
is a short exact sequence in $\textit{Coh}_Z(X)$, then we
get $c(\mathcal{G}) = c(\mathcal{F}) + c(\mathcal{H})$.
Observe that for all $q \geq 0$ we have a short exact sequence
$$
0 \to
(\mathcal{F} \cap \mathcal{I}^q\mathcal{G})/
(\mathcal{F} \cap \mathcal{I}^{q + 1}\mathcal{G}) \to
\mathcal{G}^q/\mathcal{G}^{q + 1} \to
\mathcal{H}^q/\mathcal{H}^{q + 1} \to 0
$$
For $p, q \geq 0$ consider the coherent submodule
$$
\mathcal{F}^{p, q} = \mathcal{I}^p\mathcal{F} \cap \mathcal{I}^q\mathcal{G}
$$
Arguing exactly as above and using that the filtrations
$\mathcal{F}^p = \mathcal{I}^p\mathcal{F}$ and
$\mathcal{F} \cap \mathcal{I}^q\mathcal{G}$ are locally finite,
we find that
$$
[\bigoplus\nolimits_{p \geq 0} \mathcal{F}^p/\mathcal{F}^{p + 1}] =
[\bigoplus\nolimits_{p, q \geq 0}
\mathcal{F}^{p, q}/(\mathcal{F}^{p + 1, q} + \mathcal{F}^{p, q + 1})] =
[\bigoplus\nolimits_{q \geq 0}
(\mathcal{F} \cap \mathcal{I}^q\mathcal{G})/
(\mathcal{F} \cap \mathcal{I}^{q + 1}\mathcal{G})]
$$
in $K_0(\textit{Coh}(Z))$. Combined with the exact sequences above we obtain
the desired result. Some details omitted.
\end{proof}













\section{The divisor associated to an invertible sheaf}
\label{section-divisor-invertible-sheaf}

\noindent
The following definition is the analogue of
Divisors, Definition \ref{divisors-definition-divisor-invertible-sheaf}
in our current setup.

\begin{definition}
\label{definition-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any nonzero meromorphic section $s$ of $\mathcal{L}$
we define the {\it Weil divisor associated to $s$} is the
$(n - 1)$-cycle
$$
\text{div}_\mathcal{L}(s) =
\sum \text{ord}_{Z, \mathcal{L}}(s) [Z]
$$
defined in Divisors, Definition
\ref{divisors-definition-divisor-invertible-sheaf}.
This makes sense because Weil divisors have $\delta$-dimension $n - 1$
by Lemma \ref{lemma-divisor-delta-dimension}.
\item We define {\it Weil divisor associated to $\mathcal{L}$} as
$$
c_1(\mathcal{L}) \cap [X] =
\text{class of }\text{div}_\mathcal{L}(s) \in \CH_{n - 1}(X)
$$
where $s$ is any nonzero meromorphic section of $\mathcal{L}$ over
$X$. This is well defined by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-well-defined}.
\end{enumerate}
\end{definition}

\noindent
Let $X$ and $S$ be as in Definition \ref{definition-divisor-invertible-sheaf}
above. Set $n = \dim_\delta(X)$. It is clear from the definitions that
$Cl(X) = \CH_{n - 1}(X)$ where $Cl(X)$ is the Weil divisor class group of $X$
as defined in Divisors, Definition \ref{divisors-definition-class-group}.
The map
$$
\Pic(X) \longrightarrow \CH_{n - 1}(X), \quad
\mathcal{L} \longmapsto c_1(\mathcal{L}) \cap [X]
$$
is the same as the map $\Pic(X) \to Cl(X)$ constructed in
Divisors, Equation (\ref{divisors-equation-c1}) for arbitrary
locally Noetherian integral schemes. In particular, this map
is a homomorphism of abelian groups, it is injective if $X$ is
a normal scheme, and an isomorphism if all local rings of $X$
are UFDs. See Divisors, Lemmas \ref{divisors-lemma-normal-c1-injective} and
\ref{divisors-lemma-local-rings-UFD-c1-bijective}.
There are some cases where it is easy to compute the
Weil divisor associated to an invertible sheaf.

\begin{lemma}
\label{lemma-compute-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$ be a nonzero global section.
Then
$$
\text{div}_\mathcal{L}(s) = [Z(s)]_{n - 1}
$$
in $Z_{n - 1}(X)$ and
$$
c_1(\mathcal{L}) \cap [X] = [Z(s)]_{n - 1}
$$
in $\CH_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n - 1$. Let $\xi \in Z$ be its generic
point. Choose a generator $s_\xi \in \mathcal{L}_\xi$.
Write $s = fs_\xi$ for some $f \in \mathcal{O}_{X, \xi}$.
By definition of $Z(s)$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}
we see that $Z(s)$ is cut out by a quasi-coherent
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$ such
that $\mathcal{I}_\xi = (f)$. Hence
$\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{Z(s), \xi})
=
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{X, \xi}/(f))
=
\text{ord}_{\mathcal{O}_{X, x}}(f)$ as desired.
\end{proof}

\noindent
The following lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-cap-c1}.

\begin{lemma}
\label{lemma-flat-pullback-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_Y$-module.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$. Then
$$
f^*(c_1(\mathcal{L}) \cap [Y]) = c_1(f^*\mathcal{L}) \cap [X]
$$
in $\CH_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
We will show that actually
$f^*\text{div}_\mathcal{L}(s) = \text{div}_{f^*\mathcal{L}}(f^*s)$
and hence the lemma holds.
To see this let $\xi \in Y$ be a point and let $s_\xi \in \mathcal{L}_\xi$
be a generator. Write $s = gs_\xi$ with $g \in R(X)^*$.
Then there is an open neighbourhood $V \subset Y$ of $\xi$
such that $s_\xi \in \mathcal{L}(V)$ and such that $s_\xi$ generates
$\mathcal{L}|_V$. Hence we see that
$$
\text{div}_\mathcal{L}(s)|_V = \text{div}(g)|_V.
$$
In exactly the same way, since $f^*s_\xi$ generates $\mathcal{L}$
over $f^{-1}(V)$ and since $f^*s = g f^*s_\xi$ we also
have
$$
\text{div}_\mathcal{L}(f^*s)|_{f^{-1}(V)}
=
\text{div}(g)|_{f^{-1}(V)}.
$$
Thus the desired equality of cycles over $f^{-1}(V)$ follows from the
corresponding result for pullbacks of principal divisors, see
Lemma \ref{lemma-flat-pullback-principal-divisor}.
\end{proof}



\section{Intersecting with an invertible sheaf}
\label{section-intersecting-with-divisors}

\noindent
In this section we study the following construction.

\begin{definition}
\label{definition-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We define, for every integer $k$, an operation
$$
c_1(\mathcal{L}) \cap - :
Z_{k + 1}(X) \to \CH_k(X)
$$
called {\it intersection with the first chern class of $\mathcal{L}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ with
$\dim_\delta(W) = k + 1$ we define
$$
c_1(\mathcal{L}) \cap [W] = i_*(c_1({i^*\mathcal{L}}) \cap [W])
$$
where the right hand side is defined in
Definition \ref{definition-divisor-invertible-sheaf}.
\item For a general $(k + 1)$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_1(\mathcal{L}) \cap \alpha = \sum n_i c_1(\mathcal{L}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Write each $c_1(\mathcal{L}) \cap W_i = \sum_j n_{i, j} [Z_{i, j}]$
with $\{Z_{i, j}\}_j$ a locally finite sum
of integral closed subschemes of $W_i$. Since $\{W_i\}$ is a locally
finite collection of integral closed subschemes on $X$, it follows
easily that $\{Z_{i, j}\}_{i, j}$ is a locally finite collection
of closed subschemes of $X$. Hence
$c_1(\mathcal{L}) \cap \alpha = \sum n_in_{i, j}[Z_{i, j}]$
is a cycle. Another, more convenient, way to think about this
is to observe that the morphism $\coprod W_i \to X$ is
proper. Hence $c_1(\mathcal{L}) \cap \alpha$ can be viewed
as the pushforward of a class in $\CH_k(\coprod W_i) = \prod \CH_k(W_i)$.
This also explains why the result is well defined up to rational
equivalence on $X$.

\medskip\noindent
The main goal for the next few sections is to show that intersecting with
$c_1(\mathcal{L})$ factors through rational equivalence.
This is not a triviality.

\begin{lemma}
\label{lemma-c1-cap-additive}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be an invertible sheaves on $X$.
Then
$$
c_1(\mathcal{L}) \cap \alpha  + c_1(\mathcal{N}) \cap \alpha =
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N}) \cap \alpha
$$
in $\CH_k(X)$ for every $\alpha \in Z_{k - 1}(X)$. Moreover,
$c_1(\mathcal{O}_X) \cap \alpha = 0$ for all $\alpha$.
\end{lemma}

\begin{proof}
The additivity follows directly from
Divisors, Lemma \ref{divisors-lemma-c1-additive}
and the definitions. To see that $c_1(\mathcal{O}_X) \cap \alpha = 0$
consider the section $1 \in \Gamma(X, \mathcal{O}_X)$. This restricts
to an everywhere nonzero section on any integral closed subscheme
$W \subset X$. Hence $c_1(\mathcal{O}_X) \cap [W] = 0$ as desired.
\end{proof}

\noindent
Recall that $Z(s) \subset X$ denotes the zero scheme of a global section
$s$ of an invertible sheaf on a scheme $X$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.

\begin{lemma}
\label{lemma-prepare-geometric-cap}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $Y$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_Y$-module.
Let $s \in \Gamma(Y, \mathcal{L})$.
Assume
\begin{enumerate}
\item $\dim_\delta(Y) \leq k + 1$,
\item $\dim_\delta(Z(s)) \leq k$, and
\item for every generic point $\xi$ of an irreducible component of
$Z(s)$ of $\delta$-dimension $k$ the multiplication by $s$
induces an injection $\mathcal{O}_{Y, \xi} \to \mathcal{L}_\xi$.
\end{enumerate}
Write $[Y]_{k + 1} = \sum n_i[Y_i]$ where $Y_i \subset Y$ are the
irreducible components of $Y$ of $\delta$-dimension $k + 1$.
Set $s_i = s|_{Y_i} \in \Gamma(Y_i, \mathcal{L}|_{Y_i})$. Then
\begin{equation}
\label{equation-equal-as-cycles}
[Z(s)]_k =  \sum n_i[Z(s_i)]_k
\end{equation}
as $k$-cycles on $Y$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be an integral closed subscheme of
$\delta$-dimension $k$. Let $\xi \in Z$ be its generic point.
We want to compare the coefficient $n$ of $[Z]$ in the expression
$\sum n_i[Z(s_i)]_k$ with the coefficient $m$ of $[Z]$ in the
expression $[Z(s)]_k$. Choose a generator $s_\xi \in \mathcal{L}_\xi$.
Write $A = \mathcal{O}_{Y, \xi}$, $L = \mathcal{L}_\xi$.
Then $L = As_\xi$. Write $s = f s_\xi$ for some (unique) $f \in A$.
Hypothesis (3) means that $f : A \to A$ is injective.
Since $\dim_\delta(Y) \leq k + 1$ and $\dim_\delta(Z) = k$
we have $\dim(A) = 0$ or $1$. We have
$$
m = \text{length}_A(A/(f))
$$
which is finite in either case.

\medskip\noindent
If $\dim(A) = 0$, then $f : A \to A$ being injective
implies that $f \in A^*$. Hence in this case $m$ is zero.
Moreover, the condition $\dim(A) = 0$ means that $\xi$
does not lie on any irreducible component of $\delta$-dimension
$k + 1$, i.e., $n = 0$ as well.

\medskip\noindent
Now, let $\dim(A) = 1$.
Since $A$ is a Noetherian local ring it has finitely
many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$.
These correspond 1-1 with the $Y_i$ passing through $\xi'$.
Moreover $n_i = \text{length}_{A_{\mathfrak q_i}}(A_{\mathfrak q_i})$.
Also, the multiplicity of $[Z]$ in $[Z(s_i)]_k$ is
$\text{length}_A(A/(f, \mathfrak q_i))$.
Hence the equation to prove in this case is
$$
\text{length}_A(A/(f))
=
\sum \text{length}_{A_{\mathfrak q_i}}(A_{\mathfrak q_i})
\text{length}_A(A/(f, \mathfrak q_i))
$$
which follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\noindent
The following lemma is a useful result in order to compute the intersection
product of the $c_1$ of an invertible sheaf and the cycle associated
to a closed subscheme.
Recall that $Z(s) \subset X$ denotes the zero scheme of a global section
$s$ of an invertible sheaf on a scheme $X$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.

\begin{lemma}
\label{lemma-geometric-cap}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $Y \subset X$ be a closed subscheme.
Let $s \in \Gamma(Y, \mathcal{L}|_Y)$.
Assume
\begin{enumerate}
\item $\dim_\delta(Y) \leq k + 1$,
\item $\dim_\delta(Z(s)) \leq k$, and
\item for every generic point $\xi$ of an irreducible component of
$Z(s)$ of $\delta$-dimension $k$ the multiplication by $s$
induces an injection
$\mathcal{O}_{Y, \xi} \to (\mathcal{L}|_Y)_\xi$\footnote{For example,
this holds if $s$ is a regular section of $\mathcal{L}|_Y$.}.
\end{enumerate}
Then
$$
c_1(\mathcal{L}) \cap [Y]_{k + 1} = [Z(s)]_k
$$
in $\CH_k(X)$.
\end{lemma}

\begin{proof}
Write
$$
[Y]_{k + 1} = \sum n_i[Y_i]
$$
where $Y_i \subset Y$ are the irreducible components of
$Y$ of $\delta$-dimension $k + 1$ and $n_i > 0$.
By assumption the restriction
$s_i = s|_{Y_i} \in \Gamma(Y_i, \mathcal{L}|_{Y_i})$ is not
zero, and hence is a regular section. By Lemma \ref{lemma-compute-c1}
we see that $[Z(s_i)]_k$ represents $c_1(\mathcal{L}|_{Y_i})$.
Hence by definition
$$
c_1(\mathcal{L}) \cap [Y]_{k + 1} = \sum n_i[Z(s_i)]_k
$$
Thus the result follows from Lemma \ref{lemma-prepare-geometric-cap}.
\end{proof}




\section{Intersecting with an invertible sheaf and push and pull}
\label{section-intersecting-with-divisors-push-pull}

\noindent
In this section we prove that the operation $c_1(\mathcal{L}) \cap -$
commutes with flat pullback and proper pushforward.

\begin{lemma}
\label{lemma-prepare-flat-pullback-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Assume $Y$ is integral and $n = \dim_\delta(Y)$.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
Then we have
$$
f^*\text{div}_\mathcal{L}(s) = \sum n_i\text{div}_{f^*\mathcal{L}|_{X_i}}(s_i)
$$
in $Z_{n + r - 1}(X)$. Here the sum is over the irreducible
components $X_i \subset X$ of $\delta$-dimension $n + r$,
the section $s_i = f|_{X_i}^*(s)$ is the pullback of $s$, and
$n_i = m_{X_i, X}$ is the multiplicity of $X_i$ in $X$.
\end{lemma}

\begin{proof}
To prove this equality of cycles, we may work locally on $Y$.
Hence we may assume $Y$ is affine and $s = p/q$ for some nonzero
sections $p \in \Gamma(Y, \mathcal{L})$ and $q \in \Gamma(Y, \mathcal{O})$.
If we can show both
$$
f^*\text{div}_\mathcal{L}(p) =
\sum n_i\text{div}_{f^*\mathcal{L}|_{X_i}}(p_i)
\quad\text{and}\quad
f^*\text{div}_\mathcal{O}(q) =
\sum n_i\text{div}_{\mathcal{O}_{X_i}}(q_i)
$$
(with obvious notations) then we win by the
additivity, see Divisors, Lemma \ref{divisors-lemma-c1-additive}.
Thus we may assume that $s \in \Gamma(Y, \mathcal{L})$.
In this case we may apply the equality
(\ref{equation-equal-as-cycles}) to see that
$$
[Z(f^*(s))]_{k + r - 1} =
\sum n_i\text{div}_{f^*\mathcal{L}|_{X_i}}(s_i)
$$
where $f^*(s) \in f^*\mathcal{L}$ denotes the pullback of $s$ to $X$.
On the other hand we have
$$
f^*\text{div}_\mathcal{L}(s) = f^*[Z(s)]_{k - 1}
= [f^{-1}(Z(s))]_{k + r - 1},
$$
by Lemmas \ref{lemma-compute-c1} and \ref{lemma-pullback-coherent}.
Since $Z(f^*(s)) = f^{-1}(Z(s))$ we win.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_1(\mathcal{L}) \cap \alpha) = c_1(f^*\mathcal{L}) \cap f^*\alpha
$$
in $\CH_{k + r - 1}(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_i[W_i]$. We will show that
$$
f^*(c_1(\mathcal{L}) \cap [W_i]) = c_1(f^*\mathcal{L}) \cap f^*[W_i]
$$
in $\CH_{k + r - 1}(X)$ by producing a rational equivalence
on the closed subscheme $f^{-1}(W_i)$ of $X$.
By the discussion in
Remark \ref{remark-infinite-sums-rational-equivalences}
this will prove the equality of the lemma is true.

\medskip\noindent
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension $k$.
Consider the closed subscheme $W' = f^{-1}(W) = W \times_Y X$
so that we have the fibre product diagram
$$
\xymatrix{
W' \ar[r] \ar[d]_h & X \ar[d]^f \\
W \ar[r] & Y
}
$$
We have to show that
$f^*(c_1(\mathcal{L}) \cap [W]) = c_1(f^*\mathcal{L}) \cap f^*[W]$.
Choose a nonzero meromorphic section $s$ of $\mathcal{L}|_W$.
Let $W'_i \subset W'$ be the irreducible components of
$\delta$-dimension $k + r$. Write $[W']_{k + r} = \sum n_i[W'_i]$
with $n_i$ the multiplicity of $W'_i$ in $W'$ as per definition.
So $f^*[W] = \sum n_i[W'_i]$ in $Z_{k + r}(X)$.
Since each $W'_i \to W$ is dominant we
see that $s_i = s|_{W'_i}$ is a nonzero meromorphic section for
each $i$. By Lemma \ref{lemma-prepare-flat-pullback-cap-c1}
we have the following equality of cycles
$$
h^*\text{div}_{\mathcal{L}|_W}(s) =
\sum n_i\text{div}_{f^*\mathcal{L}|_{W'_i}}(s_i)
$$
in $Z_{k + r - 1}(W')$. This finishes the proof since
the left hand side is a cycle on $W'$ which pushes to
$f^*(c_1(\mathcal{L}) \cap [W])$ in $\CH_{k + r - 1}(X)$
and the right hand side is a cycle on $W'$ which pushes to
$c_1(f^*\mathcal{L}) \cap f^*[W]$ in $\CH_{k + r - 1}(X)$.
\end{proof}

\begin{lemma}
\label{lemma-equal-c1-as-cycles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a proper morphism.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $s$ be a nonzero meromorphic section $s$ of $\mathcal{L}$ on $Y$.
Assume $X$, $Y$ integral, $f$ dominant, and $\dim_\delta(X) = \dim_\delta(Y)$.
Then
$$
f_*\left(\text{div}_{f^*\mathcal{L}}(f^*s)\right) =
[R(X) : R(Y)]\text{div}_\mathcal{L}(s).
$$
as cycles on $Y$. In particular
$$
f_*(c_1(f^*\mathcal{L}) \cap [X]) = c_1(\mathcal{L}) \cap f_*[Y].
$$
\end{lemma}

\begin{proof}
The last equation follows from the first since $f_*[X] = [R(X) : R(Y)][Y]$
by definition. It turns out that we can re-use
Lemma \ref{lemma-proper-pushforward-alteration}
to prove this. Namely, since we are trying to prove an equality
of cycles, we may work locally on $Y$. Hence we may assume
that $\mathcal{L} = \mathcal{O}_Y$. In this case $s$
corresponds to a rational function $g \in R(Y)$, and
we are simply trying to prove
$$
f_*\left(\text{div}_X(g)\right) =
[R(X) : R(Y)]\text{div}_Y(g).
$$
Comparing with the result of the aforementioned
Lemma \ref{lemma-proper-pushforward-alteration}
we see this true since
$\text{Nm}_{R(X)/R(Y)}(g) = g^{[R(X) : R(Y)]}$
as $g \in R(Y)^*$.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha \in Z_{k + 1}(X)$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Then
$$
p_*(c_1(p^*\mathcal{L}) \cap \alpha) = c_1(\mathcal{L}) \cap p_*\alpha
$$
in $\CH_k(Y)$.
\end{lemma}

\begin{proof}
Suppose that $p$ has the property that for every integral
closed subscheme $W \subset X$ the map $p|_W : W \to Y$
is a closed immersion. Then, by definition of capping
with $c_1(\mathcal{L})$ the lemma holds.

\medskip\noindent
We will use this remark to reduce to a special case. Namely,
write $\alpha = \sum n_i[W_i]$ with $n_i \not = 0$ and $W_i$ pairwise
distinct. Let $W'_i \subset Y$ be the image of $W_i$ (as an integral
closed subscheme). Consider the diagram
$$
\xymatrix{
X' = \coprod W_i \ar[r]_-q \ar[d]_{p'} & X \ar[d]^p \\
Y' = \coprod W'_i \ar[r]^-{q'} & Y.
}
$$
Since $\{W_i\}$ is locally finite on $X$, and $p$ is proper
we see that $\{W'_i\}$ is locally finite on $Y$ and that
$q, q', p'$ are also proper morphisms.
We may think of $\sum n_i[W_i]$ also as a $k$-cycle
$\alpha' \in Z_k(X')$. Clearly $q_*\alpha' = \alpha$.
We have
$q_*(c_1(q^*p^*\mathcal{L}) \cap \alpha')
= c_1(p^*\mathcal{L}) \cap q_*\alpha'$
and
$(q')_*(c_1((q')^*\mathcal{L}) \cap p'_*\alpha') =
c_1(\mathcal{L}) \cap q'_*p'_*\alpha'$ by the initial
remark of the proof. Hence it suffices to prove the lemma
for the morphism $p'$ and the cycle $\sum n_i[W_i]$.
Clearly, this means we may assume $X$, $Y$ integral,
$f : X \to Y$ dominant and $\alpha = [X]$.
In this case the result follows from
Lemma \ref{lemma-equal-c1-as-cycles}.
\end{proof}






\section{The key formula}
\label{section-key}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume
$X$ is integral and $\dim_\delta(X) = n$.
Let $\mathcal{L}$ and $\mathcal{N}$ be invertible sheaves on $X$.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$ and
let $t$ be a nonzero meromorphic section of $\mathcal{N}$.
Let $Z_i \subset X$, $i \in I$ be a locally finite set of irreducible
closed subsets of codimension $1$ with the following property:
If $Z \not \in \{Z_i\}$ with generic point $\xi$, then $s$ is a generator
for $\mathcal{L}_\xi$ and $t$ is a generator for $\mathcal{N}_\xi$.
Such a set exists by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-locally-finite}.
Then
$$
\text{div}_\mathcal{L}(s) = \sum \text{ord}_{Z_i, \mathcal{L}}(s) [Z_i]
$$
and similarly
$$
\text{div}_\mathcal{N}(t) = \sum \text{ord}_{Z_i, \mathcal{N}}(t) [Z_i]
$$
Unwinding the definitions more, we pick for each $i$ generators
$s_i \in \mathcal{L}_{\xi_i}$ and $t_i \in \mathcal{N}_{\xi_i}$
where $\xi_i$ is the generic point of $Z_i$. Then we can write
$$
s = f_i s_i
\quad\text{and}\quad
t = g_i t_i
$$
Set $B_i = \mathcal{O}_{X, \xi_i}$. Then by definition
$$
\text{ord}_{Z_i, \mathcal{L}}(s) = \text{ord}_{B_i}(f_i)
\quad\text{and}\quad
\text{ord}_{Z_i, \mathcal{N}}(t) = \text{ord}_{B_i}(g_i)
$$
Since $t_i$ is a generator of $\mathcal{N}_{\xi_i}$ we see that
its image in the fibre $\mathcal{N}_{\xi_i} \otimes \kappa(\xi_i)$
is a nonzero meromorphic section of $\mathcal{N}|_{Z_i}$. We will denote
this image $t_i|_{Z_i}$. From our definitions it follows that
$$
c_1(\mathcal{N}) \cap \text{div}_\mathcal{L}(s) =
\sum \text{ord}_{B_i}(f_i)
(Z_i \to X)_*\text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i})
$$
and similarly
$$
c_1(\mathcal{L}) \cap \text{div}_\mathcal{N}(t) =
\sum \text{ord}_{B_i}(g_i)
(Z_i \to X)_*\text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i})
$$
in $\CH_{n - 2}(X)$. We are going to find a rational equivalence between
these two cycles. To do this we consider the tame symbol
$$
\partial_{B_i}(f_i, g_i) \in \kappa(\xi_i)^*
$$
see Section \ref{section-tame-symbol}.

\begin{lemma}[Key formula]
\label{lemma-key-formula}
In the situation above the cycle
$$
\sum
(Z_i \to X)_*\left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i}) -
\text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) \right)
$$
is equal to the cycle
$$
\sum (Z_i \to X)_*\text{div}(\partial_{B_i}(f_i, g_i))
$$
\end{lemma}

\begin{proof}
First, let us examine what happens if we replace $s_i$ by $us_i$
for some unit $u$ in $B_i$. Then $f_i$ gets replaced by $u^{-1} f_i$.
Thus the first part of the first expression of the lemma is unchanged
and in the second part we add
$$
-\text{ord}_{B_i}(g_i)\text{div}(u|_{Z_i})
$$
(where $u|_{Z_i}$ is the image of $u$ in the residue field) by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-well-defined}
and in the second expression we add
$$
\text{div}(\partial_{B_i}(u^{-1}, g_i))
$$
by bi-linearity of the tame symbol. These terms agree by property
(\ref{item-normalization}) of the tame symbol.

\medskip\noindent
Let $Z \subset X$ be an irreducible closed with $\dim_\delta(Z) = n - 2$.
To show that the coefficients of $Z$ of the two cycles of the lemma
is the same, we may do a replacement $s_i \mapsto us_i$ as in the previous
paragraph. In exactly the same way one shows that we may do a replacement
$t_i \mapsto vt_i$ for some unit $v$ of $B_i$.

\medskip\noindent
Since we are proving the equality of cycles we may argue one coefficient
at a time. Thus we choose an irreducible closed $Z \subset X$
with $\dim_\delta(Z) = n - 2$ and compare coefficients. Let $\xi \in Z$
be the generic point and set $A = \mathcal{O}_{X, \xi}$. This is a Noetherian
local domain of dimension $2$. Choose generators $\sigma$ and $\tau$
for $\mathcal{L}_\xi$ and $\mathcal{N}_\xi$. After shrinking $X$, we may
and do assume $\sigma$ and $\tau$ define trivializations
of the invertible sheaves $\mathcal{L}$ and $\mathcal{N}$ over all of $X$.
Because $Z_i$ is locally
finite after shrinking $X$ we may assume $Z \subset Z_i$ for all $i \in I$
and that $I$ is finite. Then $\xi_i$ corresponds to a prime
$\mathfrak q_i \subset A$ of height $1$.
We may write $s_i = a_i \sigma$ and $t_i = b_i \tau$
for some $a_i$ and $b_i$ units in $A_{\mathfrak q_i}$.
By the remarks above, it suffices to prove the lemma when
$a_i = b_i = 1$ for all $i$.

\medskip\noindent
Assume $a_i = b_i = 1$ for all $i$. Then the first expression of the
lemma is zero, because we choose $\sigma$ and $\tau$ to be trivializing
sections. Write $s = f\sigma$ and $t = g \tau$ with $f$ and $g$ in the
fraction field of $A$. By the previous paragraph we have reduced to the case
$f_i = f$ and $g_i = g$ for all $i$. Moreover, for a height $1$ prime
$\mathfrak q$ of $A$ which is not in $\{\mathfrak q_i\}$ we have
that both $f$ and $g$ are units in $A_\mathfrak q$ (by our choice of
the family $\{Z_i\}$ in the discussion preceding the lemma). Thus
the coefficient of $Z$ in the second expression of the lemma is
$$
\sum\nolimits_i \text{ord}_{A/\mathfrak q_i}(\partial_{B_i}(f, g))
$$
which is zero by the key Lemma \ref{lemma-milnor-gersten-low-degree}.
\end{proof}






\section{Intersecting with an invertible sheaf and rational equivalence}
\label{section-commutativity}

\noindent
Applying the key lemma we obtain the fundamental properties of intersecting
with invertible sheaves. In particular, we will see that
$c_1(\mathcal{L}) \cap -$ factors through rational equivalence and
that these operations for different invertible sheaves commute.

\begin{lemma}
\label{lemma-commutativity-on-integral}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
Choose a nonzero meromorphic section $s$ of $\mathcal{L}$
and a nonzero meromorphic section $t$ of $\mathcal{N}$.
Set $\alpha = \text{div}_\mathcal{L}(s)$ and
$\beta = \text{div}_\mathcal{N}(t)$.
Then
$$
c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{L}) \cap \beta
$$
in $\CH_{n - 2}(X)$.
\end{lemma}

\begin{proof}
Immediate from the key Lemma \ref{lemma-key-formula}
and the discussion preceding it.
\end{proof}

\begin{lemma}
\label{lemma-factors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be invertible on $X$.
The operation $\alpha \mapsto c_1(\mathcal{L}) \cap \alpha$
factors through rational equivalence to give an operation
$$
c_1(\mathcal{L}) \cap - : \CH_{k + 1}(X) \to \CH_k(X)
$$
\end{lemma}

\begin{proof}
Let $\alpha \in Z_{k + 1}(X)$, and $\alpha \sim_{rat} 0$.
We have to show that $c_1(\mathcal{L}) \cap \alpha$
as defined in Definition \ref{definition-cap-c1} is zero.
By Definition \ref{definition-rational-equivalence} there
exists a locally finite family $\{W_j\}$ of integral closed
subschemes with $\dim_\delta(W_j) = k + 2$ and rational functions
$f_j \in R(W_j)^*$ such that
$$
\alpha = \sum (i_j)_*\text{div}_{W_j}(f_j)
$$
Note that $p : \coprod W_j \to X$ is a proper morphism,
and hence $\alpha = p_*\alpha'$ where $\alpha' \in Z_{k + 1}(\coprod W_j)$
is the sum of the principal divisors $\text{div}_{W_j}(f_j)$.
By Lemma \ref{lemma-pushforward-cap-c1} we have
$c_1(\mathcal{L}) \cap \alpha = p_*(c_1(p^*\mathcal{L}) \cap \alpha')$.
Hence it suffices to show that each
$c_1(\mathcal{L}|_{W_j}) \cap \text{div}_{W_j}(f_j)$ is zero.
In other words we may assume that $X$ is integral and
$\alpha = \text{div}_X(f)$ for some $f \in R(X)^*$.

\medskip\noindent
Assume $X$ is integral and $\alpha = \text{div}_X(f)$ for some $f \in R(X)^*$.
We can think of $f$ as a regular meromorphic section of the invertible
sheaf $\mathcal{N} = \mathcal{O}_X$. Choose a meromorphic section
$s$ of $\mathcal{L}$ and denote $\beta = \text{div}_\mathcal{L}(s)$.
By Lemma \ref{lemma-commutativity-on-integral}
we conclude that
$$
c_1(\mathcal{L}) \cap \alpha = c_1(\mathcal{O}_X) \cap \beta.
$$
However, by Lemma \ref{lemma-c1-cap-additive} we see that the right hand side
is zero in $\CH_k(X)$ as desired.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be invertible on $X$.
We will denote
$$
c_1(\mathcal{L}) \cap - : \CH_{k + s}(X) \to \CH_k(X)
$$
the operation $c_1(\mathcal{L}) \cap - $. This makes sense by
Lemma \ref{lemma-factors}. We will denote $c_1(\mathcal{L})^s \cap -$
the $s$-fold iterate of this operation for all $s \geq 0$.

\begin{lemma}
\label{lemma-cap-commutative}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
For any $\alpha \in \CH_{k + 2}(X)$ we have
$$
c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
$$
as elements of $\CH_k(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum m_j[Z_j]$ for some locally finite
collection of integral closed subschemes $Z_j \subset X$
with $\dim_\delta(Z_j) = k + 2$.
Consider the proper morphism $p : \coprod Z_j \to X$.
Set $\alpha' = \sum m_j[Z_j]$ as a $(k + 2)$-cycle on
$\coprod Z_j$. By several applications of
Lemma \ref{lemma-pushforward-cap-c1} we see that
$c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
= p_*(c_1(p^*\mathcal{L}) \cap c_1(p^*\mathcal{N}) \cap \alpha')$
and
$c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
= p_*(c_1(p^*\mathcal{N}) \cap c_1(p^*\mathcal{L}) \cap \alpha')$.
Hence it suffices to prove the formula in case $X$ is integral
and $\alpha = [X]$. In this case the result follows
from Lemma \ref{lemma-commutativity-on-integral} and the definitions.
\end{proof}






\section{Gysin homomorphisms}
\label{section-intersecting-effective-Cartier}

\noindent
In this section we define the gysin map for the zero locus $D$ of a
section of an invertible sheaf. An interesting case occurs when $D$
is an effective Cartier divisor, but the generalization to arbitrary $D$
allows us a flexibility to formulate various compatibilities, see
Remark \ref{remark-pullback-pairs} and
Lemmas \ref{lemma-closed-in-X-gysin}, \ref{lemma-gysin-flat-pullback}, and
\ref{lemma-gysin-commutes-gysin}.
These results can be generalized to locally principal closed subschemes
endowed with a virtual normal bundle
(Remark \ref{remark-generalize-to-virtual}) or to
pseudo-divisors (Remark \ref{remark-generalize-to-pseudo-divisor}).

\medskip\noindent
Recall that effective Cartier divisors correspond $1$-to-$1$ to
isomorphism classes of pairs $(\mathcal{L}, s)$ where $\mathcal{L}$
is an invertible sheaf and $s$ is a regular global section, see
Divisors, Lemma \ref{divisors-lemma-characterize-OD}.
If $D$ corresponds to $(\mathcal{L}, s)$, then
$\mathcal{L} = \mathcal{O}_X(D)$. Please keep this in mind while
reading this section.

\begin{definition}
\label{definition-gysin-homomorphism}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s)$ be a pair consisting of an invertible
sheaf and a global section $s \in \Gamma(X, \mathcal{L})$.
Let $D = Z(s)$ be the zero scheme of $s$, and
denote $i : D \to X$ the closed immersion.
We define, for every integer $k$, a {\it Gysin homomorphism}
$$
i^* : Z_{k + 1}(X) \to \CH_k(D).
$$
by the following rules:
\begin{enumerate}
\item Given a integral closed subscheme $W \subset X$ with
$\dim_\delta(W) = k + 1$ we define
\begin{enumerate}
\item if $W \not \subset D$, then $i^*[W] = [D \cap W]_k$ as a
$k$-cycle on $D$, and
\item if $W \subset D$, then
$i^*[W] = i'_*(c_1(\mathcal{L}|_W) \cap [W])$,
where $i' : W \to D$ is the induced closed immersion.
\end{enumerate}
\item For a general $(k + 1)$-cycle $\alpha = \sum n_j[W_j]$
we set
$$
i^*\alpha = \sum n_j i^*[W_j]
$$
\item If $D$ is an effective Cartier divisor, then we denote
$D \cdot \alpha = i_*i^*\alpha$ the pushforward of the class $i^*\alpha$
to a class on $X$.
\end{enumerate}
\end{definition}

\noindent
In fact, as we will see later, this Gysin homomorphism $i^*$ can be viewed
as an example of a non-flat pullback. Thus we will sometimes informally
call the class $i^*\alpha$ the {\it pullback} of the class $\alpha$.

\begin{remark}
\label{remark-generalize-to-virtual}
Let $X$ be a scheme locally of finite type over $S$ as in
Situation \ref{situation-setup}. Let $(D, \mathcal{N}, \sigma)$
be a triple consisting of a locally principal (Divisors, Definition
\ref{divisors-definition-effective-Cartier-divisor}) closed subscheme
$i : D \to X$, an invertible $\mathcal{O}_D$-module $\mathcal{N}$, and
a surjection $\sigma : \mathcal{N}^{\otimes -1} \to i^*\mathcal{I}_D$
of $\mathcal{O}_D$-modules\footnote{This condition assures us that if
$D$ is an effective Cartier divisor, then $\mathcal{N} = \mathcal{O}_X(D)|_D$.}.
Here $\mathcal{N}$ should be thought of as
a {\it virtual normal bundle of $D$ in $X$}. The construction of
$i^* : Z_{k + 1}(X) \to \CH_k(D)$ in
Definition \ref{definition-gysin-homomorphism}
generalizes to such triples, see
Section \ref{section-gysin-higher-codimension}.
\end{remark}

\begin{remark}
\label{remark-generalize-to-pseudo-divisor}
Let $X$ be a scheme locally of finite type over $S$ as in
Situation \ref{situation-setup}. In \cite{F} a {\it pseudo-divisor} on $X$
is defined as a triple $D = (\mathcal{L}, Z, s)$ where $\mathcal{L}$
is an invertible $\mathcal{O}_X$-module, $Z \subset X$ is a closed subset,
and $s \in \Gamma(X \setminus Z, \mathcal{L})$ is a nowhere vanishing
section. Similarly to the above, one can define for every $\alpha$
in $\CH_{k + 1}(X)$ a product $D \cdot \alpha$ in $\CH_k(Z \cap |\alpha|)$
where $|\alpha|$ is the support of $\alpha$.
\end{remark}

\begin{lemma}
\label{lemma-support-cap-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}. Let $\alpha$ be a
$(k + 1)$-cycle on $X$. Then $i_*i^*\alpha = c_1(\mathcal{L}) \cap \alpha$
in $\CH_k(X)$. In particular, if $D$ is an effective Cartier divisor, then
$D \cdot \alpha = c_1(\mathcal{O}_X(D)) \cap \alpha$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_j[W_j]$ where $i_j : W_j \to X$ are integral closed
subschemes with $\dim_\delta(W_j) = k$.
Since $D$ is the zero scheme of $s$ we see that $D \cap W_j$ is the zero scheme
of the restriction $s|_{W_j}$. Hence for each $j$ such that
$W_j \not \subset D$ we have
$c_1(\mathcal{L}) \cap [W_j] = [D \cap W_j]_k$
by Lemma \ref{lemma-geometric-cap}. So we have
$$
c_1(\mathcal{L}) \cap \alpha
=
\sum\nolimits_{W_j \not \subset D} n_j[D \cap W_j]_k
+
\sum\nolimits_{W_j \subset D}
n_j i_{j, *}(c_1(\mathcal{L})|_{W_j}) \cap [W_j])
$$
in $\CH_k(X)$ by Definition \ref{definition-cap-c1}.
The right hand side matches (termwise) the pushforward of the class
$i^*\alpha$ on $D$ from Definition \ref{definition-gysin-homomorphism}.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-easy-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme such
that $\dim_\delta(Z) \leq k + 1$ and such that
$D \cap Z$ is an effective Cartier divisor on $Z$. Then
$i^*[Z]_{k + 1} = [D \cap Z]_k$.
\item Let $\mathcal{F}$ be a coherent sheaf on $X$
such that $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$ and
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective. Then
$$
i^*[\mathcal{F}]_{k + 1} = [i^*\mathcal{F}]_k
$$
in $\CH_k(D)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $Z \subset X$ as in (1). Then set $\mathcal{F} = \mathcal{O}_Z$.
The assumption that $D \cap Z$ is an effective Cartier divisor is
equivalent to the assumption that
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective. Moreover $[Z]_{k + 1} = [\mathcal{F}]_{k + 1}]$
and $[D \cap Z]_k = [\mathcal{O}_{D \cap Z}]_k = [i^*\mathcal{F}]_k$.
See Lemma \ref{lemma-cycle-closed-coherent}.
Hence part (1) follows from part (2).

\medskip\noindent
Write $[\mathcal{F}]_{k + 1} = \sum m_j[W_j]$ with $m_j > 0$
and pairwise distinct integral closed subschemes $W_j \subset X$
of $\delta$-dimension $k + 1$. The assumption that
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective implies that $W_j \not \subset D$ for all $j$.
By definition we see that
$$
i^*[\mathcal{F}]_{k + 1} = \sum [D \cap W_j]_k.
$$
We claim that
$$
\sum [D \cap W_j]_k = [i^*\mathcal{F}]_k
$$
as cycles.
Let $Z \subset D$ be an integral closed subscheme of $\delta$-dimension
$k$. Let $\xi \in Z$ be its generic point. Let $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$. Let $f \in A$ be an element generating the
ideal of $D$, i.e., such that $\mathcal{O}_{D, \xi} = A/fA$.
By assumption $\dim(\text{Supp}(M)) = 1$,
the map $f : M \to M$ is injective, and
$\text{length}_A(M/fM) < \infty$. Moreover, $\text{length}_A(M/fM)$
is the coefficient of $[Z]$ in $[i^*\mathcal{F}]_k$. On the
other hand, let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes in the support of $M$. Then
$$
\sum
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(f)
$$
is the coefficient of $[Z]$ in $\sum [D \cap W_j]_k$.
Hence we see the equality by
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{remark}
\label{remark-gysin-on-cycles}
Let $X \to S$, $\mathcal{L}$, $s$, $i : D \to X$ be as in
Definition \ref{definition-gysin-homomorphism} and assume
that $\mathcal{L}|_D \cong \mathcal{O}_D$. In this case we
can define a canonical map $i^* : Z_{k + 1}(X) \to Z_k(D)$
on cycles, by requiring that $i^*[W] = 0$ whenever $W \subset D$
is an integral closed subscheme.
The possibility to do this will be useful later on.
\end{remark}

\begin{remark}
\label{remark-pullback-pairs}
Let $f : X' \to X$ be a morphism of schemes locally of finite type over $S$
as in Situation \ref{situation-setup}. Let $(\mathcal{L}, s, i : D \to X)$
be a triple as in Definition \ref{definition-gysin-homomorphism}.
Then we can set $\mathcal{L}' = f^*\mathcal{L}$, $s' = f^*s$, and
$D' = X' \times_X D = Z(s')$. This gives a commutative diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
and we can ask for various compatibilities between $i^*$ and $(i')^*$.
\end{remark}

\begin{lemma}
\label{lemma-closed-in-X-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X' \to X$ be a proper morphism of schemes
locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
Form the diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
as in Remark \ref{remark-pullback-pairs}.
For any $(k + 1)$-cycle $\alpha'$ on $X'$ we have
$i^*f_*\alpha' = g_*(i')^*\alpha'$ in $\CH_k(D)$
(this makes sense as $f_*$ is defined on the level of cycles).
\end{lemma}

\begin{proof}
Suppose $\alpha = [W']$ for some integral closed subscheme
$W' \subset X'$. Let $W = f(W') \subset X$. In case $W' \not \subset D'$,
then $W \not \subset D$ and we see that
$$
[W' \cap D']_k = \text{div}_{\mathcal{L}'|_{W'}}({s'|_{W'}})
\quad\text{and}\quad
[W \cap D]_k = \text{div}_{\mathcal{L}|_W}(s|_W)
$$
and hence $f_*$ of the first cycle equals the second cycle by
Lemma \ref{lemma-equal-c1-as-cycles}. Hence the
equality holds as cycles. In case $W' \subset D'$, then
$W \subset D$ and $f_*(c_1(\mathcal{L}|_{W'}) \cap [W'])$
is equal to $c_1(\mathcal{L}|_W) \cap [W]$ in $\CH_k(W)$ by the second
assertion of Lemma \ref{lemma-equal-c1-as-cycles}.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha'$.
\end{proof}

\begin{lemma}
\label{lemma-gysin-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $f : X' \to X$
be a flat morphism of relative dimension $r$ of schemes locally of finite type
over $S$. Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}. Form the diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
as in Remark \ref{remark-pullback-pairs}.
For any $(k + 1)$-cycle $\alpha$ on $X$ we have
$(i')^*f^*\alpha = g^*i^*\alpha'$ in $\CH_{k + r}(D)$
(this makes sense as $f^*$ is defined on the level of cycles).
\end{lemma}

\begin{proof}
Suppose $\alpha = [W]$ for some integral closed subscheme
$W \subset X$. Let $W' = f^{-1}(W) \subset X'$. In case $W \not \subset D$,
then $W' \not \subset D'$ and we see that
$$
W' \cap D' = g^{-1}(W \cap D)
$$
as closed subschemes of $D'$. Hence the
equality holds as cycles, see Lemma \ref{lemma-pullback-coherent}.
In case $W \subset D$, then $W' \subset D'$ and $W' = g^{-1}(W)$
with $[W']_{k + 1 + r} = g^*[W]$ and equality holds in
$\CH_{k + r}(D')$ by Lemma \ref{lemma-flat-pullback-cap-c1}.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha'$.
\end{proof}








\section{Gysin homomorphisms and rational equivalence}
\label{section-gysin}

\noindent
In this section we use the key formula to show the Gysin homomorphism
factor through rational equivalence. We also prove an important
commutativity property.

\begin{lemma}
\label{lemma-gysin-factors-general}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $X$ be integral and $n = \dim_\delta(X)$.
Let $i : D \to X$ be an effective Cartier divisor.
Let $\mathcal{N}$ be an invertible $\mathcal{O}_X$-module
and let $t$ be a nonzero meromorphic section of $\mathcal{N}$.
Then $i^*\text{div}_\mathcal{N}(t) = c_1(\mathcal{N}) \cap [D]_{n - 1}$
in $\CH_{n - 2}(D)$.
\end{lemma}

\begin{proof}
Write $\text{div}_\mathcal{N}(t) = \sum \text{ord}_{Z_i, \mathcal{N}}(t)[Z_i]$
for some integral closed subschemes $Z_i \subset X$ of $\delta$-dimension
$n - 1$. We may assume that the family $\{Z_i\}$ is locally
finite, that $t \in \Gamma(U, \mathcal{N}|_U)$ is a generator
where $U = X \setminus \bigcup Z_i$, and that every irreducible component
of $D$ is one of the $Z_i$, see
Divisors, Lemmas \ref{divisors-lemma-components-locally-finite},
\ref{divisors-lemma-divisor-locally-finite}, and
\ref{divisors-lemma-divisor-meromorphic-locally-finite}.

\medskip\noindent
Set $\mathcal{L} = \mathcal{O}_X(D)$. Denote
$s \in \Gamma(X, \mathcal{O}_X(D)) = \Gamma(X, \mathcal{L})$
the canonical section. We will apply the discussion of
Section \ref{section-key} to our current situation.
For each $i$ let $\xi_i \in Z_i$ be its generic point. Let
$B_i = \mathcal{O}_{X, \xi_i}$. For each $i$ we pick generators
$s_i \in \mathcal{L}_{\xi_i}$ and $t_i \in \mathcal{N}_{\xi_i}$
over $B_i$ but we insist that we pick $s_i = s$ if $Z_i \not \subset D$.
Write $s = f_i s_i$ and $t = g_i t_i$ with $f_i, g_i \in B_i$.
Then $\text{ord}_{Z_i, \mathcal{N}}(t) = \text{ord}_{B_i}(g_i)$.
On the other hand, we have $f_i \in B_i$ and
$$
[D]_{n - 1} = \sum \text{ord}_{B_i}(f_i)[Z_i]
$$
because of our choices of $s_i$. We claim that
$$
i^*\text{div}_\mathcal{N}(t) =
\sum \text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i})
$$
as cycles. More precisely, the right hand side is a cycle
representing the left hand side. Namely, this is clear by our
formula for $\text{div}_\mathcal{N}(t)$ and the fact that
$\text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) = [Z(s_i|_{Z_i})]_{n - 2} =
[Z_i \cap D]_{n - 2}$ when $Z_i \not \subset D$ because in
that case $s_i|_{Z_i} = s|_{Z_i}$ is a regular section, see
Lemma \ref{lemma-compute-c1}. Similarly,
$$
c_1(\mathcal{N}) \cap [D]_{n - 1} =
\sum \text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i})
$$
The key formula (Lemma \ref{lemma-key-formula}) gives the equality
$$
\sum \left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i}) -
\text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) \right) =
\sum \text{div}_{Z_i}(\partial_{B_i}(f_i, g_i))
$$
of cycles. If $Z_i \not \subset D$, then $f_i = 1$ and hence
$\text{div}_{Z_i}(\partial_{B_i}(f_i, g_i)) = 0$. Thus we get a rational
equivalence between our specific cycles representing
$i^*\text{div}_\mathcal{N}(t)$ and $c_1(\mathcal{N}) \cap [D]_{n - 1}$
on $D$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-gysin-factors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
The Gysin homomorphism factors through rational equivalence to
give a map $i^* : \CH_{k + 1}(X) \to \CH_k(D)$.
\end{lemma}

\begin{proof}
Let $\alpha \in Z_{k + 1}(X)$ and assume that $\alpha \sim_{rat} 0$.
This means there exists a locally finite collection of integral
closed subschemes $W_j \subset X$ of $\delta$-dimension $k + 2$
and $f_j \in R(W_j)^*$ such that
$\alpha = \sum i_{j, *}\text{div}_{W_j}(f_j)$.
Set $X' = \coprod W_i$ and consider the diagram
$$
\xymatrix{
D' \ar[d]_q \ar[r]_{i'} & X' \ar[d]^p \\
D \ar[r]^i & X
}
$$
of Remark \ref{remark-pullback-pairs}. Since $X' \to X$ is proper
we see that $i^*p_* = q_*(i')^*$ by Lemma \ref{lemma-closed-in-X-gysin}.
As we know that $q_*$ factors through rational equivalence
(Lemma \ref{lemma-proper-pushforward-rational-equivalence}), it suffices
to prove the result for $\alpha' = \sum \text{div}_{W_j}(f_j)$
on $X'$. Clearly this reduces us to the case where $X$ is integral
and $\alpha = \text{div}(f)$ for some $f \in R(X)^*$.

\medskip\noindent
Assume $X$ is integral and $\alpha = \text{div}(f)$ for some $f \in R(X)^*$.
If $X = D$, then we see that $i^*\alpha$ is equal
to $c_1(\mathcal{L}) \cap \alpha$.
This is rationally equivalent to zero by Lemma \ref{lemma-factors}.
If $D \not = X$, then we see that $i^*\text{div}_X(f)$ is equal to
$c_1(\mathcal{O}_D) \cap [D]_{n - 1}$ in $\CH_{n - 2}(D)$ by
Lemma \ref{lemma-gysin-factors-general}. Of course
capping with $c_1(\mathcal{O}_D)$ is the zero map
(Lemma \ref{lemma-c1-cap-additive}).
\end{proof}

\begin{lemma}
\label{lemma-gysin-back}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}. Then
$i^*i_* : \CH_k(X) \to \CH_{k - 1}(X)$ sends $\alpha$ to
$c_1(\mathcal{L}|_D) \cap \alpha$.
\end{lemma}

\begin{proof}
This is immediate from the definition of $i_*$ on cycles
and the definition of $i^*$ given in
Definition \ref{definition-gysin-homomorphism}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-commutes-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$
be a triple as in Definition \ref{definition-gysin-homomorphism}.
Let $\mathcal{N}$ be an invertible $\mathcal{O}_X$-module.
Then $i^*(c_1(\mathcal{N}) \cap \alpha) = c_1(i^*\mathcal{N}) \cap i^*\alpha$
in $\CH_{k - 2}(D)$ for all $\alpha \in \CH_k(Z)$.
\end{lemma}

\begin{proof}
With exactly the same proof as in Lemma \ref{lemma-gysin-factors}
this follows from Lemmas
\ref{lemma-pushforward-cap-c1},
\ref{lemma-cap-commutative}, and
\ref{lemma-gysin-factors-general}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-commutes-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$ and
$(\mathcal{L}', s', i' : D' \to X)$ be two triples as in
Definition \ref{definition-gysin-homomorphism}. Then the diagram
$$
\xymatrix{
\CH_k(X) \ar[r]_{i^*} \ar[d]_{(i')^*} & \CH_{k - 1}(D) \ar[d]^{j^*} \\
\CH_{k - 1}(D') \ar[r]^{(j')^*} & \CH_{k - 2}(D \cap D')
}
$$
commutes where each of the maps is a gysin map.
\end{lemma}

\begin{proof}
Denote $j : D \cap D' \to D$ and $j' : D \cap D' \to D'$ the closed
immersions corresponding to $(\mathcal{L}|_{D'}, s|_{D'}$ and
$(\mathcal{L}'_D, s|_D)$. We have to show that
$(j')^*i^*\alpha = j^* (i')^*\alpha$ for all $\alpha \in \CH_k(X)$.
Let $W \subset X$ be an integral closed subscheme of dimension $k$.
Let us prove the equality in case $\alpha = [W]$. We will deduce
it from the key formula.

\medskip\noindent
We let $\sigma$ be a nonzero meromorphic section of $\mathcal{L}|_W$
which we require to be equal to $s|_W$ if $W \not \subset D$.
We let $\sigma'$ be a nonzero meromorphic section of $\mathcal{L}'|_W$
which we require to be equal to $s'|_W$ if $W \not \subset D'$.
Write
$$
\text{div}_{\mathcal{L}|_W}(\sigma) =
\sum \text{ord}_{Z_i, \mathcal{L}|_W}(\sigma)[Z_i] = \sum n_i[Z_i]
$$
and similarly
$$
\text{div}_{\mathcal{L}'|_W}(\sigma') =
\sum \text{ord}_{Z_i, \mathcal{L}'|_W}(\sigma')[Z_i] = \sum n'_i[Z_i]
$$
as in the discussion in Section \ref{section-key}.
Then we see that $Z_i \subset D$ if $n_i \not = 0$ and
$Z'_i \subset D'$ if $n'_i \not = 0$. For each $i$, let $\xi_i \in Z_i$
be the generic point. As in Section \ref{section-key} we choose
for each $i$ an element
$\sigma_i \in \mathcal{L}_{\xi_i}$, resp.\ $\sigma'_i \in \mathcal{L}'_{\xi_i}$
which generates over $B_i = \mathcal{O}_{W, \xi_i}$
and which is equal to the image of
$s$, resp.\ $s'$ if $Z_i \not \subset D$, resp.\ $Z_i \not \subset D'$.
Write $\sigma = f_i \sigma_i$ and $\sigma' = f'_i\sigma'_i$ so that
$n_i = \text{ord}_{B_i}(f_i)$ and
$n'_i = \text{ord}_{B_i}(f'_i)$.
From our definitions it follows that
$$
(j')^*i^*[W] =
\sum \text{ord}_{B_i}(f_i) \text{div}_{\mathcal{L}'|_{Z_i}}(\sigma'_i|_{Z_i})
$$
as cycles and
$$
j^*(i')^*[W] =
\sum \text{ord}_{B_i}(f'_i) \text{div}_{\mathcal{L}|_{Z_i}}(\sigma_i|_{Z_i})
$$
The key formula (Lemma \ref{lemma-key-formula}) now gives the equality
$$
\sum \left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{L}'|_{Z_i}}(\sigma'_i|_{Z_i}) -
\text{ord}_{B_i}(f'_i) \text{div}_{\mathcal{L}|_{Z_i}}(\sigma_i|_{Z_i})
\right) =
\sum \text{div}_{Z_i}(\partial_{B_i}(f_i, f'_i))
$$
of cycles. Note that $\text{div}_{Z_i}(\partial_{B_i}(f_i, f'_i)) = 0$ if
$Z_i \not \subset D \cap D'$ because in this case either $f_i = 1$
or $f'_i = 1$. Thus we get a rational equivalence between our specific
cycles representing $(j')^*i^*[W]$ and $j^*(i')^*[W]$ on $D \cap D' \cap W$.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha$.
\end{proof}
















\section{Relative effective Cartier divisors}
\label{section-relative-effective-cartier}

\noindent
Relative effective Cartier divisors are defined and studied
in Divisors, Section \ref{divisors-section-effective-Cartier-morphisms}.
To develop the basic results on chern classes of vector bundles
we only need the case where both the ambient scheme and the effective
Cartier divisor are flat over the base.

\begin{lemma}
\label{lemma-relative-effective-cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a flat morphism of relative dimension $r$.
Let $i : D \to X$ be a relative effective Cartier divisor
(Divisors, Definition
\ref{divisors-definition-relative-effective-Cartier-divisor}).
Let $\mathcal{L} = \mathcal{O}_X(D)$.
For any $\alpha \in \CH_{k + 1}(Y)$ we have
$$
i^*p^*\alpha = (p|_D)^*\alpha
$$
in $\CH_{k + r}(D)$ and
$$
c_1(\mathcal{L}) \cap p^*\alpha = i_* ((p|_D)^*\alpha)
$$
in $\CH_{k + r}(X)$.
\end{lemma}

\begin{proof}
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension
$k + 1$. By Divisors, Lemma \ref{divisors-lemma-relative-Cartier}
we see that $D \cap p^{-1}W$ is an effective
Cartier divisor on $p^{-1}W$. By Lemma \ref{lemma-easy-gysin}
we get the first equality in
$$
i^*[p^{-1}W]_{k + r + 1} =
[D \cap p^{-1}W]_{k + r} =
[(p|_D)^{-1}(W)]_{k + r}.
$$
and the second because $D \cap p^{-1}(W) = (p|_D)^{-1}(W)$ as schemes.
Since by definition $p^*[W] = [p^{-1}W]_{k + r + 1}$ we see that
$i^*p^*[W] = (p|_D)^*[W]$ as cycles. If $\alpha = \sum m_j[W_j]$ is a
general $k + 1$ cycle, then we get
$i^*\alpha = \sum m_j i^*p^*[W_j] = \sum m_j(p|_D)^*[W_j]$ as cycles.
This proves then first equality. To deduce the second from the
first apply Lemma \ref{lemma-support-cap-effective-Cartier}.
\end{proof}








\section{Affine bundles}
\label{section-affine-vector}

\noindent
For an affine bundle the pullback map is surjective on Chow groups.

\begin{lemma}
\label{lemma-pullback-affine-fibres-surjective}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Assume that for every $y \in Y$, there exists an open neighbourhood
$U \subset Y$ such that $f|_{f^{-1}(U)} : f^{-1}(U) \to U$
is identified with the morphism $U \times \mathbf{A}^r \to U$.
Then $f^* : \CH_k(Y) \to \CH_{k + r}(X)$ is surjective for all
$k \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Let $\alpha \in \CH_{k + r}(X)$.
Write $\alpha = \sum m_j[W_j]$ with $m_j \not = 0$ and
$W_j$ pairwise distinct integral closed subschemes of
$\delta$-dimension $k + r$. Then the family $\{W_j\}$
is locally finite in $X$. For any quasi-compact open
$V \subset Y$ we see that $f^{-1}(V) \cap W_j$
is nonempty only for finitely many $j$. Hence the
collection $Z_j = \overline{f(W_j)}$ of closures
of images is a locally finite collection of integral
closed subschemes of $Y$.

\medskip\noindent
Consider the fibre product diagrams
$$
\xymatrix{
f^{-1}(Z_j) \ar[r] \ar[d]_{f_j} & X \ar[d]^f \\
Z_j \ar[r] & Y
}
$$
Suppose that $[W_j] \in Z_{k + r}(f^{-1}(Z_j))$
is rationally equivalent to $f_j^*\beta_j$ for some
$k$-cycle $\beta_j \in \CH_k(Z_j)$. Then
$\beta = \sum m_j \beta_j$ will be a $k$-cycle on $Y$
and $f^*\beta = \sum m_j f_j^*\beta_j$ will be rationally
equivalent to $\alpha$ (see
Remark \ref{remark-infinite-sums-rational-equivalences}).
This reduces us to the case $Y$ integral, and
$\alpha = [W]$ for some integral closed subscheme
of $X$ dominating $Y$. In particular we may
assume that $d = \dim_\delta(Y) < \infty$.

\medskip\noindent
Hence we can use induction on $d = \dim_\delta(Y)$.
If $d < k$, then $\CH_{k + r}(X) = 0$ and the lemma holds.
By assumption there exists a dense open $V \subset Y$ such
that $f^{-1}(V) \cong V \times \mathbf{A}^r$ as schemes over $V$.
Suppose that we can show that $\alpha|_{f^{-1}(V)} = f^*\beta$
for some $\beta \in Z_k(V)$. By Lemma \ref{lemma-exact-sequence-open}
we see that
$\beta = \beta'|_V$ for some $\beta' \in Z_k(Y)$.
By the exact sequence
$\CH_k(f^{-1}(Y \setminus V)) \to \CH_k(X) \to \CH_k(f^{-1}(V))$
of Lemma \ref{lemma-restrict-to-open}
we see that $\alpha - f^*\beta'$ comes from
a cycle $\alpha' \in \CH_{k + r}(f^{-1}(Y \setminus V))$.
Since $\dim_\delta(Y \setminus V) < d$ we win by
induction on $d$.

\medskip\noindent
Thus we may assume that $X = Y \times \mathbf{A}^r$.
In this case we can factor $f$ as
$$
X = Y \times \mathbf{A}^r \to
Y \times \mathbf{A}^{r - 1} \to \ldots \to
Y \times \mathbf{A}^1 \to Y.
$$
Hence it suffices to do the case $r = 1$. By the argument in the
second paragraph of the proof we are reduced to the case
$\alpha = [W]$, $Y$ integral, and $W \to Y$ dominant.
Again we can do induction on $d = \dim_\delta(Y)$.
If $W = Y \times \mathbf{A}^1$, then $[W] = f^*[Y]$.
Lastly, $W \subset Y \times \mathbf{A}^1$ is a proper inclusion,
then $W \to Y$ induces a finite field extension $R(Y) \subset R(W)$.
Let $P(T) \in R(Y)[T]$ be the monic irreducible polynomial such
that the generic fibre of $W \to Y$ is cut out by $P$ in
$\mathbf{A}^1_{R(Y)}$. Let $V \subset Y$ be a nonempty open such
that $P \in \Gamma(V, \mathcal{O}_Y)[T]$, and such that
$W \cap f^{-1}(V)$ is still cut out by $P$. Then we see that
$\alpha|_{f^{-1}(V)} \sim_{rat} 0$ and hence $\alpha \sim_{rat} \alpha'$
for some cycle $\alpha'$ on $(Y \setminus V) \times \mathbf{A}^1$.
By induction on the dimension we win.
\end{proof}

\begin{lemma}
\label{lemma-linebundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let
$$
p :
L = \underline{\Spec}(\text{Sym}^*(\mathcal{L}))
\longrightarrow
X
$$
be the associated vector bundle over $X$.
Then $p^* : \CH_k(X) \to \CH_{k + 1}(L)$ is an isomorphism for all $k$.
\end{lemma}

\begin{proof}
For surjectivity see Lemma \ref{lemma-pullback-affine-fibres-surjective}.
Let $o : X \to L$ be the zero section of $L \to X$, i.e., the morphism
corresponding to the surjection $\text{Sym}^*(\mathcal{L}) \to \mathcal{O}_X$
which maps $\mathcal{L}^{\otimes n}$ to zero for all $n > 0$.
Then $p \circ o = \text{id}_X$ and $o(X)$ is an effective
Cartier divisor on $L$. Hence by Lemma \ref{lemma-relative-effective-cartier}
we see that $o^* \circ p^* = \text{id}$ and we conclude that $p^*$ is
injective too.
\end{proof}

\begin{remark}
\label{remark-when-isomorphism}
We will see later (Lemma \ref{lemma-vectorbundle}) that if $X$ is a
vector bundle of rank $r$ over $Y$ then the pullback map
$\CH_k(Y) \to \CH_{k + r}(X)$
is an isomorphism. This is true whenever $X \to Y$ satisfies
the assumptions of Lemma \ref{lemma-pullback-affine-fibres-surjective}, see
\cite[Lemma 2.2]{Totaro-group}.
\end{remark}

\begin{lemma}
\label{lemma-linebundle-formulae}
In the situation of Lemma \ref{lemma-linebundle} denote $o : X \to L$
the zero section (see proof of the lemma). Then we have
\begin{enumerate}
\item $o(X)$ is the zero scheme of a regular global section of
$p^*\mathcal{L}^{\otimes -1}$,
\item $o_* : \CH_k(X) \to \CH_k(L)$ as $o$ is a closed immersion,
\item $o^* : \CH_{k + 1}(L) \to \CH_k(X)$ as $o(X)$
is an effective Cartier divisor,
\item $o^* p^* : \CH_k(X) \to \CH_k(X)$ is the identity map,
\item $o_*\alpha = - p^*(c_1(\mathcal{L}) \cap \alpha)$ for any
$\alpha \in \CH_k(X)$, and
\item $o^* o_* : \CH_k(X) \to \CH_{k - 1}(X)$ is equal to the map
$\alpha \mapsto - c_1(\mathcal{L}) \cap \alpha$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $p_*\mathcal{O}_L = \text{Sym}^*(\mathcal{L})$ we have
$p_*(p^*\mathcal{L}^{\otimes -1}) =
\text{Sym}^*(\mathcal{L}) \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes -1}$
by the projection formula
(Cohomology, Lemma \ref{cohomology-lemma-projection-formula})
and the section mentioned in (1) is
the canonical trivialization $\mathcal{O}_X \to
\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes -1}$.
We omit the proof that the vanishing locus of
this section is precisely $o(X)$. This proves (1).

\medskip\noindent
Parts (2), (3), and (4) we've seen in the course of the proof of
Lemma \ref{lemma-linebundle}. Of course (4) is the first
formula in Lemma \ref{lemma-relative-effective-cartier}.

\medskip\noindent
Part (5) follows from the second formula in
Lemma \ref{lemma-relative-effective-cartier},
additivity of capping with $c_1$ (Lemma \ref{lemma-c1-cap-additive}),
and the fact that capping with $c_1$ commutes with flat pullback
(Lemma \ref{lemma-flat-pullback-cap-c1}).

\medskip\noindent
Part (6) follows from Lemma \ref{lemma-gysin-back}
and the fact that $o^*p^*\mathcal{L} = \mathcal{L}$.
\end{proof}

\begin{lemma}
\label{lemma-decompose-section}
Let $Y$ be a scheme. Let $\mathcal{L}_i$, $i = 1, 2$ be invertible
$\mathcal{O}_Y$-modules. Let $s$ be a global section of
$\mathcal{L}_1 \otimes_{\mathcal{O}_X} \mathcal{L}_2$.
Denote $i : D \to X$ the zero scheme of $s$.
Then there exists a commutative diagram
$$
\xymatrix{
D_1 \ar[r]_{i_1} \ar[d]_{p_1} &
L \ar[d]^p &
D_2 \ar[l]^{i_2} \ar[d]^{p_2} \\
D \ar[r]^i &
Y &
D \ar[l]_i
}
$$
and sections $s_i$ of $p^*\mathcal{L}_i$ such that
the following hold:
\begin{enumerate}
\item $p^*s = s_1 \otimes s_2$,
\item $p$ is of finite type and flat of relative dimension $1$,
\item $D_i$ is the zero scheme of $s_i$,
\item $D_i \cong
\underline{\Spec}(\text{Sym}^*(\mathcal{L}_{1 - i}^{\otimes -1})|_D))$
over $D$ for $i = 1, 2$,
\item $p^{-1}D = D_1 \cup D_2$ (scheme theoretic union),
\item $D_1 \cap D_2$ (scheme theoretic intersection) maps
isomorphically to $D$, and
\item $D_1 \cap D_2 \to D_i$
is the zero section of the line bundle $D_i \to D$ for $i = 1, 2$.
\end{enumerate}
Moreover, the formation of this diagram and the sections $s_i$
commutes with arbitrary base change.
\end{lemma}

\begin{proof}
Let $p : X \to Y$ be the relative spectrum of the quasi-coherent
sheaf of $\mathcal{O}_Y$-algebras
$$
\mathcal{A} =
\left(\bigoplus\nolimits_{a_1, a_2 \geq 0}
\mathcal{L}_1^{\otimes -a_1} \otimes_{\mathcal{O}_Y}
\mathcal{L}_2^{\otimes -a_2}\right)/\mathcal{J}
$$
where $\mathcal{J}$ is the ideal generated by local sections of
the form $st - t$ for $t$ a local section of any summand
$\mathcal{L}_1^{\otimes -a_1} \otimes \mathcal{L}_2^{\otimes -a_2}$
with $a_1, a_2 > 0$. The sections $s_i$ viewed as maps
$p^*\mathcal{L}_i^{\otimes -1} \to \mathcal{O}_X$ are defined as the adjoints
of the maps $\mathcal{L}_i^{\otimes -1} \to \mathcal{A} = p_*\mathcal{O}_X$.
For any $y \in Y$ we can choose an affine
open $V \subset Y$, say $V = \Spec(B)$, containing $y$ and
trivializations $z_i : \mathcal{O}_V \to \mathcal{L}_i^{\otimes -1}|_V$.
Observe that $f = s(z_1z_2) \in A$ cuts out the closed subscheme $D$.
Then clearly
$$
p^{-1}(V) = \Spec(B[z_1, z_2]/(z_1 z_2 - f))
$$
Since $D_i$ is cut out by $z_i$ everything is clear.
\end{proof}

\begin{lemma}
\label{lemma-decompose-section-formulae}
In the situation of Lemma \ref{lemma-decompose-section}
assume $Y$ is locally of finite type over $(S, \delta)$ as in
Situation \ref{situation-setup}. Then we have
$i_1^*p^*\alpha = p_1^*i^*\alpha$
in $\CH_{k - 1}(D_1)$ for all $\alpha \in \CH_k(Y)$.
\end{lemma}

\begin{proof}
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension $k$.
We distinguish two cases.

\medskip\noindent
Assume $W \subset D$. Then
$i^*[W] = c_1(\mathcal{L}_1) \cap [W] + c_1(\mathcal{L}_2) \cap [W]$
in $\CH_{k - 1}(D)$ by our definition of gysin homomorphisms and the
additivity of Lemma \ref{lemma-c1-cap-additive}.
Hence $p_1^*i^*[W] =
p_1^*(c_1(\mathcal{L}_1) \cap [W]) + p_1^*(c_1(\mathcal{L}_2) \cap [W])$.
On the other hand, we have
$p^*[W] = [p^{-1}(W)]_{k + 1}$ by construction of flat pullback.
And $p^{-1}(W) = W_1 \cup W_2$ (scheme theoretically)
where $W_i = p_i^{-1}(W)$ is a line bundle over $W$
by the lemma (since formation of the diagram commutes with base change).
Then $[p^{-1}(W)]_{k + 1} = [W_1] + [W_2]$ as $W_i$ are integral closed
subschemes of $L$ of $\delta$-dimension $k + 1$. Hence
\begin{align*}
i_1^*p^*[W]
& =
i_1^*[p^{-1}(W)]_{k + 1} \\
& =
i_1^*([W_1] + [W_2]) \\
& =
c_1(p_1^*\mathcal{L}_1) \cap [W_1] + [W_1 \cap W_2]_k \\
& =
c_1(p_1^*\mathcal{L}_1) \cap p_1^*[W] + [W_1 \cap W_2]_k \\
& =
p_1^*(c_1(\mathcal{L}_1) \cap [W]) + [W_1 \cap W_2]_k
\end{align*}
by construction of gysin homomorphisms, the definition of flat pullback
(for the second equality), and compatibility of $c_1 \cap -$
with flat pullback (Lemma \ref{lemma-flat-pullback-cap-c1}).
Since $W_1 \cap W_2$ is the zero section of the line bundle
$W_1 \to W$ we see from Lemma \ref{lemma-linebundle-formulae}
that $[W_1 \cap W_2]_k = p_1^*(c_1(\mathcal{L}_2) \cap [W])$.
Note that here we use the fact that $D_1$ is the line bundle
which is the relative spectrum of the inverse of $\mathcal{L}_2$.
Thus we get the same thing as before.

\medskip\noindent
Assume $W \not \subset D$. In this case, both $i_1^*p^*[W]$
and $p_1^*i^*[W]$ are represented by the $k - 1$ cycle associated
to the scheme theoretic inverse image of $W$ in $D_1$.
\end{proof}

\begin{lemma}
\label{lemma-normal-cone-effective-Cartier}
In Situation \ref{situation-setup} let $X$ be a scheme locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$
be a triple as in Definition \ref{definition-gysin-homomorphism}.
There exists a commutative diagram
$$
\xymatrix{
D' \ar[r]_{i'} \ar[d]_p & X' \ar[d]^g \\
D \ar[r]^i & X
}
$$
such that
\begin{enumerate}
\item $p$ and $g$ are of finite type and flat of relative dimension $1$,
\item $p^* : \CH_k(D) \to \CH_{k + 1}(D')$ is injective for all $k$,
\item $D' \subset X'$ is the zero scheme of a global section
$s' \in \Gamma(X', \mathcal{O}_{X'})$,
\item $p^*i^* = (i')^*g^*$ as maps $\CH_k(X) \to \CH_k(D')$.
\end{enumerate}
Moreover, these properties remain true after arbitrary base change
by morphisms $Y \to X$ which are locally of finite type.
\end{lemma}

\begin{proof}
Observe that $(i')^*$ is defined because we have the triple
$(\mathcal{O}_{X'}, s', i' : D' \to X')$ as in
Definition \ref{definition-gysin-homomorphism}. Thus the statement makes sense.

\medskip\noindent
Set $\mathcal{L}_1 = \mathcal{O}_X$, $\mathcal{L}_2 = \mathcal{L}$
and apply Lemma \ref{lemma-decompose-section} with the section $s$ of
$\mathcal{L} = \mathcal{L}_1 \otimes_{\mathcal{O}_X} \mathcal{L}_2$.
Take $D' = D_1$. The results now follow from the lemma, from
Lemma \ref{lemma-decompose-section-formulae}
and injectivity by
Lemma \ref{lemma-linebundle}.
\end{proof}











\section{Bivariant intersection theory}
\label{section-bivariant}

\noindent
In order to intelligently talk about higher chern classes of vector
bundles we introduce bivariant chow classes as in \cite{F}.
Our definition differs from \cite{F} in two respects:
(1) we work in a different setting, and (2) we only require
our bivariant classes commute with the gysin homomorphisms for
zero schemes of sections of invertible modules
(Section \ref{section-intersecting-effective-Cartier}).
We will see later, in Lemma \ref{lemma-gysin-commutes}, that our
bivariant classes commute with all higher codimension gysin homomorphisms
and hence satisfy all properties required of them in \cite{F}; see
also \cite[Theorem 17.1]{F}.

\begin{definition}
\label{definition-bivariant-class}
\begin{reference}
Similar to \cite[Definition 17.1]{F}
\end{reference}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $p \in \mathbf{Z}$.
A {\it bivariant class $c$ of degree $p$ for $f$} is given by a rule
which assigns to every locally of finite type morphism $Y' \to Y$
and every $k$ a map
$$
c \cap - : \CH_k(Y') \longrightarrow \CH_{k - p}(X')
$$
where $X' = Y' \times_Y X$, satisfying the following conditions
\begin{enumerate}
\item if $Y'' \to Y'$ is a proper, then
$c \cap (Y'' \to Y')_*\alpha'' = (X'' \to X')_*(c \cap \alpha'')$
for all $\alpha''$ on $Y''$ where $X'' = Y'' \times_Y X$,
\item if $Y'' \to Y'$ is flat locally of finite type of
fixed relative dimension, then
$c \cap (Y'' \to Y')^*\alpha' = (X'' \to X')^*(c \cap \alpha')$
for all $\alpha'$ on $Y'$, and
\item if $(\mathcal{L}', s', i' : D' \to Y')$ is as in
Definition \ref{definition-gysin-homomorphism}
with pullback $(\mathcal{N}', t', j' : E' \to X')$ to $X'$,
then we have $c \cap (i')^*\alpha' = (j')^*(c \cap \alpha')$
for all $\alpha'$ on $Y'$.
\end{enumerate}
The collection of all bivariant classes of degree $p$ for $f$ is
denoted $A^p(X \to Y)$.
\end{definition}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X \to Y$
and $Y \to Z$
be morphisms of schemes locally of finite type over $S$. Let
$p \in \mathbf{Z}$. It is clear that $A^p(X \to Y)$ is an abelian group.
Moreover, it is clear that we have a bilinear composition
$$
A^p(X \to Y) \times A^q(Y \to Z) \to A^{p + q}(X \to Z)
$$
which is associative.

\begin{lemma}
\label{lemma-flat-pullback-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$
between schemes locally of finite type over $S$.
Then the rule that to $Y' \to Y$ assignes
$(f')^* : \CH_k(Y') \to \CH_{k + r}(X')$ where $X' = X \times_Y Y'$
is a bivariant class of degree $-r$.
\end{lemma}

\begin{proof}
This follows from
Lemmas \ref{lemma-flat-pullback-rational-equivalence},
\ref{lemma-compose-flat-pullback},
\ref{lemma-flat-pullback-proper-pushforward}, and
\ref{lemma-gysin-flat-pullback}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be a triple as in
Definition \ref{definition-gysin-homomorphism}.
Then the rule that to $f : X' \to X$ assignes
$(i')^* : \CH_k(X') \to \CH_{k - 1}(D')$ where $D' = D \times_X X'$
is a bivariant class of degree $1$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-gysin-factors},
\ref{lemma-closed-in-X-gysin},
\ref{lemma-gysin-flat-pullback}, and
\ref{lemma-gysin-commutes-gysin}.
\end{proof}

\begin{lemma}
\label{lemma-push-proper-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of
schemes locally of finite type over $S$.
Let $c \in A^p(X \to Z)$ and assume $f$ is proper.
Then the rule that to $Z' \to Z$ assignes
$\alpha \longmapsto f'_*(c \cap \alpha)$
is a bivariant class denoted $f_* \circ c \in A^p(Y \to Z)$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-compose-pushforward},
\ref{lemma-flat-pullback-proper-pushforward}, and
\ref{lemma-closed-in-X-gysin}.
\end{proof}

\begin{remark}
\label{remark-restriction-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X \to Y$
and $Y' \to Y$ be morphisms of schemes locally of finite type over $S$.
Let $X' = Y' \times_Y X$. Then there is an obvious restriction map
$$
A^p(X \to Y) \longrightarrow A^p(X' \to Y'),\quad
c \longmapsto res(c)
$$
obtained by viewing a scheme $Y''$ locally of finite type over $Y'$
as a scheme locally of finite type over $Y$ and settting
$res(c) \cap \alpha'' = c \cap \alpha''$ for any $\alpha'' \in \CH_k(Y'')$.
This restriction operation is compatible with compositions in an
obvious manner.
\end{remark}

\begin{remark}
\label{remark-bivariant-commute}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. For $i = 1, 2$ let $Z_i \to X$
be a morphism of schemes locally of finite type. Let
$c_i \in A^{p_i}(Z_i \to X)$, $i = 1, 2$ be bivariant classes.
For any $\alpha \in \CH_k(X)$ we can ask whether
$$
c_1 \cap c_2 \cap \alpha = c_2 \cap c_1 \cap \alpha
$$
in $\CH_{k - p_1 - p_2}(Z_1 \times_X Z_2)$. If this is true and if it holds
after any base change by $X' \to X$ locally of finite type, then we say
$c_1$ and $c_2$ {\it commute}. Of course this is the same thing as saying that
$$
res(c_1) \circ c_2 = res(c_2) \circ c_1
$$
in $A^{p_1 + p_2}(Z_1 \times_X Z_2 \to X)$. Here
$res(c_1) \in A^{p_1}(Z_1 \times_X Z_2 \to Z_2)$ is the restriction of $c_1$
as in Remark \ref{remark-restriction-bivariant}; similarly for $res(c_2)$.
\end{remark}

\begin{example}
\label{example-gysin-commute}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$ a triple as in
Definition \ref{definition-gysin-homomorphism}. Let $Z \to X$ be a morphism
of schemes locally of finite type and let $c \in A^p(Z \to X)$ be a
bivariant class. Then the bivariant gysin class $c' \in A^1(D \to X)$ of
Lemma \ref{lemma-gysin-bivariant} commutes with $c$ in the sense of
Remark \ref{remark-bivariant-commute}. Namely, this is a restatement of
condition (3) of Definition \ref{definition-bivariant-class}.
\end{example}

\begin{remark}
\label{remark-more-general-bivariant}
There is a more general type of bivariant class that doesn't seem to be
considered in the literature. Namely, suppose we are given a diagram
$$
X \longrightarrow Z \longleftarrow Y
$$
of schemes locally of finite type over $(S, \delta)$ as in
Situation \ref{situation-setup}. Let $p \in \mathbf{Z}$.
Then we can consider a rule $c$ which assigns to every $Z' \to Z$
locally of finite type maps
$$
c \cap - : \CH_k(Y') \longrightarrow \CH_{k - p}(X')
$$
for all $k \in \mathbf{Z}$
where $X' = X \times_Z Z'$ and $Y' = Z' \times_Z Y$ compatible with
\begin{enumerate}
\item proper pushforward if given $Z'' \to Z'$ proper,
\item flat pullback if given $Z'' \to Z'$ flat
of fixed relative dimension, and
\item gysin maps if given $D' \subset Z'$ as in
Definition \ref{definition-gysin-homomorphism}.
\end{enumerate}
We omit the detailed formulations. Suppose we denote the collection
of all such operations $A^p(X \to Z \leftarrow Y)$. A simple example
of the utility of this concept is when we have a proper morphism
$f : X_2 \to X_1$. Then $f_*$ isn't a bivariant operation in the sense of
Definition \ref{definition-bivariant-class} but it is in the
above generalized sense, namely, $f_* \in A^0(X_1 \to X_1 \leftarrow X_2)$.
\end{remark}





\section{Chow cohomology and the first chern class}
\label{section-chow-cohomology}

\noindent
We will be most interested in $A^p(X) = A^p(X \to X)$, which will always mean
the bivariant cohomology classes for $\text{id}_X$. Namely, that is where
chern classes will live.

\begin{definition}
\label{definition-chow-cohomology}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. The {\it Chow cohomology}
of $X$ is the graded $\mathbf{Z}$-algebra $A^*(X)$ whose degree
$p$ component is $A^p(X \to X)$.
\end{definition}

\noindent
Warning: It is not clear that the $\mathbf{Z}$-algebra structure
on $A^*(X)$ is commutative, but we will see that chern classes live
in its center.

\begin{remark}
\label{remark-pullback-cohomology}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : Y' \to Y$ be a morphism of schemes locally of finite type over $S$.
As a special case of Remark \ref{remark-restriction-bivariant}
there is a canonical $\mathbf{Z}$-algebra map $res : A^*(Y) \to A^*(Y')$.
This map is often denoted $f^*$ in the literature.
\end{remark}

\begin{lemma}
\label{lemma-cap-c1-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Then the rule that to $f : X' \to X$ assignes
$c_1(f^*\mathcal{L}) \cap - : \CH_k(X') \to \CH_{k - 1}(X')$
is a bivariant class of degree $1$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-factors},
\ref{lemma-pushforward-cap-c1},
\ref{lemma-flat-pullback-cap-c1}, and
\ref{lemma-gysin-commutes-cap-c1}.
\end{proof}

\noindent
The lemma above finally allows us to make the following definition.

\begin{definition}
\label{definition-first-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$
be locally of finite type over $S$. Let $\mathcal{L}$ be an invertible
$\mathcal{O}_X$-module. The {\it first chern class}
$c_1(\mathcal{L}) \in A^1(X)$ of $\mathcal{L}$
is the bivariant class of Lemma \ref{lemma-cap-c1-bivariant}.
\end{definition}

\noindent
For finite locally free modules we construct the chern classes in
Section \ref{section-intersecting-chern-classes}.
Let us prove that $c_1(\mathcal{L})$ is in the center of $A^*(X)$.

\begin{lemma}
\label{lemma-c1-center}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Then
\begin{enumerate}
\item $c_1(\mathcal{L}) \in A^1(X)$ is in the center of $A^*(X)$ and
\item if $f : X' \to X$ is locally of finite type and $c \in A^*(X' \to X)$,
then $c \circ c_1(\mathcal{L}) = c_1(f^*\mathcal{L}) \circ c$.
\end{enumerate}
\end{lemma}

\begin{proof}
Of course (2) implies (1).
Let $p : L \to X$ be as in Lemma \ref{lemma-linebundle} and let $o : X \to L$
be the zero section. Denote $p' : L' \to X'$ and $o' : X' \to L'$
their base changes. By Lemma \ref{lemma-linebundle-formulae} we have
$$
p^*(c_1(\mathcal{L}) \cap \alpha) = - o_* \alpha
\quad\text{and}\quad
(p')^*(c_1(f^*\mathcal{L}) \cap \alpha') = - o'_* \alpha'
$$
Since $c$ is a bivariant class we have
\begin{align*}
(p')^*(c \cap c_1(\mathcal{L}) \cap \alpha)
& =
c \cap p^*(c_1(\mathcal{L}) \cap \alpha) \\
& =
- c \cap o_* \alpha \\
& =
- o'_*(c \cap \alpha) \\
& =
(p')^*(c_1(f^*\mathcal{L}) \cap c \cap \alpha)
\end{align*}
Since $(p')^*$ is injective by one of the lemmas cited above we obtain
$c \cap c_1(\mathcal{L}) \cap \alpha =
c_1(f^*\mathcal{L}) \cap c \cap \alpha$.
The same is true after any base change by $Y \to X$ locally of finite type
and hence we have the equality of bivariant classes stated in (2).
\end{proof}

\begin{lemma}
\label{lemma-vanish-above-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a
finite type scheme over $S$ which has an ample invertible sheaf.
Assume $d = \dim(X) < \infty$ (here we really mean dimension and
not $\delta$-dimension).
Then for any invertible sheaves $\mathcal{L}_1, \ldots, \mathcal{L}_{d + 1}$
on $X$ we have
$c_1(\mathcal{L}_1) \circ \ldots \circ c_1(\mathcal{L}_{d + 1}) = 0$
in $A^{d + 1}(X)$.
\end{lemma}

\begin{proof}
We prove this by induction on $d$. The base case $d = 0$ is true because
in this case $X$ is a finite set of closed points and hence every invertible
module is trivial. Assume $d > 0$. By Divisors, Lemma
\ref{divisors-lemma-quasi-projective-Noetherian-pic-effective-Cartier}
we can write $\mathcal{L}_{d + 1} \cong \mathcal{O}_X(D) \otimes
\mathcal{O}_X(D')^{\otimes -1}$ for some effective Cartier divisors
$D, D' \subset X$. Then $c_1(\mathcal{L}_{d + 1})$ is the difference
of $c_1(\mathcal{O}_X(D))$ and $c_1(\mathcal{O}_X(D'))$ and hence
we may assume $\mathcal{L}_{d + 1} = \mathcal{O}_X(D)$ for some
effective Cartier divisor.

\medskip\noindent
Denote $i : D \to X$ the inclusion morphism and denote
$i^* \in A^1(D \to X)$ the bivariant class given by the
gysin hommomorphism as in Lemma \ref{lemma-gysin-bivariant}.
We have $i_* \circ i^* = c_1(\mathcal{L}_{d + 1})$
in $A^1(X)$ by Lemma \ref{lemma-support-cap-effective-Cartier}
(and Lemma \ref{lemma-push-proper-bivariant}
to make sense of the left hand side).
Since $c_1(\mathcal{L}_i)$ commutes with
both $i_*$ and $i^*$ (by definition of bivariant classes)
we conclude that
$$
c_1(\mathcal{L}_1) \circ \ldots \circ c_1(\mathcal{L}_{d + 1}) =
i_* \circ c_1(\mathcal{L}_1) \circ \ldots \circ c_1(\mathcal{L}_d) \circ i^* =
i_* \circ c_1(\mathcal{L}_1|_D) \circ \ldots \circ c_1(\mathcal{L}_d|_D)
\circ i^*
$$
Thus we conclude by induction on $d$. Namely, we have $\dim(D) < d$
as none of the generic points of $X$ are in $D$.
\end{proof}

\begin{remark}
\label{remark-ring-loc-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $Z \to X$ be a closed immersion of schemes locally of
finite type over $S$ and let $p \geq 0$. In this setting we define
$$
A^{(p)}(Z \to X) =
\prod\nolimits_{i \leq p - 1} A^i(X) \times
\prod\nolimits_{i \geq p} A^i(Z \to X).
$$
Then $A^{(p)}(Z \to X)$ canonically comes equipped with the structure
of a graded algebra. In fact, more generally there is a multiplication
$$
A^{(p)}(Z \to X) \times A^{(q)}(Z \to X)
\longrightarrow A^{(\max(p, q))}(Z \to X)
$$
In order to define these we define maps
\begin{align*}
A^i(Z \to X) \times A^j(X) & \to A^{i + j}(Z \to X) \\
A^i(X) \times A^j(Z \to X) & \to A^{i + j}(Z \to X) \\
A^i(Z \to X) \times A^j(Z \to X) & \to A^{i + j}(Z \to X)
\end{align*}
For the first we use composition of bivariant classes.
For the second we use restriction
$A^i(X) \to A^i(Z)$ (Remark \ref{remark-restriction-bivariant}) and
composition $A^i(Z) \times A^j(Z \to X) \to A^{i + j}(Z \to X)$.
For the third, we send $(c, c')$ to $res(c) \circ c'$
where $res : A^i(Z \to X) \to A^i(Z)$ is the restriction map (see
Remark \ref{remark-restriction-bivariant}). We omit the
verification that these multiplications are associative in a suitable sense.
\end{remark}

\begin{remark}
\label{remark-res-push}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $Z \to X$ be a closed immersion of schemes locally of
finite type over $S$. Denote $res : A^p(Z \to X) \to A^p(Z)$
the restriction map of Remark \ref{remark-restriction-bivariant}.
For $c \in A^p(Z \to X)$ we have
$res(c) \cap \alpha = c \cap i_*\alpha$ for $\alpha \in \CH_*(Z)$.
Namely $res(c) \cap \alpha = c \cap \alpha$
and compatibility of $c$ with proper pushforward
gives $(Z \to Z)_*(c \cap \alpha) = c \cap (Z \to X)_*\alpha$.
\end{remark}






\section{Lemmas on bivariant classes}
\label{section-bivariant-II}

\noindent
In this section we prove some elementary results on bivariant classes.
Here is a criterion to see that an operation
passes through rational equivalence.

\begin{lemma}
\label{lemma-factors-through-rational-equivalence}
\begin{reference}
Very weak form of \cite[Theorem 17.1]{F}
\end{reference}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $p \in \mathbf{Z}$. Suppose given a rule
which assigns to every locally of finite type morphism $Y' \to Y$
and every $k$ a map
$$
c \cap - : Z_k(Y') \longrightarrow \CH_{k - p}(X')
$$
where $Y' = X' \times_X Y$, satisfying condition (3) of
Definition \ref{definition-bivariant-class}
whenever $\mathcal{L}'|_{D'} \cong \mathcal{O}_{D'}$. Then
$c \cap -$ factors through rational equivalence.
\end{lemma}

\begin{proof}
The statement makes sense because given a triple
$(\mathcal{L}, s, i : D \to X)$ as in
Definition \ref{definition-gysin-homomorphism}
such that $\mathcal{L}|_D \cong \mathcal{O}_D$, then
the operation $i^*$ is defined on the level of cycles, see
Remark \ref{remark-gysin-on-cycles}.
Let $\alpha \in Z_k(X')$ be a cycle which is rationally equivalent to zero.
We have to show that $c \cap \alpha = 0$. By
Lemma \ref{lemma-rational-equivalence-family}
there exists a cycle $\beta \in Z_{k + 1}(X' \times \mathbf{P}^1)$
such that $\alpha = i_0^*\beta - i_\infty^*\beta$
where $i_0, i_\infty : X' \to X' \times \mathbf{P}^1$ are the
closed immersions of $X'$ over $0, \infty$. Since these are
examples of effective Cartier divisors with trivial normal
bundles, we see that $c \cap i_0^*\beta = j_0^*(c \cap \beta)$
and $c \cap i_\infty^*\beta = j_\infty^*(c \cap \beta)$
where $j_0, j_\infty : Y' \to Y' \times \mathbf{P}^1$ are
closed immersions as before. Since
$j_0^*(c \cap \beta) \sim_{rat} j_\infty^*(c \cap \beta)$
(follows from Lemma \ref{lemma-rational-equivalence-family}) we conclude.
\end{proof}

\begin{lemma}
\label{lemma-bivariant-weaker}
\begin{reference}
Weak form of \cite[Theorem 17.1]{F}
\end{reference}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $p \in \mathbf{Z}$. Suppose given a rule
which assigns to every locally of finite type morphism $Y' \to Y$
and every $k$ a map
$$
c \cap - : \CH_k(Y') \longrightarrow \CH_{k - p}(X')
$$
where $Y' = X' \times_X Y$, satisfying conditions (1), (2) of
Definition \ref{definition-bivariant-class}
and condition (3) whenever $\mathcal{L}'|_{D'} \cong \mathcal{O}_{D'}$. Then
$c \cap -$ is a bivariant class.
\end{lemma}

\begin{proof}
Let $Y' \to Y$ be a morphism of schemes which is locally of finite type.
Let $(\mathcal{L}', s', i' : D' \to Y')$ be as in
Definition \ref{definition-gysin-homomorphism}
with pullback $(\mathcal{N}', t', j' : E' \to X')$ to $X'$.
We have to show that $c \cap (i')^*\alpha' = (j')^*(c \cap \alpha')$
for all $\alpha' \in \CH_k(Y')$.

\medskip\noindent
Denote $g : Y'' \to Y'$ the smooth morphism of relative
dimension $1$ with $i'' : D'' \to Y''$ and $p : D'' \to D'$
constructed in Lemma \ref{lemma-normal-cone-effective-Cartier}.
(Warning: $D''$ isn't the full inverse image of $D'$.)
Denote $f : X'' \to X'$ and $E'' \subset X''$
their base changes by $X' \to Y'$. Picture
$$
\xymatrix{
& X'' \ar[rr] \ar'[d][dd]_h & & Y'' \ar[dd]^g \\
E'' \ar[rr] \ar[dd]_q \ar[ru]^{j''} & & D'' \ar[dd]^p \ar[ru]^{i''} & \\
& X' \ar'[r][rr] & & Y' \\
E' \ar[rr] \ar[ru]^{j'} & & D' \ar[ru]^{i'}
}
$$
By the properties given in the lemma we know that $\beta' = (i')^*\alpha'$
is the unique element of $\CH_{k - 1}(D')$ such that
$p^*\beta' = (i'')^*g^*\alpha'$. Similarly, we know that
$\gamma' = (j')^*(c \cap \alpha')$ is the unique element of
$\CH_{k - 1 - p}(E')$ such that $q^*\gamma' = (j'')^*h^*(c \cap \alpha')$.
Since we know that
$$
(j'')^*h^*(c \cap \alpha') =
(j'')^*(c \cap g^*\alpha') =
c \cap (i'')^*g^*\alpha'
$$
by our assuptions on $c$; note that the modified version of (3)
assumed in the statement of the lemma applies to $i''$
and its base change $j''$. We similarly know that
$$
q^*(c \cap \beta') = c \cap p^*\beta'
$$
We conclude that $\gamma' = c \cap \beta'$ by the uniqueness pointed
out above.
\end{proof}

\noindent
Here a criterion for when a bivariant class is zero.

\begin{lemma}
\label{lemma-bivariant-zero}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $c \in A^p(X \to Y)$. For $Y'' \to Y' \to Y$ set
$X'' = Y'' \times_Y X$ and $X' = Y' \times_Y X$.
The following are equivalent
\begin{enumerate}
\item $c$ is zero,
\item $c \cap [Y'] = 0$ in $\CH_*(X')$ for every integral scheme $Y'$
locally of finite type over $Y$, and
\item for every integral scheme $Y'$ locally of finite type over $Y$,
there exists a proper birational morphism $Y'' \to Y'$ such that
$c \cap [Y''] = 0$ in $\CH_*(X'')$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (1) $\Rightarrow$ (2) $\Rightarrow$ (3) are clear.
Assumption (3) implies (2) because $(Y'' \to Y')_*[Y''] = [Y']$
and hence $c \cap [Y'] = (X'' \to X')_*(c \cap [Y''])$ as $c$
is a bivariant class. Assume (2).
Let $Y' \to Y$ be locally of finite type. Let $\alpha \in \CH_k(Y')$.
Write $\alpha = \sum n_i [Y'_i]$ with $Y'_i \subset Y'$ a locally finite
collection of integral closed subschemes of $\delta$-dimension $k$.
Then we see that $\alpha$ is pushforward of the cycle
$\alpha' = \sum n_i[Y'_i]$ on $Y'' = \coprod Y'_i$ under the
proper morphism $Y'' \to Y'$. By the properties of bivariant
classes it suffices to prove that $c \cap \alpha' = 0$ in $\CH_{k - p}(X'')$.
We have $\CH_{k - p}(X'') = \prod \CH_{k - p}(X'_i)$ where
$X'_i = Y'_i \times_Y X$. This follows immediately
from the definitions. The projection maps
$\CH_{k - p}(X'') \to \CH_{k - p}(X'_i)$ are given by flat pullback.
Since capping with $c$ commutes with
flat pullback, we see that it suffices to show that $c \cap [Y'_i]$
is zero in $\CH_{k - p}(X'_i)$ which is true by assumption.
\end{proof}

\begin{lemma}
\label{lemma-disjoint-decomposition-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Assume we have disjoint union decompositions
$X = \coprod_{i \in I} X_i$ and $Y = \coprod_{j \in J} Y_j$
by open and closed subschemes
and a map $a : I \to J$ of sets such that $f(X_i) \subset Y_{a(i)}$.
Then
$$
A^p(X \to Y) = \prod\nolimits_{i \in I} A^p(X_i \to Y_{a(i)})
$$
\end{lemma}

\begin{proof}
Suppose given an element $(c_i) \in \prod_i A^p(X_i \to Y_{a(i)})$.
Then given $\beta \in \CH_k(Y)$ we can map this to the element of
$\CH_{k - p}(X)$ whose restriction to $X_i$ is $c_i \cap \beta|_{Y_{a(i)}}$.
This works because $\CH_{k - p}(X) = \prod_i \CH_{k - p}(X_i)$.
The same construction works after base change by any $Y' \to Y$
locally of finite type and we get $c \in A^p(X \to Y)$.
Thus we obtain a map $\Psi$ from the right hand side of the formula
to the left hand side of the formula.
Conversely, given $c \in A^p(X \to Y)$ and an element
$\beta_i \in \CH_k(Y_{a(i)})$ we can consider the element
$(c \cap (Y_{a(i)} \to Y)_*\beta_i)|_{X_i}$ in $\CH_{k - p}(X_i)$.
The same thing works after base change by any $Y' \to Y$
locally of finite type and we get $c_i \in A^p(X_i \to Y_{a(i)})$.
Thus we obtain a map $\Phi$ from the left hand
side of the formula to the right hand side of the formula.
It is immediate that $\Phi \circ \Psi = \text{id}$.
For the converse, suppose that $c \in A^p(X \to Y)$ and
$\beta \in \CH_k(Y)$. Say $\Phi(c) = (c_i)$. Let $j \in J$.
Because $c$ commutes with flat pullback we get
$$
(c \cap \beta)|_{\coprod_{a(i) = j} X_i} =
c \cap \beta|_{Y_j}
$$
Because $c$ commutes with proper pushforward we get
$$
(\coprod\nolimits_{a(i) = j} X_i \to X)_*
((c \cap \beta)|_{\coprod_{a(i) = j} X_i})
=
c \cap (Y_j \to Y)_*\beta|_{Y_j}
$$
The left hand side is the cycle on $X$ restricting to $(c \cap \beta)|_{X_i}$
on $X_i$ for $i \in I$ with $a(i) = j$ and $0$ else.
The right hand side is a cycle on $X$ whose restriction to $X_i$
is $c_i \cap \beta|_{Y_j}$ for $i \in I$ with $a(i) = j$.
Thus $c \cap \beta = \Psi((c_i))$ as desired.
\end{proof}

\begin{remark}
\label{remark-completion-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $X = \coprod_{i \in I} X_i$ and $Y = \coprod_{j \in J} Y_j$
be the decomposition of $X$ and $Y$ into their connected components
(the connected components are open as $X$ and $Y$ are locally Noetherian, see
Topology, Lemma \ref{topology-lemma-locally-Noetherian-locally-connected} and
Properties, Lemma \ref{properties-lemma-Noetherian-topology}).
Let $a(i) \in J$ be the index such that $f(X_i) \subset Y_{a(i)}$.
Then $A^p(X \to Y) = \prod A^p(X_i \to Y_{a(i)})$ by
Lemma \ref{lemma-disjoint-decomposition-bivariant}.
In this setting it is convenient to set
$$
A^*(X \to Y)^\wedge = \prod\nolimits_i A^*(X_i \to Y_{a(i)})
$$
as a kind of natural completion of the graded $\mathbf{Z}$-module
$A^*(X \to Y)$ of bivariant classes (we omit specifying the precise
sense in which this is a completion). As a special case we set
$$
A^*(X)^\wedge = \prod A^*(X_i)
$$
If $Y \to Z$ is a second morphism, then the
composition $A^*(X \to Y) \times A^*(Y \to Z) \to A^*(X \to Z)$
extends to a composition
$A^*(X \to Y)^\wedge \times A^*(Y \to Z)^\wedge \to A^*(X \to Z)^\wedge$
of completions.
\end{remark}
















\section{Projective space bundle formula}
\label{section-projective-space-bundle-formula}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Consider a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$.
Our convention is that the {\it projective bundle associated to
$\mathcal{E}$} is the morphism
$$
\xymatrix{
\mathbf{P}(\mathcal{E}) =
\underline{\text{Proj}}_X(\text{Sym}^*(\mathcal{E}))
\ar[r]^-\pi
& X
}
$$
over $X$ with
$\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$ normalized so that
$\pi_*(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)) = \mathcal{E}$.
In particular there is a surjection
$\pi^*\mathcal{E} \to \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
We will say informally ``let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$'' to denote
the situation where $P = \mathbf{P}(\mathcal{E})$ and
$\mathcal{O}_P(1) = \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.

\begin{lemma}
\label{lemma-cap-projective-bundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
For any $\alpha \in \CH_k(X)$ the element
$$
\pi_*\left(
c_1(\mathcal{O}_P(1))^s \cap \pi^*\alpha
\right)
\in
\CH_{k + r - 1 - s}(X)
$$
is $0$ if $s < r - 1$ and is equal to $\alpha$ when $s = r - 1$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
Note that $\pi^*[Z] = [\pi^{-1}(Z)]$ as $\pi^{-1}(Z)$ is integral of
$\delta$-dimension $r - 1$.
If $s < r - 1$, then by construction
$c_1(\mathcal{O}_P(1))^s \cap \pi^*[Z]$
is represented by a $(k + r - 1 - s)$-cycle supported on
$\pi^{-1}(Z)$. Hence the pushforward of this cycle
is zero for dimension reasons.

\medskip\noindent
Let $s = r - 1$. By the argument given above we see that
$\pi_*(c_1(\mathcal{O}_P(1))^s \cap \pi^*\alpha) = n [Z]$
for some $n \in \mathbf{Z}$. We want to show that $n = 1$.
For the same dimension reasons
as above it suffices to prove this result after replacing $X$ by
$X \setminus T$ where $T \subset Z$ is a proper closed subset.
Let $\xi$ be the generic point of $Z$.
We can choose elements $e_1, \ldots, e_{r - 1} \in \mathcal{E}_\xi$
which form part of a basis of $\mathcal{E}_\xi$.
These give rational sections $s_1, \ldots, s_{r - 1}$
of $\mathcal{O}_P(1)|_{\pi^{-1}(Z)}$ whose common zero set
is the closure of the image a rational section of
$\mathbf{P}(\mathcal{E}|_Z) \to Z$ union a closed subset whose
support maps to a proper closed subset $T$ of $Z$.
After removing $T$ from $X$ (and correspondingly $\pi^{-1}(T)$
from $P$), we see that $s_1, \ldots, s_n$ form a sequence
of global sections
$s_i \in \Gamma(\pi^{-1}(Z), \mathcal{O}_{\pi^{-1}(Z)}(1))$
whose common zero set is the image of a section $Z \to \pi^{-1}(Z)$.
Hence we see successively that
\begin{eqnarray*}
\pi^*[Z] & = & [\pi^{-1}(Z)] \\
c_1(\mathcal{O}_P(1)) \cap \pi^*[Z] & = & [Z(s_1)] \\
c_1(\mathcal{O}_P(1))^2 \cap \pi^*[Z] & = & [Z(s_1) \cap Z(s_2)] \\
\ldots & = & \ldots \\
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*[Z] & = &
[Z(s_1) \cap \ldots \cap Z(s_{r - 1})]
\end{eqnarray*}
by repeated applications of Lemma \ref{lemma-geometric-cap}.
Since the pushforward by $\pi$ of the image of a
section of $\pi$ over $Z$ is clearly $[Z]$ we see the result
when $\alpha = [Z]$. We omit the verification that these
arguments imply the result for a general cycle $\alpha = \sum n_j [Z_j]$.
\end{proof}

\begin{lemma}[Projective space bundle formula]
\label{lemma-chow-ring-projective-bundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
The map
$$
\bigoplus\nolimits_{i = 0}^{r - 1}
\CH_{k + i}(X)
\longrightarrow
\CH_{k + r - 1}(P),
$$
$$
(\alpha_0, \ldots, \alpha_{r-1})
\longmapsto
\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*\alpha_{r-1}
$$
is an isomorphism.
\end{lemma}

\begin{proof}
Fix $k \in \mathbf{Z}$. We first show the map is injective.
Suppose that $(\alpha_0, \ldots, \alpha_{r - 1})$ is an element
of the left hand side that maps to zero.
By Lemma \ref{lemma-cap-projective-bundle} we see that
$$
0 = \pi_*(\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*\alpha_{r-1})
= \alpha_{r - 1}
$$
Next, we see that
$$
0 = \pi_*(c_1(\mathcal{O}_P(1)) \cap (\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 2} \cap \pi^*\alpha_{r - 2}))
= \alpha_{r - 2}
$$
and so on. Hence the map is injective.

\medskip\noindent
It remains to show the map is surjective.
Let $X_i$, $i \in I$ be the irreducible components of $X$.
Then $P_i = \mathbf{P}(\mathcal{E}|_{X_i})$, $i \in I$
are the irreducible components of $P$. Consider the commutative
diagram
$$
\xymatrix{
\coprod P_i \ar[d]_{\coprod \pi_i} \ar[r]_p & P \ar[d]^\pi \\
\coprod X_i \ar[r]^q & X
}
$$
Observe that $p_*$ is surjective. If $\beta \in \CH_k(\coprod X_i)$
then $\pi^* q_* \beta = p_*(\coprod \pi_i)^* \beta$, see
Lemma \ref{lemma-flat-pullback-proper-pushforward}. Similarly for
capping with $c_1(\mathcal{O}(1))$ by
Lemma \ref{lemma-pushforward-cap-c1}.
Hence, if the map of the lemma is surjective for each
of the morphisms $\pi_i : P_i \to X_i$, then the map is
surjective for $\pi : P \to X$. Hence we may assume $X$ is irreducible.
Thus $\dim_\delta(X) < \infty$ and in particular we may use
induction on $\dim_\delta(X)$.

\medskip\noindent
The result is clear if $\dim_\delta(X) < k$.
Let $\alpha \in \CH_{k + r - 1}(P)$.
For any locally closed subscheme $T \subset X$ denote
$\gamma_T : \bigoplus \CH_{k + i}(T) \to \CH_{k + r - 1}(\pi^{-1}(T))$
the map
$$
\gamma_T(\alpha_0, \ldots, \alpha_{r - 1})
= \pi^*\alpha_0 + \ldots +
c_1(\mathcal{O}_{\pi^{-1}(T)}(1))^{r - 1} \cap \pi^*\alpha_{r - 1}.
$$
Suppose for some nonempty open $U \subset X$ we have
$\alpha|_{\pi^{-1}(U)} = \gamma_U(\alpha_0, \ldots, \alpha_{r - 1})$.
Then we may choose lifts $\alpha'_i \in \CH_{k + i}(X)$ and we
see that $\alpha - \gamma_X(\alpha'_0, \ldots, \alpha'_{r - 1})$
is by Lemma \ref{lemma-restrict-to-open}
rationally equivalent to a $k$-cycle on $P_Y = \mathbf{P}(\mathcal{E}|_Y)$
where $Y = X \setminus U$ as a reduced closed subscheme.
Note that $\dim_\delta(Y) < \dim_\delta(X)$.
By induction the result holds
for $P_Y \to Y$ and hence the result holds for $\alpha$.
Hence we may replace $X$ by any nonempty open of $X$.

\medskip\noindent
In particular we may assume that $\mathcal{E} \cong \mathcal{O}_X^{\oplus r}$.
In this case $\mathbf{P}(\mathcal{E}) = X \times \mathbf{P}^{r - 1}$.
Let us use the stratification
$$
\mathbf{P}^{r - 1} = \mathbf{A}^{r - 1}
\amalg \mathbf{A}^{r - 2}
\amalg \ldots
\amalg \mathbf{A}^0
$$
The closure of each stratum is a $\mathbf{P}^{r - 1 - i}$ which is a
representative of $c_1(\mathcal{O}(1))^i \cap [\mathbf{P}^{r - 1}]$.
Hence $P$ has a similar stratification
$$
P = U^{r - 1} \amalg U^{r - 2} \amalg \ldots \amalg U^0
$$
Let $P^i$ be the closure of $U^i$. Let $\pi^i : P^i \to X$
be the restriction of $\pi$ to $P^i$.
Let $\alpha \in \CH_{k + r - 1}(P)$. By
Lemma \ref{lemma-pullback-affine-fibres-surjective}
we can write $\alpha|_{U^{r - 1}} = \pi^*\alpha_0|_{U^{r - 1}}$
for some $\alpha_0 \in \CH_k(X)$. Hence the difference
$\alpha - \pi^*\alpha_0$ is the image of some
$\alpha' \in \CH_{k + r - 1}(P^{r - 2})$.
By Lemma \ref{lemma-pullback-affine-fibres-surjective}
again we can write
$\alpha'|_{U^{r - 2}} = (\pi^{r - 2})^*\alpha_1|_{U^{r - 2}}$
for some $\alpha_1 \in \CH_{k + 1}(X)$.
By Lemma \ref{lemma-relative-effective-cartier}
we see that the image of $(\pi^{r - 2})^*\alpha_1$
represents $c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1$.
We also see that
$\alpha - \pi^*\alpha_0 - c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1$
is the image of some $\alpha'' \in \CH_{k + r - 1}(P^{r - 3})$.
And so on.
\end{proof}

\begin{lemma}
\label{lemma-vectorbundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let
$$
p :
E = \underline{\Spec}(\text{Sym}^*(\mathcal{E}))
\longrightarrow
X
$$
be the associated vector bundle over $X$.
Then $p^* : \CH_k(X) \to \CH_{k + r}(E)$ is an isomorphism for all $k$.
\end{lemma}

\begin{proof}
(For the case of linebundles, see Lemma \ref{lemma-linebundle}.)
For surjectivity see Lemma \ref{lemma-pullback-affine-fibres-surjective}.
Let $(\pi  : P \to X, \mathcal{O}_P(1))$
be the projective space bundle associated
to the finite locally free sheaf $\mathcal{E} \oplus \mathcal{O}_X$.
Let $s \in \Gamma(P, \mathcal{O}_P(1))$ correspond to the global
section $(0, 1) \in \Gamma(X, \mathcal{E} \oplus \mathcal{O}_X)$.
Let $D = Z(s) \subset P$. Note that
$(\pi|_D : D \to X , \mathcal{O}_P(1)|_D)$
is the projective space bundle associated
to $\mathcal{E}$. We denote $\pi_D = \pi|_D$ and
$\mathcal{O}_D(1) = \mathcal{O}_P(1)|_D$.
Moreover, $D$ is an effective
Cartier divisor on $P$. Hence $\mathcal{O}_P(D) = \mathcal{O}_P(1)$
(see Divisors, Lemma \ref{divisors-lemma-characterize-OD}).
Also there is an isomorphism
$E \cong P \setminus D$. Denote $j : E \to P$ the
corresponding open immersion.
For injectivity we use that the kernel of
$$
j^* :
\CH_{k + r}(P)
\longrightarrow
\CH_{k + r}(E)
$$
are the cycles supported in the effective Cartier divisor $D$,
see Lemma \ref{lemma-restrict-to-open}. So if $p^*\alpha = 0$, then
$\pi^*\alpha = i_*\beta$ for some $\beta \in \CH_{k + r}(D)$.
By Lemma \ref{lemma-chow-ring-projective-bundle} we may write
$$
\beta = \pi_D^*\beta_0 +
\ldots + c_1(\mathcal{O}_D(1))^{r - 1} \cap \pi_D^* \beta_{r - 1}.
$$
for some $\beta_i \in \CH_{k + i}(X)$.
By Lemmas \ref{lemma-relative-effective-cartier}
and \ref{lemma-pushforward-cap-c1}
this implies
$$
\pi^*\alpha = i_*\beta =
c_1(\mathcal{O}_P(1)) \cap \pi^*\beta_0 +
\ldots +
c_1(\mathcal{O}_D(1))^r \cap \pi^*\beta_{r - 1}.
$$
Since the rank of $\mathcal{E} \oplus \mathcal{O}_X$ is $r + 1$
this contradicts Lemma \ref{lemma-pushforward-cap-c1} unless all
$\alpha$ and all $\beta_i$ are zero.
\end{proof}








\section{The Chern classes of a vector bundle}
\label{section-chern-classes-vector-bundles}

\noindent
We can use the projective space bundle formula to define the
chern classes of a rank $r$ vector bundle in terms of the expansion
of $c_1(\mathcal{O}(1))^r$ in terms of the lower powers, see
formula (\ref{equation-chern-classes}).
The reason for the signs will be explained later.

\begin{definition}
\label{definition-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$
on $X$. Let $(\pi : P \to X, \mathcal{O}_P(1))$ be the projective space
bundle associated to $\mathcal{E}$.
\begin{enumerate}
\item By Lemma \ref{lemma-chow-ring-projective-bundle} there are
elements $c_i \in \CH_{n - i}(X)$, $i = 0, \ldots, r$
such that $c_0 = [X]$, and
\begin{equation}
\label{equation-chern-classes}
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
\item With notation as above we set
$c_i(\mathcal{E}) \cap [X] = c_i$
as an element of $\CH_{n - i}(X)$.
We call these the {\it chern classes of $\mathcal{E}$ on $X$}.
\item The {\it total chern class of $\mathcal{E}$ on $X$}
is the combination
$$
c({\mathcal E}) \cap [X] =
c_0({\mathcal E}) \cap [X]
+ c_1({\mathcal E}) \cap [X] + \ldots
+ c_r({\mathcal E}) \cap [X]
$$
which is an element of
$\CH_*(X) = \bigoplus_{k \in \mathbf{Z}} \CH_k(X)$.
\end{enumerate}
\end{definition}

\noindent
Let us check that this does not give a new notion in case the
vector bundle has rank $1$.

\begin{lemma}
\label{lemma-first-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
The first chern class of $\mathcal{L}$ on $X$ of
Definition \ref{definition-chern-classes}
is equal to the Weil divisor associated to $\mathcal{L}$
by Definition \ref{definition-divisor-invertible-sheaf}.
\end{lemma}

\begin{proof}
In this proof we use $c_1(\mathcal{L}) \cap [X]$ to denote the
construction of Definition \ref{definition-divisor-invertible-sheaf}.
Since $\mathcal{L}$ has rank $1$ we have
$\mathbf{P}(\mathcal{L}) = X$ and
$\mathcal{O}_{\mathbf{P}(\mathcal{L})}(1) = \mathcal{L}$
by our normalizations. Hence (\ref{equation-chern-classes})
reads
$$
(-1)^1 c_1(\mathcal{L}) \cap c_0 + (-1)^0 c_1 = 0
$$
Since $c_0 = [X]$, we conclude $c_1 = c_1(\mathcal{L}) \cap [X]$
as desired.
\end{proof}

\begin{remark}
\label{remark-equation-signs}
We could also rewrite equation \ref{equation-chern-classes} as
\begin{equation}
\label{equation-signs}
\sum\nolimits_{i = 0}^r
c_1(\mathcal{O}_P(-1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
but we find it easier to work with the tautological quotient
sheaf $\mathcal{O}_P(1)$ instead of
its dual.
\end{remark}




\section{Intersecting with chern classes}
\label{section-intersecting-chern-classes}

\noindent
In this section we define chern classes of vector bundles on $X$ as
bivariant classes on $X$, see Lemma \ref{lemma-cap-cp-bivariant}
and the discussion following this lemma. Our construction follows the familiar
pattern of first defining the operation on prime cycles and then
summing. In Lemma \ref{lemma-determine-intersections} we show
that the result is determined by the usual formula on the associated
projective bundle. Next, we show that capping with chern classes
passes through rational equivalence, commutes with proper pushforward,
commutes with flat pullback, and commutes with the gysin maps for
inclusions of effective Cartier divisors. These lemmas could have been
avoided by directly using the characterization in
Lemma \ref{lemma-determine-intersections} and using
Lemma \ref{lemma-push-proper-bivariant}; the reader who wishes to
see this worked out should consult
Chow Groups of Spaces, Lemma \ref{spaces-chow-lemma-segre-classes}.

\begin{definition}
\label{definition-cap-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
We define, for every integer $k$ and any $0 \leq j \leq r$,
an operation
$$
c_j(\mathcal{E}) \cap - : Z_k(X) \to \CH_{k - j}(X)
$$
called {\it intersection with the $j$th chern class of $\mathcal{E}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ of $\delta$-dimension
$k$ we define
$$
c_j(\mathcal{E}) \cap [W] = i_*(c_j({i^*\mathcal{E}}) \cap [W])
\in
\CH_{k - j}(X)
$$
where $c_j({i^*\mathcal{E}}) \cap [W]$ is as defined in
Definition \ref{definition-chern-classes}.
\item For a general $k$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_j(\mathcal{E}) \cap \alpha = \sum n_i c_j(\mathcal{E}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
If $\mathcal{E}$ has rank $1$ then this agrees with our
previous definition (Definition \ref{definition-cap-c1})
by Lemma \ref{lemma-first-chern-class}.

\begin{lemma}
\label{lemma-determine-intersections}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $(\pi : P \to X, \mathcal{O}_P(1))$ be the projective bundle
associated to $\mathcal{E}$.
For $\alpha \in Z_k(X)$ the elements
$c_j(\mathcal{E}) \cap \alpha$ are the unique elements
$\alpha_j$ of $\CH_{k - j}(X)$
such that $\alpha_0 = \alpha$ and
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
holds in the Chow group of $P$.
\end{lemma}

\begin{proof}
The uniqueness of $\alpha_0, \ldots, \alpha_r$ such that
$\alpha_0 = \alpha$ and such that
the displayed equation holds follows from
the projective space bundle formula
Lemma \ref{lemma-chow-ring-projective-bundle}.
The identity holds by definition for $\alpha = [W]$ where $W$
is an integral closed subscheme of $X$.
For a general $k$-cycle $\alpha$ on $X$ write
$\alpha = \sum n_a[W_a]$ with $n_a \not = 0$, and
$i_a : W_a \to X$ pairwise distinct integral closed subschemes.
Then the family $\{W_a\}$ is locally finite on $X$.
Set $P_a = \pi^{-1}(W_a) = \mathbf{P}(\mathcal{E}|_{W_a})$.
Denote $i'_a : P_a \to P$ the corresponding closed immersions.
Consider the fibre product diagram
$$
\xymatrix{
P' \ar@{=}[r] \ar[d]_{\pi'} &
\coprod P_a \ar[d]_{\coprod \pi_a} \ar[r]_{\coprod i'_a} &
P \ar[d]^\pi \\
X' \ar@{=}[r] &
\coprod W_a \ar[r]^{\coprod i_a} &
X
}
$$
The morphism $p : X' \to X$ is proper. Moreover
$\pi' : P' \to X'$ together with the invertible sheaf
$\mathcal{O}_{P'}(1) = \coprod \mathcal{O}_{P_a}(1)$
which is also the pullback of $\mathcal{O}_P(1)$
is the projective bundle associated to
$\mathcal{E}' = p^*\mathcal{E}$. By definition
$$
c_j(\mathcal{E}) \cap [\alpha]
=
\sum i_{a, *}(c_j(\mathcal{E}|_{W_a}) \cap [W_a]).
$$
Write $\beta_{a, j} = c_j(\mathcal{E}|_{W_a}) \cap [W_a]$
which is an element of $\CH_{k - j}(W_a)$. We have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_a}(1))^i \cap \pi_a^*(\beta_{a, r - i}) = 0
$$
for each $a$ by definition. Thus clearly we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P'}(1))^i \cap (\pi')^*(\beta_{r - i}) = 0
$$
with $\beta_j = \sum n_a\beta_{a, j} \in \CH_{k - j}(X')$. Denote
$p' : P' \to P$ the morphism $\coprod i'_a$.
We have $\pi^*p_*\beta_j = p'_*(\pi')^*\beta_j$
by Lemma \ref{lemma-flat-pullback-proper-pushforward}.
By the projection formula of Lemma \ref{lemma-pushforward-cap-c1}
we conclude that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap \pi^*(p_*\beta_j) = 0
$$
Since $p_*\beta_j$ is a representative of $c_j(\mathcal{E}) \cap \alpha$
we win.
\end{proof}

\noindent
We will consistently use this characterization of chern classes
to prove many more properties.

\begin{lemma}
\label{lemma-cap-chern-class-factors-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
If $\alpha \sim_{rat} \beta$ are rationally equivalent $k$-cycles
on $X$ then $c_j(\mathcal{E}) \cap \alpha = c_j(\mathcal{E}) \cap \beta$
in $\CH_{k - j}(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-determine-intersections} the elements
$\alpha_j = c_j(\mathcal{E}) \cap \alpha$, $j \geq 1$ and
$\beta_j = c_j(\mathcal{E}) \cap \beta$, $j \geq 1$ are uniquely determined
by the {\it same} equation in the chow group of the projective
bundle associated to $\mathcal{E}$. (This of course relies on the fact that
flat pullback is compatible with rational equivalence, see
Lemma \ref{lemma-flat-pullback-rational-equivalence}.) Hence they are equal.
\end{proof}

\noindent
In other words capping with chern classes of
finite locally free sheaves factors through rational equivalence
to give maps
$$
c_j(\mathcal{E}) \cap - : \CH_k(X) \to \CH_{k - j}(X).
$$
Our next task is to show that chern classes are bivariant classes, see
Definition \ref{definition-bivariant-class}.

\begin{lemma}
\label{lemma-pushforward-cap-cj}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha$ be a $k$-cycle on $X$.
Let $\mathcal{E}$ be a finite locally free sheaf on $Y$.
Then
$$
p_*(c_j(p^*\mathcal{E}) \cap \alpha) = c_j(\mathcal{E}) \cap p_*\alpha
$$
\end{lemma}

\begin{proof}
Let $(\pi : P \to Y, \mathcal{O}_P(1))$ be the projective bundle associated
to $\mathcal{E}$. Then $P_X = X \times_Y P$ is the projective bundle associated
to $p^*\mathcal{E}$ and $\mathcal{O}_{P_X}(1)$ is the pullback of
$\mathcal{O}_P(1)$. Write $\alpha_j = c_j(p^*\mathcal{E}) \cap \alpha$, so
$\alpha_0 = \alpha$. By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi_X^*(\alpha_{r - i}) = 0
$$
in the chow group of $P_X$. Consider the fibre product diagram
$$
\xymatrix{
P_X \ar[r]_-{p'} \ar[d]_{\pi_X} & P \ar[d]^\pi \\
X \ar[r]^p & Y
}
$$
Apply proper pushforward $p'_*$
(Lemma \ref{lemma-proper-pushforward-rational-equivalence})
to the displayed equality above. Using
Lemmas \ref{lemma-pushforward-cap-c1} and
\ref{lemma-flat-pullback-proper-pushforward} we obtain
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(p_*\alpha_{r - i}) = 0
$$
in the chow group of $P$. By the characterization of
Lemma \ref{lemma-determine-intersections} we conclude.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-cap-cj}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $Y$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_j(\mathcal{E}) \cap \alpha) = c_j(f^*\mathcal{E}) \cap f^*\alpha
$$
\end{lemma}

\begin{proof}
Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so $\alpha_0 = \alpha$.
By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to Y, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Consider the fibre product diagram
$$
\xymatrix{
P_X = \mathbf{P}(f^*\mathcal{E}) \ar[r]_-{f'} \ar[d]_{\pi_X} &
P \ar[d]^\pi \\
X \ar[r]^f & Y
}
$$
Note that $\mathcal{O}_{P_X}(1)$ is the pullback of $\mathcal{O}_P(1)$.
Apply flat pullback $(f')^*$
(Lemma \ref{lemma-flat-pullback-rational-equivalence}) to the displayed
equation above. By Lemmas \ref{lemma-flat-pullback-cap-c1} and
\ref{lemma-compose-flat-pullback} we see that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_X}(1))^i \cap
\pi_X^*(f^*\alpha_{r - i}) = 0
$$
holds in the chow group of $P_X$. By the characterization of
Lemma \ref{lemma-determine-intersections} we conclude.
\end{proof}

\begin{lemma}
\label{lemma-cap-chern-class-commutes-with-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
Then $c_j(\mathcal{E}|_D) \cap i^*\alpha = i^*(c_j(\mathcal{E}) \cap \alpha)$
for all $\alpha \in \CH_k(X)$.
\end{lemma}

\begin{proof}
Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so $\alpha_0 = \alpha$.
By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to X, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Consider the fibre product diagram
$$
\xymatrix{
P_D = \mathbf{P}(\mathcal{E}|_D) \ar[r]_-{i'} \ar[d]_{\pi_D} &
P \ar[d]^\pi \\
D \ar[r]^i & X
}
$$
Note that $\mathcal{O}_{P_D}(1)$ is the pullback of $\mathcal{O}_P(1)$.
Apply the gysin map $(i')^*$ (Lemma \ref{lemma-gysin-factors}) to the
displayed equation above.
Applying Lemmas \ref{lemma-gysin-commutes-cap-c1} and
\ref{lemma-gysin-flat-pullback} we obtain
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_D}(1))^i \cap
\pi_D^*(i^*\alpha_{r - i}) = 0
$$
in the chow group of $P_D$.
By the characterization of Lemma \ref{lemma-determine-intersections}
we conclude.
\end{proof}

\noindent
At this point we have enough material to be able to prove that
capping with chern classes defines a bivariant class.

\begin{lemma}
\label{lemma-cap-cp-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module
of rank $r$. Let $0 \leq p \leq r$.
Then the rule that to $f : X' \to X$ assignes
$c_p(f^*\mathcal{E}) \cap - : \CH_k(X') \to \CH_{k - 1}(X')$
is a bivariant class of degree $p$.
\end{lemma}

\begin{proof}
Immediate from Lemmas
\ref{lemma-cap-chern-class-factors-rational-equivalence},
\ref{lemma-pushforward-cap-cj},
\ref{lemma-flat-pullback-cap-cj}, and
\ref{lemma-cap-chern-class-commutes-with-gysin}
and Definition \ref{definition-bivariant-class}.
\end{proof}

\noindent
This lemma allows us to define the chern classes of a finite
locally free module as follows.

\begin{definition}
\label{definition-chern-classes-final}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module
of rank $r$. For $i = 0, \ldots, r$ the {\it $i$th chern class}
of $\mathcal{E}$ is the bivariant class
$c_i(\mathcal{E}) \in A^i(X)$ of degree $i$
constructed in Lemma \ref{lemma-cap-cp-bivariant}. The
{\it total chern class} of $\mathcal{E}$ is the formal sum
$$
c(\mathcal{E}) = 
c_0(\mathcal{E}) + c_1(\mathcal{E}) + \ldots + c_r(\mathcal{E})
$$
which is viewed as a nonhomogeneous bivariant class on $X$.
\end{definition}

\noindent
By the remark following Definition \ref{definition-cap-chern-classes}
if $\mathcal{E}$ is invertible, then this definition agrees with
Definition \ref{definition-first-chern-class}.
Next we see that chern classes are in the center of the bivariant
Chow cohomology ring $A^*(X)$.

\begin{lemma}
\label{lemma-cap-commutative-chern}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module of rank $r$.
Then
\begin{enumerate}
\item $c_j(\mathcal{E}) \in A^j(X)$ is in the center of $A^*(X)$ and
\item if $f : X' \to X$ is locally of finite type and $c \in A^*(X' \to X)$,
then $c \circ c_j(\mathcal{E}) = c_j(f^*\mathcal{E}) \circ c$.
\end{enumerate}
In particular, if $\mathcal{F}$ is a second locally free
$\mathcal{O}_X$-module on $X$ of rank $s$, then
$$
c_i(\mathcal{E}) \cap c_j(\mathcal{F}) \cap \alpha
=
c_j(\mathcal{F}) \cap c_i(\mathcal{E}) \cap \alpha
$$
as elements of $\CH_{k - i - j}(X)$ for all $\alpha \in \CH_k(X)$.
\end{lemma}

\begin{proof}
It is immediate that (2) implies (1).
Let $\alpha \in \CH_k(X)$. Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so
$\alpha_0 = \alpha$. By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to Y, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Denote $\pi' : P' \to X'$ the base change
of $\pi$ by $f$. Using Lemma \ref{lemma-c1-center} and
the properties of bivariant classes we obtain
\begin{align*}
0 & = c \cap \left(\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i})\right) \\
& =
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P'}(1))^i \cap
(\pi')^*(c \cap \alpha_{r - i})
\end{align*}
in the Chow group of $P'$ (calculation omitted).
Hence we see that $c \cap \alpha_j$ is
equal to $c_j(f^*\mathcal{E}) \cap (c \cap \alpha)$ by the characterization
of Lemma \ref{lemma-determine-intersections}.
This proves the lemma.
\end{proof}

\begin{remark}
\label{remark-extend-to-finite-locally-free}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module.
If the rank of $\mathcal{E}$ is not constant then we can
still define the chern classes of $\mathcal{E}$. Namely, in this
case we can write
$$
X = X_0 \amalg X_1 \amalg X_2 \amalg \ldots
$$
where $X_r \subset X$ is the open and closed subspace where
the rank of $\mathcal{E}$ is $r$. By 
Lemma \ref{lemma-disjoint-decomposition-bivariant}
we have $A^p(X) = \prod A^p(X_r)$.
Hence we can define $c_i(\mathcal{E})$ to be the
product of the classes $c_i(\mathcal{E}|_{X_r})$ in $A^i(X_r)$.
Explicitly, if $X' \to X$ is a morphism locally of finite type,
then we obtain by pullback a corresponding decomposition of $X'$
and we find that
$$
\CH_*(X') = \prod\nolimits_{r \geq 0} \CH_*(X'_r)
$$
by our definitions. Then $c_i(\mathcal{E}) \in A^i(X)$
is the bivariant class which preserves these direct
product decompositions and acts by the already defined
operations $c_i(\mathcal{E}|_{X_r}) \cap -$
on the factors. Observe that in this setting it may happen
that $c_i(\mathcal{E})$ is nonzero for infinitely many $i$.
In this setting we moreover define the ``rank'' of $\mathcal{E}$
to be the element $r(\mathcal{E}) \in A^0(X)$
as the bivariant operation which sends $(\alpha_r) \in \prod \CH_*(X'_r)$
to $(r\alpha_r) \in \prod \CH_*(X'_r)$.
Note that it is still true that $c_i(\mathcal{E})$ and $r(\mathcal{E})$
are in the center of $A^*(X)$.
\end{remark}

\begin{remark}
\label{remark-top-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$
be locally of finite type over $S$. Let $\mathcal{E}$ be a
finite locally free $\mathcal{O}_X$-module. In general
we write $X = \coprod X_r$ as in
Remark \ref{remark-extend-to-finite-locally-free}.
If only a finite number of the $X_r$ are nonempty, then
we can set
$$
c_{top}(\mathcal{E}) = \sum\nolimits_r c_r(\mathcal{E}|_{X_r})
\in A^*(X) = \bigoplus A^*(X_r)
$$
where the equality is Lemma \ref{lemma-disjoint-decomposition-bivariant}.
If infinitely many $X_r$ are nonempty, we will use the same
notation to denote
$$
c_{top}(\mathcal{E}) = \prod c_r(\mathcal{E}|_{X_r})
\in \prod A^r(X_r) \subset A^*(X)^\wedge
$$
see Remark \ref{remark-completion-bivariant} for notation.
\end{remark}











\section{Polynomial relations among chern classes}
\label{section-relations-chern-classes}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $\mathcal{E}_i$ be a finite collection of finite
locally free sheaves on $X$. By Lemma \ref{lemma-cap-commutative-chern}
we see that the chern classes
$$
c_j(\mathcal{E}_i) \in A^*(X)
$$
generate a commutative (and even central) $\mathbf{Z}$-subalgebra of the
Chow cohomology algebra $A^*(X)$.
Thus we can say what it means for a polynomial in these chern classes
to be zero, or for two polynomials to be the same. As an example, saying that
$c_1(\mathcal{E}_1)^5 + c_2(\mathcal{E}_2)c_3(\mathcal{E}_3) = 0$
means that the operations
$$
\CH_k(Y) \longrightarrow \CH_{k - 5}(Y), \quad
\alpha \longmapsto
c_1(\mathcal{E}_1)^5 \cap \alpha +
c_2(\mathcal{E}_2) \cap c_3(\mathcal{E}_3) \cap \alpha
$$
are zero for all morphisms $f : Y \to X$ which are locally of finite type.
By Lemma \ref{lemma-bivariant-zero}
this is equivalent to the requirement that given any morphism
$f : Y \to X$  where $Y$ is an integral scheme
locally of finite type over $S$ the cycle
$$
c_1(\mathcal{E}_1)^5 \cap [Y] +
c_2(\mathcal{E}_2) \cap c_3(\mathcal{E}_3) \cap [Y]
$$
is zero in $\CH_{\dim(Y) - 5}(Y)$.

\medskip\noindent
A specific example is the relation
$$
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N})
=
c_1(\mathcal{L}) + c_1(\mathcal{N})
$$
proved in Lemma \ref{lemma-c1-cap-additive}.
More generally, here is what happens when we tensor an
arbitrary locally free sheaf by an invertible sheaf.

\begin{lemma}
\label{lemma-chern-classes-E-tensor-L}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of
rank $r$ on $X$. Let $\mathcal{L}$ be an invertible
sheaf on $X$. Then we have
\begin{equation}
\label{equation-twist}
c_i({\mathcal E} \otimes {\mathcal L})
=
\sum\nolimits_{j = 0}^i
\binom{r - i + j}{j} c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
\end{equation}
in $A^*(X)$.
\end{lemma}

\begin{proof}
This should hold for any triple $(X, \mathcal{E}, \mathcal{L})$.
In particular it should hold when $X$ is integral and by
Lemma \ref{lemma-bivariant-zero}
it is enough to prove
it holds when capping with $[X]$ for such $X$. Thus assume
that $X$ is integral. Let $(\pi : P \to X, \mathcal{O}_P(1))$,
resp.\ $(\pi' : P' \to X, \mathcal{O}_{P'}(1))$ be the
projective space bundle associated to $\mathcal{E}$,
resp.\ $\mathcal{E} \otimes \mathcal{L}$. Consider the canonical morphism
$$
\xymatrix{
P \ar[rd]_\pi \ar[rr]_g & & P' \ar[ld]^{\pi'} \\
& X &
}
$$
see Constructions, Lemma \ref{constructions-lemma-twisting-and-proj}.
It has the property that
$g^*\mathcal{O}_{P'}(1)
= \mathcal{O}_P(1) \otimes \pi^* {\mathcal L}$.
This means that we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i
(\xi + x)^i \cap \pi^*(c_{r - i}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
=
0
$$
in $\CH_*(P)$, where $\xi$ represents
$c_1(\mathcal{O}_P(1))$ and $x$
represents $c_1(\pi^*\mathcal{L})$. By simple algebra this
is equivalent to
$$
\sum\nolimits_{i = 0}^r
(-1)^i \xi^i \left(
\sum\nolimits_{j = i}^r
(-1)^{j - i}
\binom{j}{i}
x^{j - i} \cap
\pi^*(c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
\right)
=
0
$$
Comparing with
Equation (\ref{equation-chern-classes}) it follows from this that
$$
c_{r - i}(\mathcal{E}) \cap [X] =
\sum\nolimits_{j = i}^r
\binom{j}{i}
(-c_1(\mathcal{L}))^{j - i} \cap
c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X]
$$
Reworking this (getting rid of minus signs, and renumbering) we get
the desired relation.
\end{proof}

\noindent
Some example cases of (\ref{equation-twist}) are
\begin{align*}
c_1(\mathcal{E} \otimes \mathcal{L})
& =
c_1(\mathcal{E}) +
r c_1(\mathcal{L}) \\
c_2(\mathcal{E} \otimes \mathcal{L})
& =
c_2(\mathcal{E}) +
(r - 1) c_1(\mathcal{E}) c_1(\mathcal{L}) +
\binom{r}{2} c_1(\mathcal{L})^2 \\
c_3(\mathcal{E} \otimes \mathcal{L})
& =
c_3(\mathcal{E}) +
(r - 2) c_2(\mathcal{E})c_1(\mathcal{L}) +
\binom{r - 1}{2} c_1(\mathcal{E})c_1(\mathcal{L})^2 +
\binom{r}{3} c_1(\mathcal{L})^3
\end{align*}








\section{Additivity of chern classes}
\label{section-additivity-chern-classes}

\noindent
All of the preliminary lemmas follow trivially from the
final result.

\begin{lemma}
\label{lemma-get-rid-of-trivial-subbundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves
on $X$ of ranks $r$, $r - 1$ which fit into a short
exact sequence
$$
0 \to \mathcal{O}_X \to \mathcal{E} \to \mathcal{F} \to 0
$$
Then we have
$$
c_r(\mathcal{E}) = 0, \quad
c_j(\mathcal{E}) = c_j(\mathcal{F}), \quad j = 0, \ldots, r - 1
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-bivariant-zero}
it suffices to show that if $X$ is integral
then $c_j(\mathcal{E}) \cap [X] = c_j(\mathcal{F}) \cap [X]$.
Let $(\pi : P \to X, \mathcal{O}_P(1))$,
resp.\ $(\pi' : P' \to X, \mathcal{O}_{P'}(1))$ denote the
projective space bundle associated to $\mathcal{E}$, resp.\ $\mathcal{F}$.
The surjection $\mathcal{E} \to \mathcal{F}$ gives rise
to a closed immersion
$$
i : P' \longrightarrow P
$$
over $X$. Moreover, the element
$1 \in \Gamma(X, \mathcal{O}_X) \subset \Gamma(X, \mathcal{E})$
gives rise to a global section $s \in \Gamma(P, \mathcal{O}_P(1))$
whose zero set is exactly $P'$. Hence $P'$ is an effective Cartier
divisor on $P$ such that $\mathcal{O}_P(P') \cong \mathcal{O}_P(1)$.
Hence we see that
$$
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha = i_*((\pi')^*\alpha)
$$
for any cycle class $\alpha$ on $X$ by
Lemma \ref{lemma-relative-effective-cartier}.
By Lemma \ref{lemma-determine-intersections} we see that
$\alpha_j = c_j(\mathcal{F}) \cap [X]$, $j = 0, \ldots, r - 1$
satisfy
$$
\sum\nolimits_{j = 0}^{r - 1} (-1)^jc_1(\mathcal{O}_{P'}(1))^j
\cap (\pi')^*\alpha_j = 0
$$
Pushing this to $P$ and using the remark above as well as
Lemma \ref{lemma-pushforward-cap-c1} we get
$$
\sum\nolimits_{j = 0}^{r - 1}
(-1)^j c_1(\mathcal{O}_P(1))^{j + 1}
\cap \pi^*\alpha_j = 0
$$
By the uniqueness of Lemma \ref{lemma-determine-intersections}
we conclude that
$c_r(\mathcal{E}) \cap [X] = 0$ and
$c_j(\mathcal{E}) \cap [X] = \alpha_j = c_j(\mathcal{F}) \cap [X]$
for $j = 0, \ldots, r - 1$. Hence the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-additivity-invertible-subsheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves
on $X$ of ranks $r$, $r - 1$ which fit into a short
exact sequence
$$
0 \to \mathcal{L} \to \mathcal{E} \to \mathcal{F} \to 0
$$
where $\mathcal{L}$ is an invertible sheaf.
Then
$$
c(\mathcal{E}) = c(\mathcal{L}) c(\mathcal{F})
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
This relation really just says that
$c_i(\mathcal{E}) = c_i(\mathcal{F}) + c_1(\mathcal{L})c_{i - 1}(\mathcal{F})$.
By Lemma \ref{lemma-get-rid-of-trivial-subbundle}
we have $c_j(\mathcal{E} \otimes \mathcal{L}^{\otimes -1})
= c_j(\mathcal{F} \otimes \mathcal{L}^{\otimes -1})$ for
$j = 0, \ldots, r$ were we set
$c_r(\mathcal{F} \otimes \mathcal{L}^{-1}) = 0$ by convention.
Applying Lemma \ref{lemma-chern-classes-E-tensor-L} we deduce
$$
\sum_{j = 0}^i
\binom{r - i + j}{j} (-1)^j c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
=
\sum_{j = 0}^i
\binom{r - 1 - i + j}{j} (-1)^j c_{i - j}({\mathcal F}) c_1({\mathcal L})^j
$$
Setting
$c_i(\mathcal{E}) = c_i(\mathcal{F}) + c_1(\mathcal{L})c_{i - 1}(\mathcal{F})$
gives a ``solution'' of this equation. The lemma follows if we show
that this is the only possible solution. We omit the verification.
\end{proof}

\begin{lemma}
\label{lemma-additivity-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose that ${\mathcal E}$ sits in an
exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
of finite locally free sheaves $\mathcal{E}_i$ of rank $r_i$.
The total chern classes satisfy
$$
c({\mathcal E}) = c({\mathcal E}_1) c({\mathcal E}_2)
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-bivariant-zero} we may assume that $X$ is integral
and we have to show the identity when capping against $[X]$.
By induction on $r_1$. The case $r_1 = 1$ is
Lemma \ref{lemma-additivity-invertible-subsheaf}.
Assume $r_1 > 1$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
denote the projective space bundle associated to $\mathcal{E}_1$. Note that
\begin{enumerate}
\item $\pi^* : \CH_*(X) \to \CH_*(P)$ is injective, and
\item $\pi^*\mathcal{E}_1$ sits in a short exact sequence
$0 \to \mathcal{F} \to \pi^*\mathcal{E}_1 \to \mathcal{L} \to 0$
where $\mathcal{L}$ is invertible.
\end{enumerate}
The first assertion follows from the projective space bundle formula
and the second follows from the definition of a projective space bundle.
(In fact $\mathcal{L} = \mathcal{O}_P(1)$.)
Let $Q = \pi^*\mathcal{E}/\mathcal{F}$, which sits in an
exact sequence $0 \to \mathcal{L} \to Q \to \pi^*\mathcal{E}_2 \to 0$.
By induction we have
\begin{eqnarray*}
c(\pi^*\mathcal{E}) \cap [P]
& = &
c(\mathcal{F}) \cap c(\pi^*\mathcal{E}/\mathcal{F}) \cap [P] \\
& = &
c(\mathcal{F}) \cap c(\mathcal{L}) \cap c(\pi^*\mathcal{E}_2) \cap [P] \\
& = &
c(\pi^*\mathcal{E}_1) \cap c(\pi^*\mathcal{E}_2) \cap [P]
\end{eqnarray*}
Since $[P] = \pi^*[X]$ we
win by Lemma \ref{lemma-flat-pullback-cap-cj}.
\end{proof}

\begin{lemma}
\label{lemma-chern-filter-by-linebundles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let ${\mathcal L}_i$, $i = 1, \ldots, r$ be invertible
$\mathcal{O}_X$-modules on $X$.
Let $\mathcal{E}$ be a locally free rank
$\mathcal{O}_X$-module endowed with a filtration
$$
0 = \mathcal{E}_0 \subset \mathcal{E}_1 \subset \mathcal{E}_2
\subset \ldots \subset \mathcal{E}_r = \mathcal{E}
$$
such that $\mathcal{E}_i/\mathcal{E}_{i - 1} \cong \mathcal{L}_i$.
Set $c_1({\mathcal L}_i) = x_i$. Then
$$
c(\mathcal{E})
=
\prod\nolimits_{i = 1}^r (1 + x_i)
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-additivity-invertible-subsheaf} and induction.
\end{proof}




\section{Degrees of zero cycles}
\label{section-degree-zero-cycles}

\noindent
We start defining the degree of a zero cycle on a proper scheme over a field.
One approach is to define it directly as in
Lemma \ref{lemma-spell-out-degree-zero-cycle} and then show
it is well defined by
Lemma \ref{lemma-curve-principal-divisor}.
Instead we define it as follows.

\begin{definition}
\label{definition-degree-zero-cycle}
Let $k$ be a field (Example \ref{example-field}). Let $p : X \to \Spec(k)$
be proper. The {\it degree of a zero cycle} on $X$ is given by proper
pushforward
$$
p_* : \CH_0(X) \to \CH_0(\Spec(k))
$$
(Lemma \ref{lemma-proper-pushforward-rational-equivalence})
combined with the natural isomorphism $\CH_0(\Spec(k)) = \mathbf{Z}$
which maps $[\Spec(k)]$ to $1$. Notation: $\deg(\alpha)$.
\end{definition}

\noindent
Let us spell this out further.

\begin{lemma}
\label{lemma-spell-out-degree-zero-cycle}
Let $k$ be a field. Let $X$ be proper over $k$. Let $\alpha = \sum n_i[Z_i]$
be in $Z_0(X)$. Then
$$
\deg(\alpha) = \sum n_i\deg(Z_i)
$$
where $\deg(Z_i)$ is the degree of $Z_i \to \Spec(k)$, i.e.,
$\deg(Z_i) = \dim_k \Gamma(Z_i, \mathcal{O}_{Z_i})$.
\end{lemma}

\begin{proof}
This is the definition of proper pushforward
(Definition \ref{definition-proper-pushforward}).
\end{proof}

\noindent
Next, we make the connection with degrees of vector bundles
over $1$-dimensional proper schemes over fields as defined in
Varieties, Section \ref{varieties-section-divisors-curves}.

\begin{lemma}
\label{lemma-degree-vector-bundle}
Let $k$ be a field. Let $X$ be a proper scheme over $k$ of dimension $\leq 1$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module of constant
rank. Then
$$
\deg(\mathcal{E}) = \deg(c_1(\mathcal{E}) \cap [X]_1)
$$
where the left hand side is defined in
Varieties, Definition \ref{varieties-definition-degree-invertible-sheaf}.
\end{lemma}

\begin{proof}
Let $C_i \subset X$, $i = 1, \ldots, t$ be the irreducible components
of dimension $1$ with reduced induced scheme structure and let $m_i$ be the
multiplicity of $C_i$ in $X$. Then $[X]_1 = \sum m_i[C_i]$ and
$c_1(\mathcal{E}) \cap [X]_1$ is the sum of the pushforwards of the cycles
$m_i c_1(\mathcal{E}|_{C_i}) \cap [C_i]$. Since we have a similar decomposition
of the degree of $\mathcal{E}$ by
Varieties, Lemma \ref{varieties-lemma-degree-in-terms-of-components}
it suffices to prove the lemma in case $X$ is a proper curve over $k$.

\medskip\noindent
Assume $X$ is a proper curve over $k$.
By Divisors, Lemma \ref{divisors-lemma-filter-after-modification}
there exists a modification $f : X' \to X$ such that $f^*\mathcal{E}$
has a filtration whose successive quotients are invertible
$\mathcal{O}_{X'}$-modules. Since $f_*[X']_1 = [X]_1$ we conclude
from Lemma \ref{lemma-pushforward-cap-cj} that
$$
\deg(c_1(\mathcal{E}) \cap [X]_1) = \deg(c_1(f^*\mathcal{E}) \cap [X']_1)
$$
Since we have a similar relationship for the degree by
Varieties, Lemma \ref{varieties-lemma-degree-birational-pullback}
we reduce to the case where $\mathcal{E}$ has a filtration whose
successive quotients are invertible $\mathcal{O}_X$-modules.
In this case, we may use additivity of the degree
(Varieties, Lemma \ref{varieties-lemma-degree-additive})
and of first chern classes (Lemma \ref{lemma-additivity-chern-classes})
to reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $X$ is a proper curve over $k$ and $\mathcal{E}$ is an
invertible $\mathcal{O}_X$-module. By
Divisors, Lemma
\ref{divisors-lemma-quasi-projective-Noetherian-pic-effective-Cartier}
we see that $\mathcal{E}$ is isomorphic to
$\mathcal{O}_X(D) \otimes \mathcal{O}_X(D')^{\otimes -1}$
for some effective Cartier divisors $D, D'$ on $X$ (this also uses
that $X$ is projective, see
Varieties, Lemma \ref{varieties-lemma-dim-1-proper-projective} for example).
By additivity of degree under tensor product of invertible sheaves
(Varieties, Lemma \ref{varieties-lemma-degree-tensor-product})
and additivity of $c_1$ under tensor product of invertible sheaves
(Lemma \ref{lemma-c1-cap-additive} or \ref{lemma-chern-classes-E-tensor-L})
we reduce to the case $\mathcal{E} = \mathcal{O}_X(D)$.
In this case the left hand side gives $\deg(D)$
(Varieties, Lemma \ref{varieties-lemma-degree-effective-Cartier-divisor})
and the right hand side gives $\deg([D]_0)$ by
Lemma \ref{lemma-geometric-cap}.
Since
$$
[D]_0 = \sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{D, x}) [x] =
\sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{D, x}}(\mathcal{O}_{D, x}) [x]
$$
by definition, we see
$$
\deg([D]_0) = \sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{D, x}}(\mathcal{O}_{D, x}) [\kappa(x) : k] =
\dim_k \Gamma(D, \mathcal{O}_D) = \deg(D)
$$
The penultimate equality by
Algebra, Lemma \ref{algebra-lemma-pushdown-module}
using that $D$ is affine.
\end{proof}

\noindent
Finally, we can tie everything up with the numerical intersections
defined in Varieties, Section \ref{varieties-section-num}.

\begin{lemma}
\label{lemma-degrees-and-numerical-intersections}
Let $k$ be a field. Let $X$ be a proper scheme over $k$.
Let $Z \subset X$ be a closed subscheme of dimension $d$.
Let $\mathcal{L}_1, \ldots, \mathcal{L}_d$ be invertible
$\mathcal{O}_X$-modules. Then
$$
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot Z) =
\deg(
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_1) \cap [Z]_d)
$$
where the left hand side is defined in
Varieties, Definition \ref{varieties-definition-intersection-number}.
In particular,
$$
\deg_\mathcal{L}(Z) = \deg(c_1(\mathcal{L})^d \cap [Z]_d)
$$
if $\mathcal{L}$ is an ample invertible $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
We will prove this by induction on $d$. If $d = 0$, then the result is
true by Varieties, Lemma \ref{varieties-lemma-chi-tensor-finite}.
Assume $d > 0$.

\medskip\noindent
Let $Z_i \subset Z$, $i = 1, \ldots, t$ be the irreducible components
of dimension $d$ with reduced induced scheme structure and let $m_i$ be the
multiplicity of $Z_i$ in $Z$. Then $[Z]_d = \sum m_i[Z_i]$ and
$c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [Z]_d$
is the sum of the cycles
$m_i c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [Z_i]$.
Since we have a similar decomposition for
$(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot Z)$ by
Varieties, Lemma \ref{varieties-lemma-numerical-polynomial-leading-term}
it suffices to prove the lemma in case $Z = X$
is a proper variety of dimension $d$ over $k$.

\medskip\noindent
By Chow's lemma there exists a birational proper morphism $f : Y \to X$
with $Y$ H-projective over $k$. See Cohomology of Schemes, Lemma
\ref{coherent-lemma-chow-Noetherian} and Remark
\ref{coherent-remark-chow-Noetherian}. Then
$$
(f^*\mathcal{L}_1 \cdots f^*\mathcal{L}_d \cdot Y) =
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot X)
$$
by Varieties, Lemma \ref{varieties-lemma-intersection-number-and-pullback}
and we have
$$
f_*(c_1(f^*\mathcal{L}_1) \cap \ldots \cap c_1(f^*\mathcal{L}_d) \cap [Y]) =
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [X]
$$
by Lemma \ref{lemma-pushforward-cap-c1}. Thus we may replace $X$ by $Y$
and assume that $X$ is projective over $k$.

\medskip\noindent
If $X$ is a proper $d$-dimensional projective variety, then we can
write $\mathcal{L}_1 = \mathcal{O}_X(D) \otimes \mathcal{O}_X(D')^{\otimes -1}$
for some effective Cartier divisors $D, D' \subset X$
by Divisors, Lemma
\ref{divisors-lemma-quasi-projective-Noetherian-pic-effective-Cartier}.
By additivity for both sides of the equation
(Varieties, Lemma \ref{varieties-lemma-intersection-number-additive} and
Lemma \ref{lemma-c1-cap-additive})
we reduce to the case $\mathcal{L}_1 = \mathcal{O}_X(D)$ for some
effective Cartier divisor $D$.
By Varieties, Lemma
\ref{varieties-lemma-numerical-intersection-effective-Cartier-divisor}
we have
$$
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot X) =
(\mathcal{L}_2 \cdots \mathcal{L}_d \cdot D)
$$
and by Lemma \ref{lemma-geometric-cap} we have
$$
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [X] =
c_1(\mathcal{L}_2) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [D]_{d - 1}
$$
Thus we obtain the result from our induction hypothesis.
\end{proof}








\section{Cycles of given codimension}
\label{section-cycles-codimension}

\noindent
In some cases there is a second grading on the abelian group
of all cycles given by codimension.

\begin{lemma}
\label{lemma-locally-equidimensional}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Write
$\delta = \delta_{X/S}$ as in Section \ref{section-setup}.
The following are equivalent
\begin{enumerate}
\item There exists a decomposition $X = \coprod_{n \in \mathbf{Z}} X_n$
into open and closed subschemes such that $\delta(\xi) = n$ whenever
$\xi \in X_n$ is a generic point of an irreducible component of $X_n$.
\item For all $x \in X$ there exists an open neighbourhood $U \subset X$
of $x$ and an integer $n$ such that $\delta(\xi) = n$ whenever
$\xi \in U$ is a generic point of an irreducible component of $U$.
\item For all $x \in X$ there exists an integer $n_x$ such that
$\delta(\xi) = n_x$ for any generic point $\xi$ of an irreducible
component of $X$ containing $x$.
\end{enumerate}
The conditions are satisfied if $X$ is either
normal or Cohen-Macaulay\footnote{In fact, it suffices if
$X$ is $(S_2)$. Compare with Local Cohomology, Lemma
\ref{local-cohomology-lemma-catenary-S2-equidimensional}.}.
\end{lemma}

\begin{proof}
It is clear that (1) $\Rightarrow$ (2) $\Rightarrow$ (3).
Conversely, if (3) holds, then we set $X_n = \{x \in X \mid n_x = n\}$
and we get a decomposition as in (1). Namely, $X_n$ is open because
given $x$ the union of the irreducible components of $X$ passing through $x$
minus the union of the irreducible components of $X$ not passing through $x$
is an open neighbourhood of $x$. If $X$ is normal, then $X$ is a
disjoint union of integral schemes
(Properties, Lemma \ref{properties-lemma-normal-locally-Noetherian})
and hence the properties hold.
If $X$ is Cohen-Macaulay, then
$\delta' : X \to \mathbf{Z}$, $x \mapsto -\dim(\mathcal{O}_{X, x})$
is a dimension function on $X$ (see Example \ref{example-CM-irreducible}).
Since $\delta - \delta'$ is locally constant
(Topology, Lemma \ref{topology-lemma-dimension-function-unique})
and since $\delta'(\xi) = 0$ for every generic point $\xi$ of $X$
we see that (2) holds.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$ satisfying the equivalent
conditions of Lemma \ref{lemma-locally-equidimensional}. For an integral
closed subscheme $Z \subset X$ we have the codimension $\text{codim}(Z, X)$
of $Z$ in $X$, see Topology, Definition \ref{topology-definition-codimension}.
We define a {\it codimension $p$-cycle} to be a cycle $\alpha = \sum n_Z[Z]$
on $X$ such that $n_Z \not = 0 \Rightarrow \text{codim}(Z, X) = p$.
The abelian group of all codimension $p$-cycles is denoted $Z^p(X)$.
Let $X = \coprod X_n$ be the decomposition given in
Lemma \ref{lemma-locally-equidimensional} part (1).
Recalling that our cycles are defined as locally finite sums, it is clear that
$$
Z^p(X) = \prod\nolimits_n Z_{n - p}(X_n)
$$
Moreover, we see that $\prod_p Z^p(X) = \prod_k Z_k(X)$. We could now define
rational equivalence of codimension $p$ cycles on $X$ in exactly the same
manner as before and in fact we could redevelop the whole theory from scratch
for cycles of a given codimension for $X$ as in
Lemma \ref{lemma-locally-equidimensional}. However, instead we simply
define the {\it Chow group of codimension $p$-cycles} as
$$
\CH^p(X) = \prod\nolimits_n \CH_{n - p}(X_n)
$$
As before we have $\prod_p \CH^p(X) = \prod_k \CH_k(X)$.
If $X$ is quasi-compact, then the product in the formula is finite
(and hence is a direct sum) and we have
$\bigoplus_p \CH^p(X) = \bigoplus_k \CH_k(X)$. If $X$ is quasi-compact
and finite dimensional, then only a finite number of these groups
is nonzero.

\medskip\noindent
Many of the constructions and results for Chow groups proved above have
natural counterparts for the Chow groups $\CH^*(X)$. Each of these is
shown by decomposing the relevant schemes into ``equidimensional'' pieces
as in Lemma \ref{lemma-locally-equidimensional}
and applying the results already proved for the
factors in the product decomposition given above.
Let us list some of them.
\begin{enumerate}
\item If $f : X \to Y$ is a flat morphism of schemes locally of finite type
over $S$ and $X$ and $Y$ satisfy the equivalent conditions of
Lemma \ref{lemma-locally-equidimensional} then flat pullback determines a map
$$
f^* : \CH^p(Y) \to \CH^p(X)
$$
\item If $f : X \to Y$ is a morphism of schemes locally of finite type
over $S$ and $X$ and $Y$ satisfy the equivalent conditions of
Lemma \ref{lemma-locally-equidimensional} let us say $f$ has
{\it codimension} $r \in \mathbf{Z}$ if for all pairs of irreducible components
$Z \subset X$, $W \subset Y$ with $f(Z) \subset W$ we have
$\dim_\delta(W) - \dim_\delta(Z) = r$.
\item If $f : X \to Y$ is a proper morphism of schemes locally of finite type
over $S$ and $X$ and $Y$ satisfy the equivalent conditions of
Lemma \ref{lemma-locally-equidimensional} and $f$ has codimension $r$,
then proper pushforward is a map
$$
f_* : \CH^p(X) \to \CH^{p + r}(Y)
$$
\item If $f : X \to Y$ is a morphism of schemes locally of finite type over $S$
and $X$ and $Y$ satisfy the equivalent conditions of
Lemma \ref{lemma-locally-equidimensional} and $f$ has codimension $r$
and $c \in A^q(X \to Y)$, then $c$ induces maps
$$
c \cap -  : \CH^p(Y) \to \CH^{p + q - r}(X)
$$
\item If $X$ is a scheme locally of finite type over $S$
satisfying the equivalent conditions of
Lemma \ref{lemma-locally-equidimensional} and
$\mathcal{L}$ is an invertible $\mathcal{O}_X$-module,
then
$$
c_1(\mathcal{L}) \cap - : \CH^p(X) \to \CH^{p + 1}(X)
$$
\item If $X$ is a scheme locally of finite type over $S$
satisfying the equivalent conditions of
Lemma \ref{lemma-locally-equidimensional} and
$\mathcal{E}$ is a finite locally free $\mathcal{O}_X$-module,
then
$$
c_i(\mathcal{E}) \cap - : \CH^p(X) \to \CH^{p + i}(X)
$$
\end{enumerate}
Warning: the property for a morphism to have codimension $r$
is not preserved by base change.

\begin{remark}
\label{remark-fundamental-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$ satisfying the
equivalent conditions of Lemma \ref{lemma-locally-equidimensional}.
Let $X = \coprod X_n$ be the decomposition into open and closed
subschemes such that every irreducible component of $X_n$ has
$\delta$-dimension $n$. In this situation we sometimes set
$$
[X] = \sum\nolimits_n [X_n]_n \in \CH^0(X)
$$
This class is a kind of ``fundamental class'' of $X$ in Chow theory.
\end{remark}




\section{The splitting principle}
\label{section-splitting-principle}

\noindent
In our setting it is not so easy to say what the splitting principle
exactly says/is. Here is a possible formulation.

\begin{lemma}
\label{lemma-splitting-principle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $\mathcal{E}_i$ be a finite collection of
locally free $\mathcal{O}_X$-modules of rank $r_i$. There exists a projective
flat morphism $\pi : P \to X$ of relative dimension $d$ such that
\begin{enumerate}
\item for any morphism $f : Y \to X$ the map
$\pi_Y^* : \CH_*(Y) \to \CH_{* + d}(Y \times_X P)$ is injective, and
\item each $\pi^*\mathcal{E}_i$ has a filtration
whose successive quotients $\mathcal{L}_{i, 1}, \ldots, \mathcal{L}_{i, r_i}$
are invertible ${\mathcal O}_P$-modules.
\end{enumerate}
Moreover, when (1) holds the restriction map $A^*(X) \to A^*(P)$
(Remark \ref{remark-pullback-cohomology}) is injective.
\end{lemma}

\begin{proof}
We may assume $r_i \geq 1$ for all $i$. We will prove the lemma by induction
on $\sum (r_i - 1)$. If this integer is $0$, then $\mathcal{E}_i$
is invertible for all $i$ and we conclude by taking $\pi = \text{id}_X$.
If not, then we can pick an $i$ such that $r_i > 1$ and consider the
morphism $\pi_i : P_i = \mathbf{P}(\mathcal{E}_i) \to X$.
We have a short exact sequence
$$
0 \to \mathcal{F} \to \pi_i^*\mathcal{E}_i \to \mathcal{O}_{P_i}(1) \to 0
$$
of finite locally free $\mathcal{O}_{P_i}$-modules of ranks $r_i - 1$,
$r_i$, and $1$. Observe that $\pi_i^*$ is injective on chow groups
after any base change by the projective bundle formula
(Lemma \ref{lemma-chow-ring-projective-bundle}).
By the induction hypothesis applied to the finite locally free
$\mathcal{O}_{P_i}$-modules $\mathcal{F}$ and $\pi_{i'}^*\mathcal{E}_{i'}$
for $i' \not = i$, we find a morphism $\pi : P \to P_i$ with
properties stated as in the lemma. Then the composition
$\pi_i \circ \pi : P \to X$ does the job. Some details omitted.
\end{proof}

\begin{remark}
\label{remark-the-proof-shows-more}
The proof of Lemma \ref{lemma-splitting-principle}
shows that the morphism $\pi : P \to X$ has the following additional
properties:
\begin{enumerate}
\item $\pi$ is a finite composition of projective space bundles
associated to locally free modules of finite constant rank, and
\item for every $\alpha \in \CH_k(X)$ we have
$\alpha = \pi_*(\xi_1 \cap \ldots \cap \xi_d \cap \pi^*\alpha)$
where $\xi_i$ is the first chern class of some invertible
$\mathcal{O}_P$-module.
\end{enumerate}
The second observation follows from the first and
Lemma \ref{lemma-cap-projective-bundle}.
We will add more observations here as needed.
\end{remark}

\noindent
Let $(S, \delta)$, $X$, and $\mathcal{E}_i$ be as in
Lemma \ref{lemma-splitting-principle}.
The {\it splitting principle} refers to the practice of symbolically writing
$$
c(\mathcal{E}_i) = \prod (1 + x_{i, j})
$$
The symbols $x_{i, 1}, \ldots, x_{i, r_i}$ are called the {\it Chern roots}
of $\mathcal{E}_i$. In other words, the $p$th chern class of $\mathcal{E}_i$
is the $p$th elementary symmetric function in the chern roots.
The usefulness of the splitting principle comes from the assertion that
in order to prove a polynomial relation among chern classes of the
$\mathcal{E}_i$ it is enough to prove the corresponding relation among the
chern roots.

\medskip\noindent
Namely, let $\pi : P \to X$ be as in Lemma \ref{lemma-splitting-principle}.
Recall that there is a canonical $\mathbf{Z}$-algebra map
$\pi^* : A^*(X) \to A^*(P)$, see
Remark \ref{remark-pullback-cohomology}. The injectivity of $\pi_Y^*$
on Chow groups for every $Y$ over $X$, implies that the map
$\pi^* : A^*(X) \to A^*(P)$ is injective (details omitted).
We have
$$
\pi^*c(\mathcal{E}_i) = \prod (1 + c_1(\mathcal{L}_{i, j}))
$$
by Lemma \ref{lemma-chern-filter-by-linebundles}. Thus we may think of the
chern roots $x_{i, j}$ as the elements $c_1(\mathcal{L}_{i, j}) \in A^*(P)$
and the displayed equation as taking place in $A^*(P)$ after
applying the injective map $\pi^* : A^*(X) \to A^*(P)$ to the left
hand side of the equation.

\medskip\noindent
To see how this works, it is best to give some examples.

\begin{lemma}
\label{lemma-chern-classes-dual}
In Situation \ref{situation-setup} let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
with dual $\mathcal{E}^\vee$. Then
$$
c_i(\mathcal{E}^\vee) = (-1)^i c_i(\mathcal{E})
$$
in $A^i(X)$.
\end{lemma}

\begin{proof}
Choose a morphism $\pi : P \to X$ as in
Lemma \ref{lemma-splitting-principle}.
By the injectivity of $\pi^*$ (after any base change)
it suffices to prove the relation between
the chern classes of $\mathcal{E}$ and $\mathcal{E}^\vee$
after pulling back to $P$. Thus we may assume there
exist invertible $\mathcal{O}_X$-modules
${\mathcal L}_i$, $i = 1, \ldots, r$
and a filtration
$$
0 = \mathcal{E}_0 \subset \mathcal{E}_1 \subset \mathcal{E}_2
\subset \ldots \subset \mathcal{E}_r = \mathcal{E}
$$
such that $\mathcal{E}_i/\mathcal{E}_{i - 1} \cong \mathcal{L}_i$.
Then we obtain the dual filtration
$$
0 = \mathcal{E}_r^\perp \subset \mathcal{E}_1^\perp \subset \mathcal{E}_2^\perp
\subset \ldots \subset \mathcal{E}_0^\perp = \mathcal{E}^\vee
$$
such that $\mathcal{E}_{i - 1}^\perp/\mathcal{E}_i^\perp \cong
\mathcal{L}_i^{\otimes -1}$.
Set $x_i = c_1(\mathcal{L}_i)$.
Then $c_1(\mathcal{L}_i^{\otimes -1}) = - x_i$
by Lemma \ref{lemma-c1-cap-additive}.
By Lemma \ref{lemma-chern-filter-by-linebundles}
we have
$$
c(\mathcal{E}) = \prod\nolimits_{i = 1}^r (1 + x_i)
\quad\text{and}\quad
c(\mathcal{E}^\vee) = \prod\nolimits_{i = 1}^r (1 - x_i)
$$
in $A^*(X)$. The result follows from a formal computation
which we omit.
\end{proof}

\begin{lemma}
\label{lemma-chern-classes-tensor-product}
In Situation \ref{situation-setup} let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ and $\mathcal{F}$ be a finite locally free
$\mathcal{O}_X$-modules of ranks $r$ and $s$. Then we have
$$
c_1(\mathcal{E} \otimes \mathcal{F})
=
r c_1(\mathcal{F}) + s c_1(\mathcal{E})
$$
$$
c_2(\mathcal{E} \otimes \mathcal{F})
=
r c_2(\mathcal{F}) + s c_2(\mathcal{E}) +
{r \choose 2} c_1(\mathcal{F})^2 +
(rs - 1) c_1(\mathcal{F})c_1(\mathcal{E}) +
{s \choose 2} c_1(\mathcal{E})^2
$$
and so on in $A^*(X)$.
\end{lemma}

\begin{proof}
Arguing exactly as in the proof of Lemma \ref{lemma-chern-classes-dual}
we may assume we have
invertible $\mathcal{O}_X$-modules
${\mathcal L}_i$, $i = 1, \ldots, r$
${\mathcal N}_i$, $i = 1, \ldots, s$
filtrations
$$
0 = \mathcal{E}_0 \subset \mathcal{E}_1 \subset \mathcal{E}_2
\subset \ldots \subset \mathcal{E}_r = \mathcal{E}
\quad\text{and}\quad
0 = \mathcal{F}_0 \subset \mathcal{F}_1 \subset \mathcal{F}_2
\subset \ldots \subset \mathcal{F}_s = \mathcal{F}
$$
such that $\mathcal{E}_i/\mathcal{E}_{i - 1} \cong \mathcal{L}_i$
and such that $\mathcal{F}_j/\mathcal{F}_{j - 1} \cong \mathcal{N}_j$.
Ordering pairs $(i, j)$ lexicographically
we obtain a filtration
$$
0 \subset \ldots \subset
\mathcal{E}_i \otimes \mathcal{F}_j
+
\mathcal{E}_{i - 1} \otimes \mathcal{F}
\subset \ldots \subset \mathcal{E} \otimes \mathcal{F}
$$
with successive quotients
$$
\mathcal{L}_1 \otimes \mathcal{N}_1,
\mathcal{L}_1 \otimes \mathcal{N}_2,
\ldots,
\mathcal{L}_1 \otimes \mathcal{N}_s,
\mathcal{L}_2 \otimes \mathcal{N}_1,
\ldots,
\mathcal{L}_r \otimes \mathcal{N}_s
$$
By Lemma \ref{lemma-chern-filter-by-linebundles}
we have
$$
c(\mathcal{E}) = \prod (1 + x_i),
\quad
c(\mathcal{F}) = \prod (1 + y_j),
\quad\text{and}\quad
c(\mathcal{F}) = \prod (1 + x_i + y_j),
$$
in $A^*(X)$. The result follows from a formal computation
which we omit.
\end{proof}

\begin{remark}
\label{remark-equalities-nonconstant-rank}
The equalities proven above remain true even when we work with
finite locally free
$\mathcal{O}_X$-modules whose rank is allowed to be nonconstant.
In fact, we can work with polynomials in the rank and the
chern classes as follows. Consider the  graded polynomial ring
$\mathbf{Z}[r, c_1, c_2, c_3, \ldots]$
where $r$ has degree $0$ and $c_i$ has degree $i$. Let
$$
P \in \mathbf{Z}[r, c_1, c_2, c_3, \ldots]
$$
be a homogeneous polynomial of degree $p$. Then for any finite locally
free $\mathcal{O}_X$-module $\mathcal{E}$ on $X$ we can consider
$$
P(\mathcal{E}) =
P(r(\mathcal{E}), c_1(\mathcal{E}), c_2(\mathcal{E}), c_3(\mathcal{E}), \ldots)
\in A^p(X)
$$
see Remark \ref{remark-extend-to-finite-locally-free} for notation and
conventions. To prove relations among these polynomials (for multiple
finite locally free modules) we can work locally on $X$ and use the splitting
principle as above. For example, we claim that
$$
c_2(\SheafHom_{\mathcal{O}_X}(\mathcal{E}, \mathcal{E})) =
P(\mathcal{E})
$$
where $P = 2rc_2 - (r - 1)c_1^2$.
Namely, since $\SheafHom_{\mathcal{O}_X}(\mathcal{E}, \mathcal{E}) =
\mathcal{E} \otimes \mathcal{E}^\vee$ this follows easily from
Lemmas \ref{lemma-chern-classes-dual} and
\ref{lemma-chern-classes-tensor-product}
above by decomposing $X$ into parts where the rank
of $\mathcal{E}$ is constant as in
Remark \ref{remark-extend-to-finite-locally-free}.
\end{remark}

\begin{example}
\label{example-power-sum}
For every $p \geq 1$ there is a unique homogeneous polynomial
$P_p \in \mathbf{Z}[c_1, c_2, c_3, \ldots]$ of degree $p$
such that, for any $n \geq p$ we have
$$
P_p(s_1, s_2, \ldots, s_p) = \sum x_i^p
$$
in $\mathbf{Z}[x_1, \ldots, x_n]$ where $s_1, \ldots, s_p$ are the
elementary symmetric polynomials in $x_1, \ldots, x_n$, so
$$
s_i = \sum\nolimits_{1 \leq j_1 < \ldots < j_i \leq n}
x_{j_1}x_{j_2} \ldots x_{j_i}
$$
The existence of $P_p$ comes from the well known fact that
the elementary symmetric functions generate the ring of
all symmetric functions over the integers. Another way to
characterize $P_p \in \mathbf{Z}[c_1, c_2, c_3, \ldots]$ is that we have
$$
\log(1 + c_1 + c_2 + c_3 + \ldots) =
\sum\nolimits_{p \geq 1} (-1)^{p - 1}\frac{P_p}{p}
$$
as formal power series. This is clear by writing
$1 + c_1 + c_2 + \ldots = \prod (1 + x_i)$ and applying
the power series for the logarithm function. Expanding the left
hand side we get
\begin{align*}
& (c_1 + c_2 + \ldots) - (1/2)(c_1 + c_2 + \ldots)^2 +
(1/3)(c_1 + c_2 + \ldots)^3 - \ldots \\
& =
c_1 + (c_2 - (1/2)c_1^2) + (c_3 - c_1c_2 + (1/3)c_1^3) + \ldots
\end{align*}
In this way we find that
\begin{align*}
P_1 & = c_1, \\
P_2 & = c_1^2 - 2c_2, \\
P_3 & = c_1^3 - 3c_1c_2 + 3c_3, \\
P_4 & = c_1^4 - 4c_1^2c_2 + 4c_1c_3 + 2c_2^2 - 4c_4,
\end{align*}
and so on. Since the chern classes of a finite locally free
$\mathcal{O}_X$-module $\mathcal{E}$ are the elementary symmetric
polynomials in the chern roots $x_i$, we see that
$$
P_p(\mathcal{E}) = \sum x_i^p
$$
For convenience we set $P_0 = r$ in $\mathbf{Z}[r, c_1, c_2, c_3, \ldots]$
so that $P_0(\mathcal{E}) = r(\mathcal{E})$ as a bivariant class
(as in Remarks \ref{remark-extend-to-finite-locally-free} and
\ref{remark-equalities-nonconstant-rank}).
\end{example}






\section{Chern classes and sections}
\label{section-top-chern-class}

\noindent
A brief section whose main result is that we may compute the
top chern class of a finite locally free module using the
vanishing locus of a ``regular section.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $\mathcal{E}$ be a finite locally
free $\mathcal{O}_X$-module. Let $f : X' \to X$ be locally of finite type. Let
$$
s \in \Gamma(X', f^*\mathcal{E})
$$
be a global section of the pullback of $\mathcal{E}$ to $X'$. Let
$Z(s) \subset X'$ be the zero scheme of $s$. More precisely, we define
$Z(s)$ to be the closed subscheme whose quasi-coherent sheaf
of ideals is the image of the map
$s : f^*\mathcal{E}^\vee \to \mathcal{O}_{X'}$.

\begin{lemma}
\label{lemma-top-chern-class}
In the situation described just above assume $\dim_\delta(X') = n$,
that $f^*\mathcal{E}$ has constant rank $r$, that
$\dim_\delta(Z(s)) \leq n - r$, and that for every generic point
$\xi \in Z(s)$ with $\delta(\xi) = n - r$ the ideal of $Z(s)$
in $\mathcal{O}_{X', \xi}$ is generated by a regular sequence
of length $r$. Then
$$
c_r(\mathcal{E}) \cap [X']_n = [Z(s)]_{n - r}
$$
in $\CH_*(X')$.
\end{lemma}

\begin{proof}
Since $c_r(\mathcal{E})$ is a bivariant class
(Lemma \ref{lemma-cap-cp-bivariant})
we may assume $X = X'$ and we have to show that
$c_r(\mathcal{E}) \cap [X]_n = [Z(s)]_{n - r}$ in $\CH_{n - r}(X)$.
We will prove the lemma by induction on $r \geq 0$. (The case
$r = 0$ is trivial.) The case $r = 1$
is handled by Lemma \ref{lemma-geometric-cap}. Assume $r > 1$.

\medskip\noindent
Let $\pi : P \to X$ be the projective space bundle associated to
$\mathcal{E}$ and consider the short exact sequence
$$
0 \to \mathcal{E}' \to \pi^*\mathcal{E} \to \mathcal{O}_P(1) \to 0
$$
By the projective space bundle formula
(Lemma \ref{lemma-chow-ring-projective-bundle})
it suffices to prove the equality after pulling back by $\pi$.
Observe that $\pi^{-1}Z(s) = Z(\pi^*s)$ has $\delta$-dimension
$\leq n - 1$ and that the assumption on regular sequences at
generic points of $\delta$-dimension $n - 1$ holds by
flat pullback, see
Algebra, Lemma \ref{algebra-lemma-flat-increases-depth}.
Let $t \in \Gamma(P, \mathcal{O}_P(1))$ be the image of $\pi^*s$.
We claim
$$
[Z(t)]_{n + r - 2} = c_1(\mathcal{O}_P(1)) \cap [P]_{n + r - 1}
$$
Assuming the claim we finish the proof as follows.
The restriction $\pi^*s|_{Z(t)}$ maps to zero in
$\mathcal{O}_P(1)|_{Z(t)}$ hence comes from a unique
element $s' \in \Gamma(Z(t), \mathcal{E}'|_{Z(t)})$.
Note that $Z(s') = Z(\pi^*s)$ as closed subschemes of $P$.
If $\xi \in Z(s')$ is a generic point with $\delta(\xi) = n - 1$,
then the ideal of $Z(s')$ in $\mathcal{O}_{Z(t), \xi}$
can be generated by a regular sequence of length $r - 1$: it is generated by
$r - 1$ elements which are the images of $r - 1$ elements in
$\mathcal{O}_{P, \xi}$ which together with a generator of the
ideal of $Z(t)$ in $\mathcal{O}_{P, \xi}$ form a regular sequence
of length $r$ in $\mathcal{O}_{P, \xi}$. Hence we can apply the
induction hypothesis to $s'$ on $Z(t)$ to get
$c_{r - 1}(\mathcal{E}') \cap [Z(t)]_{n + r - 2} = [Z(s')]_{n - 1}$.
Combining all of the above we obtain
\begin{align*}
c_r(\pi^*\mathcal{E}) \cap [P]_{n + r - 1}
& =
c_{r - 1}(\mathcal{E}') \cap c_1(\mathcal{O}_P(1)) \cap [P]_{n + r - 1} \\
& =
c_{r - 1}(\mathcal{E}') \cap [Z(t)]_{n + r - 2} \\
& =
[Z(s')]_{n - 1} \\
& = [Z(\pi^*s)]_{n - 1}
\end{align*}
which is what we had to show.

\medskip\noindent
Proof of the claim. This will follow from an application of
the already used Lemma \ref{lemma-geometric-cap}.
We have $\pi^{-1}(Z(s)) = Z(\pi^*s) \subset Z(t)$.
On the other hand, for $x \in X$ if $P_x \subset Z(t)$, then
$t|_{P_x} = 0$ which implies that $s$ is zero in the fibre
$\mathcal{E} \otimes \kappa(x)$, which implies $x \in Z(s)$.
It follows that $\dim_\delta(Z(t)) \leq n + (r - 1) - 1$.
Finally, let $\xi \in Z(t)$ be a generic point with
$\delta(\xi) = n + r - 2$. If $\xi$ is not the generic point
of the fibre of $P \to X$ it is immediate that
a local equation of $Z(t)$ is a nonzerodivisor in $\mathcal{O}_{P, \xi}$
(because we can check this on the fibre by
Algebra, Lemma \ref{algebra-lemma-grothendieck}).
If $\xi$ is the generic point of a fibre, then $x = \pi(\xi) \in Z(s)$
and $\delta(x) = n + r - 2 - (r - 1) = n - 1$. This is a contradiction
with $\dim_\delta(Z(s)) \leq n - r$ because $r > 1$
so this case doesn't happen.
\end{proof}

\begin{lemma}
\label{lemma-easy-virtual-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$
be a scheme locally of finite type over $S$. Let
$$
0 \to \mathcal{N}' \to \mathcal{N} \to \mathcal{E} \to 0
$$
be a short exact sequence of finite locally free $\mathcal{O}_X$-modules.
Consider the closed embedding
$$
i :
N' = \underline{\text{Spec}}_X(\text{Sym}((\mathcal{N}')^\vee))
\longrightarrow
N = \underline{\text{Spec}}_X(\text{Sym}(\mathcal{N}^\vee))
$$
For $\alpha \in \CH_k(X)$ we have
$$
i_*(p')^*\alpha = p^*(c_{top}(\mathcal{E}) \cap \alpha)
$$
where $p' : N' \to X$ and $p : N \to X$ are the structure morphisms.
\end{lemma}

\begin{proof}
Here $c_{top}(\mathcal{E})$ is the bivariant class defined in
Remark \ref{remark-top-chern-class}. By its very definition, in
order to verify the formula, we may assume that $\mathcal{E}$
has constant rank. We may similarly assume $\mathcal{N}'$ and
$\mathcal{N}$ have constant ranks, say $r'$ and $r$, so
$\mathcal{E}$ has rank $r - r'$ and
$c_{top}(\mathcal{E}) = c_{r - r'}(\mathcal{E})$.
Observe that $p^*\mathcal{E}$ has a canonical section
$$
s \in \Gamma(N, p^*\mathcal{E}) = \Gamma(X, p_*p^*\mathcal{E}) =
\Gamma(X, \mathcal{E} \otimes_{\mathcal{O}_X} \text{Sym}(\mathcal{N}^\vee)
\supset \Gamma(X, \SheafHom(\mathcal{N}, \mathcal{E}))
$$
corresponding to the surjection $\mathcal{N} \to \mathcal{E}$ given
in the statement of the lemma. The vanishing scheme of this section
is exactly $N' \subset N$. Let $Y \subset X$ be an integral closed
subscheme of $\delta$-dimension $n$. Then we have
\begin{enumerate}
\item $p^*[Y] = [p^{-1}(Y)]$ since $p^{-1}(Y)$ is integral of
$\delta$-dimension $n + r$,
\item $(p')^*[Y] = [(p')^{-1}(Y)]$ since $(p')^{-1}(Y)$ is integral of
$\delta$-dimension $n + r'$,
\item the restriction of $s$ to $p^{-1}Y$ has vanishing scheme
$(p')^{-1}Y$ and the closed immersion $(p')^{-1}Y \to p^{-1}Y$
is a regular immersion (locally cut out by a regular sequence).
\end{enumerate}
We conclude that
$$
(p')^*[Y] = c_{r - r'}(p^*\mathcal{E}) \cap p^*[Y]
\quad\text{in}\quad \CH_*(N)
$$
by Lemma \ref{lemma-top-chern-class}. This proves the lemma.
\end{proof}










\section{The Chern character and tensor products}
\label{section-chern-classes-tensor}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
We define the {\it Chern character} of a finite locally free
$\mathcal{O}_X$-module to be the formal expression
$$
ch({\mathcal E}) = \sum\nolimits_{i=1}^r e^{x_i}
$$
if the $x_i$ are the chern roots of ${\mathcal E}$. Writing this
as a polynomial in the chern classes we obtain
\begin{align*}
ch(\mathcal{E})
& =
r(\mathcal{E})
+
c_1(\mathcal{E}) +
\frac{1}{2}(c_1(\mathcal{E})^2 - 2c_2(\mathcal{E}))
+
\frac{1}{6}(c_1(\mathcal{E})^3 - 3c_1(\mathcal{E})c_2(\mathcal{E}) + 3c_3(\mathcal{E})) \\
& \quad\quad +
\frac{1}{24}(c_1(\mathcal{E})^4 - 4c_1(\mathcal{E})^2c_2(\mathcal{E}) + 4c_1(\mathcal{E})c_3(\mathcal{E}) + 2c_2(\mathcal{E})^2 - 4c_4(\mathcal{E}))
+
\ldots \\
& =
\sum\nolimits_{p = 0, 1, 2, \ldots} \frac{P_p(\mathcal{E})}{p!}
\end{align*}
with $P_p$ polynomials in the chern classes as in
Example \ref{example-power-sum}.
What does it mean that the coefficients are rational numbers?
Well this simply means that we think of
$ch_p(\mathcal{E})$ as an element of $A^p(X) \otimes \mathbf{Q}$.

\begin{remark}
\label{remark-extend-chern-character-to-finite-locally-free}
In the discussion above we have defined the Chern character
$ch(\mathcal{E})$ of $\mathcal{E}$ even if the rank of $\mathcal{E}$
is not constant. See Remarks \ref{remark-extend-to-finite-locally-free} and
\ref{remark-equalities-nonconstant-rank}.
\end{remark}

\begin{lemma}
\label{lemma-chern-character-additive}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let
$
0 \to \mathcal{E}_1 \to \mathcal{E} \to \mathcal{E}_2 \to 0
$
be a short exact sequence of finite locally free $\mathcal{O}_X$-modules.
Then we have the equality
$$
ch(\mathcal{E}) = ch(\mathcal{E}_1) + ch(\mathcal{E}_2)
$$
in $A^*(X) \otimes \mathbf{Q}$. More precisely, we have
$P_p(\mathcal{E}) = P_p(\mathcal{E}_1) + P_p(\mathcal{E}_2)$
in $A^p(X)$ where $P_p$ is as in Example \ref{example-power-sum}.
\end{lemma}

\begin{proof}
It suffices to prove the more precise statement. By
Section \ref{section-splitting-principle}
this follows because if $x_{1, i}$, $i = 1, \ldots, r_1$
and $x_{2, i}$, $i = 1, \ldots, r_2$ are the
chern roots of $\mathcal{E}_1$ and $\mathcal{E}_2$, then
$x_{1, 1}, \ldots, x_{1, r_1}, x_{2, 1}, \ldots, x_{2, r_2}$
are the chern roots of $\mathcal{E}$. Hence we get the result
from our choice of $P_p$ in Example \ref{example-power-sum}.
\end{proof}

\begin{lemma}
\label{lemma-chern-character-multiplicative}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $\mathcal{E}_1$ and $\mathcal{E}_2$
be finite locally free $\mathcal{O}_X$-modules.
Then we have the equality
$$
ch(\mathcal{E}_1 \otimes_{\mathcal{O}_X} \mathcal{E}_2) =
ch(\mathcal{E}_1) ch(\mathcal{E}_2)
$$
in $A^*(X) \otimes \mathbf{Q}$. More precisely, we have
$$
P_p(\mathcal{E}_1 \otimes_{\mathcal{O}_X} \mathcal{E}_2) =
\sum\nolimits_{p_1 + p_2 = p}
{p \choose p_1} P_{p_1}(\mathcal{E}_1) P_{p_2}(\mathcal{E}_2)
$$
in $A^p(X)$ where $P_p$ is as in Example \ref{example-power-sum}.
\end{lemma}

\begin{proof}
It suffices to prove the more precise statement. By
Section \ref{section-splitting-principle}
this follows because if $x_{1, i}$, $i = 1, \ldots, r_1$
and $x_{2, i}$, $i = 1, \ldots, r_2$ are the
chern roots of $\mathcal{E}_1$ and $\mathcal{E}_2$, then
$x_{1, i} + x_{2, j}$, $1 \leq i \leq r_1$, $1 \leq j \leq r_2$
are the chern roots of $\mathcal{E}_1 \otimes \mathcal{E}_2$.
Hence we get the result from the binomial formula for
$(x_{1, i} + x_{2, j})^p$ and the
shape of our polynomials $P_p$ in Example \ref{example-power-sum}.
\end{proof}

\begin{lemma}
\label{lemma-chern-character-dual}
In Situation \ref{situation-setup} let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
with dual $\mathcal{E}^\vee$. Then
$ch_i(\mathcal{E}^\vee) = (-1)^i ch_i(\mathcal{E})$ in $A^i(X)$.
\end{lemma}

\begin{proof}
Follows from the corresponding result for chern classes
(Lemma \ref{lemma-chern-classes-dual}).
\end{proof}











\section{Chern classes and the derived category}
\label{section-pre-derived}

\noindent
In this section we define the total chern class of an object
of the derived category which may be represented globally
by a finite complex of finite locally free modules.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let
$$
\mathcal{E}^a \to \mathcal{E}^{a + 1} \to \ldots \to \mathcal{E}^b
$$
be a finite complex of finite locally free $\mathcal{O}_X$-modules.
Then we define the {\it total chern class of the complex} by the formula
$$
c(\mathcal{E}^\bullet) = \prod\nolimits_{p = a, \ldots, b}
c(\mathcal{E}^p)^{(-1)^p}
$$
in $A^*(X)$. Here the inverse is the formal inverse, so
$$
(1 + c_1 + c_2 + c_3 + \ldots)^{-1} =
1 - c_1 + c_1^2 - c_2 - c_1^3 + 2c_1 c_2 - c_3 + \ldots
$$
We similarly define the {\it Chern character of the complex} by
the formula
$$
ch(\mathcal{E}^\bullet) = \sum\nolimits_{p = a, \ldots, b}
(-1)^p ch(\mathcal{E}^p)
$$
in $A^*(X) \otimes \mathbf{Q}$. Finally, for
$P_p \in \mathbf{Z}[r, c_1, c_2, c_3, \ldots]$
as in Example \ref{example-power-sum} we define
$$
P_p(\mathcal{E}^\bullet) = \sum\nolimits_{i = a, \ldots, b}
(-1)^i P_p(\mathcal{E}^i)
$$
in $A^p(X)$. Let us prove that these constructions only depends
on the image of the complex in the derived category.

\begin{lemma}
\label{lemma-pre-derived-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let $E \in D(\mathcal{O}_X)$
be an object such that there exists a finite complex $\mathcal{E}^\bullet$
of finite locally free $\mathcal{O}_X$-modules representing $E$.
Then $c(\mathcal{E}^\bullet) \in A^*(X)$,
$ch(\mathcal{E}^\bullet) \in A^*(X) \otimes \mathbf{Q}$, and
$P_p(\mathcal{E}^\bullet) \in A^p(X)$
are independent of the choice of the complex.
\end{lemma}

\begin{proof}
We prove this for the total chern class; the other two cases follow
by the same arguments using
Lemma \ref{lemma-chern-character-additive}
instead of
Lemma \ref{lemma-additivity-chern-classes}.

\medskip\noindent
Suppose we have a second finite complex
$\mathcal{F}^\bullet$ of finite locally free $\mathcal{O}_X$-modules
representing $E$.
Let $g : Y \to X$ be a morphism locally of finite type with $Y$ integral.
By Lemma \ref{lemma-bivariant-zero} it suffices to show that
with $c(g^*\mathcal{E}^\bullet) \cap [Y]$ is the same as
$c(g^*\mathcal{F}^\bullet) \cap [Y]$ and it even suffices to prove
this after replacing $Y$ by an integral scheme proper and birational
over $Y$. By
More on Flatness, Lemma \ref{flat-lemma-blowup-complex-integral}
we may assume that $H^i(Lg^*E)$ is perfect of tor dimension $\leq 1$
for all $i \in \mathbf{Z}$.
This reduces us to the case discussed in the next paragraph.

\medskip\noindent
Assume $X$ is integral and $H^i(E)$ is a perfect $\mathcal{O}_X$-module
of tor dimension $\leq 1$ for all $i \in \mathbf{Z}$. We have to
show that $c(\mathcal{E}^\bullet) \cap [X]$ is the same as
$c(\mathcal{F}^\bullet) \cap [X]$. Denote
$d_\mathcal{E}^i : \mathcal{E}^i \to \mathcal{E}^{i + 1}$ and
$d_\mathcal{F}^i : \mathcal{F}^i \to \mathcal{F}^{i + 1}$
the differentials of our complexes. By
More on Flatness, Remark \ref{flat-remark-when-you-have-a-complex}
we know that $\Im(d_\mathcal{E}^i)$, $\Ker(d_\mathcal{E}^i)$,
$\Im(d_\mathcal{F}^i)$, and $\Ker(d_\mathcal{F}^i)$
are finite locally free $\mathcal{O}_X$-modules for all $i$.
By additivity (Lemma \ref{lemma-additivity-chern-classes}) we see that
$$
c(\mathcal{E}^\bullet) = \prod\nolimits_i
c(\Ker(d_\mathcal{E}^i))^{(-1)^i} c(\Im(d_\mathcal{E}^i))^{(-1)^i}
$$
and similarly for $\mathcal{F}^\bullet$. Since we have the
short exact sequences
$$
0 \to \Im(d_\mathcal{E}^i) \to \Ker(d_\mathcal{E}^i) \to H^i(E) \to 0
\quad\text{and}\quad
0 \to \Im(d_\mathcal{F}^i) \to \Ker(d_\mathcal{F}^i) \to H^i(E) \to 0
$$
we reduce to the problem stated and solved in the next paragraph.

\medskip\noindent
Assume $X$ is integral and we have two short exact sequences
$$
0 \to \mathcal{E}' \to \mathcal{E} \to \mathcal{Q} \to 0
\quad\text{and}\quad
0 \to \mathcal{F}' \to \mathcal{F} \to \mathcal{Q} \to 0
$$
with $\mathcal{E}$, $\mathcal{E}'$, $\mathcal{F}$, $\mathcal{F}'$
finite locally free. Problem: show that
$c(\mathcal{E})c(\mathcal{E}')^{-1} \cap [X] =
c(\mathcal{F})c(\mathcal{F}')^{-1} \cap [X]$.
To do this, consider the short exact sequence
$$
0 \to \mathcal{G} \to \mathcal{E} \oplus \mathcal{F} \to \mathcal{Q} \to 0
$$
defining $\mathcal{G}$. Since $\mathcal{Q}$ has tor dimension $\leq 1$
we see that $\mathcal{G}$ is finite locally free. A diagram chase
shows that the kernel of the surjection $\mathcal{G} \to \mathcal{F}$
maps isomorphically to $\mathcal{E}'$ in $\mathcal{E}$ and
the kernel of the surjection $\mathcal{G} \to \mathcal{E}$ maps
isomorphically to $\mathcal{F}'$ in $\mathcal{F}$. (Working affine
locally this follows from or is equivalent to Schanuel's lemma, see
Algebra, Lemma \ref{algebra-lemma-Schanuel}.)
We conclude that
$$
c(\mathcal{E})c(\mathcal{F}') = c(\mathcal{G}) =
c(\mathcal{F})c(\mathcal{E}')
$$
as desired.
\end{proof}

\begin{definition}
\label{definition-defined-on-perfect}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let $E \in D(\mathcal{O}_X)$
be a perfect object. If $E$ is isomorphic in $D(\mathcal{O}_X)$
to a finite complex $\mathcal{E}^\bullet$ of finite locally free
$\mathcal{O}_X$-modules, then we say {\it chern classes of $E$ are defined}.
If this is the case, then we define $c(E) = c(\mathcal{E}^\bullet) \in A^*(X)$,
$ch(E) = ch(\mathcal{E}^\bullet) \in A^*(X) \otimes \mathbf{Q}$, and
$P_p(E) = P_p(\mathcal{E}^\bullet) \in A^p(X)$.
\end{definition}

\noindent
To be sure, by Lemma \ref{lemma-pre-derived-chern-class} this is well defined.
It follows from the material in Derived Categories of Schemes,
Lemmas \ref{perfect-lemma-resolution-property-ample},
\ref{perfect-lemma-regular-resolution-property}, and
\ref{perfect-lemma-construct-strictly-perfect}
that if $X$ has an ample invertible module or if
$X$ is quasi-compact, regular, with affine diagonal, then
$c(E)$, $ch(E)$, and $P_p(E)$ are always defined. (There is little doubt
that these bivariant classes can be defined on any $X$ as in the
definition without any assumption
on $E$ apart from being perfect, but in order to do this a different
approach needs to be used.)

\begin{lemma}
\label{lemma-commutative-chern-perfect}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $E \in D(\mathcal{O}_X)$ be perfect. If the chern classes
of $E$ are defined then
\begin{enumerate}
\item $c_p(E)$ is in the center of the algebra $A^*(X)$ and
\item if $f : X' \to X$ is locally of finite type and $c \in A^*(X' \to X)$,
then $c \circ c_j(E) = c_j(Lf^*E) \circ c$.
\end{enumerate}
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-cap-commutative-chern} and the
construction.
\end{proof}

\begin{lemma}
\label{lemma-additivity-on-perfect}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let
$$
E_1 \to E_2 \to E_3 \to E_1[1]
$$
be a distinguished triangle of perfect objects in $D(\mathcal{O}_X)$.
If $E_1 \to E_2$ can be represented be a map of bounded complexes
of finite locally free $\mathcal{O}_X$-modules, then we have
$c(E_2) = c(E_1) c(E_3)$, $ch(E_2) = ch(E_1) + ch(E_3)$, and
$P_p(E_2) = P_p(E_1) + P_p(E_3)$.
\end{lemma}

\begin{proof}
Let $\alpha^\bullet : \mathcal{E}_1^\bullet \to \mathcal{E}_2^\bullet$
be a map of bounded complexes of finite locally free $\mathcal{O}_X$-modules
representing $E_1 \to E_2$. Then the cone $C(\alpha)^\bullet$
represents $E_3$. Since
$C(\alpha)^n = \mathcal{E}_2^n \oplus \mathcal{E}_1^{n + 1}$
the formulas follow from the additivity and multiplicativity
of Lemmas \ref{lemma-chern-character-additive} and
\ref{lemma-additivity-chern-classes}.
\end{proof}

\begin{remark}
\label{remark-splitting-principle-perfect}
The chern classes of a perfect complex, when defined, satisfy a kind of
splitting principle. Namely, suppose that $(S, \delta), X, E$ are as in
Definition \ref{definition-defined-on-perfect}
such that the chern classes of $E$ are defined.
Say we want to prove a relation between the bivariant classes
$c_p(E)$, $P_p(E)$, and $ch_p(E)$. To do this, we may choose a bounded
complex $\mathcal{E}^\bullet$ of finite locally free $\mathcal{O}_X$-modules
representing $E$. Using the splitting principle
(Lemma \ref{lemma-splitting-principle}) we may assume each
$\mathcal{E}^i$ has a filtration whose successive
quotients $\mathcal{L}_{i, j}$ are invertible modules.
Settting $x_{i, j} = c_1(\mathcal{L}_{i, j})$ we see that
$$
c(E) =
\prod\nolimits_{i\text{ even}} (1 + x_{i, j})
\prod\nolimits_{i\text{ odd}} (1 + x_{i, j})^{-1}
$$
and
$$
P_p(E) =  \sum\nolimits_{i\text{ even}} (x_{i, j})^p -
\sum\nolimits_{i\text{ odd}} (x_{i, j})^p
$$
Formally taking the logarithm for the expression for $c(E)$ above
we find that
$$
\log(c(E)) = \sum (-1)^{p - 1}\frac{P_p(E)}{p}
$$
Looking at the construction of the polynomials $P_p$ in
Example \ref{example-power-sum} it follows that $P_p(E)$
is the exact same expression in the chern classes of $E$
as in the case of vector bundles, in other words, we have
\begin{align*}
P_1(E) & = c_1(E), \\
P_2(E) & = c_1(E)^2 - 2c_2(E), \\
P_3(E) & = c_1(E)^3 - 3c_1(E)c_2(E) + 3c_3(E), \\
P_4(E) & = c_1(E)^4 - 4c_1(E)^2c_2(E) + 4c_1(E)c_3(E) + 2c_2(E)^2 - 4c_4(E),
\end{align*}
and so on. On the other hand, the bivariant class $P_0(E) = r(E) = ch_0(E)$
cannot be recovered from the chern class $c(E)$ of $E$; the chern class
doesn't know about the rank of the complex.
\end{remark}

\begin{lemma}
\label{lemma-chern-classes-perfect-dual}
In Situation \ref{situation-setup} let $X$ be locally of finite type over $S$.
Let $E \in D(\mathcal{O}_X)$ be a perfect object whose chern classes are
defined. Then $c_i(E^\vee) = (-1)^i c_i(E)$, $P_i(E^\vee) = (-1)^iP_i(E)$,
and $ch_i(E^\vee) = (-1)^ich_i(E)$ in $A^i(X)$.
\end{lemma}

\begin{proof}
Immediate from the definition and Lemma \ref{lemma-chern-classes-dual}.
\end{proof}

\begin{lemma}
\label{lemma-chern-class-perfect-tensor-invertible}
In Situation \ref{situation-setup} let $X$ be locally of finite type over $S$.
Let $E$ be a perfect object of $D(\mathcal{O}_X)$ whose chern classes
are defined.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Then
$$
c_i(E \otimes \mathcal{L}) =
\sum\nolimits_{j = 0}^i
\binom{r - i + j}{j} c_{i - j}(E) c_1(\mathcal{L})^j
$$
provided $E$ has constant rank $r \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
In the case where $E$ is locally free of rank $r$ this is
Lemma \ref{lemma-chern-classes-E-tensor-L}. The reader can deduce
the lemma from this special case by a formal computation.
An alternative is to use the splitting principle of
Remark \ref{remark-splitting-principle-perfect}.
In this case one ends up having to prove the following
algebra fact: if we write formally
$$
\frac{\prod_{a = 1, \ldots, n} (1 + x_a)}{\prod_{n = 1, \ldots, m} (1 + y_b)}
= 1 + c_1 + c_2 + c_3 + \ldots
$$
with $c_i$ homogeneous of degree $i$
in $\mathbf{Z}[x_i, y_j]$ then we have
$$
\frac{\prod_{a = 1, \ldots, n} (1 + x_a + t)}{\prod_{b = 1, \ldots, m} (1 + y_b + t)}
= \sum\nolimits_{i \geq 0} \sum\nolimits_{j = 0}^i
\binom{r - i + j}{j} c_{i - j} t^j
$$
where $r = n - m$. We omit the details.
\end{proof}

\begin{lemma}
\label{lemma-chern-classes-perfect-tensor-product}
In Situation \ref{situation-setup} let $X$ be locally of finite type over $S$.
Let $E$ and $F$ be perfect objects of $D(\mathcal{O}_X)$ whose chern classes
are defined. Then we have
$$
c_1(E \otimes_{\mathcal{O}_X}^\mathbf{L} F) =
r(E) c_1(\mathcal{F}) + r(F) c_1(\mathcal{E})
$$
and for $c_2(E \otimes_{\mathcal{O}_X}^\mathbf{L} F)$ we have the expression
$$
r(E) c_2(F) + r(F) c_2(E) + {r(E) \choose 2} c_1(F)^2 +
(r(E)r(F) - 1) c_1(F)c_1(E) + {r(F) \choose 2} c_1(E)^2
$$
and so on for higher chern classes in $A^*(X)$. Similarly, we have
$ch(E \otimes_{\mathcal{O}_X}^\mathbf{L} F) = ch(E) ch(F)$
in $A^*(X) \otimes \mathbf{Q}$. More precisely, we have
$$
P_p(E \otimes_{\mathcal{O}_X}^\mathbf{L} F) = \sum\nolimits_{p_1 + p_2 = p}
{p \choose p_1} P_{p_1}(E) P_{p_2}(F)
$$
in $A^p(X)$.
\end{lemma}

\begin{proof}
After representing $E$ and $F$ by bounded complexes of finite locally
free $\mathcal{O}_X$-modules this follows by a compuation from the
corresponding result for vector bundles in
Lemmas \ref{lemma-chern-classes-tensor-product} and
\ref{lemma-chern-character-multiplicative} by a calculation.
A better proof is probably to use the splitting principle as in
Remark \ref{remark-splitting-principle-perfect}
and reduce the lemma to computations in polynomial rings 
which we describe in the next paragraph.

\medskip\noindent
Let $A$ be a commutative ring (for us this will be the subring of the
bivariant chow ring of $X$ generated by chern classes).
Let $S$ be a finite set together with maps $\epsilon : S \to \{\pm 1\}$
and $f : S \to A$. Define
$$
P_p(S, f , \epsilon) = \sum\nolimits_{s \in S} \epsilon(s) f(s)^p
$$
in $A$. Given a second triple $(S', \epsilon', f')$
the equality that has to be shown for $P_p$ is the equality
$$
P_p(S \times S', f + f' , \epsilon \epsilon') = 
\sum\nolimits_{p_1 + p_2 = p}
{p \choose p_1} P_{p_1}(S, f, \epsilon) P_{p_2}(S', f', \epsilon')
$$
To see this is true, one reduces to the polynomial ring on variables
$S \amalg S'$ and one shows that each term $f(s)^if'(s')^j$ occurs
on the left and right hand side with the same coefficient.
To verify the formulas for $c_1(E \otimes_{\mathcal{O}_X}^\mathbf{L} F)$
and $c_2(E \otimes_{\mathcal{O}_X}^\mathbf{L} F)$ we use the splitting
principle to reduce to checking these formulae in a torsion free ring.
Then we use the relationship between $P_j(E)$ and $c_i(E)$ proved
in Remark \ref{remark-splitting-principle-perfect}. For example
$$
c_1(E \otimes F) = P_1(E \otimes F) = r(F)P_1(E) + r(E)P_1(F) =
r(F)c_1(E) + r(E)c_1(F)
$$
the middle equation because $r(E) = P_0(E)$ by definition. Similarly, we have
\begin{align*}
& 2c_2(E \otimes F) \\
& = c_1(E \otimes F)^2 - P_2(E \otimes F) \\
& =
(r(F)c_1(E) + r(E)c_1(F))^2 -
r(F)P_2(E) - P_1(E)P_1(F) - r(E)P_2(F) \\
& =
(r(F)c_1(E) + r(E)c_1(F))^2 -
r(F)(c_1(E)^2 - 2c_2(E)) - c_1(E)c_1(F) - \\
& \quad r(E)(c_1(F)^2 - 2c_2(F))
\end{align*}
which the reader can verify agrees with the formula in the statement
of the lemma up to a factor of $2$.
\end{proof}







\section{A baby case of localized chern classes}
\label{section-preparation-localized-chern}

\noindent
In this section we discuss some properties of the bivariant classes
constructed in the following lemma; most of these properties follow
immediately from the characterization given in the lemma. We urge the
reader to skip the rest of the section.

\begin{lemma}
\label{lemma-silly}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. Let $i_j : X_j \to X$, $j = 1, 2$
be closed immersions such that $X = X_1 \cup X_2$ set theoretically. Let
$E_2 \in D(\mathcal{O}_{X_2})$ be a perfect object. Assume
\begin{enumerate}
\item chern classes of $E_2$ are defined,
\item the restriction $E_2|_{X_1 \cap X_2}$ is zero,
resp.\ isomorphic to a finite locally free $\mathcal{O}_{X_1 \cap X_2}$-module
of rank $< p$ sitting in cohomological degree $0$.
\end{enumerate}
Then there is a canonical bivariant class
$$
P'_p(E_2),\text{ resp. }c'_p(E_2) \in A^p(X_2 \to X)
$$
characterized by the property
$$
P'_p(E_2) \cap i_{2, *} \alpha_2 = P_p(E_2) \cap \alpha_2
\quad\text{and}\quad
P'_p(E_2) \cap i_{1, *} \alpha_1 = 0,
$$
respectively
$$
c'_p(E_2) \cap i_{2, *} \alpha_2 = c_p(E_2) \cap \alpha_2
\quad\text{and}\quad
c'_p(E_2) \cap i_{1, *} \alpha_1 = 0
$$
for $\alpha_i \in \CH_k(X_i)$ and similarly after any base change
$X' \to X$ locally of finite type.
\end{lemma}

\begin{proof}
We are going to use the material of Section \ref{section-pre-derived}
without further mention.

\medskip\noindent
Assume $E_2|_{X_1 \cap X_2}$ is zero.
Consider a morphism of schemes $X' \to X$
which is locally of finite type and denote $i'_j : X'_j \to X'$ the
base change of $i_j$. By Lemma \ref{lemma-exact-sequence-closed-chow}
we can write any element $\alpha' \in \CH_k(X')$ as
$i'_{1, *}\alpha'_1 + i'_{2, *}\alpha'_2$ where
$\alpha'_2 \in \CH_k(X'_2)$
is well defined up to an element in the image of pushforward
by $X'_1 \cap X'_2 \to X'_2$. Then we can set
$P'_p(E_2) \cap \alpha' = P_p(E_2) \cap \alpha'_2 \in \CH_{k - p}(X'_2)$. This
is well defined by our assumption that $E_2$ restricts
to zero on $X_1 \cap X_2$.

\medskip\noindent
If $E_2|_{X_1 \cap X_2}$ is isomorphic to a finite locally free
$\mathcal{O}_{X_1 \cap X_2}$-module of rank $< p$ sitting in
cohomological degree $0$, then $c_p(E_2|_{X_1 \cap X_2}) = 0$
by rank considerations and we can argue in exactly the same manner.
\end{proof}

\begin{lemma}
\label{lemma-silly-independent}
In Lemma \ref{lemma-silly} the bivariant class
$P'_p(E_2)$, resp.\ $c'_p(E_2)$ in $A^p(X_2 \to X)$
does not depend on the choice of $X_1$.
\end{lemma}

\begin{proof}
Suppose that $X_1' \subset X$ is another closed subscheme such that
$X = X'_1 \cup X_2$ set theoretically and the restriction
$E_2|_{X'_1 \cap X_2}$ is zero, resp.\ isomorphic to a
finite locally free $\mathcal{O}_{X'_1 \cap X_2}$-module
of rank $< p$ sitting in cohomological degree $0$.
Then $X = (X_1 \cap X'_1) \cup X_2$. Hence we can write
any element $\alpha \in \CH_k(X)$ as $i_*\beta + i_{2, *}\alpha_2$ with
$\alpha_2 \in \CH_k(X'_2)$ and $\beta \in \CH_k(X_1 \cap X'_1)$.
Thus it is clear that
$P'_p(E_2) \cap \alpha = P_p(E_2) \cap \alpha_2 \in \CH_{k - p}(X_2)$,
resp.\  $c'_p(E_2) \cap \alpha = c_p(E_2) \cap \alpha_2 \in \CH_{k - p}(X_2)$,
is independent of whether we use $X_1$ or $X'_1$. Similarly
after any base change.
\end{proof}

\begin{lemma}
\label{lemma-silly-silly}
In Lemma \ref{lemma-silly} say $E_2$ is the restriction of a
perfect $E \in D(\mathcal{O}_X)$ such that $E|_{X_1}$ is zero,
resp.\ isomorphic to a finite locally free $\mathcal{O}_{X_1}$-module
of rank $< p$ sitting in cohomological degree $0$.
If chern classes of $E$ are defined, then
$i_{2, *} \circ P'_p(E_2) = P_p(E)$,
resp.\ $i_{2, *} \circ c'_p(E_2) = c_p(E)$
(with $\circ$ as in Lemma \ref{lemma-push-proper-bivariant}).
\end{lemma}

\begin{proof}
First, assume $E|_{X_1}$ is zero.
With notations as in the proof of Lemma \ref{lemma-silly}
the lemma in this case follows from
\begin{align*}
P_p(E) \cap \alpha'
& =
i'_{1, *}(P_p(E) \cap \alpha'_1) +
i'_{2, *}(P_p(E) \cap \alpha'_2) \\
& =
i'_{1, *}(P_p(E|_{X_1}) \cap \alpha'_1) +
i'_{2, *}(P'_p(E_2) \cap \alpha') \\
& =
i'_{2, *}(P'_p(E_2) \cap \alpha')
\end{align*}
The case where $E|_{X_1}$ is isomorphic to a finite locally free
$\mathcal{O}_{X_1}$-module of rank $< p$ sitting in cohomological degree $0$
is similar.
\end{proof}

\begin{lemma}
\label{lemma-silly-shrink}
In Lemma \ref{lemma-silly} suppose we have closed subschemes
$X'_2 \subset X_2$ and $X_1 \subset X'_1 \subset X$ such that
$X = X'_1 \cup X'_2$ set theoretically. Assume $E_2|_{X'_1 \cap X_2}$
is zero, resp.\ isomorphic to a finite locally free module
of rank $< p$ placed in degree $0$. Then we have
$(X'_2 \to X_2)_* \circ P'_p(E_2|_{X'_2}) = P'_p(E_2)$,
resp.\  $(X'_2 \to X_2)_* \circ c'_p(E_2|_{X'_2}) = c_p(E_2)$
(with $\circ$ as in Lemma \ref{lemma-push-proper-bivariant}).
\end{lemma}

\begin{proof}
This follows immediately from the characterization of these classes
in Lemma \ref{lemma-silly}.
\end{proof}

\begin{lemma}
\label{lemma-silly-commutes}
In Lemma \ref{lemma-silly} let $f : Y \to X$ be locally of finite type
and say $c \in A^*(Y \to X)$. Then
$$
c \circ P'_p(E_2) = P'_p(Lf_2^*E_2) \circ c
\quad\text{resp.}\quad
c \circ c'_p(E_2) = c'_p(Lf_2^*E_2) \circ c
$$
in $A^*(Y_2 \to Y)$ where $f_2 : Y_2 \to X_2$ is the base change of $f$.
\end{lemma}

\begin{proof}
Let $\alpha \in \CH_k(X)$. We may write
$$
\alpha = \alpha_1 + \alpha_2
$$
with $\alpha_i \in \CH_k(X_i)$; we are omitting the pushforwards
by the closed immersions $X_i \to X$. The reader then checks that
$c'_p(E_2) \cap \alpha = c_p(E_2) \cap \alpha_2$,
$c \cap c'_p(E_2) \cap \alpha = c \cap c_p(E_2) \cap \alpha_2$,
$c \cap \alpha = c \cap \alpha_1 + c \cap \alpha_2$, and
$c'_p(Lf_2^*E_2) \cap c \cap \alpha = c_p(Lf_2^*E_2) \cap c \cap \alpha_2$.
We conclude by Lemma \ref{lemma-commutative-chern-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-silly-compose}
In Lemma \ref{lemma-silly} assume $E_2|_{X_1 \cap X_2}$ is zero. Then
\begin{align*}
P'_1(E_2) & = c'_1(E_2), \\
P'_2(E_2) & = c'_1(E_2)^2 - 2c'_2(E_2), \\
P'_3(E_2) & = c'_1(E_2)^3 - 3c'_1(E_2)c'_2(E_2) + 3c'_3(E_2), \\
P'_4(E_2) & = c'_1(E_2)^4 - 4c'_1(E_2)^2c'_2(E_2) +
4c'_1(E_2)c'_3(E_2) + 2c'_2(E_2)^2 - 4c'_4(E_2),
\end{align*}
and so on with multiplication as in Remark \ref{remark-ring-loc-classes}.
\end{lemma}

\begin{proof}
The statement makes sense because the zero sheaf has rank $< 1$ and
hence the classes $c'_p(E_2)$ are defined for all $p \geq 1$. The equalities
follow immediately from the characterization of the classes produced
by Lemma \ref{lemma-silly} and the corresponding result for
capping with the chern classes of $E_2$ given in
Remark \ref{remark-splitting-principle-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-silly-sum-c}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. Let $i_j : X_j \to X$, $j = 1, 2$
be closed immersions such that $X = X_1 \cup X_2$ set theoretically. Let
$E, F \in D(\mathcal{O}_X)$ be perfect objects. Assume
\begin{enumerate}
\item chern classes of $E$ and $F$ are defined,
\item the restrictions $E|_{X_1 \cap X_2}$ and $F|_{X_1 \cap X_2}$
are isomorphic to a finite locally free $\mathcal{O}_{X_1}$-modules
of rank $< p$ and $< q$ sitting in cohomological degree $0$.
\end{enumerate}
With notation as in Remark \ref{remark-ring-loc-classes} set
$$
c^{(p)}(E) = 1 + c_1(E) + \ldots + c_{p - 1}(E) +
c'_p(E|_{X_2}) + c'_{p + 1}(E|_{X_2}) + \ldots \in A^{(p)}(X_2 \to X)
$$
with $c'_p(E|_{X_2})$ as in Lemma \ref{lemma-silly}. Similarly
for $c^{(q)}(F)$ and $c^{(p + q)}(E \oplus F)$.
Then $c^{(p + q)}(E \oplus F) = c^{(p)}(E)c^{(q)}(F)$
in $A^{(p + q)}(X_2 \to X)$.
\end{lemma}

\begin{proof}
Immediate from the characterization of the classes in
Lemma \ref{lemma-silly} and the additivity in
Lemma \ref{lemma-additivity-on-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-silly-sum-P}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. Let $i_j : X_j \to X$, $j = 1, 2$
be closed immersions such that $X = X_1 \cup X_2$ set theoretically. Let
$E, F \in D(\mathcal{O}_{X_2})$ be perfect objects. Assume
\begin{enumerate}
\item chern classes of $E$ and $F$ are defined,
\item the restrictions $E|_{X_1 \cap X_2}$ and $F|_{X_1 \cap X_2}$ are zero,
\end{enumerate}
Denote $P'_p(E), P'_p(F), P'_p(E \oplus F) \in A^p(X_2 \to X)$ for $p \geq 0$
the classes constructed in Lemma \ref{lemma-silly}. Then
$P'_p(E \oplus F) = P'_p(E) + P'_p(F)$.
\end{lemma}

\begin{proof}
Immediate from the characterization of the classes in
Lemma \ref{lemma-silly} and the additivity in
Lemma \ref{lemma-additivity-on-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-silly-tensor-invertible}
In Lemma \ref{lemma-silly} assume $E_2$ has constant rank $0$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Then
$$
c'_i(E_2 \otimes \mathcal{L}) =
\sum\nolimits_{j = 0}^i
\binom{- i + j}{j} c'_{i - j}(E_2) c_1(\mathcal{L})^j
$$
\end{lemma}

\begin{proof}
The assumption on rank implies that $E_2|_{X_1 \cap X_2}$ is zero.
Hence $c'_i(E_2)$ is defined for all $i \geq 1$ and the statement
makes sense. The actual equality follows
immediately from Lemma \ref{lemma-chern-class-perfect-tensor-invertible}
and the characterization of $c'_i$ in Lemma \ref{lemma-silly}.
\end{proof}

\begin{lemma}
\label{lemma-silly-tensor-product}
In Situation \ref{situation-setup} let $X$ be locally of finite type over $S$.
Let
$$
X = X_1 \cup X_2 = X'_1 \cup X'_2
$$
be two ways of writing $X$ as a set theoretic union of closed subschemes.
Let $E$, $E'$ be perfect objects of $D(\mathcal{O}_X)$
whose chern classes are defined.
Assume that $E|_{X_1}$ and $E'|_{X'_1}$ are zero\footnote{Presumably there
is a variant of this lemma where we only assume these restrictions are
isomorphic to a finite locally free modules
of rank $< p$ and $< p'$.} for $i = 1, 2$. Denote
\begin{enumerate}
\item $r = P'_0(E) \in A^0(X_2 \to X)$ and
$r' = P'_0(E') \in A^0(X'_2 \to X)$,
\item $\gamma_p = c'_p(E|_{X_2}) \in A^p(X_2 \to X)$ and
$\gamma'_p = c'_p(E'|_{X'_2}) \in A^p(X'_2 \to X)$,
\item $\chi_p = P'_p(E|_{X_2}) \in A^p(X_2 \to X)$ and
$\chi'_p = P'_p(E'|_{X'_2}) \in A^p(X'_2 \to X)$
\end{enumerate}
the classes constructed in Lemma \ref{lemma-silly}. Then we have
$$
c'_1((E \otimes_{\mathcal{O}_X}^\mathbf{L} E')|_{X_2 \cap X'_2}) =
r \gamma'_1 + r' \gamma_1
$$
in $A^1(X_2 \cap X'_2 \to X)$ and
$$
c'_2((E \otimes_{\mathcal{O}_X}^\mathbf{L} E')|_{X_2 \cap X'_2}) =
r \gamma'_2 + r' \gamma_2 + {r \choose 2} (\gamma'_1)^2 +
(rr' - 1) \gamma'_1\gamma_1 + {r' \choose 2} \gamma_1^2
$$
in $A^2(X_2 \cap X'_2 \to X)$ and so on for higher chern classes.
Similarly, we have
$$
P'_p((E \otimes_{\mathcal{O}_X}^\mathbf{L} E')|_{X_2 \cap X'_2}) =
\sum\nolimits_{p_1 + p_2 = p}
{p \choose p_1} \chi_{p_1} \chi'_{p_2}
$$
in $A^p(X_2 \cap X'_2 \to X)$.
\end{lemma}

\begin{proof}
First we observe that the statement makes sense. Namely, we have
$X = (X_2 \cap X'_2) \cup Y$ where
$Y = (X_1 \cap X'_1) \cup (X_1 \cap X'_2) \cup (X_2 \cap X'_1)$
and the object $E \otimes_{\mathcal{O}_X}^\mathbf{L} E'$
restricts to zero on $Y$.
The actual equalities follow from the characterization
of our classes in Lemma \ref{lemma-silly}
and the equalities of Lemma \ref{lemma-chern-classes-perfect-tensor-product}.
We omit the details.
\end{proof}







\section{Gysin at infinity}
\label{section-gysin-at-infty}

\noindent
This section is about the bivariant class constructed in the next
lemma. We urge the reader to skip the rest of the section.

\begin{lemma}
\label{lemma-gysin-at-infty}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let
$b : W \to \mathbf{P}^1_X$ be a proper morphism of schemes
which is an isomorphism over $\mathbf{A}^1_X$.
Denote $i_\infty : W_\infty \to W$ the inverse image of the divisor
$D_\infty \subset \mathbf{P}^1_X$ with complement $\mathbf{A}^1_X$.
Then there is a canonical bivariant class
$$
C \in A^0(W_\infty \to X)
$$
with the property that
$i_{\infty, *}(C \cap \alpha) = i_{0, *}\alpha$
for $\alpha \in \CH_k(X)$ and similarly after any base change by
$X' \to X$ locally of finite type.
\end{lemma}

\begin{proof}
Given $\alpha \in \CH_k(X)$ there exists a $\beta \in \CH_{k + 1}(W)$
restricting to the flat pullback of $\alpha$ on $b^{-1}(\mathbf{A}^1_X)$, see
Lemma \ref{lemma-exact-sequence-open}.
A second choice of $\beta$ differs from $\beta$ by a cycle
supported on $W_\infty$, see
Lemma \ref{lemma-restrict-to-open}. Since the normal bundle of the effective
Cartier divisor $D_\infty \subset \mathbf{P}^1_X$ of
(\ref{equation-zero-infty}) is trivial,
the gysin homomorphism $i_\infty^*$ kills cycle classes
supported on $W_\infty$, see Remark \ref{remark-gysin-on-cycles}.
Hence setting $C \cap \alpha = i_\infty^*\beta$ is well defined.

\medskip\noindent
Since $W_\infty$ and $W_0 = X \times \{0\}$
are the pullbacks of the rationally equivalent effective Cartier divisors
$D_0, D_\infty$ in $\mathbf{P}^1_X$, we see that $i_\infty^*\beta$ and
$i_0^*\beta$ map to the same cycle class on $W$; namely, both
represent the class $c_1(\mathcal{O}_{\mathbf{P}^1_X}(1)) \cap \beta$ by
Lemma \ref{lemma-support-cap-effective-Cartier}. By our choice of
$\beta$ we have $i_0^*\beta = \alpha$ as cycles on
$W_0 = X \times \{0\}$, see for example
Lemma \ref{lemma-relative-effective-cartier}.
Thus we see that $i_{\infty, *}(C \cap \alpha) = i_{0, *}\alpha$
as stated in the lemma.

\medskip\noindent
Observe that the assumptions on $b$ are preserved by any base change
by $X' \to X$ locally of finite type. Hence we get an operation
$C \cap - : \CH_k(X') \to \CH_k(W'_\infty)$ by the same construction as above.
To see that this family of operations defines a bivariant class,
we consider the diagram
$$
\xymatrix{
& & & \CH_*(X) \ar[d]^{\text{flat pullback}} \\
\CH_{* + 1}(W_\infty) \ar[r] \ar[rd]^0 &
\CH_{* + 1}(W) \ar[d]^{i_\infty^*} \ar[rr]^{\text{flat pullback}} & &
\CH_{* + 1}(\mathbf{A}^1_X) \ar[r] \ar@{..>}[lld]^{C \cap -} &
0 \\
& \CH_*(W_\infty)
}
$$
for $X$ as indicated and the base change of this diagram for any $X' \to X$.
We know that flat pullback and $i_\infty^*$ are bivariant operations, see
Lemmas \ref{lemma-flat-pullback-bivariant} and \ref{lemma-gysin-bivariant}.
Then a formal argument (involving huge diagrams of schemes and their
chow groups) shows that the dotted arrow is a bivariant operation.
\end{proof}

\begin{lemma}
\label{lemma-gysin-at-infty-independent}
In Lemma \ref{lemma-gysin-at-infty} let $g : W' \to W$ be a proper morphism
which is an isomorphism over $\mathbf{A}^1_X$. Let
$C' \in A^0(W'_\infty \to X)$ and $C \in A^0(W_\infty \to X)$
be the classes constructed in Lemma \ref{lemma-gysin-at-infty}.
Then $g_{\infty, *} \circ C' = C$ in $A^0(W_\infty \to X)$.
\end{lemma}

\begin{proof}
Set $b' = b \circ g : W' \to \mathbf{P}^1_X$. Denote
$i'_\infty : W'_\infty \to W'$ the inclusion morphism.
Denote $g_\infty : W'_\infty \to W_\infty$ the restriction of $g$.
Given $\alpha \in \CH_k(X)$ choose $\beta' \in \CH_{k + 1}(W')$
restricting to the flat pullback of $\alpha$ on $(b')^{-1}\mathbf{A}^1_X$.
Then $\beta = g_*\beta' \in \CH_{k + 1}(W)$ restricts to the
flat pullback of $\alpha$ on $b^{-1}\mathbf{A}^1_X$.
Then $i_\infty^*\beta = g_{\infty, *}(i'_\infty)^*\beta'$
by Lemma \ref{lemma-closed-in-X-gysin}.
This and the corresponding fact after base change by
morphisms $X' \to X$ locally of finite type, corresponds
to the assertion made in the lemma.
\end{proof}

\begin{lemma}
\label{lemma-homomorphism-pre}
In Lemma \ref{lemma-gysin-at-infty} we have
$C \circ (W_\infty \to X)_* \circ i_\infty^* = i_\infty^*$.
\end{lemma}

\begin{proof}
Let $\beta \in \CH_{k + 1}(W)$. Denote $i_0 : X = X \times \{0\} \to W$
the closed immersion of the fibre over $0$ in $\mathbf{P}^1$. Then
$(W_\infty \to X)_* i_\infty^* \beta = i_0^*\beta$ in $\CH_k(X)$ because
$i_{\infty, *}i_\infty^*\beta$ and $i_{0, *}i_0^*\beta$
represent the same class on $W$ (for example by
Lemma \ref{lemma-support-cap-effective-Cartier})
and hence pushforward to the same class on $X$.
The restriction of $\beta$ to $b^{-1}(\mathbf{A}^1_X)$
restricts to the flat pullback of
$i_0^*\beta = (W_\infty \to X)_* i_\infty^* \beta$ because we can check
this after pullback by $i_0$, see
Lemmas \ref{lemma-linebundle} and \ref{lemma-linebundle-formulae}.
Hence we may use $\beta$ when computing the image of
$(W_\infty \to X)_*i_\infty^*\beta$ under $C$
and we get the desired result.
\end{proof}

\begin{lemma}
\label{lemma-gysin-at-infty-commutes}
In Lemma \ref{lemma-gysin-at-infty} let $f : Y \to X$ be a morphism
locally of finite type and $c \in A^*(Y \to X)$. Then $C \circ c = c \circ C$
in $A^*(W_\infty \times_X Y)$.
\end{lemma}

\begin{proof}
Consider the commutative diagram
$$
\xymatrix{
W_\infty \times_X Y \ar@{=}[r] &
W_{Y, \infty} \ar[r]_{i_{Y, \infty}} \ar[d] &
W_Y \ar[r]_{b_Y} \ar[d] &
\mathbf{P}^1_Y \ar[r]_{p_Y} \ar[d] &
Y \ar[d]^f \\
& W_\infty \ar[r]^{i_\infty} &
W \ar[r]^b &
\mathbf{P}^1_X \ar[r]^p &
X
}
$$
with cartesian squares. For an elemnent $\alpha \in \CH_k(X)$
choose $\beta \in \CH_{k + 1}(W)$ whose restriction to $b^{-1}(\mathbf{A}^1_X)$
is the flat pullback of $\alpha$. Then $c \cap \beta$ is a class
in $\CH_*(W_Y)$ whose restriction to $b_Y^{-1}(\mathbf{A}^1_Y)$
is the flat pullback of $c \cap \alpha$. Next, we have
$$
i_{Y, \infty}^*(c \cap \beta) = c \cap i_\infty^*\beta
$$
because $c$ is a bivariant class. This exactly says that
$C \cap c \cap \alpha = c \cap C \cap \alpha$. The same argument
works after any base change by $X' \to X$ locally of finite type.
This proves the lemma.
\end{proof}





\section{Preparation for localized chern classes}
\label{section-preparation-localized-chern-II}

\noindent
In this section we discuss some properties of the bivariant classes
constructed in the following lemma. We urge the
reader to skip the rest of the section.

\begin{lemma}
\label{lemma-localized-chern-pre}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. Let $Z \subset X$ be a closed subscheme.
Let
$$
b : W \longrightarrow \mathbf{P}^1_X
$$
be a proper morphism of schemes. Let $Q \in D(\mathcal{O}_W)$ be a
perfect object. Denote $W_\infty \subset W$ the inverse image of the divisor
$D_\infty \subset \mathbf{P}^1_X$ with complement $\mathbf{A}^1_X$.
We assume
\begin{enumerate}
\item[(A0)] chern classes of $Q$ are defined
(Section \ref{section-pre-derived}),
\item[(A1)] $b$ is an isomorphism over $\mathbf{A}^1_X$,
\item[(A2)] there exists a closed subscheme $T \subset W_\infty$
containing all points of $W_\infty$ lying over $X \setminus Z$ such that
$Q|_T$ is zero, resp.\ isomorphic to a finite locally free
$\mathcal{O}_T$-module of rank $< p$ sitting in cohomological degree $0$.
\end{enumerate}
Then there exists a canonical bivariant class
$$
P'_p(Q),\text{ resp. }c'_p(Q) \in A^p(Z \to X)
$$
with
$(Z \to X)_* \circ P'_p(Q) = P_p(Q|_{X \times \{0\}})$,
resp.\ $(Z \to X)_* \circ c'_p(Q) = c_p(Q|_{X \times \{0\}})$.
\end{lemma}

\begin{proof}
Denote $E \subset W_\infty$ the inverse image of $Z$. Then
$W_\infty = T \cup E$ and $b$ induces a proper morphism $E \to Z$.
Denote $C \in A^0(W_\infty \to X)$ the bivariant class constructed
in Lemma \ref{lemma-gysin-at-infty}. Denote $P'_p(Q|_E)$, resp.\ $c'_p(Q|_E)$
in $A^p(E \to W_\infty)$ the bivariant class constructed
in Lemma \ref{lemma-silly}. This makes sense because
$(Q|_E)|_{T \cap E}$ is zero, resp.\ isomorphic to a finite locally free
$\mathcal{O}_{E \cap T}$-module of rank $< p$ sitting in
cohomological degree $0$ by assumption (A2). Then we define
$$
P'_p(Q) = (E \to Z)_* \circ P'_p(Q|_E) \circ C,\text{ resp. }
c'_p(Q) = (E \to Z)_* \circ c'_p(Q|_E) \circ C
$$
This is a bivariant class, see Lemma \ref{lemma-push-proper-bivariant}.
Since $E \to Z \to X$ is equal to $E \to W_\infty \to W \to X$ we see that
\begin{align*}
(Z \to X)_* \circ c'_p(Q)
& =
(W \to X)_* \circ i_{\infty, *} \circ (E \to W_\infty)_*
\circ c'_p(Q|_E) \circ C \\
& =
(W \to X)_* \circ i_{\infty, *} \circ c_p(Q|_{W_\infty}) \circ C \\
& =
(W \to X)_* \circ c_p(Q) \circ i_{\infty, *} \circ C \\
& =
(W \to X)_*\circ c_p(Q) \circ i_{0, *} \\
& =
(W \to X)_* \circ i_{0, *} \circ c_p(Q|_{X \times \{0\}}) \\
& =
c_p(Q|_{X \times \{0\}})
\end{align*}
The second equality holds by Lemma \ref{lemma-silly-silly}.
The third equality because $c_p(Q)$ is a bivariant class.
The fourth equality by Lemma \ref{lemma-gysin-at-infty}.
The fifth equality because $c_p(Q)$ is a bivariant class.
The final equality because $(W_0 \to W) \circ (W \to X)$
is the identity on $X$ if we identify $W_0$ with $X$ as we've
done above. The exact same sequence of equations works to
prove the property for $P'_p(Q)$.
\end{proof}

\begin{lemma}
\label{lemma-localized-chern-pre-independent}
In Lemma \ref{lemma-localized-chern-pre} the bivariant class
$P'_p(Q)$, resp.\ $c'_p(Q)$
is independent of the choice of the closed subscheme $T$.
Moreover, given a proper morphism $g : W' \to W$ which is an
isomorphism over $\mathbf{A}^1_X$, then setting $Q' = g^*Q$
we have $P'_p(Q) = P'_p(Q')$, resp.\ $c'_p(Q) = c'_p(Q')$.
\end{lemma}

\begin{proof}
The independence of $T$ follows immediately from
Lemma \ref{lemma-silly-independent}.

\medskip\noindent
Let $g : W' \to W$ be a proper morphism which is an isomorphism over
$\mathbf{A}^1_X$. Observe that taking $T' = g^{-1}(T) \subset W'_\infty$
is a closed subscheme satisfying (A2) hence the operator
$P'_p(Q')$, resp.\ $c'_p(Q')$ in $A^p(Z \to X)$
corresponding to $b' = b \circ g : W' \to \mathbf{P}^1_X$
and $Q'$ is defined. Denote $E' \subset W'_\infty$
the inverse image of $Z$ in $W'_\infty$. Recall that
$$
c'_p(Q') = (E' \to Z)_* \circ c'_p(Q'|_{E'}) \circ C'
$$
with $C' \in A^0(W'_\infty \to X)$ and
$c'_p(Q'|_{E'}) \in A^p(E' \to W'_\infty)$.
By Lemma \ref{lemma-gysin-at-infty-independent} we have
$g_{\infty, *} \circ C' = C$. Observe that $E'$ is also
the inverse image of $E$ in $W'_\infty$ by $g_\infty$.
Since moreover $Q' = g^*Q$ we find that $c'_p(Q'|_{E'})$ is simply the
restriction of $c'_p(Q|_E)$ to schemes lying over $W'_\infty$, see
Remark \ref{remark-restriction-bivariant}. Thus we obtain
\begin{align*}
c'_p(Q')
& = 
(E' \to Z)_* \circ c'_p(Q'|_{E'}) \circ C' \\
& =
(E \to Z)_* \circ (E' \to E)_* \circ c'_p(Q|_E) \circ C' \\
& =
(E \to Z)_* \circ c'_p(Q|_E) \circ g_{\infty, *} \circ C' \\
& =
(E \to Z)_* \circ c'_p(Q|_E) \circ C \\
& =
c'_p(Q)
\end{align*}
In the third equality we used that $c'_p(Q|_E)$
commutes with proper pushforward as it is a
bivariant class. The equality $P'_p(Q) = P'_p(Q')$
is proved in exactly the same way.
\end{proof}

\begin{lemma}
\label{lemma-homomorphism}
In Lemma \ref{lemma-localized-chern-pre} assume $Q|_T$ is isomorphic
to a finite locally free $\mathcal{O}_T$-module of rank $< p$.
Denote $C \in A^0(W_\infty \to X)$ the class of
Lemma \ref{lemma-gysin-at-infty}. Then
$$
C \circ c_p(Q|_{X \times \{0\}}) =
C \circ (Z \to X)_* \circ c'_p(Q) = c_p(Q|_{W_\infty}) \circ C
$$
\end{lemma}

\begin{proof}
The first equality holds because $c_p(Q|_{X \times \{0\}}) =
(Z \to X)_* \circ c'_p(Q)$ by Lemma \ref{lemma-localized-chern-pre}.
We may prove the second equality one cycle class at a time
(see Lemma \ref{lemma-bivariant-zero}). Since the construction of
the bivariant classes in the lemma is compatible with base change,
we may assume we have some $\alpha \in \CH_k(X)$ and we have to show that
$C \cap (Z \to X)_*(c'_p(Q) \cap \alpha) =
c_p(Q|_{W_\infty}) \cap C \cap \alpha$. Observe that
\begin{align*}
C \cap (Z \to X)_*(c'_p(Q) \cap \alpha)
& =
C \cap (Z \to X)_* (E \to Z)_*(c'_p(Q|_E) \cap C \cap \alpha) \\
& =
C \cap (W_\infty \to X)_*(E \to W_\infty)_*(c'_p(Q|_E) \cap C \cap \alpha) \\
& =
C \cap (W_\infty \to X)_*(E \to W_\infty)_*(c'_p(Q|_E) \cap i_\infty^*\beta) \\
& =
C \cap (W_\infty \to X)_*(c_p(Q|_{W_\infty}) \cap i_\infty^*\beta) \\
& =
C \cap (W_\infty \to X)_*i_\infty^*(c_p(Q) \cap \beta) \\
& =
i_\infty^*(c_p(Q) \cap \beta) \\
& =
c_p(Q|_{W_\infty}) \cap i_\infty^*\beta \\
& =
c_p(Q|_{W_\infty}) \cap C \cap \alpha
\end{align*}
as desired. For the first equality we used that
$c'_p(Q) = (E \to Z)_* \circ c'_p(Q|_E) \circ C$ where $E \subset W_\infty$
is the inverse image of $Z$ and $c'_p(Q|_E)$ is the class constructed
in Lemma \ref{lemma-silly}. The second equality is just the statement
that $E \to Z \to X$ is equal to $E \to W_\infty \to X$.
For the third equality we choose $\beta \in \CH_{k + 1}(W)$ whose restriction to
$b^{-1}(\mathbf{A}^1_X)$ is the flat pullback of $\alpha$ so that
$C \cap \alpha = i_\infty^*\beta$ by construction. The fourth equality is
Lemma \ref{lemma-silly-silly}. The fifth equality is the fact that
$c_p(Q)$ is a bivariant class and hence commutes with $i_\infty^*$.
The sixth equality is Lemma \ref{lemma-homomorphism-pre}.
The seventh uses again that $c_p(Q)$ is a bivariant class.
The final holds as $C \cap \alpha = i_\infty^*\beta$.
\end{proof}

\begin{lemma}
\label{lemma-homomorphism-commute}
In Lemma \ref{lemma-localized-chern-pre} let $Y \to X$ be a morphism
locally of finite type and let $c \in A^*(Y \to X)$ be a bivariant class.
Then
$$
P'_p(Q) \circ c = c \circ P'_p(Q)
\quad\text{resp.}\quad
c'_p(Q) \circ c = c \circ c'_p(Q)
$$
in $A^*(Y \times_X Z \to X)$.
\end{lemma}

\begin{proof}
Let $E \subset W_\infty$ be the inverse image of $Z$.
Recall that $P'_p(Q) = (E \to Z)_* \circ P'_p(Q|_E) \circ C$,
resp.\ $c'_p(Q) = (E \to Z)_* \circ c'_p(Q|_E) \circ C$
where $C$ is as in Lemma \ref{lemma-gysin-at-infty} and
$P'_p(Q|_E)$, resp.\ $c'_p(Q|_E)$ are as in
Lemma \ref{lemma-silly}.
By Lemma \ref{lemma-gysin-at-infty-commutes}
we see that $C$ commutes with $c$
and by Lemma \ref{lemma-silly-commutes} we see that
$P'_p(Q|_E)$, resp.\ $c'_p(Q|_E)$ commutes with $c$.
Since $c$ is a bivariant class it commutes with proper
pushforward by $E \to Z$ by definition. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-localized-chern-pre-compose}
In Lemma \ref{lemma-localized-chern-pre} assume $Q|_T$ is zero. In
$A^*(Z \to X)$ we have
\begin{align*}
P'_1(Q) & = c'_1(Q), \\
P'_2(Q) & = c'_1(Q)^2 - 2c'_2(Q), \\
P'_3(Q) & = c'_1(Q)^3 - 3c'_1(Q)c'_2(Q) + 3c'_3(Q), \\
P'_4(Q) & = c'_1(Q)^4 - 4c'_1(Q)^2c'_2(Q) +
4c'_1(Q)c'_3(Q) + 2c'_2(Q)^2 - 4c'_4(Q),
\end{align*}
and so on with multiplication as in Remark \ref{remark-ring-loc-classes}.
\end{lemma}

\begin{proof}
The statement makes sense because the zero sheaf has rank $< 1$ and
hence the classes $c'_p(Q)$ are defined for all $p \geq 1$.
In the proof of Lemma \ref{lemma-localized-chern-pre} we have constructed
the classes $P'_p(Q)$ and $c'_p(Q)$ using the bivariant class
$C \in A^0(W_\infty \to X)$ of Lemma \ref{lemma-gysin-at-infty}
and the bivariant classes
$P'_p(Q|_E)$ and $c'_p(Q|_E)$ of Lemma \ref{lemma-silly} for the restriction
$Q|_E$ of $Q$ to the inverse image $E$ of $Z$ in $W_\infty$.
Observe that by Lemma \ref{lemma-silly-compose} we have the desired
relationship between $P'_p(Q|_E)$ and $c'_p(Q|_E)$. Recall that
$$
P'_p(Q) = (E \to Z)_* \circ P'_p(Q|_E) \circ C
\quad\text{and}\quad
c'_p(Q) = (E \to Z)_* \circ c'_p(Q|_E) \circ C
$$
To finish the proof it suffices to show the multiplications defined
in Remark \ref{remark-ring-loc-classes} on the classes $a_p = c'_p(Q)$
and on the classes $b_p = c'_p(Q|_E)$ agree:
$$
a_{p_1}a_{p_2} \ldots a_{p_r} =
(E \to Z)_* \circ b_{p_1}b_{p_2} \ldots b_{p_r} \circ C
$$
Some details omitted. If $r = 1$, then this is true.
For $r > 1$ note that by Remark \ref{remark-res-push} the multiplication in
Remark \ref{remark-ring-loc-classes} proceeds
by inserting $(Z \to X)_*$, resp.\ $(E \to W_\infty)_*$ in between
the factors of the product
$a_{p_1}a_{p_2} \ldots a_{p_r}$, resp.\ $b_{p_1}b_{p_2} \ldots b_{p_r}$
and taking compositions as bivariant classes.
Now by Lemma \ref{lemma-silly} we have
$$
(E \to W_\infty)_* \circ b_{p_i} = c_{p_i}(Q|_{W_\infty})
$$
and by Lemma \ref{lemma-homomorphism} we have
$$
C \circ (Z \to X)_* \circ a_{p_i} = c_{p_i}(Q|_{W_\infty}) \circ C
$$
for $i = 2, \ldots, r$. A calculation
shows that the left and right hand side of the desired
equality both simplify to
$$
(E \to Z)_* \circ c'_{p_1}(Q|_E) \circ
c_{p_2}(Q|_{W_\infty}) \circ \ldots \circ
c_{p_r}(Q|_{W_\infty}) \circ C
$$
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-localized-chern-pre-sum-c}
In Lemma \ref{lemma-localized-chern-pre} assume $Q|_T$ is isomorphic
to a finite locally free $\mathcal{O}_T$-module of rank $< p$.
Assume we have another perfect object $Q' \in D(\mathcal{O}_W)$
whose chern classes are defined with $Q'|_T$ isomorphic to a
finite locally free $\mathcal{O}_T$-module of rank $< p'$ placed
in cohomological degree $0$. With notation as in
Remark \ref{remark-ring-loc-classes} set
$$
c^{(p)}(Q) = 1 + c_1(Q|_{X \times \{0\}}) + \ldots +
c_{p - 1}(Q|_{X \times \{0\}}) +
c'_{p}(Q) + c'_{p + 1}(Q) + \ldots
$$
in $A^{(p)}(Z \to X)$ with $c'_i(Q)$ for $i \geq p$ as in
Lemma \ref{lemma-localized-chern-pre}. Similarly for $c^{(p')}(Q')$ and
$c^{(p + p')}(Q \oplus Q')$.
Then $c^{(p + p')}(Q \oplus Q') = c^{(p)}(Q)c^{(p')}(Q')$
in $A^{(p + p')}(Z \to X)$.
\end{lemma}

\begin{proof}
Recall that the image of $c'_i(Q)$ in $A^p(X)$ is equal to
$c_i(Q|_{X \times \{0\}})$ for $i \geq p$ and similarly for
$Q'$ and $Q \oplus Q'$, see Lemma \ref{lemma-localized-chern-pre}.
Hence the equality in degrees $< p + p'$ follows from the
additivity of Lemma \ref{lemma-additivity-on-perfect}.

\medskip\noindent
Let's take $n \geq p + p'$.
As in the proof of Lemma \ref{lemma-localized-chern-pre}
let $E \subset W_\infty$ denote the inverse image of $Z$.
Observe that we have the equality
$$
c^{(p + p')}(Q|_E \oplus Q'|_E) =
c^{(p)}(Q|_E)c^{(p')}(Q'|_E)
$$
in $A^{(p + p')}(E \to W_\infty)$ by Lemma \ref{lemma-silly-sum-c}.
Since by construction
$$
c'_p(Q \oplus Q') = (E \to Z)_* \circ c'_p(Q|_E \oplus Q'|_E) \circ C
$$
we conclude that suffices to show for all $i + j = n$ we have
$$
(E \to Z)_* \circ c^{(p)}_i(Q|_E)c^{(p')}_j(Q'|_E) \circ C
=
c^{(p)}_i(Q)c^{(p')}_j(Q')
$$
in $A^n(Z \to X)$ where the multiplication is the one from
Remark \ref{remark-ring-loc-classes} on both sides. There are
three cases, depending on whether $i \geq p$, $j \geq p'$, or both.

\medskip\noindent
Assume $i \geq p$ and $j \geq p'$. In this case the products are
defined by inserting $(E \to W_\infty)_*$, resp.\ $(Z \to X)_*$ in between
the two factors and taking compositions as bivariant classes, see
Remark \ref{remark-res-push}.
In other words, we have to show
$$
(E \to Z)_* \circ c'_i(Q|_E) \circ
(E \to W_\infty)_* \circ c'_j(Q'|_E) \circ C =
c'_i(Q) \circ (Z \to X)_* \circ c'_j(Q')
$$
By Lemma \ref{lemma-silly} the left hand side is equal to
$$
(E \to Z)_* \circ c'_i(Q|_E) \circ c_j(Q'|_{W_\infty}) \circ C
$$
Since $c'_i(Q) = (E \to Z)_* \circ c'_i(Q|_E) \circ C$
the right hand side is equal to
$$
(E \to Z)_* \circ c'_i(Q|_E) \circ C \circ (Z \to X)_* \circ c'_j(Q')
$$
which is immediately seen to be equal to the above
by Lemma \ref{lemma-homomorphism}.

\medskip\noindent
Assume $i \geq p$ and $j < p$. Unwinding the products
in this case we have to show
$$
(E \to Z)_* \circ c'_i(Q|_E) \circ c_j(Q'|_{W_\infty}) \circ C =
c'_i(Q) \circ c_j(Q'|_{X \times \{0\}})
$$
Again using that $c'_i(Q) = (E \to Z)_* \circ c'_i(Q|_E) \circ C$
we see that it suffices to show $c_j(Q'|_{W_\infty}) \circ C =
C \circ c_j(Q'|_{X \times \{0\}})$ which is part of
Lemma \ref{lemma-homomorphism}.

\medskip\noindent
Assume $i < p$ and $j \geq p'$. Unwinding the products
in this case we have to show
$$
(E \to Z)_* \circ c_i(Q|_E) \circ c'_j(Q'|_E) \circ C =
c_i(Q|_{Z \times \{0\}}) \circ c'_j(Q')
$$
However, since $c'_j(Q|_E)$ and $c'_j(Q')$ are
bivariant classes, they commute with capping with chern classes
(Lemma \ref{lemma-cap-commutative-chern}). Hence it suffices to prove
$$
(E \to Z)_* \circ c'_j(Q'|_E) \circ c_i(Q|_{W_\infty}) \circ C =
c'_j(Q') \circ c_i(Q|_{X \times \{0\}})
$$
which we reduces us to the case discussed in the preceding paragraph.
\end{proof}

\begin{lemma}
\label{lemma-localized-chern-pre-sum-P}
In Lemma \ref{lemma-localized-chern-pre} assume $Q|_T$ is zero.
Assume we have another perfect object $Q' \in D(\mathcal{O}_W)$
whose chern classes are defined such that the restriction $Q'|_T$ is zero.
In this case the classes
$P'_p(Q), P'_p(Q'), P'_p(Q \oplus Q') \in A^p(Z \to X)$
constructed in Lemma \ref{lemma-localized-chern-pre}
satisfy $P'_p(Q \oplus Q') = P'_p(Q) + P'_p(Q')$.
\end{lemma}

\begin{proof}
This follows immediately from the construction of these
classes and Lemma \ref{lemma-silly-sum-P}.
\end{proof}









 
\section{Localized chern classes}
\label{section-localized-chern}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $i : Z \to X$ be a closed immersion.
Let $E \in D(\mathcal{O}_X)$ be a perfect object. Assume
\begin{enumerate}
\item chern classes of $E$ are defined, and
\item the restriction $E|_{X \setminus Z}$ is zero, resp.\ isomorphic to a
finite locally free $\mathcal{O}_{X \setminus Z}$-module of rank $< p$
sitting in cohomological degree $0$.
\end{enumerate}
In this situation we claim there exists a canonical bivariant class
$$
P_p(Z \to X, E) \in A^p(Z \to X),
\quad\text{resp.}\quad
c_p(Z \to X, E) \in A^p(Z \to X)
$$
with the property that
\begin{equation}
\label{equation-defining-property-localized-classes}
i_* \circ P_p(Z \to X, E) = P_p(E),
\quad\text{resp.}\quad
i_* \circ c_p(Z \to X, E) = c_p(E)
\end{equation}
as bivariant classes on $X$ (with $\circ$ as in
Lemma \ref{lemma-push-proper-bivariant}).

\medskip\noindent
The construction of these bivariant classes is as follows. The first condition
means that we can choose a bounded complex $\mathcal{E}^\bullet$ of
finite locally free $\mathcal{O}_X$-modules representing $E$. Next, let
$$
b : W \longrightarrow \mathbf{P}^1_X
\quad\text{and}\quad
\mathcal{Q}^\bullet
$$
be the blowing up and complex of $\mathcal{O}_W$-modules constructed in
More on Flatness, Section \ref{flat-section-blowup-complexes-III}.
Let $T \subset W_\infty$ be the closed subscheme whose existence is
averted in More on Flatness, Lemma \ref{flat-lemma-graph-construction}.
Let $T' \subset T$ be the open and closed subscheme such that
$\mathcal{Q}^\bullet|_{T'}$ is zero, resp.\ isomorphic to a
finite locally free $\mathcal{O}_{T'}$-module of rank $< p$
sitting in cohomological degree $0$. It is immediate from the construction
that the morphisms
$$
T' \to T \to W_\infty \to X
$$
are all isomorphisms of schemes over the open subscheme $X \setminus Z$ of $X$.
(Compare with More on Flatness, Lemma
\ref{flat-lemma-complex-and-divisor-blowup-T-ranks}.)
Recalling that
$\mathcal{Q}^\bullet|_{X \times \{0\}} \cong \mathcal{E}^\bullet$
by construction, we conclude that the bivariant class constructed in
Lemma \ref{lemma-localized-chern-pre}
using $W, b, \mathcal{Q}^\bullet, T'$ gives us a class
$P_p(Z \to X, E) \in A^p(Z \to X)$, resp.\ $c_p(Z \to X, E) \in A^p(Z \to X)$
satisfying (\ref{equation-defining-property-localized-classes}).

\begin{lemma}
\label{lemma-independent-loc-chern}
The localized class constructed above is independent of choices.
\end{lemma}

\noindent
In Lemma \ref{lemma-independent-loc-chern-bQ} we will see that we
have quite a bit of flexibility in choosing the pair
$b : W \to \mathbf{P}^1_X$ and $\mathcal{Q}^\bullet$.

\begin{proof}
Here are the choices we made above: the bounded complex $\mathcal{E}^\bullet$ 
of finite locally free $\mathcal{O}_X$-modules representing $E$,
the blowup $b : W \to \mathbf{P}^1_X$, the choice of $\mathcal{Q}^\bullet$,
and the closed subscheme $T'$. In
Lemma \ref{lemma-localized-chern-pre-independent}
we have seen that the class is independent of the choice of $T'$. In
More on Flatness, Lemma \ref{flat-lemma-complex-and-divisor-derived}
we have seen that the blowing up $b : W \to \mathbf{P}^1_X$
and the isomorphism class $Q$ of $\mathcal{Q}^\bullet$ in $D(\mathcal{O}_W)$
only depend on the isomorphism class of $L\text{pr}^*E$ in
$D(\mathcal{O}_{\mathbf{P}^1_X})$ where $\text{pr} : \mathbf{P}^1_X \to X$
is the projection morphism. Since the construction of
Lemma \ref{lemma-localized-chern-pre} depends only on the
isomorphism class $Q$, we conclude.
\end{proof}

\noindent
Here is another sanity check.

\begin{lemma}
\label{lemma-base-change-loc-chern}
In the situation above let $f : X' \to X$ be a morphism of schemes
which is locally of finite type. Denote $E' = Lf^*E$ and $Z' = f^{-1}(Z)$.
Then the bivariant class
$$
P_p(Z' \to X', E') \in A^p(Z' \to X'),
\quad\text{resp.}\quad
c_p(Z' \to X', E') \in A^p(Z' \to X')
$$
constructed above using $X', Z', E'$ is the restriction
(Remark \ref{remark-restriction-bivariant}) of the
bivariant class $P_p(Z \to X, E) \in A^p(Z \to X)$,
resp.\ $c_p(Z \to X, E) \in A^p(Z \to X)$.
\end{lemma}

\begin{proof}
Choose a bounded complex $\mathcal{E}^\bullet$ of finite locally free
$\mathcal{O}_X$-modules representing $E$. Denote
$(\mathcal{E}')^\bullet = f^*\mathcal{E}^\bullet$.
Observe that $\mathbf{P}^1_{X'} \to \mathbf{P}^1_X$ is a morphism of
schemes such that the pullback of the effective Cartier divisor
$(\mathbf{P}^1_X)_\infty$ is the effective Cartier divisor
$(\mathbf{P}^1_{X'})_\infty$. By More on Flatness, Lemma
\ref{flat-lemma-complex-and-divisor-blowup-base-change}
we obtain a commutative diagram
$$
\xymatrix{
W' \ar[rd]_{b'} \ar[r]_-g &
\mathbf{P}^1_{X'} \times_{\mathbf{P}^1_X} W \ar[d]_r \ar[r]_-q &
W \ar[d]^b \\
&
\mathbf{P}^1_{X'} \ar[r] &
\mathbf{P}^1_X
}
$$
such that $W'$ is the strict transform of $\mathbf{P}^1_{X'}$
with respect to $b$ and such that
$(\mathcal{Q}')^\bullet = g^*q^*\mathcal{Q}^\bullet$.
The restriction of the bivariant class $P_p(Z \to X, E)$,
resp.\ $c_p(Z \to X, E)$ corresponds to the class constructed in
Lemma \ref{lemma-localized-chern-pre} using the
proper morphism $r$ and the complex $q^*\mathcal{Q}^\bullet$.
On the other hand, the bivariant class $P_p(Z' \to X', E')$,
resp.\ $c_p(Z' \to X', E')$ corresponds to the
proper morphism $b'$ and the complex $(\mathcal{Q}')^\bullet$.
Thus we conclude by Lemma \ref{lemma-localized-chern-pre-independent}.
\end{proof}

\begin{lemma}
\label{lemma-loc-chern-after-pushforward}
In the situation above we have
$$
P_p(Z \to X, E) \cap i_*\alpha = P_p(E|_Z) \cap \alpha,
\quad\text{resp.}\quad
c_p(Z \to X, E) \cap i_*\alpha = c_p(E|_Z) \cap \alpha
$$
in $\CH_*(Z)$ for any $\alpha \in \CH_*(Z)$.
\end{lemma}

\begin{proof}
We only prove the second equality and we omit the proof of the first.
Since $c_p(Z \to X, E)$ is a bivariant class and since the base
change of $Z \to X$ by $Z \to X$ is $\text{id} : Z \to Z$ we have
$c_p(Z \to X, E) \cap i_*\alpha = c_p(Z \to X, E) \cap \alpha$.
By Lemma \ref{lemma-base-change-loc-chern} the restriction of
$c_p(Z \to X, E)$ to $Z$ (!) is the localized chern class for
$\text{id} : Z \to Z$ and $E|_Z$. Thus the result follows from
(\ref{equation-defining-property-localized-classes}) with $X = Z$.
\end{proof}

\begin{definition}
\label{definition-localized-chern}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $i : Z \to X$ be a closed immersion.
Let $E \in D(\mathcal{O}_X)$ be a perfect object whose chern classes
are defined.
\begin{enumerate}
\item If the restriction $E|_{X \setminus Z}$ is zero, then for all
$p \geq 0$ we define
$$
P_p(Z \to X, E) \in A^p(Z \to X)
$$
by the construction given above and we define the
{\it localized chern character} by the formula
$$
ch(Z \to X, E) =
\sum\nolimits_{p = 0, 1, 2, \ldots} \frac{P_p(Z \to X, E)}{p!}
\quad\text{in}\quad A^*(Z \to X) \otimes \mathbf{Q}
$$
\item If the restriction $E|_{X \setminus Z}$ is isomorphic to a
finite locally free $\mathcal{O}_{X \setminus Z}$-module of rank $< p$
sitting in cohomological degree $0$, then we define the
{\it localized $p$th chern class} $c_p(Z \to X, E)$ by the construction above.
\end{enumerate}
\end{definition}

\noindent
In the situation of the definition assume $E|_{X \setminus Z}$ is zero.
Then, to be sure, we have the equality
$$
i_* \circ ch(Z \to X, E) = ch(E)
$$
in $A^*(X) \otimes \mathbf{Q}$ because we have shown the
equality (\ref{equation-defining-property-localized-classes}) above.

\begin{lemma}
\label{lemma-loc-chern-disjoint}
In the situation of Definition \ref{definition-localized-chern}
if $\alpha \in \CH_k(X)$ has support disjoint from $Z$, then
$P_p(Z \to X, E) \cap \alpha = 0$, resp.\ $c_p(Z \to X, E) \cap \alpha = 0$.
\end{lemma}

\begin{proof}
This is immediate from the construction of the localized chern classes.
It also follows from the fact that we can compute
$c_p(Z \to X, E) \cap \alpha$ by first restricting $c_p(Z \to X, E)$ to
the support of $\alpha$, and then using Lemma \ref{lemma-base-change-loc-chern}
to see that this restriction is zero.
\end{proof}

\begin{lemma}
\label{lemma-loc-chern-shrink-Z}
In the situation of Definition \ref{definition-localized-chern}
assume $Z \subset Z' \subset X$ where $Z'$ is a closed subscheme of $X$.
Then
$P_p(Z' \to X, E) = (Z \to Z')_* \circ P_p(Z \to X, E)$,
resp.\ $c_p(Z' \to X, E) = (Z \to Z')_* \circ c_p(Z \to X, E)$
(with $\circ$ as in Lemma \ref{lemma-push-proper-bivariant}).
\end{lemma}

\begin{proof}
This is true because the construction of
$P_p(Z' \to X, E)$, resp.\ $c_p(Z' \to X, E)$
uses the exact same morphism $b : W \to \mathbf{P}^1_X$
and $\mathcal{Q}^\bullet$. Then we can use
Lemma \ref{lemma-silly-shrink} to conclude.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-loc-chern-agree}
In Lemma \ref{lemma-silly} say $E_2$ is the restriction of a perfect
$E \in D(\mathcal{O}_X)$ whose chern classes are defined and
whose restriction to $X_1$ is zero, resp.\ isomorphic to a
finite locally free $\mathcal{O}_{X_1}$-module
of rank $< p$ sitting in cohomological degree $0$. Then the
class $P'_p(E_2)$, resp.\ $c'_p(E_2)$ of Lemma \ref{lemma-silly} agrees with
$P_p(X_2 \to X, E)$, resp.\ $c_p(X_2 \to X, E)$ of
Definition \ref{definition-localized-chern}.
\end{lemma}

\begin{proof}
The assumptions on $E$ imply that there is an open $U \subset X$
containing $X_1$ such that $E|_U$ is zero, resp.\ isomorphic to a finite locally
free $\mathcal{O}_U$-module of rank $< p$. See More on Algebra, Lemma
\ref{more-algebra-lemma-lift-perfect-from-residue-field}.
Let $Z \subset X$ be the complement of $U$ in $X$ endowed with
the reduced induced closed subscheme structure. Then
$P_p(X_2 \to X, E) = (Z \to X_2)_* \circ P_p(Z \to X, E)$,
resp.\ $c_p(X_2 \to X, E) = (Z \to X_2)_* \circ c_p(Z \to X, E)$
by Lemma \ref{lemma-loc-chern-shrink-Z}.
Now we can prove that $P_p(X_2 \to X, E)$, resp.\ $c_p(X_2 \to X, E)$
satisfies the characterization of $P'_p(E_2)$, resp.\ $c'_p(E_2)$
given in Lemma \ref{lemma-silly}. Namely, by the relation
$P_p(X_2 \to X, E) = (Z \to X_2)_* \circ P_p(Z \to X, E)$,
resp.\ $c_p(X_2 \to X, E) = (Z \to X_2)_* \circ c_p(Z \to X, E)$
just proven and the fact that $X_1 \cap Z = \emptyset$,
the composition $P_p(X_2 \to X, E) \circ i_{1, *}$,
resp.\ $c_p(X_2 \to X, E) \circ i_{1, *}$ is zero
by Lemma \ref{lemma-loc-chern-disjoint}.
On the other hand,
$P_p(X_2 \to X, E) \circ i_{2, *} = P_p(E_2)$,
resp.\ $c_p(X_2 \to X, E) \circ i_{2, *} = c_p(E_2)$
by Lemma \ref{lemma-loc-chern-after-pushforward}.
\end{proof}





\section{Two technical lemmas}
\label{section-tools-loc-chern}

\noindent
In this section we develop some additional tools to allow us to work
more comfortably with localized chern classes. The following lemma
is a more precise version of something we've already encountered in
the proofs of Lemmas \ref{lemma-localized-chern-pre-compose} and
\ref{lemma-localized-chern-pre-sum-c}.

\begin{lemma}
\label{lemma-homomorphism-final}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. Let $b : W \longrightarrow \mathbf{P}^1_X$
be a proper morphism of schemes. Let $n \geq 1$. For $i = 1, \ldots, n$
let $Z_i \subset X$ be a closed subscheme, let $Q_i \in D(\mathcal{O}_W)$,
be a perfect object, let $p_i \geq 0$ be an integer, and let
$T_i \subset W_\infty$, $i = 1, \ldots, n$ be closed.
Denote $W_i = b^{-1}(\mathbf{P}^1_{Z_i})$. Assume
\begin{enumerate}
\item for $i = 1, \ldots, n$ the assumption of
Lemma \ref{lemma-localized-chern-pre} hold for
$b, Z_i, Q_i, T_i, p_i$,
\item $Q_i|_{W \setminus W_i}$ is zero, resp.\ isomorphic to a finite
locally free module of rank $< p_i$ placed in cohomological degree $0$.
\end{enumerate}
Then $P'_{p_n}(Q_n) \circ \ldots \circ P'_{p_1}(Q_1)$ is equal to
$$
(W_{n, \infty} \cap \ldots \cap W_{1, \infty} \to
Z_n \cap \ldots \cap Z_1)_* \circ
P'_{p_n}(Q_n|_{W_{n, \infty}}) \circ \ldots \circ P'_{p_1}(Q_1|_{W_{1, \infty}})
\circ C
$$
in $A^{p_n + \ldots + p_1}(Z_n \cap \ldots \cap Z_1 \to X)$,
resp.\ $c'_{p_n}(Q_n) \circ \ldots \circ c'_{p_1}(Q_1)$ is equal to
$$
(W_{n, \infty} \cap \ldots \cap W_{1, \infty} \to
Z_n \cap \ldots \cap Z_1)_* \circ
c'_{p_n}(Q_n|_{W_{n, \infty}}) \circ \ldots \circ c'_{p_1}(Q_1|_{W_{1, \infty}})
\circ C
$$
in $A^{p_n + \ldots + p_1}(Z_n \cap \ldots \cap Z_1 \to X)$.
\end{lemma}

\begin{proof}
Let us prove the statement on chern classes by induction on $n$;
the statement on $P_p(-)$ is proved in the exact same manner.
The case $n = 1$ is the construction of $c'_{p_1}(Q_1)$.
For $n > 1$ we have by induction that
$c'_{p_n}(Q_n) \circ \ldots \circ c'_{p_1}(Q_1)$ is equal to
$$
c'_{p_n}(Q_n) \circ
(W_{n - 1, \infty} \cap \ldots \cap W_{1, \infty} \to
Z_{n - 1} \cap \ldots \cap Z_1)_* \circ
c'_{p_{n - 1}}(Q_{n - 1}|_{W_{n - 1}, \infty}) \circ \ldots \circ
c'_{p_1}(Q_1|_{W_{1, \infty}})
\circ C
$$
Observe that the restriction of $c'_{p_n}(Q_n)$ to
$Z_{n - 1} \cap \ldots \cap Z_1$ is computed by
$b' : W_{n - 1} \cap \ldots \cap W_1 \to
\mathbf{P}^1_{Z_{n - 1} \cap \ldots \cap Z_1}$
and the restriction of $Q_n$ to $W_{n - 1} \cap \ldots \cap W_1$.
Denote $C_{n - 1} \in A^0(W_{n - 1, \infty} \cap \ldots \cap W_{1, \infty} \to
Z_{n - 1} \cap \ldots \cap Z_1)$ the class of Lemma \ref{lemma-gysin-at-infty}.
Hence the above becomes
\begin{align*}
(W_{n, \infty} \cap \ldots \cap W_{1, \infty} \to
Z_n \cap \ldots \cap Z_1)_* \circ
c'_{p_n}(Q_n|_{W_n, \infty}) \circ \\
C_{n - 1} \circ
(W_{n - 1, \infty} \cap \ldots \cap W_{1, \infty} \to
Z_{n - 1} \cap \ldots \cap Z_1)_* \\
\circ
c'_{p_{n - 1}}(Q_{n - 1}|_{W_{n - 1}, \infty}) \circ \ldots \circ
c'_{p_1}(Q_1|_{W_{1, \infty}})
\circ C
\end{align*}
By Lemma \ref{lemma-homomorphism-pre}
we know that the composition
$C_{n - 1} \circ (W_{n - 1, \infty} \cap \ldots \cap W_{1, \infty} \to
Z_{n - 1} \cap \ldots \cap Z_1)_*$
is the identity on elements in the image of the gysin map
$$
(W_{n - 1, \infty} \cap \ldots \cap W_{1, \infty} \to
W_{n - 1} \cap \ldots \cap W_1)^*
$$
Thus it suffices to show that any element in the image of
$c'_{p_{n - 1}}(Q_{n - 1}|_{W_{n - 1}, \infty}) \circ \ldots \circ
c'_{p_1}(Q_1|_{W_{1, \infty}}) \circ C$
is in the image of the gysin map. We may write
$$
c'_{p_i}(Q_i|_{W_{i, \infty}}) = \text{restriction of } c_{p_i}(W_i \to W, Q_i)
\text{ to } W_{i, \infty}
$$
by Lemma \ref{lemma-loc-chern-agree} and assumption (2) on $Q_i$
in the statement of the lemma. Thus, if $\beta \in \CH_{k + 1}(W)$
restricts to the flat pullback of $\alpha$ on $b^{-1}(\mathbf{A}^1_X)$,
then
\begin{align*}
& c'_{p_{n - 1}}(Q_{n - 1}|_{W_{n - 1}, \infty}) \cap \ldots \cap
c'_{p_1}(Q_1|_{W_{1, \infty}})
\cap C \cap \alpha \\
& =
c'_{p_{n - 1}}(Q_{n - 1}|_{W_{n - 1}, \infty}) \cap \ldots \cap
c'_{p_1}(Q_1|_{W_{1, \infty}})
\cap i_\infty^* \beta \\
& =
c_{p_{n - 1}}(W_{n - 1} \to W, Q_{n - 1}) \cap \ldots \cap
c_{p_{n - 1}}(W_1 \to W, Q_1) \cap i_\infty^* \beta \\
& =
(W_{n - 1, \infty} \cap \ldots \cap W_{1, \infty} \to
W_{n - 1} \cap \ldots \cap W_1)^*
\left(c_{p_{n - 1}}(W_{n - 1} \to W, Q_{n - 1}) \cap \ldots \cap
c_{p_1}(W_1 \to W, Q_1) \cap \beta\right)
\end{align*}
as desired.
\end{proof}

\noindent
The following lemma gives us a tremendous amount of flexibility
if we want to compute the localized chern classes of a complex.

\begin{lemma}
\label{lemma-independent-loc-chern-bQ}
Assume $(S, \delta), X, Z, b : W \to \mathbf{P}^1_X, Q, T, p$
satisfy all the assumptions of Lemma \ref{lemma-localized-chern-pre}.
Finally, let $F \in D(\mathcal{O}_X)$ be a perfect object whose
chern classes are defined such that
\begin{enumerate}
\item the restriction of $Q$ to $b^{-1}(\mathbf{A}^1_X)$ is
isomorphic to the pullback of $F$, and
\item $F|_{X \setminus Z}$ is zero, resp.\ isomorphic to a finite
locally free $\mathcal{O}_{X \setminus Z}$-module of rank $< p$
sitting in cohomological degree $0$.
\end{enumerate}
Then the class $P'_p(Q)$, resp.\ $c'_p(Q)$ in $A^p(Z \to X)$ constructed
in Lemma \ref{lemma-localized-chern-pre}
is equal to $P_p(Z \to X, F)$, resp.\ $c_p(Z \to X, F)$.
\end{lemma}

\begin{proof}
The assumptions are preserved by base change with a morphism
$X' \to X$ locally of finite type. Hence it suffices to show that
$P_p(Z \to X, F) \cap \alpha = P'_p(Q) \cap \alpha$,
resp.\ $c_p(Z \to X, F) \cap \alpha = c'_p(Q) \cap \alpha$
for any $\alpha \in \CH_k(X)$. Choose $\beta \in \CH_{k + 1}(W)$
whose restriction to $b^{-1}(\mathbf{A}^1_X)$ is equal to
the flat pullback of $\alpha$ as in the construction of
$C$ in Lemma \ref{lemma-gysin-at-infty}.
Denote $E \subset W_\infty$ the inverse image of $Z$.

\medskip\noindent
Let $U \subset X$ be the maximal open subscheme such that $F|_U$ is
zero, resp.\ isomorphic to a finite locally free $\mathcal{O}_U$-module
of rank $< p$ sitting in cohomological degree $0$. Let $V \subset W$ be
the maximal open subscheme such that $Q|_V$ is zero, resp.\ isomorphic
to a finite locally free $\mathcal{O}_V$-module of rank $< p$ sitting in
cohomological degree $0$. By our assumptions on $Q$ and $F$ we have
$$
V \cap b^{-1}(\mathbf{A}^1_X) = \mathbf{A}^1_U,\quad
V \cap W_\infty \supset T,
\quad\text{and}\quad
X \setminus U \subset Z
$$
Let $Z' = X \setminus U$ and let $W' \subset W$ be the scheme
theoretic closure of $b^{-1}(\mathbf{A}^1_{Z'})$. The inclusions
above imply that we have $Z' \subset Z$, $b(W') \subset \mathbf{P}^1_{Z'}$,
$b' : W' \to \mathbf{P}^1_{Z'}$ is an isomorphism over $\mathbf{A}^1_{Z'}$,
and that $Q|_{W \setminus W'}$ is zero, resp.\ isomorphic to a finite
locally free $\mathcal{O}_{W \setminus W'}$-module of rank $< p$
sitting in cohomological degree $0$. The lemma follows from
the following sequence of equalities (the case of $P_p$ is similar)
\begin{align*}
c'_p(Q) \cap \alpha
& =
(E \to Z)_*(c'_p(Q|_E) \cap i_\infty^*\beta) \\
& =
(E \to Z)_*(c_p(E \to W_\infty, Q|_{W_\infty}) \cap i_\infty^*\beta) \\
& =
(E \to Z)_*(W'_\infty \to E)_*(c_p(W' \to W, Q) \cap i_\infty^*\beta) \\
& =
(W'_\infty \to Z)_*((i'_\infty)^*(c_p(W' \to W, Q) \cap \beta)) \\
& =
(W'_\infty \to Z)_*(C' \cap c_p(Z' \to X, F) \cap \alpha) \\
& =
c_p(Z \to X, F) \cap \alpha
\end{align*}
The first equality is the construction of $c'_p(Q)$. 
The second is Lemma \ref{lemma-loc-chern-agree}.
The third expresses the fact that the restriction of
$c_p(W' \to W, Q)$ to $W_\infty$ is equal to
$c_p(W'_\infty \to W_\infty, Q|_{W_\infty})$, see for example
Lemma \ref{lemma-base-change-loc-chern}, and that
$c_p(W'_\infty \to W_\infty, Q|_{W_\infty})$
pushes forward to $c_p(E \to W_\infty, Q|_{W_\infty})$
by Lemma \ref{lemma-loc-chern-shrink-Z}.
The fourth is commutation of a bivariant class with
a gysin homomorphism. For the fith, please observe that
$c_p(W' \to W, Q)$ and $c_p(Z' \to X, E)$ restrict to the
same bivariant class on $b^{-1}(\mathbf{A}^1_X)$ by
assumption (1) of the lemma. Hence $c_p(W' \to W, Q) \cap \beta$
is a class in $\CH_{k + 1 - p}(W')$ whose restriction to
$(b')^{-1}(\mathbf{A}^1_{Z'})$ agrees with the flat pullback
of $c_p(Z' \to X, F) \cap \alpha$. Thus
$(i'_\infty)^*(c_p(W' \to W, Q) \cap \beta)$ is equal to
$C' \cap c_p(Z' \to X, F) \cap \alpha$ where
$C' \in A^0(W'_\infty \to Z')$ is constructed in
Lemma \ref{lemma-gysin-at-infty}.
The final equality holds because $c_p(Z' \to X, F)$ pushes forward
to $c_p(Z \to X, F)$ and because $(W'_\infty \to Z)_* \circ C' = 1$ in $A^0(Z)$.
In fact we have $(W'_\infty \to Z') \circ C' = 1$ in $A^0(Z')$ as
follows from the final statement in Lemma \ref{lemma-gysin-at-infty}.
\end{proof}







\section{Properties of localized chern classes}
\label{section-properties-loc-chern}

\noindent
The main results in this section are additivity and multiplicativity
for localized chern classes.

\begin{lemma}
\label{lemma-loc-chern-character}
In the situation of Definition \ref{definition-localized-chern}
assume $E|_{X \setminus Z}$ is zero. Then
\begin{align*}
P_1(Z \to X, E) & = c_1(Z \to X, E), \\
P_2(Z \to X, E) & = c_1(Z \to X, E)^2 - 2c_2(Z \to X, E), \\
P_3(Z \to X, E) & = c_1(Z \to X, E)^3 - 3c_1(Z \to X, E)c_2(Z \to X, E)
+ 3c_3(Z \to X, E),
\end{align*}
and so on where the products are taken in the algebra $A^{(1)}(Z \to X)$
of Remark \ref{remark-ring-loc-classes}.
\end{lemma}

\begin{proof}
The statement makes sense because the zero sheaf has rank $< 1$ and
hence the classes $c_p(Z \to X, E)$ are defined for all $p \geq 1$.
The result itself follows immediately from the more general
Lemma \ref{lemma-localized-chern-pre-compose} as the localized chern
classes where defined using the procedure of
Lemma \ref{lemma-localized-chern-pre}
in Section \ref{section-localized-chern}.
\end{proof}

\begin{lemma}
\label{lemma-loc-chern-classes-commute}
In the situation of Definition \ref{definition-localized-chern}
assume $P_p(Z \to X, E)$, resp.\ $c_p(Z \to X, E)$ is defined.
Let $Y \to X$ be locally of finite type and $c \in A^*(Y \to X)$.
Then
$$
P_p(Z \to X, E) \circ c = c \circ P_p(Z \to X, E),
$$
respectively
$$
c_p(Z \to X, E) \circ c = c \circ c_p(Z \to X, E)
$$
in $A^*(Y \times_X Z \to X)$.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-homomorphism-commute}.
Namely, our assumptions say $E$
is represented to a bounded complex $\mathcal{E}^\bullet$
of finite locally free $\mathcal{O}_X$-modules. Let
$$
b : W \to \mathbf{P}^1_X
\quad\text{and}\quad
\mathcal{Q}^\bullet
$$
be the blowing up and complex of $\mathcal{O}_W$-modules constructed in
More on Flatness, Section \ref{flat-section-blowup-complexes-III}.
Let $T \subset W_\infty$ be the closed subscheme whose existence is
averted in More on Flatness, Lemma \ref{flat-lemma-graph-construction}.
Let $T' \subset T$ be the open and closed subscheme such that
$\mathcal{Q}^\bullet|_{T'}$ is zero, resp.\ isomorphic to a
finite locally free sheaf of rank $< p$ placed in degree $0$. By definition
$$
c_p(Z \to X, E) = c'_p(\mathcal{Q}^\bullet)
$$
as bivariant operations (and not just on cycles over $X$)
where the right hand side is the bivariant class constructed in
Lemma \ref{lemma-localized-chern-pre} using $W, b, \mathcal{Q}^\bullet, T'$.
By Lemma \ref{lemma-homomorphism-commute} we have
$$
P'_p(\mathcal{Q}^\bullet) \circ c = c \circ P'_p(\mathcal{Q}^\bullet)
\quad\text{resp.}\quad
c'_p(\mathcal{Q}^\bullet) \circ c = c \circ c'_p(\mathcal{Q}^\bullet)
$$
in $A^*(Y \times_X Z \to X)$ and we conclude.
\end{proof}

\begin{remark}
\label{remark-loc-chern-classes}
In the situation of Definition \ref{definition-localized-chern}
assume $E|_{X \setminus Z}$ is finite locally free of rank $< p$.
In this setting it is convenient to define
$$
c^{(p)}(Z \to X, E) = 1 + c_1(E) + \ldots + c_{p - 1}(E) +
c_p(Z \to X, E) + c_{p + 1}(Z \to X, E) + \ldots
$$
as an element of the algebra $A^{(p)}(Z \to X)$ considered in
Remark \ref{remark-ring-loc-classes}.
\end{remark}

\begin{lemma}
\label{lemma-additivity-loc-chern-c}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let $Z \to X$ be
a closed immersion. Let
$$
E_1 \to E_2 \to E_3 \to E_1[1]
$$
be a distinguished triangle of perfect objects in $D(\mathcal{O}_X)$.
Assume
\begin{enumerate}
\item $E_3 \to E_1[1]$ can be represented be a map of bounded complexes
of finite locally free $\mathcal{O}_X$-modules, and
\item the restrictions $E_1|_{X \setminus Z}$ and $E_3|_{X \setminus Z}$
are isomorphic to finite locally free $\mathcal{O}_{X \setminus Z}$-modules
of rank $< p_1$ and $< p_3$ placed in degree $0$.
\end{enumerate}
With notation as in Remark \ref{remark-loc-chern-classes} we have
$$
c^{(p_1 + p_3)}(Z \to X, E_2) = c^{(p_1)}(Z \to X, E_1)c^{(p_3)}(Z \to X, E_3)
$$
in $A^{(p_1 + p_3)}(Z \to X)$.
\end{lemma}

\begin{proof}
Observe that the assumptions imply that $E_2|_{X \setminus Z}$ is zero,
resp.\ isomorphic to a finite locally free $\mathcal{O}_{X \setminus Z}$-module
of rank $< p_1 + p_3$. Thus the statement makes sense. The proof of this
statement is tricky because the operator $\eta_\mathcal{I}$ from
More on Flatness, Section \ref{flat-section-eta} used in the construction
of localized chern classes doesn't transform distinguished triangles into
distinguished triangles.

\medskip\noindent
Let $\varphi^\bullet : \mathcal{E}_3^\bullet[-1] \to \mathcal{E}_1^\bullet$
be a map of bounded complexes of finite locally free $\mathcal{O}_X$-modules
representing $E_3[-1] \to E_1$ which exists by assumption. Consider the scheme
$X' = \mathbf{A}^1 \times X$ with projection
$g : X' \to X$. Let $Z' = g^{-1}(Z) = \mathbf{A}^1 \times Z$.
Denote $t$ the coordinate on $\mathbf{A}^1$. Consider the cone
$\mathcal{C}^\bullet$ of the map of complexes
$$
t g^*\varphi^\bullet :
g^*\mathcal{E}_3^\bullet[-1]
\longrightarrow
g^*\mathcal{E}_1^\bullet
$$
over $X'$. We obtain a distinguished triangle
$$
g^*\mathcal{E}_1^\bullet \to \mathcal{C}^\bullet \to
g^*\mathcal{E}_3^\bullet \to g^*\mathcal{E}_1^\bullet[1]
$$
where the first three terms form a termwise split short exact
sequence of complexes. Clearly $\mathcal{C}^\bullet$ is a
bounded complex of finite locally free $\mathcal{O}_{X'}$-modules
whose restriction to $X' \setminus Z'$ is isomorphic to a
finite locally free
$\mathcal{O}_{X' \setminus Z'}$-module of rank $< p_1 + p_3$
placed in degree $0$. Thus we have the localized chern classes
$$
c_p(Z' \to X', \mathcal{C}^\bullet) \in A^p(Z' \to X')
$$
for $p \geq p_1 + p_3$. For any $\alpha \in \CH_k(X)$ consider
$$
c_p(Z' \to X', \mathcal{C}^\bullet) \cap g^*\alpha
\in \CH_{k + 1 - p}(\mathbf{A}^1 \times X)
$$
If we restrict to $t = 0$, then the map $t g^*\varphi^\bullet$
restricts to zero and $\mathcal{C}^\bullet|_{t = 0}$
is the direct sum of $\mathcal{E}_1^\bullet$ and $\mathcal{E}_3^\bullet$.
By compatibility of localized chern classes with base change
(Lemma \ref{lemma-base-change-loc-chern}) we conclude that
$$
i_0^* \circ c^{(p_1 + p_3)}(Z' \to X', \mathcal{C}^\bullet) \circ g^* =
c^{(p_1 + p_2)}(Z \to X, E_1 \oplus E_3)
$$
in $A^{(p_1 + p_3)}(Z \to X)$. On the other hand, if we restrict to $t = 1$,
then the map $t g^*\varphi^\bullet$
restricts to $\varphi$ and $\mathcal{C}^\bullet|_{t = 1}$
is a bounded complex of finite locally free modules representing $E_2$.
We conclude that
$$
i_1^* \circ c^{(p_1 + p_3)}(Z' \to X', \mathcal{C}^\bullet) \circ g^* =
c^{(p_1 + p_2)}(Z \to X, E_2)
$$
in $A^{(p_1 + p_3)}(Z \to X)$. Since $i_0^* = i_1^*$ by definition of
rational equivalence (more precisely this follows from the formulae in
Lemma \ref{lemma-linebundle-formulae}) we conclude that
$$
c^{(p_1 + p_2)}(Z \to X, E_2) = c^{(p_1 + p_2)}(Z \to X, E_1 \oplus E_3)
$$
This reduces us to the case discussed in the next paragraph.

\medskip\noindent
Assume $E_2 = E_1 \oplus E_3$ and $E_i$ corresponds to $\mathcal{E}_i^\bullet$
for $i = 1, 3$ as above. Set
$\mathcal{E}_2^\bullet = \mathcal{E}_1^\bullet \oplus \mathcal{E}_3^\bullet$.
For $i = 1, 2, 3$ let
$$
b_i : W_i \to \mathbf{P}^1_X
\quad\text{and}\quad
\mathcal{Q}_i^\bullet
$$
be the blowing up and complex of $\mathcal{O}_{W_i}$-modules constructed in
More on Flatness, Section \ref{flat-section-blowup-complexes-III}.
Let $T_i \subset W_{i, \infty}$ be the closed subscheme whose existence is
averted in More on Flatness, Lemma \ref{flat-lemma-graph-construction}.
Let $T'_i \subset T_i$ be the open and closed subscheme such that
$\mathcal{Q}_i^\bullet|_{T'_i}$ is isomorphic to a finite locally free
sheaf of rank $< p_i$ in degree $0$. By definition
$$
c_p(Z \to X, E_i) = c'_p(\mathcal{Q}_i^\bullet)
$$
where the right hand side is the bivariant class constructed in
Lemma \ref{lemma-localized-chern-pre} using
$W_i, b_i, \mathcal{Q}_i^\bullet, T'_i$.
By Divisors,  Lemma \ref{divisors-lemma-blowing-up-two-ideals} we
can choose a commutative diagram
$$
\xymatrix{
W \ar[dd]^{g_1} \ar[rd]^{g_2} \ar[rr]_{g_3} & & W_3 \ar[dd]^{b_3} \\
& W_2 \ar[rd]^{b_2} \\
W_1 \ar[rr]^{b_1} & & \mathbf{P}^1_X
}
$$
where all morphisms are blowing ups which are isomorphisms over
$\mathbf{A}^1_X$.

\medskip\noindent
By Lemma \ref{lemma-localized-chern-pre-independent} we may use
$W$, $b = b_i \circ g_i$, $g_i^*\mathcal{Q}_i^\bullet$, and
$g_i^{-1}(T'_i)$ to construct $c_p(Z \to X, E_i)$. The same lemma also
tells us that we may replace $g_i^{-1}(T'_i)$ with
$T = g_1^{-1}(T'_1) \cap g_2^{-1}(T'_2) \cap g_3^{-1}(T'_3)$
because this closed subscheme still contains all points of $W_\infty$
lying over $X \setminus Z$. Hence we may use $T$ for each of
the three constructions. By More on Flatness, Lemma
\ref{flat-lemma-complex-and-divisor-eta-pull}
applied to the morphisms $g_i : W \to W_i$ we find that
$$
g_i^*\mathcal{Q}_i^\bullet =
\eta_\mathcal{I}b^*p^*\mathcal{E}_i^\bullet
$$
where $\mathcal{I}$ is the invertible ideal sheaf of the effective
Cartier divisor $W_\infty$ and
$p :\mathbf{P}^1_X \to X$ is the projection morphism. Since the functor
$\eta_\mathcal{I}$ visibly commutes with direct sums, we see that
$\mathcal{Q}_2^\bullet = \mathcal{Q}_1^\bullet \oplus \mathcal{Q}_3^\bullet$.
Thus the desired equality follows from
Lemma \ref{lemma-localized-chern-pre-sum-c}.
\end{proof}

\begin{lemma}
\label{lemma-additivity-loc-chern-P}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let $Z \to X$ be
a closed immersion. Let
$$
E_1 \to E_2 \to E_3 \to E_1[1]
$$
be a distinguished triangle of perfect objects in $D(\mathcal{O}_X)$.
Assume
\begin{enumerate}
\item $E_3 \to E_1[1]$ can be represented be a map of bounded complexes
of finite locally free $\mathcal{O}_X$-modules, and
\item the restrictions $E_1|_{X \setminus Z}$ and $E_3|_{X \setminus Z}$
are zero.
\end{enumerate}
Then we have
$$
P_p(Z \to X, E_2) = P_p(Z \to X, E_1) + P_p(Z \to X, E_3)
$$
for all $p \in \mathbf{Z}$ and consequently
$ch(Z \to X, E_2) = ch(Z \to X, E_1) + ch(Z \to X, E_3)$.
\end{lemma}

\begin{proof}
The proof is exactly the same as the proof of
Lemma \ref{lemma-additivity-loc-chern-c}
except it uses
Lemma \ref{lemma-localized-chern-pre-sum-P}
at the very end. For $p > 0$ we can deduce this lemma
from Lemma \ref{lemma-additivity-loc-chern-c} with $p_1 = p_3 = 1$
and the relationship between $P_p(Z \to X, E)$ and $c_p(Z \to X, E)$ given in
Lemma \ref{lemma-loc-chern-character}. The case $p = 0$ can be shown
directly (it is only interesting if $X$ has a connected component
entirely contained in $Z$).
\end{proof}

\begin{lemma}
\label{lemma-loc-chern-tensor-product}
In Situation \ref{situation-setup} let $X$ be locally of finite type over $S$.
Let $Z_i \subset X$, $i = 1, 2$ be closed subschemes. Let $F_i$, $i = 1, 2$
be perfect objects of $D(\mathcal{O}_X)$ whose chern classes are defined.
Assume that $F_i|_{X \setminus Z_i}$ is zero\footnote{Presumably there
is a variant of this lemma where we only assume $F_i|_{X \setminus Z_i}$
is isomorphic to a finite locally free $\mathcal{O}_{X \setminus Z_i}$-module
of rank $< p_i$.} for $i = 1, 2$. Denote
$r_i = P_0(Z_i \to X, F_i) \in A^0(Z_i \to X)$.
Then we have
$$
c_1(Z_1 \cap Z_2 \to X, F_1 \otimes_{\mathcal{O}_X}^\mathbf{L} F_2) =
r_1 c_1(Z_2 \to X, F_2) + r_2 c_1(Z_1 \to X, F_1)
$$
in $A^1(Z_1 \cap Z_2 \to X)$ and
\begin{align*}
c_2(Z_1 \cap Z_2 \to X, F_1 \otimes_{\mathcal{O}_X}^\mathbf{L} F_2)
& =
r_1 c_2(Z_2 \to X, F_2) +
r_2 c_2(Z_1 \to X, F_1) + \\
& {r_1 \choose 2} c_1(Z_2 \to X, F_2)^2 + \\
& (r_1r_2 - 1) c_1(Z_2 \to X, F_2)c_1(Z_1 \to X, F_1) + \\
& {r_2 \choose 2} c_1(Z_1 \to X, F_1)^2
\end{align*}
in $A^2(Z_1 \cap Z_2 \to X)$ and so on for higher chern classes.
Similarly, we have
$$
ch(Z_1 \cap Z_2 \to X, F_1 \otimes_{\mathcal{O}_X}^\mathbf{L} F_2) =
ch(Z_1 \to X, F_1) ch(Z_2 \to X, F_2)
$$
in $A^*(Z_1 \cap Z_2 \to X) \otimes \mathbf{Q}$. More precisely, we have
$$
P_p(Z_1 \cap Z_2 \to X, F_1 \otimes_{\mathcal{O}_X}^\mathbf{L} F_2) =
\sum\nolimits_{p_1 + p_2 = p}
{p \choose p_1} P_{p_1}(Z_1 \to X, F_1) P_{p_2}(Z_2 \to X, F_2)
$$
in $A^p(Z_1 \cap Z_2 \to X)$.
\end{lemma}

\begin{proof}
Choose proper morphisms $b_i : W_i \to \mathbf{P}^1_X$ and
$Q_i \in D(\mathcal{O}_{W_i})$ as well as closed subschemes
$T_i \subset W_{i, \infty}$ as in the construction of
the localized chern classes for $F_i$ or more generally as in
Lemma \ref{lemma-independent-loc-chern-bQ}. Choose a commutative
diagram
$$
\xymatrix{
W \ar[d]^{g_1} \ar[rd]^b \ar[r]_{g_2} & W_2 \ar[d]^{b_2} \\
W_1 \ar[r]^{b_1} & \mathbf{P}^1_X
}
$$
where all morphisms are proper and isomorphisms over
$\mathbf{A}^1_X$. For example, we can take $W$ to be the closure
of the graph of the isomorphism between
$b_1^{-1}(\mathbf{A}^1_X)$ and $b_2^{-1}(\mathbf{A}^1_X)$.
By Lemma \ref{lemma-independent-loc-chern-bQ} we may work with
$W$, $b = b_i \circ g_i$, $Lg_i^*Q_i$, and
$g_i^{-1}(T_i)$ to construct the localized chern classes
$c_p(Z_i \to X, F_i)$. Thus we reduce to the situation described
in the next paragraph.

\medskip\noindent
Assume we have
\begin{enumerate}
\item a proper morphism $b : W \to \mathbf{P}^1_X$ which is an isomorphism
over $\mathbf{A}^1_X$,
\item $E_i \subset W_\infty$ is the inverse image of $Z_i$,
\item perfect objects $Q_i \in D(\mathcal{O}_W)$ whose chern classes
are defined, such that
\begin{enumerate}
\item the restriction of $Q_i$ to $b^{-1}(\mathbf{A}^1_X)$ is
the pullback of $F_i$, and
\item there exists a closed subscheme $T_i \subset W_\infty$ containing
all points of $W_\infty$ lying over $X \setminus Z_i$ such that
$Q_i|_{T_i}$ is zero.
\end{enumerate}
\end{enumerate}
By Lemma \ref{lemma-independent-loc-chern-bQ} we have
$$
c_p(Z_i \to X, F_i) = c'_p(Q_i) =
(E_i \to Z_i)_* \circ c'_p(Q_i|_{E_i}) \circ C
$$
and
$$
P_p(Z_i \to X, F_i) = P'_p(Q_i) =
(E_i \to Z_i)_* \circ P'_p(Q_i|_{E_i}) \circ C
$$
for $i = 1, 2$. Next, we observe that
$Q = Q_1 \otimes_{\mathcal{O}_W}^\mathbf{L} Q_2$
satisfies (3)(a) and (3)(b) for $F_1 \otimes_{\mathcal{O}_X}^\mathbf{L} F_2$
and $T_1 \cup T_2$. Hence we see that
$$
c_p(Z_1 \cap Z_2 \to X, F_1 \otimes_{\mathcal{O}_X}^\mathbf{L} F_2) =
(E_1 \cap E_2 \to Z_1 \cap Z_2)_* \circ
c'_p(Q|_{E_1 \cap E_2}) \circ C
$$
and
$$
P_p(Z_1 \cap Z_2 \to X, F_1 \otimes_{\mathcal{O}_X}^\mathbf{L} F_2) =
(E_1 \cap E_2 \to Z_1 \cap Z_2)_* \circ
P'_p(Q|_{E_1 \cap E_2}) \circ C
$$
by the same lemma. By Lemma \ref{lemma-silly-tensor-product}
the classes $c'_p(Q|_{E_1 \cap E_2})$ and $P'_p(Q|_{E_1 \cap E_2})$
can be expanded in the correct manner in terms of the classes
$c'_p(Q_i|_{E_i})$ and $P'_p(Q_i|_{E_i})$. Then finally
Lemma \ref{lemma-homomorphism-final}
tells us that polynomials in $c'_p(Q_i|_{E_i})$ and $P'_p(Q_i|_{E_i})$
agree with the corresponding polynomials in
$c'_p(Q_i)$ and $P'_p(Q_i)$ as desired.
\end{proof}






\section{Blowing up at infinity}
\label{section-blowup-Z-first}

\noindent
Let $X$ be a scheme. Let $Z \subset X$ be a closed subscheme cut out
by a finite type quasi-coherent sheaf of ideals. Denote $X' \to X$
the blowing up with center $Z$. Let $b : W \to \mathbf{P}^1_X$ be the
blowing up with center $\infty(Z)$. Denote $E \subset W$ the exceptional
divisor. There is a commutative diagram
$$
\xymatrix{
X' \ar[r] \ar[d] & W \ar[d]^b \\
X \ar[r]^\infty & \mathbf{P}^1_X
}
$$
whose horizontal arrows are closed immersion
(Divisors, Lemma \ref{divisors-lemma-strict-transform}). Denote $E \subset W$
the exceptional divisor and $W_\infty \subset W$ the inverse image
of $(\mathbf{P}^1_X)_\infty$. Then the following are true
\begin{enumerate}
\item $b$ is an isomorphism over
$\mathbf{A}^1_X \cup \mathbf{P}^1_{X \setminus Z}$,
\item $X'$ is an effective Cartier divisor on $W$,
\item $X' \cap E$ is the exceptional divisor of $X' \to X$,
\item $W_\infty = X' + E$ as effective Cartier divisors on $W$,
\item $E = \underline{\text{Proj}}_Z(\mathcal{C}_{Z/X, *}[S])$ where $S$
is a variable placed in degree $1$,
\item $X' \cap E = \underline{\text{Proj}}_Z(\mathcal{C}_{Z/X, *})$,
\item
\label{item-cone-is-open}
$E \setminus X' = E \setminus (X' \cap E) =
\underline{\text{Spec}}_Z(\mathcal{C}_{Z/X, *}) = C_ZX$,
\item
\label{item-find-Z-in-blowup}
there is a closed immersion $\mathbf{P}^1_Z \to W$ whose
composition with $b$ is the inclusion morphism
$\mathbf{P}^1_Z \to \mathbf{P}^1_X$ and whose base change by $\infty$
is the composition $Z \to C_ZX \to E \to W_\infty$ where the first
arrow is the vertex of the cone.
\end{enumerate}
We recall that $\mathcal{C}_{Z/X, *}$ is the conormal algebra of $Z$ in $X$,
see Divisors, Definition \ref{divisors-definition-conormal-sheaf} and
that $C_ZX$ is the normal cone of $Z$ in $X$, see
Divisors, Definition \ref{divisors-definition-normal-cone}.

\medskip\noindent
We now give the proof of the numbered assertions above. We strongly
urge the reader to work through some examples instead of reading the
proofs.

\medskip\noindent
Part (1) follows from the corresponding assertion of Divisors, Lemma
\ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
Observe that $E \subset W$ is an effective Cartier divisor by the same lemma.

\medskip\noindent
Observe that $W_\infty$ is an effective Cartier divisor by
Divisors, Lemma \ref{divisors-lemma-blow-up-pullback-effective-Cartier}.
Since $E \subset W_\infty$ we can write $W_\infty = D + E$ for some
effective Cartier divisor $D$, see
Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}.
We will see below that $D = X'$ which will prove (2) and (4).

\medskip\noindent
Since $X'$ is the strict transform of the closed immersion
$\infty : X \to \mathbf{P}^1_X$ (see above) it follows that the exceptional
divisor of $X' \to X$ is equal to the intersection $X' \cap E$
(for example because both are cut out by the pullback of the
ideal sheaf of $Z$ to $X'$). This proves (3).

\medskip\noindent
The intersection of $\infty(Z)$ with $\mathbf{P}^1_Z$ is the effective
Cartier divisor $(\mathbf{P}^1_Z)_\infty$ hence the strict transform
of $\mathbf{P}^1_Z$ by the blowing up $b$ maps isomorphically to
$\mathbf{P}^1_Z$ (see Divisors, Lemmas \ref{divisors-lemma-strict-transform}
and \ref{divisors-lemma-blow-up-effective-Cartier-divisor}).
This gives us the morphism $\mathbf{P}^1_Z \to W$ mentioned in (8).
It is a closed immersion as $b$ is separated, see
Schemes, Lemma \ref{schemes-lemma-section-immersion}.

\medskip\noindent
Suppose that $\Spec(A) \subset X$ is an affine open and that $Z \cap \Spec(A)$
corresponds to the finitely generated ideal $I \subset A$.
An affine neighbourhood of $\infty(Z \cap \Spec(A))$ is the
affine space over $A$ with coordinate $s = T_0/T_1$. Denote
$J = (I, s) \subset A[s]$ the ideal generated by $I$ and $s$.
Let $B = A[s] \oplus J \oplus J^2 \oplus \ldots$ be the Rees algebra
of $(A[s], J)$. Observe that
$$
J^n =
I^n \oplus sI^{n - 1} \oplus s^2I^{n - 2} \ldots \oplus s^nA
\oplus s^{n + 1}A \oplus \ldots
$$
as an $A$-submodule of $A[s]$ for all $n \geq 0$. Consider the open subscheme
$$
\text{Proj}(B) = \text{Proj}(A[s] \oplus J \oplus J^2 \oplus \ldots)
\subset W
$$
Finally, denote $S$ the element $s \in J$ viewed as a degree $1$ element
of $B$.

\medskip\noindent
Since formation of $\text{Proj}$ commutes with base change
(Constructions, Lemma \ref{constructions-lemma-base-change-map-proj})
we see that
$$
E = \text{Proj}(B \otimes_{A[s]} A/I) =
\text{Proj}((A/I \oplus I/I^2 \oplus I^2/I^3 \oplus \ldots)[S])
$$
The verification that $B \otimes_{A[s]} A/I = \bigoplus J^n/J^{n + 1}$
is as given
follows immediately from our description of the powers $J^n$ above.
This proves (5) because the conormal algebra of $Z \cap \Spec(A)$
in $\Spec(A)$ corresponds to the graded $A$-algebra
$A/I \oplus I/I^2 \oplus I^2/I^3 \oplus \ldots$ by
Divisors, Lemma \ref{divisors-lemma-affine-conormal-sheaf}.

\medskip\noindent
Recall that $\text{Proj}(B)$ is covered by the affine opens
$D_+(S)$ and $D_+(f^{(1)})$ for $f \in I$ which are
the spectra of affine blowup algebras $A[s][\frac{J}{s}]$
and $A[s][\frac{J}{f}]$, see
Divisors, Lemma \ref{divisors-lemma-blowing-up-affine} and
Algebra, Definition \ref{algebra-definition-blow-up}.
We will describe each of these affine opens and this will finish the
proof.

\medskip\noindent
The open $D_+(S)$, i.e., the spectrum of $A[s][\frac{J}{s}]$.
It follows from the description of the powers of $J$ above
that
$$
A[s][\textstyle{\frac{J}{s}}] = \sum s^{-n}I^n[s] \subset A[s, s^{-1}]
$$
The element $s$ is a nonzerodivisor in this ring, defines the exceptional
divisor $E$ as well as $W_\infty$. Hence $D \cap D_+(S) = \emptyset$.
Finally, the quotient of $A[s][\frac{J}{s}]$ by $s$ is the conormal algebra
$$
A/I \oplus I/I^2 \oplus I^2/I^3 \oplus \ldots
$$
This proves (7).

\medskip\noindent
The open $D_+(f^{(1)})$, i.e., the spectrum of $A[s][\frac{J}{f}]$.
It follows from the description of the powers of $J$ above that
$$
A[s][\textstyle{\frac{J}{f}}] =
A[\textstyle{\frac{I}{f}}][\textstyle{\frac{s}{f}}]
$$
where $\frac{s}{f}$ is a variable. The element $f$ is a nonzerodivisor
in this ring whose zero scheme defines the exceptional divisor $E$.
Since $s$ defines $W_\infty$ and $s = f \cdot \frac{s}{f}$
we conclude that $\frac{s}{f}$ defines
the divisor $D$ constructed above. Then we see that
$$
D \cap D_+(f^{(1)}) = \Spec(A[\textstyle{\frac{I}{f}}])
$$
which is the corresponding open of the blowup $X'$ over $\Spec(A)$.
Namely, the surjective graded $A[s]$-algebra map
$B \to A \oplus I \oplus I^2 \oplus \ldots$
to the Rees algebra of $(A, I)$ corresponds to the closed
immersion $X' \to W$ over $\Spec(A[s])$.
This proves $D = X'$ as desired.

\medskip\noindent
Let us prove (6). Observe that the zero scheme of $\frac{s}{f}$
in the previous paragraph is the restriction of the zero scheme of $S$
on the affine open $D_+(f^{(1)})$. Hence we see that $S = 0$ defines
$X' \cap E$ on $E$. Thus (6) follows from (5).

\medskip\noindent
Finally, we have to prove the last part of (8). This is clear
because the map $\mathbf{P}^1_Z \to W$ is affine locally
given by the surjection
$$
B \to B \otimes_{A[s]} A/I =
(A/I \oplus I/I^2 \oplus I^2/I^3 \oplus \ldots)[S] \to
A/I[S]
$$
and the identification $\text{Proj}(A/I[S]) = \Spec(A/I)$.
Some details omitted.






\section{Higher codimension gysin homomorphisms}
\label{section-gysin-higher-codimension}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. In this section we are going to consider
triples
$$
(Z \to X, \mathcal{N}, \sigma : \mathcal{N}^\vee \to \mathcal{C}_{Z/X})
$$
consisting of a closed immersion $Z \to X$ and a locally free
$\mathcal{O}_Z$-module $\mathcal{N}$ and a surjection
$\sigma : \mathcal{N}^\vee \to \mathcal{C}_{Z/X}$ from the dual
of $\mathcal{N}$ to the conormal sheaf of $Z$ in $X$, see
Morphisms, Section \ref{morphisms-section-conormal-sheaf}.
We will say
$\mathcal{N}$ is a {\it virtual normal sheaf for $Z$ in $X$}.

\begin{lemma}
\label{lemma-pullback-virtual-normal-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let
$$
\xymatrix{
Z' \ar[r] \ar[d]_g & X' \ar[d]^f \\
Z \ar[r] & X
}
$$
be a cartesian diagram of schemes locally of finite type over $S$
whose horizontal arrows are closed immersions.
If $\mathcal{N}$ is a virtual normal sheaf for $Z$ in $X$, then
$\mathcal{N}' = g^*\mathcal{N}$ is a virtual normal sheaf for
$Z'$ in $X'$.
\end{lemma}

\begin{proof}
This follows from the surjectivity of the map
$g^*\mathcal{C}_{Z/X} \to \mathcal{C}_{Z'/X'}$ proved in
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial-flat}.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $\mathcal{N}$ be a virtual normal bundle
for a closed immersion $Z \to X$. In this situation we set
$$
p : N = \underline{\Spec}_Z(\text{Sym}(\mathcal{N}^\vee)) \longrightarrow Z
$$
equal to the vector bundle over $Z$
whose sections correspond to sections of $\mathcal{N}$.
In this situation we have canonical closed immersions
$$
C_ZX \longrightarrow N_ZX \longrightarrow N
$$
The first closed immersion is Divisors, Equation
(\ref{divisors-equation-normal-cone-in-normal-bundle})
and the second closed immersion corresponds to the surjection
$\text{Sym}(\mathcal{N}^\vee) \to \text{Sym}(\mathcal{C}_{Z/X})$
induced by $\sigma$.
Let
$$
b : W \longrightarrow \mathbf{P}^1_X
$$
be the blowing up in $\infty(Z)$ constructed in
Section \ref{section-blowup-Z-first}. By
Lemma \ref{lemma-gysin-at-infty}
we have a canonical bivariant class in
$$
C \in A^0(W_\infty \to X)
$$
Consider the open immersion $j : C_ZX \to W_\infty$ of
(\ref{item-cone-is-open}) and the closed immersion
$i : C_ZX \to N$ constructed above. By Lemma \ref{lemma-vectorbundle}
for every $\alpha \in \CH_k(X)$ there exists a unique
$\beta \in \CH_*(Z)$ such that
$$
i_*j^*(C \cap \alpha) = p^*\beta
$$
We set $c(Z \to X, \mathcal{N}) \cap \alpha = \beta$.

\begin{lemma}
\label{lemma-construction-gysin}
The construction above defines a bivariant class\footnote{The
notation $A^*(Z \to X)^\wedge$ is discussed in
Remark \ref{remark-completion-bivariant}.
If $X$ is quasi-compact, then $A^*(Z \to X)^\wedge = A^*(Z \to X)$.}
$$
c(Z \to X, \mathcal{N}) \in A^*(Z \to X)^\wedge
$$
and moreover the construction is compatible with base change
as in Lemma \ref{lemma-pullback-virtual-normal-sheaf}.
If $\mathcal{N}$ has constant rank $r$, then
$c(Z \to X, \mathcal{N}) \in A^r(Z \to X)$.
\end{lemma}

\begin{proof}
Since both $i_* \circ j^* \circ C$ and $p^*$ are bivariant classes
(see Lemmas \ref{lemma-flat-pullback-bivariant} and
\ref{lemma-push-proper-bivariant}) we can use the equation
$$
i_* \circ j^* \circ C  = p^* \circ c(Z \to X, \mathcal{N})
$$
(suitably interpreted) to define $c(Z \to X, \mathcal{N})$
as a bivariant class. This works because $p^*$ is always
bijective on chow groups by Lemma \ref{lemma-vectorbundle}.

\medskip\noindent
Let $X' \to X$, $Z' \to X'$, and $\mathcal{N}'$ be as in
Lemma \ref{lemma-pullback-virtual-normal-sheaf}. Write
$c = c(Z \to X, \mathcal{N})$ and $c' = c(Z' \to X', \mathcal{N}')$.
The second statement of the lemma means that $c'$ is the restriction of $c$
as in Remark \ref{remark-restriction-bivariant}. Since we claim this
is true for all $X'/X$ locally of finite type, a formal argument
shows that it suffices to check that $c' \cap \alpha' = c \cap \alpha'$
for $\alpha' \in \CH_k(X')$.
To see this, note that we have a commutative diagram
$$
\xymatrix{
C_{Z'}X' \ar[d] \ar[r] &
W'_\infty \ar[d] \ar[r] &
W' \ar[d] \ar[r] &
\mathbf{P}^1_{X'} \ar[d] \\
C_ZX \ar[r] &
W_\infty \ar[r] &
W \ar[r] &
\mathbf{P}^1_X
}
$$
which induces closed immersions:
$$
W' \to W \times_{\mathbf{P}^1_X} \mathbf{P}^1_{X'},\quad
W'_\infty \to W_\infty \times_X X',\quad
C_{Z'}X' \to C_ZX \times_Z Z'
$$
To get $c \cap \alpha'$ we use the class $C \cap \alpha'$
defined using the morphism
$W \times_{\mathbf{P}^1_X} \mathbf{P}^1_{X'} \to \mathbf{P}^1_{X'}$
in Lemma \ref{lemma-gysin-at-infty}.
To get $c' \cap \alpha'$ on the other hand, we use the class
$C' \cap \alpha'$ defined using the morphism $W' \to \mathbf{P}^1_{X'}$.
By Lemma \ref{lemma-gysin-at-infty-independent} the pushforward of
$C' \cap \alpha'$ by the closed immersion
$W'_\infty \to (W \times_{\mathbf{P}^1_X} \mathbf{P}^1_{X'})_\infty$,
is equal to $C \cap \alpha'$. Hence the same is true for the pullbacks
to the opens
$$
C_{Z'}X' \subset W'_\infty,\quad
C_ZX \times_Z Z' \subset (W \times_{\mathbf{P}^1_X} \mathbf{P}^1_{X'})_\infty
$$
by Lemma \ref{lemma-flat-pullback-proper-pushforward}.
Since we have a commutative diagram
$$
\xymatrix{
C_{Z'} X' \ar[d] \ar[r] & N' \ar@{=}[d] \\
C_ZX \times_Z Z' \ar[r] & N \times_Z Z'
}
$$
these classes pushforward to the same class on $N'$ which
proves that we obtain the same element $c \cap \alpha' = c' \cap \alpha'$
in $\CH_*(Z')$.
\end{proof}

\begin{lemma}
\label{lemma-gysin-decompose}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $\mathcal{N}$ be a virtual normal
sheaf for a closed subscheme $Z$ of $X$. Suppose that we have a short
exact sequence $0 \to \mathcal{N}' \to \mathcal{N} \to \mathcal{E} \to 0$
of finite locally free $\mathcal{O}_Z$-modules such that the given surjection
$\sigma : \mathcal{N}^\vee \to \mathcal{C}_{Z/X}$ factors through a map
$\sigma' : (\mathcal{N}')^\vee \to \mathcal{C}_{Z/X}$.
Then
$$
c(Z \to X, \mathcal{N}) = c_{top}(\mathcal{E}) \circ c(Z \to X, \mathcal{N}')
$$
as bivariant classes.
\end{lemma}

\begin{proof}
Denote $N' \to N$ the closed immersion of vector bundles corresponding
to the surjection $\mathcal{N}^\vee \to (\mathcal{N}')^\vee$. Then we
have closed immersions
$$
C_ZX \to N' \to N
$$
Thus the desired relationship between the bivariant classes follows
immediately from Lemma \ref{lemma-easy-virtual-class}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-excess}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Consider
a cartesian diagram
$$
\xymatrix{
Z' \ar[r] \ar[d]_g & X' \ar[d]^f \\
Z \ar[r] & X
}
$$
of schemes locally of finite type over $S$ whose horizontal arrows
are closed immersions. Let $\mathcal{N}$, resp.\ $\mathcal{N}'$
be a virtual normal sheaf for $Z \subset X$, resp.\ $Z' \to X'$.
Assume given a short exact sequence
$0 \to \mathcal{N}' \to g^*\mathcal{N} \to \mathcal{E} \to 0$
of finite locally free modules on $Z'$ such that the diagram
$$
\xymatrix{
g^*\mathcal{N}^\vee \ar[r] \ar[d] &
(\mathcal{N}')^\vee \ar[d] \\
g^*\mathcal{C}_{Z/X} \ar[r] &
\mathcal{C}_{Z'/X'}
}
$$
commutes. Then we have
$$
res(c(Z \to X, \mathcal{N})) =
c_{top}(\mathcal{E}) \circ c(Z' \to X', \mathcal{N}')
$$
in $A^*(Z' \to X')^\wedge$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-construction-gysin} we have
$res(c(Z \to X, \mathcal{N})) = c(Z' \to X', g^*\mathcal{N})$
and the equality follows from Lemma \ref{lemma-gysin-decompose}.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $\mathcal{N}$ be a virtual normal
sheaf for a closed subscheme $Z$ of $X$. Let $Y \to X$ be a morphism
which is locally of finite type. Assume $Z \times_X Y \to Y$ is a
regular closed immersion, see
Divisors, Section \ref{divisors-section-regular-immersions}.
In this case the conormal sheaf $\mathcal{C}_{Z \times_X Y/Y}$ is a finite
locally free $\mathcal{O}_{Z \times_X Y}$-module and we obtain a short
exact sequence
$$
0 \to \mathcal{E}^\vee \to
\mathcal{N}^\vee|_{Z \times_X Y} \to \mathcal{C}_{Z \times_X Y/Y} \to 0
$$
The quotient $\mathcal{N}|_{Y \times_X Z} \to \mathcal{E}$ is called the
{\it excess normal sheaf} of the situation.

\begin{lemma}
\label{lemma-gysin-fundamental}
In the situation described just above assume $\dim_\delta(Y) = n$
and that $\mathcal{C}_{Y \times_X Z/Z}$ has constant rank $r$.
Then
$$
c(Z \to X, \mathcal{N}) \cap [Y]_n =
c_{top}(\mathcal{E}) \cap [Z \times_X Y]_{n - r}
$$
in $\CH_*(Z \times_X Y)$.
\end{lemma}

\begin{proof}
The bivariant class $c_{top}(\mathcal{E}) \in A^*(Z \times_X Y)$ was
defined in Remark \ref{remark-top-chern-class}.
By Lemma \ref{lemma-construction-gysin} we may replace $X$ by $Y$.
Thus we may assume $Z \to X$ is a regular closed immersion
of codimension $r$, we have $\dim_\delta(X) = n$, and we have
to show that $c(Z \to X, \mathcal{N}) \cap [X]_n =
c_{top}(\mathcal{E}) \cap [Z]_{n - r}$ in $\CH_*(Z)$.
By Lemma \ref{lemma-gysin-decompose} we may even assume
$\mathcal{N}^\vee \to \mathcal{C}_{Z/X}$ is an isomorphism.
In other words, we have to show
$c(Z \to X, \mathcal{C}_{Z/X}^\vee) \cap [X]_n = [Z]_{n - r}$ in $\CH_*(Z)$.

\medskip\noindent
Let us trace through the steps in the definition of
$c(Z \to X, \mathcal{C}_{Z/X}^\vee) \cap [X]_n$. Let
$b : W \to \mathbf{P}^1_X$
be the blowing up of $\infty(Z)$. We first have to compute
$C \cap [X]_n$ where $C \in A^0(W_\infty \to X)$ is
the class of Lemma \ref{lemma-gysin-at-infty}.
To do this, note that $[W]_{n + 1}$
is a cycle on $W$ whose restriction to $\mathbf{A}^1_X$ is
equal to the flat pullback of $[X]_n$. Hence $C \cap [X]_n$
is equal to $i_\infty^*[W]_{n + 1}$. Since $W_\infty$ is an
effective Cartier divisor on $W$ we have
$i_\infty^*[W]_{n + 1} = [W_\infty]_n$, see Lemma \ref{lemma-easy-gysin}.
The restriction of this class to the open $C_ZX \subset W_\infty$
is of course just $[C_ZX]_n$. Because $Z \subset X$ is regularly
embedded we have
$$
\mathcal{C}_{Z/X, *} = \text{Sym}(\mathcal{C}_{Z/X})
$$
as graded $\mathcal{O}_Z$-algebras, see
Divisors, Lemma \ref{divisors-lemma-quasi-regular-immersion}.
Hence $p : N = C_ZX \to Z$ is the structure morphism of the
vector bundle associated to the finite locally free module
$\mathcal{C}_{Z/X}$ of rank $r$. Then it is clear that
$p^*[Z]_{n - r} = [C_ZX]_n$ and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-gysin-easy}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $\mathcal{N}$ be a virtual normal
sheaf for a closed subscheme $Z$ of $X$. Let $Y \to X$ be a morphism
which is locally of finite type. Given integers $r$, $n$ assume
\begin{enumerate}
\item $\mathcal{N}$ is locally free of rank $r$,
\item every irreducible component of $Y$ has $\delta$-dimension $n$,
\item $\dim_\delta(Z \times_X Y) \leq n - r$, and
\item for $\xi \in Z \times_X Y$ with $\delta(\xi) = n - r$
the local ring $\mathcal{O}_{Y, \xi}$ is Cohen-Macaulay.
\end{enumerate}
Then $c(Z \to X, \mathcal{N}) \cap [Y]_n = [Z \times_X Y]_{n - r}$
in $\CH_{n - r}(Z \times_X Y)$.
\end{lemma}

\begin{proof}
The statement makes sense as $Z \times_X Y$ is a closed subscheme of $Y$.
Because $\mathcal{N}$ has rank $r$ we know that
$c(Z \to X, \mathcal{N}) \cap [Y]_n$ is in $\CH_{n - r}(Z \times_X Y)$.
Since $\dim_\delta(Z \cap Y) \leq n - r$ the chow group
$\CH_{n - r}(Z \times_X Y)$ is freely generated by the
cycle classes of the irreducible components $W \subset Z \times_X Y$
of $\delta$-dimension $n - r$. Let $\xi \in W$ be the generic point.
By assumption (2) we see that $\dim(\mathcal{O}_{Y, \xi}) = r$.
On the other hand, since $\mathcal{N}$ has rank $r$ and since
$\mathcal{N}^\vee \to \mathcal{C}_{Z/X}$ is surjective, we see that
the ideal sheaf of $Z$ is locally cut out by $r$ equations.
Hence the quasi-coherent ideal sheaf $\mathcal{I} \subset \mathcal{O}_Y$
of $Z \times_X Y$ in $Y$ is locally generated by $r$ elements.
Since $\mathcal{O}_{Y, \xi}$ is Cohen-Macaulay of dimension $r$
and since $\mathcal{I}_\xi$ is an ideal of definition (as $\xi$ is
a generic point of $Z \times_X Y$) it follows that $\mathcal{I}_\xi$
is generated by a regular sequence
(Algebra, Lemma \ref{algebra-lemma-reformulate-CM}).
By Divisors, Lemma \ref{divisors-lemma-Noetherian-scheme-regular-ideal}
we see that $\mathcal{I}$ is generated by a regular sequence over
an open neighbourhood $V \subset Y$ of $\xi$. By our description of
$\CH_{n - r}(Z \times_X Y)$ it suffices to show that
$c(Z \to X, \mathcal{N}) \cap [V]_n = [Z \times_X V]_{n - r}$
in $\CH_{n - r}(Z \times_X V)$. This follows from
Lemma \ref{lemma-gysin-fundamental}
because the excess normal sheaf is $0$ over $V$.
\end{proof}

\begin{lemma}
\label{lemma-gysin-agrees}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$
be a triple as in Definition \ref{definition-gysin-homomorphism}.
The gysin homomorphism $i^*$ viewed as an element of $A^1(D \to X)$
(see Lemma \ref{lemma-gysin-bivariant}) is the same as the bivariant class
$c(D \to X, \mathcal{N}) \in A^1(D \to X)$
constructed using $\mathcal{N} = i^*\mathcal{L}$
viewed as a virtual normal sheaf for $D$ in $X$.
\end{lemma}

\begin{proof}
We will use the criterion of Lemma \ref{lemma-bivariant-zero}.
Thus we may assume that $X$ is an integral scheme and
we have to show that $i^*[X]$ is equal to $c \cap [X]$.
Let $n = \dim_\delta(X)$. As usual, there are two cases.

\medskip\noindent
If $X = D$, then we see that both classes are represented by
$c_1(\mathcal{N}) \cap [X]_n$. See Lemma \ref{lemma-gysin-fundamental}
and Definition \ref{definition-gysin-homomorphism}.

\medskip\noindent
If $D \not = X$, then $D \to X$ is an effective Cartier divisor
and in particular a regular closed immersion of codimension $1$.
Again by Lemma \ref{lemma-gysin-fundamental} we conclude
$c(D \to X, \mathcal{N}) \cap [X]_n = [D]_{n - 1}$. The same
is true by definition for the gysin homomorphism and we conclude
once again.
\end{proof}

\begin{lemma}
\label{lemma-gysin-commutes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be a scheme
locally of finite type over $S$. Let $Z \subset X$ be a closed subscheme
with virtual normal sheaf $\mathcal{N}$. Let $Y \to X$ be locally of
finite type and $c \in A^*(Y \to X)$. Then $c$ and $c(Z \to X, \mathcal{N})$
commute (Remark \ref{remark-bivariant-commute}).
\end{lemma}

\begin{proof}
To check this we may use Lemma \ref{lemma-bivariant-zero}.
Thus we may assume $X$ is an integral scheme and we have to show
$c \cap c(Z \to X, \mathcal{N}) \cap [X] =
c(Z \to X, \mathcal{N}) \cap c \cap [X]$ in $\CH_*(Z \times_X Y)$.

\medskip\noindent
If $Z = X$, then $c(Z \to X, \mathcal{N}) = c_{top}(\mathcal{N})$ by
Lemma \ref{lemma-gysin-fundamental} which commutes
with the bivariant class $c$, see Lemma \ref{lemma-cap-commutative-chern}.

\medskip\noindent
Assume that $Z$ is not equal to $X$. By Lemma \ref{lemma-bivariant-zero}
it even suffices to prove the result after blowing up $X$ (in a nonzero ideal).
Let us blowup $X$ in the ideal sheaf of $Z$. This reduces us to the case
where $Z$ is an effective Cartier divisor, see
Divisors, Lemma
\ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor},

\medskip\noindent
If $Z$ is an effective Cartier divisor, then we have
$$
c(Z \to X, \mathcal{N}) =
c_{top}(\mathcal{E}) \circ i^*
$$
where $i^* \in A^1(Z \to X)$ is the gysin homomorphism
associated to $i : Z \to X$ (Lemma \ref{lemma-gysin-bivariant})
and $\mathcal{E}$ is the dual of the kernel of
$\mathcal{N}^\vee \to \mathcal{C}_{Z/X}$, see
Lemmas \ref{lemma-gysin-decompose} and \ref{lemma-gysin-agrees}.
Then we conclude because chern classes are in the center of the
bivariant ring (in the strong sense formulated in
Lemma \ref{lemma-cap-commutative-chern}) and $c$ commutes
with the gysin homomorphism $i^*$ by definition of bivariant classes.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be an
integral scheme locally of finite type over $S$ of $\delta$-dimension $n$.
Let $Z \subset Y \subset X$ be closed subschemes which are both effective
Cartier divisors in $X$. Denote $o : Y \to C_Y X$ the zero section of the
normal line cone of $Y$ in $X$. As $C_YX$ is a line bundle over $Y$
we obtain a bivariant class $o^* \in A^1(Y \to C_YX)$, see
Lemma \ref{lemma-gysin-bivariant}.

\begin{lemma}
\label{lemma-relation-normal-cones}
With notation as above we have
$$
o^*[C_ZX]_n = [C_Z Y]_{n - 1}
$$
in $\CH_{n - 1}(Y \times_{o, C_Y X} C_ZX)$.
\end{lemma}

\begin{proof}
Denote $W \to \mathbf{P}^1_X$ the blowing up of $\infty(Z)$ as in
Section \ref{section-blowup-Z-first}.
Similarly, denote $W' \to \mathbf{P}^1_X$ the blowing up of $\infty(Y)$.
Since $\infty(Z) \subset \infty(Y)$ we get an opposite inclusion
of ideal sheaves and hence a map of the graded algebras
defining these blowups. This produces a rational morphism from $W$
to $W'$ which in fact has a canonical representative
$$
W \supset U \longrightarrow W'
$$
See Constructions, Lemma \ref{constructions-lemma-morphism-relative-proj}.
A local calculation (omitted) shows that $U$ contains at least all points
of $W$ not lying over $\infty$ and the open subscheme $C_Z X$ of the special
fibre. After shrinking $U$ we may assume $U_\infty = C_Z X$ and
$\mathbf{A}^1_X \subset U$. Another local calculation (omitted)
shows that the morphism $U_\infty \to W'_\infty$
induces the canonical morphism $C_Z X \to C_Y X \subset W'_\infty$
of normal cones induced by the inclusion of ideals sheaves
coming from $Z \subset Y$. Denote $W'' \subset W$ the strict transform of
$\mathbf{P}^1_Y \subset \mathbf{P}^1_X$ in $W$. Then $W''$ is the blowing
up of $\mathbf{P}^1_Y$ in $\infty(Z)$ by
Divisors, Lemma \ref{divisors-lemma-strict-transform}
and hence $(W'' \cap U)_\infty = C_ZY$.

\medskip\noindent
Consider the effective Cartier divisor $i : \mathbf{P}^1_Y \to W'$
from (\ref{item-find-Z-in-blowup}) and its associated bivariant class
$i^* \in A^1(\mathbf{P}^1_Y \to W')$ from Lemma \ref{lemma-gysin-bivariant}.
We similarly denote $(i'_\infty)^* \in A^1(W'_\infty \to W')$ the
gysin map at infinity. Observe that the restriction of $i'_\infty$
(Remark \ref{remark-restriction-bivariant}) to $U$ is the restriction of
$i_\infty^* \in A^1(W_\infty \to W)$ to $U$. On the one hand we have
$$
(i'_\infty)^* i^* [U]_{n + 1} =
i_\infty^* i^* [U]_{n + 1} =
i_\infty^* [(W'' \cap U)_\infty]_{n + 1} =
[C_ZY]_n
$$
because $i_\infty^*$ kills all classes supported over $\infty$, because
$i^*[U]$ and $[W'']$ agree as cycles over $\mathbf{A}^1$, and because
$C_ZY$ is the fibre of $W'' \cap U$ over $\infty$.
On the other hand, we have
$$
(i'_\infty)^* i^* [U]_{n + 1} =
i^* i_\infty^*[U]_{n + 1} =
i^* [U_\infty] =
o^*[C_YX]_n
$$
because $(i'_\infty)^*$ and $i^*$ commute
(Lemma \ref{lemma-gysin-commutes-gysin})
and because the fibre of $i : \mathbf{P}^1_Y \to W'$ over $\infty$
factors as $o : Y \to C_YX$ and the open immersion $C_YX \to W'_\infty$.
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-gysin-composition}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $Z \subset Y \subset X$ be closed subschemes of a scheme locally
of finite type over $S$.
Let $\mathcal{N}$ be a virtual normal sheaf for $Z \subset X$.
Let $\mathcal{N}'$ be a virtual normal sheaf for $Z \subset Y$.
Let $\mathcal{N}''$ be a virtual normal sheaf for $Y \subset X$.
Assume there is a commutative diagram
$$
\xymatrix{
(\mathcal{N}'')^\vee|_Z \ar[r] \ar[d] &
\mathcal{N}^\vee \ar[r] \ar[d] &
(\mathcal{N}')^\vee \ar[d] \\
\mathcal{C}_{Y/X}|_Z \ar[r] &
\mathcal{C}_{Z/X} \ar[r] &
\mathcal{C}_{Z/Y}
}
$$
where the sequence at the bottom is from More on Morphisms, Lemma
\ref{more-morphisms-lemma-transitivity-conormal} and the top
sequence is a short exact sequence. Then
$$
c(Z \to X, \mathcal{N}) =
c(Z \to Y, \mathcal{N}') \circ c(Y \to X, \mathcal{N}'')
$$
in $A^*(Z \to X)^\wedge$.
\end{lemma}

\begin{proof}
Observe that the assumptions remain satisfied after any base change
by a morphism $X' \to X$ which is locally of finite type (the short
exact sequence of virtual normal sheaves is locally split hence
remains exact after any base change). Thus to check the
equality of bivariant classes we may use Lemma \ref{lemma-bivariant-zero}.
Thus we may assume $X$ is an integral scheme and we have to show
$c(Z \to X, \mathcal{N}) \cap [X] =
c(Z \to Y, \mathcal{N}') \cap c(Y \to X, \mathcal{N}'') \cap [X]$.

\medskip\noindent
If $Y = X$, then we have
\begin{align*}
c(Z \to Y, \mathcal{N}') \cap c(Y \to X, \mathcal{N}'') \cap [X]
& =
c(Z \to Y, \mathcal{N}') \cap c_{top}(\mathcal{N}'') \cap [Y] \\
& =
c_{top}(\mathcal{N}''|_Z) \cap c(Z \to Y, \mathcal{N}') \cap [Y] \\
& =
c(Z \to X, \mathcal{N}) \cap [X] 
\end{align*}
The first equality by Lemma \ref{lemma-gysin-decompose}.
The second because chern classes commute with bivariant classes
(Lemma \ref{lemma-cap-commutative-chern}).
The third equality by Lemma \ref{lemma-gysin-decompose}.

\medskip\noindent
Assume $Y \not = X$. By Lemma \ref{lemma-bivariant-zero}
it even suffices to prove the result after blowing up $X$ in a nonzero ideal.
Let us blowup $X$ in the product of the ideal sheaf of $Y$ and the ideal
sheaf of $Z$. This reduces us to the case where both $Y$ and $Z$ are
effective Cartier divisors on $X$, see
Divisors, Lemmas
\ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor} and
\ref{divisors-lemma-blowing-up-two-ideals}.

\medskip\noindent
Denote $\mathcal{N}'' \to \mathcal{E}$ the surjection of finite locally
free $\mathcal{O}_Z$-modules such that
$0 \to \mathcal{E}^\vee \to (\mathcal{N}'')^\vee \to \mathcal{C}_{Y/X} \to 0$
is a short exact sequence. Then $\mathcal{N} \to \mathcal{E}|_Z$
is a surjection as well. Denote $\mathcal{N}_1$ the finite locally free kernel
of this map and observe that $\mathcal{N}^\vee \to \mathcal{C}_{Z/X}$
factors through $\mathcal{N}_1$.
By Lemma \ref{lemma-gysin-decompose} we have
$$
c(Y \to X, \mathcal{N}'') = c_{top}(\mathcal{E}) \circ
c(Y \to X, \mathcal{C}_{Y/X}^\vee)
$$
and
$$
c(Z \to X, \mathcal{N}) = c_{top}(\mathcal{E}|_Z) \circ
c(Z \to X, \mathcal{N}_1)
$$
Since chern classes of bundles commute with bivariant classes
(Lemma \ref{lemma-cap-commutative-chern})
it suffices to prove
$$
c(Z \to X, \mathcal{N}_1) =
c(Z \to Y, \mathcal{N}') \circ c(Y \to X, \mathcal{C}_{Y/X}^\vee)
$$
in $A^*(Z \to X)$. This we may assume that $\mathcal{N}'' = \mathcal{C}_{Y/X}$.
This reduces us to the case discussed in the next paragraph.

\medskip\noindent
In this paragraph $Z$ and $Y$ are effective Cartier divisors on $X$
integral of dimension $n$, we have $\mathcal{N}'' = \mathcal{C}_{Y/X}$.
In this case $c(Y \to X, \mathcal{C}_{Y/X}^\vee) \cap [X] = [Y]_{n - 1}$ by
Lemma \ref{lemma-gysin-fundamental}. Thus we have to prove that
$c(Z \to X, \mathcal{N}) \cap [X] = c(Z \to Y, \mathcal{N}') \cap [Y]_{n - 1}$.
Denote $N$ and $N'$ the vector bundles over $Z$ associated to
$\mathcal{N}$ and $\mathcal{N}'$. Consider the commutative diagram
$$
\xymatrix{
N' \ar[r]_i &
N \ar[r] &
(C_Y X) \times_Y Z \\
C_Z Y \ar[r] \ar[u] &
C_Z X \ar[u]
}
$$
of cones and vector bundles over $Z$. Observe that $N'$ is a relative
effective Cartier divisor in $N$ over $Z$ and that
$$
\xymatrix{
N' \ar[d] \ar[r]_i & N \ar[d] \\
Z \ar[r]^-o & (C_Y X) \times_Y Z
}
$$
is cartesian where $o$ is the zero section of the line bundle
$C_Y X$ over $Y$. By
Lemma \ref{lemma-relation-normal-cones} we have $o^*[C_ZX]_n = [C_Z Y]_{n - 1}$
in
$$
\CH_{n - 1}(Y \times_{o, C_Y X} C_ZX) =
\CH_{n - 1}(Z \times_{o, (C_Y X) \times_Y Z} C_ZX)
$$
By the cartesian property of
the square above this implies that
$$
i^*[C_ZX]_n = [C_Z Y]_{n - 1}
$$
in $\CH_{n - 1}(N')$. Now observe that
$\gamma = c(Z \to X, \mathcal{N}) \cap [X]$ and
$\gamma' = c(Z \to Y, \mathcal{N}') \cap [Y]_{n - 1}$
are characterized by $p^*\gamma = [C_Z X]_n$ in $\CH_n(N)$
and by $(p')^*\gamma' = [C_Z Y]_{n - 1}$ in $\CH_{n - 1}(N')$.
Hence the proof is finished as $i^* \circ p^* = (p')^*$ by
Lemma \ref{lemma-relative-effective-cartier}.
\end{proof}

\begin{remark}[Variant for immersions]
\label{remark-gysin-for-immersion}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $i : Z \to X$ be an immersion of schemes.
In this situation
\begin{enumerate}
\item the conormal sheaf $\mathcal{C}_{Z/X}$
of $Z$ in $X$ is defined
(Morphisms, Definition \ref{morphisms-definition-conormal-sheaf}),
\item we say a pair consisting of a finite locally free $\mathcal{O}_Z$-module
$\mathcal{N}$ and a surjection $\sigma : \mathcal{N}^\vee \to \mathcal{C}_{Z/X}$
is a virtual normal bundle for the immersion $Z \to X$,
\item choose an open subscheme $U \subset X$ such that $Z \to X$
factors through a closed immersion $Z \to U$ and set
$c(Z \to X, \mathcal{N}) = c(Z \to U, \mathcal{N}) \circ (U \to X)^*$.
\end{enumerate}
The bivariant class $c(Z \to X, \mathcal{N})$ does not depend on the choice
of the open subscheme $U$. All of the lemmas have immediate counterparts
for this slightly more general construction. We omit the details.
\end{remark}







\section{Calculating some classes}
\label{section-calculate}

\noindent
To get further we need to compute the values of some of the
classes we've constructed above.

\begin{lemma}
\label{lemma-compute-koszul}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$
be a scheme locally of finite type over $S$. Let $\mathcal{E}$
be a locally free $\mathcal{O}_X$-module of rank $r$.
Then
$$
\prod\nolimits_{n = 0, \ldots, r} c(\wedge^n \mathcal{E})^{(-1)^n} =
1 - (r - 1)! c_r(\mathcal{E}) + \ldots
$$
\end{lemma}

\begin{proof}
By the splitting principle we can turn this into a calculation in the
polynomial ring on the chern roots $x_1, \ldots, x_r$ of $\mathcal{E}$. See
Section \ref{section-splitting-principle}. Observe that
$$
c(\wedge^n \mathcal{E}) =
\prod\nolimits_{1 \leq i_1 < \ldots < i_n \leq r}
(1 + x_{i_1} + \ldots + x_{i_n})
$$
Thus the logarithm of the left hand side of the equation in the lemma is
$$
-
\sum\nolimits_{p \geq 1}
\sum\nolimits_{n = 0}^r
\sum\nolimits_{1 \leq i_1 < \ldots < i_n \leq r}
\frac{(-1)^{p + n}}{p}(x_{i_1} + \ldots + x_{i_n})^p
$$
Please notice the minus sign in front. However, we have
$$
\sum\nolimits_{p \geq 0}
\sum\nolimits_{n = 0}^r
\sum\nolimits_{1 \leq i_1 < \ldots < i_n \leq r}
\frac{(-1)^{p + n}}{p!}(x_{i_1} + \ldots + x_{i_n})^p
=
\prod (1 - e^{-x_i})
$$
Hence we see that the first nonzero term in our chern class
is in degree $r$ and equal to the predicted value.
\end{proof}

\begin{lemma}
\label{lemma-compute-section}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$
be a scheme locally of finite type over $S$. Let $\mathcal{C}$
be a locally free $\mathcal{O}_X$-module of rank $r$. Consider the
morphisms
$$
X = \underline{\text{Proj}}_X(\mathcal{O}_X[T])
\xrightarrow{i}
E = \underline{\text{Proj}}_X(\text{Sym}^*(\mathcal{C})[T])
\xrightarrow{\pi}
X
$$
Then $c_t(i_*\mathcal{O}_X) = 0$ for $t = 1, \ldots, r - 1$ and in
$A^0(C \to E)$ we have
$$
p^* \circ \pi_* \circ c_r(i_*\mathcal{O}_X) = (-1)^{r - 1}(r - 1)! j^*
$$
where
$j : C \to E$ and $p : C \to X$ are the inclusion and structure
morphism of the vector bundle
$C = \underline{\Spec}(\text{Sym}^*(\mathcal{C}))$.
\end{lemma}

\begin{proof}
The canonical map $\pi^*\mathcal{C} \to \mathcal{O}_E(1)$ vanishes
exactly along $i(X)$. Hence the Koszul complex on the map
$$
\pi^*\mathcal{C} \otimes \mathcal{O}_E(-1) \to \mathcal{O}_E
$$
is a resolution of $i_*\mathcal{O}_X$. In particular we see that
$i_*\mathcal{O}_X$ is a perfect object of $D(\mathcal{O}_E)$
whose chern classes are defined. The vanishing of $c_t(i_*\mathcal{O}_X)$
for $t = 1, \ldots, t - 1$ follows from Lemma \ref{lemma-compute-koszul}.
This lemma also gives
$$
c_r(i_*\mathcal{O}_X) = - (r - 1)!
c_r(\pi^*\mathcal{C} \otimes \mathcal{O}_E(-1))
$$
On the other hand, by Lemma \ref{lemma-chern-classes-dual} we have
$$
c_r(\pi^*\mathcal{C} \otimes \mathcal{O}_E(-1)) =
(-1)^r c_r(\pi^*\mathcal{C}^\vee \otimes \mathcal{O}_E(1))
$$
and $\pi^*\mathcal{C}^\vee \otimes \mathcal{O}_E(1)$ has a section $s$
vanishing exactly along $i(X)$.

\medskip\noindent
After replacing $X$ by a scheme locally of finite type over $X$,
it suffices to prove that both sides of the equality have the
same effect on an element $\alpha \in \CH_*(E)$. Since $C \to X$
is a vector bundle, every cycle class on $C$ is of the form $p^*\beta$
for some $\beta \in \CH_*(X)$ (Lemma \ref{lemma-vectorbundle}).
Hence by Lemma \ref{lemma-restrict-to-open}
we can write $\alpha = \pi^*\beta + \gamma$ where $\gamma$
is supported on $E \setminus C$. Using the equalities above
it suffices to show that
$$
p^*(\pi_*(c_r(\pi^*\mathcal{C}^\vee \otimes \mathcal{O}_E(1)) \cap [W])) =
j^*[W]
$$
when $W \subset E$ is an integral closed subscheme which
is either (a) disjoint from $C$ or (b) is of the form $W = \pi^{-1}Y$
for some integral closed subscheme $Y \subset X$.
Using the section $s$ and Lemma \ref{lemma-top-chern-class} we find
in case (a) $c_r(\pi^*\mathcal{C}^\vee \otimes \mathcal{O}_E(1)) \cap [W] = 0$
and in case (b)
$c_r(\pi^*\mathcal{C}^\vee \otimes \mathcal{O}_E(1)) \cap [W] = [i(Y)]$.
The result follows easily from this; details omitted.
\end{proof}

\begin{lemma}
\label{lemma-agreement-with-loc-chern}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $i : Z \to X$
be a regular closed immersion of codimension $r$
between schemes locally of finite type over $S$.
Let $\mathcal{N} = \mathcal{C}_{Z/X}^\vee$ be the normal sheaf. If $X$
is quasi-compact and has the resolution property, then
$c_t(Z \to X, i_*\mathcal{O}_Z) = 0$ for $t = 1, \ldots, r - 1$ and
$$
c_r(Z \to X, i_*\mathcal{O}_Z) = (-1)^{r - 1} (r - 1)! c(Z \to X, \mathcal{N})
\quad\text{in}\quad
A^r(Z \to X)
$$
where $c_t(Z \to X, i_*\mathcal{O}_Z)$
is the localized chern class
of Definition \ref{definition-localized-chern}.
\end{lemma}

\begin{proof}
For any $x \in Z$ we can choose an affine open neighbourhood
$\Spec(A) \subset X$ such that $Z \cap \Spec(A) = V(f_1, \ldots, f_r)$
where $f_1, \ldots, f_r \in A$ is a regular sequence.
See Divisors, Definition \ref{divisors-definition-regular-immersion} and
Lemma \ref{divisors-lemma-Noetherian-scheme-regular-ideal}.
Then we see that the Koszul complex on $f_1, \ldots, f_r$ is
a resolution of $A/(f_1, \ldots, f_r)$ for example by
More on Algebra, Lemma \ref{more-algebra-lemma-regular-koszul-regular}.
Hence $A/(f_1, \ldots, f_r)$ is perfect as an $A$-module.
It follows that $F = i_*\mathcal{O}_Z$ is a perfect object of
$D(\mathcal{O}_X)$ whose restriction to $X \setminus Z$ is zero.
Since $X$ is quasi-compact and quasi-separated
(Properties, Lemma \ref{properties-lemma-locally-Noetherian-quasi-separated})
and has the resolution property we see that $F = i_*\mathcal{O}_Z$ can be
represented by a bounded complex of finite locally free modules
(Derived Categories of Schemes, Lemma
\ref{perfect-lemma-construct-strictly-perfect}) and hence
the chern classes of $F = i_*\mathcal{O}_Z$ are defined
(Definition \ref{definition-defined-on-perfect}). All in all
we conclude that the statement makes sense.

\medskip\noindent
Denote $b : W \to \mathbf{P}^1_X$ the blowing up in $\infty(Z)$
as in Section \ref{section-blowup-Z-first}. By (\ref{item-find-Z-in-blowup})
we have a closed immersion
$$
i' : \mathbf{P}^1_Z \longrightarrow W
$$
We claim that $Q = i'_*\mathcal{O}_{\mathbf{P}^1_Z}$
is a perfect object of
$D(\mathcal{O}_W)$ and that $F$ and $Q$ satisfy the assumptions of
Lemma \ref{lemma-independent-loc-chern-bQ}.

\medskip\noindent
Assume the claim. The output of Lemma \ref{lemma-independent-loc-chern-bQ}
is that we have
$$
c_p(Z \to X, F) = c'_p(Q) = (E \to Z)_* \circ c'_p(Q|_E) \circ C
$$
for all $p \geq 1$. Observe that $Q|_E$ is equal to the pushforward of
the structure sheaf of $Z$ via the morphism $Z \to E$ which is the
base change of $i'$ by $\infty$.
Thus the vanishing of $c_t(Z \to X, F)$ for $1 \leq t \leq r - 1$
by Lemma \ref{lemma-compute-section} applied to $E \to Z$.
Because $\mathcal{C}_{Z/X} = \mathcal{N}^\vee$
is locally free the bivariant class $c(Z \to X, \mathcal{N})$
is characterized by the relation
$$
j^* \circ C = p^* \circ c(Z \to X, \mathcal{N})
$$
where $j : C_ZX \to W_\infty$ and $p : C_ZX \to Z$ are the given maps.
(Recall $C \in A^0(W_\infty \to X)$ is the class of
Lemma \ref{lemma-gysin-at-infty}.)
Thus the displayed equation in the statement of the lemma
follows from the corresponding equation in Lemma \ref{lemma-compute-section}.

\medskip\noindent
Proof of the claim. Let $A$ and $f_1, \ldots, f_r$ be as above.
Consider the affine open $\Spec(A[s]) \subset \mathbf{P}^1_X$
as in Section \ref{section-blowup-Z-first}. Recall that $s = 0$
defines $(\mathbf{P}^1_X)_\infty$ over this open. Hence over
$\Spec(A[s])$ we are blowing up in the ideal generated by
the regular sequence $s, f_1, \ldots, f_r$. By More on Algebra, Lemma
\ref{more-algebra-lemma-blowup-regular-sequence} the $r + 1$
affine charts are global complete intersections over $A[s]$.
The chart corresponding to the affine blowup algebra
$$
A[s][f_1/s, \ldots, f_r/s] = A[s, y_1, \ldots, y_r]/(sy_i - f_i)
$$
contains $i'(Z \cap \Spec(A))$ as the closed subscheme cut out by
$y_1, \ldots, y_r$. Since $y_1, \ldots, y_r, sy_1 - f_1, \ldots, sy_r - f_r$
is a regular sequence in the polynomial ring $A[s, y_1, \ldots, y_r]$
we find that $i'$ is a regular immersion. Some details omitted.
As above we conclude that $Q = i'_*\mathcal{O}_{\mathbf{P}^1_Z}$
is a perfect object of $D(\mathcal{O}_W)$. Since $W$ also has
the resolution property (Derived Categories of Schemes,
Lemma \ref{perfect-lemma-resolution-property-ample-relative})
we find that the chern classes of $Q$ are defined. All the
other assumptions on $F$ and $Q$ in Lemma \ref{lemma-independent-loc-chern-bQ}
(and Lemma \ref{lemma-localized-chern-pre}) are immediately verified.
\end{proof}

\begin{lemma}
\label{lemma-actual-computation}
In the situation of Lemma \ref{lemma-agreement-with-loc-chern}
say $\dim_\delta(X) = n$. Then we have
\begin{enumerate}
\item $c_t(Z \to X, i_*\mathcal{O}_Z) \cap [X]_n = 0$ for
$t = 1, \ldots, r - 1$,
\item $c_r(Z \to X, i_*\mathcal{O}_Z) \cap [X]_n =
(-1)^{r - 1}(r - 1)![Z]_{n - r}$,
\item $ch_t(Z \to X, i_*\mathcal{O}_Z) \cap [X]_n = 0$ for
$t = 0, \ldots, r - 1$, and
\item $ch_r(Z \to X, i_*\mathcal{O}_Z) \cap [X]_n = [Z]_{n - r}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Parts (1) and (2) follow immediately from
Lemma \ref{lemma-agreement-with-loc-chern}
combined with Lemma \ref{lemma-gysin-fundamental}.
Then we deduce parts (3) and (4) using the relationship
between $ch_p = (1/p!)P_p$ and $c_p$ given in
Lemma \ref{lemma-loc-chern-character}. (Namely,
$(-1)^{r - 1}(r - 1)!ch_r = c_r$ provided
$c_1 = c_2 = \ldots = c_{r - 1} = 0$.)
\end{proof}







\section{An Adams operator}
\label{section-adams}

\noindent
We do the minimal amount of work to define the second adams operator.
Let $X$ be a scheme. Recall that $\textit{Vect}(X)$ denotes the
category of finite locally free $\mathcal{O}_X$-modules.
Moreover, recall that we have constructed a zeroth $K$-group
$K_0(\textit{Vect}(X))$ associated to this category in
Derived Categories of Schemes, Section \ref{perfect-section-K-groups}.
Finally, $K_0(\textit{Vect}(X))$ is a ring, see
Derived Categories of Schemes, Remark \ref{perfect-remark-K-ring}.

\begin{lemma}
\label{lemma-second-adams-operator}
Let $X$ be a scheme. There is a ring map
$$
\psi^2 :
K_0(\textit{Vect}(X))
\longrightarrow
K_0(\textit{Vect}(X))
$$
which sends $[\mathcal{L}]$ to $[\mathcal{L}^{\otimes 2}]$
when $\mathcal{L}$ is invertible and is compatible with pullbacks.
\end{lemma}

\begin{proof}
Let $X$ be a scheme.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module.
We will consider the element
$$
\psi^2(\mathcal{E}) = [\text{Sym}^2(\mathcal{E})] - [\wedge^2(\mathcal{E})]
$$
of $K_0(\textit{Vect}(X))$.

\medskip\noindent
Let $X$ be a scheme and consider a short exact sequence
$$
0 \to \mathcal{E} \to \mathcal{F} \to \mathcal{G} \to 0
$$
of finite locally free $\mathcal{O}_X$-modules. Let us think of
this as a filtration on $\mathcal{F}$ with $2$ steps. The induced
filtration on $\text{Sym}^2(\mathcal{F})$ has $3$ steps with
graded pieces $\text{Sym}^2(\mathcal{E})$, $\mathcal{E} \otimes \mathcal{F}$,
and $\text{Sym}^2(\mathcal{G})$. Hence
$$
[\text{Sym}^2(\mathcal{F})] =
[\text{Sym}^2(\mathcal{E})] +
[\mathcal{E} \otimes \mathcal{F}] +
[\text{Sym}^2(\mathcal{G})]
$$
In exactly the same manner one shows that
$$
[\wedge^2(\mathcal{F})] =
[\wedge^2(\mathcal{E})] +
[\mathcal{E} \otimes \mathcal{F}] +
[\wedge^2(\mathcal{G})]
$$
Thus we see that
$\psi^2(\mathcal{F}) = \psi^2(\mathcal{E}) + \psi^2(\mathcal{G})$.
We conclude that we obtain a well defined additive map
$\psi^2 : K_0(\textit{Vect}(X)) \to K_0(\textit{Vect}(X))$.

\medskip\noindent
It is clear that this map commutes with pullbacks.

\medskip\noindent
We still have to show that $\psi^2$ is a ring map.
Let $X$ be a scheme and let $\mathcal{E}$ and $\mathcal{F}$
be finite locally free $\mathcal{O}_X$-modules.
Observe that there is a short exact sequence
$$
0 \to \wedge^2(\mathcal{E}) \otimes \wedge^2(\mathcal{F}) \to
\text{Sym}^2(\mathcal{E} \otimes \mathcal{F}) \to
\text{Sym}^2(\mathcal{E}) \otimes \text{Sym}^2(\mathcal{F}) \to 0
$$
where the first map sends $(e \wedge e') \otimes (f \wedge f')$ to
$(e \otimes f)(e' \otimes f') - (e' \otimes f)(e \otimes f')$ and
the second map sends $(e \otimes f) (e' \otimes f')$ to $ee' \otimes ff'$.
Similarly, there is a short exact sequence
$$
0 \to \text{Sym}^2(\mathcal{E}) \otimes \wedge^2(\mathcal{F}) \to
\wedge^2(\mathcal{E} \otimes \mathcal{F}) \to
\wedge^2(\mathcal{E}) \otimes \text{Sym}^2(\mathcal{F}) \to 0
$$
where the first map sends $e e' \otimes f \wedge f'$ to
$(e \otimes f) \wedge (e' \otimes f') + (e' \otimes f) \wedge (e \otimes f')$
and the second map sends
$(e \otimes f) \wedge (e' \otimes f')$ to
$(e \wedge e') \otimes (f f')$.
As above this proves the map $\psi^2$ is multiplicative.
Since it is clear that $\psi^2(1) = 1$ this concludes the proof.
\end{proof}

\begin{remark}
\label{remark-adams-derived}
Let $X$ be a scheme such that $2$ is invertible on $X$.
Then the Adams operator $\psi^2$ can be defined on the $K$-group
$K_0(X) = K_0(D_{perf}(\mathcal{O}_X))$
(Derived Categories of Schemes, Definition \ref{perfect-definition-K-group})
in a straightforward manner.
Namely, given a perfect complex $L$ on $X$ we get an action
of the group $\{\pm 1\}$ on $L \otimes^\mathbf{L} L$ by switching
the factors. Then we can set
$$
\psi^2(L) = [(L \otimes^\mathbf{L} L)^+] -
[(L \otimes^\mathbf{L} L)^-]
$$
where $(-)^+$ denotes taking invariants and $(-)^-$ denotes taking
anti-invariants (suitably defined).
Using exactness of taking invariants and anti-invariants one can
argue similarly to the proof of Lemma \ref{lemma-second-adams-operator}
to show that this is well defined.
When $2$ is not invertible on $X$ the situation is a good deal more
complicated and another approach has to be used.
\end{remark}

\begin{lemma}
\label{lemma-minus-adams-operator}
Let $X$ be a scheme. There is a ring map
$\psi^{-1} : K_0(\textit{Vect}(X)) \to K_0(\textit{Vect}(X))$
which sends $[\mathcal{E}]$ to $[\mathcal{E}^\vee]$
when $\mathcal{E}$ is finite locally free
and is compatible with pullbacks.
\end{lemma}

\begin{proof}
The only thing to check is that taking duals is compatible with
short exact sequences and with pullbacks. This is clear.
\end{proof}

\begin{remark}
\label{remark-chern-classes-K}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. The chern class
map defines a canonical map
$$
c : K_0(\textit{Vect}(X)) \longrightarrow \prod\nolimits_{i \geq 0} A^i(X)
$$
by sending a generator $[\mathcal{E}]$ on the left hand side to
$c(\mathcal{E}) = 1 + c_1(\mathcal{E}) + c_2(\mathcal{E}) + \ldots$
and extending multiplicatively. Thus $-[\mathcal{E}]$ is sent to
the formal inverse $c(\mathcal{E})^{-1}$ which is why we have the
infinite product on the right hand side. This is well defined by
Lemma \ref{lemma-additivity-chern-classes}.
\end{remark}

\begin{remark}
\label{remark-chern-character-K}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. The chern character
map defines a canonical ring map
$$
ch : K_0(\textit{Vect}(X)) \longrightarrow
\prod\nolimits_{i \geq 0} A^i(X) \otimes \mathbf{Q}
$$
by sending a generator $[\mathcal{E}]$ on the left hand side to
$ch(\mathcal{E})$ and extending additively. This is well defined
by Lemma \ref{lemma-chern-character-additive} and a ring homomorphism by
Lemma \ref{lemma-chern-character-multiplicative}.
\end{remark}

\begin{lemma}
\label{lemma-adams-and-chern}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. If $\psi^2$ is
as in Lemma \ref{lemma-second-adams-operator} and $c$ and $ch$ are as in
Remarks \ref{remark-chern-classes-K} and \ref{remark-chern-character-K}
then we have $c_i(\psi^2(\alpha)) = 2^i c_i(\alpha)$ and
$ch_i(\psi^2(\alpha)) = 2^i ch_i(\alpha)$
for all $\alpha \in K_0(\textit{Vect}(X))$.
\end{lemma}

\begin{proof}
Observe that the map $\prod_{i \geq 0} A^i(X) \to \prod_{i \geq 0} A^i(X)$
multiplying by $2^i$ on $A^i(X)$ is a ring map. Hence, since $\psi^2$
is also a ring map, it suffices to prove the formulas for additive generators
of $K_0(\textit{Vect}(X))$. Thus we may assume $\alpha = [\mathcal{E}]$
for some finite locally free $\mathcal{O}_X$-module $\mathcal{E}$.
By construction of the chern classes of $\mathcal{E}$ we immediately
reduce to the case where $\mathcal{E}$ has constant rank $r$, see
Remark \ref{remark-extend-to-finite-locally-free}.
In this case, we can choose a projective smooth morphism $p : P \to X$
such that restriction $A^*(X) \to A^*(P)$ is injective
and such that $p^*\mathcal{E}$ has a finite filtration whose
graded parts are invertible $\mathcal{O}_P$-modules $\mathcal{L}_j$, see
Lemma \ref{lemma-splitting-principle}. Then
$[p^*\mathcal{E}] = \sum [\mathcal{L}_j]$ and hence
$\psi^2([p^\mathcal{E}]) = \sum [\mathcal{L}_j^{\otimes 2}]$
by definition of $\psi^2$. Setting $x_j  = c_1(\mathcal{L}_j)$
we have
$$
c(\alpha) = \prod (1 + x_j)
\quad\text{and}\quad
c(\psi^2(\alpha)) = \prod (1 + 2 x_j)
$$
in $\prod A^i(P)$ and we have
$$
ch(\alpha) = \sum \exp(x_j)
\quad\text{and}\quad
ch(\psi^2(\alpha)) = \sum \exp(2 x_j)
$$
in $\prod A^i(P)$. From these formulas the desired result follows.
\end{proof}

\begin{remark}
\label{remark-perf-Z-cohomology-K}
Let $X$ be a locally Noetherian scheme.
Let $Z \subset X$ be a closed subscheme. Consider the strictly
full, saturated, triangulated subcategory
$$
D_{Z, perf}(\mathcal{O}_X) \subset D(\mathcal{O}_X)
$$
consisting of perfect complexes of $\mathcal{O}_X$-modules
whose cohomology sheaves are settheoretically supported on $Z$.
Denote $\textit{Coh}_Z(X) \subset \textit{Coh}(X)$
the Serre subcategory of coherent $\mathcal{O}_X$-modules whose set theoretic
support is contained in $Z$. Observe that given
$E \in D_{Z, perf}(\mathcal{O}_X)$ Zariski locally on $X$
only a finite number of the cohomology sheaves $H^i(E)$ are nonzero
(and they are all settheoretically supported on $Z$).
Hence we can define
$$
K_0(D_{Z, perf}(\mathcal{O}_X))
\longrightarrow
K_0(\textit{Coh}_Z(X)) = K'_0(Z)
$$
(equality by Lemma \ref{lemma-K-coherent-supported-on-closed}) by the rule
$$
E \longmapsto
[\bigoplus\nolimits_{i \in \mathbf{Z}} H^{2i}(E)] -
[\bigoplus\nolimits_{i \in \mathbf{Z}} H^{2i + 1}(E)]
$$
This works because given a distinguished triangle in
$D_{Z, perf}(\mathcal{O}_X)$ we have a long exact sequence of
cohomology sheaves.
\end{remark}

\begin{remark}
\label{remark-perf-Z-regular}
Let $X$, $Z$, $D_{Z, perf}(\mathcal{O}_X)$ be as in
Remark \ref{remark-perf-Z-cohomology-K}.
Assume $X$ is Noetherian regular of finite dimension.
Then there is a canonical map
$$
K_0(\textit{Coh}(Z)) \longrightarrow K_0(D_{Z, perf}(\mathcal{O}_X))
$$
defined as follows. For any coherent $\mathcal{O}_Z$-module
$\mathcal{F}$ denote $\mathcal{F}[0]$ the object of $D(\mathcal{O}_X)$
which has $\mathcal{F}$ in degree $0$ and is zero in other degrees.
Then $\mathcal{F}[0]$ is a perfect complex on $X$ by
Derived Categories of Schemes, Lemma \ref{perfect-lemma-perfect-on-regular}.
Hence $\mathcal{F}[0]$ is an object of $D_{Z, perf}(\mathcal{O}_X)$.
On the other hand, given a short exact sequence
$0 \to \mathcal{F} \to \mathcal{F}' \to \mathcal{F}'' \to 0$ of
coherent $\mathcal{O}_Z$-modules we obtain a distinguished triangle
$\mathcal{F}[0] \to \mathcal{F}'[0] \to \mathcal{F}''[0] \to \mathcal{F}[1]$,
see Derived Categories, Section \ref{derived-section-canonical-delta-functor}.
This shows that we obtain a map
$K_0(\textit{Coh}(Z)) \to K_0(D_{Z, perf}(\mathcal{O}_X))$
by sending $[\mathcal{F}]$ to $[\mathcal{F}[0]]$
with apologies for the horrendous notation.
\end{remark}

\begin{lemma}
\label{lemma-perf-Z-regular}
Let $X$ be a Noetherian regular scheme of finite dimension.
Let $Z \subset X$ be a closed subschemes. The maps constructed
in Remarks \ref{remark-perf-Z-cohomology-K} and
\ref{remark-perf-Z-regular} are mutually inverse and we get
$K'_0(Z) = K_0(D_{Z, perf}(\mathcal{O}_X))$.
\end{lemma}

\begin{proof}
Clearly the composition
$$
K_0(\textit{Coh}(Z)) \longrightarrow
K_0(D_{Z, perf}(\mathcal{O}_X)) \longrightarrow
K_0(\textit{Coh}(Z))
$$
is the identity map. Thus it suffices to show the first arrow is
surjective. Let $E$ be an object of $D_{Z, perf}(\mathcal{O}_X)$.
We are going to use without further mention that $E$ is bounded
with coherent cohomology and that any such complex is a perfect complex.
Using the distinguished triangles of canonical truncations the
reader sees that
$$
[E] = \sum (-1)^i[H^i(E)[0]]
$$
in $K_0(D_{Z, perf}(\mathcal{O}_X))$. Then it suffices to
show that $[\mathcal{F}[0]]$ is in the image of the map
for any coherent $\mathcal{O}_X$-module set theoretically
supported on $Z$. Since we can find a finite filtration on
$\mathcal{F}$ whose subquotients are $\mathcal{O}_Z$-modules,
the proof is complete.
\end{proof}

\begin{remark}
\label{remark-localized-chern-classes-K}
Let $X$, $Z$, $D_{Z, perf}(\mathcal{O}_X)$ be as in
Remark \ref{remark-perf-Z-cohomology-K}.
Assume $X$ is quasi-compact, has the resolution property, and
is of finite type over $(S, \delta)$ as in Situation \ref{situation-setup}.
The localized chern classes define a canonical map
$$
c(Z \to X, -) : K_0(D_{Z, perf}(\mathcal{O}_X)) \longrightarrow
A^0(X) \times \prod\nolimits_{i \geq 1} A^i(Z \to X)
$$
by sending a generator $[E]$ on the left hand side to
$$
c(Z \to X, E) = 1 + c_1(Z \to X, E) + c_2(Z \to X, E) + \ldots
$$
and extending multiplicatively (with product on the right hand
side as in Remark \ref{remark-ring-loc-classes}). This makes sense because by
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-resolution-property-perfect-complex}
and Definition \ref{definition-localized-chern}
$c_i(Z \to X, E) $ are defined for all $i \geq 1$.
It is well defined by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-resolution-property-map-perfect-complex}
(every map in $D_{Z, perf}(\mathcal{O}_X)$ can be represented
by a map of bounded complexes of finite locally frees) and
Lemma \ref{lemma-additivity-loc-chern-c}.
\end{remark}

\begin{remark}
\label{remark-localized-chern-character-K}
Let $X$, $Z$, $D_{Z, perf}(\mathcal{O}_X)$
be as in Remark \ref{remark-perf-Z-cohomology-K}.
Assume $X$ is quasi-compact, has the resolution property, and is
of finite type over $(S, \delta)$ as in Situation \ref{situation-setup}.
The localized chern character defines a canonical additive
and multiplicative map
$$
ch(Z \to X, -) : K_0(D_{Z, perf}(\mathcal{O}_X)) \longrightarrow
\prod\nolimits_{i \geq 0} A^i(Z \to X)
$$
by sending a generator $[E]$ on the left hand side to
$ch(Z \to X, E)$ and extending additively. This makes sense because because
$ch(Z \to X, E)$ is defined by
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-resolution-property-perfect-complex}
and Definition \ref{definition-localized-chern}.
It is well defined by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-resolution-property-map-perfect-complex}
(every map in $D_{Z, perf}(\mathcal{O}_X)$ can be represented
by a map of bounded complexes of finite locally frees) and
Lemma \ref{lemma-additivity-loc-chern-P}. The multiplication on
$K_0(D_{Z, perf}(X))$ is defined using derived tensor product
(Derived Categories of Schemes, Remark \ref{perfect-remark-perf-Z})
hence $ch(\alpha \beta) = ch(\alpha) ch(\beta)$ by
Lemma \ref{lemma-loc-chern-tensor-product}.
\end{remark}

\begin{remark}
\label{remark-chern-classes-agree}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$ and assume $X$
is quasi-compact and has the resolution property.
With $Z = X$ and notation as in
Remarks \ref{remark-localized-chern-classes-K} and
\ref{remark-localized-chern-character-K}
we have $D_{Z, perf}(\mathcal{O}_X) = D_{perf}(\mathcal{O}_X)$
and we see that
$$
K_0(D_{Z, perf}(\mathcal{O}_X)) = K_0(D_{perf}(\mathcal{O}_X)) = K_0(X)
$$
see 
Derived Categories of Schemes, Definition \ref{perfect-definition-K-group}.
Hence we get
$c : K_0(X) \to \prod A^i(X)$ and $ch : K_0(X) \to \prod A^i(X)$ from
Remarks \ref{remark-localized-chern-classes-K} and
\ref{remark-localized-chern-character-K}.
Via the equality $K_0(\textit{Vect}(X)) = K_0(X)$ of
Derived Categories of Schemes, Lemma \ref{perfect-lemma-K-is-old-K}
these maps agree with the maps constructed in
Remarks \ref{remark-chern-classes-K} and
\ref{remark-chern-character-K}.
\end{remark}











\section{Chow groups and K-groups revisited}
\label{section-chow-and-K-II}

\noindent
This section is the continuation of Section \ref{section-chow-and-K}.
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. The K-group
$K'_0(X) = K_0(\textit{Coh}(X))$ of coherent sheaves on $X$
has a canonical increasing filtration
$$
F_kK'_0(X) =
\Im\Big(K_0(\textit{Coh}_{\leq k}(X)) \to K_0(\textit{Coh}(X)\Big)
$$
This is called the filtration by dimension of supports. Observe that
$$
\text{gr}_k K'_0(X) \subset K'_0(X)/F_{k - 1}K'_0(X) =
K_0(\textit{Coh}(X)/\textit{Coh}_{\leq k - 1}(X))
$$
where the equality holds
by Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}.
The discussion in Remark \ref{remark-good-cases-K-A} shows
that there are canonical maps
$$
\CH_k(X) \longrightarrow \text{gr}_k K'_0(X)
$$
defined by sending the class of an integral closed subscheme
$Z \subset X$ of $\delta$-dimension $k$ to the class of
$[\mathcal{O}_Z]$ on the right hand side.

\begin{proposition}
\label{proposition-K-tensor-Q}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Assume given a
closed immersion $X \to Y$ of schemes locally of finite type over $S$
with $Y$ regular, quasi-compact, affine diagonal, and
$\delta_{Y/S} : Y \to \mathbf{Z}$ bounded. Then the composition
$$
K'_0(X) \to
K_0(D_{X, perf}(\mathcal{O}_Y)) \to
A^*(X \to Y) \to
\CH_*(X)
$$
of the map $\mathcal{F} \mapsto \mathcal{F}[0]$ from
Remark \ref{remark-perf-Z-regular}, the map $ch(X \to Y, -)$ from
Remark \ref{remark-localized-chern-character-K}, and
the map $c \mapsto c \cap [Y]$ induces an isomorphism
$$
K'_0(X) \otimes \mathbf{Q}
\longrightarrow
\CH_*(X) \otimes \mathbf{Q}
$$
which depends on the choice of $Y$. Moreover, the canonical map
$$
\CH_k(X) \otimes \mathbf{Q}
\longrightarrow
\text{gr}_k K'_0(X) \otimes \mathbf{Q}
$$
(see above) is an isomorphism of $\mathbf{Q}$-vector spaces for all
$k \in \mathbf{Z}$.
\end{proposition}

\begin{proof}
Since $Y$ is regular of finite dimension, the construction in
Remark \ref{remark-perf-Z-regular} applies.
We have the resolution property for $Y$ by
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-regular-resolution-property}
and the construction in Remark \ref{remark-localized-chern-character-K}
applies. We have that $Y$ is locally equidimensional
(Lemma \ref{lemma-locally-equidimensional}) and
thus the ``fundamental cycle'' $[Y]$ is defined
as an element of $\CH_*(Y)$, see Remark \ref{remark-fundamental-class}.
Combining this with the map $\CH_k(X) \to \text{gr}_kK'_0(X)$
constructed above we see that it suffices to prove
\begin{enumerate}
\item If $\mathcal{F}$ is a coherent $\mathcal{O}_X$-module
whose support has $\delta$-dimension $\leq k$, then
the composition above sends $[\mathcal{F}]$ into
$\bigoplus_{k' \leq k} \CH_{k'}(X) \otimes \mathbf{Q}$.
\item If $Z \subset X$ is an integral closed subscheme
of $\delta$-dimension $k$, then the composition above
sends $[\mathcal{O}_Z]$ to an element whose degree $k$
part is the class of $[Z]$ in $\CH_k(X) \otimes \mathbf{Q}$.
\end{enumerate}
Namely, if this holds, then our maps induce maps
$\text{gr}_kK'_0(X) \otimes \mathbf{Q} \to CH_k(X) \otimes \mathbf{Q}$
which are inverse to the canonical maps 
$\CH_k(X) \otimes \mathbf{Q} \to \text{gr}_k K'_0(X) \otimes \mathbf{Q}$
given above the proposition.

\medskip\noindent
Given a coherent $\mathcal{O}_X$-module $\mathcal{F}$
the composition above sends $[\mathcal{F}]$ to
$$
ch(X \to Y, \mathcal{F}[0]) \cap [Y] \in \CH_*(X) \otimes \mathbf{Q}
$$
If $\mathcal{F}$ is (set theoretically) supported on a closed subscheme
$Z \subset X$, then we have
$$
ch(X \to Y, \mathcal{F}[0]) = (Z \to X)_* \circ ch(Z \to Y, \mathcal{F}[0])
$$
by Lemma \ref{lemma-loc-chern-shrink-Z}. We conclude that in this
case we end up in the image of $\CH_*(Z) \to \CH_*(X)$. Hence
we get condition (1).

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
The composition above sends $[\mathcal{O}_Z]$ to the element
$$
ch(X \to Y, \mathcal{O}_Z[0]) \cap [Y] =
(Z \to X)_* ch(Z \to Y, \mathcal{O}_Z[0]) \cap [Y]
$$
by the same argument as above.
Thus it suffices to prove that the degree $k$ part of
$ch(Z \to Y, \mathcal{O}_Z[0]) \cap [Y] \in
\CH_*(Z) \otimes \mathbf{Q}$ is $[Z]$.
Since $\CH_k(Z) = \mathbf{Z}$, in order
to prove this we may replace $Y$ by an open neighbourhood of the
generic point $\xi$ of $Z$. Since the maximal ideal of the regular
local ring $\mathcal{O}_{X, \xi}$ is generated by a
regular sequence (Algebra, Lemma \ref{algebra-lemma-regular-ring-CM})
we may assume the ideal of $Z$ is generated by a regular sequence, see
Divisors, Lemma \ref{divisors-lemma-Noetherian-scheme-regular-ideal}.
Thus we deduce the result from Lemma \ref{lemma-actual-computation}.
\end{proof}







\section{Rational intersection products on regular schemes}
\label{section-intersection-regular}

\noindent
We will show that $\CH_*(X) \otimes \mathbf{Q}$ has an intersection
product if $X$ is Noetherian, regular, finite dimensional, with
affine diagonal. The basis for the construction is the following result
(which is a corollary of the proposition in the previous section).

\begin{lemma}
\label{lemma-K-tensor-Q}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a quasi-compact regular scheme of finite type over $S$ with
affine diagonal and $\delta_{X/S} : X \to \mathbf{Z}$ bounded.
Then the composition
$$
K_0(\textit{Vect}(X)) \otimes \mathbf{Q}
\longrightarrow
A^*(X) \otimes \mathbf{Q}
\longrightarrow
\CH_*(X) \otimes \mathbf{Q}
$$
of the map $ch$ from Remark \ref{remark-chern-character-K} and
the map $c \mapsto c \cap [X]$ is an isomorphism.
\end{lemma}

\begin{proof}
We have $K'_0(X) = K_0(X) = K_0(\textit{Vect}(X))$ by
Derived Categories of Schemes, Lemmas \ref{perfect-lemma-Kprime-K} and
\ref{perfect-lemma-K-is-old-K}.
By Remark \ref{remark-chern-classes-agree}
the composition given agrees with the map of
Proposition \ref{proposition-K-tensor-Q} for $X = Y$.
Thus the result follows from the proposition.
\end{proof}

\noindent
Let $X, S, \delta$ be as in Lemma \ref{lemma-K-tensor-Q}.
For simplicity let us work with cycles of a given codimension, see
Section \ref{section-cycles-codimension}.
Let $[X]$ be the fundamental cycle of $X$, see
Remark \ref{remark-fundamental-class}.
Pick $\alpha \in CH^i(X)$ and
$\beta \in CH^j(X)$. By the lemma we can find a unique
$\alpha' \in K_0(\textit{Vect}(X)) \otimes \mathbf{Q}$ with
$ch(\alpha') \cap [X]  = \alpha$.
Of course this means that $ch_{i'}(\alpha') \cap [X] = 0$
if $i' \not = i$ and $ch_i(\alpha') \cap [X] = \alpha$.
By Lemma \ref{lemma-adams-and-chern} we see that
$\alpha'' = 2^{-i}\psi^2(\alpha')$ is another solution.
By uniqueness we get $\alpha'' = \alpha'$ and we conclude
that $ch_{i'}(\alpha) = 0$ in $A^{i'}(X) \otimes \mathbf{Q}$
for $i' \not = i$. Then we can define
$$
\alpha \cdot \beta = ch(\alpha') \cap \beta =
ch_i(\alpha') \cap \beta
$$
in $\CH^{i + j}(X) \otimes \mathbf{Q}$ by the property of $\alpha'$
we observed above. This is a symmetric pairing: namely, if we pick
$\beta' \in K_0(\textit{Vect}(X)) \otimes \mathbf{Q}$ lifting
$\beta$, then we get
$$
\alpha \cdot \beta = ch(\alpha') \cap \beta =
ch(\alpha') \cap ch(\beta') \cap [X]
$$
and we know that chern classes commute.
The intersection product is associative for the same reason
$$
(\alpha \cdot \beta) \cdot \gamma =
ch(\alpha') \cap ch(\beta') \cap ch(\gamma') \cap [X]
$$
because we know composition of bivariant classes is associative.
Perhaps a better way to formulate this is as follows: there is
a unique commutative, associative intersection product on
$\CH^*(X) \otimes \mathbf{Q}$ compatible with grading such that
the isomorphism
$K_0(\textit{Vect}(X)) \otimes \mathbf{Q} \to \CH^*(X) \otimes \mathbf{Q}$
is an isomorphism of rings.






\section{Gysin maps for local complete intersection morphisms}
\label{section-koszul}

\noindent
Before reading this section, we suggest the reader read up on
regular immersions
(Divisors, Section \ref{divisors-section-regular-immersions}) and
local complete intersection morphisms
(More on Morphisms, Section \ref{more-morphisms-section-lci}).

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $i : X \to Y$ be a
regular immersion\footnote{See
Divisors, Definition \ref{divisors-definition-regular-immersion}.
Observe that regular immersions are the same thing as
Koszul-regular immersions or quasi-regular immersions
for locally Noetherian schemes, see
Divisors, Lemma \ref{divisors-lemma-regular-immersion-noetherian}.
We will use this without further mention in this section.}
of schemes locally of finite type over $S$.
In particular, the conormal sheaf $\mathcal{C}_{X/Y}$ is finite locally free
(see Divisors, Lemma \ref{divisors-lemma-quasi-regular-immersion}). Hence the
normal sheaf
$$
\mathcal{N}_{X/Y} = \SheafHom_{\mathcal{O}_X}(\mathcal{C}_{X/Y}, \mathcal{O}_X)
$$
is finite locally free as well and we have a surjection
$\mathcal{N}_{X/Y}^\vee \to \mathcal{C}_{X/Y}$ (because an isomorphism
is also a surjection).
The construction in Section \ref{section-gysin-higher-codimension}
gives us a canonical bivariant class
$$
i^! = c(X \to Y, \mathcal{N}_{X/Y}) \in A^*(X \to Y)^\wedge
$$
We need a couple of lemmas about this notion.

\begin{lemma}
\label{lemma-composition-regular-immersion}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $i : X \to Y$ and $j : Y \to Z$ be regular immersions
of schemes locally of finite type over $S$. Then
$j \circ i$ is a regular immersion and
$(j \circ i)^! = i^! \circ j^!$.
\end{lemma}

\begin{proof}
The first statement is
Divisors, Lemma \ref{divisors-lemma-composition-regular-immersion}.
By Divisors, Lemma \ref{divisors-lemma-transitivity-conormal-quasi-regular}
there is a short exact sequence
$$
0 \to
i^*(\mathcal{C}_{Y/Z}) \to
\mathcal{C}_{X/Z} \to
\mathcal{C}_{X/Y} \to 0
$$
Thus the result by the more general Lemma \ref{lemma-gysin-composition}.
\end{proof}

\begin{lemma}
\label{lemma-section-smooth}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $p : P \to X$ be a smooth morphism of schemes locally of finite type
over $S$ and let $s : X \to P$ be a section. Then $s$ is a
regular immersion and $1 = s^! \circ p^*$ in $A^*(X)^\wedge$
where $p^* \in A^*(P \to X)^\wedge$ is the bivariant class
of Lemma \ref{lemma-flat-pullback-bivariant}.
\end{lemma}

\begin{proof}
The first statement is Divisors, Lemma
\ref{divisors-lemma-section-smooth-regular-immersion}.
It suffices to show that $s^! \cap p^*[Z] = [Z]$ in
$\CH_*(X)$ for any integral closed subscheme $Z \subset X$
as the assumptions are preserved by base change by $X' \to X$
locally of finite type. After replacing $P$ by an open neighbourhood
of $s(Z)$ we may assume $P \to X$ is smooth of fixed relative dimension $r$.
Say $\dim_\delta(Z) = n$. Then every irreducible component of $p^{-1}(Z)$
has dimension $r + n$ and $p^*[Z]$ is given by $[p^{-1}(Z)]_{n + r}$.
Observe that $s(X) \cap p^{-1}(Z) = s(Z)$ scheme theoretically. Hence by the
same reference as used above $s(X) \cap p^{-1}(Z)$ is a closed subscheme
regularly embedded in $\overline{p}^{-1}(Z)$ of codimension $r$.
We conclude by Lemma \ref{lemma-gysin-fundamental}.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Consider a
commutative diagram
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_i & & P \ar[ld]^g \\
& Y
}
$$
of schemes locally of finite type over $S$ such that $g$ is smooth
and $i$ is a regular immersion. Combining the bivariant class
$i^!$ discussed above with the bivariant class $g^* \in A^*(P \to Y)^\wedge$
of Lemma \ref{lemma-flat-pullback-bivariant} we obtain
$$
f^! = i^! \circ g^* \in A^*(X \to Y)
$$
Observe that the morphism $f$ is a local complete intersection morphism, see
More on Morphisms, Definition \ref{more-morphisms-definition-lci}.
Conversely, if $f : X \to Y$ is a local complete intersection morphism
of locally Noetherian schemes and $f = g \circ i$ with $g$ smooth, then
$i$ is a regular immersion. We claim that our construction of $f^!$
only depends on the morphism $f$ and not on the choice of factorization
$f = g \circ i$.

\begin{lemma}
\label{lemma-lci-gysin-well-defined}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a local complete intersection morphism
of schemes locally of finite type over $S$.
The bivariant class $f^!$ is independent of the choice of
the factorization $f = g \circ i$ with $g$ smooth (provided
one exists).
\end{lemma}

\begin{proof}
Given a second such factorization $f = g' \circ i'$ we can
consider the smooth morphism $g'' : P \times_Y P' \to Y$, the
immersion $i'' : X \to P \times_Y P'$ and the factorization
$f = g'' \circ i''$. Thus we may assume that we have a diagram
$$
\xymatrix{
& P' \ar[d]^p \ar[rd]^{g'} \\
X \ar[r]^i \ar[ru]^{i'} & P \ar[r]^g & Y
}
$$
where $p$ is a smooth morphism. Then $(g')^* = p^* \circ g^*$
(Lemma \ref{lemma-compose-flat-pullback}) and hence it suffices
to show that $i^! = (i')^! \circ p^*$
in $A^*(X \to P)$. Consider the commutative diagram
$$
\xymatrix{
& X \times_P P' \ar[d]^{\overline{p}} \ar[r]_j & P' \ar[d]^p \\
X \ar[ru]^s \ar[r]^1 & X \ar[r]^i & P
}
$$
where $s =(1, i')$. Then $s$ and $j$ are regular immersions
(by Divisors, Lemma \ref{divisors-lemma-section-smooth-regular-immersion}
and Divisors, Lemma \ref{divisors-lemma-flat-base-change-regular-immersion})
and $i' = j \circ s$. By Lemma \ref{lemma-composition-regular-immersion}
we have $(i')^! = s^! \circ j^!$.
Since the square is cartesian, the bivariant class $j^!$
is the restriction (Remark \ref{remark-restriction-bivariant})
of $i^!$ to $P'$, see Lemma \ref{lemma-construction-gysin}.
Since bivariant classes commute with flat pullbacks
we find $j^! \circ p^* = \overline{p}^* \circ i^!$.
Thus it suffices to show that $s^! \circ \overline{p}^* = \text{id}$
which is done in Lemma \ref{lemma-section-smooth}.
\end{proof}

\begin{definition}
\label{definition-lci-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a local complete intersection morphism
of schemes locally of finite type over $S$. We say
{\it the gysin map for $f$ exists} if we can write
$f = g \circ i$ with $g$ smooth and $i$ an immersion.
In this case we define the
{\it gysin map} $f^! = i^! \circ g^* \in A^*(X \to Y)$ as above.
\end{definition}

\noindent
It follows from the definition that for a regular immersion
this agrees with the construction earlier and for a smooth
morphism this agrees with flat pullback. In fact, this agreement
holds for all syntomic morphisms.

\begin{lemma}
\label{lemma-lci-gysin-flat}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a local complete intersection morphism
of schemes locally of finite type over $S$. If the gysin map
exists for $f$ and $f$ is flat, then $f^!$ is equal to the
bivariant class of Lemma \ref{lemma-flat-pullback-bivariant}.
\end{lemma}

\begin{proof}
Choose a factorization $f = g \circ i$ with $i : X \to P$
an immersion and $g : P \to Y$ smooth. Observe that for
any morphism $Y' \to Y$ which is locally of finite type,
the base changes of $f'$, $g'$, $i'$ satisfy the same
assumptions (see Morphisms, Lemmas \ref{morphisms-lemma-base-change-smooth}
and \ref{morphisms-lemma-base-change-syntomic} and
More on Morphisms, Lemma \ref{more-morphisms-lemma-flat-lci}).
Thus we reduce to proving that $f^*[Y] = i^!(g^*[Y])$ in case $Y$
is integral, see Lemma \ref{lemma-bivariant-zero}. Set $n = \dim_\delta(Y)$.
After decomposing $X$ and $P$ into connected components we
may assume $f$ is flat of relative dimension $r$ and
$g$ is smooth of relative dimension $t$.
Then $f^*[Y] = [X]_{n + s}$ and $g^*[Y] = [P]_{n + t}$.
On the other hand $i$ is a regular immersion of codimension $t - s$.
Thus $i^![P]_{n + t} = [X]_{n + s}$ (Lemma \ref{lemma-gysin-fundamental})
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-lci-gysin-composition}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ and $g : Y \to Z$ be local complete intersection morphisms
of schemes locally of finite type over $S$. Assume the gysin
map exists for $g \circ f$ and $g$. Then the gysin map exists for $f$
and $(g \circ f)^! = f^! \circ g^!$.
\end{lemma}

\begin{proof}
Observe that $g \circ f$ is a local complete intersection morphism
by More on Morphisms, Lemma \ref{more-morphisms-lemma-composition-lci}
and hence the statement of the lemma makes sense.
If $X \to P$ is an immersion of $X$ into a scheme $P$ smooth over $Z$
then $X \to P \times_Z Y$ is an immersion of $X$ into a scheme smooth
over $Y$. This prove the first assertion of the lemma.
Let $Y \to P'$ be an immersion of $Y$ into a scheme $P'$ smooth over $Z$.
Consider the commutative diagram
$$
\xymatrix{
X \ar[r] \ar[d] &
P \times_Z Y \ar[r]_a \ar[ld]^p &
P \times_Z P' \ar[ld]^q \\
Y \ar[r]_b \ar[d] &
P' \ar[ld] \\
Z
}
$$
Here the horizontal arrows are regular immersions, the south-west arrows
are smooth, and the square is cartesian. Whence
$a^! \circ q^* = p^* \circ b^!$ as bivariant classes commute
with flat pullback. Combining this fact with
Lemmas \ref{lemma-composition-regular-immersion} and
\ref{lemma-compose-flat-pullback}
the reader finds the statement of the lemma holds true.
Small detail omitted.
\end{proof}

\begin{lemma}
\label{lemma-lci-gysin-commutes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Consider a commutative diagram
$$
\xymatrix{
X'' \ar[d] \ar[r] &
X' \ar[d] \ar[r] &
X \ar[d]^f \\
Y'' \ar[r] &
Y' \ar[r] &
Y
}
$$
of schemes locally of finite type over $S$ with both square cartesian.
Assume $f : X \to Y$ is a local complete intersection morphism
such that the gysin map exists for $f$. Let $c \in A^*(Y'' \to Y')$. Denote
$res(f^!) \in A^*(X' \to Y')$ the restriction of $f^!$ to $Y'$
(Remark \ref{remark-restriction-bivariant}). Then $c$ and $res(f^!)$ commute
(Remark \ref{remark-bivariant-commute}).
\end{lemma}

\begin{proof}
Choose a factorization $f = g \circ i$ with $g$ smooth and $i$ an immersion.
Since $f^! = i^! \circ g^!$ it suffices to prove the lemma for $g^!$
(which is given by flat pullback) and for $i^!$. The result for flat pullback
is part of the definition of a bivariant class. The case of $i^!$ follows
immediately from Lemma \ref{lemma-gysin-commutes}.
\end{proof}

\begin{lemma}
\label{lemma-lci-gysin-easy}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Consider a cartesian diagram
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r] &
X \ar[d]^f \\
Y' \ar[r] &
Y
}
$$
of schemes locally of finite type over $S$. Assume
\begin{enumerate}
\item $f$ is a local complete intersection morphism and
the gysin map exists for $f$,
\item $X$, $X'$, $Y$, $Y'$ satisfy the equivalent conditions of
Lemma \ref{lemma-locally-equidimensional},
\item for $x' \in X'$ with images $x$, $y'$, and $y$
in $X$, $Y'$, and $Y$ we have $n_{x'} - n_{y'} = n_x - n_y$
where $n_{x'}$, $n_x$, $n_{y'}$, and $n_y$ are as in the lemma, and
\item for every generic point $\xi \in X'$ the local ring
$\mathcal{O}_{Y', f'(\xi)}$ is Cohen-Macaulay.
\end{enumerate}
Then $f^![Y'] = [X']$ where $[Y']$ and $[X']$ are as in
Remark \ref{remark-fundamental-class}.
\end{lemma}

\begin{proof}
Recall that $n_{x'}$ is the common value of $\delta(\xi)$
where $\xi$ is the generic point of an irreducible component
passing through $x'$. Moreover, the functions
$x' \mapsto n_{x'}$, $x \mapsto n_x$, $y' \mapsto n_{y'}$, and
$y \mapsto n_y$ are locally constant. Let $X'_n$, $X_n$, $Y'_n$,
and $Y_n$ be the open and closed subscheme of $X'$, $X$, $Y'$, and
$Y$ where the function has value $n$. Recall that
$[X'] = \sum [X'_n]_n$ and $[Y'] = \sum [Y'_n]_n$.
Having said this, it is clear that to prove the lemma we
may replace $X'$ by one of its connected components
and $X$, $Y'$, $Y$ by the connected component that
it maps into. Then we know that $X'$, $X$, $Y'$, and
$Y$ are $\delta$-equidimensional in the sense that
each irreducible component has the same $\delta$-dimension.
Say $n'$, $n$, $m'$, and $m$ is this common value
for $X'$, $X$, $Y'$, and $Y$. The last assumption
means that $n' - m' = n - m$.

\medskip\noindent
Choose a factorization $f = g \circ i$ where $i : X \to P$
is an immersion and $g : P \to Y$ is smooth. As $X$ is connected,
we see that the relative dimension of $P \to Y$ at points of $i(X)$
is constant. Hence after replacing $P$ by an open neighbourhood
of $i(X)$, we may assume that $P \to Y$ has constant relative dimension
and $i : X \to P$ is a closed immersion.
Denote $g' : Y' \times_Y P \to Y'$ the base change of $g$ and denote
$i' : X' \to Y' \times_Y P$ the base change of $i$.
It is clear that $g^*[Y] = [P]$ and $(g')^*[Y'] = [Y' \times_Y P]$.
Finally, if $\xi' \in X'$ is a generic point, then
$\mathcal{O}_{Y' \times_Y P, i'(\xi)}$ is Cohen-Macaulay.
Namely, the local ring map
$\mathcal{O}_{Y', f'(\xi)} \to \mathcal{O}_{Y' \times_Y P, i'(\xi)}$
is flat with regular fibre
(see Algebra, Section \ref{algebra-section-smooth-overview}),
a regular local ring is Cohen-Macaulay
(Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}),
$\mathcal{O}_{Y', f'(\xi)}$ is Cohen-Macaulay by assumption
(4) and we get what we want from
Algebra, Lemma \ref{algebra-lemma-CM-goes-up}.
Thus we reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $f$ is a regular closed immersion and $X'$, $X$, $Y'$, and
$Y$ are $\delta$-equidimensional of $\delta$-dimensions
$n'$, $n$, $m'$, and $m$ and $m' - n' = m - n$.
In this case we obtain the result immediately from
Lemma \ref{lemma-gysin-easy}.
\end{proof}

\begin{remark}
\label{remark-gysin-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a local complete intersection morphism
of schemes locally of finite type over $S$. Assume the gysin
map exists for $f$. Then
$f^! \circ c_i(\mathcal{E}) = c_i(f^*\mathcal{E}) \circ f^!$
and similarly for the chern character, see
Lemma \ref{lemma-lci-gysin-commutes}.
If $X$ and $Y$ satisfy the equivalent conditions of
Lemma \ref{lemma-locally-equidimensional} and $Y$ is Cohen-Macaulay
(for example), then $f^![Y] = [X]$ by Lemma \ref{lemma-lci-gysin-easy}.
In this case we also get
$f^!(c_i(\mathcal{E}) \cap [Y]) = c_i(f^*\mathcal{E}) \cap [X]$
and similarly for the chern character.
\end{remark}

\begin{lemma}
\label{lemma-compare-gysin-base-change}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Consider a cartesian square
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} &
X \ar[d]^f \\
Y' \ar[r]^g &
Y
}
$$
of schemes locally of finite type over $S$. Assume
\begin{enumerate}
\item both $f$ and $f'$ are local complete intersection morphisms, and
\item the gysin map exists for $f$
\end{enumerate}
Then $\mathcal{C} = \Ker(H^{-1}((g')^*\NL_{X/Y}) \to H^{-1}(\NL_{X'/Y'}))$
is a finite locally free $\mathcal{O}_{X'}$-module, the gysin map
exists for $f'$, and we have
$$
res(f^!) = c_{top}(\mathcal{C}^\vee) \circ (f')^!
$$
in $A^*(X' \to Y')$.
\end{lemma}

\begin{proof}
The fact that $\mathcal{C}$ is finite locally free follows immediately
from More on Algebra, Lemma \ref{more-algebra-lemma-base-change-lci-bis}.
Choose a factorization $f = g \circ i$ with $g : P \to Y$ smooth and $i$
an immersion. Then we can factor $f' = g' \circ i'$ where $g' : P' \to Y'$
and $i' : X' \to P'$ the base changes. Picture
$$
\xymatrix{
X' \ar[r] \ar[d] &
P' \ar[r] \ar[d] &
Y' \ar[d] \\
X \ar[r] &
P \ar[r] &
Y
}
$$
In particular, we see that the gysin map exists for $f'$. By
More on Morphisms, Lemmas \ref{more-morphisms-lemma-get-NL}
we have
$$
\NL_{X/Y} = \left( \mathcal{C}_{X/P} \to i^*\Omega_{P/Y} \right)
$$
where $\mathcal{C}_{X/P}$ is the conormal sheaf of the embedding $i$.
Similarly for the primed version. We have
$(g')^*i^*\Omega_{P/Y} = (i')^*\Omega_{P'/Y'}$ because
$\Omega_{P/Y}$ pulls back to $\Omega_{P'/Y'}$ by
Morphisms, Lemma \ref{morphisms-lemma-base-change-differentials}.
Also, recall that $(g')^*\mathcal{C}_{X/P} \to \mathcal{C}_{X'/P'}$
is surjective, see
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial-flat}.
We deduce that the sheaf $\mathcal{C}$ is canonicallly
isomorphic to the kernel of the map
$(g')^*\mathcal{C}_{X/P} \to \mathcal{C}_{X'/P'}$
of finite locally free modules. Recall that $i^!$ is defined
using $\mathcal{N} = \mathcal{C}_{Z/X}^\vee$ and similarly
for $(i')^!$. Thus we have
$$
res(i^!) = c_{top}(\mathcal{C}^\vee) \circ (i')^!
$$
in $A^*(X' \to P')$ by an application of Lemma \ref{lemma-gysin-excess}.
Since finally we have $f^! = i^! \circ g^*$,
$(f')^! = (i')^! \circ (g')^*$, and $(g')^* = res(g^*)$ we conclude.
\end{proof}

\begin{lemma}[Blow up formula]
\label{lemma-blow-up-formula}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $i : Z \to X$ be a regular closed immersion of schemes
locally of finite type over $S$. Let $b : X' \to X$ be the
blowing up with center $Z$. Picture
$$
\xymatrix{
E \ar[r]_j \ar[d]_\pi & X' \ar[d]^b \\
Z \ar[r]^i & X
}
$$
Assume that the gysin map exists for $b$. Then we have
$$
res(b^!) = c_{top}(\mathcal{F}^\vee) \circ \pi^*
$$
in $A^*(E \to Z)$ where $\mathcal{F}$ is the kernel of the canonical map
$\pi^*\mathcal{C}_{Z/X} \to \mathcal{C}_{E/X'}$.
\end{lemma}

\begin{proof}
Observe that the morphism $b$ is a local complete intersection morphism
by More on Algebra, Lemma \ref{more-algebra-lemma-blowup-regular-sequence}
and hence the statement makes sense. Since $Z \to X$ is a regular
immersion (and hence a fortiori quasi-regular) we see that $\mathcal{C}_{Z/X}$
is finite locally free and the map
$\text{Sym}^*(\mathcal{C}_{Z/X}) \to \mathcal{C}_{Z/X, *}$
is an isomorphism, see
Divisors, Lemma \ref{divisors-lemma-quasi-regular-immersion}.
Since $E = \text{Proj}(\mathcal{C}_{Z/X, *})$ we conclude
that $E = \mathbf{P}(\mathcal{C}_{Z/X})$
is a projective space bundle over $Z$.
Thus $E \to Z$ is smooth and certainly a local complete intersection
morphism. Thus Lemma \ref{lemma-compare-gysin-base-change}
applies and we see that
$$
res(b^!) = c_{top}(\mathcal{C}^\vee) \circ \pi^!
$$
with $\mathcal{C}$ as in the statement there.
Of course $\pi^* = \pi^!$ by Lemma \ref{lemma-lci-gysin-flat}.
It remains to show that $\mathcal{F}$ is equal to
the kernel $\mathcal{C}$ of the map
$H^{-1}(j^*\NL_{X'/X}) \to H^{-1}(\NL_{E/Z})$.

\medskip\noindent
Since $E \to Z$ is smooth we have $H^{-1}(\NL_{E/Z}) = 0$, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-NL-smooth}.
Hence it suffices to show that $\mathcal{F}$ can be identified
with $H^{-1}(j^*\NL_{X'/X})$. By More on Morphisms, Lemmas
\ref{more-morphisms-lemma-get-triangle-NL} and
\ref{more-morphisms-lemma-NL-immersion} we have an exact sequence
$$
0 \to H^{-1}(j^*\NL_{X'/X}) \to H^{-1}(\NL_{E/X}) \to
\mathcal{C}_{E/X'} \to \ldots
$$
By the same lemmas applied to $E \to Z \to X$ we obtain an isomorphism
$\pi^*\mathcal{C}_{Z/X} = H^{-1}(\pi^*\NL_{Z/X}) \to H^{-1}(\NL_{E/X})$.
Thus we conclude.
\end{proof}

\begin{lemma}
\label{lemma-lci-gysin-product-regular}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite
type over $S$ such that both $X$ and $Y$ are quasi-compact,
regular, have affine diagonal, and finite dimension.
Then $f$ is a local complete intersection morphism.
Assume moreover the gysin map is defined for $f$. Then
$$
f^!(\alpha \cdot \beta) = f^!\alpha \cdot f^!\beta
$$
in $\CH^*(X) \otimes \mathbf{Q}$ where the intersection product
is as in Section \ref{section-intersection-regular}.
\end{lemma}

\begin{proof}
The first statement follows from
More on Morphisms, Lemma
\ref{more-morphisms-lemma-morphism-regular-schemes-is-lci}.
Observe that $f^![Y] = [X]$, see Lemma \ref{lemma-lci-gysin-easy}.
Write $\alpha = ch(\alpha') \cap [Y]$ and $\beta = ch(\beta') \cap [Y]$
where $\alpha', \beta' \in K_0(\textit{Vect}(X)) \otimes \mathbf{Q}$
as in Section \ref{section-intersection-regular}.
Setting $c = ch(\alpha')$ and $c' = ch(\beta')$ we find
$\alpha \cdot \beta = c \cap c' \cap [Y]$ by construction.
By Lemma \ref{lemma-lci-gysin-commutes} we know that $f^!$
commutes with both $c$ and $c'$. Hence
\begin{align*}
f^!(\alpha \cdot \beta)
& =
f^!(c \cap c' \cap [Y]) \\
& =
c \cap c' \cap f^![Y] \\
& =
c \cap c' \cap [X] \\
& =
(c \cap [X]) \cdot (c' \cap [X]) \\
& =
(c \cap f^![Y]) \cdot (c' \cap f^![Y]) \\
& =
f^!(\alpha) \cdot f^!(\beta)
\end{align*}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-projection-formula-regular}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite
type over $S$ such that both $X$ and $Y$ are quasi-compact,
regular, have affine diagonal, and finite dimension.
Then $f$ is a local complete intersection morphism.
Assume moreover the gysin map is defined for $f$
and that $f$ is proper. Then
$$
f_*(\alpha \cdot f^!\beta) = f_*\alpha \cdot \beta
$$
in $\CH^*(Y) \otimes \mathbf{Q}$ where the intersection product
is as in Section \ref{section-intersection-regular}.
\end{lemma}

\begin{proof}
The first statement follows from
More on Morphisms, Lemma
\ref{more-morphisms-lemma-morphism-regular-schemes-is-lci}.
Observe that $f^![Y] = [X]$, see Lemma \ref{lemma-lci-gysin-easy}.
Write $\alpha = ch(\alpha') \cap [X]$ and $\beta = ch(\beta') \cap [Y]$
$\alpha' \in K_0(\textit{Vect}(X)) \otimes \mathbf{Q}$ and
$\beta' \in K_0(\textit{Vect}(Y)) \otimes \mathbf{Q}$
as in Section \ref{section-intersection-regular}.
Set $c = ch(\alpha')$ and $c' = ch(\beta')$. We have
\begin{align*}
f_*(\alpha \cdot f^!\beta)
& =
f_*(c \cap f^!(c' \cap [Y]_e)) \\
& =
f_*(c \cap c' \cap f^![Y]_e) \\
& =
f_*(c \cap c' \cap [X]_d) \\
& =
f_*(c' \cap c \cap [X]_d) \\
& =
c' \cap f_*(c \cap [X]_d) \\
& =
\beta \cdot f_*(\alpha)
\end{align*}
The first equality by the construction of the intersection product.
By Lemma \ref{lemma-lci-gysin-commutes} we know that $f^!$
commutes with $c'$. The fact that chern classes are in the center
of the bivariant ring justifies switching the order of capping
$[X]$ with $c$ and $c'$. Commuting $c'$ with $f_*$ is allowed as $c'$
is a bivariant class. The final equality is again the construction
of the intersection product.
\end{proof}













\section{Gysin maps for diagonals}
\label{section-gysin-for-diagonal}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $f : X \to Y$
be a smooth morphism of schemes locally of finite type over $S$. Then the
diagonal morphism $\Delta : X \longrightarrow X \times_Y X$
is a regular immersion, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-smooth-diagonal-perfect}.
Thus we have the gysin map
$$
\Delta^! \in A^*(X \to X \times_Y X)^\wedge
$$
constructed in Section \ref{section-koszul}. If $X \to Y$ has constant
relative dimension $d$, then $\Delta^! \in A^d(X \to X \times_Y X)$.

\begin{lemma}
\label{lemma-diagonal-identity}
In the situation above we have $\Delta^! \circ \text{pr}_i^! = 1$ in $A^0(X)$.
\end{lemma}

\begin{proof}
Observe that the projections $\text{pr}_i : X \times_Y X \to X$ are
smooth and hence we have gysin maps for these projections as well.
Thus the lemma makes sense and is a special case of
Lemma \ref{lemma-lci-gysin-composition}.
\end{proof}

\begin{proposition}
\label{proposition-compute-bivariant}
\begin{reference}
\cite[Proposition 17.4.2]{F}
\end{reference}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of schemes locally
of finite type over $S$. If $g$ is smooth of relative dimension $d$, then
$A^p(X \to Y) = A^{p - d}(X \to Z)$.
\end{proposition}

\begin{proof}
We will use that smooth morphisms are local complete intersection
morphisms whose gysin maps are defined (see Section \ref{section-koszul}).
In particular we have $g^! \in A^{-d}(Y \to Z)$. Then we can send
$c \in A^p(X \to Y)$ to $c \circ g^! \in A^{p - d}(X \to Z)$.

\medskip\noindent
Conversely, let $c' \in A^{p - d}(X \to Z)$. Denote $res(c')$ the restriction
(Remark \ref{remark-restriction-bivariant}) of $c'$ by the morphism $Y \to Z$.
Since the diagram
$$
\xymatrix{
X \times_Z Y \ar[r]_{\text{pr}_2} \ar[d]_{\text{pr}_1} & Y \ar[d]^g \\
X \ar[r]^f & Z
}
$$
is cartesian we find $res(c') \in A^{p - d}(X \times_Z Y \to Y)$.
Let $\Delta : Y \to Y \times_Z Y$ be the diagonal and denote
$res(\Delta^!)$ the restriction of $\Delta^!$
to $X \times_Z Y$ by the morphism $X \times_Z Y \to Y \times_Z Y$.
Since the diagram
$$
\xymatrix{
X \ar[r] \ar[d] & X \times_Z Y \ar[d] \\
Y \ar[r]^-\Delta & Y \times_Z Y
}
$$
is cartesian we see that $res(\Delta^!) \in A^d(X \to X \times_Z Y)$.
Combining these two restrictions we obtain
$$
res(\Delta^!) \circ res(c') \in A^p(X \to Y)
$$
Thus we have produced maps $A^p(X \to Y) \to A^{p - d}(X \to Z)$
and $A^{p - d}(X \to Z) \to A^p(X \to Y)$. To finish the proof we
will show these maps are mutually inverse.

\medskip\noindent
Let us start with $c \in A^p(X \to Y)$. Consider the diagram
$$
\xymatrix{
X \ar[d] \ar[r] & Y \ar[d] \\
X \times_Z Y \ar[r] \ar[d]^{\text{pr}_1} &
Y \times_Z Y \ar[r]_{p_2} \ar[d]^{p_1} &
Y \ar[d]^g \\
X \ar[r]^f &
Y \ar[r]^g &
Z
}
$$
whose squares are carteisan. The lower two square of this diagram
show that $res(c \circ g^!) = res(c) \cap p_2^!$ where in this formula
$res(c)$ means the restriction of $c$ via $p_1$. Looking at the upper
square of the diagram and using Lemma \ref{lemma-lci-gysin-commutes}
we get $c \circ \Delta^! = res(\Delta^!) \circ res(c)$.
We compute
\begin{align*}
res(\Delta^!) \circ res(c \circ g^!)
& =
res(\Delta^!) \circ res(c) \circ p_2^! \\
& =
c \circ \Delta^! \circ p_2^! \\
& =
c
\end{align*}
The final equality by Lemma \ref{lemma-diagonal-identity}.

\medskip\noindent
Conversely, let us start with $c' \in A^{p - d}(X \to Z)$. Looking
at the lower rectangle of the diagram above we find
$res(c') \circ g^! = \text{pr}_1^! \circ c'$.
We compute
\begin{align*}
res(\Delta^!) \circ res(c') \circ g^!
& =
res(\Delta^!) \circ \text{pr}_1^! \circ c' \\
& =
c'
\end{align*}
The final equality holds because the left two squares of
the diagram show that
$\text{id} = res(\Delta^! \circ p_1^!) = res(\Delta^!) \circ \text{pr}_1^!$.
This finishes the proof.
\end{proof}









\section{Exterior product}
\label{section-exterior-product}

\noindent
Let $k$ be a field. Set $S = \Spec(k)$ and define $\delta : S \to \mathbf{Z}$
by sending the unique point to $0$. Then $(S, \delta)$ is a special case of
our general Situation \ref{situation-setup}, see
Example \ref{example-field}.

\medskip\noindent
Consider a cartesian square
$$
\xymatrix{
X \times_k Y \ar[r] \ar[d] & Y \ar[d] \\
X \ar[r] & \Spec(k) = S
}
$$
of schemes locally of finite type over $k$. Then there is a canonical map
$$
\times :
\CH_n(X) \otimes_{\mathbf{Z}} \CH_m(Y)
\longrightarrow
\CH_{n + m}(X \times_k Y)
$$
which is uniquely determined by the following rule:
given integral closed subschemes $X' \subset X$
and $Y' \subset Y$ of dimensions $n$ and $m$ we have
$$
[X'] \times [Y'] = [X' \times_k Y']_{n + m}
$$
in $\CH_{n + m}(X \times_k Y)$.

\begin{lemma}
\label{lemma-exterior-product-well-defined}
The map
$\times : \CH_n(X) \otimes_{\mathbf{Z}} \CH_m(Y) \to \CH_{n + m}(X \times_k Y)$
is well defined.
\end{lemma}

\begin{proof}
A first remark is that if $\alpha = \sum n_i[X_i]$
and $\beta = \sum m_j[Y_j]$ with $X_i \subset X$ and $Y_j \subset Y$
locally finite families of integral closed subschemes of
dimensions $n$ and $m$, then
$X_i \times_k Y_j$ is a locally finite
collection of closed subschemes of $X \times_k Y$ of
dimensions $n + m$ and we can indeed consider
$$
\alpha \times \beta = \sum n_i m_j [X_i \times_k Y_j]_{n + m}
$$
as a $(n + m)$-cycle on $X \times_k Y$. In this way we obtain an
additive map
$\times : Z_n(X) \otimes_{\mathbf{Z}} Z_m(Y) \to Z_{n + m}(X \times_k Y)$.
The problem is to show that
this procedure is compatible with rational equivalence.

\medskip\noindent
Let $i : X' \to X$ be the inclusion morphism of
an integral closed subscheme of dimension $n$.
Then flat pullback along the morphism $p' : X' \to \Spec(k)$ is an element
$(p')^* \in A^{-n}(X' \to \Spec(k))$ by
Lemma \ref{lemma-flat-pullback-bivariant}
and hence $c' = i_* \circ (p')^* \in A^{-n}(X \to \Spec(k))$ by
Lemma \ref{lemma-push-proper-bivariant}.
This produces maps
$$
c' \cap - : \CH_m(Y) \longrightarrow \CH_{m + n}(X \times_k Y)
$$
which the reader easily sends $[Y']$ to $[X' \times_k Y']_{n + m}$
for any integral closed subscheme $Y' \subset Y$ of dimension
$m$. Hence the construction
$([X'], [Y']) \mapsto [X' \times_k Y']_{n + m}$
factors through rational equivalence in the second variable, i.e.,
gives a well defined map
$Z_n(X) \otimes_{\mathbf{Z}} \CH_m(Y) \to \CH_{n + m}(X \times_k Y)$.
By symmetry the same is true for the other variable and we conclude.
\end{proof}

\begin{lemma}
\label{lemma-chow-cohomology-towards-point}
Let $k$ be a field. Let $X$ be a scheme locally of finite type over $k$.
Then we have a canonical identification
$$
A^p(X \to \Spec(k)) = \CH_{-p}(X)
$$
for all $p \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Consider the element $[\Spec(k)] \in \CH_0(\Spec(k))$. We get a map
$A^p(X \to \Spec(k)) \to \CH_{-p}(X)$ by sending $c$ to $c \cap [\Spec(k)]$.

\medskip\noindent
Conversely, suppose we have $\alpha \in \CH_{-p}(X)$.
Then we can define $c_\alpha \in A^p(X \to \Spec(k))$ as
follows: given $X' \to \Spec(k)$ and $\alpha' \in \CH_n(X')$
we let
$$
c_\alpha \cap \alpha' = \alpha \times \alpha'
$$
in $\CH_{n - p}(X \times_k X')$. To show that this is a bivariant
class we write $\alpha = \sum n_i[X_i]$ as in
Definition \ref{definition-cycles}. Consider the composition
$$
\coprod X_i \xrightarrow{g} X \to \Spec(k)
$$
and denote $f : \coprod X_i \to \Spec(k)$ the composition.
Then $g$ is proper and $f$ is flat of relative dimension $-p$.
Pullback along $f$ is a bivariant class
$f^* \in A^p(\coprod X_i \to \Spec(k))$ by
Lemma \ref{lemma-flat-pullback-bivariant}.
Denote $\nu \in A^0(\coprod X_i)$ the bivariant class
which multiplies a cycle by $n_i$ on the $i$th component.
Thus $\nu \circ f^* \in A^p(\coprod X_i \to X)$.
Finally, we have a bivariant class
$$
g_* \circ \nu \circ f^*
$$
by Lemma \ref{lemma-push-proper-bivariant}. The reader easily
verifies that $c_\alpha$ is equal to this class and hence
is itself a bivariant class.

\medskip\noindent
To finish the proof we have to show that the two constructions
are mutually inverse. Since $c_\alpha \cap [\Spec(k)] = \alpha$
this is clear for one of the two directions. For the other, let
$c \in A^p(X \to \Spec(k))$ and set $\alpha = c \cap [\Spec(k)]$.
It suffices to prove that
$$
c \cap [X'] = c_\alpha \cap [X']
$$
when $X'$ is an integral scheme locally of finite type over $\Spec(k)$,
see Lemma \ref{lemma-bivariant-zero}. However, then $p' : X' \to \Spec(k)$
is flat of relative dimension $\dim(X')$ and hence
$[X'] = (p')^*[\Spec(k)]$. Thus the fact that the bivariant classes
$c$ and $c_\alpha$ agree on $[\Spec(k)]$ implies they
agree when capped against $[X']$ and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-chow-cohomology-towards-point-commutes}
Let $k$ be a field. Let $X$ be a scheme locally of finite type over $k$.
Let $c \in A^p(X \to \Spec(k))$. Let $Y \to Z$ be a morphism of schemes
locally of finite type over $k$. Let $c' \in A^q(Y \to Z)$. Then
$c \circ c' = c' \circ c$ in $A^{p + q}(X \times_k Y \to X \times_k Z)$.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-chow-cohomology-towards-point}
we have seen that $c$ is given by a combination of
proper pushforward, multiplying by integers over connected
components, and flat pullback. Since $c'$ commutes with each of
these operations by definition of bivariant classes, we conclude.
Some details omitted.
\end{proof}

\begin{remark}
\label{remark-commuting-exterior}
The upshot of Lemmas \ref{lemma-chow-cohomology-towards-point}
and \ref{lemma-chow-cohomology-towards-point-commutes} is the following.
Let $k$ be a field. Let $X$ be a scheme locally of finite type over $k$.
Let $\alpha \in \CH_*(X)$. Let $Y \to Z$ be a morphism of schemes
locally of finite type over $k$. Let $c' \in A^q(Y \to Z)$. Then
$$
\alpha \times (c' \cap \beta) = c' \cap (\alpha \times \beta)
$$
in $\CH_*(X \times_k Y)$ for any $\beta \in \CH_*(Z)$. Namely, this
follows by taking $c = c_\alpha \in A^*(X \to \Spec(k))$ the bivariant class
corresponding to $\alpha$, see proof of
Lemma \ref{lemma-chow-cohomology-towards-point}.
\end{remark}

\begin{lemma}
\label{lemma-exterior-product-associative}
Exterior product is associative. More precisely, let $k$ be a field,
let $X, Y, Z$ be schemes locally of finite type over $k$, let
$\alpha \in \CH_*(X)$, $\beta \in \CH_*(Y)$, $\gamma \in \CH_*(Z)$.
Then $(\alpha \times \beta) \times \gamma =
\alpha \times (\beta \times \gamma)$ in $\CH_*(X \times_k Y \times_k Z)$.
\end{lemma}

\begin{proof}
Omitted. Hint: associativity of fibre product of schemes.
\end{proof}







\section{Intersection products}
\label{section-intersection-product}

\noindent
Let $k$ be a field. Set $S = \Spec(k)$ and define $\delta : S \to \mathbf{Z}$
by sending the unique point to $0$. Then $(S, \delta)$ is a special case of
our general Situation \ref{situation-setup}, see
Example \ref{example-field}.

\medskip\noindent
Let $X$ be a smooth scheme over $k$. The bivariant class $\Delta^!$
of Section \ref{section-gysin-for-diagonal} allows us to define a kind of
intersection product on chow groups of schemes locally of finite type over $X$.
Namely, suppose that $Y \to X$ and $Z \to X$ are morphisms of schemes
which are locally of finite type. Then observe that
$$
Y \times_X Z =  (Y \times_k Z) \times_{X \times_k X, \Delta} X
$$
Hence we can consider the following sequence of maps
$$
\CH_n(Y) \otimes_\mathbf{Z} \CH_m(Y)
\xrightarrow{\times}
\CH_{n + m}(Y \times_k Z)
\xrightarrow{\Delta^!}
\CH_{n + m - *}(Y \times_X Z)
$$
Here the first arrow is the exterior product constructed in
Section \ref{section-exterior-product} and the second arrow
is the gysin map for the diagonal studied in
Section \ref{section-gysin-for-diagonal}. If $X$ is equidimensional
of dimension $d$, then we end up in $\CH_{n + m - d}(Y \times_X Z)$
and in general we can decompose into the parts lying over the open
and closed subschemes of $X$ where $X$ has a given dimension.
Given $\alpha \in \CH_*(Y)$ and $\beta \in \CH_*(Z)$ we will denote
$$
\alpha \cdot \beta = \Delta^!(\alpha \times \beta)
\in \CH_*(Y \times_X Z)
$$
In the special case where $X = Y = Z$ we obtain a multiplication
$$
\CH_*(X) \times \CH_*(X) \to \CH_*(X),\quad
(\alpha, \beta) \mapsto \alpha \cdot \beta
$$
which is called the {\it intersection product}. We observe that
this product is clearly symmetric. Associativity follows from
the next lemma.

\begin{lemma}
\label{lemma-associative}
The product defined above is associative. More precisely, let $k$ be a field,
let $X$ be smooth over $k$,
let $Y, Z, W$ be schemes locally of finite type over $X$, let
$\alpha \in \CH_*(Y)$, $\beta \in \CH_*(Z)$, $\gamma \in \CH_*(W)$.
Then $(\alpha \cdot \beta) \cdot \gamma =
\alpha \cdot (\beta \cdot \gamma)$ in $\CH_*(Y \times_X Z \times_X W)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-exterior-product-associative} we have
$(\alpha \times \beta) \times \gamma =
\alpha \times (\beta \times \gamma)$ in $\CH_*(Y \times_k Z \times_k W)$.
Consider the closed immersions
$$
\Delta_{12} : X \times_k X \longrightarrow X \times_k X \times_k X,
\quad (x, x') \mapsto (x, x, x')
$$
and
$$
\Delta_{23} : X \times_k X \longrightarrow X \times_k X \times_k X,
\quad (x, x') \mapsto (x, x', x')
$$
Denote $\Delta_{12}^!$ and $\Delta_{23}^!$ the corresponding bivariant
classes; observe that $\Delta_{12}^!$ is the restriction
(Remark \ref{remark-restriction-bivariant}) of $\Delta^!$
to $X \times_k X \times_k X$ by the map $\text{pr}_{12}$ and that
$\Delta_{23}^!$ is the restriction of $\Delta^!$
to $X \times_k X \times_k X$ by the map $\text{pr}_{23}$.
Thus clearly the restriction of $\Delta_{12}^!$ by $\Delta_{23}$
is $\Delta^!$ and the restriction of $\Delta_{23}^!$ by $\Delta_{12}$ is
$\Delta^!$ too. Thus by Lemma \ref{lemma-gysin-commutes} we have
$$
\Delta^! \circ \Delta_{12}^! =
\Delta^! \circ \Delta_{23}^! 
$$
Now we can prove the lemma by the following sequence of equalities:
\begin{align*}
(\alpha \cdot \beta) \cdot \gamma
& =
\Delta^!(\Delta^!(\alpha \times \beta) \times \gamma) \\
& =
\Delta^!(\Delta_{12}^!((\alpha \times \beta) \times \gamma)) \\
& =
\Delta^!(\Delta_{23}^!((\alpha \times \beta) \times \gamma)) \\
& =
\Delta^!(\Delta_{23}^!(\alpha \times (\beta \times \gamma)) \\
& =
\Delta^!(\alpha \times \Delta^!(\beta \times \gamma)) \\
& =
\alpha \cdot (\beta \cdot \gamma)
\end{align*}
All equalities are clear from the above except perhaps
for the second and penultimate one. The equation
$\Delta_{23}^!(\alpha \times (\beta \times \gamma)) =
\alpha \times \Delta^!(\beta \times \gamma)$ holds by
Remark \ref{remark-commuting-exterior}. Similarly for the second
equation.
\end{proof}

\begin{lemma}
\label{lemma-identify-chow-for-smooth}
Let $k$ be a field. Let $X$ be a smooth scheme over $k$, equidimensional
of dimension $d$. The map
$$
A^p(X) \longrightarrow \CH_{d - p}(X),\quad
c \longmapsto c \cap [X]_d
$$
is an isomorphism. Via this isomorphism composition of bivariant
classes turns into the intersection product defined above.
\end{lemma}

\begin{proof}
Denote $g : X \to \Spec(k)$ the structure morphism.
The map is the composition of the isomorphisms
$$
A^p(X) \to A^{p - d}(X \to \Spec(k)) \to \CH_{d - p}(X)
$$
The first is the isomorphism $c \mapsto c \circ g^*$ of
Proposition \ref{proposition-compute-bivariant}
and the second is the isomorphism $c \mapsto c \cap [\Spec(k)]$ of
Lemma \ref{lemma-chow-cohomology-towards-point}.
From the proof of Lemma \ref{lemma-chow-cohomology-towards-point}
we see that the inverse to the second arrow sends $\alpha \in \CH_{d - p}(X)$
to the bivariant class $c_\alpha$ which sends $\beta \in \CH_*(Y)$
for $Y$ locally of finite type over $k$
to $\alpha \times \beta$ in $\CH_*(X \times_k Y)$. From the proof of
Proposition \ref{proposition-compute-bivariant} we see the inverse
to the first arrow in turn sends $c_\alpha$ to the bivariant class
which sends $\beta \in \CH_*(Y)$ for $Y \to X$ locally of finite type
to $\Delta^!(\alpha \times \beta) = \alpha \cdot \beta$.
From this the final result of the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-lci-gysin-product}
Let $k$ be a field. Let $f : X \to Y$ be a morphism of schemes smooth
over $k$. Then the gysin map is defined for $f$ and
$f^!(\alpha \cdot \beta) = f^!\alpha \cdot f^!\beta$.
\end{lemma}

\begin{proof}
Observe that $X \to X \times_k Y$ is an immersion of $X$ into a scheme
smooth over $Y$. Hence the gysin map is defined for $f$
(Definition \ref{definition-lci-gysin}).
To prove the formula we may decompose $X$ and $Y$ into their
connected components, hence we may assume $X$ is smooth over $k$
and equidimensional of dimension $d$ and $Y$ is smooth over $k$
and equidimensional of dimension $e$. Observe that
$f^![Y]_e = [X]_d$ (see for example Lemma \ref{lemma-lci-gysin-easy}).
Write $\alpha = c \cap [Y]_e$ and $\beta = c' \cap [Y]_e$
and hence $\alpha \cdot \beta = c \cap c' \cap [Y]_e$,
see Lemma \ref{lemma-identify-chow-for-smooth}.
By Lemma \ref{lemma-lci-gysin-commutes} we know that $f^!$
commutes with both $c$ and $c'$. Hence
\begin{align*}
f^!(\alpha \cdot \beta)
& =
f^!(c \cap c' \cap [Y]_e) \\
& =
c \cap c' \cap f^![Y]_e \\
& =
c \cap c' \cap [X]_d \\
& =
(c \cap [X]_d) \cdot (c' \cap [X]_d) \\
& =
(c \cap f^![Y]_e) \cdot (c' \cap f^![Y]_e) \\
& =
f^!(\alpha) \cdot f^!(\beta)
\end{align*}
as desired where we have used Lemma \ref{lemma-identify-chow-for-smooth}
for $X$ as well.

\medskip\noindent
An alternative proof can be given by proving that
$(f \times f)^!(\alpha \times \beta) = f^!\alpha \times f^!\beta$
and using Lemma \ref{lemma-lci-gysin-composition}.
\end{proof}

\begin{lemma}
\label{lemma-projection-formula}
Let $k$ be a field. Let $f : X \to Y$ be a proper morphism of schemes smooth
over $k$. Then the gysin map is defined for $f$ and
$f_*(\alpha \cdot f^!\beta) = f_*\alpha \cdot \beta$.
\end{lemma}

\begin{proof}
Observe that $X \to X \times_k Y$ is an immersion of $X$ into a scheme
smooth over $Y$. Hence the gysin map is defined for $f$
(Definition \ref{definition-lci-gysin}).
To prove the formula we may decompose $X$ and $Y$ into their
connected components, hence we may assume $X$ is smooth over $k$
and equidimensional of dimension $d$ and $Y$ is smooth over $k$
and equidimensional of dimension $e$. Observe that
$f^![Y]_e = [X]_d$ (see for example Lemma \ref{lemma-lci-gysin-easy}).
Write $\alpha = c \cap [X]_d$ and $\beta = c' \cap [Y]_e$,
see Lemma \ref{lemma-identify-chow-for-smooth}. We have
\begin{align*}
f_*(\alpha \cdot f^!\beta)
& =
f_*(c \cap f^!(c' \cap [Y]_e)) \\
& =
f_*(c \cap c' \cap f^![Y]_e) \\
& =
f_*(c \cap c' \cap [X]_d) \\
& =
f_*(c' \cap c \cap [X]_d) \\
& =
c' \cap f_*(c \cap [X]_d) \\
& =
\beta \cdot f_*(\alpha)
\end{align*}
The first equality by the result of Lemma \ref{lemma-identify-chow-for-smooth}
for $X$. By Lemma \ref{lemma-lci-gysin-commutes} we know that $f^!$
commutes with $c'$. The commutativity of the intersection
product justifies switching the order of capping $[X]_d$ with $c$ and $c'$
(via the lemma). Commuting $c'$ with $f_*$ is allowed as $c'$
is a bivariant class. The final equality is again the lemma.
\end{proof}

\begin{lemma}
\label{lemma-intersect-properly}
Let $k$ be a field. Let $X$ be an integral scheme smooth over $k$.
Let $Y, Z \subset X$ be integral closed subschemes. Set
$d = \dim(Y) + \dim(Z) - \dim(X)$. Assume
\begin{enumerate}
\item $\dim(Y \cap Z) \leq d$, and
\item $\mathcal{O}_{Y, \xi}$ and $\mathcal{O}_{Z, \xi}$
are Cohen-Macaulay for every $\xi \in Y \cap Z$ with
$\delta(\xi) = d$.
\end{enumerate}
Then $[Y] \cdot [Z] = [Y \cap Z]_d$ in $\CH_d(X)$.
\end{lemma}

\begin{proof}
Recall that $[Y] \cdot [Z] = \Delta^!([Y \times Z])$ where
$\Delta^! = c(\Delta : X \to X \times X, \mathcal{T}_{X/k})$
is a higher codimension gysin map
(Section \ref{section-gysin-higher-codimension}) with
$\mathcal{T}_{X/k} = \SheafHom(\Omega_{X/k}, \mathcal{O}_X)$
locally free of rank $\dim(X)$. We have the equality of schemes
$$
Y \cap Z = X \times_{\Delta, (X \times X)} (Y \times Z)
$$
and $\dim(Y \times Z) = \dim(Y) + \dim(Z)$ and hence conditions 
(1), (2), and (3) of Lemma \ref{lemma-gysin-easy} hold.
Finally, if $\xi \in Y \cap Z$, then we have a flat local
homomorphism
$$
\mathcal{O}_{Y, \xi} \longrightarrow
\mathcal{O}_{Y \times Z, \xi}
$$
whose ``fibre'' is $\mathcal{O}_{Z, \xi}$. It follows that if both
$\mathcal{O}_{Y, \xi}$ and $\mathcal{O}_{Z, \xi}$
are Cohen-Macaulay, then so is $\mathcal{O}_{Y \times Z, \xi}$, see
Algebra, Lemma \ref{algebra-lemma-CM-goes-up}.
In this way we see that all the hypotheses of
Lemma \ref{lemma-gysin-easy} are satisfied and we conclude.
\end{proof}

\begin{lemma}
\label{lemma-intersect-regularly-embedded}
Let $k$ be a field. Let $X$ be a scheme smooth over $k$. Let $i : Y \to X$ be
a regular closed immersion. Let $\alpha \in \CH_*(X)$. If $Y$ is
equidimensional of dimension $e$, then
$\alpha \cdot [Y]_e = i_*(i^!(\alpha))$ in $\CH_*(X)$.
\end{lemma}

\begin{proof}
After decomposing $X$ into connected components we may and do assume $X$
is equidimensional of dimension $d$. Write $\alpha = c \cap [X]_n$
with $x \in A^*(X)$, see Lemma \ref{lemma-identify-chow-for-smooth}. Then
$$
i_*(i^!(\alpha)) = i_*(i^!(c \cap [X]_n)) =
i_*(c \cap i^![X]_n) = i_*(c \cap [Y]_e) =
c \cap i_*[Y]_e = \alpha \cdot [Y]_e
$$
The first equality by choice of $c$. Then second equality by
Lemma \ref{lemma-lci-gysin-commutes}. The third because
$i^![X]_d = [Y]_e$ in $\CH_*(Y)$ (Lemma \ref{lemma-lci-gysin-easy}).
The fourth because bivariant classes commute with proper pushforward.
The last equality by Lemma \ref{lemma-identify-chow-for-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-intersection-regular-smooth}
Let $k$ be a field. Let $X$ be a smooth scheme over $k$ which is
quasi-compact and has affine diagonal. Then the intersection
product on $\CH^*(X)$ constructed in this section agrees
after tensoring with $\mathbf{Q}$ with the intersection product
constructed in Section \ref{section-intersection-regular}.
\end{lemma}

\begin{proof}
Let $\alpha \in \CH^i(X)$ and $\beta \in \CH^j(X)$. Write
$\alpha = ch(\alpha') \cap [X]$ and $\beta = ch(\beta') \cap [X]$
$\alpha', \beta' \in K_0(\textit{Vect}(X)) \otimes \mathbf{Q}$
as in Section \ref{section-intersection-regular}.
Set $c = ch(\alpha')$ and $c' = ch(\beta')$.
Then the intersection product in Section \ref{section-intersection-regular}
produces $c \cap c' \cap [X]$. This is the same as $\alpha \cdot \beta$
by Lemma \ref{lemma-identify-chow-for-smooth} (or rather the
generalization that $A^i(X) \to \CH^i(X)$, $c \mapsto c \cap [X]$
is an isomorphism for any smooth scheme $X$ over $k$).
\end{proof}








\section{Exterior product over Dedekind domains}
\label{section-exterior-product-dim-1}

\noindent
Let $S$ be a locally Noetherian scheme which has an open covering
by spectra of Dedekind domains. Set $\delta(s) = 0$ for $s \in S$ closed
and $\delta(s) = 1$ otherwise. Then $(S, \delta)$ is a special case of our
general Situation \ref{situation-setup}; see
Example \ref{example-domain-dimension-1}.
Observe that $S$ is normal
(Algebra, Lemma \ref{algebra-lemma-characterize-Dedekind})
and hence a disjoint union of normal integral schemes
(Properties, Lemma \ref{properties-lemma-normal-locally-Noetherian}).
Thus all of the arguments below reduce to the case where $S$ is
irreducible. On the other hand, we allow $S$ to be nonseparated (so $S$
could be the affine line with $0$ doubled for example).

\medskip\noindent
Consider a cartesian square
$$
\xymatrix{
X \times_S Y \ar[r] \ar[d] & Y \ar[d] \\
X \ar[r] & S
}
$$
of schemes locally of finite type over $S$. We claim there is a canonical map
$$
\times :
\CH_n(X) \otimes_{\mathbf{Z}} \CH_m(Y)
\longrightarrow
\CH_{n + m - 1}(X \times_S Y)
$$
which is uniquely determined by the following rule:
given integral closed subschemes $X' \subset X$
and $Y' \subset Y$ of $\delta$-dimensions $n$ and $m$ we set
\begin{enumerate}
\item $[X'] \times [Y'] = [X' \times_S Y']_{n + m - 1}$ if
$X'$ or $Y'$ dominates an irreducible component of $S$,
\item $[X'] \times [Y'] = 0$ if neither $X'$ nor $Y'$ dominates an
irreducible component of $S$.
\end{enumerate}

\begin{lemma}
\label{lemma-exterior-product-well-defined-dim-1}
The map $\times : \CH_n(X) \otimes_{\mathbf{Z}} \CH_m(Y) \to
\CH_{n + m - 1}(X \times_S Y)$ is well defined.
\end{lemma}

\begin{proof}
Consider $n$ and $m$ cycles $\alpha = \sum_{i \in I} n_i[X_i]$
and $\beta = \sum_{j \in J} m_j[Y_j]$ with $X_i \subset X$ and $Y_j \subset Y$
locally finite families of integral closed subschemes of
$\delta$-dimensions $n$ and $m$. Let $K \subset I \times J$ be the set
of pairs $(i, j) \in I \times J$ such that $X_i$ or $Y_j$ dominates
an irreducible component of $S$.
Then $\{X_i \times_S Y_j\}_{(i, j) \in K}$ is a locally finite
collection of closed subschemes of $X \times_S Y$ of
$\delta$-dimension $n + m - 1$. This means we can indeed consider
$$
\alpha \times \beta =
\sum\nolimits_{(i, j) \in K} n_i m_j [X_i \times_S Y_j]_{n + m - 1}
$$
as a $(n + m - 1)$-cycle on $X \times_S Y$. In this way we obtain an
additive map
$\times : Z_n(X) \otimes_{\mathbf{Z}} Z_m(Y) \to Z_{n + m}(X \times_S Y)$.
The problem is to show that
this procedure is compatible with rational equivalence.

\medskip\noindent
Let $i : X' \to X$ be the inclusion morphism of an integral closed subscheme
of $\delta$-dimension $n$ which dominates an irreducible component
of $S$. Then $p' : X' \to S$ is flat of relative dimension $n - 1$, see
More on Algebra, Lemma \ref{more-algebra-lemma-dedekind-torsion-free-flat}.
Hence flat pullback along $p'$ is an element
$(p')^* \in A^{-n + 1}(X' \to S)$ by
Lemma \ref{lemma-flat-pullback-bivariant}
and hence $c' = i_* \circ (p')^* \in A^{-n + 1}(X \to S)$ by
Lemma \ref{lemma-push-proper-bivariant}.
This produces maps
$$
c' \cap - : \CH_m(Y) \longrightarrow \CH_{m + n - 1}(X \times_S Y)
$$
which sends $[Y']$ to $[X' \times_S Y']_{n + m - 1}$ for any
integral closed subscheme $Y' \subset Y$ of $\delta$-dimension $m$.

\medskip\noindent
Let $i : X' \to X$ be the inclusion morphism of an integral closed subscheme
of $\delta$-dimension $n$ such that the composition $X' \to X \to S$ 
factors through a closed point $s \in S$. Since $s$ is a closed point
of the spectrum of a Dedekind domain, we see that $s$ is an effective
Cartier divisor on $S$ whose normal bundle is trivial. Denote
$c \in A^1(s \to S)$ the gysin homomorphism, see
Lemma \ref{lemma-gysin-bivariant}. The morphism $p' : X' \to s$
is flat of relative dimension $n$. Hence flat pullback along $p'$
is an element $(p')^* \in A^{-n}(X' \to S)$ by
Lemma \ref{lemma-flat-pullback-bivariant}.
Thus
$$
c' = i_* \circ (p')^* \circ c \in A^{-n}(X \to S)
$$
by Lemma \ref{lemma-push-proper-bivariant}. This produces maps
$$
c' \cap - : \CH_m(Y) \longrightarrow \CH_{m + n - 1}(X \times_S Y)
$$
which for any integral closed subscheme $Y' \subset Y$
of $\delta$-dimension $m$
sends $[Y']$ to either $[X' \times_S Y']_{n + m - 1}$ if $Y'$ dominates
an irreducible component of $S$ or to $0$ if not.

\medskip\noindent
From the previous two paragraphs we conclude
the construction $([X'], [Y']) \mapsto [X' \times_S Y']_{n + m - 1}$
factors through rational equivalence in the second variable, i.e.,
gives a well defined map
$Z_n(X) \otimes_{\mathbf{Z}} \CH_m(Y) \to \CH_{n + m - 1}(X \times_S Y)$.
By symmetry the same is true for the other variable and we conclude.
\end{proof}

\begin{lemma}
\label{lemma-chow-cohomology-towards-base-dim-1}
Let $(S, \delta)$ be as above. Let $X$ be a scheme locally of finite type
over $S$. Then we have a canonical identification
$$
A^p(X \to S) = \CH_{1 - p}(X)
$$
for all $p \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Consider the element $[S]_1 \in \CH_1(S)$. We get a map
$A^p(X \to S) \to \CH_{1 - p}(X)$ by sending $c$ to $c \cap [S]_1$.

\medskip\noindent
Conversely, suppose we have $\alpha \in \CH_{1 - p}(X)$.
Then we can define $c_\alpha \in A^p(X \to S)$ as
follows: given $X' \to S$ and $\alpha' \in \CH_n(X')$
we let
$$
c_\alpha \cap \alpha' = \alpha \times \alpha'
$$
in $\CH_{n - p}(X \times_S X')$. To show that this is a bivariant
class we write $\alpha = \sum_{i \in I} n_i[X_i]$ as in
Definition \ref{definition-cycles}. In particular the morphism
$$
g : \coprod\nolimits_{i \in I} X_i \longrightarrow X
$$
is proper. Pick $i \in I$. If $X_i$ dominates an irreducible component
of $S$, then the structure morphism $p_i : X_i \to S$ is flat and we have
$\xi_i = p_i^* \in A^p(X_i \to S)$. On the other hand, if $p_i$ factors
as $p'_i : X_i \to s_i$ followed by the inclusion $s_i \to S$
of a closed point, then we have
$\xi_i = (p'_i)^* \circ c_i \in A^p(X_i \to S)$
where $c_i \in A^1(s_i \to S)$ is the gysin homomorphism and
$(p'_i)^*$ is flat pullback. Observe that
$$
A^p(\coprod\nolimits_{i \in I} X_i \to S) =
\prod\nolimits_{i \in I} A^p(X_i \to S)
$$
Thus we have
$$
\xi = \sum n_i \xi_i \in A^p(\coprod\nolimits_{i \in I} X_i \to S)
$$
Finally, since $g$ is proper we have a bivariant class
$$
g_* \circ \xi \in A^p(X \to S)
$$
by Lemma \ref{lemma-push-proper-bivariant}. The reader easily
verifies that $c_\alpha$ is equal to this class
(please compare with the proof of
Lemma \ref{lemma-exterior-product-well-defined-dim-1})
and hence is itself a bivariant class.

\medskip\noindent
To finish the proof we have to show that the two constructions
are mutually inverse. Since $c_\alpha \cap [S]_1 = \alpha$
this is clear for one of the two directions. For the other, let
$c \in A^p(X \to S)$ and set $\alpha = c \cap [S]_1$.
It suffices to prove that
$$
c \cap [X'] = c_\alpha \cap [X']
$$
when $X'$ is an integral scheme locally of finite type over $S$,
see Lemma \ref{lemma-bivariant-zero}. However, either $p' : X' \to S$
is flat of relative dimension $\dim_\delta(X') - 1$ and hence
$[X'] = (p')^*[S]_1$ or $X' \to S$ factors as $X' \to s \to S$
and hence $[X'] = (p')^*(s \to S)^*[S]_1$. Thus the fact that the
bivariant classes $c$ and $c_\alpha$ agree on $[S]_1$
implies they agree when capped against $[X']$ (since bivariant classes
commute with flat pullback and gysin maps) and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-chow-cohomology-towards-base-dim-1-commutes}
Let $(S, \delta)$ be as above. Let $X$ be a scheme locally of finite type
over $S$. Let $c \in A^p(X \to S)$. Let $Y \to Z$ be a morphism of schemes
locally of finite type over $S$. Let $c' \in A^q(Y \to Z)$. Then
$c \circ c' = c' \circ c$ in $A^{p + q}(X \times_S Y \to X \times_S Z)$.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-chow-cohomology-towards-base-dim-1}
we have seen that $c$ is given by a combination of
proper pushforward, multiplying by integers over connected
components, flat pullback, and gysin maps. Since $c'$ commutes with each of
these operations by definition of bivariant classes, we conclude.
Some details omitted.
\end{proof}

\begin{remark}
\label{remark-commuting-exterior-dim-1}
The upshot of Lemmas \ref{lemma-chow-cohomology-towards-base-dim-1}
and \ref{lemma-chow-cohomology-towards-base-dim-1-commutes} is the following.
Let $(S, \delta)$ be as above. Let $X$ be a scheme locally of finite type
over $S$.
Let $\alpha \in \CH_*(X)$. Let $Y \to Z$ be a morphism of schemes
locally of finite type over $S$. Let $c' \in A^q(Y \to Z)$. Then
$$
\alpha \times (c' \cap \beta) = c' \cap (\alpha \times \beta)
$$
in $\CH_*(X \times_S Y)$ for any $\beta \in \CH_*(Z)$. Namely, this
follows by taking $c = c_\alpha \in A^*(X \to S)$ the bivariant class
corresponding to $\alpha$, see proof of
Lemma \ref{lemma-chow-cohomology-towards-base-dim-1}.
\end{remark}

\begin{lemma}
\label{lemma-exterior-product-associative-dim-1}
Exterior product is associative. More precisely, let $(S, \delta)$ be
as above, let $X, Y, Z$ be schemes locally of finite type over $S$, let
$\alpha \in \CH_*(X)$, $\beta \in \CH_*(Y)$, $\gamma \in \CH_*(Z)$.
Then $(\alpha \times \beta) \times \gamma =
\alpha \times (\beta \times \gamma)$ in $\CH_*(X \times_S Y \times_S Z)$.
\end{lemma}

\begin{proof}
Omitted. Hint: associativity of fibre product of schemes.
\end{proof}















\section{Intersection products over Dedekind domains}
\label{section-intersection-product-dim-1}

\noindent
Let $S$ be a locally Noetherian scheme which has an open covering
by spectra of Dedekind domains. Set $\delta(s) = 0$ for $s \in S$ closed
and $\delta(s) = 1$ otherwise. Then $(S, \delta)$ is a special case of our
general Situation \ref{situation-setup}; see
Example \ref{example-domain-dimension-1} and discussion in
Section \ref{section-exterior-product-dim-1}.

\medskip\noindent
Let $X$ be a smooth scheme over $S$. The bivariant class $\Delta^!$
of Section \ref{section-gysin-for-diagonal} allows us to define a kind of
intersection product on chow groups of schemes locally of finite type over $X$.
Namely, suppose that $Y \to X$ and $Z \to X$ are morphisms of schemes
which are locally of finite type. Then observe that
$$
Y \times_X Z =  (Y \times_S Z) \times_{X \times_S X, \Delta} X
$$
Hence we can consider the following sequence of maps
$$
\CH_n(Y) \otimes_\mathbf{Z} \CH_m(Y)
\xrightarrow{\times}
\CH_{n + m - 1}(Y \times_S Z)
\xrightarrow{\Delta^!}
\CH_{n + m - *}(Y \times_X Z)
$$
Here the first arrow is the exterior product constructed in
Section \ref{section-exterior-product-dim-1} and the second arrow
is the gysin map for the diagonal studied in
Section \ref{section-gysin-for-diagonal}. If $X$ is equidimensional
of dimension $d$, then $X \to S$ is smooth of relative dimension $d - 1$
and hence we end up in $\CH_{n + m - d}(Y \times_X Z)$.
In general we can decompose into the parts lying over the open
and closed subschemes of $X$ where $X$ has a given dimension.
Given $\alpha \in \CH_*(Y)$ and $\beta \in \CH_*(Z)$ we will denote
$$
\alpha \cdot \beta = \Delta^!(\alpha \times \beta)
\in \CH_*(Y \times_X Z)
$$
In the special case where $X = Y = Z$ we obtain a multiplication
$$
\CH_*(X) \times \CH_*(X) \to \CH_*(X),\quad
(\alpha, \beta) \mapsto \alpha \cdot \beta
$$
which is called the {\it intersection product}. We observe that
this product is clearly symmetric. Associativity follows from
the next lemma.

\begin{lemma}
\label{lemma-associative-dim-1}
The product defined above is associative. More precisely, with
$(S, \delta)$ as above, let $X$ be smooth over $S$,
let $Y, Z, W$ be schemes locally of finite type over $X$, let
$\alpha \in \CH_*(Y)$, $\beta \in \CH_*(Z)$, $\gamma \in \CH_*(W)$.
Then $(\alpha \cdot \beta) \cdot \gamma =
\alpha \cdot (\beta \cdot \gamma)$ in $\CH_*(Y \times_X Z \times_X W)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-exterior-product-associative-dim-1} we have
$(\alpha \times \beta) \times \gamma =
\alpha \times (\beta \times \gamma)$ in $\CH_*(Y \times_S Z \times_S W)$.
Consider the closed immersions
$$
\Delta_{12} : X \times_S X \longrightarrow X \times_S X \times_S X,
\quad (x, x') \mapsto (x, x, x')
$$
and
$$
\Delta_{23} : X \times_S X \longrightarrow X \times_S X \times_S X,
\quad (x, x') \mapsto (x, x', x')
$$
Denote $\Delta_{12}^!$ and $\Delta_{23}^!$ the corresponding bivariant
classes; observe that $\Delta_{12}^!$ is the restriction
(Remark \ref{remark-restriction-bivariant}) of $\Delta^!$
to $X \times_S X \times_S X$ by the map $\text{pr}_{12}$ and that
$\Delta_{23}^!$ is the restriction of $\Delta^!$
to $X \times_S X \times_S X$ by the map $\text{pr}_{23}$.
Thus clearly the restriction of $\Delta_{12}^!$ by $\Delta_{23}$
is $\Delta^!$ and the restriction of $\Delta_{23}^!$ by $\Delta_{12}$ is
$\Delta^!$ too. Thus by Lemma \ref{lemma-gysin-commutes} we have
$$
\Delta^! \circ \Delta_{12}^! =
\Delta^! \circ \Delta_{23}^! 
$$
Now we can prove the lemma by the following sequence of equalities:
\begin{align*}
(\alpha \cdot \beta) \cdot \gamma
& =
\Delta^!(\Delta^!(\alpha \times \beta) \times \gamma) \\
& =
\Delta^!(\Delta_{12}^!((\alpha \times \beta) \times \gamma)) \\
& =
\Delta^!(\Delta_{23}^!((\alpha \times \beta) \times \gamma)) \\
& =
\Delta^!(\Delta_{23}^!(\alpha \times (\beta \times \gamma)) \\
& =
\Delta^!(\alpha \times \Delta^!(\beta \times \gamma)) \\
& =
\alpha \cdot (\beta \cdot \gamma)
\end{align*}
All equalities are clear from the above except perhaps
for the second and penultimate one. The equation
$\Delta_{23}^!(\alpha \times (\beta \times \gamma)) =
\alpha \times \Delta^!(\beta \times \gamma)$ holds by
Remark \ref{remark-commuting-exterior}. Similarly for the second
equation.
\end{proof}

\begin{lemma}
\label{lemma-identify-chow-for-smooth-dim-1}
Let $(S, \delta)$ be as above. Let $X$ be a smooth scheme over $S$,
equidimensional of dimension $d$. The map
$$
A^p(X) \longrightarrow \CH_{d - p}(X),\quad
c \longmapsto c \cap [X]_d
$$
is an isomorphism. Via this isomorphism composition of bivariant
classes turns into the intersection product defined above.
\end{lemma}

\begin{proof}
Denote $g : X \to S$ the structure morphism.
The map is the composition of the isomorphisms
$$
A^p(X) \to A^{p - d + 1}(X \to S) \to \CH_{d - p}(X)
$$
The first is the isomorphism $c \mapsto c \circ g^*$ of
Proposition \ref{proposition-compute-bivariant}
and the second is the isomorphism $c \mapsto c \cap [S]_1$ of
Lemma \ref{lemma-chow-cohomology-towards-base-dim-1}.
From the proof of Lemma \ref{lemma-chow-cohomology-towards-base-dim-1}
we see that the inverse to the second arrow sends $\alpha \in \CH_{d - p}(X)$
to the bivariant class $c_\alpha$ which sends $\beta \in \CH_*(Y)$
for $Y$ locally of finite type over $k$
to $\alpha \times \beta$ in $\CH_*(X \times_k Y)$. From the proof of
Proposition \ref{proposition-compute-bivariant} we see the inverse
to the first arrow in turn sends $c_\alpha$ to the bivariant class
which sends $\beta \in \CH_*(Y)$ for $Y \to X$ locally of finite type
to $\Delta^!(\alpha \times \beta) = \alpha \cdot \beta$.
From this the final result of the lemma follows.
\end{proof}










\section{Todd classes}
\label{section-todd-classes}

\noindent
A final class associated to a vector bundle $\mathcal{E}$
of rank $r$ is its {\it Todd class} $Todd(\mathcal{E})$.
In terms of the chern roots $x_1, \ldots, x_r$ it is
defined as
$$
Todd(\mathcal{E})
=
\prod\nolimits_{i = 1}^r
\frac{x_i}{1 - e^{-x_i}}
$$
In terms of the chern classes $c_i = c_i(\mathcal{E})$
we have
$$
Todd(\mathcal{E})
=
1
+
\frac{1}{2}c_1
+
\frac{1}{12}(c_1^2 + c_2)
+
\frac{1}{24}c_1c_2
+
\frac{1}{720}(-c_1^4 + 4c_1^2c_2 + 3c_2^2 + c_1c_3 - c_4)
+
\ldots
$$
We have made the appropriate remarks about denominators
in the previous section. It is the case that
given an exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
we have
$$
Todd({\mathcal E}) = Todd({\mathcal E}_1) Todd({\mathcal E}_2).
$$







\section{Grothendieck-Riemann-Roch}
\label{section-grr}

\noindent
Let $(S, \delta)$ be as in
Situation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf
${\mathcal E}$ on $X$ of rank $r$.
Let $f : X \to Y$ be a proper smooth morphism.
Assume that $R^if_*\mathcal{E}$ are locally free
sheaves on $Y$ of finite rank.
The Grothendieck-Riemann-Roch theorem say in this
case that
$$
f_*(Todd(T_{X/Y}) ch(\mathcal{E}))
=
\sum (-1)^i ch(R^if_*\mathcal{E})
$$
Here
$$
T_{X/Y} = \SheafHom_{\mathcal{O}_X}(\Omega_{X/Y}, \mathcal{O}_X)
$$
is the relative tangent bundle of $X$ over $Y$. If $Y = \Spec(k)$
where $k$ is a field, then we can restate this as
$$
\chi(X, \mathcal{E}) = \deg(Todd(T_{X/k}) ch(\mathcal{E}))
$$
The theorem is more general and becomes easier to prove
when formulated in correct generality. We will return to
this elsewhere (insert future reference here).







\section{Change of base scheme}
\label{section-change-base}

\noindent
In this section we explain how to compare theories for different
base schemes.

\begin{situation}
\label{situation-setup-base-change}
Here  $(S, \delta)$ and $(S', \delta')$ are as in
Situation \ref{situation-setup}. Furthermore $g : S' \to S$
is a flat morphism of schemes and $c \in \mathbf{Z}$
is an integer such that: for all $s \in S$ and $s' \in S'$
a generic point of an irreducible of $g^{-1}(\{s\})$ we have
$\delta(s') = \delta(s) + c$.
\end{situation}

\noindent
We will see that for a scheme $X$ locally of finite type over $S$
there is a well defined map $\CH_k(X) \to \CH_{k + c}(X \times_S S')$
of Chow groups which (by and large) commutes with the operations
we have defined in this chapter.

\begin{lemma}
\label{lemma-dimension-base-change}
In Situation \ref{situation-setup-base-change} let $X \to S$ be locally
of finite type. Denote $X' \to S'$ the base change by $S' \to S$.
If $X$ is integral with $\dim_\delta(X) = k$, then
every irreducible component $Z'$ of $X'$ has $\dim_{\delta'}(Z') = k + c$,
\end{lemma}

\begin{proof}
The projection $X' \to X$ is flat as a base change of the flat morphism
$S' \to S$ (Morphisms, Lemma \ref{morphisms-lemma-base-change-flat}).
Hence every generic point $x'$ of an irreducible
component of $X'$ maps to the generic point $x \in X$ (because generalizations
lift along $X' \to X$ by
Morphisms, Lemma \ref{morphisms-lemma-generalizations-lift-flat}).
Let $s \in S$ be the image of $x$.
Recall that the scheme $S'_s = S' \times_S s$
has the same underlying topological space as $g^{-1}(\{s\})$
(Schemes, Lemma \ref{schemes-lemma-fibre-topological}).
We may view $x'$ as a point of the scheme $S'_s \times_s x$ which
comes equipped with a monomorphism $S'_s \times_s x \to S' \times_S X$.
Of course, $x'$ is a generic point of an irreducible component
of $S'_s \times_s x$ as well.
Using the flatness of $\Spec(\kappa(x)) \to \Spec(\kappa(s)) = s$
and arguing as above, we see that $x'$ maps to a generic point $s'$
of an irreducible component of $g^{-1}(\{s\})$. Hence
$\delta'(s') = \delta(s) + c$ by assumption.
We have $\dim_x(X_s) = \dim_{x'}(X_{s'})$ by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}.
Since $x$ is a generic point of an irreducible component $X_s$
(this is an irreducible scheme but we don't need this) and
$x'$ is a generic point of an irreducible component of $X'_{s'}$ we conclude
that $\text{trdeg}_{\kappa(s)}(\kappa(x)) = 
\text{trdeg}_{\kappa(s')}(\kappa(x'))$
by Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}.
Then
$$
\delta_{X'/S'}(x') = \delta(s') + \text{trdeg}_{\kappa(s')}(\kappa(x')) =
\delta(s) + c + \text{trdeg}_{\kappa(s)}(\kappa(x)) = \delta_{X/S}(x) + c
$$
This proves what we want by Definition \ref{definition-delta-dimension}.
\end{proof}

\noindent
In Situation \ref{situation-setup-base-change} let $X \to S$ be locally
of finite type. Denote $X' \to S'$ the base change by $g : S' \to S$.
There is a unique homomorphism
$$
g^* : Z_k(X) \longrightarrow Z_{k + c}(X')
$$
which given an integral closed subscheme $Z \subset X$ of
$\delta$-dimension $k$ sends $[Z]$ to $[Z \times_S S']_k$.
This makes sense by Lemma \ref{lemma-dimension-base-change}.

\begin{lemma}
\label{lemma-pullback-coherent-base-change}
In Situation \ref{situation-setup-base-change} let $X \to S$
locally of finite type and let $X' \to S$ be the base change by $S' \to S$.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme with
$\dim_\delta(Z) \leq k$ and base change $Z' \subset X'$. Then we have
$\dim_{\delta'}(Z')) \leq k + c$
and $[Z']_{k + c} = g^*[Z]_k$ in $Z_{k + c}(X')$.
\item Let $\mathcal{F}$ be a coherent sheaf on $X$ with
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$ and base
change $\mathcal{F}'$ on $X'$.
Then we have $\dim_\delta(\text{Supp}(\mathcal{F}')) \leq k + c$
and $g^*[\mathcal{F}]_k = [\mathcal{F}']_{k + c}$
in $Z_{k + c}(X')$.
\end{enumerate}
\end{lemma}

\begin{proof}
The proof is exactly the same is the proof of
Lemma \ref{lemma-pullback-coherent}
and we suggest the reader skip it.

\medskip\noindent
The statements on dimensions follow from
Lemma \ref{lemma-dimension-base-change}.
Part (1) follows from part (2) by Lemma \ref{lemma-cycle-closed-coherent}
and the fact that the base change of the coherent module $\mathcal{O}_Z$
is $\mathcal{O}_{Z'}$.

\medskip\noindent
Proof of (2). As $X$, $X'$ are locally Noetherian we may apply
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} to see
that $\mathcal{F}$ is of finite type, hence $\mathcal{F}'$ is
of finite type (Modules, Lemma \ref{modules-lemma-pullback-finite-type}),
hence $\mathcal{F}'$ is coherent
(Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} again).
Thus the lemma makes sense. Let $W \subset X$ be an integral closed
subscheme of $\delta$-dimension $k$, and let $W' \subset X'$ be
an integral closed subscheme of $\delta'$-dimension $k + c$ mapping into $W$
under $X' \to X$. We have to show that the coefficient $n$ of
$[W']$ in $g^*[\mathcal{F}]_k$ agrees with the coefficient
$m$ of $[W']$ in $[\mathcal{F}']_{k + c}$. Let $\xi \in W$ and
$\xi' \in W'$ be the generic points. Let
$A = \mathcal{O}_{X, \xi}$, $B = \mathcal{O}_{X', \xi'}$
and set $M = \mathcal{F}_\xi$ as an $A$-module. (Note that
$M$ has finite length by our dimension assumptions, but we
actually do not need to verify this. See
Lemma \ref{lemma-length-finite}.)
We have $\mathcal{F}'_{\xi'} = B \otimes_A M$.
Thus we see that
$$
n = \text{length}_B(B \otimes_A M)
\quad
\text{and}
\quad
m = \text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
$$
Thus the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-module}.
\end{proof}

\begin{lemma}
\label{lemma-pullback-base-change}
In Situation \ref{situation-setup-base-change} let $X \to S$ be locally
of finite type and let $X' \to S'$ be the base change by $S' \to S$.
The map $g^* : Z_k(X) \to Z_{k + c}(X')$ above factors through rational
equivalence to give a map
$$
g^* : \CH_k(X) \longrightarrow \CH_{k + c}(X')
$$
of chow groups.
\end{lemma}

\begin{proof}
Suppose that $\alpha \in Z_k(X)$ is a $k$-cycle which is rationally equivalent
to zero. By Lemma \ref{lemma-rational-equivalence-family}
there exists a locally finite family of integral closed subschemes
$W_i \subset X \times \mathbf{P}^1$ of $\delta$-dimension $k$
not contained in the divisors
$(X \times \mathbf{P}^1)_0$ or $(X \times \mathbf{P}^1)_\infty$
of $X \times \mathbf{P}^1$ such that
$\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$.
Thus it suffices to prove for $W \subset X \times \mathbf{P}^1$
integral closed of $\delta$-dimension $k$ not contained in the divisors
$(X \times \mathbf{P}^1)_0$ or $(X \times \mathbf{P}^1)_\infty$
of $X \times \mathbf{P}^1$ we have
\begin{enumerate}
\item the base change $W' \subset X' \times \mathbf{P}^1$ satisfies the
assumptions of Lemma \ref{lemma-closed-subscheme-cross-p1} with
$k$ replaced by $k + c$, and
\item $g^*[W_0]_k = [(W')_0]_{k + c}$ and
$g^*[W_\infty]_k = [(W')_\infty]_{k + c}$.
\end{enumerate}
Part (2) follows immediately from
Lemma \ref{lemma-pullback-coherent-base-change} and the fact that
$(W')_0$ is the base change of $W_0$ (by associativity of fibre products).
For part (1), first the statement on dimensions follows
from Lemma \ref{lemma-dimension-base-change}.
Then let $w' \in (W')_0$ with image $w \in W_0$
and $z \in \mathbf{P}^1_S$. Denote $t \in \mathcal{O}_{\mathbf{P}^1_S, z}$
the usual equation for $0 : S \to \mathbf{P}^1_S$.
Since $\mathcal{O}_{W, w} \to \mathcal{O}_{W', w'}$ is flat
and since $t$ is a nonzerodivisor on $\mathcal{O}_{W, w}$
(as $W$ is integral and $W \not = W_0$) we see that also
$t$ is a nonzerodivisor in $\mathcal{O}_{W', w'}$. Hence
$W'$ has no associated points lying on $W'_0$.
\end{proof}

\begin{lemma}
\label{lemma-pullback-base-change-pullback}
In Situation \ref{situation-setup-base-change} let $Y \to X \to S$ be locally
of finite type and let $Y' \to X' \to S'$ be the base change by $S' \to S$.
Assume $f : Y \to X$ is flat of relative dimension $r$. Then $f' : Y' \to X'$
is flat of relative dimension $r$ and the diagram
$$
\xymatrix{
\CH_{k + r}(Y) \ar[r]_{g^*} & \CH_{k + c + r}(Y') \\
\CH_k(X) \ar[r]^{g^*} \ar[u]^{(f')^*} & \CH_{k + c}(X') \ar[u]_{f^*}
}
$$
of chow groups commutes.
\end{lemma}

\begin{proof}
In fact, we claim it commutes on the level of cycles. Namely, let
$Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$
and denote $Z' \subset X'$ its base change. By construction
we have $g^*[Z] = [Z']_{k + c}$. By Lemma \ref{lemma-pullback-coherent}
we have $(f')^*g^*[Z] = [Z' \times_{X'} Y']_{k + c + r}$.
Conversely, we have $f^*[Z] = [Z \times_X Y]_{k + r}$ by
Definition \ref{definition-flat-pullback}. By
Lemma \ref{lemma-pullback-coherent-base-change}
we have $g^*f^*[Z] = [(Z \times_X Y)']_{k + r + c}$.
Since $(Z \times_X Y)' = Z' \times_{X'} Y'$ by
associativity of fibre product we conclude.
\end{proof}

\begin{lemma}
\label{lemma-pullback-base-change-pushforward}
In Situation \ref{situation-setup-base-change} let $Y \to X \to S$ be locally
of finite type and let $Y' \to X' \to S'$ be the base change by $S' \to S$.
Assume $f : Y \to X$ is proper. Then $f' : Y' \to X'$ is proper and the diagram
$$
\xymatrix{
\CH_k(Y) \ar[r]_{g^*} \ar[d]_{f_*} & \CH_{k + c}(Y') \ar[d]^{f'_*} \\
\CH_k(X) \ar[r]^{g^*} & \CH_{k + c}(X')
}
$$
of chow groups commutes.
\end{lemma}

\begin{proof}
In fact, we claim it commutes on the level of cycles. Namely, let
$Z \subset Y$ be an integral closed subscheme of $\delta$-dimension $k$
and denote $Z' \subset X'$ its base change. By construction
we have $g^*[Z] = [Z']_{k + c}$. By Lemma \ref{lemma-cycle-push-sheaf}
we have $(f')_*g^*[Z] = [f'_*\mathcal{O}_{Z'}]_{k + c}$.
By the same lemma we have $f_*[Z] = [f_*\mathcal{O}_Z]_k$. By
Lemma \ref{lemma-pullback-coherent-base-change}
we have $g^*f_*[Z] = [(X' \to X)^*f_*\mathcal{O}_Z]_{k + r}$.
Thus it suffices to show that
$$
(X' \to X)^*f_*\mathcal{O}_Z \cong f'_*\mathcal{O}_{Z'}
$$
as coherent modules on $X'$. As $X' \to X$ is flat and as
$\mathcal{O}_{Z'} = (Y' \to Y)^*\mathcal{O}_Z$, this
follows from flat base change, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-pullback-base-change-c1}
In Situation \ref{situation-setup-base-change} let $X \to S$ be locally
of finite type and let $X' \to S'$ be the base change by $S' \to S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module with
base change $\mathcal{L}'$ on $X'$. Then the
diagram
$$
\xymatrix{
\CH_k(X) \ar[r]_{g^*} \ar[d]_{c_1(\mathcal{L}) \cap -} &
\CH_{k + c}(X') \ar[d]^{c_1(\mathcal{L}') \cap -} \\
\CH_{k - 1}(X) \ar[r]^{g^*} & \CH_{k + c - 1}(X')
}
$$
of chow groups commutes.
\end{lemma}

\begin{proof}
Let $p : L \to X$ be the line bundle associated to $\mathcal{L}$
with zero section $o : X \to L$. For $\alpha \in CH_k(X)$ we
know that $\beta = c_1(\mathcal{L}) \cap \alpha$
is the unique element of $\CH_{k - 1}(X)$ such that
$o_*\alpha = - p^*\beta$, see Lemmas \ref{lemma-linebundle} and
\ref{lemma-linebundle-formulae}.
The same characterization holds after pullback. Hence the lemma follows from
Lemmas \ref{lemma-pullback-base-change-pullback} and
\ref{lemma-pullback-base-change-pushforward}.
\end{proof}

\begin{lemma}
\label{lemma-pullback-base-change-chern-classes}
In Situation \ref{situation-setup-base-change} let $X \to S$ be locally
of finite type and let $X' \to S'$ be the base change by $S' \to S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module of
rank $r$ with base change $\mathcal{E}'$ on $X'$. Then the
diagram
$$
\xymatrix{
\CH_k(X) \ar[r]_{g^*} \ar[d]_{c_i(\mathcal{E}) \cap -} &
\CH_{k + c}(X') \ar[d]^{c_i(\mathcal{E}') \cap -} \\
\CH_{k - i}(X) \ar[r]^{g^*} & \CH_{k + c - i}(X')
}
$$
of chow groups commutes for all $i$.
\end{lemma}

\begin{proof}
Set $P = \mathbf{P}(\mathcal{E})$. The base change $P'$ of $P$
is equal to $\mathbf{P}(\mathcal{E}')$. Since we already know that
flat pullback and cupping with $c_1$ of an invertible module
commute with base change (Lemmas \ref{lemma-pullback-base-change-pullback} and
\ref{lemma-pullback-base-change-c1})
the lemma follows from the characterization of capping
with $c_i(\mathcal{E})$ given in Lemma \ref{lemma-determine-intersections}.
\end{proof}

\begin{lemma}
\label{lemma-compose-base-change}
Let $(S, \delta)$, $(S', \delta')$, $(S'', \delta'')$ be as in
Situation \ref{situation-setup}. Let $g : S' \to S$ and $g' : S'' \to S'$
be flat morphisms of schemes and let $c, c' \in \mathbf{Z}$
be integers such that $S, \delta, S', \delta', g, c$ and
$S', \delta', S'', g', c'$ are as in
Situation \ref{situation-setup-base-change}.
Let $X \to S$ be locally of finite type and denote $X' \to S'$
and $X'' \to S''$ the base changes by $S' \to S$ and $S'' \to S$.
Then $S, \delta, S'', \delta'', g \circ g', c + c'$ is as in
Situation \ref{situation-setup-base-change} and
the maps $g^* : \CH_k(X) \to \CH_{k + c}(X')$ and
$(g')^* : \CH_{k + c}(X') \to \CH_{k + c + c'}(X'')$ of
Lemma \ref{lemma-pullback-base-change}
compose to give the map $(g \circ g')^* : \CH_k(X) \to \CH_{k + c + c'}(X'')$
of Lemma \ref{lemma-pullback-base-change}.
\end{lemma}

\begin{proof}
Let $s \in S$ and let $s'' \in S''$ be a generic point of an irreducible
component of $(g \circ g')^{-1}(\{s\})$. Set $s' = g'(s'')$.
Clearly, $s''$ is a generic point of an irreducible component of
$(g')^{-1}(\{s'\})$. Moreover, since $g'$ is flat and hence generalizations
lift along $g'$ (Morphisms, Lemma \ref{morphisms-lemma-base-change-flat})
we see that also $s'$ is a generic point of an irreducible component
of $g^{-1}(\{s\})$. Thus by assumption $\delta'(s') = \delta(s) + c$
and $\delta''(s'') = \delta'(s') + c'$. We conclude
$\delta''(s'') = \delta(s) + c + c'$ and the first part of the
statement is true.

\medskip\noindent
For the second part, let $Z \subset X$ be an integral closed subscheme
of $\delta$-dimension $k$. Denote $Z' \subset X'$ and $Z'' \subset X''$
the base changes. By definition we have $g^*[Z] = [Z']_{k + c}$.
By Lemma \ref{lemma-pullback-coherent-base-change} we have
$(g')^*[Z']_{k + c} = [Z'']_{k + c + c'}$. This proves the final statement.
\end{proof}

\begin{lemma}
\label{lemma-chow-limit}
In Situation \ref{situation-setup-base-change} assume $c = 0$
and assume that $S' = \lim_{i \in I} S_i$ is a filtered limit
of schemes $S_i$ affine over $S$ such that
\begin{enumerate}
\item with $\delta_i$ equal to $S_i \to S \xrightarrow{\delta} \mathbf{Z}$
the pair $(S_i, \delta_i)$ is as in Situation \ref{situation-setup},
\item $S_i, \delta_i, S, \delta, S \to S_i, c = 0$ is as in
Situation \ref{situation-setup-base-change},
\item $S_i, \delta_i, S_{i'}, \delta_{i'}, S_i \to S_{i'}, c = 0$ 
for $i \geq i'$ is as in Situation \ref{situation-setup-base-change}.
\end{enumerate}
Then for a quasi-compact scheme $X$ of finite type over $S$
with base change $X'$ and $X_i$ by $S' \to S$ and $S_i \to S$ we have
$\CH_k(X') = \colim \CH_k(X_i)$.
\end{lemma}

\begin{proof}
By the result of Lemma \ref{lemma-compose-base-change} we obtain
an inverse system of chow groups $\CH_k(X_i)$ and a map
$\colim \CH_i(X_i) \to \CH_k(X)$.
We may replace $S$ by a quasi-compact open through which $X \to S$
factors, hence we may and do assume all the schemes occuring in
this proof are Noetherian (and hence quasi-compact and quasi-separated).

\medskip\noindent
Let us show that this map is surjective. Namely, let $Z' \subset X'$
be an integral closed subscheme of $\delta'$-dimension $k$. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i$ and a morphism $Z_i \to X_i$ of finite presentation
whose base change is $Z'$. Afer increasing $i$ we may assume $Z_i$
is a closed subscheme of $X_i$, see
Limits, Lemma \ref{limits-lemma-descend-closed-immersion-finite-presentation}.
Then $Z' \to X_i$ factors through $Z_i$ and we may replace $Z_i$
by the scheme theoretic image of $Z' \to X_i$. In this way we see
that we may assume $Z_i$ is an integral closed subscheme of $X_i$.
By Lemma \ref{lemma-dimension-base-change} we conclude that
$\dim_{\delta_i}(Z_i) = \dim_{\delta'}(Z') = k$.
Thus $\CH_k(X_i) \to \CH_k(X')$ maps $[Z_i]$ to $[Z']$ and
we conclude surjectivity holds.

\medskip\noindent
Let us show that our map is injective. Let $\alpha_i \in \CH_k(X_i)$
be a cycle whose image $\alpha' \in \CH_k(X')$ is zero.
Then there exist integral closed subschemes
$W_l' \subset X'$, $l = 1, \ldots, r$ of $\delta"$-dimension $k + 1$
and nonzero rational functions $f'_l$ on $W'_l$
such that $\alpha' = \sum_{l = 1, \ldots, r} \text{div}_{W'_l}(f'_l)$.
Arguing as above we can find an $i$ and integral closed subschemes
$W_{i, l} \subset X_i$ of $\delta_i$-dimension $k + 1$
whose base change is $W'_l$.
After increasin $i$ we may assume we have rational functions
$f_{i, l}$ on $W_{i, l}$. Namely, we may think of $f'_l$ as a
section of the structure sheaf over a nonempty open $U'_l \subset W'_l$,
we can descend these opens by Limits, Lemma \ref{limits-lemma-descend-opens}
and after increasing $i$ we may descend $f'_l$ by
Limits, Lemma \ref{limits-lemma-descend-section}.
We claim that
$$
\alpha_i = \sum\nolimits_{l = 1, \ldots, r} \text{div}_{W_{i, l}}(f_{i, l})
$$
after possibly increasing $i$.

\medskip\noindent
To prove the claim, let $Z'_{l, j} \subset W'_l$ be a finite
collection of integral closed subschemes of $\delta'$-dimension $k$
such that $f'_l$ is an invertible regular function outside
$\bigcup_j Y'_{l, j}$. After increasing $i$ (by the arguments above)
we may assume there exist integral closed subschemes $Z_{i, l, j} \subset W_i$
of $\delta_i$-dimension $k$ such that $f_{i, l}$ is an
invertible regular function outside $\bigcup_j Z_{i, l, j}$.
Then we may write
$$
\text{div}_{W'_l}(f'_l) = \sum n_{l, j} [Z'_{l, j}]
$$
and
$$
\text{div}_{W_{i, l}}(f_{i, l}) = \sum n_{i, l, j} [Z_{i, l, j}]
$$
To prove the claim it suffices to show that $n_{l, i} = n_{i, l, j}$.
Namely, this will imply that $\beta_i =
\alpha_i - \sum\nolimits_{l = 1, \ldots, r} \text{div}_{W_{i, l}}(f_{i, l})$
is a cycle on $X_i$ whose pullback to $X'$ is zero as a cycle!
It follows that $\beta_i$ pulls back to zero as a cycle on $X_{i'}$
for some $i' \geq i$ by an easy argument we omit.

\medskip\noindent
To prove the equality $n_{l, i} = n_{i, l, j}$ we choose a
generic point $\xi' \in Z'_{l, j}$ and we denote
$\xi \in Z_{i, l, j}$ the image which is a generic point also.
Then the local ring map
$$
\mathcal{O}_{W_{i, l}, \xi}
\longrightarrow
\mathcal{O}_{W'_l, \xi'}
$$
is flat as $W'_l \to W_{i, l}$ is the base change of the flat
morphism $S' \to S_i$. We also have
$\mathfrak m_\xi \mathcal{O}_{W'_l, \xi'} = \mathfrak m_{\xi'}$
because $Z_{i, l, j}$ pulls back to $Z'_{l, j}$! Thus the equality of
$$
n_{l, j} = \text{ord}_{Z'_{l, j}}(f'_l) =
\text{ord}_{\mathcal{O}_{W'_l, \xi'}}(f'_l)
\quad\text{and}\quad
n_{i, l, j} = \text{ord}_{Z_{i, l, j}}(f_{i, l}) =
\text{ord}_{\mathcal{O}_{W_{i, l}, \xi}}(f_{i, l})
$$
follows from Algebra, Lemma \ref{algebra-lemma-pullback-module}
and the construction of $\text{ord}$ in
Algebra, Section \ref{algebra-section-orders-of-vanishing}.
\end{proof}












\section{Appendix A: Alternative approach to key lemma}
\label{section-appendix-A}

\noindent
In this appendix we first define determinants $\det_\kappa(M)$
of finite length modules $M$ over local rings $(R, \mathfrak m, \kappa)$,
see Subsection \ref{subsection-determinants-finite-length}.
The determinant $\det_\kappa(M)$ is a $1$-dimensional $\kappa$-vector space.
We use this in Subsection \ref{subsection-periodic-complexes-determinants}
to define the determinant $\det_\kappa(M, \varphi, \psi) \in \kappa^*$
of an exact $(2, 1)$-periodic complex $(M, \varphi, \psi)$
with $M$ of finite length. In Subsection \ref{subsection-symbols}
we use these determinants to construct a tame symbol
$d_R(a, b) = \det_\kappa(R/ab, a, b)$ for a pair of nonzerodivisors
$a, b \in R$ when $R$ is Noetherian of dimension $1$.
Although there is no doubt that
$$
d_R(a, b) = \partial_R(a, b)
$$
where $\partial_R$ is as in Section \ref{section-tame-symbol},
we have not (yet) added the verification. The advantage of the
tame symbol as constructed in this appendix is that it extends
(for example) to pairs of injective endomorphisms $\varphi, \psi$
of a finite $R$-module $M$ of dimension $1$ such that
$\varphi(\psi(M)) = \psi(\varphi(M))$. In
Subsection \ref{subsection-length-determinant}
we relate Herbrand quotients and determinants.
An easy to state version of main the main result
(Proposition \ref{proposition-length-determinant-periodic-complex})
is the formula
$$
-e_R(M, \varphi, \psi) =
\text{ord}_R(\det\nolimits_K(M_K, \varphi, \psi))
$$
when $(M, \varphi, \psi)$ is a $(2, 1)$-periodic complex
whose Herbrand quotient $e_R$ (Definition \ref{definition-periodic-length})
is defined
over a $1$-dimensonal Noetherian local domain $R$ with fraction field $K$.
We use this proposition to give an alternative proof of the key lemma
(Lemma \ref{lemma-milnor-gersten-low-degree})
for the tame symbol constructed in this appendix, see
Lemma \ref{lemma-secondary-ramification}.


\subsection{Determinants of finite length modules}
\label{subsection-determinants-finite-length}

\noindent
The material in this section is related to the material in
the paper \cite{determinant} and to the material in the
thesis \cite{Joe}.

\medskip\noindent
Given any field $\kappa$ and any finite dimensional $\kappa$-vector space
$V$ we set $\det_\kappa(V) = \wedge^n(V)$ where $n = \dim_\kappa(V)$.
We will generalize this to finite length modules over local rings.
If the local ring contains a field, then the determinant constructed
below is a ``usual'' determinant, see
Remark \ref{remark-explain-determinant}.

\begin{definition}
\label{definition-determinant}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
Say $l = \text{length}_R(M)$.
\begin{enumerate}
\item Given elements $x_1, \ldots, x_r \in M$ we denote
$\langle x_1, \ldots, x_r \rangle = Rx_1 + \ldots + Rx_r$ the
$R$-submodule of $M$ generated by $x_1, \ldots, x_r$.
\item We will say an $l$-tuple of elements
$(e_1, \ldots, e_l)$ of $M$ is {\it admissible} if
$\mathfrak m e_i \subset \langle e_1, \ldots, e_{i - 1} \rangle$
for $i = 1, \ldots, l$.
\item A {\it symbol} $[e_1, \ldots, e_l]$ will mean
$(e_1, \ldots, e_l)$ is an admissible $l$-tuple.
\item An {\it admissible relation} between symbols is one of the following:
\begin{enumerate}
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$[e_1, \ldots, e_l] = 0$,
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have $e_a = \lambda e'_a + x$
with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$$
[e_1, \ldots, e_l] =
\overline{\lambda} [e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
$$
where $\overline{\lambda} \in \kappa^*$ is the image of $\lambda$ in
the residue field, and
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$ then
$$
[e_1, \ldots, e_l] =
- [e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l].
$$
\end{enumerate}
\item
We define the {\it determinant of the finite length $R$-module $M$} to be
$$
\det\nolimits_\kappa(M) =
\left\{
\frac{\kappa\text{-vector space generated by symbols}}
{\kappa\text{-linear combinations of admissible relations}}
\right\}
$$
\end{enumerate}
\end{definition}

\noindent
We stress that always $l = \text{length}_R(M)$. We also stress that
it does not follow that the symbol $[e_1, \ldots, e_l]$ is
additive in the entries (this will typically not be the case).
Before we can show that the determinant $\det_\kappa(M)$ actually
has dimension $1$ we have to show that it has dimension at most $1$.

\begin{lemma}
\label{lemma-dimension-at-most-one}
With notations as above we have $\dim_\kappa(\det_\kappa(M)) \leq 1$.
\end{lemma}

\begin{proof}
Fix an admissible sequence $(f_1, \ldots, f_l)$ of $M$ such that
$$
\text{length}_R(\langle f_1, \ldots, f_i\rangle) = i
$$
for $i = 1, \ldots, l$. Such an admissible sequence exists exactly because
$M$ has length $l$. We will show that any element of
$\det_\kappa(M)$ is a $\kappa$-multiple of the symbol
$[f_1, \ldots, f_l]$. This will prove the lemma.

\medskip\noindent
Let $(e_1, \ldots, e_l)$ be an admissible sequence of $M$.
It suffices to show that $[e_1, \ldots, e_l]$ is a multiple
of $[f_1, \ldots, f_l]$. First assume that
$\langle e_1, \ldots, e_l\rangle \not = M$. Then there exists
an $i \in [1, \ldots, l]$ such that
$e_i \in \langle e_1, \ldots, e_{i - 1}\rangle$. It immediately
follows from the first admissible relation that
$[e_1, \ldots, e_n] = 0$ in $\det_\kappa(M)$.
Hence we may assume that $\langle e_1, \ldots, e_l\rangle = M$.
In particular there exists a smallest index $i \in \{1, \ldots, l\}$
such that $f_1 \in \langle e_1, \ldots, e_i\rangle$. This means
that $e_i = \lambda f_1 + x$ with
$x \in \langle e_1, \ldots, e_{i - 1}\rangle$ and $\lambda \in R^*$.
By the second admissible relation this means that
$[e_1, \ldots, e_l] =
\overline{\lambda}[e_1, \ldots, e_{i - 1}, f_1, e_{i + 1}, \ldots, e_l]$.
Note that $\mathfrak m f_1 = 0$. Hence by applying the third
admissible relation $i - 1$ times we see that
$$
[e_1, \ldots, e_l] =
(-1)^{i - 1}\overline{\lambda}
[f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l].
$$
Note that it is also the case that
$ \langle f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l\rangle = M$.
By induction suppose we have proven that our original
symbol is equal to a scalar times
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
$$
for some admissible sequence $(f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l)$
whose elements generate $M$, i.e., \ with
$\langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l\rangle = M$.
Then we find the smallest $i$ such that
$f_{j + 1} \in \langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_i\rangle$
and we go through the same process as above to see that
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
=
(\text{scalar}) [f_1, \ldots, f_j, f_{j + 1}, e_{j + 1},
\ldots, \hat{e_i}, \ldots, e_l]
$$
Continuing in this vein we obtain the desired result.
\end{proof}

\noindent
Before we show that $\det_\kappa(M)$ always has dimension $1$,
let us show that it agrees with the usual top exterior power in
the case the module is a vector space over $\kappa$.

\begin{lemma}
\label{lemma-compare-det}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module
which is annihilated by $\mathfrak m$. Let $l = \dim_\kappa(M)$.
Then the map
$$
\det\nolimits_\kappa(M) \longrightarrow \wedge^l_\kappa(M),
\quad
[e_1, \ldots, e_l] \longmapsto e_1 \wedge \ldots \wedge e_l
$$
is an isomorphism.
\end{lemma}

\begin{proof}
It is clear that the rule described in the lemma gives a $\kappa$-linear
map since all of the admissible relations are satisfied by the usual
symbols $e_1 \wedge \ldots \wedge e_l$. It is also clearly a surjective
map. Since by Lemma \ref{lemma-dimension-at-most-one} the left hand side
has dimension at most one
we see that the map is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-determinant-dimension-one}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
The determinant $\det_\kappa(M)$ defined above is a $\kappa$-vector
space of dimension $1$. It is generated by the symbol
$[f_1, \ldots, f_l]$ for any admissible sequence such
that $\langle f_1, \ldots f_l \rangle = M$.
\end{lemma}

\begin{proof}
We know $\det_\kappa(M)$ has dimension at most $1$, and in fact that it
is generated by $[f_1, \ldots, f_l]$, by
Lemma \ref{lemma-dimension-at-most-one} and its proof.
We will show by induction on $l = \text{length}(M)$
that it is nonzero. For $l = 1$ it follows from Lemma \ref{lemma-compare-det}.
Choose a nonzero element $f \in M$
with $\mathfrak m f = 0$. Set $\overline{M} = M /\langle f \rangle$,
and denote the quotient map $x \mapsto \overline{x}$.
We will define a surjective map
$$
\psi : \det\nolimits_k(M) \to \det\nolimits_\kappa(\overline{M})
$$
which will prove the lemma since by induction the determinant of
$\overline{M}$ is nonzero.

\medskip\noindent
We define $\psi$ on symbols as follows.
Let $(e_1, \ldots, e_l)$ be an admissible sequence.
If $f \not \in \langle e_1, \ldots, e_l \rangle$ then
we simply set $\psi([e_1, \ldots, e_l]) = 0$.
If $f \in \langle e_1, \ldots, e_l \rangle$ then we choose
an $i$ minimal such that $f \in \langle e_1, \ldots, e_i \rangle$.
We may write $e_i = \lambda f + x$ for some unit $\lambda \in R$
and $x \in \langle e_1, \ldots, e_{i - 1} \rangle$.
In this case we set
$$
\psi([e_1, \ldots, e_l]) =
(-1)^i
\overline{\lambda}[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l].
$$
Note that it is indeed the case that
$(\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l)$
is an admissible sequence in $\overline{M}$, so this makes sense.
Let us show that extending this rule $\kappa$-linearly to
linear combinations of symbols does indeed lead to a map on
determinants. To do this we have to show that the admissible
relations are mapped to zero.

\medskip\noindent
Type (a) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Then $i \not = a$ and
$\overline{e}_a \in \langle \overline{e}_1, \ldots,
\hat{\overline{e}_i}, \ldots, \overline{e}_{a - 1}\rangle$ if $i < a$
or
$\overline{e}_a \in \langle \overline{e}_1, \ldots,
\overline{e}_{a - 1}\rangle$ if $i > a$.
Thus the same admissible relation for $\det_\kappa(\overline{M})$ forces
the symbol $[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]$
to be zero as desired.

\medskip\noindent
Type (b) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a = \lambda e'_a + x$ with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \mu f + y$ with $y \in \langle e_1, \ldots, e_{i - 1}\rangle$.
If $i < a$ then the desired equality is
$$
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
If $i > a$ then the desired equality is
$$
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
The interesting case is when $i = a$. In this case we have
$e_a = \lambda e'_a + x = \mu f + y$. Hence also
$e'_a = \lambda^{-1}(\mu f + y - x)$. Thus we see that
$$
\psi([e_1, \ldots, e_l])
= (-1)^i \overline{\mu}
[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]
=
\psi(
\overline{\lambda}
[e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
)
$$
as desired.

\medskip\noindent
Type (c) relations. Suppose that $(e_1, \ldots, e_l)$
is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \lambda f + x$ with $x \in \langle e_1, \ldots, e_{i - 1}\rangle$.
We distinguish $4$ cases:

\medskip\noindent
Case 1: $i < a - 1$. The desired equality is
\begin{align*}
& (-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l] \\
& =
(-1)^{i + 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
\end{align*}
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$.

\medskip\noindent
Case 2: $i > a$. The desired equality is
\begin{align*}
& (-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l] \\
& =
(-1)^{i + 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
\end{align*}
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$.

\medskip\noindent
Case 3: $i = a$. We write $e_a = \lambda f + \mu e_{a - 1} + y$
with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$. Then
$$
\psi([e_1, \ldots, e_l]) =
(-1)^a
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
by definition. If $\overline{\mu}$ is nonzero, then we have
$e_{a - 1} = - \mu^{-1} \lambda f + \mu^{-1}e_a - \mu^{-1} y$
and we obtain
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^a
\overline{\mu^{-1}\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
by definition. Since in $\overline{M}$ we have
$\overline{e}_a = \mu \overline{e}_{a - 1} + \overline{y}$ we see
the two outcomes are equal by relation (a) for $\det_\kappa(\overline{M})$.
If on the other hand $\overline{\mu}$ is zero, then we can write
$e_a = \lambda f + y$ with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$
and we have
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^a
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which is equal to $\psi([e_1, \ldots, e_l])$.

\medskip\noindent
Case 4: $i = a - 1$. Here we have
$$
\psi([e_1, \ldots, e_l]) =
(-1)^{a - 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\ldots,
\overline{e}_l]
$$
by definition. If $f \not \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$
then
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^{a + 1}\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\ldots,
\overline{e}_l]
$$
Since $(-1)^{a - 1} = (-1)^{a + 1}$ the two expressions are the same.
Finally, assume $f \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$.
In this case we see that $e_{a - 1} = \lambda f + x$ with
$x \in \langle e_1, \ldots, e_{a - 2}\rangle$ and
$e_a = \mu f + y$ with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$
for units $\lambda, \mu \in R$.
We conclude that both
$e_a \in \langle e_1, \ldots, e_{a - 1} \rangle$ and
$e_{a - 1} \in \langle e_1, \ldots, e_{a - 2}, e_a\rangle$.
In this case a relation of type (a) applies to both
$[e_1, \ldots, e_l]$ and
$[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]$
and the compatibility of $\psi$ with these shown above to see that both
$$
\psi([e_1, \ldots, e_l])
\quad\text{and}\quad
\psi([e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l])
$$
are zero, as desired.

\medskip\noindent
At this point we have shown that $\psi$ is well defined, and all that remains
is to show that it is surjective. To see this let
$(\overline{f}_2, \ldots, \overline{f}_l)$ be an admissible sequence
in $\overline{M}$. We can choose lifts $f_2, \ldots, f_l \in M$, and
then $(f, f_2, \ldots, f_l)$ is an admissible sequence in $M$.
Since $\psi([f, f_2, \ldots, f_l]) = [f_2, \ldots, f_l]$ we win.
\end{proof}

\noindent
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Note that if $\varphi : M \to N$ is an
isomorphism of finite length $R$-modules, then we get an
isomorphism
$$
\det\nolimits_\kappa(\varphi) :
\det\nolimits_\kappa(M)
\to
\det\nolimits_\kappa(N)
$$
simply by the rule
$$
\det\nolimits_\kappa(\varphi)([e_1, \ldots, e_l])
=
[\varphi(e_1), \ldots, \varphi(e_l)]
$$
for any symbol $[e_1, \ldots, e_l]$ for $M$.
Hence we see that $\det\nolimits_\kappa$ is a functor
\begin{equation}
\label{equation-functor}
\left\{
\begin{matrix}
\text{finite length }R\text{-modules}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\end{equation}
This is typical for a ``determinant functor''
(see \cite{Knudsen}), as is the following additivity
property.

\begin{lemma}
\label{lemma-det-exact-sequences}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
For every short exact sequence
$$
0 \to K \to L \to M \to 0
$$
of finite length $R$-modules there exists a canonical isomorphism
$$
\gamma_{K \to L \to M} :
\det\nolimits_\kappa(K) \otimes_\kappa \det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(L)
$$
defined by the rule on nonzero symbols
$$
[e_1, \ldots, e_k]
\otimes
[\overline{f}_1, \ldots, \overline{f}_m]
\longrightarrow
[e_1, \ldots, e_k, f_1, \ldots, f_m]
$$
with the following properties:
\begin{enumerate}
\item For every isomorphism of short exact sequences, i.e., for
every commutative diagram
$$
\xymatrix{
0 \ar[r] &
K \ar[r] \ar[d]^u &
L \ar[r] \ar[d]^v &
M \ar[r] \ar[d]^w &
0 \\
0 \ar[r] &
K' \ar[r] &
L' \ar[r] &
M' \ar[r] &
0
}
$$
with short exact rows and isomorphisms $u, v, w$ we have
$$
\gamma_{K' \to L' \to M'} \circ
(\det\nolimits_\kappa(u) \otimes \det\nolimits_\kappa(w))
=
\det\nolimits_\kappa(v) \circ
\gamma_{K \to L \to M},
$$
\item for every commutative square of finite length $R$-modules
with exact rows and columns
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] & A \ar[r] \ar[d] & B \ar[r] \ar[d] & C \ar[r] \ar[d] & 0 \\
0 \ar[r] & D \ar[r] \ar[d] & E \ar[r] \ar[d] & F \ar[r] \ar[d] & 0 \\
0 \ar[r] & G \ar[r] \ar[d] & H \ar[r] \ar[d] & I \ar[r] \ar[d] & 0 \\
& 0  & 0  & 0  &
}
$$
the following diagram is commutative
$$
\xymatrix{
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(I)
\ar[dd]_{\epsilon}
\ar[rrr]_-{\gamma_{A \to B \to C} \otimes \gamma_{G \to H \to I}}
& & &
\det\nolimits_\kappa(B) \otimes
\det\nolimits_\kappa(H)
\ar[d]^{\gamma_{B \to E \to H}}
\\
& & & \det\nolimits_\kappa(E)
\\
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(I)
\ar[rrr]^-{\gamma_{A \to D \to G} \otimes \gamma_{C \to F \to I}}
& & &
\det\nolimits_\kappa(D) \otimes
\det\nolimits_\kappa(F)
\ar[u]_{\gamma_{D \to E \to F}}
}
$$
where $\epsilon$ is the switch of the factors in the tensor product
times $(-1)^{cg}$ with $c = \text{length}_R(C)$ and $g = \text{length}_R(G)$,
and
\item the map $\gamma_{K \to L \to M}$ agrees with the usual isomorphism
if $0 \to K \to L \to M \to 0$ is actually a short exact sequence
of $\kappa$-vector spaces.
\end{enumerate}
\end{lemma}

\begin{proof}
The significance of taking nonzero symbols in the explicit description
of the map $\gamma_{K \to L \to M}$ is simply that if $(e_1, \ldots, e_l)$
is an admissible sequence in $K$, and
$(\overline{f}_1, \ldots, \overline{f}_m)$ is an admissible sequence in
$M$, then it is not guaranteed that $(e_1, \ldots, e_l, f_1, \ldots, f_m)$
is an admissible sequence in $L$ (where of course $f_i \in L$ signifies
a lift of $\overline{f}_i$). However, if the symbol
$[e_1, \ldots, e_l]$ is nonzero in $\det_\kappa(K)$, then
necessarily $K = \langle e_1, \ldots, e_k\rangle$ (see
proof of Lemma \ref{lemma-dimension-at-most-one}), and
in this case it is true that $(e_1, \ldots, e_k, f_1, \ldots, f_m)$
is an admissible sequence.
Moreover, by the admissible relations of type (b) for $\det_\kappa(L)$
we see that the value of $[e_1, \ldots, e_k, f_1, \ldots, f_m]$ in
$\det_\kappa(L)$ is independent of the choice of the lifts
$f_i$ in this case also. Given this remark, it is clear
that an admissible relation for $e_1, \ldots, e_k$ in $K$
translates into an admissible relation among
$e_1, \ldots, e_k, f_1, \ldots, f_m$ in $L$, and
similarly for an admissible relation among the
$\overline{f}_1, \ldots, \overline{f}_m$.
Thus $\gamma$ defines a linear map of vector spaces as claimed in the lemma.

\medskip\noindent
By Lemma \ref{lemma-determinant-dimension-one} we know
$\det_\kappa(L)$ is generated by any single
symbol $[x_1, \ldots, x_{k + m}]$ such that
$(x_1, \ldots, x_{k + m})$ is an admissible sequence
with $L = \langle x_1, \ldots, x_{k + m}\rangle$. Hence it is
clear that the map $\gamma_{K \to L \to M}$ is surjective and
hence an isomorphism.

\medskip\noindent
Property (1) holds because
\begin{eqnarray*}
& & \det\nolimits_\kappa(v)([e_1, \ldots, e_k, f_1, \ldots, f_m]) \\
& = &
[v(e_1), \ldots, v(e_k), v(f_1), \ldots, v(f_m)] \\
& = &
\gamma_{K' \to L' \to M'}([u(e_1), \ldots, u(e_k)]
\otimes [w(f_1), \ldots, w(f_m)]).
\end{eqnarray*}
Property (2) means that given a symbol
$[\alpha_1, \ldots, \alpha_a]$ generating $\det_\kappa(A)$,
a symbol $[\gamma_1, \ldots, \gamma_c]$ generating $\det_\kappa(C)$,
a symbol $[\zeta_1, \ldots, \zeta_g]$ generating $\det_\kappa(G)$, and
a symbol $[\iota_1, \ldots, \iota_i]$ generating $\det_\kappa(I)$
we have
\begin{eqnarray*}
& & [\alpha_1, \ldots, \alpha_a, \tilde\gamma_1, \ldots, \tilde\gamma_c,
\tilde\zeta_1, \ldots, \tilde\zeta_g, \tilde\iota_1, \ldots, \tilde\iota_i] \\
& = &
(-1)^{cg} [\alpha_1, \ldots, \alpha_a, \tilde\zeta_1, \ldots, \tilde\zeta_g,
\tilde\gamma_1, \ldots, \tilde\gamma_c, \tilde\iota_1, \ldots, \tilde\iota_i]
\end{eqnarray*}
(for suitable lifts $\tilde{x}$ in $E$) in $\det_\kappa(E)$.
This holds because we may use the admissible relations of type (c)
$cg$ times in the following order: move the
$\tilde\zeta_1$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_1 \subset A$),
then move $\tilde\zeta_2$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_2 \subset A + R\tilde\zeta_1$),
and so on.

\medskip\noindent
Part (3) of the lemma is obvious.
This finishes the proof.
\end{proof}

\noindent
We can use the maps $\gamma$ of the lemma to define more general maps
$\gamma$ as follows. Suppose that $(R, \mathfrak m, \kappa)$ is a
local ring. Let $M$ be a finite length $R$-module and suppose we
are given a finite filtration (see
Homology, Definition \ref{homology-definition-filtered})
$$
0 = F^m \subset F^{m - 1} \subset \ldots \subset F^{n + 1} \subset F^n = M
$$
then there is a well defined and canonical isomorphism
$$
\gamma_{(M, F)} :
\det\nolimits_\kappa(F^{m - 1}/F^m) \otimes_\kappa \ldots \otimes_k 
\det\nolimits_\kappa(F^n/F^{n + 1})
\longrightarrow
\det\nolimits_\kappa(M)
$$
To construct it we use isomorphisms of Lemma \ref{lemma-det-exact-sequences}
coming from the short exact sequences
$0 \to F^{i - 1}/F^i \to M/F^i \to M/F^{i - 1} \to 0$.
Part (2) of Lemma \ref{lemma-det-exact-sequences} with $G = 0$ shows
we obtain the same isomorphism if we use the short exact sequences
$0 \to F^i \to F^{i - 1} \to F^{i - 1}/F^i \to 0$.

\medskip\noindent
Here is another typical result for determinant functors.
It is not hard to show. The tricky part is usually to show the
existence of a determinant functor.

\begin{lemma}
\label{lemma-uniqueness-det}
Let $(R, \mathfrak m, \kappa)$ be any local ring.
The functor
$$
\det\nolimits_\kappa :
\left\{
\begin{matrix}
\text{finite length }R\text{-modules} \\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces} \\
\text{with isomorphisms}
\end{matrix}
\right\}
$$
endowed with the maps $\gamma_{K \to L \to M}$ is characterized by
the following properties
\begin{enumerate}
\item its restriction to the subcategory of modules annihilated
by $\mathfrak m$ is isomorphic to the usual determinant functor
(see Lemma \ref{lemma-compare-det}), and
\item (1), (2) and (3) of Lemma \ref{lemma-det-exact-sequences}
hold.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-determinant-quotient-ring}
Let $(R', \mathfrak m') \to (R, \mathfrak m)$ be a local ring
homomorphism which induces an isomorphism on residue fields $\kappa$.
Then for every finite length $R$-module the restriction $M_{R'}$
is a finite length $R'$-module and there is a canonical isomorphism
$$
\det\nolimits_{R, \kappa}(M)
\longrightarrow
\det\nolimits_{R', \kappa}(M_{R'})
$$
This isomorphism is functorial in $M$ and compatible with the
isomorphisms $\gamma_{K \to L \to M}$ of Lemma \ref{lemma-det-exact-sequences}
defined for $\det_{R, \kappa}$ and $\det_{R', \kappa}$.
\end{lemma}

\begin{proof}
If the length of $M$ as an $R$-module is $l$, then the length
of $M$ as an $R'$-module (i.e., $M_{R'}$) is $l$ as well, see
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
Note that an admissible sequence $x_1, \ldots, x_l$ of $M$
over $R$ is an admissible sequence of $M$ over $R'$ as $\mathfrak m'$
maps into $\mathfrak m$.
The isomorphism is obtained by mapping the symbol
$[x_1, \ldots, x_l] \in \det\nolimits_{R, \kappa}(M)$
to the corresponding symbol
$[x_1, \ldots, x_l] \in \det\nolimits_{R', \kappa}(M)$.
It is immediate to verify that this is functorial for
isomorphisms and compatible with the isomorphisms
$\gamma$ of Lemma \ref{lemma-det-exact-sequences}.
\end{proof}

\begin{remark}
\label{remark-explain-determinant}
Let $(R, \mathfrak m, \kappa)$ be a local ring and assume either
the characteristic of $\kappa$ is zero or it is $p$ and $p R = 0$.
Let $M_1, \ldots, M_n$ be finite length $R$-modules.
We will show below that there exists an
ideal $I \subset \mathfrak m$ annihilating $M_i$ for $i = 1, \ldots, n$
and a section $\sigma : \kappa \to R/I$ of the canonical surjection
$R/I \to \kappa$. The restriction $M_{i, \kappa}$ of $M_i$ via $\sigma$
is a $\kappa$-vector space of dimension $l_i = \text{length}_R(M_i)$ and
using Lemma \ref{lemma-determinant-quotient-ring} we see that
$$
\det\nolimits_\kappa(M_i) = \wedge_\kappa^{l_i}(M_{i, \kappa})
$$
These isomorphisms are compatible with the isomorphisms
$\gamma_{K \to M \to L}$ of Lemma \ref{lemma-det-exact-sequences}
for short exact sequences of finite length $R$-modules annihilated
by $I$. The conclusion is that verifying a property of
$\det_\kappa$ often reduces to verifying corresponding properties
of the usual determinant on the category finite dimensional vector
spaces.

\medskip\noindent
For $I$ we can take the annihilator
(Algebra, Definition \ref{algebra-definition-annihilator})
of the module $M = \bigoplus M_i$. In this case we see that
$R/I \subset \text{End}_R(M)$ hence has finite length.
Thus $R/I$ is an Artinian local ring with residue field $\kappa$.
Since an Artinian local ring is complete we see that $R/I$
has a coefficient ring by the Cohen structure theorem
(Algebra, Theorem \ref{algebra-theorem-cohen-structure-theorem})
which is a field by our assumption on $R$.
\end{remark}

\noindent
Here is a case where we can compute the determinant of a linear map.
In fact there is nothing mysterious about this in any case, see
Example \ref{example-determinant-map} for a random example.

\begin{lemma}
\label{lemma-times-u-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $u \in R^*$ be a unit.
Let $M$ be a module of finite length over $R$.
Denote $u_M : M \to M$ the map multiplication by $u$.
Then
$$
\det\nolimits_\kappa(u_M) :
\det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is multiplication by $\overline{u}^l$ where $l = \text{length}_R(M)$
and $\overline{u} \in \kappa^*$ is the image of $u$.
\end{lemma}

\begin{proof}
Denote $f_M \in \kappa^*$ the element such that
$\det\nolimits_\kappa(u_M) = f_M \text{id}_{\det\nolimits_\kappa(M)}$.
Suppose that $0 \to K \to L \to M \to 0$ is a short
exact sequence of finite $R$-modules. Then we see that
$u_k$, $u_L$, $u_M$ give an isomorphism of short exact sequences.
Hence by Lemma \ref{lemma-det-exact-sequences} (1) we conclude that
$f_K f_M = f_L$.
This means that by induction on length it suffices to prove the
lemma in the case of length $1$ where it is trivial.
\end{proof}

\begin{example}
\label{example-determinant-map}
Consider the local ring $R = \mathbf{Z}_p$.
Set $M = \mathbf{Z}_p/(p^2) \oplus \mathbf{Z}_p/(p^3)$.
Let $u : M \to M$ be the map given by the matrix
$$
u =
\left(
\begin{matrix}
a & b \\
pc & d
\end{matrix}
\right)
$$
where $a, b, c, d \in \mathbf{Z}_p$, and $a, d \in \mathbf{Z}_p^*$.
In this case $\det_\kappa(u)$ equals multiplication by
$a^2d^3 \bmod p \in \mathbf{F}_p^*$. This can easily be seen
by consider the effect of $u$ on the symbol
$[p^2e, pe, pf, e, f]$ where $e = (0 , 1) \in M$ and
$f = (1, 0) \in M$.
\end{example}





\subsection{Periodic complexes and determinants}
\label{subsection-periodic-complexes-determinants}

\noindent
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. We are going to use the determinant construction to define
an invariant of this situation. See
Subsection \ref{subsection-determinants-finite-length}.
Let us abbreviate
$K_\varphi = \Ker(\varphi)$,
$I_\varphi = \Im(\varphi)$,
$K_\psi = \Ker(\psi)$, and
$I_\psi = \Im(\psi)$.
The short exact sequences
$$
0 \to K_\varphi \to M \to I_\varphi \to 0, \quad
0 \to K_\psi \to M \to I_\psi \to 0
$$
give isomorphisms
$$
\gamma_\varphi :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M), \quad
\gamma_\psi :
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
\longrightarrow
\det\nolimits_\kappa(M),
$$
see Lemma \ref{lemma-det-exact-sequences}.
On the other hand the exactness of the complex gives equalities
$K_\varphi = I_\psi$, and $K_\psi = I_\varphi$
and hence an isomorphism
$$
\sigma :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
$$
by switching the factors. Using this notation we can define our invariant.

\begin{definition}
\label{definition-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. The {\it determinant of $(M, \varphi, \psi)$} is
the element
$$
\det\nolimits_\kappa(M, \varphi, \psi) \in \kappa^*
$$
such that the composition
$$
\det\nolimits_\kappa(M)
\xrightarrow{\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}}
\det\nolimits_\kappa(M)
$$
is multiplication by
$(-1)^{\text{length}_R(I_\varphi)\text{length}_R(I_\psi)}
\det\nolimits_\kappa(M, \varphi, \psi)$.
\end{definition}

\begin{remark}
\label{remark-more-elementary}
Here is a more down to earth description of the determinant
introduced above. Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Let us abbreviate $I_\varphi = \Im(\varphi)$,
$I_\psi = \Im(\psi)$ as above.
Assume that $\text{length}_R(I_\varphi) = a$ and
$\text{length}_R(I_\psi) = b$, so that $a + b = \text{length}_R(M)$
by exactness. Choose admissible sequences
$x_1, \ldots, x_a \in I_\varphi$ and $y_1, \ldots, y_b \in I_\psi$
such that the symbol $[x_1, \ldots, x_a]$ generates $\det_\kappa(I_\varphi)$
and the symbol $[x_1, \ldots, x_b]$ generates $\det_\kappa(I_\psi)$.
Choose $\tilde x_i \in M$ such that $\varphi(\tilde x_i) = x_i$.
Choose $\tilde y_j \in M$ such that $\psi(\tilde y_j) = y_j$.
Then $\det_\kappa(M, \varphi, \psi)$ is characterized
by the equality
$$
[x_1, \ldots, x_a, \tilde y_1, \ldots, \tilde y_b]
=
(-1)^{ab} \det\nolimits_\kappa(M, \varphi, \psi)
[y_1, \ldots, y_b, \tilde x_1, \ldots, \tilde x_a]
$$
in $\det_\kappa(M)$. This also explains the sign.
\end{remark}

\begin{lemma}
\label{lemma-periodic-determinant-shift}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Then
$$
\det\nolimits_\kappa(M, \varphi, \psi)
\det\nolimits_\kappa(M, \psi, \varphi)
= 1.
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant-sign}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \varphi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \varphi)$ is
exact. Then $\text{length}_R(M) = 2 \text{length}_R(\Im(\varphi))$
and
$$
\det\nolimits_\kappa(M, \varphi, \varphi)
=
(-1)^{\text{length}_R(\Im(\varphi))}
=
(-1)^{\frac{1}{2}\text{length}_R(M)}
$$
\end{lemma}

\begin{proof}
Follows directly from the sign rule in the definitions.
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant-easy-case}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
\begin{enumerate}
\item if $\varphi : M \to M$ is an isomorphism then
$\det_\kappa(M, \varphi, 0) = \det_\kappa(\varphi)$.
\item if $\psi : M \to M$ is an isomorphism then
$\det_\kappa(M, 0, \psi) = \det_\kappa(\psi)^{-1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove (1). Set $\psi = 0$. Then we may, with notation
as above Definition \ref{definition-periodic-determinant}, identify
$K_\varphi = I_\psi = 0$, $I_\varphi = K_\psi = M$.
With these identifications, the map
$$
\gamma_\varphi :
\kappa \otimes \det\nolimits_\kappa(M)
=
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is identified with $\det_\kappa(\varphi^{-1})$. On the other hand the
map $\gamma_\psi$ is identified with the identity map. Hence
$\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$ is equal
to $\det_\kappa(\varphi)$ in this case. Whence the result.
We omit the proof of (2).
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Suppose that we have a short exact sequence of
$(2, 1)$-periodic complexes
$$
0 \to (M_1, \varphi_1, \psi_1)
\to (M_2, \varphi_2, \psi_2)
\to (M_3, \varphi_3, \psi_3)
\to 0
$$
with all $M_i$ of finite length, and each $(M_1, \varphi_1, \psi_1)$ exact.
Then
$$
\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3).
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
Let us abbreviate
$I_{\varphi, i} = \Im(\varphi_i)$,
$K_{\varphi, i} = \Ker(\varphi_i)$,
$I_{\psi, i} = \Im(\psi_i)$, and
$K_{\psi, i} = \Ker(\psi_i)$.
Observe that we have a commutative square
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] &
K_{\varphi, 1} \ar[r] \ar[d] &
K_{\varphi, 2} \ar[r] \ar[d] &
K_{\varphi, 3} \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M_1 \ar[r] \ar[d] &
M_2 \ar[r] \ar[d] &
M_3 \ar[r] \ar[d] &
0 \\
0 \ar[r] &
I_{\varphi, 1} \ar[r] \ar[d] &
I_{\varphi, 2} \ar[r] \ar[d] &
I_{\varphi, 3} \ar[r] \ar[d] &
0 \\
& 0  & 0  & 0  &
}
$$
of finite length $R$-modules with exact rows and columns.
The top row is exact since it can be identified with the
sequence $I_{\psi, 1} \to I_{\psi, 2} \to I_{\psi, 3} \to 0$
of images, and similarly for the bottom row. There is a similar diagram
involving the modules $I_{\psi, i}$ and $K_{\psi, i}$.
By definition $\det_\kappa(M_2, \varphi_2, \psi_2)$
corresponds, up to a sign, to the composition of the left vertical maps
in the following diagram
$$
\xymatrix{
\det_\kappa(M_1) \otimes
\det_\kappa(M_3) \ar[r]^\gamma
\ar[d]^{\gamma^{-1} \otimes \gamma^{-1}} &
\det_\kappa(M_2)
\ar[d]^{\gamma^{-1}} \\
\det\nolimits_\kappa(K_{\varphi, 1})
\otimes
\det\nolimits_\kappa(I_{\varphi, 1})
\otimes
\det\nolimits_\kappa(K_{\varphi, 3})
\otimes
\det\nolimits_\kappa(I_{\varphi, 3})
\ar[d]^{\sigma \otimes \sigma}
\ar[r]^-{\gamma \otimes \gamma} &
\det\nolimits_\kappa(K_{\varphi, 2})
\otimes
\det\nolimits_\kappa(I_{\varphi, 2})
\ar[d]^\sigma
\\
\det\nolimits_\kappa(K_{\psi, 1})
\otimes
\det\nolimits_\kappa(I_{\psi, 1})
\otimes
\det\nolimits_\kappa(K_{\psi, 3})
\otimes
\det\nolimits_\kappa(I_{\psi, 3})
\ar[d]^{\gamma \otimes \gamma}
\ar[r]^-{\gamma \otimes \gamma}
&
\det\nolimits_\kappa(K_{\psi, 2})
\otimes
\det\nolimits_\kappa(I_{\psi, 2})
\ar[d]^\gamma \\
\det_\kappa(M_1)
\otimes
\det_\kappa(M_3) \ar[r]^\gamma
&
\det_\kappa(M_2)
}
$$
The top and bottom squares are commutative up to sign
by applying Lemma \ref{lemma-det-exact-sequences} (2).
The middle square is trivially
commutative (we are just switching factors). Hence we see
that
$\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\epsilon \det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3)
$
for some sign $\epsilon$. And the sign can be worked out, namely
the outer rectangle in the diagram above commutes up to
\begin{eqnarray*}
\epsilon & = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(K_{\varphi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(K_{\psi, 3})} \\
& = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(I_{\psi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(I_{\varphi, 3})}
\end{eqnarray*}
(proof omitted). It follows easily from this that the signs
work out as well.
\end{proof}

\begin{example}
\label{example-dual-numbers}
Let $k$ be a field.
Consider the ring $R = k[T]/(T^2)$ of dual numbers over $k$.
Denote $t$ the class of $T$ in $R$.
Let $M = R$ and $\varphi = ut$, $\psi = vt$ with $u, v \in k^*$.
In this case $\det_k(M)$ has generator $e = [t, 1]$.
We identify $I_\varphi = K_\varphi = I_\psi = K_\psi = (t)$.
Then $\gamma_\varphi(t \otimes t) = u^{-1}[t, 1]$
(since $u^{-1} \in M$ is a lift of $t \in I_\varphi$)
and $\gamma_\psi(t \otimes t) = v^{-1}[t, 1]$ (same reason).
Hence we see that $\det_k(M, \varphi, \psi) = -u/v \in k^*$.
\end{example}

\begin{example}
\label{example-Zp}
Let $R = \mathbf{Z}_p$ and let $M = \mathbf{Z}_p/(p^l)$.
Let $\varphi = p^b u$ and $\varphi = p^a v$ with $a, b \geq 0$,
$a + b = l$ and $u, v \in \mathbf{Z}_p^*$.
Then a computation as in Example \ref{example-dual-numbers}
shows that
\begin{eqnarray*}
\det\nolimits_{\mathbf{F}_p}(\mathbf{Z}_p/(p^l), p^bu, p^av) & = &
(-1)^{ab}u^a/v^b \bmod p \\
& = &
(-1)^{\text{ord}_p(\alpha)\text{ord}_p(\beta)}
\frac{\alpha^{\text{ord}_p(\beta)}}{\beta^{\text{ord}_p(\alpha)}} \bmod p
\end{eqnarray*}
with $\alpha = p^bu, \beta = p^av \in \mathbf{Z}_p$.
See Lemma \ref{lemma-symbol-is-usual-tame-symbol}
for a more general case (and a proof).
\end{example}

\begin{example}
\label{example-generic-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus b}$ be $l = a + b$ dimensional.
Let $\varphi$ and $\psi$ be the following diagonal matrices
$$
\varphi = \text{diag}(u_1, \ldots, u_a, 0, \ldots, 0),
\quad
\psi = \text{diag}(0, \ldots, 0, v_1, \ldots, v_b)
$$
with $u_i, v_j \in k^*$. In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
\frac{u_1 \ldots u_a}{v_1 \ldots v_b}.
$$
This can be seen by a direct computation or by computing in case $l = 1$
and using the additivity of Lemma \ref{lemma-periodic-determinant}.
\end{example}

\begin{example}
\label{example-special-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus a}$ be $l = 2a$ dimensional.
Let $\varphi$ and $\psi$ be the following block matrices
$$
\varphi =
\left(
\begin{matrix}
0 & U \\
0 & 0
\end{matrix}
\right),
\quad
\psi =
\left(
\begin{matrix}
0 & V \\
0 & 0
\end{matrix}
\right),
$$
with $U, V \in \text{Mat}(a \times a, k)$ invertible.
In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
(-1)^a\frac{\det(U)}{\det(V)}.
$$
This can be seen by a direct computation.
The case $a = 1$ is similar to the computation in
Example \ref{example-dual-numbers}.
\end{example}

\begin{example}
\label{example-a-la-oort}
Let $R = k$ be a field.
Let $M = k^{\oplus 4}$.
Let
$$
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
u_1 &   0 &   0 &   0 \\
  0 &   0 &   0 &   0 \\
  0 &   0 & u_2 &   0
\end{matrix}
\right)
\quad
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
  0 &   0 & v_2 &   0 \\
  0 &   0 &   0 &   0 \\
v_1 &   0 &   0 &   0
\end{matrix}
\right)
\quad
$$
with $u_1, u_2, v_1, v_2 \in k^*$.
Then we have
$$
\det\nolimits_k(M, \varphi, \psi) = -\frac{u_1u_2}{v_1v_2}.
$$
\end{example}

\noindent
Next we come to the analogue of the fact that the determinant
of a composition of linear endomorphisms is the product of
the determinants. To avoid very long formulae we
write $I_\varphi = \Im(\varphi)$, and
$K_\varphi = \Ker(\varphi)$
for any $R$-module map $\varphi : M \to M$.
We also denote $\varphi\psi = \varphi \circ \psi$
for a pair of morphisms $\varphi, \psi : M \to M$.

\begin{lemma}
\label{lemma-multiplicativity-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
Let $\alpha, \beta, \gamma$ be endomorphisms of $M$.
Assume that
\begin{enumerate}
\item $I_\alpha = K_{\beta\gamma}$, and similarly for any permutation
of $\alpha, \beta, \gamma$,
\item $K_\alpha = I_{\beta\gamma}$, and similarly for any permutation
of $\alpha, \beta, \gamma$.
\end{enumerate}
Then
\begin{enumerate}
\item The triple $(M, \alpha, \beta\gamma)$
is an exact $(2, 1)$-periodic complex.
\item The triple $(I_\gamma, \alpha, \beta)$
is an exact $(2, 1)$-periodic complex.
\item The triple $(M/K_\beta, \alpha, \gamma)$
is an exact $(2, 1)$-periodic complex.
\item We have
$$
\det\nolimits_\kappa(M, \alpha, \beta\gamma)
=
\det\nolimits_\kappa(I_\gamma, \alpha, \beta)
\det\nolimits_\kappa(M/K_\beta, \alpha, \gamma).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that the assumptions imply part (1) of the lemma.

\medskip\noindent
To see part (1) note that the assumptions imply that
$I_{\gamma\alpha} = I_{\alpha\gamma}$, and similarly for kernels
and any other pair of morphisms.
Moreover, we see that
$I_{\gamma\beta} =I_{\beta\gamma} = K_\alpha \subset I_\gamma$ and
similarly for any other pair. In particular we get a short exact sequence
$$
0 \to I_{\beta\gamma} \to I_\gamma \xrightarrow{\alpha} I_{\alpha\gamma} \to 0
$$
and similarly we get a short exact sequence
$$
0 \to I_{\alpha\gamma} \to I_\gamma \xrightarrow{\beta} I_{\beta\gamma} \to 0.
$$
This proves $(I_\gamma, \alpha, \beta)$ is an exact $(2, 1)$-periodic
complex. Hence part (2) of the lemma holds.

\medskip\noindent
To see that $\alpha$, $\gamma$ give well defined endomorphisms
of $M/K_\beta$ we have to check that $\alpha(K_\beta) \subset K_\beta$
and $\gamma(K_\beta) \subset K_\beta$. This is true because
$\alpha(K_\beta) = \alpha(I_{\gamma\alpha}) = I_{\alpha\gamma\alpha}
\subset I_{\alpha\gamma} = K_\beta$, and similarly in the other case.
The kernel of the map $\alpha : M/K_\beta \to M/K_\beta$ is
$K_{\beta\alpha}/K_\beta = I_\gamma/K_\beta$. Similarly,
the kernel of $\gamma : M/K_\beta \to M/K_\beta$ is equal to
$I_\alpha/K_\beta$. Hence we conclude that (3) holds.

\medskip\noindent
We introduce $r = \text{length}_R(K_\alpha)$,
$s = \text{length}_R(K_\beta)$ and $t = \text{length}_R(K_\gamma)$.
By the exact sequences above and our hypotheses we have
$\text{length}_R(I_\alpha) = s + t$, $\text{length}_R(I_\beta) = r + t$,
$\text{length}_R(I_\gamma) = r + s$, and
$\text{length}(M) = r + s + t$.
Choose
\begin{enumerate}
\item an admissible sequence $x_1, \ldots, x_r \in K_\alpha$
generating $K_\alpha$
\item an admissible sequence $y_1, \ldots, y_s \in K_\beta$
generating $K_\beta$,
\item an admissible sequence $z_1, \ldots, z_t \in K_\gamma$
generating $K_\gamma$,
\item elements $\tilde x_i \in M$ such that $\beta\gamma\tilde x_i = x_i$,
\item elements $\tilde y_i \in M$ such that $\alpha\gamma\tilde y_i = y_i$,
\item elements $\tilde z_i \in M$ such that $\beta\alpha\tilde z_i = z_i$.
\end{enumerate}
With these choices the sequence
$y_1, \ldots, y_s, \alpha\tilde z_1, \ldots, \alpha\tilde z_t$
is an admissible sequence in $I_\alpha$ generating it.
Hence, by Remark \ref{remark-more-elementary} the determinant
$D = \det_\kappa(M, \alpha, \beta\gamma)$ is the
unique element of $\kappa^*$ such that
\begin{align*}
[y_1, \ldots, y_s,
\alpha\tilde z_1, \ldots, \alpha\tilde z_s,
\tilde x_1, \ldots, \tilde x_r] \\
= (-1)^{r(s + t)} D
[x_1, \ldots, x_r,
\gamma\tilde y_1, \ldots, \gamma\tilde y_s,
\tilde z_1, \ldots, \tilde z_t]
\end{align*}
By the same remark, we see that
$D_1 = \det_\kappa(M/K_\beta, \alpha, \gamma)$
is characterized by
$$
[y_1, \ldots, y_s,
\alpha\tilde z_1, \ldots, \alpha\tilde z_t,
\tilde x_1, \ldots, \tilde x_r]
=
(-1)^{rt} D_1
[y_1, \ldots, y_s,
\gamma\tilde x_1, \ldots, \gamma\tilde x_r,
\tilde z_1, \ldots, \tilde z_t]
$$
By the same remark, we see that
$D_2 = \det_\kappa(I_\gamma, \alpha, \beta)$ is characterized by
$$
[y_1, \ldots, y_s,
\gamma\tilde x_1, \ldots, \gamma\tilde x_r,
\tilde z_1, \ldots, \tilde z_t]
=
(-1)^{rs} D_2
[x_1, \ldots, x_r,
\gamma\tilde y_1, \ldots, \gamma\tilde y_s,
\tilde z_1, \ldots, \tilde z_t]
$$
Combining the formulas above we see that $D = D_1 D_2$
as desired.
\end{proof}


\begin{lemma}
\label{lemma-tricky}
Let $R$ be a local ring with residue field $\kappa$.
Let $\alpha : (M, \varphi, \psi) \to (M', \varphi', \psi')$
be a morphism of $(2, 1)$-periodic complexes over $R$.
Assume
\begin{enumerate}
\item $M$, $M'$ have finite length,
\item $(M, \varphi, \psi)$, $(M', \varphi', \psi')$ are exact,
\item the maps $\varphi$, $\psi$ induce the zero map on
$K = \Ker(\alpha)$, and
\item the maps $\varphi$, $\psi$ induce the zero map on
$Q = \Coker(\alpha)$.
\end{enumerate}
Denote $N = \alpha(M) \subset M'$. We obtain two short exact sequences
of $(2, 1)$-periodic complexes
$$
\begin{matrix}
0 \to (N, \varphi', \psi') \to (M', \varphi', \psi') \to (Q, 0, 0) \to 0 \\
0 \to (K, 0, 0) \to (M, \varphi, \psi) \to (N, \varphi', \psi') \to 0
\end{matrix}
$$
which induce two isomorphisms $\alpha_i : Q \to K$, $i = 0, 1$. Then
$$
\det\nolimits_\kappa(M, \varphi, \psi)
=
\det\nolimits_\kappa(\alpha_0^{-1} \circ \alpha_1)
\det\nolimits_\kappa(M', \varphi', \psi')
$$
In particular, if $\alpha_0 = \alpha_1$, then
$\det\nolimits_\kappa(M, \varphi, \psi) =
\det\nolimits_\kappa(M', \varphi', \psi')$.
\end{lemma}

\begin{proof}
There are (at least) two ways to prove this lemma. One is to produce an
enormous commutative diagram using the properties of the determinants.
The other is to use the characterization of the determinants in terms
of admissible sequences of elements. It is the second approach that we
will use.

\medskip\noindent
First let us explain precisely what the maps $\alpha_i$ are.
Namely, $\alpha_0$ is the composition
$$
\alpha_0 : Q = H^0(Q, 0, 0) \to H^1(N, \varphi', \psi') \to H^2(K, 0, 0) = K
$$
and $\alpha_1$ is the composition
$$
\alpha_1 : Q = H^1(Q, 0, 0) \to H^2(N, \varphi', \psi') \to H^3(K, 0, 0) = K
$$
coming from the boundary maps of the short exact sequences of complexes
displayed in the lemma. The fact that the
complexes $(M, \varphi, \psi)$, $(M', \varphi', \psi')$ are exact
implies these maps are isomorphisms.

\medskip\noindent
We will use the notation $I_\varphi = \Im(\varphi)$,
$K_\varphi = \Ker(\varphi)$ and similarly for the other maps.
Exactness for $M$ and $M'$
means that $K_\varphi = I_\psi$ and three similar equalities.
We introduce $k = \text{length}_R(K)$, $a = \text{length}_R(I_\varphi)$,
$b = \text{length}_R(I_\psi)$. Then we see that $\text{length}_R(M) = a + b$,
and $\text{length}_R(N) = a + b - k$, $\text{length}_R(Q) = k$
and $\text{length}_R(M') = a + b$. The exact sequences below will show
that also $\text{length}_R(I_{\varphi'}) = a$ and
$\text{length}_R(I_{\psi'}) = b$.

\medskip\noindent
The assumption that $K \subset K_\varphi = I_\psi$ means that
$\varphi$ factors through $N$ to give an exact sequence
$$
0 \to \alpha(I_\psi) \to N \xrightarrow{\varphi\alpha^{-1}} I_\psi \to 0.
$$
Here $\varphi\alpha^{-1}(x') = y$ means $x' = \alpha(x)$ and $y = \varphi(x)$.
Similarly, we have
$$
0 \to \alpha(I_\varphi) \to N \xrightarrow{\psi\alpha^{-1}} I_\varphi \to 0.
$$
The assumption that $\psi'$ induces the zero map on
$Q$ means that $I_{\psi'} = K_{\varphi'} \subset N$.
This means the quotient $\varphi'(N) \subset I_{\varphi'}$
is identified with $Q$. Note that $\varphi'(N) = \alpha(I_\varphi)$.
Hence we conclude there is an isomorphism
$$
\varphi' : Q \to I_{\varphi'}/\alpha(I_\varphi)
$$
simply described by
$\varphi'(x' \bmod N) = \varphi'(x') \bmod \alpha(I_\varphi)$.
In exactly the same way we get
$$
\psi' : Q \to I_{\psi'}/\alpha(I_\psi)
$$
Finally, note that $\alpha_0$ is the composition
$$
\xymatrix{
Q \ar[r]^-{\varphi'} &
I_{\varphi'}/\alpha(I_\varphi)
\ar[rrr]^-{\psi\alpha^{-1}|_{I_{\varphi'}/\alpha(I_\varphi)}} & & &
K
}
$$
and similarly
$\alpha_1 = \varphi\alpha^{-1}|_{I_{\psi'}/\alpha(I_\psi)} \circ \psi'$.

\medskip\noindent
To shorten the formulas below we are going to write $\alpha x$ instead
of $\alpha(x)$ in the following. No confusion should result since
all maps are indicated by Greek letters and elements by Roman letters.
We are going to choose
\begin{enumerate}
\item an admissible sequence $z_1, \ldots, z_k \in K$
generating $K$,
\item elements $z'_i \in M$ such that $\varphi z'_i = z_i$,
\item elements $z''_i \in M$ such that $\psi z''_i = z_i$,
\item elements $x_{k + 1}, \ldots, x_a \in I_\varphi$ such
that $z_1, \ldots, z_k, x_{k + 1}, \ldots, x_a$ is an admissible
sequence generating $I_\varphi$,
\item elements $\tilde x_i \in M$ such that $\varphi \tilde x_i = x_i$,
\item elements $y_{k + 1}, \ldots, y_b \in I_\psi$ such that
$z_1, \ldots, z_k, y_{k + 1}, \ldots, y_b$ is an admissible
sequence generating $I_\psi$,
\item elements $\tilde y_i \in M$ such that $\psi \tilde y_i = y_i$, and
\item elements $w_1, \ldots, w_k \in M'$ such that
$w_1 \bmod N, \ldots, w_k \bmod N$ are an admissible sequence
in $Q$ generating $Q$.
\end{enumerate}
By Remark \ref{remark-more-elementary} the element
$D = \det_\kappa(M, \varphi, \psi) \in \kappa^*$ is
characterized by
\begin{eqnarray*}
& &
[z_1, \ldots, z_k,
x_{k + 1}, \ldots, x_a,
z''_1, \ldots, z''_k,
\tilde y_{k + 1}, \ldots, \tilde y_b] \\
& = &
(-1)^{ab} D
[z_1, \ldots, z_k,
y_{k + 1}, \ldots, y_b,
z'_1, \ldots, z'_k,
\tilde x_{k + 1}, \ldots, \tilde x_a]
\end{eqnarray*}
Note that by the discussion above
$\alpha x_{k + 1}, \ldots, \alpha x_a, \varphi w_1, \ldots, \varphi w_k$
is an admissible sequence generating $I_{\varphi'}$ and
$\alpha y_{k + 1}, \ldots, \alpha y_b, \psi w_1, \ldots, \psi w_k$
is an admissible sequence generating $I_{\psi'}$.
Hence by Remark \ref{remark-more-elementary} the element
$D' = \det_\kappa(M', \varphi', \psi') \in \kappa^*$ is
characterized by
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b,
w_1, \ldots, w_k]
\\
& = &
(-1)^{ab} D'
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a,
w_1, \ldots, w_k]
\end{eqnarray*}
Note how in the first, resp.\ second displayed formula
the first, resp.\ last $k$ entries of the symbols on both sides
are the same. Hence these formulas are really equivalent to the
equalities
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\alpha z''_1, \ldots, \alpha z''_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b] \\
& = &
(-1)^{ab} D
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\alpha z'_1, \ldots, \alpha z'_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
and
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b]
\\
& = &
(-1)^{ab} D'
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
in $\det_\kappa(N)$. Note that
$\varphi' w_1, \ldots, \varphi' w_k$
and
$\alpha z''_1, \ldots, z''_k$
are admissible sequences generating the module
$I_{\varphi'}/\alpha(I_\varphi)$. Write
$$
[\varphi' w_1, \ldots, \varphi' w_k]
= \lambda_0 [\alpha z''_1, \ldots, \alpha z''_k]
$$
in $\det_\kappa(I_{\varphi'}/\alpha(I_\varphi))$
for some $\lambda_0 \in \kappa^*$. Similarly,
write
$$
[\psi' w_1, \ldots, \psi' w_k]
= \lambda_1 [\alpha z'_1, \ldots, \alpha z'_k]
$$
in $\det_\kappa(I_{\psi'}/\alpha(I_\psi))$
for some $\lambda_1 \in \kappa^*$. On the one hand
it is clear that
$$
\alpha_i([w_1, \ldots, w_k]) = \lambda_i[z_1, \ldots, z_k]
$$
for $i = 0, 1$ by our description of $\alpha_i$ above,
which means that
$$
\det\nolimits_\kappa(\alpha_0^{-1} \circ \alpha_1)
=
\lambda_1/\lambda_0
$$
and
on the other hand it is clear that
\begin{eqnarray*}
& &
\lambda_0 [\alpha x_{k + 1}, \ldots, \alpha x_a,
\alpha z''_1, \ldots, \alpha z''_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b] \\
& = &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b]
\end{eqnarray*}
and
\begin{eqnarray*}
& &
\lambda_1[\alpha y_{k + 1}, \ldots, \alpha y_b,
\alpha z'_1, \ldots, \alpha z'_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a] \\
& = &
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
which imply $\lambda_0 D = \lambda_1 D'$. The lemma follows.
\end{proof}








\subsection{Symbols}
\label{subsection-symbols}

\noindent
The correct generality for this construction is perhaps the
situation of the following lemma.

\begin{lemma}
\label{lemma-pre-symbol}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module of dimension $1$.
Assume $\varphi, \psi : M \to M$ are two injective
$A$-module maps, and assume $\varphi(\psi(M)) = \psi(\varphi(M))$,
for example if $\varphi$ and $\psi$ commute.
Then $\text{length}_R(M/\varphi\psi M) < \infty$
and $(M/\varphi\psi M, \varphi, \psi)$ is an exact
$(2, 1)$-periodic complex.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a minimal prime of the support of $M$.
Then $M_{\mathfrak q}$ is a finite length $A_{\mathfrak q}$-module,
see Algebra, Lemma \ref{algebra-lemma-support-point}.
Hence both $\varphi$ and $\psi$
induce isomorphisms $M_{\mathfrak q} \to M_{\mathfrak q}$.
Thus the support of $M/\varphi\psi M$ is $\{\mathfrak m_A\}$
and hence it has finite length (see lemma cited above).
Finally, the kernel of $\varphi$ on $M/\varphi\psi M$
is clearly $\psi M/\varphi\psi M$, and hence the kernel
of $\varphi$ is the image of $\psi$ on $M/\varphi\psi M$.
Similarly the other way since $M/\varphi\psi M = M/\psi\varphi M$
by assumption.
\end{proof}

\begin{lemma}
\label{lemma-symbol-defined}
Let $A$ be a Noetherian local ring. Let $a, b \in A$.
\begin{enumerate}
\item If $M$ is a finite $A$-module of dimension $1$
such that $a, b$ are nonzerodivisors on $M$, then
$\text{length}_A(M/abM) < \infty$ and
$(M/abM, a, b)$ is a $(2, 1)$-periodic exact complex.
\item If $a, b$ are nonzerodivisors and $\dim(A) = 1$
then $\text{length}_A(A/(ab)) < \infty$ and
$(A/(ab), a, b)$ is a $(2, 1)$-periodic exact complex.
\end{enumerate}
In particular, in these cases
$\det_\kappa(M/abM, a, b) \in \kappa^*$,
resp.\ $\det_\kappa(A/(ab), a, b) \in \kappa^*$
are defined.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-pre-symbol}.
\end{proof}

\begin{definition}
\label{definition-symbol-M}
Let $A$ be a Noetherian local ring with residue field $\kappa$.
Let $a, b \in A$.
Let $M$ be a finite $A$-module of dimension $1$
such that $a, b$ are nonzerodivisors on $M$.
We define the {\it symbol associated to $M, a, b$}
to be the element
$$
d_M(a, b) =
\det\nolimits_\kappa(M/abM, a, b) \in \kappa^*
$$
\end{definition}

\begin{lemma}
\label{lemma-multiplicativity-symbol}
Let $A$ be a Noetherian local ring.
Let $a, b, c \in A$. Let $M$ be a finite $A$-module
with $\dim(\text{Supp}(M)) = 1$. Assume $a, b, c$ are nonzerodivisors on $M$.
Then
$$
d_M(a, bc) = d_M(a, b) d_M(a, c)
$$
and $d_M(a, b)d_M(b, a) = 1$.
\end{lemma}

\begin{proof}
The first statement follows from Lemma \ref{lemma-multiplicativity-determinant}
applied to $M/abcM$ and endomorphisms $\alpha, \beta, \gamma$ given by
multiplication by $a, b, c$.
The second comes from Lemma \ref{lemma-periodic-determinant-shift}.
\end{proof}

\begin{definition}
\label{definition-tame-symbol}
Let $A$ be a Noetherian local domain of dimension $1$
with residue field $\kappa$.
Let $K$ be the fraction field of $A$.
We define the {\it tame symbol} of $A$ to be the map
$$
K^* \times K^* \longrightarrow \kappa^*,
\quad
(x, y) \longmapsto d_A(x, y)
$$
where $d_A(x, y)$ is extended to $K^* \times K^*$ by the multiplicativity of
Lemma \ref{lemma-multiplicativity-symbol}.
\end{definition}

\noindent
It is clear that we may extend more generally $d_M(-, -)$ to
certain rings of fractions of $A$ (even if $A$ is not a domain).

\begin{lemma}
\label{lemma-symbol-when-equal}
Let $A$ be a Noetherian local ring and $M$ a finite $A$-module of
dimension $1$. Let $a \in A$ be a nonzerodivisor on $M$.
Then $d_M(a, a) = (-1)^{\text{length}_A(M/aM)}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-periodic-determinant-sign}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-when-one-is-a-unit}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module of dimension $1$.
Let $b \in A$ be a nonzerodivisor on $M$, and let $u \in A^*$.
Then
$$
d_M(u, b) = u^{\text{length}_A(M/bM)} \bmod \mathfrak m_A.
$$
In particular, if $M = A$, then
$d_A(u, b) = u^{\text{ord}_A(b)} \bmod \mathfrak m_A$.
\end{lemma}

\begin{proof}
Note that in this case $M/ubM = M/bM$ on which multiplication
by $b$ is zero. Hence $d_M(u, b) = \det_\kappa(u|_{M/bM})$
by Lemma \ref{lemma-periodic-determinant-easy-case}. The lemma
then follows from Lemma \ref{lemma-times-u-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-short-exact-sequence}
Let $A$ be a Noetherian local ring.
Let $a, b \in A$.
Let
$$
0 \to M \to M' \to M'' \to 0
$$
be a short exact sequence of $A$-modules of dimension $1$
such that $a, b$ are nonzerodivisors on
all three $A$-modules.
Then
$$
d_{M'}(a, b) = d_M(a, b) d_{M''}(a, b)
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
It is easy to see that this leads to a short exact sequence
of exact $(2, 1)$-periodic complexes
$$
0 \to
(M/abM, a, b) \to
(M'/abM', a, b) \to
(M''/abM'', a, b) \to 0
$$
Hence the lemma follows from Lemma \ref{lemma-periodic-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-compare-modules}
Let $A$ be a Noetherian local ring.
Let $\alpha : M \to M'$ be a homomorphism of
finite $A$-modules of dimension $1$.
Let $a, b \in A$. Assume
\begin{enumerate}
\item $a$, $b$ are nonzerodivisors on both $M$ and $M'$, and
\item $\dim(\Ker(\alpha)), \dim(\Coker(\alpha)) \leq 0$.
\end{enumerate}
Then $d_M(a, b) = d_{M'}(a, b)$.
\end{lemma}

\begin{proof}
If $a \in A^*$, then the equality follows from the
equality $\text{length}(M/bM) = \text{length}(M'/bM')$
and Lemma \ref{lemma-symbol-when-one-is-a-unit}.
Similarly if $b$ is a unit the lemma holds as well
(by the symmetry of Lemma \ref{lemma-multiplicativity-symbol}).
Hence we may assume that $a, b \in \mathfrak m_A$.
This in particular implies that $\mathfrak m$ is not
an associated prime of $M$, and hence $\alpha : M \to M'$
is injective. This permits us to think of $M$ as a submodule of $M'$.
By assumption $M'/M$ is a finite $A$-module with support
$\{\mathfrak m_A\}$ and hence has finite length.
Note that for any third module $M''$ with $M \subset M'' \subset M'$
the maps $M \to M''$ and $M'' \to M'$ satisfy the assumptions of the lemma
as well. This reduces us, by induction on the length of $M'/M$,
to the case where $\text{length}_A(M'/M) = 1$.
Finally, in this case consider the map
$$
\overline{\alpha} : M/abM \longrightarrow M'/abM'.
$$
By construction the cokernel $Q$ of $\overline{\alpha}$ has
length $1$. Since $a, b \in \mathfrak m_A$, they act trivially on
$Q$. It also follows that the kernel $K$ of $\overline{\alpha}$ has
length $1$ and hence also $a$, $b$ act trivially on $K$.
Hence we may apply Lemma \ref{lemma-tricky}. Thus it suffices to see
that the two maps $\alpha_i : Q \to K$ are the same.
In fact, both maps are equal to the map
$q = x' \bmod \Im(\overline{\alpha}) \mapsto abx' \in K$.
We omit the verification.
\end{proof}

\begin{lemma}
\label{lemma-compute-symbol-M}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module with $\dim(\text{Supp}(M)) = 1$.
Let $a, b \in A$ nonzerodivisors on $M$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes in the support of $M$. Then
$$
d_M(a, b)
=
\prod\nolimits_{i = 1, \ldots, t}
d_{A/\mathfrak q_i}(a, b)^{
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})}
$$
as elements of $\kappa^*$.
\end{lemma}

\begin{proof}
Choose a filtration by $A$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_j/M_{j - 1}$ is isomorphic
to $A/\mathfrak p_j$ for some prime ideal $\mathfrak p_j$
of $A$. See Algebra, Lemma \ref{algebra-lemma-filter-Noetherian-module}.
For each $j$ we have either $\mathfrak p_j = \mathfrak q_i$
for some $i$, or $\mathfrak p_j = \mathfrak m_A$. Moreover,
for a fixed $i$, the number of $j$ such that
$\mathfrak p_j = \mathfrak q_i$ is equal to
$\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})$ by
Algebra, Lemma \ref{algebra-lemma-filter-minimal-primes-in-support}.
Hence $d_{M_j}(a, b)$ is defined for each $j$ and
$$
d_{M_j}(a, b)
=
\left\{
\begin{matrix}
d_{M_{j - 1}}(a, b) d_{A/\mathfrak q_i}(a, b) &
\text{if} & \mathfrak p_j = \mathfrak q_i \\
d_{M_{j - 1}}(a, b) & \text{if} & \mathfrak p_j = \mathfrak m_A
\end{matrix}
\right.
$$
by Lemma \ref{lemma-symbol-short-exact-sequence} in the first instance
and Lemma \ref{lemma-symbol-compare-modules} in the second. Hence the lemma.
\end{proof}

\begin{lemma}
\label{lemma-symbol-is-usual-tame-symbol}
Let $A$ be a discrete valuation ring with fraction field $K$.
For nonzero $x, y \in K$ we have
$$
d_A(x, y)
=
(-1)^{\text{ord}_A(x)\text{ord}_A(y)}
\frac{x^{\text{ord}_A(y)}}{y^{\text{ord}_A(x)}} \bmod \mathfrak m_A,
$$
in other words the symbol is equal to the usual tame symbol.
\end{lemma}

\begin{proof}
By multiplicativity it suffices to prove this when $x, y \in A$.
Let $t \in A$ be a uniformizer.
Write $x = t^bu$ and $y = t^bv$ for some $a, b \geq 0$
and $u, v \in A^*$. Set $l = a + b$. Then
$t^{l - 1}, \ldots, t^b$ is an admissible sequence in
$(x)/(xy)$ and $t^{l - 1}, \ldots, t^a$ is an admissible
sequence in $(y)/(xy)$. Hence by Remark \ref{remark-more-elementary}
we see that $d_A(x, y)$ is characterized by the equation
$$
[t^{l - 1}, \ldots, t^b, v^{-1}t^{b - 1}, \ldots, v^{-1}]
=
(-1)^{ab} d_A(x, y)
[t^{l - 1}, \ldots, t^a, u^{-1}t^{a - 1}, \ldots, u^{-1}].
$$
Hence by the admissible relations for the
symbols $[x_1, \ldots, x_l]$ we see that
$$
d_A(x, y) = (-1)^{ab} u^a/v^b \bmod \mathfrak m_A
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-symbol-is-steinberg-prepare}
Let $A$ be a Noetherian local ring.
Let $a, b \in A$.
Let $M$ be a finite $A$-module of dimension $1$ on
which each of $a$, $b$, $b - a$ are nonzerodivisors.
Then
$$
d_M(a, b - a)d_M(b, b) = d_M(b, b - a)d_M(a, b)
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-compute-symbol-M} it suffices to show the relation when
$M = A/\mathfrak q$ for some prime $\mathfrak q \subset A$ with
$\dim(A/\mathfrak q) = 1$.

\medskip\noindent
In case $M = A/\mathfrak q$ we may replace $A$ by $A/\mathfrak q$ and
$a, b$ by their images in $A/\mathfrak q$. Hence we may assume $A = M$
and $A$ a local Noetherian domain of dimension $1$. The reason is
that the residue field $\kappa$ of $A$ and $A/\mathfrak q$ are
the same and that for any $A/\mathfrak q$-module $M$ the determinant
taken over $A$ or over $A/\mathfrak q$ are canonically identified.
See Lemma \ref{lemma-determinant-quotient-ring}.

\medskip\noindent
It suffices to show the relation when both
$a, b$ are in the maximal ideal. Namely, the case where one
or both are units follows from Lemmas \ref{lemma-symbol-when-one-is-a-unit}
and \ref{lemma-symbol-when-equal}.

\medskip\noindent
Choose an extension $A \subset A'$ and factorizations
$a = ta'$, $b = tb'$ as in
Lemma \ref{lemma-Noetherian-domain-dim-1-two-elements}.
Note that also $b - a = t(b' - a')$ and that
$A' = (a', b') = (a', b' - a') = (b' - a', b')$.
Here and in the following we think of $A'$ as an $A$-module and
$a, b, a', b', t$ as $A$-module endomorphisms of $A'$.
We will use the notation $d^A_{A'}(a', b')$ and so on to indicate
$$
d^A_{A'}(a', b')
=
\det\nolimits_\kappa(A'/a'b'A', a', b')
$$
which is defined by Lemma \ref{lemma-pre-symbol}. The upper index ${}^A$
is used to distinguish this from the already defined symbol
$d_{A'}(a', b')$ which is different (for example because it has values
in the residue field of $A'$ which may be different from $\kappa$).
By Lemma \ref{lemma-symbol-compare-modules} we see that
$d_A(a, b) = d^A_{A'}(a, b)$,
and similarly for the other combinations.
Using this and multiplicativity we see that it suffices to prove
$$
d^A_{A'}(a', b' - a') d^A_{A'}(b', b')
=
d^A_{A'}(b', b' - a') d^A_{A'}(a', b')
$$
Now, since $(a', b') = A'$ and so on we have
$$
\begin{matrix}
A'/(a'(b' - a')) & \cong & A'/(a') \oplus A'/(b' - a') \\
A'/(b'(b' - a')) & \cong & A'/(b') \oplus A'/(b' - a') \\
A'/(a'b') & \cong & A'/(a') \oplus A'/(b')
\end{matrix}
$$
Moreover, note that multiplication by $b' - a'$ on
$A/(a')$ is equal to multiplication by $b'$, and that
multiplication by $b' - a'$ on $A/(b')$ is equal to multiplication by $-a'$.
Using Lemmas
\ref{lemma-periodic-determinant-easy-case} and
\ref{lemma-periodic-determinant}
we conclude
$$
\begin{matrix}
d^A_{A'}(a', b' - a') & = &
\det\nolimits_\kappa(b'|_{A'/(a')})^{-1}
\det\nolimits_\kappa(a'|_{A'/(b' - a')}) \\
d^A_{A'}(b', b' - a') & = &
\det\nolimits_\kappa(-a'|_{A'/(b')})^{-1}
\det\nolimits_\kappa(b'|_{A'/(b' - a')}) \\
d^A_{A'}(a', b') & = &
\det\nolimits_\kappa(b'|_{A'/(a')})^{-1}
\det\nolimits_\kappa(a'|_{A'/(b')})
\end{matrix}
$$
Hence we conclude that
$$
(-1)^{\text{length}_A(A'/(b'))}
d^A_{A'}(a', b' - a')
=
d^A_{A'}(b', b' - a') d^A_{A'}(a', b')
$$
the sign coming from the $-a'$ in the second equality above.
On the other hand, by Lemma \ref{lemma-periodic-determinant-sign} we have
$d^A_{A'}(b', b') = (-1)^{\text{length}_A(A'/(b'))}$ and the lemma
is proved.
\end{proof}

\noindent
The tame symbol is a Steinberg symbol.

\begin{lemma}
\label{lemma-symbol-is-steinberg}
Let $A$ be a Noetherian local domain of dimension $1$
with fraction field $K$. For $x \in K \setminus \{0, 1\}$
we have
$$
d_A(x, 1 -x) = 1
$$
\end{lemma}

\begin{proof}
Write $x = a/b$ with $a, b \in A$.
The hypothesis implies, since $1 - x = (b - a)/b$,
that also $b - a \not = 0$. Hence we compute
$$
d_A(x, 1 - x)
=
d_A(a, b - a)d_A(a, b)^{-1}d_A(b, b - a)^{-1}d_A(b, b)
$$
Thus we have to show that
$d_A(a, b - a) d_A(b, b) = d_A(b, b - a) d_A(a, b)$.
This is Lemma \ref{lemma-symbol-is-steinberg-prepare}.
\end{proof}










\subsection{Lengths and determinants}
\label{subsection-length-determinant}

\noindent
In this section we use the determinant to compare lattices.
The key lemma is the following.

\begin{lemma}
\label{lemma-key-lemma}
Let $R$ be a noetherian local ring.
Let $\mathfrak q \subset R$ be a prime with $\dim(R/\mathfrak q) = 1$.
Let $\varphi : M \to N$ be a homomorphism of finite $R$-modules.
Assume there exist $x_1, \ldots, x_l \in M$ and $y_1, \ldots, y_l \in M$
with the following properties
\begin{enumerate}
\item $M = \langle x_1, \ldots, x_l\rangle$,
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$,
\item $N = \langle y_1, \ldots, y_l\rangle$, and
\item $\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Then $\varphi$ is injective if and only if $\varphi_{\mathfrak q}$ is an
isomorphism, and in this case we have
$$
\text{length}_R(\Coker(\varphi)) = \text{ord}_{R/\mathfrak q}(f)
$$
where $f \in \kappa(\mathfrak q)$ is the element such that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l]
$$
in $\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$.
\end{lemma}

\begin{proof}
First, note that the lemma holds in case $l = 1$.
Namely, in this case $x_1$ is a basis of $M$ over $R/\mathfrak q$
and $y_1$ is a basis of $N$ over $R/\mathfrak q$ and we have
$\varphi(x_1) = fy_1$ for some $f \in R$. Thus $\varphi$ is injective
if and only if $f \not \in \mathfrak q$. Moreover,
$\Coker(\varphi) = R/(f, \mathfrak q)$ and hence the lemma
holds by definition of $\text{ord}_{R/q}(f)$
(see Algebra, Definition \ref{algebra-definition-ord}).

\medskip\noindent
In fact, suppose more generally that $\varphi(x_i) = f_iy_i$ for some
$f_i \in R$, $f_i \not \in \mathfrak q$. Then the induced maps
$$
\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\longrightarrow
\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
$$
are all injective and have cokernels isomorphic to
$R/(f_i, \mathfrak q)$. Hence we see that
$$
\text{length}_R(\Coker(\varphi)) = \sum \text{ord}_{R/\mathfrak q}(f_i).
$$
On the other hand it is clear that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f_1 \ldots f_l [y_1, \ldots, y_l]
$$
in this case from the admissible relation (b) for symbols.
Hence we see the result holds in this case also.

\medskip\noindent
We prove the general case by induction on $l$. Assume $l > 1$.
Let $i \in \{1, \ldots, l\}$ be minimal such that
$\varphi(x_1) \in \langle y_1, \ldots, y_i\rangle$.
We will argue by induction on $i$.
If $i = 1$, then we get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\langle x_1 \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle / \langle x_1 \rangle \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\langle y_1 \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle / \langle y_1 \rangle \ar[r] &
0
}
$$
and the lemma follows from the snake lemma and induction on $l$.
Assume now that $i > 1$.
Write $\varphi(x_1) = a_1 y_1 + \ldots + a_{i - 1} y_{i - 1} + a y_i$
with $a_j, a \in R$ and $a \not \in \mathfrak q$ (since otherwise
$i$ was not minimal). Set
$$
x'_j =
\left\{
\begin{matrix}
x_j & \text{if} & j = 1 \\
ax_j & \text{if} & j \geq 2
\end{matrix}
\right.
\quad\text{and}\quad
y'_j =
\left\{
\begin{matrix}
y_j & \text{if} & j < i \\
ay_j & \text{if} & j \geq i
\end{matrix}
\right.
$$
Let $M' = \langle x'_1, \ldots, x'_l \rangle$ and
$N' = \langle y'_1, \ldots, y'_l \rangle$.
Since $\varphi(x'_1) = a_1 y'_1 + \ldots + a_{i - 1} y'_{i - 1} + y'_i$
by construction and since for $j > 1$ we have
$\varphi(x'_j) = a\varphi(x_i) \in \langle y'_1, \ldots, y'_l\rangle$
we get a commutative diagram of $R$-modules and maps
$$
\xymatrix{
M' \ar[d] \ar[r]_{\varphi'} & N' \ar[d] \\
M \ar[r]^\varphi & N
}
$$
By the result of the second paragraph of the proof we know
that $\text{length}_R(M/M') = (l - 1)\text{ord}_{R/\mathfrak q}(a)$
and similarly
$\text{length}_R(M/M') = (l - i + 1)\text{ord}_{R/\mathfrak q}(a)$.
By a diagram chase this implies that
$$
\text{length}_R(\Coker(\varphi')) =
\text{length}_R(\Coker(\varphi)) + i\ \text{ord}_{R/\mathfrak q}(a).
$$
On the other hand, it is clear that writing
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l],
\quad
[\varphi'(x'_1), \ldots, \varphi(x'_l)] = f' [y'_1, \ldots, y'_l]
$$
we have $f' = a^if$. Hence it suffices to prove the lemma for the
case that $\varphi(x_1) = a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i$,
i.e., in the case that $a = 1$. Next, recall that
$$
[y_1, \ldots, y_l] = [y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l]
$$
by the admissible relations for symbols. The sequence
$y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots + a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l$
satisfies the conditions (3), (4) of the lemma also.
Hence, we may actually
assume that $\varphi(x_1) = y_i$. In this case, note that we have
$\mathfrak q x_1 = 0$ which implies also $\mathfrak q y_i = 0$.
We have
$$
[y_1, \ldots, y_l] =
- [y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l]
$$
by the third of the admissible relations defining
$\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$. Hence we may
replace $y_1, \ldots, y_l$ by
the sequence
$y'_1, \ldots, y'_l =
y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l$
(which also satisfies conditions (3) and (4) of the lemma).
Clearly this decreases the invariant $i$ by $1$ and we win by induction
on $i$.
\end{proof}

\noindent
To use the previous lemma we show that often sequences of elements
with the required properties exist.

\begin{lemma}
\label{lemma-good-sequence-exists}
Let $R$ be a local Noetherian ring.
Let $\mathfrak q \subset R$ be a prime ideal.
Let $M$ be a finite $R$-module such that
$\mathfrak q$ is one of the minimal primes of the support of $M$.
Then there exist $x_1, \ldots, x_l \in M$ such that
\begin{enumerate}
\item the support of $M / \langle x_1, \ldots, x_l\rangle$ does not contain
$\mathfrak q$, and
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Moreover, in this case $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$.
\end{lemma}

\begin{proof}
The condition that $\mathfrak q$ is a minimal prime in the support
of $M$ implies that $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$
is finite (see Algebra, Lemma \ref{algebra-lemma-support-point}).
Hence we can find $y_1, \ldots, y_l \in M_{\mathfrak q}$
such that
$\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
We can find $f_i \in R$, $f_i \not \in \mathfrak q$ such that
$f_i y_i$ is the image of some element $z_i \in M$.
Moreover, as $R$ is Noetherian we can write
$\mathfrak q = (g_1, \ldots, g_t)$ for some $g_j \in R$.
By assumption $g_j y_i \in \langle y_1, \ldots, y_{i - 1} \rangle$
inside the module $M_{\mathfrak q}$.
By our choice of $z_i$ we can find some further elements
$f_{ji} \in R$, $f_{ij} \not \in \mathfrak q$ such that
$f_{ij} g_j z_i \in \langle z_1, \ldots, z_{i - 1} \rangle$
(equality in the module $M$).
The lemma follows by taking
$$
x_1 = f_{11}f_{12}\ldots f_{1t}z_1,
\quad
x_2 = f_{11}f_{12}\ldots f_{1t}f_{21}f_{22}\ldots f_{2t}z_2,
$$
and so on. Namely, since all the elements $f_i, f_{ij}$ are invertible
in $R_{\mathfrak q}$ we still have that
$R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_i /
R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_{i - 1}
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
By construction, $\mathfrak q x_i \in \langle x_1, \ldots, x_{i - 1}\rangle$.
Thus $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle$
is an $R$-module generated by one element, annihilated $\mathfrak q$
such that localizing at $\mathfrak q$ gives a $q$-dimensional
vector space over $\kappa(\mathfrak q)$.
Hence it is isomorphic to $R/\mathfrak q$.
\end{proof}

\noindent
Here is the main result of this section.
We will see below the various different
consequences of this proposition.
The reader is encouraged to first prove the easier
Lemma \ref{lemma-application-herbrand-quotient} his/herself.

\begin{proposition}
\label{proposition-length-determinant-periodic-complex}
Let $R$ be a local Noetherian ring with residue field $\kappa$.
Suppose that $(M, \varphi, \psi)$ is a $(2, 1)$-periodic
complex over $R$. Assume
\begin{enumerate}
\item $M$ is a finite $R$-module,
\item the cohomology modules of $(M, \varphi, \psi)$ are of finite length, and
\item $\dim(\text{Supp}(M)) = 1$.
\end{enumerate}
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the minimal
primes of the support of $M$. Then we have\footnote{
Obviously we could get rid of the minus sign by redefining
$\det_\kappa(M, \varphi, \psi)$ as the inverse of its
current value, see Definition \ref{definition-periodic-determinant}.}
$$
- e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{\mathfrak q_i}, \varphi_{\mathfrak q_i}, \psi_{\mathfrak q_i})
\right)
$$
\end{proposition}

\begin{proof}
We first reduce to the case $t = 1$ in the following way.
Note that
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$,
where $\mathfrak m \subset R$ is the maximal ideal.
Let $M_i$ denote the image of $M \to M_{\mathfrak q_i}$,
so $\text{Supp}(M_i) = \{\mathfrak m, \mathfrak q_i\}$.
The map $\varphi$ (resp.\ $\psi$) induces an $R$-module map
$\varphi_i : M_i \to M_i$ (resp.\ $\psi_i : M_i \to M_i$).
Thus we get a morphism of $(2, 1)$-periodic complexes
$$
(M, \varphi, \psi) \longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, t} (M_i, \varphi_i, \psi_i).
$$
The kernel and cokernel of this map have support contained in
$\{\mathfrak m\}$. Hence by Lemma \ref{lemma-compare-periodic-lengths}
we have
$$
e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
e_R(M_i, \varphi_i, \psi_i)
$$
On the other hand we clearly have $M_{\mathfrak q_i} = M_{i, \mathfrak q_i}$,
and hence the terms of the right hand side of the formula of the
lemma are equal to the expressions
$$
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{i, \mathfrak q_i}, \varphi_{i, \mathfrak q_i}, \psi_{i, \mathfrak q_i})
\right)
$$
In other words, if we can prove the lemma for each of the modules
$M_i$, then the lemma holds. This reduces us to the case $t = 1$.

\medskip\noindent
Assume we have a $(2, 1)$-periodic complex $(M, \varphi, \psi)$
over a Noetherian local ring with $M$ a finite $R$-module,
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$, and
finite length cohomology modules. The proof in this case
follows from Lemma \ref{lemma-key-lemma} and careful bookkeeping.
Denote
$K_\varphi = \Ker(\varphi)$,
$I_\varphi = \Im(\varphi)$,
$K_\psi = \Ker(\psi)$, and
$I_\psi = \Im(\psi)$.
Since $R$ is Noetherian these are all finite $R$-modules.
Set
$$
a = \text{length}_{R_{\mathfrak q}}(I_{\varphi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\psi, \mathfrak q}),
\quad
b = \text{length}_{R_{\mathfrak q}}(I_{\psi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\varphi, \mathfrak q}).
$$
Equalities because the complex becomes exact after localizing at
$\mathfrak q$. Note that $l = \text{length}_{R_{\mathfrak q}}(M_{\mathfrak q})$
is equal to $l = a + b$.

\medskip\noindent
We are going to use Lemma \ref{lemma-good-sequence-exists}
to choose sequences of elements in finite $R$-modules
$N$ with support contained in $\{\mathfrak m, \mathfrak q\}$.
In this case $N_{\mathfrak q}$ has finite length, say $n \in \mathbf{N}$.
Let us call a sequence $w_1, \ldots, w_n \in N$
with properties (1) and (2) of Lemma \ref{lemma-good-sequence-exists}
a ``good sequence''. Note that the quotient
$N/\langle w_1, \ldots, w_n \rangle$ of $N$ by the submodule generated by
a good sequence has support (contained in) $\{\mathfrak m\}$
and hence has finite length (Algebra, Lemma \ref{algebra-lemma-support-point}).
Moreover, the symbol
$[w_1, \ldots, w_n] \in \det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$
is a generator, see Lemma \ref{lemma-determinant-dimension-one}.

\medskip\noindent
Having said this we choose good sequences
$$
\begin{matrix}
x_1, \ldots, x_b & \text{in} & K_\varphi, &
t_1, \ldots, t_a & \text{in} & K_\psi, \\
y_1, \ldots, y_a & \text{in} & I_\varphi \cap \langle t_1, \ldots t_a\rangle, &
s_1, \ldots, s_b & \text{in} & I_\psi \cap \langle x_1, \ldots, x_b\rangle.
\end{matrix}
$$
We will adjust our choices a little bit as follows.
Choose lifts $\tilde y_i \in M$ of $y_i \in I_\varphi$
and $\tilde s_i \in M$ of $s_i \in I_\psi$. It may not be the case
that $\mathfrak q \tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and it may not be the case that
$\mathfrak q \tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
However, using that $\mathfrak q$ is finitely generated (as in the proof
of Lemma \ref{lemma-good-sequence-exists}) we can find a
$d \in R$, $d \not \in \mathfrak q$ such that
$\mathfrak q d\tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and
$\mathfrak q d\tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
Thus after replacing $y_i$ by $dy_i$,
$\tilde y_i$ by $d\tilde y_i$, $s_i$ by $ds_i$ and $\tilde s_i$
by $d\tilde s_i$ we see that we may assume also that
$x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_b$
and $t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b$
are good sequences in $M$.

\medskip\noindent
Finally, we choose a good sequence
$z_1, \ldots, z_l$ in the finite $R$-module
$$
\langle
x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a
\rangle
\cap
\langle
t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b
\rangle.
$$
Note that this is also a good sequence in $M$.

\medskip\noindent
Since $I_{\varphi, \mathfrak q} = K_{\psi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[y_1, \ldots, y_a] = h [t_1, \ldots, t_a]$
inside $\det_{\kappa(\mathfrak q)}(K_{\psi, \mathfrak q})$.
Similarly, as $I_{\psi, \mathfrak q} = K_{\varphi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[s_1, \ldots, s_b] = g [x_1, \ldots, x_b]$
inside $\det_{\kappa(\mathfrak q)}(K_{\varphi, \mathfrak q})$.
We can also do this with the three good sequences we have
in $M$. All in all we get the following identities
\begin{align*}
[y_1, \ldots, y_a]
& =
h [t_1, \ldots, t_a] \\
[s_1, \ldots, s_b]
& =
g [x_1, \ldots, x_b] \\
[z_1, \ldots, z_l]
& =
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
[z_1, \ldots, z_l]
& =
f_\psi [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b]
\end{align*}
for some $g, h, f_\varphi, f_\psi \in \kappa(\mathfrak q)$.

\medskip\noindent
Having set up all this
notation let us compute $\det_{\kappa(\mathfrak q)}(M, \varphi, \psi)$.
Namely, consider the element $[z_1, \ldots, z_l]$.
Under the map $\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$
of Definition \ref{definition-periodic-determinant} we have
\begin{eqnarray*}
[z_1, \ldots, z_l] & = &
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
& \mapsto & f_\varphi [x_1, \ldots, x_b] \otimes [y_1, \ldots, y_a] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a] \otimes [s_1, \ldots, s_b] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b] \\
& = &
f_\varphi h/f_\psi g [z_1, \ldots, z_l]
\end{eqnarray*}
This means that
$\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
is equal to $f_\varphi h/f_\psi g$ up to a sign.

\medskip\noindent
We abbreviate the following quantities
\begin{eqnarray*}
k_\varphi & = & \text{length}_R(K_\varphi/\langle x_1, \ldots, x_b\rangle) \\
k_\psi    & = & \text{length}_R(K_\psi/\langle t_1, \ldots, t_a\rangle) \\
i_\varphi & = & \text{length}_R(I_\varphi/\langle y_1, \ldots, y_a\rangle) \\
i_\psi    & = & \text{length}_R(I_\psi/\langle s_1, \ldots, s_a\rangle) \\
m_\varphi & = & \text{length}_R(M/
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle) \\
m_\psi    & = & \text{length}_R(M/
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle) \\
\delta_\varphi & = & \text{length}_R(
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle
\langle z_1, \ldots, z_l\rangle) \\
\delta_\psi & = & \text{length}_R(
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle
\langle z_1, \ldots, z_l\rangle)
\end{eqnarray*}
Using the exact sequences $0 \to K_\varphi \to M \to I_\varphi \to 0$
we get $m_\varphi = k_\varphi + i_\varphi$. Similarly we have
$m_\psi = k_\psi + i_\psi$. We have
$\delta_\varphi + m_\varphi = \delta_\psi + m_\psi$ since this
is equal to the colength of $\langle z_1, \ldots, z_l \rangle$
in $M$. Finally, we have
$$
\delta_\varphi = \text{ord}_{R/\mathfrak q}(f_\varphi),
\quad
\delta_\psi = \text{ord}_{R/\mathfrak q}(f_\psi)
$$
by our first application of the key Lemma \ref{lemma-key-lemma}.

\medskip\noindent
Next, let us compute the multiplicity of the periodic complex
\begin{eqnarray*}
e_R(M, \varphi, \psi) & = &
\text{length}_R(K_\varphi/I_\psi) - \text{length}_R(K_\psi/I_\varphi) \\
& = &
\text{length}_R(
\langle x_1, \ldots, x_b\rangle/
\langle s_1, \ldots, s_b\rangle)
+ k_\varphi - i_\psi \\
& & -
\text{length}_R(
\langle t_1, \ldots, t_a\rangle/
\langle y_1, \ldots, y_a\rangle)
- k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + k_\varphi - i_\psi - k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + m_\varphi - m_\psi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + \delta_\psi - \delta_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(f_\psi g/f_\varphi h)
\end{eqnarray*}
where we used the key Lemma \ref{lemma-key-lemma} twice in the third equality.
By our computation of $\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
this proves the proposition.
\end{proof}

\noindent
In most applications the following lemma suffices.

\begin{lemma}
\label{lemma-application-herbrand-quotient}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module, and let $\psi : M \to M$ be an
$R$-module map. Assume that
\begin{enumerate}
\item $\Ker(\psi)$ and $\Coker(\psi)$ have finite length, and
\item $\dim(\text{Supp}(M)) \leq 1$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$
and denote $f_i \in \kappa(\mathfrak q_i)^*$ the element such that
$\det_{\kappa(\mathfrak q_i)}(\psi_{\mathfrak q_i}) :
\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})
\to \det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})$
is multiplication by $f_i$. Then
we have
$$
\text{length}_R(\Coker(\psi))
-
\text{length}_R(\Ker(\psi))
=
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(f_i).
$$
\end{lemma}

\begin{proof}
Recall that $H^0(M, 0, \psi) = \Coker(\psi)$ and
$H^1(M, 0, \psi) = \Ker(\psi)$, see remarks above
Definition \ref{definition-periodic-length}.
The lemma follows by combining
Proposition \ref{proposition-length-determinant-periodic-complex} with
Lemma \ref{lemma-periodic-determinant-easy-case}.

\medskip\noindent
Alternative proof. Reduce to the case
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$
as in the proof of
Proposition \ref{proposition-length-determinant-periodic-complex}.
Then directly combine
Lemmas \ref{lemma-key-lemma} and
\ref{lemma-good-sequence-exists}
to prove this specific case of
Proposition \ref{proposition-length-determinant-periodic-complex}.
There is much less bookkeeping in this case, and the reader is
encouraged to work this out. Details omitted.
\end{proof}




\subsection{Application to the key lemma}
\label{subsection-application-tame-symbol}

\noindent
In this section we apply the results above to show the
analogue of the key lemma (Lemma \ref{lemma-milnor-gersten-low-degree})
with the tame symbol $d_A$ constructed above. Please
see Remark \ref{remark-gersten-complex-milnor}
for the relationship with Milnor $K$-theory.

\begin{lemma}[Key Lemma]
\label{lemma-secondary-ramification}
\begin{reference}
When $A$ is an excellent ring this is \cite[Proposition 1]{Kato-Milnor-K}.
\end{reference}
Let $A$ be a $2$-dimensional Noetherian local domain with fraction field $K$.
Let $f, g \in K^*$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the height
$1$ primes $\mathfrak q$ of $A$ such that either $f$ or $g$ is not an
element of $A^*_{\mathfrak q}$.
Then we have
$$
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{A/\mathfrak q_i}(d_{A_{\mathfrak q_i}}(f, g))
=
0
$$
We can also write this as
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(d_{A_{\mathfrak q}}(f, g))
=
0
$$
since at any height one prime $\mathfrak q$
of $A$ where $f, g \in A^*_{\mathfrak q}$
we have $d_{A_{\mathfrak q}}(f, g) = 1$ by
Lemma \ref{lemma-symbol-when-one-is-a-unit}.
\end{lemma}

\begin{proof}
Since the tame symbols $d_{A_{\mathfrak q}}(f, g)$ are additive
(Lemma \ref{lemma-multiplicativity-symbol}) and the order
functions $\text{ord}_{A/\mathfrak q}$
are additive (Algebra, Lemma \ref{algebra-lemma-ord-additive})
it suffices to prove the formula when $f = a \in A$ and
$g = b \in A$. In this case we see that we have to show
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(\det\nolimits_\kappa(A_{\mathfrak q}/(ab), a, b))
= 0
$$
By Proposition \ref{proposition-length-determinant-periodic-complex}
this is equivalent to showing that
$$
e_A(A/(ab), a, b) = 0.
$$
Since the complex
$A/(ab) \xrightarrow{a} A/(ab) \xrightarrow{b} A/(ab) \xrightarrow{a} A/(ab)$
is exact we win.
\end{proof}





\section{Appendix B: Alternative approaches}
\label{section-appendix-chow}

\noindent
In this appendix we first briefly try to connect the material
in the main text with $K$-theory of coherent sheaves. In
particular we describe how cupping with $c_1$ of an invertible
module is related to tensoring by this invertible module, see
Lemma \ref{lemma-coherent-sheaf-cap-c1}.
This material is obviously very interesting and
deserves a much more detailed and expansive exposition.


\subsection{Rational equivalence and K-groups}
\label{subsection-rational-equivalence-K-groups}

\noindent
This section is a continuation of Section \ref{section-chow-and-K}.
The motivation for the following lemma is
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}.

\begin{lemma}
\label{lemma-maps-between-coherent-sheaves}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Let
$$
\xymatrix{
\ldots \ar[r] &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r]^\psi &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r] & \ldots
}
$$
be a complex as in Homology, Equation (\ref{homology-equation-cyclic-complex}).
Assume that
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$.
\item $\dim_\delta(\text{Supp}(H^i(\mathcal{F}, \varphi, \psi))) \leq k$
for $i = 0, 1$.
\end{enumerate}
Then we have
$$
[H^0(\mathcal{F}, \varphi, \psi)]_k
\sim_{rat}
[H^1(\mathcal{F}, \varphi, \psi)]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$. Note that $\{W_j\}$
is a locally finite collection of closed subsets of
$X$ by Lemma \ref{lemma-length-finite}.
For every $j$, let $\xi_j \in W_j$ be the generic point.
Set
$$
f_j = \det\nolimits_{\kappa(\xi_j)}
(\mathcal{F}_{\xi_j}, \varphi_{\xi_j}, \psi_{\xi_j})
\in
R(W_j)^*.
$$
See Definition \ref{definition-periodic-determinant} for notation.
We claim that
$$
- [H^0(\mathcal{F}, \varphi, \psi)]_k + [H^1(\mathcal{F}, \varphi, \psi)]_k
=
\sum (W_j \to X)_*\text{div}(f_j)
$$
If we prove this then the lemma follows.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z]$ in
$
[H^0(\mathcal{F}, \varphi, \psi)]_k - [H^1(\mathcal{F}, \varphi, \psi)]_k
$
is the same as the coefficient $m$ of $[Z]$ in
$
\sum (W_j \to X)_*\text{div}(f_j)
$.
Let $\xi \in Z$ be the generic point.
Consider the local ring $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Denote $\varphi, \psi : M \to M$ the action of $\varphi, \psi$ on
the stalk.
By our choice of $\xi \in Z$ we have $\delta(\xi) = k$
and hence $\dim(\text{Supp}(M)) = 1$.
Finally, the integral closed subschemes
$W_j$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Supp}(M)$.
In each case the element $f_j \in R(W_j)^*$ corresponds to
the element $\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi)$
in $\kappa(\mathfrak q_i)^*$. Hence we see that
$$
n = - e_A(M, \varphi, \psi)
$$
and
$$
m =
\sum
\text{ord}_{A/\mathfrak q_i}
(\det\nolimits_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi))
$$
Thus the result follows from
Proposition \ref{proposition-length-determinant-periodic-complex}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-rational-equivalence-K-group}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
The map
$$
\CH_k(X) \longrightarrow
K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))
$$
from Lemma \ref{lemma-from-chow-to-K} induces a bijection from
$\CH_k(X)$ onto the image $B_k(X)$ of the map
$$
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow
K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X)).
$$
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-cycles-k-group} we have
$Z_k(X) = K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$
compatible with the map of Lemma \ref{lemma-from-chow-to-K}.
Thus, suppose we have an element $[A] - [B]$ of
$K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$
which maps to zero in $B_k(X)$, i.e., maps to zero in
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
We have to show that $[A] - [B]$ corresponds to a cycle
rationally equivalent to zero on $X$.
Suppose $[A] = [\mathcal{A}]$ and $[B] = [\mathcal{B}]$
for some coherent sheaves $\mathcal{A}, \mathcal{B}$ on
$X$ supported in $\delta$-dimension $\leq k$.
The assumption that $[A] - [B]$ maps to zero in the group
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$
means that there exists coherent sheaves
$\mathcal{A}', \mathcal{B}'$ on $X$ supported in
$\delta$-dimension $\leq k - 1$ such that
$[\mathcal{A} \oplus \mathcal{A}'] - [\mathcal{B} \oplus \mathcal{B}']$
is zero in $K_0(\textit{Coh}_{k + 1}(X))$ (use part (1) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}).
By part (2) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
this means there exists a $(2, 1)$-periodic complex
$(\mathcal{F}, \varphi, \psi)$ in the category $\textit{Coh}_{\leq k + 1}(X)$
such that
$\mathcal{A} \oplus \mathcal{A}' = H^0(\mathcal{F}, \varphi, \psi)$
and $\mathcal{B} \oplus \mathcal{B}' = H^1(\mathcal{F}, \varphi, \psi)$.
By Lemma \ref{lemma-maps-between-coherent-sheaves}
this implies that
$$
[\mathcal{A} \oplus \mathcal{A}']_k
\sim_{rat}
[\mathcal{B} \oplus \mathcal{B}']_k
$$
This proves that $[A] - [B]$ maps to a cycle rationally
equivalent to zero by the map
$$
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow Z_k(X)
$$
of Lemma \ref{lemma-cycles-k-group}. This is what we
had to prove and the proof is complete.
\end{proof}














\subsection{Cartier divisors and K-groups}
\label{subsection-cartier-coherent}

\noindent
In this section we describe how the intersection with the
first chern class of an invertible sheaf $\mathcal{L}$
corresponds to tensoring with $\mathcal{L} - \mathcal{O}$
in $K$-groups.

\begin{lemma}
\label{lemma-no-embedded-points-modules}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module.
Let $a, b \in A$.
Assume
\begin{enumerate}
\item $\dim(A) = 1$,
\item both $a$ and $b$ are nonzerodivisors in $A$,
\item $A$ has no embedded primes,
\item $M$ has no embedded associated primes,
\item $\text{Supp}(M) = \Spec(A)$.
\end{enumerate}
Let $I = \{x \in A \mid x(a/b) \in A\}$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes of $A$. Then $(a/b)IM \subset M$ and
$$
\text{length}_A(M/(a/b)IM)
-
\text{length}_A(M/IM)
=
\sum\nolimits_i
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(a/b)
$$
\end{lemma}

\begin{proof}
Since $M$ has no embedded associated primes, and since
the support of $M$ is $\Spec(A)$ we see that
$\text{Ass}(M) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$.
Hence $a$, $b$ are nonzerodivisors on $M$. Note that
\begin{align*}
& \text{length}_A(M/(a/b)IM) \\
& = \text{length}_A(bM/aIM) \\
& = \text{length}_A(M/aIM)
-
\text{length}_A(M/bM) \\
& = \text{length}_A(M/aM) + \text{length}_A(aM/aIM) - \text{length}_A(M/bM) \\
& = \text{length}_A(M/aM) + \text{length}_A(M/IM) - \text{length}_A(M/bM)
\end{align*}
as the injective map $b : M \to bM$ maps $(a/b)IM$ to $aIM$
and the injective map $a : M \to aM$ maps $IM$ to $aIM$.
Hence the left hand side of the equation of the lemma is
equal to
$$
\text{length}_A(M/aM) - \text{length}_A(M/bM).
$$
Applying the second formula of
Lemma \ref{lemma-additivity-divisors-restricted}
with $x = a, b$ respectively
and using Algebra, Definition \ref{algebra-definition-ord}
of the $\text{ord}$-functions we get the result.
\end{proof}

\begin{lemma}
\label{lemma-no-embedded-points}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{K}_X(\mathcal{L}))$ be a
meromorphic section of $\mathcal{L}$.
Assume
\begin{enumerate}
\item $\dim_\delta(X) \leq k + 1$,
\item $X$ has no embedded points,
\item $\mathcal{F}$ has no embedded associated points,
\item the support of $\mathcal{F}$ is $X$, and
\item the section $s$ is regular meromorphic.
\end{enumerate}
In this situation let $\mathcal{I} \subset \mathcal{O}_X$
be the ideal of denominators of $s$, see
Divisors,
Definition \ref{divisors-definition-regular-meromorphic-ideal-denominators}.
Then we have the following:
\begin{enumerate}
\item there are short exact sequences
$$
\begin{matrix}
0 &
\to &
\mathcal{I}\mathcal{F} &
\xrightarrow{1} &
\mathcal{F} &
\to &
\mathcal{Q}_1 &
\to &
0 \\
0 &
\to &
\mathcal{I}\mathcal{F} &
\xrightarrow{s} &
\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L} &
\to &
\mathcal{Q}_2 &
\to &
0
\end{matrix}
$$
\item the coherent sheaves $\mathcal{Q}_1$, $\mathcal{Q}_2$
are supported in $\delta$-dimension $\leq k$,
\item the section $s$ restricts to a regular meromorphic
section $s_i$ on every irreducible component $X_i$ of
$X$ of $\delta$-dimension $k + 1$, and
\item writing $[\mathcal{F}]_{k + 1} = \sum m_i[X_i]$ we have
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
\sum m_i(X_i \to X)_*\text{div}_{\mathcal{L}|_{X_i}}(s_i)
$$
in $Z_k(X)$, in particular
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}
$$
in $\CH_k(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Recall from Divisors, Lemma \ref{divisors-lemma-make-maps-regular-section}
the existence of injective maps
$1 : \mathcal{I}\mathcal{F} \to \mathcal{F}$ and
$s : \mathcal{I}\mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X}\mathcal{L}$
whose cokernels are supported on a closed nowhere dense subsets $T$.
Denote $\mathcal{Q}_i$ there cokernels as in the lemma.
We conclude that $\dim_\delta(\text{Supp}(\mathcal{Q}_i)) \leq k$.
By Divisors, Lemmas \ref{divisors-lemma-pullback-meromorphic-sections-defined}
and \ref{divisors-lemma-meromorphic-sections-pullback} the pullbacks $s_i$
are defined and are regular meromorphic sections for $\mathcal{L}|_{X_i}$.
The equality of cycles in (4) implies the equality of cycle classes
in (4). Hence the only remaining thing to show is that
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
\sum m_i(X_i \to X)_*\text{div}_{\mathcal{L}|_{X_i}}(s_i)
$$
holds in $Z_k(X)$. To see this, let $Z \subset X$ be an integral closed
subscheme of $\delta$-dimension $k$. Let $\xi \in Z$ be the generic point.
Let $A = \mathcal{O}_{X, \xi}$ and $M = \mathcal{F}_\xi$.
Moreover, choose a generator $s_\xi \in \mathcal{L}_\xi$.
Then we can write $s = (a/b) s_\xi$ where $a, b \in A$ are
nonzerodivisors. In this case
$I = \mathcal{I}_\xi = \{x \in A \mid x(a/b) \in A\}$.
In this case the coefficient of $[Z]$ in the left hand side is
$$
\text{length}_A(M/(a/b)IM) - \text{length}_A(M/IM)
$$
and the coefficient of $[Z]$ in the right hand side
is
$$
\sum
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(a/b)
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the minimal
primes of the $1$-dimensional local ring $A$. Hence the result
follows from Lemma \ref{lemma-no-embedded-points-modules}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Assume $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$.
Then the element
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
\in
K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))
$$
lies in the subgroup $B_k(X)$ of
Lemma \ref{lemma-cycles-rational-equivalence-K-group} and maps to
the element $c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}$ via
the map $B_k(X) \to \CH_k(X)$.
\end{lemma}

\begin{proof}
Let
$$
0 \to \mathcal{K} \to \mathcal{F} \to \mathcal{F}' \to 0
$$
be the short exact sequence constructed in
Divisors, Lemma \ref{divisors-lemma-remove-embedded-points}.
This in particular means that $\mathcal{F}'$ has no embedded
associated points.
Since the support of $\mathcal{K}$ is nowhere dense in the
support of $\mathcal{F}$ we see that
$\dim_\delta(\text{Supp}(\mathcal{K})) \leq k$. We may
re-apply
Divisors, Lemma \ref{divisors-lemma-remove-embedded-points}
starting with $\mathcal{K}$ to get a short exact sequence
$$
0 \to \mathcal{K}'' \to \mathcal{K} \to \mathcal{K}' \to 0
$$
where now $\dim_\delta(\text{Supp}(\mathcal{K}'')) < k$
and $\mathcal{K}'$ has no embedded associated points.
Suppose we can prove the lemma for the coherent sheaves
$\mathcal{F}'$ and $\mathcal{K}'$. Then we see
from the equations
$$
[\mathcal{F}]_{k + 1}
=
[\mathcal{F}']_{k + 1}
+ [\mathcal{K}']_{k + 1}
+ [\mathcal{K}'']_{k + 1}
$$
(use Lemma \ref{lemma-additivity-sheaf-cycle}),
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
=
[\mathcal{F}' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}']
+
[\mathcal{K}' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{K}']
+
[\mathcal{K}'' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{K}'']
$$
(use the $\otimes \mathcal{L}$ is exact)
and the trivial vanishing of $[\mathcal{K}'']_{k + 1}$ and
$[\mathcal{K}'' \otimes_{\mathcal{O}_X} \mathcal{L}]
- [\mathcal{K}'']$ in
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$
that the result holds
for $\mathcal{F}$. What this means is that we may assume that
the sheaf $\mathcal{F}$ has no embedded associated points.

\medskip\noindent
Assume $X$, $\mathcal{F}$ as in the lemma, and assume in addition
that $\mathcal{F}$ has no embedded associated points. Consider the
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$, the corresponding
closed subscheme $i : Z \to X$ and the coherent $\mathcal{O}_Z$-module
$\mathcal{G}$ constructed in
Divisors, Lemma \ref{divisors-lemma-no-embedded-points-endos}.
Recall that $Z$ is a locally Noetherian scheme without embedded points,
$\mathcal{G}$ is a coherent sheaf without embedded
associated points, with $\text{Supp}(\mathcal{G}) = Z$
and such that $i_*\mathcal{G} = \mathcal{F}$.
Moreover, set $\mathcal{N} = \mathcal{L}|_Z$.

\medskip\noindent
By Divisors, Lemma \ref{divisors-lemma-regular-meromorphic-section-exists}
the invertible sheaf $\mathcal{N}$ has a regular meromorphic section $s$
over $Z$. Let us denote $\mathcal{J} \subset \mathcal{O}_Z$ the sheaf
of denominators of $s$. By Lemma \ref{lemma-no-embedded-points}
there exist short exact sequences
$$
\begin{matrix}
0 &
\to &
\mathcal{J}\mathcal{G} &
\xrightarrow{1} &
\mathcal{G} &
\to &
\mathcal{Q}_1 &
\to &
0 \\
0 &
\to &
\mathcal{J}\mathcal{G} &
\xrightarrow{s} &
\mathcal{G} \otimes_{\mathcal{O}_Z} \mathcal{N} &
\to &
\mathcal{Q}_2 &
\to &
0
\end{matrix}
$$
such that $\dim_\delta(\text{Supp}(\mathcal{Q}_i)) \leq k$ and
such that the cycle
$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
$
is a representative of $c_1(\mathcal{N}) \cap [\mathcal{G}]_{k + 1}$.
We see (using the fact that
$i_*(\mathcal{G} \otimes \mathcal{N}) = \mathcal{F} \otimes \mathcal{L}$
by the projection formula, see
Cohomology, Lemma \ref{cohomology-lemma-projection-formula})
that
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
=
[i_*\mathcal{Q}_2] - [i_*\mathcal{Q}_1]
$$
in $K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
This already shows that
$[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}] - [\mathcal{F}]$
is an element of $B_k(X)$. Moreover we have
\begin{eqnarray*}
[i_*\mathcal{Q}_2]_k - [i_*\mathcal{Q}_1]_k
& = &
i_*\left( [\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k \right) \\
& = &
i_*\left(c_1(\mathcal{N}) \cap [\mathcal{G}]_{k + 1} \right) \\
& = &
c_1(\mathcal{L}) \cap i_*[\mathcal{G}]_{k + 1} \\
& = &
c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}
\end{eqnarray*}
by the above and Lemmas \ref{lemma-pushforward-cap-c1}
and \ref{lemma-cycle-push-sheaf}. And this agree with the
image of the element under $B_k(X) \to \CH_k(X)$ by definition.
Hence the lemma is proved.
\end{proof}


































\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
