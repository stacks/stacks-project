\input{preamble}

% OK, start here.
%
\begin{document}

\title{Chow Homology and Chern Classes}

\maketitle

\phantomsection
\label{section-phantom}


\tableofcontents


\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss Chow homology groups and the construction
of chern classes of vector bundles as elements of operational
Chow cohomology groups (everything with $\mathbf{Z}$-coefficients).
We follow the first few chapters of \cite{F}, except that we have been
less precise about the supports of the cycles involved.
More classical discussions of Chow groups can be found in
\cite{Samuel}, \cite{ChevalleyI}, and \cite{ChevalleyII}.
Of course there are many others.

\medskip\noindent
To make the material a little bit more challenging we decided
to treat a somewhat more general case than is usually done.
Namely we assume our schemes $X$ are locally of finite type
over a fixed locally Noetherian base scheme which is universally
catenary and has a given dimension function. This seems to be
all that is needed to be able to define the Chow homology
groups $A_*(X)$ and the action of capping with chern classes
on them. This is an indication that we should be able to define
these also for algebraic stacks locally of finite type over such
a base.

\medskip\noindent
In another chapter we will define the intersection products
on $A_*(X)$ using Serre's Tor-formula in case $X$ is nonsingular
(see \cite{Serre_local_algebra}, or \cite{Serre_algebre_locale})
and we have a good moving lemma. See (insert future reference here).

\section{Determinants of finite length modules}
\label{section-determinants-finite-length}

\noindent
The material in this section is related to the material in
the paper \cite{determinant} and to the material in the
thesis \cite{Joe}. If you have a good reference then please
email \href{mailto:stacks.project@gmail.com}{stacks.project@gmail.com}.

\medskip\noindent
Given any field $\kappa$ and
any finite dimensional $\kappa$-vector space $V$ we set
$\det\nolimits_\kappa(V)$ equal to $\det\nolimits_\kappa(V) = \wedge^n(V)$
where $n = \dim_\kappa(V)$. We want to generalize this slightly.

\begin{definition}
\label{definition-determinant}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
Say $l = \text{length}_R(M)$.
\begin{enumerate}
\item Given elements $x_1, \ldots, x_r \in M$ we denote
$\langle x_1, \ldots, x_r \rangle = Rx_1 + \ldots + Rx_r$ the
$R$-submodule of $R$ generated by $x_1, \ldots, x_r$.
\item We will say an $l$-tuples of elements
$(e_1, \ldots, e_l)$ of $M$ is {\it admissible} if
$\mathfrak m e_i \in \langle e_1, \ldots, e_{i - 1} \rangle$
for $i = 1, \ldots, l$.
\item A {\it symbol} $[e_1, \ldots, e_l]$ will mean
$(e_1, \ldots, e_l)$ is an admissible $l$-tuple.
\item An {\it admissible relation} between symbols is one of the following:
\begin{enumerate}
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$[e_1, \ldots, e_l] = 0$,
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have $e_a = \lambda e'_a + x$
with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$$
[e_1, \ldots, e_l] =
\overline{\lambda} [e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
$$
where $\overline{\lambda} \in \kappa^*$ is the image of $\lambda$ in
the residue field, and
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$ then
$$
[e_1, \ldots, e_l] =
- [e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l].
$$
\end{enumerate}
\item
We define the {\it determinant of the finite length $R$-module} to be
$$
\det\nolimits_\kappa(M) =
\left\{
\frac{\kappa\text{-vector space generated by symbols}}
{\kappa\text{-linear combinations of admissible relations}}
\right\}
$$
\end{enumerate}
\end{definition}

\noindent
We stress that always $l = \text{length}_R(M)$. We also stress that
it does not follow that the symbol $[e_1, \ldots, e_l]$ is
additive in the entries (this will typically not be the case).
Before we can show that the determinant $\det_\kappa(M)$ actually
has dimension $1$ we have to show that it has dimension at most $1$.

\begin{lemma}
\label{lemma-dimension-at-most-one}
With notations as above we have $\dim_\kappa(\det_\kappa(M)) \leq 1$.
\end{lemma}

\begin{proof}
Fix an admissible sequence $(f_1, \ldots, f_l)$ of $M$ such that
$$
\text{length}_R(\langle f_1, \ldots, f_i\rangle) = i
$$
for $i = 1, \ldots, l$. Such an admissible sequence exists exactly because
$M$ has length $l$. We will show that any element of
$\det_\kappa(M)$ is a $\kappa$-multiple of the symbol
$[f_1, \ldots, f_l]$. This will prove the lemma.

\medskip\noindent
Let $(e_1, \ldots, e_l)$ be an admissible sequence of $M$.
It suffices to show that $[e_1, \ldots, e_l$ is a multiple
of $[f_1, \ldots, f_l]$. First assume that
$\langle e_1, \ldots, e_l\rangle \not = M$. Then there exists
an $i \in [1, \ldots, l]$ such that
$e_i \in \langle e_1, \ldots, e_{i - 1}\rangle$. It immediately
follows from the first admissible relation that
$[e_1, \ldots, e_n] = 0$ in $\det_\kappa(M)$.
Hence we may assume that $\langle e_1, \ldots, e_l\rangle = M$.
In particular there exists a smallest index $i \in \{1, \ldots, l\}$
such that $f_1 \in \langle e_1, \ldots, e_i\rangle$. This means
that $e_i = \lambda f_1 + x$ with
$x \in \langle e_1, \ldots, e_{i - 1}\rangle$ and $\lambda \in R^*$.
By the second admissible relation this means that
$[e_1, \ldots, e_l] =
\overline{\lambda}[e_1, \ldots, e_{i - 1}, f_1, e_{i + 1}, \ldots, e_l]$.
Note that $\mathfrak m f_1 = 0$. Hence by applying the third
admissible relation $i - 1$ times we see that
$$
[e_1, \ldots, e_l] =
(-1)^{i - 1}\overline{\lambda}
[f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l].
$$
Note that it is also the case that
$ \langle f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l\rangle = M$.
By induction suppose we have proven that our original
symbol is equal to a scalar times
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
$$
for some admissible sequence $(f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l)$
whose elements generate $M$, i.e., \ with
$\langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l\rangle = M$.
Then we find the smallest $i$ such that
$f_{j + 1} \in \langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_i\rangle$
and we go through the same process as above to see that
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
=
(\text{scalar}) [f_1, \ldots, f_j, f_{j + 1}, e_{j + 1},
\ldots, \hat{e_i}, \ldots, e_l]
$$
Continuing in this vein we obtain the desired result.
\end{proof}

\noindent
Before we show that $\det_\kappa(M)$ always has dimension $1$,
let us show that it agree with the usual top exterior power in
the case the module is a vector space over $\kappa$.

\begin{lemma}
\label{lemma-compare-det}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module
which is annihilated by $\mathfrak m$. Let $l = n = \dim_\kappa(M)$.
Then the map
$$
\det\nolimits_\kappa(M) \longrightarrow \wedge^l_\kappa(M),
\quad
[e_1, \ldots, e_l] \longmapsto e_1 \wedge \ldots \wedge e_l
$$
is an isomorphism.
\end{lemma}

\begin{proof}
It is clear that the rule described in the lemma gives a $\kappa$-linear
map since all of the admissible relations are satisfied by the usual
symbols $e_1 \wedge \ldots \wedge e_l$. It is also clearly a surjective
map. Since by Lemma \ref{lemma-dimension-at-most-one} the left hand side
has dimension at most one
we see that the map is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-determinant-dimension-one}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
The determinant $\det_\kappa(M)$ defined above is a $\kappa$-vector
space of dimension $1$. It is generated by the symbol
$[f_1, \ldots, f_l]$ for any admissible sequence such
that $\langle f_1, \ldots f_l \rangle = M$.
\end{lemma}

\begin{proof}
We know $\det_\kappa(M)$ has dimension at most $1$, and in fact that it
is generated by $[f_1, \ldots, f_l]$, by
Lemma \ref{lemma-dimension-at-most-one} and its proof.
We will show by induction on $l = \text{length}(M)$
that it is nonzero. For $l = 1$ it follows from Lemma \ref{lemma-compare-det}.
Choose a nonzero element $f \in M$
with $\mathfrak m f = 0$. Set $\overline{M} = M /\langle f \rangle$,
and denote the quotient map $x \mapsto \overline{x}$.
We will define a surjective map
$$
\psi : \det\nolimits_k(M) \to \det\nolimits_\kappa(\overline{M})
$$
which will prove the lemma since by induction the determinant of
$\overline{M}$ is nonzero.

\medskip\noindent
We define $\psi$ on symbols as follows.
Let $(e_1, \ldots, e_l)$ be an admissible sequence.
If $f \not \in \langle e_1, \ldots, e_l \rangle$ then
we simply set $\psi([e_1, \ldots, e_l]) = 0$.
If $f \in \langle e_1, \ldots, e_l \rangle$ then we choose
an $i$ minimal such that $f \in \langle e_1, \ldots, e_i \rangle$
and write $e_i = \lambda f + x$ for some $\lambda \in R$
and $x \in \langle e_1, \ldots, e_{i - 1} \rangle$.
In this case we set
$$
\psi([e_1, \ldots, e_l]) =
\overline{\lambda}[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l].
$$
Note that it is indeed the case that
$(\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l)$
is an admissible sequence in $\overline{M}$, so this makes sense.
Let us show that extending this rule $\kappa$-linearly to
linear combinations of symbols does indeed lead to a map on
determinants. To do this we have to show that the admissible
relations are mapped to zero.

\medskip\noindent
Type (a) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Then it is immediate that $i \not = a$. Since it is also
the case that
$\overline{e}_a \in
\langle \overline{e}_1, \ldots, \hat{\overline{e}_i}, \ldots,
\overline{e}_{a - 1}\rangle$ we see immediately that the same
admissible relation for $\det_\kappa(\overline{M})$ forces
the symbol $[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]$
to be zero as desired.

\medskip\noindent
Type (b) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a = \lambda e'_a + x$ with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \mu f + y$ with $y \in \langle e_1, \ldots, e_{i - 1}\rangle$.
If $i < a$ then the desired equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
If $i > a$ then the desired equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
The interesting case is when $i = a$. In this case we have
$e_a = \lambda e'_a + x = \mu f + y$. Hence also
$e'_a = \lambda^{-1}(\mu f + y - x)$. Thus we see that
$$
\psi([e_1, \ldots, e_l])
= \overline{\mu}
[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]
=
\psi(
\overline{\lambda}
[e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
)
$$
as desired.

\medskip\noindent
Type (c) relations. Suppose that $(e_1, \ldots, e_l)$
is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \lambda f + x$ with $x \in \langle e_1, \ldots, e_{i - 1}\rangle$.
If $i < a - 1$, then the desired equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$. Similarly, if $i > a$, then the
desired equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
$$
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$. If $i = a$, then the desired
equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which is tautological. Finally, the interesting case is $i = a - 1$.
This case itself splits into two cases as to whether
$f \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$ or not.
If not, then we see that the desired equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which is tautological since after switching $e_{a - 1}$ and $e_a$
the smallest index such that $f$ is in the becomes equal to
$i' = a$ and it is again $e_a$ which is removed. On the other
hand, suppose that $f \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$.
In this case we see that we can, besides the equality
$e_{a - 1} = \lambda f + x$ of above, also write
$e_a = \mu f + y$ with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$.
Clearly this means that both
$e_a \in \langle e_1, \ldots, e_{a - 1} \rangle$ and
$e_{a - 1} \in \langle e_1, \ldots, e_{a - 2}, e_a\rangle$.
Thus we can use relations of type (a) and the compatibility of $\psi$
with these shown above to see that both
$$
\psi([e_1, \ldots, e_l])
\quad\text{and}\quad
\psi([e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l])
$$
are zero, as desired.

\medskip\noindent
At this point we have shown that $\psi$ is well defined, and all that remains
is to show that it is surjective. To see this let
$(\overline{f}_2, \ldots, \overline{f}_l)$ be an admissible sequence
in $\overline{M}$. We can choose lifts $f_2, \ldots, f_l \in M$, and
then $(f, f_2, \ldots, f_l)$ is an admissible sequence in $M$.
Since $\psi([f, f_2, \ldots, f_l]) = [f_2, \ldots, f_l]$ we win.
\end{proof}

\noindent
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Note that if $\varphi : M \to N$ is an
isomorphism of finite length $R$-modules, then we get an
isomorphism
$$
\det\nolimits_\kappa(\varphi) :
\det\nolimits_\kappa(M)
\to
\det\nolimits_\kappa(N)
$$
simply by the rule
$$
\det\nolimits_\kappa(\varphi)([e_1, \ldots, e_l])
=
[\varphi(e_1), \ldots, \varphi(e_l)]
$$
for any symbol $[e_1, \ldots, e_l]$ for $M$.
Hence we see that $\det\nolimits_\kappa$ is a functor
\begin{equation}
\label{equation-functor}
\left\{
\begin{matrix}
\text{finite length $R$-modules}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\end{equation}
This is typical for a ``determinant functor''
(see \cite{Knudsen}), as is the following additivity
property.

\begin{lemma}
\label{lemma-det-exact-sequences}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
For every short exact sequence
$$
0 \to K \to L \to M \to 0
$$
of finite length $R$-modules there exists a canonical isomorphism
$$
\gamma_{K \to L \to M} :
\det\nolimits_\kappa(K) \otimes_\kappa \det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(L)
$$
defined by the rule on nonzero symbols
$$
[e_1, \ldots, e_k]
\otimes
[\overline{f}_1, \ldots, \overline{f}_m]
\longrightarrow
[e_1, \ldots, e_k, f_1, \ldots, f_m]
$$
with the following properties:
\begin{enumerate}
\item For every isomorphism of short exact sequences, i.e., for
every commutative diagram
$$
\xymatrix{
0 \ar[r] &
K \ar[r] \ar[d]^u &
L \ar[r] \ar[d]^v &
M \ar[r] \ar[d]^w &
0 \\
0 \ar[r] &
K' \ar[r] &
L' \ar[r] &
M' \ar[r] &
0
}
$$
with short exact rows and isomorphisms $u, v, w$ we have
$$
\gamma_{K' \to L' \to M'} \circ
(\det\nolimits_\kappa(u) \otimes \det\nolimits_\kappa(w))
=
\det\nolimits_\kappa(v) \circ
\gamma_{K \to L \to M},
$$
\item for every commutative square of finite length $R$-modules
with exact rows and columns
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] & A \ar[r] \ar[d] & B \ar[r] \ar[d] & C \ar[r] \ar[d] & 0 \\
0 \ar[r] & D \ar[r] \ar[d] & E \ar[r] \ar[d] & F \ar[r] \ar[d] & 0 \\
0 \ar[r] & G \ar[r] \ar[d] & H \ar[r] \ar[d] & I \ar[r] \ar[d] & 0 \\
& 0  & 0  & 0  &
}
$$
the following diagram is commutative
$$
\xymatrix{
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(I)
\ar[dd]_{\epsilon}
\ar[rrr]_-{\gamma_{A \to B \to C} \otimes \gamma_{G \to H \to I}}
& & &
\det\nolimits_\kappa(B) \otimes
\det\nolimits_\kappa(H)
\ar[d]^{\gamma_{B \to E \to H}}
\\
& & & \det\nolimits_\kappa(E)
\\
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(I)
\ar[rrr]^-{\gamma_{A \to D \to G} \otimes \gamma_{C \to F \to I}}
& & &
\det\nolimits_\kappa(D) \otimes
\det\nolimits_\kappa(F)
\ar[u]_{\gamma_{D \to E \to F}}
}
$$
where $\epsilon$ is the switch of the factors in the tensor product
times $(-1)^{cg}$ with $c = \text{length}_R(C)$ and $g = \text{length}_R(G)$,
and
\item the map $\gamma_{K \to L \to M}$ agrees with the usual isomorphism
if $0 \to K \to L \to M \to 0$ is actually a short exact sequence
of $\kappa$-vector spaces.
\end{enumerate}
\end{lemma}

\begin{proof}
The significance of taking nonzero symbols in the explicit description
of the map $\gamma_{K \to L \to M}$ is simply that if $(e_1, \ldots, e_l)$
is an admissible sequence in $K$, and
$(\overline{f}_1, \ldots, \overline{f}_m)$ is an admissible sequence in
$M$, then it is not guaranteed that $(e_1, \ldots, e_l, f_1, \ldots, f_m)$
is an admissible sequence in $L$ (where of course $f_i \in L$ signifies
a lift of $\overline{f}_i$). However, if the symbol
$[e_1, \ldots, e_l]$ is nonzero in $\det_\kappa(K)$, then
necessarily $K = \langle e_1, \ldots, e_k\rangle$ (see
proof of Lemma \ref{lemma-dimension-at-most-one}), and
in this case it is true that $(e_1, \ldots, e_k, f_1, \ldots, f_m)$
is an admissible sequence.
Moreover, by the admissible relations of type (b) for $\det_\kappa(L)$
we see that the value of $[e_1, \ldots, e_k, f_1, \ldots, f_m]$ in
$\det_\kappa(L)$ is independent of the choice of the lifts
$f_i$ in this case also. Given this remark, it is clear
that an admissible relation for $e_1, \ldots, e_k$ in $K$
translates into an admissible relation among
$e_1, \ldots, e_k, f_1, \ldots, f_m$ in $L$, and
similarly for an admissible relation among the
$\overline{f}_1, \ldots, \overline{f}_m$.
Thus $\gamma$ defines a linear map of vector spaces as claimed in the lemma.

\medskip\noindent
By Lemma \ref{lemma-determinant-dimension-one} we know
$\det_\kappa(L)$ is generated by any single
symbol $[x_1, \ldots, x_{k + m}]$ such that
$(x_1, \ldots, x_{k + m})$ is an admissible sequence
with $L = \langle x_1, \ldots, x_{k + m}\rangle$. Hence it is
clear that the map $\gamma_{K \to L \to M}$ is surjective and
hence an isomorphism.

\medskip\noindent
Property (1) holds because
\begin{eqnarray*}
& & \det\nolimits_\kappa(v)([e_1, \ldots, e_k, f_1, \ldots, f_m]) \\
& = &
[v(e_1), \ldots, v(e_k), v(f_1), \ldots, v(f_m)] \\
& = &
\gamma_{K' \to L' \to M'}([u(e_1), \ldots, u(e_k)]
\otimes [w(f_1), \ldots, w(f_m)]).
\end{eqnarray*}
Property (2) means that given a symbol
$[\alpha_1, \ldots, \alpha_a]$ generating $\det_\kappa(A)$,
a symbol $[\gamma_1, \ldots, \gamma_c]$ generating $\det_\kappa(C)$,
a symbol $[\zeta_1, \ldots, \zeta_g]$ generating $\det_\kappa(G)$, and
a symbol $[\iota_1, \ldots, \iota_i]$ generating $\det_\kappa(I)$
we have
\begin{eqnarray*}
& & [\alpha_1, \ldots, \alpha_a, \tilde\gamma_1, \ldots, \tilde\gamma_c,
\tilde\zeta_1, \ldots, \tilde\zeta_g, \tilde\iota_1, \ldots, \tilde\iota_i] \\
& = &
(-1)^{cg} [\alpha_1, \ldots, \alpha_a, \tilde\zeta_1, \ldots, \tilde\zeta_g,
\tilde\gamma_1, \ldots, \tilde\gamma_c, \tilde\iota_1, \ldots, \tilde\iota_i]
\end{eqnarray*}
(for suitable lifts $\tilde{x}$ in $E$) in $\det_\kappa(E)$.
This holds because we may use the admissible relations of type (c)
$cg$ times in the following order: move the
$\tilde\zeta_1$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_1 \subset A$),
then move $\tilde\zeta_2$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_2 \subset A + R\tilde\zeta_1$),
and so on.

\medskip\noindent
Part (3) of the lemma is obvious.
This finishes the proof.
\end{proof}

\noindent
We can use the maps $\gamma$ of the lemma to define more general maps
$\gamma$ as follows. Suppose that $(R, \mathfrak m, \kappa)$ is a
local ring. Let $M$ be a finite length $R$-module and suppose we
are given a finite filtration (see
Homology, Definition \ref{homology-definition-filtered})
$$
M = F^n \supset F^{n + 1} \supset \ldots \supset F^{m - 1} \supset F^m = 0.
$$
Then there is a canonical isomorphism
$$
\gamma_{(M, F)} :
\bigotimes\nolimits_i \det\nolimits_\kappa(F^i/F^{i + 1})
\longrightarrow
\det\nolimits_\kappa(M)
$$
well defined up to sign(!). One can make the sign explicit either by
giving a well defined order of the terms in the tensor product (starting with
higher indices unfortunately), and by thinking of the target category for
the functor $\det_\kappa$ as the category of
$1$-dimensional super vector spaces. See \cite[Section 1]{determinant}.

\medskip\noindent
Here is another typical result for determinant functors.
It is not hard to show. The tricky part is usually to show the
existence of a determinant functor.

\begin{lemma}
\label{lemma-uniqueness-det}
Let $(R, \mathfrak m, \kappa)$ be any local ring.
The functor
$$
\det\nolimits_\kappa :
\left\{
\begin{matrix}
\text{finite length }R\text{-modules} \\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces} \\
\text{with isomorphisms}
\end{matrix}
\right\}
$$
endowed with the maps $\gamma_{K \to L \to M}$ is characterized by
the following properties
\begin{enumerate}
\item its restriction to the subcategory of modules annihilated
by $\mathfrak m$ is isomorphic to the usual determinant functor
(see Lemma \ref{lemma-compare-det}), and
\item (1), (2) and (3) of Lemma \ref{lemma-det-exact-sequences}
hold.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-determinant-quotient-ring}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
Let $I \subset \mathfrak m$ be an ideal, and set $R' = R/I$.
Let $\det_{R, \kappa}$ denote the determinant functor
on the category $\text{Mod}^f_R$ finite length $R$-modules
and denote $\det_{R', \kappa}$ the determinant on
the category $\text{Mod}^f_{R'}$ of finite length $R'$-modules.
Then $\text{Mod}^f_{R'} \subset \text{Mod}^f_R$ is a full subcategory
and there exists an isomorphism of functors
$$
\det\nolimits_{R, \kappa}|_{\text{Mod}^f_{R'}}
=
\det\nolimits_{R', \kappa}
$$
compatible with the isomorphisms $\gamma_{K \to L \to M}$
for either of these functors.
\end{lemma}

\begin{proof}
This can be shown by using the characterization
of the pair $(\det\nolimits_{R', \kappa}, \gamma)$
in Lemma \ref{lemma-uniqueness-det}.
But really the isomorphism is obtained by mapping a symbol
$[x_1, \ldots, x_l] \in \det\nolimits_{R, \kappa}(M)$
to the corresponding symbol
$[x_1, \ldots, x_l] \in \det\nolimits_{R', \kappa}(M)$
which ``obviously'' works.
\end{proof}

\noindent
Here is a case where we can compute the determinant of a linear map.
In fact there is nothing mysterious about this in any case, see
Example \ref{example-determinant-map} for a random example.

\begin{lemma}
\label{lemma-times-u-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $u \in R^*$ be a unit.
Let $M$ be a module of finite length over $R$.
Denote $u_M : M \to M$ the map multiplication by $u$.
Then
$$
\det\nolimits_\kappa(u_M) :
\det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is multiplication by $\overline{u}^l$ where $l = \text{length}_R(M)$
and $\overline{u} \in \kappa^*$ is the image of $u$.
\end{lemma}

\begin{proof}
Denote $f_M \in \kappa^*$ the element such that
$\det\nolimits_\kappa(u_M) = f_M \text{id}_{\det\nolimits_\kappa(M)}$.
Suppose that $0 \to K \to L \to M \to 0$ is a short
exact sequence of finite $R$-modules. Then we see that
$u_k$, $u_L$, $u_M$ give an isomorphism of short exact sequences.
Hence by Lemma \ref{lemma-det-exact-sequences} (1) we conclude that
$f_K f_M = f_L$.
This means that by induction on length it suffices to prove the
lemma in the case of length $1$ where it is trivial.
\end{proof}

\begin{example}
\label{example-determinant-map}
Consider the local ring $R = \mathbf{Z}_p$.
Set $M = \mathbf{Z}_p/(p^2) \oplus \mathbf{Z}_p/(p^3)$.
Let $u : M \to M$ be the map given by the matrix
$$
u =
\left(
\begin{matrix}
a & b \\
pc & d
\end{matrix}
\right)
$$
where $a, b, c, d \in \mathbf{Z}_p$, and $a, d \in \mathbf{Z}_p^*$.
In this case $\det_\kappa(u)$ equals multiplication by
$a^2d^3 \bmod p \in \mathbf{F}_p^*$. This can easily be seen
by consider the effect of $u$ on the symbol
$[p^2e, pe, pf, e, f]$ where $e = (0 , 1) \in M$ and
$f = (1, 0) \in M$.
\end{example}








\section{Periodic complexes}
\label{section-periodic-complexes}

\noindent
Of course there is a very general notion of periodic complexes.
We can require periodicity of the maps, or periodicity of the objects.
We will add these here as needed. For the moment we only need
the following cases.

\begin{definition}
\label{definition-periodic-complex}
Let $R$ be a ring.
\begin{enumerate}
\item A {\it $2$-periodic complex} over $R$ is given
by a quadruple $(M, N, \varphi, \psi)$ consisting of
$R$-modules $M$, $N$ and $R$-module maps $\varphi : M \to N$,
$\psi: N \to M$ such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
N \ar[r]^\psi &
M \ar[r]^\varphi &
N \ar[r] & \ldots
}
$$
is a complex. In this setting we define the {\it cohomology modules}
of the complex to be the $R$-modules
$$
H^0(M, N, \varphi, \psi) = \text{Ker}(\varphi)/\text{Im}(\psi)
, \quad\text{and}\quad
H^1(M, N, \varphi, \psi) = \text{Ker}(\psi)/\text{Im}(\varphi).
$$
We say the $2$-periodic complex is {\it exact} if the cohomology
groups are zero.
\item A {\it $(2, 1)$-periodic complex} over $R$ is given
by a triple $(M, \varphi, \psi)$ consisting of an $R$-module $M$ and
$R$-module maps $\varphi : M \to M$, $\psi : M \to M$
such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
M \ar[r]^\psi &
M \ar[r]^\varphi &
M \ar[r] & \ldots
}
$$
is a complex. Since this is a special case of a $2$-periodic complex
we have its {\it cohomology modules} $H^0(M, \varphi, \psi)$,
$H^1(M, \varphi, \psi)$ and a notion of exactness.
\end{enumerate}
\end{definition}

\noindent
In the following we will use any result proved for $2$-periodic
complexes without further mention for $(2, 1)$-periodic complexes.
It is clear that the collection of $2$-periodic complexes
(resp.\ $(2, 1)$-periodic complexes) forms a category with morphisms
$(f, g) : (M, N, \varphi, \psi) \to (M', N', \varphi', \psi')$
pairs of morphisms $f : M \to M'$ and $g : N \to N'$ such
that $\varphi' \circ f = f \circ \varphi$ and $\psi' \circ g = g \circ \psi$.
In fact it is an abelian category, with kernels and cokernels as in
Homology, Lemma \ref{homology-lemma-cat-chain-abelian}.
Also, note that a special case are the
$(2, 1)$-periodic complexes of the form $(M, 0, \psi)$. In this
special case we have
$$
H^0(M, 0, \psi) = \text{Coker}(\psi)
, \quad\text{and}\quad
H^1(M, 0, \psi) = \text{Ker}(\psi).
$$

\begin{definition}
\label{definition-periodic-length}
Let $R$ be a local ring.
Let $(M, N, \varphi, \psi)$ be a $2$-periodic complex over $R$
whose cohomology groups have finite length over $R$.
In this case we define the {\it multiplicity} of $(M, N, \varphi, \psi)$
to be the integer
$$
e_R(M, N, \varphi, \psi) =
\text{length}_R(H^0(M, N, \varphi, \psi))
-
\text{length}_R(H^1(M, N, \varphi, \psi))
$$
We will sometimes (especially in the case of a $(2, 1)$-periodic complex with
$\varphi = 0$) call this the {\it Herbrand quotient}\footnote{If the residue
field of $R$ is finite with $q$ elements
it is customary to call the Herbrand quotient
$h(M, N, \varphi, \psi) = q^{e_R(M, N, \varphi, \psi)}$ which is equal to
the number of elements of $H^0$ divided by the number of elements of
$H^1$.}.
\end{definition}

\begin{lemma}
\label{lemma-periodic-length}
Let $R$ be a local ring.
\begin{enumerate}
\item If $(M, N, \varphi, \psi)$ is a $2$-periodic complex
such that $M$, $N$ have finite length. Then
$e_R(M, N, \varphi, \psi) = \text{length}_R(M) - \text{length}_R(N)$.
\item If $(M, \varphi, \psi)$ is a $(2, 1)$-periodic complex
such that $M$ has finite length. Then
$e_R(M, \varphi, \psi) = 0$.
\item Suppose that we have a short exact sequence of
$(2, 1)$-periodic complexes
$$
0 \to (M_1, N_1, \varphi_1, \psi_1)
\to (M_2, N_2, \varphi_2, \psi_2)
\to (M_3, N_3, \varphi_3, \psi_3)
\to 0
$$
If two out of three have cohomology modules of finite length so does
the third and we have
$$
e_R(M_2, N_2, \varphi_2, \psi_2) =
e_R(M_1, N_1, \varphi_1, \psi_1) +
e_R(M_3, N_3, \varphi_3, \psi_3).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (3). Abbreviate $A = (M_1, N_1, \varphi_1, \psi_1)$,
$B = (M_2, N_2, \varphi_2, \psi_2)$ and $C = (M_3, N_3, \varphi_3, \psi_3)$.
We have a long exact cohomology sequence
$$
\ldots
\to H^1(C)
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to H^1(C)
\to \ldots
$$
This gives a finite exact sequence
$$
0 \to I
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to K \to 0
$$
with $0 \to K \to H^1(C) \to I \to 0$ a filtration. By additivity of
the length function (Algebra, Lemma \ref{algebra-lemma-length-additive})
we see the result.
The proofs of (1) and (2) are omitted.
\end{proof}

\noindent
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. We are going to use the determinant construction to define
an invariant of this situation. See
Section \ref{section-determinants-finite-length}.
Let us abbreviate
$K_\varphi = \text{Ker}(\varphi)$,
$I_\varphi = \text{Im}(\varphi)$,
$K_\psi = \text{Ker}(\psi)$, and
$I_\psi = \text{Im}(\psi)$.
The short exact sequences
$$
0 \to K_\varphi \to M \to I_\varphi \to 0, \quad
0 \to K_\psi \to M \to I_\psi \to 0
$$
give isomorphisms
$$
\gamma_\varphi :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M), \quad
\gamma_\psi :
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
\longrightarrow
\det\nolimits_\kappa(M),
$$
see Lemma \ref{lemma-det-exact-sequences}.
On the other hand the exactness of the complex gives equalities
$K_\varphi = I_\psi$, and $K_\psi = I_\varphi$
and hence an isomorphism
$$
\sigma :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
$$
by switching the factors. Using this notation we can define our invariant.

\begin{definition}
\label{definition-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. The {\it determinant of $(M, \varphi, \psi)$} is
the element
$$
\det\nolimits_\kappa(M, \varphi, \psi) \in \kappa^*
$$
such that the composition
$$
\det\nolimits_\kappa(M)
\xrightarrow{\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}}
\det\nolimits_\kappa(M)
$$
is multiplication by
$(-1)^{\text{length}_R(I_\varphi)\text{length}_R(I_\psi)}
\det\nolimits_\kappa(M, \varphi, \psi)$.
\end{definition}

\begin{remark}
\label{remark-more-elementary}
Here is a more down to earth description of the determinant
introduced above. Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Let us abbreviate $I_\varphi = \text{Im}(\varphi)$,
$I_\psi = \text{Im}(\psi)$ as above.
Assume that $\text{length}_R(I_\varphi) = a$ and
$\text{length}_R(I_\psi) = b$, so that $a + b = \text{length}_R(M)$
by exactness. Choose admissible sequences
$x_1, \ldots, x_a \in I_\varphi$ and $y_1, \ldots, y_b \in I_\psi$
such that the symbol $[x_1, \ldots, x_a]$ generates $\det_\kappa(I_\varphi)$
and the symbol $[x_1, \ldots, x_b]$ generates $\det_\kappa(I_\psi)$.
Choose $\tilde x_i \in M$ such that $\varphi(\tilde x_i) = x_i$.
Choose $\tilde y_j \in M$ such that $\psi(\tilde y_j) = y_j$.
Then $\det_\kappa(M, \varphi, \psi)$ is characterized
by the equality
$$
[x_1, \ldots, x_a, \tilde y_1, \ldots, \tilde y_b]
=
(-1)^{ab} \det\nolimits_\kappa(M, \varphi, \psi)
[y_1, \ldots, y_b, \tilde x_1, \ldots, \tilde x_a]
$$
in $\det_\kappa(M)$. This also explains the sign.
\end{remark}

\begin{lemma}
\label{lemma-periodic-determinant-shift}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Then
$$
\det\nolimits_\kappa(M, \varphi, \psi)
\det\nolimits_\kappa(M, \psi, \varphi)
= 1.
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant-sign}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \varphi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Then $\text{length}_R(M) = 2 \text{length}_R(\text{Im}(\varphi))$
and
$$
\det\nolimits_\kappa(M, \varphi, \psi)
=
(-1)^{\text{length}_R(\text{Im}(\varphi))}
=
(-1)^{\frac{1}{2}\text{length}_R(M)}
$$
\end{lemma}

\begin{proof}
Follows directly from the sign rule in the definitions.
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant-easy-case}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
\begin{enumerate}
\item if $\varphi : M \to M$ is an isomorphism then
$\det_\kappa(M, \varphi, 0) = \det_\kappa(\varphi)$.
\item if $\psi : M \to M$ is an isomorphism then
$\det_\kappa(M, 0, \psi) = \det_\kappa(\psi)^{-1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove (1). Set $\psi = 0$. Then we may, with notation
as above Definition \ref{definition-periodic-determinant}, identify
$K_\varphi = I_\psi = 0$, $I_\varphi = K_\psi = M$.
With these identifications, the map
$$
\gamma_\varphi :
\kappa \otimes \det\nolimits_\kappa(M)
=
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is identified with $\det_\kappa(\varphi^{-1})$. On the other hand the
map $\gamma_\psi$ is identified with the identity map. Hence
$\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$ is equal
to $\det_\kappa(\varphi)$ in this case. Whence the result.
We omit the proof of (2).
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Suppose that we have a short exact sequence of
$(2, 1)$-periodic complexes
$$
0 \to (M_1, \varphi_1, \psi_1)
\to (M_2, \varphi_2, \psi_2)
\to (M_3, \varphi_3, \psi_3)
\to 0
$$
with all $M_i$ of finite length, and each $(M_1, \varphi_1, \psi_1)$ exact.
Then
$$
\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3).
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
Let us abbreviate
$I_{\varphi, i} = \text{Im}(\varphi_i)$,
$K_{\varphi, i} = \text{Ker}(\varphi_i)$,
$I_{\psi, i} = \text{Im}(\psi_i)$, and
$K_{\psi, i} = \text{Ker}(\psi_i)$.
Observe that we have a commutative square
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] &
K_{\varphi, 1} \ar[r] \ar[d] &
K_{\varphi, 2} \ar[r] \ar[d] &
K_{\varphi, 3} \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M_1 \ar[r] \ar[d] &
M_2 \ar[r] \ar[d] &
M_3 \ar[r] \ar[d] &
0 \\
0 \ar[r] &
I_{\varphi, 1} \ar[r] \ar[d] &
I_{\varphi, 2} \ar[r] \ar[d] &
I_{\varphi, 3} \ar[r] \ar[d] &
0 \\
& 0  & 0  & 0  &
}
$$
of finite length $R$-modules with exact rows and columns.
The top row is exact since it can be identified with the
sequence $I_{\psi, 1} \to I_{\psi, 2} \to I_{\psi, 3} \to 0$
of images, and similarly for the bottom row. There is a similar diagram
involving the modules $I_{\psi, i}$ and $K_{\psi, i}$.
By definition $\det_\kappa(M_2, \varphi_2, \psi_2)$
corresponds, up to a sign, to the composition of the left vertical maps
in the following diagram
$$
\xymatrix{
\det_\kappa(M_1) \otimes
\det_\kappa(M_3) \ar[r]^\gamma
\ar[d]^{\gamma^{-1} \otimes \gamma^{-1}} &
\det_\kappa(M_2)
\ar[d]^{\gamma^{-1}} \\
\det\nolimits_\kappa(K_{\varphi, 1})
\otimes
\det\nolimits_\kappa(I_{\varphi, 1})
\otimes
\det\nolimits_\kappa(K_{\varphi, 3})
\otimes
\det\nolimits_\kappa(I_{\varphi, 3})
\ar[d]^{\sigma \otimes \sigma}
\ar[r]^-{\gamma \otimes \gamma} &
\det\nolimits_\kappa(K_{\varphi, 2})
\otimes
\det\nolimits_\kappa(I_{\varphi, 2})
\ar[d]^\sigma
\\
\det\nolimits_\kappa(K_{\psi, 1})
\otimes
\det\nolimits_\kappa(I_{\psi, 1})
\otimes
\det\nolimits_\kappa(K_{\psi, 3})
\otimes
\det\nolimits_\kappa(I_{\psi, 3})
\ar[d]^{\gamma \otimes \gamma}
\ar[r]^-{\gamma \otimes \gamma}
&
\det\nolimits_\kappa(K_{\psi, 2})
\otimes
\det\nolimits_\kappa(I_{\psi, 2})
\ar[d]^\gamma \\
\det_\kappa(M_1)
\otimes
\det_\kappa(M_3) \ar[r]^\gamma
&
\det_\kappa(M_2)
}
$$
The top and bottom squares are commutative up to sign
by applying Lemma \ref{lemma-det-exact-sequences} (2).
The middle square is trivially
commutative (we are just switching factors). Hence we see
that
$\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\epsilon \det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3)
$
for some sign $\epsilon$. And the sign can be worked out, namely
the outer rectangle in the diagram above commutes up to
\begin{eqnarray*}
\epsilon & = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(K_{\varphi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(K_{\psi, 3})} \\
& = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(I_{\psi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(I_{\varphi, 3})}
\end{eqnarray*}
(proof omitted). It follows easily from this that the signs
work out as well.
\end{proof}

\begin{example}
\label{example-dual-numbers}
Let $k$ be a field.
Consider the ring $R = k[T]/(T^2)$ of dual numbers over $k$.
Denote $t$ the class of $T$ in $R$.
Let $M = R$ and $\varphi = ut$, $\psi = vt$ with $u, v \in k^*$.
In this case $\det_k(M)$ has generator $e = [t, 1]$.
We identify $I_\varphi = K_\varphi = I_\psi = K_\psi = (t)$.
Then $\gamma_\varphi(t \otimes t) = u^{-1}[t, 1]$
(since $u^{-1} \in M$ is a lift of $t \in I_\varphi$)
and $\gamma_\psi(t \otimes t) = v^{-1}[t, 1]$ (same reason).
Hence we see that $\det_k(M, \varphi, \psi) = -u/v \in k^*$.
\end{example}

\begin{example}
\label{example-Zp}
Let $R = \mathbf{Z}_p$ and let $M = \mathbf{Z}_p/(p^l)$.
Let $\varphi = p^b u$ and $\varphi = p^a v$ with $a, b \geq 0$,
$a + b = l$ and $u, v \in \mathbf{Z}_p^*$.
Then a computation as in Example \ref{example-dual-numbers}
shows that
\begin{eqnarray*}
\det\nolimits_{\mathbf{F}_p}(\mathbf{Z}_p/(p^l), p^bu, p^av) & = &
(-1)^{ab}u^a/v^b \bmod p \\
& = &
(-1)^{\text{ord}_p(\alpha)\text{ord}_p(\beta)}
\frac{\alpha^{\text{ord}_p(\beta)}}{\beta^{\text{ord}_p(\alpha)}} \bmod p
\end{eqnarray*}
with $\alpha = p^bu, \beta = p^av \in \mathbf{Z}_p$.
See Lemma \ref{lemma-symbol-is-usual-tame-symbol}
for a more general case (and a proof).
\end{example}

\begin{example}
\label{example-generic-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus b}$ be $l = a + b$ dimensional.
Let $\varphi$ and $\psi$ be the following diagonal matrices
$$
\varphi = \text{diag}(u_1, \ldots, u_a, 0, \ldots, 0),
\quad
\psi = \text{diag}(0, \ldots, 0, v_1, \ldots, v_b)
$$
with $u_i, v_j \in k^*$. In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
\frac{u_1 \ldots u_a}{v_1 \ldots v_b}.
$$
This can be seen by a direct computation or by computing in case $l = 1$
and using the additivity of Lemma \ref{lemma-periodic-determinant}.
\end{example}

\begin{example}
\label{example-special-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus a}$ be $l = 2a$ dimensional.
Let $\varphi$ and $\psi$ be the following block matrices
$$
\varphi =
\left(
\begin{matrix}
0 & U \\
0 & 0
\end{matrix}
\right),
\quad
\psi =
\left(
\begin{matrix}
0 & V \\
0 & 0
\end{matrix}
\right),
$$
with $U, V \in \text{Mat}(a \times a, k)$ invertible.
In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
(-1)^a\frac{\det(U)}{\det(V)}.
$$
This can be seen by a direct computation.
The case $a = 1$ is similar to the computation in
Example \ref{example-dual-numbers}.
\end{example}

\begin{example}
\label{example-a-la-oort}
Let $R = k$ be a field.
Let $M = k^{\oplus 4}$.
Let
$$
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
u_1 &   0 &   0 &   0 \\
  0 &   0 &   0 &   0 \\
  0 &   0 & u_2 &   0
\end{matrix}
\right)
\quad
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
  0 &   0 & v_2 &   0 \\
  0 &   0 &   0 &   0 \\
v_1 &   0 &   0 &   0
\end{matrix}
\right)
\quad
$$
with $u_1, u_2, v_1, v_2 \in k^*$.
Then we have
$$
\det\nolimits_k(M, \varphi, \psi) = -\frac{u_1u_2}{v_1v_2}.
$$
\end{example}

\noindent
Next we come to the analogue of the fact that the determinant
of a composition of linear endomorphisms is the product of
the determinants. To avoid very long formulae we
write $I_\varphi = \text{Im}(\varphi)$, and
$K_\varphi = \text{Ker}(\varphi)$
for any $R$-module map $\varphi : M \to M$.
We also denote $\varphi\psi = \varphi \circ \psi$
for a pair of morphisms $\varphi, \psi : M \to M$.

\begin{lemma}
\label{lemma-multiplicativity-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
Let $\alpha, \beta, \gamma$ be endomorphisms of $M$.
Assume that
\begin{enumerate}
\item $I_\alpha = K_{\beta\gamma}$, and similarly for any permutation
of $\alpha, \beta, \gamma$,
\item $K_\alpha = I_{\beta\gamma}$, and similarly for any permutation
of $\alpha, \beta, \gamma$.
\end{enumerate}
Then
\begin{enumerate}
\item The triple $(M, \alpha, \beta\gamma)$
is an exact $(2, 1)$-periodic complex.
\item The triple $(I_\gamma, \alpha, \beta)$
is an exact $(2, 1)$-periodic complex.
\item The triple $(M/K_\beta, \alpha, \gamma)$
is an exact $(2, 1)$-periodic complex.
\item We have
$$
\det\nolimits_\kappa(M, \alpha, \beta\gamma)
=
\det\nolimits_\kappa(I_\gamma, \alpha, \beta)
\det\nolimits_\kappa(M/K_\beta, \alpha, \gamma).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that the assumptions imply part (1) of the lemma.

\medskip\noindent
To see part (1) note that the assumptions imply that
$I_{\gamma\alpha} = I_{\alpha\gamma}$, and similarly for kernels
and any other pair of morphisms.
Moreover, we see that
$I_{\gamma\beta} =I_{\beta\gamma} = K_\alpha \subset I_\gamma$ and
similarly for any other pair. In particular we get a short exact sequence
$$
0 \to I_{\beta\gamma} \to I_\gamma \xrightarrow{\alpha} I_{\alpha\gamma} \to 0
$$
and similarly we get a short exact sequence
$$
0 \to I_{\alpha\gamma} \to I_\gamma \xrightarrow{\beta} I_{\beta\gamma} \to 0.
$$
This proves $(I_\gamma, \alpha, \beta)$ is an exact $(2, 1)$-periodic
complex. Hence part (2) of the lemma holds.

\medskip\noindent
To see that $\alpha$, $\gamma$ give well defined endomorphisms
of $M/K_\beta$ we have to check that $\alpha(K_\beta) \subset K_\beta$
and $\gamma(K_\beta) \subset K_\beta$. This is true because
$\alpha(K_\beta) = \alpha(I_{\gamma\alpha}) = I_{\alpha\gamma\alpha}
\subset I_{\alpha\gamma} = K_\beta$, and similarly in the other case.
The kernel of the map $\alpha : M/K_\beta \to M/K_\beta$ is
$K_{\beta\alpha}/K_\beta = I_\gamma/K_\beta$. Similarly,
the kernel of $\gamma : M/K_\beta \to M/K_\beta$ is equal to
$I_\alpha/K_\beta$. Hence we conclude that (3) holds.

\medskip\noindent
We introduce $r = \text{length}_R(K_\alpha)$,
$s = \text{length}_R(K_\beta)$ and $t = \text{length}_R(K_\gamma)$.
By the exact sequences above and our hypotheses we have
$\text{length}_R(I_\alpha) = s + t$, $\text{length}_R(I_\beta) = r + t$,
$\text{length}_R(I_\gamma) = r + s$, and
$\text{length}(M) = r + s + t$.
Choose
\begin{enumerate}
\item an admissible sequence $x_1, \ldots, x_r \in K_\alpha$
generating $K_\alpha$
\item an admissible sequence $y_1, \ldots, y_s \in K_\beta$
generating $K_\beta$,
\item an admissible sequence $z_1, \ldots, z_t \in K_\gamma$
generating $K_\gamma$,
\item elements $\tilde x_i \in M$ such that $\beta\gamma\tilde x_i = x_i$,
\item elements $\tilde y_i \in M$ such that $\alpha\gamma\tilde y_i = y_i$,
\item elements $\tilde z_i \in M$ such that $\beta\alpha\tilde z_i = z_i$.
\end{enumerate}
With these choices the sequence
$y_1, \ldots, y_s, \alpha\tilde z_1, \ldots, \alpha\tilde z_t$
is an admissible sequence in $I_\alpha$ generating it.
Hence, by Remark \ref{remark-more-elementary} the determinant
$D = \det_\kappa(M, \alpha, \beta\gamma)$ is the
unique element of $\kappa^*$ such that
\begin{align*}
[y_1, \ldots, y_s,
\alpha\tilde z_1, \ldots, \alpha\tilde z_s,
\tilde x_1, \ldots, \tilde x_r] \\
= (-1)^{r(s + t)} D
[x_1, \ldots, x_r,
\gamma\tilde y_1, \ldots, \gamma\tilde y_s,
\tilde z_1, \ldots, \tilde z_t]
\end{align*}
By the same remark, we see that
$D_1 = \det_\kappa(M/K_\beta, \alpha, \gamma)$
is characterized by
$$
[y_1, \ldots, y_s,
\alpha\tilde z_1, \ldots, \alpha\tilde z_t,
\tilde x_1, \ldots, \tilde x_r]
=
(-1)^{rt} D_1
[y_1, \ldots, y_s,
\gamma\tilde x_1, \ldots, \gamma\tilde x_r,
\tilde z_1, \ldots, \tilde z_t]
$$
By the same remark, we see that
$D_2 = \det_\kappa(I_\gamma, \alpha, \beta)$ is characterized by
$$
[y_1, \ldots, y_s,
\gamma\tilde x_1, \ldots, \gamma\tilde x_r,
\tilde z_1, \ldots, \tilde z_t]
=
(-1)^{rs} D_2
[x_1, \ldots, x_r,
\gamma\tilde y_1, \ldots, \gamma\tilde y_s,
\tilde z_1, \ldots, \tilde z_t]
$$
Combining the formulas above we see that $D = D_1 D_2$
as desired.
\end{proof}


\begin{lemma}
\label{lemma-tricky}
Let $R$ be a local ring with residue field $\kappa$.
Let $\alpha : (M, \varphi, \psi) \to (M', \varphi', \psi')$
be a morphism of $(2, 1)$-periodic complexes over $R$.
Assume
\begin{enumerate}
\item $M$, $M'$ have finite length,
\item $(M, \varphi, \psi)$, $(M', \varphi', \psi')$ are exact,
\item the maps $\varphi$, $\psi$ induce the zero map on
$K = \text{Ker}(\alpha)$, and
\item the maps $\varphi$, $\psi$ induce the zero map on
$Q = \text{Coker}(\alpha)$.
\end{enumerate}
Denote $N = \alpha(M) \subset M'$. We obtain two short exact sequences
of $(2, 1)$-periodic complexes
$$
\begin{matrix}
0 \to (N, \varphi', \psi') \to (M', \varphi', \psi') \to (Q, 0, 0) \to 0 \\
0 \to (K, 0, 0) \to (M, \varphi, \psi) \to (N, \varphi', \psi') \to 0
\end{matrix}
$$
which induce two isomorphisms $\alpha_i : Q \to K$, $i = 0, 1$. Then
$$
\det\nolimits_\kappa(M, \varphi, \psi)
=
\det\nolimits_\kappa(\alpha_0^{-1} \circ \alpha_1)
\det\nolimits_\kappa(M', \varphi', \psi')
$$
In particular, if $\alpha_0 = \alpha_1$, then
$\det\nolimits_\kappa(M, \varphi, \psi) =
\det\nolimits_\kappa(M', \varphi', \psi')$.
\end{lemma}

\begin{proof}
There are (at least) two ways to prove this lemma. One is to produce an
enormous commutative diagram using the properties of the determinants.
The other is to use the characterization of the determinants in terms
of admissible sequences of elements. It is the second approach that we
will use.

\medskip\noindent
First let us explain precisely what the maps $\alpha_i$ are.
Namely, $\alpha_0$ is the composition
$$
\alpha_0 : Q = H^0(Q, 0, 0) \to H^1(N, \varphi', \psi') \to H^2(K, 0, 0) = K
$$
and $\alpha_1$ is the composition
$$
\alpha_1 : Q = H^1(Q, 0, 0) \to H^2(N, \varphi', \psi') \to H^3(K, 0, 0) = K
$$
coming from the boundary maps of the short exact sequences of complexes
displayed in the lemma. The fact that the
complexes $(M, \varphi, \psi)$, $(M', \varphi', \psi')$ are exact
implies these maps are isomorphisms.

\medskip\noindent
We will use the notation $I_\varphi = \text{Im}(\varphi)$,
$K_\varphi = \text{Ker}(\varphi)$ and similarly for the other maps.
Exactness for $M$ and $M'$
means that $K_\varphi = I_\psi$ and three similar equalities.
We introduce $k = \text{length}_R(K)$, $a = \text{length}_R(I_\varphi)$,
$b = \text{length}_R(I_\psi)$. Then we see that $\text{length}_R(M) = a + b$,
and $\text{length}_R(N) = a + b - k$, $\text{length}_R(Q) = k$
and $\text{length}_R(M') = a + b$. The exact sequences below will show
that also $\text{length}_R(I_{\varphi'}) = a$ and
$\text{length}_R(I_{\psi'}) = b$.

\medskip\noindent
The assumption that $K \subset K_\varphi = I_\psi$ means that
$\varphi$ factors through $N$ to give an exact sequence
$$
0 \to \alpha(I_\psi) \to N \xrightarrow{\varphi\alpha^{-1}} I_\psi \to 0.
$$
Here $\varphi\alpha^{-1}(x') = y$ means $x' = \alpha(x)$ and $y = \varphi(x)$.
Similarly, we have
$$
0 \to \alpha(I_\varphi) \to N \xrightarrow{\psi\alpha^{-1}} I_\varphi \to 0.
$$
The assumption that $\psi'$ induces the zero map on
$Q$ means that $I_{\psi'} = K_{\varphi'} \subset N$.
This means the quotient $\varphi'(N) \subset I_{\varphi'}$
is identified with $Q$. Note that $\varphi'(N) = \alpha(I_\varphi)$.
Hence we conclude there is an isomorphism
$$
\varphi' : Q \to I_{\varphi'}/\alpha(I_\varphi)
$$
simply described by
$\varphi'(x' \bmod N) = \varphi'(x') \bmod \alpha(I_\varphi)$.
In exactly the same way we get
$$
\psi' : Q \to I_{\psi'}/\alpha(I_\psi)
$$
Finally, note that $\alpha_0$ is the composition
$$
\xymatrix{
Q \ar[r]^-{\varphi'} &
I_{\varphi'}/\alpha(I_\varphi)
\ar[rrr]^-{\psi\alpha^{-1}|_{I_{\varphi'}/\alpha(I_\varphi)}} & & &
K
}
$$
and similarly
$\alpha_1 = \varphi\alpha^{-1}|_{I_{\psi'}/\alpha(I_\psi)} \circ \psi'$.

\medskip\noindent
To shorten the formulas below we are going to write $\alpha x$ instead
of $\alpha(x)$ in the following. No confusion should result since
all maps are indicated by greek letters and elements by roman letters.
We are going to choose
\begin{enumerate}
\item an admissible sequence $z_1, \ldots, z_k \in K$
generating $K$,
\item elements $z'_i \in M$ such that $\varphi z'_i = z_i$,
\item elements $z''_i \in M$ such that $\psi z''_i = z_i$,
\item elements $x_{k + 1}, \ldots, x_a \in I_\varphi$ such
that $z_1, \ldots, z_k, x_{k + 1}, \ldots, x_a$ is an admissible
sequence generating $I_\varphi$,
\item elements $\tilde x_i \in M$ such that $\varphi \tilde x_i = x_i$,
\item elements $y_{k + 1}, \ldots, y_b \in I_\psi$ such that
$z_1, \ldots, z_k, y_{k + 1}, \ldots, y_b$ is an admissible
sequence generating $I_\psi$,
\item elements $\tilde y_i \in M$ such that $\psi \tilde y_i = y_i$, and
\item elements $w_1, \ldots, w_k \in M'$ such that
$w_1 \bmod N, \ldots, w_k \bmod N$ are an admissible sequence
in $Q$ generating $Q$.
\end{enumerate}
By Remark \ref{remark-more-elementary} the element
$D = \det_\kappa(M, \varphi, \psi) \in \kappa^*$ is
characterized by
\begin{eqnarray*}
& &
[z_1, \ldots, z_k,
x_{k + 1}, \ldots, x_a,
z''_1, \ldots, z''_k,
\tilde y_{k + 1}, \ldots, \tilde y_b] \\
& = &
(-1)^{ab} D
[z_1, \ldots, z_k,
y_{k + 1}, \ldots, y_b,
z'_1, \ldots, z'_k,
\tilde x_{k + 1}, \ldots, \tilde x_a]
\end{eqnarray*}
Note that by the discussion above
$\alpha x_{k + 1}, \ldots, \alpha x_a, \varphi w_1, \ldots, \varphi w_k$
is an admissible sequence generating $I_{\varphi'}$ and
$\alpha y_{k + 1}, \ldots, \alpha y_b, \psi w_1, \ldots, \psi w_k$
is an admissible sequence generating $I_{\psi'}$.
Hence by Remark \ref{remark-more-elementary} the element
$D' = \det_\kappa(M', \varphi', \psi') \in \kappa^*$ is
characterized by
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b,
w_1, \ldots, w_k]
\\
& = &
(-1)^{ab} D'
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a,
w_1, \ldots, w_k]
\end{eqnarray*}
Note how in the first, resp.\ second displayed formula the
the first, resp.\ last $k$ entries of the symbols on both sides
are the same. Hence these formulas are really equivalent to the
equalities
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\alpha z''_1, \ldots, \alpha z''_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b] \\
& = &
(-1)^{ab} D
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\alpha z'_1, \ldots, \alpha z'_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
and
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b]
\\
& = &
(-1)^{ab} D'
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
in $\det_\kappa(N)$. Note that
$\varphi' w_1, \ldots, \varphi' w_k$
and
$\alpha z''_1, \ldots, z''_k$
are admissible sequences generating the module
$I_{\varphi'}/\alpha(I_\varphi)$. Write
$$
[\varphi' w_1, \ldots, \varphi' w_k]
= \lambda_0 [\alpha z''_1, \ldots, \alpha z''_k]
$$
in $\det_\kappa(I_{\varphi'}/\alpha(I_\varphi))$
for some $\lambda_0 \in \kappa^*$. Similarly,
write
$$
[\psi' w_1, \ldots, \psi' w_k]
= \lambda_1 [\alpha z'_1, \ldots, \alpha z'_k]
$$
in $\det_\kappa(I_{\psi'}/\alpha(I_\psi))$
for some $\lambda_1 \in \kappa^*$. On the one hand
it is clear that
$$
\alpha_i([w_1, \ldots, w_k]) = \lambda_i[z_1, \ldots, z_k]
$$
for $i = 0, 1$ by our description of $\alpha_i$ above,
which means that
$$
\det\nolimits_\kappa(\alpha_0^{-1} \circ \alpha_1)
=
\lambda_1/\lambda_0
$$
and
on the other hand it is clear that
\begin{eqnarray*}
& &
\lambda_0 [\alpha x_{k + 1}, \ldots, \alpha x_a,
\alpha z''_1, \ldots, \alpha z''_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b] \\
& = &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b]
\end{eqnarray*}
and
\begin{eqnarray*}
& &
\lambda_1[\alpha y_{k + 1}, \ldots, \alpha y_b,
\alpha z'_1, \ldots, \alpha z'_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a] \\
& = &
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
which imply $\lambda_0 D = \lambda_1 D'$. The lemma follows.
\end{proof}








\section{Symbols}
\label{section-symbols}

\noindent
The correct generality for this construction is perhaps the
situation of the following lemma.

\begin{lemma}
\label{lemma-pre-symbol}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module of dimension $1$.
Assume $\varphi, \psi : M \to M$ are two injective
$A$-module maps, and assume $\varphi(\psi(M)) = \psi(\varphi(M))$,
for example if $\varphi$ and $\psi$ commute.
Then $\text{length}_R(M/\varphi\psi M) < \infty$
and $(M/\varphi\psi M, \varphi, \psi)$ is an exact
$(2, 1)$-periodic complex.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a minimal prime of the support of $M$.
Then $M_{\mathfrak q}$ is a finite length $A_{\mathfrak q}$-module,
see Algebra, Lemma \ref{algebra-lemma-support-point}.
Hence both $\varphi$ and $\psi$
induce isomorphisms $M_{\mathfrak q} \to M_{\mathfrak q}$.
Thus the support of $M/\varphi\psi M$ is $\{\mathfrak m_A\}$
and hence it has finite length (see lemma cited above).
Finally, the kernel of $\varphi$ on $M/\varphi\psi M$
is clearly $\psi M/\varphi\psi M$, and hence the kernel
of $\varphi$ is the image of $\psi$ on $M/\varphi\psi M$.
Similarly the other way since $M/\varphi\psi M = M/\psi\varphi M$
by assumption.
\end{proof}

\begin{lemma}
\label{lemma-symbol-defined}
Let $A$ be a Noetherian local ring. Let $a, b \in A$.
\begin{enumerate}
\item if $M$ is a finite $A$-module of dimension $1$
such that $a, b$ are nonzerodivisors on $M$, then
$\text{length}_A(M/abM) < \infty$ and
$(M/abM, a, b)$ is a $(2, 1)$-periodic exact complex.
\item if $a, b$ are nonzerodivisors and $\dim(A) = 1$
then $\text{length}_A(A/(ab)) < \infty$ and
$(A/(ab), a, b)$ is a $(2, 1)$-periodic exact complex.
\end{enumerate}
In particular, in these case
$\det_\kappa(M/abM, a, b) \in \kappa^*$,
resp.\ $\det_\kappa(A/(ab), a, b) \in \kappa^*$
are defined.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-pre-symbol}.
\end{proof}

\begin{definition}
\label{definition-symbol-M}
Let $A$ be a Noetherian local ring with residue field $\kappa$.
Let $a, b \in A$.
Let $M$ be a finite $A$-module of dimension $1$
such that $a, b$ are nonzerodivisors on $M$.
We define the {\it symbol associated to $M, a, b$}
to be the element
$$
d_M(a, b) =
\det\nolimits_\kappa(M/abM, a, b) \in \kappa^*
$$
\end{definition}

\begin{lemma}
\label{lemma-multiplicativity-symbol}
Let $A$ be a Noetherian local ring.
Let $a, b, c \in A$. Let $M$ be a finite $A$-module
with $\dim(M) = 1$. Assume $a, b, c$ are nonzerodivisors on $M$.
Then
$$
d_M(a, bc) = d_M(a, b) d_M(a, c)
$$
and $d_M(a, b)d_M(b, a) = 1$.
\end{lemma}

\begin{proof}
The first statement
is immediate from Lemma \ref{lemma-multiplicativity-determinant} above.
The second comes from Lemma \ref{lemma-periodic-determinant-shift}.
\end{proof}

\begin{definition}
\label{definition-tame-symbol}
Let $A$ be a Noetherian local domain of dimension $1$
with residue field $\kappa$.
Let $K$ be the fraction field of $A$.
We define the {\it tame symbol} of $A$ to be the map
$$
K^* \times K^* \longrightarrow \kappa^*,
\quad
(x, y) \longmapsto d_A(x, y)
$$
where $d_A(x, y)$ is extended to $K^* \times K^*$ by the multiplicativity of
Lemma \ref{lemma-multiplicativity-symbol}.
\end{definition}

\noindent
It is clear that we may extend more generally $d_M(-, -)$ to
certain rings of fractions of $A$ (even if $A$ is not a domain).

\begin{lemma}
\label{lemma-symbol-when-one-is-a-unit}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module of dimension $1$.
Let $b \in A$ be a nonzerodivisor on $M$, and let $u \in A^*$.
Then
$$
d_M(u, b) = u^{\text{length}_M(M/bM)} \bmod \mathfrak m_A.
$$
In particular, if $M = A$, then
$d_A(u, b) = u^{\text{ord}_A(b)} \bmod \mathfrak m_A$.
\end{lemma}

\begin{proof}
Note that in this case $M/ubM = M/bM$ on which multiplication
by $b$ is zero. Hence $d_M(u, b) = \det_\kappa(u|_{M/bM})$
by Lemma \ref{lemma-periodic-determinant-easy-case}. The lemma
then follows from Lemma \ref{lemma-times-u-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-short-exact-sequence}
Let $A$ be a Noetherian local ring.
Let $a, b \in A$.
Let
$$
0 \to M \to M' \to M'' \to 0
$$
be a short exact sequence of $A$-modules of dimension $1$
such that $a, b$ are nonzerodivisors on
all three $A$-modules.
Then
$$
d_{M'}(a, b) = d_M(a, b) d_{M''}(a, b)
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
It is easy to see that this leads to a short exact sequence
of exact $(2, 1)$-periodic complexes
$$
0 \to
(M/abM, a, b) \to
(M'/abM', a, b) \to
(M''/abM'', a, b) \to 0
$$
Hence the lemma follows from Lemma \ref{lemma-periodic-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-compare-modules}
Let $A$ be a Noetherian local ring.
Let $\alpha : M \to M'$ be a homomorphism of
finite $A$-modules of dimension $1$.
Let $a, b \in A$. Assume
\begin{enumerate}
\item $a$, $b$ are nonzerodivisors on both $M$ and $M'$, and
\item $\dim(\text{Ker}(\alpha)), \dim(\text{Coker}(\alpha)) \leq 0$.
\end{enumerate}
Then $d_M(a, b) = d_{M'}(a, b)$.
\end{lemma}

\begin{proof}
If $a \in A^*$, then the equality follows from the
equality $\text{length}(M/bM) = \text{length}(M'/bM')$
and Lemma \ref{lemma-symbol-when-one-is-a-unit}.
Similarly if $b$ is a unit the lemma holds as well
(by the symmetry of Lemma \ref{lemma-multiplicativity-symbol}).
Hence we may assume that $a, b \in \mathfrak m_A$.
This in particular implies that $\mathfrak m$ is not
an associated prime of $M$, and hence $\alpha : M \to M'$
is injective. This permits us to think of $M$ as a submodule of $M'$.
By assumption $M'/M$ is a finite $A$-module with support
$\{\mathfrak m_A\}$ and hence has finite length.
Note that for any third module $M''$ with $M \subset M'' \subset M'$
the maps $M \to M''$ and $M'' \to M'$ satisfy the assumptions of the lemma
as well. This reduces us, by induction on the length of $M'/M$,
to the case where $\text{length}_A(M'/M) = 1$.
Finally, in this case consider the map
$$
\overline{\alpha} : M/abM \longrightarrow M'/abM'.
$$
By construction the cokernel $Q$ of $\overline{\alpha}$ has
length $1$. Since $a, b \in \mathfrak m_A$, they act trivially on
$Q$. It also follows that the kernel $K$ of $\overline{\alpha}$ has
length $1$ and hence also $a$, $b$ act trivially on $K$.
Hence we may apply Lemma \ref{lemma-tricky}. Thus it suffices to see
that the two maps $\alpha_i : Q \to K$ are the same.
In fact, both maps are equal to the map
$q = x' \bmod \text{Im}(\overline{\alpha}) \mapsto abx' \in K$.
We omit the verification.
\end{proof}

\begin{lemma}
\label{lemma-compute-symbol-M}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module with $\dim(M) = 1$.
Let $a, b \in A$ nonzerodivisors on $M$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes in the support of $M$. Then
$$
d_M(a, b)
=
\prod\nolimits_{i = 1, \ldots, t}
d_{A/\mathfrak q_i}(a, b)^{
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})}
$$
as elements of $\kappa^*$.
\end{lemma}

\begin{proof}
Choose a filtration by $A$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_j/M_{j - 1}$ is isomorphic
to $A/\mathfrak p_j$ for some prime ideal $\mathfrak p_j$
of $A$. See Algebra, Lemma \ref{algebra-lemma-filter-Noetherian-module}.
For each $j$ we have either $\mathfrak p_j = \mathfrak q_i$
for some $i$, or $\mathfrak p_j = \mathfrak m_A$. Moreover,
for a fixed $i$, the number of $j$ such that
$\mathfrak p_j = \mathfrak q_i$ is equal to
$\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})$ by
Algebra, Lemma \ref{algebra-lemma-filter-minimal-primes-in-support}.
Hence $d_{M_j}(a, b)$ is defined for each $j$ and
$$
d_{M_j}(a, b)
=
\left\{
\begin{matrix}
d_{M_{j - 1}}(a, b) d_{A/\mathfrak q_i}(a, b) &
\text{if} & \mathfrak p_j = \mathfrak q_i \\
d_{M_{j - 1}}(a, b) & \text{if} & \mathfrak p_j = \mathfrak m_A
\end{matrix}
\right.
$$
by Lemma \ref{lemma-symbol-short-exact-sequence} in the first instance
and Lemma \ref{lemma-symbol-compare-modules} in the second. Hence the lemma.
\end{proof}

\begin{lemma}
\label{lemma-symbol-is-usual-tame-symbol}
Let $A$ be a discrete valuation ring with fraction field $K$.
For nonzero $x, y \in K$ we have
$$
d_A(x, y)
=
(-1)^{\text{ord}_A(x)\text{ord}_A(y)}
\frac{x^{\text{ord}_A(y)}}{y^{\text{ord}_A(x)}} \bmod \mathfrak m_A,
$$
in other words the symbol is equal to the usual tame symbol.
\end{lemma}

\begin{proof}
By multiplicativity it suffices to prove this when $x, y \in A$.
Let $t \in A$ be a uniformizer.
Write $x = t^bu$ and $y = t^bv$ for some $a, b \geq 0$
and $u, v \in A^*$. Set $l = a + b$. Then
$t^{l - 1}, \ldots, t^b$ is an admissible sequence in
$(x)/(xy)$ and $t^{l - 1}, \ldots, t^a$ is an admissible
sequence in $(y)/(xy)$. Hence by Remark \ref{remark-more-elementary}
we see that $d_A(x, y)$ is characterized by the equation
$$
[t^{l - 1}, \ldots, t^b, v^{-1}t^{b - 1}, \ldots, v^{-1}]
=
(-1)^{ab} d_A(x, y)
[t^{l - 1}, \ldots, t^a, u^{-1}t^{a - 1}, \ldots, u^{-1}].
$$
Hence by the admissible relations for the
symbols $[x_1, \ldots, x_l]$ we see that
$$
d_A(x, y) = (-1)^{ab} u^a/v^b \bmod \mathfrak m_A
$$
as desired.
\end{proof}

\noindent
We add the following lemma here. It is very similar to
Algebra, Lemma \ref{algebra-lemma-nonregular-dimension-one}.

\begin{lemma}
\label{lemma-Noetherian-domain-dim-1-two-elements}
Let $R$ be a local Noetherian domain of dimension $1$
with maximal ideal $\mathfrak m$.
Let $a, b \in \mathfrak m$ be nonzero. There exists a finite
ring extension $R \subset R'$ with same field of fractions,
and $t, a', b' \in R'$ such that $a = ta'$ and $b = tb'$ and
$R' = a'R' + b'R'$.
\end{lemma}

\begin{proof}
Set $I = (a, b)$. The idea is to blow up $R$ in $I$ as in
the proof of Algebra, Lemma \ref{algebra-lemma-nonregular-dimension-one}.
Instead of doing the algebraic argument we work geometrically.
Let $X = \text{Proj}(\bigoplus I^d/I^{d + 1})$.
By Divisors, Lemma \ref{divisors-lemma-blow-up-integral-scheme}
this is an integral scheme.
The morphism $X \to \Spec(R)$ is projective by
Divisors, Lemma \ref{divisors-lemma-blowing-up-projective}.
By Algebra, Lemma \ref{algebra-lemma-finite-in-codim-1} and the fact that
$X$ is quasi-compact we see that the fibre of $X \to \Spec(R)$
over $\mathfrak m$ is finite.
By Properties, Lemma \ref{properties-lemma-ample-finite-set-in-affine}
there exists an affine open $U \subset X$
containing this fibre.
Hence $X = U$ because $X \to \Spec(R)$ is closed.
In other words $X$ is affine, say $X = \Spec(R')$.
By Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we see that $R \to R'$ is of finite type. Since $X \to \Spec(R)$ is
proper and affine it is integral (see
Morphisms, Lemma \ref{morphisms-lemma-integral-universally-closed}).
Hence $R \to R'$ is of finite type and integral, hence finite
(Algebra, Lemma \ref{algebra-lemma-characterize-finite-in-terms-of-integral}).
By Divisors,
Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
we see that $IR'$ is a locally principal ideal.
Since $R'$ is semi-local we see that $IR'$ is principal,
see Algebra, Lemma \ref{algebra-lemma-locally-free-semi-local-free},
say $IR' = (t)$. Then we have $a = a't$ and $b = b't$ and everything is
clear.
\end{proof}

\begin{lemma}
\label{lemma-symbol-is-steinberg-prepare}
Let $A$ be a Noetherian local ring.
Let $a, b \in A$.
Let $M$ be a finite $A$-module of dimension $1$ on
which each of $a$, $b$, $b - a$ are nonzerodivisors.
Then
$$
d_M(a, b - a)d_M(b, b) = d_M(b, b - a)d_M(a, b)
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-compute-symbol-M} it suffices to show the relation when
$M = A/\mathfrak q$ for some prime $\mathfrak q \subset A$ with
$\dim(A/\mathfrak q) = 1$.

\medskip\noindent
In case $M = A/\mathfrak q$ we may replace $A$ by $A/\mathfrak q$ and
$a, b$ by their images in $A/\mathfrak q$. Hence we may assume $A = M$
and $A$ a local Noetherian domain of dimension $1$. The reason is
that the residue field $\kappa$ of $A$ and $A/\mathfrak q$ are
the same and that for any $A/\mathfrak q$-module $M$ the determinant
taken over $A$ or over $A/\mathfrak q$ are canonically identified.
See Lemma \ref{lemma-determinant-quotient-ring}.

\medskip\noindent
It suffices to show the relation when both
$a, b$ are in the maximal ideal. Namely, the case where one
or both are units follows from Lemma \ref{lemma-symbol-when-one-is-a-unit}.

\medskip\noindent
Choose an extension $A \subset A'$ and factorizations
$a = ta'$, $b = tb'$ as in
Lemma \ref{lemma-Noetherian-domain-dim-1-two-elements}.
Note that also $b - a = t(b' - a')$ and that
$A' = (a', b') = (a', b' - a') = (b' - a', b')$.
Here and in the following we think of $A'$ as an $A$-module and
$a, b, a', b', t$ as $A$-module endomorphisms of $A'$.
We will use the notation $d^A_{A'}(a', b')$ and so on to indicate
$$
d^A_{A'}(a', b')
=
\det\nolimits_\kappa(A'/a'b'A', a', b')
$$
which is defined by Lemma \ref{lemma-pre-symbol}. The upper index ${}^A$
is used to distinguish this from the already defined symbol
$d_{A'}(a', b')$ which is different (for example because it has values
in the residue field of $A'$ which may be different from $\kappa$).
By Lemma \ref{lemma-symbol-compare-modules} we see that
$d_A(a, b) = d^A_{A'}(a, b)$,
and similarly for the other combinations.
Using this and multiplicativity we see that it suffices to prove
$$
d^A_{A'}(a', b' - a') d^A_{A'}(b', b')
=
d^A_{A'}(b', b' - a') d^A_{A'}(a', b')
$$
Now, since $(a', b') = A'$ and so on we have
$$
\begin{matrix}
A'/(a'(b' - a')) & \cong & A'/(a') \oplus A'/(b' - a') \\
A'/(b'(b' - a')) & \cong & A'/(b') \oplus A'/(b' - a') \\
A'/(a'b') & \cong & A'/(a') \oplus A'/(b')
\end{matrix}
$$
Moreover, note that multiplication by $b' - a'$ on
$A/(a')$ is equal to multiplication by $b'$, and that
multiplication by $b' - a'$ on $A/(b')$ is equal to multiplication by $-a'$.
Using Lemmas
\ref{lemma-periodic-determinant-easy-case} and
\ref{lemma-periodic-determinant}
we conclude
$$
\begin{matrix}
d^A_{A'}(a', b' - a') & = &
\det\nolimits_\kappa(b'|_{A'/(a')})^{-1}
\det\nolimits_\kappa(a'|_{A'/(b' - a')}) \\
d^A_{A'}(b', b' - a') & = &
\det\nolimits_\kappa(-a'|_{A'/(b')})^{-1}
\det\nolimits_\kappa(b'|_{A'/(b' - a')}) \\
d^A_{A'}(a', b') & = &
\det\nolimits_\kappa(b'|_{A'/(a')})^{-1}
\det\nolimits_\kappa(a'|_{A'/(b')})
\end{matrix}
$$
Hence we conclude that
$$
(-1)^{\text{length}_A(A'/(b'))}
d^A_{A'}(a', b' - a')
=
d^A_{A'}(b', b' - a') d^A_{A'}(a', b')
$$
the sign coming from the $-a'$ in the second equality above.
On the other hand, by Lemma \ref{lemma-periodic-determinant-sign} we have
$d^A_{A'}(b', b') = (-1)^{\text{length}_A(A'/(b'))}$, and the lemma
is proved.
\end{proof}

\noindent
The tame symbol is a Steinberg symbol.

\begin{lemma}
\label{lemma-symbol-is-steinberg}
Let $A$ be a Noetherian local domain of dimension $1$.
Let $K = f.f.(A)$. For $x \in K \setminus \{0, 1\}$
we have
$$
d_A(x, 1 -x) = 1
$$
\end{lemma}

\begin{proof}
Write $x = a/b$ with $a, b \in A$.
The hypothesis implies, since $1 - x = (b - a)/b$,
that also $b - a \not = 0$. Hence we compute
$$
d_A(x, 1 - x)
=
d_A(a, b - a)d_A(a, b)^{-1}d_A(b, b - a)^{-1}d_A(b, b)
$$
Thus we have to show that
$d_A(a, b - a) d_A(b, b) = d_A(b, b - a) d_A(a, b)$.
This is Lemma \ref{lemma-symbol-is-steinberg-prepare}.
\end{proof}










\section{Lengths and determinants}
\label{section-length-determinant}

\noindent
In this section we use the determinant to compare lattices.
The key lemma is the following.

\begin{lemma}
\label{lemma-key-lemma}
Let $R$ be a noetherian local ring.
Let $\mathfrak q \subset R$ be a prime with $\dim(R/\mathfrak q) = 1$.
Let $\varphi : M \to N$ be a homomorphism of finite $R$-modules.
Assume there exist $x_1, \ldots, x_l \in M$ and $y_1, \ldots, y_l \in M$
with the following properties
\begin{enumerate}
\item $M = \langle x_1, \ldots, x_l\rangle$,
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$,
\item $N = \langle y_1, \ldots, y_l\rangle$, and
\item $\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Then $\varphi$ is injective if and only if $\varphi_{\mathfrak q}$ is an
isomorphism, and in this case we have
$$
\text{length}_R(\text{Coker}(\varphi)) = \text{ord}_{R/\mathfrak q}(f)
$$
where $f \in \kappa(\mathfrak q)$ is the element such that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l]
$$
in $\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$.
\end{lemma}

\begin{proof}
First, note that the lemma holds in case $l = 1$.
Namely, in this case $x_1$ is a basis of $M$ over $R/\mathfrak q$
and $y_1$ is a basis of $N$ over $R/\mathfrak q$ and we have
$\varphi(x_1) = fy_1$ for some $f \in R$. Thus $\varphi$ is injective
if and only if $f \not \in \mathfrak q$. Moreover,
$\text{Coker}(\varphi) = R/(f, \mathfrak q)$ and hence the lemma
holds by definition of $\text{ord}_{R/q}(f)$
(see Algebra, Definition \ref{algebra-definition-ord}).

\medskip\noindent
In fact, suppose more generally that $\varphi(x_i) = f_iy_i$ for some
$f_i \in R$, $f_i \not \in \mathfrak q$. Then the induced maps
$$
\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\longrightarrow
\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
$$
are all injective and have cokernels isomorphic to
$R/(f_i, \mathfrak q)$. Hence we see that
$$
\text{length}_R(\text{Coker}(\varphi)) = \sum \text{ord}_{R/\mathfrak q}(f_i).
$$
On the other hand it is clear that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f_1 \ldots f_l [y_1, \ldots, y_l]
$$
in this case from the admissible relation (b) for symbols.
Hence we see the result holds in this case also.

\medskip\noindent
We prove the general case by induction on $l$. Assume $l > 1$.
Let $i \in \{1, \ldots, l\}$ be minimal such that
$\varphi(x_1) \in \langle y_1, \ldots, y_i\rangle$.
We will argue by induction on $i$.
If $i = 1$, then we get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\langle x_1 \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle / \langle x_1 \rangle \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\langle y_1 \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle / \langle y_1 \rangle \ar[r] &
0
}
$$
and the lemma follows from the snake lemma and induction on $l$.
Assume now that $i > 1$.
Write $\varphi(x_1) = a_1 y_1 + \ldots + a_{i - 1} y_{i - 1} + a y_i$
with $a_j, a \in R$ and $a \not \in \mathfrak q$ (since otherwise
$i$ was not minimal). Set
$$
x'_j =
\left\{
\begin{matrix}
x_j & \text{if} & j = 1 \\
ax_j & \text{if} & j \geq 2
\end{matrix}
\right.
\quad\text{and}\quad
y'_j =
\left\{
\begin{matrix}
y_j & \text{if} & j < i \\
ay_j & \text{if} & j \geq i
\end{matrix}
\right.
$$
Let $M' = \langle x'_1, \ldots, x'_l \rangle$ and
$N' = \langle y'_1, \ldots, y'_l \rangle$.
Since $\varphi(x'_1) = a_1 y'_1 + \ldots + a_{i - 1} y'_{i - 1} + y'_i$
by construction and since for $j > 1$ we have
$\varphi(x'_j) = a\varphi(x_i) \in \langle y'_1, \ldots, y'_l\rangle$
we get a commutative diagram of $R$-modules and maps
$$
\xymatrix{
M' \ar[d] \ar[r]_{\varphi'} & N' \ar[d] \\
M \ar[r]^\varphi & N
}
$$
By the result of the second paragraph of the proof we know
that $\text{length}_R(M/M') = (l - 1)\text{ord}_{R/\mathfrak q}(a)$
and similarly
$\text{length}_R(M/M') = (l - i + 1)\text{ord}_{R/\mathfrak q}(a)$.
By a diagram chase this implies that
$$
\text{length}_R(\text{Coker}(\varphi')) =
\text{length}_R(\text{Coker}(\varphi)) + i\;\text{ord}_{R/\mathfrak q}(a).
$$
On the other hand, it is clear that writing
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l],
\quad
[\varphi'(x'_1), \ldots, \varphi(x'_l)] = f' [y'_1, \ldots, y'_l]
$$
we have $f' = a^if$. Hence it suffices to prove the lemma for the
case that $\varphi(x_1) = a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i$,
i.e., in the case that $a = 1$. Next, recall that
$$
[y_1, \ldots, y_l] = [y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l]
$$
by the admissible relations for symbols. The sequence
$y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots + a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l$
satisfies the conditions (3), (4) of the lemma also.
Hence, we may actually
assume that $\varphi(x_1) = y_i$. In this case, note that we have
$\mathfrak q x_1 = 0$ which implies also $\mathfrak q y_i = 0$.
We have
$$
[y_1, \ldots, y_l] =
- [y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l]
$$
by the third of the admissible relations defining
$\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$. Hence we may
replace $y_1, \ldots, y_l$ by
the sequence
$y'_1, \ldots, y'_l =
y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l$
(which also satisfies conditions (3) and (4) of the lemma).
Clearly this decreases the invariant $i$ by $1$ and we win by induction
on $i$.
\end{proof}

\noindent
To use the previous lemma we show that often sequences of elements
with the required properties exist.

\begin{lemma}
\label{lemma-good-sequence-exists}
Let $R$ be a local Noetherian ring.
Let $\mathfrak q \subset R$ be a prime ideal.
Let $M$ be a finite $R$-module such that
$\mathfrak q$ is one of the minimal primes of the support of $M$.
Then there exist $x_1, \ldots, x_l \in M$ such that
\begin{enumerate}
\item the support of $M / \langle x_1, \ldots, x_l\rangle$ does not contain
$\mathfrak q$, and
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Moreover, in this case $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$.
\end{lemma}

\begin{proof}
The condition that $\mathfrak q$ is a minimal prime in the support
of $M$ implies that $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$
is finite (see Algebra, Lemma \ref{algebra-lemma-support-point}).
Hence we can find $y_1, \ldots, y_l \in M_{\mathfrak q}$
such that
$\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
We can find $f_i \in R$, $f_i \not \in \mathfrak q$ such that
$f_i y_i$ is the image of some element $z_i \in M$.
Moreover, as $R$ is Noetherian we can write
$\mathfrak q = (g_1, \ldots, g_t)$ for some $g_j \in R$.
By assumption $g_j y_i \in \langle y_1, \ldots, y_{i - 1} \rangle$
inside the module $M_{\mathfrak q}$.
By our choice of $z_i$ we can find some further elements
$f_{ji} \in R$, $f_{ij} \not \in \mathfrak q$ such that
$f_{ij} g_j z_i \in \langle z_1, \ldots, z_{i - 1} \rangle$
(equality in the module $M$).
The lemma follows by taking
$$
x_1 = f_{11}f_{12}\ldots f_{1t}z_1,
\quad
x_2 = f_{11}f_{12}\ldots f_{1t}f_{21}f_{22}\ldots f_{2t}z_2,
$$
and so on. Namely, since all the elements $f_i, f_{ij}$ are invertible
in $R_{\mathfrak q}$ we still have that
$R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_i /
R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_{i - 1}
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
By construction, $\mathfrak q x_i \in \langle x_1, \ldots, x_{i - 1}\rangle$.
Thus $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle$
is an $R$-module generated by one element, annihilated $\mathfrak q$
such that localizing at $\mathfrak q$ gives a $q$-dimensional
vector space over $\kappa(\mathfrak q)$.
Hence it is isomorphic to $R/\mathfrak q$.
\end{proof}

\noindent
Here is the main result of this section.
We will see below the various different
consequences of this proposition.
The reader is encouraged to first prove the easier
Lemma \ref{lemma-application-herbrand-quotient} his/herself.

\begin{proposition}
\label{proposition-length-determinant-periodic-complex}
Let $R$ be a local Noetherian ring with residue field $\kappa$.
Suppose that $(M, \varphi, \psi)$ is a $(2, 1)$-periodic
complex over $R$. Assume
\begin{enumerate}
\item $M$ is a finite $R$-module,
\item the cohomology modules of $(M, \varphi, \psi)$ are of finite length, and
\item $\dim(\text{Supp}(M)) = 1$.
\end{enumerate}
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the minimal
primes of the support of $M$. Then we have\footnote{
Obviously we could get rid of the minus sign by redefining
$\det_\kappa(M, \varphi, \psi)$ as the inverse of its
current value, see Definition \ref{definition-periodic-determinant}.}
$$
- e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{\mathfrak q_i}, \varphi_{\mathfrak q_i}, \psi_{\mathfrak q_i})
\right)
$$
\end{proposition}

\begin{proof}
We first reduce to the case $t = 1$ in the following way.
Note that
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$,
where $\mathfrak m \subset R$ is the maximal ideal.
Let $M_i$ denote the image of $M \to M_{\mathfrak q_i}$,
so $\text{Supp}(M_i) = \{\mathfrak m, \mathfrak q_i\}$.
The map $\varphi$ (resp.\ $\psi$) induces an $R$-module map
$\varphi_i : M_i \to M_i$ (resp.\ $\psi_i : M_i \to M_i$).
Thus we get a morphism of $(2, 1)$-periodic complexes
$$
(M, \varphi, \psi) \longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, t} (M_i, \varphi_i, \psi_i).
$$
The kernel and cokernel of this map have support equal to
$\{\mathfrak m\}$ (or are zero). Hence by Lemma \ref{lemma-periodic-length}
these $(2, 1)$-periodic complexes have multiplicity $0$.
In other words we have
$$
e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
e_R(M_i, \varphi_i, \psi_i)
$$
On the other hand we clearly have $M_{\mathfrak q_i} = M_{i, \mathfrak q_i}$,
and hence the terms of the right hand side of the formula of the
lemma are equal to the expressions
$$
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{i, \mathfrak q_i}, \varphi_{i, \mathfrak q_i}, \psi_{i, \mathfrak q_i})
\right)
$$
In other words, if we can prove the lemma for each of the modules
$M_i$, then the lemma holds. This reduces us to the case $t = 1$.

\medskip\noindent
Assume we have a $(2, 1)$-periodic complex $(M, \varphi, \psi)$
over a Noetherian local ring with $M$ a finite $R$-module,
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$, and
finite length cohomology modules. The proof in this case
follows from Lemma \ref{lemma-key-lemma} and careful bookkeeping.
Denote
$K_\varphi = \text{Ker}(\varphi)$,
$I_\varphi = \text{Im}(\varphi)$,
$K_\psi = \text{Ker}(\psi)$, and
$I_\psi = \text{Im}(\psi)$.
Since $R$ is Noetherian these are all finite $R$-modules.
Set
$$
a = \text{length}_{R_{\mathfrak q}}(I_{\varphi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\psi, \mathfrak q}),
\quad
b = \text{length}_{R_{\mathfrak q}}(I_{\psi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\varphi, \mathfrak q}).
$$
Equalities because the complex becomes exact after localizing at
$\mathfrak q$. Note that $l = \text{length}_{R_{\mathfrak q}}(M_{\mathfrak q})$
is equal to $l = a + b$.

\medskip\noindent
We are going to use Lemma \ref{lemma-good-sequence-exists}
to choose sequences of elements in finite $R$-modules
$N$ with support contained in $\{\mathfrak m, \mathfrak q\}$.
In this case $N_{\mathfrak q}$ has finite length, say $n \in \mathbf{N}$.
Let us call a sequence $w_1, \ldots, w_n \in N$
with properties (1) and (2) of Lemma \ref{lemma-good-sequence-exists}
a ``good sequence''. Note that the quotient
$N/\langle w_1, \ldots, w_n \rangle$ of $N$ by the submodule generated by
a good sequence has support (contained in) $\{\mathfrak m\}$
and hence has finite length (Algebra, Lemma \ref{algebra-lemma-support-point}).
Moreover, the symbol
$[w_1, \ldots, w_n] \in \det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$
is a generator, see Lemma \ref{lemma-determinant-dimension-one}.

\medskip\noindent
Having said this we choose good sequences
$$
\begin{matrix}
x_1, \ldots, x_b & \text{in} & K_\varphi, &
t_1, \ldots, t_a & \text{in} & K_\psi, \\
y_1, \ldots, y_a & \text{in} & I_\varphi \cap \langle t_1, \ldots t_a\rangle, &
s_1, \ldots, s_b & \text{in} & I_\psi \cap \langle x_1, \ldots, x_b\rangle.
\end{matrix}
$$
We will adjust our choices a little bit as follows.
Choose lifts $\tilde y_i \in M$ of $y_i \in I_\varphi$
and $\tilde s_i \in M$ of $s_i \in I_\psi$. It may not be the case
that $\mathfrak q \tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and it may not be the case that
$\mathfrak q \tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
However, using that $\mathfrak q$ is finitely generated (as in the proof
of Lemma \ref{lemma-good-sequence-exists}) we can find a
$d \in R$, $d \not \in \mathfrak q$ such that
$\mathfrak q d\tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and
$\mathfrak q d\tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
Thus after replacing $y_i$ by $dy_i$,
$\tilde y_i$ by $d\tilde y_i$, $s_i$ by $ds_i$ and $\tilde s_i$
by $d\tilde s_i$ we see that we may assume also that
$x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_b$
and $t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b$
are good sequences in $M$.

\medskip\noindent
Finally, we choose a good sequence
$z_1, \ldots, z_l$ in the finite $R$-module
$$
\langle
x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a
\rangle
\cap
\langle
t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b
\rangle.
$$
Note that this is also a good sequence in $M$.

\medskip\noindent
Since $I_{\varphi, \mathfrak q} = K_{\psi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[y_1, \ldots, y_a] = h [t_1, \ldots, t_a]$
inside $\det_{\kappa(\mathfrak q)}(K_{\psi, \mathfrak q})$.
Similarly, as $I_{\psi, \mathfrak q} = K_{\varphi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[s_1, \ldots, s_b] = g [x_1, \ldots, x_b]$
inside $\det_{\kappa(\mathfrak q)}(K_{\varphi, \mathfrak q})$.
We can also do this with the three good sequences we have
in $M$. All in all we get the following identities
\begin{align*}
[y_1, \ldots, y_a]
& =
h [t_1, \ldots, t_a] \\
[s_1, \ldots, s_b]
& =
g [x_1, \ldots, x_b] \\
[z_1, \ldots, z_l]
& =
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
[z_1, \ldots, z_l]
& =
f_\psi [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b]
\end{align*}
for some $g, h, f_\varphi, f_\psi \in \kappa(\mathfrak q)$.

\medskip\noindent
Having set up all this
notation let us compute $\det_{\kappa(\mathfrak q)}(M, \varphi, \psi)$.
Namely, consider the element $[z_1, \ldots, z_l]$.
Under the map $\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$
of Definition \ref{definition-periodic-determinant} we have
\begin{eqnarray*}
[z_1, \ldots, z_l] & = &
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
& \mapsto & f_\varphi [x_1, \ldots, x_b] \otimes [y_1, \ldots, y_a] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a] \otimes [s_1, \ldots, s_b] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b] \\
& = &
f_\varphi h/f_\psi g [z_1, \ldots, z_l]
\end{eqnarray*}
This means that
$\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
is equal to $f_\varphi h/f_\psi g$ up to a sign.

\medskip\noindent
We abbreviate the following quantities
\begin{eqnarray*}
k_\varphi & = & \text{length}_R(K_\varphi/\langle x_1, \ldots, x_b\rangle) \\
k_\psi    & = & \text{length}_R(K_\psi/\langle t_1, \ldots, t_a\rangle) \\
i_\varphi & = & \text{length}_R(I_\varphi/\langle y_1, \ldots, y_a\rangle) \\
i_\psi    & = & \text{length}_R(I_\psi/\langle s_1, \ldots, s_a\rangle) \\
m_\varphi & = & \text{length}_R(M/
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle) \\
m_\psi    & = & \text{length}_R(M/
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle) \\
\delta_\varphi & = & \text{length}_R(
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle
\langle z_1, \ldots, z_l\rangle) \\
\delta_\psi & = & \text{length}_R(
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle
\langle z_1, \ldots, z_l\rangle)
\end{eqnarray*}
Using the exact sequences $0 \to K_\varphi \to M \to I_\varphi \to 0$
we get $m_\varphi = k_\varphi + i_\varphi$. Similarly we have
$m_\psi = k_\psi + i_\psi$. We have
$\delta_\varphi + m_\varphi = \delta_\psi + m_\psi$ since this
is equal to the colength of $\langle z_1, \ldots, z_l \rangle$
in $M$. Finally, we have
$$
\delta_\varphi = \text{ord}_{R/\mathfrak q}(f_\varphi),
\quad
\delta_\psi = \text{ord}_{R/\mathfrak q}(f_\psi)
$$
by our first application of the key Lemma \ref{lemma-key-lemma}.

\medskip\noindent
Next, let us compute the multiplicity of the periodic complex
\begin{eqnarray*}
e_R(M, \varphi, \psi) & = &
\text{length}_R(K_\varphi/I_\psi) - \text{length}_R(K_\psi/I_\varphi) \\
& = &
\text{length}_R(
\langle x_1, \ldots, x_b\rangle/
\langle s_1, \ldots, s_b\rangle)
+ k_\varphi - i_\psi \\
& & -
\text{length}_R(
\langle t_1, \ldots, t_a\rangle/
\langle y_1, \ldots, y_a\rangle)
- k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + k_\varphi - i_\psi - k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + m_\varphi - m_\psi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + \delta_\psi - \delta_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(f_\psi g/f_\varphi h)
\end{eqnarray*}
where we used the key Lemma \ref{lemma-key-lemma} twice in the third equality.
By our computation of $\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
this proves the proposition.
\end{proof}

\noindent
In most applications the following lemma suffices.

\begin{lemma}
\label{lemma-application-herbrand-quotient}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module, and let $\psi : M \to M$ be an
$R$-module map. Assume that
\begin{enumerate}
\item $\text{Ker}(\psi)$ and $\text{Coker}(\psi)$ have finite length, and
\item $\dim(\text{Supp}(M)) \leq 1$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$
and denote $f_i \in \kappa(\mathfrak q_i)^*$ the element such that
$\det_{\kappa(\mathfrak q_i)}(\psi_{\mathfrak q_i}) :
\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})
\to \det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})$
is multiplication by $f_i$. Then
we have
$$
\text{length}_R(\text{Coker}(\psi))
-
\text{length}_R(\text{Ker}(\psi))
=
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(f_i).
$$
\end{lemma}

\begin{proof}
Recall that $H^0(M, 0, \psi) = \text{Coker}(\psi)$ and
$H^1(M, 0, \psi) = \text{Ker}(\psi)$, see remarks above
Definition \ref{definition-periodic-length}.
The lemma follows by combining
Proposition \ref{proposition-length-determinant-periodic-complex} with
Lemma \ref{lemma-periodic-determinant-easy-case}.

\medskip\noindent
Alternative proof. Reduce to the case
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$
as in the proof of
Proposition \ref{proposition-length-determinant-periodic-complex}.
Then directly combine
Lemmas \ref{lemma-key-lemma} and
\ref{lemma-good-sequence-exists}
to prove this specific case of
Proposition \ref{proposition-length-determinant-periodic-complex}.
There is much less bookkeeping in this case, and the reader is
encouraged to work this out. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-length-multiplication}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module.
Let $x \in R$.
Assume that
\begin{enumerate}
\item $\dim(\text{Supp}(M)) \leq 1$, and
\item $\dim(M/xM) \leq 0$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$.
Then
$$
\text{length}_R(M_x)
-
\text{length}_R({}_xM)
=
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(x)
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
where $M_x = M/xM$ and ${}_xM = \text{Ker}(x : M \to M)$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-application-herbrand-quotient}.
To see that $f_i = x^{\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i})}$
see Lemma \ref{lemma-times-u-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-additivity-divisors-restricted}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $I \subset R$ be an ideal and let $x \in R$.
Assume $x$ is a nonzerodivisor on $R/I$ and that $\dim(R/I) = 1$.
Then
$$
\text{length}_R(R/(x, I))
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}((R/I)_{\mathfrak q_i})
$$
where $\mathfrak q_1, \ldots, \mathfrak q_n$ are the minimal
primes over $I$. More generally if $M$ is any finite Cohen-Macaulay
module of dimension $1$ over $R$ and $\dim(M/xM) = 0$, then
$$
\text{length}_R(M/xM)
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the
minimal primes of the support of $M$.
\end{lemma}

\begin{proof}
These are special cases of Lemma \ref{lemma-length-multiplication}.
\end{proof}

\begin{lemma}
\label{lemma-no-embedded-points-modules}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module.
Let $a, b \in A$.
Assume
\begin{enumerate}
\item $\dim(A) = 1$,
\item both $a$ and $b$ are nonzerodivisors in $A$,
\item $A$ has no embedded primes,
\item $M$ has no embedded associated primes,
\item $\text{Supp}(M) = \Spec(A)$.
\end{enumerate}
Let $I = \{x \in A \mid x(a/b) \in A\}$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes of $A$. Then $(a/b)IM \subset M$ and
$$
\text{length}_A(M/(a/b)IM)
-
\text{length}_A(M/IM)
=
\sum\nolimits_i
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(a/b)
$$
\end{lemma}

\begin{proof}
Since $M$ has no embedded associated primes, and since
the support of $M$ is $\Spec(A)$ we see that
$\text{Ass}(M) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$.
Hence $a$, $b$ are nonzerodivisors on $M$. Note that
\begin{align*}
& \text{length}_A(M/(a/b)IM) \\
& = \text{length}_A(bM/aIM) \\
& = \text{length}_A(M/aIM)
-
\text{length}_A(M/bM) \\
& = \text{length}_A(M/aM) + \text{length}_A(aM/aIM) - \text{length}_A(M/bM) \\
& = \text{length}_A(M/aM) + \text{length}_A(M/IM) - \text{length}_A(M/bM)
\end{align*}
as the injective map $b : M \to bM$ maps $(a/b)IM$ to $aIM$
and the injective map $a : M \to aM$ maps $IM$ to $aIM$.
Hence the left hand side of the equation of the lemma is
equal to
$$
\text{length}_A(M/aM) - \text{length}_A(M/bM).
$$
Applying the second formula of
Lemma \ref{lemma-additivity-divisors-restricted} with $x = a, b$ respectively
and using Algebra, Definition \ref{algebra-definition-ord}
of the $\text{ord}$-functions we get the result.
\end{proof}











\section{Application to tame symbol}
\label{section-application-tame-symbol}

\noindent
In this section we apply the results above to show
the following lemma.

\begin{lemma}
\label{lemma-secondary-ramification}
Let $A$ be a $2$-dimensional Noetherian local domain.
Let $K = f.f.(A)$. Let $f, g \in K^*$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the height
$1$ primes $\mathfrak q$ of $A$ such that either $f$ or $g$ is not an
element of $A^*_{\mathfrak q}$.
Then we have
$$
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{A/\mathfrak q_i}(d_{A_{\mathfrak q_i}}(f, g))
=
0
$$
We can also write this as
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(d_{A_{\mathfrak q}}(f, g))
=
0
$$
since at any height one prime $\mathfrak q$
of $A$ where $f, g \in A^*_{\mathfrak q}$
we have $d_{A_{\mathfrak q}}(f, g) = 1$ by
Lemma \ref{lemma-symbol-when-one-is-a-unit}.
\end{lemma}

\begin{proof}
Since the tame symbols $d_{A_{\mathfrak q}}(f, g)$ are additive
(Lemma \ref{lemma-multiplicativity-symbol}) and the order
functions $\text{ord}_{A/\mathfrak q}$
are additive (Algebra, Lemma \ref{algebra-lemma-ord-additive})
it suffices to prove the formula when $f = a \in A$ and
$g = b \in A$. In this case we see that we have to show
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(\det\nolimits_\kappa(A_{\mathfrak q}/(ab), a, b))
= 0
$$
By Proposition \ref{proposition-length-determinant-periodic-complex}
this is equivalent to showing that
$$
e_A(A/(ab), a, b) = 0.
$$
Since the complex
$A/(ab) \xrightarrow{a} A/(ab) \xrightarrow{b} A/(ab) \xrightarrow{a} A/(ab)$
is exact we win.
\end{proof}






















\section{Setup}
\label{section-setup}

\noindent
We will throughout work over a locally Noetherian universally
catenary base $S$ endowed with a dimension function $\delta$.
Although it is likely possible to generalize (parts of) the
discussion in the chapter, it seems that this is a good first
approximation. We usually do not assume our schemes are
separated or quasi-compact. Many interesting algebraic stacks
are non-separated and/or non-quasi-compact and this is a good
case study to see how to develop a reasonable theory for those as well.
In order to reference these hypotheses we give it a number.

\begin{situation}
\label{situation-setup}
Here $S$ is a locally Noetherian, and universally catenary scheme.
Moreover, we assume $S$ is endowed with a dimension function
$\delta : S \longrightarrow \mathbf{Z}$.
\end{situation}

\noindent
See Morphisms, Definition \ref{morphisms-definition-universally-catenary}
for the notion of a universally catenary scheme, and see
Topology, Definition \ref{topology-definition-dimension-function}
for the notion of a dimension function. Recall that any locally
Noetherian catenary scheme locally has a dimension function, see
Properties, Lemma \ref{properties-lemma-catenary-dimension-function}.
Moreover, there are lots of schemes which are universally catenary,
see Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Any scheme $X$ locally of finite type over $S$ is locally Noetherian
and catenary. In fact, $X$ has a canonical dimension function
$$
\delta = \delta_{X/S} : X \longrightarrow \mathbf{Z}
$$
associated to $(f : X \to S, \delta)$ given by the rule
$\delta_{X/S}(x) = \delta(f(x)) + \text{trdeg}_{\kappa(f(x))}\kappa(x)$.
See Morphisms, Lemma \ref{morphisms-lemma-dimension-function-propagates}.
Moreover, if $h : X \to Y$ is a morphism of schemes locally of finite
type over $S$, and $x \in X$, $y = h(x)$,
then obviously
$\delta_{X/S}(x) = \delta_{Y/S}(y) + \text{trdeg}_{\kappa(y)}\kappa(x)$.
We will freely use this function and its properties in the following.

\medskip\noindent
Here are the basic examples of setups as above.
In fact, the main interest lies in the case where the base
is the spectrum of a field, or the case where the base
is the spectrum of a Dedekind ring (e.g.\ $\mathbf{Z}$,
or a discrete valuation ring).

\begin{example}
\label{example-field}
Here $S = \Spec(k)$ and $k$ is a field.
We set $\delta(pt) = 0$ where $pt$ indicates the unique point of $S$.
The pair $(S, \delta)$ is an example of a situation as in
Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\begin{example}
\label{example-domain-dimension-1}
Here $S = \Spec(A)$, where $A$ is a Noetherian domain
of dimension $1$.
For example we could consider $A = \mathbf{Z}$.
We set $\delta(\mathfrak p) = 0$ if
$\mathfrak p$ is a maximal ideal and $\delta(\mathfrak p) = 1$
if $\mathfrak p = (0)$ corresponds to the generic point.
This is an example of Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\noindent
In good cases $\delta$ corresponds to the dimension function.

\begin{lemma}
\label{lemma-delta-is-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Assume in addition $S$ is a Jacobson scheme, and $\delta(s) = 0$ for every
closed point $s$ of $S$. Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be an integral closed subscheme and let
$\xi \in Z$ be its generic point. The following integers are the same:
\begin{enumerate}
\item $\delta_{X/S}(\xi)$,
\item $\dim(Z)$, and
\item $\dim(\mathcal{O}_{Z, z})$ where $z$ is a closed point of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X \to S$, $\xi \in Z \subset X$ be as in the lemma.
Since $X$ is locally of finite type over $S$ we see that
$X$ is Jacobson, see
Morphisms, Lemma \ref{morphisms-lemma-Jacobson-universally-Jacobson}.
Hence closed points of $X$ are dense in every closed subset of $Z$
and map to closed points of $S$. Hence given any chain
of irreducible closed subsets of $Z$ we can end it with a closed point of $Z$.
It follows that $\dim(Z) = \text{sup}_z(\dim(\mathcal{O}_{Z, z})$
(see Properties, Lemma \ref{properties-lemma-codimension-local-ring})
where $z \in Z$ runs over the closed points of $Z$.
Note that $\dim(\mathcal{O}_{Z, z}) = \delta(\xi) - \delta(z))$
by the properties of a dimension function.
For each closed $z \in Z$ the field extension
$\kappa(z) \supset \kappa(f(z))$ is finite, see Morphisms,
Lemma \ref{morphisms-lemma-jacobson-finite-type-points}.
Hence $\delta_{X/S}(z) = \delta(f(z)) = 0$ for $z \in Z$ closed.
It follows that all three integers are equal.
\end{proof}

\noindent
In the situation of the lemma above the
value of $\delta$ at the generic point of a closed irreducible subset
is the dimension of the irreducible closed subset.
However, in general we cannot expect the equality to hold.
For example if $S = \Spec(\mathbf{C}[[t]])$ and
$X = \Spec(\mathbf{C}((t)))$ then we would get
$\delta(x) = 1$ for the unique point of $X$, but $\dim(X) = 0$.
Still we want to think of $\delta_{X/S}$ as giving the
dimension of the irreducible closed subschemes. Thus we introduce
the following terminology.

\begin{definition}
\label{definition-delta-dimension}
Let $(S, \delta)$ as in Situation \ref{situation-setup}.
For any scheme $X$ locally of finite type over $S$
and any irreducible closed subset $Z \subset X$ we define
$$
\dim_\delta(Z) = \delta(\xi)
$$
where $\xi \in Z$ is the generic point of $Z$.
We will call this the {\it $\delta$-dimension of $Z$}.
If $Z$ is a closed subscheme of $X$, then we define
$\dim_\delta(Z)$ as the supremum of the $\delta$-dimensions
of its irreducible components.
\end{definition}







\section{Cycles}
\label{section-cycles}

\noindent
Since we are not assuming our schemes are quasi-compact we have
to be a little careful when defining cycles. We have to allow
infinite sums because a rational function may have infinitely many
poles for example. In any case, if $X$ is quasi-compact then a
cycle is a finite sum as usual.

\begin{definition}
\label{definition-cycles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item A collection of closed subschemes $\{Z_i\}_{i \in I}$ of $X$
is said to be {\it locally finite} if for every quasi-compact open
$U \subset X$ the set
$$
\# \{i\in I \mid Z_i \cap U \not = \emptyset\}
$$
is finite.
\item A {\it cycle on $X$} is a formal sum
$$
\alpha = \sum n_Z [Z]
$$
where the sum is over integral closed subschemes $Z \subset X$,
each $n_Z \in \mathbf{Z}$, and the collection
$\{Z; n_Z \not = 0\}$ is locally finite.
\item A {\it $k$-cycle}, on $X$ is
a cycle
$$
\alpha = \sum n_Z [Z]
$$
where $n_Z \not = 0 \Rightarrow \dim_\delta(Z) = k$.
\item The abelian group of all $k$-cycles on $X$ is denoted $Z_k(X)$.
\end{enumerate}
\end{definition}

\noindent
In other words, a $k$-cycle on $X$
is a locally finite formal $\mathbf{Z}$-linear
combination of integral closed subschemes of $\delta$-dimension $k$.
Addition of $k$-cycles $\alpha = \sum n_Z[Z]$ and
$\beta = \sum m_Z[Z]$ is given by
$$
\alpha + \beta = \sum (n_Z + m_Z)[Z],
$$
i.e., by adding the coefficients.




\section{Cycle associated to a closed subscheme}
\label{section-cycle-of-closed-subscheme}

\begin{lemma}
\label{lemma-multiplicity-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item The collection of irreducible components of $Z$
is locally finite.
\item Let $Z' \subset Z$ be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi} < \infty
$$
\item If $\dim_\delta(Z) \leq k$ and $\xi \in Z$ with
$\delta(\xi) = k$, then $\xi$ is a generic point of an
irreducible component of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $U \subset X$ be a quasi-compact open subscheme.
Then $U$ is a Noetherian scheme, and hence has a Noetherian
underlying topological space
(Properties, Lemma \ref{properties-lemma-Noetherian-topology}).
Hence every subspace is Noetherian and
has finitely many irreducible components
(see Topology, Lemma \ref{topology-lemma-Noetherian}).
This proves (1).

\medskip\noindent
Let $Z' \subset Z$, $\xi \in Z'$ be as in (2).
Then $\dim(\mathcal{O}_{Z, \xi}) = 0$ (for example by
Properties, Lemma \ref{properties-lemma-codimension-local-ring}).
Hence $\mathcal{O}_{Z, \xi}$ is Noetherian
local ring of dimension zero, and hence has finite length over
itself (see
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}).
Hence, it also has finite length over $\mathcal{O}_{X, \xi}$, see
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.

\medskip\noindent
Assume $\xi \in Z$ and $\delta(\xi) = k$.
Consider the closure $Z' = \overline{\{\xi\}}$. It is an irreducible
closed subscheme with $\dim_\delta(Z') = k$ by definition.
Since $\dim_\delta(Z) = k$ it must be an irreducible component
of $Z$. Hence we see (3) holds.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-closed-subscheme}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item For any irreducible component $Z' \subset Z$ with generic point $\xi$
the integer
$m_{Z', Z} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi}$
(Lemma \ref{lemma-multiplicity-finite})
is called the {\it multiplicity of $Z'$ in $Z$}.
\item Assume $\dim_\delta(Z) \leq k$.
The {\it $k$-cycle associated to $Z$} is
$$
[Z]_k
=
\sum m_{Z', Z}[Z']
$$
where the sum is over the irreducible components of $Z$
of $\delta$-dimension $k$. (This is a $k$-cycle by
Lemma \ref{lemma-multiplicity-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[Z]_k$ if the $\delta$-dimension
of $Z$ does not exceed $k$. In other words, by convention, if we write
$[Z]_k$ then this implies that $\dim_\delta(Z) \leq k$.



\section{Cycle associated to a coherent sheaf}
\label{section-cycle-of-coherent-sheaf}



\begin{lemma}
\label{lemma-length-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item The collection of irreducible components of the support of
$\mathcal{F}$ is locally finite.
\item Let $Z' \subset \text{Supp}(\mathcal{F})$
be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi < \infty
$$
\item If $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$
and $\xi \in Z$ with $\delta(\xi) = k$, then $\xi$ is a
generic point of an irreducible component of $\text{Supp}(\mathcal{F})$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}
the support $Z$ of $\mathcal{F}$ is a closed subset of $X$.
We may think of $Z$ as a reduced closed subscheme of $X$
(Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
Hence (1) and (3) follow immediately by applying
Lemma \ref{lemma-multiplicity-finite} to $Z \subset X$.

\medskip\noindent
Let $\xi \in Z'$ be as in (2). In this case for any specialization
$\xi' \leadsto \xi$ in $X$ we have $\mathcal{F}_{\xi'} = 0$.
Recall that the non-maximal primes of $\mathcal{O}_{X, \xi}$ correspond
to the points of $X$ specializing to $\xi$
(Schemes, Lemma \ref{schemes-lemma-specialize-points}).
Hence $\mathcal{F}_\xi$ is a finite $\mathcal{O}_{X, \xi}$-module
whose support is $\{\mathfrak m_\xi\}$. Hence it has finite length
by Algebra, Lemma \ref{algebra-lemma-support-point}.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-coherent-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any irreducible component $Z' \subset \text{Supp}(\mathcal{F})$
with generic point $\xi$ the integer
$m_{Z', \mathcal{F}} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi$
(Lemma \ref{lemma-length-finite})
is called the {\it multiplicity of $Z'$ in $\mathcal{F}$}.
\item Assume $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
The {\it $k$-cycle associated to $\mathcal{F}$} is
$$
[\mathcal{F}]_k
=
\sum m_{Z', \mathcal{F}}[Z']
$$
where the sum is over the irreducible components of
$\text{Supp}(\mathcal{F})$ of $\delta$-dimension $k$.
(This is a $k$-cycle by Lemma \ref{lemma-length-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[\mathcal{F}]_k$
if $\mathcal{F}$ is coherent and the $\delta$-dimension
of $\text{Supp}(\mathcal{F})$ does not exceed $k$. In other words,
by convention, if we write $[\mathcal{F}]_k$ then this implies that
$\mathcal{F}$ is coherent on $X$ and
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-cycle-closed-coherent}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
If $\dim_\delta(Z) \leq k$, then $[Z]_k = [{\mathcal O}_Z]_k$.
\end{lemma}

\begin{proof}
This is because in this case the multiplicities $m_{Z', Z}$ and
$m_{Z', \mathcal{O}_Z}$ agree by definition.
\end{proof}

\begin{lemma}
\label{lemma-additivity-sheaf-cycle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0$
be a short exact sequence of coherent sheaves on $X$.
Assume that the $\delta$-dimension of the supports
of $\mathcal{F}$, $\mathcal{G}$, and $\mathcal{H}$ is $\leq k$.
Then $[\mathcal{G}]_k = [\mathcal{F}]_k + [\mathcal{H}]_k$.
\end{lemma}

\begin{proof}
Follows immediately from additivity of lengths, see
Algebra, Lemma \ref{algebra-lemma-length-additive}.
\end{proof}









\section{Preparation for proper pushforward}
\label{section-preparation-pushforward}

\begin{lemma}
\label{lemma-equal-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $X$, $Y$ integral and $\dim_\delta(X) = \dim_\delta(Y)$.
Then either $f(X)$ is contained in a proper closed subscheme
of $Y$, or $f$ is dominant and the extension of function fields
$R(Y) \subset R(X)$ is finite.
\end{lemma}

\begin{proof}
The closure $\overline{f(X)} \subset Y$ is irreducible as $X$
is irreducible (Topology, Lemmas
\ref{topology-lemma-image-irreducible-space} and
\ref{topology-lemma-irreducible}).
If $\overline{f(X)} \not = Y$, then we are done.
If $\overline{f(X)} = Y$, then $f$ is dominant and by
Morphisms,
Lemma \ref{morphisms-lemma-dominant-finite-number-irreducible-components}
we see that the generic point $\eta_Y$ of $Y$ is in the image of $f$.
Of course this implies that $f(\eta_X) = \eta_Y$, where $\eta_X \in X$
is the generic point of $X$. Since $\delta(\eta_X) = \delta(\eta_Y)$
we see that $R(Y) = \kappa(\eta_Y) \subset \kappa(\eta_X) = R(X)$
is an extension of transcendence degree $0$.
Hence $R(Y) \subset R(X)$ is a finite extension by
Morphisms, Lemma \ref{morphisms-lemma-finite-degree}
(which applies by
Morphisms, Lemma \ref{morphisms-lemma-permanence-finite-type}).
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is quasi-compact, and $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $X$.
Then $\{\overline{f(Z_i)}\}_{i \in I}$ is a locally finite
collection of closed subsets of $Y$.
\end{lemma}

\begin{proof}
Let $V \subset Y$ be a quasi-compact open subset.
Since $f$ is quasi-compact the open $f^{-1}(V)$ is
quasi-compact. Hence the set
$\{i \in I \mid Z_i \cap f^{-1}(V) \not = \emptyset \}$
is finite by assumption (Definition \ref{definition-cycles}).
Since this is the same as the set
$$
\{i \in I \mid f(Z_i) \cap V \not = \emptyset \} =
\{i \in I \mid \overline{f(Z_i)} \cap V \not = \emptyset \}
$$
the lemma is proved.
\end{proof}









\section{Proper pushforward}
\label{section-proper-pushforward}

\begin{definition}
\label{definition-proper-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is proper.
\begin{enumerate}
\item Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = k$. We define
$$
f_*[Z] =
\left\{
\begin{matrix}
0 & \text{if} & \dim_\delta(f(Z))< k, \\
\deg(Z/f(Z)) [f(Z)] & \text{if} & \dim_\delta(f(Z)) = k.
\end{matrix}
\right.
$$
Here we think of $f(Z) \subset Y$ as an integral closed subscheme.
The degree of $Z$ over $f(Z)$ is finite if
$\dim_\delta(f(Z)) = \dim_\delta(Z)$
by Lemma \ref{lemma-equal-dimension}.
\item Let $\alpha = \sum n_Z [Z]$ be a $k$-cycle on $X$. The
{\it pushforward} of $\alpha$ as the sum
$$
f_* \alpha = \sum n_Z f_*[Z]
$$
where each $f_*[Z]$ is defined as above. The sum is locally finite
by Lemma \ref{lemma-quasi-compact-locally-finite} above.
\end{enumerate}
\end{definition}

\noindent
By definition the proper pushforward of cycles
$$
f_* : Z_k(X) \longrightarrow Z_k(Y)
$$
is a homomorphism of abelian groups. It turns $X \mapsto Z_k(X)$
into a covariant functor on the category of schemes locally of
finite type over $S$ with morphisms equal to proper morphisms.

\begin{lemma}
\label{lemma-compose-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$, and $Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be proper morphisms.
Then $g_* \circ f_* = (g \circ f)_*$ as maps $Z_k(X) \to Z_k(Z)$.
\end{lemma}

\begin{proof}
Let $W \subset X$ be an integral closed subscheme of dimension $k$.
Consider $W' = f(Z) \subset Y$ and $W'' = g(f(Z)) \subset Z$.
Since $f$, $g$ are proper we see that $W'$ (resp.\ $W''$) is
an integral closed subscheme of $Y$ (resp.\ $Z$).
We have to show that $g_*(f_*[W]) = (f \circ g)_*[W]$.
If $\dim_\delta(W'') < k$, then both sides are zero.
If $\dim_\delta(W'') = k$, then we see the induced morphisms
$$
W \longrightarrow
W' \longrightarrow
W''
$$
both satisfy the hypotheses of Lemma \ref{lemma-equal-dimension}. Hence
$$
g_*(f_*[W]) = \deg(W/W')\deg(W'/W'')[W''],
\quad
(f \circ g)_*[W] = \deg(W/W'')[W''].
$$
Then we can apply
Morphisms, Lemma \ref{morphisms-lemma-degree-composition}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-cycle-push-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is proper.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme with $\dim_\delta(Z) \leq k$.
Then
$$
f_*[Z]_k = [f_*{\mathcal O}_Z]_k.
$$
\item Let $\mathcal{F}$ be a coherent sheaf on $X$ such that
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$. Then
$$
f_*[\mathcal{F}]_k = [f_*{\mathcal F}]_k.
$$
\end{enumerate}
Note that the statement makes sense since $f_*\mathcal{F}$ and
$f_*\mathcal{O}_Z$ are coherent $\mathcal{O}_Y$-modules by
Cohomology of Schemes, Lemma \ref{coherent-lemma-proper-pushforward-coherent}.
\end{lemma}

\begin{proof}
Part (1) follows from (2) and Lemma \ref{lemma-cycle-closed-coherent}.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Assume that $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}
there exists a closed subscheme $i : Z \to X$ and a coherent
$\mathcal{O}_Z$-module $\mathcal{G}$ such that
$i_*\mathcal{G} \cong \mathcal{F}$ and such that the support
of $\mathcal{F}$ is $Z$. Let $Z' \subset Y$ be the scheme theoretic image
of $f|_Z : Z \to Y$.Consider the commutative diagram of schemes
$$
\xymatrix{
Z \ar[r]_i \ar[d]_{f|_Z} &
X \ar[d]^f \\
Z' \ar[r]^{i'} & Y
}
$$
We have $f_*\mathcal{F} = f_*i_*\mathcal{G} = i'_*(f|_Z)_*\mathcal{G}$
by going around the diagram in two ways. Suppose we know the result holds
for closed immersions and for $f|_Z$. Then we see that
$$
f_*[\mathcal{F}]_k = f_*i_*[\mathcal{G}]_k
= (i')_*(f|_Z)_*[\mathcal{G}]_k =
(i')_*[(f|_Z)_*\mathcal{G}]_k =
[(i')_*(f|_Z)_*\mathcal{G}]_k = [f_*\mathcal{F}]_k
$$
as desired. The case of a closed immersion is straightforward (omitted).
Note that $f|_Z : Z \to Z'$ is a dominant morphism (see
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-scheme-theoretic-image}).
Thus we have reduced to the case where
$\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.

\medskip\noindent
Assume $\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.
Since $f$ is dominant, for every irreducible component $Z \subset Y$
with generic point $\eta$ there exists a point $\xi \in X$ such
that $f(\xi) = \eta$. Hence $\delta(\eta) \leq \delta(\xi) \leq k$.
Thus we see that in the expressions
$$
f_*[\mathcal{F}]_k = \sum n_Z[Z],
\quad
\text{and}
\quad
[f_*\mathcal{F}]_k = \sum m_Z[Z].
$$
whenever $n_Z \not = 0$, or $m_Z \not = 0$ the integral closed
subscheme $Z$ is actually an irreducible component of $Y$ of
$\delta$-dimension $k$. Pick such an integral closed subscheme
$Z \subset Y$ and denote $\eta$ its generic point. Note that for
any $\xi \in X$ with $f(\xi) = \eta$ we have $\delta(\xi) \geq k$
and hence $\xi$ is a generic point of an irreducible component
of $X$ of $\delta$-dimension $k$ as well
(see Lemma \ref{lemma-multiplicity-finite}). Since $f$ is quasi-compact
and $X$ is locally Noetherian, there can be only finitely many of
these and hence $f^{-1}(\{\eta\})$ is finite.
By Morphisms, Lemma \ref{morphisms-lemma-generically-finite} there exists
an open neighbourhood $\eta \in V \subset Y$ such that $f^{-1}(V) \to V$
is finite. Replacing $Y$ by $V$ and $X$ by $f^{-1}(V)$ we reduce to the
case where $Y$ is affine, and $f$ is finite.

\medskip\noindent
Write $Y = \Spec(R)$ and $X = \Spec(A)$ (possible as
a finite morphism is affine).
Then $R$ and $A$ are Noetherian rings and $A$ is finite over $R$.
Moreover $\mathcal{F} = \widetilde{M}$ for some finite $A$-module
$M$. Note that $f_*\mathcal{F}$ corresponds to $M$ viewed as an $R$-module.
Let $\mathfrak p \subset R$ be the minimal prime corresponding
to $\eta \in Y$. The coefficient of $Z$ in $[f_*\mathcal{F}]_k$
is clearly $\text{length}_{R_{\mathfrak p}}(M_{\mathfrak p})$.
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the primes of $A$
lying over $\mathfrak p$. Then $A_{\mathfrak p} = \prod A_{\mathfrak q_i}$
since $A_{\mathfrak p}$ is an Artinian ring being finite over the
dimension zero local Noetherian ring $R_{\mathfrak p}$.
Clearly the coefficient of $Z$ in $f_*[\mathcal{F}]_k$ is
$$
\sum\nolimits_{i = 1, \ldots, t}
[\kappa(\mathfrak q_i) : \kappa(\mathfrak p)]
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
$$
Hence the desired equality follows from
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
\end{proof}




















\section{Preparation for flat pullback}
\label{section-preparation-flat-pullback}


\noindent
Recall that a morphism $f : X \to Y$ which is locally of finite type
is said to have relative dimension $r$ if every nonempty fibre
is equidimensional of dimension $r$. See
Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}.

\begin{lemma}
\label{lemma-flat-inverse-image-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
For any closed subset $Z \subset Y$ we have
$$
\dim_\delta(f^{-1}(Z)) = \dim_\delta(Z) + r.
$$
If $Z$ is irreducible and $Z' \subset f^{-1}(Z)$ is an irreducible
component, then $Z'$ dominates $Z$ and
$\dim_\delta(Z') = \dim_\delta(Z) + r$.
\end{lemma}

\begin{proof}
It suffices to prove the final statement.
We may replace $Y$ by the integral closed subscheme $Z$ and
$X$ by the scheme theoretic inverse image $f^{-1}(Z) = Z \times_Y X$.
Hence we may assume $Z = Y$ is integral and $f$ is a flat morphism
of relative dimension $r$. Since $Y$ is locally Noetherian the
morphism $f$ which is locally of finite type,
is actually locally of finite presentation. Hence
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}
applies and we see that $f$ is open.
Let $\xi \in X$ be a generic point of an irreducible component
of $X$. By the openness of $f$ we see that $f(\xi)$ is the
generic point $\eta$ of $Z = Y$. Note that $\dim_\xi(X_\eta) = r$
by assumption that $f$ has relative dimension $r$. On the other
hand, since $\xi$ is a generic point of $X$ we see that
$\mathcal{O}_{X, \xi} = \mathcal{O}_{X_\eta, \xi}$ has only one
prime ideal and hence has dimension $0$. Thus by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
we conclude that the transcendence
degree of $\kappa(\xi)$ over $\kappa(\eta)$ is $r$.
In other words, $\delta(\xi) = \delta(\eta) + r$ as desired.
\end{proof}

\noindent
Here is the lemma that we will use to prove that the flat pullback
of a locally finite collection of closed subschemes is locally finite.

\begin{lemma}
\label{lemma-inverse-image-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $Y$.
Then $\{f^{-1}(Z_i)\}_{i \in I}$ is a locally finite
collection of closed subsets of $Y$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be a quasi-compact open subset.
Since the image $f(U) \subset Y$ is a quasi-compact subset
there exists a quasi-compact open $V \subset Y$ such that
$f(U) \subset V$. Note that
$$
\{i \in I \mid f^{-1}(Z_i) \cap U \not = \emptyset \}
\subset
\{i \in I \mid Z_i \cap V \not = \emptyset \}.
$$
Since the right hand side is finite by assumption we win.
\end{proof}



\section{Flat pullback}
\label{section-flat-pullback}

\noindent
In the following we use $f^{-1}(Z)$ to denote the
{\it scheme theoretic inverse image} of a closed subscheme
$Z \subset Y$ for a morphism of schemes $f : X \to Y$.
We recall that the scheme theoretic inverse image is the fibre product
$$
\xymatrix{
f^{-1}(Z) \ar[r] \ar[d] & X \ar[d] \\
Z \ar[r] & Y
}
$$
and it is also the closed subscheme of $X$ cut out by the
quasi-coherent sheaf of ideals $f^{-1}(\mathcal{I})\mathcal{O}_X$, if
$\mathcal{I} \subset \mathcal{O}_Y$ is the quasi-coherent sheaf of ideals
corresponding to $Z$ in $Y$.
(This is discussed in
Schemes, Section \ref{schemes-section-closed-immersion} and
Lemma \ref{schemes-lemma-fibre-product-immersion}
and Definition \ref{schemes-definition-inverse-image-closed-subscheme}.)

\begin{definition}
\label{definition-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be an integral closed subscheme of
$\delta$-dimension $k$. We define $f^*[Z]$ to be the
$(k+r)$-cycle on $X$ to the scheme theoretic inverse image
$$
f^*[Z] = [f^{-1}(Z)]_{k+r}.
$$
This makes sense since $\dim_\delta(f^{-1}(Z)) = k + r$
by Lemma \ref{lemma-flat-inverse-image-dimension}.
\item Let $\alpha = \sum n_i [Z_i]$ be
a $k$-cycle on $Y$. The {\it flat pullback of $\alpha$ by $f$}
is the sum
$$
f^* \alpha = \sum n_i f^*[Z_i]
$$
where each $f^*[Z_i]$ is defined as above.
The sum is locally finite by Lemma \ref{lemma-inverse-image-locally-finite}.
\item We denote $f^* : Z_k(Y) \to Z_{k + r}(X)$ the map of abelian
groups so obtained.
\end{enumerate}
\end{definition}

\noindent
An open immersion is flat. This is an important though trivial special
case of a flat morphism. If $U \subset X$ is open then sometimes the
pullback by $j : U \to X$ of a cycle is called the {\it restriction} of the
cycle to $U$. Note that in this case the maps
$$
j^* : Z_k(X) \longrightarrow Z_k(U)
$$
are all {\it surjective}. The reason is that given any integral closed
subscheme $Z' \subset U$, we can take the closure of $Z$ of $Z'$ in $X$
and think of it as a reduced closed subscheme of $X$ (see
Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
And clearly $Z \cap U = Z'$, in other words
$j^*[Z] = [Z']$ whence the surjectivity. In fact a little bit more
is true.

\begin{lemma}
\label{lemma-exact-sequence-open}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
For every $k \in \mathbf{Z}$ the sequence
$$
\xymatrix{
Z_k(Y) \ar[r]^{i_*} & Z_k(X) \ar[r]^{j^*} & Z_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
By the description above the basis elements $[Z]$ of the free
abelian group $Z_k(X)$ map either to (distinct) basis elements
$[Z \cap U]$ or to zero if $Z \subset Y$. Hence the lemma is clear.
\end{proof}

\begin{lemma}
\label{lemma-compose-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X, Y, Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be flat morphisms of relative dimensions
$r$ and $s$. Then $g \circ f$ is flat of relative dimension
$r + s$ and
$$
f^* \circ g^* = (g \circ f)^*
$$
as maps $Z_k(Z) \to Z_{k + r + s}(X)$.
\end{lemma}

\begin{proof}
The composition is flat of relative dimension $r + s$ by
Morphisms, Lemma \ref{morphisms-lemma-composition-relative-dimension-d}.
Suppose that
\begin{enumerate}
\item $W \subset Z$ is a closed integral subscheme of $\delta$-dimension $k$,
\item $W' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s$ with $W' \subset g^{-1}(W)$, and
\item $W'' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s + r$ with $W'' \subset f^{-1}(W')$.
\end{enumerate}
We have to show that the coefficient $n$ of $[W'']$ in
$(g \circ f)^*[W]$ agrees with the coefficient $m$ of
$[W'']$ in $f^*(g^*[W])$. That it suffices to check the lemma in these
cases follows from Lemma \ref{lemma-flat-inverse-image-dimension}.
Let $\xi'' \in W''$, $\xi' \in W'$
and $\xi \in W$ be the generic points. Consider the local rings
$A = \mathcal{O}_{Z, \xi}$, $B = \mathcal{O}_{Y, \xi'}$
and $C = \mathcal{O}_{X, \xi''}$. Then we have local flat ring maps
$A \to B$, $B \to C$ and moreover
$$
n = \text{length}_C(C/\mathfrak m_AC),
\quad
\text{and}
\quad
m = \text{length}_C(C/\mathfrak m_BC) \text{length}_B(B/\mathfrak m_AB)
$$
Hence the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-transitive}.
\end{proof}

\begin{lemma}
\label{lemma-pullback-coherent}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be a closed subscheme with
$\dim_\delta(Z) \leq k$. Then we have
$\dim_\delta(f^{-1}(Z)) \leq k + r$
and $[f^{-1}(Z)]_{k + r} = f^*[Z]_k$ in $Z_{k + r}(X)$.
\item Let $\mathcal{F}$ be a coherent sheaf on $Y$ with
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
Then we have $\dim_\delta(\text{Supp}(f^*\mathcal{F})) \leq k + r$
and
$$
f^*[{\mathcal F}]_k = [f^*{\mathcal F}]_{k+r}
$$
in $Z_{k + r}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from part (2) by Lemma \ref{lemma-cycle-closed-coherent}
and the fact that $f^*\mathcal{O}_Z = \mathcal{O}_{f^{-1}(Z)}$.

\medskip\noindent
Proof of (2).
As $X$, $Y$ are locally Noetherian we may apply
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} to see
that $\mathcal{F}$ is of finite type, hence $f^*\mathcal{F}$ is
of finite type (Modules, Lemma \ref{modules-lemma-pullback-finite-type}),
hence $f^*\mathcal{F}$ is coherent
(Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} again).
Thus the lemma makes sense. Let $W \subset Y$ be an integral closed
subscheme of $\delta$-dimension $k$, and let $W' \subset X$ be
an integral closed subscheme of dimension $k + r$ mapping into $W$
under $f$. We have to show that the coefficient $n$ of
$[W]$ in $f^*[{\mathcal F}]_k$ agrees with the coefficient
$m$ of $[W]$ in $[f^*{\mathcal F}]_{k+r}$. Let $\xi \in W$ and
$\xi' \in W'$ be the generic points. Let
$A = \mathcal{O}_{Y, \xi}$, $B = \mathcal{O}_{X, \xi'}$
and set $M = \mathcal{F}_\xi$ as an $A$-module. (Note that
$M$ has finite length by our dimension assumptions, but we
actually do not need to verify this. See
Lemma \ref{lemma-length-finite}.)
We have $f^*\mathcal{F}_{\xi'} = B \otimes_A M$.
Thus we see that
$$
n = \text{length}_B(B \otimes_A M)
\quad
\text{and}
\quad
m = \text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
$$
Thus the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-module}.
\end{proof}



\section{Push and pull}
\label{section-push-pull}

\noindent
In this section we verify that proper pushforward and flat pullback
are compatible when this makes sense. By the work we did above this
is a consequence of cohomology and base change.

\begin{lemma}
\label{lemma-flat-pullback-proper-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
be a fibre product diagram of schemes locally of finite type over $S$.
Assume $f : X \to Y$ proper and $g : Y' \to Y$ flat of relative dimension $r$.
Then also $f'$ is proper and $g'$ is flat of relative dimension $r$.
For any $k$-cycle $\alpha$ on $X$ we have
$$
g^*f_*\alpha = f'_*(g')^*\alpha
$$
in $Z_{k + r}(Y')$.
\end{lemma}

\begin{proof}
The assertion that $f'$ is proper follows from
Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}.
The assertion that $g'$ is flat of relative dimension $r$ follows from
Morphisms, Lemmas \ref{morphisms-lemma-base-change-relative-dimension-d}
and \ref{morphisms-lemma-base-change-flat}.
It suffices to prove the equality of cycles when $\alpha = [W]$
for some integral closed subscheme $W \subset X$ of $\delta$-dimension $k$.
Note that in this case we have $\alpha = [\mathcal{O}_W]_k$, see
Lemma \ref{lemma-cycle-closed-coherent}.
By Lemmas \ref{lemma-cycle-push-sheaf} and
\ref{lemma-pullback-coherent} it therefore suffices
to show that $f'_*(g')^*\mathcal{O}_W$ is isomorphic to
$g^*f_*\mathcal{O}_W$. This follows from cohomology and
base change, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-finite-flat}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a finite locally free morphism
of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Then $f$ is both proper and flat of relative dimension $0$, and
$$
f_*f^*\alpha = d\alpha
$$
for every $\alpha \in Z_k(Y)$.
\end{lemma}

\begin{proof}
A finite locally free morphism is flat and finite by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat},
and a finite morphism is proper
by Morphisms, Lemma \ref{morphisms-lemma-finite-proper}.
We omit showing that a finite
morphism has relative dimension $0$. Thus the formula makes sense.
To prove it, let $Z \subset Y$ be an integral closed subscheme
of $\delta$-dimension $k$. It suffices to prove the formula
for $\alpha = [Z]$. Since the base change of a finite locally free
morphism is finite locally free
(Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-locally-free})
we see that $f_*f^*\mathcal{O}_Z$ is a finite locally free sheaf of
rank $d$ on $Z$. Hence
$$
f_*f^*[Z] = f_*f^*[\mathcal{O}_Z]_k =
[f_*f^*\mathcal{O}_Z]_k = d[Z]
$$
where we have used Lemmas \ref{lemma-pullback-coherent} and
\ref{lemma-cycle-push-sheaf}.
\end{proof}








\section{Preparation for principal divisors}
\label{section-preparation-principal-divisors}

\noindent
Recall that if $Z$ is an irreducible closed subset of a scheme $X$,
then the codimension of $Z$ in $X$ is equal to the dimension
of the local ring $\mathcal{O}_{X, \xi}$, where $\xi \in Z$
is the generic point. See
Properties, Lemma \ref{properties-lemma-codimension-local-ring}.

\begin{definition}
\label{definition-order-vanishing}
Let $X$ be a locally Noetherian scheme. Assume $X$ is integral.
Let $f \in R(X)^*$. For every integral closed subscheme
$Z \subset X$ of codimension $1$ we define
the {\it order of vanishing of $f$ along $Z$} as the integer
$$
\text{ord}_Z(f) = \text{ord}_{\mathcal{O}_{X, \xi}}(f)
$$
where the right hand side is the notion of
Algebra, Definition \ref{algebra-definition-ord}
and $\xi$ is the generic point of $Z$.
\end{definition}

\noindent
Of course it can happen that $\text{ord}_Z(f) < 0$.
In this case we say that $f$ has a {\it pole} along $Z$
and that $-\text{ord}_Z(f) > 0$ is the {\it order of pole of
$f$ along $Z$}. Note that for $f, g \in R(X)^*$ we have
$$
\text{ord}_Z(fg) = \text{ord}_Z(f) + \text{ord}_Z(g).
$$

\begin{lemma}
\label{lemma-divisor-delta-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral. If $Z \subset X$ is an integral closed subscheme
of codimension $1$, then $\dim_\delta(Z) = \dim_\delta(X) - 1$.
\end{lemma}

\begin{proof}
This is more or less the defining property of a dimension function.
\end{proof}

\begin{lemma}
\label{lemma-divisor-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral. Let $f \in R(X)^*$. Then the set
$$
\{Z \subset X \mid Z \text{ is integral, closed of codimension }1
\text{ and }\text{ord}_Z(f) \not = 0\}
$$
is locally finite in $X$.
\end{lemma}

\begin{proof}
This is true simply because there exists a nonempty open subscheme
$U \subset X$ such that $f$ corresponds to a section of
$\Gamma(U, \mathcal{O}_X^*)$, and hence the codimension $1$
irreducibles which can occur in the set of the lemma are all
irreducible components of $X \setminus U$.
Hence Lemma \ref{lemma-multiplicity-finite} gives the desired result.
\end{proof}

\begin{lemma}
\label{lemma-finite-in-codimension-one}
Let $f : X \to Y$ be a morphism of schemes.
Let $\xi \in Y$ be a point.
Assume that
\begin{enumerate}
\item $X$, $Y$ are integral,
\item $X$ is locally Noetherian
\item $f$ is proper, dominant and $R(X) \subset R(Y)$ is finite, and
\item $\dim(\mathcal{O}_{Y, \xi}) = 1$.
\end{enumerate}
Then there exists an open neighbourhood $V \subset Y$ of $\xi$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
By Cohomology of Schemes,
Lemma \ref{coherent-lemma-proper-finite-fibre-finite-in-neighbourhood}
it suffices to prove that $f^{-1}(\{\xi\})$ is finite.
We replace $Y$ by an affine open, say $Y = \Spec(R)$.
Note that $R$ is Noetherian, as $X$ is assumed locally Noetherian.
Since $f$ is proper it is quasi-compact. Hence we can find a finite
affine open covering $X = U_1 \cup \ldots \cup U_n$ with
each $U_i = \Spec(A_i)$. Note that $R \to A_i$ is a
finite type injective homomorphism of domains with
$f.f.(R) \subset f.f.(A_i)$ finite. Thus the lemma follows
from Algebra, Lemma \ref{algebra-lemma-finite-in-codim-1}.
\end{proof}


\section{Principal divisors}
\label{section-principal-divisors}

\noindent
The following definition is the key to everything that follows.

\begin{definition}
\label{definition-principal-divisor}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral with $\dim_\delta(X) = n$.
Let $f \in R(X)^*$. The {\it principal divisor
associated to $f$} is the $(n - 1)$-cycle
$$
\text{div}(f) = \text{div}_X(f) = \sum \text{ord}_Z(f) [Z]
$$
where the sum is over integral closed subschemes of
codimension $1$ and $\text{ord}_Z(f)$ is as in
Definition \ref{definition-order-vanishing}. This makes sense
by Lemmas \ref{lemma-divisor-delta-dimension} and
\ref{lemma-divisor-locally-finite}.
\end{definition}


\begin{lemma}
\label{lemma-div-additive}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral with $\dim_\delta(X) = n$.
Let $f, g \in R(X)^*$.
Then
$$
\text{div}(fg) = \text{div}(f) + \text{div}(g)
$$
in $Z_{n - 1}(X)$.
\end{lemma}

\begin{proof}
This is clear from the additivity of the $\text{ord}$ functions.
\end{proof}

\noindent
An important role in the discussion of principal divisors
is played by the ``universal'' principal divisor $[0] - [\infty]$
on $\mathbf{P}^1_S$. To make this more precise, let us denote
$$
D_0, D_\infty \subset
\mathbf{P}^1_S = \underline{\text{Proj}}_S(\mathcal{O}_S[X_0, X_1])
$$
the closed subscheme cut out by the section $X_1$, resp.\ $X_0$
of $\mathcal{O}(1)$. These are effective Cartier divisors, see
Divisors, Definition \ref{divisors-definition-effective-Cartier-divisor}
and Lemma \ref{divisors-lemma-characterize-OD}.
The following lemma says that loosely speaking we have
``$\text{div}(X_1/X_0) = [D_0] - [D_1]$'' and that this is the
universal principal divisor.

\begin{lemma}
\label{lemma-rational-function}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$. Let $f \in R(X)^*$.
Let $U \subset X$ be a nonempty open such that $f$
corresponds to a section $f \in \Gamma(U, \mathcal{O}_X^*)$.
Let $Y \subset X \times_S \mathbf{P}^1_S$ be the
closure of the graph of $f : U \to \mathbf{P}^1_S$.
Then
\begin{enumerate}
\item the projection morphism $p : Y \to X$ is proper,
\item $p|_{p^{-1}(U)} : p^{-1}(U) \to U$ is an isomorphism,
\item the pullbacks $q^{-1}D_0$ and $q^{-1}D_\infty$ via the morphism
$q : Y \to \mathbf{P}^1_S$ are effective Cartier divisors on $Y$,
\item we have
$$
\text{div}_Y(f) = [q^{-1}D_0]_{n - 1} - [q^{-1}D_\infty]_{n - 1}
$$
\item we have
$$
\text{div}_X(f) = p_*\text{div}_Y(f)
$$
\item if we view $Y_0 = q^{-1}D_0$, and
$Y_\infty = q^{-1}D_\infty$ as closed subschemes of $X$
via the morphism $p$ then we have
$$
\text{div}_X(f) = [Y_0]_{n - 1} - [Y_\infty]_{n - 1}
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Since $X$ is integral, we see that $U$ is integral.
Hence $Y$ is integral, and $(1, f)(U) \subset Y$ is an open dense subscheme.
Also, note that the closed subscheme $Y \subset X \times_S \mathbf{P}^1_S$
does not depend on the choice of the open $U$, since after all it is
the closure of the one point set $\{\eta'\} = \{(1, f)(\eta)\}$
where $\eta \in X$ is the generic point. Having said this let us
prove the assertions of the lemma.

\medskip\noindent
For (1) note that $p$ is the composition of the closed immersion
$Y \to X \times_S \mathbf{P}^1_S = \mathbf{P}^1_X$ with the proper
morphism $\mathbf{P}^1_X \to X$. As a composition of proper morphisms
is proper (Morphisms, Lemma \ref{morphisms-lemma-composition-proper})
we conclude.

\medskip\noindent
It is clear that $Y \cap U \times_S \mathbf{P}^1_S = (1, f)(U)$.
Thus (2) follows. It also follows that $\dim_\delta(Y) = n$.

\medskip\noindent
Note that $q(\eta') = f(\eta)$ is not contained in $D_0$ or $D_\infty$
since $f \in R(X)^*$. Hence $q^{-1}D_0$ and $q^{-1}D_\infty$ are
effective Cartier divisors on $Y$ by
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}.
Thus we see (3). It also follows that $\dim_\delta(q^{-1}D_0) = n - 1$
and $\dim_\delta(q^{-1}D_\infty) = n - 1$.

\medskip\noindent
Consider the effective Cartier divisor $q^{-1}D_0$.
At every point $\xi \in q^{-1}D_0$ we have $f \in \mathcal{O}_{Y, \xi}$ and
the local equation for $q^{-1}D_0$ is given by $f$.
In particular, if $\delta(\xi) = n - 1$ so $\xi$ is the generic point
of a integral closed subscheme $Z$ of $\delta$-dimension $n - 1$,
then we see that the coefficient of $[Z]$ in $\text{div}_Y(f)$ is
$$
\text{ord}_Z(f) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{Y, \xi}/f\mathcal{O}_{Y, \xi}) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{q^{-1}D_0, \xi})
$$
which is the coefficient of $[Z]$ in $[q^{-1}D_0]_{n - 1}$. A similar
argument using the rational function $1/f$ shows that
$-[q^{-1}D_\infty]$ agrees with the terms with negative coefficients in
the expression for $\text{div}_Y(f)$. Hence (4) follows.

\medskip\noindent
Note that $D_0 \to S$ is an isomorphism. Hence we see that
$X \times_S D_0 \to X$ is an isomorphism as well. Clearly
we have $q^{-1}D_0 = Y \cap X \times_S D_0$ (scheme theoretic intersection)
inside $X \times_S \mathbf{P}^1_S$. Hence it is really the case that
$Y_0 \to X$ is a closed immersion. By the same token we see that
$$
p_*\mathcal{O}_{q^{-1}D_0} = \mathcal{O}_{Y_0}
$$
and hence by Lemma \ref{lemma-cycle-push-sheaf} we
have $p_*[q^{-1}D_0]_{n - 1} = [Y_0]_{n - 1}$. Of course the same
is true for $D_\infty$ and $Y_\infty$. Hence to finish the proof of
the lemma it suffices to prove the last assertion.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension
$n - 1$. We want to show that the coefficient of $[Z]$ in $\text{div}(f)$
is the same as the coefficient of $[Z]$ in
$[Y_0]_{n - 1} - [Y_\infty]_{n - 1}$.
We may apply Lemma \ref{lemma-finite-in-codimension-one}
to the morphism $p : Y \to X$ and
the generic point $\xi \in Z$. Hence we may replace $X$ by an
affine open neighbourhood of $\xi$ and assume that $p : Y \to X$ is finite.
Write $X = \Spec(R)$ and $Y = \Spec(A)$ with $p$ induced
by a finite homomorphism $R \to A$ of Noetherian domains which induces
an isomorphism $f.f.(R) \cong f.f.(A)$ of fraction fields.
Now we have $f \in f.f.(R)$ and a prime $\mathfrak p \subset R$
with $\dim(R_{\mathfrak p}) = 1$. The coefficient of
$[Z]$ in $\text{div}_X(f)$ is $\text{ord}_{R_\mathfrak p}(f)$.
The coefficient of $[Z]$ in $p_*\text{div}_Y(f)$ is
$$
\sum\nolimits_{\mathfrak q\text{ lying over }\mathfrak p}
[\kappa(\mathfrak q) : \kappa(\mathfrak p)]
\text{ord}_{A_{\mathfrak q}}(f)
$$
The desired equality therefore follows from
Algebra, Lemma \ref{algebra-lemma-finite-extension-dim-1}.
\end{proof}

\noindent
This lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-rational-equivalence}.

\begin{lemma}
\label{lemma-flat-pullback-principal-divisor}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $g \in R(Y)^*$. Then
$$
f^*(\text{div}_Y(g)) = \text{div}_X(g)
$$
in $Z_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Note that since $f$ is flat it is dominant so that
$f$ induces an embedding $R(Y) \subset R(X)$, and hence
we may think of $g$ as an element of $R(X)^*$.
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n + r - 1$. Let $\xi \in Z$
be its generic point. If $\dim_\delta(f(Z)) > n - 1$,
then we see that the coefficient of $[Z]$ in the left and
right hand side of the equation is zero.
Hence we may assume that $Z' = \overline{f(Z)}$ is an
integral closed subscheme of $Y$ of $\delta$-dimension $n - 1$.
Let $\xi' = f(\xi)$. It is the generic point of $Z'$.
Set $A = \mathcal{O}_{Y, \xi'}$, $B = \mathcal{O}_{X, \xi}$.
The ring map $A \to B$ is a flat local homomorphism of
Noetherian local domains of dimension $1$.
We have $g \in f.f.(A)$. What we have to show is that
$$
\text{ord}_A(g) \text{length}_B(B/\mathfrak m_AB)
=
\text{ord}_B(g).
$$
This follows from Algebra, Lemma \ref{algebra-lemma-pullback-module}
(details omitted).
\end{proof}











\section{Two fun results on principal divisors}
\label{section-two-fun}

\noindent
The first lemma implies that the pushforward of a principal
divisor along a generically finite morphism is a principal divisor.

\begin{lemma}
\label{lemma-proper-pushforward-alteration}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(X) = \dim_\delta(Y)$.
Let $p : X \to Y$ be a dominant proper morphism.
Let $f \in R(X)^*$. Set
$$
g = \text{Nm}_{R(X)/R(Y)}(f).
$$
Then we have
$p_*\text{div}(f) = \text{div}(g)$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be an integral closed subscheme of $\delta$-dimension
$n - 1$. We want to show that the coefficient of $[Z]$ in
$p_*\text{div}(f)$ and $\text{div}(g)$ are equal. We may apply
Lemma \ref{lemma-finite-in-codimension-one}
to the morphism $p : X \to X$ and the generic point $\xi \in Z$.
Hence we may replace $X$ by an
affine open neighbourhood of $\xi$ and assume that $p : Y \to X$ is finite.
Write $X = \Spec(R)$ and $Y = \Spec(A)$ with $p$ induced
by a finite homomorphism $R \to A$ of Noetherian domains which induces
an finite field extension $f.f.(R) \subset f.f.(A)$ of fraction fields.
Now we have $f \in f.f.(A)$, $g = \text{Nm}(f) \in f.f.(R)$,
and a prime $\mathfrak p \subset R$ with $\dim(R_{\mathfrak p}) = 1$.
The coefficient of $[Z]$ in $\text{div}_Y(g)$ is
$\text{ord}_{R_\mathfrak p}(g)$.
The coefficient of $[Z]$ in $p_*\text{div}_X(f)$ is
$$
\sum\nolimits_{\mathfrak q\text{ lying over }\mathfrak p}
[\kappa(\mathfrak q) : \kappa(\mathfrak p)]
\text{ord}_{A_{\mathfrak q}}(f)
$$
The desired equality therefore follows from
Algebra, Lemma \ref{algebra-lemma-finite-extension-dim-1}.
\end{proof}

\noindent
The following lemma says that the degree of a principal divisor on
a proper curve is zero.

\begin{lemma}
\label{lemma-curve-principal-divisor}
Let $K$ be any field. Let $X$ be a $1$-dimensional integral scheme
endowed with a proper morphism $c : X \to \Spec(K)$.
Let $f \in K(X)^*$ be an invertible rational function.
Then
$$
\sum\nolimits_{x \in X \text{ closed}}
[\kappa(x) : K] \text{ord}_{\mathcal{O}_{X, x}}(f)
=
0
$$
where $\text{ord}$ is as in
Algebra, Definition \ref{algebra-definition-ord}.
In other words, $c_*\text{div}(f) = 0$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
Y \ar[r]_p \ar[d]_q & X \ar[d]^c \\
\mathbf{P}^1_K \ar[r]^-{c'} & \Spec(K)
}
$$
that we constructed in Lemma \ref{lemma-rational-function}
starting with $X$ and the rational function $f$ over $S = \Spec(K)$.
We will use all the results of this lemma without further mention.
We have to show that $c_*\text{div}_X(f) = c_*p_*\text{div}_Y(f) = 0$.
This is the same as proving that $c'_*q_*\text{div}_Y(f) = 0$.
If $q(Y)$ is a closed point of $\mathbf{P}^1_K$ then we
see that $\text{div}_X(f) = 0$ and the lemma holds.
Thus we may assume that $q$ is dominant.
Since $\text{div}_Y(f) = [q^{-1}D_0]_0 - [q^{-1}D_\infty]_0$
we see (by definition of flat pullback) that
$\text{div}_Y(f) = q^*([D_0]_0 - [D_\infty]_0)$.
Suppose we can show that $q : Y \to \mathbf{P}^1_K$ is finite
locally free of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Then byy Lemma \ref{lemma-finite-flat} we get
$q_*\text{div}_Y(f) = d([D_0]_0 - [D_\infty]_0)$.
Since clearly $c'_*[D_0]_0 = c'_*[D_\infty]_0$ we win.

\medskip\noindent
It remains to show that $q$ is finite locally free.
(It will automatically have some given degree as $\mathbf{P}^1_K$
is connected.)
Since $\dim(\mathbf{P}^1_K) = 1$ we see that $q$ is finite for example
by Lemma \ref{lemma-finite-in-codimension-one}.
All local rings of $\mathbf{P}^1_K$ at
closed points are regular local rings of dimension $1$
(in other words discrete valuation rings), since they are
localizations of $K[T]$ (see
Algebra, Lemma \ref{algebra-lemma-dim-affine-space}).
Hence for $y\in Y$ closed the local ring $\mathcal{O}_{Y, y}$
will be flat over $\mathcal{O}_{\mathbf{P}^1_K, q(y)}$ as soon as
it is torsion free. This is obviously the case as
$\mathcal{O}_{Y, y}$ is a domain and $q$ is dominant.
Thus $q$ is flat. Hence $q$ is finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
\end{proof}





\section{Rational equivalence}
\label{section-rational-equivalence}

\noindent
In this section we define {\it rational equivalence} on $k$-cycles.
We will allow locally finite sums of images of
principal divisors (under closed immersions). This leads to some
pretty strange phenomena, see Example \ref{example-weird}.
However, if we do not allow these then we do not know how to prove that
capping with chern classes of line bundles factors through rational
equivalence.

\begin{definition}
\label{definition-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item Given any locally finite collection $\{W_j \subset X\}$
of integral closed subschemes with $\dim_\delta(W_j) = k + 1$,
and any $f_j \in R(W_j)^*$ we may consider
$$
\sum (i_j)_*\text{div}(f_j) \in Z_k(X)
$$
where $i_j : W_j \to X$ is the inclusion morphism.
This makes sense as the morphism
$\coprod i_j : \coprod W_j \to X$ is proper.
\item We say that $\alpha \in Z_k(X)$ is {\it rationally equivalent to zero}
if $\alpha$ is a cycle of the form displayed above.
\item We say $\alpha, \beta \in Z_k(X)$ are
{\it rationally equivalent} and we write $\alpha \sim_{rat} \beta$
if $\alpha - \beta$ is rationally equivalent to zero.
\item We define
$$
A_k(X) = Z_k(X) / \sim_{rat}
$$
to be the {\it Chow group of $k$-cycles on $X$}. This is sometimes called
the {\it Chow group of $k$-cycles module rational equivalence on $X$}.
\end{enumerate}
\end{definition}

\noindent
There are many other interesting (adequate) equivalence relations.
Rational equivalence is the coarsest one of them all.
A very simple but important lemma is the following.

\begin{lemma}
\label{lemma-restrict-to-open}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
Let $k \in \mathbf{Z}$.
Suppose $\alpha, \beta \in Z_k(X)$.
If $\alpha|_U \sim_{rat} \beta|_U$ then there exist a cycle
$\gamma \in Z_k(Y)$ such that
$$
\alpha \sim_{rat} \beta + i_*\gamma.
$$
In other words, the sequence
$$
\xymatrix{
A_k(Y) \ar[r]^{i_*} & A_k(X) \ar[r]^{j_*} & A_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be a locally finite collection of integral closed
subschemes of $\delta$-dimension $k + 1$, and let $f_j \in R(W_j)^*$
be elements such that $(\alpha - \beta)|_U = \sum (i_j)_*\text{div}(f_j)$
as in the definition. Set $W_j' \subset X$ equal
to the closure of $W_j$. Suppose that $V \subset X$ is a quasi-compact
open. Then also $V \cap U$ is quasi-compact open in $U$ as
$V$ is Noetherian. Hence the set
$\{j \in J \mid W_j \cap V \not = \emptyset\}
= \{j \in J \mid W'_j \cap V \not = \emptyset\}$
is finite since $\{W_j\}$ is locally finite. In other words we see that
$\{W'_j\}$ is also locally finite. Since $R(W_j) = R(W'_j)$ we see
that
$$
\alpha - \beta - \sum (i'_j)_*\text{div}(f_j)
$$
is a cycle supported on $Y$ and the lemma follows (see
Lemma \ref{lemma-exact-sequence-open}).
\end{proof}

\begin{example}
\label{example-weird}
Here is a ``strange'' example.
Suppose that $S$ is the spectrum of a field $k$
with $\delta$ as in Example \ref{example-field}.
Suppose that $X = C_1 \cup C_2 \cup \ldots$ is an infinite
union of curves $C_j \cong \mathbf{P}^1_k$ glued together
in the following way: The point $\infty \in C_j$ is glued
transversally to the point $0 \in C_{j + 1}$ for $j = 1, 2, 3, \ldots$.
Take the point $0 \in C_1$. This gives a zero cycle
$[0] \in Z_0(X)$. The ``strangeness'' in this situation is
that actually $[0] \sim_{rat} 0$! Namely we can choose
the rational function $f_j \in R(C_j)$ to be the function
which has a simple zero at $0$ and a simple pole at $\infty$
and no other zeros or poles. Then we see that the sum
$\sum (i_j)_*\text{div}(f_j)$ is exactly the $0$-cycle
$[0]$. In fact it turns out that $A_0(X) = 0$ in this example.
If you find this too bizarre, then you can just
make sure your spaces are always quasi-compact
(so $X$ does not even exist for you).
\end{example}

\begin{remark}
\label{remark-infinite-sums-rational-equivalences}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose we have infinite collections $\alpha_i, \beta_i \in Z_k(X)$,
$i \in I$ of $k$-cycles on $X$. Suppose that the supports
of $\alpha_i$ and $\beta_i$ form locally finite collections
of closed subsets of $X$ so that $\sum \alpha_i$
and $\sum \beta_i$ are defined as cycles. Moreover, assume that
$\alpha_i \sim_{rat} \beta_i$ for each $i$. Then it is not
clear that $\sum \alpha_i \sim_{rat} \sum \beta_i$. Namely,
the problem is that the rational equivalences may be
given by locally finite
families $\{W_{i, j}, f_{i, j} \in R(W_{i, j})^*\}_{j \in J_i}$
but the union $\{W_{i, j}\}_{i \in I, j\in J_i}$ may not
be locally finite.

\medskip\noindent
In many cases in practice, one has a locally finite family of closed
subsets $\{T_i\}_{i \in I}$ such that $\alpha_i, \beta_i$
are supported on $T_i$ and such that $\alpha_i = \beta_i$
in $A_k(T_i)$, in other words, the families
$\{W_{i, j}, f_{i, j} \in R(W_{i, j})^*\}_{j \in J_i}$
consist of subschemes $W_{i, j} \subset T_i$. In this case it is true that
$\sum \alpha_i \sim_{rat} \sum \beta_i$ on $X$, simply because
the family $\{W_{i, j}\}_{i \in I, j\in J_i}$ is automatically
locally finite in this case.
\end{remark}






\section{Properties of rational equivalence}
\label{section-properties-rational-equivalence}

\begin{lemma}
\label{lemma-flat-pullback-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha \sim_{rat} \beta$ be rationally equivalent $k$-cycles on $Y$.
Then $f^*\alpha \sim_{rat} f^*\beta$ as $(k + r)$-cycles on $X$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow Y
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $f_j \in R(W_j)^*$.
Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $Y$.
Then we have to show that
$$
f^*(\sum i_{j, *}\text{div}(f_j))
$$
is rationally equivalent to zero on $X$.

\medskip\noindent
Consider the fibre products
$$
i'_j :
W'_j = W_j \times_Y X
\longrightarrow
X.
$$
For each $j$, consider the collection $\{W'_{j, l}\}_{l \in L_j}$
of irreducible components $W'_{j, l} \subset W'_j$ having $\delta$-dimension
$k + 1$. We may write
$$
[W'_j]_{k + 1} = \sum\nolimits_{l \in L_j} n_{j, l}[W'_{j, l}]_{k + 1}
$$
for some $n_{j, l} > 0$.
By Lemma \ref{lemma-flat-inverse-image-dimension}
we see that $W'_{j, l} \to W_j$ is
dominant and hence we can let $f_{j, l} \in R(W'_{j, l})^*$ denote the
image of $f_j$ under the map of fields $R(W_j) \to R(W'_{j, l})$.
We claim that
\begin{enumerate}
\item the collection $\{W'_{j, l}\}_{j \in J, l \in L_j}$ is
locally finite on $X$, and
\item with obvious notation
$f^*(\sum i_{j, *}\text{div}(f_j))
=
\sum i'_{j, l, *} \text{div}(f_{j, l}^{n_{j, l}})$.
\end{enumerate}
Clearly this claim implies the lemma.

\medskip\noindent
To show (1), note that $\{W'_j\}$ is a locally finite collection
of closed subschemes of $X$ by Lemma \ref{lemma-inverse-image-locally-finite}.
Hence if $U \subset X$ is quasi-compact, then $U$ meets only finitely
many $W'_j$. By Lemma \ref{lemma-multiplicity-finite} the collection of
irreducible components of each $W_j$ is locally finite as well. Hence
we see only finitely many $W'_{j, l}$ meet $U$ as desired.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension
$k + r$. We have to show that the coefficient $n$ of $[Z]$ in
$f^*(\sum i_{j, *}\text{div}(f_j))$ is equal to the coefficient
$m$ of $[Z]$ in $\sum i'_{j, l, *} \text{div}(f_{j, l}^{n_{j, l}})$.
Let $Z'$ be the closure of $f(Z)$ which is an integral closed
subscheme of $Y$. By Lemma \ref{lemma-flat-inverse-image-dimension}
we have $\dim_\delta(Z') \geq k$.
If $\dim_\delta(Z') > k$, then the coefficients $n$ and $m$ are
both zero, since the generic point of $Z$ will not be contained
in any $W'_j$ or $W'_{j, l}$. Hence we may assume that $\dim_\delta(Z') = k$.

\medskip\noindent
We are going to translate the equality of $n$ and $m$ into algebra.
Namely, let $\xi' \in Z'$ and $\xi \in Z$ be the generic points.
Set $A = \mathcal{O}_{Y, \xi'}$ and $B = \mathcal{O}_{X, \xi}$.
Note that $A$, $B$ are Noetherian, $A \to B$ is flat, local,
and that $\mathfrak m_AB$ is an ideal of definition of the local ring $B$.
There are finitely many $j$ such that $W_j$ passes through
$\xi'$, and these correspond to prime ideals
$$
\mathfrak p_1, \ldots, \mathfrak p_T \subset A
$$
with the property that $\dim(A/\mathfrak p_t) = 1$ for each
$t = 1, \ldots, T$. The rational functions $f_j$ correspond
to elements $f_t \in \kappa(\mathfrak p_t)^*$.
Say $\mathfrak p_t$ corresponds to $W_j$.
By construction, the closed subschemes $W'_{j, l}$ which meet
$\xi$ correspond $1 - 1$ with minimal primes
$$
\mathfrak p_tB
\subset
\mathfrak q_{t, 1}, \ldots, \mathfrak q_{t, S_t}
\subset
B
$$
over $\mathfrak p_tB$.
The integers $n_{j, l}$ correspond to the integers
$$
n_{t, s} = \text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
The rational functions $f_{j, l}$ correspond to the images
$f_{t, s} \in \kappa(\mathfrak q_{t, s})^*$ of the elements
$f_t \in \kappa(\mathfrak p_t)^*$. Putting everything together
we see that
$$
n = \sum \text{ord}_{A/\mathfrak p_t}(f_t)\text{length}_B(B/\mathfrak m_AB)
$$
and that
$$
m = \sum \text{ord}_{B/\mathfrak q_{t, s}}(f_{t, s})
\text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
Note that it suffices to prove the equality for each
$t \in \{1, \ldots, T\}$ separately. Writing $f_t = x/y$
for some nonzero $\overline{x}, \overline{y} \in A/\mathfrak p_t$
coming from $x, y\in A$ we see that it suffices
to prove
$$
\text{length}_{A/\mathfrak p_t}(A/(\mathfrak p_t, x))
\text{length}_B(B/\mathfrak m_AB)
=
\text{length}_B(B/(x, \mathfrak p_t)B)
$$
(equality uses Algebra, Lemma \ref{algebra-lemma-pullback-module})
equals
$$
\sum\nolimits_{s = 1, \ldots, S_t}
\text{ord}_{B/\mathfrak q_{t, s}}(B/(x, \mathfrak q_{t, s}))
\text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
and similarly for $y$. Note that as $x \not \in \mathfrak p_t$ we
see that $x$ is a nonzerodivisor on $A/\mathfrak p_t$. As $A \to B$
is flat it follows that $x$ is a nonzerodivisor on the module
$M = B/\mathfrak p_tB$. Hence the equality above follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-proper-pushforward-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Suppose $\alpha, \beta \in Z_k(X)$ are rationally equivalent.
Then $p_*\alpha$ is rationally equivalent to $p_*\beta$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow X
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $f_j \in R(W_j)^*$.
Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $X$.
Then we have to show that
$$
p_*\left(\sum i_{j, *}\text{div}(f_j)\right)
$$
is rationally equivalent to zero on $X$.

\medskip\noindent
Note that the sum is equal to
$$
\sum p_*i_{j, *}\text{div}(f_j).
$$
Let $W'_j \subset Y$ be the integral closed subscheme which is the
image of $p \circ i_j$. The collection $\{W'_j\}$ is locally finite
in $Y$ by Lemma \ref{lemma-quasi-compact-locally-finite}.
Hence it suffices to show, for a given $j$, that either
$p_*i_{j, *}\text{div}(f_j) = 0$ or that it
is equal to $i'_{j, *}\text{div}(g_j)$ for some $g_j \in R(W'_j)^*$.

\medskip\noindent
The arguments above therefore reduce us to the case of a since
integral closed subscheme $W \subset X$ of $\delta$-dimension $k + 1$.
Let $f \in R(W)^*$. Let $W' = p(W)$ as above.
We get a commutative diagram of morphisms
$$
\xymatrix{
W \ar[r]_i \ar[d]_{p'} & X \ar[d]^p \\
W' \ar[r]^{i'} & Y
}
$$
Note that $p_*i_*\text{div}(f) = i'_*(p')_*\text{div}(f)$ by
Lemma \ref{lemma-compose-pushforward}. As explained above
we have to show that $(p')_*\text{div}(f)$
is the divisor of a rational function on $W'$ or zero.
There are three cases to distinguish.

\medskip\noindent
The case $\dim_\delta(W') < k$. In this case automatically
$(p')_*\text{div}(f) = 0$ and there is nothing to prove.

\medskip\noindent
The case $\dim_\delta(W') = k$. Let us show that $(p')_*\text{div}(f) = 0$
in this case. Let $\eta \in W'$ be the generic point.
Note that $c : W_\eta \to \Spec(K)$
is a proper integral curve over $K = \kappa(\eta)$
whose function field $K(W_\eta)$ is identified with $R(W)$.
Here is a diagram
$$
\xymatrix{
W_\eta \ar[r] \ar[d]_c & W \ar[d]^{p'} \\
\Spec(K) \ar[r] & W'
}
$$
Let us denote $f_\eta \in K(W_\eta)^*$ the rational function
corresponding to $f \in R(W)^*$.
Moreover, the closed points $\xi$ of $W_\eta$ correspond $1 - 1$ to the
closed integral subschemes $Z = Z_\xi \subset W$ of $\delta$-dimension $k$
with $p'(Z) = W'$. Note that the multiplicity
of $Z_\xi$ in $\text{div}(f)$ is equal to
$\text{ord}_{\mathcal{O}_{W_\eta, \xi}}(f_\eta)$ simply because the
local rings $\mathcal{O}_{W_\eta, \xi}$ and $\mathcal{O}_{W, \xi}$
are identified (as subrings of their fraction fields).
Hence we see that the multiplicity of $[W']$ in
$(p')_*\text{div}(f)$ is equal to the multiplicity of
$[\Spec(K)]$ in $c_*\text{div}(f_\eta)$.
By Lemma \ref{lemma-curve-principal-divisor} this is zero.

\medskip\noindent
The case $\dim_\delta(W') = k + 1$. In this case
Lemma \ref{lemma-proper-pushforward-alteration} applies,
and we see that indeed $p'_*\text{div}(f) = \text{div}(g)$
for some $g \in R(W')^*$ as desired.
\end{proof}















\section{Different characterizations of rational equivalence}
\label{section-different-rational-equivalence}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Given any closed subscheme
$Z \subset X \times_S \mathbf{P}^1_S = X \times \mathbf{P}^1$
we let $Z_0$, resp.\ $Z_\infty$ be the scheme theoretic closed
subscheme $Z_0 = \text{pr}_2^{-1}(D_0)$,
resp.\ $Z_\infty = \text{pr}_2^{-1}(D_\infty)$.
Here $D_0$, $D_\infty$ are as defined just above
Lemma \ref{lemma-rational-function}.

\begin{lemma}
\label{lemma-rational-equivalence-family}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $W \subset X \times_S \mathbf{P}^1_S$ be an integral
closed subscheme of $\delta$-dimension $k + 1$.
Assume $W \not = W_0$, and $W \not = W_\infty$. Then
\begin{enumerate}
\item $W_0$, $W_\infty$ are effective Cartier divisors of $W$,
\item $W_0$, $W_\infty$ can be viewed as closed subschemes
of $X$ and
$$
[W_0]_k \sim_{rat} [W_\infty]_k,
$$
\item for any locally finite family of
integral closed subschemes
$W_i \subset X \times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$ with $W_i \not = (W_i)_0$ and
$W_i \not = (W_i)_\infty$ we have
$\sum ([(W_i)_0]_k - [(W_i)_\infty]_k) \sim_{rat} 0$
on $X$, and
\item for any $\alpha \in Z_k(X)$ with $\alpha \sim_{rat} 0$
there exists a locally finite family of
integral closed subschemes $W_i \subset X \times_S \mathbf{P}^1_S$
as above such that $\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}
since the generic point
of $W$ is not mapped into $D_0$ or $D_\infty$ under the projection
$X \times_S \mathbf{P}^1_S \to \mathbf{P}^1_S$ by assumption.

\medskip\noindent
Since $X \times_S D_0 \to X$ is an isomorphism we see that $W_0$
is isomorphic to a closed subscheme of $X$. Similarly for $W_\infty$.
Consider the morphism $p : W \to X$. It is proper and on $W$ we have
$[W_0]_k \sim_{rat} [W_\infty]_k$. Hence part (2) follows from
Lemma \ref{lemma-proper-pushforward-rational-equivalence} as clearly
$p_*[W_0]_k = [W_0]_k$ and similarly for $W_\infty$.

\medskip\noindent
The only content of statement (3) is, given parts (1) and (2), that
the collection $\{(W_i)_0, (W_i)_\infty\}$ is a locally finite collection
of closed subschemes of $X$. This is clear.

\medskip\noindent
Suppose that $\alpha \sim_{rat} 0$.
By definition this means there exist integral closed subschemes
$V_i \subset X$ of $\delta$-dimension $k + 1$ and rational
functions $f_i \in R(V_i)^*$ such that the family
$\{V_i\}_{i \in I}$ is locally finite in $X$ and such that
$\alpha = \sum (V_i \to X)_*\text{div}(f_i)$.
Let
$$
W_i \subset V_i \times_S \mathbf{P}^1_S \subset X \times_S \mathbf{P}^1_S
$$
be the closure of the graph of the rational map $f_i$ as in
Lemma \ref{lemma-rational-function}.
Then we have that $(V_i \to X)_*\text{div}(f_i)$
is equal to $[(W_i)_0]_k - [(W_i)_\infty]_k$ by that same lemma.
Hence the result is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-subscheme-cross-p1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $Z$ be a closed subscheme of $X \times \mathbf{P}^1$.
Assume $\dim_\delta(Z) \leq k + 1$, $\dim_\delta(Z_0) \leq k$,
$\dim_\delta(Z_\infty) \leq k$ and assume
any embedded point $\xi$
(Divisors, Definition \ref{divisors-definition-embedded})
of $Z$ has $\delta(\xi) < k$. Then
$$
[Z_0]_k \sim_{rat} [Z_\infty]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $Z$ which have $\delta$-dimension $k + 1$.
Write
$$
[Z]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by Lemma \ref{lemma-multiplicity-finite}.
We claim that
$$
[Z_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[Z_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[Z_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $I \subset A$ be the ideal cutting out $Z$, in other words so that
$A/I = \mathcal{O}_{Z, \xi}$. Let $t \in A$ be the element cutting
out $X \times_S D_0$ (i.e., the coordinate of $\mathbf{P}^1$ at zero
pulled back). By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(A/I) = 1$. Since $\xi$ is not an embedded point by
definition we see that $A/I$ is Cohen-Macaulay. Since $\dim_\delta(Z_0)
= k$ we see that $\dim(A/(t, I)) = 0$ which implies that $t$
is a nonzerodivisor on $A/I$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$I \subset \mathfrak q_i$ over $I$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(A/(t, I))
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i))
\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}
$$
Thus the result follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cross-p1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X \times \mathbf{P}^1$.
Let $i_0, i_\infty : X \to X \times \mathbf{P}^1$ be the closed immersion
such that $i_t(x) = (x, t)$. Denote $\mathcal{F}_0 = i_0^*\mathcal{F}$ and
$\mathcal{F}_\infty = i_\infty^*\mathcal{F}$.
Assume
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$,
\item $\dim_\delta(\text{Supp}(\mathcal{F}_0)) \leq k$,
$\dim_\delta(\text{Supp}(\mathcal{F}_\infty)) \leq k$, and
\item any nonmaximal associated point
(insert future reference here) $\xi \in \text{Supp}(\mathcal{F})$
of $\mathcal{F}$ has $\delta(\xi) < k$.
\end{enumerate}
Then
$$
[\mathcal{F}_0]_k \sim_{rat} [\mathcal{F}_\infty]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$.
Write
$$
[\mathcal{F}]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by Lemma \ref{lemma-length-finite}.
We claim that
$$
[\mathcal{F}_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[\mathcal{F}_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[\mathcal{F}_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Let $t \in A$ be the element cutting out $X \times_S D_0$
(i.e., the coordinate of $\mathbf{P}^1$ at zero pulled back).
By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(M) = 1$. Since $\xi$ is not an associated point
of $\mathcal{F}$ by definition we see that $M$ is Cohen-Macaulay module.
Since $\dim_\delta(\text{Supp}(\mathcal{F}_0)) = k$
we see that $\dim(M/tM) = 0$ which implies that $t$
is a nonzerodivisor on $M$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Ass}(M)$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(M/tM)
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i)A)
\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}
$$
Thus the result follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}





\section{Rational equivalence and K-groups}
\label{section-rational-equivalence-K-groups}

\noindent
In this section we compare the cycle groups $Z_k(X)$ and
the Chow groups $A_k(X)$ with certain $K_0$-groups of
abelian categories of coherent sheaves on $X$. We avoid having
to talk about $K_1(\mathcal{A})$ for an abelian category
$\mathcal{A}$ by dint of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}.
In particular, the motivation for the precise form of
Lemma \ref{lemma-maps-between-coherent-sheaves} is that lemma.

\medskip\noindent
Let us introduce the following notation.
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
We denote $\text{Coh}(X) = \text{Coh}(\mathcal{O}_X)$
the category of coherent sheaves on $X$.
It is an abelian category, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.
For any $k \in \mathbf{Z}$ we let $\text{Coh}_{\leq k}(X)$
be the full subcategory of $\text{Coh}(X)$
consisting of those coherent sheaves $\mathcal{F}$
having $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-Serre-subcategories}
Let us introduce the following notation.
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
The categories $\text{Coh}_{\leq k}(X)$ are Serre subcategories
of the abelian category $\text{Coh}(X)$.
\end{lemma}

\begin{proof}
Omitted. The definition of a Serre subcategory is
Homology, Definition \ref{homology-definition-serre-subcategory}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-k-group}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
There are maps
$$
Z_k(X)
\longrightarrow
K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))
\longrightarrow
Z_k(X)
$$
whose composition is the identity. The first is the map
$$
\sum n_Z[Z] \mapsto
\left[\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}\right]
-
\left[\bigoplus\nolimits_{n_Z < 0} \mathcal{O}_Z^{\oplus -n_Z}\right]
$$
and the second comes from the map $\mathcal{F} \mapsto [\mathcal{F}]_k$.
If $X$ is quasi-compact, then both maps are isomorphisms.
\end{lemma}

\begin{proof}
Note that the direct sum
$\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}$
is indeed a coherent sheaf on $X$ since the family $\{Z \mid n_Z > 0\}$
is locally finite on $X$.
The map $\mathcal{F} \to [\mathcal{F}]_k$ is additive
on $\text{Coh}_{\leq k}(X)$, see
Lemma \ref{lemma-additivity-sheaf-cycle}. And $[\mathcal{F}]_k = 0$
if $\mathcal{F} \in \text{Coh}_{\leq k - 1}(X)$.
This implies we have the left map as shown in the lemma.
It is clear that their composition is the identity.

\medskip\noindent
In case $X$ is quasi-compact we will show that the right arrow
is injective.
Suppose that $q \in K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k + 1}(X))$
maps to zero in $Z_k(X)$. By
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
we can find
a $\tilde q \in K_0(\text{Coh}_{\leq k}(X))$ mapping to $q$.
Write $\tilde q = [\mathcal{F}] - [\mathcal{G}]$ for some
$\mathcal{F}, \mathcal{G} \in K_0(\text{Coh}_{\leq k}(X))$.
Since $X$ is quasi-compact we may apply
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-filter}.
This shows that there exist integral closed subschemes
$Z_j, T_i \subset X$ and (nonzero) ideal sheaves
$\mathcal{I}_j \subset \mathcal{O}_{Z_j}$,
$\mathcal{I}_i \subset \mathcal{O}_{T_i}$ such that
$\mathcal{F}$, resp.\ $\mathcal{G}$ have filtrations whose successive
quotients are the sheaves $\mathcal{I}_j$, resp.\ $\mathcal{I}_i$.
In particular we see that $\dim_\delta(Z_j), \dim_\delta(T_i) \leq k$.
In other words we have
$$
[\mathcal{F}] = \sum\nolimits_j [\mathcal{I}_j],
\quad
[\mathcal{G}] = \sum\nolimits_i [\mathcal{I}_i],
$$
in $K_0(\text{Coh}_{\leq k}(X))$. Our assumption is that
$\sum_j [\mathcal{I}_j]_k - \sum_i [\mathcal{I}_i]_k = 0$.
It is clear that we may throw out the indices $j$, resp.\ $i$
such that $\dim_\delta(Z_j) < k$, resp.\ $\dim_\delta(T_i) < k$,
since the corresponding sheaves are in $\text{Coh}_{k - 1}(X)$ and
also do not contribute to the cycle. Moreover, the exact sequences
$0 \to \mathcal{I}_j \to \mathcal{O}_{Z_j} \to
\mathcal{O}_{Z_j}/\mathcal{I}_j \to 0$
and
$0 \to \mathcal{I}_i \to \mathcal{O}_{T_i} \to
\mathcal{O}_{Z_i}/\mathcal{I}_i \to 0$
show similarly that we may replace $\mathcal{I}_j$, resp.\ $\mathcal{I}_i$
by $\mathcal{O}_{Z_j}$, resp.\ $\mathcal{O}_{T_i}$.
OK, and finally, at this point it is clear that our assumption
$$
\sum\nolimits_j [\mathcal{O}_{Z_j}]_k - \sum\nolimits_i [\mathcal{O}_{T_i}]_k
= 0
$$
implies that in $K_0(\text{Coh}_k(X))$ we have also
$\sum\nolimits_j [\mathcal{O}_{Z_j}] - \sum\nolimits_i [\mathcal{O}_{T_i}]
= 0$
as desired.
\end{proof}

\begin{remark}
\label{remark-not-true-not-quasi-compact}
It seems likely that the arrows of Lemma \ref{lemma-cycles-k-group}
are not isomorphisms if $X$ is not quasi-compact. For example, suppose $X$ is
an infinite disjoint union $X = \coprod_{n \in \mathbf{N}} \mathbf{P}^1_k$
over a field $k$. Let $\mathcal{F}$, resp.\ $\mathcal{G}$ be the coherent
sheaf on $X$ whose restriction to the $n$th summand is equal to the skyscraper
sheaf at $0$ associated to $\mathcal{O}_{\mathbf{P}^1_k, 0}/\mathfrak m_0^n$,
resp.\ $\kappa(0)^{\oplus n}$. The cycle associated to $\mathcal{F}$ is
equal to the cycle associated to $\mathcal{G}$, namely both are equal to
$\sum n[0_n]$ where $0_n \in X$ denotes $0$ on the $n$th component of $X$.
But there seems to be no way to show that
$[\mathcal{F}] = [\mathcal{G}]$ in $K_0(\text{Coh}(X))$ since
any proof we can envision uses infinitely many relations.
\end{remark}

\begin{lemma}
\label{lemma-maps-between-coherent-sheaves}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Let
$$
\xymatrix{
\ldots \ar[r] &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r]^\psi &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r] & \ldots
}
$$
be a complex as in Homology, Equation (\ref{homology-equation-cyclic-complex}).
Assume that
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$.
\item $\dim_\delta(\text{Supp}(H^i(\mathcal{F}, \varphi, \psi))) \leq k$
for $i = 0, 1$.
\end{enumerate}
Then we have
$$
[H^0(\mathcal{F}, \varphi, \psi)]_k
\sim_{rat}
[H^1(\mathcal{F}, \varphi, \psi)]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$. Note that $\{W_j\}$
is a locally finite collection of closed subsets of
$X$ by Lemma \ref{lemma-length-finite}.
For every $j$, let $\xi_j \in W_j$ be the generic point.
Set
$$
f_j = \det\nolimits_{\kappa(\xi_j)}
(\mathcal{F}_{\xi_j}, \varphi_{\xi_j}, \psi_{\xi_j})
\in
R(W_j)^*.
$$
See Definition \ref{definition-periodic-determinant} for notation.
We claim that
$$
- [H^0(\mathcal{F}, \varphi, \psi)]_k + [H^1(\mathcal{F}, \varphi, \psi)]_k
=
\sum (W_j \to X)_*\text{div}(f_j)
$$
If we prove this then the lemma follows.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z]$ in
$
[H^0(\mathcal{F}, \varphi, \psi)]_k - [H^1(\mathcal{F}, \varphi, \psi)]_k
$
is the same as the coefficient $m$ of $[Z]$ in
$
\sum (W_j \to X)_*\text{div}(f_j)
$.
Let $\xi \in Z$ be the generic point.
Consider the local ring $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Denote $\varphi, \psi : M \to M$ the action of $\varphi, \psi$ on
the stalk.
By our choice of $\xi \in Z$ we have $\delta(\xi) = k$
and hence $\dim(M) = 1$.
Finally, the integral closed subschemes
$W_j$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Supp}(M)$.
In each case the element $f_j \in R(W_j)^*$ corresponds to
the element $\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi)$
in $\kappa(\mathfrak q_i)^*$. Hence we see that
$$
n = - e_A(M, \varphi, \psi)
$$
and
$$
m =
\sum
\text{ord}_{A/\mathfrak q_i}
(\det\nolimits_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi))
$$
Thus the result follows from
Proposition \ref{proposition-length-determinant-periodic-complex}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-rational-equivalence-K-group}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Denote $B_k(X)$ the image of the map
$$
K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))
\longrightarrow
K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X)).
$$
There is a commutative diagram
$$
\xymatrix{
K_0\left(\frac{\text{Coh}_{\leq k}(X)}{\text{Coh}_{\leq k - 1}(X)}\right)
\ar[r] \ar[d] &
B_k(X) \ar[d] \ar@{^{(}->}[r] &
K_0\left(\frac{\text{Coh}_{\leq k + 1}(X)}{\text{Coh}_{\leq k - 1}(X)}\right)
\\
Z_k(X) \ar[r] & A_k(X)
}
$$
where the left vertical arrow is the one from
Lemma \ref{lemma-cycles-k-group}. If $X$ is quasi-compact
then both vertical arrows are isomorphisms.
\end{lemma}

\begin{proof}
Suppose we have an element $[A] - [B]$ of
$K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))$
which maps to zero in $B_k(X)$, i.e., in
$K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))$.
Suppose $[A] = [\mathcal{A}]$ and $[B] = [\mathcal{B}]$
for some coherent sheaves $\mathcal{A}, \mathcal{B}$ on
$X$ supported in $\delta$-dimension $\leq k$.
The assumption that $[A] - [B]$ maps to zero in the group
$K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))$
means that there exists coherent sheaves
$\mathcal{A}', \mathcal{B}'$ on $X$ supported in
$\delta$-dimension $\leq k - 1$ such that
$[\mathcal{A} \oplus \mathcal{A}'] - [\mathcal{B} \oplus \mathcal{B}']$
is zero in $K_0(\text{Coh}_{k + 1}(X))$ (use part (1) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}).
By part (2) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
this means there exists a $(2, 1)$-periodic complex
$(\mathcal{F}, \varphi, \psi)$ in the category $\text{Coh}_{\leq k + 1}(X)$
such that
$\mathcal{A} \oplus \mathcal{A}' = H^0(\mathcal{F}, \varphi, \psi)$
and $\mathcal{B} \oplus \mathcal{B}' = H^1(\mathcal{F}, \varphi, \psi)$.
By Lemma \ref{lemma-maps-between-coherent-sheaves}
this implies that
$$
[\mathcal{A} \oplus \mathcal{A}']_k
\sim_{rat}
[\mathcal{B} \oplus \mathcal{B}']_k
$$
This proves that $[A] - [B]$ maps to zero via the composition
$$
K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))
\longrightarrow Z_k(X)
\longrightarrow A_k(X).
$$
In other words this proves the
commutative diagram exists.

\medskip\noindent
Next, assume that $X$ is quasi-compact. By Lemma \ref{lemma-cycles-k-group}
the left vertical arrow is bijective. Hence it suffices to show
any $\alpha \in Z_k(X)$ which is rationally equivalent to zero
maps to zero in $B_k(X)$ via the inverse of the left vertical
arrow composed with the horizontal arrow.
By Lemma \ref{lemma-rational-equivalence-family} we see that
$\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$ for some
closed integral subschemes $W_i \subset X \times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$. Moreover the family
$\{W_i\}$ is finite because $X$ is quasi-compact.
Note that the ideal sheaves
$\mathcal{I}_i, \mathcal{J}_i \subset \mathcal{O}_{W_i}$
of the effective Cartier divisors $(W_i)_0, (W_i)_\infty$
are isomorphic (as $\mathcal{O}_{W_i}$-modules). This is true
because the ideal sheaves of $D_0$ and $D_\infty$ on $\mathbf{P}^1$
are isomorphic and $\mathcal{I}_i, \mathcal{J}_i$ are the pullbacks of
these. (Some details omitted.) Hence we have
short exact sequences
$$
0 \to \mathcal{I}_i \to \mathcal{O}_{W_i} \to \mathcal{O}_{(W_i)_0} \to 0,
\quad
0 \to \mathcal{J}_i \to \mathcal{O}_{W_i} \to \mathcal{O}_{(W_i)_\infty} \to 0
$$
of coherent $\mathcal{O}_{W_i}$-modules.
Also, since $[(W_i)_0]_k = [p_*\mathcal{O}_{(W_i)_0}]_k$ in
$Z_k(X)$ we see that the inverse of the left vertical arrow
maps $[(W_i)_0]_k$ to the element $[p_*\mathcal{O}_{(W_i)_0}]$ in
$K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))$.
Thus we have
\begin{eqnarray*}
\alpha
& = &
\sum \left([(W_i)_0]_k - [(W_i)_\infty]_k\right) \\
& \mapsto &
\sum \left([p_*\mathcal{O}_{(W_i)_0}] - [p_*\mathcal{O}_{(W_i)_\infty}]\right)
\\
& = &
\sum \left([p_*\mathcal{O}_{W_i}] - [p_*\mathcal{I}_i]
- [p_*\mathcal{O}_{W_i}] + [p_*\mathcal{J}_i]\right)
\end{eqnarray*}
in $K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))$.
By what was said above this is zero, and we win.
\end{proof}

\begin{remark}
\label{remark-good-cases-K-A}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Assume $X$ is quasi-compact.
The result of Lemma \ref{lemma-cycles-rational-equivalence-K-group}
in particular gives a map
$$
A_k(X)
\longrightarrow
K_0(\text{Coh}(X)/\text{Coh}_{\leq k - 1}(X)).
$$
We have not been able to find a statement or conjecture in the
literature as to whether this map is should be injective or not.
If $X$ is connected nonsingular, then, using the
isomorphism $K_0(X) = K^0(X)$ (see insert future reference here)
and chern classes (see below), one can show that
the map is an isomorphism up to $(p - 1)!$-torsion where
$p = \dim_\delta(X) - k$.
\end{remark}


















\section{Preparation for the divisor associated to an invertible sheaf}
\label{section-preparation-divisor-sheaf}

\noindent
For the following remarks, see
Divisors, Section \ref{divisors-section-meromorphic-functions}.
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\xi \in X$ be a point.
If $s_\xi, s'_\xi \in \mathcal{L}_\xi$ generate $\mathcal{L}_\xi$
as $\mathcal{O}_{X, \xi}$-module, then there exists a unit
$u \in \mathcal{O}_{X, \xi}^*$ such that $s_\xi = u s'_\xi$.
The stalk of the sheaf of meromorphic sections
$\mathcal{K}_X(\mathcal{L})$ of $\mathcal{L}$
at $x$ is equal to
$\mathcal{K}_{X, x} \otimes_{\mathcal{O}_{X, x}} \mathcal{L}_x$.
Thus the image of any meromorphic section $s$
of $\mathcal{L}$ in the stalk at $x$ can be written as $s = fs_\xi$ with
$f \in \mathcal{K}_{X, x}$. Below we will abbreviate this by
saying $f = s/s_\xi$. Also, if $X$ is integral we have
$\mathcal{K}_{X, x} = R(X)$ is equal to the function field of $X$,
so $s/s_\xi \in R(X)$. If $s$ is a {\it regular} meromorphic
section (see
Divisors, Definition \ref{divisors-definition-regular-meromorphic-section}),
then actually $f \in R(X)^*$. (On an integral scheme a regular
meromorphic section is the same thing as a nonzero meromorphic section.)
Hence the following definition makes sense.

\begin{definition}
\label{definition-order-vanishing-meromorphic}
Let $X$ be a locally Noetherian scheme. Assume $X$ is integral.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{K}_X(\mathcal{L}))$
be a regular meromorphic section of $\mathcal{L}$.
For every integral closed subscheme
$Z \subset X$ of codimension $1$ we define
the {\it order of vanishing of $s$ along $Z$} as the integer
$$
\text{ord}_{Z, \mathcal{L}}(s)
= \text{ord}_{\mathcal{O}_{X, \xi}}(s/s_\xi)
$$
where the right hand side is the notion of
Algebra, Definition \ref{algebra-definition-ord},
$\xi \in Z$ is the generic point,
and $s_\xi \in \mathcal{L}_\xi$ is a generator.
\end{definition}

\begin{lemma}
\label{lemma-divisor-meromorphic-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \mathcal{K}_X(\mathcal{L})$ be a regular (i.e., nonzero)
meromorphic section of $\mathcal{L}$. Then the set
$$
\{Z \subset X \mid Z \text{ is irreducible, closed of codimension }1
\text{ and }\text{ord}_{Z, \mathcal{L}}(s) \not = 0\}
$$
is locally finite in $X$.
\end{lemma}

\begin{proof}
This is true simply because there exists a nonempty open subscheme
$U \subset X$ such that $s$ corresponds to a section of
$\Gamma(U, \mathcal{L})$ which generates $\mathcal{L}$ over $U$.
Hence the codimension $1$
irreducibles which can occur in the set of the lemma are all
irreducible components of $X \setminus U$.
Hence Lemma \ref{lemma-multiplicity-finite} gives the desired result.
\end{proof}

\begin{lemma}
\label{lemma-divisor-meromorphic-well-defined}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s, s' \in \mathcal{K}_X(\mathcal{L})$ be nonzero
meromorphic sections of $\mathcal{L}$. Then $f = s/s'$
is an element of $R(X)^*$ and we have
$$
\sum \text{ord}_{Z, \mathcal{L}}(s)[Z]
=
\sum \text{ord}_{Z, \mathcal{L}}(s')[Z]
+
\text{div}(f)
$$
(where the sums are over integral closed subschemes $Z \subset X$
of $\delta$-dimension $n - 1$) as elements of $Z_{n - 1}(X)$.
\end{lemma}

\begin{proof}
This is clear from the definitions.
Note that Lemma \ref{lemma-divisor-meromorphic-locally-finite}
guarantees that the sums are indeed
elements of $Z_{n - 1}(X)$.
\end{proof}









\section{The divisor associated to an invertible sheaf}
\label{section-divisor-invertible-sheaf}

\noindent
The material above allows us to define the divisor
associated to an invertible sheaf.

\begin{definition}
\label{definition-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any nonzero meromorphic section $s$ of $\mathcal{L}$
we define the {\it Weil divisor associated to $s$} as
$$
\text{div}_\mathcal{L}(s) :=
\sum \text{ord}_{Z, \mathcal{L}}(s) [Z] \in Z_{n - 1}(X)
$$
where the sum is over integral closed subschemes $Z \subset X$
of $\delta$-dimension $n - 1$.
\item We define {\it Weil divisor associated to $\mathcal{L}$}
$$
c_1(\mathcal{L}) \cap [X] =
\text{class of }\text{div}_\mathcal{L}(s) \in A_{n - 1}(X)
$$
where $s$ is any nonzero meromorphic section of $\mathcal{L}$ over
$X$. This is well defined by
Lemma \ref{lemma-divisor-meromorphic-well-defined}.
\end{enumerate}
\end{definition}

\noindent
There are some cases where it is easy to compute the
Weil divisor associated to an invertible sheaf.

\begin{lemma}
\label{lemma-compute-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$ be a nonzero global section.
Then
$$
\text{div}_\mathcal{L}(s) = [Z(s)]_{n - 1}
$$
in $Z_{n - 1}(X)$ and
$$
c_1(\mathcal{L}) \cap [X] = [Z(s)]_{n - 1}
$$
in $A_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n - 1$. Let $\xi \in Z$ be its generic
point. Choose a generator $s_\xi \in \mathcal{L}_\xi$.
Write $s = fs_\xi$ for some $f \in \mathcal{O}_{X, \xi}$.
By definition of $Z(s)$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}
we see that $Z(s)$ is cut out by a quasi-coherent
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$ such
that $\mathcal{I}_\xi = (f)$. Hence
$\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{Z(s), \xi})
=
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{X, \xi}/(f))
=
\text{ord}_{\mathcal{O}_{X, x}}(f)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-c1-additive}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible $\mathcal{O}_X$-modules.
Then
\begin{enumerate}
\item Let $s$, resp.\ $t$ be a nonzero meromorphic section
of $\mathcal{L}$, resp.\ $\mathcal{N}$. Then $st$ is a nonzero
meromorphic section of $\mathcal{L} \otimes \mathcal{N}$, and
$$
\text{div}_{\mathcal{L} \otimes \mathcal{N}}(st)
=
\text{div}_\mathcal{L}(s) + \text{div}_\mathcal{N}(t)
$$
in $Z_{n - 1}(X)$.
\item We have
$$
c_1(\mathcal{L}) \cap [X] + c_1(\mathcal{N}) \cap [X] =
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N}) \cap [X]
$$
in $A_{n - 1}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $s$, resp.\ $t$ be a nonzero meromorphic section
of $\mathcal{L}$, resp.\ $\mathcal{N}$. Then $st$ is a nonzero
meromorphic section of $\mathcal{L} \otimes \mathcal{N}$.
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n - 1$. Let $\xi \in Z$ be its generic
point. Choose generators $s_\xi \in \mathcal{L}_\xi$, and
$t_\xi \in \mathcal{N}_\xi$. Then $s_\xi t_\xi$ is a generator
for $(\mathcal{L} \otimes \mathcal{N})_\xi$.
So $st/(s_\xi t_\xi) = (s/s_\xi)(t/t_\xi)$.
Hence we see that
$$
\text{div}_{\mathcal{L} \otimes \mathcal{N}, Z}(st)
=
\text{div}_{\mathcal{L}, Z}(s) + \text{div}_{\mathcal{N}, Z}(t)
$$
by the additivity of the $\text{ord}_Z$ function.
\end{proof}

\noindent
The following lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-cap-c1}.

\begin{lemma}
\label{lemma-flat-pullback-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_Y$-module.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$. Then
$$
f^*(c_1(\mathcal{L}) \cap [Y]) = c_1(f^*\mathcal{L}) \cap [X]
$$
in $A_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
We will show that actually
$f^*\text{div}_\mathcal{L}(s) = \text{div}_{f^*\mathcal{L}}(f^*s)$
and hence the lemma holds.
To see this let $\xi \in Y$ be a point and let $s_\xi \in \mathcal{L}_\xi$
be a generator. Write $s = gs_\xi$ with $g \in R(X)^*$.
Then there is an open neighbourhood $V \subset Y$ of $\xi$
such that $s_\xi \in \mathcal{L}(V)$ and such that $s_\xi$ generates
$\mathcal{L}|_V$. Hence we see that
$$
\text{div}_\mathcal{L}(s)|_V = \text{div}(g)|_V.
$$
In exactly the same way, since $f^*s_\xi$ generates $\mathcal{L}$
over $f^{-1}(V)$ and since $f^*s = g f^*s_\xi$ we also
have
$$
\text{div}_\mathcal{L}(f^*s)|_{f^{-1}(V)}
=
\text{div}(g)|_{f^{-1}(V)}.
$$
Thus the desired equality of cycles over $f^{-1}(V)$ follows from the
corresponding result for pullbacks of principal divisors, see
Lemma \ref{lemma-flat-pullback-principal-divisor}.
\end{proof}



\section{Intersecting with Cartier divisors}
\label{section-intersecting-with-divisors}

\begin{definition}
\label{definition-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We define, for every integer $k$, an operation
$$
c_1(\mathcal{L}) \cap - :
Z_{k + 1}(X) \to A_k(X)
$$
called {\it intersection with the first chern class of $\mathcal{L}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ with
$\dim_\delta(W) = k + 1$ we define
$$
c_1(\mathcal{L}) \cap [W] = i_*(c_1({i^*\mathcal{L}}) \cap [W])
$$
where the right hand side is defined in
Definition \ref{definition-divisor-invertible-sheaf}.
\item For a general $(k + 1)$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_1(\mathcal{L}) \cap \alpha = \sum n_i c_1(\mathcal{L}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Write each $c_1(\mathcal{L}) \cap W_i = \sum_j n_{i, j} [Z_{i, j}]$
with $\{Z_{i, j}\}_j$ a locally finite sum
of integral closed subschemes of $W_i$. Since $\{W_i\}$ is a locally
finite collection of integral closed subschemes on $X$, it follows
easily that $\{Z_{i, j}\}_{i, j}$ is a locally finite collection
of closed subschemes of $X$. Hence
$c_1(\mathcal{L}) \cap \alpha = \sum n_in_{i, j}[Z_{i, j}]$
is a cycle. Another, more convenient, way to think about this
is to observe that the morphism $\coprod W_i \to X$ is
proper. Hence $c_1(\mathcal{L}) \cap \alpha$ can be viewed
as the pushforward of a class in $A_k(\coprod W_i) = \prod A_k(W_i)$.
This also explains why the result is well defined up to rational
equivalence on $X$.

\medskip\noindent
The main goal for the next few sections is to show that intersecting with
$c_1(\mathcal{L})$ factors through rational equivalence, and is commutative.
This is not a triviality.

\begin{lemma}
\label{lemma-c1-cap-additive}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be an invertible sheaves on $X$.
Then
$$
c_1(\mathcal{L}) \cap \alpha  + c_1(\mathcal{N}) \cap \alpha =
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N}) \cap \alpha
$$
in $A_k(X)$ for every $\alpha \in Z_{k - 1}(X)$. Moreover,
$c_1(\mathcal{O}_X) \cap \alpha = 0$ for all $\alpha$.
\end{lemma}

\begin{proof}
The additivity follows directly from Lemma \ref{lemma-c1-additive}
and the definitions. To see that $c_1(\mathcal{O}_X) \cap \alpha = 0$
consider the section $1 \in \Gamma(X, \mathcal{O}_X)$. This restricts
to an everywhere nonzero section on any integral closed subscheme
$W \subset X$. Hence $c_1(\mathcal{O}_X) \cap [W] = 0$ as desired.
\end{proof}

\noindent
The following lemma is a useful result in order to compute the intersection
product of the $c_1$ of an invertible sheaf and the cycle associated
to a closed subscheme.
Recall that $Z(s) \subset X$ denotes the zero scheme of a global section
$s$ of an invertible sheaf on a scheme $X$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.

\begin{lemma}
\label{lemma-geometric-cap}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $Z \subset X$ be a closed subscheme.
Assume $\dim_\delta(Z) \leq k + 1$.
Let $s \in \Gamma(Z, \mathcal{L}|_Z)$.
Assume
\begin{enumerate}
\item $\dim_\delta(Z(s)) \leq k$, and
\item for every generic point $\xi$ of an irreducible component of
$Z(s)$ of dimension $k$ the multiplication by $s$
induces an injection $\mathcal{O}_{Z, \xi} \to (\mathcal{L}|_Z)_\xi$.
\end{enumerate}
This holds for example if $s$ is a regular section of $\mathcal{L}|_Z$.
Then
$$
[Z(s)]_k = c_1(\mathcal{L}) \cap [Z]_{k + 1}
$$
in $A_k(X)$.
\end{lemma}

\begin{proof}
Write
$$
[Z]_{k + 1} = \sum n_i[W_i]
$$
where $W_i \subset Z$ are the irreducible components of
$Z$ of $\delta$-dimension $k + 1$ and $n_i > 0$.
By assumption the restriction
$s_i = s|_{W_i} \in \Gamma(W_i, \mathcal{L}|_{W_i})$ is not
zero, and hence is a regular section. By Lemma \ref{lemma-compute-c1}
we see that $[Z(s_i)]_k$ represents $c_1(\mathcal{L}|_{W_i})$.
Hence by definition
$$
c_1(\mathcal{L}) \cap [Z]_{k + 1} = \sum n_i[Z(s_i)]_k
$$
In fact, the proof below will show that we have
\begin{equation}
\label{equation-equal-as-cycles}
[Z(s)]_k =  \sum n_i[Z(s_i)]_k
\end{equation}
as $k$-cycles on $X$.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of
$\delta$-dimension $k$. Let $\xi' \in Z'$ be its generic point.
We want to compare the coefficient $n$ of $[Z']$ in the expression
$\sum n_i[Z(s_i)]_k$ with the coefficient $m$ of $[Z']$ in the
expression $[Z(s)]_k$. Choose a generator $s_{\xi'} \in \mathcal{L}_\xi$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal sheaf of $Z$.
Write $A = \mathcal{O}_{X, \xi'}$, $L = \mathcal{L}_{\xi'}$
and $I = \mathcal{I}_{\xi'}$. Then $L = As_{\xi'}$ and
$L/IL = (A/I)s_{\xi'} = (\mathcal{L}|_Z)_{\xi'}$.
Write $s = f s_{\xi'}$ for some (unique) $f \in A/I$.
Hypothesis (2) means that $f : A/I \to A/I$ is injective.
Since $\dim_\delta(Z) \leq k + 1$ and $\dim_\delta(Z') = k$
we have $\dim(A/I) = 0$ or $1$. We have
$$
m = \text{length}_A(A/(f, I))
$$
which is finite in either case.

\medskip\noindent
If $\dim(A/I) = 0$, then $f : A/I \to A/I$ being injective
implies that $f \in (A/I)^*$. Hence in this case $m$ is zero.
Moreover, the condition $\dim(A/I) = 0$ means that $\xi'$
does not lie on any irreducible component of $\delta$-dimension
$k + 1$, i.e., $n = 0$ as well.

\medskip\noindent
Now, let $\dim(A/I) = 1$.
Since $A$ is a Noetherian local ring there are finitely
many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t \supset I$
over $I$. These correspond 1-1 with $W_i$ passing through $\xi'$.
Moreover $n_i = \text{length}_{A_{\mathfrak q_i}}((A/I)_{\mathfrak q_i})$.
Also, the multiplicity of $[Z']$ in $[Z(s_i)]_k$ is
$\text{length}_A(A/(f, \mathfrak q_i))$.
Hence the equation to prove in this case is
$$
\text{length}_A(A/(f, I))
=
\sum \text{length}_{A_{\mathfrak q_i}}((A/I)_{\mathfrak q_i})
\text{length}_A(A/(f, \mathfrak q_i))
$$
which follows from Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_1(\mathcal{L}) \cap \alpha) = c_1(f^*\mathcal{L}) \cap f^*\alpha
$$
in $A_{k + r - 1}(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_i[W_i]$. We claim it suffices to show that
$f^*(c_1(\mathcal{L}) \cap [W_i]) = c_1(f^*\mathcal{L}) \cap f^*[W_i]$
for each $i$. Proof of this claim is omitted.
(Remarks: it is clear in the quasi-compact case.
Something similar happened in the proof of
Lemma \ref{lemma-flat-pullback-rational-equivalence}, and one
can copy the method used there here. Another possibility
is to check the cycles and rational equivalences used
for all $W_i$ combined at each step form a locally finite collection).

\medskip\noindent
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension $k$.
We have to show that
$f^*(c_1(\mathcal{L}) \cap [W]) = c_1(f^*\mathcal{L}) \cap f^*[W]$.
Consider the following fibre product diagram
$$
\xymatrix{
W' = W \times_Y X \ar[r] \ar[d] & X \ar[d] \\
W \ar[r] & Y
}
$$
and let $W'_i \subset W'$ be the irreducible components of
$\delta$-dimension $k + r$. Write
$[W']_{k + r} = \sum n_i[W'_i]$ with $n_i > 0$ as per definition.
So $f^*[W] = \sum n_i[W'_i]$. Choose a nonzero meromorphic section
$s$ of $\mathcal{L}|_W$. Since each $W'_i \to W$ is dominant we
see that $s_i = s|_{W'_i}$ is a nonzero meromorphic section for
each $i$. We claim that we have the following equality of
cycles
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(s_i)
=
f^*\text{div}_{\mathcal{L}|_W}(s)
$$
in $Z_{k + r - 1}(X)$.

\medskip\noindent
Having formulated the problem as an equality of cycles
we may work locally on $Y$. Hence we may assume
$Y$ and also $W$ affine, and $s = p/q$ for some
nonzero sections $p \in \Gamma(W, \mathcal{L})$
and $q \in \Gamma(W, \mathcal{O})$. If we can show both
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(p_i)
=
f^*\text{div}_{\mathcal{L}|_W}(p),
\quad\text{and}\quad
\sum n_i\text{div}_{\mathcal{O}|_{W_i}}(q_i)
=
f^*\text{div}_{\mathcal{O}|_W}(q)
$$
(with obvious notations) then we win by the
additivity, see Lemma \ref{lemma-c1-additive}.
Thus we may assume that $s \in \Gamma(W, \mathcal{L}|_W)$.
In this case we may apply the equality
(\ref{equation-equal-as-cycles}) obtained in the proof of
Lemma \ref{lemma-geometric-cap} to see that
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(s_i)
=
[Z(s')]_{k + r - 1}
$$
where $s' \in f^*\mathcal{L}|_{W'}$ denotes the pullback
of $s$ to $W'$. On the other hand we have
$$
f^*\text{div}_{\mathcal{L}|_W}(s) = f^*[Z(s)]_{k - 1}
= [f^{-1}(Z(s))]_{k + r - 1},
$$
by Lemmas \ref{lemma-compute-c1} and \ref{lemma-pullback-coherent}.
Since $Z(s') = f^{-1}(Z(s))$ we win.
\end{proof}


\begin{lemma}
\label{lemma-equal-c1-as-cycles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a proper morphism.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $s$ be a nonzero meromorphic section $s$ of $\mathcal{L}$ on $Y$.
Assume $X$, $Y$ integral, $f$ dominant, and $\dim_\delta(X) = \dim_\delta(Y)$.
Then
$$
f_*\left(\text{div}_{f^*\mathcal{L}}(f^*s)\right) =
[R(X) : R(Y)]\text{div}_\mathcal{L}(s).
$$
In particular
$$
f_*(c_1(f^*\mathcal{L}) \cap [X]) = c_1(\mathcal{L}) \cap f_*[Y].
$$
\end{lemma}

\begin{proof}
The last equation follows from the first since $f_*[X] = [R(X) : R(Y)][Y]$
by definition. It turns out that we can re-use
Lemma \ref{lemma-proper-pushforward-alteration}
to prove this. Namely, since we are trying to prove an equality
of cycles, we may work locally on $Y$. Hence we may assume
that $\mathcal{L} = \mathcal{O}_Y$. In this case $s$
corresponds to a rational function $g \in R(Y)$, and
we are simply trying to prove
$$
f_*\left(\text{div}_X(g)\right) =
[R(X) : R(Y)]\text{div}_Y(g).
$$
Comparing with the result of the aforementioned
Lemma \ref{lemma-proper-pushforward-alteration}
we see this true since
$\text{Nm}_{R(X)/R(Y)}(g) = g^{[R(X) : R(Y)]}$
as $g \in R(Y)^*$.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha \in Z_{k + 1}(X)$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Then
$$
p_*(c_1(p^*\mathcal{L}) \cap \alpha) = c_1(\mathcal{L}) \cap p_*\alpha
$$
in $A_k(Y)$.
\end{lemma}

\begin{proof}
Suppose that $p$ has the property that for every integral
closed subscheme $W \subset X$ the map $p|_W : W \to Y$
is a closed immersion. Then, by definition of capping
wiht $c_1(\mathcal{L})$ the lemma holds.

\medskip\noindent
We will use this remark to reduce to a special case. Namely,
write $\alpha = \sum n_i[W_i]$ with $n_i \not = 0$ and $W_i$ pairwise
distinct. Let $W'_i \subset Y$ be the image of $W_i$ (as an integral
closed subscheme). Consider the diagram
$$
\xymatrix{
X' = \coprod W_i \ar[r]_-q \ar[d]_{p'} & X \ar[d]^p \\
Y' = \coprod W'_i \ar[r]^-{q'} & Y.
}
$$
Since $\{W_i\}$ is locally finite on $X$, and $p$ is proper
we see that $\{W'_i\}$ is locally finite on $Y$ and that
$q, q', p'$ are also proper morphisms.
We may think of $\sum n_i[W_i]$ also as a $k$-cycle
$\alpha' \in Z_k(X')$. Clearly $q_*\alpha' = \alpha$.
We have
$q_*(c_1(q^*p^*\mathcal{L}) \cap \alpha')
= c_1(p^*\mathcal{L}) \cap q_*\alpha'$
and
$(q')_*(c_1((q')^*\mathcal{L}) \cap p'_*\alpha') =
c_1(\mathcal{L}) \cap q'_*p'_*\alpha'$ by the initial
remark of the proof. Hence it suffices to prove the lemma
for the morphism $p'$ and the cycle $\sum n_i[W_i]$.
Clearly, this means we may assume $X$, $Y$ integral,
$f : X \to Y$ dominant and $\alpha = [X]$.
In this case the result follows from
Lemma \ref{lemma-equal-c1-as-cycles}.
\end{proof}














\section{Cartier divisors and K-groups}
\label{section-cartier-coherent}

\noindent
In this section we describe how the intersection with the
first chern class of an invertible sheaf $\mathcal{L}$
corresponds to tensoring with $\mathcal{L} - \mathcal{O}$
in $K$-groups.

\begin{lemma}
\label{lemma-no-embedded-points}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{K}_X(\mathcal{L}))$ be a
meromorphic section of $\mathcal{L}$.
Assume
\begin{enumerate}
\item $\dim_\delta(X) \leq k + 1$,
\item $X$ has no embedded points,
\item $\mathcal{F}$ has no embedded associated points,
\item the support of $\mathcal{F}$ is $X$, and
\item the section $s$ is regular meromorphic.
\end{enumerate}
In this situation let $\mathcal{I} \subset \mathcal{O}_X$
be the ideal of denominators of $s$, see
Divisors,
Definition \ref{divisors-definition-regular-meromorphic-ideal-denominators}.
Then we have the following:
\begin{enumerate}
\item there are short exact sequences
$$
\begin{matrix}
0 &
\to &
\mathcal{I}\mathcal{F} &
\xrightarrow{1} &
\mathcal{F} &
\to &
\mathcal{Q}_1 &
\to &
0 \\
0 &
\to &
\mathcal{I}\mathcal{F} &
\xrightarrow{s} &
\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L} &
\to &
\mathcal{Q}_2 &
\to &
0
\end{matrix}
$$
\item the coherent sheaves $\mathcal{Q}_1$, $\mathcal{Q}_2$
are supported in $\delta$-dimension $\leq k$,
\item the section $s$ restricts to a regular meromorphic
section $s_i$ on every irreducible component $X_i$ of
$X$ of $\delta$-dimension $k + 1$, and
\item writing $[\mathcal{F}]_{k + 1} = \sum m_i[X_i]$ we have
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
\sum m_i(X_i \to X)_*\text{div}_{\mathcal{L}|_{X_i}}(s_i)
$$
in $Z_k(X)$, in particular
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}
$$
in $A_k(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Recall from Divisors, Lemma \ref{divisors-lemma-make-maps-regular-section}
the existence of injective maps
$1 : \mathcal{I}\mathcal{F} \to \mathcal{F}$ and
$s : \mathcal{I}\mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X}\mathcal{L}$
whose cokernels are supported on a closed nowhere dense subsets $T$.
Denote $\mathcal{Q}_i$ there cokernels as in the lemma.
We conclude that $\dim_\delta(\text{Supp}(\mathcal{Q}_i)) \leq k$.
By Divisors, Lemmas \ref{divisors-lemma-pullback-meromorphic-sections-defined}
and \ref{divisors-lemma-meromorphic-sections-pullback} the pullbacks $s_i$
are defined and are regular meromorphic sections for $\mathcal{L}|_{X_i}$.
The equality of cycles in (4) implies the equality of cycle classes
in (4). Hence the only remaining thing to show is that
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
\sum m_i(X_i \to X)_*\text{div}_{\mathcal{L}|_{X_i}}(s_i)
$$
holds in $Z_k(X)$. To see this, let $Z \subset X$ be an integral closed
subscheme of $\delta$-dimension $k$. Let $\xi \in Z$ be the generic point.
Let $A = \mathcal{O}_{X, \xi}$ and $M = \mathcal{F}_\xi$.
Moreover, choose a generator $s_\xi \in \mathcal{L}_\xi$.
Then we can write $s = (a/b) s_\xi$ where $a, b \in A$ are
nonzerodivisors. In this case
$I = \mathcal{I}_\xi = \{x \in A \mid x(a/b) \in A\}$.
In this case the coefficient of $[Z]$ in the left hand side is
$$
\text{length}_A(M/(a/b)IM) - \text{length}_A(M/IM)
$$
and the coefficient of $[Z]$ in the right hand side
is
$$
\sum
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(a/b)
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the minimal
primes of the $1$-dimensional local ring $A$. Hence the result
follows from Lemma \ref{lemma-no-embedded-points-modules}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Assume $\dim_\delta(\text{Support}(\mathcal{F})) \leq k + 1$.
Then the element
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
\in
K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))
$$
lies in the subgroup $B_k(X)$ of
Lemma \ref{lemma-cycles-rational-equivalence-K-group} and maps to
the element $c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}$ via
the map $B_k(X) \to A_k(X)$.
\end{lemma}

\begin{proof}
Let
$$
0 \to \mathcal{K} \to \mathcal{F} \to \mathcal{F}' \to 0
$$
be the short exact sequence constructed in
Divisors, Lemma \ref{divisors-lemma-remove-embedded-points}.
This in particular means that $\mathcal{F}'$ has no embedded
associated points.
Since the support of $\mathcal{K}$ is nowhere dense in the
support of $\mathcal{F}$ we see that
$\dim_\delta(\text{Supp}(\mathcal{K})) \leq k$. We may
re-apply
Divisors, Lemma \ref{divisors-lemma-remove-embedded-points}
starting with $\mathcal{K}$ to get a short exact sequence
$$
0 \to \mathcal{K}'' \to \mathcal{K} \to \mathcal{K}' \to 0
$$
where now $\dim_\delta(\text{Supp}(\mathcal{K}'')) < k$
and $\mathcal{K}'$ has no embedded associated points.
Suppose we can prove the lemma for the coherent sheaves
$\mathcal{F}'$ and $\mathcal{K}'$. Then we see
from the equations
$$
[\mathcal{F}]_{k + 1}
=
[\mathcal{F}']_{k + 1}
+ [\mathcal{K}']_{k + 1}
+ [\mathcal{K}'']_{k + 1}
$$
(use Lemma \ref{lemma-additivity-sheaf-cycle}),
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
=
[\mathcal{F}' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}']
+
[\mathcal{K}' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{K}']
+
[\mathcal{K}'' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{K}'']
$$
(use the $\otimes \mathcal{L}$ is exact)
and the trivial vanishing of $[\mathcal{K}'']_{k + 1}$ and
$[\mathcal{K}'' \otimes_{\mathcal{O}_X} \mathcal{L}]
- [\mathcal{K}'']$ in
$K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))$
that the result holds
for $\mathcal{F}$. What this means is that we may assume that
the sheaf $\mathcal{F}$ has no embedded associated points.

\medskip\noindent
Assume $X$, $\mathcal{F}$ as in the lemma, and assume in addition
that $\mathcal{F}$ has no embedded associated points. Consider the
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$, the corresponding
closed subscheme $i : Z \to X$ and the coherent $\mathcal{O}_Z$-module
$\mathcal{G}$ constructed in
Divisors, Lemma \ref{divisors-lemma-no-embedded-points-endos}.
Recall that $Z$ is a locally Noetherian scheme without embedded points,
$\mathcal{G}$ is a coherent sheaf without embedded
associated points, with $\text{Supp}(\mathcal{G}) = Z$
and such that $i_*\mathcal{G} = \mathcal{F}$.
Moreover, set $\mathcal{N} = \mathcal{L}|_Z$.

\medskip\noindent
By Divisors, Lemma \ref{divisors-lemma-regular-meromorphic-section-exists}
the invertible sheaf $\mathcal{N}$ has a regular meromorphic section $s$
over $Z$. Let us denote $\mathcal{J} \subset \mathcal{O}_Z$ the sheaf
of denominators of $s$. By Lemma \ref{lemma-no-embedded-points}
there exist short exact sequences
$$
\begin{matrix}
0 &
\to &
\mathcal{J}\mathcal{G} &
\xrightarrow{1} &
\mathcal{G} &
\to &
\mathcal{Q}_1 &
\to &
0 \\
0 &
\to &
\mathcal{J}\mathcal{G} &
\xrightarrow{s} &
\mathcal{G} \otimes_{\mathcal{O}_Z} \mathcal{N} &
\to &
\mathcal{Q}_2 &
\to &
0
\end{matrix}
$$
such that $\dim_\delta(\text{Supp}(\mathcal{Q}_i)) \leq k$ and
such that the cycle
$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
$
is a representative of $c_1(\mathcal{N}) \cap [\mathcal{G}]_{k + 1}$.
We see (using the fact that
$i_*(\mathcal{G} \otimes \mathcal{N}) = \mathcal{F} \otimes \mathcal{L}$
by the projection formula, see
Cohomology, Lemma \ref{cohomology-lemma-projection-formula})
that
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
=
[i_*\mathcal{Q}_2] - [i_*\mathcal{Q}_1]
$$
in $K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))$.
This already shows that
$[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}] - [\mathcal{F}]$
is an element of $B_k(X)$. Moreover we have
\begin{eqnarray*}
\empty [i_*\mathcal{Q}_2]_k - [i_*\mathcal{Q}_1]_k
& = &
i_*\left( [\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k \right) \\
& = &
i_*\left(c_1(\mathcal{N}) \cap [\mathcal{G}]_{k + 1} \right) \\
& = &
c_1(\mathcal{L}) \cap i_*[\mathcal{G}]_{k + 1} \\
& = &
c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}
\end{eqnarray*}
by the above and Lemmas \ref{lemma-pushforward-cap-c1}
and \ref{lemma-cycle-push-sheaf}. And this agree with the
image of the element under $B_k(X) \to A_k(X)$ by definition.
Hence the lemma is proved.
\end{proof}



















\section{Blowing up lemmas}
\label{section-blowing-up-lemmas}

\noindent
In this section we prove some lemmas on representing
Cartier divisors by suitable effective Cartier divisors
on blow-ups. These lemmas can be found in \cite[Section 2.4]{F}.
We have adapted the formulation so they also work
in the non-finite type setting. It may happen that the morphism $b$
of Lemma \ref{lemma-blowing-up-intersections} is a composition of
infinitely many blow ups, but over any given quasi-compact open
$W \subset X$ one needs only finitely many blow-ups
(and this is the result of loc.\ cit.).

\begin{lemma}
\label{lemma-push-pull-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a proper morphism.
Let $D \subset Y$ be an effective Cartier divisor.
Assume $X$, $Y$ integral, $n = \dim_\delta(X) = \dim_\delta(Y)$ and
$f$ dominant. Then
$$
f_*[f^{-1}(D)]_{n - 1} = [R(X) : R(Y)] [D]_{n - 1}.
$$
In particular if $f$ is birational then $f_*[f^{-1}(D)]_{n - 1} = [D]_{n - 1}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-equal-c1-as-cycles}
and the fact that $D$ is the zero
scheme of the canonical section $1_D$ of $\mathcal{O}_X(D)$.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-denominators}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral with $\dim_\delta(X) = n$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
Let $U \subset X$ be the maximal open subscheme such that
$s$ corresponds to a section of $\mathcal{L}$ over $U$.
There exists a projective morphism
$$
\pi : X' \longrightarrow X
$$
such that
\begin{enumerate}
\item $X'$ is integral,
\item $\pi|_{\pi^{-1}(U)} : \pi^{-1}(U) \to U$ is an isomorphism,
\item there exist effective Cartier divisors $D, E \subset X'$
such that
$$
\pi^*\mathcal{L} = \mathcal{O}_{X'}(D - E),
$$
\item the meromorphic section $s$ corresponds, via the isomorphism above,
to the meromorphic section $1_D \otimes (1_E)^{-1}$ (see
Divisors, Definition
\ref{divisors-definition-invertible-sheaf-effective-Cartier-divisor}),
\item we have
$$
\pi_*([D]_{n - 1} - [E]_{n - 1}) = \text{div}_\mathcal{L}(s)
$$
in $Z_{n - 1}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent ideal sheaf
of denominators of $s$. Namely, we declare a local section
$f$ of $\mathcal{O}_X$ to be a local section of $\mathcal{I}$
if and only if $fs$ is a local section of $\mathcal{L}$.
On any affine open $U = \Spec(A)$
of $X$ write $\mathcal{L}|_U = \widetilde{L}$ for some invertible
$A$-module $L$. Then $A$ is a Noetherian domain with fraction field
$K = R(X)$ and we may think of $s|_U$ as an element of
$L \otimes_A K$ (see
Divisors, Lemma \ref{divisors-lemma-locally-Noetherian-K}).
Let $I = \{x \in A \mid xs \in L\}$. Then we see that
$\mathcal{I}|_U = \widetilde{I}$ (details omitted) and hence
$\mathcal{I}$ is quasi-coherent.

\medskip\noindent
Consider the closed subscheme $Z \subset X$ defined by $\mathcal{I}$.
It is clear that $U = X \setminus Z$. This suggests we should blow
up $Z$. Let
$$
\pi : X' =
\underline{\text{Proj}}_X
\left(\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n\right)
\longrightarrow
X
$$
be the blowing up of $X$ along $Z$. The quasi-coherent
sheaf of $\mathcal{O}_X$-algebras
$\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n$
is generated in degree $1$ over $\mathcal{O}_X$.
Moreover, the degree $1$ part is a coherent $\mathcal{O}_X$-module,
in particular of finite type. Hence we see that $\pi$
is projective and $\mathcal{O}_{X'}(1)$ is relatively very ample.

\medskip\noindent
By Divisors, Lemma \ref{divisors-lemma-blow-up-integral-scheme}
we have $X'$ is integral. By
Divisors, Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
there exists an effective Cartier divisor $E \subset X'$ such that
$\pi^{-1}\mathcal{I} \cdot \mathcal{O}_{X'} = \mathcal{I}_E$.
Also, by the same lemma we see that $\pi^{-1}(U) \cong U$.

\medskip\noindent
Denote $s'$ the pullback of the meromorphic section $s$ to a meromorphic
section of $\mathcal{L}' = \pi^*\mathcal{L}$ over $X'$.
It follows from the fact that $\mathcal{I}s \subset \mathcal{L}$
that $\mathcal{I}_Es' \subset \mathcal{L}'$. In other words,
$s'$ gives rise to an $\mathcal{O}_{X'}$-linear map
$\mathcal{I}_E \to \mathcal{L}'$, or in other words
a section $t \in \mathcal{L}' \otimes \mathcal{O}_{X'}(E)$.
By Divisors, Lemma \ref{divisors-lemma-characterize-OD} we obtain a unique
effective Cartier divisor $D \subset X'$ such that
$\mathcal{L}' \otimes \mathcal{O}_{X'}(E) \cong \mathcal{O}_{X'}(D)$
with $t$ corresponding to $1_D$. Reversing this procedure
we conclude that
$\mathcal{L}' = \mathcal{O}_{X'}(-E) \cong \mathcal{O}_{X'}(D)$
with $s'$ corresponding to $1_D \otimes 1_E^{-1}$ as in (4).

\medskip\noindent
We still have to prove (5).
By Lemma \ref{lemma-equal-c1-as-cycles} we have
$$
\pi_*(\text{div}_{\mathcal{L}'}(s')) = \text{div}_\mathcal{L}(s).
$$
Hence it suffices to show that
$\text{div}_{\mathcal{L}'}(s') = [D]_{n - 1} - [E]_{n - 1}$.
This follows from the equality
$s' = 1_D \otimes 1_E^{-1}$ and additivity, see
Lemma \ref{lemma-c1-additive}.
\end{proof}

\begin{definition}
\label{definition-epsilon}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = n - 1$. The {\it $\epsilon$-invariant}
of this situation is
$$
\epsilon_Z(D_1, D_2) = n_Z \cdot m_Z
$$
where $n_Z$, resp.\ $m_Z$ is the coefficient of
$Z$ in the $(n - 1)$-cycle $[D_1]_{n - 1}$, resp.\ $[D_2]_{n - 1}$.
\end{definition}

\begin{lemma}
\label{lemma-two-divisors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z$ be an open and closed subscheme of the scheme $D_1 \cap D_2$.
Assume $\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Then there exists a morphism
$b : X' \to X$, and Cartier divisors
$D_1', D_2', E$ on $X'$ with the following properties
\begin{enumerate}
\item $X'$ is integral,
\item $b$ is projective,
\item $b$ is the blow up of $X$ in the closed subscheme $Z$,
\item $E = b^{-1}(Z)$,
\item $b^{-1}(D_1) = D'_1 + E$, and $b^{-1}D_2 = D_2' + E$,
\item $\dim_\delta(D'_1 \cap D'_2) \leq n - 2$, and if
$Z = D_1 \cap D_2$ then $D'_1 \cap D'_2 = \emptyset$,
\item for every integral closed subscheme $W'$
with $\dim_\delta(W') = n - 1$ we have
\begin{enumerate}
\item if $\epsilon_{W'}(D'_1, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_1, E) < \epsilon_W(D_1, D_2),
$$
\item if $\epsilon_{W'}(D'_2, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_2, E) < \epsilon_W(D_1, D_2),
$$
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the quasi-coherent ideal sheaf
$\mathcal{I} = \mathcal{I}_{D_1} + \mathcal{I}_{D_2}$
defines the scheme theoretic intersection $D_1 \cap D_2 \subset X$.
Since $Z$ is a union of connected components of $D_1 \cap D_2$
we see that for every $z \in Z$ the kernel of
$\mathcal{O}_{X, z} \to \mathcal{O}_{Z, z}$ is equal to $\mathcal{I}_z$.
Let $b : X' \to X$ be the blow up of $X$ in $Z$. (So Zariski locally
around $Z$ it is the blow up of $X$ in $\mathcal{I}$.)
Denote $E = b^{-1}(Z)$ the corresponding effective Cartier divisor, see
Divisors,
Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
Since $Z \subset D_1$ we have $E \subset f^{-1}(D_1)$ and hence
$D_1 = D_1' + E$ for some effective Cartier divisor $D'_1 \subset X'$,
see Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}.
Similarly $D_2 = D_2' + E$. This takes care of assertions (1) -- (5).

\medskip\noindent
Note that if $W'$ is as in (7) (a) or (7) (b), then the image $W$
of $W'$ is contained in $D_1 \cap D_2$. If $W$ is not contained in
$Z$, then $b$ is an isomorphism at the generic point of $W$ and
we see that $\dim_\delta(W) = \dim_\delta(W') = n - 1$ which
contradicts the assumption that
$\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Hence $W \subset Z$. This means that
to prove (6) and (7) we may work locally around $Z$ on $X$.

\medskip\noindent
Thus we may assume that $X = \Spec(A)$ with
$A$ a Noetherian domain, and $D_1 = \Spec(A/a)$,
$D_2 = \Spec(A/b)$ and $Z = D_1 \cap D_2$.
Set $I = (a, b)$. Since $A$ is a domain and $a, b \not = 0$ we can
cover the blow up by two patches, namely
$U = \Spec(A[s]/(as - b))$ and $V = \Spec(A[t]/(bt -a))$.
These patches are glued using the isomorphism
$A[s, s^{-1}]/(as - b) \cong A[t, t^{-1}]/(bt - a)$
which maps $s$ to $t^{-1}$.
The effective Cartier divisor $E$ is described by
$\Spec(A[s]/(as - b, a)) \subset U$ and
$\Spec(A[t]/(bt - a, b)) \subset V$.
The closed subscheme $D'_1$ corresponds to
$\Spec(A[t]/(bt - a, t)) \subset U$.
The closed subscheme $D'_2$ corresponds to
$\Spec(A[s]/(as -b, s)) \subset V$.
Since ``$ts = 1$'' we see that $D'_1 \cap D'_2 = \emptyset$.

\medskip\noindent
Suppose we have a prime $\mathfrak q \subset A[s]/(as - b)$
of height one with $s, a \in \mathfrak q$.
Let $\mathfrak p \subset A$ be the corresponding prime of $A$.
Observe that $a, b \in \mathfrak p$.
By the dimension formula we see that $\dim(A_{\mathfrak p}) = 1$
as well. The final assertion to be shown is that
$$
\text{ord}_{A_{\mathfrak p}}(a)
\;
\text{ord}_{A_{\mathfrak p}}(b)
>
\text{ord}_{B_{\mathfrak q}}(a)
\;
\text{ord}_{B_{\mathfrak q}}(s)
$$
where $B = A[s]/(as - b)$. By
Algebra, Lemma \ref{algebra-lemma-quasi-finite-extension-dim-1}
we have $\text{ord}_{A_{\mathfrak p}}(x) \geq \text{ord}_{B_{\mathfrak q}}(x)$
for $x = a, b$. Since $\text{ord}_{B_{\mathfrak q}}(s) > 0$ we win
by additivity of the $\text{ord}$ function and the fact that
$as = b$.
\end{proof}

\begin{definition}
\label{definition-locally-finite-sum-effective-Cartier-divisors}
Let $X$ be a scheme.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$.
Suppose given a function
$I \to \mathbf{Z}_{\geq 0}$, $i \mapsto n_i$.
The {\it sum of the effective Cartier divisors}
$D = \sum n_i D_i$, is the unique effective Cartier divisor
$D \subset X$ such that on any quasi-compact open $U \subset X$
we have $D|_U = \sum_{D_i \cap U \not = \emptyset} n_iD_i|_U$
is the sum as in Divisors,
Definition \ref{divisors-definition-sum-effective-Cartier-divisors}.
\end{definition}

\begin{lemma}
\label{lemma-sum-divisors-associated-Weil}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$.
Suppose given $n_i \geq 0$ for $i \in I$.
Then
$$
[D]_{n - 1} = \sum\nolimits_i n_i[D_i]_{n - 1}
$$
in $Z_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Since we are proving an equality of cycles we may work locally on $X$.
Hence this reduces to a finite sum, and by induction to a sum of
two effective Cartier divisors $D = D_1 + D_2$.
By Lemma \ref{lemma-compute-c1} we see that
$D_1 = \text{div}_{\mathcal{O}_X(D_1)}(1_{D_1})$ where
$1_{D_1}$ denotes the canonical section of $\mathcal{O}_X(D_1)$.
Of course we have the same statement for $D_2$ and $D$.
Since $1_D = 1_{D_1} \otimes 1_{D_2}$ via the identification
$\mathcal{O}_X(D) = \mathcal{O}_X(D_1) \otimes \mathcal{O}_X(D_2)$
we win by Lemma \ref{lemma-c1-additive}.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-intersections}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = d$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection of
effective Cartier divisors on $X$.
Assume that for all $\{i, j, k\} \subset I$, $\#\{i, j, k\} = 3$
we have $D_i \cap D_j \cap D_k = \emptyset$.
Then there exist
\begin{enumerate}
\item an open subscheme $U \subset X$ with
$\dim_\delta(X \setminus U) \leq d - 3$,
\item a morphism $b : U' \to U$, and
\item effective Cartier divisors $\{D'_j\}_{j \in J}$ on $U'$
\end{enumerate}
with the following properties:
\begin{enumerate}
\item $b$ is proper morphism $b : U' \to U$,
\item $U'$ is integral,
\item $b$ is an isomorphism over the complement of the union of the pairwise
intersections of the $D_i|_U$,
\item $\{D'_j\}_{j \in J}$ is a locally finite collection of effective
Cartier divisors on $U'$,
\item $\dim_\delta(D'_j \cap D'_{j'}) \leq d - 2$ if $j \not = j'$, and
\item $b^{-1}(D_i|_U) = \sum n_{ij} D'_j$ for certain $n_{ij} \geq 0$.
\end{enumerate}
Moreover, if $X$ is quasi-compact, then we may assume $U = X$ in the above.
\end{lemma}

\begin{proof}
Let us first prove this in the quasi-compact case, since it is perhaps
the most interesting case. In this case we produce inductively a sequence
of blowups
$$
X = X_0 \xleftarrow{b_0} X_1 \xleftarrow{b_1} X_2 \leftarrow \ldots
$$
and finite sets of effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \coprod P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$. Finally, we will have
$$
b_n^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$
We conclude that for each $n \geq 0$ we have
$(b_0 \circ \ldots \circ b_n)^{-1}(D_i)$ is a nonnegative
integer combination of the divisors $D_{n + 1, j}$, $j \in I_{n + 1}$.

\medskip\noindent
To start the induction we set $X_0 = X$ and
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\}_{i \in I_n})$ let $X_{n + 1}$ be the
blow up of $X_n$ in the closed subscheme
$Z_n = \bigcup_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Note that the closed subschemes $D_{n, i} \cap D_{n, i'}$ are pairwise
disjoint by our assumption on triple intersections.
In other words we may write
$Z_n = \coprod_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Moreover, in a Zariski neighbourhood of $D_{n, i} \cap D_{n, i'}$ the
morphism $b_n$ is equal to the blow up of the scheme $X_n$
in the closed subscheme $D_{n, i} \cap D_{n, i'}$, and the results
of Lemma \ref{lemma-two-divisors} apply.
Hence setting $D_{n + 1, \{i, i'\}} = b_n^{-1}(D_i \cap D_{i'})$
we get an effective Cartier divisor.
The Cartier divisors $D_{n + 1, \{i, i'\}}$ are pairwise disjoint.
Clearly we have
$b_n^{-1}(D_{n, i}) \supset D_{n + 1, \{i, i'\}}$ for
every $i' \in I_n$, $i' \not = i$. Hence, applying
Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}
we see that indeed $b^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$
for some effective Cartier divisor $D_{n + 1, i}$ on $X_{n + 1}$.
In a neighbourhood of $D_{n + 1, \{i, i'\}}$ these divisors
$D_{n + 1, i}$ play the role of the primed divisors of
Lemma \ref{lemma-two-divisors}. In particular we conclude that
$D_{n + 1, i} \cap D_{n + 1, i'} = \emptyset$ if $i \not = i'$,
$i, i' \in I_n$ by part (6) of Lemma \ref{lemma-two-divisors}.
This already implies that triple intersections
of the divisors $D_{n + 1, i}$ are zero.

\medskip\noindent
OK, and at this point we can use the quasi-compactness of $X$
to conclude that the invariant
\begin{equation}
\label{equation-invariant}
\epsilon(X, \{D_i\}_{i \in I}) =
\max\{\epsilon_Z(D_i, D_{i'}) \mid
Z \subset X,
\dim_\delta(Z) = d - 1,
\{i, i'\} \in P(I)\}
\end{equation}
is finite, since after all each $D_i$ has at most finitely many irreducible
components. We claim that for some $n$ the invariant
$\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ is zero. Namely, if not then
by Lemma \ref{lemma-two-divisors} we have a strictly decreasing sequence
$$
\epsilon(X, \{D_i\}_{i \in I})
=
\epsilon(X_0, \{D_{0, i}\}_{i \in I_0})
>
\epsilon(X_1, \{D_{1, i}\}_{i \in I_1})
>
\ldots
$$
of positive integers which is a contradiction. Take $n$ with
invariant $\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ equal to zero.
This means that there is no integral closed subscheme $Z \subset X_n$
and no pair of indices $i, i' \in I_n$
such that $\epsilon_Z(D_{n, i}, D_{n, i'}) > 0$.
In other words, $\dim_\delta(D_{n, i}, D_{n, i'}) \leq d - 2$ for
all pairs $\{i, i'\} \in P(I_n)$ as desired.

\medskip\noindent
Next, we come to the general case where we no longer assume that
the scheme $X$ is quasi-compact. The problem with the idea from
the first part of the proof is that we may get and infinite sequence
of blow ups with centers dominating a fixed point of $X$. In order to
avoid this we cut out suitable closed subsets of codimension $\geq 3$
at each stage. Namely, we will construct by induction
a sequence of morphisms having the following shape
$$
\xymatrix{
X = X_0 \\
U_0 \ar[u]^{j_0} & X_1 \ar[l]_{b_0} \\
 & U_1 \ar[u]^{j_1} & X_2 \ar[l]_{b_1} \\
 & & U_2 \ar[u]^{j_2} & X_3 \ar[l]_{b_2}
}
$$
Each of the morphisms $j_n : U_n \to X_n$ will be an open immersion.
Each of the morphisms $b_n : X_{n + 1} \to U_n$ will be a proper birational
morphism of integral schemes. As in the quasi-compact case we will have
effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$ on $X_n$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \coprod P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$.
Finally, we will arrange it so that
$$
b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$

\medskip\noindent
We start the induction by setting $X_0 = X$,
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\})$ we construct the open subscheme
$U_n$ as follows. For each pair $\{i, i'\} \in P(I_n)$ consider
the closed subscheme $D_{n, i} \cap D_{n, i'}$. This has ``good''
irreducible components which have $\delta$-dimension $d - 2$ and
``bad'' irreducible components which have $\delta$-dimension $d - 1$.
Let us set
$$
\text{Bad}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 1} W
$$
and similarly
$$
\text{Good}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 2} W.
$$
Then $D_{n, i} \cap D_{n, i'} = \text{Bad}(i, i') \cup \text{Good}(i, i')$
and moreover we have
$\dim_\delta(\text{Bad}(i, i') \cap \text{Good}(i, i')) \leq d - 3$.
Here is our choice of $U_n$:
$$
U_n
=
X_n
\setminus
\bigcup\nolimits_{\{i, i'\} \in P(I_n)}
\text{Bad}(i, i') \cap \text{Good}(i, i').
$$
By our condition on triple intersections of the divisors $D_{n, i}$
we see that the union is actually a disjoint union. Moreover,
we see that (as a scheme)
$$
D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}
=
Z_{n, i, i'} \coprod G_{n, i, i'}
$$
where $Z_{n, i, i'}$ is $\delta$-equidimension of dimension $d - 1$
and $G_{n, i, i'}$ is $\delta$-equidimensional of dimension $d - 2$.
(So topologically $Z_{n, i, i'}$ is the union of the bad components
but throw out intersections with good components.) Finally we set
$$
Z_n =
\bigcup\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'} =
\coprod\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'},
$$
and we let $b_n : X_{n + 1} \to X_n$ be the blow up in $Z_n$.
Note that Lemma \ref{lemma-two-divisors}
applies to the morphism $b_n : X_{n + 1} \to X_n$ locally around
each of the loci $D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}$. Hence,
exactly as in the first part of the proof we obtain effective
Cartier divisors $D_{n + 1, \{i, i'\}}$ for $\{i, i'\} \in P(I_n)$
and effective Cartier divisors $D_{n + 1, i}$ for $i \in I_n$
such that
$b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$.
For each $n$ denote $\pi_n : X_n \to X$ the morphism obtained
as the composition $j_0 \circ \ldots \circ j_{n - 1} \circ b_{n - 1}$.

\medskip\noindent
{\bf Claim:} given any quasi-compact open $V \subset X$
for all sufficiently large $n$ the maps
$$
\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V) \leftarrow \ldots
$$
are all isomorphisms. Namely, if the map
$\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V)$ is not an isomorphism,
then $Z_{n, i, i'} \cap \pi_n^{-1}(V) \not = \emptyset$ for some
$\{i, i'\} \in P(I_n)$. Hence there exists an irreducible component
$W \subset D_{n, i} \cap D_{n, i'}$ with $\dim_\delta(W) = d - 1$.
In particular we see that $\epsilon_W(D_{n, i}, D_{n, i'}) > 0$.
Applying Lemma \ref{lemma-two-divisors} repeatedly we see that
$$
\epsilon_W(D_{n, i}, D_{n, i'})
<
\epsilon(V, \{D_i|_V\}) - n
$$
with $\epsilon(V, \{D_i|_V\})$ as in (\ref{equation-invariant}).
Since $V$ is quasi-compact, we have
$\epsilon(V, \{D_i|_V\}) < \infty$ and taking $n > \epsilon(V, \{D_i|_V\})$
we see the result.

\medskip\noindent
Note that by construction the difference $X_n \setminus U_n$
has $\dim_\delta(X_n \setminus U_n) \leq d - 3$.
Let $T_n = \pi_n(X_n \setminus U_n)$ be its image in $X$.
Traversing in the diagram of maps above using each $b_n$ is closed
it follows that $T_0 \cup \ldots \cup T_n$ is a closed subset of $X$
for each $n$. Any $t \in T_n$ satisfies $\delta(t) \leq d - 3$
by construction. Hence $\overline{T_n} \subset X$ is a closed subset
with $\dim_\delta(T_n) \leq d - 3$. By the claim above we see
that for any quasi-compact open $V \subset X$ we have
$T_n \cap V \not = \emptyset$ for at most finitely many $n$.
Hence $\{\overline{T_n}\}_{n \geq 0}$ is a locally finite
collection of closed subsets, and we may set
$U = X \setminus \bigcup \overline{T_n}$. This will be
$U$ as in the lemma.

\medskip\noindent
Note that $U_n \cap \pi_n^{-1}(U) = \pi_n^{-1}(U)$ by construction
of $U$. Hence all the morphisms
$$
b_n : \pi_{n + 1}^{-1}(U) \longrightarrow \pi_n^{-1}(U)
$$
are proper. Moreover, by the claim they eventually become isomorphisms
over each quasi-compact open of $X$. Hence we can define
$$
U' = \lim_n \pi_n^{-1}(U).
$$
The induced morphism $b : U' \to U$ is proper since this is local
on $U$, and over each compact open the limit stabilizes. Similarly
we set $J = \bigcup_{n \geq 0} I_n$ using the inclusions
$I_n \to I_{n + 1}$ from the construction. For $j \in J$ choose
an $n_0$ such that $j$ corresponds to $i \in I_{n_0}$ and define
$D'_j = \lim_{n \geq n_0} D_{n, i}$. Again this makes sense
as locally over $X$ the morphisms stabilize.
The other claims of the lemma are verified as in the case
of a quasi-compact $X$.
\end{proof}







\section{Intersecting with effective Cartier divisors}
\label{section-intersecting-effective-Cartier}

\noindent
To be able to prove the commutativity of intersection
products we need a little more precision in terms of
supports of the cycles. Here is the relevant notion.

\begin{definition}
\label{definition-gysin-homomorphism}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $D$ be an effective Cartier divisor on $X$, and
denote $i : D \to X$ the closed immersion.
We define, for every integer $k$, a
{\it Gysin homomorphism}
$$
i^* : Z_{k + 1}(X) \to A_k(D).
$$
\begin{enumerate}
\item Given a integral closed subscheme $W \subset X$ with
$\dim_\delta(W) = k + 1$ we define
\begin{enumerate}
\item if $W \not \subset D$, then $i^*[W] = [D \cap W]_k$ as a
$k$-cycle on $D$, and
\item if $W \subset D$, then
$i^*[W] = i'_*(c_1(\mathcal{O}_X(D)|_W) \cap [W])$,
where $i' : W \to D$ is the induced closed immersion.
\end{enumerate}
\item For a general $(k + 1)$-cycle $\alpha = \sum n_j[W_j]$
we set
$$
i^*\alpha = \sum n_j i^*[W_j]
$$
\item We denote $D \cdot \alpha = i_*i^*\alpha$ the pushforward of
the class to a class on $X$.
\end{enumerate}
\end{definition}

\noindent
In fact, as we will see later, this Gysin homomorphism $i^*$ can be viewed
as an example of a non-flat pullback. Thus we will sometimes informally
call the class $i^*\alpha$ the {\it pullback} of the class $\alpha$.

\begin{lemma}
\label{lemma-support-cap-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $D$ be an effective Cartier divisor on $X$.
Let $\alpha$ be a $(k + 1)$-cycle on $X$.
Then $D \cdot \alpha = c_1(\mathcal{O}_X(D)) \cap \alpha$
in $A_k(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_j[W_j]$ where $i_j : W_j \to X$ are integral closed
subschemes with $\dim_\delta(W_j) = k$.
Since $D$ is the zero scheme of the canonical section $1_D$ of
$\mathcal{O}_X(D)$ we see that $D \cap W_j$ is the zero scheme
of the restriction $1_D|_{W_j}$. Hence for each $j$ such that
$W_j \not \subset D$ we have
$c_1(\mathcal{O}_X(D)) \cap [W_j] = [D \cap W_j]_k$
by Lemma \ref{lemma-geometric-cap}. So we have
$$
c_1(\mathcal{O}_X(D)) \cap \alpha
=
\sum\nolimits_{W_j \not \subset D} n_j[D \cap W_j]_k
+
\sum\nolimits_{W_j \subset D}
n_j i_{j, *}(c_1(\mathcal{O}_X(D)|_{W_j}) \cap [W_j])
$$
in $A_k(X)$ by Definition \ref{definition-cap-c1}.
The right hand side matches (termwise) the pushforward of the class
$i^*\alpha$ on $D$ from Definition \ref{definition-gysin-homomorphism}.
Hence we win.
\end{proof}

\noindent
The following lemma will be superseded later.

\begin{lemma}
\label{lemma-closed-in-X-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $D$ be an effective Cartier divisor on $X$.
Let $W \subset X$ be a closed subscheme such that
$D' = W \cap D$ is an effective Cartier divisor on $W$.
$$
\xymatrix{
D' \ar[r]_{i'} \ar[d]_{i''} & W \ar[d] \\
D \ar[r]^i & X
}
$$
For any $(k + 1)$-cycle on $W$ we have
$i^*\alpha = (i'')_*(i')^*\alpha$ in $A_k(D)$.
\end{lemma}

\begin{proof}
Suppose $\alpha = [Z]$ for some integral closed subscheme
$Z \subset W$. In case $Z \not \subset D$ we have
$Z \cap D' = Z \cap D$ scheme theoretically. Hence the
equality holds as cycles. In case $Z \subset D$ we also
have $Z \subset D'$ and the equality holds since
$\mathcal{O}_X(D)|_Z \cong \mathcal{O}_W(D')|_Z$
and the definition of $i^*$ and $(i')^*$ in these cases.
\end{proof}

\begin{lemma}
\label{lemma-easy-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $i : D \to X$ be an effective Cartier divisor on $X$.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme such
that $\dim_\delta(Z) \leq k + 1$ and such that
$D \cap Z$ is an effective Cartier divisor on $Z$. Then
$i^*[Z]_{k + 1} = [D \cap Z]_k$.
\item Let $\mathcal{F}$ be a coherent sheaf on $X$
such that $\dim_\delta(\text{Support}(\mathcal{F})) \leq k + 1$ and
$1_D : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{O}_X(D)$
is injective. Then
$$
i^*[\mathcal{F}]_{k + 1} = [i^*\mathcal{F}]_k
$$
in $A_k(D)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $Z \subset X$ as in (1). Then set $\mathcal{F} = \mathcal{O}_Z$.
The assumption that $D \cap Z$ is an effective Cartier divisor is
equivalent to the assumption that
$1_D : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{O}_X(D)$
is injective. Moreover $[Z]_{k + 1} = [\mathcal{F}]_{k + 1}]$
and $[D \cap Z]_k = [\mathcal{O}_{D \cap Z}]_k = [i^*\mathcal{F}]_k$.
See Lemma \ref{lemma-cycle-closed-coherent}.
Hence part (1) follows from part (2).

\medskip\noindent
Write $[\mathcal{F}]_{k + 1} = \sum m_j[W_j]$ with $m_j > 0$
and pairwise distinct integral closed subschemes $W_j \subset X$
of $\delta$-dimension $k + 1$. The assumption that
$1_D : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{O}_X(D)$
is injective implies that $W_j \not \subset D$ for all $j$.
By definition we see that
$$
i^*[\mathcal{F}]_{k + 1} = \sum [D \cap W_j]_k.
$$
We claim that
$$
\sum [D \cap W_j]_k = [i^*\mathcal{F}]_k
$$
as cycles.
Let $Z \subset D$ be an integral closed subscheme of $\delta$-dimension
$k$. Let $\xi \in Z$ be its generic point. Let $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$. Let $f \in A$ be an element generating the
ideal of $D$, i.e., such that $\mathcal{O}_{D, \xi} = A/fA$.
By assumption $\dim(M) = 1$, $f : M \to M$ is injective, and
$\text{length}_A(M/fM) < \infty$. Moreover, $\text{length}_A(M/fM)$
is the coefficient of $[Z]$ in $[i^*\mathcal{F}]_k$. On the
other hand, let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes in the support of $M$. Then
$$
\sum
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(f)
$$
is the coefficient of $[Z]$ in $\sum [D \cap W_j]_k$.
Hence we see the equality by
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-improved-additivity}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\{i_j : D_j \to X \}_{j \in J}$ be a locally finite collection
of effective Cartier divisors on $X$. Let $n_j > 0$, $j\in J$.
Set $D = \sum_{j \in J} n_j D_j$, and denote $i : D \to X$ the
inclusion morphism. Let $\alpha \in Z_{k + 1}(X)$. Then
$$
p : \coprod\nolimits_{j \in J} D_j \longrightarrow D
$$
is proper and
$$
i^*\alpha = p_*\left(\sum n_j i_j^*\alpha\right)
$$
in $A_k(D)$.
\end{lemma}

\begin{proof}
The proof of this lemma is made a bit longer than expected
by a subtlety concerning infinite sums of rational equivalences.
In the quasi-compact case the family $D_j$ is finite and the result
is altogether easy and a straightforward consequence of
Lemmas \ref{lemma-compute-c1} and
\ref{lemma-c1-additive} and the definitions.

\medskip\noindent
The morphism $p$ is proper since the family $\{D_j\}_{j \in J}$
is locally finite. Write $\alpha = \sum_{a \in A} m_a [W_a]$
with $W_a \subset X$ an integral closed subscheme of
$\delta$-dimension $k + 1$.
Denote $i_a : W_a \to X$ the closed immersion.
We assume that $m_a \not = 0$ for all $a \in A$ such that
$\{W_a\}_{a \in A}$ is locally finite on $X$.

\medskip\noindent
Observe that
by Definition \ref{definition-gysin-homomorphism}
the class $i^*\alpha$ is the class of a cycle
$\sum m_a\beta_a$ for certain $\beta_a \in Z_k(W_a \cap D)$.
Namely, if $W_a \not \subset D$ then $\beta_a = [D \cap W_a]_k$
and if $W_a \subset D$, then $\beta_a$ is a cycle
representing $c_1(\mathcal{O}_X(D)) \cap [W_a]$.

\medskip\noindent
For each $a \in A$ write $J = J_{a, 1} \coprod J_{a, 2} \coprod J_{a, 3}$
where
\begin{enumerate}
\item $j \in J_{a, 1}$ if and only if $W_a \cap D_j = \emptyset$,
\item $j \in J_{a, 2}$ if and only if
$W_a \not = W_a \cap D_1 \not = \emptyset$, and
\item $j \in J_{a, 3}$ if and only if $W_a \subset D_j$.
\end{enumerate}
Since the family $\{D_j\}$ is locally finite we see that
$J_{a, 3}$ is a finite set. For every $a \in A$ and $j \in J$
we choose a cycle $\beta_{a, j} \in Z_k(W_a \cap D_j)$ as follows
\begin{enumerate}
\item if $j \in J_{a, 1}$ we set $\beta_{a, j} = 0$,
\item if $j \in J_{a, 2}$ we set $\beta_{a, j} = [D_j \cap W_a]_k$, and
\item if $j \in J_{a, 3}$ we choose $\beta_{a, j} \in Z_k(W_a)$
representing $c_1(i_a^*\mathcal{O}_X(D_j)) \cap [W_j]$.
\end{enumerate}
We claim that
$$
\beta_a \sim_{rat}
\sum\nolimits_{j \in J} n_j \beta_{a, j}
$$
in $A_k(W_a \cap D)$.

\medskip\noindent
Case I: $W_a \not \subset D$. In this case $J_{a, 3} = \emptyset$.
Thus it suffices to show that
$[D \cap W_a]_k = \sum n_j [D_j \cap W_a]_k$ as cycles.
This is Lemma \ref{lemma-sum-divisors-associated-Weil}.

\medskip\noindent
Case II: $W_a \subset D$. In this case $\beta_a$ is a cycle representing
$c_1(i_a^*\mathcal{O}_X(D)) \cap [W_a]$.
Write $D = D_{a, 1} + D_{a, 2} + D_{a, 3}$ with
$D_{a, s} = \sum_{j \in J_{a, s}} n_jD_j$.
By Lemma \ref{lemma-c1-additive} we have
\begin{eqnarray*}
c_1(i_a^*\mathcal{O}_X(D)) \cap [W_a] & = &
c_1(i_a^*\mathcal{O}_X(D_{a, 1})) \cap [W_a] +
c_1(i_a^*\mathcal{O}_X(D_{a, 2})) \cap [W_a] \\
& &
 + c_1(i_a^*\mathcal{O}_X(D_{a, 3})) \cap [W_a].
\end{eqnarray*}
It is clear that the first term of the sum is zero.
Since $J_{a, 3}$ is finite we see that the last term agrees
with $\sum\nolimits_{j \in J_{a, 3}} n_jc_1(i_a^*\mathcal{L}_j) \cap [W_a]$,
see Lemma \ref{lemma-c1-additive}.
This is represented by $\sum_{j \in J_{a, 3}} n_j \beta_{a, j}$.
Finally, by Case I we see that the middle term is represented by the cycle
$\sum\nolimits_{j \in J_{a, 2}} n_j[D_j \cap W_a]_k =
\sum_{j \in J_{a, 2}} n_j\beta_{a, j}$.
Whence the claim in this case.

\medskip\noindent
At this point we are ready to finish the proof of the lemma.
Namely, we have $i^*D \sim_{rat} \sum m_a\beta_a$ by our
choice of $\beta_a$. For each $a$ we have
$\beta_a \sim_{rat} \sum_j \beta_{a, j}$ with the rational
equivalence taking place on $D \cap W_a$.
Since the collection of closed subschemes $D \cap W_a$
is locally finite on $D$, we see that also
$\sum m_a \beta_a \sim_{rat} \sum_{a, j} m_a\beta_{a, j}$
on $D$! (See Remark \ref{remark-infinite-sums-rational-equivalences}.)
Ok, and now it is clear that $\sum_a m_a\beta_{a, j}$ (viewed
as a cycle on $D_j$) represents $i_j^*\alpha$ and hence
$\sum_{a, j} m_a\beta_{a, j}$ represents $p_* \sum_j i_j^*\alpha$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D$, $D'$ be effective Cartier divisors on $X$.
Assume $\dim_\delta(D \cap D') = n - 2$. Let $i : D \to X$,
resp.\ $i' : D' \to X$ be the corresponding closed immersions.
Then
\begin{enumerate}
\item there exists a cycle $\alpha \in Z_{n - 2}(D \cap D')$
whose pushforward to $D$ represents
$i^*[D']_{n - 1} \in A_{n - 2}(D)$
and whose pushforward to $D'$ represents
$(i')^*[D]_{n - 1} \in A_{n - 2}(D')$, and
\item we have
$$
D \cdot [D']_{n - 1}
=
D' \cdot [D]_{n - 1}
$$
in $A_{n - 2}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (3) is a trivial consequence of parts (1) and (2).
Because of symmetry we only need to prove (1).
Let us write $[D]_{n - 1} = \sum n_a[Z_a]$ and
$[D']_{n - 1} = \sum m_b[Z_b]$ with $Z_a$ the irreducible
components of $D$ and $[Z_b]$ the irreducible
components of $D'$.
According to Definition \ref{definition-gysin-homomorphism},
we have $i^*D' = \sum m_b i^*[Z_b]$ and $(i')^*D = \sum n_a(i')^*[Z_a]$.
By assumption, none of the irreducible components $Z_b$
is contained in $D$, and hence $i^*[Z_b] = [Z_b\cap D]_{n - 2}$
by definition. Similarly $(i')^*[Z_a] = [Z_a \cap D']_{n - 2}$.
Hence we are trying to prove the equality of cycles
$$
\sum n_a[Z_a \cap D']_{n - 2} = \sum m_b[Z_b \cap D]_{n - 2}
$$
which are indeed supported on $D \cap D'$.
Let $W \subset X$ be an integral closed subscheme
with $\dim_\delta(W) = n - 2$. Let $\xi \in W$ be its generic point.
Set $R = \mathcal{O}_{X, \xi}$. It is a Noetherian local domain.
Note that $\dim(R) = 2$. Let $f \in R$, resp.\ $f' \in R$
be an element defining the ideal of $D$, resp.\ $D'$.
By assumption $\dim(R/(f, f')) = 0$. Let
$\mathfrak q'_1, \ldots, \mathfrak q'_t \subset R$ be the minimal
primes over $(f')$, let $\mathfrak q_1, \ldots, \mathfrak q_s \subset R$
be the minimal primes over $(f)$.
The equality above comes down to the equality
$$
\sum_{i = 1, \ldots, s}
\text{length}_{R_{\mathfrak q_i}}(R_{\mathfrak q_i}/(f))
\text{ord}_{R/\mathfrak q_i}(f')
=
\sum_{j = 1, \ldots, t}
\text{length}_{R_{\mathfrak q_j}}(R_{\mathfrak q'_j}/(f'))
\text{ord}_{R/\mathfrak q_j}(f).
$$
By Lemma \ref{lemma-length-multiplication}
applied with $M = R/(f)$ the left hand side of
this equation is equal to
$$
\text{length}_R(R/(f, f'))
-
\text{length}_R(\text{Ker}(f' : R/(f) \to R/(f)))
$$
OK, and now we note that
$\text{Ker}(f' : R/(f) \to R/(f))$ is canonically isomorphic
to $((f) \cap (f'))/(ff')$ via the map $x \bmod (f) \mapsto
f'x \bmod (ff')$. Hence the left hand side is
$$
\text{length}_R(R/(f, f'))
-
\text{length}_R((f) \cap (f')/(ff'))
$$
Since this is symmetric in $f$ and $f'$ we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection-infinite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\{D_j\}_{j \in J}$ be a locally finite collection of
effective Cartier divisors on $X$. Let $n_j, m_j \geq 0$ be
collections of nonnegative integers. Set
$D = \sum n_j D_j$ and $D' = \sum m_j D_j$.
Assume that $\dim_\delta(D_j \cap D_{j'}) = n - 2$ for every
$j \not = j'$. Then $D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}$ in
$A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
This lemma is a trivial consequence of
Lemmas \ref{lemma-sum-divisors-associated-Weil} and
\ref{lemma-commutativity-effective-Cartier-proper-intersection}
in case the sums are finite, e.g., if $X$ is quasi-compact.
Hence we suggest the reader skip the proof.

\medskip\noindent
Here is the proof in the general case.
Let $i_j : D_j \to X$ be the closed immersions
Let $p : \coprod D_j \to X$ denote coproduct of the morphisms $i_j$.
Let $\{Z_a\}_{a \in A}$ be the collection of irreducible components of
$\bigcup D_j$. For each $j$ we write
$$
[D_j]_{n - 1} = \sum d_{j, a}[Z_a].
$$
By Lemma \ref{lemma-sum-divisors-associated-Weil} we have
$$
[D]_{n - 1} = \sum n_j d_{j, a} [Z_a],
\quad
[D']_{n - 1} = \sum m_j d_{j, a} [Z_a].
$$
By Lemma \ref{lemma-improved-additivity}
we have
$$
D \cdot [D']_{n - 1} = p_*\left(\sum n_j i_j^*[D']_{n - 1} \right),
\quad
D' \cdot [D]_{n - 1} = p_*\left(\sum m_{j'} i_{j'}^*[D]_{n - 1} \right).
$$
As in the definition of the Gysin homomorphisms (see
Definition \ref{definition-gysin-homomorphism})
we choose cycles $\beta_{a, j}$ on $D_j \cap Z_a$ representing
$i_j^*[Z_a]$. (Note that in fact $\beta_{a, j} = [D_j \cap Z_a]_{n - 2}$
if $Z_a$ is not contained in $D_j$, i.e., there is no choice in that case.)
Now since $p$ is a closed immersion when restricted to each of the $D_j$
we can (and we will) view $\beta_{a, j}$ as a cycle on $X$.
Plugging in the formulas for $[D]_{n - 1}$ and $[D']_{n - 1}$ obtained
above we see that
$$
D \cdot [D']_{n - 1} =
\sum\nolimits_{j, j', a} n_j m_{j'} d_{j', a} \beta_{a, j},
\quad
D' \cdot [D]_{n - 1} =
\sum\nolimits_{j, j', a} m_{j'} n_j d_{j, a} \beta_{a, j'}.
$$
Moreover, with the same conventions we also have
$$
D_j \cdot [D_{j'}]_{n - 1} = \sum d_{j', a} \beta_{a, j}.
$$
In these terms
Lemma \ref{lemma-commutativity-effective-Cartier-proper-intersection}
(see also its proof)
says that for $j \not = j'$ the cycles
$\sum d_{j', a} \beta_{a, j}$ and $\sum d_{j, a} \beta_{a, j'}$
are equal as cycles! Hence we see that
\begin{eqnarray*}
D \cdot [D']_{n - 1}
& = &
\sum\nolimits_{j, j', a} n_j m_{j'} d_{j', a} \beta_{a, j} \\
& = &
\sum\nolimits_{j \not = j'} n_j m_{j'}
\left(\sum\nolimits_a d_{j', a} \beta_{a, j}\right) +
\sum\nolimits_{j, a} n_j m_j d_{j, a} \beta_{a, j} \\
& = &
\sum\nolimits_{j \not = j'} n_j m_{j'}
\left(\sum\nolimits_a d_{j, a} \beta_{a, j'}\right) +
\sum\nolimits_{j, a} n_j m_j d_{j, a} \beta_{a, j} \\
& = &
\sum\nolimits_{j, j', a} m_{j'} n_j d_{j, a} \beta_{a, j'} \\
& = &
D' \cdot [D]_{n - 1}
\end{eqnarray*}
and we win.
\end{proof}

\noindent
Here is the key lemma of this chapter. A stronger version of this lemma
asserts that $D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}$ holds
in $A_{n - 2}(D \cap D')$ for suitable representatives of the
dot products involved. The first proof of the lemma together with
Lemmas \ref{lemma-improved-additivity},
\ref{lemma-commutativity-effective-Cartier-proper-intersection}, and
\ref{lemma-commutativity-effective-Cartier-proper-intersection-infinite}
can be modified to show this (see \cite{F}). It is
not so clear how to modify the second proof to prove the refined
version. An application of the refined version is a proof that the
Gysin homomorphism factors through rational equivalence. We will show
this by another method later.

\begin{lemma}
\label{lemma-commutativity-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D$, $D'$ be effective Cartier divisors on $X$.
Then
$$
D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-commutativity-effective-Cartier}]
First, let us prove this in case $X$ is quasi-compact.
In this case, apply Lemma \ref{lemma-blowing-up-intersections} to $X$ and the
two element set $\{D, D'\}$ of effective Cartier divisors.
Thus we get a proper morphism $b : X' \to X$,
a finite collection of effective Cartier
divisors $D'_j \subset X'$ intersecting pairwise in codimension $\geq 2$,
with $b^{-1}(D) = \sum n_j D'_j$, and $b^{-1}(D') = \sum m_j D'_j$.
Note that $b_*[b^{-1}(D)]_{n - 1} = [D]_{n - 1}$ in $Z_{n - 1}(X)$
and similarly for $D'$,
see Lemma \ref{lemma-push-pull-effective-Cartier}.
Hence, by Lemma \ref{lemma-pushforward-cap-c1} we have
$$
D \cdot [D']_{n - 1} = b_*\left(b^{-1}(D) \cdot [b^{-1}(D')]_{n - 1}\right)
$$
in $A_{n - 2}(X)$ and similarly for the other term. Hence the
lemma follows from the equality
$b^{-1}(D) \cdot [b^{-1}(D')]_{n - 1} = b^{-1}(D') \cdot [b^{-1}(D)]_{n - 1}$
in $A_{n - 2}(X')$ of Lemma
\ref{lemma-commutativity-effective-Cartier-proper-intersection-infinite}.

\medskip\noindent
Note that in the proof above, each referenced lemma works also
in the general case (when $X$ is not assumed quasi-compact). The
only minor change in the general case is that the morphism
$b : U' \to U$ we get from applying Lemma \ref{lemma-blowing-up-intersections}
has as its target
an open $U \subset X$ whose complement has codimension $\geq 3$.
Hence by Lemma \ref{lemma-restrict-to-open} we see that
$A_{n - 2}(U) = A_{n - 2}(X)$
and after replacing $X$ by $U$ the rest of the proof goes through
unchanged.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-commutativity-effective-Cartier}]
Let $\mathcal{I} = \mathcal{O}_X(-D)$ and
$\mathcal{I}' = \mathcal{O}_X(-D')$ be the invertible
ideal sheaves of $D$ and $D'$.
We denote
$\mathcal{I}_{D'} = \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{O}_{D'}$
and
$\mathcal{I}'_D = \mathcal{I}' \otimes_{\mathcal{O}_X} \mathcal{O}_D$.
We can restrict the inclusion map $\mathcal{I} \to \mathcal{O}_X$
to $D'$ to get a map
$$
\varphi : \mathcal{I}_{D'} \longrightarrow \mathcal{O}_{D'}
$$
and similarly
$$
\psi: \mathcal{I}'_D \longrightarrow \mathcal{O}_D
$$
It is clear that
$$
\text{Coker}(\varphi)
\cong
\mathcal{O}_{D \cap D'}
\cong
\text{Coker}(\psi)
$$
and
$$
\text{Ker}(\varphi)
\cong
\frac{\mathcal{I} \cap \mathcal{I}'}{\mathcal{I}\mathcal{I}'}
\cong
\text{Ker}(\psi).
$$
Hence we see that
$$
\gamma =
[\mathcal{I}_{D'}] - [\mathcal{O}_{D'}]
=
[\mathcal{I}'_D] - [\mathcal{O}_D]
$$
in $K_0(\text{Coh}_{\leq n - 1}(X))$. On the other hand it is clear that
$$
[\mathcal{I}'_D]_{n - 1} = [D]_{n - 1}, \quad
[\mathcal{I}_{D'}]_{n - 1} = [D']_{n - 1}.
$$
and that
$$
\mathcal{O}_X(D') \otimes \mathcal{I}'_D = \mathcal{O}_D, \quad
\mathcal{O}_X(D) \otimes \mathcal{I}_{D'} = \mathcal{O}_{D'}.
$$
By Lemma \ref{lemma-coherent-sheaf-cap-c1} (applied two times)
this means that the element $\gamma$ is an element of $B_{n - 2}(X)$, and
maps to both $c_1(\mathcal{O}_X(D')) \cap [D]_{n - 1}$ and to
$c_1(\mathcal{O}_X(D)) \cap [D']_{n - 1}$ and we win (since the
map $B_{n - 2}(X) \to A_{n - 2}(X)$ is well defined -- which is
the key to this proof).
\end{proof}









\section{Commutativity}
\label{section-commutativity}

\noindent
At this point we can start using the material above and start proving
more interesting results.

\begin{lemma}
\label{lemma-commutativity-on-integral}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
Choose a nonzero meromorphic section $s$ of $\mathcal{L}$
and a nonzero meromorphic section $t$ of $\mathcal{N}$.
Set $\alpha = \text{div}_\mathcal{L}(s)$ and
$\beta = \text{div}_\mathcal{N}(t)$.
Then
$$
c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{L}) \cap \beta
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-blowing-up-denominators} (applied twice)
there exists a proper morphism
$\pi : X' \to X$ and effective Cartier divisors
$D_1, E_1, D_2, E_2$ on $X'$ such that
$$
b^*\mathcal{L} = \mathcal{O}_{X'}(D_1 - E_1),
\quad
b^*\mathcal{N} = \mathcal{O}_{X'}(D_2 - E_2),
$$
and such that
$$
\alpha = \pi_*([D_1]_{n - 1} - [E_1]_{n - 1}),
\quad
\beta = \pi_*([D_2]_{n - 1} - [E_2]_{n - 1}).
$$
By the projection formula of Lemma \ref{lemma-pushforward-cap-c1}
and the additivity of Lemma \ref{lemma-c1-cap-additive}
it is enough to show the equality
$$
c_1(\mathcal{O}_{X'}(D_1)) \cap [D_2]_{n - 1}
=
c_1(\mathcal{O}_{X'}(D_2)) \cap [D_1]_{n - 1}
$$
and three other similar equalities involving $D_i$ and $E_j$.
By Lemma \ref{lemma-support-cap-effective-Cartier} this is the
same as showing that
$D_1 \cdot [D_2]_{n - 1} = D_2 \cdot [D_1]_{n - 1}$ and so on.
Thus the result follows from Lemma \ref{lemma-commutativity-effective-Cartier}.
\end{proof}

\begin{lemma}
\label{lemma-factors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be invertible on $X$.
The operation $\alpha \mapsto c_1(\mathcal{L}) \cap \alpha$
factors through rational equivalence to give an operation
$$
c_1(\mathcal{L}) \cap - : A_{k + 1}(X) \to A_k(X)
$$
\end{lemma}

\begin{proof}
Let $\alpha \in Z_{k + 1}(X)$, and $\alpha \sim_{rat} 0$.
We have to show that $c_1(\mathcal{L}) \cap \alpha$
as defined in Definition \ref{definition-cap-c1} is zero.
By Definition \ref{definition-rational-equivalence} there
exists a locally finite family $\{W_j\}$ of integral closed
subschemes with $\dim_\delta(W_j) = k + 2$ and rational functions
$f_j \in R(W_j)^*$ such that
$$
\alpha = \sum (i_j)_*\text{div}_{W_j}(f_j)
$$
Note that $p : \coprod W_j \to X$ is a proper morphism,
and hence $\alpha = p_*\alpha'$ where $\alpha' \in Z_{k + 1}(\coprod W_j)$
is the sum of the principal divisors $\text{div}_{W_j}(f_j)$.
By the projection formula (Lemma \ref{lemma-pushforward-cap-c1}) we have
$c_1(\mathcal{L}) \cap \alpha = p_*(c_1(p^*\mathcal{L}) \cap \alpha')$.
Hence it suffices to show that each
$c_1(\mathcal{L}|_{W_j}) \cap \text{div}_{W_j}(f_j)$ is zero.
In other words we may assume that $X$ is integral and
$\alpha = \text{div}_X(f)$ for some $f \in R(X)^*$.

\medskip\noindent
Assume $X$ is integral and $\alpha = \text{div}_X(f)$ for some $f \in R(X)^*$.
We can think of $f$ as a regular meromorphic section of the invertible
sheaf $\mathcal{N} = \mathcal{O}_X$. Choose a meromorphic section
$s$ of $\mathcal{L}$ and denote $\beta = \text{div}_\mathcal{L}(s)$.
By Lemma \ref{lemma-commutativity-on-integral}
we conclude that
$$
c_1(\mathcal{L}) \cap \alpha = c_1(\mathcal{O}_X) \cap \beta.
$$
However, by Lemma \ref{lemma-c1-cap-additive} we see that the right hand side
is zero in $A_k(X)$ as desired.
\end{proof}

\noindent
For any integer $s \geq 0$ we will denote
$$
c_1(\mathcal{L})^s \cap - : A_{k + s}(X) \to A_k(X)
$$
the $s$-fold iterate of the operation $c_1(\mathcal{L}) \cap - $.
This makes sense by the lemma above.

\begin{lemma}
\label{lemma-cap-commutative}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
For any $\alpha \in A_{k + 2}(X)$ we have
$$
c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
$$
as elements of $A_k(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum m_j[Z_j]$ for some locally finite
collection of integral closed subschemes $Z_j \subset X$
with $\dim_\delta(Z_j) = k + 2$.
Consider the proper morphism $p : \coprod Z_j \to X$.
Set $\alpha' = \sum m_j[Z_j]$ as a $(k + 2)$-cycle on
$\coprod Z_j$. By several applications of
Lemma \ref{lemma-pushforward-cap-c1} we see that
$c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
= p_*(c_1(p^*\mathcal{L}) \cap c_1(p^*\mathcal{N}) \cap \alpha')$
and
$c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
= p_*(c_1(p^*\mathcal{N}) \cap c_1(p^*\mathcal{L}) \cap \alpha')$.
Hence it suffices to prove the formula in case $X$ is integral
and $\alpha = [X]$. In this case the result follows
from Lemma \ref{lemma-commutativity-on-integral} and the definitions.
\end{proof}








\section{Gysin homomorphisms}
\label{section-gysin}

\noindent
We want to show the Gysin homomorphisms factor through rational equivalence.
One method (see \cite{F}) is to prove a more precise version of the
key Lemma \ref{lemma-commutativity-effective-Cartier} keeping track of
supports. Having obtained this one can find analogues of the lemmas of Section
\ref{section-commutativity} for the Gysin homomorphism and get the result.
We will use another method.

\begin{lemma}
\label{lemma-gysin-factors-principal}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $X$ be integral and $n = \dim_\delta(X)$.
Let $a \in \Gamma(X, \mathcal{O}_X)$ be a nonzero function.
Let $i : D = Z(a) \to X$ be the closed immersion of the zero scheme of $a$.
Let $f \in R(X)^*$.
In this case $i^*\text{div}_X(f) = 0$ in $A_{n - 2}(D)$.
\end{lemma}

\begin{proof}
Write $\text{div}_X(f) = \sum n_j[Z_j]$ for some integral
closed subschemes $Z_j \subset X$ of $\delta$-dimension $n - 1$.
We may assume that the family $\{Z_j\}_{j \in J}$ is locally
finite and that $f \in \Gamma(U, \mathcal{O}_U^*)$
where $U = X \setminus \bigcup Z_j$ (see
Lemma \ref{lemma-divisor-locally-finite} and its proof).

\medskip\noindent
Write $J = J_1 \coprod J_2$ where $J_1 = \{j \in J \mid Z_j \subset D\}$.
Note that $\mathcal{O}_X(D) \cong \mathcal{O}_X$ because
$a^{-1}$ is a trivializing global section. Hence by
Definition \ref{definition-gysin-homomorphism}
of $i^*$ we see that $i^*\text{div}_X(f)$ is represented
by
$$
\sum\nolimits_{j \in J_2} n_j[D \cap Z_j]_{n - 2}.
$$
Namely, the terms involving $c_1(\mathcal{O}_X(D)|_{Z_j}) \cap Z_j$
may be dropped since $c_1(\mathcal{O}) \cap -$ is the zero
operation anyway (see Lemma \ref{lemma-c1-cap-additive}).

\medskip\noindent
For each $j$ let $\xi_j \in Z_j$ be its generic point.
Let $B_j = \mathcal{O}_{X, \xi_j}$, which has
residue field $\kappa_j = \kappa(\xi_j) = R(Z_j)$.
For $j \in J_1$, let
$$
f_j = d_{B_j}(f, a)
$$
be the tame symbol, see Definition \ref{definition-tame-symbol}.
We claim that we have the following equality of cycles
$$
\sum\nolimits_{j \in J_2} n_j[D \cap Z_j]_{n - 2}
=
\sum\nolimits_{j \in J_1}
(Z_j \to D)_*\text{div}_{Z_j}(f_j)
$$
on $D$. Indeed, note that $[D \cap Z_j]_{n - 2} = \text{div}_{Z_j}(a)$.
Hence $n_j[D \cap Z_j]_{n - 2} = \text{div}_{Z_j}(a^{n_j})$.
Since $n_j = \text{ord}_{B_j}(f)$ we see that in fact also
$n_j[D \cap Z_j]_{n - 2} = \text{div}_{Z_j}(d_{B_j}(a, f))$,
as $a$ is a unit in $B_j$ see Lemma \ref{lemma-symbol-when-one-is-a-unit}.
Note that $d_{B_j}(f, a) = d_{B_j}(a, f)^{-1}$, see
Lemma \ref{lemma-multiplicativity-symbol}.
Hence altogether we are trying to show that
$$
\sum\nolimits_{j \in J}
(Z_j \to D)_*\text{div}_{Z_j}(d_{B_j}(a, f))
=
0
$$
as an $(n - 2)$-cycle. Consider any codimension $2$
integral closed subscheme $W \subset X$ with generic point $\zeta \in X$.
Set $A = \mathcal{O}_{X, \zeta}$. Applying
Lemma \ref{lemma-secondary-ramification} to
$(A, a, f)$ we see that the coefficient of $[W]$ in the expression
above is zero as desired.
\end{proof}

\begin{lemma}
\label{lemma-gysin-factors-general}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $X$ be integral and $n = \dim_\delta(X)$.
Let $i : D \to X$ be an effective Cartier divisor.
Let $f \in R(X)^*$.
In this case $i^*\text{div}_X(f) = 0$ in $A_{n - 2}(D)$.
\end{lemma}

\begin{proof}
This proof is a repeat of the proof of
Lemma \ref{lemma-gysin-factors-principal}.
So make sure you've read that one first.

\medskip\noindent
Write $\text{div}_X(f) = \sum n_j[Z_j]$ for some integral
closed subschemes $Z_j \subset X$ of $\delta$-dimension $n - 1$.
We may assume that the family $\{Z_j\}_{j \in J}$ is locally
finite and that $f \in \Gamma(U, \mathcal{O}_U^*)$
where $U = X \setminus \bigcup Z_j$ (see
Lemma \ref{lemma-divisor-locally-finite} and its proof).

\medskip\noindent
Write $J = J_1 \coprod J_2$ where $J_1 = \{j \in J \mid Z_j \subset D\}$.
For each $j$ let $\xi_j \in Z_j$ be its generic point.
Let us write $\mathcal{L} = \mathcal{O}_X(D)$.
Choose $\tilde s_j \in \mathcal{L}_{\xi_j}$ a generator.
Denote $s_j \in \mathcal{L}_{\xi_j} \otimes \kappa(\xi_j)$
the corresponding nonzero meromorphic section of
$\mathcal{L}|_{Z_j}$. Then by
Definition \ref{definition-gysin-homomorphism}
of $i^*$ we see that $i^*\text{div}_X(f)$ is represented
by the cycle
$$
\sum\nolimits_{j \in J_2} n_j[D \cap Z_j]_{n - 2}
+
\sum\nolimits_{j \in J_2} n_j \text{div}_{\mathcal{L}|_{Z_j}}(s_j)
$$
on $D$. Our goal is to show that this is rationally equivalent to zero
on $D$.

\medskip\noindent
Let $B_j = \mathcal{O}_{X, \xi_j}$, which has
residue field $\kappa_j = \kappa(\xi_j) = R(Z_j)$.
Write $s = a_j \tilde s_j$ for some $a_j \in B_j$.
For $j \in J_1$ let
$$
f_j = d_{B_j}(f, a_j) \in \kappa_j^* = R(Z_j)^*
$$
be the tame symbol, see Definition \ref{definition-tame-symbol}.
We claim that we have the following equality of cycles
$$
\sum\nolimits_{j \in J_2} n_j[D \cap Z_j]_{n - 2}
+
\sum\nolimits_{j \in J_2} n_j \text{div}_{\mathcal{L}|_{Z_j}}(s_j)
=
\sum\nolimits_{j \in J_1}
(Z_j \to D)_*\text{div}_{Z_j}(f_j)
$$
on $D$. This will clearly prove the lemma.

\medskip\noindent
Note that for $j\in J_2$ we have
$[D \cap Z_j]_{n - 2} = \text{div}_{\mathcal{L}|_{Z_j}}(s|_{Z_j})$.
Since $s|_{Z_j} = a_j|_{Z_j} s_j$ we see that
$[D \cap Z_j]_{n - 2} =
\text{div}_{\mathcal{L}|_{Z_j}}(s_j) + \text{div}_{Z_j}(a_j|_{Z_j})$.
Hence, still for $j \in J_2$, we have
$$
n_j[D \cap Z_j]_{n - 2} =
n_j \text{div}_{\mathcal{L}|_{Z_j}}(s_j) +
\text{div}_{Z_j}((a_j|_{Z_j})^{n_j})
$$
Since $n_j = \text{ord}_{B_j}(f)$ we see that
$\text{div}_{Z_j}((a_j|_{Z_j})^{n_j}) = \text{div}_{Z_j}(d_{B_j}(a_j, f))$,
as $a_j$ is a unit in $B_j$ (since $j \in J_2$),
see Lemma \ref{lemma-symbol-when-one-is-a-unit}.
Note that $d_{B_j}(f, a_j) = d_{B_j}(a_j, f)^{-1}$, see
Lemma \ref{lemma-multiplicativity-symbol}.
Hence altogether we are trying to show that
\begin{equation}
\label{equation-to-prove}
\sum\nolimits_{j \in J}
n_j \text{div}_{\mathcal{L}|_{Z_j}}(s_j)
=
\sum\nolimits_{j \in J}
(Z_j \to D)_*\text{div}_{Z_j}(d_{B_j}(a_j, f))
\end{equation}
as an $(n - 2)$-cycle.

\medskip\noindent
Consider any codimension $2$
integral closed subscheme $W \subset X$ with generic point $\zeta \in X$.
Set $A = \mathcal{O}_{X, \zeta}$. Choose a generator
$s_\zeta \in \mathcal{L}_\zeta$. For those $j$ such that
$\zeta \in Z_j$ we may write $\tilde s_j = b_j s_\zeta$ with
$b_j \in B_j^*$. We may also write $s = a_\zeta s_\zeta$ for
some $a_\zeta \in A$. Then we see that $a_j = b_j a_\zeta$.
The coefficient of $[W]$ on the right hand side of
Equation (\ref{equation-to-prove}) is
$$
\sum\nolimits_{\zeta \in Z_j} n_j\text{ord}_{A/\mathfrak q_j}(\overline{b_j}).
$$
where $\mathfrak q_j \subset A$ is the height one prime corresponding
to $Z_j$. Note that $B_j = A_{\mathfrak q_j}$ in this case.
The coefficient of $[W]$ on the left hand side of
Equation (\ref{equation-to-prove}) is
$$
\sum\nolimits_{\zeta \in Z_j}
\text{ord}_{A/\mathfrak q_j}(d_{A_{\mathfrak q_j}}(b_j a_\zeta, f)).
$$
Since $b_j$ is a unit, and $n_j = \text{ord}_{A_{\mathfrak q_j}}(f)$
we see that $d_{A_{\mathfrak q_j}}(b_j a_\zeta, f)
= \overline{b_j}^{n_j} d_{A_{\mathfrak q_j}}(a_\zeta, f)$ by
Lemmas \ref{lemma-multiplicativity-symbol}
and \ref{lemma-symbol-when-one-is-a-unit}.
By additivity of $\text{ord}$ we see that it suffices to prove
$$
0 = \sum\nolimits_{\zeta \in Z_j}
\text{ord}_{A/\mathfrak q_j}(d_{A_{\mathfrak q_j}}(a_\zeta, f))
$$
which is Lemma \ref{lemma-secondary-ramification}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-factors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $i : D \to X$ be an effective Cartier divisor on $X$.
The Gysin homomorphism factors through rational equivalence to
give a map $i^* : A_{k + 1}(X) \to A_k(D)$.
\end{lemma}

\begin{proof}
Let $\alpha \in Z_{k + 1}(X)$ and assume that $\alpha \sim_{rat} 0$.
This means there exists a locally finite collection of integral
closed subschemes $W_j \subset X$ of $\delta$-dimension $k + 2$
and $f_j \in R(W_j)^*$ such that
$\alpha = \sum i_{j, *}\text{div}_{W_j}(f_j)$.
By construction of the map $i^*$ we see that
$i^*\alpha = \sum i^*i_{j, *}\text{div}_{W_j}(f_j)$
where each cycle $i^*i_{j, *}\text{div}_{W_j}(f_j)$
is supported on $D \cap W_j$. If we can show that each
$i^*i_{j, *}\text{div}_{W_j}(f_j)$ is rationally
equivalent on $W_j \cap D$, then we see that
$i^*\alpha \sim_{rat} 0$ (this is clear if the sum is finite,
in general see Remark \ref{remark-infinite-sums-rational-equivalences}).

\medskip\noindent
Pick an index $j$. If $W_j \subset D$, then we see that
$i^*i_{j, *}\text{div}_{W_j}(f_j)$ is simply equal
to
$$
i'_{j, *}c_1(\mathcal{O}_X(D)|_{W_j}) \cap \text{div}_{W_j}(f_j)
$$
where $i'_j : W_j \to D$ is the inclusion map.
This is rationally equivalent to zero by Lemma \ref{lemma-factors}.
If $W_j \not \subset D$, then we see that
$i^*i_{j, *}\text{div}_{W_j}(f_j)$ is simply equal
to
$$
(i')^*\text{div}_{W_j}(f_j)
$$
where $i' : D \cap W_j \to W_j$ is the corresponding closed immersion
(see Lemma \ref{lemma-closed-in-X-gysin}).
Hence in this case Lemma \ref{lemma-gysin-factors-general} applies,
and we win.
\end{proof}








\section{Relative effective Cartier divisors}
\label{section-relative-effective-cartier}

\begin{lemma}
\label{lemma-relative-effective-cartier-algebra}
Let $A \to B$ be a ring map. Let $f \in B$. Assume that
\begin{enumerate}
\item $A \to B$ is flat,
\item $f$ is a nonzerodivisor, and
\item $A \to B/fB$ is flat.
\end{enumerate}
Then for every ideal $I \subset A$ the map
$f : B/IB \to B/IB$ is injective.
\end{lemma}

\begin{proof}
Note that $IB = I \otimes_A B$ and $I(B/fB) = I \otimes_A B/fB$
by the flatness of $B$ and $B/fB$ over $A$.
In particular $IB/fIB \cong I \otimes_A B/fB$ maps injectively
into $B/fB$. Hence the result follows from the snake lemma applied
to the diagram
$$
\xymatrix{
0 \ar[r] &
I \otimes_A B \ar[r] \ar[d]^f &
B \ar[r] \ar[d]^f &
B/IB \ar[r] \ar[d]^f &
0 \\
0 \ar[r] &
I \otimes_A B \ar[r] &
B \ar[r] &
B/IB \ar[r] &
0
}
$$
with exact rows.
\end{proof}

\begin{lemma}
\label{lemma-relative-effective-cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a flat morphism of relative dimension $r$.
Let $i : D \to X$ be an effective Cartier divisor with the property
that $p|_D : D \to Y$ is flat of relative dimension $r - 1$.
Let $\mathcal{L} = \mathcal{O}_X(D)$.
For any $\alpha \in A_{k + 1}(Y)$ we have
$$
i^*p^*\alpha = (p|_D)^*\alpha
$$
in $A_{k + r}(D)$ and
$$
c_1(\mathcal{L}) \cap p^*\alpha = i_* ((p|_D)^*\alpha)
$$
in $A_{k + r}(X)$.
\end{lemma}

\begin{proof}
Let $W \subset Y$ be an integral closed subvariety of $\delta$-dimension
$k + 1$. By Lemma \ref{lemma-relative-effective-cartier-algebra}
we see that $D \cap p^{-1}W$ is an effective
Cartier divisor on $p^{-1}W$. By Lemma \ref{lemma-easy-gysin}
we see that
$i^*[p^{-1}W]_{k + r + 1} = [D \cap W]_{k + r} = [(p|_D)^{-1}(W)]_{k + r}$.
Since by definition $p^*[W] = [p^{-1}W]_{k + r + 1}$ and
$(p|_D)^*[W] = [(p|_D)^{-1}(W)]_{k + r}$ we see we have equality
of cycles. Hence if $\alpha = \sum m_j[W_j]$, then we get
$i^*\alpha = \sum m_ji^*[W_j] = \sum m_j(p|_D)^*[W_j]$ as cycles.
This proves then first equality. To deduce the second from the
first apply Lemma \ref{lemma-support-cap-effective-Cartier}.
\end{proof}








\section{Affine bundles}
\label{section-affine-vector}

\begin{lemma}
\label{lemma-pullback-affine-fibres-surjective}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Assume that for every $y \in Y$, there exists an open neighbourhood
$U \subset Y$ such that $f|_{f^{-1}(U)} : f^{-1}(U) \to U$
is identified with the morphism $U \times \mathbf{A}^r \to U$.
Then $f^* : A_k(Y) \to A_{k + r}(X)$ is surjective for all
$k \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Let $\alpha \in A_{k + r}(X)$.
Write $\alpha = \sum m_j[W_j]$ with $m_j \not = 0$ and
$W_j$ pairwise distinct integral closed subschemes of
$\delta$-dimension $k + r$. Then the family $\{W_j\}$
is locally finite in $X$. For any quasi-compact open
$V \subset Y$ we see that $f^{-1}(V) \cap W_j$
is nonempty only for finitely many $j$. Hence the
collection $Z_j = \overline{f(W_j)}$ of closures
of images is a locally finite collection of integral
closed subschemes of $Y$.

\medskip\noindent
Consider the fibre product diagrams
$$
\xymatrix{
f^{-1}(Z_j) \ar[r] \ar[d]_{f_j} & X \ar[d]^f \\
Z_j \ar[r] & Y
}
$$
Suppose that $[W_j] \in Z_{k + r}(f^{-1}(Z_j))$
is rationally equivalent to $f_j^*\beta_j$ for some
$k$-cycle $\beta_j \in A_k(Z_j)$. Then
$\beta = \sum m_j \beta_j$ will be a $k$-cycle on $Y$
and $f^*\beta = \sum m_j f_j^*\beta_j$ will be rationally
equivalent to $\alpha$ (see
Remark \ref{remark-infinite-sums-rational-equivalences}).
This reduces us to the case $Y$ integral, and
$\alpha = [W]$ for some integral closed subscheme
of $X$ dominating $Y$. In particular we may
assume that $d = \dim_\delta(Y) < \infty$.

\medskip\noindent
Hence we can use induction on $d = \dim_\delta(Y)$.
If $d < k$, then $A_{k + r}(X) = 0$ and the lemma holds.
By assumption there exists a dense open $V \subset Y$ such
that $f^{-1}(V) \cong V \times \mathbf{A}^r$ as schemes over $V$.
Suppose that we can show that $\alpha|_{f^{-1}(V)} = f^*\beta$
for some $\beta \in Z_k(V)$. By Lemma \ref{lemma-exact-sequence-open}
we see that
$\beta = \beta'|_V$ for some $\beta' \in Z_k(Y)$.
By the exact sequence
$A_k(f^{-1}(Y \setminus V)) \to A_k(X) \to A_k(f^{-1}(V))$
of Lemma \ref{lemma-restrict-to-open}
we see that $\alpha - f^*\beta'$ comes from
a cycle $\alpha' \in A_{k + r}(f^{-1}(Y \setminus V))$.
Since $\dim_\delta(Y \setminus V) < d$ we win by
induction on $d$.

\medskip\noindent
Thus we may assume that $X = Y \times \mathbf{A}^r$.
In this case we can factor $f$ as
$$
X = Y \times \mathbf{A}^r \to
Y \times \mathbf{A}^{r - 1} \to \ldots \to
Y \times \mathbf{A}^1 \to Y.
$$
Hence it suffices to do the case $r = 1$. By the argument in the
second paragraph of the proof we are reduced to the case
$\alpha = [W]$, $Y$ integral, and $W \to Y$ dominant.
Again we can do induction on $d = \dim_\delta(Y)$.
If $W = Y \times \mathbf{A}^1$, then $[W] = f^*[Y]$.
Lastly, $W \subset Y \times \mathbf{A}^1$ is a proper inclusion,
then $W \to Y$ induces a finite field extension $R(Y) \subset R(W)$.
Let $P(T) \in R(Y)[T]$ be the monic irreducible polynomial such
that the generic fibre of $W \to Y$ is cut out by $P$ in
$\mathbf{A}^1_{R(Y)}$. Let $V \subset Y$ be a nonempty open such
that $P \in \Gamma(V, \mathcal{O}_Y)[T]$, and such that
$W \cap f^{-1}(V)$ is still cut out by $P$. Then we see that
$\alpha|_{f^{-1}(V)} \sim_{rat} 0$ and hence $\alpha \sim_{rat} \alpha'$
for some cycle $\alpha'$ on $(Y \setminus V) \times \mathbf{A}^1$.
By induction on the dimension we win.
\end{proof}

\begin{remark}
\label{remark-when-isomorphism}
We will see later (Lemma \ref{lemma-vectorbundle})
that if $X$ is a vectorbundle over $Y$ then
the pullback map $A_k(Y) \to A_{k + r}(X)$ is an isomorphism.
Is this true in general?
\end{remark}








\section{Projective space bundle formula}
\label{section-projective-space-bundle-formula}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Consider a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$.
Our convention is that the {\it projective bundle associated to
$\mathcal{E}$} is the morphism
$$
\xymatrix{
\mathbf{P}(\mathcal{E}) =
\underline{\text{Proj}}_X(\text{Sym}^*(\mathcal{E}))
\ar[r]^-\pi
& X
}
$$
over $X$ with
$\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$ normalized so that
$\pi_*(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)) = \mathcal{E}$.
In particular there is a surjection
$\pi^*\mathcal{E} \to \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
We will say informally ``let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$'' to denote
the situation where $P = \mathbf{P}(\mathcal{E})$ and
$\mathcal{O}_P(1) = \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.

\begin{lemma}
\label{lemma-cap-projective-bundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
For any $\alpha \in A_k(X)$ we the element
$$
\pi_*\left(
c_1(\mathcal{O}_P(1))^s \cap \pi^*\alpha
\right)
\in
A_{k + r - 1 - s}(X)
$$
is $0$ if $s < r - 1$ and is equal to $\alpha$ when $s = r - 1$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
Note that $\pi^*[Z] = [\pi^{-1}(Z)]$ as $\pi^{-1}(Z)$ is integral of
$\delta$-dimension $r - 1$.
If $s < r - 1$, then by construction
$c_1(\mathcal{O}_P(1))^s \cap \pi^*[Z]$
is represented by a $(k + r - 1 - s)$-cycle supported on
$\pi^{-1}(Z)$. Hence the pushforward of this cycle
is zero for dimension reasons.

\medskip\noindent
Let $s = r - 1$. By the argument given above we see that
$\pi_*(c_1(\mathcal{O}_P(1))^s \cap \pi^*\alpha) = n [Z]$
for some $n \in \mathbf{Z}$. We want to show that $n = 1$.
For the same dimension reasons
as above it suffices to prove this result after replacing $X$ by
$X \setminus T$ where $T \subset Z$ is a proper closed subset.
Let $\xi$ be the generic point of $Z$.
We can choose elements $e_1, \ldots, e_{r - 1} \in \mathcal{E}_\xi$
which form part of a basis of $\mathcal{E}_\xi$.
These give rational sections $s_1, \ldots, s_{r - 1}$
of $\mathcal{O}_P(1)|_{\pi^{-1}(Z)}$ whose common zero set
is the closure of the image a rational section of
$\mathbf{P}(\mathcal{E}|_Z) \to Z$ union a closed subset whose
support maps to a proper closed subset $T$ of $Z$.
After removing $T$ from $X$ (and correspondingly $\pi^{-1}(T)$
from $P$), we see that $s_1, \ldots, s_n$ form a sequence
of global sections
$s_i \in \Gamma(\pi^{-1}(Z), \mathcal{O}_{\pi^{-1}(Z)}(1))$
whose common zero set is the image of a section $Z \to \pi^{-1}(Z)$.
Hence we see successively that
\begin{eqnarray*}
\pi^*[Z] & = & [\pi^{-1}(Z)] \\
c_1(\mathcal{O}_P(1)) \cap \pi^*[Z] & = & [Z(s_1)] \\
c_1(\mathcal{O}_P(1))^2 \cap \pi^*[Z] & = & [Z(s_1) \cap Z(s_2)] \\
\ldots & = & \ldots \\
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*[Z] & = &
[Z(s_1) \cap \ldots \cap Z(s_{r - 1})]
\end{eqnarray*}
by repeated applications of Lemma \ref{lemma-geometric-cap}.
Since the pushforward by $\pi$ of the image of a
section of $\pi$ over $Z$ is clearly $[Z]$ we see the result
when $\alpha = [Z]$. We omit the verification that these
arguments imply the result for a general cycle $\alpha = \sum n_j [Z_j]$.
\end{proof}

\begin{lemma}[Projective space bundle formula]
\label{lemma-chow-ring-projective-bundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
The map
$$
\bigoplus\nolimits_{i = 0}^{r - 1}
A_{k + i}(X)
\longrightarrow
A_{k + r - 1}(P),
$$
$$
(\alpha_0, \ldots, \alpha_{r-1})
\longmapsto
\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*\alpha_{r-1}
$$
is an isomorphism.
\end{lemma}

\begin{proof}
Fix $k \in \mathbf{Z}$. We first show the map is injective.
Suppose that $(\alpha_0, \ldots, \alpha_{r - 1})$ is an element
of the left hand side that maps to zero.
By Lemma \ref{lemma-cap-projective-bundle} we see that
$$
0 = \pi_*(\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*\alpha_{r-1})
= \alpha_{r - 1}
$$
Next, we see that
$$
0 = \pi_*(c_1(\mathcal{O}_P(1)) \cap (\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 2} \cap \pi^*\alpha_{r - 2}))
= \alpha_{r - 2}
$$
and so on. Hence the map is injective.

\medskip\noindent
It remains to show the map is surjective.
Let $X_i$, $i \in I$ be the irreducible components of $X$.
Then $P_i = \mathbf{P}(\mathcal{E}|_{X_i})$, $i \in I$
are the irreducible components of $P$.
If the map is surjective for each of the morphisms
$P_i \to X_i$, then the map is
surjective for $\pi : P \to X$.
Details omitted. Hence we may assume $X$ is irreducible.
Thus $\dim_\delta(X) < \infty$ and in particular we may use
induction on $\dim_\delta(X)$.

\medskip\noindent
The result is clear if $\dim_\delta(X) < k$.
Let $\alpha \in A_{k + r - 1}(P)$.
For any locally closed subscheme $T \subset X$ denote
$\gamma_T : \bigoplus A_{k + i}(T) \to A_{k + r - 1}(\pi^{-1}(T))$
the map
$$
\gamma_T(\alpha_0, \ldots, \alpha_{r - 1})
= \pi^*\alpha_0 + \ldots +
c_1(\mathcal{O}_{\pi^{-1}(T)}(1))^{r - 1} \cap \pi^*\alpha_{r - 1}.
$$
Suppose for some nonempty open $U \subset X$ we have
$\alpha|_{\pi^{-1}(U)} = \gamma_U(\alpha_0, \ldots, \alpha_{r - 1})$.
Then we may choose lifts $\alpha'_i \in A_{k + i}(X)$ and we
see that $\alpha - \gamma_X(\alpha'_0, \ldots, \alpha'_{r - 1})$
is by Lemma \ref{lemma-restrict-to-open}
rationally equivalent to a $k$-cycle on $P_Y = \mathbf{P}(\mathcal{E}|_Y)$
where $Y = X \setminus U$ as a reduced closed subscheme.
Note that $\dim_\delta(Y) < \dim_\delta(X)$.
By induction the result holds
for $P_Y \to Y$ and hence the result holds for $\alpha$.
Hence we may replace $X$ by any nonempty open of $X$.

\medskip\noindent
In particular we may assume that $\mathcal{E} \cong \mathcal{O}_X^{\oplus r}$.
In this case $\mathbf{P}(\mathcal{E}) = X \times \mathbf{P}^{r - 1}$.
Let us use the stratification
$$
\mathbf{P}^{r - 1} = \mathbf{A}^{r - 1}
\coprod \mathbf{A}^{r - 2}
\coprod \ldots
\coprod \mathbf{A}^0
$$
The closure of each stratum is a $\mathbf{P}^{r - 1 - i}$ which is a
representative of $c_1(\mathcal{O}(1))^i \cap [\mathbf{P}^{r - 1}]$.
Hence $P$ has a similar stratification
$$
P = U^{r - 1} \coprod U^{r - 2} \coprod \ldots \coprod U^0
$$
Let $P^i$ be the closure of $U^i$. Let $\pi^i : P^i \to X$
be the restriction of $\pi$ to $P^i$.
Let $\alpha \in A_{k + r - 1}(P)$. By
Lemma \ref{lemma-pullback-affine-fibres-surjective}
we can write $\alpha|_{U^{r - 1}} = \pi^*\alpha_0|_{U^{r - 1}}$
for some $\alpha_0 \in A_k(X)$. Hence the difference
$\alpha - \pi^*\alpha_0$ is the image of some
$\alpha' \in A_{k + r - 1}(P^{r - 2})$.
By Lemma \ref{lemma-pullback-affine-fibres-surjective}
again we can write
$\alpha'|_{U^{r - 2}} = (\pi^{r - 2})^*\alpha_1|_{U^{r - 2}}$
for some $\alpha_1 \in A_{k + 1}(X)$.
By Lemma \ref{lemma-relative-effective-cartier}
we see that the image of $(\pi^{r - 2})^*\alpha_1$
represents $c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1$.
We also see that
$\alpha - \pi^*\alpha_0 - c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1$
is the image of some $\alpha'' \in A_{k + r - 1}(P^{r - 3})$.
And so on.
\end{proof}

\begin{lemma}
\label{lemma-vectorbundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let
$$
p :
E = \underline{\Spec}(\text{Sym}^*(\mathcal{E}))
\longrightarrow
X
$$
be the associated vector bundle over $X$.
Then $p^* : A_k(X) \to A_{k + r}(E)$ is an isomorphism for all $k$.
\end{lemma}

\begin{proof}
For surjectivity see Lemma \ref{lemma-pullback-affine-fibres-surjective}.
Let $(\pi  : P \to X, \mathcal{O}_P(1))$
be the projective space bundle associated
to the finite locally free sheaf $\mathcal{E} \oplus \mathcal{O}_X$.
Let $s \in \Gamma(P, \mathcal{O}_P(1))$ correspond to the global
section $(0, 1) \in \Gamma(X, \mathcal{E} \oplus \mathcal{O}_X)$.
Let $D = Z(s) \subset P$. Note that
$(\pi|_D : D \to X , \mathcal{O}_P(1)|_D)$
is the projective space bundle associated
to $\mathcal{E}$. We denote $\pi_D = \pi|_D$ and
$\mathcal{O}_D(1) = \mathcal{O}_P(1)|_D$.
Moreover, $D$ is an effective
Cartier divisor on $P$. Hence $\mathcal{O}_P(D) = \mathcal{O}_P(1)$
(see Divisors, Lemma \ref{divisors-lemma-characterize-OD}).
Also there is an isomorphism
$E \cong P \setminus D$. Denote $j : E \to P$ the
corresponding open immersion.
For injectivity we use that the kernel of
$$
j^* :
A_{k + r}(P)
\longrightarrow
A_{k + r}(E)
$$
are the cycles supported in the effective Cartier divisor $D$,
see Lemma \ref{lemma-restrict-to-open}. So if $p^*\alpha = 0$, then
$\pi^*\alpha = i_*\beta$ for some $\beta \in A_{k + r}(D)$.
By Lemma \ref{lemma-chow-ring-projective-bundle} we may write
$$
\beta = \pi_D^*\beta_0 +
\ldots + c_1(\mathcal{O}_D(1))^{r - 1} \cap \pi_D^* \beta_{r - 1}.
$$
for some $\beta_i \in A_{k + i}(X)$.
By Lemmas \ref{lemma-relative-effective-cartier}
and \ref{lemma-pushforward-cap-c1}
this implies
$$
\pi^*\alpha = i_*\beta =
c_1(\mathcal{O}_P(1)) \cap \pi^*\beta_0 +
\ldots +
c_1(\mathcal{O}_D(1))^r \cap \pi^*\beta_{r - 1}.
$$
Since the rank of $\mathcal{E} \oplus \mathcal{O}_X$ is $r + 1$
this contradicts Lemma \ref{lemma-pushforward-cap-c1} unless all
$\alpha$ and all $\beta_i$ are zero.
\end{proof}








\section{The Chern classes of a vector bundle}
\label{section-chern-classes-vector-bundles}

\noindent
We can use the projective space bundle formula to define the
chern classes of a rank $r$ vector bundle in terms of the expansion
of $c_1(\mathcal{O}(1))^r$ in terms of the lower powers, see
formula (\ref{equation-chern-classes}).
The reason for the signs will be explained later.

\begin{definition}
\label{definition-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$
on $X$. Let $(\pi : P \to X, \mathcal{O}_P(1))$ be the projective space
bundle associated to $\mathcal{E}$.
\begin{enumerate}
\item By Lemma \ref{lemma-chow-ring-projective-bundle} there are
elements $c_i \in A_{n - i}(X)$, $i = 0, \ldots, r$
such that $c_0 = [X]$, and
\begin{equation}
\label{equation-chern-classes}
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
\item With notation as above we set
$c_i(\mathcal{E}) \cap [X] = c_i$
as an element of $A_{n - i}(X)$.
We call these the {\it chern classes of $\mathcal{E}$ on $X$}.
\item The {\it total chern class of $\mathcal{E}$ on $X$}
is the combination
$$
c({\mathcal E}) \cap [X] =
c_0({\mathcal E}) \cap [X]
+ c_1({\mathcal E}) \cap [X] + \ldots
+ c_r({\mathcal E}) \cap [X]
$$
which is an element of
$A_*(X) = \bigoplus_{k \in \mathbf{Z}} A_k(X)$.
\end{enumerate}
\end{definition}

\noindent
Let us check that this does not give a new notion in case the
vector bundle has rank $1$.

\begin{lemma}
\label{lemma-first-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
The first chern class of $\mathcal{L}$ on $X$ of
Definition \ref{definition-chern-classes}
is equal to the Weil divisor associated to $\mathcal{L}$
by Definition \ref{definition-divisor-invertible-sheaf}.
\end{lemma}

\begin{proof}
In this proof we use $c_1(\mathcal{L}) \cap [X]$ to denote the
construction of Definition \ref{definition-divisor-invertible-sheaf}.
Since $\mathcal{L}$ has rank $1$ we have
$\mathbf{P}(\mathcal{L}) = X$ and
$\mathcal{O}_{\mathbf{P}(\mathcal{L})}(1) = \mathcal{L}$
by our normalizations. Hence (\ref{equation-chern-classes})
reads
$$
(-1)^1 c_1(\mathcal{L}) \cap c_0 + (-1)^0 c_1 = 0
$$
Since $c_0 = [X]$, we conclude $c_1 = c_1(\mathcal{L}) \cap [X]$
as desired.
\end{proof}

\begin{remark}
\label{remark-equation-signs}
We could also rewrite equation \ref{equation-chern-classes} as
\begin{equation}
\label{equation-signs}
\sum\nolimits_{i = 0}^r
c_1(\mathcal{O}_P(-1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
but we find it easier to work with the tautological quotient
sheaf $\mathcal{O}_P(1)$ instead of
its dual.
\end{remark}




\section{Intersecting with chern classes}
\label{section-intersecting-chern-classes}

\begin{definition}
\label{definition-cap-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
We define, for every integer $k$ and any $0 \leq j \leq r$,
an operation
$$
c_j(\mathcal{E}) \cap - : Z_k(X) \to A_{k - j}(X)
$$
called {\it intersection with the $j$th chern class of $\mathcal{E}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ of $\delta$-dimension
$k$ we define
$$
c_j(\mathcal{E}) \cap [W] = i_*(c_j({i^*\mathcal{E}}) \cap [W])
\in
A_{k - j}(X)
$$
where $c_j({i^*\mathcal{E}}) \cap [W]$ is as defined in
Definition \ref{definition-chern-classes}.
\item For a general $k$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_j(\mathcal{E}) \cap \alpha = \sum n_i c_j(\mathcal{E}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Again, if $\mathcal{E}$ has rank $1$ then this agrees with our
previous definition.

\begin{lemma}
\label{lemma-determine-intersections}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $(\pi : P \to X, \mathcal{O}_P(1))$ be the projective bundle
associated to $\mathcal{E}$.
For $\alpha \in Z_k(X)$ the elements
$c_j(\mathcal{E}) \cap \alpha$ are the unique elements
$\alpha_j$ of $A_{k - j}(X)$
such that $\alpha_0 = \alpha$ and
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
holds in the Chow group of $P$.
\end{lemma}

\begin{proof}
The uniqueness of $\alpha_0, \ldots, \alpha_r$ such that
$\alpha_0 = \alpha$ and such that
the displayed equation holds follows from
the projective space bundle formula
Lemma \ref{lemma-chow-ring-projective-bundle}.
The identity holds by definition for $\alpha = [X]$.
For a general $k$-cycle $\alpha$ on $X$ write
$\alpha = \sum n_a[W_a]$ with $n_a \not = 0$, and
$i_a : W_a \to X$ pairwise distinct integral closed subschemes.
Then the family $\{W_a\}$ is locally finite on $X$.
Set $P_a = \pi^{-1}(W_a) = \mathbf{P}(\mathcal{E}|_{W_a})$.
Denote $i'_a : P_a \to P$ the corresponding closed immersions.
Consider the fibre product diagram
$$
\xymatrix{
P' \ar@{=}[r] \ar[d]_{\pi'} &
\coprod P_a \ar[d]_{\pi_a} \ar[r]_{i'_a} &
P \ar[d]^\pi \\
X' \ar@{=}[r] &
\coprod W_a \ar[r]^{i_a} &
X
}
$$
The morphism $p : X' \to X$ is proper. Moreover
$\pi' : P' \to X'$ together with the invertible sheaf
$\mathcal{O}_{P'}(1) = \coprod \mathcal{O}_{P_a}(1)$
which is also the pullback of $\mathcal{O}_P(1)$
is the projective bundle associated to
$\mathcal{E}' = p^*\mathcal{E}$. By definition
$$
c_j(\mathcal{E}) \cap [\alpha]
=
\sum i_{a, *}(c_j(\mathcal{E}|_{W_a}) \cap [W_a]).
$$
Write $\beta_{a, j} = c_j(\mathcal{E}|_{W_a}) \cap [W_a]$
which is an element of $A_{k - j}(W_a)$. We have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_a}(1))^i \cap \pi_a^*(\beta_{a, r - i}) = 0
$$
for each $a$ by definition. Thus clearly we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P'}(1))^i \cap (\pi')^*(\beta_{r - i}) = 0
$$
with $\beta_j = \sum n_a\beta_{a, j} \in A_{k - j}(X')$. Denote
$p' : P' \to P$ the morphism $\coprod i'_a$.
We have $\pi^*p_*\beta_j = p'_*(\pi')^*\beta_j$
by Lemma \ref{lemma-flat-pullback-proper-pushforward}.
By the projection formula of Lemma \ref{lemma-pushforward-cap-c1}
we conclude that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap \pi^*(p_*\beta_j) = 0
$$
Since $p_*\beta_j$ is a representative of $c_j(\mathcal{E}) \cap \alpha$
we win.
\end{proof}

\noindent
This characterization of chern classes allows us to prove many more
properties.

\begin{lemma}
\label{lemma-cap-chern-class-factors-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
If $\alpha \sim_{rat} \beta$ are rationally equivalent $k$-cycles
on $X$ then $c_j(\mathcal{E}) \cap \alpha = c_j(\mathcal{E}) \cap \beta$
in $A_{k - j}(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-determine-intersections} the elements
$\alpha_j = c_j(\mathcal{E}) \cap \alpha$, $j \geq 1$ and
$\beta_j = c_j(\mathcal{E}) \cap \beta$, $j \geq 1$ are uniquely determined
by the {\it same} equation in the chow group of the projective
bundle associated to $\mathcal{E}$. (This of course relies on the fact that
flat pullback is compatible with rational equivalence, see
Lemma \ref{lemma-flat-pullback-rational-equivalence}.) Hence they are equal.
\end{proof}

\noindent
In other words capping with chern classes of
finite locally free sheaves factors through rational equivalence
to give maps
$$
c_j(\mathcal{E}) \cap - : A_k(X) \to A_{k - j}(X).
$$

\begin{lemma}
\label{lemma-flat-pullback-cap-cj}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $Y$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_j(\mathcal{E}) \cap \alpha) = c_j(f^*\mathcal{E}) \cap f^*\alpha
$$
\end{lemma}

\begin{proof}
Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so $\alpha_0 = \alpha$.
By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to Y, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Consider the fibre product diagram
$$
\xymatrix{
P_X = \mathbf{P}(f^*\mathcal{E}) \ar[r]_-{f_P} \ar[d]_{\pi_X} &
P \ar[d]^\pi \\
X \ar[r]^f & Y
}
$$
Note that $\mathcal{O}_{P_X}(1) = f_P^*\mathcal{O}_P(1)$.
By Lemmas \ref{lemma-flat-pullback-cap-c1} and
\ref{lemma-compose-flat-pullback} we see that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_X}(1))^i \cap
\pi_X^*(f^*\alpha_{r - i}) = 0
$$
holds in the chow group of $P_X$. Since $f^*\alpha_0 = f^*\alpha$
the lemma follows from
the uniqueness in Lemma \ref{lemma-determine-intersections}.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-cap-cj}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha$ be a $k$-cycle on $X$.
Let $\mathcal{E}$ be a finite locally free sheaf on $Y$.
Then
$$
p_*(c_j(p^*\mathcal{E}) \cap \alpha) = c_j(\mathcal{E}) \cap p_*\alpha
$$
\end{lemma}

\begin{proof}
Write $\alpha_j = c_j(p^*\mathcal{E}) \cap \alpha$, so $\alpha_0 = \alpha$.
By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi_X^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi_X : P_X \to X, \mathcal{O}_{P_X}(1))$
associated to $p^*\mathcal{E}$. Let
$(\pi : P \to Y, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
Consider the fibre product diagram
$$
\xymatrix{
P_X = \mathbf{P}(p^*\mathcal{E}) \ar[r]_-{p_P} \ar[d]_{\pi_X} &
P \ar[d]^\pi \\
X \ar[r]^p & Y
}
$$
Note that $\mathcal{O}_{P_X}(1) = p_P^*\mathcal{O}_P(1)$.
Pushing the displayed equality above to $P$ and using
Lemmas \ref{lemma-flat-pullback-proper-pushforward},
\ref{lemma-pushforward-cap-c1} and
\ref{lemma-compose-flat-pullback} we see that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(p_*\alpha_{r - i}) = 0
$$
holds in the chow group of $P$. Since $p_*\alpha_0 = p_*\alpha$
the lemma follows from
the uniqueness in Lemma \ref{lemma-determine-intersections}.
\end{proof}

\begin{lemma}
\label{lemma-cap-commutative-chern}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves on $X$
of ranks $r$ and $s$.
For any $\alpha \in A_k(X)$ we have
$$
c_i(\mathcal{E}) \cap c_j(\mathcal{F}) \cap \alpha
=
c_j(\mathcal{F}) \cap c_i(\mathcal{E}) \cap \alpha
$$
as elements of $A_{k - i - j}(X)$.
\end{lemma}

\begin{proof}
Consider
$$
\pi : \mathbf{P}(\mathcal{E}) \times_X \mathbf{P}(\mathcal{F})
\longrightarrow
X
$$
with invertible sheaves
$\mathcal{L} = \text{pr}_1^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$
and
$\mathcal{N} = \text{pr}_2^*\mathcal{O}_{\mathbf{P}(\mathcal{F})}(1)$.
Write $\alpha_{i, j}$ for the left hand side and $\beta_{i, j}$
for the right hand side.
Also write
$\alpha_j = c_j(\mathcal{F}) \cap \alpha$ and
$\beta_i = c_i(\mathcal{E}) \cap \alpha$.
In particular this means that $\alpha_0 = \alpha = \beta_0$,
and $\alpha_{0, j} = \alpha_j = \beta_{0, j}$,
$\alpha_{i, 0} = \beta_i = \beta_{i, 0}$.
From Lemma \ref{lemma-determine-intersections}
(pulled back to the space above using Lemma \ref{lemma-flat-pullback-cap-c1}
for the first two) we see that
\begin{eqnarray*}
0 & = &
\sum\nolimits_{j = 0, \ldots, s}
(-1)^j c_1(\mathcal{N})^j \cap \pi^*\alpha_{s - j}
\\
0 & = &
\sum\nolimits_{i = 0, \ldots, r}
(-1)^i c_1(\mathcal{L})^i \cap \pi^*\beta_{r - i}
\\
0 & = &
\sum\nolimits_{i = 0, \ldots, r}
(-1)^i
c_1(\mathcal{L})^i \cap \pi^*\alpha_{r - i, s - j}
\\
0 & = &
\sum\nolimits_{j = 0, \ldots, s}
(-1)^j
c_1(\mathcal{N})^j \cap \pi^*\beta_{r - i,  s - j}
\end{eqnarray*}
We can combine the first and the third of these to get
\begin{align*}
& (-1)^{r + s} c_1(\mathcal{L})^r \cap c_1(\mathcal{N})^s \cap \pi^*\alpha \\
& =
\sum\nolimits_{j = 1, \ldots, s}
(-1)^{r + j - 1}
c_1(\mathcal{L})^r \cap c_1(\mathcal{N})^j \cap \pi^*\alpha_{s - j}
\\
& =
\sum\nolimits_{j = 1, \ldots, s}
(-1)^{j - 1 + r} c_1(\mathcal{N})^j \cap
c_1(\mathcal{L})^r \cap \pi^*\alpha_{0, s - j}
\\
& =
\sum\nolimits_{j = 1}^s
\sum\nolimits_{i = 1}^r
(-1)^{i + j}
c_1(\mathcal{N})^j \cap c_1(\mathcal{L})^i \cap \pi^*\alpha_{r - i, s - j}
\end{align*}
using that capping with $c_1(\mathcal{L})$ commutes with
capping with $c_1(\mathcal{N})$. In exactly the same way one
shows that
$$
(-1)^{r + s} c_1(\mathcal{L})^r \cap c_1(\mathcal{N})^s \cap \pi^*\alpha
=
\sum\nolimits_{j = 1}^s
\sum\nolimits_{i = 1}^r
(-1)^{i + j}
c_1(\mathcal{N})^j \cap c_1(\mathcal{L})^i \cap \pi^*\beta_{r - i, s - j}
$$
By the projective space bundle formula
Lemma \ref{lemma-chow-ring-projective-bundle}
applied twice these representations
are unique. Whence the result.
\end{proof}









\section{Polynomial relations among chern classes}
\label{section-relations-chern-classes}

\begin{definition}
\label{definition-polynomial-relation-chern-classes}
Let $P(x_{i, j}) \in \mathbf{Z}[x_{i, j}]$ be a polynomial.
We write $P$ as a finite sum
$$
\sum\nolimits_s
\sum\nolimits_{I = ((i_1, j_1), (i_2, j_2), \ldots, (i_s, j_s))}
a_I x_{i_1, j_1} \ldots x_{i_s, j_s}.
$$
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}_i$ be a finite collection of finite
locally free sheaves on $X$. We say that $P$
is a {\it polynomial relation among the chern classes}
and we write $P(c_j(\mathcal{E}_i)) = 0$
if for any morphism $f : Y \to X$ of an integral scheme
locally of finite type over $S$ the cycle
$$
\sum\nolimits_s
\sum\nolimits_{I = ((i_1, j_1), (i_2, j_2), \ldots, (i_s, j_s))}
a_I\ c_{j_1}(f^*\mathcal{E}_{i_1}) \cap \ldots
\cap c_{j_s}(f^*\mathcal{E}_{i_s}) \cap [Y]
$$
is zero in $A_*(Y)$.
\end{definition}

\noindent
This is not an elegant definition but it will do
for now. It makes sense because we showed in
Lemma \ref{lemma-cap-commutative-chern} that
capping with chern classes of vector bundles is commutative.
By our definitions and results above
this is equivalent with requiring all the
operations
$$
\sum\nolimits_s
\sum\nolimits_I
a_I\ c_{j_1}(f^*\mathcal{E}_{i_1}) \cap \ldots
\cap c_{j_s}(f^*\mathcal{E}_{i_s}) \cap - :
A_*(Y) \to A_*(Y)
$$
to be zero for all morphisms $f : Y \to X$ which are locally of finite type.

\medskip\noindent
An example of such a relation is the relation
$$
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N})
=
c_1(\mathcal{L}) + c_1(\mathcal{N})
$$
proved in Lemma \ref{lemma-c1-cap-additive}.
More generally, here is what happens when we tensor an
arbitrary locally free sheaf by an invertible sheaf.

\begin{lemma}
\label{lemma-chern-classes-E-tensor-L}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of
rank $r$ on $X$. Let $\mathcal{L}$ be an invertible
sheaf on $X$. Then
\begin{equation}
\label{equation-twist}
c_i({\mathcal E} \otimes {\mathcal L})
=
\sum\nolimits_{j = 0}^i
\binom{r - i + j}{j} c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
\end{equation}
is a valid polynomial relation in the sense described above.
\end{lemma}

\begin{proof}
This should hold for any triple $(X, \mathcal{E}, \mathcal{L})$.
In particular it should hold when $X$ is integral, and in fact by
definition of a polynomial relation it is enough to prove
it holds when capping with $[X]$ for such $X$. Thus assume
that $X$ is integral. Let $(\pi : P \to X, \mathcal{O}_P(1))$,
resp.\ $(\pi' : P' \to X, \mathcal{O}_{P'}(1))$ be the
projective space bundle associated to $\mathcal{E}$,
resp.\ $\mathcal{E} \otimes \mathcal{L}$. Consider the canonical morphism
$$
\xymatrix{
P \ar[rd]_\pi \ar[rr]_g & & P' \ar[ld]^{\pi'} \\
& X &
}
$$
see Constructions, Lemma \ref{constructions-lemma-twisting-and-proj}.
It has the property that
$g^*\mathcal{O}_{P'}(1)
= \mathcal{O}_P(1) \otimes \pi^* {\mathcal L}$.
This means that we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i
(\xi + x)^i \cap \pi^*(c_{r - i}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
=
0
$$
in $A_*(P)$, where $\xi$ represents
$c_1(\mathcal{O}_P(1))$ and $x$
represents $c_1(\pi^*\mathcal{L})$. By simple algebra this
is equivalent to
$$
\sum\nolimits_{i = 0}^r
(-1)^i \xi^i \left(
\sum\nolimits_{j = i}^r
(-1)^{j - i}
\binom{j}{i}
x^{j - i} \cap
\pi^*(c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
\right)
=
0
$$
Comparing with
Equation (\ref{equation-chern-classes}) it follows from this that
$$
c_{r - i}(\mathcal{E}) \cap [X] =
\sum\nolimits_{j = i}^r
\binom{j}{i}
(-c_1(\mathcal{L}))^{j - i} \cap
c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X]
$$
Reworking this (getting rid of minus signs, and renumbering) we get
the desired relation.
\end{proof}

\noindent
Some example cases of (\ref{equation-twist}) are
\begin{align*}
c_1(\mathcal{E} \otimes \mathcal{L})
& =
c_1(\mathcal{E}) +
r c_1(\mathcal{L}) \\
c_2(\mathcal{E} \otimes \mathcal{L})
& =
c_2(\mathcal{E}) +
(r - 1) c_1(\mathcal{E}) c_1(\mathcal{L}) +
\binom{r}{2} c_1(\mathcal{L})^2 \\
c_3(\mathcal{E} \otimes \mathcal{L})
& =
c_3(\mathcal{E}) +
(r - 2) c_2(\mathcal{E})c_1(\mathcal{L}) +
\binom{r - 1}{2} c_1(\mathcal{E})c_1(\mathcal{L})^2 +
\binom{r}{3} c_1(\mathcal{L})^3
\end{align*}








\section{Additivity of chern classes}
\label{section-additivity-chern-classes}

\noindent
All of the preliminary lemmas follow trivially from the
final result.

\begin{lemma}
\label{lemma-get-rid-of-trivial-subbundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves
on $X$ of ranks $r$, $r - 1$ which fit into a short
exact sequence
$$
0 \to \mathcal{O}_X \to \mathcal{E} \to \mathcal{F} \to 0
$$
Then
$$
c_r(\mathcal{E}) = 0, \quad
c_j(\mathcal{E}) = c_j(\mathcal{F}), \quad j = 0, \ldots, r - 1
$$
are valid polynomial relations among chern classes.
\end{lemma}

\begin{proof}
By Definition \ref{definition-polynomial-relation-chern-classes}
it suffices to show that if $X$ is integral
then $c_j(\mathcal{E}) \cap [X] = c_j(\mathcal{F}) \cap [X]$.
Let $(\pi : P \to X, \mathcal{O}_P(1))$,
resp. $(\pi' : P' \to X, \mathcal{O}_{P'}(1))$ denote the
projective space bundle associated to $\mathcal{E}$, resp.\ $\mathcal{F}$.
The surjection $\mathcal{E} \to \mathcal{F}$ gives rise
to a closed immersion
$$
i : P' \longrightarrow P
$$
over $X$. Moreover, the element
$1 \in \Gamma(X, \mathcal{O}_X) \subset \Gamma(X, \mathcal{E})$
gives rise to a global section $s \in \Gamma(P, \mathcal{O}_P(1))$
whose zero set is exactly $P'$. Hence $P'$ is an effective Cartier
divisor on $P$ such that $\mathcal{O}_P(P') \cong \mathcal{O}_P(1)$.
Hence we see that
$$
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha = i_*((\pi')^*\alpha)
$$
for any cycle class $\alpha$ on $X$ by
Lemma \ref{lemma-relative-effective-cartier}.
By Lemma \ref{lemma-determine-intersections} we see that
$\alpha_j = c_j(\mathcal{F}) \cap [X]$, $j = 0, \ldots, r - 1$
satisfy
$$
\sum\nolimits_{j = 0}^{r - 1} (-1)^jc_1(\mathcal{O}_{P'}(1))^j
\cap (\pi')^*\alpha_j = 0
$$
Pushing this to $P$ and using the remark above as well as
Lemma \ref{lemma-pushforward-cap-c1} we get
$$
\sum\nolimits_{j = 0}^{r - 1}
(-1)^j c_1(\mathcal{O}_P(1))^{j + 1}
\cap \pi^*\alpha_j = 0
$$
By the uniqueness of Lemma \ref{lemma-determine-intersections}
we conclude that
$c_r(\mathcal{E}) \cap [X] = 0$ and
$c_j(\mathcal{E}) \cap [X] = \alpha_j = c_j(\mathcal{F}) \cap [X]$
for $j = 0, \ldots, r - 1$. Hence the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-additivity-invertible-subsheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves
on $X$ of ranks $r$, $r - 1$ which fit into a short
exact sequence
$$
0 \to \mathcal{L} \to \mathcal{E} \to \mathcal{F} \to 0
$$
where $\mathcal{L}$ is an invertible sheaf
Then
$$
c(\mathcal{E}) = c(\mathcal{L}) c(\mathcal{F})
$$
is a valid polynomial relation among chern classes.
\end{lemma}

\begin{proof}
This relation really just says that
$c_i(\mathcal{E}) = c_i(\mathcal{F}) + c_1(\mathcal{L})c_{i - 1}(\mathcal{F})$.
By Lemma \ref{lemma-get-rid-of-trivial-subbundle}
we have $c_j(\mathcal{E} \otimes \mathcal{L}^{\otimes -1})
= c_j(\mathcal{E} \otimes \mathcal{L}^{\otimes -1})$ for
$j = 0, \ldots, r$ (were we set $c_r(\mathcal{F}) = 0$ by
convention).
Applying Lemma \ref{lemma-chern-classes-E-tensor-L} we deduce
$$
\sum_{j = 0}^i
\binom{r - i + j}{j} (-1)^j c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
=
\sum_{j = 0}^i
\binom{r - 1 - i + j}{j} (-1)^j c_{i - j}({\mathcal F}) c_1({\mathcal L})^j
$$
Setting
$c_i(\mathcal{E}) = c_i(\mathcal{F}) + c_1(\mathcal{L})c_{i - 1}(\mathcal{F})$
gives a ``solution'' of this equation. The lemma follows if we show
that this is the only possible solution. We omit the verification.
\end{proof}

\begin{lemma}
\label{lemma-additivity-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose that ${\mathcal E}$ sits in an
exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
of finite locally free sheaves $\mathcal{E}_i$ of rank $r_i$.
Then
$$
c({\mathcal E}) = c({\mathcal E}_1) c({\mathcal E}_2)
$$
is a polynomial relation among chern classes.
\end{lemma}

\begin{proof}
We may assume that $X$ is integral and we have to show the
identity when capping against $[X]$.
By induction on $r_1$. The case $r_1 = 1$ is
Lemma \ref{lemma-additivity-invertible-subsheaf}.
Assume $r_1 > 1$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
denote the projective space bundle associated to $\mathcal{E}_1$. Note that
\begin{enumerate}
\item $\pi^* : A_*(X) \to A_*(P)$ is injective, and
\item $\pi^*\mathcal{E}_1$ sits in a short exact sequence
$0 \to \mathcal{F} \to \pi^*\mathcal{E}_1 \to \mathcal{L} \to 0$
where $\mathcal{L}$ is invertible.
\end{enumerate}
The first assertion follows from the projective space bundle formula
and the second follows from the definition of a projective space bundle.
(In fact $\mathcal{L} = \mathcal{O}_P(1)$.)
Let $Q = \pi^*\mathcal{E}/\mathcal{F}$, which sits in an
exact sequence $0 \to \mathcal{L} \to Q \to \pi^*\mathcal{E}_2 \to 0$.
By induction we have
\begin{eqnarray*}
c(\pi^*\mathcal{E}) \cap [P]
& = &
c(\mathcal{F}) \cap c(\pi^*\mathcal{E}/\mathcal{F}) \cap [P] \\
& = &
c(\mathcal{F}) \cap c(\mathcal{L}) \cap c(\pi^*\mathcal{E}_2) \cap [P] \\
& = &
c(\pi^*\mathcal{E}_1) \cap c(\pi^*\mathcal{E}_2) \cap [P]
\end{eqnarray*}
Since $[P] = \pi^*[X]$ we
win by Lemma \ref{lemma-flat-pullback-cap-cj}.
\end{proof}

\begin{lemma}
\label{lemma-chern-filter-by-linebundles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let ${\mathcal L}_i$, $i = 1, \ldots, r$ be invertible
$\mathcal{O}_X$-modules on $X$.
Let $\mathcal{E}$ be a finite locally free rank $r$
$\mathcal{O}_X$-module endowed with a filtration
$$
0 = \mathcal{E}_0 \subset \mathcal{E}_1 \subset \mathcal{E}_2
\subset \ldots \subset \mathcal{E}_r = \mathcal{E}
$$
such that $\mathcal{E}_i/\mathcal{E}_{i - 1} \cong \mathcal{L}_i$.
Set $c_1({\mathcal L}_i) = x_i$. Then
$$
c(\mathcal{E})
=
\prod\nolimits_{i = 1}^r (1 + x_i)
$$
is a valid polynomial relation among chern classes in the sense of
Definition \ref{definition-polynomial-relation-chern-classes}.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-additivity-invertible-subsheaf} and induction.
\end{proof}





\section{The splitting principle}
\label{section-splitting-principle}

\noindent
In our setting it is not so easy to say what the splitting principle
exactly says/is. Here is a possible formulation.

\begin{lemma}
\label{lemma-splitting-principle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf ${\mathcal E}$ on $X$
of rank $r$.
There exists a projective flat morphism of relative dimension $d$
$\pi : P \to X$ such that
\begin{enumerate}
\item for any morphism $f : Y \to X$ the map
$\pi_Y^* : A_*(Y) \to A_{* + r}(Y \times_X P)$ is injective, and
\item $\pi^*{\mathcal E}$ has a filtration
with successive quotients ${\mathcal L}_1, \ldots, {\mathcal L}_r$
for some invertible ${\mathcal O}_P$-modules ${\mathcal L}_i$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Use a composition of projective space bundles,
i.e., a flag variety over $X$.
\end{proof}

\noindent
The splitting principle refers to the practice of
symbolically writing
$$
c({\mathcal E}) = \prod\nolimits (1+x_i)
$$
with $x_i = c_1(\mathcal{L}_i)$. The expressions $x_i$ are then
called the {\it Chern roots} of ${\mathcal E}$.
In order to prove polynomial relations among chern classes of
vector bundles it is permissible to do calculations using the
chern roots.

\medskip\noindent
For example, let us calculate the chern classes of the
dual vector bundle $\mathcal{E}^\wedge$. Note that
if $\mathcal{E}$ has a filtration with subquotients
invertible sheaves $\mathcal{L}_i$ then $\mathcal{E}^\wedge$
has a filtration with subquotients the invertible sheaves
$\mathcal{L}_i^{-1}$. Hence if $x_i$ are the chern roots of
$\mathcal{E}$, then the $-x_i$ are the chern roots of
$\mathcal{E}^\wedge$. It follows that
$$
c_j(\mathcal{E}^\wedge) = (-1)^j c_j(\mathcal{E})
$$
is a valid polynomial relation among chern classes.

\medskip\noindent
In the same vain, let us compute the chern classes of
a tensor product of vector bundles.
Namely, suppose that $\mathcal{E}$, $\mathcal{F}$
are finite locally free of ranks $r$, $s$.
Write
$$
c(\mathcal{E}) = \prod\nolimits_{i = 1}^r (1 + x_i),
\quad
c(\mathcal{E}) = \prod\nolimits_{j = 1}^s (1 + y_j)
$$
where $x_i$, $y_j$ are the chern roots of $\mathcal{E}$,
$\mathcal{F}$. Then we see that
$$
c(\mathcal{E} \otimes_{\mathcal{O}_X} \mathcal{F})
=
\prod\nolimits_{i, j} (1 + x_i + y_j)
$$
Here are some examples of what this means in terms of
chern classes
$$
c_1(\mathcal{E} \otimes \mathcal{F})
=
r c_1(\mathcal{F}) + s c_1(\mathcal{E})
$$
$$
c_2(\mathcal{E} \otimes \mathcal{F})
=
r^2 c_2(\mathcal{F}) +
rs c_1(\mathcal{F})c_1(\mathcal{E}) +
s^2 c_2(\mathcal{E})
$$



\section{Chern classes and tensor product}
\label{section-chern-classes-tensor}

\noindent
We define the {\it Chern character} of a finite locally free
sheaf of rank $r$ to be the formal expression
$$
ch({\mathcal E}) := \sum\nolimits_{i=1}^r e^{x_i}
$$
if the $x_i$ are the chern roots of ${\mathcal E}$. Writing this in
terms of chern classes $c_i = c_i(\mathcal{E})$
we see that
$$
ch(\mathcal{E}) =
r
+
c_1
+
\frac{1}{2}(c_1^2 - 2c_2)
+
\frac{1}{6}(c_1^3 - 3c_1c_2 + 3c_3)
+
\frac{1}{24}(c_1^4 - 4c_1^2c_2 + 4c_1c_3 + 2c_2^2 - 4c_4)
+
\ldots
$$
What does it mean that the coefficients are rational numbers?
Well this simply means that we think of these as operations
$$
ch_j(\mathcal{E}) \cap - :
A_k(X)
\longrightarrow
A_{k - j}(X) \otimes_{\mathbf{Z}} \mathbf{Q}
$$
and we think of polynomial relations among them as relations
between these operations with values in the groups
$A_{k - j}(Y) \otimes_{\mathbf{Z}} \mathbf{Q}$ for varying $Y$.
By the above
we have in case of an exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
that
$$
ch({\mathcal E}) = ch({\mathcal E}_1) + ch({\mathcal E}_2)
$$
Using the Chern character we can express the compatibility
of the chern classes and tensor product as follows:
$$
ch({\mathcal E}_1 \otimes_{{\mathcal O}_X} {\mathcal E}_2) =
ch({\mathcal E}_1) ch({\mathcal E}_2)
$$
This follows directly from the discussion of the chern roots
of the tensor product in the previous section.


\section{Todd classes}
\label{section-todd-classes}

\noindent
A final class associated to a vector bundle $\mathcal{E}$
of rank $r$ is its {\it Todd class} $Todd(\mathcal{E})$.
In terms of the chern roots $x_1, \ldots, x_r$ it is
defined as
$$
Todd(\mathcal{E})
=
\prod\nolimits_{i = 1}^r
\frac{x_i}{1 - e^{-x_i}}
$$
In terms of the chern classes $c_i = c_i(\mathcal{E})$
we have
$$
Todd(\mathcal{E})
=
1
+
\frac{1}{2}c_1
+
\frac{1}{12}(c_1^2 + c_2)
+
\frac{1}{24}c_1c_2
+
\frac{1}{720}(-c_1^4 + 4c_1^2c_2 + 3c_2^2 + c_1c_3 - c_4)
+
\ldots
$$
We have made the appropriate remarks about denominators
in the previous section. It is the case that
given an exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
we have
$$
Todd({\mathcal E}) = Todd({\mathcal E}_1) Todd({\mathcal E}_2).
$$

\section{Grothendieck-Riemann-Roch}
\label{section-grr}

\noindent
Let $(S, \delta)$ be as in
Situation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf
${\mathcal E}$ on $X$ of rank $r$.
Let $f : X \to Y$ be a proper smooth morphism.
Assume that $R^if_*\mathcal{E}$ are locally free
sheaves on $Y$ of finite rank (for example if $Y$ is a point).
The Grothendieck-Riemann-Roch theorem implies that in this
case we have
$$
f_*(Todd(T_{X/Y}) ch(\mathcal{E}))
=
\sum (-1)^i ch(R^if_*\mathcal{E})
$$
Here
$$
T_{X/Y} = \SheafHom_{\mathcal{O}_X}(\Omega_{X/Y}, \mathcal{O}_X)
$$
is the relative tangent bundle of $X$ over $Y$.
The theorem is more general and becomes easier to prove
when formulated in correct generality. We will return to
this elsewhere (insert future reference here).









\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
