\input{preamble}

% OK, start here.
%
\begin{document}

\title{Chow Homology and Chern Classes}

\maketitle

\phantomsection
\label{section-phantom}


\tableofcontents


\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss Chow homology groups and the construction
of chern classes of vector bundles as elements of operational
Chow cohomology groups (everything with $\mathbf{Z}$-coefficients).

\medskip\noindent
We start this chapter by giving the shortest possible
algebraic proof of the Key Lemma \ref{lemma-milnor-gersten-low-degree}.
We first define the Herbrand quotient
(Section \ref{section-periodic-complexes})
and we compute it in some cases
(Section \ref{section-calculation}).
Next, we prove some simple algebra lemmas on
existence of suitable factorizations after modifications
(Section \ref{section-preparation-tame-symbol}).
Using these we construct/define the tame symbol in
Section \ref{section-tame-symbol}.
Only the most basic properties of the tame symbol
are needed to prove the Key Lemma, which we do
in Section \ref{section-key-lemma}.

\medskip\noindent
Next, we introduce the basic setup we work with in the rest of this
chapter in Section \ref{section-setup}. To make the material a little
bit more challenging we decided to treat a somewhat more general case
than is usually done. Namely we assume our schemes $X$ are locally of
finite type over a fixed locally Noetherian base scheme which is universally
catenary and is endowed with a dimension function. These assumptions suffice
to be able to define the Chow homology groups $A_*(X)$ and the action of
capping with chern classes on them. This is an indication that we should
be able to define these also for algebraic stacks locally of finite type
over such a base.

\medskip\noindent
Next, we follow the first few chapters of \cite{F} in order to define
cycles, flat pullback, proper pushforward, and rational equivalence,
except that we have been less precise about the supports of the cycles
involved.

\medskip\noindent
We diverge from the presentation given in \cite{F} by using the
Key lemma mentioned above to prove a basic commutativity relation in
Section \ref{section-key}. Using this we prove that the operation
of intersecting with an invertible sheaf passes through rational
equivalence and is commutative, see Section \ref{section-commutativity}.
One more application of the Key
lemma proves that the Gysin map of an effective Cartier divisor
passes through rational equivalence, see Section \ref{section-gysin}.
Having proved this, it is straightforward to define chern
classes of vector bundles, prove additivity, prove the splitting principle,
introduce chern characters, Todd classes, and state the
Grothendieck-Riemann-Roch theorem.

\medskip\noindent
There are two appendices. In Appendix A (Section \ref{section-appendix-A})
we discuss an alternative (longer) construction of the
tame symbol and corresponding proof of the Key Lemma.
Finally, in Appendix B (Section \ref{section-appendix-chow})
we briefly discuss the relationship with $K$-theory of coherent
sheaves and we discuss some blowup lemmas.
We suggest the reader look at their introductions for
more information.

\medskip\noindent
We will return to the Chow groups $A_*(X)$ for smooth projective varieties
over algebraically closed fields in the next chapter. Using a moving
lemma as in \cite{Samuel}, \cite{ChevalleyI}, and \cite{ChevalleyII}
and Serre's Tor-formula
(see \cite{Serre_local_algebra} or \cite{Serre_algebre_locale})
we will define a ring structure on $A_*(X)$. See
Intersection Theory, Section \ref{intersection-section-introduction} ff.








\section{Periodic complexes and Herbrand quotients}
\label{section-periodic-complexes}

\noindent
Of course there is a very general notion of periodic complexes.
We can require periodicity of the maps, or periodicity of the objects.
We will add these here as needed. For the moment we only need
the following cases.

\begin{definition}
\label{definition-periodic-complex}
Let $R$ be a ring.
\begin{enumerate}
\item A {\it $2$-periodic complex} over $R$ is given
by a quadruple $(M, N, \varphi, \psi)$ consisting of
$R$-modules $M$, $N$ and $R$-module maps $\varphi : M \to N$,
$\psi : N \to M$ such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
N \ar[r]^\psi &
M \ar[r]^\varphi &
N \ar[r] & \ldots
}
$$
is a complex. In this setting we define the {\it cohomology modules}
of the complex to be the $R$-modules
$$
H^0(M, N, \varphi, \psi) = \Ker(\varphi)/\Im(\psi)
\quad\text{and}\quad
H^1(M, N, \varphi, \psi) = \Ker(\psi)/\Im(\varphi).
$$
We say the $2$-periodic complex is {\it exact} if the cohomology
groups are zero.
\item A {\it $(2, 1)$-periodic complex} over $R$ is given
by a triple $(M, \varphi, \psi)$ consisting of an $R$-module $M$ and
$R$-module maps $\varphi : M \to M$, $\psi : M \to M$
such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
M \ar[r]^\psi &
M \ar[r]^\varphi &
M \ar[r] & \ldots
}
$$
is a complex. Since this is a special case of a $2$-periodic complex
we have its {\it cohomology modules} $H^0(M, \varphi, \psi)$,
$H^1(M, \varphi, \psi)$ and a notion of exactness.
\end{enumerate}
\end{definition}

\noindent
In the following we will use any result proved for $2$-periodic
complexes without further mention for $(2, 1)$-periodic complexes.
It is clear that the collection of $2$-periodic complexes forms a
category with morphisms
$(f, g) : (M, N, \varphi, \psi) \to (M', N', \varphi', \psi')$
pairs of morphisms $f : M \to M'$ and $g : N \to N'$ such
that $\varphi' \circ f = f \circ \varphi$ and $\psi' \circ g = g \circ \psi$.
We obtain an abelian category, with kernels and cokernels as in
Homology, Lemma \ref{homology-lemma-cat-chain-abelian}.

\begin{definition}
\label{definition-periodic-length}
Let $(M, N, \varphi, \psi)$ be a $2$-periodic complex
over a ring $R$ whose cohomology modules have finite length.
In this case we define the {\it multiplicity} of $(M, N, \varphi, \psi)$
to be the integer
$$
e_R(M, N, \varphi, \psi) =
\text{length}_R(H^0(M, N, \varphi, \psi))
-
\text{length}_R(H^1(M, N, \varphi, \psi))
$$
In the case of a $(2, 1)$-periodic complex $(M, \varphi, \psi)$,
we denote this by $e_R(M, \varphi, \psi)$ and we will sometimes call this
the {\it (additive) Herbrand quotient}.
\end{definition}

\noindent
If the cohomology groups of $(M, \varphi, \psi)$
are finite abelian groups, then it is customary to call the
{\it (multiplicative) Herbrand quotient}
$$
q(M, \varphi, \psi) =
\frac{\# H^0(M, \varphi, \psi)}{\# H^1(M, \varphi, \psi)}
$$
In words: the multiplicative Herbrand quotient is the number of elements of
$H^0$ divided by the number of elements of $H^1$. If $R$ is local and if
the residue field of $R$ is finite with $q$ elements, then we see that
$$
q(M, \varphi, \psi) = q^{e_R(M, \varphi, \psi)}
$$

\medskip\noindent
An example of a $(2, 1)$-periodic complex over a ring $R$ is any triple of
the form $(M, 0, \psi)$ where $M$ is an $R$-module and $\psi$ is an
$R$-linear map. If the kernel and cokernel of $\psi$ have finite length,
then we obtain
\begin{equation}
\label{equation-multiplicity-coker-ker}
e_R(M, 0, \psi) = \text{length}_R(\Coker(\psi)) - \text{length}_R(\Ker(\psi))
\end{equation}
We state and prove the obligatory lemmas on these notations.

\begin{lemma}
\label{lemma-additivity-periodic-length}
Let $R$ be a ring. Suppose that we have a short exact sequence of
$2$-periodic complexes
$$
0 \to (M_1, N_1, \varphi_1, \psi_1)
\to (M_2, N_2, \varphi_2, \psi_2)
\to (M_3, N_3, \varphi_3, \psi_3)
\to 0
$$
If two out of three have cohomology modules of finite length so does
the third and we have
$$
e_R(M_2, N_2, \varphi_2, \psi_2) =
e_R(M_1, N_1, \varphi_1, \psi_1) +
e_R(M_3, N_3, \varphi_3, \psi_3).
$$
\end{lemma}

\begin{proof}
We abbreviate $A = (M_1, N_1, \varphi_1, \psi_1)$,
$B = (M_2, N_2, \varphi_2, \psi_2)$ and $C = (M_3, N_3, \varphi_3, \psi_3)$.
We have a long exact cohomology sequence
$$
\ldots
\to H^1(C)
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to H^1(C)
\to \ldots
$$
This gives a finite exact sequence
$$
0 \to I
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to K \to 0
$$
with $0 \to K \to H^1(C) \to I \to 0$ a filtration. By additivity of
the length function (Algebra, Lemma \ref{algebra-lemma-length-additive})
we see the result.
\end{proof}

\begin{lemma}
\label{lemma-finite-periodic-length}
Let $R$ be a ring. If $(M, N, \varphi, \psi)$ is a $2$-periodic complex
such that $M$, $N$ have finite length, then
$e_R(M, N, \varphi, \psi) = \text{length}_R(M) - \text{length}_R(N)$.
In particular, if $(M, \varphi, \psi)$ is a $(2, 1)$-periodic complex
such that $M$ has finite length, then
$e_R(M, \varphi, \psi) = 0$.
\end{lemma}

\begin{proof}
This follows from the additity of
Lemma \ref{lemma-additivity-periodic-length}
and the short exact sequence
$0 \to (M, 0, 0, 0) \to (M, N, \varphi, \psi) \to (0, N, 0, 0) \to 0$.
\end{proof}

\begin{lemma}
\label{lemma-compare-periodic-lengths}
Let $R$ be a ring. Let $f : (M, \varphi, \psi) \to (M', \varphi', \psi')$
be a map of $(2, 1)$-periodic complexes whose cohomology modules
have finite length. If $\Ker(f)$ and $\Coker(f)$ have finite length,
then $e_R(M, \varphi, \psi) = e_R(M', \varphi', \psi')$.
\end{lemma}

\begin{proof}
Apply the additivity of Lemma \ref{lemma-additivity-periodic-length}
and observe that $(\Ker(f), \varphi, \psi)$ and
$(\Coker(f), \varphi', \psi')$ have vanishing multiplicity by
Lemma \ref{lemma-finite-periodic-length}.
\end{proof}




\section{Calculuation of some multiplicities}
\label{section-calculation}

\noindent
To prove equality of certain cycles later on we need to
compute some multiplicities. Our main tool, besides the
elementary lemmas on multiplicities given in the previous section,
will be Algebra, Lemma \ref{algebra-lemma-order-vanishing-determinant}.

\begin{lemma}
\label{lemma-length-multiplication}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module. Let $x \in R$. Assume that
\begin{enumerate}
\item $\dim(\text{Supp}(M)) \leq 1$, and
\item $\dim(\text{Supp}(M/xM)) \leq 0$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$.
Then
$$
e_R(M, 0, x) =
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(x)
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
\end{lemma}

\begin{proof}
We first make some preparatory remarks.
The result of the lemma holds if $M$ has finite length, i.e., if $t = 0$,
because both the left hand side and the right hand side are zero
in this case, see Lemma \ref{lemma-finite-periodic-length}.
Also, if we have a short exact sequence $0 \to M \to M' \to M'' \to 0$
of modules satisfying (1) and (2), then lemma for 2 out of 3
of these implies the lemma for the third by the
additivity of length (Algebra, Lemma \ref{algebra-lemma-length-additive}) and
additivty of multiplicities (Lemma \ref{lemma-additivity-periodic-length}).

\medskip\noindent
Denote $M_i$ the image of $M$ in $M_{\mathfrak q_i}$, so
$\text{Supp}(M_i) = \{\mathfrak m, \mathfrak q_i\}$.
The kernel and cokernel of the map $M \to \bigoplus M_i$
have support $\{\mathfrak m\}$ and hence have finite length.
By our preparatory remarks, it follows that it suffices to
prove the lemma for each $M_i$. Thus we may assume that
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$.
In this case we can filter $M$ by powers of $\mathfrak q$.
Again additivity shows that it suffices to prove the lemma
in the case $M$ is annihilated by $\mathfrak q$.
In this case we can view $M$ as a $R/\mathfrak q$-module,
i.e., we may assume that $R$ is a Noetherian local domain
of dimension $1$ with fraction field $K$.
Dividing by the torsion submodule, i.e., by the
kernel of $M \to M \otimes_R K = V$ (the torsion has
finite length hence is handled by our preliminary remarks)
we may assume that $M \subset V$ is a lattice
(Algebra, Definition \ref{algebra-definition-lattice}).
Then $x : M \to M$ is injective and
$\text{length}_R(M/xM) = d(M, xM)$
(Algebra, Definition \ref{algebra-definition-distance}). Since
$\text{length}_K(V) = \dim_K(V)$
we see that $\det(x : V \to V) = x^{\dim_K(V)}$ and
$\text{ord}_R(\det(x : V \to V)) = \dim_K(V) \text{ord}_R(x)$.
Thus the desired equality follows from
Algebra, Lemma \ref{algebra-lemma-order-vanishing-determinant}
in this case.
\end{proof}

\begin{lemma}
\label{lemma-additivity-divisors-restricted}
Let $R$ be a Noetherian local ring.
Let $x \in R$. If $M$ is a finite Cohen-Macaulay module over $R$
with $\dim(\text{Supp}(M)) = 1$ and $\dim(\text{Supp}(M/xM)) = 0$, then
$$
\text{length}_R(M/xM)
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the
minimal primes of the support of $M$. If $I \subset R$ is an ideal
such that $x$ is a nonzerodivisor on $R/I$ and $\dim(R/I) = 1$, then
$$
\text{length}_R(R/(x, I))
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}((R/I)_{\mathfrak q_i})
$$
where $\mathfrak q_1, \ldots, \mathfrak q_n$ are the minimal
primes over $I$.
\end{lemma}

\begin{proof}
These are special cases of Lemma \ref{lemma-length-multiplication}.
\end{proof}

\noindent
Here is another case where we can determine the value of a multiplicity.

\begin{lemma}
\label{lemma-powers-period-length-zero}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $\varphi : M \to M$ be an endomorphism and $n > 0$
such that $\varphi^n = 0$ and such that $\Ker(\varphi)/\Im(\varphi^{n - 1})$
has finite length as an $R$-module.
Then
$$
e_R(M, \varphi^i, \varphi^{n - i}) = 0
$$
for $i = 0, \ldots, n$.
\end{lemma}

\begin{proof}
The cases $i = 0, n$ are trivial as $\pi^0 = \text{id}_M$ by convention.
Let us think of $M$ as an $R[t]$-module where multiplication by $t$
is given by $\varphi$. Let us write
$K_i = \Ker(t^i : M \to M)$ and
$$
a_i = \text{length}_R(K_i/t^{n - i}M),\quad
b_i = \text{length}_R(K_i/tK_{i + 1}),\quad
c_i = \text{length}_R(K_1/t^iK_{i + 1})
$$
Boundary values are $a_0 = a_n = b_0 = c_0 = 0$.
The $c_i$ are integers for $i < n$ as $K_1/t^iK_{i + 1}$
is a quotient of $K_1/t^{n - 1}M$ which is assumed to have finite length.
We will use frequently that $K_i \cap t^jM = t^jK_{i + j}$.
For $0 < i < n - 1$ we have an exact sequence
$$
0 \to
K_1/t^{n - i - 1}K_{n - i} \to
K_{i + 1}/t^{n - i - 1}M \xrightarrow{t} K_i/t^{n - i}M
\to K_i/tK_{i + 1} \to 0
$$
By induction on $i$ we conclude that $a_i$ and $b_i$ are
integers for $i < n$ and that
$$
c_{n - i - 1} - a_{i + 1} + a_i - b_i = 0
$$
For $0 < i < n - 1$ there is a short exact sequence
$$
0 \to
K_i/tK_{i + 1} \to
K_{i + 1}/tK_{i + 2} \xrightarrow{t^i}
K_1/t^{i + 1}K_{i + 2} \to
K_1/t^iK_{i + 1} \to 0
$$
which gives
$$
b_i - b_{i + 1} + c_{i + 1} - c_i = 0
$$
Since $b_0 = c_0$ we conclude that $b_i = c_i$ for $i < n$.
Then we see that
$$
a_2 = a_1 + b_{n - 2} - b_1,\quad
a_3 = a_2 + b_{n - 3} - b_2,\quad \ldots
$$
It is straighforward to see that this implies $a_i = a_{n - i}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-multiply-period-length}
Let $(R, \mathfrak m)$ be a Noetherian local ring. Let
$(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$
with $M$ finite and with cohomology groups of finite length over $R$.
Let $x \in R$ be such that $\dim(\text{Supp}(M/xM)) \leq 0$. Then
$$
e_R(M, x\varphi, \psi) = e_R(M, \varphi, \psi) - e_R(\Im(\varphi), 0, x)
$$
and
$$
e_R(M, \varphi, x\psi) = e_R(M, \varphi, \psi) + e_R(\Im(\psi), 0, x)
$$
\end{lemma}

\begin{proof}
We will only prove the first formula as the second is proved
in exactly the same manner.
Let $M' = M[x^\infty]$ be the $x$-power torsion submodule of $M$.
Consider the short exact sequence $0 \to M' \to M \to M'' \to 0$.
Then $M''$ is $x$-power torsion free (More on Algebra, Lemma
\ref{more-algebra-lemma-divide-by-torsion}).
Since $\varphi$, $\psi$ map $M'$ into $M'$
we obtain a short exact sequence
$$
0 \to (M', \varphi', \psi') \to (M, \varphi, \psi) \to
(M'', \varphi'', \psi'') \to 0
$$
of $(2, 1)$-periodic complexes. Also, we get a short exact sequence
$0 \to M' \cap \Im(\varphi) \to \Im(\varphi) \to \Im(\varphi'') \to 0$.
We have
$e_R(M', \varphi, \psi) = e_R(M', x\varphi, \psi) =
e_R(M' \cap \Im(\varphi), 0, x) = 0$
by Lemma \ref{lemma-compare-periodic-lengths}.
By additivity (Lemma \ref{lemma-additivity-periodic-length})
we see that it suffices to prove the lemma for $(M'', \varphi'', \psi'')$.
This reduces us to the case discussed in the next paragraph.

\medskip\noindent
Assume $x : M \to M$ is injective.
In this case $\Ker(x\varphi) = \Ker(\varphi)$.
On the other hand we have a short exact sequence
$$
0 \to \Im(\varphi)/x\Im(\varphi) \to
\Ker(\psi)/\Im(x\varphi) \to \Ker(\psi)/\Im(\varphi) \to 0
$$
This together with (\ref{equation-multiplicity-coker-ker}) proves the formula.
\end{proof}







\section{Preparation for tame symbols}
\label{section-preparation-tame-symbol}

\noindent
In this section we put some lemma that will help us define the
tame symbol in the next section.

\begin{lemma}
\label{lemma-glue-at-max}
Let $A$ be a Noetherian ring. Let $\mathfrak m_1, \ldots, \mathfrak m_r$
be pairwise distinct maximal ideals of $A$. For $i = 1, \ldots, r$ let
$\varphi_i : A_{\mathfrak m_i} \to B_i$ be a ring map whose
kernel and cokernel are annihilated by a power
of $\mathfrak m_i$. Then there exists a ring map $\varphi : A \to B$ such
that
\begin{enumerate}
\item the localization of $\varphi$ at $\mathfrak m_i$ is
isomorphic to $\varphi_i$, and
\item $\Ker(\varphi)$ and $\Coker(\varphi)$ are annihilated
by a power of $\mathfrak m_1 \cap \ldots \cap \mathfrak m_r$.
\end{enumerate}
Moreover, if each $\varphi_i$ is finite, injective, or
surjective then so is $\varphi$.
\end{lemma}

\begin{proof}
Set $I = \mathfrak m_1 \cap \ldots \cap \mathfrak m_r$. Set
$A_i = A_{\mathfrak m_i}$ and $A' = \prod A_i$.
Then $IA' = \prod \mathfrak m_i A_i$ and $A \to A'$
is a flat ring map such that $A/I \cong A'/IA'$.
Thus we may use More on Algebra, Lemma
\ref{more-algebra-lemma-application-formal-glueing}
to see that there exists an $A$-module map $\varphi : A \to B$
with $\varphi_i$ isomorphic to the localization of $\varphi$
at $\mathfrak m_i$. Then we can use the discussion in
More on Algebra, Remark \ref{more-algebra-remark-formal-glueing-algebras}
to endow $B$ with an $A$-algebra structure
matching the given $A$-algebra structure on $B_i$.
The final statement of the lemma follows easily from
the fact that $\Ker(\varphi)_{\mathfrak m_i} \cong \Ker(\varphi_i)$
and $\Coker(\varphi)_{\mathfrak m_i} \cong \Coker(\varphi_i)$.
\end{proof}

\noindent
The following lemma is very similar to
Algebra, Lemma \ref{algebra-lemma-nonregular-dimension-one}.

\begin{lemma}
\label{lemma-Noetherian-domain-dim-1-two-elements}
Let $(R, \mathfrak m)$ be a Noetherian local ring of dimension $1$.
Let $a, b \in R$ be nonzerodivisors.
There exists a finite ring extension $R \subset R'$
with $R'/R$ annihilated by a power of $\mathfrak m$
and nonzerodivisors $t, a', b' \in R'$ such that
$a = ta'$ and $b = tb'$ and $R' = a'R' + b'R'$.
\end{lemma}

\begin{proof}
If $a$ or $b$ is a unit, then the lemma is true with $R = R'$.
Thus we may assume $a, b \in \mathfrak m$.
Set $I = (a, b)$. The idea is to blow up $R$ in $I$.
Instead of doing the algebraic argument we work geometrically.
Let $X = \text{Proj}(\bigoplus_{d \geq 0} I^d)$.
By Divisors, Lemma
\ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
the morphism $X \to \Spec(R)$ is an isomorphism over
the punctured spectrum $U = \Spec(R) \setminus \{\mathfrak m\}$.
Thus we may and do view $U$ as an open subscheme of $X$.
The morphism $X \to \Spec(R)$ is projective by
Divisors, Lemma \ref{divisors-lemma-blowing-up-projective}.
Also, every generic point of $X$ lies in $U$, for example
by Divisors, Lemma \ref{divisors-lemma-blow-up-and-irreducible-components}.
It follows from Varieties, Lemma \ref{varieties-lemma-finite-in-codim-1}
that $X \to \Spec(R)$ is finite. Thus $X = \Spec(R')$ is
affine and $R \to R'$ is finite. We have $R_a \cong R'_a$ as $U = D(a)$.
Hence a power of $a$ annihilates the finite $R$-module $R'/R$.
As $\mathfrak m = \sqrt{(a)}$ we see that $R'/R$ is annihilated
by a power of $\mathfrak m$. By
Divisors, Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
we see that $IR'$ is a locally principal ideal.
Since $R'$ is semi-local we see that $IR'$ is principal,
see Algebra, Lemma \ref{algebra-lemma-locally-free-semi-local-free},
say $IR' = (t)$. Then we have $a = a't$ and $b = b't$ and everything is
clear.
\end{proof}

\begin{lemma}
\label{lemma-not-infinitely-divisible}
Let $(R, \mathfrak m)$ be a Noetherian local ring of dimension $1$.
Let $a, b \in R$ be nonzerodivisors with $a \in \mathfrak m$.
There exists an integer $n = n(R, a, b)$ such that for a finite ring
extension $R \subset R'$ if $b = a^m c$ for some $c \in R'$, then $m \leq n$.
\end{lemma}

\begin{proof}
Choose a minimal prime $\mathfrak q \subset R$. Observe that
$\dim(R/\mathfrak q) = 1$, in particular $R/\mathfrak q$ is not a field.
We can choose a discrete valuation ring $A$ dominating $R/\mathfrak q$
with the same fraction field, see
Algebra, Lemma \ref{algebra-lemma-dominate-by-dimension-1}. Observe that
$a$ and $b$ map to nonzero elements of $A$ as nonzerodivisors in $R$
are not contained in $\mathfrak q$. Let $v$ be the discrete valuation on $A$.
Then $v(a) > 0$ as $a \in \mathfrak m$.
We claim $n = v(b)/v(a)$ works.

\medskip\noindent
Let $R \subset R'$ be given. Set $A' = A \otimes_R R'$.
Since $\Spec(R') \to \Spec(R)$ is surjective
(Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective})
also $\Spec(A') \to \Spec(A)$ is surjective
(Algebra, Lemma \ref{algebra-lemma-surjective-spec-radical-ideal}).
Pick a prime $\mathfrak q' \subset A'$ lying over $(0) \subset A$.
Then $A \subset A'' = A'/\mathfrak q'$ is a finite extension of rings
(again inducing a surjection on spectra).
Pick a maximal ideal $\mathfrak m'' \subset A''$
lying over the maximal ideal of $A$ and a discrete valuation ring
$A'''$ dominating $A''_{\mathfrak m''}$ (see lemma cited above).
Then $A \to A'''$ is an extension of discrete valuation rings
and we have $b = a^m c$ in $A'''$. Thus $v'''(b) \geq mv'''(a)$.
Since $v''' = ev$ where $e$ is the ramification index
of $A'''/A$, we find that $m \leq n$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-prepare-tame-symbol}
Let $(A, \mathfrak m)$ be a Noetherian local ring of dimension $1$.
Let $r \geq 2$ and let $a_1, \ldots, a_r \in A$ be nonzerodivisors
not all units.
Then there exist
\begin{enumerate}
\item a finite ring extension $A \subset B$ with
$B/A$ annihilated by a power of $\mathfrak m$,
\item for each of maximal ideal $\mathfrak m_j \subset B$
a nonzerodivisor $\pi_j \in B_j = B_{\mathfrak m_j}$, and
\item factorizations $a_i = u_{i, j} \pi_j^{e_{i, j}}$ in $B_j$
with $u_{i, j} \in B_j$ units and $e_{i, j} \geq 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since at least one $a_i$ is not a unit and we find that $\mathfrak m$
is not an associated prime of $A$. Moreover, for any $A \subset B$
as in the statement $\mathfrak m$ is not an associated prime of $B$
and $\mathfrak m_j$ is not an associate prime of $B_j$.
Keeping this in mind will help check the arguments below.

\medskip\noindent
First, we claim that it suffices to prove the lemma for $r = 2$.
We will argue this by induction on $r$; we suggest the reader
skip the proof. Suppose we are given $A \subset B$ and $\pi_j$ in
$B_j = B_{\mathfrak m_j}$ and factorizations
$a_i = u_{i, j} \pi_j^{e_{i, j}}$ for $i = 1, \ldots, r - 1$ in $B_j$
with $u_{i, j} \in B_j$ units and $e_{i, j} \geq 0$.
Then by the case $r = 2$ for $\pi_j$ and $a_r$ in $B_j$
we can find extensions $B_j \subset C_j$ and for every maximal ideal
$\mathfrak m_{j, k}$ of $C_j$ a nonzerodivisor
$\pi_{j, k} \in C_{j, k} = (C_j)_{\mathfrak m_{j, k}}$
and factorizations
$$
\pi_j = v_{j, k} \pi_{j, k}^{f_{j, k}}
\quad\text{and}\quad
a_r = w_{j, k} \pi_{j, k}^{g_{j, k}}
$$
as in the lemma. There exists a unique finite extension $B \subset C$
with $C/B$ annihilated by a power of $\mathfrak m$ such
that $C_j \cong C_{\mathfrak m_j}$ for all $j$, see
Lemma \ref{lemma-glue-at-max}.
The maximal ideals of $C$ correspond $1$-to-$1$
to the maximal ideals $\mathfrak m_{j, k}$ in the localizations
and in these localizations we have
$$
a_i = u_{i, j} \pi_j^{e_{i, j}} =
u_{i, j} v_{j, k}^{e_{i, j}} \pi_{j, k}^{e_{i, j}f_{j, k}}
$$
for $i \leq r - 1$. Since $a_r$ factors correctly too the
proof of the induction step is complete.

\medskip\noindent
Proof of the case $r = 2$. We will use induction on
$$
\ell = \min(\text{length}_A(A/a_1A),\ \text{length}_A(A/a_2A)).
$$
If $\ell = 0$, then either $a_1$ or $a_2$ is a unit and
the lemma holds with $A = B$. Thus we may and do assume $\ell > 0$.

\medskip\noindent
Suppose we have a finite extension of rings $A \subset A'$ such that
$A'/A$ is annihilated by a power of $\mathfrak m$ and such that
$\mathfrak m$ is not an associated prime of $A'$.
Let $\mathfrak m_1, \ldots, \mathfrak m_r \subset A'$
be the maximal ideals and set $A'_i = A'_{\mathfrak m_i}$.
If we can solve the problem for $a_1, a_2$ in each $A'_i$,
then we can apply Lemma \ref{lemma-glue-at-max}
to produce a solution for $a_1, a_2$ in $A$.
Choose $x \in \{a_1, a_2\}$ such that $\ell = \text{length}_A(A/xA)$.
By Lemma \ref{lemma-compare-periodic-lengths} 
and (\ref{equation-multiplicity-coker-ker})
we have $\text{length}_A(A/xA) = \text{length}_A(A'/xA')$.
On the other hand, we have
$$
\text{length}_A(A'/xA') =
\sum [\kappa(\mathfrak m_i) : \kappa(\mathfrak m)]
\text{length}_{A'_i}(A'_i/xA'_i)
$$
by Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
Since $x \in \mathfrak m$ we see that each term on the right hand side
is positive. We conclude that the induction hypothesis applies
to $a_1, a_2$ in each $A'_i$ if $r > 1$ or if $r = 1$ and
$[\kappa(\mathfrak m_1) : \kappa(\mathfrak m)] > 1$.
We conclude that we may assume each $A'$ as above is local with
the same residue field as $A$.

\medskip\noindent
Applying the discussion of the previous paragraph,
we may replace $A$ by the ring constructed in
Lemma \ref{lemma-Noetherian-domain-dim-1-two-elements}
for $a_1, a_2 \in A$. Then since $A$ is local we find,
after possibly switching $a_1$ and $a_2$, that $a_2 \in (a_1)$.
Write $a_2 = a_1^m c$ with $m > 0$ maximal. In fact, by
Lemma \ref{lemma-not-infinitely-divisible}
we may assume $m$ is maximal even after replacing $A$
by any finite extension $A \subset A'$ as in the previous paragraph.
If $c$ is a unit, then we are done. If not, then we replace
$A$ by the ring constructed in
Lemma \ref{lemma-Noetherian-domain-dim-1-two-elements}
for $a_1, c \in A$. Then either (1) $c = a_1 c'$ or
(2) $a_1 = c a'_1$. The first case cannot happen since
it would give $a_2 = a_1^{m + 1} c'$ contradicting the
maximality of $m$. In the second case we get
$a_1 = c a'_1$ and $a_2 = c^{m + 1} (a'_1)^m$.
Then it suffices to prove the lemma for $A$ and $c, a'_1$.
If $a'_1$ is a unit we're done and if not, then
$\text{length}_A(A/cA) < \ell$ because $cA$ is a strictly
bigger ideal than $a_1A$. Thus we win by induction hypothesis.
\end{proof}






\section{Tame symbols}
\label{section-tame-symbol}

\noindent
Consider a Noetherian local ring $(A, \mathfrak m)$ of dimension $1$.
We denote $Q(A)$ the total ring of fractions of $A$, see
Algebra, Example \ref{algebra-example-localize-at-prime}.
The {\it tame symbol} will be a map
$$
\partial_A(-, -) : Q(A)^* \times Q(A)^* \longrightarrow \kappa(\mathfrak m)^*
$$
satisfying the following properties:
\begin{enumerate}
\item $\partial_A(f, gh) = \partial_A(f, g) \partial_A(f, h)$
\label{item-bilinear}
for $f, g, h \in Q(A)^*$,
\item $\partial_A(f, g) \partial_A(g, f) = 1$
\label{item-skew}
for $f, g \in Q(A)^*$,
\item $\partial_A(f, 1 - f) = 1$
\label{item-1-x}
for $f \in Q(A)^*$ such that $1 - f \in Q(A)^*$,
\item $\partial_A(aa', b) = \partial_A(a, b)\partial_A(a', b)$
\label{item-bilinear-better}
and $\partial_A(a, bb') = \partial_A(a, b)\partial_A(a, b')$
for $a, a', b, b' \in A$ nonzerodivisors,
\item $\partial_A(b, b) = (-1)^m$
\label{item-skew-better}
with $m = \text{length}_A(A/bA)$
for $b \in A$ a nonzerodivisor,
\item $\partial_A(u, b) = u^m \bmod \mathfrak m$
\label{item-normalization}
with $m = \text{length}_A(A/bA)$ for $u \in A$ a unit and
$b \in A$ a nonzerodivisor, and
\item
\label{item-1-x-better}
$\partial_A(a, b - a)\partial_A(b, b) = \partial_A(b, b - a)\partial_A(a, b)$
for $a, b \in A$ such that $a, b, b - a$ are nonzerodivisors.
\end{enumerate}
Since it is easier to work with elements of $A$ we will
often think of $\partial_A$ as a map defined on pairs of
nonzerodivisors of $A$ satisfying (\ref{item-bilinear-better}),
(\ref{item-skew-better}), (\ref{item-normalization}),
(\ref{item-1-x-better}). It is an exercise to see that
setting
$$
\partial_A(\frac{a}{b}, \frac{c}{d}) =
\partial_A(a, b) \partial_A(a, d)^{-1} \partial_A(b, c)^{-1} \partial_A(b, d)
$$
we get a well defined map $Q(A)^* \times Q(A)^* \to \kappa(\mathfrak m)^*$
satisfying (\ref{item-bilinear}), (\ref{item-skew}), (\ref{item-1-x})
as well as the other properties.

\medskip\noindent
We do not claim there is a unique map with these properties.
Instead, we will give a recipe for constructing such a map.
Namely, given $a_1, a_2 \in A$ nonzerodivisors, we choose
a ring extension $A \subset B$ and local factorizations
as in Lemma \ref{lemma-prepare-tame-symbol}.
Then we define
\begin{equation}
\label{equation-tame-symbol}
\partial_A(a_1, a_2) = \prod\nolimits_j
\text{Norm}_{\kappa(\mathfrak m_j)/\kappa(\mathfrak m)}
((-1)^{e_{1, j}e_{2, j}}u_{1, j}^{e_{2, j}}u_{2, j}^{-e_{1, j}}
\bmod \mathfrak m_j)^{m_j}
\end{equation}
where $m_j = \text{length}_{B_j}(B_j/\pi_j B_j)$ and the product
is taken over the maximal ideals $\mathfrak m_1, \ldots, \mathfrak m_r$ of $B$.

\begin{lemma}
\label{lemma-well-defined-tame-symbol}
The formula (\ref{equation-tame-symbol}) determines a
well defined element of $\kappa(\mathfrak m)^*$. In other words, the
right hand side does not depend on the choice of the
local factorizations or the choice of $B$.
\end{lemma}

\begin{proof}
Independence of choice of factorizations. Suppose we have
a Noetherian $1$-dimensional local ring $B$, elements $a_1, a_2 \in B$,
and nonzerodivisors $\pi, \theta$ such that we can write
$$
a_1 = u_1 \pi^{e_1} = v_1 \theta^{f_1},\quad
a_2 = u_2 \pi^{e_2} = v_2 \theta^{f_2}
$$
with $e_i, f_i \geq 0$ integers and $u_i, v_i$ units in $B$.
Observe that this implies
$$
a_1^{e_2} = u_1^{e_2}u_2^{-e_1}a_2^{e_1},\quad
a_1^{f_2} = v_1^{f_2}v_2^{-f_1}a_2^{f_1}
$$
On the other hand, setting
$m = \text{length}_B(B/\pi B)$ and $k = \text{length}_B(B/\theta B)$
we find $e_2 m = \text{length}_B(B/a_2 B) = f_2 k$.
Expanding $a_1^{e_2m} = a_1^{f_2 k}$ using the above we find
$$
(u_1^{e_2}u_2^{-e_1})^m =  (v_1^{f_2}v_2^{-f_1})^k
$$
This proves the desired equality up to signs. To see the signs
work out we have to show $me_1e_2$ is even if and only if
$kf_1f_2$ is even. This follows as both $me_2 = kf_2$ and
$me_1 = kf_1$ (same argument as above).

\medskip\noindent
Independence of choice of $B$. Suppose given two extensions
$A \subset B$ and $A \subset B'$ as in Lemma \ref{lemma-prepare-tame-symbol}.
Then
$$
C = (B \otimes_A B')/(\mathfrak m\text{-power torsion})
$$
will be a third one. Thus we may assume we have
$A \subset B \subset C$ and factorizations over the
local rings of $B$ and we have to show that using
the same factorizations over the local rings of $C$
gives the same element of $\kappa(\mathfrak m)$.
By transitivity of norms
(Fields, Lemma \ref{fields-lemma-trace-and-norm-tower})
this comes down to the following problem:
if $B$ is a Noetherian local ring of dimension $1$
and $\pi \in B$ is a nonzerodivisor, then
$$
\lambda^m = \prod \text{Norm}_{\kappa_k/\kappa}(\lambda)^{m_k}
$$
Here we have used the following notation:
(1) $\kappa$ is the residue field of $B$,
(2) $\lambda$ is an element of $\kappa$,
(3) $\mathfrak m_k \subset C$ are the maximal ideals of $C$,
(4) $\kappa_k = \kappa(\mathfrak m_k)$ is the residue field of
$C_k = C_{\mathfrak m_k}$,
(5) $m = \text{length}_B(B/\pi B)$, and
(6) $m_k = \text{length}_{C_k}(C_k/\pi C_k)$.
The displayed equality holds because
$\text{Norm}_{\kappa_k/\kappa}(\lambda) = \lambda^{[\kappa_k : \kappa]}$
as $\lambda \in \kappa$ and because $m = \sum m_k[\kappa_k:\kappa]$.
First, we have $m = \text{length}_B(B/xB) = \text{length}_B(C/\pi C)$
by Lemma \ref{lemma-compare-periodic-lengths} 
and (\ref{equation-multiplicity-coker-ker}).
Finally, we have $\text{length}_B(C/\pi C) = \sum m_k[\kappa_k:\kappa]$
by Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
\end{proof}

\begin{lemma}
\label{lemma-tame-symbol}
The tame symbol (\ref{equation-tame-symbol}) satisfies
(\ref{item-bilinear-better}), (\ref{item-skew-better}),
(\ref{item-normalization}), (\ref{item-1-x-better}) and hence
gives a map $\partial_A : Q(A)^* \times Q(A)^* \to \kappa(\mathfrak m)^*$
satisfying (\ref{item-bilinear}), (\ref{item-skew}), (\ref{item-1-x}).
\end{lemma}

\begin{proof}
Let us prove (\ref{item-bilinear-better}).
Let $a_1, a_2, a_3 \in A$ be nonzerodivisors.
Choose $A \subset B$ as in Lemma \ref{lemma-prepare-tame-symbol}
for $a_1, a_2, a_3$. Then the equality
$$
\partial_A(a_1a_2, a_3) = \partial_A(a_1, a_3) \partial_A(a_2, a_3)
$$
follows from the equality
$$
(-1)^{(e_{1, j} + e_{2, j})e_{3, j}}
(u_{1, j}u_{2, j})^{e_{3, j}}u_{3, j}^{-e_{1, j} - e_{2, j}} =
(-1)^{e_{1, j}e_{3, j}}
u_{1, j}^{e_{3, j}}u_{3, j}^{-e_{1, j}}
(-1)^{e_{2, j}e_{3, j}}
u_{2, j}^{e_{3, j}}u_{3, j}^{-e_{2, j}}
$$
in $B_j$. Properties (\ref{item-skew-better}) and
(\ref{item-normalization}) are equally immediate.

\medskip\noindent
Let us prove (\ref{item-1-x-better}). Let $a_1, a_2, a_1 - a_2 \in A$
be nonzerodivisors and set $a_3 = a_1 - a_2$.
Choose $A \subset B$ as in Lemma \ref{lemma-prepare-tame-symbol}
for $a_1, a_2, a_3$. Then it suffices to show
$$
(-1)^{e_{1, j}e_{2, j} + e_{1, j}e_{3, j} + e_{2, j}e_{3, j} + e_{2, j}}
u_{1, j}^{e_{2, j} - e_{3, j}}
u_{2, j}^{e_{3, j} - e_{1, j}}
u_{3, j}^{e_{1, j} - e_{2, j}} \bmod \mathfrak m_j = 1
$$
This is clear if $e_{1, j} = e_{2, j} = e_{3, j}$.
Say $e_{1, j} > e_{2, j}$. Then we see that $e_{3, j} = e_{2, j}$
because $a_3 = a_1 - a_2$ and we see that $u_{3, j}$
has the same residue class as $-u_{2, j}$. Hence
the formula is true -- the signs work out as well
and this verification is the reason for the choice of signs
in (\ref{equation-tame-symbol}).
The other cases are handled in exactly the same manner.
\end{proof}

\begin{lemma}
\label{lemma-norm-down-tame-symbol}
Let $(A, \mathfrak m)$ be a Noetherian local ring of dimension $1$.
Let $A \subset B$ be a finite ring extension with $B/A$
annihilated by a power of $\mathfrak m$ and $\mathfrak m$ not
an associated prime of $B$.
For $a, b \in A$ nonzerodivisors we have
$$
\partial_A(a, b) = \prod
\text{Norm}_{\kappa(\mathfrak m_j)/\kappa(\mathfrak m)}(\partial_{B_j}(a, b))
$$
where the product is over the maximal ideals $\mathfrak m_j$ of $B$
and $B_j = B_{\mathfrak m_j}$.
\end{lemma}

\begin{proof}
Choose $B_j \subset C_j$ as in
Lemma \ref{lemma-prepare-tame-symbol} for $a, b$.
By Lemma \ref{lemma-glue-at-max} we can choose a finite ring
extension $B \subset C$ with $C_j \cong C_{\mathfrak m_j}$ for all $j$.
Let $\mathfrak m_{j, k} \subset C$ be the maximal ideals of $C$
lying over $\mathfrak m_j$. Let
$$
a = u_{j, k}\pi_{j, k}^{f_{j, k}},\quad
b = v_{j, k}\pi_{j, k}^{g_{j, k}}
$$
be the local factorizations which exist by our choice of
$C_j \cong C_{\mathfrak m_j}$. By definition we have
$$
\partial_A(a, b) = 
\prod\nolimits_{j, k}
\text{Norm}_{\kappa(\mathfrak m_{j, k})/\kappa(\mathfrak m)}
((-1)^{f_{j, k}g_{j, k}}u_{j, k}^{g_{j, k}}v_{j, k}^{-f_{j, k}}
\bmod \mathfrak m_{j, k})^{m_{j, k}}
$$
and
$$
\partial_{B_j}(a, b) = 
\prod\nolimits_k
\text{Norm}_{\kappa(\mathfrak m_{j, k})/\kappa(\mathfrak m_j)}
((-1)^{f_{j, k}g_{j, k}}u_{j, k}^{g_{j, k}}v_{j, k}^{-f_{j, k}}
\bmod \mathfrak m_{j, k})^{m_{j, k}}
$$
The result follows by transitivity of norms
for $\kappa(\mathfrak m_{j, k})/\kappa(\mathfrak m_j)/\kappa(\mathfrak m)$, see
Fields, Lemma \ref{fields-lemma-trace-and-norm-tower}.
\end{proof}

\begin{lemma}
\label{lemma-tame-symbol-formally-smooth}
Let $(A, \mathfrak m, \kappa) \to (A', \mathfrak m', \kappa')$
be a local homomorphism of Noetherian local rings of dimension $1$.
If $A \to A'$ is flat, $\mathfrak m' = \mathfrak m A'$, and $\kappa'/\kappa$
is separable, then for $a_1, a_2 \in A$ nonzerodivisors the tame symbol
$\partial_A(a_1, a_2)$ maps to $\partial_{A'}(a_1, a_2)$.
\end{lemma}

\begin{proof}
If $a_1, a_2$ are both units, then $\partial_A(a_1, a_2) = 1$
and $\partial_{A'}(a_1, a_2) = 1$ and the result is true.
If not, then we can choose a ring extension $A \subset B$ and
local factorizations as in Lemma \ref{lemma-prepare-tame-symbol}.
Set $B' = A' \otimes_A B$. Since $A'$ is flat over $A$ we see
that $A' \subset B'$ is a ring extension with $B'/A'$ annihilated
by a power of $\mathfrak m'$. Let $\mathfrak m_1, \ldots, \mathfrak m_m$
be the maximal ideals of $B$. For each $j \in \{1, \ldots, m\}$
denote $\kappa_j = \kappa(\mathfrak m_j)$ the residue field.
Then
$$
\kappa_j \otimes_\kappa \kappa' =
\prod\nolimits_{l = 1, \ldots, n_j} \kappa'_{j, l}
$$
is a product of fields each finite over $\kappa'$ because $\kappa'/\kappa$
is a separable field extension
(Algebra, Lemma \ref{algebra-lemma-separable-extension-preserves-reducedness}).
It follows that $B'$ has corresponding maximal ideals $\mathfrak m'_{j, l}$
lying over $\mathfrak m_j$. As factorizations in
$B'_{j, l} = B'_{\mathfrak m'_{j, l}}$ we use the image of the factorizations
$a_i = u_{i, j} \pi_j^{e_{i, j}}$ given to us in $B_j$.
Thus we obtain
$$
\partial_A(a_1, a_2) = \prod\nolimits_j
\text{Norm}_{\kappa_j/\kappa}
((-1)^{e_{1, j}e_{2, j}}u_{1, j}^{e_{2, j}}u_{2, j}^{-e_{1, j}}
\bmod \mathfrak m_j)^{m_j}
$$
by definition and similarly
$$
\partial_{A'}(a_1, a_2) = \prod\nolimits_{j, l}
\text{Norm}_{\kappa'_{j, l}/\kappa'}
((-1)^{e_{1, j}e_{2, j}}u_{1, j}^{e_{2, j}}u_{2, j}^{-e_{1, j}}
\bmod \mathfrak m'_{j, l})^{m_j}
$$
To finish the proof we observe that if $u \in \kappa_j$
has image $u_l \in \kappa'_{j, l}$, then
$\text{Norm}_{\kappa_j/\kappa}(u)$ in $\kappa$ maps to
$\prod_l \text{Norm}_{\kappa'_{j, l}/\kappa'}(u_l)$ in $\kappa'$.
This follows from the fact that taking determinants of linear
maps commutes with ground field extension.
\end{proof}






\section{A key lemma}
\label{section-key-lemma}

\noindent
In this section we apply the results above to prove
Lemma \ref{lemma-milnor-gersten-low-degree}.
This lemma is a low degree case of the statement
that there is a complex for Milnor K-theory similar
to the Gersten-Quillen complex in Quillen's K-theory.
See Remark \ref{remark-gersten-complex-milnor}.

\begin{lemma}
\label{lemma-perpare-key}
Let $(A, \mathfrak m)$ be a $2$-dimensional Noetherian local ring.
Let $t \in \mathfrak m$ be a nonzerodivisor. Say
$V(t) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_r\}$.
Let $A_{\mathfrak q_i} \subset B_i$ be a finite ring
extension with $B_i/A_{\mathfrak q_i}$ annihilated by a power of
$t$. Then there exists a finite extension $A \subset B$ of
local rings identifying residue fields
with $B_i \cong B_{\mathfrak q_i}$ and $B/A$ annihilated
by a power of $t$.
\end{lemma}

\begin{proof}
Choose $n > 0$ such that $B_i \subset t^{-n}A_{\mathfrak q_i}$.
Let $M \subset t^{-n}A$, resp.\ $M' \subset t^{-2n}A$ be the
$A$-submodule consisting of elements mapping to $B_i$ in
$t^{-n}A_{\mathfrak q_i}$, resp.\ $t^{-2n}A_{\mathfrak q_i}$.
Then $M \subset M'$ are finite $A$-modules as $A$ is Noetherian
and $M_{\mathfrak q_i} = M'_{\mathfrak q_i} = B_i$ as localization
is exact. Thus $M'/M$ is annihilated by $\mathfrak m^c$ for some
$c > 0$. Observe that $M \cdot M \subset M'$ under the multiplication
$t^{-n}A \times t^{-n}A \to t^{-2n}A$. Hence
$B = A + \mathfrak m^{c + 1}M$ is a finite $A$-algebra with the correct
localizations. We omit the verification that $B$ is local with
maximal ideal $\mathfrak m + \mathfrak m^{c + 1}M$.
\end{proof}

\begin{lemma}
\label{lemma-key-nonzerodivisors}
Let $(A, \mathfrak m)$ be a $2$-dimensional Noetherian local ring.
Let $a, b \in A$ be nonzerodivisors.
Then we have
$$
\sum
\text{ord}_{A/\mathfrak q}(\partial_{A_{\mathfrak q}}(a, b))
=
0
$$
where the sum is over the height $1$ primes $\mathfrak q$ of $A$.
\end{lemma}

\begin{proof}
If $\mathfrak q$ is a height $1$ prime of $A$ such that $a, b$
map to a unit of $A_\mathfrak q$, then $\partial_{A_\mathfrak q}(a, b) = 1$.
Thus the sum is finite. In fact, if
$V(ab) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_r\}$
then the sum is over $i = 1, \ldots, r$.
For each $i$ we pick an extension $A_{\mathfrak q_i} \subset B_i$
as in Lemma \ref{lemma-prepare-tame-symbol} for $a, b$.
By Lemma \ref{lemma-perpare-key} with $t = ab$ and the given list of primes
we may assume we have a finite local extension $A \subset B$
with $B/A$ annihilated by a power of $ab$ and such that
for each $i$ the $B_{\mathfrak q_i} \cong B_i$.
Observe that if $\mathfrak q_{i, j}$ are the primes of $B$
lying over $\mathfrak q_i$ then we have
$$
\text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(a, b))
=
\sum\nolimits_j
\text{ord}_{B/\mathfrak q_{i, j}}(\partial_{B_{\mathfrak q_{i, j}}}(a, b))
$$
by Lemma \ref{lemma-norm-down-tame-symbol} and
Algebra, Lemma \ref{algebra-lemma-finite-extension-dim-1}.
Thus we may replace $A$ by $B$ and
reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume for each $i$ there is a nonzerodivisor
$\pi_i \in A_{\mathfrak q_i}$ and units $u_i, v_i \in A_{\mathfrak q_i}$
such that for some integers $e_i, f_i \geq 0$ we have
$$
a = u_i \pi_i^{e_i},\quad b = v_i \pi_i^{f_i}
$$
in $A_{\mathfrak q_i}$. Setting
$m_i = \text{length}_{A_{\mathfrak q_i}}(A_{\mathfrak q_i}/\pi_i)$
we have
$\partial_{A_{\mathfrak q_i}}(a, b) =
((-1)^{e_if_i}u_i^{f_i}v_i^{-e_i})^{m_i}$ by definition.
Since $a, b$ are nonzerodivisors the
$(2, 1)$-periodic complex $(A/(ab), a, b)$ has vanishing cohomology.
Denote $M_i$ the image of $A/(ab)$ in $A_{\mathfrak q_i}/(ab)$.
Then we have a map
$$
A/(ab) \longrightarrow \bigoplus M_i
$$
whose kernel and cokernel are supported in $\{\mathfrak m\}$
and hence have finite length. Thus we see that
$$
\sum e_A(M_i, a, b) = 0
$$
by Lemma \ref{lemma-compare-periodic-lengths}. Hence it suffices to show
$e_A(M_i, a, b) =
- \text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(a, b))$.

\medskip\noindent
Let us prove this first, in case $\pi_i, u_i, v_i$ are the images
of elements $\pi_i, u_i, v_i \in A$ (using the same symbols
should not cause any confusion). In this case we get
\begin{align*}
e_A(M_i, a, b) & =
e_A(M_i, u_i\pi_i^{e_i}, v_i\pi_i^{f_i}) \\
& =
e_A(M_i, \pi_i^{e_i}, \pi_i^{f_i}) -
e_A(\pi_i^{e_i}M_i, 0, u_i) +
e_A(\pi_i^{f_i}M_i, 0, v_i) \\
& =
0 -
f_im_i\text{ord}_{A/\mathfrak q_i}(u_i) +
e_im_i\text{ord}_{A/\mathfrak q_i}(v_i) \\
& =
-m_i\text{ord}_{A/\mathfrak q_i}(u_i^{f_i}v_i^{-e_i}) =
-\text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(a, b))
\end{align*}
The second equality holds by Lemma \ref{lemma-multiply-period-length}.
Observe that
$M_i \subset (M_i)_{\mathfrak q_i} = A_{\mathfrak q_i}/(\pi_i^{e_i + f_i})$
and
$(\pi_i^{e_i}M_i)_{\mathfrak q_i} \cong A_{\mathfrak q_i}/\pi_i^{f_i}$ and
$(\pi_i^{f_i}M_i)_{\mathfrak q_i} \cong A_{\mathfrak q_i}/\pi_i^{e_i}$.
The $0$ in the third equality comes from
Lemma \ref{lemma-powers-period-length-zero}
and the other two terms come from
Lemma \ref{lemma-length-multiplication}.
The last two equalities follow from multiplicativity of
the order function and from the definition of our tame symbol.

\medskip\noindent
In general, we may first choose $c \in A$, $c \not \in \mathfrak q_i$
such that $c\pi_i \in A$. After replacing $\pi_i$ by $c\pi_i$
and $u_i$ by $c^{-e_i}u_i$ and $v_i$ by $c^{-f_i}v_i$
we may and do assume $\pi_i$ is in $A$.
Next, choose an $c \in A$, $c \not \in \mathfrak q_i$
with $cu_i, cv_i \in A$. Then we observe that
$$
e_A(M_i, ca, cb) = e_A(M_i, a, b) - e_A(aM_i, 0, c) + e_A(bM_i, 0, c)
$$
by Lemma \ref{lemma-length-multiplication}.
On the other hand, we have
$$
\partial_{A_{\mathfrak q_i}}(ca, cb) =
c^{m_i(f_i - e_i)}\partial_{A_{\mathfrak q_i}}(a, b)
$$
in $\kappa(\mathfrak q_i)^*$ because $c$ is a unit in $A_{\mathfrak q_i}$.
The arguments in the previous paragraph show that
$e_A(M_i, ca, cb) = -
\text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(ca, cb))$.
Thus it suffices to prove
$$
e_A(aM_i, 0, c) = \text{ord}_{A/\mathfrak q_i}(c^{m_if_i})
\quad\text{and}\quad
e_A(bM_i, 0, c) = \text{ord}_{A/\mathfrak q_i}(c^{m_ie_i})
$$
and this follows from Lemma \ref{lemma-length-multiplication}
by the description (see above)
of what happens when we localize at $\mathfrak q_i$.
\end{proof}

\begin{lemma}[Key Lemma]
\label{lemma-milnor-gersten-low-degree}
\begin{reference}
When $A$ is an excellent ring this is \cite[Proposition 1]{Kato-Milnor-K}.
\end{reference}
Let $A$ be a $2$-dimensional Noetherian local domain with fraction field $K$.
Let $f, g \in K^*$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the height
$1$ primes $\mathfrak q$ of $A$ such that either $f$ or $g$ is not an
element of $A^*_{\mathfrak q}$.
Then we have
$$
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{A/\mathfrak q_i}(\partial_{A_{\mathfrak q_i}}(f, g))
=
0
$$
We can also write this as
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(\partial_{A_{\mathfrak q}}(f, g))
=
0
$$
since at any height $1$ prime $\mathfrak q$
of $A$ where $f, g \in A^*_{\mathfrak q}$
we have $\partial_{A_{\mathfrak q}}(f, g) = 1$.
\end{lemma}

\begin{proof}
Since the tame symbols $\partial_{A_{\mathfrak q}}(f, g)$ are
bilinear and the order functions $\text{ord}_{A/\mathfrak q}$
are additive it suffices to prove the formula when
$f$ and $g$ are elements of $A$. This case is proven in
Lemma \ref{lemma-key-nonzerodivisors}.
\end{proof}

\begin{remark}[Milnor K-theory]
\label{remark-gersten-complex-milnor}
For a field $k$ let us denote $K^M_*(k)$ the quotient of
the tensor algebra on $k^*$ divided by the two-sided ideal
generated by the elements $x \otimes 1 - x$. Thus $K^M_0(k) = \mathbf{Z}$,
$K_1^M(k) = k^*$, and
$$
K^M_2(k) = k^* \otimes_\mathbf{Z} k^* / \langle x \otimes 1 - x \rangle
$$
If $(A, \mathfrak m)$ is a $1$-dimensional Noetherian local domain
with fraction field $Q(A)$ and residue field $\kappa$ there is a
tame symbol
$$
\partial_A : K_{i + 1}^M(Q(A)) \to K_i^M(\kappa(\mathfrak m))
$$
You can use the method of Section \ref{section-tame-symbol}
to define these maps, provided you extend the norm map
to $K_i^M$ for all $i$. Next, let $X$ be a Noetherian scheme with a
dimension function $\delta$. Then we can use these tame symbols
to get the arrows in the following:
$$
\bigoplus\nolimits_{\delta(x) = j + 1} K^M_{i + 1}(\kappa(x))
\longrightarrow
\bigoplus\nolimits_{\delta(x) = j} K^M_i(\kappa(x))
\longrightarrow
\bigoplus\nolimits_{\delta(x) = j - 1} K^M_{i - 1}(\kappa(x))
$$
However, it is not clear, if you define the maps as suggested above,
that the composition is zero. When $i = 1$ and $j$ arbitrary, this
follows from Lemma \ref{lemma-milnor-gersten-low-degree}.
For excellent $X$ this follows from \cite{Kato-Milnor-K}
modulo the verification that Kato's maps are the same as ours.
\end{remark}





















\section{Setup}
\label{section-setup}

\noindent
We will throughout work over a locally Noetherian universally
catenary base $S$ endowed with a dimension function $\delta$.
Although it is likely possible to generalize (parts of) the
discussion in the chapter, it seems that this is a good first
approximation. It is exactly the generality discussed in \cite{Thorup}.
We usually do not assume our schemes are
separated or quasi-compact. Many interesting algebraic stacks
are non-separated and/or non-quasi-compact and this is a good
case study to see how to develop a reasonable theory for those as well.
In order to reference these hypotheses we give it a number.

\begin{situation}
\label{situation-setup}
Here $S$ is a locally Noetherian, and universally catenary scheme.
Moreover, we assume $S$ is endowed with a dimension function
$\delta : S \longrightarrow \mathbf{Z}$.
\end{situation}

\noindent
See Morphisms, Definition \ref{morphisms-definition-universally-catenary}
for the notion of a universally catenary scheme, and see
Topology, Definition \ref{topology-definition-dimension-function}
for the notion of a dimension function. Recall that any locally
Noetherian catenary scheme locally has a dimension function, see
Properties, Lemma \ref{properties-lemma-catenary-dimension-function}.
Moreover, there are lots of schemes which are universally catenary,
see Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Any scheme $X$ locally of finite type over $S$ is locally Noetherian
and catenary. In fact, $X$ has a canonical dimension function
$$
\delta = \delta_{X/S} : X \longrightarrow \mathbf{Z}
$$
associated to $(f : X \to S, \delta)$ given by the rule
$\delta_{X/S}(x) = \delta(f(x)) + \text{trdeg}_{\kappa(f(x))}\kappa(x)$.
See Morphisms, Lemma \ref{morphisms-lemma-dimension-function-propagates}.
Moreover, if $h : X \to Y$ is a morphism of schemes locally of finite
type over $S$, and $x \in X$, $y = h(x)$,
then obviously
$\delta_{X/S}(x) = \delta_{Y/S}(y) + \text{trdeg}_{\kappa(y)}\kappa(x)$.
We will freely use this function and its properties in the following.

\medskip\noindent
Here are the basic examples of setups as above.
In fact, the main interest lies in the case where the base
is the spectrum of a field, or the case where the base
is the spectrum of a Dedekind ring (e.g.\ $\mathbf{Z}$,
or a discrete valuation ring).

\begin{example}
\label{example-field}
Here $S = \Spec(k)$ and $k$ is a field.
We set $\delta(pt) = 0$ where $pt$ indicates the unique point of $S$.
The pair $(S, \delta)$ is an example of a situation as in
Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\begin{example}
\label{example-domain-dimension-1}
Here $S = \Spec(A)$, where $A$ is a Noetherian domain
of dimension $1$.
For example we could consider $A = \mathbf{Z}$.
We set $\delta(\mathfrak p) = 0$ if
$\mathfrak p$ is a maximal ideal and $\delta(\mathfrak p) = 1$
if $\mathfrak p = (0)$ corresponds to the generic point.
This is an example of Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\noindent
If $S$ is Jacobson and $\delta$ sends closed points to zero, then $\delta$
is the function sending a point to the dimension of its closure.

\begin{lemma}
\label{lemma-delta-is-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Assume in addition $S$ is a Jacobson scheme, and $\delta(s) = 0$ for every
closed point $s$ of $S$. Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be an integral closed subscheme and let
$\xi \in Z$ be its generic point. The following integers are the same:
\begin{enumerate}
\item $\delta_{X/S}(\xi)$,
\item $\dim(Z)$, and
\item $\dim(\mathcal{O}_{Z, z})$ where $z$ is a closed point of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X \to S$, $\xi \in Z \subset X$ be as in the lemma.
Since $X$ is locally of finite type over $S$ we see that
$X$ is Jacobson, see
Morphisms, Lemma \ref{morphisms-lemma-Jacobson-universally-Jacobson}.
Hence closed points of $X$ are dense in every closed subset of $Z$
and map to closed points of $S$. Hence given any chain
of irreducible closed subsets of $Z$ we can end it with a closed point of $Z$.
It follows that $\dim(Z) = \sup_z(\dim(\mathcal{O}_{Z, z})$
(see Properties, Lemma \ref{properties-lemma-codimension-local-ring})
where $z \in Z$ runs over the closed points of $Z$.
Note that $\dim(\mathcal{O}_{Z, z}) = \delta(\xi) - \delta(z)$
by the properties of a dimension function.
For each closed $z \in Z$ the field extension
$\kappa(z) \supset \kappa(f(z))$ is finite, see Morphisms,
Lemma \ref{morphisms-lemma-jacobson-finite-type-points}.
Hence $\delta_{X/S}(z) = \delta(f(z)) = 0$ for $z \in Z$ closed.
It follows that all three integers are equal.
\end{proof}

\noindent
In the situation of the lemma above the
value of $\delta$ at the generic point of a closed irreducible subset
is the dimension of the irreducible closed subset.
However, in general we cannot expect the equality to hold.
For example if $S = \Spec(\mathbf{C}[[t]])$ and
$X = \Spec(\mathbf{C}((t)))$ then we would get
$\delta(x) = 1$ for the unique point of $X$, but $\dim(X) = 0$.
Still we want to think of $\delta_{X/S}$ as giving the
dimension of the irreducible closed subschemes. Thus we introduce
the following terminology.

\begin{definition}
\label{definition-delta-dimension}
Let $(S, \delta)$ as in Situation \ref{situation-setup}.
For any scheme $X$ locally of finite type over $S$
and any irreducible closed subset $Z \subset X$ we define
$$
\dim_\delta(Z) = \delta(\xi)
$$
where $\xi \in Z$ is the generic point of $Z$.
We will call this the {\it $\delta$-dimension of $Z$}.
If $Z$ is a closed subscheme of $X$, then we define
$\dim_\delta(Z)$ as the supremum of the $\delta$-dimensions
of its irreducible components.
\end{definition}







\section{Cycles}
\label{section-cycles}

\noindent
Since we are not assuming our schemes are quasi-compact we have
to be a little careful when defining cycles. We have to allow
infinite sums because a rational function may have infinitely many
poles for example. In any case, if $X$ is quasi-compact then a
cycle is a finite sum as usual.

\begin{definition}
\label{definition-cycles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item A {\it cycle on $X$} is a formal sum
$$
\alpha = \sum n_Z [Z]
$$
where the sum is over integral closed subschemes $Z \subset X$,
each $n_Z \in \mathbf{Z}$, and the collection
$\{Z; n_Z \not = 0\}$ is locally finite
(Topology, Definition \ref{topology-definition-locally-finite}).
\item A {\it $k$-cycle} on $X$ is a cycle
$$
\alpha = \sum n_Z [Z]
$$
where $n_Z \not = 0 \Rightarrow \dim_\delta(Z) = k$.
\item The abelian group of all $k$-cycles on $X$ is denoted $Z_k(X)$.
\end{enumerate}
\end{definition}

\noindent
In other words, a $k$-cycle on $X$
is a locally finite formal $\mathbf{Z}$-linear
combination of integral closed subschemes of $\delta$-dimension $k$.
Addition of $k$-cycles $\alpha = \sum n_Z[Z]$ and
$\beta = \sum m_Z[Z]$ is given by
$$
\alpha + \beta = \sum (n_Z + m_Z)[Z],
$$
i.e., by adding the coefficients.




\section{Cycle associated to a closed subscheme}
\label{section-cycle-of-closed-subscheme}

\begin{lemma}
\label{lemma-multiplicity-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item Let $Z' \subset Z$ be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi} < \infty
$$
\item If $\dim_\delta(Z) \leq k$ and $\xi \in Z$ with
$\delta(\xi) = k$, then $\xi$ is a generic point of an
irreducible component of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $Z' \subset Z$, $\xi \in Z'$ be as in (1).
Then $\dim(\mathcal{O}_{Z, \xi}) = 0$ (for example by
Properties, Lemma \ref{properties-lemma-codimension-local-ring}).
Hence $\mathcal{O}_{Z, \xi}$ is Noetherian
local ring of dimension zero, and hence has finite length over
itself (see
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}).
Hence, it also has finite length over $\mathcal{O}_{X, \xi}$, see
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.

\medskip\noindent
Assume $\xi \in Z$ and $\delta(\xi) = k$.
Consider the closure $Z' = \overline{\{\xi\}}$. It is an irreducible
closed subscheme with $\dim_\delta(Z') = k$ by definition.
Since $\dim_\delta(Z) = k$ it must be an irreducible component
of $Z$. Hence we see (2) holds.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-closed-subscheme}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item For any irreducible component $Z' \subset Z$ with generic point $\xi$
the integer
$m_{Z', Z} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi}$
(Lemma \ref{lemma-multiplicity-finite})
is called the {\it multiplicity of $Z'$ in $Z$}.
\item Assume $\dim_\delta(Z) \leq k$.
The {\it $k$-cycle associated to $Z$} is
$$
[Z]_k
=
\sum m_{Z', Z}[Z']
$$
where the sum is over the irreducible components of $Z$
of $\delta$-dimension $k$. (This is a $k$-cycle by
Divisors, Lemma \ref{divisors-lemma-components-locally-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[Z]_k$ if the $\delta$-dimension
of $Z$ does not exceed $k$. In other words, by convention, if we write
$[Z]_k$ then this implies that $\dim_\delta(Z) \leq k$.



\section{Cycle associated to a coherent sheaf}
\label{section-cycle-of-coherent-sheaf}



\begin{lemma}
\label{lemma-length-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item The collection of irreducible components of the support of
$\mathcal{F}$ is locally finite.
\item Let $Z' \subset \text{Supp}(\mathcal{F})$
be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi < \infty
$$
\item If $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$
and $\xi \in Z$ with $\delta(\xi) = k$, then $\xi$ is a
generic point of an irreducible component of $\text{Supp}(\mathcal{F})$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}
the support $Z$ of $\mathcal{F}$ is a closed subset of $X$.
We may think of $Z$ as a reduced closed subscheme of $X$
(Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
Hence (1) follows from
Divisors, Lemma \ref{divisors-lemma-components-locally-finite} applied to $Z$
and (3) follows from
Lemma \ref{lemma-multiplicity-finite} applied to $Z$.

\medskip\noindent
Let $\xi \in Z'$ be as in (2). In this case for any specialization
$\xi' \leadsto \xi$ in $X$ we have $\mathcal{F}_{\xi'} = 0$.
Recall that the non-maximal primes of $\mathcal{O}_{X, \xi}$ correspond
to the points of $X$ specializing to $\xi$
(Schemes, Lemma \ref{schemes-lemma-specialize-points}).
Hence $\mathcal{F}_\xi$ is a finite $\mathcal{O}_{X, \xi}$-module
whose support is $\{\mathfrak m_\xi\}$. Hence it has finite length
by Algebra, Lemma \ref{algebra-lemma-support-point}.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-coherent-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any irreducible component $Z' \subset \text{Supp}(\mathcal{F})$
with generic point $\xi$ the integer
$m_{Z', \mathcal{F}} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi$
(Lemma \ref{lemma-length-finite})
is called the {\it multiplicity of $Z'$ in $\mathcal{F}$}.
\item Assume $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
The {\it $k$-cycle associated to $\mathcal{F}$} is
$$
[\mathcal{F}]_k
=
\sum m_{Z', \mathcal{F}}[Z']
$$
where the sum is over the irreducible components of
$\text{Supp}(\mathcal{F})$ of $\delta$-dimension $k$.
(This is a $k$-cycle by Lemma \ref{lemma-length-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[\mathcal{F}]_k$
if $\mathcal{F}$ is coherent and the $\delta$-dimension
of $\text{Supp}(\mathcal{F})$ does not exceed $k$. In other words,
by convention, if we write $[\mathcal{F}]_k$ then this implies that
$\mathcal{F}$ is coherent on $X$ and
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-cycle-closed-coherent}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
If $\dim_\delta(Z) \leq k$, then $[Z]_k = [{\mathcal O}_Z]_k$.
\end{lemma}

\begin{proof}
This is because in this case the multiplicities $m_{Z', Z}$ and
$m_{Z', \mathcal{O}_Z}$ agree by definition.
\end{proof}

\begin{lemma}
\label{lemma-additivity-sheaf-cycle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0$
be a short exact sequence of coherent sheaves on $X$.
Assume that the $\delta$-dimension of the supports
of $\mathcal{F}$, $\mathcal{G}$, and $\mathcal{H}$ is $\leq k$.
Then $[\mathcal{G}]_k = [\mathcal{F}]_k + [\mathcal{H}]_k$.
\end{lemma}

\begin{proof}
Follows immediately from additivity of lengths, see
Algebra, Lemma \ref{algebra-lemma-length-additive}.
\end{proof}









\section{Preparation for proper pushforward}
\label{section-preparation-pushforward}

\begin{lemma}
\label{lemma-equal-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $X$, $Y$ integral and $\dim_\delta(X) = \dim_\delta(Y)$.
Then either $f(X)$ is contained in a proper closed subscheme
of $Y$, or $f$ is dominant and the extension of function fields
$R(Y) \subset R(X)$ is finite.
\end{lemma}

\begin{proof}
The closure $\overline{f(X)} \subset Y$ is irreducible as $X$
is irreducible (Topology, Lemmas
\ref{topology-lemma-image-irreducible-space} and
\ref{topology-lemma-irreducible}).
If $\overline{f(X)} \not = Y$, then we are done.
If $\overline{f(X)} = Y$, then $f$ is dominant and by
Morphisms,
Lemma \ref{morphisms-lemma-dominant-finite-number-irreducible-components}
we see that the generic point $\eta_Y$ of $Y$ is in the image of $f$.
Of course this implies that $f(\eta_X) = \eta_Y$, where $\eta_X \in X$
is the generic point of $X$. Since $\delta(\eta_X) = \delta(\eta_Y)$
we see that $R(Y) = \kappa(\eta_Y) \subset \kappa(\eta_X) = R(X)$
is an extension of transcendence degree $0$.
Hence $R(Y) \subset R(X)$ is a finite extension by
Morphisms, Lemma \ref{morphisms-lemma-finite-degree}
(which applies by
Morphisms, Lemma \ref{morphisms-lemma-permanence-finite-type}).
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is quasi-compact, and $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $X$.
Then $\{\overline{f(Z_i)}\}_{i \in I}$ is a locally finite
collection of closed subsets of $Y$.
\end{lemma}

\begin{proof}
Let $V \subset Y$ be a quasi-compact open subset.
Since $f$ is quasi-compact the open $f^{-1}(V)$ is
quasi-compact. Hence the set
$\{i \in I \mid Z_i \cap f^{-1}(V) \not = \emptyset \}$
is finite by a simple topological argument which we omit.
Since this is the same as the set
$$
\{i \in I \mid f(Z_i) \cap V \not = \emptyset \} =
\{i \in I \mid \overline{f(Z_i)} \cap V \not = \emptyset \}
$$
the lemma is proved.
\end{proof}









\section{Proper pushforward}
\label{section-proper-pushforward}

\begin{definition}
\label{definition-proper-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is proper.
\begin{enumerate}
\item Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = k$. We define
$$
f_*[Z] =
\left\{
\begin{matrix}
0 & \text{if} & \dim_\delta(f(Z))< k, \\
\deg(Z/f(Z)) [f(Z)] & \text{if} & \dim_\delta(f(Z)) = k.
\end{matrix}
\right.
$$
Here we think of $f(Z) \subset Y$ as an integral closed subscheme.
The degree of $Z$ over $f(Z)$ is finite if
$\dim_\delta(f(Z)) = \dim_\delta(Z)$
by Lemma \ref{lemma-equal-dimension}.
\item Let $\alpha = \sum n_Z [Z]$ be a $k$-cycle on $X$. The
{\it pushforward} of $\alpha$ as the sum
$$
f_* \alpha = \sum n_Z f_*[Z]
$$
where each $f_*[Z]$ is defined as above. The sum is locally finite
by Lemma \ref{lemma-quasi-compact-locally-finite} above.
\end{enumerate}
\end{definition}

\noindent
By definition the proper pushforward of cycles
$$
f_* : Z_k(X) \longrightarrow Z_k(Y)
$$
is a homomorphism of abelian groups. It turns $X \mapsto Z_k(X)$
into a covariant functor on the category of schemes locally of
finite type over $S$ with morphisms equal to proper morphisms.

\begin{lemma}
\label{lemma-compose-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$, and $Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be proper morphisms.
Then $g_* \circ f_* = (g \circ f)_*$ as maps $Z_k(X) \to Z_k(Z)$.
\end{lemma}

\begin{proof}
Let $W \subset X$ be an integral closed subscheme of dimension $k$.
Consider $W' = f(Z) \subset Y$ and $W'' = g(f(Z)) \subset Z$.
Since $f$, $g$ are proper we see that $W'$ (resp.\ $W''$) is
an integral closed subscheme of $Y$ (resp.\ $Z$).
We have to show that $g_*(f_*[W]) = (f \circ g)_*[W]$.
If $\dim_\delta(W'') < k$, then both sides are zero.
If $\dim_\delta(W'') = k$, then we see the induced morphisms
$$
W \longrightarrow
W' \longrightarrow
W''
$$
both satisfy the hypotheses of Lemma \ref{lemma-equal-dimension}. Hence
$$
g_*(f_*[W]) = \deg(W/W')\deg(W'/W'')[W''],
\quad
(f \circ g)_*[W] = \deg(W/W'')[W''].
$$
Then we can apply
Morphisms, Lemma \ref{morphisms-lemma-degree-composition}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-cycle-push-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a proper morphism of schemes which are
locally of finite type over $S$.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme with $\dim_\delta(Z) \leq k$.
Then
$$
f_*[Z]_k = [f_*{\mathcal O}_Z]_k.
$$
\item Let $\mathcal{F}$ be a coherent sheaf on $X$ such that
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$. Then
$$
f_*[\mathcal{F}]_k = [f_*{\mathcal F}]_k.
$$
\end{enumerate}
Note that the statement makes sense since $f_*\mathcal{F}$ and
$f_*\mathcal{O}_Z$ are coherent $\mathcal{O}_Y$-modules by
Cohomology of Schemes, Proposition
\ref{coherent-proposition-proper-pushforward-coherent}.
\end{lemma}

\begin{proof}
Part (1) follows from (2) and Lemma \ref{lemma-cycle-closed-coherent}.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Assume that $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}
there exists a closed subscheme $i : Z \to X$ and a coherent
$\mathcal{O}_Z$-module $\mathcal{G}$ such that
$i_*\mathcal{G} \cong \mathcal{F}$ and such that the support
of $\mathcal{F}$ is $Z$. Let $Z' \subset Y$ be the scheme theoretic image
of $f|_Z : Z \to Y$. Consider the commutative diagram of schemes
$$
\xymatrix{
Z \ar[r]_i \ar[d]_{f|_Z} &
X \ar[d]^f \\
Z' \ar[r]^{i'} & Y
}
$$
We have $f_*\mathcal{F} = f_*i_*\mathcal{G} = i'_*(f|_Z)_*\mathcal{G}$
by going around the diagram in two ways. Suppose we know the result holds
for closed immersions and for $f|_Z$. Then we see that
$$
f_*[\mathcal{F}]_k = f_*i_*[\mathcal{G}]_k
= (i')_*(f|_Z)_*[\mathcal{G}]_k =
(i')_*[(f|_Z)_*\mathcal{G}]_k =
[(i')_*(f|_Z)_*\mathcal{G}]_k = [f_*\mathcal{F}]_k
$$
as desired. The case of a closed immersion is straightforward (omitted).
Note that $f|_Z : Z \to Z'$ is a dominant morphism (see
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-scheme-theoretic-image}).
Thus we have reduced to the case where
$\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.

\medskip\noindent
Assume $\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.
Since $f$ is dominant, for every irreducible component $Z \subset Y$
with generic point $\eta$ there exists a point $\xi \in X$ such
that $f(\xi) = \eta$. Hence $\delta(\eta) \leq \delta(\xi) \leq k$.
Thus we see that in the expressions
$$
f_*[\mathcal{F}]_k = \sum n_Z[Z],
\quad
\text{and}
\quad
[f_*\mathcal{F}]_k = \sum m_Z[Z].
$$
whenever $n_Z \not = 0$, or $m_Z \not = 0$ the integral closed
subscheme $Z$ is actually an irreducible component of $Y$ of
$\delta$-dimension $k$. Pick such an integral closed subscheme
$Z \subset Y$ and denote $\eta$ its generic point. Note that for
any $\xi \in X$ with $f(\xi) = \eta$ we have $\delta(\xi) \geq k$
and hence $\xi$ is a generic point of an irreducible component
of $X$ of $\delta$-dimension $k$ as well
(see Lemma \ref{lemma-multiplicity-finite}). Since $f$ is quasi-compact
and $X$ is locally Noetherian, there can be only finitely many of
these and hence $f^{-1}(\{\eta\})$ is finite.
By Morphisms, Lemma \ref{morphisms-lemma-generically-finite} there exists
an open neighbourhood $\eta \in V \subset Y$ such that $f^{-1}(V) \to V$
is finite. Replacing $Y$ by $V$ and $X$ by $f^{-1}(V)$ we reduce to the
case where $Y$ is affine, and $f$ is finite.

\medskip\noindent
Write $Y = \Spec(R)$ and $X = \Spec(A)$ (possible as
a finite morphism is affine).
Then $R$ and $A$ are Noetherian rings and $A$ is finite over $R$.
Moreover $\mathcal{F} = \widetilde{M}$ for some finite $A$-module
$M$. Note that $f_*\mathcal{F}$ corresponds to $M$ viewed as an $R$-module.
Let $\mathfrak p \subset R$ be the minimal prime corresponding
to $\eta \in Y$. The coefficient of $Z$ in $[f_*\mathcal{F}]_k$
is clearly $\text{length}_{R_{\mathfrak p}}(M_{\mathfrak p})$.
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the primes of $A$
lying over $\mathfrak p$. Then $A_{\mathfrak p} = \prod A_{\mathfrak q_i}$
since $A_{\mathfrak p}$ is an Artinian ring being finite over the
dimension zero local Noetherian ring $R_{\mathfrak p}$.
Clearly the coefficient of $Z$ in $f_*[\mathcal{F}]_k$ is
$$
\sum\nolimits_{i = 1, \ldots, t}
[\kappa(\mathfrak q_i) : \kappa(\mathfrak p)]
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
$$
Hence the desired equality follows from
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
\end{proof}




















\section{Preparation for flat pullback}
\label{section-preparation-flat-pullback}


\noindent
Recall that a morphism $f : X \to Y$ which is locally of finite type
is said to have relative dimension $r$ if every nonempty fibre
is equidimensional of dimension $r$. See
Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}.

\begin{lemma}
\label{lemma-flat-inverse-image-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
For any closed subset $Z \subset Y$ we have
$$
\dim_\delta(f^{-1}(Z)) = \dim_\delta(Z) + r.
$$
provided $f^{-1}(Z)$ is nonempty.
If $Z$ is irreducible and $Z' \subset f^{-1}(Z)$ is an irreducible
component, then $Z'$ dominates $Z$ and
$\dim_\delta(Z') = \dim_\delta(Z) + r$.
\end{lemma}

\begin{proof}
It suffices to prove the final statement.
We may replace $Y$ by the integral closed subscheme $Z$ and
$X$ by the scheme theoretic inverse image $f^{-1}(Z) = Z \times_Y X$.
Hence we may assume $Z = Y$ is integral and $f$ is a flat morphism
of relative dimension $r$. Since $Y$ is locally Noetherian the
morphism $f$ which is locally of finite type,
is actually locally of finite presentation. Hence
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}
applies and we see that $f$ is open.
Let $\xi \in X$ be a generic point of an irreducible component
of $X$. By the openness of $f$ we see that $f(\xi)$ is the
generic point $\eta$ of $Z = Y$. Note that $\dim_\xi(X_\eta) = r$
by assumption that $f$ has relative dimension $r$. On the other
hand, since $\xi$ is a generic point of $X$ we see that
$\mathcal{O}_{X, \xi} = \mathcal{O}_{X_\eta, \xi}$ has only one
prime ideal and hence has dimension $0$. Thus by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
we conclude that the transcendence
degree of $\kappa(\xi)$ over $\kappa(\eta)$ is $r$.
In other words, $\delta(\xi) = \delta(\eta) + r$ as desired.
\end{proof}

\noindent
Here is the lemma that we will use to prove that the flat pullback
of a locally finite collection of closed subschemes is locally finite.

\begin{lemma}
\label{lemma-inverse-image-locally-finite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $Y$.
Then $\{f^{-1}(Z_i)\}_{i \in I}$ is a locally finite
collection of closed subsets of $X$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be a quasi-compact open subset.
Since the image $f(U) \subset Y$ is a quasi-compact subset
there exists a quasi-compact open $V \subset Y$ such that
$f(U) \subset V$. Note that
$$
\{i \in I \mid f^{-1}(Z_i) \cap U \not = \emptyset \}
\subset
\{i \in I \mid Z_i \cap V \not = \emptyset \}.
$$
Since the right hand side is finite by assumption we win.
\end{proof}



\section{Flat pullback}
\label{section-flat-pullback}

\noindent
In the following we use $f^{-1}(Z)$ to denote the
{\it scheme theoretic inverse image} of a closed subscheme
$Z \subset Y$ for a morphism of schemes $f : X \to Y$.
We recall that the scheme theoretic inverse image is the fibre product
$$
\xymatrix{
f^{-1}(Z) \ar[r] \ar[d] & X \ar[d] \\
Z \ar[r] & Y
}
$$
and it is also the closed subscheme of $X$ cut out by the
quasi-coherent sheaf of ideals $f^{-1}(\mathcal{I})\mathcal{O}_X$, if
$\mathcal{I} \subset \mathcal{O}_Y$ is the quasi-coherent sheaf of ideals
corresponding to $Z$ in $Y$.
(This is discussed in
Schemes, Section \ref{schemes-section-closed-immersion} and
Lemma \ref{schemes-lemma-fibre-product-immersion}
and Definition \ref{schemes-definition-inverse-image-closed-subscheme}.)

\begin{definition}
\label{definition-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be an integral closed subscheme of
$\delta$-dimension $k$. We define $f^*[Z]$ to be the
$(k+r)$-cycle on $X$ to the scheme theoretic inverse image
$$
f^*[Z] = [f^{-1}(Z)]_{k+r}.
$$
This makes sense since $\dim_\delta(f^{-1}(Z)) = k + r$
by Lemma \ref{lemma-flat-inverse-image-dimension}.
\item Let $\alpha = \sum n_i [Z_i]$ be
a $k$-cycle on $Y$. The {\it flat pullback of $\alpha$ by $f$}
is the sum
$$
f^* \alpha = \sum n_i f^*[Z_i]
$$
where each $f^*[Z_i]$ is defined as above.
The sum is locally finite by Lemma \ref{lemma-inverse-image-locally-finite}.
\item We denote $f^* : Z_k(Y) \to Z_{k + r}(X)$ the map of abelian
groups so obtained.
\end{enumerate}
\end{definition}

\noindent
An open immersion is flat. This is an important though trivial special
case of a flat morphism. If $U \subset X$ is open then sometimes the
pullback by $j : U \to X$ of a cycle is called the {\it restriction} of the
cycle to $U$. Note that in this case the maps
$$
j^* : Z_k(X) \longrightarrow Z_k(U)
$$
are all {\it surjective}. The reason is that given any integral closed
subscheme $Z' \subset U$, we can take the closure of $Z$ of $Z'$ in $X$
and think of it as a reduced closed subscheme of $X$ (see
Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
And clearly $Z \cap U = Z'$, in other words
$j^*[Z] = [Z']$ whence the surjectivity. In fact a little bit more
is true.

\begin{lemma}
\label{lemma-exact-sequence-open}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
For every $k \in \mathbf{Z}$ the sequence
$$
\xymatrix{
Z_k(Y) \ar[r]^{i_*} & Z_k(X) \ar[r]^{j^*} & Z_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
First assume $X$ is quasi-compact. Then $Z_k(X)$ is a free $\mathbf{Z}$-module
with basis given by the elements $[Z]$ where $Z \subset X$ is integral
closed of $\delta$-dimension $k$. Such a basis element maps
either to the basis element $[Z \cap U]$ or to zero if $Z \subset Y$.
Hence the lemma is clear in this case. The general case is similar
and the proof is omitted.
\end{proof}

\begin{lemma}
\label{lemma-compose-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X, Y, Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be flat morphisms of relative dimensions
$r$ and $s$. Then $g \circ f$ is flat of relative dimension
$r + s$ and
$$
f^* \circ g^* = (g \circ f)^*
$$
as maps $Z_k(Z) \to Z_{k + r + s}(X)$.
\end{lemma}

\begin{proof}
The composition is flat of relative dimension $r + s$ by
Morphisms, Lemma \ref{morphisms-lemma-composition-relative-dimension-d}.
Suppose that
\begin{enumerate}
\item $W \subset Z$ is a closed integral subscheme of $\delta$-dimension $k$,
\item $W' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s$ with $W' \subset g^{-1}(W)$, and
\item $W'' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s + r$ with $W'' \subset f^{-1}(W')$.
\end{enumerate}
We have to show that the coefficient $n$ of $[W'']$ in
$(g \circ f)^*[W]$ agrees with the coefficient $m$ of
$[W'']$ in $f^*(g^*[W])$. That it suffices to check the lemma in these
cases follows from Lemma \ref{lemma-flat-inverse-image-dimension}.
Let $\xi'' \in W''$, $\xi' \in W'$
and $\xi \in W$ be the generic points. Consider the local rings
$A = \mathcal{O}_{Z, \xi}$, $B = \mathcal{O}_{Y, \xi'}$
and $C = \mathcal{O}_{X, \xi''}$. Then we have local flat ring maps
$A \to B$, $B \to C$ and moreover
$$
n = \text{length}_C(C/\mathfrak m_AC),
\quad
\text{and}
\quad
m = \text{length}_C(C/\mathfrak m_BC) \text{length}_B(B/\mathfrak m_AB)
$$
Hence the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-transitive}.
\end{proof}

\begin{lemma}
\label{lemma-pullback-coherent}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be a closed subscheme with
$\dim_\delta(Z) \leq k$. Then we have
$\dim_\delta(f^{-1}(Z)) \leq k + r$
and $[f^{-1}(Z)]_{k + r} = f^*[Z]_k$ in $Z_{k + r}(X)$.
\item Let $\mathcal{F}$ be a coherent sheaf on $Y$ with
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
Then we have $\dim_\delta(\text{Supp}(f^*\mathcal{F})) \leq k + r$
and
$$
f^*[{\mathcal F}]_k = [f^*{\mathcal F}]_{k+r}
$$
in $Z_{k + r}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from part (2) by Lemma \ref{lemma-cycle-closed-coherent}
and the fact that $f^*\mathcal{O}_Z = \mathcal{O}_{f^{-1}(Z)}$.

\medskip\noindent
Proof of (2).
As $X$, $Y$ are locally Noetherian we may apply
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} to see
that $\mathcal{F}$ is of finite type, hence $f^*\mathcal{F}$ is
of finite type (Modules, Lemma \ref{modules-lemma-pullback-finite-type}),
hence $f^*\mathcal{F}$ is coherent
(Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian} again).
Thus the lemma makes sense. Let $W \subset Y$ be an integral closed
subscheme of $\delta$-dimension $k$, and let $W' \subset X$ be
an integral closed subscheme of dimension $k + r$ mapping into $W$
under $f$. We have to show that the coefficient $n$ of
$[W']$ in $f^*[{\mathcal F}]_k$ agrees with the coefficient
$m$ of $[W']$ in $[f^*{\mathcal F}]_{k+r}$. Let $\xi \in W$ and
$\xi' \in W'$ be the generic points. Let
$A = \mathcal{O}_{Y, \xi}$, $B = \mathcal{O}_{X, \xi'}$
and set $M = \mathcal{F}_\xi$ as an $A$-module. (Note that
$M$ has finite length by our dimension assumptions, but we
actually do not need to verify this. See
Lemma \ref{lemma-length-finite}.)
We have $f^*\mathcal{F}_{\xi'} = B \otimes_A M$.
Thus we see that
$$
n = \text{length}_B(B \otimes_A M)
\quad
\text{and}
\quad
m = \text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
$$
Thus the equality follows from
Algebra, Lemma \ref{algebra-lemma-pullback-module}.
\end{proof}



\section{Push and pull}
\label{section-push-pull}

\noindent
In this section we verify that proper pushforward and flat pullback
are compatible when this makes sense. By the work we did above this
is a consequence of cohomology and base change.

\begin{lemma}
\label{lemma-flat-pullback-proper-pushforward}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
be a fibre product diagram of schemes locally of finite type over $S$.
Assume $f : X \to Y$ proper and $g : Y' \to Y$ flat of relative dimension $r$.
Then also $f'$ is proper and $g'$ is flat of relative dimension $r$.
For any $k$-cycle $\alpha$ on $X$ we have
$$
g^*f_*\alpha = f'_*(g')^*\alpha
$$
in $Z_{k + r}(Y')$.
\end{lemma}

\begin{proof}
The assertion that $f'$ is proper follows from
Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}.
The assertion that $g'$ is flat of relative dimension $r$ follows from
Morphisms, Lemmas \ref{morphisms-lemma-base-change-relative-dimension-d}
and \ref{morphisms-lemma-base-change-flat}.
It suffices to prove the equality of cycles when $\alpha = [W]$
for some integral closed subscheme $W \subset X$ of $\delta$-dimension $k$.
Note that in this case we have $\alpha = [\mathcal{O}_W]_k$, see
Lemma \ref{lemma-cycle-closed-coherent}.
By Lemmas \ref{lemma-cycle-push-sheaf} and
\ref{lemma-pullback-coherent} it therefore suffices
to show that $f'_*(g')^*\mathcal{O}_W$ is isomorphic to
$g^*f_*\mathcal{O}_W$. This follows from cohomology and
base change, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-finite-flat}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a finite locally free morphism
of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Then $f$ is both proper and flat of relative dimension $0$, and
$$
f_*f^*\alpha = d\alpha
$$
for every $\alpha \in Z_k(Y)$.
\end{lemma}

\begin{proof}
A finite locally free morphism is flat and finite by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat},
and a finite morphism is proper
by Morphisms, Lemma \ref{morphisms-lemma-finite-proper}.
We omit showing that a finite
morphism has relative dimension $0$. Thus the formula makes sense.
To prove it, let $Z \subset Y$ be an integral closed subscheme
of $\delta$-dimension $k$. It suffices to prove the formula
for $\alpha = [Z]$. Since the base change of a finite locally free
morphism is finite locally free
(Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-locally-free})
we see that $f_*f^*\mathcal{O}_Z$ is a finite locally free sheaf of
rank $d$ on $Z$. Hence
$$
f_*f^*[Z] = f_*f^*[\mathcal{O}_Z]_k =
[f_*f^*\mathcal{O}_Z]_k = d[Z]
$$
where we have used Lemmas \ref{lemma-pullback-coherent} and
\ref{lemma-cycle-push-sheaf}.
\end{proof}








\section{Preparation for principal divisors}
\label{section-preparation-principal-divisors}

\noindent
Some of the material in this section partially overlaps with the
discussion in Divisors, Section \ref{divisors-section-Weil-divisors}.

\begin{lemma}
\label{lemma-divisor-delta-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral.
\begin{enumerate}
\item If $Z \subset X$ is an integral closed subscheme, then
the following are equivalent:
\begin{enumerate}
\item $Z$ is a prime divisor,
\item $Z$ has codimension $1$ in $X$, and
\item $\dim_\delta(Z) = \dim_\delta(X) - 1$.
\end{enumerate}
\item If $Z$ is an irreducible component of an effective Cartier
divisor on $X$, then $\dim_\delta(Z) = \dim_\delta(X) - 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from the definition of a prime divisor
(Divisors, Definition \ref{divisors-definition-Weil-divisor})
and the definition of a dimension function
(Topology, Definition \ref{topology-definition-dimension-function}).
Let $\xi \in Z$ be the generic point of an irreducible component $Z$ of
an effective Cartier divisor $D \subset X$.
Then $\dim(\mathcal{O}_{D, \xi}) = 0$ and
$\mathcal{O}_{D, \xi} = \mathcal{O}_{X, \xi}/(f)$ for some
nonzerodivisor $f \in \mathcal{O}_{X, \xi}$ (Divisors,
Lemma \ref{divisors-lemma-effective-Cartier-in-points}).
Then $\dim(\mathcal{O}_{X, \xi}) = 1$ by
Algebra, Lemma \ref{algebra-lemma-one-equation}. Hence $Z$ is as in (1) by
Properties, Lemma \ref{properties-lemma-codimension-local-ring}
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-finite-in-codimension-one}
Let $f : X \to Y$ be a morphism of schemes.
Let $\xi \in Y$ be a point.
Assume that
\begin{enumerate}
\item $X$, $Y$ are integral,
\item $Y$ is locally Noetherian
\item $f$ is proper, dominant and $R(X) \subset R(Y)$ is finite, and
\item $\dim(\mathcal{O}_{Y, \xi}) = 1$.
\end{enumerate}
Then there exists an open neighbourhood $V \subset Y$ of $\xi$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
This lemma is a special case of
Varieties, Lemma \ref{varieties-lemma-finite-in-codim-1}.
Here is a direct argument in this case.
By Cohomology of Schemes,
Lemma \ref{coherent-lemma-proper-finite-fibre-finite-in-neighbourhood}
it suffices to prove that $f^{-1}(\{\xi\})$ is finite.
We replace $Y$ by an affine open, say $Y = \Spec(R)$.
Note that $R$ is Noetherian, as $Y$ is assumed locally Noetherian.
Since $f$ is proper it is quasi-compact. Hence we can find a finite
affine open covering $X = U_1 \cup \ldots \cup U_n$ with
each $U_i = \Spec(A_i)$. Note that $R \to A_i$ is a
finite type injective homomorphism of domains such that
the induced extension of fraction fields is finite.
Thus the lemma follows
from Algebra, Lemma \ref{algebra-lemma-finite-in-codim-1}.
\end{proof}


\section{Principal divisors}
\label{section-principal-divisors}

\noindent
The following definition is the analogue of
Divisors, Definition \ref{divisors-definition-principal-divisor}
in our current setup.

\begin{definition}
\label{definition-principal-divisor}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral with $\dim_\delta(X) = n$.
Let $f \in R(X)^*$. The {\it principal divisor
associated to $f$} is the $(n - 1)$-cycle
$$
\text{div}(f) = \text{div}_X(f) = \sum \text{ord}_Z(f) [Z]
$$
defined in Divisors, Definition \ref{divisors-definition-principal-divisor}.
This makes sense because prime divisors have $\delta$-dimension $n - 1$ by
Lemma \ref{lemma-divisor-delta-dimension}.
\end{definition}

\noindent
In the situation of the definition for $f, g \in R(X)^*$ we have
$$
\text{div}_X(fg) = \text{div}_X(f) + \text{div}_X(g)
$$
in $Z_{n - 1}(X)$. See Divisors, Lemma \ref{divisors-lemma-div-additive}.
The following lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-rational-equivalence}.

\begin{lemma}
\label{lemma-flat-pullback-principal-divisor}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $g \in R(Y)^*$. Then
$$
f^*(\text{div}_Y(g)) = \text{div}_X(g)
$$
in $Z_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Note that since $f$ is flat it is dominant so that
$f$ induces an embedding $R(Y) \subset R(X)$, and hence
we may think of $g$ as an element of $R(X)^*$.
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n + r - 1$. Let $\xi \in Z$
be its generic point. If $\dim_\delta(f(Z)) > n - 1$,
then we see that the coefficient of $[Z]$ in the left and
right hand side of the equation is zero.
Hence we may assume that $Z' = \overline{f(Z)}$ is an
integral closed subscheme of $Y$ of $\delta$-dimension $n - 1$.
Let $\xi' = f(\xi)$. It is the generic point of $Z'$.
Set $A = \mathcal{O}_{Y, \xi'}$, $B = \mathcal{O}_{X, \xi}$.
The ring map $A \to B$ is a flat local homomorphism of
Noetherian local domains of dimension $1$.
We have $g$ in the fraction field of $A$. What we have to show is that
$$
\text{ord}_A(g) \text{length}_B(B/\mathfrak m_AB)
=
\text{ord}_B(g).
$$
This follows from Algebra, Lemma \ref{algebra-lemma-pullback-module}
(details omitted).
\end{proof}











\section{Principal divisors and pushforward}
\label{section-two-fun}

\noindent
The first lemma implies that the pushforward of a principal
divisor along a generically finite morphism is a principal divisor.

\begin{lemma}
\label{lemma-proper-pushforward-alteration}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(X) = \dim_\delta(Y)$.
Let $p : X \to Y$ be a dominant proper morphism.
Let $f \in R(X)^*$. Set
$$
g = \text{Nm}_{R(X)/R(Y)}(f).
$$
Then we have
$p_*\text{div}(f) = \text{div}(g)$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be an integral closed subscheme of $\delta$-dimension
$n - 1$. We want to show that the coefficient of $[Z]$ in
$p_*\text{div}(f)$ and $\text{div}(g)$ are equal. We may apply
Lemma \ref{lemma-finite-in-codimension-one}
to the morphism $p : X \to Y$ and the generic point $\xi \in Z$.
Hence we may replace $Y$ by an
affine open neighbourhood of $\xi$ and assume that $p : X \to Y$ is finite.
Write $Y = \Spec(R)$ and $X = \Spec(A)$ with $p$ induced
by a finite homomorphism $R \to A$ of Noetherian domains which induces
an finite field extension $L/K$ of fraction fields.
Now we have $f \in L$, $g = \text{Nm}(f) \in K$,
and a prime $\mathfrak p \subset R$ with $\dim(R_{\mathfrak p}) = 1$.
The coefficient of $[Z]$ in $\text{div}_Y(g)$ is
$\text{ord}_{R_\mathfrak p}(g)$.
The coefficient of $[Z]$ in $p_*\text{div}_X(f)$ is
$$
\sum\nolimits_{\mathfrak q\text{ lying over }\mathfrak p}
[\kappa(\mathfrak q) : \kappa(\mathfrak p)]
\text{ord}_{A_{\mathfrak q}}(f)
$$
The desired equality therefore follows from
Algebra, Lemma \ref{algebra-lemma-finite-extension-dim-1}.
\end{proof}

\noindent
An important role in the discussion of principal divisors
is played by the ``universal'' principal divisor $[0] - [\infty]$
on $\mathbf{P}^1_S$. To make this more precise, let us denote
$$
D_0, D_\infty \subset
\mathbf{P}^1_S = \underline{\text{Proj}}_S(\mathcal{O}_S[T_0, T_1])
$$
the closed subscheme cut out by the section $T_1$, resp.\ $T_0$
of $\mathcal{O}(1)$. These are effective Cartier divisors, see
Divisors, Definition \ref{divisors-definition-effective-Cartier-divisor}
and Lemma \ref{divisors-lemma-characterize-OD}.
The following lemma says that loosely speaking we have
``$\text{div}(T_1/T_0) = [D_0] - [D_1]$'' and that this is the
universal principal divisor.

\begin{lemma}
\label{lemma-rational-function}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$. Let $f \in R(X)^*$.
Let $U \subset X$ be a nonempty open such that $f$
corresponds to a section $f \in \Gamma(U, \mathcal{O}_X^*)$.
Let $Y \subset X \times_S \mathbf{P}^1_S$ be the
closure of the graph of $f : U \to \mathbf{P}^1_S$.
Then
\begin{enumerate}
\item the projection morphism $p : Y \to X$ is proper,
\item $p|_{p^{-1}(U)} : p^{-1}(U) \to U$ is an isomorphism,
\item the pullbacks $Y_0 = q^{-1}D_0$ and $Y_\infty = q^{-1}D_\infty$
via the morphism $q : Y \to \mathbf{P}^1_S$ are defined
(Divisors, Definition
\ref{divisors-definition-pullback-effective-Cartier-divisor}),
\item we have
$$
\text{div}_Y(f) = [Y_0]_{n - 1} - [Y_\infty]_{n - 1}
$$
\item we have
$$
\text{div}_X(f) = p_*\text{div}_Y(f)
$$
\item if we view $Y_0$ and $Y_\infty$ as closed subschemes of $X$
via the morphism $p$ then we have
$$
\text{div}_X(f) = [Y_0]_{n - 1} - [Y_\infty]_{n - 1}
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Since $X$ is integral, we see that $U$ is integral.
Hence $Y$ is integral, and $(1, f)(U) \subset Y$ is an open dense subscheme.
Also, note that the closed subscheme $Y \subset X \times_S \mathbf{P}^1_S$
does not depend on the choice of the open $U$, since after all it is
the closure of the one point set $\{\eta'\} = \{(1, f)(\eta)\}$
where $\eta \in X$ is the generic point. Having said this let us
prove the assertions of the lemma.

\medskip\noindent
For (1) note that $p$ is the composition of the closed immersion
$Y \to X \times_S \mathbf{P}^1_S = \mathbf{P}^1_X$ with the proper
morphism $\mathbf{P}^1_X \to X$. As a composition of proper morphisms
is proper (Morphisms, Lemma \ref{morphisms-lemma-composition-proper})
we conclude.

\medskip\noindent
It is clear that $Y \cap U \times_S \mathbf{P}^1_S = (1, f)(U)$.
Thus (2) follows. It also follows that $\dim_\delta(Y) = n$.

\medskip\noindent
Note that $q(\eta') = f(\eta)$ is not contained in $D_0$ or $D_\infty$
since $f \in R(X)^*$. Hence (3) by
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}.
We obtain $\dim_\delta(Y_0) = n - 1$
and $\dim_\delta(Y_\infty) = n - 1$ from
Lemma \ref{lemma-divisor-delta-dimension}.

\medskip\noindent
Consider the effective Cartier divisor $Y_0$.
At every point $\xi \in Y_0$ we have $f \in \mathcal{O}_{Y, \xi}$ and
the local equation for $Y_0$ is given by $f$.
In particular, if $\delta(\xi) = n - 1$ so $\xi$ is the generic point
of a integral closed subscheme $Z$ of $\delta$-dimension $n - 1$,
then we see that the coefficient of $[Z]$ in $\text{div}_Y(f)$ is
$$
\text{ord}_Z(f) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{Y, \xi}/f\mathcal{O}_{Y, \xi}) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{Y_0, \xi})
$$
which is the coefficient of $[Z]$ in $[Y_0]_{n - 1}$. A similar
argument using the rational function $1/f$ shows that
$-[Y_\infty]$ agrees with the terms with negative coefficients in
the expression for $\text{div}_Y(f)$. Hence (4) follows.

\medskip\noindent
Note that $D_0 \to S$ is an isomorphism. Hence we see that
$X \times_S D_0 \to X$ is an isomorphism as well. Clearly
we have $Y_0 = Y \cap X \times_S D_0$ (scheme theoretic intersection)
inside $X \times_S \mathbf{P}^1_S$. Hence it is really the case that
$Y_0 \to X$ is a closed immersion. It follows that
$$
p_*\mathcal{O}_{Y_0} = \mathcal{O}_{Y'_0}
$$
where $Y'_0 \subset X$ is the image of $Y_0 \to X$.
By Lemma \ref{lemma-cycle-push-sheaf} we
have $p_*[Y_0]_{n - 1} = [Y'_0]_{n - 1}$. The same
is true for $D_\infty$ and $Y_\infty$. Hence (6) is a consequence of (5).
Finally, (5) follows immediately from
Lemma \ref{lemma-proper-pushforward-alteration}.
\end{proof}

\noindent
The following lemma says that the degree of a principal divisor on
a proper curve is zero.

\begin{lemma}
\label{lemma-curve-principal-divisor}
Let $K$ be any field. Let $X$ be a $1$-dimensional integral scheme
endowed with a proper morphism $c : X \to \Spec(K)$.
Let $f \in K(X)^*$ be an invertible rational function.
Then
$$
\sum\nolimits_{x \in X \text{ closed}}
[\kappa(x) : K] \text{ord}_{\mathcal{O}_{X, x}}(f)
=
0
$$
where $\text{ord}$ is as in
Algebra, Definition \ref{algebra-definition-ord}.
In other words, $c_*\text{div}(f) = 0$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
Y \ar[r]_p \ar[d]_q & X \ar[d]^c \\
\mathbf{P}^1_K \ar[r]^-{c'} & \Spec(K)
}
$$
that we constructed in Lemma \ref{lemma-rational-function}
starting with $X$ and the rational function $f$ over $S = \Spec(K)$.
We will use all the results of this lemma without further mention.
We have to show that $c_*\text{div}_X(f) = c_*p_*\text{div}_Y(f) = 0$.
This is the same as proving that $c'_*q_*\text{div}_Y(f) = 0$.
If $q(Y)$ is a closed point of $\mathbf{P}^1_K$ then we
see that $\text{div}_X(f) = 0$ and the lemma holds.
Thus we may assume that $q$ is dominant.
Suppose we can show that $q : Y \to \mathbf{P}^1_K$ is finite
locally free of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Since $\text{div}_Y(f) = [q^{-1}D_0]_0 - [q^{-1}D_\infty]_0$
we see (by definition of flat pullback) that
$\text{div}_Y(f) = q^*([D_0]_0 - [D_\infty]_0)$.
Then by Lemma \ref{lemma-finite-flat} we get
$q_*\text{div}_Y(f) = d([D_0]_0 - [D_\infty]_0)$.
Since clearly $c'_*[D_0]_0 = c'_*[D_\infty]_0$ we win.

\medskip\noindent
It remains to show that $q$ is finite locally free.
(It will automatically have some given degree as $\mathbf{P}^1_K$
is connected.)
Since $\dim(\mathbf{P}^1_K) = 1$ we see that $q$ is finite for example
by Lemma \ref{lemma-finite-in-codimension-one}.
All local rings of $\mathbf{P}^1_K$ at
closed points are regular local rings of dimension $1$
(in other words discrete valuation rings), since they are
localizations of $K[T]$ (see
Algebra, Lemma \ref{algebra-lemma-dim-affine-space}).
Hence for $y\in Y$ closed the local ring $\mathcal{O}_{Y, y}$
will be flat over $\mathcal{O}_{\mathbf{P}^1_K, q(y)}$ as soon as
it is torsion free (More on Algebra, Lemma
\ref{more-algebra-lemma-dedekind-torsion-free-flat}).
This is obviously the case as
$\mathcal{O}_{Y, y}$ is a domain and $q$ is dominant.
Thus $q$ is flat. Hence $q$ is finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
\end{proof}





\section{Rational equivalence}
\label{section-rational-equivalence}

\noindent
In this section we define {\it rational equivalence} on $k$-cycles.
We will allow locally finite sums of images of
principal divisors (under closed immersions). This leads to some
pretty strange phenomena, see Example \ref{example-weird}.
However, if we do not allow these then we do not know how to prove that
capping with chern classes of line bundles factors through rational
equivalence.

\begin{definition}
\label{definition-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item Given any locally finite collection $\{W_j \subset X\}$
of integral closed subschemes with $\dim_\delta(W_j) = k + 1$,
and any $f_j \in R(W_j)^*$ we may consider
$$
\sum (i_j)_*\text{div}(f_j) \in Z_k(X)
$$
where $i_j : W_j \to X$ is the inclusion morphism.
This makes sense as the morphism
$\coprod i_j : \coprod W_j \to X$ is proper.
\item We say that $\alpha \in Z_k(X)$ is {\it rationally equivalent to zero}
if $\alpha$ is a cycle of the form displayed above.
\item We say $\alpha, \beta \in Z_k(X)$ are
{\it rationally equivalent} and we write $\alpha \sim_{rat} \beta$
if $\alpha - \beta$ is rationally equivalent to zero.
\item We define
$$
A_k(X) = Z_k(X) / \sim_{rat}
$$
to be the {\it Chow group of $k$-cycles on $X$}. This is sometimes called
the {\it Chow group of $k$-cycles modulo rational equivalence on $X$}.
\end{enumerate}
\end{definition}

\noindent
There are many other interesting (adequate) equivalence relations.
Rational equivalence is the coarsest one of them all.
A very simple but important lemma is the following.

\begin{lemma}
\label{lemma-restrict-to-open}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
Let $k \in \mathbf{Z}$.
Suppose $\alpha, \beta \in Z_k(X)$.
If $\alpha|_U \sim_{rat} \beta|_U$ then there exist a cycle
$\gamma \in Z_k(Y)$ such that
$$
\alpha \sim_{rat} \beta + i_*\gamma.
$$
In other words, the sequence
$$
\xymatrix{
A_k(Y) \ar[r]^{i_*} & A_k(X) \ar[r]^{j^*} & A_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be a locally finite collection of integral closed
subschemes of $U$ of $\delta$-dimension $k + 1$, and let $f_j \in R(W_j)^*$
be elements such that $(\alpha - \beta)|_U = \sum (i_j)_*\text{div}(f_j)$
as in the definition. Set $W_j' \subset X$ equal
to the closure of $W_j$. Suppose that $V \subset X$ is a quasi-compact
open. Then also $V \cap U$ is quasi-compact open in $U$ as
$V$ is Noetherian. Hence the set
$\{j \in J \mid W_j \cap V \not = \emptyset\}
= \{j \in J \mid W'_j \cap V \not = \emptyset\}$
is finite since $\{W_j\}$ is locally finite. In other words we see that
$\{W'_j\}$ is also locally finite. Since $R(W_j) = R(W'_j)$ we see
that
$$
\alpha - \beta - \sum (i'_j)_*\text{div}(f_j)
$$
is a cycle supported on $Y$ and the lemma follows (see
Lemma \ref{lemma-exact-sequence-open}).
\end{proof}

\begin{example}
\label{example-weird}
Here is a ``strange'' example.
Suppose that $S$ is the spectrum of a field $k$
with $\delta$ as in Example \ref{example-field}.
Suppose that $X = C_1 \cup C_2 \cup \ldots$ is an infinite
union of curves $C_j \cong \mathbf{P}^1_k$ glued together
in the following way: The point $\infty \in C_j$ is glued
transversally to the point $0 \in C_{j + 1}$ for $j = 1, 2, 3, \ldots$.
Take the point $0 \in C_1$. This gives a zero cycle
$[0] \in Z_0(X)$. The ``strangeness'' in this situation is
that actually $[0] \sim_{rat} 0$! Namely we can choose
the rational function $f_j \in R(C_j)$ to be the function
which has a simple zero at $0$ and a simple pole at $\infty$
and no other zeros or poles. Then we see that the sum
$\sum (i_j)_*\text{div}(f_j)$ is exactly the $0$-cycle
$[0]$. In fact it turns out that $A_0(X) = 0$ in this example.
If you find this too bizarre, then you can just
make sure your spaces are always quasi-compact
(so $X$ does not even exist for you).
\end{example}

\begin{remark}
\label{remark-infinite-sums-rational-equivalences}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose we have infinite collections $\alpha_i, \beta_i \in Z_k(X)$,
$i \in I$ of $k$-cycles on $X$. Suppose that the supports
of $\alpha_i$ and $\beta_i$ form locally finite collections
of closed subsets of $X$ so that $\sum \alpha_i$
and $\sum \beta_i$ are defined as cycles. Moreover, assume that
$\alpha_i \sim_{rat} \beta_i$ for each $i$. Then it is not
clear that $\sum \alpha_i \sim_{rat} \sum \beta_i$. Namely,
the problem is that the rational equivalences may be
given by locally finite
families $\{W_{i, j}, f_{i, j} \in R(W_{i, j})^*\}_{j \in J_i}$
but the union $\{W_{i, j}\}_{i \in I, j\in J_i}$ may not
be locally finite.

\medskip\noindent
In many cases in practice, one has a locally finite family of closed
subsets $\{T_i\}_{i \in I}$ such that $\alpha_i, \beta_i$
are supported on $T_i$ and such that $\alpha_i = \beta_i$
in $A_k(T_i)$, in other words, the families
$\{W_{i, j}, f_{i, j} \in R(W_{i, j})^*\}_{j \in J_i}$
consist of subschemes $W_{i, j} \subset T_i$. In this case it is true that
$\sum \alpha_i \sim_{rat} \sum \beta_i$ on $X$, simply because
the family $\{W_{i, j}\}_{i \in I, j\in J_i}$ is automatically
locally finite in this case.
\end{remark}






\section{Rational equivalence and push and pull}
\label{section-properties-rational-equivalence}

\noindent
In this section we show that flat pullback and proper pushforward
commute with rational equivalence.

\begin{lemma}
\label{lemma-prepare-flat-pullback-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Assume $Y$ integral with $\dim_\delta(Y) = k$.
Let $f : X \to Y$ be a flat morphism of
relative dimension $r$. Then for $g \in R(Y)^*$ we have
$$
f^*\text{div}_Y(g) =
\sum n_j i_{j, *}\text{div}_{X_j}(g \circ f|_{X_j})
$$
as $(k + r - 1)$-cycles on $X$ where the sum is over the irreducible
components $X_j$ of $X$ and $n_j$ is the multiplicity of $X_j$ in $X$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension
$k + r - 1$. We have to show that the coefficient $n$ of $[Z]$ in
$f^*\text{div}(g)$ is equal to the coefficient
$m$ of $[Z]$ in $\sum i_{j, *} \text{div}(g \circ f|_{X_j})$.
Let $Z'$ be the closure of $f(Z)$ which is an integral closed
subscheme of $Y$. By Lemma \ref{lemma-flat-inverse-image-dimension}
we have $\dim_\delta(Z') \geq k - 1$. Thus either $Z' = Y$
or $Z'$ is a prime divisor on $Y$. If $Z' = Y$, then the coefficients
$n$ and $m$ are both zero: this is clear for $n$ by definition
of $f^*$ and follows for $m$ because $g \circ f|_{X_j}$ is
a unit in any point of $X_j$ mapping to the generic point of $Y$.
Hence we may assume that $Z' \subset Y$ is a prime divisor.

\medskip\noindent
We are going to translate the equality of $n$ and $m$ into algebra.
Namely, let $\xi' \in Z'$ and $\xi \in Z$ be the generic points.
Set $A = \mathcal{O}_{Y, \xi'}$ and $B = \mathcal{O}_{X, \xi}$.
Note that $A$, $B$ are Noetherian, $A \to B$ is flat, local,
$A$ is a domain, and $\mathfrak m_AB$ is an ideal of definition
of the local ring $B$. The rational function $g$ is an element
of the fraction field $Q(A)$ of $A$.
By construction, the closed subschemes $X_j$
which meet $\xi$ correspond $1$-to-$1$ with minimal primes
$$
\mathfrak q_1, \ldots, \mathfrak q_s \subset B
$$
The integers $n_j$ are the corresponding lengths
$$
n_i = \text{length}_{B_{\mathfrak q_i}}(B_{\mathfrak q_i})
$$
The rational functions $g \circ f|_{X_j}$ correspond to the image
$g_i \in \kappa(\mathfrak q_i)^*$ of $g \in Q(A)$.
Putting everything together we see that
$$
n = \text{ord}_A(g) \text{length}_B(B/\mathfrak m_AB)
$$
and that
$$
m = \sum \text{ord}_{B/\mathfrak q_i}(g_i)
\text{length}_{B_{\mathfrak q_i}}(B_{\mathfrak q_i})
$$
Writing $g = x/y$ for some nonzero $x, y \in A$ we see that it suffices
to prove
$$
\text{length}_A(A/(x)) \text{length}_B(B/\mathfrak m_AB) =
\text{length}_B(B/xB)
$$
(equality uses Algebra, Lemma \ref{algebra-lemma-pullback-module})
equals
$$
\sum\nolimits_{i = 1, \ldots, s}
\text{length}_{B/\mathfrak q_i}(B/(x, \mathfrak q_i))
\text{length}_{B_{\mathfrak q_i}}(B_{\mathfrak q_i})
$$
and similarly for $y$. As $A \to B$ is flat it follows that $x$
is a nonzerodivisor in $B$. Hence the desired equality follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha \sim_{rat} \beta$ be rationally equivalent $k$-cycles on $Y$.
Then $f^*\alpha \sim_{rat} f^*\beta$ as $(k + r)$-cycles on $X$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow Y
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $g_j \in R(W_j)^*$. Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $Y$.
Then we have to show that
$$
f^*(\sum i_{j, *}\text{div}(g_j)) = \sum f^*i_{j, *}\text{div}(g_j)
$$
is rationally equivalent to zero on $X$. The sum on the right
makes sense as $\{W_j\}$ is locally finite in $X$ by
Lemma \ref{lemma-inverse-image-locally-finite}.

\medskip\noindent
Consider the fibre products
$$
i'_j : W'_j = W_j \times_Y X \longrightarrow X.
$$
and denote $f_j : W'_j \to W_j$ the first projection.
By Lemma \ref{lemma-flat-pullback-proper-pushforward}
we can write the sum above as
$$
\sum i'_{j, *}(f_j^*\text{div}(g_j))
$$
By Lemma \ref{lemma-prepare-flat-pullback-rational-equivalence}
we see that each $f_j^*\text{div}(g_j)$ is rationally equivalent
to zero on $W'_j$. Hence each $i'_{j, *}(f_j^*\text{div}(g_j))$
is rationally equivalent to zero. Then the same is true for
the displayed sum by the discussion in
Remark \ref{remark-infinite-sums-rational-equivalences}.
\end{proof}

\begin{lemma}
\label{lemma-proper-pushforward-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Suppose $\alpha, \beta \in Z_k(X)$ are rationally equivalent.
Then $p_*\alpha$ is rationally equivalent to $p_*\beta$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow X
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $f_j \in R(W_j)^*$.
Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $X$.
Then we have to show that
$$
p_*\left(\sum i_{j, *}\text{div}(f_j)\right)
$$
is rationally equivalent to zero on $X$.

\medskip\noindent
Note that the sum is equal to
$$
\sum p_*i_{j, *}\text{div}(f_j).
$$
Let $W'_j \subset Y$ be the integral closed subscheme which is the
image of $p \circ i_j$. The collection $\{W'_j\}$ is locally finite
in $Y$ by Lemma \ref{lemma-quasi-compact-locally-finite}.
Hence it suffices to show, for a given $j$, that either
$p_*i_{j, *}\text{div}(f_j) = 0$ or that it
is equal to $i'_{j, *}\text{div}(g_j)$ for some $g_j \in R(W'_j)^*$.

\medskip\noindent
The arguments above therefore reduce us to the case of a since
integral closed subscheme $W \subset X$ of $\delta$-dimension $k + 1$.
Let $f \in R(W)^*$. Let $W' = p(W)$ as above.
We get a commutative diagram of morphisms
$$
\xymatrix{
W \ar[r]_i \ar[d]_{p'} & X \ar[d]^p \\
W' \ar[r]^{i'} & Y
}
$$
Note that $p_*i_*\text{div}(f) = i'_*(p')_*\text{div}(f)$ by
Lemma \ref{lemma-compose-pushforward}. As explained above
we have to show that $(p')_*\text{div}(f)$
is the divisor of a rational function on $W'$ or zero.
There are three cases to distinguish.

\medskip\noindent
The case $\dim_\delta(W') < k$. In this case automatically
$(p')_*\text{div}(f) = 0$ and there is nothing to prove.

\medskip\noindent
The case $\dim_\delta(W') = k$. Let us show that $(p')_*\text{div}(f) = 0$
in this case. Let $\eta \in W'$ be the generic point.
Note that $c : W_\eta \to \Spec(K)$
is a proper integral curve over $K = \kappa(\eta)$
whose function field $K(W_\eta)$ is identified with $R(W)$.
Here is a diagram
$$
\xymatrix{
W_\eta \ar[r] \ar[d]_c & W \ar[d]^{p'} \\
\Spec(K) \ar[r] & W'
}
$$
Let us denote $f_\eta \in K(W_\eta)^*$ the rational function
corresponding to $f \in R(W)^*$.
Moreover, the closed points $\xi$ of $W_\eta$ correspond $1 - 1$ to the
closed integral subschemes $Z = Z_\xi \subset W$ of $\delta$-dimension $k$
with $p'(Z) = W'$. Note that the multiplicity
of $Z_\xi$ in $\text{div}(f)$ is equal to
$\text{ord}_{\mathcal{O}_{W_\eta, \xi}}(f_\eta)$ simply because the
local rings $\mathcal{O}_{W_\eta, \xi}$ and $\mathcal{O}_{W, \xi}$
are identified (as subrings of their fraction fields).
Hence we see that the multiplicity of $[W']$ in
$(p')_*\text{div}(f)$ is equal to the multiplicity of
$[\Spec(K)]$ in $c_*\text{div}(f_\eta)$.
By Lemma \ref{lemma-curve-principal-divisor} this is zero.

\medskip\noindent
The case $\dim_\delta(W') = k + 1$. In this case
Lemma \ref{lemma-proper-pushforward-alteration} applies,
and we see that indeed $p'_*\text{div}(f) = \text{div}(g)$
for some $g \in R(W')^*$ as desired.
\end{proof}















\section{Rational equivalence and the projective line}
\label{section-different-rational-equivalence}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Given any closed subscheme
$Z \subset X \times_S \mathbf{P}^1_S = X \times \mathbf{P}^1$
we let $Z_0$, resp.\ $Z_\infty$ be the scheme theoretic closed
subscheme $Z_0 = \text{pr}_2^{-1}(D_0)$,
resp.\ $Z_\infty = \text{pr}_2^{-1}(D_\infty)$.
Here $D_0$, $D_\infty$ are as defined just above
Lemma \ref{lemma-rational-function}.

\begin{lemma}
\label{lemma-rational-equivalence-family}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $W \subset X \times_S \mathbf{P}^1_S$ be an integral
closed subscheme of $\delta$-dimension $k + 1$.
Assume $W \not = W_0$, and $W \not = W_\infty$. Then
\begin{enumerate}
\item $W_0$, $W_\infty$ are effective Cartier divisors of $W$,
\item $W_0$, $W_\infty$ can be viewed as closed subschemes
of $X$ and
$$
[W_0]_k \sim_{rat} [W_\infty]_k,
$$
\item for any locally finite family of
integral closed subschemes
$W_i \subset X \times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$ with $W_i \not = (W_i)_0$ and
$W_i \not = (W_i)_\infty$ we have
$\sum ([(W_i)_0]_k - [(W_i)_\infty]_k) \sim_{rat} 0$
on $X$, and
\item for any $\alpha \in Z_k(X)$ with $\alpha \sim_{rat} 0$
there exists a locally finite family of
integral closed subschemes $W_i \subset X \times_S \mathbf{P}^1_S$
as above such that $\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}
since the generic point
of $W$ is not mapped into $D_0$ or $D_\infty$ under the projection
$X \times_S \mathbf{P}^1_S \to \mathbf{P}^1_S$ by assumption.

\medskip\noindent
Since $X \times_S D_0 \to X$ is an isomorphism we see that $W_0$
is isomorphic to a closed subscheme of $X$. Similarly for $W_\infty$.
Consider the morphism $p : W \to X$. It is proper and on $W$ we have
$[W_0]_k \sim_{rat} [W_\infty]_k$. Hence part (2) follows from
Lemma \ref{lemma-proper-pushforward-rational-equivalence} as clearly
$p_*[W_0]_k = [W_0]_k$ and similarly for $W_\infty$.

\medskip\noindent
The only content of statement (3) is, given parts (1) and (2), that
the collection $\{(W_i)_0, (W_i)_\infty\}$ is a locally finite collection
of closed subschemes of $X$. This is clear.

\medskip\noindent
Suppose that $\alpha \sim_{rat} 0$.
By definition this means there exist integral closed subschemes
$V_i \subset X$ of $\delta$-dimension $k + 1$ and rational
functions $f_i \in R(V_i)^*$ such that the family
$\{V_i\}_{i \in I}$ is locally finite in $X$ and such that
$\alpha = \sum (V_i \to X)_*\text{div}(f_i)$.
Let
$$
W_i \subset V_i \times_S \mathbf{P}^1_S \subset X \times_S \mathbf{P}^1_S
$$
be the closure of the graph of the rational map $f_i$ as in
Lemma \ref{lemma-rational-function}.
Then we have that $(V_i \to X)_*\text{div}(f_i)$
is equal to $[(W_i)_0]_k - [(W_i)_\infty]_k$ by that same lemma.
Hence the result is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-subscheme-cross-p1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $Z$ be a closed subscheme of $X \times \mathbf{P}^1$.
Assume $\dim_\delta(Z) \leq k + 1$, $\dim_\delta(Z_0) \leq k$,
$\dim_\delta(Z_\infty) \leq k$ and assume
any embedded point $\xi$
(Divisors, Definition \ref{divisors-definition-embedded})
of $Z$ has $\delta(\xi) < k$. Then
$$
[Z_0]_k \sim_{rat} [Z_\infty]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $Z$ which have $\delta$-dimension $k + 1$.
Write
$$
[Z]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by
Divisors, Lemma \ref{divisors-lemma-components-locally-finite}.
We claim that
$$
[Z_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[Z_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[Z_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $I \subset A$ be the ideal cutting out $Z$, in other words so that
$A/I = \mathcal{O}_{Z, \xi}$. Let $t \in A$ be the element cutting
out $X \times_S D_0$ (i.e., the coordinate of $\mathbf{P}^1$ at zero
pulled back). By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(A/I) = 1$. Since $\xi$ is not an embedded point by
definition we see that $A/I$ is Cohen-Macaulay. Since $\dim_\delta(Z_0)
= k$ we see that $\dim(A/(t, I)) = 0$ which implies that $t$
is a nonzerodivisor on $A/I$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$I \subset \mathfrak q_i$ over $I$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(A/(t, I))
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i))
\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}
$$
Thus the result follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cross-p1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X \times \mathbf{P}^1$.
Let $i_0, i_\infty : X \to X \times \mathbf{P}^1$ be the closed immersion
such that $i_t(x) = (x, t)$. Denote $\mathcal{F}_0 = i_0^*\mathcal{F}$ and
$\mathcal{F}_\infty = i_\infty^*\mathcal{F}$.
Assume
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$,
\item $\dim_\delta(\text{Supp}(\mathcal{F}_0)) \leq k$,
$\dim_\delta(\text{Supp}(\mathcal{F}_\infty)) \leq k$, and
\item any embedded associated point $\xi$ of $\mathcal{F}$ has
$\delta(\xi) < k$.
\end{enumerate}
Then
$$
[\mathcal{F}_0]_k \sim_{rat} [\mathcal{F}_\infty]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$.
Write
$$
[\mathcal{F}]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by Lemma \ref{lemma-length-finite}.
We claim that
$$
[\mathcal{F}_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[\mathcal{F}_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[\mathcal{F}_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Let $t \in A$ be the element cutting out $X \times_S D_0$
(i.e., the coordinate of $\mathbf{P}^1$ at zero pulled back).
By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(\text{Supp}(M)) = 1$. Since $\xi$ is not an associated point
of $\mathcal{F}$ by definition we see that $M$ is Cohen-Macaulay module.
Since $\dim_\delta(\text{Supp}(\mathcal{F}_0)) = k$
we see that $\dim(\text{Supp}(M/tM)) = 0$ which implies that $t$
is a nonzerodivisor on $M$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Ass}(M)$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(M/tM)
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i)A)
\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}
$$
Thus the result follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}
















\section{The divisor associated to an invertible sheaf}
\label{section-divisor-invertible-sheaf}

\noindent
The following definition is the analogue of
Divisors, Definition \ref{divisors-definition-divisor-invertible-sheaf}
in our current setup.

\begin{definition}
\label{definition-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any nonzero meromorphic section $s$ of $\mathcal{L}$
we define the {\it Weil divisor associated to $s$} is the
$(n - 1)$-cycle
$$
\text{div}_\mathcal{L}(s) =
\sum \text{ord}_{Z, \mathcal{L}}(s) [Z]
$$
defined in Divisors, Definition
\ref{divisors-definition-divisor-invertible-sheaf}.
This makes sense because Weil divisors have $\delta$-dimension $n - 1$
by Lemma \ref{lemma-divisor-delta-dimension}.
\item We define {\it Weil divisor associated to $\mathcal{L}$} as
$$
c_1(\mathcal{L}) \cap [X] =
\text{class of }\text{div}_\mathcal{L}(s) \in A_{n - 1}(X)
$$
where $s$ is any nonzero meromorphic section of $\mathcal{L}$ over
$X$. This is well defined by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-well-defined}.
\end{enumerate}
\end{definition}

\noindent
There are some cases where it is easy to compute the
Weil divisor associated to an invertible sheaf.

\begin{lemma}
\label{lemma-compute-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$ be a nonzero global section.
Then
$$
\text{div}_\mathcal{L}(s) = [Z(s)]_{n - 1}
$$
in $Z_{n - 1}(X)$ and
$$
c_1(\mathcal{L}) \cap [X] = [Z(s)]_{n - 1}
$$
in $A_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n - 1$. Let $\xi \in Z$ be its generic
point. Choose a generator $s_\xi \in \mathcal{L}_\xi$.
Write $s = fs_\xi$ for some $f \in \mathcal{O}_{X, \xi}$.
By definition of $Z(s)$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}
we see that $Z(s)$ is cut out by a quasi-coherent
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$ such
that $\mathcal{I}_\xi = (f)$. Hence
$\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{Z(s), \xi})
=
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{X, \xi}/(f))
=
\text{ord}_{\mathcal{O}_{X, x}}(f)$ as desired.
\end{proof}

\noindent
The following lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-cap-c1}.

\begin{lemma}
\label{lemma-flat-pullback-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_Y$-module.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$. Then
$$
f^*(c_1(\mathcal{L}) \cap [Y]) = c_1(f^*\mathcal{L}) \cap [X]
$$
in $A_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
We will show that actually
$f^*\text{div}_\mathcal{L}(s) = \text{div}_{f^*\mathcal{L}}(f^*s)$
and hence the lemma holds.
To see this let $\xi \in Y$ be a point and let $s_\xi \in \mathcal{L}_\xi$
be a generator. Write $s = gs_\xi$ with $g \in R(X)^*$.
Then there is an open neighbourhood $V \subset Y$ of $\xi$
such that $s_\xi \in \mathcal{L}(V)$ and such that $s_\xi$ generates
$\mathcal{L}|_V$. Hence we see that
$$
\text{div}_\mathcal{L}(s)|_V = \text{div}(g)|_V.
$$
In exactly the same way, since $f^*s_\xi$ generates $\mathcal{L}$
over $f^{-1}(V)$ and since $f^*s = g f^*s_\xi$ we also
have
$$
\text{div}_\mathcal{L}(f^*s)|_{f^{-1}(V)}
=
\text{div}(g)|_{f^{-1}(V)}.
$$
Thus the desired equality of cycles over $f^{-1}(V)$ follows from the
corresponding result for pullbacks of principal divisors, see
Lemma \ref{lemma-flat-pullback-principal-divisor}.
\end{proof}



\section{Intersecting with an invertible sheaf}
\label{section-intersecting-with-divisors}

\noindent
In this section we study the following construction.

\begin{definition}
\label{definition-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We define, for every integer $k$, an operation
$$
c_1(\mathcal{L}) \cap - :
Z_{k + 1}(X) \to A_k(X)
$$
called {\it intersection with the first chern class of $\mathcal{L}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ with
$\dim_\delta(W) = k + 1$ we define
$$
c_1(\mathcal{L}) \cap [W] = i_*(c_1({i^*\mathcal{L}}) \cap [W])
$$
where the right hand side is defined in
Definition \ref{definition-divisor-invertible-sheaf}.
\item For a general $(k + 1)$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_1(\mathcal{L}) \cap \alpha = \sum n_i c_1(\mathcal{L}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Write each $c_1(\mathcal{L}) \cap W_i = \sum_j n_{i, j} [Z_{i, j}]$
with $\{Z_{i, j}\}_j$ a locally finite sum
of integral closed subschemes of $W_i$. Since $\{W_i\}$ is a locally
finite collection of integral closed subschemes on $X$, it follows
easily that $\{Z_{i, j}\}_{i, j}$ is a locally finite collection
of closed subschemes of $X$. Hence
$c_1(\mathcal{L}) \cap \alpha = \sum n_in_{i, j}[Z_{i, j}]$
is a cycle. Another, more convenient, way to think about this
is to observe that the morphism $\coprod W_i \to X$ is
proper. Hence $c_1(\mathcal{L}) \cap \alpha$ can be viewed
as the pushforward of a class in $A_k(\coprod W_i) = \prod A_k(W_i)$.
This also explains why the result is well defined up to rational
equivalence on $X$.

\medskip\noindent
The main goal for the next few sections is to show that intersecting with
$c_1(\mathcal{L})$ factors through rational equivalence.
This is not a triviality.

\begin{lemma}
\label{lemma-c1-cap-additive}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be an invertible sheaves on $X$.
Then
$$
c_1(\mathcal{L}) \cap \alpha  + c_1(\mathcal{N}) \cap \alpha =
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N}) \cap \alpha
$$
in $A_k(X)$ for every $\alpha \in Z_{k - 1}(X)$. Moreover,
$c_1(\mathcal{O}_X) \cap \alpha = 0$ for all $\alpha$.
\end{lemma}

\begin{proof}
The additivity follows directly from
Divisors, Lemma \ref{divisors-lemma-c1-additive}
and the definitions. To see that $c_1(\mathcal{O}_X) \cap \alpha = 0$
consider the section $1 \in \Gamma(X, \mathcal{O}_X)$. This restricts
to an everywhere nonzero section on any integral closed subscheme
$W \subset X$. Hence $c_1(\mathcal{O}_X) \cap [W] = 0$ as desired.
\end{proof}

\noindent
Recall that $Z(s) \subset X$ denotes the zero scheme of a global section
$s$ of an invertible sheaf on a scheme $X$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.

\begin{lemma}
\label{lemma-prepare-geometric-cap}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $Y$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_Y$-module.
Let $s \in \Gamma(Y, \mathcal{L})$.
Assume
\begin{enumerate}
\item $\dim_\delta(Y) \leq k + 1$,
\item $\dim_\delta(Z(s)) \leq k$, and
\item for every generic point $\xi$ of an irreducible component of
$Z(s)$ of $\delta$-dimension $k$ the multiplication by $s$
induces an injection $\mathcal{O}_{Y, \xi} \to \mathcal{L}_\xi$.
\end{enumerate}
Write $[Y]_{k + 1} = \sum n_i[Y_i]$ where $Y_i \subset Y$ are the
irreducible components of $Y$ of $\delta$-dimension $k + 1$.
Set $s_i = s|_{Y_i} \in \Gamma(Y_i, \mathcal{L}|_{Y_i})$. Then
\begin{equation}
\label{equation-equal-as-cycles}
[Z(s)]_k =  \sum n_i[Z(s_i)]_k
\end{equation}
as $k$-cycles on $Y$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be an integral closed subscheme of
$\delta$-dimension $k$. Let $\xi \in Z$ be its generic point.
We want to compare the coefficient $n$ of $[Z]$ in the expression
$\sum n_i[Z(s_i)]_k$ with the coefficient $m$ of $[Z]$ in the
expression $[Z(s)]_k$. Choose a generator $s_\xi \in \mathcal{L}_\xi$.
Write $A = \mathcal{O}_{Y, \xi}$, $L = \mathcal{L}_\xi$.
Then $L = As_\xi$. Write $s = f s_\xi$ for some (unique) $f \in A$.
Hypothesis (3) means that $f : A \to A$ is injective.
Since $\dim_\delta(Y) \leq k + 1$ and $\dim_\delta(Z) = k$
we have $\dim(A) = 0$ or $1$. We have
$$
m = \text{length}_A(A/(f))
$$
which is finite in either case.

\medskip\noindent
If $\dim(A) = 0$, then $f : A \to A$ being injective
implies that $f \in A^*$. Hence in this case $m$ is zero.
Moreover, the condition $\dim(A) = 0$ means that $\xi$
does not lie on any irreducible component of $\delta$-dimension
$k + 1$, i.e., $n = 0$ as well.

\medskip\noindent
Now, let $\dim(A) = 1$.
Since $A$ is a Noetherian local ring it has finitely
many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$.
These correspond 1-1 with the $Y_i$ passing through $\xi'$.
Moreover $n_i = \text{length}_{A_{\mathfrak q_i}}(A_{\mathfrak q_i})$.
Also, the multiplicity of $[Z]$ in $[Z(s_i)]_k$ is
$\text{length}_A(A/(f, \mathfrak q_i))$.
Hence the equation to prove in this case is
$$
\text{length}_A(A/(f))
=
\sum \text{length}_{A_{\mathfrak q_i}}(A_{\mathfrak q_i})
\text{length}_A(A/(f, \mathfrak q_i))
$$
which follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\noindent
The following lemma is a useful result in order to compute the intersection
product of the $c_1$ of an invertible sheaf and the cycle associated
to a closed subscheme.
Recall that $Z(s) \subset X$ denotes the zero scheme of a global section
$s$ of an invertible sheaf on a scheme $X$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.

\begin{lemma}
\label{lemma-geometric-cap}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $Y \subset X$ be a closed subscheme.
Let $s \in \Gamma(Y, \mathcal{L}|_Y)$.
Assume
\begin{enumerate}
\item $\dim_\delta(Y) \leq k + 1$,
\item $\dim_\delta(Z(s)) \leq k$, and
\item for every generic point $\xi$ of an irreducible component of
$Z(s)$ of $\delta$-dimension $k$ the multiplication by $s$
induces an injection
$\mathcal{O}_{Y, \xi} \to (\mathcal{L}|_Y)_\xi$\footnote{For example,
this holds if $s$ is a regular section of $\mathcal{L}|_Y$.}.
\end{enumerate}
Then
$$
c_1(\mathcal{L}) \cap [Y]_{k + 1} = [Z(s)]_k
$$
in $A_k(X)$.
\end{lemma}

\begin{proof}
Write
$$
[Y]_{k + 1} = \sum n_i[Y_i]
$$
where $Y_i \subset Y$ are the irreducible components of
$Y$ of $\delta$-dimension $k + 1$ and $n_i > 0$.
By assumption the restriction
$s_i = s|_{Y_i} \in \Gamma(Y_i, \mathcal{L}|_{Y_i})$ is not
zero, and hence is a regular section. By Lemma \ref{lemma-compute-c1}
we see that $[Z(s_i)]_k$ represents $c_1(\mathcal{L}|_{Y_i})$.
Hence by definition
$$
c_1(\mathcal{L}) \cap [Y]_{k + 1} = \sum n_i[Z(s_i)]_k
$$
Thus the result follows from Lemma \ref{lemma-prepare-geometric-cap}.
\end{proof}




\section{Intersecting with an invertible sheaf and push and pull}
\label{section-intersecting-with-divisors-push-pull}

\noindent
In this section we prove that the operation $c_1(\mathcal{L}) \cap -$
commutes with flat pullback and proper pushforward.

\begin{lemma}
\label{lemma-prepare-flat-pullback-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Assume $Y$ is integral and $n = \dim_\delta(Y)$.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
Then we have
$$
f^*\text{div}_\mathcal{L}(s) = \sum n_i\text{div}_{f^*\mathcal{L}|_{X_i}}(s_i)
$$
in $Z_{n + r - 1}(X)$. Here the sum is over the irreducible
components $X_i \subset X$ of $\delta$-dimension $n + r$,
the section $s_i = f|_{X_i}^*(s)$ is the pullback of $s$, and
$n_i = m_{X_i, X}$ is the multiplicity of $X_i$ in $X$.
\end{lemma}

\begin{proof}
To prove this equality of cycles, we may work locally on $Y$.
Hence we may assume $Y$ is affine and $s = p/q$ for some nonzero
sections $p \in \Gamma(Y, \mathcal{L})$ and $q \in \Gamma(Y, \mathcal{O})$.
If we can show both
$$
f^*\text{div}_\mathcal{L}(p) =
\sum n_i\text{div}_{f^*\mathcal{L}|_{X_i}}(p_i)
\quad\text{and}\quad
f^*\text{div}_\mathcal{O}(q) =
\sum n_i\text{div}_{\mathcal{O}_{X_i}}(q_i)
$$
(with obvious notations) then we win by the
additivity, see Divisors, Lemma \ref{divisors-lemma-c1-additive}.
Thus we may assume that $s \in \Gamma(Y, \mathcal{L})$.
In this case we may apply the equality
(\ref{equation-equal-as-cycles}) to see that
$$
[Z(f^*(s))]_{k + r - 1} =
\sum n_i\text{div}_{f^*\mathcal{L}|_{X_i}}(s_i)
$$
where $f^*(s) \in f^*\mathcal{L}$ denotes the pullback of $s$ to $X$.
On the other hand we have
$$
f^*\text{div}_\mathcal{L}(s) = f^*[Z(s)]_{k - 1}
= [f^{-1}(Z(s))]_{k + r - 1},
$$
by Lemmas \ref{lemma-compute-c1} and \ref{lemma-pullback-coherent}.
Since $Z(f^*(s)) = f^{-1}(Z(s))$ we win.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_1(\mathcal{L}) \cap \alpha) = c_1(f^*\mathcal{L}) \cap f^*\alpha
$$
in $A_{k + r - 1}(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_i[W_i]$. We will show that
$$
f^*(c_1(\mathcal{L}) \cap [W_i]) = c_1(f^*\mathcal{L}) \cap f^*[W_i]
$$
in $A_{k + r - 1}(X)$ by producing a rational equivalence
on the closed subscheme $f^{-1}(W_i)$ of $X$.
By the discussion in
Remark \ref{remark-infinite-sums-rational-equivalences}
this will prove the equality of the lemma is true.

\medskip\noindent
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension $k$.
Consider the closed subscheme $W' = f^{-1}(W) = W \times_Y X$
so that we have the fibre product diagram
$$
\xymatrix{
W' \ar[r] \ar[d]_h & X \ar[d]^f \\
W \ar[r] & Y
}
$$
We have to show that
$f^*(c_1(\mathcal{L}) \cap [W]) = c_1(f^*\mathcal{L}) \cap f^*[W]$.
Choose a nonzero meromorphic section $s$ of $\mathcal{L}|_W$.
Let $W'_i \subset W'$ be the irreducible components of
$\delta$-dimension $k + r$. Write $[W']_{k + r} = \sum n_i[W'_i]$
with $n_i$ the multiplicity of $W'_i$ in $W'$ as per definition.
So $f^*[W] = \sum n_i[W'_i]$ in $Z_{k + r}(X)$.
Since each $W'_i \to W$ is dominant we
see that $s_i = s|_{W'_i}$ is a nonzero meromorphic section for
each $i$. By Lemma \ref{lemma-prepare-flat-pullback-cap-c1}
we have the following equality of cycles
$$
h^*\text{div}_{\mathcal{L}|_W}(s) =
\sum n_i\text{div}_{f^*\mathcal{L}|_{W'_i}}(s_i)
$$
in $Z_{k + r - 1}(W')$. This finishes the proof since
the left hand side is a cycle on $W'$ which pushes to
$f^*(c_1(\mathcal{L}) \cap [W])$ in $A_{k + r - 1}(X)$
and the right hand side is a cycle on $W'$ which pushes to
$c_1(f^*\mathcal{L}) \cap f^*[W]$ in $A_{k + r - 1}(X)$.
\end{proof}

\begin{lemma}
\label{lemma-equal-c1-as-cycles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a proper morphism.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $s$ be a nonzero meromorphic section $s$ of $\mathcal{L}$ on $Y$.
Assume $X$, $Y$ integral, $f$ dominant, and $\dim_\delta(X) = \dim_\delta(Y)$.
Then
$$
f_*\left(\text{div}_{f^*\mathcal{L}}(f^*s)\right) =
[R(X) : R(Y)]\text{div}_\mathcal{L}(s).
$$
as cycles on $Y$. In particular
$$
f_*(c_1(f^*\mathcal{L}) \cap [X]) = c_1(\mathcal{L}) \cap f_*[Y].
$$
\end{lemma}

\begin{proof}
The last equation follows from the first since $f_*[X] = [R(X) : R(Y)][Y]$
by definition. It turns out that we can re-use
Lemma \ref{lemma-proper-pushforward-alteration}
to prove this. Namely, since we are trying to prove an equality
of cycles, we may work locally on $Y$. Hence we may assume
that $\mathcal{L} = \mathcal{O}_Y$. In this case $s$
corresponds to a rational function $g \in R(Y)$, and
we are simply trying to prove
$$
f_*\left(\text{div}_X(g)\right) =
[R(X) : R(Y)]\text{div}_Y(g).
$$
Comparing with the result of the aforementioned
Lemma \ref{lemma-proper-pushforward-alteration}
we see this true since
$\text{Nm}_{R(X)/R(Y)}(g) = g^{[R(X) : R(Y)]}$
as $g \in R(Y)^*$.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha \in Z_{k + 1}(X)$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Then
$$
p_*(c_1(p^*\mathcal{L}) \cap \alpha) = c_1(\mathcal{L}) \cap p_*\alpha
$$
in $A_k(Y)$.
\end{lemma}

\begin{proof}
Suppose that $p$ has the property that for every integral
closed subscheme $W \subset X$ the map $p|_W : W \to Y$
is a closed immersion. Then, by definition of capping
with $c_1(\mathcal{L})$ the lemma holds.

\medskip\noindent
We will use this remark to reduce to a special case. Namely,
write $\alpha = \sum n_i[W_i]$ with $n_i \not = 0$ and $W_i$ pairwise
distinct. Let $W'_i \subset Y$ be the image of $W_i$ (as an integral
closed subscheme). Consider the diagram
$$
\xymatrix{
X' = \coprod W_i \ar[r]_-q \ar[d]_{p'} & X \ar[d]^p \\
Y' = \coprod W'_i \ar[r]^-{q'} & Y.
}
$$
Since $\{W_i\}$ is locally finite on $X$, and $p$ is proper
we see that $\{W'_i\}$ is locally finite on $Y$ and that
$q, q', p'$ are also proper morphisms.
We may think of $\sum n_i[W_i]$ also as a $k$-cycle
$\alpha' \in Z_k(X')$. Clearly $q_*\alpha' = \alpha$.
We have
$q_*(c_1(q^*p^*\mathcal{L}) \cap \alpha')
= c_1(p^*\mathcal{L}) \cap q_*\alpha'$
and
$(q')_*(c_1((q')^*\mathcal{L}) \cap p'_*\alpha') =
c_1(\mathcal{L}) \cap q'_*p'_*\alpha'$ by the initial
remark of the proof. Hence it suffices to prove the lemma
for the morphism $p'$ and the cycle $\sum n_i[W_i]$.
Clearly, this means we may assume $X$, $Y$ integral,
$f : X \to Y$ dominant and $\alpha = [X]$.
In this case the result follows from
Lemma \ref{lemma-equal-c1-as-cycles}.
\end{proof}






\section{The key formula}
\label{section-key}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume
$X$ is integral and $\dim_\delta(X) = n$.
Let $\mathcal{L}$ and $\mathcal{N}$ be invertible sheaves on $X$.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$ and
let $t$ be a nonzero meromorphic section of $\mathcal{N}$.
Let $Z_i \subset X$, $i \in I$ be a locally finite set of irreducible
closed subsets of codimension $1$ with the following property:
If $Z \not \in \{Z_i\}$ with generic point $\xi$, then $s$ is a generator
for $\mathcal{L}_\xi$ and $t$ is a generator for $\mathcal{N}_\xi$.
Such a set exists by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-locally-finite}.
Then
$$
\text{div}_\mathcal{L}(s) = \sum \text{ord}_{Z_i, \mathcal{L}}(s) [Z_i]
$$
and similarly
$$
\text{div}_\mathcal{N}(t) = \sum \text{ord}_{Z_i, \mathcal{N}}(t) [Z_i]
$$
Unwinding the definitions more, we pick for each $i$ generators
$s_i \in \mathcal{L}_{\xi_i}$ and $t_i \in \mathcal{N}_{\xi_i}$
where $\xi_i$ is the generic point of $Z_i$. Then we can write
$$
s = f_i s_i
\quad\text{and}\quad
t = g_i t_i
$$
Set $B_i = \mathcal{O}_{X, \xi_i}$. Then by definition
$$
\text{ord}_{Z_i, \mathcal{L}}(s) = \text{ord}_{B_i}(f_i)
\quad\text{and}\quad
\text{ord}_{Z_i, \mathcal{N}}(t) = \text{ord}_{B_i}(g_i)
$$
Since $t_i$ is a generator of $\mathcal{N}_{\xi_i}$ we see that
its image in the fibre $\mathcal{N}_{\xi_i} \otimes \kappa(\xi_i)$
is a nonzero meromorphic section of $\mathcal{N}|_{Z_i}$. We will denote
this image $t_i|_{Z_i}$. From our definitions it follows that
$$
c_1(\mathcal{N}) \cap \text{div}_\mathcal{L}(s) =
\sum \text{ord}_{B_i}(f_i)
(Z_i \to X)_*\text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i})
$$
and similarly
$$
c_1(\mathcal{L}) \cap \text{div}_\mathcal{N}(t) =
\sum \text{ord}_{B_i}(g_i)
(Z_i \to X)_*\text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i})
$$
in $A_{n - 2}(X)$. We are going to find a rational equivalence between
these two cycles. To do this we consider the tame symbol
$$
\partial_{B_i}(f_i, g_i) \in \kappa(\xi_i)^*
$$
see Section \ref{section-tame-symbol}.

\begin{lemma}[Key formula]
\label{lemma-key-formula}
In the situation above the cycle
$$
\sum
(Z_i \to X)_*\left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i}) -
\text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) \right)
$$
is equal to the cycle
$$
\sum (Z_i \to X)_*\text{div}(\partial_{B_i}(f_i, g_i))
$$
\end{lemma}

\begin{proof}
First, let us examine what happens if we replace $s_i$ by $us_i$
for some unit $u$ in $B_i$. Then $f_i$ gets replaced by $u^{-1} f_i$.
Thus the first part of the first expression of the lemma is unchanged
and in the second part we add
$$
-\text{ord}_{B_i}(g_i)\text{div}(u|_{Z_i})
$$
(where $u|_{Z_i}$ is the image of $u$ in the residue field) by
Divisors, Lemma \ref{divisors-lemma-divisor-meromorphic-well-defined}
and in the second expression we add
$$
\text{div}(\partial_{B_i}(u^{-1}, g_i))
$$
by bi-linearity of the tame symbol. These terms agree by property
(\ref{item-normalization}) of the tame symbol.

\medskip\noindent
Let $Z \subset X$ be an irreducible closed with $\dim_\delta(Z) = n - 2$.
To show that the coefficients of $Z$ of the two cycles of the lemma
is the same, we may do a replacement $s_i \mapsto us_i$ as in the previous
paragraph. In exactly the same way one shows that we may do a replacement
$t_i \mapsto vt_i$ for some unit $v$ of $B_i$.

\medskip\noindent
Since we are proving the equality of cycles we may argue one coefficient
at a time. Thus we choose an irreducible closed $Z \subset X$
with $\dim_\delta(Z) = n - 2$ and compare coefficients. Let $\xi \in Z$
be the generic point and set $A = \mathcal{O}_{X, \xi}$. This is a Noetherian
local domain of dimension $2$. Choose generators $\sigma$ and $\tau$
for $\mathcal{L}_\xi$ and $\mathcal{N}_\xi$. After shrinking $X$, we may
and do assume $\sigma$ and $\tau$ define trivializations
of the invertible sheaves $\mathcal{L}$ and $\mathcal{N}$ over all of $X$.
Because $Z_i$ is locally
finite after shrinking $X$ we may assume $Z \subset Z_i$ for all $i \in I$
and that $I$ is finite. Then $\xi_i$ corresponds to a prime
$\mathfrak q_i \subset A$ of height $1$.
We may write $s_i = a_i \sigma$ and $t_i = b_i \tau$
for some $a_i$ and $b_i$ units in $A_{\mathfrak q_i}$.
By the remarks above, it suffices to prove the lemma when
$a_i = b_i = 1$ for all $i$.

\medskip\noindent
Assume $a_i = b_i = 1$ for all $i$. Then the first expression of the
lemma is zero, because we choose $\sigma$ and $\tau$ to be trivializing
sections. Write $s = f\sigma$ and $t = g \tau$ with $f$ and $g$ in the
fraction field of $A$. By the previous paragraph we have reduced to the case
$f_i = f$ and $g_i = g$ for all $i$. Moreover, for a height $1$ prime
$\mathfrak q$ of $A$ which is not in $\{\mathfrak q_i\}$ we have
that both $f$ and $g$ are units in $A_\mathfrak q$ (by our choice of
the family $\{Z_i\}$ in the discussion preceding the lemma). Thus
the coefficient of $Z$ in the second expression of the lemma is
$$
\sum\nolimits_i \text{ord}_{A/\mathfrak q_i}(\partial_{B_i}(f, g))
$$
which is zero by the key Lemma \ref{lemma-milnor-gersten-low-degree}.
\end{proof}






\section{Intersecting with an invertible sheaf and rational equivalence}
\label{section-commutativity}

\noindent
Applying the key lemma we obtain the fundamental properties of intersecting
with invertible sheaves. In particular, we will see that
$c_1(\mathcal{L}) \cap -$ factors through rational equivalence and
that these operations for different invertible sheaves commute.

\begin{lemma}
\label{lemma-commutativity-on-integral}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
Choose a nonzero meromorphic section $s$ of $\mathcal{L}$
and a nonzero meromorphic section $t$ of $\mathcal{N}$.
Set $\alpha = \text{div}_\mathcal{L}(s)$ and
$\beta = \text{div}_\mathcal{N}(t)$.
Then
$$
c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{L}) \cap \beta
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
Immediate from the key Lemma \ref{lemma-key-formula}
and the discussion preceding it.
\end{proof}

\begin{lemma}
\label{lemma-factors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be invertible on $X$.
The operation $\alpha \mapsto c_1(\mathcal{L}) \cap \alpha$
factors through rational equivalence to give an operation
$$
c_1(\mathcal{L}) \cap - : A_{k + 1}(X) \to A_k(X)
$$
\end{lemma}

\begin{proof}
Let $\alpha \in Z_{k + 1}(X)$, and $\alpha \sim_{rat} 0$.
We have to show that $c_1(\mathcal{L}) \cap \alpha$
as defined in Definition \ref{definition-cap-c1} is zero.
By Definition \ref{definition-rational-equivalence} there
exists a locally finite family $\{W_j\}$ of integral closed
subschemes with $\dim_\delta(W_j) = k + 2$ and rational functions
$f_j \in R(W_j)^*$ such that
$$
\alpha = \sum (i_j)_*\text{div}_{W_j}(f_j)
$$
Note that $p : \coprod W_j \to X$ is a proper morphism,
and hence $\alpha = p_*\alpha'$ where $\alpha' \in Z_{k + 1}(\coprod W_j)$
is the sum of the principal divisors $\text{div}_{W_j}(f_j)$.
By Lemma \ref{lemma-pushforward-cap-c1} we have
$c_1(\mathcal{L}) \cap \alpha = p_*(c_1(p^*\mathcal{L}) \cap \alpha')$.
Hence it suffices to show that each
$c_1(\mathcal{L}|_{W_j}) \cap \text{div}_{W_j}(f_j)$ is zero.
In other words we may assume that $X$ is integral and
$\alpha = \text{div}_X(f)$ for some $f \in R(X)^*$.

\medskip\noindent
Assume $X$ is integral and $\alpha = \text{div}_X(f)$ for some $f \in R(X)^*$.
We can think of $f$ as a regular meromorphic section of the invertible
sheaf $\mathcal{N} = \mathcal{O}_X$. Choose a meromorphic section
$s$ of $\mathcal{L}$ and denote $\beta = \text{div}_\mathcal{L}(s)$.
By Lemma \ref{lemma-commutativity-on-integral}
we conclude that
$$
c_1(\mathcal{L}) \cap \alpha = c_1(\mathcal{O}_X) \cap \beta.
$$
However, by Lemma \ref{lemma-c1-cap-additive} we see that the right hand side
is zero in $A_k(X)$ as desired.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be invertible on $X$.
We will denote
$$
c_1(\mathcal{L})^s \cap - : A_{k + s}(X) \to A_k(X)
$$
the operation $c_1(\mathcal{L}) \cap - $. This makes sense by
Lemma \ref{lemma-factors}. We will denote $c_1(\mathcal{L}^s \cap -$
the $s$-fold iterate of this operation for all $s \geq 0$.

\begin{lemma}
\label{lemma-cap-commutative}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
For any $\alpha \in A_{k + 2}(X)$ we have
$$
c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
$$
as elements of $A_k(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum m_j[Z_j]$ for some locally finite
collection of integral closed subschemes $Z_j \subset X$
with $\dim_\delta(Z_j) = k + 2$.
Consider the proper morphism $p : \coprod Z_j \to X$.
Set $\alpha' = \sum m_j[Z_j]$ as a $(k + 2)$-cycle on
$\coprod Z_j$. By several applications of
Lemma \ref{lemma-pushforward-cap-c1} we see that
$c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
= p_*(c_1(p^*\mathcal{L}) \cap c_1(p^*\mathcal{N}) \cap \alpha')$
and
$c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
= p_*(c_1(p^*\mathcal{N}) \cap c_1(p^*\mathcal{L}) \cap \alpha')$.
Hence it suffices to prove the formula in case $X$ is integral
and $\alpha = [X]$. In this case the result follows
from Lemma \ref{lemma-commutativity-on-integral} and the definitions.
\end{proof}




\section{Intersecting with effective Cartier divisors}
\label{section-intersecting-effective-Cartier}

\noindent
In this section we define the gysin map for the zero locus of a
section of an invertible sheaf. The most interesting case is that
of an effective Cartier divisor; the reason for the generalization
is to be able to formulate various compatibilities, see
Remark \ref{remark-pullback-pairs} and
Lemmas \ref{lemma-closed-in-X-gysin},
\ref{lemma-gysin-flat-pullback}, and
\ref{lemma-gysin-commutes-gysin}.
These results can be generalized to deal with locally principal
closed subschemes with a virtual normal bundle
(Remark \ref{remark-generalize-to-virtual}).
A generalization in a different direction comes from looking
at pseudo-divisors (Remark \ref{remark-generalize-to-pseudo-divisor}).

\medskip\noindent
Recall that effective Cartier divisors correspond $1$-to-$1$ to
isomorphism classes of pairs $(\mathcal{L}, s)$ where $\mathcal{L}$
is an invertible sheaf and $s$ is a global section, see
Divisors, Lemma \ref{divisors-lemma-characterize-OD}.
If $D$ corresponds to $(\mathcal{L}, s)$, then
$\mathcal{L} = \mathcal{O}_X(D)$. Please keep this in mind while
reading this section.

\begin{definition}
\label{definition-gysin-homomorphism}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s)$ be a pair consisting of an invertible
sheaf and a global section $s \in \Gamma(X, \mathcal{L})$.
Let $D = Z(s)$ be the zero scheme of $s$, and
denote $i : D \to X$ the closed immersion.
We define, for every integer $k$, a (refined) {\it Gysin homomorphism}
$$
i^* : Z_{k + 1}(X) \to A_k(D).
$$
by the following rules:
\begin{enumerate}
\item Given a integral closed subscheme $W \subset X$ with
$\dim_\delta(W) = k + 1$ we define
\begin{enumerate}
\item if $W \not \subset D$, then $i^*[W] = [D \cap W]_k$ as a
$k$-cycle on $D$, and
\item if $W \subset D$, then
$i^*[W] = i'_*(c_1(\mathcal{L}|_W) \cap [W])$,
where $i' : W \to D$ is the induced closed immersion.
\end{enumerate}
\item For a general $(k + 1)$-cycle $\alpha = \sum n_j[W_j]$
we set
$$
i^*\alpha = \sum n_j i^*[W_j]
$$
\item If $D$ is an effective Cartier divisor, then we denote
$D \cdot \alpha = i_*i^*\alpha$ the pushforward of
the class to a class on $X$.
\end{enumerate}
\end{definition}

\noindent
In fact, as we will see later, this Gysin homomorphism $i^*$ can be viewed
as an example of a non-flat pullback. Thus we will sometimes informally
call the class $i^*\alpha$ the {\it pullback} of the class $\alpha$.

\begin{remark}
\label{remark-pullback-pairs}
Let $f : X' \to X$ be a morphism of schemes locally of finite type over $S$
as in Situation \ref{situation-setup}. Let $(\mathcal{L}, s, i : D \to X)$
be a triple as in Definition \ref{definition-gysin-homomorphism}.
Then we can set $\mathcal{L}' = f^*\mathcal{L}$, $s' = f^*s$, and
$D' = X' \times_X D = Z(s')$. This gives a commutative diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
and we can ask for various compatibilities between $i^*$ and $(i')^*$.
\end{remark}

\begin{remark}
\label{remark-on-cycles}
Let $X \to S$, $\mathcal{L}$, $s$, $i : D \to X$ be as in
Definition \ref{definition-gysin-homomorphism} and assume
that $\mathcal{L}|_D \cong \mathcal{O}_D$. In this case we
can define a canonical map $i^* : Z_{k + 1}(X) \to Z_k(D)$
on cycles, by requiring that $i^*[W] = 0$ whenever $W \subset D$.
The possibility to do this will be useful later on.
\end{remark}

\begin{remark}
\label{remark-generalize-to-virtual}
Let $X$ be a scheme locally of finite type over $S$ as in
Situation \ref{situation-setup}. Let $(D, \mathcal{N}, \sigma)$
be a triple consisting of a locally principal (Divisors, Definition
\ref{divisors-definition-effective-Cartier-divisor}) closed subscheme
$i : D \to X$, an invertible $\mathcal{O}_D$-module $\mathcal{N}$, and
a surjection $\sigma : \mathcal{N}^{\otimes -1} \to i^*\mathcal{I}_D$
of $\mathcal{O}_D$-modules. Here $\mathcal{N}$ should be thought of as
a {\it virtual normal bundle of $D$ in $X$}. The construction of
$i^* : Z_{k + 1}(X) \to A_k(D)$ in
Definition \ref{definition-gysin-homomorphism}
generalizes to such triples and it is perhaps the correct generality
for the definition.
\end{remark}

\begin{remark}
\label{remark-generalize-to-pseudo-divisor}
Let $X$ be a scheme locally of finite type over $S$ as in
Situation \ref{situation-setup}. In \cite{F} a {\it pseudo-divisor} on $X$
is defined as a triple $D = (\mathcal{L}, Z, s)$ where $\mathcal{L}$
is an invertible $\mathcal{O}_X$-module, $Z \subset X$ is a closed subset,
and $s \in \Gamma(X \setminus Z, \mathcal{L})$ is a nowhere vanishing
section. Similarly to the above, one can define for every $\alpha$
in $A_{k + 1}(X)$ a product $D \cdot \alpha$ in $A_k(Z \cap |\alpha|)$
where $|\alpha|$ is the support of $\alpha$.
\end{remark}

\begin{lemma}
\label{lemma-support-cap-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}. Let $\alpha$ be a
$(k + 1)$-cycle on $X$. Then $i_*i^*\alpha = c_1(\mathcal{L}) \cap \alpha$
in $A_k(X)$. In particular, if $D$ is an effective Cartier divisor, then
$D \cdot \alpha = c_1(\mathcal{O}_X(D)) \cap \alpha$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_j[W_j]$ where $i_j : W_j \to X$ are integral closed
subschemes with $\dim_\delta(W_j) = k$.
Since $D$ is the zero scheme of $s$ we see that $D \cap W_j$ is the zero scheme
of the restriction $s|_{W_j}$. Hence for each $j$ such that
$W_j \not \subset D$ we have
$c_1(\mathcal{L}) \cap [W_j] = [D \cap W_j]_k$
by Lemma \ref{lemma-geometric-cap}. So we have
$$
c_1(\mathcal{L}) \cap \alpha
=
\sum\nolimits_{W_j \not \subset D} n_j[D \cap W_j]_k
+
\sum\nolimits_{W_j \subset D}
n_j i_{j, *}(c_1(\mathcal{L})|_{W_j}) \cap [W_j])
$$
in $A_k(X)$ by Definition \ref{definition-cap-c1}.
The right hand side matches (termwise) the pushforward of the class
$i^*\alpha$ on $D$ from Definition \ref{definition-gysin-homomorphism}.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-closed-in-X-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X' \to X$ be a proper morphism of schemes
locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
Form the diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
as in Remark \ref{remark-pullback-pairs}.
For any $(k + 1)$-cycle $\alpha'$ on $X'$ we have
$i^*f_*\alpha' = g_*(i')^*\alpha'$ in $A_k(D)$
(this makes sense as $f_*$ is defined on the level of cycles).
\end{lemma}

\begin{proof}
Suppose $\alpha = [W']$ for some integral closed subscheme
$W' \subset X'$. Let $W = f(W') \subset X$. In case $W' \not \subset D'$,
then $W \not \subset D$ and we see that
$$
[W' \cap D']_k = \text{div}_{\mathcal{L}'|_{W'}}({s'|_{W'}})
\quad\text{and}\quad
[W \cap D]_k = \text{div}_{\mathcal{L}|_W}(s|_W)
$$
and hence $f_*$ of the first cycle equals the second cycle by
Lemma \ref{lemma-equal-c1-as-cycles}. Hence the
equality holds as cycles. In case $W' \subset D'$, then
$W \subset D$ and $f_*(c_1(\mathcal{L}|_{W'}) \cap [W'])$
is equal to $c_1(\mathcal{L}|_W) \cap [W]$ in $A_k(W)$ by the second
assertion of Lemma \ref{lemma-equal-c1-as-cycles}.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha'$.
\end{proof}

\begin{lemma}
\label{lemma-gysin-flat-pullback}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $f : X' \to X$
be a flat morphism of relative dimension $r$ of schemes locally of finite type
over $S$. Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}. Form the diagram
$$
\xymatrix{
D' \ar[d]_g \ar[r]_{i'} & X' \ar[d]^f \\
D \ar[r]^i & X
}
$$
as in Remark \ref{remark-pullback-pairs}.
For any $(k + 1)$-cycle $\alpha$ on $X$ we have
$(i')^*f^*\alpha = g^*i^*\alpha'$ in $A_{k + r}(D)$
(this makes sense as $f^*$ is defined on the level of cycles).
\end{lemma}

\begin{proof}
Suppose $\alpha = [W]$ for some integral closed subscheme
$W \subset X$. Let $W' = f^{-1}(W) \subset X'$. In case $W \not \subset D$,
then $W' \not \subset D'$ and we see that
$$
W' \cap D' = g^{-1}(W \cap D)
$$
as closed subschemes of $D'$. Hence the
equality holds as cycles, see Lemma \ref{lemma-pullback-coherent}.
In case $W \subset D$, then $W' \subset D'$ and $W' = g^{-1}(W)$
with $[W']_{k + 1 + r} = g^*[W]$ and equality holds in
$A_{k + r}(D')$ by Lemma \ref{lemma-flat-pullback-cap-c1}.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha'$.
\end{proof}

\begin{lemma}
\label{lemma-easy-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme such
that $\dim_\delta(Z) \leq k + 1$ and such that
$D \cap Z$ is an effective Cartier divisor on $Z$. Then
$i^*[Z]_{k + 1} = [D \cap Z]_k$.
\item Let $\mathcal{F}$ be a coherent sheaf on $X$
such that $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$ and
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective. Then
$$
i^*[\mathcal{F}]_{k + 1} = [i^*\mathcal{F}]_k
$$
in $A_k(D)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $Z \subset X$ as in (1). Then set $\mathcal{F} = \mathcal{O}_Z$.
The assumption that $D \cap Z$ is an effective Cartier divisor is
equivalent to the assumption that
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective. Moreover $[Z]_{k + 1} = [\mathcal{F}]_{k + 1}]$
and $[D \cap Z]_k = [\mathcal{O}_{D \cap Z}]_k = [i^*\mathcal{F}]_k$.
See Lemma \ref{lemma-cycle-closed-coherent}.
Hence part (1) follows from part (2).

\medskip\noindent
Write $[\mathcal{F}]_{k + 1} = \sum m_j[W_j]$ with $m_j > 0$
and pairwise distinct integral closed subschemes $W_j \subset X$
of $\delta$-dimension $k + 1$. The assumption that
$s : \mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}$
is injective implies that $W_j \not \subset D$ for all $j$.
By definition we see that
$$
i^*[\mathcal{F}]_{k + 1} = \sum [D \cap W_j]_k.
$$
We claim that
$$
\sum [D \cap W_j]_k = [i^*\mathcal{F}]_k
$$
as cycles.
Let $Z \subset D$ be an integral closed subscheme of $\delta$-dimension
$k$. Let $\xi \in Z$ be its generic point. Let $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$. Let $f \in A$ be an element generating the
ideal of $D$, i.e., such that $\mathcal{O}_{D, \xi} = A/fA$.
By assumption $\dim(\text{Supp}(M)) = 1$,
the map $f : M \to M$ is injective, and
$\text{length}_A(M/fM) < \infty$. Moreover, $\text{length}_A(M/fM)$
is the coefficient of $[Z]$ in $[i^*\mathcal{F}]_k$. On the
other hand, let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes in the support of $M$. Then
$$
\sum
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(f)
$$
is the coefficient of $[Z]$ in $\sum [D \cap W_j]_k$.
Hence we see the equality by
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}








\section{Gysin homomorphisms}
\label{section-gysin}

\noindent
In this section we use the key formula to show the Gysin homomorphism
factor through rational equivalence.

\begin{lemma}
\label{lemma-gysin-factors-general}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $X$ be integral and $n = \dim_\delta(X)$.
Let $i : D \to X$ be an effective Cartier divisor.
Let $\mathcal{N}$ be an invertible $\mathcal{O}_X$-module
and let $t$ be a nonzero meromorphic section of $\mathcal{N}$.
Then $i^*\text{div}_\mathcal{N}(t) = c_1(\mathcal{N}) \cap [D]_{n - 1}$
in $A_{n - 2}(D)$.
\end{lemma}

\begin{proof}
Write $\text{div}_\mathcal{N}(t) = \sum \text{ord}_{Z_i, \mathcal{N}}(t)[Z_i]$
for some integral closed subschemes $Z_i \subset X$ of $\delta$-dimension
$n - 1$. We may assume that the family $\{Z_i\}$ is locally
finite, that $t \in \Gamma(U, \mathcal{N}|_U)$ is a generator
where $U = X \setminus \bigcup Z_i$, and that every irreducible component
of $D$ is one of the $Z_i$, see
Divisors, Lemmas \ref{divisors-lemma-components-locally-finite},
\ref{divisors-lemma-divisor-locally-finite}, and
\ref{divisors-lemma-divisor-meromorphic-locally-finite}.

\medskip\noindent
Set $\mathcal{L} = \mathcal{O}_X(D)$. Denote
$s \in \Gamma(X, \mathcal{O}_X(D)) = \Gamma(X, \mathcal{L})$
the canonical section. We will apply the discussion of
Section \ref{section-key} to our current situation.
For each $i$ let $\xi_i \in Z_i$ be its generic point. Let
$B_i = \mathcal{O}_{X, \xi_i}$. For each $i$ we pick generators
$s_i \in \mathcal{L}_{\xi_i}$ and $t_i \in \mathcal{N}_{\xi_i}$
over $B_i$ but we insist that we pick $s_i = s$ if $Z_i \not \subset D$.
Write $s = f_i s_i$ and $t = g_i t_i$ with $f_i, g_i \in B_i$.
Then $\text{ord}_{Z_i, \mathcal{N}}(t) = \text{ord}_{B_i}(g_i)$.
On the other hand, we have $f_i \in B_i$ and
$$
[D]_{n - 1} = \sum \text{ord}_{B_i}(f_i)[Z_i]
$$
because of our choices of $s_i$. We claim that
$$
i^*\text{div}_\mathcal{N}(t) =
\sum \text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i})
$$
as cycles. More precisely, the right hand side is a cycle
representing the left hand side. Namely, this is clear by our
formula for $\text{div}_\mathcal{N}(t)$ and the fact that
$\text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) = [Z(s_i|_{Z_i})]_{n - 2} =
[Z_i \cap D]_{n - 2}$ when $Z_i \not \subset D$ because in
that case $s_i|_{Z_i} = s|_{Z_i}$ is a regular section, see
Lemma \ref{lemma-compute-c1}. Similarly,
$$
c_1(\mathcal{N}) \cap [D]_{n - 1} =
\sum \text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i})
$$
The key formula (Lemma \ref{lemma-key-formula}) gives the equality
$$
\sum \left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{N}|_{Z_i}}(t_i|_{Z_i}) -
\text{ord}_{B_i}(g_i) \text{div}_{\mathcal{L}|_{Z_i}}(s_i|_{Z_i}) \right) =
\sum \text{div}_{Z_i}(\partial_{B_i}(f_i, g_i))
$$
of cycles. If $Z_i \not \subset D$, then $f_i = 1$ and hence
$\text{div}_{Z_i}(\partial_{B_i}(f_i, g_i)) = 0$. Thus we get a rational
equivalence between our specific cycles representing
$i^*\text{div}_\mathcal{N}(t)$ and $c_1(\mathcal{N}) \cap [D]_{n - 1}$
on $D$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-gysin-factors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
The Gysin homomorphism factors through rational equivalence to
give a map $i^* : A_{k + 1}(X) \to A_k(D)$.
\end{lemma}

\begin{proof}
Let $\alpha \in Z_{k + 1}(X)$ and assume that $\alpha \sim_{rat} 0$.
This means there exists a locally finite collection of integral
closed subschemes $W_j \subset X$ of $\delta$-dimension $k + 2$
and $f_j \in R(W_j)^*$ such that
$\alpha = \sum i_{j, *}\text{div}_{W_j}(f_j)$.
Set $X' = \coprod W_i$ and consider the diagram
$$
\xymatrix{
D' \ar[d]_q \ar[r]_{i'} & X' \ar[d]^p \\
D \ar[r]^i & X
}
$$
of Remark \ref{remark-pullback-pairs}. Since $X' \to X$ is proper
we see that $i^*p_* = q_*(i')^*$ by Lemma \ref{lemma-closed-in-X-gysin}.
As we know that $q_*$ factors through rational equivalence
(Lemma \ref{lemma-proper-pushforward-rational-equivalence}), it suffices
to prove the result for $\alpha' = \sum \text{div}_{W_j}(f_j)$
on $X'$. Clearly this reduces us to the case where $X$ is integral
and $\alpha = \text{div}(f)$ for some $f \in R(X)^*$.

\medskip\noindent
Assume $X$ is integral and $\alpha = \text{div}(f)$ for some $f \in R(X)^*$.
If $X = D$, then we see that $i^*\alpha$ is equal
to $c_1(\mathcal{L}) \cap \alpha$.
This is rationally equivalent to zero by Lemma \ref{lemma-factors}.
If $D \not = X$, then we see that $i^*\text{div}_X(f)$ is equal to
$c_1(\mathcal{O}_D) \cap [D]_{n - 1}$ in $A_k(D)$ by
Lemma \ref{lemma-gysin-factors-general}. Of course
capping with $c_1(\mathcal{O}_D)$ is the zero map.
\end{proof}

\begin{lemma}
\label{lemma-gysin-commutes-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be
locally of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$
be a triple as in Definition \ref{definition-gysin-homomorphism}.
Let $\mathcal{N}$ be an invertible $\mathcal{O}_X$-module.
Then $i^*(c_1(\mathcal{N}) \cap \alpha) = c_1(i^*\mathcal{N}) \cap i^*\alpha$
in $A_{k - 2}(D)$ for all $\alpha \in A_k(Z)$.
\end{lemma}

\begin{proof}
With exactly the same proof as in Lemma \ref{lemma-gysin-factors}
this follows from Lemmas
\ref{lemma-pushforward-cap-c1},
\ref{lemma-cap-commutative}, and
\ref{lemma-gysin-factors-general}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-commutes-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $(\mathcal{L}, s, i : D \to X)$ and
$(\mathcal{L}', s', i' : D' \to X)$ be two triples as in
Definition \ref{definition-gysin-homomorphism}. Then the diagram
$$
\xymatrix{
A_k(X) \ar[r]_{i^*} \ar[d]_{(i')^*} & A_{k - 1}(D) \ar[d] \\
A_{k - 1}(D') \ar[r] & A_{k - 2}(D \cap D')
}
$$
commutes where each of the maps is a gysin map.
\end{lemma}

\begin{proof}
Denote $j : D \cap D' \to D$ and $j' : D \cap D' \to D'$ the closed
immersions corresponding to $(\mathcal{L}|_{D'}, s|_{D'}$ and
$(\mathcal{L}'_D, s|_D)$. We have to show that
$(j')^*i^*\alpha = j^* (i')^*\alpha$ for all $\alpha \in A_k(X)$.
Let $W \subset X$ be an integral closed subscheme of dimension $k$.
Let us prove the equality in case $\alpha = [W]$. We will deduce
it from the key formula.

\medskip\noindent
We let $\sigma$ be a nonzero meromorphic section of $\mathcal{L}|_W$
which we require to be equal to $s|_W$ if $W \not \subset D$.
We let $\sigma'$ be a nonzero meromorphic section of $\mathcal{L}'|_W$
which we require to be equal to $s'|_W$ if $W \not \subset D'$.
Write
$$
\text{div}_{\mathcal{L}|_W}(\sigma) =
\sum \text{ord}_{Z_i, \mathcal{L}|_W}(\sigma)[Z_i] = \sum n_i[Z_i]
$$
and similarly
$$
\text{div}_{\mathcal{L}'|_W}(\sigma') =
\sum \text{ord}_{Z_i, \mathcal{L}'|_W}(\sigma')[Z_i] = \sum n'_i[Z_i]
$$
as in the discussion in Section \ref{section-key}.
Then we see that $Z_i \subset D$ if $n_i \not = 0$ and
$Z'_i \subset D'$ if $n'_i \not = 0$. For each $i$, let $\xi_i \in Z_i$
be the generic point. As in Section \ref{section-key} we choose
for each $i$ an element
$\sigma_i \in \mathcal{L}_{\xi_i}$, resp.\ $\sigma'_i \in \mathcal{L}'_{\xi_i}$
which generates over $B_i = \mathcal{O}_{W, \xi_i}$
and which is equal to the image of
$s$, resp.\ $s'$ if $Z_i \not \subset D$, resp.\ $Z_i \not \subset D'$.
Write $\sigma = f_i \sigma_i$ and $\sigma' = f'_i\sigma'_i$ so that
$n_i = \text{ord}_{B_i}(f_i)$ and
$n'_i = \text{ord}_{B_i}(f'_i)$.
From our definitions it follows that
$$
(j')^*i^*[W] =
\sum \text{ord}_{B_i}(f_i) \text{div}_{\mathcal{L}'|_{Z_i}}(\sigma'_i|_{Z_i})
$$
as cycles and
$$
j^*(i')^*[W] =
\sum \text{ord}_{B_i}(f'_i) \text{div}_{\mathcal{L}|_{Z_i}}(\sigma_i|_{Z_i})
$$
The key formula (Lemma \ref{lemma-key-formula}) now gives the equality
$$
\sum \left(
\text{ord}_{B_i}(f_i) \text{div}_{\mathcal{L}'|_{Z_i}}(\sigma'_i|_{Z_i}) -
\text{ord}_{B_i}(f'_i) \text{div}_{\mathcal{L}|_{Z_i}}(\sigma_i|_{Z_i})
\right) =
\sum \text{div}_{Z_i}(\partial_{B_i}(f_i, f'_i))
$$
of cycles. Note that $\text{div}_{Z_i}(\partial_{B_i}(f_i, f'_i)) = 0$ if
$Z_i \not \subset D \cap D'$ because in this case either $f_i = 1$
or $f'_i = 1$. Thus we get a rational equivalence between our specific
cycles representing $(j')^*i^*[W]$ and $j^*(i')^*[W]$ on $D \cap D' \cap W$.
By Remark \ref{remark-infinite-sums-rational-equivalences}
the result follows for general $\alpha$.
\end{proof}







\section{Relative effective Cartier divisors}
\label{section-relative-effective-cartier}

\noindent
Relative effective Cartier divisors are defined and studied
in Divisors, Section \ref{divisors-section-effective-Cartier-morphisms}.
To develop the basic results on chern classes of vector bundles
we only need the case where both the ambient scheme and the effective
Cartier divisor are flat over the base.

\begin{lemma}
\label{lemma-relative-effective-cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a flat morphism of relative dimension $r$.
Let $i : D \to X$ be a relative effective Cartier divisor
(Divisors, Definition
\ref{divisors-definition-relative-effective-Cartier-divisor}).
Let $\mathcal{L} = \mathcal{O}_X(D)$.
For any $\alpha \in A_{k + 1}(Y)$ we have
$$
i^*p^*\alpha = (p|_D)^*\alpha
$$
in $A_{k + r}(D)$ and
$$
c_1(\mathcal{L}) \cap p^*\alpha = i_* ((p|_D)^*\alpha)
$$
in $A_{k + r}(X)$.
\end{lemma}

\begin{proof}
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension
$k + 1$. By Divisors, Lemma \ref{divisors-lemma-relative-Cartier}
we see that $D \cap p^{-1}W$ is an effective
Cartier divisor on $p^{-1}W$. By Lemma \ref{lemma-easy-gysin}
we get the first equality in
$$
i^*[p^{-1}W]_{k + r + 1} =
[D \cap p^{-1}W]_{k + r} =
[(p|_D)^{-1}(W)]_{k + r}.
$$
and the second because $D \cap p^{-1}(W) = (p|_D)^{-1}(W)$ as schemes.
Since by definition $p^*[W] = [p^{-1}W]_{k + r + 1}$ we see that
$i^*p^*[W] = (p|_D)^*[W]$ as cycles. If $\alpha = \sum m_j[W_j]$ is a
general $k + 1$ cycle, then we get
$i^*\alpha = \sum m_j i^*p^*[W_j] = \sum m_j(p|_D)^*[W_j]$ as cycles.
This proves then first equality. To deduce the second from the
first apply Lemma \ref{lemma-support-cap-effective-Cartier}.
\end{proof}








\section{Affine bundles}
\label{section-affine-vector}

\noindent
For an affine bundle the pullback map is surjective on Chow groups.

\begin{lemma}
\label{lemma-pullback-affine-fibres-surjective}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Assume that for every $y \in Y$, there exists an open neighbourhood
$U \subset Y$ such that $f|_{f^{-1}(U)} : f^{-1}(U) \to U$
is identified with the morphism $U \times \mathbf{A}^r \to U$.
Then $f^* : A_k(Y) \to A_{k + r}(X)$ is surjective for all
$k \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Let $\alpha \in A_{k + r}(X)$.
Write $\alpha = \sum m_j[W_j]$ with $m_j \not = 0$ and
$W_j$ pairwise distinct integral closed subschemes of
$\delta$-dimension $k + r$. Then the family $\{W_j\}$
is locally finite in $X$. For any quasi-compact open
$V \subset Y$ we see that $f^{-1}(V) \cap W_j$
is nonempty only for finitely many $j$. Hence the
collection $Z_j = \overline{f(W_j)}$ of closures
of images is a locally finite collection of integral
closed subschemes of $Y$.

\medskip\noindent
Consider the fibre product diagrams
$$
\xymatrix{
f^{-1}(Z_j) \ar[r] \ar[d]_{f_j} & X \ar[d]^f \\
Z_j \ar[r] & Y
}
$$
Suppose that $[W_j] \in Z_{k + r}(f^{-1}(Z_j))$
is rationally equivalent to $f_j^*\beta_j$ for some
$k$-cycle $\beta_j \in A_k(Z_j)$. Then
$\beta = \sum m_j \beta_j$ will be a $k$-cycle on $Y$
and $f^*\beta = \sum m_j f_j^*\beta_j$ will be rationally
equivalent to $\alpha$ (see
Remark \ref{remark-infinite-sums-rational-equivalences}).
This reduces us to the case $Y$ integral, and
$\alpha = [W]$ for some integral closed subscheme
of $X$ dominating $Y$. In particular we may
assume that $d = \dim_\delta(Y) < \infty$.

\medskip\noindent
Hence we can use induction on $d = \dim_\delta(Y)$.
If $d < k$, then $A_{k + r}(X) = 0$ and the lemma holds.
By assumption there exists a dense open $V \subset Y$ such
that $f^{-1}(V) \cong V \times \mathbf{A}^r$ as schemes over $V$.
Suppose that we can show that $\alpha|_{f^{-1}(V)} = f^*\beta$
for some $\beta \in Z_k(V)$. By Lemma \ref{lemma-exact-sequence-open}
we see that
$\beta = \beta'|_V$ for some $\beta' \in Z_k(Y)$.
By the exact sequence
$A_k(f^{-1}(Y \setminus V)) \to A_k(X) \to A_k(f^{-1}(V))$
of Lemma \ref{lemma-restrict-to-open}
we see that $\alpha - f^*\beta'$ comes from
a cycle $\alpha' \in A_{k + r}(f^{-1}(Y \setminus V))$.
Since $\dim_\delta(Y \setminus V) < d$ we win by
induction on $d$.

\medskip\noindent
Thus we may assume that $X = Y \times \mathbf{A}^r$.
In this case we can factor $f$ as
$$
X = Y \times \mathbf{A}^r \to
Y \times \mathbf{A}^{r - 1} \to \ldots \to
Y \times \mathbf{A}^1 \to Y.
$$
Hence it suffices to do the case $r = 1$. By the argument in the
second paragraph of the proof we are reduced to the case
$\alpha = [W]$, $Y$ integral, and $W \to Y$ dominant.
Again we can do induction on $d = \dim_\delta(Y)$.
If $W = Y \times \mathbf{A}^1$, then $[W] = f^*[Y]$.
Lastly, $W \subset Y \times \mathbf{A}^1$ is a proper inclusion,
then $W \to Y$ induces a finite field extension $R(Y) \subset R(W)$.
Let $P(T) \in R(Y)[T]$ be the monic irreducible polynomial such
that the generic fibre of $W \to Y$ is cut out by $P$ in
$\mathbf{A}^1_{R(Y)}$. Let $V \subset Y$ be a nonempty open such
that $P \in \Gamma(V, \mathcal{O}_Y)[T]$, and such that
$W \cap f^{-1}(V)$ is still cut out by $P$. Then we see that
$\alpha|_{f^{-1}(V)} \sim_{rat} 0$ and hence $\alpha \sim_{rat} \alpha'$
for some cycle $\alpha'$ on $(Y \setminus V) \times \mathbf{A}^1$.
By induction on the dimension we win.
\end{proof}

\begin{lemma}
\label{lemma-linebundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let
$$
p :
L = \underline{\Spec}(\text{Sym}^*(\mathcal{L}))
\longrightarrow
X
$$
be the associated vector bundle over $X$.
Then $p^* : A_k(X) \to A_{k + 1}(L)$ is an isomorphism for all $k$.
\end{lemma}

\begin{proof}
For surjectivity see Lemma \ref{lemma-pullback-affine-fibres-surjective}.
Let $o : X \to L$ be the zero section of $L \to X$, i.e., the morphism
corresponding to the surjection $\text{Sym}^*(\mathcal{L}) \to \mathcal{O}_X$
which maps $\mathcal{L}^{\otimes n}$ to zero for all $n > 0$.
Then $p \circ o = \text{id}_X$ and $o(X)$ is an effective
Cartier divisor on $L$. Hence by Lemma \ref{lemma-relative-effective-cartier}
we see that $o^* \circ p^* = \text{id}$ and we conclude that $p^*$ is
injective too.
\end{proof}

\begin{remark}
\label{remark-when-isomorphism}
We will see later (Lemma \ref{lemma-vectorbundle}) that if $X$ is a
vector bundle of rank $r$ over $Y$ then the pullback map
$A_k(Y) \to A_{k + r}(X)$
is an isomorphism. This is true whenever $X \to Y$ satisfies
the assumptions of Lemma \ref{lemma-pullback-affine-fibres-surjective}, see
\cite[Lemma 2.2]{Totaro-group}.
\end{remark}







\section{Bivariant intersection theory}
\label{section-bivariant}

\noindent
In order to intelligently talk about higher chern classes of vector
bundles we introduce the following notion, following \cite{FM}.
It follows from \cite[Theorem 17.1]{F} that our definition agrees
with that of \cite{F} modulo the caveat that we are working in different
settings.

\begin{definition}
\label{definition-bivariant-class}
\begin{reference}
Similar to \cite[Definition 17.1]{F}
\end{reference}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $p \in \mathbf{Z}$.
A {\it bivariant class $c$ of degree $p$ for $f$} is given by a rule
which assigns to every locally of finite type morphism $Y' \to Y$
and every $k$ a map
$$
c \cap - : A_k(Y') \longrightarrow A_{k - p}(X')
$$
where $X' = Y' \times_Y X$, satisfying the following conditions
\begin{enumerate}
\item if $Y'' \to Y'$ is a proper, then
$c \cap (Y'' \to Y')_*\alpha'' = (X'' \to X')_*(c \cap \alpha'')$
for all $\alpha''$ on $Y''$ where $X'' = Y'' \times_Y X$,
\item if $Y'' \to Y'$ is flat locally of finite type of
fixed relative dimension, then
$c \cap (Y'' \to Y')^*\alpha' = (X'' \to X')^*(c \cap \alpha')$
for all $\alpha'$ on $Y'$, and
\item if $(\mathcal{L}', s', i' : D' \to Y')$ is as in
Definition \ref{definition-gysin-homomorphism}
with pullback $(\mathcal{N}', t', j' : E' \to X')$ to $X'$,
then we have $c \cap (i')^*\alpha' = (j')^*(c \cap \alpha')$
for all $\alpha'$ on $Y'$.
\end{enumerate}
The collection of all bivariant classes of degree $p$ for $f$ is
denoted $A^p(X \to Y)$.
\end{definition}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X \to Y$
and $Y \to Z$
be morphisms of schemes locally of finite type over $S$. Let
$p \in \mathbf{Z}$. It is clear that $A^p(X \to Y)$ is an abelian group.
Moreover, it is clear that we have a bilinear composition
$$
A^p(X \to Y) \times A^q(Y \to Z) \to A^{p + q}(X \to Z)
$$
which is associative.
We will be most interested in $A^p(X) = A^p(X \to X)$, which will always mean
the bivariant cohomology classes for $\text{id}_X$. Namely, that is where
chern classes will live.

\begin{definition}
\label{definition-chow-cohomology}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. The {\it Chow cohomology}
of $X$ is the graded $\mathbf{Z}$-algebra $A^*(X)$ whose degree
$p$ component is $A^p(X \to X)$.
\end{definition}

\noindent
Warning: It is not clear that the $\mathbf{Z}$-algebra structure
on $A^*(X)$ is commutative, but we will see that chern classes live
in its center.

\begin{remark}
\label{remark-pullback-cohomology}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Then there is a canonical $\mathbf{Z}$-algebra map $A^*(Y) \to A^*(X)$.
Namely, given $c \in A^p(Y)$ and $X' \to X$, then we can let $f^*c$
be defined by the map $c \cap - : A_k(X') \to A_{k - p}(X')$ which is
given by thinking of $X'$ as a scheme over $Y$.
\end{remark}

\begin{lemma}
\label{lemma-cap-c1-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Then the rule that to $f : X' \to X$ assignes
$c_1(f^*\mathcal{L}) \cap - : A_k(X') \to A_{k - 1}(X')$
is a bivariant class of degree $1$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-factors},
\ref{lemma-pushforward-cap-c1},
\ref{lemma-flat-pullback-cap-c1}, and
\ref{lemma-gysin-commutes-cap-c1}.
\end{proof}

\noindent
Having said this we see that we can define $c_1(\mathcal{L})$ as the element
of $A^1(X)$ constructed in Lemma \ref{lemma-cap-c1-bivariant}.
We will return to this in Section \ref{section-relations-chern-classes}.

\begin{lemma}
\label{lemma-flat-pullback-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$
between schemes locally of finite type over $S$.
Then the rule that to $Y' \to Y$ assignes
$(f')^* : A_k(Y') \to A_{k + r}(X')$ where $X' = X \times_Y Y'$
is a bivariant class of degree $-r$.
\end{lemma}

\begin{proof}
This follows from
Lemmas \ref{lemma-flat-pullback-rational-equivalence},
\ref{lemma-compose-flat-pullback},
\ref{lemma-flat-pullback-proper-pushforward}, and
\ref{lemma-gysin-flat-pullback}.
\end{proof}

\begin{lemma}
\label{lemma-gysin-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $(\mathcal{L}, s, i : D \to X)$ be a triple as in
Definition \ref{definition-gysin-homomorphism}.
Then the rule that to $f : X' \to X$ assignes
$(i')^* : A_k(X') \to A_{k - 1}(D')$ where $D' = D \times_X X'$
is a bivariant class of degree $1$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-gysin-factors},
\ref{lemma-closed-in-X-gysin},
\ref{lemma-gysin-flat-pullback}, and
\ref{lemma-gysin-commutes-gysin}.
\end{proof}

\begin{lemma}
\label{lemma-push-proper-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of
schemes locally of finite type over $S$.
Let $c \in A^p(X \to Z)$ and assume $f$ is proper.
Then the rule that to $Z' \to Z$ assignes
$\alpha \longmapsto f'_*(c \cap \alpha)$
is a bivariant class of degree $p$.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-compose-pushforward},
\ref{lemma-flat-pullback-proper-pushforward}, and
\ref{lemma-closed-in-X-gysin}.
\end{proof}


\noindent
Here is a criterion to see that an operation
passes through rational equivalence.

\begin{lemma}
\label{lemma-factors-through-rational-equivalence}
\begin{reference}
Very weak form of \cite[Theorem 17.1]{F}
\end{reference}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $p \in \mathbf{Z}$. Suppose given a rule
which assigns to every locally of finite type morphism $Y' \to Y$
and every $k$ a map
$$
c \cap - : Z_k(Y') \longrightarrow A_{k - p}(X')
$$
where $Y' = X' \times_X Y$, satisfying condition (3) of
Definition \ref{definition-bivariant-class}
whenever $\mathcal{L}'|_{D'} \cong \mathcal{O}_{D'}$. Then
$c \cap -$ factors through rational equivalence.
\end{lemma}

\begin{proof}
The statement makes sense because given a triple
$(\mathcal{L}, s, i : D \to X)$ as in
Definition \ref{definition-gysin-homomorphism}
such that $\mathcal{L}|_D \cong \mathcal{O}_D$, then
the operation $i^*$ is defined on the level of cycles, see
Remark \ref{remark-on-cycles}.
Let $\alpha \in Z_k(X')$ be a cycle which is rationally equivalent to zero.
We have to show that $c \cap \alpha = 0$. By
Lemma \ref{lemma-rational-equivalence-family}
there exists a cycle $\beta \in Z_{k + 1}(X' \times \mathbf{P}^1)$
such that $\alpha = i_0^*\beta - i_\infty^*\beta$
where $i_0, i_\infty : X' \to X' \times \mathbf{P}^1$ are the
closed immersions of $X'$ over $0, \infty$. Since these are
examples of effective Cartier divisors with trivial normal
bundles, we see that $c \cap i_0^*\beta = j_0^*(c \cap \beta)$
and $c \cap i_\infty^*\beta = j_\infty^*(c \cap \beta)$
where $j_0, j_\infty : Y' \to Y' \times \mathbf{P}^1$ are
closed immersions as before. Since
$j_0^*(c \cap \beta) \sim_{rat} j_\infty^*(c \cap \beta)$
(follows from Lemma \ref{lemma-rational-equivalence-family}) we conclude.
\end{proof}

\noindent
Here we see that $c_1(\mathcal{L})$ is in the center of $A^*(X)$.

\begin{lemma}
\label{lemma-c1-center}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Then $c_1(\mathcal{L}) \in A^1(X)$ commutes with every
element $c \in A^p(X)$.
\end{lemma}

\begin{proof}
Let $p : L \to X$ be as in Lemma \ref{lemma-linebundle} and let $o : X \to L$
be the zero section. Observe that $p^*\mathcal{L}^{\otimes -1}$ has a
canonical section whose zero scheme is exactly the effective Cartier divisor
$o(X)$. Let $\alpha \in A_k(X)$. Then we see that
$$
p^*(c_1(\mathcal{L}^{\otimes -1}) \cap \alpha) =
c_1(p^*\mathcal{L}^{\otimes -1}) \cap p^*\alpha =
o_* o^* p^*\alpha
$$
by Lemmas \ref{lemma-flat-pullback-cap-c1} and
\ref{lemma-relative-effective-cartier}.
Since $c$ is a bivariant class we have
\begin{align*}
p^*(c \cap c_1(\mathcal{L}^{\otimes -1}) \cap \alpha)
& =
c \cap p^*(c_1(\mathcal{L}^{\otimes -1}) \cap \alpha) \\
& =
c \cap o_* o^* p^*\alpha \\
& =
o_* o^* p^*(c \cap \alpha) \\
& =
p^*(c_1(\mathcal{L}^{\otimes -1}) \cap c \cap \alpha)
\end{align*}
(last equality by the above applied to $c \cap \alpha$).
Since $p^*$ is injective by a lemma cited above we get that
$c_1(\mathcal{L}^{\otimes -1})$
is in the center of $A^*(X)$. This proves the lemma.
\end{proof}

\noindent
Here a criterion for when a bivariant class is zero.

\begin{lemma}
\label{lemma-bivariant-zero}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $f : X \to Y$ be a morphism of schemes locally of finite type over $S$.
Let $c \in A^p(X \to Y)$. For $Y'' \to Y' \to Y$ set
$X'' = Y'' \times_Y X$ and $X' = Y' \times_Y X$.
The following are equivalent
\begin{enumerate}
\item $c$ is zero,
\item $c \cap [Y'] = 0$ in $A_*(X')$ for every integral scheme $Y'$
locally of finite type over $Y$, and
\item for every integral scheme $Y'$ locally of finite type over $Y$,
there exists a proper birational morphism $Y'' \to Y'$ such that
$c \cap [Y''] = 0$ in $A_*(X'')$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (1) $\Rightarrow$ (2) $\Rightarrow$ (3) are clear.
Assumption (3) imlpies (2) because $(Y'' \to Y')_*[Y''] = [Y']$
and hence $c \cap [Y'] = (X'' \to X')_*(c \cap [Y''])$ as $c$
is a bivariant class. Assume (2).
Let $Y' \to Y$ be locally of finite type. Let $\alpha \in A_k(Y')$.
Write $\alpha = \sum n_i [Y'_i]$ with $Y'_i \subset Y'$ a locally finite
collection of integral closed subschemes of $\delta$-dimension $k$.
Then we see that $\alpha$ is pushforward of the cycle
$\alpha' = \sum n_i[Y'_i]$ on $Y'' = \coprod Y'_i$ under the
proper morphism $Y'' \to Y'$. By the properties of bivariant
classes it suffices to prove that $c \cap \alpha' = 0$ in $A_{k - p}(X'')$.
We have $A_{k - p}(X'') = \prod A_{k - p}(X'_i)$ where
$X'_i = Y'_i \times_Y X$. This follows immediately
from the definitions. The projection maps
$A_{k - p}(X'') \to A_{k - p}(X'_i)$ are given by flat pullback.
Since capping with $c$ commutes with
flat pullback, we see that it suffices to show that $c \cap [Y'_i]$
is zero in $A_{k - p}(X'_i)$ which is true by assumption.
\end{proof}





\section{Projective space bundle formula}
\label{section-projective-space-bundle-formula}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Consider a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$.
Our convention is that the {\it projective bundle associated to
$\mathcal{E}$} is the morphism
$$
\xymatrix{
\mathbf{P}(\mathcal{E}) =
\underline{\text{Proj}}_X(\text{Sym}^*(\mathcal{E}))
\ar[r]^-\pi
& X
}
$$
over $X$ with
$\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$ normalized so that
$\pi_*(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)) = \mathcal{E}$.
In particular there is a surjection
$\pi^*\mathcal{E} \to \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
We will say informally ``let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$'' to denote
the situation where $P = \mathbf{P}(\mathcal{E})$ and
$\mathcal{O}_P(1) = \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.

\begin{lemma}
\label{lemma-cap-projective-bundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
For any $\alpha \in A_k(X)$ the element
$$
\pi_*\left(
c_1(\mathcal{O}_P(1))^s \cap \pi^*\alpha
\right)
\in
A_{k + r - 1 - s}(X)
$$
is $0$ if $s < r - 1$ and is equal to $\alpha$ when $s = r - 1$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
Note that $\pi^*[Z] = [\pi^{-1}(Z)]$ as $\pi^{-1}(Z)$ is integral of
$\delta$-dimension $r - 1$.
If $s < r - 1$, then by construction
$c_1(\mathcal{O}_P(1))^s \cap \pi^*[Z]$
is represented by a $(k + r - 1 - s)$-cycle supported on
$\pi^{-1}(Z)$. Hence the pushforward of this cycle
is zero for dimension reasons.

\medskip\noindent
Let $s = r - 1$. By the argument given above we see that
$\pi_*(c_1(\mathcal{O}_P(1))^s \cap \pi^*\alpha) = n [Z]$
for some $n \in \mathbf{Z}$. We want to show that $n = 1$.
For the same dimension reasons
as above it suffices to prove this result after replacing $X$ by
$X \setminus T$ where $T \subset Z$ is a proper closed subset.
Let $\xi$ be the generic point of $Z$.
We can choose elements $e_1, \ldots, e_{r - 1} \in \mathcal{E}_\xi$
which form part of a basis of $\mathcal{E}_\xi$.
These give rational sections $s_1, \ldots, s_{r - 1}$
of $\mathcal{O}_P(1)|_{\pi^{-1}(Z)}$ whose common zero set
is the closure of the image a rational section of
$\mathbf{P}(\mathcal{E}|_Z) \to Z$ union a closed subset whose
support maps to a proper closed subset $T$ of $Z$.
After removing $T$ from $X$ (and correspondingly $\pi^{-1}(T)$
from $P$), we see that $s_1, \ldots, s_n$ form a sequence
of global sections
$s_i \in \Gamma(\pi^{-1}(Z), \mathcal{O}_{\pi^{-1}(Z)}(1))$
whose common zero set is the image of a section $Z \to \pi^{-1}(Z)$.
Hence we see successively that
\begin{eqnarray*}
\pi^*[Z] & = & [\pi^{-1}(Z)] \\
c_1(\mathcal{O}_P(1)) \cap \pi^*[Z] & = & [Z(s_1)] \\
c_1(\mathcal{O}_P(1))^2 \cap \pi^*[Z] & = & [Z(s_1) \cap Z(s_2)] \\
\ldots & = & \ldots \\
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*[Z] & = &
[Z(s_1) \cap \ldots \cap Z(s_{r - 1})]
\end{eqnarray*}
by repeated applications of Lemma \ref{lemma-geometric-cap}.
Since the pushforward by $\pi$ of the image of a
section of $\pi$ over $Z$ is clearly $[Z]$ we see the result
when $\alpha = [Z]$. We omit the verification that these
arguments imply the result for a general cycle $\alpha = \sum n_j [Z_j]$.
\end{proof}

\begin{lemma}[Projective space bundle formula]
\label{lemma-chow-ring-projective-bundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
be the projective bundle associated to $\mathcal{E}$.
The map
$$
\bigoplus\nolimits_{i = 0}^{r - 1}
A_{k + i}(X)
\longrightarrow
A_{k + r - 1}(P),
$$
$$
(\alpha_0, \ldots, \alpha_{r-1})
\longmapsto
\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*\alpha_{r-1}
$$
is an isomorphism.
\end{lemma}

\begin{proof}
Fix $k \in \mathbf{Z}$. We first show the map is injective.
Suppose that $(\alpha_0, \ldots, \alpha_{r - 1})$ is an element
of the left hand side that maps to zero.
By Lemma \ref{lemma-cap-projective-bundle} we see that
$$
0 = \pi_*(\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 1} \cap \pi^*\alpha_{r-1})
= \alpha_{r - 1}
$$
Next, we see that
$$
0 = \pi_*(c_1(\mathcal{O}_P(1)) \cap (\pi^*\alpha_0 +
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1
+ \ldots +
c_1(\mathcal{O}_P(1))^{r - 2} \cap \pi^*\alpha_{r - 2}))
= \alpha_{r - 2}
$$
and so on. Hence the map is injective.

\medskip\noindent
It remains to show the map is surjective.
Let $X_i$, $i \in I$ be the irreducible components of $X$.
Then $P_i = \mathbf{P}(\mathcal{E}|_{X_i})$, $i \in I$
are the irreducible components of $P$. Consider the commutative
diagram
$$
\xymatrix{
\coprod P_i \ar[d]_{\coprod \pi_i} \ar[r]_p & P \ar[d]^\pi \\
\coprod X_i \ar[r]^q & X
}
$$
Observe that $p_*$ is surjective. If $\beta \in A_k(\coprod X_i)$
then $\pi^* q_* \beta = p_*(\coprod \pi_i)^* \beta$, see
Lemma \ref{lemma-flat-pullback-proper-pushforward}. Similarly for
capping with $c_1(\mathcal{O}(1))$ by
Lemma \ref{lemma-pushforward-cap-c1}.
Hence, if the map of the lemma is surjective for each
of the morphisms $\pi_i : P_i \to X_i$, then the map is
surjective for $\pi : P \to X$. Hence we may assume $X$ is irreducible.
Thus $\dim_\delta(X) < \infty$ and in particular we may use
induction on $\dim_\delta(X)$.

\medskip\noindent
The result is clear if $\dim_\delta(X) < k$.
Let $\alpha \in A_{k + r - 1}(P)$.
For any locally closed subscheme $T \subset X$ denote
$\gamma_T : \bigoplus A_{k + i}(T) \to A_{k + r - 1}(\pi^{-1}(T))$
the map
$$
\gamma_T(\alpha_0, \ldots, \alpha_{r - 1})
= \pi^*\alpha_0 + \ldots +
c_1(\mathcal{O}_{\pi^{-1}(T)}(1))^{r - 1} \cap \pi^*\alpha_{r - 1}.
$$
Suppose for some nonempty open $U \subset X$ we have
$\alpha|_{\pi^{-1}(U)} = \gamma_U(\alpha_0, \ldots, \alpha_{r - 1})$.
Then we may choose lifts $\alpha'_i \in A_{k + i}(X)$ and we
see that $\alpha - \gamma_X(\alpha'_0, \ldots, \alpha'_{r - 1})$
is by Lemma \ref{lemma-restrict-to-open}
rationally equivalent to a $k$-cycle on $P_Y = \mathbf{P}(\mathcal{E}|_Y)$
where $Y = X \setminus U$ as a reduced closed subscheme.
Note that $\dim_\delta(Y) < \dim_\delta(X)$.
By induction the result holds
for $P_Y \to Y$ and hence the result holds for $\alpha$.
Hence we may replace $X$ by any nonempty open of $X$.

\medskip\noindent
In particular we may assume that $\mathcal{E} \cong \mathcal{O}_X^{\oplus r}$.
In this case $\mathbf{P}(\mathcal{E}) = X \times \mathbf{P}^{r - 1}$.
Let us use the stratification
$$
\mathbf{P}^{r - 1} = \mathbf{A}^{r - 1}
\amalg \mathbf{A}^{r - 2}
\amalg \ldots
\amalg \mathbf{A}^0
$$
The closure of each stratum is a $\mathbf{P}^{r - 1 - i}$ which is a
representative of $c_1(\mathcal{O}(1))^i \cap [\mathbf{P}^{r - 1}]$.
Hence $P$ has a similar stratification
$$
P = U^{r - 1} \amalg U^{r - 2} \amalg \ldots \amalg U^0
$$
Let $P^i$ be the closure of $U^i$. Let $\pi^i : P^i \to X$
be the restriction of $\pi$ to $P^i$.
Let $\alpha \in A_{k + r - 1}(P)$. By
Lemma \ref{lemma-pullback-affine-fibres-surjective}
we can write $\alpha|_{U^{r - 1}} = \pi^*\alpha_0|_{U^{r - 1}}$
for some $\alpha_0 \in A_k(X)$. Hence the difference
$\alpha - \pi^*\alpha_0$ is the image of some
$\alpha' \in A_{k + r - 1}(P^{r - 2})$.
By Lemma \ref{lemma-pullback-affine-fibres-surjective}
again we can write
$\alpha'|_{U^{r - 2}} = (\pi^{r - 2})^*\alpha_1|_{U^{r - 2}}$
for some $\alpha_1 \in A_{k + 1}(X)$.
By Lemma \ref{lemma-relative-effective-cartier}
we see that the image of $(\pi^{r - 2})^*\alpha_1$
represents $c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1$.
We also see that
$\alpha - \pi^*\alpha_0 - c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha_1$
is the image of some $\alpha'' \in A_{k + r - 1}(P^{r - 3})$.
And so on.
\end{proof}

\begin{lemma}
\label{lemma-vectorbundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let
$$
p :
E = \underline{\Spec}(\text{Sym}^*(\mathcal{E}))
\longrightarrow
X
$$
be the associated vector bundle over $X$.
Then $p^* : A_k(X) \to A_{k + r}(E)$ is an isomorphism for all $k$.
\end{lemma}

\begin{proof}
(For the case of linebundles, see Lemma \ref{lemma-linebundle}.)
For surjectivity see Lemma \ref{lemma-pullback-affine-fibres-surjective}.
Let $(\pi  : P \to X, \mathcal{O}_P(1))$
be the projective space bundle associated
to the finite locally free sheaf $\mathcal{E} \oplus \mathcal{O}_X$.
Let $s \in \Gamma(P, \mathcal{O}_P(1))$ correspond to the global
section $(0, 1) \in \Gamma(X, \mathcal{E} \oplus \mathcal{O}_X)$.
Let $D = Z(s) \subset P$. Note that
$(\pi|_D : D \to X , \mathcal{O}_P(1)|_D)$
is the projective space bundle associated
to $\mathcal{E}$. We denote $\pi_D = \pi|_D$ and
$\mathcal{O}_D(1) = \mathcal{O}_P(1)|_D$.
Moreover, $D$ is an effective
Cartier divisor on $P$. Hence $\mathcal{O}_P(D) = \mathcal{O}_P(1)$
(see Divisors, Lemma \ref{divisors-lemma-characterize-OD}).
Also there is an isomorphism
$E \cong P \setminus D$. Denote $j : E \to P$ the
corresponding open immersion.
For injectivity we use that the kernel of
$$
j^* :
A_{k + r}(P)
\longrightarrow
A_{k + r}(E)
$$
are the cycles supported in the effective Cartier divisor $D$,
see Lemma \ref{lemma-restrict-to-open}. So if $p^*\alpha = 0$, then
$\pi^*\alpha = i_*\beta$ for some $\beta \in A_{k + r}(D)$.
By Lemma \ref{lemma-chow-ring-projective-bundle} we may write
$$
\beta = \pi_D^*\beta_0 +
\ldots + c_1(\mathcal{O}_D(1))^{r - 1} \cap \pi_D^* \beta_{r - 1}.
$$
for some $\beta_i \in A_{k + i}(X)$.
By Lemmas \ref{lemma-relative-effective-cartier}
and \ref{lemma-pushforward-cap-c1}
this implies
$$
\pi^*\alpha = i_*\beta =
c_1(\mathcal{O}_P(1)) \cap \pi^*\beta_0 +
\ldots +
c_1(\mathcal{O}_D(1))^r \cap \pi^*\beta_{r - 1}.
$$
Since the rank of $\mathcal{E} \oplus \mathcal{O}_X$ is $r + 1$
this contradicts Lemma \ref{lemma-pushforward-cap-c1} unless all
$\alpha$ and all $\beta_i$ are zero.
\end{proof}








\section{The Chern classes of a vector bundle}
\label{section-chern-classes-vector-bundles}

\noindent
We can use the projective space bundle formula to define the
chern classes of a rank $r$ vector bundle in terms of the expansion
of $c_1(\mathcal{O}(1))^r$ in terms of the lower powers, see
formula (\ref{equation-chern-classes}).
The reason for the signs will be explained later.

\begin{definition}
\label{definition-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$
on $X$. Let $(\pi : P \to X, \mathcal{O}_P(1))$ be the projective space
bundle associated to $\mathcal{E}$.
\begin{enumerate}
\item By Lemma \ref{lemma-chow-ring-projective-bundle} there are
elements $c_i \in A_{n - i}(X)$, $i = 0, \ldots, r$
such that $c_0 = [X]$, and
\begin{equation}
\label{equation-chern-classes}
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
\item With notation as above we set
$c_i(\mathcal{E}) \cap [X] = c_i$
as an element of $A_{n - i}(X)$.
We call these the {\it chern classes of $\mathcal{E}$ on $X$}.
\item The {\it total chern class of $\mathcal{E}$ on $X$}
is the combination
$$
c({\mathcal E}) \cap [X] =
c_0({\mathcal E}) \cap [X]
+ c_1({\mathcal E}) \cap [X] + \ldots
+ c_r({\mathcal E}) \cap [X]
$$
which is an element of
$A_*(X) = \bigoplus_{k \in \mathbf{Z}} A_k(X)$.
\end{enumerate}
\end{definition}

\noindent
Let us check that this does not give a new notion in case the
vector bundle has rank $1$.

\begin{lemma}
\label{lemma-first-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
The first chern class of $\mathcal{L}$ on $X$ of
Definition \ref{definition-chern-classes}
is equal to the Weil divisor associated to $\mathcal{L}$
by Definition \ref{definition-divisor-invertible-sheaf}.
\end{lemma}

\begin{proof}
In this proof we use $c_1(\mathcal{L}) \cap [X]$ to denote the
construction of Definition \ref{definition-divisor-invertible-sheaf}.
Since $\mathcal{L}$ has rank $1$ we have
$\mathbf{P}(\mathcal{L}) = X$ and
$\mathcal{O}_{\mathbf{P}(\mathcal{L})}(1) = \mathcal{L}$
by our normalizations. Hence (\ref{equation-chern-classes})
reads
$$
(-1)^1 c_1(\mathcal{L}) \cap c_0 + (-1)^0 c_1 = 0
$$
Since $c_0 = [X]$, we conclude $c_1 = c_1(\mathcal{L}) \cap [X]$
as desired.
\end{proof}

\begin{remark}
\label{remark-equation-signs}
We could also rewrite equation \ref{equation-chern-classes} as
\begin{equation}
\label{equation-signs}
\sum\nolimits_{i = 0}^r
c_1(\mathcal{O}_P(-1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
but we find it easier to work with the tautological quotient
sheaf $\mathcal{O}_P(1)$ instead of
its dual.
\end{remark}




\section{Intersecting with chern classes}
\label{section-intersecting-chern-classes}

\noindent
In this section we define chern classes of vector bundles on $X$ as
bivariant classes on $X$, see Lemma \ref{lemma-cap-cp-bivariant}
and the discussion following this lemma. Our construction follows the familiar
pattern of first defining the operation on prime cycles and then
summing. In Lemma \ref{lemma-determine-intersections} we show
that the result is determined by the usual formula on the associated
projective bundle. Next, we show that capping with chern classes
passes through rational equivalence, commutes with proper pushforward,
commutes with flat pullback, and commutes with the gysin maps for
inclusions of effective Cartier divisors. These lemmas could have been
avoided by directly using the characterization in
Lemma \ref{lemma-determine-intersections} and using
Lemma \ref{lemma-push-proper-bivariant}; the reader who wishes to
see this worked out should consult
Chow Groups of Spaces, Lemma \ref{spaces-chow-lemma-segre-classes}.

\begin{definition}
\label{definition-cap-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
We define, for every integer $k$ and any $0 \leq j \leq r$,
an operation
$$
c_j(\mathcal{E}) \cap - : Z_k(X) \to A_{k - j}(X)
$$
called {\it intersection with the $j$th chern class of $\mathcal{E}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ of $\delta$-dimension
$k$ we define
$$
c_j(\mathcal{E}) \cap [W] = i_*(c_j({i^*\mathcal{E}}) \cap [W])
\in
A_{k - j}(X)
$$
where $c_j({i^*\mathcal{E}}) \cap [W]$ is as defined in
Definition \ref{definition-chern-classes}.
\item For a general $k$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_j(\mathcal{E}) \cap \alpha = \sum n_i c_j(\mathcal{E}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Again, if $\mathcal{E}$ has rank $1$ then this agrees with our
previous definition.

\begin{lemma}
\label{lemma-determine-intersections}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $(\pi : P \to X, \mathcal{O}_P(1))$ be the projective bundle
associated to $\mathcal{E}$.
For $\alpha \in Z_k(X)$ the elements
$c_j(\mathcal{E}) \cap \alpha$ are the unique elements
$\alpha_j$ of $A_{k - j}(X)$
such that $\alpha_0 = \alpha$ and
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
holds in the Chow group of $P$.
\end{lemma}

\begin{proof}
The uniqueness of $\alpha_0, \ldots, \alpha_r$ such that
$\alpha_0 = \alpha$ and such that
the displayed equation holds follows from
the projective space bundle formula
Lemma \ref{lemma-chow-ring-projective-bundle}.
The identity holds by definition for $\alpha = [W]$ where $W$
is an integral closed subscheme of $X$.
For a general $k$-cycle $\alpha$ on $X$ write
$\alpha = \sum n_a[W_a]$ with $n_a \not = 0$, and
$i_a : W_a \to X$ pairwise distinct integral closed subschemes.
Then the family $\{W_a\}$ is locally finite on $X$.
Set $P_a = \pi^{-1}(W_a) = \mathbf{P}(\mathcal{E}|_{W_a})$.
Denote $i'_a : P_a \to P$ the corresponding closed immersions.
Consider the fibre product diagram
$$
\xymatrix{
P' \ar@{=}[r] \ar[d]_{\pi'} &
\coprod P_a \ar[d]_{\coprod \pi_a} \ar[r]_{\coprod i'_a} &
P \ar[d]^\pi \\
X' \ar@{=}[r] &
\coprod W_a \ar[r]^{\coprod i_a} &
X
}
$$
The morphism $p : X' \to X$ is proper. Moreover
$\pi' : P' \to X'$ together with the invertible sheaf
$\mathcal{O}_{P'}(1) = \coprod \mathcal{O}_{P_a}(1)$
which is also the pullback of $\mathcal{O}_P(1)$
is the projective bundle associated to
$\mathcal{E}' = p^*\mathcal{E}$. By definition
$$
c_j(\mathcal{E}) \cap [\alpha]
=
\sum i_{a, *}(c_j(\mathcal{E}|_{W_a}) \cap [W_a]).
$$
Write $\beta_{a, j} = c_j(\mathcal{E}|_{W_a}) \cap [W_a]$
which is an element of $A_{k - j}(W_a)$. We have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_a}(1))^i \cap \pi_a^*(\beta_{a, r - i}) = 0
$$
for each $a$ by definition. Thus clearly we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P'}(1))^i \cap (\pi')^*(\beta_{r - i}) = 0
$$
with $\beta_j = \sum n_a\beta_{a, j} \in A_{k - j}(X')$. Denote
$p' : P' \to P$ the morphism $\coprod i'_a$.
We have $\pi^*p_*\beta_j = p'_*(\pi')^*\beta_j$
by Lemma \ref{lemma-flat-pullback-proper-pushforward}.
By the projection formula of Lemma \ref{lemma-pushforward-cap-c1}
we conclude that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap \pi^*(p_*\beta_j) = 0
$$
Since $p_*\beta_j$ is a representative of $c_j(\mathcal{E}) \cap \alpha$
we win.
\end{proof}

\noindent
We will consistently use this characterization of chern classes
to prove many more properties.

\begin{lemma}
\label{lemma-cap-chern-class-factors-rational-equivalence}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
If $\alpha \sim_{rat} \beta$ are rationally equivalent $k$-cycles
on $X$ then $c_j(\mathcal{E}) \cap \alpha = c_j(\mathcal{E}) \cap \beta$
in $A_{k - j}(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-determine-intersections} the elements
$\alpha_j = c_j(\mathcal{E}) \cap \alpha$, $j \geq 1$ and
$\beta_j = c_j(\mathcal{E}) \cap \beta$, $j \geq 1$ are uniquely determined
by the {\it same} equation in the chow group of the projective
bundle associated to $\mathcal{E}$. (This of course relies on the fact that
flat pullback is compatible with rational equivalence, see
Lemma \ref{lemma-flat-pullback-rational-equivalence}.) Hence they are equal.
\end{proof}

\noindent
In other words capping with chern classes of
finite locally free sheaves factors through rational equivalence
to give maps
$$
c_j(\mathcal{E}) \cap - : A_k(X) \to A_{k - j}(X).
$$
Our next task is to show that chern classes are bivariant classes, see
Definition \ref{definition-bivariant-class}.

\begin{lemma}
\label{lemma-pushforward-cap-cj}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha$ be a $k$-cycle on $X$.
Let $\mathcal{E}$ be a finite locally free sheaf on $Y$.
Then
$$
p_*(c_j(p^*\mathcal{E}) \cap \alpha) = c_j(\mathcal{E}) \cap p_*\alpha
$$
\end{lemma}

\begin{proof}
Let $(\pi : P \to Y, \mathcal{O}_P(1))$ be the projective bundle associated
to $\mathcal{E}$. Then $P_X = X \times_Y P$ is the projective bundle associated
to $p^*\mathcal{E}$ and $\mathcal{O}_{P_X}(1)$ is the pullback of
$\mathcal{O}_P(1)$. Write $\alpha_j = c_j(p^*\mathcal{E}) \cap \alpha$, so
$\alpha_0 = \alpha$. By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi_X^*(\alpha_{r - i}) = 0
$$
in the chow group of $P_X$. Consider the fibre product diagram
$$
\xymatrix{
P_X \ar[r]_-{p'} \ar[d]_{\pi_X} & P \ar[d]^\pi \\
X \ar[r]^p & Y
}
$$
Apply proper pushforward $p'_*$
(Lemma \ref{lemma-proper-pushforward-rational-equivalence})
to the displayed equality above. Using
Lemmas \ref{lemma-pushforward-cap-c1} and
\ref{lemma-flat-pullback-proper-pushforward} we obtain
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(p_*\alpha_{r - i}) = 0
$$
in the chow group of $P$. By the characterization of
Lemma \ref{lemma-determine-intersections} we conclude.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-cap-cj}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $Y$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_j(\mathcal{E}) \cap \alpha) = c_j(f^*\mathcal{E}) \cap f^*\alpha
$$
\end{lemma}

\begin{proof}
Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so $\alpha_0 = \alpha$.
By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to Y, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Consider the fibre product diagram
$$
\xymatrix{
P_X = \mathbf{P}(f^*\mathcal{E}) \ar[r]_-{f'} \ar[d]_{\pi_X} &
P \ar[d]^\pi \\
X \ar[r]^f & Y
}
$$
Note that $\mathcal{O}_{P_X}(1)$ is the pullback of $\mathcal{O}_P(1)$.
Apply flat pullback $(f')^*$
(Lemma \ref{lemma-flat-pullback-rational-equivalence}) to the displayed
equation above. By Lemmas \ref{lemma-flat-pullback-cap-c1} and
\ref{lemma-compose-flat-pullback} we see that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_X}(1))^i \cap
\pi_X^*(f^*\alpha_{r - i}) = 0
$$
holds in the chow group of $P_X$. By the characterization of
Lemma \ref{lemma-determine-intersections} we conclude.
\end{proof}

\begin{lemma}
\label{lemma-cap-chern-class-commutes-with-gysin}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $(\mathcal{L}, s, i : D \to X)$ be as in
Definition \ref{definition-gysin-homomorphism}.
Then $c_j(\mathcal{E}|_D) \cap i^*\alpha = i^*(c_j(\mathcal{E}) \cap \alpha)$
for all $\alpha \in A_k(X)$.
\end{lemma}

\begin{proof}
Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so $\alpha_0 = \alpha$.
By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to X, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Consider the fibre product diagram
$$
\xymatrix{
P_D = \mathbf{P}(\mathcal{E}|_D) \ar[r]_-{i'} \ar[d]_{\pi_D} &
P \ar[d]^\pi \\
D \ar[r]^i & X
}
$$
Note that $\mathcal{O}_{P_D}(1)$ is the pullback of $\mathcal{O}_P(1)$.
Apply the gysin map $(i')^*$ (Lemma \ref{lemma-gysin-factors}) to the
displayed equation above.
Applying Lemmas \ref{lemma-gysin-commutes-cap-c1} and
\ref{lemma-gysin-flat-pullback} we obtain
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{P_D}(1))^i \cap
\pi_D^*(i^*\alpha_{r - i}) = 0
$$
in the chow group of $P_D$.
By the characterization of Lemma \ref{lemma-determine-intersections}
we conclude.
\end{proof}

\noindent
At this point we have enough material to be able to prove that
capping with chern classes defines a bivariant class.

\begin{lemma}
\label{lemma-cap-cp-bivariant}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module
of rank $r$. Let $0 \leq p \leq r$.
Then the rule that to $f : X' \to X$ assignes
$c_p(f^*\mathcal{E}) \cap - : A_k(X') \to A_{k - 1}(X')$
is a bivariant class of degree $p$.
\end{lemma}

\begin{proof}
Immediate from Lemmas
\ref{lemma-cap-chern-class-factors-rational-equivalence},
\ref{lemma-pushforward-cap-cj},
\ref{lemma-flat-pullback-cap-cj}, and
\ref{lemma-cap-chern-class-commutes-with-gysin}
and Definition \ref{definition-bivariant-class}.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module
of rank $r$. At this point we define the {\it chern classes}
of $\mathcal{E}$ to be the elements
$$
c_j(\mathcal{E}) \in A^j(X)
$$
constructed in Lemma \ref{lemma-cap-cp-bivariant}. The
{\it total chern class} of $\mathcal{E}$ is the element
$$
c(\mathcal{E}) = 
c_0(\mathcal{E}) + c_1(\mathcal{E}) + \ldots + c_r(\mathcal{E})
\in A^*(X)
$$
Next we see that chern classes are in the center of the bivariant
Chow cohomology ring $A^*(X)$.

\begin{lemma}
\label{lemma-cap-commutative-chern}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a locally free $\mathcal{O}_X$-module of rank $r$.
Then $c_j(\mathcal{L}) \in A^j(X)$ commutes with every
element $c \in A^p(X)$. In particular, if $\mathcal{F}$ is a
second locally free $\mathcal{O}_X$-module on $X$ of rank $s$, then
$$
c_i(\mathcal{E}) \cap c_j(\mathcal{F}) \cap \alpha
=
c_j(\mathcal{F}) \cap c_i(\mathcal{E}) \cap \alpha
$$
as elements of $A_{k - i - j}(X)$ for all $\alpha \in A_k(X)$.
\end{lemma}

\begin{proof}
Let $\alpha \in A_k(X)$. Write $\alpha_j = c_j(\mathcal{E}) \cap \alpha$, so
$\alpha_0 = \alpha$. By Lemma \ref{lemma-determine-intersections} we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
in the chow group of the projective bundle
$(\pi : P \to Y, \mathcal{O}_P(1))$
associated to $\mathcal{E}$. Applying $c \cap -$ and using
Lemma \ref{lemma-c1-center} and the properties of bivariant classes we obtain
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_P(1))^i \cap
\pi^*(c \cap \alpha_{r - i}) = 0
$$
in the Chow group of $P$. Hence we see that $c \cap \alpha_j$ is
equal to $c_j(\mathcal{E}) \cap (c \cap \alpha)$ by the characterization
of Lemma \ref{lemma-determine-intersections}.
This proves the lemma.
\end{proof}

\begin{remark}
\label{remark-extend-to-finite-locally-free}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module.
If the rank of $\mathcal{E}$ is not constant then we can
still define the chern classes of $\mathcal{E}$. Namely, in this
case we can write
$$
X = X_0 \amalg X_1 \amalg X_2 \amalg \ldots
$$
where $X_r \subset X$ is the open and closed subspace where
the rank of $\mathcal{E}$ is $r$. If $X' \to X$ is a morphism
which is locally of finite type, then we obtain by
pullback a corresponding decomposition of $X'$ and we find that
$$
A_*(X') = \prod\nolimits_{r \geq 0} A_*(X'_r)
$$
by our definitions. Then we simply define $c_i(\mathcal{E})$
to be the bivariant class which preserves these direct
product decompositions and acts by the already defined
operations $c_i(\mathcal{E}|_{X_r}) \cap -$
on the factors. Observe that in this setting it may happen
that $c_i(\mathcal{E})$ is nonzero for infinitely many $i$.
\end{remark}









\section{Polynomial relations among chern classes}
\label{section-relations-chern-classes}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $\mathcal{E}_i$ be a finite collection of finite
locally free sheaves on $X$. By Lemma \ref{lemma-cap-commutative-chern}
we see that the chern classes
$$
c_j(\mathcal{E}_i) \in A^*(X)
$$
generate a commutative (and even central) $\mathbf{Z}$-subalgebra of the
Chow cohomology algebra $A^*(X)$.
Thus we can say what it means for a polynomial in these chern classes
to be zero, or for two polynomials to be the same. As an example, saying that
$c_1(\mathcal{E}_1)^5 + c_2(\mathcal{E}_2)c_3(\mathcal{E}_3) = 0$
means that the operations
$$
A_k(Y) \longrightarrow A_{k - 5}(Y), \quad
\alpha \longmapsto
c_1(\mathcal{E}_1)^5 \cap \alpha +
c_2(\mathcal{E}_2) \cap c_3(\mathcal{E}_3) \cap \alpha
$$
are zero for all morphisms $f : Y \to X$ which are locally of finite type.
By Lemma \ref{lemma-bivariant-zero}
this is equivalent to the requirement that given any morphism
$f : Y \to X$  where $Y$ is an integral scheme
locally of finite type over $S$ the cycle
$$
c_1(\mathcal{E}_1)^5 \cap [Y] +
c_2(\mathcal{E}_2) \cap c_3(\mathcal{E}_3) \cap [Y]
$$
is zero in $A_{\dim(Y) - 5}(Y)$.

\medskip\noindent
A specific example is the relation
$$
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N})
=
c_1(\mathcal{L}) + c_1(\mathcal{N})
$$
proved in Lemma \ref{lemma-c1-cap-additive}.
More generally, here is what happens when we tensor an
arbitrary locally free sheaf by an invertible sheaf.

\begin{lemma}
\label{lemma-chern-classes-E-tensor-L}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of
rank $r$ on $X$. Let $\mathcal{L}$ be an invertible
sheaf on $X$. Then we have
\begin{equation}
\label{equation-twist}
c_i({\mathcal E} \otimes {\mathcal L})
=
\sum\nolimits_{j = 0}^i
\binom{r - i + j}{j} c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
\end{equation}
in $A^*(X)$.
\end{lemma}

\begin{proof}
This should hold for any triple $(X, \mathcal{E}, \mathcal{L})$.
In particular it should hold when $X$ is integral and by
Lemma \ref{lemma-bivariant-zero}
it is enough to prove
it holds when capping with $[X]$ for such $X$. Thus assume
that $X$ is integral. Let $(\pi : P \to X, \mathcal{O}_P(1))$,
resp.\ $(\pi' : P' \to X, \mathcal{O}_{P'}(1))$ be the
projective space bundle associated to $\mathcal{E}$,
resp.\ $\mathcal{E} \otimes \mathcal{L}$. Consider the canonical morphism
$$
\xymatrix{
P \ar[rd]_\pi \ar[rr]_g & & P' \ar[ld]^{\pi'} \\
& X &
}
$$
see Constructions, Lemma \ref{constructions-lemma-twisting-and-proj}.
It has the property that
$g^*\mathcal{O}_{P'}(1)
= \mathcal{O}_P(1) \otimes \pi^* {\mathcal L}$.
This means that we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i
(\xi + x)^i \cap \pi^*(c_{r - i}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
=
0
$$
in $A_*(P)$, where $\xi$ represents
$c_1(\mathcal{O}_P(1))$ and $x$
represents $c_1(\pi^*\mathcal{L})$. By simple algebra this
is equivalent to
$$
\sum\nolimits_{i = 0}^r
(-1)^i \xi^i \left(
\sum\nolimits_{j = i}^r
(-1)^{j - i}
\binom{j}{i}
x^{j - i} \cap
\pi^*(c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
\right)
=
0
$$
Comparing with
Equation (\ref{equation-chern-classes}) it follows from this that
$$
c_{r - i}(\mathcal{E}) \cap [X] =
\sum\nolimits_{j = i}^r
\binom{j}{i}
(-c_1(\mathcal{L}))^{j - i} \cap
c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X]
$$
Reworking this (getting rid of minus signs, and renumbering) we get
the desired relation.
\end{proof}

\noindent
Some example cases of (\ref{equation-twist}) are
\begin{align*}
c_1(\mathcal{E} \otimes \mathcal{L})
& =
c_1(\mathcal{E}) +
r c_1(\mathcal{L}) \\
c_2(\mathcal{E} \otimes \mathcal{L})
& =
c_2(\mathcal{E}) +
(r - 1) c_1(\mathcal{E}) c_1(\mathcal{L}) +
\binom{r}{2} c_1(\mathcal{L})^2 \\
c_3(\mathcal{E} \otimes \mathcal{L})
& =
c_3(\mathcal{E}) +
(r - 2) c_2(\mathcal{E})c_1(\mathcal{L}) +
\binom{r - 1}{2} c_1(\mathcal{E})c_1(\mathcal{L})^2 +
\binom{r}{3} c_1(\mathcal{L})^3
\end{align*}








\section{Additivity of chern classes}
\label{section-additivity-chern-classes}

\noindent
All of the preliminary lemmas follow trivially from the
final result.

\begin{lemma}
\label{lemma-get-rid-of-trivial-subbundle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves
on $X$ of ranks $r$, $r - 1$ which fit into a short
exact sequence
$$
0 \to \mathcal{O}_X \to \mathcal{E} \to \mathcal{F} \to 0
$$
Then we have
$$
c_r(\mathcal{E}) = 0, \quad
c_j(\mathcal{E}) = c_j(\mathcal{F}), \quad j = 0, \ldots, r - 1
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-bivariant-zero}
it suffices to show that if $X$ is integral
then $c_j(\mathcal{E}) \cap [X] = c_j(\mathcal{F}) \cap [X]$.
Let $(\pi : P \to X, \mathcal{O}_P(1))$,
resp. $(\pi' : P' \to X, \mathcal{O}_{P'}(1))$ denote the
projective space bundle associated to $\mathcal{E}$, resp.\ $\mathcal{F}$.
The surjection $\mathcal{E} \to \mathcal{F}$ gives rise
to a closed immersion
$$
i : P' \longrightarrow P
$$
over $X$. Moreover, the element
$1 \in \Gamma(X, \mathcal{O}_X) \subset \Gamma(X, \mathcal{E})$
gives rise to a global section $s \in \Gamma(P, \mathcal{O}_P(1))$
whose zero set is exactly $P'$. Hence $P'$ is an effective Cartier
divisor on $P$ such that $\mathcal{O}_P(P') \cong \mathcal{O}_P(1)$.
Hence we see that
$$
c_1(\mathcal{O}_P(1)) \cap \pi^*\alpha = i_*((\pi')^*\alpha)
$$
for any cycle class $\alpha$ on $X$ by
Lemma \ref{lemma-relative-effective-cartier}.
By Lemma \ref{lemma-determine-intersections} we see that
$\alpha_j = c_j(\mathcal{F}) \cap [X]$, $j = 0, \ldots, r - 1$
satisfy
$$
\sum\nolimits_{j = 0}^{r - 1} (-1)^jc_1(\mathcal{O}_{P'}(1))^j
\cap (\pi')^*\alpha_j = 0
$$
Pushing this to $P$ and using the remark above as well as
Lemma \ref{lemma-pushforward-cap-c1} we get
$$
\sum\nolimits_{j = 0}^{r - 1}
(-1)^j c_1(\mathcal{O}_P(1))^{j + 1}
\cap \pi^*\alpha_j = 0
$$
By the uniqueness of Lemma \ref{lemma-determine-intersections}
we conclude that
$c_r(\mathcal{E}) \cap [X] = 0$ and
$c_j(\mathcal{E}) \cap [X] = \alpha_j = c_j(\mathcal{F}) \cap [X]$
for $j = 0, \ldots, r - 1$. Hence the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-additivity-invertible-subsheaf}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves
on $X$ of ranks $r$, $r - 1$ which fit into a short
exact sequence
$$
0 \to \mathcal{L} \to \mathcal{E} \to \mathcal{F} \to 0
$$
where $\mathcal{L}$ is an invertible sheaf.
Then
$$
c(\mathcal{E}) = c(\mathcal{L}) c(\mathcal{F})
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
This relation really just says that
$c_i(\mathcal{E}) = c_i(\mathcal{F}) + c_1(\mathcal{L})c_{i - 1}(\mathcal{F})$.
By Lemma \ref{lemma-get-rid-of-trivial-subbundle}
we have $c_j(\mathcal{E} \otimes \mathcal{L}^{\otimes -1})
= c_j(\mathcal{E} \otimes \mathcal{L}^{\otimes -1})$ for
$j = 0, \ldots, r$ (were we set $c_r(\mathcal{F}) = 0$ by
convention).
Applying Lemma \ref{lemma-chern-classes-E-tensor-L} we deduce
$$
\sum_{j = 0}^i
\binom{r - i + j}{j} (-1)^j c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
=
\sum_{j = 0}^i
\binom{r - 1 - i + j}{j} (-1)^j c_{i - j}({\mathcal F}) c_1({\mathcal L})^j
$$
Setting
$c_i(\mathcal{E}) = c_i(\mathcal{F}) + c_1(\mathcal{L})c_{i - 1}(\mathcal{F})$
gives a ``solution'' of this equation. The lemma follows if we show
that this is the only possible solution. We omit the verification.
\end{proof}

\begin{lemma}
\label{lemma-additivity-chern-classes}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose that ${\mathcal E}$ sits in an
exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
of finite locally free sheaves $\mathcal{E}_i$ of rank $r_i$.
The total chern classes satisfy
$$
c({\mathcal E}) = c({\mathcal E}_1) c({\mathcal E}_2)
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-bivariant-zero} we may assume that $X$ is integral
and we have to show the identity when capping against $[X]$.
By induction on $r_1$. The case $r_1 = 1$ is
Lemma \ref{lemma-additivity-invertible-subsheaf}.
Assume $r_1 > 1$. Let $(\pi : P \to X, \mathcal{O}_P(1))$
denote the projective space bundle associated to $\mathcal{E}_1$. Note that
\begin{enumerate}
\item $\pi^* : A_*(X) \to A_*(P)$ is injective, and
\item $\pi^*\mathcal{E}_1$ sits in a short exact sequence
$0 \to \mathcal{F} \to \pi^*\mathcal{E}_1 \to \mathcal{L} \to 0$
where $\mathcal{L}$ is invertible.
\end{enumerate}
The first assertion follows from the projective space bundle formula
and the second follows from the definition of a projective space bundle.
(In fact $\mathcal{L} = \mathcal{O}_P(1)$.)
Let $Q = \pi^*\mathcal{E}/\mathcal{F}$, which sits in an
exact sequence $0 \to \mathcal{L} \to Q \to \pi^*\mathcal{E}_2 \to 0$.
By induction we have
\begin{eqnarray*}
c(\pi^*\mathcal{E}) \cap [P]
& = &
c(\mathcal{F}) \cap c(\pi^*\mathcal{E}/\mathcal{F}) \cap [P] \\
& = &
c(\mathcal{F}) \cap c(\mathcal{L}) \cap c(\pi^*\mathcal{E}_2) \cap [P] \\
& = &
c(\pi^*\mathcal{E}_1) \cap c(\pi^*\mathcal{E}_2) \cap [P]
\end{eqnarray*}
Since $[P] = \pi^*[X]$ we
win by Lemma \ref{lemma-flat-pullback-cap-cj}.
\end{proof}

\begin{lemma}
\label{lemma-chern-filter-by-linebundles}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let ${\mathcal L}_i$, $i = 1, \ldots, r$ be invertible
$\mathcal{O}_X$-modules on $X$.
Let $\mathcal{E}$ be a locally free rank
$\mathcal{O}_X$-module endowed with a filtration
$$
0 = \mathcal{E}_0 \subset \mathcal{E}_1 \subset \mathcal{E}_2
\subset \ldots \subset \mathcal{E}_r = \mathcal{E}
$$
such that $\mathcal{E}_i/\mathcal{E}_{i - 1} \cong \mathcal{L}_i$.
Set $c_1({\mathcal L}_i) = x_i$. Then
$$
c(\mathcal{E})
=
\prod\nolimits_{i = 1}^r (1 + x_i)
$$
in $A^*(X)$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-additivity-invertible-subsheaf} and induction.
\end{proof}





\section{The splitting principle}
\label{section-splitting-principle}

\noindent
In our setting it is not so easy to say what the splitting principle
exactly says/is. Here is a possible formulation.

\begin{lemma}
\label{lemma-splitting-principle}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}. Let $X$ be locally
of finite type over $S$. Let $\mathcal{E}_i$ be a finite collection of
locally free $\mathcal{O}_X$-modules of rank $r_i$. There exists a projective
flat morphism $\pi : P \to X$ of relative dimension $d$ such that
\begin{enumerate}
\item for any morphism $f : Y \to X$ the map
$\pi_Y^* : A_*(Y) \to A_{* + d}(Y \times_X P)$ is injective, and
\item each $\pi^*\mathcal{E}_i$ has a filtration
whose successive quotients $\mathcal{L}_{i, 1}, \ldots, \mathcal{L}_{i, r_i}$
are invertible ${\mathcal O}_P$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Use a composition of projective space bundles.
\end{proof}

\noindent
Let $(S, \delta)$, $X$, and $\mathcal{E}_i$ be as in
Lemma \ref{lemma-splitting-principle}.
The {\it splitting principle} refers to the practice of symbolically writing
$$
c(\mathcal{E}_i) = \prod (1 + x_{i, j})
$$
The symbols $x_{i, 1}, \ldots, x_{i, r_i}$ are called the {\it Chern roots}
of $\mathcal{E}_i$. We think of $x_{i, j}$ as the first chern classes
of some (unknown) invertible sheaves whose direct sum equals $\mathcal{E}_i$.
The usefulness of the splitting principle comes from the assertion
that in order to prove a polynomial relation
among chern classes of the $\mathcal{E}_i$ it is enough to prove the
corresponding relation among the chern roots.

\medskip\noindent
Namely, let $\pi : P \to X$ be as in Lemma \ref{lemma-splitting-principle}.
Recall that there is a canonical $\mathbf{Z}$-algebra map
$\pi^* : A^*(X) \to A^*(P)$, see
Remark \ref{remark-pullback-cohomology}. The injectivity of $\pi_Y^*$
on Chow groups for every $Y$ over $X$, implies that the map
$\pi^* : A^*(X) \to A^*(P)$ is injective (details omitted).
We have
$$
\pi^*c(\mathcal{E}_i) = \prod (1 + c_1(\mathcal{L}_{i, j}))
$$
by Lemma \ref{lemma-chern-filter-by-linebundles}. Thus we may identify
the chern roots $x_{i, j}$ with $c_1(\mathcal{L}_{i, j})$ at least after
applying the injective map $\pi^* : A^*(X) \to A^*(P)$.

\medskip\noindent
To see how this works, it is best to give an example. Let us calculate the
chern classes of the dual $\mathcal{E}^\vee$ of a locally
free $\mathcal{O}_X$-module $\mathcal{E}$ of rank $r$. Note that
if $\pi^*\mathcal{E}$ has a filtration with subquotients the invertible
modules $\mathcal{L}_1, \ldots, \mathcal{L}_r$, then
$\pi^*\mathcal{E}^\vee$ has a filtration with subquotients invertible
sheaves $\mathcal{L}_r^{-1}, \ldots, \mathcal{L}_1^{\otimes -1}$.
Hence if $x_i$ are the chern roots of $\mathcal{E}$, in other words,
if $x_i = c_1(\mathcal{L}_i)$, then the $-x_i$ are the chern roots of
$\mathcal{E}^\vee$ by Lemma \ref{lemma-c1-cap-additive}. It follows that
$$
\pi^*c(\mathcal{E}^\vee) = \prod (1 - x_i)
$$
in $A^*(P)$ and hence by elementary algebra that
$$
c_j(\mathcal{E}^\vee) = (-1)^jc_j(\mathcal{E})
$$
in $A^*(X)$ by the injectivity above.

\medskip\noindent
It should be said here that in any application of the splitting principle
it is no longer necessary to choose an actual $\pi : P \to X$ and to use
the pullback map; it suffices to know that one exists. In a way this is an
abuse of language, more than anything else. In the following
paragraph we give an example.

\medskip\noindent
Let us compute the chern classes of a tensor product of vector bundles.
Namely, suppose that $\mathcal{E}$, $\mathcal{F}$
are finite locally free of ranks $r$, $s$.
Write
$$
c(\mathcal{E}) = \prod\nolimits_{i = 1}^r (1 + x_i),
\quad
c(\mathcal{E}) = \prod\nolimits_{j = 1}^s (1 + y_j)
$$
where $x_i$, $y_j$ are the chern roots of $\mathcal{E}$,
$\mathcal{F}$. Then we see that
$$
c(\mathcal{E} \otimes_{\mathcal{O}_X} \mathcal{F})
=
\prod\nolimits_{i, j} (1 + x_i + y_j)
$$
because if $\mathcal{E}$ is the direct sum of invertible sheaves
$\mathcal{L}_i$ and $\mathcal{F}$ is the direct sum of invertible
sheaves $\mathcal{N}_j$, then $\mathcal{E} \otimes \mathcal{F}$
is the direct sum of the invertible sheaves
$\mathcal{L}_i \otimes \mathcal{N}_j$.
Here are some examples of what this means in terms of
chern classes
$$
c_1(\mathcal{E} \otimes \mathcal{F})
=
r c_1(\mathcal{F}) + s c_1(\mathcal{E})
$$
$$
c_2(\mathcal{E} \otimes \mathcal{F})
=
r^2 c_2(\mathcal{F}) +
rs c_1(\mathcal{F})c_1(\mathcal{E}) +
s^2 c_2(\mathcal{E})
$$




\section{The Chern character and tensor products}
\label{section-chern-classes-tensor}

\noindent
We define the {\it Chern character} of a finite locally free
sheaf of rank $r$ to be the formal expression
$$
ch({\mathcal E}) = \sum\nolimits_{i=1}^r e^{x_i}
$$
if the $x_i$ are the chern roots of ${\mathcal E}$. Writing this in
terms of chern classes $c_i = c_i(\mathcal{E})$ we see that
$$
ch(\mathcal{E}) =
r
+
c_1
+
\frac{1}{2}(c_1^2 - 2c_2)
+
\frac{1}{6}(c_1^3 - 3c_1c_2 + 3c_3)
+
\frac{1}{24}(c_1^4 - 4c_1^2c_2 + 4c_1c_3 + 2c_2^2 - 4c_4)
+
\ldots
$$
What does it mean that the coefficients are rational numbers?
Well this simply means that we think of
$ch_j(\mathcal{E})$ as an element of $A^j(X) \otimes \mathbf{Q}$.
By the above we have in case of an exact sequence
$$
0 \to \mathcal{E}_1 \to \mathcal{E} \to \mathcal{E}_2 \to 0
$$
that
$$
ch(\mathcal{E}) = ch(\mathcal{E}_1) + ch(\mathcal{E}_2)
$$
in $A^*(X) \otimes \mathbf{Q}$.
Using the Chern character we can express the compatibility
of the chern classes and tensor product as follows:
$$
ch(\mathcal{E}_1 \otimes_{\mathcal{O}_X} \mathcal{E}_2) =
ch(\mathcal{E}_1) ch(\mathcal{E}_2)
$$
in $A^*(X) \otimes \mathbf{Q}$.
This follows directly from the discussion of the chern roots
of the tensor product in the previous section.

\begin{remark}
\label{remark-extend-chern-character-to-finite-locally-free}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module.
If the rank of $\mathcal{E}$ is not constant then we can
still define the Chern character $ch(\mathcal{E})$
of $\mathcal{E}$, exactly as in
Remark \ref{remark-extend-to-finite-locally-free}.
It is still the case that $ch_i(\mathcal{E})$
is in $A^i(X) \otimes \mathbf{Q}$ with denominator at worst $i!$.
\end{remark}












\section{Chern classes and the derived category}
\label{section-pre-derived}

\noindent
In this section we define the total chern class of an object
of the derived category which may be represented globally
by a finite complex of finite locally free modules.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let
$$
\mathcal{E}^a \to \mathcal{E}^{a + 1} \to \ldots \to \mathcal{E}^b
$$
be a finite complex of finite locally free $\mathcal{O}_X$-modules.
Then we define the {\it total chern class of the complex} by the formula
$$
c(\mathcal{E}^\bullet) = \prod\nolimits_{p = a, \ldots, b}
c(\mathcal{E}^p)^{(-1)^p}
$$
in $A^*(X)$. Here the inverse is the formal inverse, so
$$
(1 + c_1 + c_2 + c_3 + \ldots)^{-1} =
1 - c_1 + c_1^2 - c_2 - c_1^3 + 2c_1 c_2 - c_3 + \ldots
$$
We similarly define the {\it Chern character of the complex} by
the formula
$$
ch(\mathcal{E}^\bullet) = \sum\nolimits_{p = a, \ldots, b}
(-1)^p ch(\mathcal{E}^p)
$$
in $A^*(X) \otimes \mathbf{Q}$.
Let us prove that $c(\mathcal{E}^\bullet)$ only depends
on the image of the complex
in the derived category.

\begin{lemma}
\label{lemma-pre-derived-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Let $E \in D(\mathcal{O}_X)$
be an object such that there exists a finite complex $\mathcal{E}^\bullet$
of finite locally free $\mathcal{O}_X$-modules representing $E$.
Then $c(\mathcal{E}^\bullet) \in A^*(X)$ is independent of the
choice of the complex. Similarly for $ch(\mathcal{E}^\bullet)$.
\end{lemma}

\begin{proof}
Suppose we have a second finite complex $\mathcal{F}^\bullet$
of finite locally free $\mathcal{O}_X$-modules representing $E$.
Choose $a \leq b$ such that $\mathcal{F}^p$ and $\mathcal{E}^p$
are zero for $p \not \in [a, b]$. We will prove the lemma
by induction on $b - a$. If $b - a = 0$, then we have
$\mathcal{F}^a \cong \mathcal{E}^a \cong E$ and the result is clear.

\medskip\noindent
Induction step. Assume $b > a$. Let $g : Y \to X$ be a morphism
locally of finite type with $Y$ integral.
By Lemma \ref{lemma-bivariant-zero} it suffices to show that
with $c(g^*\mathcal{E}^\bullet) \cap [Y]$ is the same as
$c(g^*\mathcal{F}^\bullet) \cap [Y]$ and it even suffices to prove
this after replacing $Y$ by an integral scheme proper and birational
over $Y$. By
More on Flatness, Lemma \ref{flat-lemma-blowup-complex-integral}
we may assume that $H^b(Lg^*E)$ is perfect of tor dimension $\leq 1$.
This reduces us to the case discussed in the next paragraph.

\medskip\noindent
Assume $X$ is integral and $H^b(E)$ is a perfect $\mathcal{O}_X$-module
of tor dimension $\leq 1$. Let
$$
\mathcal{G} = \Ker(\mathcal{E}^b \oplus \mathcal{F}^b \to H^b(E))
$$
Since $H^b(E)$ has tor dimension $\leq 1$ we see that
$\mathcal{G}$ is finite locally free. Then there is a commutative diagram
$$
\xymatrix{
\mathcal{G}[-b] \ar[r]_\alpha \ar[d]^\beta & \mathcal{E}^\bullet \ar[d] \\
\mathcal{F}^\bullet \ar[r] & E
}
$$
in $D(\mathcal{O}_X)$.
(Warning: you have to choose the negative of the canonical map for one of
the arrows to make this diagram commute.)
Choose a distinguished triangle
$$
\mathcal{G}[-b] \to E \to E' \to \mathcal{G}[-b + 1]
$$
in $D(\mathcal{O}_X)$. On the other hand, the cone on
$\alpha : \mathcal{G}[-b] \to \mathcal{E}^\bullet$
gives a distinguished triangle
$$
\mathcal{G}[-b] \to
\mathcal{E}^\bullet \to C(\alpha) \to
\mathcal{G}[-b + 1]
$$
and similarly for $\mathcal{F}^\bullet$ and $\beta$.
Since $\mathcal{G} \to \mathcal{E}^b$ is surjective,
it follows that $C(\alpha)$ has vanishing cohomogy
in degree $b$ and hence
$$
\tau_{\leq b - 1}C(\alpha) \longrightarrow C(\alpha)
$$
is an isomorphism in $D(\mathcal{O}_X)$. On the other hand, the displayed
arrow determines an isomorphism of complexes except in degrees
$b - 1$ and $b$ where we have
$$
\left(\tau_{\leq b - 1}C(\alpha)\right)^{b - 1} =
\Ker\left(C(\alpha)^{b - 1} \to C(\alpha)^b\right)
\quad\text{and}\quad
\left(\tau_{\leq b - 1}C(\alpha)\right)^b = 0
$$
Since $C(\alpha)^{b - 1} \to C(\alpha)^b$ is a surjection of finite
locally free $\mathcal{O}_X$-modules, we conclude from multiplicativity
of total chern classes (Lemma \ref{lemma-additivity-chern-classes})
$$
c(\tau_{\leq b - 1}C(\alpha)) = c(C(\alpha))
$$
and similarly for $C(\beta)$. By the axioms of a triangulated category we
obtain an isomorphism $C(\alpha) \to E'$ in $D(\mathcal{O}_X)$
and similarly of $\mathcal{F}^\bullet$. By induction hypothesis we obtain
$$
c(\tau_{\leq b - 1}C(\alpha)) \cap [X] =
c(\tau_{\leq b - 1}C(\beta)) \cap [X]
$$
We conclude that
$$
c(\tau_{\leq b - 1}C(\alpha)) \cap [X] =
c(C(\alpha)) \cap [X] =
c(\mathcal{E}^\bullet) c(\mathcal{G})^{(-1)^{b - 1}} \cap [X]
$$
and similarly for $\mathcal{F}^\bullet$. The second equality follows
because the terms of $C(\alpha)$ are identical to the terms of
the complex $\mathcal{E}^\bullet$, except in degree $b - 1$
we've added $\mathcal{G}$ (plus we use
Lemma \ref{lemma-additivity-chern-classes} again).
We conclude that
$$
c(\mathcal{E}^\bullet) c(\mathcal{G})^{(-1)^{b - 1}} \cap [X] =
c(\mathcal{F}^\bullet) c(\mathcal{G})^{(-1)^{b - 1}} \cap [X]
$$
and we win since multiplying by a total chern class is an
invertible operation.
\end{proof}














\section{Todd classes}
\label{section-todd-classes}

\noindent
A final class associated to a vector bundle $\mathcal{E}$
of rank $r$ is its {\it Todd class} $Todd(\mathcal{E})$.
In terms of the chern roots $x_1, \ldots, x_r$ it is
defined as
$$
Todd(\mathcal{E})
=
\prod\nolimits_{i = 1}^r
\frac{x_i}{1 - e^{-x_i}}
$$
In terms of the chern classes $c_i = c_i(\mathcal{E})$
we have
$$
Todd(\mathcal{E})
=
1
+
\frac{1}{2}c_1
+
\frac{1}{12}(c_1^2 + c_2)
+
\frac{1}{24}c_1c_2
+
\frac{1}{720}(-c_1^4 + 4c_1^2c_2 + 3c_2^2 + c_1c_3 - c_4)
+
\ldots
$$
We have made the appropriate remarks about denominators
in the previous section. It is the case that
given an exact sequence
$$
0
\to
{\mathcal E}_1
\to
{\mathcal E}
\to
{\mathcal E}_2
\to
0
$$
we have
$$
Todd({\mathcal E}) = Todd({\mathcal E}_1) Todd({\mathcal E}_2).
$$




\section{Degrees of zero cycles}
\label{section-degree-zero-cycles}

\noindent
We start defining the degree of a zero cycle on a proper scheme over a field.
One approach is to define it directly as in
Lemma \ref{lemma-spell-out-degree-zero-cycle} and then show
it is well defined by
Lemma \ref{lemma-curve-principal-divisor}.
Instead we define it as follows.

\begin{definition}
\label{definition-degree-zero-cycle}
Let $k$ be a field (Example \ref{example-field}). Let $p : X \to \Spec(k)$
be proper. The {\it degree of a zero cycle} on $X$ is given by proper
pushforward
$$
p_* : A_0(X) \to A_0(\Spec(k))
$$
(Lemma \ref{lemma-proper-pushforward-rational-equivalence})
combined with the natural isomorphism $A_0(\Spec(k)) = \mathbf{Z}$
which maps $[\Spec(k)]$ to $1$. Notation: $\deg(\alpha)$.
\end{definition}

\noindent
Let us spell this out further.

\begin{lemma}
\label{lemma-spell-out-degree-zero-cycle}
Let $k$ be a field. Let $X$ be proper over $k$. Let $\alpha = \sum n_i[Z_i]$
be in $Z_0(X)$. Then
$$
\deg(\alpha) = \sum n_i\deg(Z_i)
$$
where $\deg(Z_i)$ is the degree of $Z_i \to \Spec(k)$, i.e.,
$\deg(Z_i) = \dim_k \Gamma(Z_i, \mathcal{O}_{Z_i})$.
\end{lemma}

\begin{proof}
This is the definition of proper pushforward
(Definition \ref{definition-proper-pushforward}).
\end{proof}

\noindent
Next, we make the connection with degrees of vector bundles
over $1$-dimensional proper schemes over fields as defined in
Varieties, Section \ref{varieties-section-divisors-curves}.

\begin{lemma}
\label{lemma-degree-vector-bundle}
Let $k$ be a field. Let $X$ be a proper scheme over $k$ of dimension $\leq 1$.
Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module of constant
rank. Then
$$
\deg(\mathcal{E}) = \deg(c_1(\mathcal{E}) \cap [X]_1)
$$
where the left hand side is defined in
Varieties, Definition \ref{varieties-definition-degree-invertible-sheaf}.
\end{lemma}

\begin{proof}
Let $C_i \subset X$, $i = 1, \ldots, t$ be the irreducible components
of dimension $1$ with reduced induced scheme structure and let $m_i$ be the
multiplicity of $C_i$ in $X$. Then $[X]_1 = \sum m_i[C_i]$ and
$c_1(\mathcal{E}) \cap [X]_1$ is the sum of the pushforwards of the cycles
$m_i c_1(\mathcal{E}|_{C_i}) \cap [C_i]$. Since we have a similar decomposition
of the degree of $\mathcal{E}$ by
Varieties, Lemma \ref{varieties-lemma-degree-in-terms-of-components}
it suffices to prove the lemma in case $X$ is a proper curve over $k$.

\medskip\noindent
Assume $X$ is a proper curve over $k$.
By Divisors, Lemma \ref{divisors-lemma-filter-after-modification}
there exists a modification $f : X' \to X$ such that $f^*\mathcal{E}$
has a filtration whose successive quotients are invertible
$\mathcal{O}_{X'}$-modules. Since $f_*[X']_1 = [X]_1$ we conclude
from Lemma \ref{lemma-pushforward-cap-cj} that
$$
\deg(c_1(\mathcal{E}) \cap [X]_1) = \deg(c_1(f^*\mathcal{E}) \cap [X']_1)
$$
Since we have a similar relationship for the degree by
Varieties, Lemma \ref{varieties-lemma-degree-birational-pullback}
we reduce to the case where $\mathcal{E}$ has a filtration whose
successive quotients are invertible $\mathcal{O}_X$-modules.
In this case, we may use additivity of the degree
(Varieties, Lemma \ref{varieties-lemma-degree-additive})
and of first chern classes (Lemma \ref{lemma-additivity-chern-classes})
to reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $X$ is a proper curve over $k$ and $\mathcal{E}$ is an
invertible $\mathcal{O}_X$-module. By
Divisors, Lemma
\ref{divisors-lemma-quasi-projective-Noetherian-pic-effective-Cartier}
we see that $\mathcal{E}$ is isomorphic to
$\mathcal{O}_X(D) \otimes \mathcal{O}_X(D')^{\otimes -1}$
for some effective Cartier divisors $D, D'$ on $X$ (this also uses
that $X$ is projective, see
Varieties, Lemma \ref{varieties-lemma-dim-1-proper-projective} for example).
By additivity of degree under tensor product of invertible sheaves
(Varieties, Lemma \ref{varieties-lemma-degree-tensor-product})
and additivity of $c_1$ under tensor product of invertible sheaves
(Lemma \ref{lemma-c1-cap-additive} or \ref{lemma-chern-classes-E-tensor-L})
we reduce to the case $\mathcal{E} = \mathcal{O}_X(D)$.
In this case the left hand side gives $\deg(D)$
(Varieties, Lemma \ref{varieties-lemma-degree-effective-Cartier-divisor})
and the right hand side gives $\deg([D]_0)$ by
Lemma \ref{lemma-geometric-cap}.
Since
$$
[D]_0 = \sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{D, x}) [x] =
\sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{D, x}}(\mathcal{O}_{D, x}) [x]
$$
by definition, we see
$$
\deg([D]_0) = \sum\nolimits_{x \in D}
\text{length}_{\mathcal{O}_{D, x}}(\mathcal{O}_{D, x}) [\kappa(x) : k] =
\dim_k \Gamma(D, \mathcal{O}_D) = \deg(D)
$$
The penultimate equality by
Algebra, Lemma \ref{algebra-lemma-pushdown-module}
using that $D$ is affine.
\end{proof}

\noindent
Finally, we can tie everything up with the numerical intersections
defined in Varieties, Section \ref{varieties-section-num}.

\begin{lemma}
\label{lemma-degrees-and-numerical-intersections}
Let $k$ be a field. Let $X$ be a proper scheme over $k$.
Let $Z \subset X$ be a closed subscheme of dimension $d$.
Let $\mathcal{L}_1, \ldots, \mathcal{L}_d$ be invertible
$\mathcal{O}_X$-modules. Then
$$
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot Z) =
\deg(
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_1) \cap [Z]_d)
$$
where the left hand side is defined in
Varieties, Definition \ref{varieties-definition-intersection-number}.
In particular,
$$
\deg_\mathcal{L}(Z) = \deg(c_1(\mathcal{L})^d \cap [Z]_d)
$$
if $\mathcal{L}$ is an ample invertible $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
We will prove this by induction on $d$. If $d = 0$, then the result is
true by Varieties, Lemma \ref{varieties-lemma-chi-tensor-finite}.
Assume $d > 0$.

\medskip\noindent
Let $Z_i \subset Z$, $i = 1, \ldots, t$ be the irreducible components
of dimension $d$ with reduced induced scheme structure and let $m_i$ be the
multiplicity of $Z_i$ in $Z$. Then $[Z]_d = \sum m_i[Z_i]$ and
$c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [Z]_d$
is the sum of the cycles
$m_i c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [Z_i]$.
Since we have a similar decomposition for
$(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot Z)$ by
Varieties, Lemma \ref{varieties-lemma-numerical-polynomial-leading-term}
it suffices to prove the lemma in case $Z = X$
is a proper variety of dimension $d$ over $k$.

\medskip\noindent
By Chow's lemma there exists a birational proper morphism $f : Y \to X$
with $Y$ H-projective over $k$. See Cohomology of Schemes, Lemma
\ref{coherent-lemma-chow-Noetherian} and Remark
\ref{coherent-remark-chow-Noetherian}. Then
$$
(f^*\mathcal{L}_1 \cdots f^*\mathcal{L}_d \cdot Y) =
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot X)
$$
by Varieties, Lemma \ref{varieties-lemma-intersection-number-and-pullback}
and we have
$$
f_*(c_1(f^*\mathcal{L}_1) \cap \ldots \cap c_1(f^*\mathcal{L}_d) \cap [Y]) =
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [X]
$$
by Lemma \ref{lemma-pushforward-cap-c1}. Thus we may replace $X$ by $Y$
and assume that $X$ is projective over $k$.

\medskip\noindent
If $X$ is a proper $d$-dimensional projective variety, then we can
write $\mathcal{L}_1 = \mathcal{O}_X(D) \otimes \mathcal{O}_X(D')^{\otimes -1}$
for some effective Cartier divisors $D, D' \subset X$
by Divisors, Lemma
\ref{divisors-lemma-quasi-projective-Noetherian-pic-effective-Cartier}.
By additivity for both sides of the equation
(Varieties, Lemma \ref{varieties-lemma-intersection-number-additive} and
Lemma \ref{lemma-c1-cap-additive})
we reduce to the case $\mathcal{L}_1 = \mathcal{O}_X(D)$ for some
effective Cartier divisor $D$.
By Varieties, Lemma
\ref{varieties-lemma-numerical-intersection-effective-Cartier-divisor}
we have
$$
(\mathcal{L}_1 \cdots \mathcal{L}_d \cdot X) =
(\mathcal{L}_2 \cdots \mathcal{L}_d \cdot D)
$$
and by Lemma \ref{lemma-geometric-cap} we have
$$
c_1(\mathcal{L}_1) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [X] =
c_1(\mathcal{L}_2) \cap \ldots \cap c_1(\mathcal{L}_d) \cap [D]_{d - 1}
$$
Thus we obtain the result from our induction hypothesis.
\end{proof}







\section{Grothendieck-Riemann-Roch}
\label{section-grr}

\noindent
Let $(S, \delta)$ be as in
Situation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf
${\mathcal E}$ on $X$ of rank $r$.
Let $f : X \to Y$ be a proper smooth morphism.
Assume that $R^if_*\mathcal{E}$ are locally free
sheaves on $Y$ of finite rank.
The Grothendieck-Riemann-Roch theorem say in this
case that
$$
f_*(Todd(T_{X/Y}) ch(\mathcal{E}))
=
\sum (-1)^i ch(R^if_*\mathcal{E})
$$
Here
$$
T_{X/Y} = \SheafHom_{\mathcal{O}_X}(\Omega_{X/Y}, \mathcal{O}_X)
$$
is the relative tangent bundle of $X$ over $Y$. If $Y = \Spec(k)$
where $k$ is a field, then we can restate this as
$$
\chi(X, \mathcal{E}) = \deg(Todd(T_{X/k}) ch(\mathcal{E}))
$$
The theorem is more general and becomes easier to prove
when formulated in correct generality. We will return to
this elsewhere (insert future reference here).



\section{Appendix A: Alternative approach to key lemma}
\label{section-appendix-A}

\noindent
In this appendix we first define determinants $\det_\kappa(M)$
of finite length modules $M$ over local rings $(R, \mathfrak m, \kappa)$,
see Subsection \ref{subsection-determinants-finite-length}.
The determinant $\det_\kappa(M)$ is a $1$-dimensional $\kappa$-vector space.
We use this in Subsection \ref{subsection-periodic-complexes-determinants}
to define the determinant $\det_\kappa(M, \varphi, \psi) \in \kappa^*$
of an exact $(2, 1)$-periodic complex $(M, \varphi, \psi)$
with $M$ of finite length. In Subsection \ref{subsection-symbols}
we use these determinants to construct a tame symbol
$d_R(a, b) = \det_\kappa(R/ab, a, b)$ for a pair of nonzerodivisors
$a, b \in R$ when $R$ is Noetherian of dimension $1$.
Although there is no doubt that
$$
d_R(a, b) = \partial_R(a, b)
$$
where $\partial_R$ is as in Section \ref{section-tame-symbol},
we have not (yet) added the verification. The advantage of the
tame symbol as constructed in this appendix is that it extends
(for example) to pairs of injective endomorphisms $\varphi, \psi$
of a finite $R$-module $M$ of dimension $1$ such that
$\varphi(\psi(M)) = \psi(\varphi(M))$. In
Subsection \ref{subsection-length-determinant}
we relate Herbrand quotients and determinants.
An easy to state version of main the main result
(Proposition \ref{proposition-length-determinant-periodic-complex})
is the formula
$$
-e_R(M, \varphi, \psi) =
\text{ord}_R(\det\nolimits_K(M_K, \varphi, \psi))
$$
when $(M, \varphi, \psi)$ is a $(2, 1)$-periodic complex
whose Herbrand quotient $e_R$ (Definition \ref{definition-periodic-length})
is defined
over a $1$-dimensonal Noetherian local domain $R$ with fraction field $K$.
We use this proposition to give an alternative proof of the key lemma
(Lemma \ref{lemma-milnor-gersten-low-degree})
for the tame symbol constructed in this appendix, see
Lemma \ref{lemma-secondary-ramification}.


\subsection{Determinants of finite length modules}
\label{subsection-determinants-finite-length}

\noindent
The material in this section is related to the material in
the paper \cite{determinant} and to the material in the
thesis \cite{Joe}.

\medskip\noindent
Given any field $\kappa$ and any finite dimensional $\kappa$-vector space
$V$ we set $\det_\kappa(V) = \wedge^n(V)$ where $n = \dim_\kappa(V)$.
We will generalize this to finite length modules over local rings.
If the local ring contains a field, then the determinant constructed
below is a ``usual'' determinant, see
Remark \ref{remark-explain-determinant}.

\begin{definition}
\label{definition-determinant}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
Say $l = \text{length}_R(M)$.
\begin{enumerate}
\item Given elements $x_1, \ldots, x_r \in M$ we denote
$\langle x_1, \ldots, x_r \rangle = Rx_1 + \ldots + Rx_r$ the
$R$-submodule of $M$ generated by $x_1, \ldots, x_r$.
\item We will say an $l$-tuple of elements
$(e_1, \ldots, e_l)$ of $M$ is {\it admissible} if
$\mathfrak m e_i \subset \langle e_1, \ldots, e_{i - 1} \rangle$
for $i = 1, \ldots, l$.
\item A {\it symbol} $[e_1, \ldots, e_l]$ will mean
$(e_1, \ldots, e_l)$ is an admissible $l$-tuple.
\item An {\it admissible relation} between symbols is one of the following:
\begin{enumerate}
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$[e_1, \ldots, e_l] = 0$,
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have $e_a = \lambda e'_a + x$
with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$$
[e_1, \ldots, e_l] =
\overline{\lambda} [e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
$$
where $\overline{\lambda} \in \kappa^*$ is the image of $\lambda$ in
the residue field, and
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$ then
$$
[e_1, \ldots, e_l] =
- [e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l].
$$
\end{enumerate}
\item
We define the {\it determinant of the finite length $R$-module $M$} to be
$$
\det\nolimits_\kappa(M) =
\left\{
\frac{\kappa\text{-vector space generated by symbols}}
{\kappa\text{-linear combinations of admissible relations}}
\right\}
$$
\end{enumerate}
\end{definition}

\noindent
We stress that always $l = \text{length}_R(M)$. We also stress that
it does not follow that the symbol $[e_1, \ldots, e_l]$ is
additive in the entries (this will typically not be the case).
Before we can show that the determinant $\det_\kappa(M)$ actually
has dimension $1$ we have to show that it has dimension at most $1$.

\begin{lemma}
\label{lemma-dimension-at-most-one}
With notations as above we have $\dim_\kappa(\det_\kappa(M)) \leq 1$.
\end{lemma}

\begin{proof}
Fix an admissible sequence $(f_1, \ldots, f_l)$ of $M$ such that
$$
\text{length}_R(\langle f_1, \ldots, f_i\rangle) = i
$$
for $i = 1, \ldots, l$. Such an admissible sequence exists exactly because
$M$ has length $l$. We will show that any element of
$\det_\kappa(M)$ is a $\kappa$-multiple of the symbol
$[f_1, \ldots, f_l]$. This will prove the lemma.

\medskip\noindent
Let $(e_1, \ldots, e_l)$ be an admissible sequence of $M$.
It suffices to show that $[e_1, \ldots, e_l]$ is a multiple
of $[f_1, \ldots, f_l]$. First assume that
$\langle e_1, \ldots, e_l\rangle \not = M$. Then there exists
an $i \in [1, \ldots, l]$ such that
$e_i \in \langle e_1, \ldots, e_{i - 1}\rangle$. It immediately
follows from the first admissible relation that
$[e_1, \ldots, e_n] = 0$ in $\det_\kappa(M)$.
Hence we may assume that $\langle e_1, \ldots, e_l\rangle = M$.
In particular there exists a smallest index $i \in \{1, \ldots, l\}$
such that $f_1 \in \langle e_1, \ldots, e_i\rangle$. This means
that $e_i = \lambda f_1 + x$ with
$x \in \langle e_1, \ldots, e_{i - 1}\rangle$ and $\lambda \in R^*$.
By the second admissible relation this means that
$[e_1, \ldots, e_l] =
\overline{\lambda}[e_1, \ldots, e_{i - 1}, f_1, e_{i + 1}, \ldots, e_l]$.
Note that $\mathfrak m f_1 = 0$. Hence by applying the third
admissible relation $i - 1$ times we see that
$$
[e_1, \ldots, e_l] =
(-1)^{i - 1}\overline{\lambda}
[f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l].
$$
Note that it is also the case that
$ \langle f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l\rangle = M$.
By induction suppose we have proven that our original
symbol is equal to a scalar times
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
$$
for some admissible sequence $(f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l)$
whose elements generate $M$, i.e., \ with
$\langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l\rangle = M$.
Then we find the smallest $i$ such that
$f_{j + 1} \in \langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_i\rangle$
and we go through the same process as above to see that
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
=
(\text{scalar}) [f_1, \ldots, f_j, f_{j + 1}, e_{j + 1},
\ldots, \hat{e_i}, \ldots, e_l]
$$
Continuing in this vein we obtain the desired result.
\end{proof}

\noindent
Before we show that $\det_\kappa(M)$ always has dimension $1$,
let us show that it agrees with the usual top exterior power in
the case the module is a vector space over $\kappa$.

\begin{lemma}
\label{lemma-compare-det}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module
which is annihilated by $\mathfrak m$. Let $l = \dim_\kappa(M)$.
Then the map
$$
\det\nolimits_\kappa(M) \longrightarrow \wedge^l_\kappa(M),
\quad
[e_1, \ldots, e_l] \longmapsto e_1 \wedge \ldots \wedge e_l
$$
is an isomorphism.
\end{lemma}

\begin{proof}
It is clear that the rule described in the lemma gives a $\kappa$-linear
map since all of the admissible relations are satisfied by the usual
symbols $e_1 \wedge \ldots \wedge e_l$. It is also clearly a surjective
map. Since by Lemma \ref{lemma-dimension-at-most-one} the left hand side
has dimension at most one
we see that the map is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-determinant-dimension-one}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
The determinant $\det_\kappa(M)$ defined above is a $\kappa$-vector
space of dimension $1$. It is generated by the symbol
$[f_1, \ldots, f_l]$ for any admissible sequence such
that $\langle f_1, \ldots f_l \rangle = M$.
\end{lemma}

\begin{proof}
We know $\det_\kappa(M)$ has dimension at most $1$, and in fact that it
is generated by $[f_1, \ldots, f_l]$, by
Lemma \ref{lemma-dimension-at-most-one} and its proof.
We will show by induction on $l = \text{length}(M)$
that it is nonzero. For $l = 1$ it follows from Lemma \ref{lemma-compare-det}.
Choose a nonzero element $f \in M$
with $\mathfrak m f = 0$. Set $\overline{M} = M /\langle f \rangle$,
and denote the quotient map $x \mapsto \overline{x}$.
We will define a surjective map
$$
\psi : \det\nolimits_k(M) \to \det\nolimits_\kappa(\overline{M})
$$
which will prove the lemma since by induction the determinant of
$\overline{M}$ is nonzero.

\medskip\noindent
We define $\psi$ on symbols as follows.
Let $(e_1, \ldots, e_l)$ be an admissible sequence.
If $f \not \in \langle e_1, \ldots, e_l \rangle$ then
we simply set $\psi([e_1, \ldots, e_l]) = 0$.
If $f \in \langle e_1, \ldots, e_l \rangle$ then we choose
an $i$ minimal such that $f \in \langle e_1, \ldots, e_i \rangle$.
We may write $e_i = \lambda f + x$ for some unit $\lambda \in R$
and $x \in \langle e_1, \ldots, e_{i - 1} \rangle$.
In this case we set
$$
\psi([e_1, \ldots, e_l]) =
(-1)^i
\overline{\lambda}[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l].
$$
Note that it is indeed the case that
$(\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l)$
is an admissible sequence in $\overline{M}$, so this makes sense.
Let us show that extending this rule $\kappa$-linearly to
linear combinations of symbols does indeed lead to a map on
determinants. To do this we have to show that the admissible
relations are mapped to zero.

\medskip\noindent
Type (a) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Then $i \not = a$ and
$\overline{e}_a \in \langle \overline{e}_1, \ldots,
\hat{\overline{e}_i}, \ldots, \overline{e}_{a - 1}\rangle$ if $i < a$
or
$\overline{e}_a \in \langle \overline{e}_1, \ldots,
\overline{e}_{a - 1}\rangle$ if $i > a$.
Thus the same admissible relation for $\det_\kappa(\overline{M})$ forces
the symbol $[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]$
to be zero as desired.

\medskip\noindent
Type (b) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a = \lambda e'_a + x$ with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \mu f + y$ with $y \in \langle e_1, \ldots, e_{i - 1}\rangle$.
If $i < a$ then the desired equality is
$$
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
If $i > a$ then the desired equality is
$$
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
(-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
The interesting case is when $i = a$. In this case we have
$e_a = \lambda e'_a + x = \mu f + y$. Hence also
$e'_a = \lambda^{-1}(\mu f + y - x)$. Thus we see that
$$
\psi([e_1, \ldots, e_l])
= (-1)^i \overline{\mu}
[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]
=
\psi(
\overline{\lambda}
[e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
)
$$
as desired.

\medskip\noindent
Type (c) relations. Suppose that $(e_1, \ldots, e_l)$
is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \lambda f + x$ with $x \in \langle e_1, \ldots, e_{i - 1}\rangle$.
We distinguish $4$ cases:

\medskip\noindent
Case 1: $i < a - 1$. The desired equality is
\begin{align*}
& (-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l] \\
& =
(-1)^{i + 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
\end{align*}
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$.

\medskip\noindent
Case 2: $i > a$. The desired equality is
\begin{align*}
& (-1)^i
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l] \\
& =
(-1)^{i + 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
\end{align*}
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$.

\medskip\noindent
Case 3: $i = a$. We write $e_a = \lambda f + \mu e_{a - 1} + y$
with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$. Then
$$
\psi([e_1, \ldots, e_l]) =
(-1)^a
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
by definition. If $\overline{\mu}$ is nonzero, then we have
$e_{a - 1} = - \mu^{-1} \lambda f + \mu^{-1}e_a - \mu^{-1} y$
and we obtain
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^a
\overline{\mu^{-1}\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
by definition. Since in $\overline{M}$ we have
$\overline{e}_a = \mu \overline{e}_{a - 1} + \overline{y}$ we see
the two outcomes are equal by relation (a) for $\det_\kappa(\overline{M})$.
If on the other hand $\overline{\mu}$ is zero, then we can write
$e_a = \lambda f + y$ with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$
and we have
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^a
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which is equal to $\psi([e_1, \ldots, e_l])$.

\medskip\noindent
Case 4: $i = a - 1$. Here we have
$$
\psi([e_1, \ldots, e_l]) =
(-1)^{a - 1}
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\ldots,
\overline{e}_l]
$$
by definition. If $f \not \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$
then
$$
\psi(-[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]) =
(-1)^{a + 1}\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\ldots,
\overline{e}_l]
$$
Since $(-1)^{a - 1} = (-1)^{a + 1}$ the two expressions are the same.
Finally, assume $f \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$.
In this case we see that $e_{a - 1} = \lambda f + x$ with
$x \in \langle e_1, \ldots, e_{a - 2}\rangle$ and
$e_a = \mu f + y$ with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$
for units $\lambda, \mu \in R$.
We conclude that both
$e_a \in \langle e_1, \ldots, e_{a - 1} \rangle$ and
$e_{a - 1} \in \langle e_1, \ldots, e_{a - 2}, e_a\rangle$.
In this case a relation of type (a) applies to both
$[e_1, \ldots, e_l]$ and
$[e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l]$
and the compatibility of $\psi$ with these shown above to see that both
$$
\psi([e_1, \ldots, e_l])
\quad\text{and}\quad
\psi([e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l])
$$
are zero, as desired.

\medskip\noindent
At this point we have shown that $\psi$ is well defined, and all that remains
is to show that it is surjective. To see this let
$(\overline{f}_2, \ldots, \overline{f}_l)$ be an admissible sequence
in $\overline{M}$. We can choose lifts $f_2, \ldots, f_l \in M$, and
then $(f, f_2, \ldots, f_l)$ is an admissible sequence in $M$.
Since $\psi([f, f_2, \ldots, f_l]) = [f_2, \ldots, f_l]$ we win.
\end{proof}

\noindent
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Note that if $\varphi : M \to N$ is an
isomorphism of finite length $R$-modules, then we get an
isomorphism
$$
\det\nolimits_\kappa(\varphi) :
\det\nolimits_\kappa(M)
\to
\det\nolimits_\kappa(N)
$$
simply by the rule
$$
\det\nolimits_\kappa(\varphi)([e_1, \ldots, e_l])
=
[\varphi(e_1), \ldots, \varphi(e_l)]
$$
for any symbol $[e_1, \ldots, e_l]$ for $M$.
Hence we see that $\det\nolimits_\kappa$ is a functor
\begin{equation}
\label{equation-functor}
\left\{
\begin{matrix}
\text{finite length }R\text{-modules}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\end{equation}
This is typical for a ``determinant functor''
(see \cite{Knudsen}), as is the following additivity
property.

\begin{lemma}
\label{lemma-det-exact-sequences}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
For every short exact sequence
$$
0 \to K \to L \to M \to 0
$$
of finite length $R$-modules there exists a canonical isomorphism
$$
\gamma_{K \to L \to M} :
\det\nolimits_\kappa(K) \otimes_\kappa \det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(L)
$$
defined by the rule on nonzero symbols
$$
[e_1, \ldots, e_k]
\otimes
[\overline{f}_1, \ldots, \overline{f}_m]
\longrightarrow
[e_1, \ldots, e_k, f_1, \ldots, f_m]
$$
with the following properties:
\begin{enumerate}
\item For every isomorphism of short exact sequences, i.e., for
every commutative diagram
$$
\xymatrix{
0 \ar[r] &
K \ar[r] \ar[d]^u &
L \ar[r] \ar[d]^v &
M \ar[r] \ar[d]^w &
0 \\
0 \ar[r] &
K' \ar[r] &
L' \ar[r] &
M' \ar[r] &
0
}
$$
with short exact rows and isomorphisms $u, v, w$ we have
$$
\gamma_{K' \to L' \to M'} \circ
(\det\nolimits_\kappa(u) \otimes \det\nolimits_\kappa(w))
=
\det\nolimits_\kappa(v) \circ
\gamma_{K \to L \to M},
$$
\item for every commutative square of finite length $R$-modules
with exact rows and columns
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] & A \ar[r] \ar[d] & B \ar[r] \ar[d] & C \ar[r] \ar[d] & 0 \\
0 \ar[r] & D \ar[r] \ar[d] & E \ar[r] \ar[d] & F \ar[r] \ar[d] & 0 \\
0 \ar[r] & G \ar[r] \ar[d] & H \ar[r] \ar[d] & I \ar[r] \ar[d] & 0 \\
& 0  & 0  & 0  &
}
$$
the following diagram is commutative
$$
\xymatrix{
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(I)
\ar[dd]_{\epsilon}
\ar[rrr]_-{\gamma_{A \to B \to C} \otimes \gamma_{G \to H \to I}}
& & &
\det\nolimits_\kappa(B) \otimes
\det\nolimits_\kappa(H)
\ar[d]^{\gamma_{B \to E \to H}}
\\
& & & \det\nolimits_\kappa(E)
\\
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(I)
\ar[rrr]^-{\gamma_{A \to D \to G} \otimes \gamma_{C \to F \to I}}
& & &
\det\nolimits_\kappa(D) \otimes
\det\nolimits_\kappa(F)
\ar[u]_{\gamma_{D \to E \to F}}
}
$$
where $\epsilon$ is the switch of the factors in the tensor product
times $(-1)^{cg}$ with $c = \text{length}_R(C)$ and $g = \text{length}_R(G)$,
and
\item the map $\gamma_{K \to L \to M}$ agrees with the usual isomorphism
if $0 \to K \to L \to M \to 0$ is actually a short exact sequence
of $\kappa$-vector spaces.
\end{enumerate}
\end{lemma}

\begin{proof}
The significance of taking nonzero symbols in the explicit description
of the map $\gamma_{K \to L \to M}$ is simply that if $(e_1, \ldots, e_l)$
is an admissible sequence in $K$, and
$(\overline{f}_1, \ldots, \overline{f}_m)$ is an admissible sequence in
$M$, then it is not guaranteed that $(e_1, \ldots, e_l, f_1, \ldots, f_m)$
is an admissible sequence in $L$ (where of course $f_i \in L$ signifies
a lift of $\overline{f}_i$). However, if the symbol
$[e_1, \ldots, e_l]$ is nonzero in $\det_\kappa(K)$, then
necessarily $K = \langle e_1, \ldots, e_k\rangle$ (see
proof of Lemma \ref{lemma-dimension-at-most-one}), and
in this case it is true that $(e_1, \ldots, e_k, f_1, \ldots, f_m)$
is an admissible sequence.
Moreover, by the admissible relations of type (b) for $\det_\kappa(L)$
we see that the value of $[e_1, \ldots, e_k, f_1, \ldots, f_m]$ in
$\det_\kappa(L)$ is independent of the choice of the lifts
$f_i$ in this case also. Given this remark, it is clear
that an admissible relation for $e_1, \ldots, e_k$ in $K$
translates into an admissible relation among
$e_1, \ldots, e_k, f_1, \ldots, f_m$ in $L$, and
similarly for an admissible relation among the
$\overline{f}_1, \ldots, \overline{f}_m$.
Thus $\gamma$ defines a linear map of vector spaces as claimed in the lemma.

\medskip\noindent
By Lemma \ref{lemma-determinant-dimension-one} we know
$\det_\kappa(L)$ is generated by any single
symbol $[x_1, \ldots, x_{k + m}]$ such that
$(x_1, \ldots, x_{k + m})$ is an admissible sequence
with $L = \langle x_1, \ldots, x_{k + m}\rangle$. Hence it is
clear that the map $\gamma_{K \to L \to M}$ is surjective and
hence an isomorphism.

\medskip\noindent
Property (1) holds because
\begin{eqnarray*}
& & \det\nolimits_\kappa(v)([e_1, \ldots, e_k, f_1, \ldots, f_m]) \\
& = &
[v(e_1), \ldots, v(e_k), v(f_1), \ldots, v(f_m)] \\
& = &
\gamma_{K' \to L' \to M'}([u(e_1), \ldots, u(e_k)]
\otimes [w(f_1), \ldots, w(f_m)]).
\end{eqnarray*}
Property (2) means that given a symbol
$[\alpha_1, \ldots, \alpha_a]$ generating $\det_\kappa(A)$,
a symbol $[\gamma_1, \ldots, \gamma_c]$ generating $\det_\kappa(C)$,
a symbol $[\zeta_1, \ldots, \zeta_g]$ generating $\det_\kappa(G)$, and
a symbol $[\iota_1, \ldots, \iota_i]$ generating $\det_\kappa(I)$
we have
\begin{eqnarray*}
& & [\alpha_1, \ldots, \alpha_a, \tilde\gamma_1, \ldots, \tilde\gamma_c,
\tilde\zeta_1, \ldots, \tilde\zeta_g, \tilde\iota_1, \ldots, \tilde\iota_i] \\
& = &
(-1)^{cg} [\alpha_1, \ldots, \alpha_a, \tilde\zeta_1, \ldots, \tilde\zeta_g,
\tilde\gamma_1, \ldots, \tilde\gamma_c, \tilde\iota_1, \ldots, \tilde\iota_i]
\end{eqnarray*}
(for suitable lifts $\tilde{x}$ in $E$) in $\det_\kappa(E)$.
This holds because we may use the admissible relations of type (c)
$cg$ times in the following order: move the
$\tilde\zeta_1$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_1 \subset A$),
then move $\tilde\zeta_2$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_2 \subset A + R\tilde\zeta_1$),
and so on.

\medskip\noindent
Part (3) of the lemma is obvious.
This finishes the proof.
\end{proof}

\noindent
We can use the maps $\gamma$ of the lemma to define more general maps
$\gamma$ as follows. Suppose that $(R, \mathfrak m, \kappa)$ is a
local ring. Let $M$ be a finite length $R$-module and suppose we
are given a finite filtration (see
Homology, Definition \ref{homology-definition-filtered})
$$
M = F^n \supset F^{n + 1} \supset \ldots \supset F^{m - 1} \supset F^m = 0.
$$
Then there is a canonical isomorphism
$$
\gamma_{(M, F)} :
\bigotimes\nolimits_i \det\nolimits_\kappa(F^i/F^{i + 1})
\longrightarrow
\det\nolimits_\kappa(M)
$$
well defined up to sign(!). One can make the sign explicit either by
giving a well defined order of the terms in the tensor product (starting with
higher indices unfortunately), and by thinking of the target category for
the functor $\det_\kappa$ as the category of
$1$-dimensional super vector spaces. See \cite[Section 1]{determinant}.

\medskip\noindent
Here is another typical result for determinant functors.
It is not hard to show. The tricky part is usually to show the
existence of a determinant functor.

\begin{lemma}
\label{lemma-uniqueness-det}
Let $(R, \mathfrak m, \kappa)$ be any local ring.
The functor
$$
\det\nolimits_\kappa :
\left\{
\begin{matrix}
\text{finite length }R\text{-modules} \\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces} \\
\text{with isomorphisms}
\end{matrix}
\right\}
$$
endowed with the maps $\gamma_{K \to L \to M}$ is characterized by
the following properties
\begin{enumerate}
\item its restriction to the subcategory of modules annihilated
by $\mathfrak m$ is isomorphic to the usual determinant functor
(see Lemma \ref{lemma-compare-det}), and
\item (1), (2) and (3) of Lemma \ref{lemma-det-exact-sequences}
hold.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-determinant-quotient-ring}
Let $(R', \mathfrak m') \to (R, \mathfrak m)$ be a local ring
homomorphism which induces an isomorphism on residue fields $\kappa$.
Then for every finite length $R$-module the restriction $M_{R'}$
is a finite length $R'$-module and there is a canonical isomorphism
$$
\det\nolimits_{R, \kappa}(M)
\longrightarrow
\det\nolimits_{R', \kappa}(M_{R'})
$$
This isomorphism is functorial in $M$ and compatible with the
isomorphisms $\gamma_{K \to L \to M}$ of Lemma \ref{lemma-det-exact-sequences}
defined for $\det_{R, \kappa}$ and $\det_{R', \kappa}$.
\end{lemma}

\begin{proof}
If the length of $M$ as an $R$-module is $l$, then the length
of $M$ as an $R'$-module (i.e., $M_{R'}$) is $l$ as well, see
Algebra, Lemma \ref{algebra-lemma-pushdown-module}.
Note that an admissible sequence $x_1, \ldots, x_l$ of $M$
over $R$ is an admissible sequence of $M$ over $R'$ as $\mathfrak m'$
maps into $\mathfrak m$.
The isomorphism is obtained by mapping the symbol
$[x_1, \ldots, x_l] \in \det\nolimits_{R, \kappa}(M)$
to the corresponding symbol
$[x_1, \ldots, x_l] \in \det\nolimits_{R', \kappa}(M)$.
It is immediate to verify that this is functorial for
isomorphisms and compatible with the isomorphisms
$\gamma$ of Lemma \ref{lemma-det-exact-sequences}.
\end{proof}

\begin{remark}
\label{remark-explain-determinant}
Let $(R, \mathfrak m, \kappa)$ be a local ring and assume either
the characteristic of $\kappa$ is zero or it is $p$ and $p R = 0$.
Let $M_1, \ldots, M_n$ be finite length $R$-modules.
We will show below that there exists an
ideal $I \subset \mathfrak m$ annihilating $M_i$ for $i = 1, \ldots, n$
and a section $\sigma : \kappa \to R/I$ of the canonical surjection
$R/I \to \kappa$. The restriction $M_{i, \kappa}$ of $M_i$ via $\sigma$
is a $\kappa$-vector space of dimension $l_i = \text{length}_R(M_i)$ and
using Lemma \ref{lemma-determinant-quotient-ring} we see that
$$
\det\nolimits_\kappa(M_i) = \wedge_\kappa^{l_i}(M_{i, \kappa})
$$
These isomorphisms are compatible with the isomorphisms
$\gamma_{K \to M \to L}$ of Lemma \ref{lemma-det-exact-sequences}
for short exact sequences of finite length $R$-modules annihilated
by $I$. The conclusion is that verifying a property of
$\det_\kappa$ often reduces to verifying corresponding properties
of the usual determinant on the category finite dimensional vector
spaces.

\medskip\noindent
For $I$ we can take the annihilator
(Algebra, Definition \ref{algebra-definition-annihilator})
of the module $M = \bigoplus M_i$. In this case we see that
$R/I \subset \text{End}_R(M)$ hence has finite length.
Thus $R/I$ is an Artinian local ring with residue field $\kappa$.
Since an Artinian local ring is complete we see that $R/I$
has a coefficient ring by the Cohen structure theorem
(Algebra, Theorem \ref{algebra-theorem-cohen-structure-theorem})
which is a field by our assumption on $R$.
\end{remark}

\noindent
Here is a case where we can compute the determinant of a linear map.
In fact there is nothing mysterious about this in any case, see
Example \ref{example-determinant-map} for a random example.

\begin{lemma}
\label{lemma-times-u-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $u \in R^*$ be a unit.
Let $M$ be a module of finite length over $R$.
Denote $u_M : M \to M$ the map multiplication by $u$.
Then
$$
\det\nolimits_\kappa(u_M) :
\det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is multiplication by $\overline{u}^l$ where $l = \text{length}_R(M)$
and $\overline{u} \in \kappa^*$ is the image of $u$.
\end{lemma}

\begin{proof}
Denote $f_M \in \kappa^*$ the element such that
$\det\nolimits_\kappa(u_M) = f_M \text{id}_{\det\nolimits_\kappa(M)}$.
Suppose that $0 \to K \to L \to M \to 0$ is a short
exact sequence of finite $R$-modules. Then we see that
$u_k$, $u_L$, $u_M$ give an isomorphism of short exact sequences.
Hence by Lemma \ref{lemma-det-exact-sequences} (1) we conclude that
$f_K f_M = f_L$.
This means that by induction on length it suffices to prove the
lemma in the case of length $1$ where it is trivial.
\end{proof}

\begin{example}
\label{example-determinant-map}
Consider the local ring $R = \mathbf{Z}_p$.
Set $M = \mathbf{Z}_p/(p^2) \oplus \mathbf{Z}_p/(p^3)$.
Let $u : M \to M$ be the map given by the matrix
$$
u =
\left(
\begin{matrix}
a & b \\
pc & d
\end{matrix}
\right)
$$
where $a, b, c, d \in \mathbf{Z}_p$, and $a, d \in \mathbf{Z}_p^*$.
In this case $\det_\kappa(u)$ equals multiplication by
$a^2d^3 \bmod p \in \mathbf{F}_p^*$. This can easily be seen
by consider the effect of $u$ on the symbol
$[p^2e, pe, pf, e, f]$ where $e = (0 , 1) \in M$ and
$f = (1, 0) \in M$.
\end{example}





\subsection{Periodic complexes and determinants}
\label{subsection-periodic-complexes-determinants}

\noindent
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. We are going to use the determinant construction to define
an invariant of this situation. See
Subsection \ref{subsection-determinants-finite-length}.
Let us abbreviate
$K_\varphi = \Ker(\varphi)$,
$I_\varphi = \Im(\varphi)$,
$K_\psi = \Ker(\psi)$, and
$I_\psi = \Im(\psi)$.
The short exact sequences
$$
0 \to K_\varphi \to M \to I_\varphi \to 0, \quad
0 \to K_\psi \to M \to I_\psi \to 0
$$
give isomorphisms
$$
\gamma_\varphi :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M), \quad
\gamma_\psi :
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
\longrightarrow
\det\nolimits_\kappa(M),
$$
see Lemma \ref{lemma-det-exact-sequences}.
On the other hand the exactness of the complex gives equalities
$K_\varphi = I_\psi$, and $K_\psi = I_\varphi$
and hence an isomorphism
$$
\sigma :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
$$
by switching the factors. Using this notation we can define our invariant.

\begin{definition}
\label{definition-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. The {\it determinant of $(M, \varphi, \psi)$} is
the element
$$
\det\nolimits_\kappa(M, \varphi, \psi) \in \kappa^*
$$
such that the composition
$$
\det\nolimits_\kappa(M)
\xrightarrow{\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}}
\det\nolimits_\kappa(M)
$$
is multiplication by
$(-1)^{\text{length}_R(I_\varphi)\text{length}_R(I_\psi)}
\det\nolimits_\kappa(M, \varphi, \psi)$.
\end{definition}

\begin{remark}
\label{remark-more-elementary}
Here is a more down to earth description of the determinant
introduced above. Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Let us abbreviate $I_\varphi = \Im(\varphi)$,
$I_\psi = \Im(\psi)$ as above.
Assume that $\text{length}_R(I_\varphi) = a$ and
$\text{length}_R(I_\psi) = b$, so that $a + b = \text{length}_R(M)$
by exactness. Choose admissible sequences
$x_1, \ldots, x_a \in I_\varphi$ and $y_1, \ldots, y_b \in I_\psi$
such that the symbol $[x_1, \ldots, x_a]$ generates $\det_\kappa(I_\varphi)$
and the symbol $[x_1, \ldots, x_b]$ generates $\det_\kappa(I_\psi)$.
Choose $\tilde x_i \in M$ such that $\varphi(\tilde x_i) = x_i$.
Choose $\tilde y_j \in M$ such that $\psi(\tilde y_j) = y_j$.
Then $\det_\kappa(M, \varphi, \psi)$ is characterized
by the equality
$$
[x_1, \ldots, x_a, \tilde y_1, \ldots, \tilde y_b]
=
(-1)^{ab} \det\nolimits_\kappa(M, \varphi, \psi)
[y_1, \ldots, y_b, \tilde x_1, \ldots, \tilde x_a]
$$
in $\det_\kappa(M)$. This also explains the sign.
\end{remark}

\begin{lemma}
\label{lemma-periodic-determinant-shift}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. Then
$$
\det\nolimits_\kappa(M, \varphi, \psi)
\det\nolimits_\kappa(M, \psi, \varphi)
= 1.
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant-sign}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \varphi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \varphi)$ is
exact. Then $\text{length}_R(M) = 2 \text{length}_R(\Im(\varphi))$
and
$$
\det\nolimits_\kappa(M, \varphi, \varphi)
=
(-1)^{\text{length}_R(\Im(\varphi))}
=
(-1)^{\frac{1}{2}\text{length}_R(M)}
$$
\end{lemma}

\begin{proof}
Follows directly from the sign rule in the definitions.
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant-easy-case}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
\begin{enumerate}
\item if $\varphi : M \to M$ is an isomorphism then
$\det_\kappa(M, \varphi, 0) = \det_\kappa(\varphi)$.
\item if $\psi : M \to M$ is an isomorphism then
$\det_\kappa(M, 0, \psi) = \det_\kappa(\psi)^{-1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove (1). Set $\psi = 0$. Then we may, with notation
as above Definition \ref{definition-periodic-determinant}, identify
$K_\varphi = I_\psi = 0$, $I_\varphi = K_\psi = M$.
With these identifications, the map
$$
\gamma_\varphi :
\kappa \otimes \det\nolimits_\kappa(M)
=
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is identified with $\det_\kappa(\varphi^{-1})$. On the other hand the
map $\gamma_\psi$ is identified with the identity map. Hence
$\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$ is equal
to $\det_\kappa(\varphi)$ in this case. Whence the result.
We omit the proof of (2).
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Suppose that we have a short exact sequence of
$(2, 1)$-periodic complexes
$$
0 \to (M_1, \varphi_1, \psi_1)
\to (M_2, \varphi_2, \psi_2)
\to (M_3, \varphi_3, \psi_3)
\to 0
$$
with all $M_i$ of finite length, and each $(M_1, \varphi_1, \psi_1)$ exact.
Then
$$
\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3).
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
Let us abbreviate
$I_{\varphi, i} = \Im(\varphi_i)$,
$K_{\varphi, i} = \Ker(\varphi_i)$,
$I_{\psi, i} = \Im(\psi_i)$, and
$K_{\psi, i} = \Ker(\psi_i)$.
Observe that we have a commutative square
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] &
K_{\varphi, 1} \ar[r] \ar[d] &
K_{\varphi, 2} \ar[r] \ar[d] &
K_{\varphi, 3} \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M_1 \ar[r] \ar[d] &
M_2 \ar[r] \ar[d] &
M_3 \ar[r] \ar[d] &
0 \\
0 \ar[r] &
I_{\varphi, 1} \ar[r] \ar[d] &
I_{\varphi, 2} \ar[r] \ar[d] &
I_{\varphi, 3} \ar[r] \ar[d] &
0 \\
& 0  & 0  & 0  &
}
$$
of finite length $R$-modules with exact rows and columns.
The top row is exact since it can be identified with the
sequence $I_{\psi, 1} \to I_{\psi, 2} \to I_{\psi, 3} \to 0$
of images, and similarly for the bottom row. There is a similar diagram
involving the modules $I_{\psi, i}$ and $K_{\psi, i}$.
By definition $\det_\kappa(M_2, \varphi_2, \psi_2)$
corresponds, up to a sign, to the composition of the left vertical maps
in the following diagram
$$
\xymatrix{
\det_\kappa(M_1) \otimes
\det_\kappa(M_3) \ar[r]^\gamma
\ar[d]^{\gamma^{-1} \otimes \gamma^{-1}} &
\det_\kappa(M_2)
\ar[d]^{\gamma^{-1}} \\
\det\nolimits_\kappa(K_{\varphi, 1})
\otimes
\det\nolimits_\kappa(I_{\varphi, 1})
\otimes
\det\nolimits_\kappa(K_{\varphi, 3})
\otimes
\det\nolimits_\kappa(I_{\varphi, 3})
\ar[d]^{\sigma \otimes \sigma}
\ar[r]^-{\gamma \otimes \gamma} &
\det\nolimits_\kappa(K_{\varphi, 2})
\otimes
\det\nolimits_\kappa(I_{\varphi, 2})
\ar[d]^\sigma
\\
\det\nolimits_\kappa(K_{\psi, 1})
\otimes
\det\nolimits_\kappa(I_{\psi, 1})
\otimes
\det\nolimits_\kappa(K_{\psi, 3})
\otimes
\det\nolimits_\kappa(I_{\psi, 3})
\ar[d]^{\gamma \otimes \gamma}
\ar[r]^-{\gamma \otimes \gamma}
&
\det\nolimits_\kappa(K_{\psi, 2})
\otimes
\det\nolimits_\kappa(I_{\psi, 2})
\ar[d]^\gamma \\
\det_\kappa(M_1)
\otimes
\det_\kappa(M_3) \ar[r]^\gamma
&
\det_\kappa(M_2)
}
$$
The top and bottom squares are commutative up to sign
by applying Lemma \ref{lemma-det-exact-sequences} (2).
The middle square is trivially
commutative (we are just switching factors). Hence we see
that
$\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\epsilon \det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3)
$
for some sign $\epsilon$. And the sign can be worked out, namely
the outer rectangle in the diagram above commutes up to
\begin{eqnarray*}
\epsilon & = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(K_{\varphi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(K_{\psi, 3})} \\
& = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(I_{\psi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(I_{\varphi, 3})}
\end{eqnarray*}
(proof omitted). It follows easily from this that the signs
work out as well.
\end{proof}

\begin{example}
\label{example-dual-numbers}
Let $k$ be a field.
Consider the ring $R = k[T]/(T^2)$ of dual numbers over $k$.
Denote $t$ the class of $T$ in $R$.
Let $M = R$ and $\varphi = ut$, $\psi = vt$ with $u, v \in k^*$.
In this case $\det_k(M)$ has generator $e = [t, 1]$.
We identify $I_\varphi = K_\varphi = I_\psi = K_\psi = (t)$.
Then $\gamma_\varphi(t \otimes t) = u^{-1}[t, 1]$
(since $u^{-1} \in M$ is a lift of $t \in I_\varphi$)
and $\gamma_\psi(t \otimes t) = v^{-1}[t, 1]$ (same reason).
Hence we see that $\det_k(M, \varphi, \psi) = -u/v \in k^*$.
\end{example}

\begin{example}
\label{example-Zp}
Let $R = \mathbf{Z}_p$ and let $M = \mathbf{Z}_p/(p^l)$.
Let $\varphi = p^b u$ and $\varphi = p^a v$ with $a, b \geq 0$,
$a + b = l$ and $u, v \in \mathbf{Z}_p^*$.
Then a computation as in Example \ref{example-dual-numbers}
shows that
\begin{eqnarray*}
\det\nolimits_{\mathbf{F}_p}(\mathbf{Z}_p/(p^l), p^bu, p^av) & = &
(-1)^{ab}u^a/v^b \bmod p \\
& = &
(-1)^{\text{ord}_p(\alpha)\text{ord}_p(\beta)}
\frac{\alpha^{\text{ord}_p(\beta)}}{\beta^{\text{ord}_p(\alpha)}} \bmod p
\end{eqnarray*}
with $\alpha = p^bu, \beta = p^av \in \mathbf{Z}_p$.
See Lemma \ref{lemma-symbol-is-usual-tame-symbol}
for a more general case (and a proof).
\end{example}

\begin{example}
\label{example-generic-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus b}$ be $l = a + b$ dimensional.
Let $\varphi$ and $\psi$ be the following diagonal matrices
$$
\varphi = \text{diag}(u_1, \ldots, u_a, 0, \ldots, 0),
\quad
\psi = \text{diag}(0, \ldots, 0, v_1, \ldots, v_b)
$$
with $u_i, v_j \in k^*$. In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
\frac{u_1 \ldots u_a}{v_1 \ldots v_b}.
$$
This can be seen by a direct computation or by computing in case $l = 1$
and using the additivity of Lemma \ref{lemma-periodic-determinant}.
\end{example}

\begin{example}
\label{example-special-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus a}$ be $l = 2a$ dimensional.
Let $\varphi$ and $\psi$ be the following block matrices
$$
\varphi =
\left(
\begin{matrix}
0 & U \\
0 & 0
\end{matrix}
\right),
\quad
\psi =
\left(
\begin{matrix}
0 & V \\
0 & 0
\end{matrix}
\right),
$$
with $U, V \in \text{Mat}(a \times a, k)$ invertible.
In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
(-1)^a\frac{\det(U)}{\det(V)}.
$$
This can be seen by a direct computation.
The case $a = 1$ is similar to the computation in
Example \ref{example-dual-numbers}.
\end{example}

\begin{example}
\label{example-a-la-oort}
Let $R = k$ be a field.
Let $M = k^{\oplus 4}$.
Let
$$
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
u_1 &   0 &   0 &   0 \\
  0 &   0 &   0 &   0 \\
  0 &   0 & u_2 &   0
\end{matrix}
\right)
\quad
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
  0 &   0 & v_2 &   0 \\
  0 &   0 &   0 &   0 \\
v_1 &   0 &   0 &   0
\end{matrix}
\right)
\quad
$$
with $u_1, u_2, v_1, v_2 \in k^*$.
Then we have
$$
\det\nolimits_k(M, \varphi, \psi) = -\frac{u_1u_2}{v_1v_2}.
$$
\end{example}

\noindent
Next we come to the analogue of the fact that the determinant
of a composition of linear endomorphisms is the product of
the determinants. To avoid very long formulae we
write $I_\varphi = \Im(\varphi)$, and
$K_\varphi = \Ker(\varphi)$
for any $R$-module map $\varphi : M \to M$.
We also denote $\varphi\psi = \varphi \circ \psi$
for a pair of morphisms $\varphi, \psi : M \to M$.

\begin{lemma}
\label{lemma-multiplicativity-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
Let $\alpha, \beta, \gamma$ be endomorphisms of $M$.
Assume that
\begin{enumerate}
\item $I_\alpha = K_{\beta\gamma}$, and similarly for any permutation
of $\alpha, \beta, \gamma$,
\item $K_\alpha = I_{\beta\gamma}$, and similarly for any permutation
of $\alpha, \beta, \gamma$.
\end{enumerate}
Then
\begin{enumerate}
\item The triple $(M, \alpha, \beta\gamma)$
is an exact $(2, 1)$-periodic complex.
\item The triple $(I_\gamma, \alpha, \beta)$
is an exact $(2, 1)$-periodic complex.
\item The triple $(M/K_\beta, \alpha, \gamma)$
is an exact $(2, 1)$-periodic complex.
\item We have
$$
\det\nolimits_\kappa(M, \alpha, \beta\gamma)
=
\det\nolimits_\kappa(I_\gamma, \alpha, \beta)
\det\nolimits_\kappa(M/K_\beta, \alpha, \gamma).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that the assumptions imply part (1) of the lemma.

\medskip\noindent
To see part (1) note that the assumptions imply that
$I_{\gamma\alpha} = I_{\alpha\gamma}$, and similarly for kernels
and any other pair of morphisms.
Moreover, we see that
$I_{\gamma\beta} =I_{\beta\gamma} = K_\alpha \subset I_\gamma$ and
similarly for any other pair. In particular we get a short exact sequence
$$
0 \to I_{\beta\gamma} \to I_\gamma \xrightarrow{\alpha} I_{\alpha\gamma} \to 0
$$
and similarly we get a short exact sequence
$$
0 \to I_{\alpha\gamma} \to I_\gamma \xrightarrow{\beta} I_{\beta\gamma} \to 0.
$$
This proves $(I_\gamma, \alpha, \beta)$ is an exact $(2, 1)$-periodic
complex. Hence part (2) of the lemma holds.

\medskip\noindent
To see that $\alpha$, $\gamma$ give well defined endomorphisms
of $M/K_\beta$ we have to check that $\alpha(K_\beta) \subset K_\beta$
and $\gamma(K_\beta) \subset K_\beta$. This is true because
$\alpha(K_\beta) = \alpha(I_{\gamma\alpha}) = I_{\alpha\gamma\alpha}
\subset I_{\alpha\gamma} = K_\beta$, and similarly in the other case.
The kernel of the map $\alpha : M/K_\beta \to M/K_\beta$ is
$K_{\beta\alpha}/K_\beta = I_\gamma/K_\beta$. Similarly,
the kernel of $\gamma : M/K_\beta \to M/K_\beta$ is equal to
$I_\alpha/K_\beta$. Hence we conclude that (3) holds.

\medskip\noindent
We introduce $r = \text{length}_R(K_\alpha)$,
$s = \text{length}_R(K_\beta)$ and $t = \text{length}_R(K_\gamma)$.
By the exact sequences above and our hypotheses we have
$\text{length}_R(I_\alpha) = s + t$, $\text{length}_R(I_\beta) = r + t$,
$\text{length}_R(I_\gamma) = r + s$, and
$\text{length}(M) = r + s + t$.
Choose
\begin{enumerate}
\item an admissible sequence $x_1, \ldots, x_r \in K_\alpha$
generating $K_\alpha$
\item an admissible sequence $y_1, \ldots, y_s \in K_\beta$
generating $K_\beta$,
\item an admissible sequence $z_1, \ldots, z_t \in K_\gamma$
generating $K_\gamma$,
\item elements $\tilde x_i \in M$ such that $\beta\gamma\tilde x_i = x_i$,
\item elements $\tilde y_i \in M$ such that $\alpha\gamma\tilde y_i = y_i$,
\item elements $\tilde z_i \in M$ such that $\beta\alpha\tilde z_i = z_i$.
\end{enumerate}
With these choices the sequence
$y_1, \ldots, y_s, \alpha\tilde z_1, \ldots, \alpha\tilde z_t$
is an admissible sequence in $I_\alpha$ generating it.
Hence, by Remark \ref{remark-more-elementary} the determinant
$D = \det_\kappa(M, \alpha, \beta\gamma)$ is the
unique element of $\kappa^*$ such that
\begin{align*}
[y_1, \ldots, y_s,
\alpha\tilde z_1, \ldots, \alpha\tilde z_s,
\tilde x_1, \ldots, \tilde x_r] \\
= (-1)^{r(s + t)} D
[x_1, \ldots, x_r,
\gamma\tilde y_1, \ldots, \gamma\tilde y_s,
\tilde z_1, \ldots, \tilde z_t]
\end{align*}
By the same remark, we see that
$D_1 = \det_\kappa(M/K_\beta, \alpha, \gamma)$
is characterized by
$$
[y_1, \ldots, y_s,
\alpha\tilde z_1, \ldots, \alpha\tilde z_t,
\tilde x_1, \ldots, \tilde x_r]
=
(-1)^{rt} D_1
[y_1, \ldots, y_s,
\gamma\tilde x_1, \ldots, \gamma\tilde x_r,
\tilde z_1, \ldots, \tilde z_t]
$$
By the same remark, we see that
$D_2 = \det_\kappa(I_\gamma, \alpha, \beta)$ is characterized by
$$
[y_1, \ldots, y_s,
\gamma\tilde x_1, \ldots, \gamma\tilde x_r,
\tilde z_1, \ldots, \tilde z_t]
=
(-1)^{rs} D_2
[x_1, \ldots, x_r,
\gamma\tilde y_1, \ldots, \gamma\tilde y_s,
\tilde z_1, \ldots, \tilde z_t]
$$
Combining the formulas above we see that $D = D_1 D_2$
as desired.
\end{proof}


\begin{lemma}
\label{lemma-tricky}
Let $R$ be a local ring with residue field $\kappa$.
Let $\alpha : (M, \varphi, \psi) \to (M', \varphi', \psi')$
be a morphism of $(2, 1)$-periodic complexes over $R$.
Assume
\begin{enumerate}
\item $M$, $M'$ have finite length,
\item $(M, \varphi, \psi)$, $(M', \varphi', \psi')$ are exact,
\item the maps $\varphi$, $\psi$ induce the zero map on
$K = \Ker(\alpha)$, and
\item the maps $\varphi$, $\psi$ induce the zero map on
$Q = \Coker(\alpha)$.
\end{enumerate}
Denote $N = \alpha(M) \subset M'$. We obtain two short exact sequences
of $(2, 1)$-periodic complexes
$$
\begin{matrix}
0 \to (N, \varphi', \psi') \to (M', \varphi', \psi') \to (Q, 0, 0) \to 0 \\
0 \to (K, 0, 0) \to (M, \varphi, \psi) \to (N, \varphi', \psi') \to 0
\end{matrix}
$$
which induce two isomorphisms $\alpha_i : Q \to K$, $i = 0, 1$. Then
$$
\det\nolimits_\kappa(M, \varphi, \psi)
=
\det\nolimits_\kappa(\alpha_0^{-1} \circ \alpha_1)
\det\nolimits_\kappa(M', \varphi', \psi')
$$
In particular, if $\alpha_0 = \alpha_1$, then
$\det\nolimits_\kappa(M, \varphi, \psi) =
\det\nolimits_\kappa(M', \varphi', \psi')$.
\end{lemma}

\begin{proof}
There are (at least) two ways to prove this lemma. One is to produce an
enormous commutative diagram using the properties of the determinants.
The other is to use the characterization of the determinants in terms
of admissible sequences of elements. It is the second approach that we
will use.

\medskip\noindent
First let us explain precisely what the maps $\alpha_i$ are.
Namely, $\alpha_0$ is the composition
$$
\alpha_0 : Q = H^0(Q, 0, 0) \to H^1(N, \varphi', \psi') \to H^2(K, 0, 0) = K
$$
and $\alpha_1$ is the composition
$$
\alpha_1 : Q = H^1(Q, 0, 0) \to H^2(N, \varphi', \psi') \to H^3(K, 0, 0) = K
$$
coming from the boundary maps of the short exact sequences of complexes
displayed in the lemma. The fact that the
complexes $(M, \varphi, \psi)$, $(M', \varphi', \psi')$ are exact
implies these maps are isomorphisms.

\medskip\noindent
We will use the notation $I_\varphi = \Im(\varphi)$,
$K_\varphi = \Ker(\varphi)$ and similarly for the other maps.
Exactness for $M$ and $M'$
means that $K_\varphi = I_\psi$ and three similar equalities.
We introduce $k = \text{length}_R(K)$, $a = \text{length}_R(I_\varphi)$,
$b = \text{length}_R(I_\psi)$. Then we see that $\text{length}_R(M) = a + b$,
and $\text{length}_R(N) = a + b - k$, $\text{length}_R(Q) = k$
and $\text{length}_R(M') = a + b$. The exact sequences below will show
that also $\text{length}_R(I_{\varphi'}) = a$ and
$\text{length}_R(I_{\psi'}) = b$.

\medskip\noindent
The assumption that $K \subset K_\varphi = I_\psi$ means that
$\varphi$ factors through $N$ to give an exact sequence
$$
0 \to \alpha(I_\psi) \to N \xrightarrow{\varphi\alpha^{-1}} I_\psi \to 0.
$$
Here $\varphi\alpha^{-1}(x') = y$ means $x' = \alpha(x)$ and $y = \varphi(x)$.
Similarly, we have
$$
0 \to \alpha(I_\varphi) \to N \xrightarrow{\psi\alpha^{-1}} I_\varphi \to 0.
$$
The assumption that $\psi'$ induces the zero map on
$Q$ means that $I_{\psi'} = K_{\varphi'} \subset N$.
This means the quotient $\varphi'(N) \subset I_{\varphi'}$
is identified with $Q$. Note that $\varphi'(N) = \alpha(I_\varphi)$.
Hence we conclude there is an isomorphism
$$
\varphi' : Q \to I_{\varphi'}/\alpha(I_\varphi)
$$
simply described by
$\varphi'(x' \bmod N) = \varphi'(x') \bmod \alpha(I_\varphi)$.
In exactly the same way we get
$$
\psi' : Q \to I_{\psi'}/\alpha(I_\psi)
$$
Finally, note that $\alpha_0$ is the composition
$$
\xymatrix{
Q \ar[r]^-{\varphi'} &
I_{\varphi'}/\alpha(I_\varphi)
\ar[rrr]^-{\psi\alpha^{-1}|_{I_{\varphi'}/\alpha(I_\varphi)}} & & &
K
}
$$
and similarly
$\alpha_1 = \varphi\alpha^{-1}|_{I_{\psi'}/\alpha(I_\psi)} \circ \psi'$.

\medskip\noindent
To shorten the formulas below we are going to write $\alpha x$ instead
of $\alpha(x)$ in the following. No confusion should result since
all maps are indicated by Greek letters and elements by Roman letters.
We are going to choose
\begin{enumerate}
\item an admissible sequence $z_1, \ldots, z_k \in K$
generating $K$,
\item elements $z'_i \in M$ such that $\varphi z'_i = z_i$,
\item elements $z''_i \in M$ such that $\psi z''_i = z_i$,
\item elements $x_{k + 1}, \ldots, x_a \in I_\varphi$ such
that $z_1, \ldots, z_k, x_{k + 1}, \ldots, x_a$ is an admissible
sequence generating $I_\varphi$,
\item elements $\tilde x_i \in M$ such that $\varphi \tilde x_i = x_i$,
\item elements $y_{k + 1}, \ldots, y_b \in I_\psi$ such that
$z_1, \ldots, z_k, y_{k + 1}, \ldots, y_b$ is an admissible
sequence generating $I_\psi$,
\item elements $\tilde y_i \in M$ such that $\psi \tilde y_i = y_i$, and
\item elements $w_1, \ldots, w_k \in M'$ such that
$w_1 \bmod N, \ldots, w_k \bmod N$ are an admissible sequence
in $Q$ generating $Q$.
\end{enumerate}
By Remark \ref{remark-more-elementary} the element
$D = \det_\kappa(M, \varphi, \psi) \in \kappa^*$ is
characterized by
\begin{eqnarray*}
& &
[z_1, \ldots, z_k,
x_{k + 1}, \ldots, x_a,
z''_1, \ldots, z''_k,
\tilde y_{k + 1}, \ldots, \tilde y_b] \\
& = &
(-1)^{ab} D
[z_1, \ldots, z_k,
y_{k + 1}, \ldots, y_b,
z'_1, \ldots, z'_k,
\tilde x_{k + 1}, \ldots, \tilde x_a]
\end{eqnarray*}
Note that by the discussion above
$\alpha x_{k + 1}, \ldots, \alpha x_a, \varphi w_1, \ldots, \varphi w_k$
is an admissible sequence generating $I_{\varphi'}$ and
$\alpha y_{k + 1}, \ldots, \alpha y_b, \psi w_1, \ldots, \psi w_k$
is an admissible sequence generating $I_{\psi'}$.
Hence by Remark \ref{remark-more-elementary} the element
$D' = \det_\kappa(M', \varphi', \psi') \in \kappa^*$ is
characterized by
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b,
w_1, \ldots, w_k]
\\
& = &
(-1)^{ab} D'
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a,
w_1, \ldots, w_k]
\end{eqnarray*}
Note how in the first, resp.\ second displayed formula
the first, resp.\ last $k$ entries of the symbols on both sides
are the same. Hence these formulas are really equivalent to the
equalities
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\alpha z''_1, \ldots, \alpha z''_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b] \\
& = &
(-1)^{ab} D
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\alpha z'_1, \ldots, \alpha z'_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
and
\begin{eqnarray*}
& &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b]
\\
& = &
(-1)^{ab} D'
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
in $\det_\kappa(N)$. Note that
$\varphi' w_1, \ldots, \varphi' w_k$
and
$\alpha z''_1, \ldots, z''_k$
are admissible sequences generating the module
$I_{\varphi'}/\alpha(I_\varphi)$. Write
$$
[\varphi' w_1, \ldots, \varphi' w_k]
= \lambda_0 [\alpha z''_1, \ldots, \alpha z''_k]
$$
in $\det_\kappa(I_{\varphi'}/\alpha(I_\varphi))$
for some $\lambda_0 \in \kappa^*$. Similarly,
write
$$
[\psi' w_1, \ldots, \psi' w_k]
= \lambda_1 [\alpha z'_1, \ldots, \alpha z'_k]
$$
in $\det_\kappa(I_{\psi'}/\alpha(I_\psi))$
for some $\lambda_1 \in \kappa^*$. On the one hand
it is clear that
$$
\alpha_i([w_1, \ldots, w_k]) = \lambda_i[z_1, \ldots, z_k]
$$
for $i = 0, 1$ by our description of $\alpha_i$ above,
which means that
$$
\det\nolimits_\kappa(\alpha_0^{-1} \circ \alpha_1)
=
\lambda_1/\lambda_0
$$
and
on the other hand it is clear that
\begin{eqnarray*}
& &
\lambda_0 [\alpha x_{k + 1}, \ldots, \alpha x_a,
\alpha z''_1, \ldots, \alpha z''_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b] \\
& = &
[\alpha x_{k + 1}, \ldots, \alpha x_a,
\varphi' w_1, \ldots, \varphi' w_k,
\alpha \tilde y_{k + 1}, \ldots, \alpha \tilde y_b]
\end{eqnarray*}
and
\begin{eqnarray*}
& &
\lambda_1[\alpha y_{k + 1}, \ldots, \alpha y_b,
\alpha z'_1, \ldots, \alpha z'_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a] \\
& = &
[\alpha y_{k + 1}, \ldots, \alpha y_b,
\psi' w_1, \ldots, \psi' w_k,
\alpha \tilde x_{k + 1}, \ldots, \alpha \tilde x_a]
\end{eqnarray*}
which imply $\lambda_0 D = \lambda_1 D'$. The lemma follows.
\end{proof}








\subsection{Symbols}
\label{subsection-symbols}

\noindent
The correct generality for this construction is perhaps the
situation of the following lemma.

\begin{lemma}
\label{lemma-pre-symbol}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module of dimension $1$.
Assume $\varphi, \psi : M \to M$ are two injective
$A$-module maps, and assume $\varphi(\psi(M)) = \psi(\varphi(M))$,
for example if $\varphi$ and $\psi$ commute.
Then $\text{length}_R(M/\varphi\psi M) < \infty$
and $(M/\varphi\psi M, \varphi, \psi)$ is an exact
$(2, 1)$-periodic complex.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a minimal prime of the support of $M$.
Then $M_{\mathfrak q}$ is a finite length $A_{\mathfrak q}$-module,
see Algebra, Lemma \ref{algebra-lemma-support-point}.
Hence both $\varphi$ and $\psi$
induce isomorphisms $M_{\mathfrak q} \to M_{\mathfrak q}$.
Thus the support of $M/\varphi\psi M$ is $\{\mathfrak m_A\}$
and hence it has finite length (see lemma cited above).
Finally, the kernel of $\varphi$ on $M/\varphi\psi M$
is clearly $\psi M/\varphi\psi M$, and hence the kernel
of $\varphi$ is the image of $\psi$ on $M/\varphi\psi M$.
Similarly the other way since $M/\varphi\psi M = M/\psi\varphi M$
by assumption.
\end{proof}

\begin{lemma}
\label{lemma-symbol-defined}
Let $A$ be a Noetherian local ring. Let $a, b \in A$.
\begin{enumerate}
\item If $M$ is a finite $A$-module of dimension $1$
such that $a, b$ are nonzerodivisors on $M$, then
$\text{length}_A(M/abM) < \infty$ and
$(M/abM, a, b)$ is a $(2, 1)$-periodic exact complex.
\item If $a, b$ are nonzerodivisors and $\dim(A) = 1$
then $\text{length}_A(A/(ab)) < \infty$ and
$(A/(ab), a, b)$ is a $(2, 1)$-periodic exact complex.
\end{enumerate}
In particular, in these cases
$\det_\kappa(M/abM, a, b) \in \kappa^*$,
resp.\ $\det_\kappa(A/(ab), a, b) \in \kappa^*$
are defined.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-pre-symbol}.
\end{proof}

\begin{definition}
\label{definition-symbol-M}
Let $A$ be a Noetherian local ring with residue field $\kappa$.
Let $a, b \in A$.
Let $M$ be a finite $A$-module of dimension $1$
such that $a, b$ are nonzerodivisors on $M$.
We define the {\it symbol associated to $M, a, b$}
to be the element
$$
d_M(a, b) =
\det\nolimits_\kappa(M/abM, a, b) \in \kappa^*
$$
\end{definition}

\begin{lemma}
\label{lemma-multiplicativity-symbol}
Let $A$ be a Noetherian local ring.
Let $a, b, c \in A$. Let $M$ be a finite $A$-module
with $\dim(\text{Supp}(M)) = 1$. Assume $a, b, c$ are nonzerodivisors on $M$.
Then
$$
d_M(a, bc) = d_M(a, b) d_M(a, c)
$$
and $d_M(a, b)d_M(b, a) = 1$.
\end{lemma}

\begin{proof}
The first statement follows from Lemma \ref{lemma-multiplicativity-determinant}
applied to $M/abcM$ and endomorphisms $\alpha, \beta, \gamma$ given by
multiplication by $a, b, c$.
The second comes from Lemma \ref{lemma-periodic-determinant-shift}.
\end{proof}

\begin{definition}
\label{definition-tame-symbol}
Let $A$ be a Noetherian local domain of dimension $1$
with residue field $\kappa$.
Let $K$ be the fraction field of $A$.
We define the {\it tame symbol} of $A$ to be the map
$$
K^* \times K^* \longrightarrow \kappa^*,
\quad
(x, y) \longmapsto d_A(x, y)
$$
where $d_A(x, y)$ is extended to $K^* \times K^*$ by the multiplicativity of
Lemma \ref{lemma-multiplicativity-symbol}.
\end{definition}

\noindent
It is clear that we may extend more generally $d_M(-, -)$ to
certain rings of fractions of $A$ (even if $A$ is not a domain).

\begin{lemma}
\label{lemma-symbol-when-equal}
Let $A$ be a Noetherian local ring and $M$ a finite $A$-module of
dimension $1$. Let $a \in A$ be a nonzerodivisor on $M$.
Then $d_M(a, a) = (-1)^{\text{length}_A(M/aM)}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-periodic-determinant-sign}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-when-one-is-a-unit}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module of dimension $1$.
Let $b \in A$ be a nonzerodivisor on $M$, and let $u \in A^*$.
Then
$$
d_M(u, b) = u^{\text{length}_A(M/bM)} \bmod \mathfrak m_A.
$$
In particular, if $M = A$, then
$d_A(u, b) = u^{\text{ord}_A(b)} \bmod \mathfrak m_A$.
\end{lemma}

\begin{proof}
Note that in this case $M/ubM = M/bM$ on which multiplication
by $b$ is zero. Hence $d_M(u, b) = \det_\kappa(u|_{M/bM})$
by Lemma \ref{lemma-periodic-determinant-easy-case}. The lemma
then follows from Lemma \ref{lemma-times-u-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-short-exact-sequence}
Let $A$ be a Noetherian local ring.
Let $a, b \in A$.
Let
$$
0 \to M \to M' \to M'' \to 0
$$
be a short exact sequence of $A$-modules of dimension $1$
such that $a, b$ are nonzerodivisors on
all three $A$-modules.
Then
$$
d_{M'}(a, b) = d_M(a, b) d_{M''}(a, b)
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
It is easy to see that this leads to a short exact sequence
of exact $(2, 1)$-periodic complexes
$$
0 \to
(M/abM, a, b) \to
(M'/abM', a, b) \to
(M''/abM'', a, b) \to 0
$$
Hence the lemma follows from Lemma \ref{lemma-periodic-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-symbol-compare-modules}
Let $A$ be a Noetherian local ring.
Let $\alpha : M \to M'$ be a homomorphism of
finite $A$-modules of dimension $1$.
Let $a, b \in A$. Assume
\begin{enumerate}
\item $a$, $b$ are nonzerodivisors on both $M$ and $M'$, and
\item $\dim(\Ker(\alpha)), \dim(\Coker(\alpha)) \leq 0$.
\end{enumerate}
Then $d_M(a, b) = d_{M'}(a, b)$.
\end{lemma}

\begin{proof}
If $a \in A^*$, then the equality follows from the
equality $\text{length}(M/bM) = \text{length}(M'/bM')$
and Lemma \ref{lemma-symbol-when-one-is-a-unit}.
Similarly if $b$ is a unit the lemma holds as well
(by the symmetry of Lemma \ref{lemma-multiplicativity-symbol}).
Hence we may assume that $a, b \in \mathfrak m_A$.
This in particular implies that $\mathfrak m$ is not
an associated prime of $M$, and hence $\alpha : M \to M'$
is injective. This permits us to think of $M$ as a submodule of $M'$.
By assumption $M'/M$ is a finite $A$-module with support
$\{\mathfrak m_A\}$ and hence has finite length.
Note that for any third module $M''$ with $M \subset M'' \subset M'$
the maps $M \to M''$ and $M'' \to M'$ satisfy the assumptions of the lemma
as well. This reduces us, by induction on the length of $M'/M$,
to the case where $\text{length}_A(M'/M) = 1$.
Finally, in this case consider the map
$$
\overline{\alpha} : M/abM \longrightarrow M'/abM'.
$$
By construction the cokernel $Q$ of $\overline{\alpha}$ has
length $1$. Since $a, b \in \mathfrak m_A$, they act trivially on
$Q$. It also follows that the kernel $K$ of $\overline{\alpha}$ has
length $1$ and hence also $a$, $b$ act trivially on $K$.
Hence we may apply Lemma \ref{lemma-tricky}. Thus it suffices to see
that the two maps $\alpha_i : Q \to K$ are the same.
In fact, both maps are equal to the map
$q = x' \bmod \Im(\overline{\alpha}) \mapsto abx' \in K$.
We omit the verification.
\end{proof}

\begin{lemma}
\label{lemma-compute-symbol-M}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module with $\dim(\text{Supp}(M)) = 1$.
Let $a, b \in A$ nonzerodivisors on $M$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes in the support of $M$. Then
$$
d_M(a, b)
=
\prod\nolimits_{i = 1, \ldots, t}
d_{A/\mathfrak q_i}(a, b)^{
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})}
$$
as elements of $\kappa^*$.
\end{lemma}

\begin{proof}
Choose a filtration by $A$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_j/M_{j - 1}$ is isomorphic
to $A/\mathfrak p_j$ for some prime ideal $\mathfrak p_j$
of $A$. See Algebra, Lemma \ref{algebra-lemma-filter-Noetherian-module}.
For each $j$ we have either $\mathfrak p_j = \mathfrak q_i$
for some $i$, or $\mathfrak p_j = \mathfrak m_A$. Moreover,
for a fixed $i$, the number of $j$ such that
$\mathfrak p_j = \mathfrak q_i$ is equal to
$\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})$ by
Algebra, Lemma \ref{algebra-lemma-filter-minimal-primes-in-support}.
Hence $d_{M_j}(a, b)$ is defined for each $j$ and
$$
d_{M_j}(a, b)
=
\left\{
\begin{matrix}
d_{M_{j - 1}}(a, b) d_{A/\mathfrak q_i}(a, b) &
\text{if} & \mathfrak p_j = \mathfrak q_i \\
d_{M_{j - 1}}(a, b) & \text{if} & \mathfrak p_j = \mathfrak m_A
\end{matrix}
\right.
$$
by Lemma \ref{lemma-symbol-short-exact-sequence} in the first instance
and Lemma \ref{lemma-symbol-compare-modules} in the second. Hence the lemma.
\end{proof}

\begin{lemma}
\label{lemma-symbol-is-usual-tame-symbol}
Let $A$ be a discrete valuation ring with fraction field $K$.
For nonzero $x, y \in K$ we have
$$
d_A(x, y)
=
(-1)^{\text{ord}_A(x)\text{ord}_A(y)}
\frac{x^{\text{ord}_A(y)}}{y^{\text{ord}_A(x)}} \bmod \mathfrak m_A,
$$
in other words the symbol is equal to the usual tame symbol.
\end{lemma}

\begin{proof}
By multiplicativity it suffices to prove this when $x, y \in A$.
Let $t \in A$ be a uniformizer.
Write $x = t^bu$ and $y = t^bv$ for some $a, b \geq 0$
and $u, v \in A^*$. Set $l = a + b$. Then
$t^{l - 1}, \ldots, t^b$ is an admissible sequence in
$(x)/(xy)$ and $t^{l - 1}, \ldots, t^a$ is an admissible
sequence in $(y)/(xy)$. Hence by Remark \ref{remark-more-elementary}
we see that $d_A(x, y)$ is characterized by the equation
$$
[t^{l - 1}, \ldots, t^b, v^{-1}t^{b - 1}, \ldots, v^{-1}]
=
(-1)^{ab} d_A(x, y)
[t^{l - 1}, \ldots, t^a, u^{-1}t^{a - 1}, \ldots, u^{-1}].
$$
Hence by the admissible relations for the
symbols $[x_1, \ldots, x_l]$ we see that
$$
d_A(x, y) = (-1)^{ab} u^a/v^b \bmod \mathfrak m_A
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-symbol-is-steinberg-prepare}
Let $A$ be a Noetherian local ring.
Let $a, b \in A$.
Let $M$ be a finite $A$-module of dimension $1$ on
which each of $a$, $b$, $b - a$ are nonzerodivisors.
Then
$$
d_M(a, b - a)d_M(b, b) = d_M(b, b - a)d_M(a, b)
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-compute-symbol-M} it suffices to show the relation when
$M = A/\mathfrak q$ for some prime $\mathfrak q \subset A$ with
$\dim(A/\mathfrak q) = 1$.

\medskip\noindent
In case $M = A/\mathfrak q$ we may replace $A$ by $A/\mathfrak q$ and
$a, b$ by their images in $A/\mathfrak q$. Hence we may assume $A = M$
and $A$ a local Noetherian domain of dimension $1$. The reason is
that the residue field $\kappa$ of $A$ and $A/\mathfrak q$ are
the same and that for any $A/\mathfrak q$-module $M$ the determinant
taken over $A$ or over $A/\mathfrak q$ are canonically identified.
See Lemma \ref{lemma-determinant-quotient-ring}.

\medskip\noindent
It suffices to show the relation when both
$a, b$ are in the maximal ideal. Namely, the case where one
or both are units follows from Lemmas \ref{lemma-symbol-when-one-is-a-unit}
and \ref{lemma-symbol-when-equal}.

\medskip\noindent
Choose an extension $A \subset A'$ and factorizations
$a = ta'$, $b = tb'$ as in
Lemma \ref{lemma-Noetherian-domain-dim-1-two-elements}.
Note that also $b - a = t(b' - a')$ and that
$A' = (a', b') = (a', b' - a') = (b' - a', b')$.
Here and in the following we think of $A'$ as an $A$-module and
$a, b, a', b', t$ as $A$-module endomorphisms of $A'$.
We will use the notation $d^A_{A'}(a', b')$ and so on to indicate
$$
d^A_{A'}(a', b')
=
\det\nolimits_\kappa(A'/a'b'A', a', b')
$$
which is defined by Lemma \ref{lemma-pre-symbol}. The upper index ${}^A$
is used to distinguish this from the already defined symbol
$d_{A'}(a', b')$ which is different (for example because it has values
in the residue field of $A'$ which may be different from $\kappa$).
By Lemma \ref{lemma-symbol-compare-modules} we see that
$d_A(a, b) = d^A_{A'}(a, b)$,
and similarly for the other combinations.
Using this and multiplicativity we see that it suffices to prove
$$
d^A_{A'}(a', b' - a') d^A_{A'}(b', b')
=
d^A_{A'}(b', b' - a') d^A_{A'}(a', b')
$$
Now, since $(a', b') = A'$ and so on we have
$$
\begin{matrix}
A'/(a'(b' - a')) & \cong & A'/(a') \oplus A'/(b' - a') \\
A'/(b'(b' - a')) & \cong & A'/(b') \oplus A'/(b' - a') \\
A'/(a'b') & \cong & A'/(a') \oplus A'/(b')
\end{matrix}
$$
Moreover, note that multiplication by $b' - a'$ on
$A/(a')$ is equal to multiplication by $b'$, and that
multiplication by $b' - a'$ on $A/(b')$ is equal to multiplication by $-a'$.
Using Lemmas
\ref{lemma-periodic-determinant-easy-case} and
\ref{lemma-periodic-determinant}
we conclude
$$
\begin{matrix}
d^A_{A'}(a', b' - a') & = &
\det\nolimits_\kappa(b'|_{A'/(a')})^{-1}
\det\nolimits_\kappa(a'|_{A'/(b' - a')}) \\
d^A_{A'}(b', b' - a') & = &
\det\nolimits_\kappa(-a'|_{A'/(b')})^{-1}
\det\nolimits_\kappa(b'|_{A'/(b' - a')}) \\
d^A_{A'}(a', b') & = &
\det\nolimits_\kappa(b'|_{A'/(a')})^{-1}
\det\nolimits_\kappa(a'|_{A'/(b')})
\end{matrix}
$$
Hence we conclude that
$$
(-1)^{\text{length}_A(A'/(b'))}
d^A_{A'}(a', b' - a')
=
d^A_{A'}(b', b' - a') d^A_{A'}(a', b')
$$
the sign coming from the $-a'$ in the second equality above.
On the other hand, by Lemma \ref{lemma-periodic-determinant-sign} we have
$d^A_{A'}(b', b') = (-1)^{\text{length}_A(A'/(b'))}$ and the lemma
is proved.
\end{proof}

\noindent
The tame symbol is a Steinberg symbol.

\begin{lemma}
\label{lemma-symbol-is-steinberg}
Let $A$ be a Noetherian local domain of dimension $1$
with fraction field $K$. For $x \in K \setminus \{0, 1\}$
we have
$$
d_A(x, 1 -x) = 1
$$
\end{lemma}

\begin{proof}
Write $x = a/b$ with $a, b \in A$.
The hypothesis implies, since $1 - x = (b - a)/b$,
that also $b - a \not = 0$. Hence we compute
$$
d_A(x, 1 - x)
=
d_A(a, b - a)d_A(a, b)^{-1}d_A(b, b - a)^{-1}d_A(b, b)
$$
Thus we have to show that
$d_A(a, b - a) d_A(b, b) = d_A(b, b - a) d_A(a, b)$.
This is Lemma \ref{lemma-symbol-is-steinberg-prepare}.
\end{proof}










\subsection{Lengths and determinants}
\label{subsection-length-determinant}

\noindent
In this section we use the determinant to compare lattices.
The key lemma is the following.

\begin{lemma}
\label{lemma-key-lemma}
Let $R$ be a noetherian local ring.
Let $\mathfrak q \subset R$ be a prime with $\dim(R/\mathfrak q) = 1$.
Let $\varphi : M \to N$ be a homomorphism of finite $R$-modules.
Assume there exist $x_1, \ldots, x_l \in M$ and $y_1, \ldots, y_l \in M$
with the following properties
\begin{enumerate}
\item $M = \langle x_1, \ldots, x_l\rangle$,
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$,
\item $N = \langle y_1, \ldots, y_l\rangle$, and
\item $\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Then $\varphi$ is injective if and only if $\varphi_{\mathfrak q}$ is an
isomorphism, and in this case we have
$$
\text{length}_R(\Coker(\varphi)) = \text{ord}_{R/\mathfrak q}(f)
$$
where $f \in \kappa(\mathfrak q)$ is the element such that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l]
$$
in $\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$.
\end{lemma}

\begin{proof}
First, note that the lemma holds in case $l = 1$.
Namely, in this case $x_1$ is a basis of $M$ over $R/\mathfrak q$
and $y_1$ is a basis of $N$ over $R/\mathfrak q$ and we have
$\varphi(x_1) = fy_1$ for some $f \in R$. Thus $\varphi$ is injective
if and only if $f \not \in \mathfrak q$. Moreover,
$\Coker(\varphi) = R/(f, \mathfrak q)$ and hence the lemma
holds by definition of $\text{ord}_{R/q}(f)$
(see Algebra, Definition \ref{algebra-definition-ord}).

\medskip\noindent
In fact, suppose more generally that $\varphi(x_i) = f_iy_i$ for some
$f_i \in R$, $f_i \not \in \mathfrak q$. Then the induced maps
$$
\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\longrightarrow
\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
$$
are all injective and have cokernels isomorphic to
$R/(f_i, \mathfrak q)$. Hence we see that
$$
\text{length}_R(\Coker(\varphi)) = \sum \text{ord}_{R/\mathfrak q}(f_i).
$$
On the other hand it is clear that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f_1 \ldots f_l [y_1, \ldots, y_l]
$$
in this case from the admissible relation (b) for symbols.
Hence we see the result holds in this case also.

\medskip\noindent
We prove the general case by induction on $l$. Assume $l > 1$.
Let $i \in \{1, \ldots, l\}$ be minimal such that
$\varphi(x_1) \in \langle y_1, \ldots, y_i\rangle$.
We will argue by induction on $i$.
If $i = 1$, then we get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\langle x_1 \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle / \langle x_1 \rangle \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\langle y_1 \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle / \langle y_1 \rangle \ar[r] &
0
}
$$
and the lemma follows from the snake lemma and induction on $l$.
Assume now that $i > 1$.
Write $\varphi(x_1) = a_1 y_1 + \ldots + a_{i - 1} y_{i - 1} + a y_i$
with $a_j, a \in R$ and $a \not \in \mathfrak q$ (since otherwise
$i$ was not minimal). Set
$$
x'_j =
\left\{
\begin{matrix}
x_j & \text{if} & j = 1 \\
ax_j & \text{if} & j \geq 2
\end{matrix}
\right.
\quad\text{and}\quad
y'_j =
\left\{
\begin{matrix}
y_j & \text{if} & j < i \\
ay_j & \text{if} & j \geq i
\end{matrix}
\right.
$$
Let $M' = \langle x'_1, \ldots, x'_l \rangle$ and
$N' = \langle y'_1, \ldots, y'_l \rangle$.
Since $\varphi(x'_1) = a_1 y'_1 + \ldots + a_{i - 1} y'_{i - 1} + y'_i$
by construction and since for $j > 1$ we have
$\varphi(x'_j) = a\varphi(x_i) \in \langle y'_1, \ldots, y'_l\rangle$
we get a commutative diagram of $R$-modules and maps
$$
\xymatrix{
M' \ar[d] \ar[r]_{\varphi'} & N' \ar[d] \\
M \ar[r]^\varphi & N
}
$$
By the result of the second paragraph of the proof we know
that $\text{length}_R(M/M') = (l - 1)\text{ord}_{R/\mathfrak q}(a)$
and similarly
$\text{length}_R(M/M') = (l - i + 1)\text{ord}_{R/\mathfrak q}(a)$.
By a diagram chase this implies that
$$
\text{length}_R(\Coker(\varphi')) =
\text{length}_R(\Coker(\varphi)) + i\ \text{ord}_{R/\mathfrak q}(a).
$$
On the other hand, it is clear that writing
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l],
\quad
[\varphi'(x'_1), \ldots, \varphi(x'_l)] = f' [y'_1, \ldots, y'_l]
$$
we have $f' = a^if$. Hence it suffices to prove the lemma for the
case that $\varphi(x_1) = a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i$,
i.e., in the case that $a = 1$. Next, recall that
$$
[y_1, \ldots, y_l] = [y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l]
$$
by the admissible relations for symbols. The sequence
$y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots + a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l$
satisfies the conditions (3), (4) of the lemma also.
Hence, we may actually
assume that $\varphi(x_1) = y_i$. In this case, note that we have
$\mathfrak q x_1 = 0$ which implies also $\mathfrak q y_i = 0$.
We have
$$
[y_1, \ldots, y_l] =
- [y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l]
$$
by the third of the admissible relations defining
$\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$. Hence we may
replace $y_1, \ldots, y_l$ by
the sequence
$y'_1, \ldots, y'_l =
y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l$
(which also satisfies conditions (3) and (4) of the lemma).
Clearly this decreases the invariant $i$ by $1$ and we win by induction
on $i$.
\end{proof}

\noindent
To use the previous lemma we show that often sequences of elements
with the required properties exist.

\begin{lemma}
\label{lemma-good-sequence-exists}
Let $R$ be a local Noetherian ring.
Let $\mathfrak q \subset R$ be a prime ideal.
Let $M$ be a finite $R$-module such that
$\mathfrak q$ is one of the minimal primes of the support of $M$.
Then there exist $x_1, \ldots, x_l \in M$ such that
\begin{enumerate}
\item the support of $M / \langle x_1, \ldots, x_l\rangle$ does not contain
$\mathfrak q$, and
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Moreover, in this case $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$.
\end{lemma}

\begin{proof}
The condition that $\mathfrak q$ is a minimal prime in the support
of $M$ implies that $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$
is finite (see Algebra, Lemma \ref{algebra-lemma-support-point}).
Hence we can find $y_1, \ldots, y_l \in M_{\mathfrak q}$
such that
$\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
We can find $f_i \in R$, $f_i \not \in \mathfrak q$ such that
$f_i y_i$ is the image of some element $z_i \in M$.
Moreover, as $R$ is Noetherian we can write
$\mathfrak q = (g_1, \ldots, g_t)$ for some $g_j \in R$.
By assumption $g_j y_i \in \langle y_1, \ldots, y_{i - 1} \rangle$
inside the module $M_{\mathfrak q}$.
By our choice of $z_i$ we can find some further elements
$f_{ji} \in R$, $f_{ij} \not \in \mathfrak q$ such that
$f_{ij} g_j z_i \in \langle z_1, \ldots, z_{i - 1} \rangle$
(equality in the module $M$).
The lemma follows by taking
$$
x_1 = f_{11}f_{12}\ldots f_{1t}z_1,
\quad
x_2 = f_{11}f_{12}\ldots f_{1t}f_{21}f_{22}\ldots f_{2t}z_2,
$$
and so on. Namely, since all the elements $f_i, f_{ij}$ are invertible
in $R_{\mathfrak q}$ we still have that
$R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_i /
R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_{i - 1}
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
By construction, $\mathfrak q x_i \in \langle x_1, \ldots, x_{i - 1}\rangle$.
Thus $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle$
is an $R$-module generated by one element, annihilated $\mathfrak q$
such that localizing at $\mathfrak q$ gives a $q$-dimensional
vector space over $\kappa(\mathfrak q)$.
Hence it is isomorphic to $R/\mathfrak q$.
\end{proof}

\noindent
Here is the main result of this section.
We will see below the various different
consequences of this proposition.
The reader is encouraged to first prove the easier
Lemma \ref{lemma-application-herbrand-quotient} his/herself.

\begin{proposition}
\label{proposition-length-determinant-periodic-complex}
Let $R$ be a local Noetherian ring with residue field $\kappa$.
Suppose that $(M, \varphi, \psi)$ is a $(2, 1)$-periodic
complex over $R$. Assume
\begin{enumerate}
\item $M$ is a finite $R$-module,
\item the cohomology modules of $(M, \varphi, \psi)$ are of finite length, and
\item $\dim(\text{Supp}(M)) = 1$.
\end{enumerate}
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the minimal
primes of the support of $M$. Then we have\footnote{
Obviously we could get rid of the minus sign by redefining
$\det_\kappa(M, \varphi, \psi)$ as the inverse of its
current value, see Definition \ref{definition-periodic-determinant}.}
$$
- e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{\mathfrak q_i}, \varphi_{\mathfrak q_i}, \psi_{\mathfrak q_i})
\right)
$$
\end{proposition}

\begin{proof}
We first reduce to the case $t = 1$ in the following way.
Note that
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$,
where $\mathfrak m \subset R$ is the maximal ideal.
Let $M_i$ denote the image of $M \to M_{\mathfrak q_i}$,
so $\text{Supp}(M_i) = \{\mathfrak m, \mathfrak q_i\}$.
The map $\varphi$ (resp.\ $\psi$) induces an $R$-module map
$\varphi_i : M_i \to M_i$ (resp.\ $\psi_i : M_i \to M_i$).
Thus we get a morphism of $(2, 1)$-periodic complexes
$$
(M, \varphi, \psi) \longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, t} (M_i, \varphi_i, \psi_i).
$$
The kernel and cokernel of this map have support contained in
$\{\mathfrak m\}$. Hence by Lemma \ref{lemma-compare-periodic-lengths}
we have
$$
e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
e_R(M_i, \varphi_i, \psi_i)
$$
On the other hand we clearly have $M_{\mathfrak q_i} = M_{i, \mathfrak q_i}$,
and hence the terms of the right hand side of the formula of the
lemma are equal to the expressions
$$
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{i, \mathfrak q_i}, \varphi_{i, \mathfrak q_i}, \psi_{i, \mathfrak q_i})
\right)
$$
In other words, if we can prove the lemma for each of the modules
$M_i$, then the lemma holds. This reduces us to the case $t = 1$.

\medskip\noindent
Assume we have a $(2, 1)$-periodic complex $(M, \varphi, \psi)$
over a Noetherian local ring with $M$ a finite $R$-module,
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$, and
finite length cohomology modules. The proof in this case
follows from Lemma \ref{lemma-key-lemma} and careful bookkeeping.
Denote
$K_\varphi = \Ker(\varphi)$,
$I_\varphi = \Im(\varphi)$,
$K_\psi = \Ker(\psi)$, and
$I_\psi = \Im(\psi)$.
Since $R$ is Noetherian these are all finite $R$-modules.
Set
$$
a = \text{length}_{R_{\mathfrak q}}(I_{\varphi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\psi, \mathfrak q}),
\quad
b = \text{length}_{R_{\mathfrak q}}(I_{\psi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\varphi, \mathfrak q}).
$$
Equalities because the complex becomes exact after localizing at
$\mathfrak q$. Note that $l = \text{length}_{R_{\mathfrak q}}(M_{\mathfrak q})$
is equal to $l = a + b$.

\medskip\noindent
We are going to use Lemma \ref{lemma-good-sequence-exists}
to choose sequences of elements in finite $R$-modules
$N$ with support contained in $\{\mathfrak m, \mathfrak q\}$.
In this case $N_{\mathfrak q}$ has finite length, say $n \in \mathbf{N}$.
Let us call a sequence $w_1, \ldots, w_n \in N$
with properties (1) and (2) of Lemma \ref{lemma-good-sequence-exists}
a ``good sequence''. Note that the quotient
$N/\langle w_1, \ldots, w_n \rangle$ of $N$ by the submodule generated by
a good sequence has support (contained in) $\{\mathfrak m\}$
and hence has finite length (Algebra, Lemma \ref{algebra-lemma-support-point}).
Moreover, the symbol
$[w_1, \ldots, w_n] \in \det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$
is a generator, see Lemma \ref{lemma-determinant-dimension-one}.

\medskip\noindent
Having said this we choose good sequences
$$
\begin{matrix}
x_1, \ldots, x_b & \text{in} & K_\varphi, &
t_1, \ldots, t_a & \text{in} & K_\psi, \\
y_1, \ldots, y_a & \text{in} & I_\varphi \cap \langle t_1, \ldots t_a\rangle, &
s_1, \ldots, s_b & \text{in} & I_\psi \cap \langle x_1, \ldots, x_b\rangle.
\end{matrix}
$$
We will adjust our choices a little bit as follows.
Choose lifts $\tilde y_i \in M$ of $y_i \in I_\varphi$
and $\tilde s_i \in M$ of $s_i \in I_\psi$. It may not be the case
that $\mathfrak q \tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and it may not be the case that
$\mathfrak q \tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
However, using that $\mathfrak q$ is finitely generated (as in the proof
of Lemma \ref{lemma-good-sequence-exists}) we can find a
$d \in R$, $d \not \in \mathfrak q$ such that
$\mathfrak q d\tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and
$\mathfrak q d\tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
Thus after replacing $y_i$ by $dy_i$,
$\tilde y_i$ by $d\tilde y_i$, $s_i$ by $ds_i$ and $\tilde s_i$
by $d\tilde s_i$ we see that we may assume also that
$x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_b$
and $t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b$
are good sequences in $M$.

\medskip\noindent
Finally, we choose a good sequence
$z_1, \ldots, z_l$ in the finite $R$-module
$$
\langle
x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a
\rangle
\cap
\langle
t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b
\rangle.
$$
Note that this is also a good sequence in $M$.

\medskip\noindent
Since $I_{\varphi, \mathfrak q} = K_{\psi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[y_1, \ldots, y_a] = h [t_1, \ldots, t_a]$
inside $\det_{\kappa(\mathfrak q)}(K_{\psi, \mathfrak q})$.
Similarly, as $I_{\psi, \mathfrak q} = K_{\varphi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[s_1, \ldots, s_b] = g [x_1, \ldots, x_b]$
inside $\det_{\kappa(\mathfrak q)}(K_{\varphi, \mathfrak q})$.
We can also do this with the three good sequences we have
in $M$. All in all we get the following identities
\begin{align*}
[y_1, \ldots, y_a]
& =
h [t_1, \ldots, t_a] \\
[s_1, \ldots, s_b]
& =
g [x_1, \ldots, x_b] \\
[z_1, \ldots, z_l]
& =
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
[z_1, \ldots, z_l]
& =
f_\psi [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b]
\end{align*}
for some $g, h, f_\varphi, f_\psi \in \kappa(\mathfrak q)$.

\medskip\noindent
Having set up all this
notation let us compute $\det_{\kappa(\mathfrak q)}(M, \varphi, \psi)$.
Namely, consider the element $[z_1, \ldots, z_l]$.
Under the map $\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$
of Definition \ref{definition-periodic-determinant} we have
\begin{eqnarray*}
[z_1, \ldots, z_l] & = &
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
& \mapsto & f_\varphi [x_1, \ldots, x_b] \otimes [y_1, \ldots, y_a] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a] \otimes [s_1, \ldots, s_b] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b] \\
& = &
f_\varphi h/f_\psi g [z_1, \ldots, z_l]
\end{eqnarray*}
This means that
$\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
is equal to $f_\varphi h/f_\psi g$ up to a sign.

\medskip\noindent
We abbreviate the following quantities
\begin{eqnarray*}
k_\varphi & = & \text{length}_R(K_\varphi/\langle x_1, \ldots, x_b\rangle) \\
k_\psi    & = & \text{length}_R(K_\psi/\langle t_1, \ldots, t_a\rangle) \\
i_\varphi & = & \text{length}_R(I_\varphi/\langle y_1, \ldots, y_a\rangle) \\
i_\psi    & = & \text{length}_R(I_\psi/\langle s_1, \ldots, s_a\rangle) \\
m_\varphi & = & \text{length}_R(M/
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle) \\
m_\psi    & = & \text{length}_R(M/
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle) \\
\delta_\varphi & = & \text{length}_R(
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle
\langle z_1, \ldots, z_l\rangle) \\
\delta_\psi & = & \text{length}_R(
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle
\langle z_1, \ldots, z_l\rangle)
\end{eqnarray*}
Using the exact sequences $0 \to K_\varphi \to M \to I_\varphi \to 0$
we get $m_\varphi = k_\varphi + i_\varphi$. Similarly we have
$m_\psi = k_\psi + i_\psi$. We have
$\delta_\varphi + m_\varphi = \delta_\psi + m_\psi$ since this
is equal to the colength of $\langle z_1, \ldots, z_l \rangle$
in $M$. Finally, we have
$$
\delta_\varphi = \text{ord}_{R/\mathfrak q}(f_\varphi),
\quad
\delta_\psi = \text{ord}_{R/\mathfrak q}(f_\psi)
$$
by our first application of the key Lemma \ref{lemma-key-lemma}.

\medskip\noindent
Next, let us compute the multiplicity of the periodic complex
\begin{eqnarray*}
e_R(M, \varphi, \psi) & = &
\text{length}_R(K_\varphi/I_\psi) - \text{length}_R(K_\psi/I_\varphi) \\
& = &
\text{length}_R(
\langle x_1, \ldots, x_b\rangle/
\langle s_1, \ldots, s_b\rangle)
+ k_\varphi - i_\psi \\
& & -
\text{length}_R(
\langle t_1, \ldots, t_a\rangle/
\langle y_1, \ldots, y_a\rangle)
- k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + k_\varphi - i_\psi - k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + m_\varphi - m_\psi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + \delta_\psi - \delta_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(f_\psi g/f_\varphi h)
\end{eqnarray*}
where we used the key Lemma \ref{lemma-key-lemma} twice in the third equality.
By our computation of $\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
this proves the proposition.
\end{proof}

\noindent
In most applications the following lemma suffices.

\begin{lemma}
\label{lemma-application-herbrand-quotient}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module, and let $\psi : M \to M$ be an
$R$-module map. Assume that
\begin{enumerate}
\item $\Ker(\psi)$ and $\Coker(\psi)$ have finite length, and
\item $\dim(\text{Supp}(M)) \leq 1$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$
and denote $f_i \in \kappa(\mathfrak q_i)^*$ the element such that
$\det_{\kappa(\mathfrak q_i)}(\psi_{\mathfrak q_i}) :
\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})
\to \det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})$
is multiplication by $f_i$. Then
we have
$$
\text{length}_R(\Coker(\psi))
-
\text{length}_R(\Ker(\psi))
=
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(f_i).
$$
\end{lemma}

\begin{proof}
Recall that $H^0(M, 0, \psi) = \Coker(\psi)$ and
$H^1(M, 0, \psi) = \Ker(\psi)$, see remarks above
Definition \ref{definition-periodic-length}.
The lemma follows by combining
Proposition \ref{proposition-length-determinant-periodic-complex} with
Lemma \ref{lemma-periodic-determinant-easy-case}.

\medskip\noindent
Alternative proof. Reduce to the case
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$
as in the proof of
Proposition \ref{proposition-length-determinant-periodic-complex}.
Then directly combine
Lemmas \ref{lemma-key-lemma} and
\ref{lemma-good-sequence-exists}
to prove this specific case of
Proposition \ref{proposition-length-determinant-periodic-complex}.
There is much less bookkeeping in this case, and the reader is
encouraged to work this out. Details omitted.
\end{proof}




\subsection{Application to the key lemma}
\label{subsection-application-tame-symbol}

\noindent
In this section we apply the results above to show the
analogue of the key lemma (Lemma \ref{lemma-milnor-gersten-low-degree})
with the tame symbol $d_A$ constructed above. Please
see Remark \ref{remark-gersten-complex-milnor}
for the relationship with Milnor $K$-theory.

\begin{lemma}[Key Lemma]
\label{lemma-secondary-ramification}
\begin{reference}
When $A$ is an excellent ring this is \cite[Proposition 1]{Kato-Milnor-K}.
\end{reference}
Let $A$ be a $2$-dimensional Noetherian local domain with fraction field $K$.
Let $f, g \in K^*$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the height
$1$ primes $\mathfrak q$ of $A$ such that either $f$ or $g$ is not an
element of $A^*_{\mathfrak q}$.
Then we have
$$
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{A/\mathfrak q_i}(d_{A_{\mathfrak q_i}}(f, g))
=
0
$$
We can also write this as
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(d_{A_{\mathfrak q}}(f, g))
=
0
$$
since at any height one prime $\mathfrak q$
of $A$ where $f, g \in A^*_{\mathfrak q}$
we have $d_{A_{\mathfrak q}}(f, g) = 1$ by
Lemma \ref{lemma-symbol-when-one-is-a-unit}.
\end{lemma}

\begin{proof}
Since the tame symbols $d_{A_{\mathfrak q}}(f, g)$ are additive
(Lemma \ref{lemma-multiplicativity-symbol}) and the order
functions $\text{ord}_{A/\mathfrak q}$
are additive (Algebra, Lemma \ref{algebra-lemma-ord-additive})
it suffices to prove the formula when $f = a \in A$ and
$g = b \in A$. In this case we see that we have to show
$$
\sum\nolimits_{\text{height}(\mathfrak q) = 1}
\text{ord}_{A/\mathfrak q}(\det\nolimits_\kappa(A_{\mathfrak q}/(ab), a, b))
= 0
$$
By Proposition \ref{proposition-length-determinant-periodic-complex}
this is equivalent to showing that
$$
e_A(A/(ab), a, b) = 0.
$$
Since the complex
$A/(ab) \xrightarrow{a} A/(ab) \xrightarrow{b} A/(ab) \xrightarrow{a} A/(ab)$
is exact we win.
\end{proof}





\section{Appendix B: Alternative approaches}
\label{section-appendix-chow}

\noindent
In this appendix we first briefly try to connect the material
in the main text with $K$-theory of coherent sheaves. In
particular we describe how cupping with $c_1$ of an invertible
module is related to tensoring by this invertible module, see
Lemma \ref{lemma-coherent-sheaf-cap-c1}.
This material is obviously very interesting and
deserves a much more detailed and expansive exposition.
In the final part (Subsections
\ref{subsection-blowing-up-lemmas} and
\ref{subsection-commutativity})
we discuss some blowing up lemmas and how this relates
to commutativity of intersecting with divisors; we urge
the reader to avoid reading these subsections.


\subsection{Rational equivalence and K-groups}
\label{subsection-rational-equivalence-K-groups}

\noindent
In this section we compare the cycle groups $Z_k(X)$ and
the Chow groups $A_k(X)$ with certain $K_0$-groups of
abelian categories of coherent sheaves on $X$. We avoid having
to talk about $K_1(\mathcal{A})$ for an abelian category
$\mathcal{A}$ by dint of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}.
In particular, the motivation for the precise form of
Lemma \ref{lemma-maps-between-coherent-sheaves} is that lemma.

\medskip\noindent
Let us introduce the following notation.
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
We denote $\textit{Coh}(X) = \textit{Coh}(\mathcal{O}_X)$
the category of coherent sheaves on $X$.
It is an abelian category, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.
For any $k \in \mathbf{Z}$ we let $\textit{Coh}_{\leq k}(X)$
be the full subcategory of $\textit{Coh}(X)$
consisting of those coherent sheaves $\mathcal{F}$
having $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-Serre-subcategories}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
The categories $\textit{Coh}_{\leq k}(X)$ are Serre subcategories
of the abelian category $\textit{Coh}(X)$.
\end{lemma}

\begin{proof}
Omitted. The definition of a Serre subcategory is
Homology, Definition \ref{homology-definition-serre-subcategory}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-k-group}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
There are maps
$$
Z_k(X)
\longrightarrow
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow
Z_k(X)
$$
whose composition is the identity. The first is the map
$$
\sum n_Z[Z] \mapsto
\left[\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}\right]
-
\left[\bigoplus\nolimits_{n_Z < 0} \mathcal{O}_Z^{\oplus -n_Z}\right]
$$
and the second comes from the map $\mathcal{F} \mapsto [\mathcal{F}]_k$.
If $X$ is quasi-compact, then both maps are isomorphisms.
\end{lemma}

\begin{proof}
Note that the direct sum
$\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}$
is indeed a coherent sheaf on $X$ since the family $\{Z \mid n_Z > 0\}$
is locally finite on $X$.
The map $\mathcal{F} \to [\mathcal{F}]_k$ is additive
on $\textit{Coh}_{\leq k}(X)$, see
Lemma \ref{lemma-additivity-sheaf-cycle}. And $[\mathcal{F}]_k = 0$
if $\mathcal{F} \in \textit{Coh}_{\leq k - 1}(X)$.
This implies we have the left map as shown in the lemma.
It is clear that their composition is the identity.

\medskip\noindent
In case $X$ is quasi-compact we will show that the right arrow
is injective.
Suppose that $q \in K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k + 1}(X))$
maps to zero in $Z_k(X)$. By
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
we can find
a $\tilde q \in K_0(\textit{Coh}_{\leq k}(X))$ mapping to $q$.
Write $\tilde q = [\mathcal{F}] - [\mathcal{G}]$ for some
$\mathcal{F}, \mathcal{G} \in K_0(\textit{Coh}_{\leq k}(X))$.
Since $X$ is quasi-compact we may apply
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-filter}.
This shows that there exist integral closed subschemes
$Z_j, T_i \subset X$ and (nonzero) ideal sheaves
$\mathcal{I}_j \subset \mathcal{O}_{Z_j}$,
$\mathcal{I}_i \subset \mathcal{O}_{T_i}$ such that
$\mathcal{F}$, resp.\ $\mathcal{G}$ have filtrations whose successive
quotients are the sheaves $\mathcal{I}_j$, resp.\ $\mathcal{I}_i$.
In particular we see that $\dim_\delta(Z_j), \dim_\delta(T_i) \leq k$.
In other words we have
$$
[\mathcal{F}] = \sum\nolimits_j [\mathcal{I}_j],
\quad
[\mathcal{G}] = \sum\nolimits_i [\mathcal{I}_i],
$$
in $K_0(\textit{Coh}_{\leq k}(X))$. Our assumption is that
$\sum_j [\mathcal{I}_j]_k - \sum_i [\mathcal{I}_i]_k = 0$.
It is clear that we may throw out the indices $j$, resp.\ $i$
such that $\dim_\delta(Z_j) < k$, resp.\ $\dim_\delta(T_i) < k$,
since the corresponding sheaves are in $\textit{Coh}_{k - 1}(X)$ and
also do not contribute to the cycle. Moreover, the exact sequences
$0 \to \mathcal{I}_j \to \mathcal{O}_{Z_j} \to
\mathcal{O}_{Z_j}/\mathcal{I}_j \to 0$
and
$0 \to \mathcal{I}_i \to \mathcal{O}_{T_i} \to
\mathcal{O}_{Z_i}/\mathcal{I}_i \to 0$
show similarly that we may replace $\mathcal{I}_j$, resp.\ $\mathcal{I}_i$
by $\mathcal{O}_{Z_j}$, resp.\ $\mathcal{O}_{T_i}$.
OK, and finally, at this point it is clear that our assumption
$$
\sum\nolimits_j [\mathcal{O}_{Z_j}]_k - \sum\nolimits_i [\mathcal{O}_{T_i}]_k
= 0
$$
implies that in $K_0(\textit{Coh}_k(X))$ we have also
$\sum\nolimits_j [\mathcal{O}_{Z_j}] - \sum\nolimits_i [\mathcal{O}_{T_i}]
= 0$
as desired.
\end{proof}

\begin{remark}
\label{remark-not-true-not-quasi-compact}
It seems likely that the arrows of Lemma \ref{lemma-cycles-k-group}
are not isomorphisms if $X$ is not quasi-compact. For example, suppose $X$ is
an infinite disjoint union $X = \coprod_{n \in \mathbf{N}} \mathbf{P}^1_k$
over a field $k$. Let $\mathcal{F}$, resp.\ $\mathcal{G}$ be the coherent
sheaf on $X$ whose restriction to the $n$th summand is equal to the skyscraper
sheaf at $0$ associated to $\mathcal{O}_{\mathbf{P}^1_k, 0}/\mathfrak m_0^n$,
resp.\ $\kappa(0)^{\oplus n}$. The cycle associated to $\mathcal{F}$ is
equal to the cycle associated to $\mathcal{G}$, namely both are equal to
$\sum n[0_n]$ where $0_n \in X$ denotes $0$ on the $n$th component of $X$.
But there seems to be no way to show that
$[\mathcal{F}] = [\mathcal{G}]$ in $K_0(\textit{Coh}(X))$ since
any proof we can envision uses infinitely many relations.
\end{remark}

\begin{lemma}
\label{lemma-maps-between-coherent-sheaves}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Let
$$
\xymatrix{
\ldots \ar[r] &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r]^\psi &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r] & \ldots
}
$$
be a complex as in Homology, Equation (\ref{homology-equation-cyclic-complex}).
Assume that
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$.
\item $\dim_\delta(\text{Supp}(H^i(\mathcal{F}, \varphi, \psi))) \leq k$
for $i = 0, 1$.
\end{enumerate}
Then we have
$$
[H^0(\mathcal{F}, \varphi, \psi)]_k
\sim_{rat}
[H^1(\mathcal{F}, \varphi, \psi)]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$. Note that $\{W_j\}$
is a locally finite collection of closed subsets of
$X$ by Lemma \ref{lemma-length-finite}.
For every $j$, let $\xi_j \in W_j$ be the generic point.
Set
$$
f_j = \det\nolimits_{\kappa(\xi_j)}
(\mathcal{F}_{\xi_j}, \varphi_{\xi_j}, \psi_{\xi_j})
\in
R(W_j)^*.
$$
See Definition \ref{definition-periodic-determinant} for notation.
We claim that
$$
- [H^0(\mathcal{F}, \varphi, \psi)]_k + [H^1(\mathcal{F}, \varphi, \psi)]_k
=
\sum (W_j \to X)_*\text{div}(f_j)
$$
If we prove this then the lemma follows.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z]$ in
$
[H^0(\mathcal{F}, \varphi, \psi)]_k - [H^1(\mathcal{F}, \varphi, \psi)]_k
$
is the same as the coefficient $m$ of $[Z]$ in
$
\sum (W_j \to X)_*\text{div}(f_j)
$.
Let $\xi \in Z$ be the generic point.
Consider the local ring $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Denote $\varphi, \psi : M \to M$ the action of $\varphi, \psi$ on
the stalk.
By our choice of $\xi \in Z$ we have $\delta(\xi) = k$
and hence $\dim(\text{Supp}(M)) = 1$.
Finally, the integral closed subschemes
$W_j$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Supp}(M)$.
In each case the element $f_j \in R(W_j)^*$ corresponds to
the element $\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi)$
in $\kappa(\mathfrak q_i)^*$. Hence we see that
$$
n = - e_A(M, \varphi, \psi)
$$
and
$$
m =
\sum
\text{ord}_{A/\mathfrak q_i}
(\det\nolimits_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi))
$$
Thus the result follows from
Proposition \ref{proposition-length-determinant-periodic-complex}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-rational-equivalence-K-group}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Denote $B_k(X)$ the image of the map
$$
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow
K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X)).
$$
There is a commutative diagram
$$
\xymatrix{
K_0\left(\frac{\textit{Coh}_{\leq k}(X)}{\textit{Coh}_{\leq k - 1}(X)}\right)
\ar[r] \ar[d] &
B_k(X) \ar[d] \ar@{^{(}->}[r] &
K_0\left(\frac{\textit{Coh}_{\leq k + 1}(X)}{\textit{Coh}_{\leq k - 1}(X)}\right)
\\
Z_k(X) \ar[r] & A_k(X)
}
$$
where the left vertical arrow is the one from
Lemma \ref{lemma-cycles-k-group}. If $X$ is quasi-compact
then both vertical arrows are isomorphisms.
\end{lemma}

\begin{proof}
Suppose we have an element $[A] - [B]$ of
$K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$
which maps to zero in $B_k(X)$, i.e., in
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Suppose $[A] = [\mathcal{A}]$ and $[B] = [\mathcal{B}]$
for some coherent sheaves $\mathcal{A}, \mathcal{B}$ on
$X$ supported in $\delta$-dimension $\leq k$.
The assumption that $[A] - [B]$ maps to zero in the group
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$
means that there exists coherent sheaves
$\mathcal{A}', \mathcal{B}'$ on $X$ supported in
$\delta$-dimension $\leq k - 1$ such that
$[\mathcal{A} \oplus \mathcal{A}'] - [\mathcal{B} \oplus \mathcal{B}']$
is zero in $K_0(\textit{Coh}_{k + 1}(X))$ (use part (1) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}).
By part (2) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
this means there exists a $(2, 1)$-periodic complex
$(\mathcal{F}, \varphi, \psi)$ in the category $\textit{Coh}_{\leq k + 1}(X)$
such that
$\mathcal{A} \oplus \mathcal{A}' = H^0(\mathcal{F}, \varphi, \psi)$
and $\mathcal{B} \oplus \mathcal{B}' = H^1(\mathcal{F}, \varphi, \psi)$.
By Lemma \ref{lemma-maps-between-coherent-sheaves}
this implies that
$$
[\mathcal{A} \oplus \mathcal{A}']_k
\sim_{rat}
[\mathcal{B} \oplus \mathcal{B}']_k
$$
This proves that $[A] - [B]$ maps to zero via the composition
$$
K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))
\longrightarrow Z_k(X)
\longrightarrow A_k(X).
$$
In other words this proves the
commutative diagram exists.

\medskip\noindent
Next, assume that $X$ is quasi-compact. By Lemma \ref{lemma-cycles-k-group}
the left vertical arrow is bijective. Hence it suffices to show
any $\alpha \in Z_k(X)$ which is rationally equivalent to zero
maps to zero in $B_k(X)$ via the inverse of the left vertical
arrow composed with the horizontal arrow.
By Lemma \ref{lemma-rational-equivalence-family} we see that
$\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$ for some
closed integral subschemes $W_i \subset X \times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$. Moreover the family
$\{W_i\}$ is finite because $X$ is quasi-compact.
Note that the ideal sheaves
$\mathcal{I}_i, \mathcal{J}_i \subset \mathcal{O}_{W_i}$
of the effective Cartier divisors $(W_i)_0, (W_i)_\infty$
are isomorphic (as $\mathcal{O}_{W_i}$-modules). This is true
because the ideal sheaves of $D_0$ and $D_\infty$ on $\mathbf{P}^1$
are isomorphic and $\mathcal{I}_i, \mathcal{J}_i$ are the pullbacks of
these. (Some details omitted.) Hence we have
short exact sequences
$$
0 \to \mathcal{I}_i \to \mathcal{O}_{W_i} \to \mathcal{O}_{(W_i)_0} \to 0,
\quad
0 \to \mathcal{J}_i \to \mathcal{O}_{W_i} \to \mathcal{O}_{(W_i)_\infty} \to 0
$$
of coherent $\mathcal{O}_{W_i}$-modules.
Also, since $[(W_i)_0]_k = [p_*\mathcal{O}_{(W_i)_0}]_k$ in
$Z_k(X)$ we see that the inverse of the left vertical arrow
maps $[(W_i)_0]_k$ to the element $[p_*\mathcal{O}_{(W_i)_0}]$ in
$K_0(\textit{Coh}_{\leq k}(X)/\textit{Coh}_{\leq k - 1}(X))$.
Thus we have
\begin{eqnarray*}
\alpha
& = &
\sum \left([(W_i)_0]_k - [(W_i)_\infty]_k\right) \\
& \mapsto &
\sum \left([p_*\mathcal{O}_{(W_i)_0}] - [p_*\mathcal{O}_{(W_i)_\infty}]\right)
\\
& = &
\sum \left([p_*\mathcal{O}_{W_i}] - [p_*\mathcal{I}_i]
- [p_*\mathcal{O}_{W_i}] + [p_*\mathcal{J}_i]\right)
\end{eqnarray*}
in $K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
By what was said above this is zero, and we win.
\end{proof}

\begin{remark}
\label{remark-good-cases-K-A}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Assume $X$ is quasi-compact.
The result of Lemma \ref{lemma-cycles-rational-equivalence-K-group}
in particular gives a map
$$
A_k(X)
\longrightarrow
K_0(\textit{Coh}(X)/\textit{Coh}_{\leq k - 1}(X)).
$$
We have not been able to find a statement or conjecture in the
literature as to whether this map is should be injective or not.
If $X$ is connected nonsingular, then, using the
isomorphism $K_0(X) = K^0(X)$ (see insert future reference here)
and chern classes (see below), one can show that
the map is an isomorphism up to $(p - 1)!$-torsion where
$p = \dim_\delta(X) - k$.
\end{remark}















\subsection{Cartier divisors and K-groups}
\label{subsection-cartier-coherent}

\noindent
In this section we describe how the intersection with the
first chern class of an invertible sheaf $\mathcal{L}$
corresponds to tensoring with $\mathcal{L} - \mathcal{O}$
in $K$-groups.

\begin{lemma}
\label{lemma-no-embedded-points-modules}
Let $A$ be a Noetherian local ring.
Let $M$ be a finite $A$-module.
Let $a, b \in A$.
Assume
\begin{enumerate}
\item $\dim(A) = 1$,
\item both $a$ and $b$ are nonzerodivisors in $A$,
\item $A$ has no embedded primes,
\item $M$ has no embedded associated primes,
\item $\text{Supp}(M) = \Spec(A)$.
\end{enumerate}
Let $I = \{x \in A \mid x(a/b) \in A\}$.
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal
primes of $A$. Then $(a/b)IM \subset M$ and
$$
\text{length}_A(M/(a/b)IM)
-
\text{length}_A(M/IM)
=
\sum\nolimits_i
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(a/b)
$$
\end{lemma}

\begin{proof}
Since $M$ has no embedded associated primes, and since
the support of $M$ is $\Spec(A)$ we see that
$\text{Ass}(M) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$.
Hence $a$, $b$ are nonzerodivisors on $M$. Note that
\begin{align*}
& \text{length}_A(M/(a/b)IM) \\
& = \text{length}_A(bM/aIM) \\
& = \text{length}_A(M/aIM)
-
\text{length}_A(M/bM) \\
& = \text{length}_A(M/aM) + \text{length}_A(aM/aIM) - \text{length}_A(M/bM) \\
& = \text{length}_A(M/aM) + \text{length}_A(M/IM) - \text{length}_A(M/bM)
\end{align*}
as the injective map $b : M \to bM$ maps $(a/b)IM$ to $aIM$
and the injective map $a : M \to aM$ maps $IM$ to $aIM$.
Hence the left hand side of the equation of the lemma is
equal to
$$
\text{length}_A(M/aM) - \text{length}_A(M/bM).
$$
Applying the second formula of
Lemma \ref{lemma-additivity-divisors-restricted}
with $x = a, b$ respectively
and using Algebra, Definition \ref{algebra-definition-ord}
of the $\text{ord}$-functions we get the result.
\end{proof}

\begin{lemma}
\label{lemma-no-embedded-points}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{K}_X(\mathcal{L}))$ be a
meromorphic section of $\mathcal{L}$.
Assume
\begin{enumerate}
\item $\dim_\delta(X) \leq k + 1$,
\item $X$ has no embedded points,
\item $\mathcal{F}$ has no embedded associated points,
\item the support of $\mathcal{F}$ is $X$, and
\item the section $s$ is regular meromorphic.
\end{enumerate}
In this situation let $\mathcal{I} \subset \mathcal{O}_X$
be the ideal of denominators of $s$, see
Divisors,
Definition \ref{divisors-definition-regular-meromorphic-ideal-denominators}.
Then we have the following:
\begin{enumerate}
\item there are short exact sequences
$$
\begin{matrix}
0 &
\to &
\mathcal{I}\mathcal{F} &
\xrightarrow{1} &
\mathcal{F} &
\to &
\mathcal{Q}_1 &
\to &
0 \\
0 &
\to &
\mathcal{I}\mathcal{F} &
\xrightarrow{s} &
\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L} &
\to &
\mathcal{Q}_2 &
\to &
0
\end{matrix}
$$
\item the coherent sheaves $\mathcal{Q}_1$, $\mathcal{Q}_2$
are supported in $\delta$-dimension $\leq k$,
\item the section $s$ restricts to a regular meromorphic
section $s_i$ on every irreducible component $X_i$ of
$X$ of $\delta$-dimension $k + 1$, and
\item writing $[\mathcal{F}]_{k + 1} = \sum m_i[X_i]$ we have
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
\sum m_i(X_i \to X)_*\text{div}_{\mathcal{L}|_{X_i}}(s_i)
$$
in $Z_k(X)$, in particular
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}
$$
in $A_k(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Recall from Divisors, Lemma \ref{divisors-lemma-make-maps-regular-section}
the existence of injective maps
$1 : \mathcal{I}\mathcal{F} \to \mathcal{F}$ and
$s : \mathcal{I}\mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X}\mathcal{L}$
whose cokernels are supported on a closed nowhere dense subsets $T$.
Denote $\mathcal{Q}_i$ there cokernels as in the lemma.
We conclude that $\dim_\delta(\text{Supp}(\mathcal{Q}_i)) \leq k$.
By Divisors, Lemmas \ref{divisors-lemma-pullback-meromorphic-sections-defined}
and \ref{divisors-lemma-meromorphic-sections-pullback} the pullbacks $s_i$
are defined and are regular meromorphic sections for $\mathcal{L}|_{X_i}$.
The equality of cycles in (4) implies the equality of cycle classes
in (4). Hence the only remaining thing to show is that
$$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
=
\sum m_i(X_i \to X)_*\text{div}_{\mathcal{L}|_{X_i}}(s_i)
$$
holds in $Z_k(X)$. To see this, let $Z \subset X$ be an integral closed
subscheme of $\delta$-dimension $k$. Let $\xi \in Z$ be the generic point.
Let $A = \mathcal{O}_{X, \xi}$ and $M = \mathcal{F}_\xi$.
Moreover, choose a generator $s_\xi \in \mathcal{L}_\xi$.
Then we can write $s = (a/b) s_\xi$ where $a, b \in A$ are
nonzerodivisors. In this case
$I = \mathcal{I}_\xi = \{x \in A \mid x(a/b) \in A\}$.
In this case the coefficient of $[Z]$ in the left hand side is
$$
\text{length}_A(M/(a/b)IM) - \text{length}_A(M/IM)
$$
and the coefficient of $[Z]$ in the right hand side
is
$$
\sum
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
\text{ord}_{A/\mathfrak q_i}(a/b)
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the minimal
primes of the $1$-dimensional local ring $A$. Hence the result
follows from Lemma \ref{lemma-no-embedded-points-modules}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cap-c1}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Assume $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$.
Then the element
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
\in
K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))
$$
lies in the subgroup $B_k(X)$ of
Lemma \ref{lemma-cycles-rational-equivalence-K-group} and maps to
the element $c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}$ via
the map $B_k(X) \to A_k(X)$.
\end{lemma}

\begin{proof}
Let
$$
0 \to \mathcal{K} \to \mathcal{F} \to \mathcal{F}' \to 0
$$
be the short exact sequence constructed in
Divisors, Lemma \ref{divisors-lemma-remove-embedded-points}.
This in particular means that $\mathcal{F}'$ has no embedded
associated points.
Since the support of $\mathcal{K}$ is nowhere dense in the
support of $\mathcal{F}$ we see that
$\dim_\delta(\text{Supp}(\mathcal{K})) \leq k$. We may
re-apply
Divisors, Lemma \ref{divisors-lemma-remove-embedded-points}
starting with $\mathcal{K}$ to get a short exact sequence
$$
0 \to \mathcal{K}'' \to \mathcal{K} \to \mathcal{K}' \to 0
$$
where now $\dim_\delta(\text{Supp}(\mathcal{K}'')) < k$
and $\mathcal{K}'$ has no embedded associated points.
Suppose we can prove the lemma for the coherent sheaves
$\mathcal{F}'$ and $\mathcal{K}'$. Then we see
from the equations
$$
[\mathcal{F}]_{k + 1}
=
[\mathcal{F}']_{k + 1}
+ [\mathcal{K}']_{k + 1}
+ [\mathcal{K}'']_{k + 1}
$$
(use Lemma \ref{lemma-additivity-sheaf-cycle}),
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
=
[\mathcal{F}' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}']
+
[\mathcal{K}' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{K}']
+
[\mathcal{K}'' \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{K}'']
$$
(use the $\otimes \mathcal{L}$ is exact)
and the trivial vanishing of $[\mathcal{K}'']_{k + 1}$ and
$[\mathcal{K}'' \otimes_{\mathcal{O}_X} \mathcal{L}]
- [\mathcal{K}'']$ in
$K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$
that the result holds
for $\mathcal{F}$. What this means is that we may assume that
the sheaf $\mathcal{F}$ has no embedded associated points.

\medskip\noindent
Assume $X$, $\mathcal{F}$ as in the lemma, and assume in addition
that $\mathcal{F}$ has no embedded associated points. Consider the
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$, the corresponding
closed subscheme $i : Z \to X$ and the coherent $\mathcal{O}_Z$-module
$\mathcal{G}$ constructed in
Divisors, Lemma \ref{divisors-lemma-no-embedded-points-endos}.
Recall that $Z$ is a locally Noetherian scheme without embedded points,
$\mathcal{G}$ is a coherent sheaf without embedded
associated points, with $\text{Supp}(\mathcal{G}) = Z$
and such that $i_*\mathcal{G} = \mathcal{F}$.
Moreover, set $\mathcal{N} = \mathcal{L}|_Z$.

\medskip\noindent
By Divisors, Lemma \ref{divisors-lemma-regular-meromorphic-section-exists}
the invertible sheaf $\mathcal{N}$ has a regular meromorphic section $s$
over $Z$. Let us denote $\mathcal{J} \subset \mathcal{O}_Z$ the sheaf
of denominators of $s$. By Lemma \ref{lemma-no-embedded-points}
there exist short exact sequences
$$
\begin{matrix}
0 &
\to &
\mathcal{J}\mathcal{G} &
\xrightarrow{1} &
\mathcal{G} &
\to &
\mathcal{Q}_1 &
\to &
0 \\
0 &
\to &
\mathcal{J}\mathcal{G} &
\xrightarrow{s} &
\mathcal{G} \otimes_{\mathcal{O}_Z} \mathcal{N} &
\to &
\mathcal{Q}_2 &
\to &
0
\end{matrix}
$$
such that $\dim_\delta(\text{Supp}(\mathcal{Q}_i)) \leq k$ and
such that the cycle
$
[\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k
$
is a representative of $c_1(\mathcal{N}) \cap [\mathcal{G}]_{k + 1}$.
We see (using the fact that
$i_*(\mathcal{G} \otimes \mathcal{N}) = \mathcal{F} \otimes \mathcal{L}$
by the projection formula, see
Cohomology, Lemma \ref{cohomology-lemma-projection-formula})
that
$$
[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}]
-
[\mathcal{F}]
=
[i_*\mathcal{Q}_2] - [i_*\mathcal{Q}_1]
$$
in $K_0(\textit{Coh}_{\leq k + 1}(X)/\textit{Coh}_{\leq k - 1}(X))$.
This already shows that
$[\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{L}] - [\mathcal{F}]$
is an element of $B_k(X)$. Moreover we have
\begin{eqnarray*}
[i_*\mathcal{Q}_2]_k - [i_*\mathcal{Q}_1]_k
& = &
i_*\left( [\mathcal{Q}_2]_k - [\mathcal{Q}_1]_k \right) \\
& = &
i_*\left(c_1(\mathcal{N}) \cap [\mathcal{G}]_{k + 1} \right) \\
& = &
c_1(\mathcal{L}) \cap i_*[\mathcal{G}]_{k + 1} \\
& = &
c_1(\mathcal{L}) \cap [\mathcal{F}]_{k + 1}
\end{eqnarray*}
by the above and Lemmas \ref{lemma-pushforward-cap-c1}
and \ref{lemma-cycle-push-sheaf}. And this agree with the
image of the element under $B_k(X) \to A_k(X)$ by definition.
Hence the lemma is proved.
\end{proof}



















\subsection{Blowing up lemmas}
\label{subsection-blowing-up-lemmas}

\noindent
In this section we prove some lemmas on representing
Cartier divisors by suitable effective Cartier divisors
on blowups. These lemmas can be found in \cite[Section 2.4]{F}.
We have adapted the formulation so they also work
in the non-finite type setting. It may happen that the morphism $b$
of Lemma \ref{lemma-blowing-up-intersections} is a composition of
infinitely many blowups, but over any given quasi-compact open
$W \subset X$ one needs only finitely many blowups
(and this is the result of loc.\ cit.).

\begin{lemma}
\label{lemma-push-pull-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a proper morphism.
Let $D \subset Y$ be an effective Cartier divisor.
Assume $X$, $Y$ integral, $n = \dim_\delta(X) = \dim_\delta(Y)$ and
$f$ dominant. Then
$$
f_*[f^{-1}(D)]_{n - 1} = [R(X) : R(Y)] [D]_{n - 1}.
$$
In particular if $f$ is birational then $f_*[f^{-1}(D)]_{n - 1} = [D]_{n - 1}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-equal-c1-as-cycles}
and the fact that $D$ is the zero
scheme of the canonical section $1_D$ of $\mathcal{O}_X(D)$.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-denominators}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral with $\dim_\delta(X) = n$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
Let $U \subset X$ be the maximal open subscheme such that
$s$ corresponds to a section of $\mathcal{L}$ over $U$.
There exists a projective morphism
$$
\pi : X' \longrightarrow X
$$
such that
\begin{enumerate}
\item $X'$ is integral,
\item $\pi|_{\pi^{-1}(U)} : \pi^{-1}(U) \to U$ is an isomorphism,
\item there exist effective Cartier divisors $D, E \subset X'$
such that
$$
\pi^*\mathcal{L} = \mathcal{O}_{X'}(D - E),
$$
\item the meromorphic section $s$ corresponds, via the isomorphism above,
to the meromorphic section $1_D \otimes (1_E)^{-1}$ (see
Divisors, Definition
\ref{divisors-definition-invertible-sheaf-effective-Cartier-divisor}),
\item we have
$$
\pi_*([D]_{n - 1} - [E]_{n - 1}) = \text{div}_\mathcal{L}(s)
$$
in $Z_{n - 1}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent ideal sheaf
of denominators of $s$, see Divisors, Definition
\ref{divisors-definition-regular-meromorphic-ideal-denominators}.
By Divisors, Lemma \ref{divisors-lemma-blowing-up-denominators}
we get (2), (3), and (4).
By Divisors, Lemma \ref{divisors-lemma-blow-up-integral-scheme}
we get (1). By Divisors, Lemma \ref{divisors-lemma-blowing-up-projective}
the morphism $\pi$ is projective.
We still have to prove (5).
By Lemma \ref{lemma-equal-c1-as-cycles} we have
$$
\pi_*(\text{div}_{\mathcal{L}'}(s')) = \text{div}_\mathcal{L}(s).
$$
Hence it suffices to show that
$\text{div}_{\mathcal{L}'}(s') = [D]_{n - 1} - [E]_{n - 1}$.
This follows from the equality
$s' = 1_D \otimes 1_E^{-1}$ and additivity, see
Divisors, Lemma \ref{divisors-lemma-c1-additive}.
\end{proof}

\begin{definition}
\label{definition-epsilon}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = n - 1$. The {\it $\epsilon$-invariant}
of this situation is
$$
\epsilon_Z(D_1, D_2) = n_Z \cdot m_Z
$$
where $n_Z$, resp.\ $m_Z$ is the coefficient of
$Z$ in the $(n - 1)$-cycle $[D_1]_{n - 1}$, resp.\ $[D_2]_{n - 1}$.
\end{definition}

\begin{lemma}
\label{lemma-two-divisors}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z$ be an open and closed subscheme of the scheme $D_1 \cap D_2$.
Assume $\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Then there exists a morphism
$b : X' \to X$, and Cartier divisors
$D_1', D_2', E$ on $X'$ with the following properties
\begin{enumerate}
\item $X'$ is integral,
\item $b$ is projective,
\item $b$ is the blowup of $X$ in the closed subscheme $Z$,
\item $E = b^{-1}(Z)$,
\item $b^{-1}(D_1) = D'_1 + E$, and $b^{-1}D_2 = D_2' + E$,
\item $\dim_\delta(D'_1 \cap D'_2) \leq n - 2$, and if
$Z = D_1 \cap D_2$ then $D'_1 \cap D'_2 = \emptyset$,
\item for every integral closed subscheme $W'$
with $\dim_\delta(W') = n - 1$ we have
\begin{enumerate}
\item if $\epsilon_{W'}(D'_1, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_1, E) < \epsilon_W(D_1, D_2),
$$
\item if $\epsilon_{W'}(D'_2, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_2, E) < \epsilon_W(D_1, D_2),
$$
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the quasi-coherent ideal sheaf
$\mathcal{I} = \mathcal{I}_{D_1} + \mathcal{I}_{D_2}$
defines the scheme theoretic intersection $D_1 \cap D_2 \subset X$.
Since $Z$ is a union of connected components of $D_1 \cap D_2$
we see that for every $z \in Z$ the kernel of
$\mathcal{O}_{X, z} \to \mathcal{O}_{Z, z}$ is equal to $\mathcal{I}_z$.
Let $b : X' \to X$ be the blowup of $X$ in $Z$. (So Zariski locally
around $Z$ it is the blowup of $X$ in $\mathcal{I}$.)
Denote $E = b^{-1}(Z)$ the corresponding effective Cartier divisor, see
Divisors,
Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
Since $Z \subset D_1$ we have $E \subset f^{-1}(D_1)$ and hence
$D_1 = D_1' + E$ for some effective Cartier divisor $D'_1 \subset X'$,
see Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}.
Similarly $D_2 = D_2' + E$. This takes care of assertions (1) -- (5).

\medskip\noindent
Note that if $W'$ is as in (7) (a) or (7) (b), then the image $W$
of $W'$ is contained in $D_1 \cap D_2$. If $W$ is not contained in
$Z$, then $b$ is an isomorphism at the generic point of $W$ and
we see that $\dim_\delta(W) = \dim_\delta(W') = n - 1$ which
contradicts the assumption that
$\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Hence $W \subset Z$. This means that
to prove (6) and (7) we may work locally around $Z$ on $X$.

\medskip\noindent
Thus we may assume that $X = \Spec(A)$ with
$A$ a Noetherian domain, and $D_1 = \Spec(A/a)$,
$D_2 = \Spec(A/b)$ and $Z = D_1 \cap D_2$.
Set $I = (a, b)$. Since $A$ is a domain and $a, b \not = 0$ we can
cover the blowup by two patches, namely
$U = \Spec(A[s]/(as - b))$ and $V = \Spec(A[t]/(bt -a))$.
These patches are glued using the isomorphism
$A[s, s^{-1}]/(as - b) \cong A[t, t^{-1}]/(bt - a)$
which maps $s$ to $t^{-1}$.
The effective Cartier divisor $E$ is described by
$\Spec(A[s]/(as - b, a)) \subset U$ and
$\Spec(A[t]/(bt - a, b)) \subset V$.
The closed subscheme $D'_1$ corresponds to
$\Spec(A[t]/(bt - a, t)) \subset U$.
The closed subscheme $D'_2$ corresponds to
$\Spec(A[s]/(as -b, s)) \subset V$.
Since ``$ts = 1$'' we see that $D'_1 \cap D'_2 = \emptyset$.

\medskip\noindent
Suppose we have a prime $\mathfrak q \subset A[s]/(as - b)$
of height one with $s, a \in \mathfrak q$.
Let $\mathfrak p \subset A$ be the corresponding prime of $A$.
Observe that $a, b \in \mathfrak p$.
By the dimension formula we see that $\dim(A_{\mathfrak p}) = 1$
as well. The final assertion to be shown is that
$$
\text{ord}_{A_{\mathfrak p}}(a)
\text{ord}_{A_{\mathfrak p}}(b)
>
\text{ord}_{B_{\mathfrak q}}(a)
\text{ord}_{B_{\mathfrak q}}(s)
$$
where $B = A[s]/(as - b)$. By
Algebra, Lemma \ref{algebra-lemma-quasi-finite-extension-dim-1}
we have $\text{ord}_{A_{\mathfrak p}}(x) \geq \text{ord}_{B_{\mathfrak q}}(x)$
for $x = a, b$. Since $\text{ord}_{B_{\mathfrak q}}(s) > 0$ we win
by additivity of the $\text{ord}$ function and the fact that
$as = b$.
\end{proof}

\begin{definition}
\label{definition-locally-finite-sum-effective-Cartier-divisors}
Let $X$ be a scheme.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$.
Suppose given a function
$I \to \mathbf{Z}_{\geq 0}$, $i \mapsto n_i$.
The {\it sum of the effective Cartier divisors}
$D = \sum n_i D_i$, is the unique effective Cartier divisor
$D \subset X$ such that on any quasi-compact open $U \subset X$
we have $D|_U = \sum_{D_i \cap U \not = \emptyset} n_iD_i|_U$
is the sum as in Divisors,
Definition \ref{divisors-definition-sum-effective-Cartier-divisors}.
\end{definition}

\begin{lemma}
\label{lemma-sum-divisors-associated-Weil}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$.
Suppose given $n_i \geq 0$ for $i \in I$.
Then
$$
[D]_{n - 1} = \sum\nolimits_i n_i[D_i]_{n - 1}
$$
in $Z_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Since we are proving an equality of cycles we may work locally on $X$.
Hence this reduces to a finite sum, and by induction to a sum of
two effective Cartier divisors $D = D_1 + D_2$.
By Lemma \ref{lemma-compute-c1} we see that
$D_1 = \text{div}_{\mathcal{O}_X(D_1)}(1_{D_1})$ where
$1_{D_1}$ denotes the canonical section of $\mathcal{O}_X(D_1)$.
Of course we have the same statement for $D_2$ and $D$.
Since $1_D = 1_{D_1} \otimes 1_{D_2}$ via the identification
$\mathcal{O}_X(D) = \mathcal{O}_X(D_1) \otimes \mathcal{O}_X(D_2)$
we win by Divisors, Lemma \ref{divisors-lemma-c1-additive}.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-intersections}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = d$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection of
effective Cartier divisors on $X$.
Assume that for all $\{i, j, k\} \subset I$, $\#\{i, j, k\} = 3$
we have $D_i \cap D_j \cap D_k = \emptyset$.
Then there exist
\begin{enumerate}
\item an open subscheme $U \subset X$ with
$\dim_\delta(X \setminus U) \leq d - 3$,
\item a morphism $b : U' \to U$, and
\item effective Cartier divisors $\{D'_j\}_{j \in J}$ on $U'$
\end{enumerate}
with the following properties:
\begin{enumerate}
\item $b$ is proper morphism $b : U' \to U$,
\item $U'$ is integral,
\item $b$ is an isomorphism over the complement of the union of the pairwise
intersections of the $D_i|_U$,
\item $\{D'_j\}_{j \in J}$ is a locally finite collection of effective
Cartier divisors on $U'$,
\item $\dim_\delta(D'_j \cap D'_{j'}) \leq d - 2$ if $j \not = j'$, and
\item $b^{-1}(D_i|_U) = \sum n_{ij} D'_j$ for certain $n_{ij} \geq 0$.
\end{enumerate}
Moreover, if $X$ is quasi-compact, then we may assume $U = X$ in the above.
\end{lemma}

\begin{proof}
Let us first prove this in the quasi-compact case, since it is perhaps
the most interesting case. In this case we produce inductively a sequence
of blowups
$$
X = X_0 \xleftarrow{b_0} X_1 \xleftarrow{b_1} X_2 \leftarrow \ldots
$$
and finite sets of effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \amalg P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$. Finally, we will have
$$
b_n^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$
We conclude that for each $n \geq 0$ we have
$(b_0 \circ \ldots \circ b_n)^{-1}(D_i)$ is a nonnegative
integer combination of the divisors $D_{n + 1, j}$, $j \in I_{n + 1}$.

\medskip\noindent
To start the induction we set $X_0 = X$ and
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\}_{i \in I_n})$ let $X_{n + 1}$ be the
blowup of $X_n$ in the closed subscheme
$Z_n = \bigcup_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Note that the closed subschemes $D_{n, i} \cap D_{n, i'}$ are pairwise
disjoint by our assumption on triple intersections.
In other words we may write
$Z_n = \coprod_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Moreover, in a Zariski neighbourhood of $D_{n, i} \cap D_{n, i'}$ the
morphism $b_n$ is equal to the blowup of the scheme $X_n$
in the closed subscheme $D_{n, i} \cap D_{n, i'}$, and the results
of Lemma \ref{lemma-two-divisors} apply.
Hence setting $D_{n + 1, \{i, i'\}} = b_n^{-1}(D_i \cap D_{i'})$
we get an effective Cartier divisor.
The Cartier divisors $D_{n + 1, \{i, i'\}}$ are pairwise disjoint.
Clearly we have
$b_n^{-1}(D_{n, i}) \supset D_{n + 1, \{i, i'\}}$ for
every $i' \in I_n$, $i' \not = i$. Hence, applying
Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}
we see that indeed $b^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$
for some effective Cartier divisor $D_{n + 1, i}$ on $X_{n + 1}$.
In a neighbourhood of $D_{n + 1, \{i, i'\}}$ these divisors
$D_{n + 1, i}$ play the role of the primed divisors of
Lemma \ref{lemma-two-divisors}. In particular we conclude that
$D_{n + 1, i} \cap D_{n + 1, i'} = \emptyset$ if $i \not = i'$,
$i, i' \in I_n$ by part (6) of Lemma \ref{lemma-two-divisors}.
This already implies that triple intersections
of the divisors $D_{n + 1, i}$ are zero.

\medskip\noindent
OK, and at this point we can use the quasi-compactness of $X$
to conclude that the invariant
\begin{equation}
\label{equation-invariant}
\epsilon(X, \{D_i\}_{i \in I}) =
\max\{\epsilon_Z(D_i, D_{i'}) \mid
Z \subset X,
\dim_\delta(Z) = d - 1,
\{i, i'\} \in P(I)\}
\end{equation}
is finite, since after all each $D_i$ has at most finitely many irreducible
components. We claim that for some $n$ the invariant
$\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ is zero. Namely, if not then
by Lemma \ref{lemma-two-divisors} we have a strictly decreasing sequence
$$
\epsilon(X, \{D_i\}_{i \in I})
=
\epsilon(X_0, \{D_{0, i}\}_{i \in I_0})
>
\epsilon(X_1, \{D_{1, i}\}_{i \in I_1})
>
\ldots
$$
of positive integers which is a contradiction. Take $n$ with
invariant $\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ equal to zero.
This means that there is no integral closed subscheme $Z \subset X_n$
and no pair of indices $i, i' \in I_n$
such that $\epsilon_Z(D_{n, i}, D_{n, i'}) > 0$.
In other words, $\dim_\delta(D_{n, i}, D_{n, i'}) \leq d - 2$ for
all pairs $\{i, i'\} \in P(I_n)$ as desired.

\medskip\noindent
Next, we come to the general case where we no longer assume that
the scheme $X$ is quasi-compact. The problem with the idea from
the first part of the proof is that we may get and infinite sequence
of blowups with centers dominating a fixed point of $X$. In order to
avoid this we cut out suitable closed subsets of codimension $\geq 3$
at each stage. Namely, we will construct by induction
a sequence of morphisms having the following shape
$$
\xymatrix{
X = X_0 \\
U_0 \ar[u]^{j_0} & X_1 \ar[l]_{b_0} \\
 & U_1 \ar[u]^{j_1} & X_2 \ar[l]_{b_1} \\
 & & U_2 \ar[u]^{j_2} & X_3 \ar[l]_{b_2}
}
$$
Each of the morphisms $j_n : U_n \to X_n$ will be an open immersion.
Each of the morphisms $b_n : X_{n + 1} \to U_n$ will be a proper birational
morphism of integral schemes. As in the quasi-compact case we will have
effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$ on $X_n$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \amalg P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$.
Finally, we will arrange it so that
$$
b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$

\medskip\noindent
We start the induction by setting $X_0 = X$,
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\})$ we construct the open subscheme
$U_n$ as follows. For each pair $\{i, i'\} \in P(I_n)$ consider
the closed subscheme $D_{n, i} \cap D_{n, i'}$. This has ``good''
irreducible components which have $\delta$-dimension $d - 2$ and
``bad'' irreducible components which have $\delta$-dimension $d - 1$.
Let us set
$$
\text{Bad}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 1} W
$$
and similarly
$$
\text{Good}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 2} W.
$$
Then $D_{n, i} \cap D_{n, i'} = \text{Bad}(i, i') \cup \text{Good}(i, i')$
and moreover we have
$\dim_\delta(\text{Bad}(i, i') \cap \text{Good}(i, i')) \leq d - 3$.
Here is our choice of $U_n$:
$$
U_n
=
X_n
\setminus
\bigcup\nolimits_{\{i, i'\} \in P(I_n)}
\text{Bad}(i, i') \cap \text{Good}(i, i').
$$
By our condition on triple intersections of the divisors $D_{n, i}$
we see that the union is actually a disjoint union. Moreover,
we see that (as a scheme)
$$
D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}
=
Z_{n, i, i'} \amalg G_{n, i, i'}
$$
where $Z_{n, i, i'}$ is $\delta$-equidimensional of dimension $d - 1$
and $G_{n, i, i'}$ is $\delta$-equidimensional of dimension $d - 2$.
(So topologically $Z_{n, i, i'}$ is the union of the bad components
but throw out intersections with good components.) Finally we set
$$
Z_n =
\bigcup\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'} =
\coprod\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'},
$$
and we let $b_n : X_{n + 1} \to X_n$ be the blowup in $Z_n$.
Note that Lemma \ref{lemma-two-divisors}
applies to the morphism $b_n : X_{n + 1} \to X_n$ locally around
each of the loci $D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}$. Hence,
exactly as in the first part of the proof we obtain effective
Cartier divisors $D_{n + 1, \{i, i'\}}$ for $\{i, i'\} \in P(I_n)$
and effective Cartier divisors $D_{n + 1, i}$ for $i \in I_n$
such that
$b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$.
For each $n$ denote $\pi_n : X_n \to X$ the morphism obtained
as the composition $j_0 \circ \ldots \circ j_{n - 1} \circ b_{n - 1}$.

\medskip\noindent
{\bf Claim:} given any quasi-compact open $V \subset X$
for all sufficiently large $n$ the maps
$$
\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V) \leftarrow \ldots
$$
are all isomorphisms. Namely, if the map
$\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V)$ is not an isomorphism,
then $Z_{n, i, i'} \cap \pi_n^{-1}(V) \not = \emptyset$ for some
$\{i, i'\} \in P(I_n)$. Hence there exists an irreducible component
$W \subset D_{n, i} \cap D_{n, i'}$ with $\dim_\delta(W) = d - 1$.
In particular we see that $\epsilon_W(D_{n, i}, D_{n, i'}) > 0$.
Applying Lemma \ref{lemma-two-divisors} repeatedly we see that
$$
\epsilon_W(D_{n, i}, D_{n, i'})
<
\epsilon(V, \{D_i|_V\}) - n
$$
with $\epsilon(V, \{D_i|_V\})$ as in (\ref{equation-invariant}).
Since $V$ is quasi-compact, we have
$\epsilon(V, \{D_i|_V\}) < \infty$ and taking $n > \epsilon(V, \{D_i|_V\})$
we see the result.

\medskip\noindent
Note that by construction the difference $X_n \setminus U_n$
has $\dim_\delta(X_n \setminus U_n) \leq d - 3$.
Let $T_n = \pi_n(X_n \setminus U_n)$ be its image in $X$.
Traversing in the diagram of maps above using each $b_n$ is closed
it follows that $T_0 \cup \ldots \cup T_n$ is a closed subset of $X$
for each $n$. Any $t \in T_n$ satisfies $\delta(t) \leq d - 3$
by construction. Hence $\overline{T_n} \subset X$ is a closed subset
with $\dim_\delta(T_n) \leq d - 3$. By the claim above we see
that for any quasi-compact open $V \subset X$ we have
$T_n \cap V \not = \emptyset$ for at most finitely many $n$.
Hence $\{\overline{T_n}\}_{n \geq 0}$ is a locally finite
collection of closed subsets, and we may set
$U = X \setminus \bigcup \overline{T_n}$. This will be
$U$ as in the lemma.

\medskip\noindent
Note that $U_n \cap \pi_n^{-1}(U) = \pi_n^{-1}(U)$ by construction
of $U$. Hence all the morphisms
$$
b_n : \pi_{n + 1}^{-1}(U) \longrightarrow \pi_n^{-1}(U)
$$
are proper. Moreover, by the claim they eventually become isomorphisms
over each quasi-compact open of $X$. Hence we can define
$$
U' = \lim_n \pi_n^{-1}(U).
$$
The induced morphism $b : U' \to U$ is proper since this is local
on $U$, and over each compact open the limit stabilizes. Similarly
we set $J = \bigcup_{n \geq 0} I_n$ using the inclusions
$I_n \to I_{n + 1}$ from the construction. For $j \in J$ choose
an $n_0$ such that $j$ corresponds to $i \in I_{n_0}$ and define
$D'_j = \lim_{n \geq n_0} D_{n, i}$. Again this makes sense
as locally over $X$ the morphisms stabilize.
The other claims of the lemma are verified as in the case
of a quasi-compact $X$.
\end{proof}


\subsection{Commutativity}
\label{subsection-commutativity}

\noindent
The results of this subsection can be used to provide an alternative
proof of the lemmas of Section \ref{section-commutativity} as was
done in an earlier version of this chapter. See also the discussion
preceding Lemma \ref{lemma-commutativity-effective-Cartier}.

\begin{lemma}
\label{lemma-improved-additivity}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\{i_j : D_j \to X \}_{j \in J}$ be a locally finite collection
of effective Cartier divisors on $X$. Let $n_j > 0$, $j\in J$.
Set $D = \sum_{j \in J} n_j D_j$, and denote $i : D \to X$ the
inclusion morphism. Let $\alpha \in Z_{k + 1}(X)$. Then
$$
p : \coprod\nolimits_{j \in J} D_j \longrightarrow D
$$
is proper and
$$
i^*\alpha = p_*\left(\sum n_j i_j^*\alpha\right)
$$
in $A_k(D)$.
\end{lemma}

\begin{proof}
The proof of this lemma is made a bit longer than expected
by a subtlety concerning infinite sums of rational equivalences.
In the quasi-compact case the family $D_j$ is finite and the result
is altogether easy and a straightforward consequence of
Lemmas \ref{lemma-compute-c1} and
Divisors, \ref{divisors-lemma-c1-additive} and the definitions.

\medskip\noindent
The morphism $p$ is proper since the family $\{D_j\}_{j \in J}$
is locally finite. Write $\alpha = \sum_{a \in A} m_a [W_a]$
with $W_a \subset X$ an integral closed subscheme of
$\delta$-dimension $k + 1$.
Denote $i_a : W_a \to X$ the closed immersion.
We assume that $m_a \not = 0$ for all $a \in A$ such that
$\{W_a\}_{a \in A}$ is locally finite on $X$.

\medskip\noindent
Observe that
by Definition \ref{definition-gysin-homomorphism}
the class $i^*\alpha$ is the class of a cycle
$\sum m_a\beta_a$ for certain $\beta_a \in Z_k(W_a \cap D)$.
Namely, if $W_a \not \subset D$ then $\beta_a = [D \cap W_a]_k$
and if $W_a \subset D$, then $\beta_a$ is a cycle
representing $c_1(\mathcal{O}_X(D)) \cap [W_a]$.

\medskip\noindent
For each $a \in A$ write $J = J_{a, 1} \amalg J_{a, 2} \amalg J_{a, 3}$
where
\begin{enumerate}
\item $j \in J_{a, 1}$ if and only if $W_a \cap D_j = \emptyset$,
\item $j \in J_{a, 2}$ if and only if
$W_a \not = W_a \cap D_1 \not = \emptyset$, and
\item $j \in J_{a, 3}$ if and only if $W_a \subset D_j$.
\end{enumerate}
Since the family $\{D_j\}$ is locally finite we see that
$J_{a, 3}$ is a finite set. For every $a \in A$ and $j \in J$
we choose a cycle $\beta_{a, j} \in Z_k(W_a \cap D_j)$ as follows
\begin{enumerate}
\item if $j \in J_{a, 1}$ we set $\beta_{a, j} = 0$,
\item if $j \in J_{a, 2}$ we set $\beta_{a, j} = [D_j \cap W_a]_k$, and
\item if $j \in J_{a, 3}$ we choose $\beta_{a, j} \in Z_k(W_a)$
representing $c_1(i_a^*\mathcal{O}_X(D_j)) \cap [W_j]$.
\end{enumerate}
We claim that
$$
\beta_a \sim_{rat}
\sum\nolimits_{j \in J} n_j \beta_{a, j}
$$
in $A_k(W_a \cap D)$.

\medskip\noindent
Case I: $W_a \not \subset D$. In this case $J_{a, 3} = \emptyset$.
Thus it suffices to show that
$[D \cap W_a]_k = \sum n_j [D_j \cap W_a]_k$ as cycles.
This is Lemma \ref{lemma-sum-divisors-associated-Weil}.

\medskip\noindent
Case II: $W_a \subset D$. In this case $\beta_a$ is a cycle representing
$c_1(i_a^*\mathcal{O}_X(D)) \cap [W_a]$.
Write $D = D_{a, 1} + D_{a, 2} + D_{a, 3}$ with
$D_{a, s} = \sum_{j \in J_{a, s}} n_jD_j$.
By Divisors, Lemma \ref{divisors-lemma-c1-additive} we have
\begin{eqnarray*}
c_1(i_a^*\mathcal{O}_X(D)) \cap [W_a] & = &
c_1(i_a^*\mathcal{O}_X(D_{a, 1})) \cap [W_a] +
c_1(i_a^*\mathcal{O}_X(D_{a, 2})) \cap [W_a] \\
& &
 + c_1(i_a^*\mathcal{O}_X(D_{a, 3})) \cap [W_a].
\end{eqnarray*}
It is clear that the first term of the sum is zero.
Since $J_{a, 3}$ is finite we see that the last term agrees
with $\sum\nolimits_{j \in J_{a, 3}} n_jc_1(i_a^*\mathcal{L}_j) \cap [W_a]$,
see Divisors, Lemma \ref{divisors-lemma-c1-additive}.
This is represented by $\sum_{j \in J_{a, 3}} n_j \beta_{a, j}$.
Finally, by Case I we see that the middle term is represented by the cycle
$\sum\nolimits_{j \in J_{a, 2}} n_j[D_j \cap W_a]_k =
\sum_{j \in J_{a, 2}} n_j\beta_{a, j}$.
Whence the claim in this case.

\medskip\noindent
At this point we are ready to finish the proof of the lemma.
Namely, we have $i^*D \sim_{rat} \sum m_a\beta_a$ by our
choice of $\beta_a$. For each $a$ we have
$\beta_a \sim_{rat} \sum_j \beta_{a, j}$ with the rational
equivalence taking place on $D \cap W_a$.
Since the collection of closed subschemes $D \cap W_a$
is locally finite on $D$, we see that also
$\sum m_a \beta_a \sim_{rat} \sum_{a, j} m_a\beta_{a, j}$
on $D$! (See Remark \ref{remark-infinite-sums-rational-equivalences}.)
Ok, and now it is clear that $\sum_a m_a\beta_{a, j}$ (viewed
as a cycle on $D_j$) represents $i_j^*\alpha$ and hence
$\sum_{a, j} m_a\beta_{a, j}$ represents $p_* \sum_j i_j^*\alpha$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D$, $D'$ be effective Cartier divisors on $X$.
Assume $\dim_\delta(D \cap D') = n - 2$. Let $i : D \to X$,
resp.\ $i' : D' \to X$ be the corresponding closed immersions.
Then
\begin{enumerate}
\item there exists a cycle $\alpha \in Z_{n - 2}(D \cap D')$
whose pushforward to $D$ represents
$i^*[D']_{n - 1} \in A_{n - 2}(D)$
and whose pushforward to $D'$ represents
$(i')^*[D]_{n - 1} \in A_{n - 2}(D')$, and
\item we have
$$
D \cdot [D']_{n - 1}
=
D' \cdot [D]_{n - 1}
$$
in $A_{n - 2}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) is a trivial consequence of part (1).
Let us write $[D]_{n - 1} = \sum n_a[Z_a]$ and
$[D']_{n - 1} = \sum m_b[Z_b]$ with $Z_a$ the irreducible
components of $D$ and $[Z_b]$ the irreducible
components of $D'$.
According to Definition \ref{definition-gysin-homomorphism},
we have $i^*D' = \sum m_b i^*[Z_b]$ and $(i')^*D = \sum n_a(i')^*[Z_a]$.
By assumption, none of the irreducible components $Z_b$
is contained in $D$, and hence $i^*[Z_b] = [Z_b\cap D]_{n - 2}$
by definition. Similarly $(i')^*[Z_a] = [Z_a \cap D']_{n - 2}$.
Hence we are trying to prove the equality of cycles
$$
\sum n_a[Z_a \cap D']_{n - 2} = \sum m_b[Z_b \cap D]_{n - 2}
$$
which are indeed supported on $D \cap D'$.
Let $W \subset X$ be an integral closed subscheme
with $\dim_\delta(W) = n - 2$. Let $\xi \in W$ be its generic point.
Set $R = \mathcal{O}_{X, \xi}$. It is a Noetherian local domain.
Note that $\dim(R) = 2$. Let $f \in R$, resp.\ $f' \in R$
be an element defining the ideal of $D$, resp.\ $D'$.
By assumption $\dim(R/(f, f')) = 0$. Let
$\mathfrak q'_1, \ldots, \mathfrak q'_t \subset R$ be the minimal
primes over $(f')$, let $\mathfrak q_1, \ldots, \mathfrak q_s \subset R$
be the minimal primes over $(f)$.
The equality above comes down to the equality
$$
\sum_{i = 1, \ldots, s}
\text{length}_{R_{\mathfrak q_i}}(R_{\mathfrak q_i}/(f))
\text{ord}_{R/\mathfrak q_i}(f')
=
\sum_{j = 1, \ldots, t}
\text{length}_{R_{\mathfrak q'_j}}(R_{\mathfrak q'_j}/(f'))
\text{ord}_{R/\mathfrak q'_j}(f).
$$
By Lemma \ref{lemma-length-multiplication} 
applied with $M = R/(f)$ the left hand side of
this equation is equal to
$$
\text{length}_R(R/(f, f'))
-
\text{length}_R(\Ker(f' : R/(f) \to R/(f)))
$$
OK, and now we note that
$\Ker(f' : R/(f) \to R/(f))$ is canonically isomorphic
to $((f) \cap (f'))/(ff')$ via the map $x \bmod (f) \mapsto
f'x \bmod (ff')$. Hence the left hand side is
$$
\text{length}_R(R/(f, f'))
-
\text{length}_R((f) \cap (f')/(ff'))
$$
Since this is symmetric in $f$ and $f'$ we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection-infinite}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\{D_j\}_{j \in J}$ be a locally finite collection of
effective Cartier divisors on $X$. Let $n_j, m_j \geq 0$ be
collections of nonnegative integers. Set
$D = \sum n_j D_j$ and $D' = \sum m_j D_j$.
Assume that $\dim_\delta(D_j \cap D_{j'}) = n - 2$ for every
$j \not = j'$. Then $D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}$ in
$A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
This lemma is a trivial consequence of
Lemmas \ref{lemma-sum-divisors-associated-Weil} and
\ref{lemma-commutativity-effective-Cartier-proper-intersection}
in case the sums are finite, e.g., if $X$ is quasi-compact.
Hence we suggest the reader skip the proof.

\medskip\noindent
Here is the proof in the general case.
Let $i_j : D_j \to X$ be the closed immersions
Let $p : \coprod D_j \to X$ denote coproduct of the morphisms $i_j$.
Let $\{Z_a\}_{a \in A}$ be the collection of irreducible components of
$\bigcup D_j$. For each $j$ we write
$$
[D_j]_{n - 1} = \sum d_{j, a}[Z_a].
$$
By Lemma \ref{lemma-sum-divisors-associated-Weil} we have
$$
[D]_{n - 1} = \sum n_j d_{j, a} [Z_a],
\quad
[D']_{n - 1} = \sum m_j d_{j, a} [Z_a].
$$
By Lemma \ref{lemma-improved-additivity}
we have
$$
D \cdot [D']_{n - 1} = p_*\left(\sum n_j i_j^*[D']_{n - 1} \right),
\quad
D' \cdot [D]_{n - 1} = p_*\left(\sum m_{j'} i_{j'}^*[D]_{n - 1} \right).
$$
As in the definition of the Gysin homomorphisms (see
Definition \ref{definition-gysin-homomorphism})
we choose cycles $\beta_{a, j}$ on $D_j \cap Z_a$ representing
$i_j^*[Z_a]$. (Note that in fact $\beta_{a, j} = [D_j \cap Z_a]_{n - 2}$
if $Z_a$ is not contained in $D_j$, i.e., there is no choice in that case.)
Now since $p$ is a closed immersion when restricted to each of the $D_j$
we can (and we will) view $\beta_{a, j}$ as a cycle on $X$.
Plugging in the formulas for $[D]_{n - 1}$ and $[D']_{n - 1}$ obtained
above we see that
$$
D \cdot [D']_{n - 1} =
\sum\nolimits_{j, j', a} n_j m_{j'} d_{j', a} \beta_{a, j},
\quad
D' \cdot [D]_{n - 1} =
\sum\nolimits_{j, j', a} m_{j'} n_j d_{j, a} \beta_{a, j'}.
$$
Moreover, with the same conventions we also have
$$
D_j \cdot [D_{j'}]_{n - 1} = \sum d_{j', a} \beta_{a, j}.
$$
In these terms
Lemma \ref{lemma-commutativity-effective-Cartier-proper-intersection}
(see also its proof)
says that for $j \not = j'$ the cycles
$\sum d_{j', a} \beta_{a, j}$ and $\sum d_{j, a} \beta_{a, j'}$
are equal as cycles! Hence we see that
\begin{eqnarray*}
D \cdot [D']_{n - 1}
& = &
\sum\nolimits_{j, j', a} n_j m_{j'} d_{j', a} \beta_{a, j} \\
& = &
\sum\nolimits_{j \not = j'} n_j m_{j'}
\left(\sum\nolimits_a d_{j', a} \beta_{a, j}\right) +
\sum\nolimits_{j, a} n_j m_j d_{j, a} \beta_{a, j} \\
& = &
\sum\nolimits_{j \not = j'} n_j m_{j'}
\left(\sum\nolimits_a d_{j, a} \beta_{a, j'}\right) +
\sum\nolimits_{j, a} n_j m_j d_{j, a} \beta_{a, j} \\
& = &
\sum\nolimits_{j, j', a} m_{j'} n_j d_{j, a} \beta_{a, j'} \\
& = &
D' \cdot [D]_{n - 1}
\end{eqnarray*}
and we win.
\end{proof}

\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ integral
and $\dim_\delta(X) = n$. Let $D$, $D'$ be effective Cartier divisors on $X$.
A stronger (and more useful) version of the following lemma
asserts that
$$
D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}
\quad\text{in}\quad
A_{n - 2}(D \cap D')
$$
for suitable representatives of the dot products involved. The first proof
of the lemma together with
Lemmas \ref{lemma-improved-additivity},
\ref{lemma-commutativity-effective-Cartier-proper-intersection}, and
\ref{lemma-commutativity-effective-Cartier-proper-intersection-infinite}
can be modified to show this (see \cite{F}). It is
not so clear how to modify the second proof to prove the refined
version. An application of the refined version is a proof that the
Gysin homomorphism factors through rational equivalence which we proved
by a different method in Lemma \ref{lemma-gysin-factors}.

\begin{lemma}
\label{lemma-commutativity-effective-Cartier}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D$, $D'$ be effective Cartier divisors on $X$.
Then
$$
D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-commutativity-effective-Cartier}]
First, let us prove this in case $X$ is quasi-compact.
In this case, apply Lemma \ref{lemma-blowing-up-intersections} to $X$ and the
two element set $\{D, D'\}$ of effective Cartier divisors.
Thus we get a proper morphism $b : X' \to X$,
a finite collection of effective Cartier
divisors $D'_j \subset X'$ intersecting pairwise in codimension $\geq 2$,
with $b^{-1}(D) = \sum n_j D'_j$, and $b^{-1}(D') = \sum m_j D'_j$.
Note that $b_*[b^{-1}(D)]_{n - 1} = [D]_{n - 1}$ in $Z_{n - 1}(X)$
and similarly for $D'$,
see Lemma \ref{lemma-push-pull-effective-Cartier}.
Hence, by Lemma \ref{lemma-pushforward-cap-c1} we have
$$
D \cdot [D']_{n - 1} = b_*\left(b^{-1}(D) \cdot [b^{-1}(D')]_{n - 1}\right)
$$
in $A_{n - 2}(X)$ and similarly for the other term. Hence the
lemma follows from the equality
$b^{-1}(D) \cdot [b^{-1}(D')]_{n - 1} = b^{-1}(D') \cdot [b^{-1}(D)]_{n - 1}$
in $A_{n - 2}(X')$ of Lemma
\ref{lemma-commutativity-effective-Cartier-proper-intersection-infinite}.

\medskip\noindent
Note that in the proof above, each referenced lemma works also
in the general case (when $X$ is not assumed quasi-compact). The
only minor change in the general case is that the morphism
$b : U' \to U$ we get from applying Lemma \ref{lemma-blowing-up-intersections}
has as its target
an open $U \subset X$ whose complement has codimension $\geq 3$.
Hence by Lemma \ref{lemma-restrict-to-open} we see that
$A_{n - 2}(U) = A_{n - 2}(X)$
and after replacing $X$ by $U$ the rest of the proof goes through
unchanged.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-commutativity-effective-Cartier}]
Let $\mathcal{I} = \mathcal{O}_X(-D)$ and
$\mathcal{I}' = \mathcal{O}_X(-D')$ be the invertible
ideal sheaves of $D$ and $D'$.
We denote
$\mathcal{I}_{D'} = \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{O}_{D'}$
and
$\mathcal{I}'_D = \mathcal{I}' \otimes_{\mathcal{O}_X} \mathcal{O}_D$.
We can restrict the inclusion map $\mathcal{I} \to \mathcal{O}_X$
to $D'$ to get a map
$$
\varphi : \mathcal{I}_{D'} \longrightarrow \mathcal{O}_{D'}
$$
and similarly
$$
\psi : \mathcal{I}'_D \longrightarrow \mathcal{O}_D
$$
It is clear that
$$
\Coker(\varphi)
\cong
\mathcal{O}_{D \cap D'}
\cong
\Coker(\psi)
$$
and
$$
\Ker(\varphi)
\cong
\frac{\mathcal{I} \cap \mathcal{I}'}{\mathcal{I}\mathcal{I}'}
\cong
\Ker(\psi).
$$
Hence we see that
$$
\gamma =
[\mathcal{I}_{D'}] - [\mathcal{O}_{D'}]
=
[\mathcal{I}'_D] - [\mathcal{O}_D]
$$
in $K_0(\textit{Coh}_{\leq n - 1}(X))$. On the other hand it is clear that
$$
[\mathcal{I}'_D]_{n - 1} = [D]_{n - 1}, \quad
[\mathcal{I}_{D'}]_{n - 1} = [D']_{n - 1}.
$$
and that
$$
\mathcal{O}_X(D') \otimes \mathcal{I}'_D = \mathcal{O}_D, \quad
\mathcal{O}_X(D) \otimes \mathcal{I}_{D'} = \mathcal{O}_{D'}.
$$
By Lemma \ref{lemma-coherent-sheaf-cap-c1} (applied two times)
this means that the element $\gamma$ is an element of $B_{n - 2}(X)$, and
maps to both $c_1(\mathcal{O}_X(D')) \cap [D]_{n - 1}$ and to
$c_1(\mathcal{O}_X(D)) \cap [D']_{n - 1}$ and we win (since the
map $B_{n - 2}(X) \to A_{n - 2}(X)$ is well defined -- which is
the key to this proof).
\end{proof}













\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
