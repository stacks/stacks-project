\input{preamble}

% OK, start here.
%
\begin{document}

\title{Dualizing Complexes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
A reference is the book \cite{RD}.

\medskip\noindent
The goals of this chapter are the following:
\begin{enumerate}
\item Define what it means to have a dualizing complex $\omega_A^\bullet$
over a Noetherian ring $A$, namely
\begin{enumerate}
\item we have $\omega_A^\bullet \in D^{+}(A)$,
\item the cohomology modules $H^i(\omega_A^\bullet)$ are
all finite $A$-modules,
\item $\omega_A^\bullet$ has finite injective dimension, and
\item we have $A \to R\Hom_A(\omega_A^\bullet, \omega_A^\bullet)$
is a quasi-isomorphism.
\end{enumerate}
\item List elementary properties of dualizing complexes.
\item Show a dualizing complex gives rise to a dimension function.
\item Show a dualizing complex gives rise to a good notion of a
reflexive hull.
\item Prove the finiteness theorem when a dualizing complex exists.
\end{enumerate}






\section{Essential surjections and injections}
\label{section-essential}

\noindent
We will mostly work in categories of modules, but we may as well make
the definition in general.

\begin{definition}
\label{definition-essential}
Let $\mathcal{A}$ be an abelian category.
\begin{enumerate}
\item An injection $A \subset B$ of $\mathcal{A}$ is {\it essential},
or we say that $B$ is an {\it essential extension of} $A$,
if every nonzero subobject $B' \subset B$ has nonzero intersection with $A$.
\item A surjection $f : A \to B$ of $\mathcal{A}$ is {\it essential}
if for every proper subobject $A' \subset A$ we have $f(A') \not = B$.
\end{enumerate}
\end{definition}

\noindent
Some lemmas about this notion.

\begin{lemma}
\label{lemma-essential}
Let $\mathcal{A}$ be an abelian category.
\begin{enumerate}
\item If $A \subset B$ and $B \subset C$ are essential extensions, then
$A \subset C$ is an essential extension.
\item If $A \subset B$ is an essential extension and $C \subset B$
is a subobject, then $A \cap C \subset C$ is an essential extension.
\item If $A \to B$ and $B \to C$ are essential surjections, then
$A \to C$ is an essential surjection.
\item Given an essential surjection $f : A \to B$ and a surjection
$A \to C$ with kernel $K$, the morphism $C \to B/f(K)$ is an essential
surjection.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-union-essential-extensions}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $E = \colim E_i$
be a filtered colimit of $R$-modules. Suppose given a compatible
system of essential injections $M \to E_i$ of $R$-modules.
Then $M \to E$ is an essential injection.
\end{lemma}

\begin{proof}
Immediate from the definitions and the fact that filtered
colimits are exact (Algebra, Lemma \ref{algebra-lemma-directed-colimit-exact}).
\end{proof}

\begin{lemma}
\label{lemma-essential-extension}
Let $R$ be a ring. Let $M \subset N$ be $R$-modules. The following
are equivalent
\begin{enumerate}
\item $M \subset N$ is an essential extension,
\item for all $x \in N$ there exists an $f \in R$ such that $fx \in M$
and $fx \not = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1) and let $x \in N$ be a nonzero element. By (1) we have
$Rx \cap M \not = 0$. This implies (2).

\medskip\noindent
Assume (2). Let $N' \subset N$ be a nonzero submodule. Pick $x \in N'$
nonzero. By (2) we can find $f \in $ with $fx \in N$ and $fx \not = 0$.
Thus $N' \cap M \not = 0$.
\end{proof}




\section{Injective modules}
\label{section-injective-modules}

\noindent
Some results about injective modules over rings.

\begin{lemma}
\label{lemma-product-injectives}
Let $R$ be a ring. Any product of injective $R$-modules is injective.
\end{lemma}

\begin{proof}
Special case of Homology, Lemma \ref{homology-lemma-product-injectives}.
\end{proof}

\begin{lemma}
\label{lemma-injective-flat}
Let $R \to S$ be a flat ring map. If $E$ is an injective $S$-module,
then $E$ is injective as an $R$-module.
\end{lemma}

\begin{proof}
This is true because $\Hom_R(M, E) = \Hom_S(M \otimes_R S, E)$
by Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}
and the fact that tensoring with $S$ is exact.
\end{proof}

\begin{lemma}
\label{lemma-injective-epimorphism}
Let $R \to S$ be an epimorphism of rings. Let $E$ be an $S$-module.
If $E$ is injective as an $R$-module, then $E$ is an injective $S$-module.
\end{lemma}

\begin{proof}
This is true because $\Hom_R(N, E) = \Hom_S(N, E)$ for any $S$-module $N$,
see Algebra, Lemma \ref{algebra-lemma-epimorphism-modules}.
\end{proof}

\begin{lemma}
\label{lemma-hom-injective}
Let $R \to S$ be a ring map. If $E$ is an injective $R$-module,
then $\Hom_R(S, E)$ is an injective $S$-module.
\end{lemma}

\begin{proof}
This is true because $\Hom_S(N, \Hom_R(S, E)) = \Hom_R(N, E)$ by
Algebra, Lemma \ref{algebra-lemma-adjoint-hom-restrict}.
\end{proof}

\begin{lemma}
\label{lemma-essential-extensions-in-injective}
Let $R$ be a ring. Let $I$ be an injective $R$-module. Let $E \subset I$
be a submodule. The following are equivalent
\begin{enumerate}
\item $E$ is injective, and
\item for all $E \subset E' \subset I$ with $E \subset E'$ essential
we have $E = E'$.
\end{enumerate}
In particular, an $R$-module is injective if and only if every essential
extension is trivial.
\end{lemma}

\begin{proof}
The final assertion follows from the first and the fact that the
category of $R$-modules has enough injectives
(More on Algebra, Section \ref{more-algebra-section-injectives-modules}).

\medskip\noindent
Assume (1). Let $E \subset E' \subset I$ as in (2).
Then the map $\text{id}_E : E \to E$ can be extended
to a map $\alpha : E' \to E$. The kernel of $\alpha$ has to be
zero because it intersects $E$ trivially and $E'$ is an essential
extension. Hence $E = E'$.

\medskip\noindent
Assume (2). Let $M \subset N$ be $R$-modules and let $\varphi : M \to E$
be an $R$-module map. In order to prove (1) we have to show that
$\varphi$ extends to a morphism $N \to E$. Consider the set $\mathcal{S}$
of pairs
$(M', \varphi')$ where $M \subset M' \subset N$ and $\varphi' : M' \to E$
is an $R$-module map agreeing with $\varphi$ on $M$. We define an ordering
on $\mathcal{S}$ by the rule $(M', \varphi') \leq (M'', \varphi'')$
if and only if $M' \subset M''$ and $\varphi''|_{M'} = \varphi'$.
It is clear that we can take the maximum of a totally ordered subset
of $\mathcal{S}$. Hence by Zorn's lemma we may assume $(M, \varphi)$
is a maximal element.

\medskip\noindent
Choose an extension $\psi : N \to I$ of $\varphi$ composed
with the inclusion $E \to I$. This is possible as $I$ is injective.
If $\psi(N) \subset E$, then $\psi$ is the desired extension.
If $\psi(N)$ is not contained in $E$, then by (2) the inclusion
$E \subset E + \psi(N)$ is not essential. hence
we can find a nonzero submodule $K \subset E + \psi(N)$ meeting $E$ in $0$.
This means that $M' = \psi^{-1}(E + K)$ strictly contains $M$.
Thus we can extend $\varphi$ to $M'$ using
$$
M' \xrightarrow{\psi|_{M'}} E + K \to (E + K)/K = E
$$
This contradicts the maximality of $(M, \varphi)$.
\end{proof}

\begin{example}
\label{example-reduced-ring-injective}
Let $R$ be a reduced ring. Let $\mathfrak p \subset R$ be a minimal prime
so that $K = R_\mathfrak p$ is a field
(Algebra, Lemma \ref{algebra-lemma-minimal-prime-reduced-ring}).
Then $K$ is an injective $R$-module. Namely, we have
$\Hom_R(M, K) = \Hom_K(M_\mathfrak p, K)$ for any $R$-module
$M$. Since localization is an exact functor and taking duals is
an exact functor on $K$-vector spaces we conclude $\Hom_R(-, K)$
is an exact functor, i.e., $K$ is an injective $R$-module.
\end{example}

\begin{lemma}
\label{lemma-characterize-injective}
Let $R$ be a ring. Let $E$ be an $R$-module. The following are equivalent
\begin{enumerate}
\item $E$ is an injective $R$-module, and
\item given an ideal $I \subset R$ and a module map $\varphi : I \to E$
there exists an extension of $\varphi$ to an $R$-module map $R \to E$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) follows from the definitions.
Thus we assume (2) holds and we prove (1).
First proof: The lemma follows from
More on Algebra, Lemma \ref{more-algebra-lemma-characterize-injective-bis}.
Second proof: Since $R$ is a generator for the category of $R$-modules,
the lemma follows from
Injectives, Lemma \ref{injectives-lemma-characterize-injective}.

\medskip\noindent
Third proof: We have to show that every essential extension $E \subset E'$
is trivial, see Lemma \ref{lemma-essential-extensions-in-injective}.
Pick $x \in E'$ and set $I = \{f \in R \mid fx \in E\}$.
The map $I \to E$, $f \mapsto fx$ extends to $\psi : R \to E$ by (2).
Then $x' = x - \psi(1)$ is an element of $E'$ whose annihilator in
$E'/E$ is $I$ and which is annihilated by $I$ as an element of $E'$.
Thus $Rx' = (R/I)x'$ does not intersect $E$. Since $E \subset E'$
is an essential extension it follows that $x' \in E$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-sum-injective-modules}
Let $R$ be a Noetherian ring. A direct sum of injective modules
is injective.
\end{lemma}

\begin{proof}
Let $E_i$ be a family of injective modules parametrized by a set $I$.
Set $E = \bigcup E_i$. To show that $E$ is injective we use
Lemma \ref{lemma-characterize-injective}.
Thus let $\varphi : I \to E$ be a module map from an ideal of $R$
into $E$. As $I$ is a finite $R$-module (because $R$ is Noetherian)
we can find finitely many elements $i_1, \ldots, i_r \in I$
such that $\varphi$ maps into $\bigcup_{j = 1, \ldots, r} E_{i_j}$.
Then we can extend $\varphi$ into $\bigcup_{j = 1, \ldots, r} E_{i_j}$
using the injectivity of the modules $E_{i_j}$.
\end{proof}

\begin{lemma}
\label{lemma-localization-injective-modules}
Let $R$ be a Noetherian ring. Let $S \subset R$ be a multiplicative
subset. If $E$ is an injective $R$-module, then $S^{-1}E$ is an
injective $S^{-1}R$-module.
\end{lemma}

\begin{proof}
Since $R \to S^{-1}R$ is an epimorphism of rings, it suffices
to show that $S^{-1}E$ is injective as an $R$-module, see
Lemma \ref{lemma-injective-epimorphism}.
To show this we use Lemma \ref{lemma-characterize-injective}.
Thus let $I \subset R$ be an ideal and let
$\varphi : I \to S^{-1} E$ be an $R$-module map.
As $I$ is a finitely presented $R$-module (because $R$ is Noetherian)
we can find find an $f \in S$ and an $R$-module map $I \to E$
such that $f\varphi$ is the composition $I \to E \to S^{-1}E$
(Algebra, Lemma \ref{algebra-lemma-hom-from-finitely-presented}).
Then we can extend $I \to E$ to a homomorphism $R \to E$.
Then the composition
$$
R \to E \to S^{-1}E \xrightarrow{f^{-1}} S^{-1}E
$$
is the desired extension of $\varphi$ to $R$.
\end{proof}

\begin{lemma}
\label{lemma-injective-module-divide}
Let $R$ be a Noetherian ring. Let $I$ be an injective $R$-module.
\begin{enumerate}
\item Let $f \in R$. Then $E = \bigcup I[f^n] = I[f^\infty]$
is an injective submodule of $I$.
\item Let $J \subset R$ be an ideal. Then the $J$-power torsion
submodule $I[J^\infty]$ is an injective submodule of $I$.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use Lemma \ref{lemma-essential-extensions-in-injective}
to prove (1).
Suppose that $E \subset E' \subset I$ and that $E'$ is an essential
extension of $E$. We will show that $E' = E$. If not, then we can
find $x \in E'$ and $x \not \in E$. Let $J = \{a \in R \mid ax \in E'\}$.
Since $R$ is Noetherian we can choose $x$ with $J$ maximal.
Since $R$ is Noetherian we can write $J = (g_1, \ldots, g_t)$ for some
$g_i \in R$. Say $f^{n_i}$ annihilates $g_ix$. Set $n = \max\{n_i\}$.
Then $x' = f^n x$ is an element of $E'$ not in $E$ and is annihilated
by $J$. By maximality of $J$ we see that $R x' = (R/J)x'  \cap E = (0)$.
Hence $E'$ is not an essential extension of $E$ a contradiction.

\medskip\noindent
To prove (2) write $J = (f_1, \ldots, f_t)$. Then
$I[J^\infty]$ is equal to
$$
(\ldots((I[f_1^\infty])[f_2^\infty])\ldots)[f_t^\infty]
$$
and the result follows from (1) and induction.
\end{proof}

\begin{lemma}
\label{lemma-injective-dimension-over-polynomial-ring}
Let $A$ be a Noetherian ring. Let $E$ be an injective $A$-module.
Then $E \otimes_A A[x]$ has injective-amplitude $[0, 1]$
as an object of $D(A[x])$. In particular, $E \otimes_A A[x]$
has finite injective dimension as an $A[x]$-module.
\end{lemma}

\begin{proof}
Let us write $E[x] = E \otimes_A A[x]$. Consider the short exact
sequence of $A[x]$-modules
$$
0 \to E[x] \to \Hom_A(A[x], E[x]) \to \Hom_A(A[x], E[x]) \to 0
$$
where the first map sends $p \in E[x]$ to $f \mapsto fp$ and the
second map sends $\varphi$ to $f \mapsto \varphi(xf) - x\varphi(f)$.
The second map is surjective because
$\Hom_A(A[x], E[x]) = \prod_{n \geq 0} E[x]$ as an abelian group and
the map sends $(e_n)$ to $(e_{n + 1} - xe_n)$ which is surjective.
As an $A$-module we have $E[x] \cong \bigoplus_{n \geq 0} E$
which is injective by Lemma \ref{lemma-sum-injective-modules}.
Hence the $A[x]$-module $\Hom_A(A[x], I[x])$ is injective by
Lemma \ref{lemma-hom-injective} and the proof is complete.
\end{proof}



\section{Projective covers}
\label{section-projective-cover}

\noindent
In this section we briefly discuss projective covers.

\begin{definition}
\label{definition-projective-cover}
Let $R$ be a ring. A surjection $P \to M$ of $R$-modules is said
to be a {\it projective cover}, or sometimes a {\it projective envelope},
if $P$ is a projective $R$-module and $P \to M$ is an essential
surjection.
\end{definition}

\noindent
Projective covers do not always exist. For example, if $k$ is a field
and $R = k[x]$ is the polynomial ring over $k$, then the module $M = R/(x)$
does not have a projective cover. Namely, for any surjection $f : P \to M$
with $P$ projective over $R$, the proper submodule $(x - 1)P$ surjects
onto $M$. Hence $f$ is not essential.

\begin{lemma}
\label{lemma-projective-cover-unique}
Let $R$ be a ring and let $M$ be an $R$-module. If a projective cover
of $M$ exists, then it is unique up to isomorphism.
\end{lemma}

\begin{proof}
Let $P \to M$ and $P' \to M$ be projective covers. Because $P$ is a
projective $R$-module and $P' \to M$ is surjective, we can find an
$R$-module map $\alpha : P \to P'$ compatible with the maps to $M$.
Since $P' \to M$ is essential, we see that $\alpha$ is surjective.
As $P'$ is a projective $R$-module we can choose a direct sum decomposition
$P = \Ker(\alpha) \oplus P'$. Since $P' \to M$ is surjective
and since $P \to M$ is essential we conclude that $\Ker(\alpha)$
is zero as desired.
\end{proof}

\noindent
Here is an example where projective covers exist.

\begin{lemma}
\label{lemma-projective-covers-local}
Let $(R, \mathfrak m, \kappa)$ be a local ring. Any finite $R$-module has
a projective cover.
\end{lemma}

\begin{proof}
Let $M$ be a finite $R$-module. Let $r = \dim_\kappa(M/\mathfrak m M)$.
Choose $x_1, \ldots, x_r \in M$ mapping to a basis of $M/\mathfrak m M$.
Consider the map $f : R^{\oplus r} \to M$. By Nakayama's lemma this is
a surjection (Algebra, Lemma \ref{algebra-lemma-NAK}). If
$N \subset R^{\oplus R}$ is a proper submodule, then
$N/\mathfrak m N \to \kappa^{\oplus r}$ is not surjective (by
Nakayama's lemma again) hence $N/\mathfrak m N \to M/\mathfrak m M$
is not surjective. Thus $f$ is an essential surjection.
\end{proof}







\section{Injective hulls}
\label{section-injective-hull}

\noindent
In this section we briefly discuss injective hulls.

\begin{definition}
\label{definition-injective-hull}
Let $R$ be a ring. A injection $M \to I$ of $R$-modules is said
to be an {\it injective hull} if $I$ is a injective $R$-module and
$M \to I$ is an essential injection.
\end{definition}

\noindent
Injective hulls always exist.

\begin{lemma}
\label{lemma-injective-hull}
Let $R$ be a ring. Any $R$-module has an injective hull.
\end{lemma}

\begin{proof}
Let $M$ be an $R$-module. By
More on Algebra, Section \ref{more-algebra-section-injectives-modules}
the category of $R$-modules has enough injectives.
Choose an injection $M \to I$ with $I$ an injective $R$-module.
Consider the set $\mathcal{S}$ of submodules $M \subset E \subset I$
such that $E$ is an essential extension of $M$. We order $\mathcal{S}$
by inclusion. If $\{E_\alpha\}$ is a totally ordered subset
of $\mathcal{S}$, then $\bigcup E_\alpha$ is an essential extension of $M$
too (Lemma \ref{lemma-union-essential-extensions}).
Thus we can apply Zorn's lemma and find a maximal element
$E \in \mathcal{S}$. We claim $M \subset E$ is an injective hull, i.e.,
$E$ is an injective $R$-module. This follows from
Lemma \ref{lemma-essential-extensions-in-injective}.
\end{proof}

\begin{lemma}
\label{lemma-injective-hull-unique}
Let $R$ be a ring. Let $M$, $N$ be $R$-modules and let $M \to E$
and $N \to E'$ be injective hulls. Then
\begin{enumerate}
\item for any $R$-module map $\varphi : M \to N$ there exists an
$R$-module map $\psi : E \to E'$ such that
$$
\xymatrix{
M \ar[r] \ar[d]_\varphi & E \ar[d]^\psi \\
N \ar[r] & E'
}
$$
commutes,
\item if $\varphi$ is injective, then $\psi$ is injective,
\item if $\varphi$ is an essential injection, then $\psi$ is an isomorphism,
\item if $\varphi$ is an isomorphism, then $\psi$ is an isomorphism,
\item if $M \to I$ is an embedding of $M$ into an injective $R$-module,
then there is an isomorphism $I \cong E \oplus I'$ compatible with
the embeddings of $M$,
\end{enumerate}
In particular, the injective hull $E$ of $M$ is unique up to isomorphism.
\end{lemma}

\begin{proof}
Part (1) follows from the fact that $E'$ is an injective $R$-module.
Part (2) follows as $\Ker(\psi) \cap M = 0$
and $E$ is an essential extension of $M$.
Assume $\varphi$ is an essential injection. Then
$E \cong \psi(E) \subset E'$ by (2) which implies
$E' = \psi(E) \oplus E''$ because $E$ is injective.
Since $E'$ is an essential extension of
$M$ (Lemma \ref{lemma-essential}) we get $E'' = 0$.
Part (4) is a special case of (3).
Assume $M \to I$ as in (5).
Choose a map $\alpha : E \to I$ extending the map $M \to I$.
Arguing as before we see that $\alpha$ is injective.
Thus as before $\alpha(E)$ splits off from $I$.
This proves (5).
\end{proof}

\begin{example}
\label{example-injective-hull-domain}
Let $R$ be a domain with fraction field $K$. Then $R \subset K$ is an
injective hull of $R$. Namely, by
Example \ref{example-reduced-ring-injective} we see that $K$ is an injective
$R$-module and by Lemma \ref{lemma-essential-extension} we see that
$R \subset K$ is an essential extension.
\end{example}

\begin{definition}
\label{definition-indecomposable}
An object $X$ of an additive category is called {\it indecomposable}
if it is nonzero and if $X = Y \oplus Z$, then either $Y = 0$ or $Z = 0$.
\end{definition}

\begin{lemma}
\label{lemma-indecomposable-injective}
Let $R$ be a ring. Let $E$ be an indecomposable injective $R$-module.
Then
\begin{enumerate}
\item $E$ is the injective hull of any nonzero submodule of $E$,
\item the intersection of any two nonzero submodules of $E$ is nonzero,
\item $\text{End}_R(E, E)$ is a noncommutative local ring with maximal
ideal those $\varphi : E \to E$ whose kernel is nonzero, and
\item the set of zerodivisors on $E$ is a prime ideal $\mathfrak p$ of $R$
and $E$ is an injective $R_\mathfrak p$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from Lemma \ref{lemma-injective-hull-unique}.
Part (2) follows from part (1) and the definition of injective hulls.

\medskip\noindent
Proof of (3). Set $A = \text{End}_R(E, E)$ and
$I = \{\varphi \in A \mid \Ker(f) \not = 0\}$.
The statement means that $I$ is a two sided ideal and
that any $\varphi \in A$, $\varphi \not \in I$ is invertible.
Suppose $\varphi$ and $\psi$ are not injective.
Then $\Ker(\varphi) \cap \Ker(\psi)$ is nonzero
by (2). Hence $\varphi + \psi \in I$. It follows that $I$
is a two sided ideal. If $\varphi \in A$, $\varphi \not \in I$,
then $E \cong \varphi(E) \subset E$ is an injective submodule,
hence $E = \varphi(E)$ because $E$ is indecomposable.

\medskip\noindent
Proof of (4). Consider the ring map $R \to A$ and let $\mathfrak p \subset R$
be the inverse image of the maximal ideal $I$. Then it is clear
that $\mathfrak p$ is a prime ideal and that $R \to A$ extends to
$R_\mathfrak p \to A$. Thus $E$ is an $R_\mathfrak p$-module.
It follows from Lemma \ref{lemma-injective-epimorphism} that $E$ is injective
as an $R_\mathfrak p$-module.
\end{proof}

\begin{lemma}
\label{lemma-injective-hull-indecomposable}
Let $\mathfrak p \subset R$ be a prime of a ring $R$.
Let $E$ be the injective hull of $R/\mathfrak p$. Then
\begin{enumerate}
\item $E$ is indecomposable,
\item $E$ is the injective hull of $\kappa(\mathfrak p)$,
\item $E$ is the injective hull of $\kappa(\mathfrak p)$
over the ring $R_\mathfrak p$.
\end{enumerate}
\end{lemma}

\begin{proof}
As $R/\mathfrak p \subset \kappa(\mathfrak p)$ we can extend the embedding
to a map $\kappa(\mathfrak p) \to E$. Hence (2) holds.
For $f \in R$, $f \not \in \mathfrak p$
the map $f : \kappa(\mathfrak p) \to \kappa(\mathfrak p)$ is an isomorphism
hence the map $f : E \to E$ is an isomorphism,
see Lemma \ref{lemma-injective-hull-unique}.
Thus $E$ is an $R_\mathfrak p$-module. It is injective
as an $R_\mathfrak p$-module by Lemma \ref{lemma-injective-epimorphism}.
Finally, let $E' \subset E$ be a nonzero injective $R$-submodule.
Then $J = (R/\mathfrak p) \cap E'$ is nonzero. After shrinking $E'$
we may assume that $E'$ is the injective hull of $J$ (see
Lemma \ref{lemma-injective-hull-unique} for example).
Observe that $R/\mathfrak p$ is an essential extension of $J$ for example by
Lemma \ref{lemma-essential-extension}. Hence $E' \to E$
is an isomorphism by Lemma \ref{lemma-injective-hull-unique} part (3).
Hence $E$ is indecomposable.
\end{proof}

\begin{lemma}
\label{lemma-indecomposable-injective-noetherian}
Let $R$ be a Noetherian ring. Let $E$ be an indecomposable injective
$R$-module. Then there exists a prime ideal $\mathfrak p$ of $R$ such that
$E$ is the injective hull of $\kappa(\mathfrak p)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be the prime ideal found in
Lemma \ref{lemma-indecomposable-injective}.
Say $\mathfrak p = (f_1, \ldots, f_r)$.
Pick a nonzero element $x \in \bigcap \Ker(f_i : E \to E)$,
see Lemma \ref{lemma-indecomposable-injective}.
Then $(R_\mathfrak p)x$ is a module isomorphic to $\kappa(\mathfrak p)$
inside $E$. We conclude by Lemma \ref{lemma-indecomposable-injective}.
\end{proof}

\begin{proposition}[Structure of injective modules over Noetherian rings]
\label{proposition-structure-injectives-noetherian}
Let $R$ be a Noetherian ring.
Every injective module is a direct sum of indecomposable injective modules.
Every indecomposable injective module is the injective hull of
the residue field at a prime.
\end{proposition}

\begin{proof}
The second statement is Lemma \ref{lemma-indecomposable-injective-noetherian}.
For the first statement, let $I$ be an injective $R$-module.
We will use transfinite induction to construct $I_\alpha \subset I$
for ordinals $\alpha$ which are direct sums of indecomposable injective
$R$-modules $E_{\beta + 1}$ for $\beta < \alpha$.
For $\alpha = 0$ we let $I_0 = 0$. Suppose given an ordinal $\alpha$
such that $I_\alpha$ has been constructed. Then $I_\alpha$ is an
injective $R$-module by Lemma \ref{lemma-sum-injective-modules}.
Hence $I \cong I_\alpha \oplus I'$. If $I' = 0$ we are done.
If not, then $I'$ has an associated prime by
Algebra, Lemma \ref{algebra-lemma-ass-zero}.
Thus $I'$ contains a copy of $R/\mathfrak p$ for some prime $\mathfrak p$.
Hence $I'$ contains an indecomposable submodule $E$ by
Lemmas \ref{lemma-injective-hull-unique} and
\ref{lemma-injective-hull-indecomposable}. Set
$I_{\alpha + 1} = I_\alpha \oplus E_\alpha$.
If $\alpha$ is a limit ordinal and $I_\beta$ has been constructed
for $\beta < \alpha$, then we set
$I_\alpha = \bigcup_{\beta < \alpha} I_\beta$.
Observe that $I_\alpha = \bigoplus_{\beta < \alpha} E_{\beta + 1}$.
This concludes the proof.
\end{proof}



\section{Duality over Artinian local rings}
\label{section-artinian}

\noindent
Let $(R, \mathfrak m, \kappa)$ be an artinian local ring.
Recall that this implies $R$ is Noetherian and that $R$ has finite
length as an $R$-module. Moreover an $R$-module is finite if and
only if it has finite length. We will use these facts without
further mention in this section. Please see
Algebra, Sections \ref{algebra-section-length} and
\ref{algebra-section-artinian}
and
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}
for more details.

\begin{lemma}
\label{lemma-finite}
Let $(R, \mathfrak m, \kappa)$ be an artinian local ring.
Let $E$ be an injective hull of $\kappa$. For every finite
$R$-module $M$ we have
$$
\text{length}_R(M) = \text{length}_R(\Hom_R(M, E))
$$
In particular, the injective hull $E$ of $\kappa$ is a finite $R$-module.
\end{lemma}

\begin{proof}
Because $E$ is an essential extension of $\kappa$ we have
$\kappa = E[\mathfrak m]$ where $E[\mathfrak m]$ is the
$\mathfrak m$-torsion in $E$ (notation as in More on Algebra, Section
\ref{more-algebra-section-formal-glueing}).
Hence $\Hom_R(\kappa, E) \cong \kappa$ and the equality of lengths
holds for $M = \kappa$. We prove the displayed equality of the lemma
by induction on the length of $M$. If $M$ is nonzero there exists a surjection
$M \to \kappa$ with kernel $M'$. Since the functor $M \mapsto \Hom_R(M, E)$
is exact we obtain a short exact sequence
$$
0 \to \Hom_R(\kappa, E) \to \Hom_R(M, E) \to \Hom_R(M', E) \to 0.
$$
Additivity of length for this sequence and the sequence
$0 \to M' \to M \to \kappa \to 0$ and the equality for $M'$ (induction
hypothesis) and $\kappa$ implies the equality for $M$.
The final statement of the lemma follows as $E = \Hom_R(R, E)$.
\end{proof}

\begin{lemma}
\label{lemma-evaluate}
Let $(R, \mathfrak m, \kappa)$ be an artinian local ring.
Let $E$ be an injective hull of $\kappa$.
For any finite $R$-module $M$ the evaluation map
$$
M \longrightarrow \Hom_R(\Hom_R(M, E), E)
$$
is an isomorphism. In particular $R = \Hom_R(E, E)$.
\end{lemma}

\begin{proof}
Observe that the displayed arrow is injective. Namely, if $x \in M$ is
a nonzero element, then there is a nonzero map $Rx \to \kappa$ which
we can extend to a map $\varphi : M \to E$ that doesn't vanish on $x$.
Since the source and target of the arrow have the same length by
Lemma \ref{lemma-finite}
we conclude it is an isomorphism. The final statement follows
on taking $M = R$.
\end{proof}

\noindent
To state the next lemma, denote $\text{Mod}^{fg}_R$ the category of finite
$R$-modules over a ring $R$.

\begin{lemma}
\label{lemma-duality}
Let $(R, \mathfrak m, \kappa)$ be an artinian local ring.
Let $E$ be an injective hull of $\kappa$.
The functor $D(-) = \Hom_R(-, E)$ induces an exact anti-equivalence
$\text{Mod}^{fg}_R \to \text{Mod}^{fg}_R$ and
$D \circ D \cong \text{id}$.
\end{lemma}

\begin{proof}
We have seen that $D \circ D = \text{id}$ on $\text{Mod}^{fg}_R$
in Lemma \ref{lemma-evaluate}. It follows immediately that
$D$ is an anti-equivalence.
\end{proof}

\begin{lemma}
\label{lemma-duality-torsion-cotorsion}
Assumptions and notation as in Lemma \ref{lemma-duality}.
Let $I \subset R$ be an ideal and $M$ a finite $R$-module.
Then
$$
D(M[I]) = D(M)/ID(M) \quad\text{and}\quad D(M/IM) = D(M)[I]
$$
\end{lemma}

\begin{proof}
Say $I = (f_1, \ldots, f_t)$. Consider the map
$$
M^{\oplus t} \xrightarrow{f_1, \ldots, f_t} M
$$
with cokernel $M/IM$. Applying the exact functor $D$ we conclude that
$D(M/IM)$ is $D(M)[I]$. The other case is proved in the same way.
\end{proof}



\section{Injective hull of the residue field}
\label{section-hull-residue-field}

\noindent
Most of our results will be for Noetherian local rings in this section.

\begin{lemma}
\label{lemma-quotient}
Let $R \to S$ be a surjective map of local rings with kernel $I$.
Let $E$ be the injective hull of the residue field of $R$ over $R$.
Then $E[I]$ is the injective hull of the residue field of $S$ over $S$.
\end{lemma}

\begin{proof}
Observe that $E[I] = \Hom_R(S, E)$ as $S = R/I$. Hence $E[I]$ is an injective
$S$-module by Lemma \ref{lemma-hom-injective}. Since $E$ is an essential
extension of $\kappa = R/\mathfrak m_R$ it follows that $E[I]$ is an
essential extension of $\kappa$ as well. The result follows.
\end{proof}

\begin{lemma}
\label{lemma-torsion-submodule-sum-injective-hulls}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
Let $E$ be the injective hull of $\kappa$.
Let $M$ be a $\mathfrak m$-power torsion $R$-module
with $n = \dim_\kappa(M[\mathfrak m]) < \infty$.
Then $M$ is isomorphic to a submodule of $E^{\oplus n}$.
\end{lemma}

\begin{proof}
Observe that $E^{\oplus n}$ is the injective hull of
$\kappa^{\oplus n} = M[\mathfrak m]$. Thus there is an $R$-module map
$M \to E^{\oplus n}$ which is injective on $M[\mathfrak m]$.
Since $M$ is $\mathfrak m$-power torsion the inclusion
$M[\mathfrak m] \subset M$ is an essential extension
(for example by Lemma \ref{lemma-essential-extension})
we conclude that the kernel of $M \to E^{\oplus n}$ is zero.
\end{proof}

\begin{lemma}
\label{lemma-union-artinian}
Let $(R, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $E$ be an injective hull of $\kappa$ over $R$.
Let $E_n$ be an injective hull of $\kappa$ over $R/\mathfrak m^n$.
Then $E = \bigcup E_n$ and $E_n = E[\mathfrak m^n]$.
\end{lemma}

\begin{proof}
We have $E_n = E[\mathfrak m^n]$ by Lemma \ref{lemma-quotient}.
We have $E = \bigcup E_n$ because $\bigcup E_n = E[\mathfrak m^\infty]$
is an injective $R$-submodule which contains $\kappa$, see
Lemma \ref{lemma-injective-module-divide}.
\end{proof}

\noindent
The following lemma tells us the injective hull of the residue
field of a Noetherian local ring only depends on the completion.

\begin{lemma}
\label{lemma-compare}
Let $R \to S$ be a flat local homomorphism of local Noetherian rings
such that $R/\mathfrak m_R \cong S/\mathfrak m_R S$.
Then the injective hull of the residue field
of $R$ is the injective hull of the residue field of $S$.
\end{lemma}

\begin{proof}
Set $\kappa = R/\mathfrak m_R = S/\mathfrak m_S$.
Let $E_R$ be the injective hull of $\kappa$ over $R$.
Let $E_S$ be the injective hull of $\kappa$ over $S$.
Observe that $E_S$ is an injective $R$-module by
Lemma \ref{lemma-injective-flat}.
Choose an extension $E_R \to E_S$ of the identification of
residue fields. This map is an isomorphism by
Lemma \ref{lemma-union-artinian}
because $R \to S$ induces an isomorphism
$R/\mathfrak m_R^n \to S/\mathfrak m_S^n$ for all $n$.
\end{proof}

\begin{lemma}
\label{lemma-endos}
Let $(R, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $E$ be an injective hull of $\kappa$ over $R$. Then
$\Hom_R(E, E)$ is canonically isomorphic to the completion of $R$.
\end{lemma}

\begin{proof}
Write $E = \bigcup E_n$ with $E_n = E[\mathfrak m^n]$ as in
Lemma \ref{lemma-union-artinian}. Any endomorphism of $E$
preserves this filtration. Hence
$$
\Hom_R(E, E) = \lim \Hom_R(E_n, E_n)
$$
The lemma follows as
$\Hom_R(E_n, E_n) = \Hom_{R/\mathfrak m^n}(E_n, E_n) = R/\mathfrak m^n$
by Lemma \ref{lemma-evaluate}.
\end{proof}

\begin{lemma}
\label{lemma-injective-hull-has-dcc}
Let $(R, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $E$ be an injective hull of $\kappa$ over $R$. Then
$E$ satisfies the descending chain condition.
\end{lemma}

\begin{proof}
If $E \subset M_1 \subset M_2 \ldots$ is a sequence of submodules, then
$$
\Hom_R(E, E) \to \Hom_R(M_1, E) \to \Hom_R(M_2, E) \to \ldots
$$
is sequence of surjections. By Lemma \ref{lemma-endos} each of these is a
module over the completion $R^\wedge = \Hom_R(E, E)$.
Since $R^\wedge$ is Noetherian
(Algebra, Lemma \ref{algebra-lemma-completion-Noetherian-Noetherian})
the sequence stabilizes: $\Hom_R(M_n, E) = \Hom_R(M_{n + 1}, E) = \ldots$.
Since $E$ is injective, this can only happen if $\Hom_R(M_n/M_{n + 1}, E)$
is zero. However, if $M_n/M_{n + 1}$ is nonzero, then it contains a
nonzero element annihilated by $\mathfrak m$, because $E$ is
$\mathfrak m$-power torsion by Lemma \ref{lemma-union-artinian}.
In this case $M_n/M_{n + 1}$ has a nonzero map into $E$, contradicting
the assumed vanishing. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-describe-categories}
Let $(R, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $E$ be an injective hull of $\kappa$.
\begin{enumerate}
\item For an $R$-module $M$ the following are equivalent:
\begin{enumerate}
\item $M$ satisfies the ascending chain condition,
\item $M$ is a finite $R$-module, and
\item there exist $n, m$ and an exact sequence
$R^{\oplus m} \to R^{\oplus n} \to M \to 0$.
\end{enumerate}
\item For an $R$-module $M$ the following are equivalent:
\begin{enumerate}
\item $M$ satisfies the descending chain condition,
\item $M$ is $\mathfrak m$-power torsion and
$\dim_\kappa(M[\mathfrak m]) < \infty$, and
\item there exist $n, m$ and an exact sequence
$0 \to M \to E^{\oplus n} \to E^{\oplus m}$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
We omit the proof of (1).

\medskip\noindent
Let $M$ be an $R$-module with the descending chain condition. Let $x \in M$.
Then $\mathfrak m^n x$ is a descending chain of submodules, hence stabilizes.
Thus $\mathfrak m^nx = \mathfrak m^{n + 1}x$ for some $n$. By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK}) this implies $\mathfrak m^n x = 0$,
i.e., $x$ is $\mathfrak m$-power torsion. Since $M[\mathfrak m]$ is a vector
space over $\kappa$ it has to be finite dimensional in order to have the
descending chain condition.

\medskip\noindent
Assume that $M$ is $\mathfrak m$-power torsion and has a finite dimensional
$\mathfrak m$-torsion submodule $M[\mathfrak m]$. By
Lemma \ref{lemma-torsion-submodule-sum-injective-hulls}
we see that $M$ is a submodule of $E^{\oplus n}$ for some $n$.
Consider the quotient $N = E^{\oplus n}/M$. By
Lemma \ref{lemma-injective-hull-has-dcc} the module $E$ has the
descending chain condition hence so do $E^{\oplus n}$ and $N$.
Therefore $N$ satisfies (2)(a) which implies $N$ satisfies
(2)(b) by the second paragraph of the proof. Thus by
Lemma \ref{lemma-torsion-submodule-sum-injective-hulls}
again we see that $N$ is a submodule of $E^{\oplus m}$ for some $m$.
Thus we have a short exact sequence
$0 \to M \to E^{\oplus n} \to E^{\oplus m}$.

\medskip\noindent
Assume we have a short exact sequence
$0 \to M \to E^{\oplus n} \to E^{\oplus m}$.
Since $E$ satisfies the descending chain condition by
Lemma \ref{lemma-injective-hull-has-dcc}
so does $M$.
\end{proof}

\begin{proposition}[Matlis duality]
\label{proposition-matlis}
Let $(R, \mathfrak m, \kappa)$ be a complete local Noetherian ring.
Let $E$ be an injective hull of $\kappa$ over $R$. The functor
$D(-) = \Hom_R(-, E)$ induces an anti-equivalence
$$
\left\{
\begin{matrix}
R\text{-modules with the} \\
\text{descending chain condition}
\end{matrix}
\right\}
\longleftrightarrow
\left\{
\begin{matrix}
R\text{-modules with the} \\
\text{ascending chain condition}
\end{matrix}
\right\}
$$
and we have $D \circ D = \text{id}$ on either side of the equivalence.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-endos} we have $R = \Hom_R(E, E) = D(E)$.
Of course we have $E = \Hom_R(R, E) = D(R)$. Since $E$ is injective
the functor $D$ is exact. The result now follows immediately from the
description of the categories in
Lemma \ref{lemma-describe-categories}.
\end{proof}




















\section{Deriving torsion}
\label{section-bad-local-cohomology}

\noindent
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal
(if $I$ is not finitely generated perhaps a different definition
should be used). Let $Z = V(I) \subset \Spec(A)$. Recall that the
category $I^\infty\text{-torsion}$ of $I$-power torsion modules
only depends on the closed subset $Z$ and not on the choice of the
finitely generated ideal $I$ such that $Z = V(I)$, see
More on Algebra, Lemma \ref{more-algebra-lemma-local-cohomology-closed}.
In this section we will consider the functor
$$
H^0_{I} : \text{Mod}_A \longrightarrow I^\infty\text{-torsion},\quad
M \longmapsto M[I^\infty] = \bigcup M[I^n]
$$
which sends $M$ to the submodule of $I$-power torsion.

\medskip\noindent
Let $A$ be a ring and let $I$ be a finitely generated ideal.
Note that $I^\infty\text{-torsion}$ is a Grothendieck
abelian category (direct sums exist, filtered colimits are
exact, and $\bigoplus A/I^n$ is a generator by
More on Algebra, Lemma \ref{more-algebra-lemma-I-power-torsion-presentation}).
Hence the derived category $D(I^\infty\text{-torsion})$ exists, see
Injectives, Remark \ref{injectives-remark-existence-D}.
Our functor $H^0_I$ is left exact and has a derived extension
which we will denote
$$
R\Gamma_I : D(A) \longrightarrow D(I^\infty\text{-torsion}).
$$
{\bf Warning:} this functor does not deserve the name
local cohomology unless the ring $A$ is Noetherian.
The functors $H^0_I$, $R\Gamma_I$, and the satellites $H^p_I$
only depend on the closed subset $Z \subset \Spec(A)$ and not
on the choice of the finitely generated ideal $I$ such that
$V(I) = Z$. However, we insist on using the subscript $I$ for
the functors above as the notation $R\Gamma_Z$ is going
to be used for a different functor, see
(\ref{equation-local-cohomology}), which
agrees with the functor $R\Gamma_I$ only (as far as we know)
in case $A$ is Noetherian
(see Lemma \ref{lemma-local-cohomology-noetherian}).

\begin{lemma}
\label{lemma-adjoint}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
The functor $R\Gamma_I$ is right adjoint to the functor
$D(I^\infty\text{-torsion}) \to D(A)$.
\end{lemma}

\begin{proof}
This follows from the fact that taking $I$-power torsion submodules
is the right adjoint to the inclusion functor
$I^\infty\text{-torsion} \to \text{Mod}_A$. See
Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-ext}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
For any object $K$ of $D(A)$ we have
$$
R\Gamma_I(K) = \text{hocolim}\ R\Hom_A(A/I^n, K)
$$
in $D(A)$ and
$$
R^q\Gamma_I(K) = \colim_n \text{Ext}_A^q(A/I^n, K)
$$
as modules for all $q \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Let $J^\bullet$ be a K-injective complex representing $K$.
Then
$$
R\Gamma_I(K) = J^\bullet[I^\infty] = \colim J^\bullet[I^n] =
\colim \Hom_A(A/I^n, J^\bullet)
$$
By Derived Categories, Lemma \ref{derived-lemma-colim-hocolim}
we obtain the first equality. The second equality is clear
because $H^q(\Hom_A(A/I^n, J^\bullet)) = \text{Ext}^q_A(A/I^n, K)$
and because filtered colimits are exact in the category of abelian
groups.
\end{proof}

\begin{lemma}
\label{lemma-bad-local-cohomology-vanishes}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Let $K^\bullet$ be a complex of $A$-modules such that
$f : K^\bullet \to K^\bullet$ is an isomorphism for some
$f \in I$, i.e., $K^\bullet$ is a complex of $A_f$-modules. Then
$R\Gamma_I(K^\bullet) = 0$.
\end{lemma}

\begin{proof}
Namely, in this case the cohomology modules of $R\Gamma_I(K^\bullet)$
are both $f$-power torsion and $f$ acts by automorphisms. Hence the
cohomology modules are zero and hence the object is zero.
\end{proof}

\noindent
Let $A$ be a ring and $I \subset A$ a finitely generated ideal.
By More on Algebra, Lemma \ref{more-algebra-lemma-I-power-torsion}
the category of $I$-power torsion modules is a Serre subcategory
of the category of all $A$-modules, hence there is a functor
\begin{equation}
\label{equation-compare-torsion}
D(I^\infty\text{-torsion}) \to D_{I^\infty\text{-torsion}}(A)
\end{equation}
see Derived Categories, Section \ref{derived-section-triangulated-sub}.

\begin{lemma}
\label{lemma-not-equal}
Let $A$ be a ring and let $I$ be a finitely generated ideal.
Let $M$ and $N$ be $I$-power torsion modules.
\begin{enumerate}
\item $\Hom_{D(A)}(M, N) = \Hom_{D({I^\infty\text{-torsion}})}(M, N)$,
\item $\text{Ext}^1_{D(A)}(M, N) =
\text{Ext}^1_{D({I^\infty\text{-torsion}})}(M, N)$,
\item $\text{Ext}^2_{D({I^\infty\text{-torsion}})}(M, N) \to
\text{Ext}^2_{D(A)}(M, N)$ is not surjective in general,
\item (\ref{equation-compare-torsion}) is not an equivalence in general.
\end{enumerate}
\end{lemma}

\begin{proof}
Parts (1) and (2) follow immediately from the fact that $I$-power torsion
forms a Serre subcategory of $\text{Mod}_A$. Part (4) follows from
part (3).

\medskip\noindent
For part (3) let $A$ be a ring with an element $f \in A$ such that
$A[f]$ contains a nonzero element $x$ and $A$ contains elements
$x_n$ with $f^nx_n = x$. Such a ring $A$ exists because we can take
$$
A = \mathbf{Z}[f, x, x_n]/(fx, f^nx_n - x)
$$
Given $A$ set $I = (f)$. Then the exact sequence
$$
0 \to A[f] \to A \xrightarrow{f} A \to A/fA \to 0
$$
defines an element in $\text{Ext}^2_A(A/fA, A[f])$. We claim this
element does not come from an element of
$\text{Ext}^2_{D(f^\infty\text{-torsion})}(A/fA, A[f])$.
Namely, if it did, then there would be an exact sequence
$$
0 \to A[f] \to M \to N \to A/fA \to 0
$$
where $M$ and $N$ are $f$-power torsion modules defining the same
$2$ extension class. Since $A \to A$ is a complex of free modules
and since the $2$ extension classes are the same
we would be able to find a map
$$
\xymatrix{
0 \ar[r] &
A[f] \ar[r] \ar[d] &
A \ar[r] \ar[d]_\varphi &
A \ar[r] \ar[d]_\psi &
A/fA \ar[r] \ar[d] & 0 \\
0 \ar[r] &
A[f] \ar[r] &
M \ar[r] &
N \ar[r] &
A/fA \ar[r] & 0
}
$$
(some details omitted). Then we could replace $M$ by the image of
$\varphi$ and $N$ by the image of $\psi$. Then $M$ would be a cyclic
module, hence $f^n M = 0$ for some $n$. Considering $\varphi(x_{n + 1})$
we get a contradiction with the fact that $f^{n + 1}x_n = x$ is
nonzero in $A[f]$.
\end{proof}









\section{Local cohomology}
\label{section-local-cohomology}

\noindent
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Set $Z = V(I) \subset \Spec(A)$. We will construct a functor
\begin{equation}
\label{equation-local-cohomology}
R\Gamma_Z : D(A) \longrightarrow D_{I^\infty\text{-torsion}}(A).
\end{equation}
which is right adjoint to the inclusion functor. For notation
see Section \ref{section-bad-local-cohomology}. The cohomology
modules of $R\Gamma_Z(K)$ are the {\it local cohomology groups
of $K$ with respect to $Z$}. In fact, we will show $R\Gamma_Z$
computes cohomology with support in $Z$ for the assocated
complex of quasi-coherent sheaves on $\Spec(A)$. By
Lemma \ref{lemma-not-equal} this functor will in general {\bf not} be
equal to $R\Gamma_I( - )$ even viewed as functors into $D(A)$.
In Section \ref{section-local-cohomology-noetherian}
we will show that if $A$ is Noetherian, then the two agree.

\begin{lemma}
\label{lemma-local-cohomology-adjoint}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
There exists a right adjoint $R\Gamma_Z$ (\ref{equation-local-cohomology})
to the inclusion functor $D_{I^\infty\text{-torsion}}(A) \to D(A)$.
In fact, if $I$ is generated by $f_1, \ldots, f_r \in A$, then we have
$$
R\Gamma_Z(K) =
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}}
\to \ldots \to A_{f_1\ldots f_r}) \otimes_A^\mathbf{L} K
$$
functorially in $K \in D(A)$.
\end{lemma}

\begin{proof}
Say $I = (f_1, \ldots, f_r)$ is an ideal.
Let $K^\bullet$ be a complex of $A$-modules.
There is a canonical map of complexes
$$
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \longrightarrow A.
$$
from the extended {\v C}ech complex to $A$.
Tensoring with $K^\bullet$, taking associated total complex,
we get a map
$$
\text{Tot}\left(
K^\bullet \otimes_A
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
\longrightarrow
K^\bullet
$$
in $D(A)$. We claim the cohomology modules of the complex on the left are
$I$-power torsion, i.e., the LHS is an object of
$D_{I^\infty\text{-torsion}}(A)$. Namely, we have
$$
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) = \colim K(A, f_1^n, \ldots, f_r^n)
$$
by More on Algebra, Lemma
\ref{more-algebra-lemma-extended-alternating-Cech-is-colimit-koszul}.
Moreover, multiplication by $f_i^n$ on the complex
$K(A, f_1^n, \ldots, f_r^n)$ is homotopic to zero by
More on Algebra, Lemma \ref{more-algebra-lemma-homotopy-koszul}.
Since
$$
H^q\left( LHS \right) =
\colim H^q(\text{Tot}(K^\bullet \otimes_A K(A, f_1^n, \ldots, f_r^n)))
$$
we obtain our claim. On the other hand, if $K^\bullet$ is an
object of $D_{I^\infty\text{-torsion}}(A)$, then the complexes
$K^\bullet \otimes_A A_{f_{i_0} \ldots f_{i_p}}$ have vanishing
cohomology. Hence in this case the map $LHS \to K^\bullet$
is an isomorphism in $D(A)$. The construction
$$
R\Gamma_Z(K^\bullet) =
\text{Tot}\left(
K^\bullet \otimes_A
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
$$
is functorial in $K^\bullet$ and defines an exact functor
$D(A) \to D_{I^\infty\text{-torsion}}(A)$ between
triangulated categories. It follows formally from the
existence of the natural transformation $R\Gamma_Z \to \text{id}$
given above and the fact that this evaluates to an isomorphism
on $K^\bullet$ in the subcategory, that $R\Gamma_Z$ is the desired
right adjoint.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-and-restriction}
Let $A \to B$ be a ring homomorphism and let $I \subset A$
be a finitely generated ideal. Set $J = IB$. Set $Z = V(I)$
and $Y = V(J)$. Then
$$
R\Gamma_Z(M_A) = R\Gamma_Y(M)_A
$$
functorially in $M \in D(B)$. Here $(-)_A$ denotes the restriction
functors $D(B) \to D(A)$ and
${}_A : D_{J^\infty\text{-torsion}}(B) \to D_{I^\infty\text{-torsion}}(A)$.
\end{lemma}

\begin{proof}
This follows from uniquess of adjoint functors as both
$R\Gamma_Z((-)_A)$ and $R\Gamma_Y(-)_A$
are right adjoint to the functor $D_{I^\infty\text{-torsion}}(A) \to D(B)$,
$K \mapsto K \otimes_A^\mathbf{L} B$.
Alternatively, one can use the description of $R\Gamma_Z$ and $R\Gamma_Y$
in terms of alternating {\v C}ech complexes
(Lemma \ref{lemma-local-cohomology-adjoint}).
Namely, if $I = (f_1, \ldots, f_r)$ then $J$ is generated by the images
$g_1, \ldots, g_r \in B$ of $f_1, \ldots, f_r$.
Then the statement of the lemma follows from the existence of
a canonical isomorphism
\begin{align*}
& M_A \otimes_A (A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}}
\to \ldots \to A_{f_1\ldots f_r}) \\
& = 
M \otimes_B (B \to \prod\nolimits_{i_0} B_{g_{i_0}} \to
\prod\nolimits_{i_0 < i_1} B_{g_{i_0}g_{i_1}}
\to \ldots \to B_{g_1\ldots g_r})
\end{align*}
for any $B$-module $M$.
\end{proof}

\begin{lemma}
\label{lemma-torsion-change-rings}
Let $A \to B$ be a ring homomorphism and let $I \subset A$
be a finitely generated ideal. Set $J = IB$. Let $Z = V(I)$ and $Y = V(J)$.
Then
$$
R\Gamma_Z(K) \otimes_A^\mathbf{L} B = R\Gamma_Y(K \otimes_A^\mathbf{L} B)
$$
functorially in $K \in D(A)$.
\end{lemma}

\begin{proof}
This follows from uniquess of adjoint functors
as both $R\Gamma_Z( - ) \otimes_A^\mathbf{L} B$ and
$R\Gamma_Y(- \otimes_A^\mathbf{L} B)$
are right adjoint to the functor
$D_{J^\infty\text{-torsion}}(B) \to D(A)$. Alternatively, one can use
the description of $R\Gamma_Z$ and $R\Gamma_Y$ in terms of alternating
{\v C}ech complexes (Lemma \ref{lemma-local-cohomology-adjoint})
and use that formation of the extended {\v C}ech
complex commutes with base change.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-vanishes}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Let $K^\bullet$ be a complex of $A$-modules such that
$f : K^\bullet \to K^\bullet$ is an isomorphism for some
$f \in I$, i.e., $K^\bullet$ is a complex of $A_f$-modules. Then
$R\Gamma_Z(K^\bullet) = 0$.
\end{lemma}

\begin{proof}
Namely, in this case the cohomology modules of $R\Gamma_Z(K^\bullet)$
are both $f$-power torsion and $f$ acts by automorphisms. Hence the
cohomology modules are zero and hence the object is zero.
\end{proof}

\begin{lemma}
\label{lemma-torsion-tensor-product}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
For $K, L \in D(A)$ we have
$$
R\Gamma_Z(K \otimes_A^\mathbf{L} L) =
K \otimes_A^\mathbf{L} R\Gamma_Z(L) =
R\Gamma_Z(K) \otimes_A^\mathbf{L} L =
R\Gamma_Z(K) \otimes_A^\mathbf{L} R\Gamma_Z(L)
$$
If $K$ or $L$ is in $D_{I^\infty\text{-torsion}}(A)$ then so is
$K \otimes_A^\mathbf{L} L$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-local-cohomology-adjoint} we know that
$R\Gamma_Z$ is given by $C \otimes^\mathbf{L} -$ for some $C \in D(A)$.
Hence, for $K, L \in D(A)$ general we have
$$
R\Gamma_Z(K \otimes_A^\mathbf{L} L) =
K \otimes^\mathbf{L} L \otimes_A^\mathbf{L} C =
K \otimes_A^\mathbf{L} R\Gamma_Z(L)
$$
The other equalities follow formally from this one. This also implies
the last statement of the lemma.
\end{proof}

\noindent
The following lemma tells us that the functor $R\Gamma_Z$
is related to cohomology with supports.

\begin{lemma}
\label{lemma-local-cohomology-is-local-cohomology}
Let $A$ be a ring and let $I$ be a finitely generated ideal.
With $Z = V(I) \subset X = \Spec(A)$ there is a functorial
isomorphism
$$
R\Gamma_Z(K^\bullet) = R\Gamma_Z(\widetilde{K^\bullet})
$$
where on the left we have (\ref{equation-local-cohomology})
and on the right we have the functor of
Cohomology, Section \ref{cohomology-section-cohomology-support}.
\end{lemma}

\begin{proof}
Denote $\mathcal{F}^\bullet = \widetilde{K^\bullet}$ be
the complex of quasi-coherent $\mathcal{O}_X$-modules on $X$
associated to $K^\bullet$.
By Cohomology, Section \ref{cohomology-section-cohomology-support}
there exists a distinguished triangle
$$
R\Gamma_Z(X, \mathcal{F}^\bullet)
\to R\Gamma(X, \mathcal{F}^\bullet)
\to R\Gamma(U, \mathcal{F}^\bullet)
\to R\Gamma_Z(X, \mathcal{F}^\bullet)[1]
$$
where $U = X \setminus Z$. We know that
$R\Gamma(X, \mathcal{F}^\bullet) = K^\bullet$
for example by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
Say $I = (f_1, \ldots, f_r)$. Then we obtain a finite affine
open covering $\mathcal{U} : U = D(f_1) \cup \ldots \cup D(f_r)$.
By Derived Categories of Schemes, Lemma
\ref{perfect-lemma-alternating-cech-complex-complex-computes-cohomology}
the alternating {\v C}ech complex
$$
\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F}^\bullet))
$$
computes $R\Gamma(U, \mathcal{F}^\bullet)$. Working through the
definitions we find
$$
R\Gamma(U, \mathcal{F}^\bullet) =
\text{Tot}\left(
K^\bullet \otimes_A
(\prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
$$
It is clear that
$R\Gamma(X, \mathcal{F}^\bullet) \to R\Gamma(U, \mathcal{F}^\bullet)$
is given by the map from $A$ into $\prod A_{f_i}$. Hence we conclude that
$$
R\Gamma_Z(X, \mathcal{F}^\bullet) =
\text{Tot}\left(
K^\bullet \otimes_A
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
$$
By Lemma \ref{lemma-local-cohomology-adjoint}
this complex computes $R\Gamma_Z(K^\bullet)$ and we see the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-ss}
Let $A$ be a ring and let $I, J \subset A$ be finitely generated
ideals. Set $Z = V(I)$ and $Y = V(J)$. Then $Z \cap Y = V(I + J)$
and $R\Gamma_Y \circ R\Gamma_Z = R\Gamma_{Y \cap Z}$ as functors
$D(A) \to D_{(I + J)^\infty\text{-torsion}}(A)$. For $K \in D^+(A)$
there is a spectral sequence
$$
E_2^{p, q} = H^p_Y(H^p_Z(K)) \Rightarrow H^{p + q}_{Y \cap Z}(K)
$$
as in Derived Categories, Lemma
\ref{derived-lemma-grothendieck-spectral-sequence}.
\end{lemma}

\begin{proof}
There is a bit of abuse of notation in the lemma as strictly
speaking we cannot compose $R\Gamma_Y$ and $R\Gamma_Z$. The
meaning of the statement is simply that we are composing
$R\Gamma_Z$ with the inclusion $D_{I^\infty\text{-torsion}}(A) \to D(A)$
and then with $R\Gamma_Y$. Then the equality
$R\Gamma_Y \circ R\Gamma_Z = R\Gamma_{Y \cap Z}$
follows from the fact that
$$
D_{I^\infty\text{-torsion}}(A) \to D(A) \xrightarrow{R\Gamma_Y}
D_{(I + J)^\infty\text{-torsion}}(A)
$$
is right adjoint to the inclusion
$D_{(I + J)^\infty\text{-torsion}}(A) \to D_{I^\infty\text{-torsion}}(A)$.
Alternatively one can prove the formula using
Lemma \ref{lemma-local-cohomology-adjoint}
and the fact that the tensor product of
extended {\v C}ech complexes on $f_1, \ldots, f_r$ and
$g_1, \ldots, g_m$ is the extended {\v C} complex on
$f_1, \ldots, f_n. g_1, \ldots, g_m$.
The final assertion follows from this and the cited lemma.
\end{proof}

\noindent
The following lemma is the analogue of
More on Algebra, Lemma
\ref{more-algebra-lemma-restriction-derived-complete-equivalence}
for complexes with torsion cohomologies.

\begin{lemma}
\label{lemma-torsion-flat-change-rings}
Let $A \to B$ be a flat ring map and let $I \subset A$ be a finitely
generated ideal such that $A/I = B/IB$. Then base change and
restriction induce quasi-inverse equivalences
$D_{I^\infty\text{-torsion}}(A) = D_{(IB)^\infty\text{-torsion}}(B)$.
\end{lemma}

\begin{proof}
More precisely the functors are $K \mapsto K \otimes_A^\mathbf{L} B$
for $K$ in $D_{I^\infty\text{-torsion}}(A)$ and $M \mapsto M_A$
for $M$ in $D_{(IB)^\infty\text{-torsion}}(B)$. The reason this works
is that $H^i(K \otimes_A^\mathbf{L} B) = H^i(K) \otimes_A B = H^i(K)$.
The first equality holds as $A \to B$ is flat and the second by
More on Algebra, Lemma \ref{more-algebra-lemma-neighbourhood-isomorphism}.
\end{proof}

\noindent
The following lemma was shown for $\Hom$ and $\text{Ext}^1$ of modules in
More on Algebra, Lemmas \ref{more-algebra-lemma-neighbourhood-equivalence} and
\ref{more-algebra-lemma-neighbourhood-extensions}.

\begin{lemma}
\label{lemma-neighbourhood-extensions}
Let $A \to B$ be a flat ring map and let $I \subset A$ be a
finitely generated ideal such that $A/I \to B/IB$ is an isomorphism.
For $K \in D_{I^\infty\text{-torsion}}(A)$ and $L \in D(A)$
the map
$$
R\Hom_A(K, L) \longrightarrow R\Hom_B(K \otimes_A B, L \otimes_A B)
$$
is a quasi-isomorphism. In particular, if $M$, $N$ are $A$-modules and
$M$ is $I$-power torsion, then the canonical map
$$
\text{Ext}^i_A(M, N)
\longrightarrow
\text{Ext}^i_B(M \otimes_A B, N \otimes_A B)
$$
is an isomorphism for all $i$. 
\end{lemma}

\begin{proof}
Let $Z = V(I) \subset \Spec(A)$ and $Y = V(IB) \subset \Spec(B)$.
Since the cohomology modules of $K$ are $I$ power torsion, the
canonical map $R\Gamma_Z(L) \to L$ induces an isomorphism
$$
R\Hom_A(K, R\Gamma_Z(L)) \to R\Hom_A(K, L)
$$
in $D(A)$. Similarly, the cohomology modules of $K \otimes_A B$ are
$IB$ power torsion and we have an isomorphism
$$
R\Hom_B(K \otimes_A B, R\Gamma_Y(L \otimes_A B)) \to 
R\Hom_B(K \otimes_A B, L \otimes_A B)
$$
in $D(B)$.
By Lemma \ref{lemma-torsion-change-rings} we have
$R\Gamma_Z(L) \otimes_A B = R\Gamma_Y(L \otimes_A B)$.
Hence it suffices to show that the map
$$
R\Hom_A(K, R\Gamma_Z(L)) \to R\Hom_B(K \otimes_A B, R\Gamma_Z(L) \otimes_A B)
$$
is a quasi-isomorphism. This follows from
Lemma \ref{lemma-torsion-flat-change-rings}.
\end{proof}




\section{Local cohomology for Noetherian rings}
\label{section-local-cohomology-noetherian}

\noindent
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Set $Z = V(I) \subset \Spec(A)$. Recall that (\ref{equation-compare-torsion})
is the functor
$$
D(I^\infty\text{-torsion}) \to D_{I^\infty\text{-torsion}}(A)
$$
In fact, there is a natural transformation of functors
\begin{equation}
\label{equation-compare-torsion-functors}
(\ref{equation-compare-torsion}) \circ R\Gamma_I(-)
\longrightarrow
R\Gamma_Z(-)
\end{equation}
Namely, given a complex of $A$-modules $K^\bullet$ the canonical map
$R\Gamma_I(K^\bullet) \to K^\bullet$ in $D(A)$ factors (uniquely)
through $R\Gamma_Z(K^\bullet)$ as $R\Gamma_I(K^\bullet)$ has
$I$-power torsion cohomology modules (see Lemma \ref{lemma-adjoint}).
In general this map is not an isomorphism (we've seen this in
Lemma \ref{lemma-not-equal}).

\begin{lemma}
\label{lemma-local-cohomology-noetherian}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
\begin{enumerate}
\item the adjunction $R\Gamma_I(K) \to K$ is an isomorphism
for $K \in D_{I^\infty\text{-torsion}}(A)$,
\item the functor
(\ref{equation-compare-torsion})
$D(I^\infty\text{-torsion}) \to D_{I^\infty\text{-torsion}}(A)$
is an equivalence,
\item the transformation of functors
(\ref{equation-compare-torsion-functors}) is an isomorphism,
in other words $R\Gamma_I(K) = R\Gamma_Z(K)$ for $K \in D(A)$.
\end{enumerate}
\end{lemma}

\begin{proof}
A formal argument, which we omit, shows that it suffices to prove (1).

\medskip\noindent
Let $M$ be an $I$-power torsion $A$-module. Choose an embedding
$M \to J$ into an injective $A$-module. Then $J[I^\infty]$ is
an injective $A$-module, see Lemma \ref{lemma-injective-module-divide},
and we obtain an embedding $M \to J[I^\infty]$.
Thus every $I$-power torsion module has an injective resolution
$M \to J^\bullet$ with $J^n$ also $I$-power torsion. It follows
that $R\Gamma_I(M) = M$ (this is not a triviality and this is not
true in general if $A$ is not Noetherian). Next, suppose that
$K \in D_{I^\infty\text{-torsion}}^+(A)$. Then the spectral sequence
$$
R^q\Gamma_I(H^p(K)) \Rightarrow R^{p + q}\Gamma_I(K)
$$
(Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor})
converges and above we have seen that only the terms with $q = 0$
are nonzero. Thus we see that $R\Gamma_I(K) \to K$ is an isomorphism.

\medskip\noindent
Suppose $K$ is an arbitrary object of $D_{I^\infty\text{-torsion}}(A)$.
We have
$$
R^q\Gamma_I(K) = \colim \text{Ext}^q_A(A/I^n, K)
$$
by Lemma \ref{lemma-local-cohomology-ext}. Choose $f_1, \ldots, f_r \in A$
generating $I$. Let $K_n^\bullet = K(A, f_1^n, \ldots, f_r^n)$ be the
Koszul complex with terms in degrees $-r, \ldots, 0$. Since the
pro-objects $\{A/I^n\}$ and $\{K_n^\bullet\}$ in $D(A)$ are the same by
More on Algebra, Lemma \ref{more-algebra-lemma-sequence-Koszul-complexes},
we see that
$$
R^q\Gamma_I(K) = \colim \text{Ext}^q_A(K_n^\bullet, K)
$$
Pick any complex $K^\bullet$ of $A$-modules representing $K$.
Since $K_n^\bullet$ is a finite complex of finite free modules we see
that
$$
\text{Ext}^q_A(K_n, K) =
H^q(\text{Tot}((K_n^\bullet)^\vee \otimes_A K^\bullet))
$$
where $(K_n^\bullet)^\vee$ is the dual of the complex $K_n^\bullet$.
See More on Algebra, Lemma \ref{more-algebra-lemma-RHom-out-of-projective}.
As $(K_n^\bullet)^\vee$ is a complex of finite free $A$-modules sitting
in degrees $0, \ldots, r$ we see that the terms of the complex
$\text{Tot}((K_n^\bullet)^\vee \otimes_A K^\bullet)$ are the
same as the terms of the complex
$\text{Tot}((K_n^\bullet)^\vee \otimes_A \tau_{\geq q - r - 2} K^\bullet)$
in degrees $q - 1$ and higher. Hence we see that
$$
\text{Ext}^q_A(K_n, K) = \text{Ext}^q_A(K_n, \tau_{\geq q - r - 2}K)
$$
for all $n$. It follows that
$$
R^q\Gamma_I(K) = R^q\Gamma_I(\tau_{\geq q - r - 2}K) =
H^q(\tau_{\geq q - r - 2}K) = H^q(K)
$$
Thus we see that the map $R\Gamma_I(K) \to K$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-compute-local-cohomology-noetherian}
If $A$ is a Noetherian ring and $I = (f_1, \ldots, f_r)$ an ideal.
There are canonical isomorphisms
$$
R\Gamma_I(A) \to
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \to R\Gamma_Z(A)
$$
in $D(A)$.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-local-cohomology-noetherian}
and the computation of the functor $R\Gamma_Z$ in
Lemma \ref{lemma-local-cohomology-adjoint}.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-change-rings}
If $A \to B$ is a homomorphism of Noetherian rings and $I \subset A$
is an ideal, then in $D(B)$ we have
$$
R\Gamma_I(A) \otimes_A^\mathbf{L} B =
R\Gamma_Z(A) \otimes_A^\mathbf{L} B =
R\Gamma_Y(B) = R\Gamma_{IB}(B)
$$
where $Y = V(IB) \subset \Spec(B)$.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-compute-local-cohomology-noetherian} and
\ref{lemma-torsion-change-rings}.
\end{proof}






\section{Depth}
\label{section-depth}

\noindent
In this section we revisit the notion of depth introduced in
Algebra, Section \ref{algebra-section-depth}.

\begin{lemma}
\label{lemma-depth}
Let $A$ be a Noetherian ring, let $I \subset A$ be an ideal, and
let $M$ be a finite $A$-module such that $IM \not = M$. Then
the following integers are equal:
\begin{enumerate}
\item $\text{depth}_I(M)$,
\item the smallest integer $i$ such that $\text{Ext}_A^i(A/I, M)$
is nonzero, and
\item the smallest integer $i$ such that $H^i_I(M)$ is nonzero.
\end{enumerate}
Moreover, we have $\text{Ext}^i_A(N, M) = 0$ for $i < \text{depth}_I(M)$
for any finite $A$-module $N$ annihilated by a power of $I$.
\end{lemma}

\begin{proof}
We prove the equality of (1) and (2) by induction on $\text{depth}_I(M)$
which is allowed by
Algebra, Lemma \ref{algebra-lemma-depth-finite-noetherian}.

\medskip\noindent
Base case. If $\text{depth}_I(M) = 0$, then $I$ is contained in the union
of the associated primes of $M$
(Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}).
By prime avoidance (Algebra, Lemma \ref{algebra-lemma-silly})
we see that $I \subset \mathfrak p$ for some associated prime $\mathfrak p$.
Hence $\Hom_A(A/I, M)$
is nonzero. Thus equality holds in this case.

\medskip\noindent
Assume that $\text{depth}_I(M) > 0$. Let $f \in I$ be $M$-regular.
Consider the short exact sequence
$$
0 \to M \to M \to M/fM \to 0
$$
and the associated long exact sequence for $\text{Ext}^*_A(A/I, -)$.
Note that $\text{Ext}^i_A(A/I, M)$ is a finite $A/I$-module
(Algebra, Lemmas \ref{algebra-lemma-ext-noetherian} and
\ref{algebra-lemma-annihilate-ext}). Hence we obtain
$$
\Hom_A(A/I, M/fM) = \text{Ext}^1_A(A/I, M)
$$
and short exact sequences
$$
0 \to \text{Ext}^i_A(A/I, M) \to \text{Ext}^i_A(A/I, M/fM) \to
\text{Ext}^{i + 1}_A(A/I, M) \to 0
$$
Thus the equality of (1) and (2) by induction.

\medskip\noindent
Observe that $\text{dept}_I(M) = \text{depth}_{I^n}(M)$ for all $n \geq 1$
for example by Algebra, Lemma \ref{algebra-lemma-regular-sequence-powers}.
Hence by the equality of (1) and (2) we see that
$\text{Ext}^i_A(A/I^n, M) = 0$ for all $n$ and $i < \text{depth}_I(M)$.
Let $N$ be a finite $A$-module annihilated by a power of $I$.
Then we can choose a short exact sequence
$$
0 \to N' \to (A/I^n)^{\oplus m} \to N \to 0
$$
for some $n, m \geq 0$. Then
$\Hom_A(N, M) \subset \Hom_A((A/I^n)^{\oplus m}, M)$
and
$\text{Ext}^i_A(N, M) \subset \text{Ext}^{i - 1}_A(N', M)$
for $i < \text{depth}_I(M)$. Thus a simply induction argument
shows that the final statement of the lemma holds.

\medskip\noindent
Finally, we prove that (3) is equal to (1) and (2).
We have $H^p_I(M) = \colim \text{Ext}^p_A(A/I^n, M)$ by
Lemma \ref{lemma-local-cohomology-ext}.
Thus we see that $H^i_I(M) = 0$ for $i < \text{depth}_I(M)$.
For $i = \text{depth}_I(M)$, using the vanishing of
$\text{Ext}_A^{i - 1}(I/I^n, M)$ we see that the map
$\text{Ext}_A^i(A/I, M) \to H_I^i(M)$ is injective which
proves nonvanishing in the correct degree.
\end{proof}

\begin{lemma}
\label{lemma-divide-by-torsion}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Let $M$ be an $A$-module. Let $Z = V(I)$.
Then $H^0_I(M) = H^0_Z(M)$. Let $N$ be the common value and
set $M' = M/N$. Then
\begin{enumerate}
\item $H^0_I(M') = 0$ and $H^p_I(M) = H^p_I(M')$ and $H^p_I(N) = 0$
for all $p > 0$,
\item $H^0_Z(M') = 0$ and $H^p_Z(M) = H^p_Z(M')$ and $H^p_Z(N) = 0$
for all $p > 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
By definition $H^0_I(M) = M[I^\infty]$ is $I$-power torsion.
By Lemma \ref{lemma-local-cohomology-adjoint} we see that
$$
H^0_Z(M) = \Ker(M \longrightarrow M_{f_1} \times \ldots \times M_{f_r})
$$
if $I = (f_1, \ldots, f_r)$. Thus $H^0_I(M) \subset H^0_Z(M)$ and
conversely, if $x \in H^0_Z(M)$, then it is annihilated by a $f_i^{e_i}$
for some $e_i \geq 1$ hence annihilated by some power of $I$.
This proves the first equality and moreover $N$ is $I$-power torsion.
By Lemma \ref{lemma-adjoint} we see that $R\Gamma_I(N) = N$.
By Lemma \ref{lemma-local-cohomology-adjoint} we see that $R\Gamma_Z(N) = N$.
This proves the higher vanishing of $H^p_I(N)$ and $H^p_Z(N)$ in (1) and (2).
The vanishing of $H^0_I(M')$ and $H^0_Z(M')$ follow from the preceding
remarks and the fact that $M'$ is $I$-power torsion free by
More on Algebra, Lemma \ref{more-algebra-lemma-divide-by-torsion}.
The equality of higher cohomologies for $M$ and $M'$ follow
immediately from the long exact cohomology sequence.
\end{proof}






\section{Formally catenary rings}
\label{section-formally-catenary}

\noindent
In this section we prove a theorem of Ratliff
\cite{Ratliff} that a Noetherian local
ring is universally catenary if and only if it is formally catenary.

\begin{definition}
\label{definition-formally-catenary}
A Noetherian local ring $A$ is {\it formally catenary}
if for every minimal prime $\mathfrak p \subset A$ the ring
$A^\wedge/\mathfrak p A^\wedge$ is equidimensional.
\end{definition}

\noindent
The following lemma can be used to construct finite type extensions
from given finite type extensions of the formal completion.

\begin{lemma}
\label{lemma-quotient-by-idempotent}
Let $A$ be a Noetherian ring and $I$ an ideal. Let $B$
be a finite type $A$-algebra. Let $B^\wedge \to C$ be a surjective
ring map with kernel $J$ where $B^\wedge$ is the $I$-adic completion.
If $J/J^2$ is annihilated by $I^c$ for some $c \geq 0$, then $C$ is
isomorphic to the completion of a finite type $A$-algebra.
\end{lemma}

\begin{proof}
Since $B^\wedge$ is Noetherian (Algebra, Lemma
\ref{algebra-lemma-completion-Noetherian-Noetherian}),
we see that $J$ is a finitely generated
ideal. Hence we conclude from
Algebra, Lemma \ref{algebra-lemma-ideal-is-squared-union-connected}
that
$$
\Spec(C) \setminus V(IC) \longrightarrow \Spec(B^\wedge) \setminus V(IB^\wedge)
$$
is an open and closed immersion. Let
$V \subset \Spec(B^\wedge) \setminus V(IB^\wedge)$ be the complement
of the image viewed as an open and closed subscheme.
Let $Z \subset \Spec(B^\wedge)$ be the scheme
theoretic closure of $V$. Write $Z = \Spec(C')$. Then
$$
\Spec(C \times C') = \Spec(C) \amalg Z \longrightarrow \Spec(B^\wedge)
$$
is a finite morphism of schemes which is an isomorphism away from
$V(IB^\wedge)$. Hence the corresponding ring map $B^\wedge \to C \times C'$
is finite and becomes an isomorphism on inverting any element of $I$.
Since $B \to B^\wedge$ is a flat map
(Algebra, Lemma \ref{algebra-lemma-completion-flat}) inducing an isomorphism
$B/IB \to B^\wedge/IB^\wedge$ we may apply
More on Algebra, Proposition \ref{more-algebra-proposition-equivalence}
and Remark \ref{more-algebra-remark-formal-glueing-algebras} to it.
We conclude that $C \times C'$ is isomorphic to $D \otimes_B B^\wedge$
for some finite $B$-algebra $D$.
Then $D/ID \cong C/IC \times C'/IC'$. Let $\overline{e} \in D/ID$
be the idempotent corresponding to the factor $C/IC$.
By More on Algebra, Lemma
\ref{more-algebra-lemma-lift-idempotent-upstairs} there exists an
\'etale ring map $B \to B'$ which induces an isomorphism
$B/IB \to B'/IB'$ such that $D' = D \otimes_B B'$ contains an
idempotent $e$ lifting $\overline{e}$. Since $C \times C'$
is $I$-adically complete the pair $(C \times C', IC \times IC')$
is henselian
(More on Algebra, Lemma \ref{more-algebra-lemma-complete-henselian}).
Thus we can factor the map $B \to C \times C'$ through $B'$.
Doing so we may replace $B$ by $B'$ and $D$ by $D'$. Then
we find that $D = D_e \times D_{1 - e} = D/(1 - e) \times D/(e)$
is a product of finite type $A$-algebras and the completion of the
first part is $C$ and the completion of the second part is $C'$.
\end{proof}

\begin{lemma}
\label{lemma-not-formally-catenary}
Let $(A, \mathfrak m)$ be a Noetherian local ring which is not
formally catenary. Then $A$ is not universally catenary.
\end{lemma}

\begin{proof}
By assumption there exists a minimal prime $\mathfrak p \subset A$
such that $A^\wedge /\mathfrak p A^\wedge$ is not equidimensional.
After replacing $A$ by $A/\mathfrak p$ we may assume that $A$
is a domain and that $A^\wedge$ is not equidimensional.
Let $\mathfrak q$ be a minimal prime of
$A^\wedge$ such that $d = \dim(A^\wedge/\mathfrak q)$
is minimal and hence $0 < d < \dim(A)$. We prove the lemma by induction
on $d$.

\medskip\noindent
The case $d = 1$. In this case $\dim(A^\wedge_\mathfrak q) = 0$.
Hence $A^\wedge_\mathfrak q$ is Artinian local and we see that
for some $n > 0$ the ideal $J = \mathfrak q^n$ maps to zero in
$A^\wedge_\mathfrak q$. It follows that $\mathfrak m$ is the
only associated prime of $J/J^2$, whence $\mathfrak m^m$ annihilates
$J/J^2$ for some $m > 0$. Thus we can use
Lemma \ref{lemma-quotient-by-idempotent}
to find $A \to B$ of finite type such that $B^\wedge \cong A^\wedge/J$.
It follows that $\mathfrak m_B = \sqrt{\mathfrak mB}$ is a maximal
ideal with the same residue field as $\mathfrak m$ and $B^\wedge$
is the $\mathfrak m_B$-adic completion
(Algebra, Lemma \ref{algebra-lemma-finite-after-completion}).
Then
$$
\dim(B_{\mathfrak m_B}) = \dim(B^\wedge) = 1 = d.
$$
Since we have the factorization $A \to B \to A^\wedge/J$ the inverse image
of $\mathfrak q/J$ is a prime $\mathfrak q' \subset \mathfrak m_B$ lying
over $(0)$ in $A$. Thus, if $A$ were universally catenary, the dimension
formula (Algebra, Lemma \ref{algebra-lemma-dimension-formula}) would give
\begin{align*}
\dim(B_{\mathfrak m_B})
& \geq
\dim((B/\mathfrak q')_{\mathfrak m_B}) \\
& =
\dim(A) + \text{trdeg}_{f.f.(A)}(f.f.(B/\mathfrak q')) -
\text{trdeg}_{\kappa(\mathfrak m)}(\kappa(\mathfrak m_B)) \\
& =
\dim(A) + \text{trdeg}_{f.f.(A)}(f.f.(B/\mathfrak q'))
\end{align*}
This contradictions finishes the argument in case $d = 1$.

\medskip\noindent
Assume $d > 1$. Let $Z \subset \Spec(A^\wedge)$ be the union of
the irreducible components distinct from $V(\mathfrak q)$.
Let $\mathfrak r_1, \ldots, \mathfrak r_m \subset A^\wedge$
be the prime ideals corresponding to irreducible components of
$V(\mathfrak q) \cap Z$ of dimension $> 0$.
Choose $f \in \mathfrak m$, $f \not \in A \cap \mathfrak r_j$
using prime avoidance (Algebra, Lemma \ref{algebra-lemma-silly}).
Then $\dim(A/fA) = \dim(A) - 1$ and there is some irreducible
component of $V(\mathfrak q, f)$ of dimension $d - 1$.
Thus $A/fA$ is not formally catenary and the invariant $d$ has
decreased. By induction $A/fA$ is not universally catenary, hence
$A$ is not universally catenary.
\end{proof}

\begin{lemma}
\label{lemma-flat-under-catenary-equidimensional}
Let $A \to B$ be a flat local ring map of local Noetherian rings.
Assume $B$ is catenary and equidimensional. Then
\begin{enumerate}
\item $B/\mathfrak p B$ is equidimensional for all $\mathfrak p \subset A$,
\item $A$ is catenary and equidimensional.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset A$ be a prime ideal. Let $\mathfrak q \subset B$
be a prime minimal over $\mathfrak pB$. Then $\mathfrak q \cap A = \mathfrak p$
by going down for $A \to B$
(Algebra, Lemma \ref{algebra-lemma-flat-going-down}).
Hence $A_\mathfrak p \to B_\mathfrak q$ is a flat local ring map
with special fibre of dimension $0$ and hence
$$
\dim(A_\mathfrak p) = \dim(B_\mathfrak q) = \dim(B) - \dim(B/\mathfrak q)
$$
(Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-equals-total}).
The second equality because $B$ is equidimensional and catenary.
Thus $\dim(B/\mathfrak q)$ is independent of the choice of $\mathfrak q$
and we conclude that $B/\mathfrak p B$ is equidimensional of
dimension $\dim(B) - \dim(A_\mathfrak p)$. On the other hand, we
have
$\dim(B/\mathfrak p B) = \dim(A/\mathfrak p) + \dim(B/\mathfrak m_A B)$
and
$\dim(B) = \dim(A) + \dim(B/\mathfrak m_A B)$
by flatness (see lemma cited above) and we get
$$
\dim(A_\mathfrak p) = \dim(A) - \dim(A/\mathfrak p)
$$
for all $\mathfrak p$ in $A$. Applying this to all minimal primes in
$A$ we see that $A$ is equidimensional.
If $\mathfrak p \subset \mathfrak p'$ is a strict inclusion
with no primes in between, then we may apply the above to
the prime $\mathfrak p'/\mathfrak p$ in $A/\mathfrak p$
because $A/\mathfrak p \to B/\mathfrak p B$ is flat and
$B/\mathfrak p B$ is equidimensional, to get
$$
1 = \dim((A/\mathfrak p)_{\mathfrak p'}) =
\dim(A/\mathfrak p) - \dim(A/\mathfrak p')
$$
Thus $\mathfrak p \mapsto \dim(A/\mathfrak p)$ is a dimension
function and we conclude that $A$ is catenary.
\end{proof}

\begin{lemma}
\label{lemma-formally-catenary}
Let $A$ be a formally catenary Noetherian local ring.
Then $A$ is universally catenary.
\end{lemma}

\begin{proof}
We may replace $A$ by $A/\mathfrak p$ where $\mathfrak p$ is a minimal prime
of $A$, see Algebra, Lemma \ref{algebra-lemma-catenary-check-irreducible}.
Thus we may assume that $A^\wedge$ is equidimensional.
It suffices to show that every local ring essentially of finite type
over $A$ is catenary (see for example
Algebra, Lemma \ref{algebra-lemma-catenary-check-local}).
Hence it suffices to show that $A[x_1, \ldots, x_n]_\mathfrak m$ is catenary
where $\mathfrak m \subset A[x_1, \ldots, x_n]$ is a maximal
ideal lying over $\mathfrak m_A$, see
Algebra, Lemma \ref{algebra-lemma-localization-at-closed-point-special-fibre}
(and Algebra, Lemmas \ref{algebra-lemma-quotient-catenary} and
\ref{algebra-lemma-localization-catenary}).
Let $\mathfrak m' \subset A^\wedge[x_1, \ldots, x_n]$ be the unique
maximal ideal lying over $\mathfrak m$. Then
$$
A[x_1, \ldots, x_n]_\mathfrak m \to A^\wedge[x_1, \ldots, x_n]_{\mathfrak m'}
$$
is local and flat (Algebra, Lemma \ref{algebra-lemma-completion-flat}).
Hence it suffices to show that the ring on the right
hand side is equidimensional and catenary, see
Lemma \ref{lemma-flat-under-catenary-equidimensional}.
It is catenary because complete local rings are universally catenary
(Algebra, Remark
\ref{algebra-remark-Noetherian-complete-local-ring-universally-catenary}).
Pick any minimal prime $\mathfrak q$ of
$A^\wedge[x_1, \ldots, x_n]_{\mathfrak m'}$. Then
$\mathfrak q = \mathfrak p A^\wedge[x_1, \ldots, x_n]_{\mathfrak m'}$
for some minimal prime $\mathfrak p$ of $A^\wedge$ (small detail omitted).
Hence
$$
\dim(A^\wedge[x_1, \ldots, x_n]_{\mathfrak m'}/\mathfrak q) =
\dim(A^\wedge/\mathfrak p) + n = \dim(A^\wedge) + n
$$
the first equality by
Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-equals-total}
and the second because $A^\wedge$ is equidimensional.
This finishes the proof.
\end{proof}

\begin{proposition}[Ratliff]
\label{proposition-ratliff}
\begin{reference}
\cite{Ratliff}
\end{reference}
A Noetherian local ring is universally catenary if and only if
it is formally catenary.
\end{proposition}

\begin{proof}
Combine Lemmas \ref{lemma-not-formally-catenary} and
\ref{lemma-formally-catenary}.
\end{proof}



\section{Finiteness of local cohomology, I}
\label{section-finiteness}

\noindent
We will follow Faltings approach to finiteness of local cohomology
modules, see \cite{Faltings-annulators} and \cite{Faltings-finiteness}.
Here is a lemma which shows that it suffices to prove
local cohomology modules have an annihilator in order to prove that
they are finite modules.

\begin{lemma}
\label{lemma-check-finiteness-local-cohomology-by-annihilator}
\begin{reference}
This is a special case of \cite[Lemma 3]{Faltings-annulators}.
\end{reference}
Let $A$ be a Noetherian ring, $I \subset A$ an ideal, $M$ a finite
$A$-module, and $n \geq 0$ an integer. Let $Z = V(I)$.
The following are equivalent
\begin{enumerate}
\item $H^i_Z(M)$ is finite for $i \leq n$,
\item there exists an $e \geq 0$ such that $I^e$ annihilates
$H^i_Z(M)$ for $i \leq n$, and
\item there exists an ideal $J \subset A$ with $V(J) \subset Z$
such that $J$ annihilates $H^i_Z(M)$ for $i \leq n$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove the lemma by induction on $n$. For $n = 0$ we have
$H^0_Z(M) \subset M$ is finite, hence (1), (2), and (3) are true.
Assume that $n > 0$.

\medskip\noindent
If (1) is true, then, since $H^i_Z(M) = H^i_I(M)$
(Lemma \ref{lemma-local-cohomology-noetherian})
is $I$-power torsion, we see that (2) holds.
It is clear that (2) implies (3).

\medskip\noindent
Assume (3) is true. Let $N = H^0_Z(M)$ and $M' = M/N$.
By Lemma \ref{lemma-divide-by-torsion} we may replace $M$ by $M'$.
Thus we may assume that $H^0_Z(M) = 0$.
This means that $\text{depth}_I(M) > 0$ (Lemma \ref{lemma-depth}).
Pick $f \in I$ a nonzerodivisor on $M$. After raising $f$ to a suitable
power, we may assume $f \in J$ as $V(J) \subset V(I)$. Then the
long exact local cohomology sequence associated to the short
exact sequence
$$
0 \to M \to M \to M/fM \to 0
$$
turns into short exact sequences
$$
0 \to H^i_Z(M) \to H^i_Z(M/fM) \to H^{i + 1}_Z(M) \to 0
$$
for $i < n$. We conclude that $J^2$ annihilates $H^i_Z(M/fM)$
for $i < n$. By induction hypothesis we see that $H^i_Z(M/fM)$
is finite for $i < n$. Using the short exact sequence once more
we see that $H^{i + 1}_Z(M)$ is finite for $i < n$ as desired.
\end{proof}

\noindent
The following result of Faltings allows us to prove finiteness
of local cohomology at the level of local rings.

\begin{lemma}
\label{lemma-check-finiteness-local-cohomology-locally}
\begin{reference}
This is a special case of \cite[Satz 1]{Faltings-finiteness}.
\end{reference}
Let $A$ be a Noetherian ring, $I \subset A$ an ideal, $M$ a finite
$A$-module, and $n \geq 0$ an integer. Let $Z = V(I)$.
The following are equivalent
\begin{enumerate}
\item the modules $H^i_Z(M)$ are finite for $i \leq n$, and
\item for all $\mathfrak p \in \Spec(A)$ the modules
$H^i_Z(M)_\mathfrak p$, $i \leq n$ are finite $A_\mathfrak p$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is immediate. We prove the converse
by induction on $n$. The case $n = 0$ is clear because both (1) and
(2) are always true in that case.

\medskip\noindent
Assume $n > 0$ and that (2) is true. Let $N = H^0_Z(M)$ and $M' = M/N$.
By Lemma \ref{lemma-divide-by-torsion} we may replace $M$ by $M'$.
Thus we may assume that $H^0_Z(M) = 0$.
This means that $\text{depth}_I(M) > 0$ (Lemma \ref{lemma-depth}).
Pick $f \in I$ a nonzerodivisor on $M$ and consider the short
exact sequence
$$
0 \to M \to M \to M/fM \to 0
$$
which produces a long exact sequence
$$
0 \to H^0_Z(M/fM) \to H^1_Z(M) \to H^1_Z(M) \to H^1_Z(M/fM) \to
H^2_Z(M) \to \ldots
$$
and similarly after localization. Thus assumption (2) implies that
the modules $H^i_Z(M/fM)_\mathfrak p$ are finite for $i < n$. Hence
by induction assumption $H^i_Z(M/fM)$ are finite for $i < n$.

\medskip\noindent
Let $\mathfrak p$ be a prime of $A$ which is associated to
$H^i_Z(M)$ for some $i \leq n$. Say $\mathfrak p$ is the annihilator
of the element $x \in H^i_Z(M)$. Then $\mathfrak p \in Z$, hence
$f \in \mathfrak p$. Thus $fx = 0$ and hence $x$ comes from an
element of $H^{i - 1}_Z(M/fM)$ by the boundary map $\delta$ in the long
exact sequence above. It follows that $\mathfrak p$ is an associated
prime of the finite module $\Im(\delta)$. We conclude that
$\text{Ass}(H^i_Z(M))$ is finite for $i \leq n$, see
Algebra, Lemma \ref{algebra-lemma-finite-ass}.

\medskip\noindent
Recall that
$$
H^i_Z(M) \subset
\prod\nolimits_{\mathfrak p \in \text{Ass}(H^i_Z(M))}
H^i_Z(M)_\mathfrak p
$$
by Algebra, Lemma \ref{algebra-lemma-zero-at-ass-zero}. Since by
assumption the modules on the right hand side are finite and $I$-power
torsion, we can find integers $e_{\mathfrak p, i} \geq 0$, $i \leq n$,
$\mathfrak p \in \text{Ass}(H^i_Z(M))$ such that
$I^{e_{\mathfrak p, i}}$ annihilates $H^i_Z(M)_\mathfrak p$. We conclude
that $I^e$ with $e = \max\{e_{\mathfrak p, i}\}$ annihilates $H^i_Z(M)$
for $i \leq n$. By
Lemma \ref{lemma-check-finiteness-local-cohomology-by-annihilator}
we see that $H^i_Z(M)$ is finite for $i \leq n$.
\end{proof}

\noindent
In the rest of this section we discuss the easiest nontrivial case of the
finiteness theorem, namely, the finiteness of the first local
cohomology or what is equivalent, finiteness of $j_*\mathcal{F}$
where $j : U \to X$ is an open immersion, $X$ is locally Noetherian, and
$\mathcal{F}$ is a coherent sheaf on $U$. The reader who is interested
in higher direct images or higher local cohomology groups should skip
ahead to Section \ref{section-finiteness-II} (which is developed
independently of the rest of this section).

\begin{lemma}
\label{lemma-check-finiteness-pushforward-on-associated-points}
Let $X$ be a locally Noetherian scheme. Let $j : U \to X$ be the inclusion
of an open subscheme with complement $Z$. For $x \in U$ let
$i_x : W_x \to U$ be the integral closed subscheme with generic point $x$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module.
The following are equivalent
\begin{enumerate}
\item for all $x \in \text{Ass}(\mathcal{F})$ the
$\mathcal{O}_X$-module $j_*i_{x, *}\mathcal{O}_{W_x}$ is coherent,
\item $j_*\mathcal{F}$ is coherent.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove that (1) implies (2). Assume (1) holds.
The statement is local on $X$, hence we may assume $X$ is affine.
Then $U$ is quasi-compact, hence $\text{Ass}(\mathcal{F})$ is finite
(Divisors, Lemma \ref{divisors-lemma-finite-ass}). Thus we may argue by
induction on the number of associated points. Let $x \in U$ be a generic
point of an irreducible component of the support of $\mathcal{F}$.
By Divisors, Lemma \ref{divisors-lemma-finite-ass} we have
$x \in \text{Ass}(\mathcal{F})$. By our choice of $x$ we have
$\dim(\mathcal{F}_x) = 0$ as $\mathcal{O}_{X, x}$-module.
Hence $\mathcal{F}_x$ has finite length as an $\mathcal{O}_{X, x}$-module
(Algebra, Lemma \ref{algebra-lemma-support-point}).
Thus we may use induction on this length.

\medskip\noindent
Set $\mathcal{G} = j_*i_{x, *}\mathcal{O}_{W_x}$. This is a coherent
$\mathcal{O}_X$-module by assumption. We have $\mathcal{G}_x = \kappa(x)$.
Choose a nonzero map
$\varphi_x : \mathcal{F}_x \to \kappa(x) = \mathcal{G}_x$.
By Cohomology of Schemes, Lemma \ref{coherent-lemma-map-stalks-local-map}
there is an open $x \in V \subset U$ and a map
$\varphi_V : \mathcal{F}|_V \to \mathcal{G}|_V$ whose stalk
at $x$ is $\varphi_x$. Choose $f \in \Gamma(X, \mathcal{O}_X)$
which does not vanish at $x$ such that $D(f) \subset V$. By
Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
(for example) we see that $\varphi_V$ extends to
$f^n\mathcal{F} \to \mathcal{G}|_U$ for some $n$.
Precomposing with multiplication by $f^n$ we obtain a map
$\mathcal{F} \to \mathcal{G}|_U$ whose stalk at $x$ is nonzero.
Let $\mathcal{F}' \subset \mathcal{F}$ be the kernel.
Note that $\text{Ass}(\mathcal{F}') \subset \text{Ass}(\mathcal{F})$, see
Divisors, Lemma \ref{divisors-lemma-ses-ass}.
Since
$\text{length}_{\mathcal{O}_{X, x}}(\mathcal{F}') = 
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{F}) - 1$
we may apply the
induction hypothesis to conclude $j_*\mathcal{F}'$ is coherent.
Since $\mathcal{G} = j_*(\mathcal{G}|_U) = j_*i_{x, *}\mathcal{O}_{W_x}$
is coherent, we can consider the exact sequence
$$
0 \to j_*\mathcal{F}' \to j_*\mathcal{F} \to \mathcal{G}
$$
By Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
the sheaf $j_*\mathcal{F}$ is quasi-coherent.
Hence the image of $j_*\mathcal{F}$ in $j_*(\mathcal{G}|_U)$
is coherent by Cohomology of Schemes, Lemma
\ref{coherent-lemma-coherent-Noetherian-quasi-coherent-sub-quotient}.
Finally, $j_*\mathcal{F}$ is coherent by
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.

\medskip\noindent
Assume (2) holds. Exactly in the same manner as above we reduce
to the case $X$ affine. We pick $x \in \text{Ass}(\mathcal{F})$
and we set $\mathcal{G} = j_*i_{x, *}\mathcal{O}_{W_x}$.
Then we choose a nonzero map
$\varphi_x : \mathcal{G}_x = \kappa(x) \to \mathcal{F}_x$
which exists exactly because $x$ is an associated point of $\mathcal{F}$.
Arguing exactly as above we may assume $\varphi_x$
extends to an $\mathcal{O}_U$-module map
$\varphi : \mathcal{G}|_U \to \mathcal{F}$.
Then $\varphi$ is injective (for example by
Divisors, Lemma \ref{divisors-lemma-check-injective-on-ass})
and we find and injective map
$\mathcal{G} = j_*(\mathcal{G}|_V \to j_*\mathcal{F}$.
Thus (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-finiteness-pushforwards-and-H1-local}
Let $X = \Spec(A)$ be a locally Noetherian scheme. Let $I \subset A$
be an ideal and set $Z = V(I)$ and $U = X \setminus Z$.
Let $j : U \to X$ be the inclusion morphism.
Let $M$ be a finite $A$-module and $\mathcal{F}$ the
restriction of $\widetilde{M}$ to $U$. Then the following are equivalent
\begin{enumerate}
\item $j_*\mathcal{F}$ is coherent,
\item $H^1_Z(M)$ is a finite $A$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that $j_*\mathcal{F}$ is quasi-coherent
(Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent})
and corresponds to the $A$-module $H^0(U, \mathcal{F})$.
By Lemma \ref{lemma-local-cohomology-is-local-cohomology}
we obtain an exact sequence
$$
0 \to H^0_Z(M) \to M \to H^0(U, \mathcal{F}) \to H^1_Z(M) \to 0
$$
The final zero because $H^1(X, \widetilde{M}) = 0$ as $X$ is affine
and $\widetilde{M}$ is quasi-coherent (Cohomology of Schemes,
Lemma \ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}).
Thus $j_*\mathcal{F}$ is coherent if and only if $H^1_Z(M)$ is
finite.
\end{proof}

\begin{lemma}
\label{lemma-finiteness-pushforward}
Let $X$ be a locally Noetherian scheme.
Let $j : U \to X$ be the inclusion of an
open subscheme with complement $Z$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_U$-module. Assume
\begin{enumerate}
\item $X$ is Nagata,
\item $X$ is universally catenary, and
\item for $x \in \text{Ass}(\mathcal{F})$ and
$z \in Z \cap \overline{\{x\}}$ we have
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) \geq 2$.
\end{enumerate}
Then $j_*\mathcal{F}$ is coherent.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-check-finiteness-pushforward-on-associated-points}
we may assume that $\mathcal{F} = i_{x, *}\mathcal{O}_{W_x}$.
Let $\pi : Y \to X$ be the normalization of $X$ in $\Spec(\kappa(x))$, see
Morphisms, Section \ref{morphisms-section-normalization}. By
Morphisms, Lemma \ref{morphisms-lemma-nagata-normalization-finite-general}
the morphism $\pi$ is finite. Since $\pi$ is finite
$\mathcal{G} = \pi_*\mathcal{O}_Y$ is a coherent $\mathcal{O}_X$-module by
Cohomology of Schemes, Lemma \ref{coherent-lemma-finite-pushforward-coherent}.
Observe that $W_x = U \cap \pi(Y)$. Thus
$\pi|_{\pi^{-1}(U)} : \pi^{-1}(U) \to U$ factors through $i_x : W_x \to U$
and we obtain a canonical map
$$
\mathcal{F} = i_{x, *}\mathcal{O}_{W_x}
\longrightarrow
(\pi|_{\pi^{-1}(U)})_*(\mathcal{O}_{\pi^{-1}(U)}) =
(\pi_*\mathcal{O}_Y)|_U = \mathcal{G}|_U
$$
This map is injective (for example by Divisors, Lemma
\ref{divisors-lemma-check-injective-on-ass}). Hence
$j_*\mathcal{F} \subset j_*\mathcal{G}|_U$ and it suffices to show that
$j_*\mathcal{G}|_U$ is coherent.

\medskip\noindent
It remains to prove that $j_*(\mathcal{G}|_U)$ is coherent. We claim
Divisors, Lemma \ref{divisors-lemma-check-isomorphism-via-depth-and-ass}
applies to
$$
\mathcal{G} \longrightarrow j_*(\mathcal{G}|_U)
$$
which finishes the proof.
Let $z \in X$. If $z \in U$, then the map is an isomorphism
on stalks as $j_*(\mathcal{G}|_U)|_U = \mathcal{G}|_U$.
If $z \in Z$, then $z \not \in \text{Ass}(j_*(\mathcal{G}|_U))$
(Divisors, Lemmas \ref{divisors-lemma-weakass-pushforward} and
\ref{divisors-lemma-weakly-ass-support}).
Thus it suffices to show that $\text{depth}(\mathcal{G}_z) \geq 2$.
Let $y_1, \ldots, y_n \in Y$ be the points mapping to $z$.
By Algebra, Lemma \ref{algebra-lemma-depth-goes-down-finite}
it suffices to show that
$\text{depth}(\mathcal{O}_{Y, y_i}) \geq 2$ for $i = 1, \ldots, n$.
If not, then by Properties, Lemma \ref{properties-lemma-criterion-normal}
we see that $\dim(\mathcal{O}_{Y, y_i}) = 1$ for some $i$.
This is impossible by the dimension formula
(Morphisms, Lemma \ref{morphisms-lemma-dimension-formula})
for $\pi : Y \to \overline{\{x\}}$ and assumption (3).
\end{proof}

\begin{lemma}[Koll\'ar]
\label{lemma-sharp-finiteness-pushforward}
\begin{reference}
One direction of a Theorem of Koll\'ar in an email
dated Wed, 1 Jul 2015.
\end{reference}
Let $X$ be an integral locally Noetherian scheme. Let $j : U \to X$
be the inclusion of an open subscheme with complement $Z$. Assume
that for all $z \in Z$ and any nonmaximal associated prime $\mathfrak p$ of
the completion $\mathcal{O}_{X, z}^\wedge$
satisfies $\dim(\mathcal{O}_{X, z}^\wedge/\mathfrak p) \geq 2$.
Then $j_*\mathcal{O}_U$ is coherent.
\end{lemma}

\begin{proof}
We may assume $X$ is affine.
Using Lemmas \ref{lemma-check-finiteness-local-cohomology-locally} and
\ref{lemma-finiteness-pushforwards-and-H1-local} we reduce to
$X = \Spec(A)$ where $(A, \mathfrak m)$ is a Noetherian local domain
and $\mathfrak m \in Z$.
Then we can use induction on $d = \dim(A)$.
(The base case is $d = 0, 1$ which do not happen by
our assumption on the local rings.)
Set $V = \Spec(A) \setminus \{\mathfrak m\}$.
Observe that the local rings of $V$ have dimension strictly smaller than $d$.
Repeating the arguments for $j' : U \to V$ we
and using induction we conclude that $j'_*\mathcal{O}_U$ is
a coherent $\mathcal{O}_V$-module.
Pick a nonzero $f \in A$ which vanishes on $Z$.
Since $D(f) \cap V \subset U$ we find an $n$ such that
multiplication by $f^n$ on $U$ extends to a map
$f^n : j'_*\mathcal{O}_U \to \mathcal{O}_V$ over $V$
(for example by Cohomology of Schemes, Lemma
\ref{coherent-lemma-homs-over-open}). This map is injective
hence there is an injective map
$$
j_*\mathcal{O}_U = j''_* j'_* \mathcal{O}_U \to j''_*\mathcal{O}_V
$$
on $X$ where $j'' : V \to X$ is the incusion morphism.
Hence it suffices to show that $j''_*\mathcal{O}_V$ is coherent.
In other words, we may assume that $X$ is the spectrum
of a local Noetherian domain and that $Z$
consists of the closed point.

\medskip\noindent
Assume $X = \Spec(A)$ with $(A, \mathfrak m)$ local and $Z = \{\mathfrak m\}$.
Let $A^\wedge$ be the completion of $A$.
Set $X^\wedge = \Spec(A^\wedge)$, $Z^\wedge = \{\mathfrak m^\wedge\}$,
$U^\wedge = X^\wedge \setminus Z^\wedge$, and
$\mathcal{F}^\wedge = \mathcal{O}_{U^\wedge}$.
The ring $A^\wedge$ is universally catenary and Nagata (Algebra, Remark
\ref{algebra-remark-Noetherian-complete-local-ring-universally-catenary} and
Lemma \ref{algebra-lemma-Noetherian-complete-local-Nagata}).
Moreover, condition (3) of Lemma \ref{lemma-finiteness-pushforward}
for $X^\wedge, Z^\wedge, U^\wedge, \mathcal{F}^\wedge$
holds by assumption! Thus we see that
$(U^\wedge \to X^\wedge)_*\mathcal{O}_{U^\wedge}$
is coherent. Since the morphism $c : X^\wedge \to X$
is flat we conclude that the pullback of $j_*\mathcal{O}_U$ is
$(U^\wedge \to X^\wedge)_*\mathcal{O}_{U^\wedge}$
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-flat-base-change-cohomology}).
Finally, since $c$ is faithfully flat we conclude that
$j_*\mathcal{O}_U$ is coherent by
Descent, Lemma \ref{descent-lemma-finite-type-descends}.
\end{proof}

\begin{lemma}
\label{lemma-finiteness-pushforward-general}
Let $X$ be a locally Noetherian scheme.
Let $j : U \to X$ be the inclusion of an
open subscheme with complement $Z$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_U$-module. Assume
\begin{enumerate}
\item $X$ is universally catenary,
\item for every $z \in Z$ the formal fibres of $\mathcal{O}_{X, z}$
are $(S_1)$, and
\item for $x \in \text{Ass}(\mathcal{F})$ and
$z \in Z \cap \overline{\{x\}}$ we have
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) \geq 2$.
\end{enumerate}
Then $j_*\mathcal{F}$ is coherent.
\end{lemma}

\begin{proof}
The statement is local on $X$, hence we may assume $X$ is affine.
Say $X = \Spec(A)$ and $Z = V(I)$. By
Properties, Lemma \ref{properties-lemma-extend-finite-presentation}
there exists a coherent $\mathcal{O}_X$-module $\mathcal{F}'$
whose restriction to $U$ is isomorphic to $\mathcal{F}$.
Say $\mathcal{F}'$ corresponds to the finite $A$-module $M$.
By Lemma \ref{lemma-finiteness-pushforwards-and-H1-local}
we have to show that $H^1_Z(M)$ is finite.

\medskip\noindent
By Lemma \ref{lemma-check-finiteness-local-cohomology-locally}
we may assume that $A$ is a local Noetherian ring.
Let $\mathfrak m$ be the maximal ideal.
We may assume $I \subset \mathfrak m$, otherwise the
lemma is trivial. Let $A^\wedge$ be the
completion of $A$, let $Z^\wedge = V(IA^\wedge)$, and let
$M^\wedge = M \otimes_A A^\wedge$ be the completion of $M$
(Algebra, Lemma \ref{algebra-lemma-completion-tensor}).
Then $H^1_Z(M) \otimes_A A^\wedge = H^1_{Z^\wedge}(M^\wedge)$ by
Lemma \ref{lemma-torsion-change-rings} and flatness of $A \to A^\wedge$
(Algebra, Lemma \ref{algebra-lemma-completion-flat}).
Hence it suffices to show that $H^1_{Z^\wedge}(M^\wedge)$ is
finite, see Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.

\medskip\noindent
The ring $A^\wedge$ is universally catenary and Nagata
(Algebra, Remark
\ref{algebra-remark-Noetherian-complete-local-ring-universally-catenary} and
Lemma \ref{algebra-lemma-Noetherian-complete-local-Nagata}).
The finiteness of $H^1_{Z^\wedge}(M^\wedge)$ will follow from
Lemmas \ref{lemma-finiteness-pushforwards-and-H1-local} and
\ref{lemma-finiteness-pushforward} if we can check
condition (3) of Lemma \ref{lemma-finiteness-pushforward}
for the situation over $A^\wedge$. Let
$\mathfrak p^\wedge \subset \mathfrak q^\wedge \subset A^\wedge$
be primes with $\mathfrak p^\wedge \in \text{Ass}(M^\wedge)$ and
$\mathfrak q^\wedge \in Z^\wedge$. We have to show that
$\dim((A^\wedge/\mathfrak p^\wedge)_{\mathfrak q^\wedge}) \geq 2$.
Observe that
$$
\text{Ass}_{A^\wedge}(M^\wedge) =
\bigcup\nolimits_{\mathfrak p \in \text{Ass}_A(M)}
\text{Ass}_{A^\wedge}(A^\wedge \otimes_A \kappa(\mathfrak p))
$$
by Algebra, Lemma \ref{algebra-lemma-bourbaki-fibres}.
By assumption (2) we see that $\mathfrak p^\wedge$
is minimal over $\mathfrak p A^\wedge$ with
$\mathfrak p = A \cap \mathfrak p^\wedge \in \text{Ass}(M)$.
On the other hand, $\mathfrak q = A \cap \mathfrak q^\wedge$ is a
point of $Z$. By assumption (1) $A/\mathfrak p$ is universally
catenary, hence $A^\wedge/\mathfrak p A^\wedge$
is equidimensional, see
Proposition \ref{proposition-ratliff}.
Since $A^\wedge/\mathfrak p A^\wedge$ is catenary, we conclude
that $(A^\wedge/\mathfrak p A^\wedge)_{\mathfrak q^\wedge}$
is equidimensional too. Hence
$$
\dim((A^\wedge/\mathfrak p^\wedge)_{\mathfrak q^\wedge}) =
\dim((A^\wedge/\mathfrak p A^\wedge)_{\mathfrak q^\wedge}) \geq
\dim((A/\mathfrak p)_\mathfrak q)) \geq 2
$$
The first inequality by
Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-equals-total}
and the last by assumption (3).
\end{proof}

\begin{remark}
\label{remark-no-finiteness-pushforward}
Let $X$ be a locally Noetherian scheme. Let $j : U \to X$ be the inclusion of
an open subscheme with complement $Z$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_U$-module. If there exists an $x \in \text{Ass}(\mathcal{F})$ and
$z \in Z \cap \overline{\{x\}}$ such that
$\dim(\mathcal{O}_{\overline{\{x\}}, z}) \leq 1$, then $j_*\mathcal{F}$ is not
coherent. To prove this we can do a flat base change to the spectrum
of $\mathcal{O}_{X, z}$. Let $X' = \overline{\{x\}}$.
The assumption implies $\mathcal{O}_{X' \cap U} \subset \mathcal{F}$.
Thus it suffices to see that $j_*\mathcal{O}_{X' \cap U}$ is not
coherent. This is clear because $X' = \{x, z\}$, hence
$j_*\mathcal{O}_{X' \cap U}$ corresponds to $\kappa(x)$ as an
$\mathcal{O}_{X, z}$-module which cannot be finite as $x$ is not
a closed point.
\end{remark}





\section{Purity of branch locus}
\label{section-purity}

\noindent
Let $\pi : X \to Y$ be a morphism of schemes which is finite locally
free. Then there exists a canonical {\it trace for $\pi$}
which is an $\mathcal{O}_Y$-linear map
$$
\text{Trace}_\pi : \pi_*\mathcal{O}_X \longrightarrow \mathcal{O}_Y
$$
such that the composition
$\mathcal{O}_Y \xrightarrow{\pi^\sharp} \pi_*\mathcal{O}_X
\xrightarrow{\text{Trace}_\pi} \mathcal{O}_Y$ equals
multiplication by the degree of $\pi$ (which is a locally constant
function on $Y$). In analogy with
Fields, Section \ref{fields-section-trace-pairing}
we can define the trace pairing
$$
Q_\pi :
\pi_*\mathcal{O}_X \times \pi_*\mathcal{O}_X
\longrightarrow
\mathcal{O}_Y
$$
by the rule $(f, g) \mapsto \text{Trace}_\pi(fg)$. We can think of
$Q_\pi$ as a linear map
$\pi_*\mathcal{O}_X \to
\SheafHom_{\mathcal{O}_Y}(\pi_*\mathcal{O}_X, \mathcal{O}_Y)$
between locally free modules of the same rank, and hence obtain
a determinant
$$
\text{Det}(Q_\pi) :
\wedge^{top}(\pi_*\mathcal{O}_X)
\longrightarrow
\wedge^{top}(\pi_*\mathcal{O}_X)^{\otimes -1}
$$
or in other words a global section
$$
\text{Det}(Q_\pi) \in \Gamma(Y, \wedge^{top}(\pi_*\mathcal{O}_X)^{\otimes -2})
$$
The {\it discriminant of $\pi$} is by definition the closed
subscheme $D_\pi \subset Y$ cut out by this global section.
Clearly, $D_\pi$ is a locally principal closed subscheme of $Y$.

\begin{lemma}
\label{lemma-discriminant}
Let $\pi : X \to Y$ be a morphism of schemes which is finite locally
free. Then $\pi$ is \'etale if and only if its discriminant is empty.
\end{lemma}

\begin{proof}
By Morphisms, Lemma \ref{morphisms-lemma-etale-flat-etale-fibres}
it suffices to check that the fibres of $\pi$ are \'etale.
Since the construction of the trace pairing commutes with base
change we reduce to the following question: Let $k$ be a field
and let $A$ be a finite dimensional $k$-algebra. Show that
$A$ is \'etale over $k$ if and only if the trace pairing
$Q_{A/k} : A \times A \to k$, $(a, b) \mapsto \text{Trace}_{A/k}(ab)$
is nondegenerate.

\medskip\noindent
Assume $Q_{A/k}$ is nondegenerate. If $a \in A$ is a nilpotent element, then
$ab$ is nilpotent for all $b \in A$ and we conclude that $Q_{A/k}(a, -)$ is
identically zero. Hence $A$ is reduced. Then we can write
$A = K_1 \times \ldots \times K_n$ as a product where each $K_i$
is a field (see
Algebra, Lemmas \ref{algebra-lemma-finite-dimensional-algebra},
\ref{algebra-lemma-artinian-finite-length}, and
\ref{algebra-lemma-minimal-prime-reduced-ring}).
In this case the quadratic
space $(A, Q_{A/k})$ is the orthogonal direct sum of the spaces
$(K_i, Q_{K_i/k})$. It follows from
Fields, Lemma \ref{fields-lemma-separable-trace-pairing}
that each $K_i$ is separable over $k$. This means that $A$ is \'etale
over $k$ by Algebra, Lemma \ref{algebra-lemma-etale-over-field}.
The converse is proved by reading the argument backwards.
\end{proof}

\begin{lemma}
\label{lemma-find-point-codim-1}
Let $(A, \mathfrak m)$ be a Noetherian local ring with $\dim(A) \geq 1$.
Let $f \in \mathfrak m$. Then there exist a $\mathfrak p \in V(f)$ with
$\dim(A_\mathfrak p) = 1$.
\end{lemma}

\begin{proof}
By induction on $\dim(A)$. If $\dim(A) = 1$, then $\mathfrak p = \mathfrak m$
works. If $\dim(A) > 1$, then let $Z \subset \Spec(A)$ be an irreducible
component of dimension $> 1$. Then $V(f) \cap Z$ has dimension $> 0$
(Algebra, Lemma \ref{algebra-lemma-one-equation}). Pick a prime
$\mathfrak q \in V(f) \cap Z$, $\mathfrak q \not = \mathfrak m$
corresponding to a closed point of the punctured spectrum of $A$;
this is possible by
Properties, Lemma \ref{properties-lemma-complement-closed-point-Jacobson}.
Then $\mathfrak q$ is not the generic point of $Z$. Hence
$0 < \dim(A_\mathfrak q) < \dim(A)$ and $f \in \mathfrak q A_\mathfrak q$.
By induction on the dimension we can find
$f \in \mathfrak p \subset A_\mathfrak q$ with
$\dim((A_\mathfrak q)_\mathfrak p) = 1$.
Then $\mathfrak p \cap A$ works.
\end{proof}

\begin{lemma}
\label{lemma-ramification-quasi-finite-flat}
Let $f : X \to Y$ be a morphism of locally Noetherian schemes.
Let $x \in X$. Assume
\begin{enumerate}
\item $f$ is flat,
\item $f$ is quasi-finite at $x$,
\item $x$ is not a generic point of an irreducible component of $X$,
\item for specializations $x' \leadsto x$ with
$\dim(\mathcal{O}_{X, x'}) = 1$ our $f$ is unramified at $x'$.
\end{enumerate}
Then $f$ is \'etale at $x$.
\end{lemma}

\begin{proof}
Observe that the set of points where $f$ is unramified is the same as
the set of points where $f$ is \'etale and that this set is open.
See Morphisms, Definitions \ref{morphisms-definition-unramified}
and \ref{morphisms-definition-etale} and
Lemma \ref{morphisms-lemma-flat-unramified-etale}.
To check $f$ is \'etale at $x$ we may work locally on the base and on the
target (Descent, Lemmas \ref{descent-lemma-descending-property-etale} and
\ref{descent-lemma-etale-etale-local-source}).
Thus we can apply More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-makes-quasi-finite-finite-at-point}
and assume that $f : X \to Y$ is finite and that $x$ is the unique
point of $X$ lying over $y = f(x)$.
Then it follows that $f$ is finite locally free
(Morphisms, Lemma \ref{morphisms-lemma-finite-flat}).

\medskip\noindent
Assume $f$ is finite locally free and that $x$ is the unique point of
$X$ lying over $y = f(x)$. By Lemma \ref{lemma-discriminant}
we find a locally principal closed subscheme $D_\pi \subset Y$
such that $y' \in D_\pi$ if and only if there exists an $x' \in X$
with $f(x') = y'$ and $f$ ramified at $x'$. Thus we have to prove
that $y \not \in D_\pi$. Assume $y \in D_\pi$ to get a contradiction.

\medskip\noindent
By condition (3) we have $\dim(\mathcal{O}_{X, x}) \geq 1$.
We have $\dim(\mathcal{O}_{X, x}) = \dim(\mathcal{O}_{Y, y})$ by
Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-equals-total}.
By Lemma \ref{lemma-find-point-codim-1}
we can find $y' \in D_\pi$ specializing to $y$
with $\dim(\mathcal{O}_{Y, y'}) = 1$.
Choose $x' \in X$ with $f(x') = y'$ where $f$ is ramified. Since $f$
is finite it is closed, and hence $x' \leadsto x$.
We have $\dim(\mathcal{O}_{X, x'}) = \dim(\mathcal{O}_{Y, y'}) = 1$
as before. This contradicts property (4).
\end{proof}








\section{Torsion versus complete modules}
\label{section-torsion-and-complete}

\noindent
Let $A$ be a ring and let $I$ be a finitely generated ideal.
In this case we can consider the derived category
$D_{I^\infty\text{-torsion}}(A)$ of complexes
with $I$-power torsion cohomology modules
(Section \ref{section-local-cohomology})
and the derived category
$D_{comp}(A, I)$ of derived complete complexes
(More on Algebra, Section \ref{more-algebra-section-derived-completion}).
In this section we show these categories are equivalent.
A more general statement can be found in
\cite{Dwyer-Greenlees}.

\begin{lemma}
\label{lemma-complete-and-local}
Let $A$ be a ring and let $I$ be a finitely generated ideal.
Let $R\Gamma_Z$ be as in Lemma \ref{lemma-local-cohomology-adjoint}.
Let ${\ }^\wedge$ denote derived completion as in
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion}.
For an object $K$ in $D(A)$ we have
$$
R\Gamma_Z(K^\wedge) = R\Gamma_Z(K)
\quad\text{and}\quad
(R\Gamma_Z(K))^\wedge = K^\wedge
$$
in $D(A)$.
\end{lemma}

\begin{proof}
Choose $f_1, \ldots, f_r \in A$ generating $I$. Recall that
$$
K^\wedge = R\Hom_A\left((A \to \prod A_{f_{i_0}}
\to \prod A_{f_{i_0i_1}} \to \ldots \to A_{f_1 \ldots f_r}), K\right)
$$
by More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion}.
Hence the cone $C = \text{Cone}(K \to K^\wedge)$
is given by
$$
R\Hom_A\left((\prod A_{f_{i_0}}
\to \prod A_{f_{i_0i_1}} \to \ldots \to A_{f_1 \ldots f_r}), K\right)
$$
which can be represented by a complex endowed with a finite filtration
whose successive quotients are isomorphic to
$$
R\Hom_A(A_{f_{i_0} \ldots f_{i_p}}, K), \quad p > 0
$$
These complexes vanish on applying $R\Gamma_Z$, see
Lemma \ref{lemma-local-cohomology-vanishes}. Applying $R\Gamma_Z$
to the distinguished triangle $K \to K^\wedge \to C \to K[1]$
we see that the first formula of the lemma is correct.

\medskip\noindent
Recall that
$$
R\Gamma_Z(K) =
K \otimes^\mathbf{L} (A \to \prod A_{f_{i_0}}
\to \prod A_{f_{i_0i_1}} \to \ldots \to A_{f_1 \ldots f_r})
$$
by Lemma \ref{lemma-local-cohomology-adjoint}.
Hence the cone $C = \text{Cone}(R\Gamma_Z(K) \to K)$
can be represented by a complex endowed with a finite filtration
whose successive quotients are isomorphic to
$$
K \otimes_A A_{f_{i_0} \ldots f_{i_p}}, \quad p > 0
$$
These complexes vanish on applying ${\ }^\wedge$, see
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion-vanishes}.
Applying derived completion to the distinguished triangle
$R\Gamma_Z(K) \to K \to C \to R\Gamma_Z(K)[1]$
we see that the second formula of the lemma is correct.
\end{proof}

\noindent
The following result is a special case of a very general phenomenon
concerning admissible subcategories of a triangulated category.

\begin{proposition}
\label{proposition-torsion-complete}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
The functors $R\Gamma_Z$ and ${\ }^\wedge$
define quasi-inverse equivalences of categories
$$
D_{I^\infty\text{-torsion}}(A) \leftrightarrow D_{comp}(A, I)
$$
\end{proposition}

\begin{proof}
Follows immediately from Lemma \ref{lemma-complete-and-local}.
\end{proof}

\noindent
The following addendum of the proposition above makes the
correspondence on morphisms more precise.

\begin{lemma}
\label{lemma-compare-RHom}
With notation as in Lemma \ref{lemma-complete-and-local}.
For objects $K, L$ in $D(A)$ there is a canonical isomorphism
$$
R\Hom_A(K^\wedge, L^\wedge) \longrightarrow R\Hom_A(R\Gamma_Z(K), R\Gamma_Z(L))
$$
in $D(A)$.
\end{lemma}

\begin{proof}
Say $I = (f_1, \ldots, f_r)$. Denote
$C = (A \to \prod A_{f_i} \to \ldots \to A_{f_1 \ldots f_r})$ the
alternating {\v C}ech complex. Then derived completion is given
by $R\Hom_A(C, -)$ and local cohomology by $C \otimes^\mathbf{L} -$.
Combinging the isomorphism
$$
R\Hom_A(K \otimes^\mathbf{L} C, L \otimes^\mathbf{L} C) =
R\Hom_A(K, R\Hom(C,  L \otimes^\mathbf{L} C))
$$
(More on Algebra, Lemma \ref{more-algebra-lemma-internal-hom})
and the map
$$
L \to R\Hom_A(C,  L \otimes^\mathbf{L} C)
$$
(More on Algebra, Lemma \ref{more-algebra-lemma-internal-hom-diagonal})
we obtain a map
$$
\gamma :
R\Hom_A(K, L)
\longrightarrow
R\Hom_A(K \otimes^\mathbf{L} C, L \otimes^\mathbf{L} C)
$$
On the other hand, the right hand side is derived complete as it is
equal to
$$
R\Hom_A(C, R\Hom_A(K, L \otimes^\mathbf{L} C)).
$$
Thus $\gamma$ factors through the derived completion of
$R\Hom_A(K, L)$ by the universal property of derived completion.
However, the derived completion goes inside the $R\Hom_A$ by
More on Algebra, Lemma \ref{more-algebra-lemma-completion-RHom}
and we obtain the desired map.

\medskip\noindent
To show that the map of the lemma is an isomorphism
we may assume that $K$ and $L$ are derived complete, i.e.,
$K = K^\wedge$ and $L = L^\wedge$. In this case we are
looking at the map
$$
\gamma : R\Hom_A(K, L) \longrightarrow R\Hom_A(R\Gamma_Z(K), R\Gamma_Z(L))
$$
By Proposition \ref{proposition-torsion-complete} we know that
the cohomology groups
of the left and the right hand side coincide. In other words,
we have to check that the map $\gamma$ sends a morphism
$\alpha : K \to L$ in $D(A)$ to the morphism
$R\Gamma_Z(\alpha) : R\Gamma_Z(K) \to R\Gamma_Z(L)$.
We omit the verification (hint: note that $R\Gamma_Z(\alpha)$
is just the map
$\alpha \otimes \text{id}_C :
K \otimes^\mathbf{L} C
\to
L \otimes^\mathbf{L} C$ which is almost the same as the
construction of the map in
More on Algebra, Lemma \ref{more-algebra-lemma-internal-hom-diagonal}).
\end{proof}







\section{Trivial duality for a ring map}
\label{section-trivial}

\noindent
Let $A \to B$ be a ring homomorphism. Consider the functor
$$
\Hom_A(B, -) : \text{Mod}_A \longrightarrow \text{Mod}_B,\quad
M \longmapsto \Hom_A(B, M)
$$
This functor is left exact and has a derived extension
$R\Hom(B, -) : D(A) \to D(B)$. If $i_* : D(B) \to D(A)$ is the obvious
functor, then $i_*R\Hom(B, K) = R\Hom_A(B, K)$ for every $K \in D(A)$.
Since $R\Hom_A(A, K) = K$, the map $A \to B$ induces a canonical map
$i_*R\Hom(B, K) \to K$ in $D(A)$ functorial in $K$.

\begin{lemma}
\label{lemma-right-adjoint}
With notation as above. The functor $R\Hom(B, -)$ is the
right adjoint to the functor $i_* : D(B) \to D(A)$.
\end{lemma}

\begin{proof}
This is a consequence of the fact that $i_*$ and $\Hom_A(B, -)$ are
adjoint functors by Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}.
See Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.
\end{proof}

\begin{lemma}
\label{lemma-RHom-ext}
With notation as above. For $K$ in $D(A)$ we have
$R^q\Hom(B, K) = \text{Ext}_A^q(B, K)$
as $A$-modules (the left hand side starts out as a $B$-module).
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Let $A$ be a Noetherian ring. We will denote
$$
D_{\textit{Coh}}(A) \subset D(A)
$$
the full subcategory consisting of those objects $K$ of $D(A)$
whose cohomology modules are all finite $A$-modules. This makes sense
by Derived Categories, Section \ref{derived-section-triangulated-sub}
because as $A$ is Noetherian, the subcategory of finite $A$-modules
is a Serre subcategory of $\text{Mod}_A$.

\begin{lemma}
\label{lemma-exact-support-coherent}
With notation as above, assume $A \to B$ is a finite ring map of
Noetherian rings. Then $R\Hom(B, -)$ maps
$D^+_{\textit{Coh}}(A)$ into $D^+_{\textit{Coh}}(B)$.
\end{lemma}

\begin{proof}
We have to show: if $K \in D^+(A)$ has finite cohomology modules, then the
complex $R\Hom(B, K)$ has finite cohomology modules too.
This follows for example from Lemma \ref{lemma-RHom-ext}
if we can show the ext modules $\text{Ext}^i_A(B, K)$
are finite $A$-modules. Since $K$ is bounded below there is a
convergent spectral sequence
$$
\text{Ext}^p_A(B, H^q(K)) \Rightarrow \text{Ext}^{p + q}_A(B, K)
$$
This finishes the proof as the modules $\text{Ext}^p_A(B, H^q(K))$
are finite by
Algebra, Lemma \ref{algebra-lemma-ext-noetherian}.
\end{proof}

\begin{remark}
\label{remark-exact-support}
Let $A$ be a ring and let $I \subset A$ be an ideal. Set $B = A/I$.
In this case the functor $\Hom_A(B, -)$ is equal to the functor
$$
\text{Mod}_A \longrightarrow \text{Mod}_B,\quad M \longmapsto M[I]
$$
which sends $M$ to the submodule of $I$-torsion.
\end{remark}





\section{Sections with support in a closed subscheme}
\label{section-sections-with-exact-support}

\noindent
Let $i : (Z, \mathcal{O}_Z) \to (X, \mathcal{O}_X)$ be a morphism
of ringed spaces such that $i$ is a homomorphism onto a closed
subset and such that $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$
is surjective. (For example a closed immersion of schemes.)
Let $\mathcal{I} = \Ker(i^\sharp)$. For a sheaf
of $\mathcal{O}_X$-modules $\mathcal{F}$ the sheaf
$$
\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_Z, \mathcal{F})
$$
a sheaf of $\mathcal{O}_X$-modules annihilated by $\mathcal{I}$.
Hence by Modules, Lemma \ref{modules-lemma-i-star-equivalence}
there is a sheaf of $\mathcal{O}_Z$-modules,
which we will denote $\SheafHom(\mathcal{O}_Z, \mathcal{F})$,
such that
$$
i_*\SheafHom(\mathcal{O}_Z, \mathcal{F}) =
\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_Z, \mathcal{F})
$$
as $\mathcal{O}_X$-modules. We spell out what this means.

\begin{lemma}
\label{lemma-compute-sheaf-with-exact-support}
With notation as above. The functor $\SheafHom(\mathcal{O}_Z, -)$ is a
right adjoint to the functor
$i_* : \textit{Mod}(\mathcal{O}_Z) \to \textit{Mod}(\mathcal{O}_X)$.
For $V \subset Z$ open we have
$$
\Gamma(V, \SheafHom(\mathcal{O}_Z, \mathcal{F})) =
\{s \in \Gamma(U, \mathcal{F}) \mid \mathcal{I}s = 0\}
$$
where $U \subset X$ is an open whose intersection with $Z$ is $V$.
\end{lemma}

\begin{proof}
Let $\mathcal{G}$ be a sheaf of $\mathcal{O}_Z$-modules. Then
$$
\Hom_{\mathcal{O}_X}(i_*\mathcal{G}, \mathcal{F}) =
\Hom_{i_*\mathcal{O}_Z}(i_*\mathcal{G},
\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_Z, \mathcal{F})) =
\Hom_{\mathcal{O}_Z}(\mathcal{G}, \SheafHom(\mathcal{O}_Z, \mathcal{F}))
$$
The first equality by
Modules, Lemma \ref{modules-lemma-adjoint-tensor-restrict}
and the second by the fully faithfulness of $i_*$, see
Modules, Lemma \ref{modules-lemma-i-star-equivalence}.
The description of sections is left to the reader.
\end{proof}

\noindent
The functor
$$
\textit{Mod}(\mathcal{O}_X)
\longrightarrow
\textit{Mod}(\mathcal{O}_Z),
\quad
\mathcal{F} \longmapsto \SheafHom(\mathcal{O}_Z, \mathcal{F})
$$
is left exact and has a derived extension
$$
R\SheafHom(\mathcal{O}_Z, -) : D(\mathcal{O}_X) \to D(\mathcal{O}_Z).
$$

\begin{lemma}
\label{lemma-sheaf-with-exact-support-adjoint}
With notation as above. The functor $R\SheafHom(\mathcal{O}_Z, -)$
is the right adjoint of the functor
$i_* : D(\mathcal{O}_Z) \to D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
This is a consequence of the fact that $i_*$ and
$\SheafHom(\mathcal{O}_Z, -)$ are adjoint functors by
Lemma \ref{lemma-compute-sheaf-with-exact-support}. See
Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-with-exact-support-ext}
With notation as above. We have
$$
i_*R\SheafHom(\mathcal{O}_Z, K) = R\SheafHom(i_*\mathcal{O}_Z, K)
$$
in $D(\mathcal{O}_X)$ for all $K$ in $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
This is immediate from the construction of the functor
$R\SheafHom(\mathcal{O}_Z, -)$.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-with-exact-support-quasi-coherent}
In the situation above, assume $i : Z \to X$ is a pseudo-coherent
morphism of schemes (for example if $X$ is locally Noetherian).
Then
\begin{enumerate}
\item $R\SheafHom(\mathcal{O}_Z, -)$ maps $D^+_\QCoh(\mathcal{O}_X)$
into $D^+_\QCoh(\mathcal{O}_Z)$, and
\item if $X = \Spec(A)$ and $Z = \Spec(B)$, then the diagram
$$
\xymatrix{
D^+(B) \ar[r] & D_\QCoh^+(\mathcal{O}_Z) \\
D^+(A) \ar[r] \ar[u]^{R\Hom(B, -)} &
D_\QCoh^+(\mathcal{O}_X) \ar[u]_{R\SheafHom(\mathcal{O}_Z, -)}
}
$$
is commutative.
\end{enumerate}
\end{lemma}

\begin{proof}
To explain the parenthetical remark, if $X$ is locally Noetherian, then
$i$ is pseudo-coherent by
More on Morphisms, Lemma \ref{more-morphisms-lemma-Noetherian-pseudo-coherent}.

\medskip\noindent
Let $K$ be an object of $D^+_\QCoh(\mathcal{O}_X)$. To prove (1), by
Morphisms, Lemma \ref{morphisms-lemma-i-star-equivalence}
it suffices to show that $i_*$ applied to
$H^n(R\SheafHom(\mathcal{O}_Z, K))$ produces a
quasi-coherent module on $X$. By
Lemma \ref{lemma-sheaf-with-exact-support-ext}
this means we have to show that $R\SheafHom(i_*\mathcal{O}_Z, K)$
is in $D_\QCoh(\mathcal{O}_X)$. Since $i$ is pseudo-coherent
the sheaf $\mathcal{O}_Z$ is a pseudo-coherent $\mathcal{O}_X$-module.
Hence the result follows from
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-internal-hom}.

\medskip\noindent
Assume $X = \Spec(A)$ and $Z = \Spec(B)$ as in (2).
Let $I^\bullet$ be a bounded below complex of injective $A$-modules
representing an object $K$ of $D^+(A)$.
Then we know that $R\Hom(B, K) = \Hom_A(B, I^\bullet)$ viewed
as a complex of $B$-modules. Choose a quasi-isomorphism
$$
\widetilde{I^\bullet} \longrightarrow \mathcal{I}^\bullet
$$
where $\mathcal{I}^\bullet$ is a bounded below complex of injective
$\mathcal{O}_X$-modules. It follows from the description of
the functor $\SheafHom(\mathcal{O}_Z, -)$ in
Lemma \ref{lemma-compute-sheaf-with-exact-support}
that there is a map
$$
\Hom_A(B, I^\bullet)
\longrightarrow
\Gamma(Z, \SheafHom(\mathcal{O}_Z, \mathcal{I}^\bullet))
$$
Observe that $\SheafHom(\mathcal{O}_Z, \mathcal{I}^\bullet)$
represents $R\SheafHom(\mathcal{O}_Z, \widetilde{K})$.
Applying the universal property of the $\widetilde{\ }$ functor we
obtain a map
$$
\widetilde{\Hom_A(B, I^\bullet)}
\longrightarrow
R\SheafHom(\mathcal{O}_Z, \widetilde{K})
$$
in $D(\mathcal{O}_Z)$. We may check that this map is an isomorphism in
$D(\mathcal{O}_Z)$ after applying $i_*$. However, once we apply
$i_*$ we obtain the isomorphism of Derived Categories of Schemes,
Lemma \ref{perfect-lemma-quasi-coherence-internal-hom}
via the identification of
Lemma \ref{lemma-sheaf-with-exact-support-ext}.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-with-exact-support-coherent}
In this situation above. Assume $X$ is a locally Noetherian scheme.
Then $R\SheafHom(\mathcal{O}_Z, -)$ maps $D^+_{\textit{Coh}}(\mathcal{O}_X)$
into $D^+_{\textit{Coh}}(\mathcal{O}_Z)$.
\end{lemma}

\begin{proof}
The question is local on $X$, hence we may assume that $X$ is affine.
Say $X = \Spec(A)$ and $Z = \Spec(B)$ with $A$ Noetherian and
$A \to B$ surjective. In this case, we can apply
Lemma \ref{lemma-sheaf-with-exact-support-quasi-coherent}
to translate the question into algebra.
The corresponding algebra result is a consequence of
Lemma \ref{lemma-exact-support-coherent}.
\end{proof}






\section{Dualizing complexes}
\label{section-dualizing}

\noindent
In this section we define dualizing complexes for Noetherian rings.

\begin{definition}
\label{definition-dualizing}
Let $A$ be a Noetherian ring. A {\it dualizing complex} is a
complex of $A$-modules $\omega_A^\bullet$ such that
\begin{enumerate}
\item $\omega_A^\bullet$ has finite injective dimension,
\item $H^i(\omega_A^\bullet)$ is a finite $A$-module for all $i$, and
\item $A \to R\Hom_A(\omega_A^\bullet, \omega_A^\bullet)$
is a quasi-isomorphism.
\end{enumerate}
\end{definition}

\noindent
This definition takes some time getting used to. It is perhaps a good
idea to prove some of the following lemmas yourself without reading
the proofs.

\begin{lemma}
\label{lemma-dualizing}
Let $A$ be a Noetherian ring. If $\omega_A^\bullet$ is a dualizing
complex, then the functor
$$
D : K \longmapsto R\Hom_A(K, \omega_A^\bullet)
$$
is an anti-equivalence $D_{\textit{Coh}}(A) \to D_{\textit{Coh}}(A)$
which exchanges $D^+_{\textit{Coh}}(A)$ and $D^-_{\textit{Coh}}(A)$
and induces an equivalence $D^b_{\textit{Coh}}(A) \to D^b_{\textit{Coh}}(A)$.
Moreover $D \circ D$ is isomorphic to the identity functor.
\end{lemma}

\begin{proof}
Let $K$ be an object of $D_{\textit{Coh}}(A)$. Pick an integer $n$ and
consider the distinguihsed triangle
$$
\tau_{\leq n}K \to K \to \tau_{\geq n + 1}K \to \tau_{\leq n}K[1]
$$
see Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle}.
Since $\omega_A^\bullet$ has finite injective dimension we see
that $R\Hom_A(\tau_{\geq n + 1}K, \omega_A^\bullet)$ has vanishing
cohomology in degrees $\geq n - c$ for some constant $c$.
On the other hand, we obtain a spectral sequence
$$
\text{Ext}_A^p(H^{-q}(\tau_{\leq n}K, \omega_A^\bullet)
\Rightarrow
\text{Ext}_A^{p + q}(\tau_{\leq n}K, \omega_A^\bullet) =
H^{p + q}(R\Hom_A(\tau_{\leq n}K, \omega_A^\bullet))
$$
which shows that these cohomology modules are finite. Since for
$n > p + q + c$ this is equal to $H^{p + q}(R\Hom_A(K, \omega_A^\bullet))$
we see that $R\Hom_A(K, \omega_A^\bullet)$ is indeed an object
of $D_{\textit{Coh}}(A)$.
By More on Algebra, Lemma
\ref{more-algebra-lemma-internal-hom-evaluate-isomorphism-technical}
and the assumptions on the dualizing complex
we obtain a canonical isomorphism
$$
K = R\Hom_A(\omega_A^\bullet, \omega_A^\bullet) \otimes_A^\mathbf{L} K
\longrightarrow
R\Hom_A(R\Hom_A(K, \omega_A^\bullet), \omega_A^\bullet)
$$
Thus our functor has a quasi-inverse and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-detect-cohomology}
Let $A$ be a Noetherian ring. Let $K \in D^b_{\textit{Coh}}(A)$.
Let $\mathfrak m$ be a maximal ideal of $A$.
If $H^i(K)/\mathfrak m H^i(K) \not = 0$, then there exists a finite
$A$-module $E$ annihilated by a power of $\mathfrak m$
and a map $K \to E[-i]$ which is nonzero on $H^i(K)$.
\end{lemma}

\begin{proof}
Let $I$ be the injective hull of the residue field of $\mathfrak m$.
If $H^i(K)/\mathfrak m H^i(K) \not = 0$, then there exists a nonzero
map $H^i(K) \to I$. Since $I$ is injective, we can lift this to a
nonzero map $K \to I[-i]$. Recall that $I = \bigcup I[\mathfrak m^n]$,
see Lemma \ref{lemma-torsion-submodule-sum-injective-hulls}
and that each of the modules $E = I[\mathfrak m^n]$ is of the
desired type. Thus it suffices to prove that
$$
\Hom_{D(A)}(K, I) = \colim \Hom_{D(A)}(K, I[\mathfrak m^n])
$$
This would be immediate if $K$ where a compact object
(or a perfect object) of $D(A)$. This is not the case, but
$K$ is a pseudo-coherent object which is enough here. Namely,
we can represent $K$ by a bounded above complex of finite
free $R$-modules $K^\bullet$. In this case the $\Hom$ groups
above are computed by using $\Hom_{K(A)}(K^\bullet, -)$.
As each $K^n$ is finite free the limit statement holds and the
proof is complete.
\end{proof}

\noindent
Let $R$ be a ring. We will say that an object $L$ of $D(R)$ is
{\it invertible} if there is an open covering $\Spec(R) = \bigcup D(f_i)$
such that $L \otimes_R R_{f_i} \cong R_{f_i}[-n_i]$ for some integers $n_i$.
In this case, the function
$$
\mathfrak p \mapsto n_\mathfrak p,\quad
\text{where }n_\mathfrak p\text{ is the unique integer such that }
H^{n_\mathfrak p}(L \otimes \kappa(\mathfrak p)) \not = 0
$$
is locally constant on $\Spec(R)$. In particular, it follows that
$L = \bigoplus H^n(L)[-n]$ which gives a well defined complex of
$R$-modules (with zero differentials) representing $L$. Since each
$H^n(L)$ is finite projective and nonzero for only a finite number of
$n$ we also see that $L$ is a perfect object of $D(R)$.

\begin{lemma}
\label{lemma-equivalence-comes-from-invertible}
Let $A$ be a Noetherian ring. Let
$F : D^b_{\textit{Coh}}(A) \to D^b_{\textit{Coh}}(A)$ be an $A$-linear
equivalence of categories. Then $F(A)$ is an invertible object of $D(A)$.
\end{lemma}

\begin{proof}
Let $\mathfrak m \subset A$ be a maximal ideal with residue field $\kappa$.
Consider the object $F(\kappa)$. Since
$\kappa = \Hom_{D(A)}(\kappa, \kappa)$ we find that all
cohomology groups of $F(\kappa)$ are annihilated by $\mathfrak m$.
We also see that
$$
\text{Ext}^i_A(\kappa, \kappa) = \text{Ext}^i_A(F(\kappa), F(\kappa))
= \Hom_{D(A)}(F(\kappa), F(\kappa)[-i])
$$
is zero for $i < 0$. Say $H^a(F(\kappa)) \not = 0$ and
$H^b(F(\kappa)) \not = 0$ with $a$ minimal and $b$ maximal
(so in particular $a \leq b$). Then there is a nonzero map
$$
F(\kappa) \to H^b(F(\kappa))[-b] \to H^a(F(\kappa))[-b]
\to F(\kappa)[a - b]
$$
in $D(A)$ (nonzero because it induces a nonzero map on cohomology).
This proves that $b = a$. We conclude that $F(\kappa) = \kappa[-a]$.

\medskip\noindent
Let $G$ be a quasi-inverse to our functor $F$. Arguing as above
we find an integer $b$ such that $G(\kappa) = \kappa[-b]$.
On composing we find $a + b = 0$. Let $E$ be a finite $A$-module
wich is annihilated by a power of $\mathfrak m$. Arguing by
induction on the length of $E$ we find that $G(E) = E'[-b]$
for some finite $A$-module $E'$ annihilated by a power of
$\mathfrak m$. Then $E[-a] = F(E')$.
Next, we consider the groups
$$
\text{Ext}^i_A(A, E') = \text{Ext}^i_A(F(A), F(E')) =
\Hom_{D(A)}(F(A), E[-a + i])
$$
The left hand side is nonzero if and only if $i = 0$ and then
we get $E'$. Applying this with $E = E' = \kappa$ and using Nakayama's
lemma this implies that $H^j(F(A))_\mathfrak m$ is zero for $j > a$ and
generated by $1$ element for $j = a$. On the other hand, if
$H^j(F(A))_\mathfrak m$ is not zero for some $j < a$, then
there is a map $F(A) \to E[-a + i]$ for some $i < 0$ and some
$E$ (Lemma \ref{lemma-detect-cohomology}) which is a contradiction.
Thus we see that $F(A)_\mathfrak m = M[-a]$
for some $A_\mathfrak m$-module $M$ generated by $1$ element.
However, since
$$
A_\mathfrak m = \Hom_{D(A)}(A, A)_\mathfrak m =
\Hom_{D(A)}(F(A), F(A))_\mathfrak m = \Hom_{A_\mathfrak m}(M, M)
$$
we see that $M \cong A_\mathfrak m$. We conclude that there exists
an element $f \in A$, $f \not \in \mathfrak m$ such that
$F(A)_f$ is isomorphic to $A_f[-a]$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-unique}
Let $A$ be a Noetherian ring. If $\omega_A^\bullet$ and
$(\omega'_A)^\bullet$ are dualizing complexes, then
$(\omega'_A)^\bullet$ is quasi-isomorphic to
$\omega_A^\bullet \otimes_A^\mathbf{L} L$
for some invertible object $L$ of $D(A)$.
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-dualizing} and
\ref{lemma-equivalence-comes-from-invertible} the functor
$K \mapsto R\Hom_A(R\Hom_A(K, \omega_A^\bullet), (\omega_A')^\bullet)$
maps $A$ to an invertible object $L$. In other words, there is
an isomorphism
$$
L \longrightarrow R\Hom_A(\omega_A^\bullet, (\omega_A')^\bullet)
$$
Since $L$ has finite tor dimension, this means that we can apply
More on Algebra, Lemma
\ref{more-algebra-lemma-internal-hom-evaluate-isomorphism-technical}
to see that
$$
R\Hom_A(\omega_A^\bullet, (\omega'_A)^\bullet) \otimes_A^\mathbf{L} K
\longrightarrow
R\Hom_A(R\Hom_A(K, \omega_A^\bullet), (\omega_A')^\bullet)
$$
is an isomorphism for $K$ in $D^b_{\textit{Coh}}(A)$.
In particular, setting $K = \omega_A^\bullet$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-localize}
Let $A$ be a Noetherian ring. Let $B = S^{-1}A$ be a localization.
If $\omega_A^\bullet$ is a dualizing
complex, then $\omega_A^\bullet \otimes_A B$ is a dualizing
complex for $B$.
\end{lemma}

\begin{proof}
Let $\omega_A^\bullet \to I^\bullet$ be a quasi-isomorphism
with $I^\bullet$ a bounded complex of injectives.
Then $S^{-1}I^\bullet$ is a bounded complex of injective
$B = S^{-1}A$-modules (Lemma \ref{lemma-localization-injective-modules})
representing $\omega_A^\bullet \otimes_A B$.
Thus $\omega_A^\bullet \otimes_A B$ has finite injective dimension.
Since $H^i(\omega_A^\bullet \otimes_A B) = H^i(\omega_A^\bullet) \otimes_A B$
by flatness of $A \to B$ we see that $\omega_A^\bullet \otimes_A B$
has finite cohomology modules. Finally, the map
$$
B \longrightarrow
R\Hom_A(\omega_A^\bullet \otimes_A B, \omega_A^\bullet \otimes_A B)
$$
is a quasi-isomorphism as formation of internal hom commutes with
flat base change in this case, see
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-glue}
Let $A$ be a Noetherian ring. Let $f_1, \ldots, f_n \in A$
generate the unit ideal. If $\omega_A^\bullet$ is a complex
of $A$-modules such that $(\omega_A^\bullet)_{f_i}$ is a dualizing
complex for $A_{f_i}$ for all $i$, then $\omega_A^\bullet$ is a dualizing
complex for $A$.
\end{lemma}

\begin{proof}
Consider the double complex
$$
\prod\nolimits_{i_0} (\omega_A^\bullet)_{f_{i_0}}
\to
\prod\nolimits_{i_0 < i_1} (\omega_A^\bullet)_{f_{i_0}f_{i_1}}
\to \ldots
$$
The associated total complex is quasi-isomorphic to $\omega_A^\bullet$
for example by Descent, Remark \ref{descent-remark-standard-covering}
or by
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-alternating-cech-complex-complex-computes-cohomology}.
By assumption the complexes $(\omega_A^\bullet)_{f_i}$ have
finite injective dimension as complexes of $A_{f_i}$-modules.
This implies that each of the complexes
$(\omega_A^\bullet)_{f_{i_0} \ldots f_{i_p}}$, $p > 0$ has
finite injective dimension over $A_{f_{i_0} \ldots f_{i_p}}$,
see Lemma \ref{lemma-localization-injective-modules}.
This in turn implies that each of the complexes
$(\omega_A^\bullet)_{f_{i_0} \ldots f_{i_p}}$, $p > 0$ has
finite injective dimension over $A$, see
Lemma \ref{lemma-injective-flat}. Hence $\omega_A^\bullet$
has finite injective dimension as a complex of $A$-modules
(as it can be represented by a complex endowed with
a finite filtration whose graded parts have finite injective
dimension). Since $H^n(\omega_A^\bullet)_{f_i}$ is a finite
$A_{f_i}$ module for each $i$ we see that $H^i(\omega_A^\bullet)$
is a finite $A$-module, see Algebra, Lemma \ref{algebra-lemma-cover}.
Finally, the (derived) base change of the map
$A \to R\Hom_A(\omega_A^\bullet, \omega_A^\bullet)$ to $A_{f_i}$
is the map
$A_{f_i} \to R\Hom_A((\omega_A^\bullet)_{f_i}, (\omega_A^\bullet)_{f_i})$ by
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}.
Hence we deduce that
$A \to R\Hom_A(\omega_A^\bullet, \omega_A^\bullet)$
is an isomorphism and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-quotient}
Let $A \to B$ be a surjective homomorphism of Noetherian rings.
Let $\omega_A^\bullet$ be a dualizing complex.
Then $R\Hom(B, \omega_A^\bullet)$ is a dualizing complex for $B$.
\end{lemma}

\begin{proof}
Let $\omega_A^\bullet \to I^\bullet$ be a quasi-isomorphism
with $I^\bullet$ a bounded complex of injectives.
Then $\Hom_A(B, I^\bullet)$ is a bounded complex of injective
$B$-modules (Lemma \ref{lemma-hom-injective}) representing
$R\Hom(B, \omega_A^\bullet)$.
Thus $R\Hom(B, \omega_A^\bullet)$ has finite injective dimension.
By Lemma \ref{lemma-exact-support-coherent} it is an object of
$D_{\textit{Coh}}(B)$. Finally, we compute
$$
\Hom_{D(B)}(R\Hom(B, \omega_A^\bullet), R\Hom(B, \omega_A^\bullet)) =
\Hom_{D(A)}(R\Hom(B, \omega_A^\bullet), \omega_A^\bullet) = B
$$
and for $n \not = 0$ we compute
$$
\Hom_{D(B)}(R\Hom(B, \omega_A^\bullet), R\Hom(B, \omega_A^\bullet)[n]) =
\Hom_{D(A)}(R\Hom(B, \omega_A^\bullet), \omega_A^\bullet[n]) = 0
$$
which proves the last property of a dualizing complex.
In the displayed equations, the first
equality holds by Lemma \ref{lemma-right-adjoint}
and the second equality holds by Lemma \ref{lemma-dualizing}.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-polynomial-ring}
Let $A$ be a Noetherian ring. If $\omega_A^\bullet$ is a dualizing
complex, then $\omega_A^\bullet \otimes_A A[x]$ is a dualizing
complex for $A[x]$.
\end{lemma}

\begin{proof}
Set $B = A[x]$ and $\omega_B^\bullet = \omega_A^\bullet \otimes_A B$.
It follows from Lemma \ref{lemma-injective-dimension-over-polynomial-ring}
and More on Algebra, Lemma \ref{more-algebra-lemma-finite-injective-dimension}
that $\omega_B^\bullet$ has finite injective dimension.
Since $H^i(\omega_B^\bullet) = H^i(\omega_A^\bullet) \otimes_A B$
by flatness of $A \to B$ we see that $\omega_A^\bullet \otimes_A B$
has finite cohomology modules. Finally, the map
$$
B \longrightarrow R\Hom_B(\omega_B^\bullet, \omega_B^\bullet)
$$
is a quasi-isomorphism as formation of internal hom commutes with
flat base change in this case, see
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}.
\end{proof}

\begin{proposition}
\label{proposition-dualizing-essentially-finite-type}
Let $A$ be a Noetherian ring which has a dualizing complex.
Then any $A$-algebra essentially of finite type over $A$
has a dualixing complex.
\end{proposition}

\begin{proof}
This follows from a combination of
Lemmas \ref{lemma-dualizing-localize},
\ref{lemma-dualizing-quotient}, and \ref{lemma-dualizing-polynomial-ring}.
\end{proof}

\begin{lemma}
\label{lemma-find-function}
Let $A$ be a Noetherian ring. Let $\omega_A^\bullet$ be a dualizing
complex. Let $\mathfrak m \subset A$ be a maximal ideal and set
$\kappa = A/\mathfrak m$. Then
$R\Hom_A(\kappa, \omega_A^\bullet) \cong \kappa[n]$ for some
$n \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
This is true because $R\Hom_A(\kappa, \omega_A^\bullet)$ is a dualizing
complex over $\kappa$ (Lemma \ref{lemma-dualizing-quotient}),
because dualizing complexes over $\kappa$ are unique up to shifts
(Lemma \ref{lemma-dualizing-unique}), and because $\kappa$ is a
dualizing complex over $\kappa$.
\end{proof}




\section{Dualizing complexes over local rings}
\label{section-dualizing-local}

\noindent
In this section $(A, \mathfrak m, \kappa)$ will be a Noetherian local
ring endowed with a dualizing complex $\omega_A^\bullet$ such that
the integer $n$ of Lemma \ref{lemma-find-function} is zero.
More precisely, we assume that $R\Hom_A(\kappa, \omega_A^\bullet) = \kappa[0]$.
In this case we will say that the dualizing complex is {\it normalized}.
Observe that a normalized dualizing complex is unique up to
isomorphism and that any other dualizing complex for $A$ is isomorphic
to a shift of a normalized one (Lemma \ref{lemma-dualizing-unique}).

\begin{lemma}
\label{lemma-normalized-quotient}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex $\omega_A^\bullet$.
Let $A \to B$ be surjective. Then
$\omega_B^\bullet = R\Hom_A(B, \omega_A^\bullet)$ is a
normalized dualizing complex for $B$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dualizing-quotient} the complex
$\omega_B^\bullet$ is dualizing for $B$. We compute
$$
R\Hom_B(\kappa, R\Hom_A(B, \omega_A^\bullet)) =
R\Hom_A(\kappa, \omega_A^\bullet) \cong \kappa[0]
$$
The first equality by Lemma \ref{lemma-right-adjoint}.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-finite-length}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring. Let $F$ be an $A$-linear self-equivalence of the category of
finite length $A$-modules. Then $F$ is isomorphic to the identity functor.
\end{lemma}

\begin{proof}
Since $\kappa$ is the unique simple object of the category we have
$F(\kappa) \cong \kappa$. Since our category is abelian, we find that
$F$ is exact. Hence $F(E)$ has the same length as $E$ for all finite
length modules $E$.
Since $\Hom(E, \kappa) = \Hom(F(E), F(\kappa)) \cong \Hom(F(E), \kappa)$
we conclude from Nakayama's lemma that $E$ and $F(E)$ have the same
number of generators. Hence $F(A/\mathfrak m^n)$ is a cyclic $A$-module.
Pick a generator $e \in F(A/\mathfrak m^n)$.
Since $F$ is $A$-linear we conclude that $\mathfrak m^n e = 0$.
The map $A/\mathfrak m^n \to F(A/\mathfrak m^n)$ has to be
an isomorphism as the lengths are equal. Pick an element
$$
e \in \lim F(A/\mathfrak m^n)
$$
which maps to a generator for all $n$ (small argument omitted).
Then we obtain a system of isomorphisms
$A/\mathfrak m^n \to F(A/\mathfrak m^n)$ compatible with all
$A$-module maps $A/\mathfrak m^n \to A/\mathfrak m^{n'}$ (by $A$-linearity
of $F$ again). Since any finite lenghth module is a cokernel
of a map between direct sums of cyclic modules, we obtain the isomorphism
of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-finite-length}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex $\omega_A^\bullet$.
Let $E$ be an injective hull of $\kappa$. Then there exists
a functorial isomorphism
$$
R\Hom_A(N, \omega_A^\bullet) = \Hom_A(N, E)[0]
$$
for $N$ running through the finite length $A$-modules.
\end{lemma}

\begin{proof}
By induction on the length of $N$ we see that $R\Hom_A(N, \omega_A^\bullet)$
is a module of finite length sitting in degree $0$. Thus
$R\Hom_A(-, \omega_A^\bullet)$ induces an anti-equivalence
on the category of finite length modules. Since the same is true
for $\Hom_A(-, E)$ by Proposition \ref{proposition-matlis} we see that
$$
N \longmapsto \Hom_A(R\Hom_A(N, \omega_A^\bullet), E)
$$
is an equivalence as in Lemma \ref{lemma-equivalence-finite-length}.
Hence it is isomorphic to the identity functor.
Since $\Hom_A(-, E)$ applied twice is the identity
(Proposition \ref{proposition-matlis}) we obtain
the statement of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-sitting-in-degrees}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring with
normalized dualizing complex $\omega_A^\bullet$. Let $M$ be a finite
$A$-module and let $d = \dim(\text{Supp}(M))$. Then
\begin{enumerate}
\item if $\text{Ext}^i_A(M, \omega_A^\bullet)$ is nonzero, then
$i \in \{-d, \ldots, 0\}$,
\item the dimension of the support of $\text{Ext}^i_A(M, \omega_A^\bullet)$
is at most $-i$,
\item $\text{depth}(M)$ is the smallest integer $\delta \geq 0$ such that
$\text{Ext}^{-\delta}_A(M, \omega_A^\bullet) \not = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove this by induction on $d$. If $d = 0$, this follows from
Lemma \ref{lemma-dualizing-finite-length} and Matlis duality
(Proposition \ref{proposition-matlis}) which guarantees that
$\Hom_A(M, E)$ is nonzero if $M$ is nonzero.

\medskip\noindent
Assume the result holds for modules with support of dimension $< d$ and that
$M$ has depth $> 0$. Choose an $f \in \mathfrak m$ which is a nonzerodivisor
on $M$ and consider the short exact sequence
$$
0 \to M \to M \to M/fM \to 0
$$
Since $\dim(\text{Supp}(M/fM)) = d - 1$
(Algebra, Lemma \ref{algebra-lemma-one-equation-module}) we
may apply the induction hypothesis.
Writing
$E^i = \text{Ext}^i_A(M, \omega_A^\bullet)$ and
$F^i = \text{Ext}^i_A(M/fM, \omega_A^\bullet)$
we obtain a long exact sequence
$$
\ldots \to F^i \to E^i \xrightarrow{f} E^i \to F^{i + 1} \to \ldots
$$
By induction $E^i/fE^i = 0$ for
$i + 1 \not \in \{-\dim(\text{Supp}(M/fM)), \ldots, -\text{depth}(M/fM)\}$.
By Nakayama's lemma (Algebra, Lemma \ref{algebra-lemma-NAK})
and Algebra, Lemma \ref{algebra-lemma-depth-drops-by-one}
we conclude $E^i = 0$ for
$i \not \in \{-\dim(\text{Supp}(M)), \ldots, -\text{depth}(M)\}$.
Moreover, in the boundary case $i = - \text{depth}(M)$ we deduce that $E^i$
is nonzero as $F^{i + 1}$ is nonzero by induction.
Since $E^i/fE^i \subset F^{i + 1}$ we get
$$
\dim(\text{Supp}(F^{i + 1})) \geq \dim(\text{Supp}(E^i/fE^i))
\geq \dim(\text{Supp}(E^i)) - 1
$$
(see lemma used above) we also obtain the dimension estimate (2).

\medskip\noindent
If $M$ has depth $0$ and $d > 0$ we let $N = M[\mathfrak m^\infty]$ and set
$M' = M/N$ (compare with Lemma \ref{lemma-divide-by-torsion}).
Then $M'$ has depth $>0$ and $\dim(\text{Supp}(M')) = d$.
Thus we know the result for $M'$ and since
$R\Hom_A(N, \omega_A^\bullet) = \Hom_A(N, E)$
(Lemma \ref{lemma-dualizing-finite-length})
the long exact cohomology sequence of $\text{Ext}$'s implies the
result for $M$.
\end{proof}

\begin{lemma}
\label{lemma-local-CM}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring
with normalized dualizing complex $\omega_A^\bullet$. Let $M$
be a finite $A$-module. The following are equivalent
\begin{enumerate}
\item $M$ is Cohen-Macaulay,
\item $\text{Ext}^i_A(M, \omega_A^\bullet)$ is nonzero for a single $i$,
\item $\text{Ext}^i_A(M, \omega_A^\bullet)$ is zero for
$i \not = \dim(\text{Supp}(M))$.
\end{enumerate}
Denote $CM_d$ the category of finite Cohen-Macaulay $A$-modules
of depth $d$. Then $M \mapsto \text{Ext}^{-d}_A(M, \omega_A^\bullet)$
defines an anti-auto-equivalence of $CM_d$.
\end{lemma}

\begin{proof}
We will use the results of Lemma \ref{lemma-sitting-in-degrees}
without further mention. Fix a finite module $M$.
If $M$ is Cohen-Macaulay, then only
$\text{Ext}^{-d}_A(M, \omega_A^\bullet)$ can be nonzero,
hence (1) $\Rightarrow$ (3).
The implication (3) $\Rightarrow$ (2) is immediate.
Assume (2) and let $N = \text{Ext}^{-\delta}_A(M, \omega_A^\bullet)$
be the nonzero $\text{Ext}$ where $\delta = \text{depth}(M)$. Then, since
$$
M[0] = R\Hom_A(R\Hom_A(M, \omega_A^\bullet), \omega_A^\bullet) =
R\Hom_A(N[\delta], \omega_A^\bullet)
$$
(Lemma \ref{lemma-dualizing})
we conclude that $M = \text{Ext}_A^{-\delta}(N, \omega_A^\bullet)$.
Thus $\delta \geq \dim(\text{Supp}(M))$. Howeover,
since we also know that $\delta \leq \dim(\text{Supp}(M))$
(Algebra, Lemma \ref{algebra-lemma-bound-depth}) we conclude that $M$ is
Cohen-Macaulay.

\medskip\noindent
To prove the final statement, it suffices to show that
$N = \text{Ext}^{-d}_A(M, \omega_A^\bullet)$ is in $CM_d$
for $M$ in $CM_d$. Above we have seen that
$M[0] = R\Hom_A(N[d], \omega_A^\bullet)$ and this proves the
desired result by the equivalence of (1) and (3).
\end{proof}

\begin{lemma}
\label{lemma-dualizing-artinian}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex $\omega_A^\bullet$.
If $\dim(A) = 0$, then $\omega_A^\bullet \cong E[0]$
where $E$ is an injective hull of the residue field.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-dualizing-finite-length}.
\end{proof}

\begin{lemma}
\label{lemma-divide-by-finite-length-ideal}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex. Let $I \subset \mathfrak m$ be an
ideal of finite length. Set $B = A/I$. Then there is a distinguished
triangle
$$
\omega_B^\bullet \to \omega_A^\bullet \to \Hom_A(I, E)[0] \to
\omega_B^\bullet[1]
$$
in $D(A)$ where $E$ is an injective hull of $\kappa$ and
$\omega_B^\bullet$ is a normalized dualizing complex for $B$.
\end{lemma}

\begin{proof}
Use the short exact sequence $0 \to I \to A \to B \to 0$
and Lemmas \ref{lemma-dualizing-finite-length} and
\ref{lemma-normalized-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-divide-by-nonzerodivisor}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex $\omega_A^\bullet$.
Let $f \in \mathfrak m$ be a
nonzerodivisor. Set $B = A/(f)$. Then there is a distinguished
triangle
$$
\omega_B^\bullet \to \omega_A^\bullet \to \omega_A^\bullet \to
\omega_B^\bullet[1]
$$
in $D(A)$ where $\omega_B^\bullet$ is a normalized dualizing complex
for $B$.
\end{lemma}

\begin{proof}
Use the short exact sequence $0 \to A \to A \to B \to 0$
and Lemma \ref{lemma-normalized-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-flat-unramified}
Let $A \to B$ be a local homomorphism of Noetherian local rings.
Let $\omega_A^\bullet$ be a normalized dualizing complex.
If $A \to B$ is flat and $\mathfrak m_A B = \mathfrak m_B$,
then $\omega_A^\bullet \otimes_A B$ is a normalized dualizing
complex for $B$.
\end{lemma}

\begin{proof}
It is clear that $\omega_A^\bullet \otimes_A B$ is in $D^b_{\textit{Coh}}(B)$.
Let $\kappa_A$ and $\kappa_B$ be the residue fields of $A$ and $B$.
By More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}
we see that
$$
R\Hom_B(\kappa_B, \omega_A^\bullet \otimes_A B) =
R\Hom_A(\kappa_A, \omega_A^\bullet) \otimes_A B =
\kappa_A[0] \otimes_A B = \kappa_B[0]
$$
Thus $\omega_A^\bullet \otimes_A B$ has finite injective dimension by
More on Algebra, Lemma
\ref{more-algebra-lemma-finite-injective-dimension-Noetherian-local}.
Finally, we can use the same arguments to see that
$$
R\Hom_B(\omega_A^\bullet \otimes_A B, \omega_A^\bullet \otimes_A B) =
R\Hom_A(\omega_A^\bullet, \omega_A^\bullet) \otimes_A B = A \otimes_A B = B
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-nonvanishing-generically-local}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring with
normalized dualizing complex $\omega_A^\bullet$.
Let $\mathfrak p$ be a minimal prime of $A$ with
$\dim(A/\mathfrak p) = e$. Then
$H^i(\omega_A^\bullet)_\mathfrak p$ is nonzero
if and only if $i = -e$.
\end{lemma}

\begin{proof}
Since $A_\mathfrak p$ has dimension zero, there exists an integer
$n > 0$ such that $\mathfrak p^nA_\mathfrak p$ is zero.
Set $B = A/\mathfrak p^n$ and
$\omega_B^\bullet = R\Hom_A(B, \omega_A^\bullet)$.
Since $B_\mathfrak p = A_\mathfrak p$ we see that
$(\omega_B^\bullet)_\mathfrak p \cong (\omega_A^\bullet)_\mathfrak p$
by using More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}.
By Lemma \ref{lemma-normalized-quotient} we may replace $A$ by $B$.
After doing so, we see that $\dim(A) = e$. Then we see that
$H^i(\omega_A^\bullet)_\mathfrak p$ can only be nonzero if $i = -e$
by Lemma \ref{lemma-sitting-in-degrees}.
On the other hand, since $(\omega_A^\bullet)_\mathfrak p$
is a dualizing complex for the nonzero ring $A_\mathfrak p$
(Lemma \ref{lemma-dualizing-localize})
we see that the remaining module has to be nonzero.
\end{proof}





\section{The dimension function of a dualizing complex}
\label{section-dimension-function}

\noindent
Our results in the local setting have the following consequence:
a Noetherian ring with has a dualizing complex is a
universally catenary ring of finite dimension.

\begin{lemma}
\label{lemma-nonvanishing-generically}
Let $A$ be a Noetherian ring. Let $\mathfrak p$ be a minimal prime
of $A$. Then $H^i(\omega_A^\bullet)_\mathfrak p$ is nonzero
for exactly one $i$.
\end{lemma}

\begin{proof}
The complex $\omega_A^\bullet \otimes_A A_\mathfrak p$
is a dualizing complex for $A_\mathfrak p$
(Lemma \ref{lemma-dualizing-localize}).
The dimension of $A_\mathfrak p$ is zero as $\mathfrak p$
is minimal. Hence the result follows from
Lemma \ref{lemma-dualizing-artinian}.
\end{proof}

\noindent
Let $A$ be a Noetherian ring and let $\omega_A^\bullet$ be a dualizing
complex. Lemma \ref{lemma-find-function} allows us to define a function
$$
\delta = \delta_{\omega_A^\bullet} : \Spec(A) \longrightarrow \mathbf{Z}
$$
by mapping $\mathfrak p$ to the integer of Lemma \ref{lemma-find-function}
for the dualizing complex $(\omega_A^\bullet)_\mathfrak p$
over $A_\mathfrak p$ (Lemma \ref{lemma-dualizing-localize})
and the residue field $\kappa(\mathfrak p)$. To be precise, we define
$\delta(\mathfrak p)$ to be the unique integer such that
$$
(\omega_A^\bullet)_\mathfrak p[-\delta(\mathfrak p)]
$$
is a normalized dualizing complex over the Noetherian local ring
$A_\mathfrak p$.

\begin{lemma}
\label{lemma-quotient-function}
Let $A$ be a Noetherian ring and let $\omega_A^\bullet$ be a dualizing
complex. Let $A \to B$ be a surjective ring map and let
$\omega_B^\bullet = R\Hom(B, \omega_A^\bullet)$ be the dualizing
complex for $B$ of Lemma \ref{lemma-dualizing-quotient}. Then we have
$$
\delta_{\omega_B^\bullet} = \delta_{\omega_A^\bullet}|_{\Spec(B)}
$$
\end{lemma}

\begin{proof}
This follows from the definition of the functions and
Lemma \ref{lemma-normalized-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-function}
Let $A$ be a Noetherian ring and let $\omega_A^\bullet$ be a dualizing
complex. The function $\delta = \delta_{\omega_A^\bullet}$
defined above is a dimension function
(Topology, Definition \ref{topology-definition-dimension-function}).
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset \mathfrak q$ be an immediate specialization.
We have to show that $\delta(\mathfrak p) = \delta(\mathfrak q) + 1$.
We may replace $A$ by $A/\mathfrak p$, the complex $\omega_A^\bullet$ by
$\omega_{A/\mathfrak p}^\bullet = R\Hom(A/\mathfrak p, \omega_A^\bullet)$,
the prime $\mathfrak p$ by $(0)$, and the prime $\mathfrak q$
by $\mathfrak q/\mathfrak p$,
see Lemma \ref{lemma-quotient-function}. Thus we may assume that
$A$ is a domain, $\mathfrak p = (0)$, and $\mathfrak q$ is a prime
ideal of height $1$.

\medskip\noindent
Then $H^i(\omega_A^\bullet)_{(0)}$ is nonzero
for exactly one $i$, say $i_0$, by Lemma \ref{lemma-nonvanishing-generically}.
In fact $i_0 = -\delta((0))$ because
$(\omega_A^\bullet)_{(0)}[-\delta((0))]$
is a normalized dualizing complex over the field $A_{(0)}$.

\medskip\noindent
On the other hand $(\omega_A^\bullet)_\mathfrak q[-\delta(\mathfrak q)]$
is a normalized dualizing complex for $A_\mathfrak q$. By
Lemma \ref{lemma-nonvanishing-generically-local}
we see that
$$
H^e((\omega_A^\bullet)_\mathfrak q[-\delta(\mathfrak q)])_{(0)} =
H^{e - \delta(\mathfrak q)}(\omega_A^\bullet)_{(0)}
$$
is nonzero only for $e = -\dim(A_\mathfrak q) = -1$.
We conclude
$$
-\delta((0)) = -1 - \delta(\mathfrak p)
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-universally-catenary}
Let $A$ be a Noetherian ring which has a dualizing
complex. Then $A$ is universally catenary of finite dimension.
\end{lemma}

\begin{proof}
Because $\Spec(A)$ has a dimension function by
Lemma \ref{lemma-dimension-function}
it is catenary, see
Topology, Lemma \ref{topology-lemma-dimension-function-catenary}.
Hence $A$ is catenary, see
Algebra, Lemma \ref{algebra-lemma-catenary}.
It follows from
Proposition \ref{proposition-dualizing-essentially-finite-type}
that $A$ is universally catenary.

\medskip\noindent
Because any dualizing complex $\omega_A^\bullet$ is
in $D^b_{\textit{Coh}}(A)$ the values of the function
$\delta_{\omega_A^\bullet}$ in minimal primes are bounded by
Lemma \ref{lemma-nonvanishing-generically}.
On the other hand, for a maximal ideal $\mathfrak m$ with
residue field $\kappa$ the integer $i = -\delta(\mathfrak m)$
is the unique integer such that
$\text{Ext}_A^i(\kappa, \omega_A^\bullet)$ is nonzero
(Lemma \ref{lemma-find-function}).
Since $\omega_A^\bullet$ has finite injective dimension
these values are bounded too. Since the dimension of
$A$ is the maximal value of $\delta(\mathfrak p) - \delta(\mathfrak m)$
where $\mathfrak p \subset \mathfrak m$ are a pair
consisting of a minimal prime and a maximal prime we find that the
dimension of $\Spec(A)$ is bounded.
\end{proof}

\begin{lemma}
\label{lemma-depth-dualizing-module}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring with
normalized dualizing complex $\omega_A^\bullet$. Let $d = \dim(A)$
and $\omega_A = H^{-d}(\omega_A^\bullet)$. Then
\begin{enumerate}
\item the support of $\omega_A$ is the union of the irreducible components
of $\Spec(A)$ of dimension $d$,
\item $\omega_A$ satisfies $(S_2)$, see
Algebra, Definition \ref{algebra-definition-conditions}.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use Lemma \ref{lemma-sitting-in-degrees} without further mention.
By Lemma \ref{lemma-nonvanishing-generically-local} the support
of $\omega_A$ contains the irreducible components of dimension $d$.
Let $\mathfrak p \subset A$ be a prime. By Lemma \ref{lemma-dimension-function}
the complex $(\omega_A^\bullet)_{\mathfrak p}[\dim(A/\mathfrak p)]$
is a normalized dualizing complex for $A_\mathfrak p$. Hence if
$\dim(A/\mathfrak p) + \dim(A_\mathfrak p) < d$, then
$(\omega_A)_\mathfrak p = 0$.
This proves the support of $\omega_A$ is the union of the irreducible
components of dimension $d$, because the complement of this union
is exactly the primes $\mathfrak p$ of $A$ for which
$\dim(A/\mathfrak p) + \dim(A_\mathfrak p) < d$ as $A$ is catenary
(Lemma \ref{lemma-universally-catenary}).
On the other hand, if $\dim(A/\mathfrak p) + \dim(A_\mathfrak p) = d$, then
$$
(\omega_A)_\mathfrak p =
H^{-\dim(A_\mathfrak p)}\left(
(\omega_A^\bullet)_{\mathfrak p}[\dim(A/\mathfrak p)] \right)
$$
Hence in order to prove $\omega_A$ has $(S_2)$ it suffices to show that
the depth of $\omega_A$ is at least $\text{min}(\dim(A), 2)$.
We prove this by induction on $\dim(A)$. The case $\dim(A) = 0$ is
trivial.

\medskip\noindent
Assume $\text{depth}(A) > 0$. Choose a nonzerodivisor $f \in \mathfrak m$
and set $B = A/fA$. Then $\dim(B) = \dim(A) - 1$ and we may apply the
induction hypothesis to $B$. By Lemma \ref{lemma-divide-by-nonzerodivisor}
we see that multiplication by $f$ is injective on $\omega_A$ and we get
$\omega_A/f\omega_A \subset \omega_B$. This proves the depth of $\omega_A$
is at least $1$. If $\dim(A) > 1$, then $\dim(B) > 0$ and $\omega_B$
has depth $ > 0$. Hence $\omega_A$ has depth $> 1$ and we conclude in
this case.

\medskip\noindent
Assume $\dim(A) > 0$ and $\text{depth}(A) = 0$. Let
$I = A[\mathfrak m^\infty]$ and set $B = A/I$. Then $B$ has
depth $\geq 1$ and $\omega_A = \omega_B$ by
Lemma \ref{lemma-dualizing-artinian}.
Since we proved the result for $\omega_B$ above the proof is done.
\end{proof}





\section{The local duality theorem}
\label{section-local-duality}

\noindent
The main result in this section is due to Grothendieck.

\begin{lemma}
\label{lemma-local-cohomology-of-dualizing}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $\omega_A^\bullet$ be a normalized dualizing complex.
Let $Z = V(\mathfrak m) \subset \Spec(A)$.
Then $E = R^0\Gamma_Z(\omega_A^\bullet)$ is an injective hull of
$\kappa$ and $R\Gamma_Z(\omega_A^\bullet) = E[0]$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-local-cohomology-noetherian} we have
$R\Gamma_{\mathfrak m} = R\Gamma_Z$. Thus
$$
R\Gamma_Z(\omega_A^\bullet) =
R\Gamma_{\mathfrak m}(\omega_A^\bullet) =
\text{hocolim}\ R\Hom_A(A/\mathfrak m^n, \omega_A^\bullet)
$$
by Lemma \ref{lemma-local-cohomology-ext}. Let $E'$ be an injective
hull of the residue field.
By Lemma \ref{lemma-dualizing-finite-length}
we can find isomorphisms
$$
R\Hom_A(A/\mathfrak m^n, \omega_A^\bullet) \cong \Hom_A(A/I^n, E')[0]
$$
compatible with transition maps. Since
$E' = \bigcup E'[\mathfrak m^n] = \colim \Hom_A(A/I^n, E')$
by Lemma \ref{lemma-union-artinian}
we conclude that $E \cong E'$ and that all other cohomology
groups of the complex $R\Gamma_Z(\omega_A^\bullet)$ are zero.
\end{proof}

\begin{remark}
\label{remark-specific-injective-hull}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring
with a normalized dualizing complex $\omega_A^\bullet$.
By Lemma \ref{lemma-local-cohomology-of-dualizing}
above we see that $R\Gamma_Z(\omega_A^\bullet)$
is an injective hull of the residue field placed in degree $0$.
In fact, this gives a ``construction'' or ``realization''
of the injective hull which is slightly more canonical than
just picking any old injective hull. Namely, a normalized
dualizing complex is unique up to isomorphism, with group
of automorphisms the group of units of $A$, whereas an
injective hull of $\kappa$ is unique up to isomorphism, with
group of automorphisms the group of units of the completion
$A^\wedge$ of $A$ with respect to $\mathfrak m$.
\end{remark}

\noindent
Here is the main result of this section.

\begin{theorem}
\label{theorem-local-duality}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $\omega_A^\bullet$ be a normalized dualizing complex.
Let $E$ be an injective hull of the residue field.
Let $Z = V(\mathfrak m) \subset \Spec(A)$.
Denote ${}^\wedge$ derived completion with respect to $\mathfrak m$.
Then
$$
R\Hom_A(K, \omega_A^\bullet)^\wedge \cong R\Hom_A(R\Gamma_Z(K), E[0])
$$
for $K$ in $D(A)$.
\end{theorem}

\begin{proof}
Observe that $E[0] \cong R\Gamma_Z(\omega_A^\bullet)$ by
Lemma \ref{lemma-local-cohomology-of-dualizing}.
By More on Algebra, Lemma \ref{more-algebra-lemma-completion-RHom}
completion on the left hand side goes inside.
Thus we have to prove
$$
R\Hom_A(K^\wedge, (\omega_A^\bullet)^\wedge)
=
R\Hom_A(R\Gamma_Z(K), R\Gamma_Z(\omega_A^\bullet))
$$
This follows from the equivalence between
$D_{comp}(A, \mathfrak m)$ and $D_{\mathfrak m^\infty\text{-torsion}}(A)$
given in Proposition \ref{proposition-torsion-complete}.
More precisely, it is a special case of Lemma \ref{lemma-compare-RHom}.
\end{proof}

\noindent
Here is a special case of the theorem above.

\begin{lemma}
\label{lemma-special-case-local-duality}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $\omega_A^\bullet$ be a normalized dualizing complex.
Let $E$ be an injective hull of the residue field.
Let $K \in D_{\textit{Coh}}(A)$. Then
$$
\text{Ext}^{-i}_A(K, \omega_A^\bullet)^\wedge =
\Hom_A(H^i_{\mathfrak m}(K), E)
$$
where ${}^\wedge$ denotes $\mathfrak m$-adic completion.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dualizing} we see that $R\Hom_A(K, \omega_A^\bullet)$
is an object of $D_{\textit{Coh}}(A)$.
It follows that the cohomology modules of the derived completion
of $R\Hom_A(K, \omega_A^\bullet)$ are equal to the usual completions
$\text{Ext}^i_A(K, \omega_A^\bullet)^\wedge$ by
More on Algebra, Lemma
\ref{more-algebra-lemma-derived-completion-pseudo-coherent}.
On the other hand, we have $R\Gamma_{\mathfrak m} = R\Gamma_Z$
for $Z = V(\mathfrak m)$ by Lemma \ref{lemma-local-cohomology-noetherian}.
Moreover, the functor $\Hom_A(-, E)$ is exact hence
factors through cohomology.
Hence the lemma is consequence of
Theorem \ref{theorem-local-duality}.
\end{proof}






\section{Dualizing complexes on schemes}
\label{section-dualizing-schemes}

\noindent
We define a dualizing complex on a locally Noetherian scheme
to be a complex which affine locally comes from a dualizing
complex on the corresponding ring. This is not completely
standard but agrees with all definitions in the literature
on Noetherian schemes of finite dimension.

\begin{lemma}
\label{lemma-equivalent-definitions}
Let $X$ be a locally Noetherian scheme. Let $K$ be an object of
$D(\mathcal{O}_X)$. The following are equivalent
\begin{enumerate}
\item For every affine open $U = \Spec(A) \subset X$ there exists
a dualizing complex $\omega_A^\bullet$ for $A$ such that
$K|_U$ is isomorphic to the image of $\omega_A^\bullet$ by
the functor $\widetilde{} : D(A) \to D(\mathcal{O}_U)$.
\item There is an affine open covering $X = \bigcup U_i$, $U_i = \Spec(A_i)$
such that for each $i$ there exists a dualizing complex $\omega_i^\bullet$
for $A_i$ such that $K|_U$ is isomorphic to the image of $\omega_i^\bullet$ by
the functor $\widetilde{} : D(A_i) \to D(\mathcal{O}_{U_i})$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (2) and let $U = \Spec(A)$ be an affine open of $X$.
Since condition (2) implies that $K$ is in $D_\QCoh(\mathcal{O}_X)$
we find an object $\omega_A^\bullet$ in $D(A)$ whose associated
complex of quasi-coherent sheaves is isomorphic to $K|_U$, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
We will show that $\omega_A^\bullet$ is a dualizing complex for $A$
which will finish the proof.

\medskip\noindent
Since $X = \bigcup U_i$ is an open covering, we can find a standard
open covering $U = D(f_1) \cup \ldots \cup D(f_m)$ such that
each $D(f_j)$ is a standard open in one of the affine opens $U_i$, see
Schemes, Lemma \ref{schemes-lemma-standard-open-two-affines}.
Say $D(f_j) = D(g_j)$ for $g_j \in A_{i_j}$.
Then $A_{f_j} \cong (A_{i_j})_{g_j}$ and we have
$$
(\omega_A^\bullet)_{f_j} \cong (\omega_i^\bullet)_{g_j}
$$
in the derived category by
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
By Lemma \ref{lemma-dualizing-localize} we find that
the complex $(\omega_A^\bullet)_{f_j}$ is a dualizing complex over
$A_{f_j}$ for $j = 1, \ldots, m$. This implies that $\omega_A^\bullet$
is dualizing by Lemma \ref{lemma-dualizing-glue}.
\end{proof}

\begin{definition}
\label{definition-dualizing-scheme}
Let $X$ be a locally Noetherian scheme. An object $K$ of
$D(\mathcal{O}_X)$ is called a {\it dualizing complex} if
$K$ satisfies the equivalent conditions of
Lemma \ref{lemma-equivalent-definitions}.
\end{definition}

\noindent
Please see remarks made at the beginning of this section.

\begin{lemma}
\label{lemma-affine-duality}
Let $A$ be a Noetherian ring and let $X = \Spec(A)$. Let $K, L$ be objects
of $D(A)$. If $K \in D_{\textit{Coh}}(A)$ and $L$ has finite injective
dimension, then
$$
R\SheafHom(\widetilde{K}, \widetilde{L})
=
\widetilde{R\Hom_A(K, L)}
$$
in $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
We may assume that $L$ is given by a finite complex $I^\bullet$
of injective $A$-modules. By induction on the length of $I^\bullet$
and compatibility of the constructions with distinguished triangles,
we reduce to the case that $L = I[0]$ where $I$ is an injective $A$-module.
In this case, Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-internal-hom}, tells us that
the $n$th cohomology sheaf of $R\SheafHom(\widetilde{K}, \widetilde{L})$
is the sheaf associated to the presheaf
$$
D(f) \longmapsto \text{Ext}^n_{A_f}(K \otimes_A A_f, I \otimes_A A_f)
$$
Since $A$ is Noetherian, the $A_f$-module $I \otimes_A A_f$ is injective
(Lemma \ref{lemma-localization-injective-modules}). Hence we see that
\begin{align*}
\text{Ext}^n_{A_f}(K \otimes_A A_f, I \otimes_A A_f)
& =
\Hom_{A_f}(H^{-n}(K \otimes_A A_f), I \otimes_A A_f) \\
& =
\Hom_{A_f}(H^{-n}(K) \otimes_A A_f, I \otimes_A A_f) \\
& =
\Hom_A(H^{-n}(K), I) \otimes_A A_f
\end{align*}
The last equality because $H^{-n}(K)$ is a finite $A$-module.
This proves that the canonical map
$$
\widetilde{R\Hom_A(K, L)}
\longrightarrow
R\SheafHom(\widetilde{K}, \widetilde{L})
$$
is a quasi-isomorphism in this case and the proof is done.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-schemes}
Let $K$ be a dualizing complex on a locally Noetherian scheme $X$.
Then $K$ is an object of $D_{\textit{Coh}}(\mathcal{O}_X)$
and $D = R\SheafHom(-, K)$ induces an anti-equivalence
$$
D :
D_{\textit{Coh}}(\mathcal{O}_X)
\longrightarrow
D_{\textit{Coh}}(\mathcal{O}_X)
$$
which comes equipped with a canonical isomorphism
$\text{id} \to D \circ D$. If $X$ is quasi-compact, then
$D$ exchanges $D^+_{\textit{Coh}}(\mathcal{O}_X)$ and
$D^-_{\textit{Coh}}(\mathcal{O}_X)$ and induces an equivalence
$D^b_{\textit{Coh}}(\mathcal{O}_X) \to D^b_{\textit{Coh}}(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be an affine open. Say $U = \Spec(A)$ and
let $\omega_A^\bullet$ be a dualizing complex for $A$
corresponding to $K|_U$
as in Lemma \ref{lemma-equivalent-definitions}.
By Lemma \ref{lemma-affine-duality} the diagram
$$
\xymatrix{
D_{\textit{Coh}}(A) \ar[r] \ar[d]_{R\Hom_A(-, \omega_A^\bullet)} &
D_{\textit{Coh}}(\mathcal{O}_U) \ar[d]^{R\SheafHom(-, K|_U)} \\
D_{\textit{Coh}}(A) \ar[r] &
D(\mathcal{O}_U)
}
$$
commutes. We conclude that $D$ sends $D_{\textit{Coh}}(\mathcal{O}_X)$ into
$D_{\textit{Coh}}(\mathcal{O}_X)$. Moreover, the canonical map
$$
L \longrightarrow R\SheafHom(R\SheafHom(L, K), K)
$$
(Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-internal-hom-evaluate})
is an isomorphism for all $L$ because this is true on affines by
Lemma \ref{lemma-dualizing}.
The statement on boundedness properties of the functor $D$
in the quasi-compact case also folow from the corresponding
statements of Lemma \ref{lemma-dualizing}.
\end{proof}

\noindent
Let $X$ be a locally ringed space. We will say that an object $L$ of
$D(\mathcal{O}_X)$ is {\it invertible} if there is an open covering
$X = \bigcup U_i$ such that $L|_{U_i} \cong \mathcal{O}_{U_i}[-n_i]$
for some integers $n_i$. In this case, the function
$$
x \mapsto n_x,\quad
\text{where }n_x\text{ is the unique integer such that }
H^{n_x}(L_x) \not = 0
$$
is locally constant on $X$. In particular, it follows that
$L = \bigoplus H^n(L)[-n]$ which gives a well defined complex of
$\mathcal{O}_X$-modules (with zero differentials) representing $L$.
In particular $L$ is a perfect object of $D(\mathcal{O}_X)$.

\begin{lemma}
\label{lemma-dualizing-unique-schemes}
Let $X$ be a locally Noetherian scheme. If $K$ and $K'$ are dualizing
complexes on $X$, then $K'$ is isomorphic to
$K \otimes_{\mathcal{O}_X}^\mathbf{L} L$
for some invertible object $L$ of $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Set
$$
L = R\SheafHom_{\mathcal{O}_X}(K, K')
$$
This is an invertible object of $D(\mathcal{O}_X)$, because affine locally
this is true, see Lemma \ref{lemma-dualizing-unique} and its proof.
The evaluation map $L \otimes_{\mathcal{O}_X}^\mathbf{L} K \to K'$
is an isomorphism for the same reason.
\end{proof}

\begin{lemma}
\label{lemma-dimension-function-scheme}
Let $X$ be a locally Noetherian scheme. Let $\omega_X^\bullet$
be a dualizing complex on $X$. Then $X$ is universally catenary
and the function
$X \to \mathbf{Z}$ defined by
$$
x \longmapsto \delta(x)\text{ such that }
\omega_{X, x}^\bullet[-\delta(x)]
\text{ is a normalized dualizing complex over }
\mathcal{O}_{X, x}
$$
is a dimension functor.
\end{lemma}

\begin{proof}
Immediate from the affine case
Lemma \ref{lemma-dimension-function}
and the definitions.
\end{proof}






\section{Right adjoint of pushforward}
\label{section-twisted-inverse-image}

\noindent
References for this section and the following are
\cite{Neeman-Grothendieck}, \cite{LN},
\cite{Lipman-notes}, and \cite{Neeman-improvement}.

\medskip\noindent
Let $f : X \to Y$ be a morphism of schemes.
In this section we consider the right adjoint to the functor
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_X)$.
In the literature, if this functor exists, then it is sometimes
denoted $f^{\times}$. This notation is not universally accepted and we refrain
from using it. We will not use the notation $f^!$ for such a functor,
as this would clash (for general morphisms $f$) with the notation in
\cite{RD}.

\begin{lemma}
\label{lemma-twisted-inverse-image}
\begin{reference}
This is almost the same as \cite[Example 4.2]{Neeman-Grothendieck}.
\end{reference}
Let $f : X \to Y$ be a morphism between quasi-separated and quasi-compact
schemes. The functor $Rf_* : D_\QCoh(X) \to D_\QCoh(Y)$ has a
right adjoint.
\end{lemma}

\begin{proof}
We will prove a right adjoint exists by verifying the hypotheses of
Derived Categories, Proposition \ref{derived-proposition-brown}.
First off, the category $D_\QCoh(\mathcal{O}_X)$ has direct sums, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-direct-sums}.
The category $D_\QCoh(\mathcal{O}_X)$ is compactly generated by
Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh}.
Since $X$ and $Y$ are quasi-compact and quasi-separated, so is $f$, see
Schemes, Lemmas \ref{schemes-lemma-compose-after-separated} and
\ref{schemes-lemma-quasi-compact-permanence}.
Hence the functor $Rf_*$ commutes with direct sums, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-pushforward-direct-sums}.
This finishes the proof.
\end{proof}

\begin{example}
\label{example-affine-twisted-inverse-image}
Let $A \to B$ be a ring map. Let $Y = \Spec(A)$ and $X = \Spec(B)$
and $f : X \to Y$ the morphism corresponding to $A \to B$.
Then $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$
corresponds to restriction $D(B) \to D(A)$ via
the equivalences $D(B) \to D_\QCoh(\mathcal{O}_X)$ and
$D(A) \to D_\QCoh(\mathcal{O}_Y)$. Hence the right adjoint
corresponds to the functor $K \longmapsto R\Hom(B, K)$ of
Section \ref{section-trivial}.
\end{example}

\begin{example}
\label{example-does-not-preserve-coherent}
If $f : X \to Y$ is a separated finite type morphism of Noetherian schemes,
then the right adjoint of
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ does not map
$D_{\textit{Coh}}(\mathcal{O}_Y)$ into
$D_{\textit{Coh}}(\mathcal{O}_X)$. Namely, let $k$ be a field and
consider the morphism $f : \mathbf{A}^1_k \to \Spec(k)$. By
Example \ref{example-affine-twisted-inverse-image}
this corresponds to the question of whether
$R\Hom(B, -)$ maps $D_{\textit{Coh}}(A)$ into $D_{\textit{Coh}}(B)$
where $A = k$ and $B = k[x]$. This is not true because
$$
R\Hom(k[x], k) = \left(\prod\nolimits_{n \geq 0} k\right)[0]
$$
which is not a finite $k[x]$-module. Hence $a(\mathcal{O}_Y)$
does not have coherent cohomology sheaves.
\end{example}

\begin{example}
\label{example-does-not-preserve-bounded-above}
If $f : X \to Y$ is a proper or even finite morphism of Noetherian schemes,
then the right adjoint of
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$
does not map $D_\QCoh^-(\mathcal{O}_Y)$ into
$D_\QCoh^-(\mathcal{O}_X)$. Namely, let $k$ be a field, let
$k[\epsilon]$ be the dual numbers over $k$, let
$X = \Spec(k)$, and let $Y = \Spec(k[\epsilon])$.
Then $\text{Ext}^i_{k[\epsilon]}(k, k)$ is nonzero for all $i \geq 0$.
Hence $a(\mathcal{O}_Y)$ is not bounded above
by Example \ref{example-affine-twisted-inverse-image}.
\end{example}

\begin{lemma}
\label{lemma-twisted-inverse-image-bounded-below}
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $a : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)$
be the right adjoint to $Rf_*$ of Lemma \ref{lemma-twisted-inverse-image}.
Then $a$ maps $D^+_\QCoh(\mathcal{O}_Y)$ into $D^+_\QCoh(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
By Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-direct-image}
the functor $Rf_*$ has finite cohomological dimension. In other words,
there exist an integer $N$ such that
$H^i(Rf_*L) = 0$ for $i \geq N + c$ if $H^j(L) = 0$ for $j \geq c$.
Say $K \in D^+_\QCoh(\mathcal{O}_Y)$ has $H^k(K) = 0$ for $k \geq c$.
Then
$$
\Hom_{D(\mathcal{O}_X)}(\tau_{\leq c - N}a(K), a(K)) =
\Hom_{D(\mathcal{O}_Y)}(Rf_*\tau_{\leq c - N}a(K), K) = 0
$$
by what we said above. Clearly, this implies that $a(K)$ is bounded below.
\end{proof}

\noindent
We often want to know whether the right adjoints to pushforward commutes
with base change. Thus we consider a cartesian square
\begin{equation}
\label{equation-base-change}
\vcenter{
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
}
\end{equation}
of quasi-compact and quasi-separated schemes.
Denote
\begin{align*}
a  & : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X), \\
a' & : D_\QCoh(\mathcal{O}_{Y'}) \to D_\QCoh(\mathcal{O}_{X'}), \\
b  & : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_{X'}), \\
b' & : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_{Y'})
\end{align*}
the right adjoints to $Rf_*$, $Rf'_*$, $Rg_*$, and $Rg'_*$
(Lemma \ref{lemma-twisted-inverse-image}). Since
$Rf_* \circ Rg'_* = Rg_* \circ Rf'_*$ we get
$$
b' \circ a = a' \circ b.
$$
Another compatibility comes from the base change map of
Cohomology, Remark \ref{cohomology-remark-base-change}.
It induces a transformation of functors
$$
Lg^* \circ Rf_* \longrightarrow Rf'_* \circ L(g')^*
$$
on derived categories of sheaves with quasi-coherent cohomology.
Hence a transformation between the right adjoints in the opposite direction
$$
a \circ Rg_* \longleftarrow Rg'_* \circ a'
$$

\begin{lemma}
\label{lemma-flat-precompose-pus}
In diagram (\ref{equation-base-change}) assume that $g$ is flat or
more generally that $f$ and $g$ are Tor independent. Then
$a \circ Rg_* \leftarrow Rg'_* \circ a'$ is an isomorphism.
\end{lemma}

\begin{proof}
In this case the base change map
$Lg^* \circ Rf_* K \longrightarrow Rf'_* \circ L(g')^*K$
is an isomorphism for every $K$ in $D_\QCoh(\mathcal{O}_X)$ by
Derived Categories of Schemes, Lemma \ref{perfect-lemma-compare-base-change}.
Thus the corresponding transformation between adjoint functors
is an isomorphism as well.
\end{proof}

\noindent
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $V \subset Y$ be a quasi-compact open subscheme and set
$U = f^{-1}(V)$. This gives a cartesian square
$$
\xymatrix{
U \ar[r]_{j'} \ar[d]_{f|_U} & X \ar[d]^f \\
V \ar[r]^j & Y
}
$$
as in (\ref{equation-base-change}). By Lemma \ref{lemma-flat-precompose-pus}
the map $\xi : a \circ Rj_* \leftarrow Rj'_* \circ a'$ is an isomorphism
where $a$ and $a'$ are the right adjoints to
$Rf_*$ and $R(f|_U)_*$. We obtain a transformation
of functors $D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_U)$
\begin{equation}
\label{equation-sheafy}
(j')^* \circ a \to
(j')^* \circ a \circ Rj_* \circ j^* \xrightarrow{\xi^{-1}}
(j')^* \circ Rj'_* \circ a' \circ j^* \to a' \circ j^*
\end{equation}
where the first arrow comes from $\text{id} \to Rj_* \circ j^*$
and the final arrow from the isomorphism $(j')^* \circ Rj'_* \to \text{id}$.
In particular, we see that (\ref{equation-sheafy}) is an isomorphism
when evaluated on $K$ if and only if $a(K)|_U \to a(Rj_*(K|_V))|_U$
is an isomorphism.

\begin{example}
\label{example-not-supported-on-inverse-image}
There is a finite morphsm $f : X \to Y$ of Noetherian schemes
such that (\ref{equation-sheafy}) is not an isomorphism
when evaluated on some
$K \in D_{\textit{Coh}}(\mathcal{O}_Y)$.
Namely, let $X = \Spec(B) \to Y = \Spec(A)$ with
$A = k[x, \epsilon]$ where $k$ is a field and $\epsilon^2 = 0$ and
$B = k[x] = A/(\epsilon)$. For $n \in \mathbf{N}$ set
$M_n = A/(\epsilon, x^n)$. Observe that
$$
\text{Ext}^i_A(B, M_n) = M_n,\quad i \geq 0
$$
because $B$ has the free periodic resolution
$\ldots \to A \to A \to A$ with maps given by multiplication by $\epsilon$.
Consider the object
$K = \bigoplus K_n[n] = \prod K_n[n]$
of $D_{\textit{Coh}}(A)$ (equality in $D(A)$ by
Derived Categories, Lemmas \ref{derived-lemma-direct-sums} and
\ref{derived-lemma-products}). Then we see that $a(K)$ correspnds
to $R\Hom(B, K)$ by Example \ref{example-affine-twisted-inverse-image} and
$$
H^0(R\Hom(B, K)) = \text{Ext}^0_A(B, K) =
\prod\nolimits_{n \geq 1} \text{Ext}^n_A(B. M_n) = 
\prod\nolimits_{n \geq 1} M_n
$$
by the above. But this module has elements which are not
annihilated by any power of $x$, whereas the complex $K$
does have every element of its cohomology annihilated by
a power of $x$. In other words, for the map (\ref{equation-sheafy})
with $V = D(x)$ and $U = D(x)$ and the complex $K$ cannot
be an isomorphism because $(j')^*(a(K))$ is nonzero and
$a'(j^*K)$ is zero.
\end{example}

\begin{lemma}
\label{lemma-when-sheafy}
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $a$ be the right adjoint to
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$.
Let $V \subset Y$ be quasi-compact open with inverse image $U \subset X$.
If for every $Q \in D_\QCoh^+(\mathcal{O}_Y)$ supported on $Y \setminus V$
the image $a(Q)$ is supported on $X \setminus U$, then (\ref{equation-sheafy})
is an isomorphism on all $K$ in $D_\QCoh^+(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
Choose a distinguished triangle
$$
K \to Rj_*K|_V \to Q \to K[1]
$$
Observe that $Q$ is supported on $Y \setminus V$
(Derived Categories of Schemes, Definition
\ref{perfect-definition-supported-on}).
Applying $a$ we obtain a distinguished triangle
$$
a(K) \to a(Rj_*K|_V) \to a(Q) \to a(K)[1]
$$
on $X$. If $a(Q)$ is supported on $X \setminus U$, then
restricting to $U$ the map $a(K)|_U \to a(Rj_*K|_V)|_U$ is an
isomorphism, i.e., (\ref{equation-sheafy}) is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-proper-noetherian}
Let $f : X \to Y$ be a proper\footnote{This proof works for those
morphisms of quasi-compact and quasi-separated schemes such that
$Rf_*P$ is pseudo-coherent for all $P$ perfect on $X$. It follows
easily from a theorem of Kiehl \cite{Kiehl} that this holds if
$f$ is proper and pseudo-coherent. This is the correct generality
for this lemma and some of the other results in this section.}
morphism of Noetherian schemes.
The assumption and hence the conclusion of
Lemma \ref{lemma-when-sheafy} holds for all opens $V$ of $Y$.
\end{lemma}

\begin{proof}
Let $Q \in D^+_\QCoh(\mathcal{O}_Y)$ be supported on $Y \setminus V$.
To get a contradiction, assume that $a(Q)$ is not supported on
$X \setminus U$. Then we can find a perfect complex $P_U$ on $U$
and a nonzero map $P_U \to a(Q)|_U$ (follows from
Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh}). Then using
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-lift-map-from-perfect-complex-with-support}
we may assume there is a perfect complex $P$ on $X$ and a map
$P \to a(Q)$ whose restriction to $U$ is nonzero.
By definition of $a$ this map
is adjoint to a map $Rf_*P \to Q$.

\medskip\noindent
Because $f$ is proper and $X$ and $Y$ Noetherian, the complex
$Rf_*P$ is pseudo-coherent, see
Derived Categories of Schemes, Lemmas
\ref{perfect-lemma-direct-image-coherent} and
\ref{perfect-lemma-identify-pseudo-coherent-noetherian}.
Thus we may apply
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-map-from-pseudo-coherent-to-complex-with-support}
and get a map $I \to \mathcal{O}_Y$ of perfect complexes
whose restriction to $V$ is an isomorphism such that the composition
$I \otimes^\mathbf{L}_{\mathcal{O}_Y} Rf_*P \to Rf_*P \to K$ is zero.
By Derived Categories of Schemes, Lemma
\ref{perfect-lemma-cohomology-base-change}
we have $I \otimes^\mathbf{L}_{\mathcal{O}_Y} Rf_*P =
Rf_*(Lf^*I \otimes^\mathbf{L}_{\mathcal{O}_X} P)$.
We conclude that the composition
$$
Lf^*I \otimes^\mathbf{L}_{\mathcal{O}_X} P \to P \to a(K)
$$
is zero. However, the restriction to $U$ is the map
$P|_U \to a(K)|_U$ which we assumed to be nonzero.
This contradiction finishes the proof.
\end{proof}

\noindent
Let $f : X \to Y$ be a morphism of quasi-separated and quasi-compact
schemes. Let $a$ denote the right adjoint to
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$. For every
$K \in D_\QCoh(\mathcal{O}_Y)$ and $L \in D_\QCoh(\mathcal{O}_Y)$
we obtain a canonical map
\begin{equation}
\label{equation-sheafy-trace}
Rf_*R\SheafHom(L, a(K)) \longrightarrow R\SheafHom(Rf_*L, K)
\end{equation}
Namely, this map is constructed as the composition
$$
Rf_*R\SheafHom(L, a(K)) \to R\SheafHom(Rf_*L, Rf_*a(K))
\to R\SheafHom(Rf_*L, K)
$$
where the first arrow is 
Cohomology, Remark
\ref{cohomology-remark-projection-formula-for-internal-hom}
and the second arrow comes from the adjunction map $Rf_*a(K) \to K$.

\begin{lemma}
\label{lemma-iso-global-hom}
Let $f : X \to Y$ be a morphism of quasi-separated and quasi-compact
schemes.
For all $L \in D_\QCoh(\mathcal{O}_X)$ and $K \in D_\QCoh(\mathcal{O}_Y)$
(\ref{equation-sheafy-trace}) induces an isomorphism
$R\Hom(L, a(K)) \to R\Hom(Rf_*L, K)$ of global derived homs.
\end{lemma}

\begin{proof}
By construction (Cohomology, Section \ref{cohomology-section-global-RHom})
the complexes
$$
R\Hom(L, a(K)) = R\Gamma(X, R\SheafHom(L, a(K))) =
R\Gamma(Y, Rf_*R\SheafHom(L, a(K)))
$$
and $R\Hom(Rf_*L, K) = R\Gamma(Y, R\SheafHom(Rf_*L, a(K)))$
have $H^0$ equal to $\Hom(L, a(K))$ and $\Hom(Rf_*L, K)$ and
(\ref{equation-sheafy-trace}) induces the adjunction map
between these. Similarly in other degrees.
\end{proof}

\begin{lemma}
\label{lemma-proper-noetherian-relative}
Let $f : X \to Y$ be a proper morphism of Noetherian schemes.
Let $a$ be the right adjoint to
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$.
Then (\ref{equation-sheafy-trace})
$$
Rf_*R\SheafHom(L, a(K)) \longrightarrow R\SheafHom(Rf_*L, K)
$$
is an isomorphism for all $L \in D_\QCoh(\mathcal{O}_X)$ and all
$K \in D^+_\QCoh(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
Taking $H^0(V, -)$ for an open $V$ of $Y$ with inverse image $U$ in $X$ we get
$$
\Hom_{D(\mathcal{O}_U)}(L|_U, a(K)|_U) \longrightarrow
\Hom_{D(\mathcal{O}_V)}(Rf_*L|_V, K|_V)
$$
see Cohomology, Lemma \ref{cohomology-lemma-section-RHom-over-U}.
Since $a(K)|_U$ is the image of $K|_V$ (Lemma \ref{lemma-proper-noetherian})
under the right adjoint to $R(f|_U)_*$ the two
sides of this arrow are isomorphic. We omit the verification that
the two maps agree. A similar argument works for $H^n(V, -)$.
Thus the map defined above is an isomorphism on cohomology
and hence an isomorphism in the derived category.
\end{proof}

\begin{lemma}
\label{lemma-twisted-inverse-image-closed}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $i : Z \to X$ be a pseudo-coherent closed immersion
(if $X$ is Noetherian, then any closed immersion is pseudo-coherent).
Let $a : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Z)$ be the
right adjoint to $Ri_*$. Then there is a functorial isomorphism
$$
a(K) = R\SheafHom(\mathcal{O}_Z, K)
$$
for $K \in D_\QCoh^+(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
(The parenthetical statement follows from More on Morphisms, Lemma
\ref{more-morphisms-lemma-Noetherian-pseudo-coherent}.)
By Lemma \ref{lemma-sheaf-with-exact-support-adjoint}
the functor $R\SheafHom(\mathcal{O}_Z, -)$ is a right adjoint
to $Ri_* : D(\mathcal{O}_Z) \to D(\mathcal{O}_X)$. Moreover,
by Lemma \ref{lemma-sheaf-with-exact-support-quasi-coherent}
and Lemma \ref{lemma-twisted-inverse-image-bounded-below}
both $R\SheafHom(\mathcal{O}_Z, -)$ and $a$ map
$D_\QCoh^+(\mathcal{O}_X)$ into $D_\QCoh^+(\mathcal{O}_Z)$.
Hence we obtain the isomorphism by uniqueness of adjoint
functors.
\end{proof}






\section{Base change for right adjoints to pushforward}
\label{section-base-change-map}

\noindent
The map (\ref{equation-sheafy}) is a special case of a base change map.
Namely, suppose that we have a diagram (\ref{equation-base-change})
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
where $f$ and $g$ are Tor independent. Then we can consider the
morphism of functors
$D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_{X'})$
given by the composition
\begin{equation}
\label{equation-base-change-map}
L(g')^* \circ a \to
L(g')^* \circ a \circ Rg_* \circ Lg^* \leftarrow
L(g')^* \circ Rg'_* \circ a' \circ Lg^* \to a' \circ Lg^*
\end{equation}
The first arrow comes from the adjunction map $\text{id} \to Rg_* Lg^*$
and the last arrow from the adjunction map $L(g')^*Rg'_* \to \text{id}$.
We need the assumption on Tor independence to invert the arrow
in the middle, see Lemma \ref{lemma-flat-precompose-pus}.
Alternatively, we can think of (\ref{equation-base-change-map}) by
adjointness of $L(g')^*$ and $R(g')_*$ as a natural transformation
$$
a \to a \circ Rg_* \circ Lg^* \leftarrow Rg'_* \circ a' \circ Lg^*
$$
were again the second arrow is invertible. If $M \in D_\QCoh(\mathcal{O}_X)$
and $K \in D_\QCoh(\mathcal{O}_Y)$
then on Yoneda functors this map is given by
\begin{align*}
\Hom_X(M, a(K))
& =
\Hom_Y(Rf_*M, K) \\
& \to
\Hom_Y(Rf_*M, Rg_* Lg^*K) \\
& =
\Hom_{Y'}(Lg^*Rf_*M, Lg^*K) \\
& \leftarrow
\Hom_{Y'}(Rf'_* L(g')^*M, Lg^*K) \\
& =
\Hom_{X'}(L(g')^*M, a'(Lg^*K)) \\
& =
\Hom_X(M, Rg'_*a'(Lg^*K))
\end{align*}
(were the arrow pointing left is invertible by the base
change theorem given in
Derived Categories of Schemes, Lemma \ref{perfect-lemma-compare-base-change})
which makes things a little bit more explicit.

\medskip\noindent
In this section we first prove that the base change map is an isomorphism
in some cases and then we prove that the base change map satisfies
some natural compatibilities with regards to stacking squares as in
Cohomology, Remarks \ref{cohomology-remark-compose-base-change} and
\ref{cohomology-remark-compose-base-change-horizontal} for the usual
base change map. We suggest the reader skip the rest of this section
on a first reading.

\begin{lemma}
\label{lemma-more-base-change}
In diagram (\ref{equation-base-change}) assume
\begin{enumerate}
\item $g : Y' \to Y$ is a morphism of affine schemes,
\item $f : X \to Y$ is proper,
\item $Y$ Noetherian, and
\item $f$ and $g$ are Tor independent.
\end{enumerate}
Then the base change map (\ref{equation-base-change-map}) induces an
isomorphism
$$
L(g')^*a(K) \longrightarrow a'(Lg^*K)
$$
in the following cases
\begin{enumerate}
\item for all $K \in D_\QCoh(\mathcal{O}_X)$ if $f$ is flat, or
\item for $K \in D_\QCoh^+(\mathcal{O}_X)$ if $g$ has finite Tor dimension.
\end{enumerate}
\end{lemma}

\begin{proof}
Write $Y = \Spec(A)$ and $Y' = \Spec(A')$. As a base change of an affine
morphism, the morphism $g'$ is affine. Hence $Rg'_*$ reflects isomorphisms,
see Derived Categories of Schemes, Lemma \ref{perfect-lemma-affine-morphism}.
Thus (\ref{equation-base-change-map}) is an isomorphism for
$K \in D_\QCoh(\mathcal{O}_X)$ if and only
if the map $a(K) \to a(Rg_*Lg^*K) = Rg'_*a'(Lg^*K)$ induces an isomorphism
$$
a(K) \otimes^\mathbf{L}_{\mathcal{O}_X} g'_*\mathcal{O}_{X'} \to a(Rg_*Lg^*K)
$$
(see Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-morphism-pull-push}).
As $D_\QCoh(\mathcal{O}_X)$ is generated by perfect objects
(see Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh}), it suffices
to check we obtain an isomorphism after applying the functor
$\Hom(M, -)$ where $M$ is perfect on $X$. Recall that
$\Hom(M, -) = H^0(R\Hom(M, -))$, see Cohomology, Section
\ref{cohomology-section-global-RHom}. Thus on the left hand side
we get $H^0$ of the following complex
\begin{align*}
R\Hom(M, a(K) \otimes^\mathbf{L}_{\mathcal{O}_X} g'_*\mathcal{O}_{X'})
& =
R\Hom(M, a(K)) \otimes^\mathbf{L}_A A' \\
& =
R\Hom(Rf_*M, K) \otimes^\mathbf{L}_A A'
\end{align*}
The first equality by Derived Categories of Schemes,
Lemma \ref{perfect-lemma-affine-morphism-and-hom-out-of-perfect}.
The second equality is Lemma \ref{lemma-iso-global-hom}.
In the case that $f$ is flat the complex $Rf_*M$ is perfect on $Y$
(Derived Categories of Schemes, Lemma \ref{perfect-lemma-perfect-direct-image})
and in general the complex $Rf_*M$ is pseudo-coherent on $Y$
(Derived Categories of Schemes, Lemmas
\ref{perfect-lemma-direct-image-coherent} and
\ref{perfect-lemma-identify-pseudo-coherent-noetherian}).
Thus we get on the right hand side $H^0$ of the following complex
\begin{align*}
R\Hom(M, a(Rg_*Lg^*K))
& =
R\Hom(Rf_*M, Rg_*Lg^*K) \\
& =
R\Hom(Rf_*M, K \otimes^\mathbf{L}_{\mathcal{O}_Y} g_*\mathcal{O}_{Y'}) \\
& =
R\Hom(Rf_*M, K) \otimes_A^\mathbf{L} A'
\end{align*}
The first equality by Lemma \ref{lemma-iso-global-hom}. The second equality
by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-morphism-pull-push}.
The third equality by Derived Categories of Schemes,
Lemma \ref{perfect-lemma-affine-morphism-and-hom-out-of-perfect}.
Thus we get the same outcome as before. We omit the
verification that our map induces the given identifications.
\end{proof}

\begin{lemma}
\label{lemma-compose-base-change-maps}
Consider a commutative diagram
$$
\xymatrix{
X' \ar[r]_k \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^l \ar[d]_{g'} & Y \ar[d]^g \\
Z' \ar[r]^m & Z
}
$$
of quasi-compact and quasi-separated schemes where
both diagrams are cartesian and where $f$ and $l$
as well as $g$ and $m$ are Tor independent.
Then the maps (\ref{equation-base-change-map})
for the two squares compose to give the base
change map for the outer rectangle (see proof for a precise statement).
\end{lemma}

\begin{proof}
It follows from the assumptions that $g \circ f$ and $m$ are Tor
independent (details omitted), hence the statement makes sense.
In this proof we write $k^*$ in place of $Lk^*$ and $f_*$ instead
of $Rf_*$. Let $a$, $b$, and $c$ be the right adjoints of
Lemma \ref{lemma-twisted-inverse-image}
for $f$, $g$, and $g \circ f$ and similarly for the primed versions.
The arrow corresponding to the top square is the composition
$$
\gamma_{top} :
k^* \circ a \to k^* \circ a \circ l_* \circ l^*
\xleftarrow{\xi_{top}} k^* \circ k_* \circ a' \circ l^* \to a' \circ l^*
$$
where $\xi_{top} : k_* \circ a' \to a \circ l_*$
is an isomorphism (hence can be inverted)
and is the arrow ``dual'' to the base change map
$l^* \circ f_* \to f'_* \circ k^*$. The outer arrows come
from the canonical maps $1 \to l_* \circ l^*$ and $k^* \circ k_* \to 1$.
Similarly for the second square we have
$$
\gamma_{bot} :
l^* \circ b \to l^* \circ b \circ m_* \circ m^*
\xleftarrow{\xi_{bot}} l^* \circ l_* \circ b' \circ m^* \to b' \circ m^*
$$
For the outer rectangle we get
$$
\gamma_{rect} :
k^* \circ c \to k^* \circ c \circ m_* \circ m^*
\xleftarrow{\xi_{rect}} k^* \circ k_* \circ c' \circ m^* \to c' \circ m^*
$$
We have $(g \circ f)_* = g_* \circ f_*$ and hence
$c = a \circ b$ and similarly $c' = a' \circ b'$.
The statement of the lemma is that $\gamma_{rect}$
is equal to the composition
$$
k^* \circ c = k^* \circ a \circ b \xrightarrow{\gamma_{top}}
a' \circ l^* \circ b \xrightarrow{\gamma_{bot}}
a' \circ b' \circ m^* = c' \circ m^*
$$
To see this we contemplate the following diagram:
$$
\xymatrix{
& & k^* \circ a \circ b \ar[d] \ar[lldd] \\
& & k^* \circ a \circ l_* \circ l^* \circ b \ar[ld] \\
k^* \circ a \circ b \circ m_* \circ m^* \ar[r] &
k^* \circ a \circ l_* \circ l^* \circ b \circ m_* \circ m^* &
k^* \circ k_* \circ a' \circ l^* \circ b \ar[u]_{\xi_{top}} \ar[d] \ar[ld] \\
& k^*\circ k_* \circ a' \circ l^* \circ b \circ m_* \circ m^*
\ar[u]_{\xi_{top}} \ar[rd] &
a' \circ l^* \circ b \ar[d] \\
k^* \circ k_* \circ a' \circ b' \circ m^* \ar[uu]_{\xi_{rect}} \ar[ddrr] &
k^*\circ k_* \circ a' \circ l^* \circ l_* \circ b' \circ m^*
\ar[u]_{\xi_{bot}} \ar[l] \ar[dr] &
a' \circ l^* \circ b \circ m_* \circ m^* \\
& & a' \circ l^* \circ l_* \circ b' \circ m^* \ar[u]_{\xi_{bot}} \ar[d] \\
& & a' \circ b' \circ m^*
}
$$
Going down the right hand side we have the composition and going
down the left hand side we have $\gamma_{rect}$.
All the quadrilaterals on the right hand side of this diagram commute
by Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}
or more simply the discussion preceding
Categories, Definition \ref{categories-definition-horizontal-composition}.
Hence we see that it suffices to show the diagram
$$
\xymatrix{
a \circ l_* \circ l^* \circ b \circ m_* &
a \circ b \circ m_* \ar[l] \\
k_* \circ a' \circ l^* \circ b \circ m_* \ar[u]_{\xi_{top}} & \\
k_* \circ a' \circ l^* \circ l_* \circ b' \ar[u]_{\xi_{bot}} \ar[r] &
k_* \circ a' \circ b' \ar[uu]_{\xi_{rect}}
}
$$
becomes commutative if we invert the arrows $\xi_{top}$, $\xi_{bot}$,
and $\xi_{rect}$ (note that this is different from asking the
diagram to be commutative). However, the diagram
$$
\xymatrix{
& a \circ l_* \circ l^* \circ b \circ m_* \\
a \circ l_* \circ l^* \circ l_* \circ b'
\ar[ru]^{\xi_{bot}} & &
k_* \circ a' \circ l^* \circ b \circ m_* \ar[ul]_{\xi_{top}} \\
& k_* \circ a' \circ l^* \circ l_* \circ b'
\ar[ul]^{\xi_{top}} \ar[ur]_{\xi_{bot}}
}
$$
commutes by Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}.
Since the diagrams
$$
\vcenter{
\xymatrix{
a \circ l_* \circ l^* \circ b \circ m_* & a \circ b \circ m \ar[l] \\
a \circ l_* \circ l^* \circ l_* \circ b' \ar[u] &
a \circ l_* \circ b' \ar[l] \ar[u]
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
a \circ l_* \circ l^* \circ l_* \circ b' \ar[r] & a \circ l_* \circ b' \\
k_* \circ a' \circ l^* \circ l_* \circ b' \ar[u] \ar[r] &
k_* \circ a' \circ b' \ar[u]
}
}
$$
commute (see references cited) and since the composition of
$l_* \to l_* \circ l^* \circ l_* \to l_*$ is the identity,
we find that it suffices to prove that
$$
k \circ a' \circ b' \xrightarrow{\xi_{bot}} a \circ l_* \circ b
\xrightarrow{\xi_{top}} a \circ b \circ m_*
$$
is equal to $\xi_{rect}$ (via the identifications $a \circ b = c$
and $a' \circ b' = c'$). This is the statement dual to
Cohomology, Remark \ref{cohomology-remark-compose-base-change}
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-compose-base-change-maps-horizontal}
Consider a commutative diagram
$$
\xymatrix{
X'' \ar[r]_{g'} \ar[d]_{f''} & X' \ar[r]_g \ar[d]_{f'} & X \ar[d]^f \\
Y'' \ar[r]^{h'} & Y' \ar[r]^h & Y
}
$$
of quasi-compact and quasi-separated schemes where
both diagrams are cartesian and where $f$ and $h$
as well as $f'$ and $h'$ are Tor independent.
Then the maps (\ref{equation-base-change-map})
for the two squares compose to give the base
change map for the outer rectangle (see proof for a precise statement).
\end{lemma}

\begin{proof}
It follows from the assumptions that $f$ and $h \circ h'$ are Tor
independent (details omitted), hence the statement makes sense.
In this proof we write $g^*$ in place of $Lg^*$ and $f_*$ instead
of $Rf_*$. Let $a$, $a'$, and $a''$ be the right adjoints of
Lemma \ref{lemma-twisted-inverse-image}
for $f$, $f'$, and $f''$. The arrow corresponding to the right
square is the composition
$$
\gamma_{right} :
g^* \circ a \to g^* \circ a \circ h_* \circ h^*
\xleftarrow{\xi_{right}} g^* \circ g_* \circ a' \circ h^* \to a' \circ h^*
$$
where $\xi_{right} : g_* \circ a' \to a \circ h_*$
is an isomorphism (hence can be inverted)
and is the arrow ``dual'' to the base change map
$h^* \circ f_* \to f'_* \circ g^*$. The outer arrows come
from the canonical maps $1 \to h_* \circ h^*$ and $g^* \circ g_* \to 1$.
Similarly for the left square we have
$$
\gamma_{left} :
(g')^* \circ a' \to (g')^* \circ a' \circ (h')_* \circ (h')^*
\xleftarrow{\xi_{left}}
(g')^* \circ (g')_* \circ a'' \circ (h')^* \to a'' \circ (h')^*
$$
For the outer rectangle we get
$$
\gamma_{rect} :
k^* \circ a \to
k^* \circ a \circ m_* \circ m^* \xleftarrow{\xi_{rect}}
k^* \circ k_* \circ a'' \circ m^* \to
a'' \circ m^*
$$
where $k = g \circ g'$ and $m = h \circ h'$.
We have $k^* = (g')^* \circ g^*$ and $m^* = (h')^* \circ h^*$.
The statement of the lemma is that $\gamma_{rect}$
is equal to the composition
$$
k^* \circ a =
(g')^* \circ g^* \circ a \xrightarrow{\gamma_{right}}
(g')^* \circ a' \circ h^* \xrightarrow{\gamma_{left}}
a'' \circ (h')^* \circ h^* = a'' \circ m^*
$$
To see this we contemplate the following diagram
$$
\xymatrix{
& (g')^* \circ g^* \circ a \ar[d] \ar[ddl] \\
& (g')^* \circ g^* \circ a \circ h_* \circ h^* \ar[ld] \\
(g')^* \circ g^* \circ a \circ h_* \circ (h')_* \circ (h')^* \circ h^* &
(g')^* \circ g^* \circ g_* \circ a' \circ h^*
\ar[u]_{\xi_{right}} \ar[d] \ar[ld] \\
(g')^* \circ g^* \circ g_* \circ a' \circ (h')_* \circ (h')^* \circ h^*
\ar[u]_{\xi_{right}} \ar[dr] &
(g')^* \circ a' \circ h^* \ar[d] \\
(g')^* \circ g^* \circ g_* \circ (g')_* \circ a'' \circ (h')^* \circ h^*
\ar[u]_{\xi_{left}} \ar[ddr] \ar[dr] &
(g')^* \circ a' \circ (h')_* \circ (h')^* \circ h^* \\
& (g')^*\circ (g')_* \circ a'' \circ (h')^* \circ h^*
\ar[u]_{\xi_{left}} \ar[d] \\
& a'' \circ (h')^* \circ h^*
}
$$
Going down the right hand side we have the composition and going
down the left hand side we have $\gamma_{rect}$.
All the quadrilaterals on the right hand side of this diagram commute
by Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}
or more simply the discussion preceding
Categories, Definition \ref{categories-definition-horizontal-composition}.
Hence we see that it suffices to show that
$$
g_* \circ (g')_* \circ a'' \xrightarrow{\xi_{left}}
g_* \circ a' \circ (h')_* \xrightarrow{\xi_{right}}
a \circ h_* \circ (h')_*
$$
is equal to $\xi_{rect}$. This is the statement dual to
Cohomology, Remark \ref{cohomology-remark-compose-base-change-horizontal}
and the proof is complete.
\end{proof}

\begin{remark}
\label{remark-going-around}
Consider a commutative diagram
$$
\xymatrix{
X'' \ar[r]_{k'} \ar[d]_{f''} & X' \ar[r]_k \ar[d]_{f'} & X \ar[d]^f \\
Y'' \ar[r]^{l'} \ar[d]_{g''} & Y' \ar[r]^l \ar[d]_{g'} & Y \ar[d]^g \\
Z'' \ar[r]^{m'} & Z' \ar[r]^m & Z
}
$$
of quasi-compact and quasi-separated schemes where
all squares are cartesian and where
$(f, l)$, $(g, m)$, $(f', l')$, $(g', m')$ are
Tor independent pairs of maps.
Let $a$, $a'$, $a''$, $b$, $b'$, $b''$ be the
right adjoints of Lemma \ref{lemma-twisted-inverse-image}
for $f$, $f'$, $f''$, $g$, $g'$, $g''$.
Let us label the squares of the diagram $A$, $B$, $C$, $D$
as follows
$$
\begin{matrix}
A & B \\
C & D
\end{matrix}
$$
Then the maps (\ref{equation-base-change-map})
for the squares are (where we use $k^* = Lk^*$, etc)
$$
\begin{matrix}
\gamma_A : (k')^* \circ a' \to a'' \circ (l')^* &
\gamma_B : k^* \circ a \to a' \circ l^* \\
\gamma_C : (l')^* \circ b' \to b'' \circ (m')^* &
\gamma_D : l^* \circ b \to b' \circ m^*
\end{matrix}
$$
For the $2 \times 1$ and $1 \times 2$ rectangles we have four further
base change maps
$$
\begin{matrix}
\gamma_{A + B} : (k \circ k')^* \circ a \to a'' \circ (l \circ l')^* \\
\gamma_{C + D} : (l \circ l')^* \circ b \to b'' \circ (m \circ m')^* \\
\gamma_{A + C} : (k')^* \circ (a' \circ b') \to (a'' \circ b'') \circ (m')^* \\
\gamma_{A + C} : k^* \circ (a \circ b) \to (a' \circ b') \circ m^*
\end{matrix}
$$
By Lemma \ref{lemma-compose-base-change-maps-horizontal} we have
$$
\gamma_{A + B} = \gamma_A \circ \gamma_B, \quad
\gamma_{C + D} = \gamma_C \circ \gamma_D
$$
and by Lemma \ref{lemma-compose-base-change-maps} we have
$$
\gamma_{A + C} = \gamma_C \circ \gamma_A, \quad
\gamma_{B + D} = \gamma_D \circ \gamma_B
$$
Here it would be more correct to write
$\gamma_{A + B} = (\gamma_A \star \text{id}_{l^*}) \circ
(\text{id}_{(k')^*} \star \gamma_B)$ with notation as in
Categories, Section \ref{categories-section-formal-cat-cat}
and similarly for the others. However, we continue the
abuse of notation used in the proofs of
Lemmas \ref{lemma-compose-base-change-maps} and
\ref{lemma-compose-base-change-maps-horizontal}
of dropping $\star$ products with identities as one can figure
out which ones to add as long as the source and target of the
transformation is known.
Having said all of this we find (a priori) two transformations
$$
(k')^* \circ k^* \circ a \circ b
\longrightarrow
a'' \circ b'' \circ (m')^* \circ m^*
$$
namely
$$
\gamma_C \circ \gamma_A \circ \gamma_D \circ \gamma_B =
\gamma_{A + C} \circ \gamma_{B + D}
$$
and
$$
\gamma_C \circ \gamma_D \circ \gamma_A \circ \gamma_B =
\gamma_{C + D} \circ \gamma_{A + B}
$$
The point of this remark is to point out that these transformations
are equal. Namely, to see this it suffices to show that
$$
\xymatrix{
(k')^* \circ a' \circ l^* \circ b \ar[r]_{\gamma_D} \ar[d]_{\gamma_A} &
(k')^* \circ a' \circ b' \circ m^* \ar[d]^{\gamma_A} \\
a'' \circ (l')^* \circ l^* \circ b \ar[r]^{\gamma_D} &
a'' \circ (l')^* \circ b' \circ m^*
}
$$
commutes. This is true by
Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}
or more simply the discussion preceding
Categories, Definition \ref{categories-definition-horizontal-composition}.
\end{remark}






\section{Trace maps for right adjoints to pushforward}
\label{section-trace}

\noindent
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $a : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)$
be the right adjoint as in Lemma \ref{lemma-twisted-inverse-image}. By
Categories, Section \ref{categories-section-adjoint} we obtain a
transformation of functors
$$
\text{Tr}_f : Rf_* \circ a \longrightarrow \text{id}
$$
The defining maps $\text{Tr}_{f, K} : Rf_*a(K) \longrightarrow K$
for $K \in D_\QCoh(\mathcal{O}_Y)$ are sometimes called the {\it trace map}.
This is the map which has the property that the bijection
$$
\Hom_X(L, a(K)) \longrightarrow \Hom_Y(Rf_*L, K)
$$
for $L \in D_\QCoh(\mathcal{O}_X)$ which characterizes the right adjoint
is given by
$$
\varphi \longmapsto \text{Tr}_{f, K} \circ Rf_*\varphi
$$
If $f$ is a proper morphism of Noetherian schemes and $K$ is bounded
below, then Lemma \ref{lemma-proper-noetherian-relative} shows that
the isomorphism
$$
Rf_*R\SheafHom(L, a(K)) \longrightarrow R\SheafHom(Rf_*L, K)
$$
comes about by composition with $\text{Tr}_{f, K}$.
Every trace map we are going to consider in this section will be a
special case of this trace map. Before we discuss some special cases
we show that formation of the trace map commutes with base change.

\begin{lemma}[Trace map and base change]
\label{lemma-trace-map-and-base-change}
Suppose we have a diagram (\ref{equation-base-change}) where $f$ and $g$
are tor independent. Then the maps
$1 \star \text{Tr}_f : Lg^* \circ Rf_* \circ a \to Lg^*$ and
$\text{Tr}_{f'} \star 1 : Rf'_* \circ a' \circ Lg^* \to Lg^*$
agree via the base change maps
$\beta : Lg^* \circ Rf_* \to Rf'_* \circ L(g')^*$
(Cohomology, Remark \ref{cohomology-remark-base-change})
and $\alpha : L(g')^* \circ a \to a' \circ Lg^*$
(\ref{equation-base-change-map}).
More precisely, the diagram
$$
\xymatrix{
Lg^* \circ Rf_* \circ a
\ar[d]_{\beta \star 1} \ar[r]_-{1 \star \text{Tr}_f} &
Lg^* \\
Rf'_* \circ L(g')^* \circ a \ar[r]^{1 \star \alpha} &
Rf'_* \circ a' \circ Lg^* \ar[u]_{\text{Tr}_{f'} \star 1}
}
$$
of transformations of functors commutes.
\end{lemma}

\begin{proof}
In this proof we write $f_*$ for $Rf_*$ and $g^*$ for $Lg^*$ and we
drop $\star$ products with identities as one can figure out which ones
to add as long as the source and target of the transformation is known.
Recall that $\beta : g^* \circ f_* \to f'_* \circ (g')^*$ is an isomorphism
and that $\alpha$ is defined using
the isomorphism $\beta^\vee : g'_* \circ a' \to a \circ g_*$
which is the adjoint of $\beta$, see Lemma \ref{lemma-flat-precompose-pus}
and its proof. First we note that the top horizontal arrow
of the diagram in the lemma is equal to the composition
$$
g^* \circ f_* \circ a \to
g^* \circ f_* \circ a \circ g_* \circ g^* \to
g^* \circ g_* \circ g^* \to g^*
$$
where the first arrow is the unit for $(g^*, g_*)$, the second arrow
is $\text{Tr}_f$, and the third arrow is the counit for $(g^*, g_*)$.
This is a simple consequence of the fact that the composition
$g^* \to g^* \circ g_* \circ g^* \to g^*$ of unit and counit is the identity.
Consider the diagram
$$
\xymatrix{
& g^* \circ f_* \circ a \ar[ld]_\beta \ar[d] \ar[r]_{\text{Tr}_f} & g^* \\
f'_* \circ (g')^* \circ a \ar[dr] &
g^* \circ f_* \circ a \circ g_* \circ g^* \ar[d]_\beta \ar[ru] &
g^* \circ f_* \circ g'_* \circ a' \circ g^* \ar[l]_{\beta^\vee} \ar[d]_\beta &
f'_* \circ a' \circ g^* \ar[lu]_{\text{Tr}_{f'}} \\
& f'_* \circ (g')^* \circ a \circ g_* \circ g^* &
f'_* \circ (g')^* \circ g'_* \circ a' \circ g^* \ar[ru] \ar[l]_{\beta^\vee}
}
$$
In this diagram the two squares commute 
Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}
or more simply the discussion preceding
Categories, Definition \ref{categories-definition-horizontal-composition}.
The triangle commutes by the discussion above. By
Categories, Lemma
\ref{categories-lemma-transformation-between-functors-and-adjoints}
the square
$$
\xymatrix{
g^* \circ f_* \circ g'_* \circ a' \ar[d]_{\beta^\vee} \ar[r]_-\beta &
f'_* \circ (g')^* \circ g'_* \circ a' \ar[d] \\
g^* \circ f_* \circ a \circ g_* \ar[r] &
\text{id}
}
$$
commutes which implies the pentagon in the big diagram commutes.
Since $\beta$ and $\beta^\vee$ are isomorphisms, and since going on
the outside of the big diagram equals
$\text{Tr}_f \circ \alpha \circ \beta$ by definition this proves the lemma.
\end{proof}

\noindent
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $a : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)$
be the right adjoint of $Rf_*$ as in
Lemma \ref{lemma-twisted-inverse-image}. By
Categories, Section \ref{categories-section-adjoint} we obtain a
transformation of functors
$$
\eta_f : \text{id} \to  a \circ Rf_*
$$
which is called the unit of the adjunction.

\begin{lemma}
\label{lemma-unit-and-base-change}
Suppose we have a diagram (\ref{equation-base-change}) where $f$ and $g$
are tor independent. Then the maps
$1 \star \eta_f : L(g')^* \to L(g')^* \circ a \circ Rf_*$ and
$\eta_{f'} \star 1 : L(g')^* \to a' \circ Rf'_* \circ L(g')^*$
agree via the base change maps
$\beta : Lg^* \circ Rf_* \to Rf'_* \circ L(g')^*$
(Cohomology, Remark \ref{cohomology-remark-base-change})
and $\alpha : L(g')^* \circ a \to a' \circ Lg^*$
(\ref{equation-base-change-map}).
More precisely, the diagram
$$
\xymatrix{
L(g')^* \ar[r]_-{1 \star \eta_f} \ar[d]_{\eta_{f'} \star 1} &
L(g')^* \circ a \circ Rf_* \ar[d]^\alpha \\
a' \circ Rf'_* \circ L(g')^* &
a' \circ Lg^* \circ Rf_* \ar[l]_-\beta
}
$$
of transformations of functors commutes.
\end{lemma}

\begin{proof}
This proof is dual to the proof of Lemma \ref{lemma-trace-map-and-base-change}.
In this proof we write $f_*$ for $Rf_*$ and $g^*$ for $Lg^*$ and we
drop $\star$ products with identities as one can figure out which ones
to add as long as the source and target of the transformation is known.
Recall that $\beta : g^* \circ f_* \to f'_* \circ (g')^*$ is an isomorphism
and that $\alpha$ is defined using
the isomorphism $\beta^\vee : g'_* \circ a' \to a \circ g_*$
which is the adjoint of $\beta$, see Lemma \ref{lemma-flat-precompose-pus}
and its proof. First we note that the left vertical arrow
of the diagram in the lemma is equal to the composition
$$
(g')^* \to (g')^* \circ g'_* \circ (g')^* \to
(g')^* \circ g'_* \circ a' \circ f'_* \circ (g')^* \to
a' \circ f'_* \circ (g')^*
$$
where the first arrow is the unit for $((g')^*, g'_*)$, the second arrow
is $\eta_{f'}$, and the third arrow is the counit for $((g')^*, g'_*)$.
This is a simple consequence of the fact that the composition
$(g')^* \to (g')^* \circ (g')_* \circ (g')^* \to (g')^*$
of unit and counit is the identity. Consider the diagram
$$
\xymatrix{
& (g')^* \circ a \circ f_* \ar[r] &
(g')^* \circ a \circ g_* \circ g^* \circ f_*
\ar[ld]_\beta \\
(g')^* \ar[ru]^{\eta_f} \ar[dd]_{\eta_{f'}} \ar[rd] &
(g')^* \circ a \circ g_* \circ f'_* \circ (g')^* &
(g')^* \circ g'_* \circ a' \circ g^* \circ f_*
\ar[u]_{\beta^\vee} \ar[ld]_\beta \ar[d] \\
& (g')^* \circ g'_* \circ a' \circ f'_* \circ (g')^*
\ar[ld] \ar[u]_{\beta^\vee} &
a' \circ g^* \circ f_* \ar[lld]^\beta \\
a' \circ f'_* \circ (g')^*
}
$$
In this diagram the two squares commute 
Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}
or more simply the discussion preceding
Categories, Definition \ref{categories-definition-horizontal-composition}.
The triangle commutes by the discussion above. By the dual of
Categories, Lemma
\ref{categories-lemma-transformation-between-functors-and-adjoints}
the square
$$
\xymatrix{
\text{id} \ar[r] \ar[d] &
g'_* \circ a' \circ g^* \circ f_* \ar[d]^\beta \\
g'_* \circ a' \circ g^* \circ f_* \ar[r]^{\beta^\vee} &
a \circ g_* \circ f'_* \circ (g')^*
}
$$
commutes which implies the pentagon in the big diagram commutes.
Since $\beta$ and $\beta^\vee$ are isomorphisms, and since going on
the outside of the big diagram equals
$\beta \circ \alpha \circ \eta_f$ by definition this proves the lemma.
\end{proof}

\begin{example}
\label{example-trace-affine}
Let $A \to B$ be a ring map. Let $Y = \Spec(A)$ and $X = \Spec(B)$
and $f : X \to Y$ the morphism corresponding to $A \to B$. As seen
in Example \ref{example-affine-twisted-inverse-image}
the right adjoint of
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$
sends an object $K$ of $D(A) = D_\QCoh(\mathcal{O}_Y)$ to $R\Hom(B, K)$ in
$D(B) = D_\QCoh(\mathcal{O}_X)$. The trace map is the map
$$
\text{Tr}_{f, K} : R\Hom(B, K) \longrightarrow R\Hom(A, K) = K
$$
induced by the $A$-module map $A \to B$.
\end{example}

\begin{example}
\label{example-trace-closed-immersion}
If $i : Z \to X$ is closed immersion of Noetherian schemes, then
the diagram
$$
\xymatrix{
i_*a(K) \ar[rr]_-{\text{Tr}_{i, K}} \ar@{=}[d] & &
K \ar@{=}[d] \\
i_*R\SheafHom(\mathcal{O}_Z, K) \ar@{=}[r] &
R\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_Z, K)
\ar[r] & K
}
$$
is commutative for $K \in D_\QCoh^+(\mathcal{O}_X)$.
Here the horizontal equality sign is
Lemma \ref{lemma-sheaf-with-exact-support-ext} and the
lower horizontal arrow is induced by
by the map $\mathcal{O}_X \to i_*\mathcal{O}_Z$. The commutativity
of the diagram is a consequence of
Lemma \ref{lemma-twisted-inverse-image-closed}.
\end{example}



\section{Right adjoint to pushforward and pullback}
\label{section-compare-with-pullback}

\noindent
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $a$ be the right adjoint of pushforward as in
Lemma \ref{lemma-twisted-inverse-image}. There is a canonical map
\begin{equation}
\label{equation-compare-with-pullback}
Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(\mathcal{O}_Y) \longrightarrow a(K)
\end{equation}
functorial in $K$ and compatible with distinguished triangles.
Namely, this map is adjoint to a map
$$
Rf_*(Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(\mathcal{O}_Y)) =
K \otimes^\mathbf{L}_{\mathcal{O}_Y} Rf_*(a(\mathcal{O}_Y))
\longrightarrow K
$$
(equality by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-cohomology-base-change})
for which we use the adjunction map $Rf_*a(\mathcal{O}_Y) \to \mathcal{O}_Y$
and the identity on $K$. This map is an isomorphism for every
perfect object.

\begin{lemma}
\label{lemma-compare-with-pullback-perfect}
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. The map (\ref{equation-compare-with-pullback}) is an isomorphism
for every perfect object $K$ of $D(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
Let $K$ be a perfect object on $Y$ with ``dual'' $K^\wedge$, see
Cohomology, Lemma \ref{cohomology-lemma-dual-perfect-complex}.
For $L \in D_\QCoh(\mathcal{O}_X)$ we have
\begin{align*}
\Hom_{D(\mathcal{O}_Y)}(Rf_*L, K)
& =
\Hom_{D(\mathcal{O}_Y)}(
Rf_*L \otimes^\mathbf{L}_{\mathcal{O}_Y} K^\wedge, \mathcal{O}_Y) \\
& =
\Hom_{D(\mathcal{O}_X)}(
L \otimes^\mathbf{L}_{\mathcal{O}_X} Lf^*K^\wedge, a(\mathcal{O}_Y)) \\
& =
\Hom_{D(\mathcal{O}_X)}(L,
a(\mathcal{O}_Y) \otimes^\mathbf{L}_{\mathcal{O}_X} Lf^*K)
\end{align*}
Hence the result by the Yoneda lemma.
\end{proof}

\begin{lemma}
\label{lemma-restriction-compare-with-pullback}
Suppose we have a diagram (\ref{equation-base-change}) where $f$ and $g$
are tor independent. Let $K \in D_\QCoh(\mathcal{O}_Y)$. The diagram
$$
\xymatrix{
L(g')^*(Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(\mathcal{O}_Y))
\ar[r] \ar[d] & L(g')^*a(K) \ar[d] \\
L(f')^*Lg^*K \otimes_{\mathcal{O}_{X'}}^\mathbf{L} a'(\mathcal{O}_{Y'})
\ar[r] & a'(Lg^*K)
}
$$
commutes where the horizontal arrows are the maps
(\ref{equation-compare-with-pullback}) for $K$ and $Lg^*K$
and the vertical maps are constructed using
Cohomology, Remark \ref{cohomology-remark-base-change} and
(\ref{equation-base-change-map}).
\end{lemma}

\begin{proof}
In this proof we will write $f_*$ for $Rf_*$ and $f^*$ for $Lf^*$, etc,
and we will write $\otimes$ for $\otimes^\mathbf{L}_{\mathcal{O}_X}$, etc.
Let us write (\ref{equation-compare-with-pullback}) as the composition
\begin{align*}
f^*K \otimes a(\mathcal{O}_Y)
& \to
a(f_*(f^*K \otimes a(\mathcal{O}_Y))) \\
& \leftarrow
a(K \otimes f_*a(\mathcal{O}_K)) \\
& \to
a(K \otimes \mathcal{O}_Y) \\
& \to
a(K)
\end{align*}
Here the first arrow is the unit $\eta_f$, the second arrow is $a$
applied to Cohomology, Equation
(\ref{cohomology-equation-projection-formula-map}) which is an
isomorphism by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-cohomology-base-change}, the third arrow is
$a$ applied to $\text{id}_K \otimes \text{Tr}_f$, and the fourth
arrow is $a$ applied to the isomorphism $K \otimes \mathcal{O}_Y = K$.
The proof of the lemma consists in showing that each of these
maps gives rise to a commutative square as in the statement of the lemma.
For $\eta_f$ and $\text{Tr}_f$ this is
Lemmas \ref{lemma-unit-and-base-change} and
\ref{lemma-trace-map-and-base-change}.
For the arrow using Cohomology, Equation
(\ref{cohomology-equation-projection-formula-map})
this is Cohomology, Remark \ref{cohomology-remark-compatible-with-diagram}.
For the multiplication map it is clear. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-compare-on-open}
Let $f : X \to Y$ be a proper morphism of Noetherian schemes. Let $V \subset Y$
be an open such that $f^{-1}(V) \to V$ is an isomorphism. Then for
$K \in D_\QCoh^+(\mathcal{O}_Y)$ the map (\ref{equation-compare-with-pullback})
restricts to an isomorphism over $f^{-1}(V)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-proper-noetherian} the map (\ref{equation-sheafy}) is an
ismorphism for objects of $D_\QCoh^+(\mathcal{O}_Y)$. Hence
Lemma \ref{lemma-restriction-compare-with-pullback} tells us the
restriction of (\ref{equation-compare-with-pullback}) for $K$
to $f^{-1}(V)$ is the map (\ref{equation-compare-with-pullback})
for $K|_V$ and $f^{-1}(V) \to V$. Thus it suffices to show that
the map is an isomorphism when $f$ is the identity morphism. This is clear.
\end{proof}

\begin{lemma}
\label{lemma-transitivity-compare-with-pullback}
Let $f : X \to Y$ and $g : Y \to Z$ be composable morphisms of quasi-compact
and quasi-separated schemes and set $h = g \circ f$. Let $a, b, c$ be the
adjoints of Lemma \ref{lemma-twisted-inverse-image} for $f, g, h$.
For any $K \in D_\QCoh(\mathcal{O}_Z)$ the diagram
$$
\xymatrix{
Lf^*(Lg^*K \otimes_{\mathcal{O}_Y}^\mathbf{L}
b(\mathcal{O}_Z)) \otimes_{\mathcal{O}_X}^\mathbf{L} a(\mathcal{O}_Y)
\ar@{=}[d] \ar[r] &
a(Lg^*K \otimes_{\mathcal{O}_Y}^\mathbf{L} b(\mathcal{O}_Z)) \ar[r] &
a(b(K)) \ar@{=}[d] \\
Lh^*K \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*b(\mathcal{O}_Z)
\otimes_{\mathcal{O}_X}^\mathbf{L} a(\mathcal{O}_Y) \ar[r] &
Lh^*K \otimes_{\mathcal{O}_X}^\mathbf{L} c(\mathcal{O}_Z) \ar[r] &
c(K)
}
$$
is commutative where the arrows are (\ref{equation-compare-with-pullback})
and we have used $Lh^* = Lf^* \circ Lg^*$ and $c = a \circ b$.
\end{lemma}

\begin{proof}
In this proof we will write $f_*$ for $Rf_*$ and $f^*$ for $Lf^*$, etc,
and we will write $\otimes$ for $\otimes^\mathbf{L}_{\mathcal{O}_X}$, etc.
The composition of the top arrows is adjoint to a map
$$
g_*f_*(f^*(g^*K \otimes b(\mathcal{O}_Z)) \otimes a(\mathcal{O}_Y)) \to K
$$
The left hand side is equal to
$K \otimes g_*f_*(f^*b(\mathcal{O}_Z) \otimes a(\mathcal{O}_Y))$ by
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-cohomology-base-change}
and inspection of the definitions shows the map comes from the map
$$
g_*f_*(f^*b(\mathcal{O}_Z) \otimes a(\mathcal{O}_Y))
\xleftarrow{g_*\epsilon}
g_*(b(\mathcal{O}_Z) \otimes f_*a(\mathcal{O}_Y)) \xrightarrow{g_*\alpha}
g_*(b(\mathcal{O}_Z)) \xrightarrow{\beta} \mathcal{O}_Z
$$
tensored with $\text{id}_K$. Here $\epsilon$ is the isomorphism from
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-cohomology-base-change} and
$\beta$ comes from the counit map
$g_*b \to \text{id}$. Similarly, the composition of the lower
horizontal arrows is adjoint to $\text{id}_K$ tensored with the composition 
$$
g_*f_*(f^*b(\mathcal{O}_Z) \otimes a(\mathcal{O}_Y)) \xrightarrow{g_*f_*\delta}
g_*f_*(ab(\mathcal{O}_Z)) \xrightarrow{g_*\gamma}
g_*(b(\mathcal{O}_Z)) \xrightarrow{\beta}
\mathcal{O}_Z
$$
where $\gamma$ comes from the counit map $f_*a \to \text{id}$
and $\delta$ is the map whose adjoint is the composition
$$
f_*(f^*b(\mathcal{O}_Z) \otimes a(\mathcal{O}_Y))
\xleftarrow{\epsilon}
b(\mathcal{O}_Z) \otimes f_*a(\mathcal{O}_Y) \xrightarrow{\alpha}
b(\mathcal{O}_Z)
$$
By general properties of adjoint functors, adjoint maps, and counits
(see Categories, Section \ref{categories-section-adjoint})
we have $\gamma \circ f_*\delta = \alpha \circ \epsilon^{-1}$ as desired.
\end{proof}







\section{Perfect proper morphisms}
\label{section-flat-and-proper}

\noindent
The correct generality for this section would be to consider
perfect proper morphisms of quasi-compact and quasi-separated
schemes, see \cite{LN}. A flat proper morphism of Noetherian
schemes is perfect, see
More on Morphisms, Lemma
\ref{more-morphisms-lemma-flat-finite-presentation-perfect}.

\begin{lemma}
\label{lemma-proper-flat-noetherian}
Let $f : X \to Y$ be a perfect proper morphism of Noetherian schemes.
Let $a$ be the right adjoint for
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of
Lemma \ref{lemma-twisted-inverse-image}. Then $a$ commutes with direct sums.
\end{lemma}

\begin{proof}
Let $P$ be a perfect object of $D(\mathcal{O}_X)$. By
More on Morphisms, Lemma
\ref{more-morphisms-lemma-perfect-proper-perfect-direct-image}
the complex $Rf_*P$ is perfect on $Y$.
Let $K_i$ be a family of objects of $D_\QCoh(\mathcal{O}_Y)$.
Then
\begin{align*}
\Hom_{D(\mathcal{O}_X)}(P, a(\bigoplus K_i))
& =
\Hom_{D(\mathcal{O}_Y)}(Rf_*P, \bigoplus K_i) \\
& =
\bigoplus \Hom_{D(\mathcal{O}_Y)}(Rf_*P, K_i) \\
& =
\bigoplus \Hom_{D(\mathcal{O}_X)}(P, a(K_i))
\end{align*}
because a perfect object is compact (Derived Categories of Schemes,
Proposition \ref{perfect-proposition-compact-is-perfect}).
Since $D_\QCoh(\mathcal{O}_X)$ has a perfect generator
(Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh})
we conclude that the map $\bigoplus a(K_i) \to a(\bigoplus K_i)$
is an isomorphism, i.e., $a$ commutes with direct sums.
\end{proof}

\begin{lemma}
\label{lemma-proper-flat-noetherian-relative}
Let $f : X \to Y$ be a perfect proper morphism of Noetherian schemes.
Let $a$ be the right adjoint for
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of
Lemma \ref{lemma-twisted-inverse-image}. Then
\begin{enumerate}
\item for every closed $T \subset Y$ if $Q \in D_\QCoh(Y)$ is supported on $T$,
then $a(Q)$ is supported on $f^{-1}(T)$,
\item for every open $V \subset Y$ and any $K \in D_\QCoh(\mathcal{O}_Y)$
the map (\ref{equation-sheafy}) is an isomorphism, and
\item the canonical map
$$
Rf_*R\SheafHom(L, a(K)) \longrightarrow R\SheafHom(Rf_*L, K)
$$
is an isomorphism for all $L \in D_\QCoh(\mathcal{O}_X)$ and all
$K \in D_\QCoh(\mathcal{O}_Y)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Arguing exactly as in the proof of
Lemma \ref{lemma-proper-noetherian-relative}
we see that (2) implies (3).
Arguing exactly as in the proof of
Lemma \ref{lemma-when-sheafy}
we see that (1) implies (2).

\medskip\noindent
Proof of (1). We will use the notation $D_{\QCoh, T}(\mathcal{O}_Y)$ and
$D_{\QCoh, f^{-1}(T)}(\mathcal{O}_X)$ to denote complexes
whose cohomology sheaves are supported on $T$ and $f^{-1}(T)$.
By Lemma \ref{lemma-proper-flat-noetherian} the functor $a$ commutes
with direct sums. Hence the strictly full, saturated, triangulated
subcategory $\mathcal{D}$ with objects
$$
\{Q \in D_{\QCoh, T}(\mathcal{O}_Y) \mid
a(Q) \in D_{\QCoh, f^{-1}(T)}(\mathcal{O}_X)\}
$$
is preserved by direct sums (and hence derived colimits).
On the other hand, the
category $D_{\QCoh, T}(\mathcal{O}_Y)$ is generated by a perfect
object $E$ (see Derived Categories of Schemes, Lemma
\ref{perfect-lemma-generator-with-support}).
By Lemma \ref{lemma-proper-noetherian} we see that $E \in \mathcal{D}$.
By Derived Categories, Lemma \ref{derived-lemma-write-as-colimit}
every object $Q$ of $D_{\QCoh, T}(\mathcal{O}_Y)$ is a derived
colimit of a system $Q_1 \to Q_2 \to Q_3 \to \ldots$
such that the cones of the transition maps are direct sums
of shifts of $E$. Arguing by induction we see that
$Q_n \in \mathcal{D}$ for all $n$ and finally that $Q$ is
in $\mathcal{D}$. Thus (1) is true.
\end{proof}

\begin{lemma}
\label{lemma-compare-with-pullback-flat-proper-noetherian}
Let $f : X \to Y$ be a perfect proper morphism of Noetherian
schemes. The map (\ref{equation-compare-with-pullback}) is an isomorphism
for every object $K$ of $D_\QCoh(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-proper-flat-noetherian} we know that $a$ commutes
with direct sums. Hence the collection of objects of
$D_\QCoh(\mathcal{O}_Y)$ for which (\ref{equation-compare-with-pullback})
is an isomorphism is a strictly full, saturated, triangulated
subcategory of $D_\QCoh(\mathcal{O}_Y)$ which is moreover
preserved under taking direct sums. Since $D_\QCoh(\mathcal{O}_Y)$
is a module category (Derived Categories of Schemes, Theorem
\ref{perfect-theorem-DQCoh-is-Ddga}) generated by a single
perfect object (Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh})
we can argue as in
More on Algebra, Remark \ref{more-algebra-remark-P-resolution}
to see that it suffices to prove (\ref{equation-compare-with-pullback})
is an isomorphism for a single perfect object.
However, the result holds for perfect objects, see
Lemma \ref{lemma-compare-with-pullback-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-proper-flat-base-change}
Let $f : X \to Y$ be a flat proper morphism of Noetherian schemes.
Let $g : Y' \to Y$ be a morphism with $Y'$ Noetherian. Then the base
change map (\ref{equation-base-change-map}) is an isomorphism
for all $K \in D_\QCoh(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-proper-flat-noetherian-relative} formation of the
functors $a$ and $a'$ commutes with restriction to opens of $Y$ and $Y'$.
Hence we may assume $Y' \to Y$ is a morphism of affine schemes. In this
case the statement follows from Lemma \ref{lemma-more-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-upper-shriek-P1}
Let $f : X = \mathbf{P}^1_Y \to Y$ be the projection where $Y$ is
a Noetherian scheme. Let $a$ be the right adjoint for
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of
Lemma \ref{lemma-twisted-inverse-image}.
Then $a(\mathcal{O}_Y)$ is isomorphic to $\mathcal{O}_X(-2)[1]$.
\end{lemma}

\begin{proof}
Recall that there is an identification
$Rf_*(\mathcal{O}_X(-2)[1]) = \mathcal{O}_Y$, see
Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-base} or
\ref{coherent-lemma-cohomology-projective-bundle}.
This determines a map $\mathcal{O}_X(-2)[1] \to a(\mathcal{O}_Y)$.
By Lemma \ref{lemma-proper-noetherian} construction of the $a$
is local on the base. In particular, to check that
$\mathcal{O}_X(-2)[1] \to a(\mathcal{O}_Y)$ is an isomorphism, we
may work locally on $Y$. In other words, we may assume $Y$ is affine.
In the affine case the sheaves $\mathcal{O}_X$ and $\mathcal{O}_X(-1)$
generate $D_\QCoh(X)$, see
Derived Categories of Schemes, Lemma \ref{perfect-lemma-generator-P1}.
Hence it suffices to show that the maps
\begin{align*}
H^{-n + 1}(X, \mathcal{O}(-2))
& = 
\Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X[n], \mathcal{O}_X(-2)[1]) \\
& \to
\Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X[n], a(\mathcal{O}_Y)) \\
& =
\Hom_{D(\mathcal{O}_Y)}(Rf_*(\mathcal{O}_X)[n], \mathcal{O}_Y) \\
& =
H^{-n}(Y, \mathcal{O}_Y)
\end{align*}
and
\begin{align*}
H^{-n + 1}(X, \mathcal{O}_X(-1))
& = 
\Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X(-1)[n], \mathcal{O}_X(-2)[1]) \\
& \to
\Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X(-1)[n], a(\mathcal{O}_Y)) \\
& =
\Hom_{D(\mathcal{O}_Y)}(Rf_*(\mathcal{O}_X(-1))[n], \mathcal{O}_Y) \\
& = 0
\end{align*}
(where we used Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring})
are isomorphisms for all $n \in \mathbf{Z}$. This is clear from
the explicit computation of cohomology in
Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring}.
\end{proof}

\begin{example}
\label{example-base-change-wrong}
The base change map (\ref{equation-base-change-map}) is not an
isomorphism if $f$ is perfect proper and $g$ is perfect.
Let $k$ be a field. Let $Y = \mathbf{A}^2_k$ and let $f : X \to Y$
be the blow up of $Y$ in the origin. Denote $E \subset X$ the
exceptional divisor. Then we can factor $f$ as
$$
X \xrightarrow{i} \mathbf{P}^1_Y \xrightarrow{p} Y
$$
This gives a factorization $a = c \circ b$ where
$b$ and $c$ are the right adjoints of
Lemma \ref{lemma-twisted-inverse-image}
for $p$ and $i$. Denote $\mathcal{O}(n)$ the
Serre twist of the structure sheaf on $\mathbf{P}^1_Y$ and
denote $\mathcal{O}_X(n)$ its restriction to $X$.
Note that $X \subset \mathbf{P}^1_Y$ is cut out by
a degree one equation, hence $\mathcal{O}(X) = \mathcal{O}(1)$.
By Lemma \ref{lemma-upper-shriek-P1} we have
$b(\mathcal{O}_Y) = \mathcal{O}(-2)[1]$.
By Lemma \ref{lemma-twisted-inverse-image-closed}
we have
$$
a(\mathcal{O}_Y) = c(b(\mathcal{O}_Y)) =
c(\mathcal{O}(-2)[1]) =
R\SheafHom(\mathcal{O}_X, \mathcal{O}(-2)[1]) =
\mathcal{O}_X(-1)
$$
Last equality by Lemma \ref{lemma-sheaf-with-exact-support-effective-Cartier}.
Let $Y' = \Spec(k)$ be the origin in $Y$. The restriction of
$a(\mathcal{O}_Y)$ to $X' = E = \mathbf{P}^1_k$
is an invertible sheaf of degree $-1$ placed in cohomological
degree $0$. But on the other hand,
$a'(\mathcal{O}_{\Spec(k)}) = \mathcal{O}_E(-2)[1]$
which is an invertible sheaf of degree $-2$ placed in
cohomological degree $-1$, so different. In this example
(4) is the only hypothesis of Lemma \ref{lemma-more-base-change}
which is violated.
\end{example}

\begin{remark}
\label{remark-relative-dualizing-complex}
Let $f : X \to Y$ be a flat proper morphism of Noetherian schemes.
Let $a$ be the adjoint of Lemma \ref{lemma-twisted-inverse-image} for $f$.
In this situation, $\omega_{X/Y}^\bullet = a(\mathcal{O}_Y)$
is sometimes called the {\it relative dualizing complex}
(for reasons that will become clear later). By
Lemma \ref{lemma-compare-with-pullback-flat-proper-noetherian}
there is a functorial isomorphism
$a(K) = Lf^*K \otimes_{\mathcal{O}_X}^\mathbf{L} \omega_{X/Y}^\bullet$
for $K \in D_\QCoh(\mathcal{O}_Y)$. Moreover, the trace map
$$
\text{Tr}_f : Rf_*\omega_{X/Y}^\bullet \to \mathcal{O}_Y
$$
induces the trace map
$$
Rf_*a(K) = Rf_*(Lf^*K \otimes_{\mathcal{O}_X}^\mathbf{L} \omega_{X/Y}^\bullet)
= K \otimes_{\mathcal{O}_Y}^\mathbf{L} Rf_*\omega_{X/Y}^\bullet
\to K
$$
for every $K \in D_\QCoh(\mathcal{O}_Y)$. If $g : Y' \to Y$ is a
morphism of Noetherian schemes and $X' = Y' \times_Y X$, then by
Lemma \ref{lemma-proper-flat-base-change} we have
$\omega_{X'/Y'}^\bullet = L(g')^*\omega_{X/Y}^\bullet$ where $g' : X' \to X$
is the projection and by Lemma \ref{lemma-trace-map-and-base-change}
the trace map
$$
\text{Tr}_{f'} : Rf'_*\omega_{X'/Y'}^\bullet \to \mathcal{O}_{Y'}
$$
for $f' : X' \to Y'$ is the base change of $\text{Tr}_f$ via the
base change isomorphism.
\end{remark}



\section{Effective Cartier divisors}
\label{section-dualizing-Cartier}

\noindent
Let $X$ be a scheme and let $i : D \to X$ be the inclusion of an
effective Cartier divisor. Denote $\mathcal{N} = i^*\mathcal{O}_X(D)$
the normal sheaf of $i$, see
Morphisms, Section \ref{morphisms-section-conormal-sheaf}
and
Divisors, Section \ref{divisors-section-effective-Cartier-divisors}.
Recall that $R\SheafHom(\mathcal{O}_D, -)$
denotes the right adjoint to $i_* : D(\mathcal{O}_D) \to D(\mathcal{O}_X)$
and has the property
$i_*R\SheafHom(\mathcal{O}_D, -) = R\SheafHom(i_*\mathcal{O}_D, -)$,
see Section \ref{section-sections-with-exact-support}.

\begin{lemma}
\label{lemma-compute-for-effective-Cartier}
As above, let $X$ be a scheme and let $D \subset X$ be an
effective Cartier divisor. There is a canonical isomorphism
$R\SheafHom(\mathcal{O}_D, \mathcal{O}_X) = \mathcal{N}[-1]$
in $D(\mathcal{O}_D)$.
\end{lemma}

\begin{proof}
Equivalently, we are saying that $R\SheafHom(\mathcal{O}_D, \mathcal{O}_X)$
has a unique nonzero cohomology sheaf in degree $1$ and that this
sheaf is isomorphic to $\mathcal{N}$. Since $i_*$ is exact and fully
faithful, it suffices to prove that
$i_*R\SheafHom(\mathcal{O}_D, \mathcal{O}_X)$ is isomorphic
to $i_*\mathcal{N}[-1]$. We have
$i_*R\SheafHom(\mathcal{O}_D, \mathcal{O}_X) =
R\SheafHom(i_*\mathcal{O}_D, \mathcal{O}_X)$
by Lemma \ref{lemma-sheaf-with-exact-support-ext}. We have a resolution
$$
0 \to \mathcal{I} \to \mathcal{O}_X \to i_*\mathcal{O}_D \to 0
$$
where $\mathcal{I}$ is the ideal sheaf of $D$
which we can use to compute. Since
$R\SheafHom(\mathcal{O}_X, \mathcal{O}_X) = \mathcal{O}_X$ and
$R\SheafHom(\mathcal{I}, \mathcal{O}_X) = \mathcal{O}_X(D)$ by
a local compuation, we see that
$$
R\SheafHom(i_*\mathcal{O}_D, \mathcal{O}_X) =
(\mathcal{O}_X \to \mathcal{O}_X(D))
$$
where on the right hand side we have $\mathcal{O}_X$ in degree $0$
and $\mathcal{O}_X(D)$ in degree $1$. The result follows from the
short exact sequence
$$
0 \to \mathcal{O}_X \to \mathcal{O}_X(D) \to i_*\mathcal{N} \to 0
$$
coming from the fact that $D$ is the zero scheme of the canonical section
of $\mathcal{O}_X(D)$ and from the fact that
$\mathcal{N} = i^*\mathcal{O}_X(D)$.
\end{proof}

\noindent
For every object $K$ of $D(\mathcal{O}_X)$ there is a canonical map
\begin{equation}
\label{equation-map-effective-Cartier}
Li^*K
\otimes_{\mathcal{O}_D}^\mathbf{L}
R\SheafHom(\mathcal{O}_D, \mathcal{O}_X)
\longrightarrow
R\SheafHom(\mathcal{O}_D, K)
\end{equation}
functorial in $K$ and compatible with distinguished triangles.
Namely, this map is adjoint to a map
$$
i_*(Li^*K \otimes^\mathbf{L}_{\mathcal{O}_D}
R\SheafHom(\mathcal{O}_D, \mathcal{O}_X)) =
K \otimes^\mathbf{L}_{\mathcal{O}_X}
R\SheafHom(i_*\mathcal{O}_D, \mathcal{O}_X)
\longrightarrow K
$$
where the equality is
Cohomology, Lemma \ref{cohomology-lemma-projection-formula-closed-immersion}
and the arrow comes from the canonical map
$R\SheafHom(i_*\mathcal{O}_D, \mathcal{O}_X) \to \mathcal{O}_X$
induced by $\mathcal{O}_X \to i_*\mathcal{O}_D$.

\medskip\noindent
If $K \in D_\QCoh(\mathcal{O}_X)$, then
(\ref{equation-map-effective-Cartier}) is equal to
(\ref{equation-compare-with-pullback}) via the identification
$a(K) = R\SheafHom(\mathcal{O}_D, K)$ of
Lemma \ref{lemma-twisted-inverse-image-closed}.
If $K \in D_\QCoh(\mathcal{O}_X)$ and $X$ is Noetherian, then
the following lemma is a special case of
Lemma \ref{lemma-compare-with-pullback-flat-proper-noetherian}.

\begin{lemma}
\label{lemma-sheaf-with-exact-support-effective-Cartier}
As above, let $X$ be a scheme and let $D \subset X$ be an
effective Cartier divisor. Then (\ref{equation-map-effective-Cartier})
combined with Lemma \ref{lemma-compute-for-effective-Cartier}
defines an isomorphism
$$
Li^*K \otimes_{\mathcal{O}_D}^\mathbf{L} \mathcal{N}[-1]
\longrightarrow
R\SheafHom(\mathcal{O}_D, K)
$$
functorial in $K$ in $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Since $i_*$ is exact and fully faithful on modules, to prove the map is an
isomorphism, it suffices to show that it is an isomorphism after applying
$i_*$. We will use the short exact sequences
$0 \to \mathcal{I} \to \mathcal{O}_X \to i_*\mathcal{O}_D \to 0$
and
$0 \to \mathcal{O}_X \to \mathcal{O}_X(D) \to i_*\mathcal{N} \to 0$
used in the proof of Lemma \ref{lemma-compute-for-effective-Cartier}
without further mention. By
Cohomology, Lemma \ref{cohomology-lemma-projection-formula-closed-immersion}
which was used to define the map (\ref{equation-map-effective-Cartier})
the left hand side becomes
$$
K \otimes_{\mathcal{O}_X}^\mathbf{L} i_*\mathcal{N}[-1] =
K \otimes_{\mathcal{O}_X}^\mathbf{L} (\mathcal{O}_X \to \mathcal{O}_X(D))
$$
The right hand side becomes
\begin{align*}
R\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_D, K) & =
R\SheafHom_{\mathcal{O}_X}((\mathcal{I} \to \mathcal{O}_X), K) \\
& =
R\SheafHom_{\mathcal{O}_X}((\mathcal{I} \to \mathcal{O}_X), \mathcal{O}_X)
\otimes_{\mathcal{O}_X}^\mathbf{L} K
\end{align*}
the final equality by
Cohomology, Lemma \ref{cohomology-lemma-dual-perfect-complex}.
Since the map comes from the isomorphism
$$
R\SheafHom_{\mathcal{O}_X}((\mathcal{I} \to \mathcal{O}_X), \mathcal{O}_X)
= (\mathcal{O}_X \to \mathcal{O}_X(D))
$$
the lemma is clear.
\end{proof}







\section{Compactifications}
\label{section-compactify}

\noindent
We interrupt the flow of the arguments for a little bit of geometry.

\medskip\noindent
Let $S$ be a quasi-compact and quasi-separated scheme. We will say a
scheme $X$ over $S$ {\it has a compactification over $S$} if there exists
an open immersion $X \to \overline{X}$ into a scheme $\overline{X}$
proper over $S$. If $X$ has a compactification over $S$, then $X \to S$
is separated and of finite type. It is a theorem of Nagata (see
\cite{Lutkebohmert}, \cite{Conrad-Nagata}, \cite{Nagata-1},
\cite{Nagata-2}, \cite{Nagata-3}, and \cite{Nagata-4}) that the converse is
true as well (we will give a
precise statement and a proof if we ever need this result).

\medskip\noindent
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $X$ be a scheme over $S$. The category
of {\it compactifications of $X$} is the category whose
objects are open immersions $j : X \to \overline{X}$ over $S$ with
$\overline{X} \to S$ proper and whose morphisms
$(j : X \to \overline{X}') \to (j : X \to \overline{X})$
are morphisms $f : \overline{X} \to \overline{X}$ such that
$f \circ j' = j$.

\begin{lemma}
\label{lemma-compactifications-cofiltered}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $X$ be a compactifyable scheme over $S$.
The category of compactifications of $X$ over $S$ is
cofiltered.
\end{lemma}

\begin{proof}
We have to check conditions (1), (2), (3) of
Categories, Definition \ref{categories-definition-codirected}.
Condition (1) holds exactly because we assumed that $X$
is compactifyable.
Let $j_i : X \to \overline{X}_i$, $i = 1, 2$ be two compactifications.
Then we can consider the scheme theoretic closure $\overline{X}$
of $(j_1, j_2) : X \to \overline{X}_1 \times_S \overline{X}_2$.
This determines a third compactification $j : X \to \overline{X}$
which dominates both $j_i$:
$$
\xymatrix{
(X, \overline{X}_1) & (X, \overline{X}) \ar[l] \ar[r] & (X, \overline{X}_2)
}
$$
Thus (2) holds. Let $f_1, f_2 : \overline{X}_1 \to \overline{X}_2$
be two morphisms between compactifications
$j_i : X \to \overline{X}_i$, $i = 1, 2$.
Let $\overline{X} \subset \overline{X}_1$ be the equalizer of
$f_1$ and $f_2$. As $\overline{X}_2 \to S$ is separated, we see
that $\overline{X}$ is a closed subscheme of $\overline{X}_1$
and hence proper over $S$. Moreover, we obtain an
open immersion $X \to \overline{X}$ because $f_1|_X = f_2|_X = \text{id}_X$.
The morphism $(X \to \overline{X}) \to (j_1 : X \to \overline{X}_1)$
given by the closed immersion $\overline{X} \to \overline{X}_1$
equalizes $f_1$ and $f_2$ which proves condition (3) and
finishes the proof.
\end{proof}

\noindent
We can also consider the category of all compactifications (for varying $X$).
It turns out that this category, localized at the set of morphisms
which induce an isomorphism on the interior
is equivalent to the category of compactifyable schemes over $S$.

\begin{lemma}
\label{lemma-compactifyable}
Let $S$ be a quasi-compact and quasi-separated scheme. Let $f : X \to Y$
be a morphism of schemes over $S$ with $Y$ separated and of finite type
over $S$ and $X$ compactifyable over $S$. Then $X$ has a compactification
over $Y$.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ be a morphism of schemes over $S$ with $Y$ separated
and of finite type over $S$. Let $j : X \to \overline{X}$ be a
compactification of $X$ over $S$. Then we let $\overline{X}'$ be
the scheme theoretic image of $(j, f) : X \to \overline{X} \times_S Y$.
The morphism $\overline{X}' \to Y$ is proper because
$\overline{X} \times_S Y \to Y$ is proper as a base change of
$\overline{X} \to S$. On the other hand, since $Y$ is separated
over $S$, the morphism $(1, f) : X \to X \times_S Y$ is a closed
immersion (Schemes, Lemma \ref{schemes-lemma-semi-diagonal})
and hence $X \to \overline{X}'$ is an open immersion.
\end{proof}

\noindent
Let $S$ be a quasi-compact and quasi-separated scheme.
We define the {\it category of compactifications} to be the category
whose objects are pairs $(X, \overline{X})$ where $\overline{X}$
is a scheme proper over $S$ and $X \subset \overline{X}$ is a
quasi-compact open and whose morphisms
are commutative diagrams
$$
\xymatrix{
X \ar[d] \ar[r]_f & Y \ar[d] \\
\overline{X} \ar[r]^{\overline{f}} & \overline{Y}
}
$$
of morphisms of schemes over $S$.

\begin{lemma}
\label{lemma-right-multiplicative-system}
Let $S$ be a quasi-compact and quasi-separated scheme.
The collection of morphisms
$(u, \overline{u}) : (X', \overline{X}') \to (X, \overline{X})$
such that $u$ is an isomorphism forms a right multiplicative system
(Categories, Definition \ref{categories-definition-multiplicative-system})
of arrows in the category of compactifications.
\end{lemma}

\begin{proof}
Axiom RMS1 is trivial to verrify. Let us check RMS2 holds.
Suppose given a diagram
$$
\xymatrix{
& (X', \overline{X}') \ar[d]_{(u, \overline{u})} \\
(Y, \overline{Y}) \ar[r]^{(f, \overline{f})} & (X, \overline{X})
}
$$
with $u : X' \to X$ an isomorphism. Then we let $Y' = Y \times_X X'$
with the projection map $v : Y' \to Y$ (an isomorphism). We also
set $\overline{Y}' = \overline{Y} \times_{\overline{X}} \overline{X}'$
with the projection map $\overline{v} : \overline{Y}' \to \overline{Y}$
It is clear that $Y' \to \overline{Y}'$ is an open immersion.
The diagram
$$
\xymatrix{
(Y', \overline{Y}') \ar[r]_{(g, \overline{g})} \ar[d]_{(v, \overline{v})} &
(X', \overline{X}') \ar[d]_{(u, \overline{u})} \\
(Y, \overline{Y}) \ar[r]^{(f, \overline{f})} & (X, \overline{X})
}
$$
shows that axiom RMS2 holds.

\medskip\noindent
Let us check RMS3 holds. Suppose given a pair of morphims
$(f, \overline{f}), (g, \overline{g}) :
(X, \overline{X}) \to (Y, \overline{Y})$
of compactifications and a morphism
$(v, \overline{v}) : (Y, \overline{Y}) \to (Y', \overline{Y}')$
such that $v$ is an isomorphism and such that
$(v, \overline{v}) \circ (f, \overline{f}) =
(v, \overline{v}) \circ (g, \overline{g})$. Then $f = g$.
Hence if we let $\overline{X}' \subset \overline{X}$
be the equalizer of $\overline{f}$ and $\overline{g}$,
then $(u, \overline{u}) : (X, \overline{X}') \to (X, \overline{X})$
will be a morphism of the category of compactifications
such that $(f, \overline{f}) \circ (u, \overline{u}) =
(g, \overline{g}) \circ (u, \overline{u})$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-invert-right-multiplicative-system}
Let $S$ be a quasi-compact and quasi-separated scheme.
The functor $(X, \overline{X}) \mapsto X$ defines an
equivalence from the category of compactifications localized
(Categories, Lemma \ref{categories-lemma-right-localization})
at the right
multiplicative system of Lemma \ref{lemma-right-multiplicative-system}
to the category of compactifyable schemes over $S$.
\end{lemma}

\begin{proof}
Denote $\mathcal{C}$ the category of compactifications and
denote $Q : \mathcal{C} \to \mathcal{C}'$ the localization
functor of Categories, Lemma
\ref{categories-lemma-properties-right-localization}.
Denote $\mathcal{D}$ the category of compactifyable schemes
over $S$. It is clear from the lemma just cited and our
choice of multiplicative system that we
obtain a functor $\mathcal{C}' \to \mathcal{D}$.
This functor is clearly essentially surjective.
If $f : X \to Y$ is a morphism of compactifyable
schemes, then we choose an open immersion $Y \to \overline{Y}$
into a scheme proper over $S$, and then we choose an embedding
$X \to \overline{X}$ into a scheme $\overline{X}$ proper over
$\overline{Y}$ (possible by Lemma \ref{lemma-compactifyable}
applied to $X \to \overline{Y}$). This gives a morphism
$(X, \overline{X}) \to (Y, \overline{Y})$ of compactifications
which produces our given morphism $X \to Y$.
Finally, suppose given a pair of morphisms in the
localized category with the same source and target: say
$$
a = ((f, \overline{f}) : (X', \overline{X}') \to (Y, \overline{Y}),
(u, \overline{u}) : (X', \overline{X}') \to (X, \overline{X}))
$$
and
$$
b = ((g, \overline{g}) : (X'', \overline{X}'') \to (Y, \overline{Y}),
(v, \overline{v}) : (X'', \overline{X}'') \to (X, \overline{X}))
$$
which produce the same morphism $X \to Y$ over $S$, in other words
$f \circ u^{-1} = g \circ v^{-1}$. By
Categories, Lemma \ref{categories-lemma-morphisms-right-localization}
we may assume that $(X', \overline{X}') = (X'', \overline{X}'')$
and $(u, \overline{u}) = (v, \overline{v})$. In this case we
can consider the equalizer $\overline{X}''' \subset \overline{X}'$
of $\overline{f}$ and $\overline{g}$. The morphism
$(w, \overline{w}) : (X', \overline{X}''') \to (X', \overline{X}')$ is in
the multiplicative subset and we see that $a = b$ in the localized
category by precomposing with $(w, \overline{w})$.
\end{proof}







\section{Upper shriek functors}
\label{section-upper-shriek}

\noindent
In this section, we construct the functors $f^!$ for morphisms
between compactifyable schemes over a fixed Noetherian base.
As is customary in coherent duality, there are a number of diagrams
that have to be shown to be commutative. We suggest the reader,
after reading the construction, skips the verification of the
lemmas and continues to the next section where we discuss
properties of the upper shriek functors.

\medskip\noindent
Given a morphism $f : X \to Y$ of compactifyable schemes over a Noetherian
base scheme $S$, we will define an exact functor
$$
f^! : D_\QCoh^+(\mathcal{O}_Y) \to D_\QCoh^+(\mathcal{O}_X)
$$
of triangulated categories. Namely, we choose a compactification
$X \to \overline{X}$ over $Y$ which is possible by
Lemma \ref{lemma-compactifyable}. Denote $\overline{f} : \overline{X} \to Y$
the structure morphism. Let
$\overline{a} : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_{\overline{X}})$
be the right adjoint of $R\overline{f}_*$
constructed in Lemma \ref{lemma-twisted-inverse-image}. Then we set
$$
f^!K  = \overline{a}(K)|_X
$$
for $K \in D_\QCoh^+(\mathcal{O}_Y)$. The result is an object of
$D_\QCoh^+(\mathcal{O}_X)$ by
Lemma \ref{lemma-twisted-inverse-image-bounded-below}.

\begin{lemma}
\label{lemma-shriek-well-defined}
Let $f : X \to Y$ be a morphism between compactifyable schemes over a
Noetherian scheme $S$. The functor $f^!$ is, up to canonical isomorphism,
independent of the choice of the compactification.
\end{lemma}

\begin{proof}
Consider the category of compactifications of $X$ over $Y$,
which is cofiltered according to
Lemmas \ref{lemma-compactifications-cofiltered} and \ref{lemma-compactifyable}.
To every choice of a compactification
$$
j : X \to \overline{X},\quad \overline{f} : \overline{X} \to Y
$$
the construction above associates the functor $j^* \circ \overline{a} :
D_\QCoh^+(\mathcal{O}_Y) \to D_\QCoh^+(\mathcal{O}_X)$
where $\overline{a}$ is the right adjoint of $R\overline{f}_*$
constructed in Lemma \ref{lemma-twisted-inverse-image}.

\medskip\noindent
Supppose given a morphism $g : \overline{X}_1 \to \overline{X}_2$
between compactifications $j_i : X \to \overline{X}_i$ over $Y$.
Namely, let $\overline{c}$ be the right adjoint of
Lemma \ref{lemma-twisted-inverse-image} for $g$.
Then $\overline{c} \circ \overline{a}_2 = \overline{a}_1$
because these functors are adjoint to
$R\overline{f}_{2, *} \circ Rg_* = R(\overline{f}_2 \circ g)_*$.
By (\ref{equation-sheafy}) we have a canonical transformation
$$
j_1^* \circ \overline{c} \longrightarrow j_2^*
$$
of functors
$D^+_\QCoh(\mathcal{O}_{\overline{X}_2}) \to D^+_\QCoh(\mathcal{O}_X)$
which is an isomorphism by Lemma \ref{lemma-proper-noetherian}.
The composition
$$
j_1^* \circ \overline{a}_1 \longrightarrow
j_1^* \circ \overline{c} \circ \overline{a}_2 \longrightarrow
j_2^* \circ \overline{a}_2
$$
is an isomorphism of functors which we will denote by $\alpha_g$.

\medskip\noindent
To finish the proof, since the category of compactifications of $X$ over $Y$
is cofiltered, it suffices to show compositions of morphisms of
compactifications of $X$ over $Y$ are turned into compositions of
isomorphisms of functors\footnote{Namely, if $\alpha, \beta : F \to G$
are morphisms of functors and $\gamma : G \to H$ is an isomorphism
of functors such that $\gamma \circ \alpha = \gamma \circ \beta$, then
we conclude $\alpha = \beta$.}. To do this, suppose that
$j_3 : X \to \overline{X}_3$
is a third compactification and that $h : \overline{X}_2 \to \overline{X}_3$
is a morphism of compactifications. Let $\overline{d}$ be the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for $h$.
Then $\overline{d} \circ \overline{a}_3 = \overline{a}_2$
and there is a canonical transformation
$$
j_2^* \circ \overline{d} \longrightarrow j_3^*
$$
of functors
$D^+_\QCoh(\mathcal{O}_{\overline{X}_3}) \to D^+_\QCoh(\mathcal{O}_X)$
for the same reasons as above. Denote $\overline{e}$ the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
for $h \circ g$. There is a canonical transformation
$$
j_1^* \circ \overline{e} \longrightarrow j_3^*
$$
of functors
$D^+_\QCoh(\mathcal{O}_{\overline{X}_3}) \to D^+_\QCoh(\mathcal{O}_X)$
given by (\ref{equation-sheafy}). Spelling things out we have to
show that the composition
$$
\alpha_h \circ \alpha_g :
j_1^* \circ \overline{a}_1 \to
j_1^* \circ \overline{c} \circ \overline{a}_2 \to
j_2^* \circ \overline{a}_2 \to
j_2^* \circ \overline{d} \circ \overline{a}_3 \to
j_3^* \circ \overline{a}_3
$$
is the same as the composition
$$
\alpha_{h \circ g} :
j_1^* \circ \overline{a}_1 \to
j_1^* \circ \overline{e} \circ \overline{a}_3 \to
j_3^* \circ \overline{a}_3
$$
We split this into two parts. The first is to show that the diagram
$$
\xymatrix{
\overline{a}_1 \ar[r] \ar[d] & \overline{c} \circ \overline{a}_2 \ar[d] \\
\overline{e} \circ \overline{a}_3 \ar[r] &
\overline{c} \circ \overline{d} \circ \overline{a}_3
}
$$
commutes where the lower horizontal arrow comes from the identification
$\overline{e} = \overline{c} \circ \overline{d}$. This is true
because the corresponding diagram of total direct image functors
$$
\xymatrix{
R\overline{f}_{1, *} \ar[r] \ar[d] & Rg_* \circ R\overline{f}_{2, *} \ar[d] \\
R(h \circ g)_* \circ R\overline{f}_{3, *} \ar[r] &
Rg_* \circ Rh_* \circ R\overline{f}_{3, *}
}
$$
is commutative (insert future reference here). The second part
is to show that the composition
$$
j_1^* \circ \overline{c} \circ \overline{d} \to
j_2^* \circ \overline{d} \to j_3^*
$$
is equal to the map
$$
j_1^* \circ \overline{e} \to j_3^*
$$
via the identification $\overline{e} = \overline{c} \circ \overline{d}$.
This was proven in Lemma \ref{lemma-compose-base-change-maps}
(note that in the current case the morphisms $f', g'$ of that
lemma are equal to $\text{id}_X$).
\end{proof}

\begin{lemma}
\label{lemma-upper-shriek-composition}
Let $f : X \to Y$ and $g : Y \to Z$ be composable
morphisms between compactifyable
schemes over a Noetherian scheme $S$. Then there is a canonical
isomorphism $(g \circ f)^! \to f^! \circ g^!$.
\end{lemma}

\begin{proof}
Choose a compactification $i : Y \to \overline{Y}$ of $Y$ over $Z$.
Choose a compactification $X \to \overline{X}$ of $X$ over
$\overline{Y}$. This uses Lemma \ref{lemma-compactifyable} twice.
Let $\overline{a}$ be the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
$\overline{X} \to \overline{Y}$ and let $\overline{b}$
be the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
$\overline{Y} \to Z$.
Then $\overline{a} \circ \overline{b}$ is the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
the composition $\overline{X} \to Z$.
Hence $g^! = j_Y^* \circ \overline{b}$ and
$(g \circ f)^! = (X \to \overline{X})^* \circ \overline{a} \circ \overline{b}$.
Let $U$ be the inverse image of $Y$ in $\overline{X}$
so that we get the commutative diagram
$$
\xymatrix{
X \ar[r]_j \ar[d] & U \ar[dl] \ar[r]_{j'} & \overline{X} \ar[dl] \\
Y \ar[r]_i \ar[d] & \overline{Y} \ar[dl] \\
Z
}
$$
Let $\overline{a}'$ be the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
$U \to Y$.
Then $f^! = j^* \circ \overline{a}'$. We obtain
$$
\gamma : (j')^* \circ \overline{a} \to \overline{a}' \circ j_Y^*
$$
by (\ref{equation-sheafy}) and we can use it to define
$$
(g \circ f)^! =
j_X^* \circ \overline{a} \circ \overline{b} =
j^* \circ (j')^* \circ \overline{a} \circ \overline{b}
\to
j^* \circ \overline{a}' \circ j_Y^* \circ \overline{b} =
f^! \circ g^!
$$
which is an isomorphism on objects of $D_\QCoh^+(\mathcal{O}_Z)$ by
Lemma \ref{lemma-proper-noetherian}. To finish the proof we show that
this isomorphism is independent of choices made.

\medskip\noindent
Suppose we have two diagrams
$$
\vcenter{
\xymatrix{
X \ar[r]_{j_1} \ar[d] & U_1 \ar[dl] \ar[r]_{j'_1} & \overline{X}_1 \ar[dl] \\
Y \ar[r]_{i_1} \ar[d] & \overline{Y}_1 \ar[dl] \\
Z
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
X \ar[r]_{j_2} \ar[d] & U_2 \ar[dl] \ar[r]_{j'_2} & \overline{X}_2 \ar[dl] \\
Y \ar[r]_{i_2} \ar[d] & \overline{Y}_2 \ar[dl] \\
Z
}
}
$$
We can first choose a compactification $i : Y \to \overline{Y}$
of $Y$ over $Z$ which dominates both $\overline{Y}_1$ and $\overline{Y}_2$,
see Lemma \ref{lemma-compactifications-cofiltered}.
By Lemma \ref{lemma-right-multiplicative-system} and
Categories, Lemmas \ref{categories-lemma-morphisms-right-localization} and
\ref{categories-lemma-equality-morphisms-right-localization}
we can choose a compactification $X \to \overline{X}$ of
$X$ over $\overline{Y}$ with morphisms $\overline{X} \to \overline{X}_1$
and $\overline{X} \to \overline{X}_2$ and such that the composition
$\overline{X} \to \overline{Y} \to \overline{Y}_1$ is equal to
the composition $\overline{X} \to \overline{X}_1 \to \overline{Y}_1$
and such that the composition
$\overline{X} \to \overline{Y} \to \overline{Y}_2$ is equal to
the composition $\overline{X} \to \overline{X}_2 \to \overline{Y}_2$.
Thus we see that it suffices to compare the maps
determined by our diagrams when we have a commutative diagram
as follows
$$
\xymatrix{
X \ar[rr]_{j_1} \ar@{=}[d] & &
U_1 \ar[d] \ar[ddll] \ar[rr]_{j'_1} & &
\overline{X}_1 \ar[d] \ar[ddll] \\
X \ar'[r][rr]^-{j_2} \ar[d] & &
U_2 \ar'[dl][ddll] \ar'[r][rr]^-{j'_2} & &
\overline{X}_2 \ar[ddll] \\
Y \ar[rr]^{i_1} \ar@{=}[d] & & \overline{Y}_1 \ar[d] \\
Y \ar[rr]^{i_2} \ar[d] & & \overline{Y}_2 \ar[dll] \\
Z
}
$$
We use $\overline{a}_i$, $\overline{a}'_i$, $\overline{c}$, and
$\overline{c}'$ for the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
$\overline{X}_i \to \overline{Y}_i$, $U_i \to Y$,
$\overline{X}_1 \to \overline{X}_2$, and $U_1 \to U_2$.
Each of the squares
$$
\xymatrix{
X \ar[r] \ar[d] \ar@{}[dr]|A & U_1 \ar[d] \\
X \ar[r] & U_2
}
\quad
\xymatrix{
U_2 \ar[r] \ar[d] \ar@{}[dr]|B & \overline{X}_2 \ar[d] \\
Y \ar[r] & \overline{Y}_2
}
\quad
\xymatrix{
U_1 \ar[r] \ar[d] \ar@{}[dr]|C & \overline{X}_1 \ar[d] \\
Y \ar[r] & \overline{Y}_1
}
\quad
\xymatrix{
Y \ar[r] \ar[d] \ar@{}[dr]|D & \overline{Y}_1 \ar[d] \\
Y \ar[r] & \overline{Y}_2
}
\quad
\xymatrix{
X \ar[r] \ar[d] \ar@{}[dr]|E & \overline{X}_1 \ar[d] \\
X \ar[r] & \overline{X}_2
}
$$
gives rise to a base change map (\ref{equation-sheafy}) as follows
$$
\begin{matrix}
\gamma_A : j_1^* \circ \overline{c}' \to j_2^* &
\gamma_B : (j_2')^* \circ \overline{a}_2 \to \overline{a}'_2 \circ i_2^* &
\gamma_C : (j_1')^* \circ \overline{a}_1 \to \overline{a}'_1 \circ i_1^* \\
\gamma_D : i_1^* \circ \overline{d} \to i_2^* &
\gamma_E : (j'_1 \circ j_1)^* \circ \overline{c} \to (j'_2 \circ j_2)^*
\end{matrix}
$$
Denote $f_1^! = j_1^* \circ \overline{a}'_1$,
$f_2^! = j_2^* \circ \overline{a}'_2$,
$g_1^! = i_1^* \circ \overline{b}_1$,
$g_2^! = i_2^* \circ \overline{b}_2$,
$(g \circ f)_1^! =
(j_1' \circ j_1)^* \circ \overline{a}_1 \circ \overline{b}_1$, and
$(g \circ f)^!_2 =
(j_2' \circ j_2)^* \circ \overline{a}_2 \circ \overline{b}_2$.
The construction given in the first paragraph of the proof
and in Lemma \ref{lemma-shriek-well-defined} uses
\begin{enumerate}
\item $\gamma_C$ for the map $(g \circ f)^!_1 \to f_1^! \circ g_1^!$,
\item $\gamma_B$ for the map $(g \circ f)^!_2 \to f_2^! \circ g_2^!$,
\item $\gamma_A$ for the map $f_1^! \to f_2^!$,
\item $\gamma_D$ for the map $g_1^! \to g_2^!$, and
\item $\gamma_E$ for the map $(g \circ f)^!_1 \to (g \circ f)^!_2$.
\end{enumerate}
We have to show that the diagram
$$
\xymatrix{
(g \circ f)^!_1 \ar[r]_{\gamma_E} \ar[d]_{\gamma_C} &
(g \circ f)^!_2 \ar[d]_{\gamma_B} \\
f_1^! \circ g_1^! \ar[r]^{\gamma_A \circ \gamma_D} & f_2^! \circ g_2^!
}
$$
is commutative. We will use
Lemmas \ref{lemma-compose-base-change-maps} and
\ref{lemma-compose-base-change-maps-horizontal}
and with (abuse of) notation as in
Remark \ref{remark-going-around} (in particular
dropping $\star$ products with identity transformations
from the notation).
We can write $\gamma_E = \gamma_A \circ \gamma_F$ where
$$
\xymatrix{
U_1 \ar[r] \ar[d] \ar@{}[rd]|F & \overline{X}_1 \ar[d] \\
U_2 \ar[r] & \overline{X}_2
}
$$
Thus we see that
$$
\gamma_B \circ \gamma_E = \gamma_B \circ \gamma_A  \circ \gamma_F
= \gamma_A \circ \gamma_B \circ \gamma_F
$$
the last equality because the two squares $A$ and $B$ only
intersect in one point (similar to the last argument in
Remark \ref{remark-going-around}). Thus it suffices to prove that
$\gamma_D \circ \gamma_C = \gamma_B \circ \gamma_F$.
Since both of these are equal to the map (\ref{equation-sheafy})
for the square
$$
\xymatrix{
U_1 \ar[r] \ar[d] & \overline{X}_1 \ar[d] \\
Y \ar[r] & \overline{Y}_2
}
$$
we conclude.
\end{proof}

\begin{lemma}
\label{lemma-pseudo-functor}
Let $S$ be a Noetherian scheme. The constructions of
Lemmas \ref{lemma-shriek-well-defined} and \ref{lemma-upper-shriek-composition}
define a pseudo functor from the category of
compactifyable schemes over $S$ into the $2$-category of
categories (see Categories, Definition
\ref{categories-definition-functor-into-2-category}).
\end{lemma}

\begin{proof}
To show this we have to prove given morphisms
$f : X \to Y$, $g : Y \to Z$, $h : Z \to T$
that
$$
\xymatrix{
(h \circ g \circ f)^! \ar[r]_{\gamma_{A + B}} \ar[d]_{\gamma_{B + C}} &
f^! \circ (h \circ g)^! \ar[d]^{\gamma_C} \\
(g \circ f)^! \circ h^! \ar[r]^{\gamma_A} & f^! \circ g^! \circ h^!
}
$$
is commutative (for the meaning of the $\gamma$'s, see below).
To do this we choose a compactification $\overline{Z}$
of $Z$ over $T$, then a compactification $\overline{Y}$ of $Y$ over
$\overline{Z}$, and then a compactification $\overline{X}$ of
$X$ over $\overline{Y}$. This uses Lemma \ref{lemma-compactifyable} thrice.
Let $W \subset \overline{Y}$ be the inverse image of $Z$ under
$\overline{Y} \to \overline{Z}$ and let $U \subset V \subset \overline{X}$
be the inverse images of $Y \subset W$ under $\overline{X} \to \overline{Y}$.
This produces the following diagram
$$
\xymatrix{
X \ar[d]_f \ar[r] & U \ar[r] \ar[d] \ar@{}[dr]|A &
V \ar[d] \ar[r] \ar@{}[rd]|B & \overline{X} \ar[d] \\
Y \ar[d]_g \ar[r] & Y \ar[r] \ar[d] & W \ar[r] \ar[d] \ar@{}[rd]|C &
\overline{Y} \ar[d] \\
Z \ar[d]_h \ar[r] & Z \ar[d] \ar[r] & Z \ar[d] \ar[r] & \overline{Z} \ar[d] \\
T \ar[r] & T \ar[r] & T \ar[r] & T
}
$$
Without introducing tons of notation but arguing exactly
as in the proof of Lemma \ref{lemma-upper-shriek-composition}
we see that the maps in the first displayed diagram use the
maps (\ref{equation-sheafy}) for the rectangles
$A + B$, $B + C$, $A$, and $C$ as indicated. Since by
Lemmas \ref{lemma-compose-base-change-maps} and
\ref{lemma-compose-base-change-maps-horizontal}
we have $\gamma_{A + B} = \gamma_A \circ \gamma_B$ and
$\gamma_{B + C} = \gamma_C \circ \gamma_B$  we conclude
that the desired equality holds provided
$\gamma_A \circ \gamma_C = \gamma_C \circ \gamma_A$.
This is true because the two squares $A$ and $C$ only
intersect in one point (similar to the last argument in
Remark \ref{remark-going-around}).
\end{proof}

\begin{lemma}
\label{lemma-map-pullback-to-shriek-well-defined}
Let $f : X \to Y$ be a morphism between compactifyable schemes over a
Noetherian scheme $S$. There are canonical maps
$$
\mu_{f, K} :
Lf^*K \otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y
\longrightarrow
f^!K
$$
functorial in $K$ in $D^+_\QCoh(\mathcal{O}_Y)$.
If $g : Y \to Z$ is another morphism between compactifyable schemes, then
the diagram
$$
\xymatrix{
Lf^*(Lg^*K \otimes_{\mathcal{O}_Y}^\mathbf{L} g^!\mathcal{O}_Z)
\otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y
\ar@{=}[d] \ar[r]_-{\mu_f} &
f^!(Lg^*K \otimes_{\mathcal{O}_Y}^\mathbf{L} g^!\mathcal{O}_Z)
\ar[r]_-{f^!\mu_g} &
f^!g^!K \ar@{=}[d] \\
Lf^*Lg^*K \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^* g^!\mathcal{O}_Z
\otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y \ar[r]^-{\mu_f} &
Lf^*Lg^*K \otimes_{\mathcal{O}_X}^\mathbf{L} f^!g^!\mathcal{O}_Z
\ar[r]^-{\mu_{g \circ f}} & f^!g^!K
}
$$
commutes for all $K \in D^+_\QCoh(\mathcal{O}_Z)$.
\end{lemma}

\begin{proof}
If $f$ is proper, then $f^! = a$ and we can use
(\ref{equation-compare-with-pullback}) and if $g$ is also proper,
then Lemma \ref{lemma-transitivity-compare-with-pullback} proves
the commutativity of the diagram (in greater generality).

\medskip\noindent
In general, choose a compactification $j : X \to \overline{X}$
of $X$ over $Y$. Since $f^!$ is defined as $j^* \circ \overline{a}$
we obtain $\mu_f$ as the restriction of the map
(\ref{equation-compare-with-pullback})
$$
L\overline{f}^*K \otimes_{\mathcal{O}_{\overline{X}}}^\mathbf{L}
\overline{a}(\mathcal{O}_Y)
\longrightarrow
\overline{a}(K)
$$
to $X$. To see this is independent of the choice of the compactification,
we may assume given a morphism $g : \overline{X}_1 \to \overline{X}_2$
between compactifications $j_i : X \to \overline{X}_i$ over $Y$.
But now we know that the maps
$$
L\overline{f}_1^*K \otimes_{\mathcal{O}_{\overline{X}}}^\mathbf{L}
\overline{a}_1(\mathcal{O}_Y)
\longrightarrow
\overline{a}_1(K)
\quad\text{and}\quad
L\overline{f}_2^*K \otimes_{\mathcal{O}_{\overline{X}}}^\mathbf{L}
\overline{a}_2(\mathcal{O}_Y)
\longrightarrow
\overline{a}_2(K)
$$
fit into a commutative diagram by
Lemma \ref{lemma-transitivity-compare-with-pullback}
with two other maps given by $\mu_g$ which restrict to an
isomorphism on $X$ by Lemma \ref{lemma-compare-on-open}.
This implies the two displayed maps above restrict to the
same map on the open, via the identification
$\overline{a}_1(K)|_X = \overline{a}_2(K)|_X$ used in the definition
of $f^!$. Having said this, the commutativity of the diagram
follows from the construction of the isomorphism
$(g \circ f)^! \to f^! \circ g^!$ (first part of the proof of
Lemma \ref{lemma-upper-shriek-composition} using
$\overline{X} \to \overline{Y} \to Z$) and the result
of Lemma \ref{lemma-transitivity-compare-with-pullback}
for $\overline{X} \to \overline{Y} \to Z$.
\end{proof}



\section{Properties of upper shriek functors}
\label{section-upper-shriek-properties}

\noindent
Here are some properties of the upper shriek functors.

\begin{lemma}
\label{lemma-shriek-open-immersion}
Let $S$ be a Noetherian scheme. Let $Y$ be a compactifyable
scheme over $S$ and let $j : X \to Y$ be an open immersion.
Then there is a canonical isomorphism $j^! = j^*$ of functors.
\end{lemma}

\begin{proof}
In this case we may choose $\overline{X} = Y$ as our compactification.
Then the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
$\text{id} : Y \to Y$ is the
identity functor and hence $j^! = j^*$ by definition.
\end{proof}

\begin{lemma}
\label{lemma-shriek-affine-line}
Let $S$ be a Noetherian scheme. Let $Y$ be a compactifyable
scheme over $S$ and let $f : X = \mathbf{A}^1_Y \to Y$ be
the projection. Then there is a (noncanonical) isomorphism
$f^!(-) \cong Lf^*(-) [1]$ of functors.
\end{lemma}

\begin{proof}
Since $X = \mathbf{A}^1_Y \subset \mathbf{P}^1_Y$
and since $\mathcal{O}_{\mathbf{P}^1_Y}(-2)|_X \cong \mathcal{O}_X$
this follows from Lemmas \ref{lemma-upper-shriek-P1} and
\ref{lemma-compare-with-pullback-flat-proper-noetherian}.
\end{proof}

\begin{lemma}
\label{lemma-shriek-closed-immersion}
Let $S$ be a Noetherian scheme. Let $Y$ be a compactifyable
scheme over $S$ and let $i : X \to Y$ be a closed immersion.
Then there is a canonical isomorphism
$i^!(-) = R\SheafHom(\mathcal{O}_X, -)$ of functors.
\end{lemma}

\begin{proof}
This is a restatement of Lemma \ref{lemma-twisted-inverse-image-closed}.
\end{proof}

\begin{lemma}
\label{lemma-shriek-coherent}
Let $S$ be a Noetherian scheme. Let $f : X \to Y$ be a morphism
of compactifyable schemes over $S$. Then $f^!$ maps
$D_{\textit{Coh}}^+(\mathcal{O}_Y)$ into $D_{\textit{Coh}}^+(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
The question is local on $X$ hence we may assume that $X$ and $Y$ are
affine schemes. In this case we can factor $f : X \to Y$ as
$$
X \xrightarrow{i} \mathbf{A}^n_Y \to \mathbf{A}^{n - 1}_Y \to \ldots \to
\mathbf{A}^1_Y \to Y
$$
where $i$ is a closed immersion. The lemma follows from
By Lemmas \ref{lemma-shriek-affine-line},
\ref{lemma-dualizing-polynomial-ring},
\ref{lemma-sheaf-with-exact-support-coherent} and induction.
\end{proof}

\begin{lemma}
\label{lemma-shriek-dualizing}
Let $S$ be a Noetherian scheme. Let $f : X \to Y$ be a morphism
of compactifyable schemes over $S$. If $K$ is a dualizing complex
for $Y$, then $f^!K$ is a dualizing complex for $X$.
\end{lemma}

\begin{proof}
The question is local on $X$ hence we may assume that $X$ and $Y$ are
affine schemes mapping into an affine open of $S$. In this case
we can factor $f : X \to Y$ as
$$
X \xrightarrow{i} \mathbf{A}^n_Y \to \mathbf{A}^{n - 1}_Y \to \ldots \to
\mathbf{A}^1_Y \to Y
$$
where $i$ is a closed immersion. By Lemmas \ref{lemma-shriek-affine-line} and
\ref{lemma-dualizing-polynomial-ring} and induction we see that
the $p^!K$ is a dualizing complex on $\mathbf{A}^n_Y$ where
$p : \mathbf{A}^n_Y \to Y$ is the projection. Similarly, by
Lemmas \ref{lemma-dualizing-quotient},
\ref{lemma-sheaf-with-exact-support-quasi-coherent}, and
\ref{lemma-shriek-closed-immersion} we see that $i^!$
transforms dualizing complexes into dualizing complexes.
\end{proof}

\begin{lemma}
\label{lemma-shriek-via-duality}
Let $S$ be a Noetherian scheme. Let $f : X \to Y$ be a morphism
of compactifyable schemes over $S$. Let $K$ be a dualizing complex
on $Y$. Set $D_Y(M) = R\SheafHom_{\mathcal{O}_Y}(M, K)$ for
$M \in D_{\textit{Coh}}(\mathcal{O}_Y)$ and
$D_X(E) = R\SheafHom_{\mathcal{O}_X}(E, f^!K)$ for
$E \in D_{\textit{Coh}}(\mathcal{O}_X)$. Then there is a canonical
isomorphism
$$
f^!M \longrightarrow D_X(Lf^*D_Y(M))
$$
for $M \in D_{\textit{Coh}}^+(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
Choose compactification $j : X \subset \overline{X}$ of $X$ over $Y$
(Lemma \ref{lemma-compactifyable}). Let $a$ be the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
$\overline{X} \to Y$. Set
$D_{\overline{X}}(E) = R\SheafHom_{\mathcal{O}_{\overline{X}}}(E, a(K))$
for $E \in D_{\textit{Coh}}(\mathcal{O}_{\overline{X}})$.
Since formation of $R\SheafHom$ commutes with restriction to opens
and since $f^! = j^* \circ a$ we see that it suffices to prove that
there is a canonical isomorphism
$$
a(M) \longrightarrow D_{\overline{X}}(L\overline{f}^*D_Y(M))
$$
for $M \in D_{\textit{Coh}}(\mathcal{O}_Y)$. For
$F \in D_\QCoh(\mathcal{O}_X)$ we have
\begin{align*}
\Hom_{\overline{X}}(
F, D_{\overline{X}}(L\overline{f}^*D_Y(M)))
& =
\Hom_{\overline{X}}(
F \otimes_{\mathcal{O}_X}^\mathbf{L} L\overline{f}^*D_Y(M), a(K)) \\
& =
\Hom_Y(
R\overline{f}_*(F \otimes_{\mathcal{O}_X}^\mathbf{L} L\overline{f}^*D_Y(M)),
K) \\
& =
\Hom_Y(
R\overline{f}_*(F) \otimes_{\mathcal{O}_Y}^\mathbf{L} D_Y(M),
K) \\
& =
\Hom_Y(
R\overline{f}_*(F), D_Y(D_Y(M))) \\
& =
\Hom_Y(R\overline{f}_*(F), M) \\
& = \Hom_{\overline{X}}(F, a(M))
\end{align*}
The first equality by Cohomology, Lemma \ref{cohomology-lemma-internal-hom}.
The second by definition of $a$.
The third by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-cohomology-base-change}.
The fourth equality by Cohomology, Lemma \ref{cohomology-lemma-internal-hom}
and the definition of $D_Y$.
The fifth equality by Lemma \ref{lemma-dualizing-schemes}.
The final equality by definition of $a$.
Hence we see that $a(M) = D_{\overline{X}}(L\overline{f}^*D_Y(M))$
by Yoneda's lemma.
\end{proof}

\begin{lemma}
\label{lemma-perfect-comparison-shriek}
Let $S$ be a Noetherian scheme. Let $f : X \to Y$ be a perfect
(e.g., flat) morphism of compactifyable schemes over $S$. Then
\begin{enumerate}
\item $f^!$ maps $D_{\textit{Coh}}^b(\mathcal{O}_Y)$ into
$D_{\textit{Coh}}^b(\mathcal{O}_X)$,
\item the map
$\mu_{f,  K} :
Lf^*K \otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y
\to
f^!K$
of Lemma \ref{lemma-map-pullback-to-shriek-well-defined}
is an isomorphism for all $K \in D_\QCoh^+(\mathcal{O}_Y)$.
\end{enumerate}
\end{lemma}

\begin{proof}
(A flat morphism of finite presentation is perfect, see
More on Morphisms, Lemma
\ref{more-morphisms-lemma-flat-finite-presentation-perfect}.)
We begin with a series of preliminary remarks.
\begin{enumerate}
\item We already know that $f^!$ sends $D_{\textit{Coh}}^+(\mathcal{O}_Y)$
into $D_{\textit{Coh}}^+(\mathcal{O}_X)$, see
Lemma \ref{lemma-shriek-coherent}.
\item If $f$ is an open immersion, then (1) and (2) are true because
we can take $\overline{X} = Y$ in the construction of $f^!$ and $\mu_f$.
See also Lemma \ref{lemma-shriek-open-immersion}.
\item If $f$ is a perfect proper morphism, then (2) is true by
Lemma \ref{lemma-compare-with-pullback-flat-proper-noetherian}.
\item If there exists an open covering $X = \bigcup U_i$ and (1) is
true for $U_i \to Y$, then (1) is true for $X \to Y$. Same for (2).
This holds because the construction of $f^!$ and $\mu_f$ commutes
with passing to open subschemes.
\item If $g : Y \to Z$ is a second perfect morphism of compactifyable
schemes over $S$ and (2) holds for $f$ and $g$, then
$f^!g^!\mathcal{O}_Z =
Lf^*g^!\mathcal{O}_Z \otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y$
and (2) holds for $f$ by the commutative diagram
of Lemma \ref{lemma-map-pullback-to-shriek-well-defined}.
\item If (1) and (2) hold for both $f$ and $g$, then
(1) and (2) hold for $g \circ f$. Namely, then $f^!g^!\mathcal{O}_Z$
is bounded above (by the previous point) and $L(g \circ f)^*$ has finite
cohomological dimension and (1) follows from (2) which we saw above.
\end{enumerate}
From these points we see it suffices to prove the result in case $X$ is affine.
Choose an immersion $X \to \mathbf{A}^n_Y$
(Morphisms, Lemma \ref{morphisms-lemma-quasi-affine-finite-type-over-S})
which we factor as $X \to U \to \mathbf{A}^n_Y \to Y$ where $X \to U$
is a closed immersion and $U \subset \mathbf{A}^n_Y$ is open.
Note that $X \to U$ is a perfect closed immersion by
More on Morphisms, Lemma \ref{more-morphisms-lemma-perfect-permanence}.
Thus it suffices to prove the lemma for a perfect closed immersion
and for the projection $\mathbf{A}^n_Y \to Y$.

\medskip\noindent
Let $f : X \to Y$ be a perfect closed immersion. We already know (2) holds.
Let $K \in D^b_{\textit{Coh}}(\mathcal{O}_Y)$.
Then $f^!K = R\SheafHom(\mathcal{O}_X, K)$
(Lemma \ref{lemma-shriek-closed-immersion})
and $f_*f^!K = R\SheafHom(f_*\mathcal{O}_X, K)$.
Since $f$ is perfect, the complex $f_*\mathcal{O}_X$ is perfect
and hence $R\SheafHom(f_*\mathcal{O}_X, K)$ is bounded above.
This proves that (1) holds. Some details omittted.

\medskip\noindent
Let $f : \mathbf{A}^n_Y \to Y$ be the projection. Then (1) holds
by repeated application of Lemma \ref{lemma-shriek-affine-line}.
Finally, (2) is true because it holds for $\mathbf{P}^n_Y \to Y$
(flat and proper) and because $\mathbf{A}^n_Y \subset \mathbf{P}^n_Y$
is an open.
\end{proof}

\begin{lemma}
\label{lemma-lci-shriek}
Let $S$ be a Noetherian scheme. Let $f : X \to Y$ be a local complete
intersection morphism of compactifyable schemes over $S$. Then $f^!$
maps perfect complexes to perfect complexes.
\end{lemma}

\begin{proof}
Recall that a local complete intersection morphism is perfect, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-lci-properties}.
By Lemma \ref{lemma-perfect-comparison-shriek} it suffices to show
that $f^!\mathcal{O}_Y$ is a perfect complex on $X$. This question
is local on $X$ and $Y$. Hence we may assume that $X \to Y$
factors as $X \to \mathbf{A}^n_Y \to Y$ where the first arrow is a
Koszul regular immersion. See More on Morphisms, Section
\ref{more-morphisms-section-lci}.
The result holds for $\mathbf{A}^n_Y \to Y$
by Lemma \ref{lemma-shriek-affine-line}. Thus it suffices to prove
the lemma when $f$ is a Koszul regular immersion.
Working locally once again we reduce to the case
$X = \Spec(A)$ and $Y = \Spec(B)$, where $A = B/(f_1, \ldots, f_r)$
for some regular sequence $f_1, \ldots, f_r \in B$
(use that for Noetherian local rings the notion of Koszul
regular and regular are the same, see
More on Algebra, Lemma
\ref{more-algebra-lemma-noetherian-finite-all-equivalent}).
Thus $X \to Y$ is a composition
$$
X = X_r \to X_{r - 1} \to \ldots X_1 \to X_0 = Y
$$
where each arrow is the inclusion of an effective Cartier divisor.
In this way we reduce to the case of an inclusion of an effective
Cartier divisor $i : D \to X$. In this case
$i^!\mathcal{O}_X = \mathcal{N}[1]$ by
Lemma \ref{lemma-compute-for-effective-Cartier} and the proof is complete.
\end{proof}






\section{A duality theory}
\label{section-duality}

\noindent
Recall that a dualizing complex on a Noetherian scheme $S$, is an
object of $D(\mathcal{O}_S)$ which affine locally gives a dualizing
complex for the corresponding rings, see
Definition \ref{definition-dualizing-scheme}.

\begin{situation}
\label{situation-dualizing}
Here $S$ is a Noetherian scheme and $\omega_S^\bullet$ is a dualizing
complex.
\end{situation}

\noindent
For $(S, \omega_S^\bullet)$ as in Situation \ref{situation-dualizing}.
We summarize the most important points of the results obtained above:
\begin{enumerate}
\item the functors $f^!$ for morphisms between compactifyable
schemes over $S$ turn $D_\QCoh^+$ into a pseudo functor,
\item $\omega_X^\bullet = (X \to S)^!\omega_S^\bullet$
is a dualizing complex for $X$ over $S$ compactifyable,
\item the functor $D_X = R\SheafHom(-, \omega_X^\bullet)$
defines an involution of $D_{\textit{Coh}}(\mathcal{O}_X)$
switching $D_{\textit{Coh}}^+(\mathcal{O}_X)$ and
$D_{\textit{Coh}}^-(\mathcal{O}_X)$ and fixing
$D_{\textit{Coh}}^b(\mathcal{O}_X)$,
\item $\omega_X^\bullet = f^!\omega_Y^\bullet$ for $f : X \to Y$
between compactifyable schemes over $S$,
\item $f^!M = D_X(Lf^*D_Y(M))$ canonically for
$M \in D_{\textit{Coh}}^+(\mathcal{O}_Y)$, and
\item if in addition $f$ is proper then $f^!$ is the restriction
of the right adjoint of
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$
to $D_\QCoh^+(\mathcal{O}_Y)$ and there is a canonical isomorphism
$$
Rf_*R\SheafHom_{\mathcal{O}_X}(K, f^!M)
\to
R\SheafHom_{\mathcal{O}_Y}(Rf_*K, M)
$$
for all $K \in D_\QCoh(\mathcal{O}_X)$ and $M \in D_\QCoh^+(\mathcal{O}_Y)$,
and most importantly
$$
Rf_*R\SheafHom_{\mathcal{O}_X}(K, \omega_X^\bullet) =
R\SheafHom_{\mathcal{O}_Y}(Rf_*K, \omega_Y^\bullet)
$$
\end{enumerate}
See Lemmas
\ref{lemma-pseudo-functor},
\ref{lemma-shriek-dualizing},
\ref{lemma-dualizing-schemes},
\ref{lemma-upper-shriek-composition},
\ref{lemma-shriek-via-duality}, and
\ref{lemma-proper-noetherian-relative}. 

\medskip\noindent
We have obtained our functors by a very abstract procedure
which finally rests on invoking an existence theorem
(Derived Categories, Proposition \ref{derived-proposition-brown}).
This means we have no explicit description of the functors $f^!$.
This can sometimes be a problem. However, as we will see,
often it is enough to know the existence of a dualizing complex
and the duality isomorphism to pin down what it is more exactly.

\begin{remark}
\label{remark-relative-dualizing-complex-shriek}
Let $f : X \to Y$ be a flat proper morphism of compactifyable
schemes over $S$ as in Situation \ref{situation-dualizing}.
By construction the relative dualizing complex
(Remark \ref{remark-relative-dualizing-complex}) is
$\omega_{X/Y}^\bullet = f^!\mathcal{O}_Y$.
Using $\omega_X^\bullet = f^!\omega_Y^\bullet$ and the discussion in
Remark \ref{remark-relative-dualizing-complex}
we get a canonical isomorphism
$$
\omega_X^\bullet =
Lf^*\omega_Y^\bullet \otimes_{\mathcal{O}_X}^\mathbf{L} \omega_{X/Y}^\bullet
$$
in $D(\mathcal{O}_X)$.
\end{remark}







\section{Glueing dualizing complexes}
\label{section-glue}

\noindent
We will now use glueing of dualizing complexes to get a theory which works for
all finite type schemes over $S$ given a pair $(S, \omega_S^\bullet)$
as in Situation \ref{situation-dualizing}. This is similar to
\cite[Remark on page 310]{RD}.

\medskip\noindent
Let $X$ be a scheme of finite type over $S$.
Let $\mathcal{U} : X = \bigcup_{i = 1, \ldots, n} U_i$
be a finite open covering of $X$ by quasi-compact compactifyable
schemes over $S$. Every affine scheme of finite type
over $S$ is compactifyable over $S$ by
Morphisms, Lemma \ref{morphisms-lemma-quasi-projective-finite-type-over-S}
hence such open coverings certainly exist.
For each $i, j, k \in \{1, \ldots, n\}$
the schemes $p_i : U_i \to S$, $p_{ij} : U_i \cap U_j \to S$,
and $p_{ijk} : U_i \cap U_j \cap U_k \to S$ are compactifyable.
From such an open covering we obtain
\begin{enumerate}
\item $\omega_i^\bullet = p_i^!\omega_S^\bullet$
as in Section \ref{section-duality},
\item for each $i, j$ a canonical isomorphism
$\varphi_{ij} :
\omega_i^\bullet|_{U_i \cap U_j} \to \omega_j^\bullet|_{U_i \cap U_j}$, and
\item
\label{item-cocycle-glueing}
for each $i, j, k$ we have
$$
\varphi_{ik}|_{U_i \cap U_j \cap U_k} =
\varphi_{jk}|_{U_i \cap U_j \cap U_k} \circ
\varphi_{ij}|_{U_i \cap U_j \cap U_k}
$$
in $D(\mathcal{O}_{U_i \cap U_j \cap U_k})$.
\end{enumerate}
Here, in (2) we use that $(U_i \cap U_j \to U_i)^!$
is given by restriction (Lemma \ref{lemma-shriek-open-immersion})
and that we have canonical isomorphisms
$$
(U_i \cap U_j \to U_i)^! \circ p_i^! = p_{ij}^! =
(U_i \cap U_j \to U_j)^! \circ p_j^!
$$
by Lemma \ref{lemma-upper-shriek-composition} and to get (3) we use
that the upper shriek functors form a pseudo functor by
Lemma \ref{lemma-pseudo-functor}.

\medskip\noindent
In the situation just described a
{\it dualizing complex normalized relative to $\omega_S^\bullet$
and $\mathcal{U}$} is a pair $(K, \alpha_i)$ where $K \in D(\mathcal{O}_X)$
and $\alpha_i : K|_{U_i} \to \omega_i^\bullet$ are isomorphisms
such that $\varphi_{ij}$ is given by
$\alpha_j|_{U_i \cap U_j} \circ \alpha_i^{-1}|_{U_i \cap U_j}$.
Since being a dualizing complex on a scheme is a local property
we see that dualizing complexes normalized relative to $\omega_S^\bullet$
and $\mathcal{U}$ are indeed dualizing complexes.

\begin{lemma}
\label{lemma-good-dualizing-unique}
In Situation \ref{situation-dualizing} let $X$ be a scheme of finite type
over $S$ and let $\mathcal{U}$ be a finite open covering of $X$
by compactifyable schemes. If there exists a dualizing complex
normalized relative to $\omega_S^\bullet$ and $\mathcal{U}$, then it is unique
up to unique isomorphism.
\end{lemma}

\begin{proof}
If $(K, \alpha_i)$ and $(K', \alpha_i')$ are two, then we consider
$L = R\SheafHom(K, K')$. By Lemma \ref{lemma-dualizing-unique-schemes}
and its proof, this is an invertible object of $D(\mathcal{O}_X)$.
Using $\alpha_i$ and $\alpha'_i$ we obtain an isomorphism
$$
\alpha_i^t \otimes \alpha'_i :
L|_{U_i} \longrightarrow
R\SheafHom(\omega_i^\bullet, \omega_i^\bullet) = \mathcal{O}_{U_i}[0]
$$
This already implies that $L = H^0(L)[0]$ in $D(\mathcal{O}_X)$.
Moreover, $H^0(L)$ is an invertible sheaf with given trivializations
on the opens $U_i$ of $X$. Finally, the condition that
$\alpha_j|_{U_i \cap U_j} \circ \alpha_i^{-1}|_{U_i \cap U_j}$
and
$\alpha'_j|_{U_i \cap U_j} \circ (\alpha'_i)^{-1}|_{U_i \cap U_j}$
both give $\varphi_{ij}$ implies that the transition maps
are $1$ and we get an isomorphism $H^0(L) = \mathcal{O}_X$.
\end{proof}

\begin{lemma}
\label{lemma-good-dualizing-independence-covering}
In Situation \ref{situation-dualizing} let $X$ be a scheme of finite type
over $S$ and let $\mathcal{U}$, $\mathcal{V}$ be two finite open coverings
of $X$ by compactifyable schemes. Assume that $\mathcal{V}$
If there exists a dualizing complex normalized
relative to $\omega_S^\bullet$ and $\mathcal{U}$, then
there exists a dualizing complex normalized relative to
$\omega_S^\bullet$ and $\mathcal{V}$ and these complexes are
canonically isomorphic.
\end{lemma}

\begin{proof}
It suffices to prove this when $\mathcal{U}$ is given by the opens
$U_1, \ldots, U_n$ and $\mathcal{V}$ by the opens $U_1, \ldots, U_{n + m}$.
In fact, we may and do even assume $m = 1$.
To go from a dualizing complex $(K, \alpha_i)$ normalized
relative to $\omega_S^\bullet$ and $\mathcal{V}$ to a
dualizing complex normalized relative to $\omega_S^\bullet$ amd $\mathcal{U}$
is achieved by forgetting about $\alpha_i$ for $i = n + 1$. Conversely, let
$(K, \alpha_i)$ be a dualizing complex normalized relative to
$\omega_S^\bullet$ and $\mathcal{U}$.
To finish the proof we need to construct a map
$\alpha_{n + 1} : K|_{U_{n + 1}} \to \omega_{n + 1}^\bullet$ satisfying
the desired conditions.
To do this we observe that $U_{n + 1} = \bigcup U_i \cap U_{n + 1}$
is an open covering.
It is clear that $(K|_{U_{n + 1}}, \alpha_i|_{U_i \cap U_{n + 1}})$
is a dualizing complex normalized relative to $\omega_S^\bullet$
and the covering $U_{n + 1} = \bigcup U_i \cap U_{n + 1}$.
On the other hand, by condition (\ref{item-cocycle-glueing}) the pair
$(\omega_{n + 1}^\bullet|_{U_{n + 1}}, \varphi_{n + 1i})$
is another dualizing complex normalized relative to $\omega_S^\bullet$
and the covering
$U_{n + 1} = \bigcup U_i \cap U_{n + 1}$.
By Lemma \ref{lemma-good-dualizing-unique} we obtain a unique isomorphism
$$
\alpha_{n + 1} : K|_{U_{n + 1}} \longrightarrow \omega_{n + 1}^\bullet
$$
compatible with the given local isomorphisms.
It is a pleasant exercise to show that this means it satisfies
the required property.
\end{proof}

\begin{lemma}
\label{lemma-existence-good-dualizing}
In Situation \ref{situation-dualizing} let $X$ be a scheme of finite type
over $S$ and let $\mathcal{U}$ be two a finite open covering
of $X$ by compactifyable schemes. Then there exists
a dualizing complex normalized relative to $\omega_S^\bullet$ and
$\mathcal{U}$.
\end{lemma}

\begin{proof}
Say $\mathcal{U} : X = \bigcup_{i = 1, \ldots, n} U_i$.
We prove the lemma by induction on $n$. The base case $n = 1$ is immediate.
Assume $n > 1$. Set $X' = U_1 \cup \ldots \cup U_{n - 1}$
and let $(K', \{\alpha'_i\}_{i = 1, \ldots, n - 1})$
be a dualizing complex normalized relative to $\omega_S^\bullet$
and $\mathcal{U}' : X' = \bigcup_{i = 1, \ldots, n - 1} U_i$.
It is clear that $(K'|_{X' \cap U_n}, \alpha'_i|_{U_i \cap U_n})$
is a dualizing complex normalized relative to $\omega_S^\bullet$
and the covering
$X' \cap U_n = \bigcup_{i = 1, \ldots, n - 1} U_i \cap U_n$.
On the other hand, by condition (\ref{item-cocycle-glueing}) the pair
$(\omega_n^\bullet|_{X' \cap U_n}, \varphi_{ni})$
is another dualizing complex normalized relative to $\omega_S^\bullet$
and the covering
$X' \cap U_n = \bigcup_{i = 1, \ldots, n - 1} U_i \cap U_n$.
By Lemma \ref{lemma-good-dualizing-unique} we obtain a unique isomorphism
$$
\epsilon : K'|_{X' \cap U_n} \longrightarrow \omega_i^\bullet|_{X' \cap U_n}
$$
compatible with the given local isomorphisms.
By Cohomology, Lemma \ref{cohomology-lemma-glue}
we obtain $K \in D(\mathcal{O}_X)$ together with
isomorphisms $\beta : K|_{X'} \to K'$ and
$\gamma : K|_{U_n} \to \omega_n^\bullet$ such that
$\epsilon = \gamma|_{X'\cap U_n} \circ \beta|_{X' \cap U_n}^{-1}$.
Then we define
$$
\alpha_i = \alpha'_i \circ \beta|_{U_i}, i = 1, \ldots, n - 1,
\text{ and }
\alpha_n = \gamma
$$
We still need to verify that $\varphi_{ij}$ is given by
$\alpha_j|_{U_i \cap U_j} \circ \alpha_i^{-1}|_{U_i \cap U_j}$.
For $i, j \leq n - 1$ this follows from the corresping
condition for $\alpha_i'$. For $i = j = n$ it is clear as well.
If $i < j = n$, then we get
$$
\alpha_n|_{U_i \cap U_n} \circ \alpha_i^{-1}|_{U_i \cap U_n} =
\gamma|_{U_i \cap U_n} \circ \beta^{-1}|_{U_i \cap U_n}
\circ (\alpha'_i)^{-1}|_{U_i \cap U_n} =
\epsilon|_{U_i \cap U_n} \circ (\alpha'_i)^{-1}|_{U_i \cap U_n}
$$
This is equal to $\alpha_{in}$ exactly because $\epsilon$
is the unique map compatible with the maps
$\alpha_i'$ and $\alpha_{ni}$.
\end{proof}

\noindent
Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}.
The upshot of the lemmas above is that given any scheme $X$ of finite type
over $S$, there is a pair $(K, \alpha_U)$ given up to unique isomorphism,
consisting of an object $K \in D(\mathcal{O}_X)$ and isomorphisms
$\alpha_U : K|_U \to \omega_U^\bullet$ for every open subscheme
$U \subset X$ which has a compactification over $S$ and where
$\omega_U^\bullet$ is as in Section \ref{section-duality}, such that, if
$\mathcal{U} : X = \bigcup U_i$ is a finite open covering
by opens which are compactifyable over $S$, then
$(K, \alpha_{U_i})$ is a dualizing complex normalized relative to
$\omega_S^\bullet$ and $\mathcal{U}$.
Namely, uniqueness up to unique isomorphsm by
Lemma \ref{lemma-good-dualizing-unique},
existence for one open covering by
Lemma \ref{lemma-existence-good-dualizing}, and
the fact that $K$ then works for all open coverings is
Lemma \ref{lemma-good-dualizing-independence-covering}.

\begin{definition}
\label{definition-good-dualizing}
Let $S$ be a Noetherian scheme and let $\omega_S^\bullet$ be a dualizing
complex on $S$. Let $X$ be a scheme of finite type over $S$.
The complex $K$ constructed above is called the
{\it dualizing complex normalized relative to $\omega_S^\bullet$}
and is denoted $\omega_X^\bullet$.
\end{definition}

\noindent
As the terminology suggest, a dualizing complex normalized relative to
$\omega_S^\bullet$ is not just an object of the derived category of $X$
but comes equipped with the local isomorphisms described above.
This does not conflict with setting
$\omega_X^\bullet = p^!\omega_S^\bullet$ where $p : X \to S$ is the
structure morphism if $X$ has a compactification over $S$ (see
Section \ref{section-dualizing}). More generally
we have the following sanity check.

\begin{lemma}
\label{lemma-good-over-both}
Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}.
Let $f : X \to Y$ be a morphism of finite type schemes over $S$.
Let $\omega_X^\bullet$ and $\omega_Y^\bullet$ be dualizing complexes
normalized relative to $\omega_S^\bullet$. Then $\omega_X^\bullet$
is a dualizing complex normalized relative to $\omega_Y^\bullet$.
\end{lemma}

\begin{proof}
This is just a matter of bookkeeping.
Choose a finite affine open covering $\mathcal{V} : Y = \bigcup V_j$.
For each $j$ choose a finite affine open covering $f^{-1}(V_j) = U_{ji}$.
Set $\mathcal{U} : X = \bigcup U_{ji}$. The schemes $V_j$ and $U_{ji}$ are
compactifyable over $S$, hence we have the upper shriek functors for
$q_j : V_j \to S$, $p_{ji} : U_{ji} \to S$ and
$f_{ji} : U_{ji} \to V_j$ and $f_{ji}' : U_{ji} \to Y$.
Let $(L, \beta_j)$ be a dualizing complex normalized relative to
$\omega_S^\bullet$ and $\mathcal{V}$.
Let $(K, \gamma_{ji})$ be a dualizing complex normalized relative to
$\omega_S^\bullet$ and $\mathcal{U}$.
(In other words, $L = \omega_Y^\bullet$ and $K = \omega_X^\bullet$.)
We can define
$$
\alpha_{ji} :
K|_{U_{ji}} \xrightarrow{\gamma_{ji}}
p_{ji}^!\omega_S^\bullet = f_{ji}^!q_j^!\omega_S^\bullet
\xrightarrow{f_{ji}^!\beta_j^{-1}} f_{ji}^!(L|_{V_j}) =
(f_{ji}')^!(L)
$$
To finish the proof we have to show that
$\alpha_{ji}|_{U_{ji} \cap U_{j'i'}}
\circ \alpha_{j'i'}^{-1}|_{U_{ji} \cap U_{j'i'}}$
is the canonical isomorphism
$(f_{ji}')^!(L)|_{U_{ji} \cap U_{j'i'}} \to
(f_{j'i'}')^!(L)|_{U_{ji} \cap U_{j'i'}}$. This is formal and we
omit the details.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-good-dualizing-complex}
Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}.
Let $j : X \to Y$ be an open immersion of schemes of finite type over $S$.
Let $\omega_X^\bullet$ and $\omega_Y^\bullet$ be dualizing complexes
normalized relative to $\omega_S^\bullet$. Then there is a canonical
isomorphism $\omega_X^\bullet = \omega_Y^\bullet|_X$.
\end{lemma}

\begin{proof}
Immediate from the construction of normalized dualizing complexes
given just above
Definition \ref{definition-good-dualizing}.
\end{proof}

\begin{lemma}
\label{lemma-proper-map-good-dualizing-complex}
Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}.
Let $f : X \to Y$ be a proper morphism of schemes of finite type over $S$.
Let $\omega_X^\bullet$ and $\omega_Y^\bullet$ be dualizing complexes
normalized relative to $\omega_S^\bullet$. Let $a$ be the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
$f$. Then there is a canonical isomorphism
$a(\omega_Y^\bullet) = \omega_X^\bullet$.
\end{lemma}

\begin{proof}
Let $p : X \to S$ and $q : Y \to S$ be the structure morphisms.
If $X$ and $Y$ are compactifyable over $S$, then this follows
from the fact that $\omega_X^\bullet = p^!\omega_S^\bullet$,
$\omega_Y^\bullet = q^!\omega_S^\bullet$, $f^! = a$, and
$f^! \circ q^! = p^!$ (Lemma \ref{lemma-upper-shriek-composition}).
In the general case we first use Lemma \ref{lemma-good-over-both}
to reduce to the case $Y = S$. In this case $X$ and $Y$
are compactifyable over $S$ and we've just seen the result.
\end{proof}

\noindent
Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}.
For a scheme $X$ of finite type over $S$ denote $\omega_X^\bullet$ the
dualizing complex for $X$ normalized relative to $\omega_S^\bullet$.
Define $D_X(-) = R\SheafHom_{\mathcal{O}_X}(-, \omega_X^\bullet)$
as in Lemma \ref{lemma-dualizing-schemes}.
Let $f : X \to Y$ be a morphism of finite type schemes over $S$.
Define
$$
f_{new}^! = D_X \circ Lf^* \circ D_Y :
D_{\textit{Coh}}^+(\mathcal{O}_Y)
\to
D_{\textit{Coh}}^+(\mathcal{O}_X)
$$
If $f : X \to Y$ and $g : Y \to Z$ are composable
morphisms between schemes of finite type over $S$, define
\begin{align*}
(g \circ f)^!_{new} & = D_X \circ L(g \circ f)^* \circ D_Z \\
& = D_X \circ Lf^* \circ Lg^* \circ D_Z \\
& \to D_X \circ Lf^* \circ D_Y \circ D_Y \circ Lg^* \circ D_Z \\
& = f^!_{new} \circ g^!_{new}
\end{align*}
where the arrow is defined in Lemma \ref{lemma-dualizing-schemes}.
We collect the results together in the following lemma.

\begin{lemma}
\label{lemma-duality-bootstrap}
Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}.
With $f^!_{new}$ and $\omega_X^\bullet$ defined for all (morphisms of)
schemes of finite type over $S$ as above:
\begin{enumerate}
\item the functors $f^!_{new}$ and the arrows
$(g \circ f)^!_{new} \to f^!_{new} \circ g^!_{new}$
turn $D_{\textit{Coh}}^+$ into a pseudo functor from the category of
schemes of finite type over $S$ into the $2$-category of categories,
\item $\omega_X^\bullet = (X \to S)^!_{new} \omega_S^\bullet$,
\item the functor $D_X$
defines an involution of $D_{\textit{Coh}}(\mathcal{O}_X)$
switching $D_{\textit{Coh}}^+(\mathcal{O}_X)$ and
$D_{\textit{Coh}}^-(\mathcal{O}_X)$ and fixing
$D_{\textit{Coh}}^b(\mathcal{O}_X)$,
\item $\omega_X^\bullet = f^!_{new}\omega_Y^\bullet$ for
$f : X \to Y$ a morphism of finite type schemes over $S$,
\item $f^!_{new}M = D_X(Lf^*D_Y(M))$ for
$M \in D_{\textit{Coh}}^+(\mathcal{O}_Y)$, and
\item if in addition $f$ is proper, then $f^!_{new}$ is isomorphic
to the restriction of the right adjoint of
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ to
$D_{\textit{Coh}}^+(\mathcal{O}_Y)$ and there is a canonical isomorphism
$$
Rf_*R\SheafHom_{\mathcal{O}_X}(K, f^!_{new}M)
\to
R\SheafHom_{\mathcal{O}_Y}(Rf_*K, M)
$$
for all $K \in D_\QCoh(\mathcal{O}_X)$ and
$M \in D_{\textit{Coh}}^+(\mathcal{O}_Y)$, and most importantly
$$
Rf_*R\SheafHom_{\mathcal{O}_X}(K, \omega_X^\bullet) =
R\SheafHom_{\mathcal{O}_Y}(Rf_*K, \omega_Y^\bullet)
$$
\end{enumerate}
Moreover, if $X$ is compactifyable over $S$ then
$\omega_X^\bullet$ is canonically isomorphic to the complex
$\omega_X^\bullet$ of Section \ref{section-duality} and
if $f$ is a morphism between compactifyable schemes
over $S$, then there is a canonical isomorphism\footnote{We haven't
checked that these are compatible with the isomorphisms
$(g \circ f)^! \to f^! \circ g^!$ and
$(g \circ f)^!_{new} \to f^!_{new} \circ g^!_{new}$. We will do this
here if we need this later.}
$f_{new}^!K = f^!K$ for $K$ in $D_{\textit{Coh}}^+$.
\end{lemma}

\begin{proof}
Let $f : X \to Y$, $g : Y \to Z$, $h : Z \to T$ be morphisms of schemes
of finite type over $S$. We have to show that
$$
\xymatrix{
(h \circ g \circ f)^!_{new} \ar[r] \ar[d] &
f^!_{new} \circ (h \circ g)^!_{new} \ar[d] \\
(g \circ f)^!_{new} \circ h^!_{new} \ar[r] &
f^!_{new} \circ g^!_{new} \circ h^!_{new}
}
$$
is commutative. Let $\eta_Y : \text{id} \to D_Y^2$
and $\eta_Z : \text{id} \to D_Z^2$ be the canonical isomorphisms
of Lemma \ref{lemma-dualizing-schemes}. Then, using
Categories, Lemma \ref{categories-lemma-properties-2-cat-cats},
a computation (omitted) shows that both arrows
$(h \circ g \circ f)^!_{new} \to f^!_{new} \circ g^!_{new} \circ h^!_{new}$
are given by
$$
1 \star \eta_Y \star 1 \star \eta_Z \star 1 :
D_X \circ Lf^* \circ Lg^* \circ Lh^* \circ D_T
\longrightarrow
D_X \circ Lf^* \circ D_Y^2 \circ Lg^* \circ D_Z^2 \circ Lh^* \circ D_T
$$
This proves (1). Part (2) is immediate from the definition of
$(X \to S)^!_{new}$ and the fact that $D_S(\omega_S^\bullet) = \mathcal{O}_S$.
Part (3) is Lemma \ref{lemma-dualizing-schemes}.
Part (4) follows by the same arguemtn as part (2).
Part (5) is the definition of $f^!_{new}$.

\medskip\noindent
Proof of (6). Let $a$ be the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for the
proper morphism $f : X \to Y$ of schemes of finite type over $S$.
The issue is that we do not know $X$ or $Y$ is
compactifyable over $S$ (and in general this won't be true)
hence we cannot immediately apply
Lemma \ref{lemma-shriek-via-duality} to $f$ over $S$.
To get around this we use the canonical identification
$\omega_X^\bullet = a(\omega_Y^\bullet)$ of
Lemma \ref{lemma-proper-map-good-dualizing-complex}.
Hence $f^!_{new}$ is the restriction of $a$ to
$D_{\textit{Coh}}^+(\mathcal{O}_Y)$ by Lemma \ref{lemma-shriek-via-duality}
applied to $f : X \to Y$ over the base scheme $Y$!
Thus the result is true by Lemma \ref{lemma-proper-noetherian-relative}.

\medskip\noindent
The final assertions follow from the construction of normalized
dualizing complexes and the already used Lemma \ref{lemma-shriek-via-duality}.
\end{proof}

\begin{example}
\label{example-trace-proper}
Let $S$ be a Noetherian scheme and let $\omega_S^\bullet$ be a
dualizing complex. Let $f : X \to Y$ be a proper morphism of finite
type schemes over $S$. Let $\omega_X^\bullet$ and $\omega_Y^\bullet$
be dualizing complexes normalized relative to $\omega_S^\bullet$.
In this situation we have $a(\omega_Y^\bullet) = \omega_X^\bullet$
(Lemma \ref{lemma-proper-map-good-dualizing-complex})
and hence the trace map (Section \ref{section-trace}) is a canonical arrow
$$
\text{Tr}_f : Rf_*\omega_X^\bullet \longrightarrow \omega_Y^\bullet
$$
which produces the isomorphisms (Lemma \ref{lemma-duality-bootstrap})
$$
\Hom_X(L, \omega_X^\bullet) = \Hom_Y(Rf_*L, \omega_Y^\bullet)
$$
and
$$
Rf_*R\SheafHom_{\mathcal{O}_X}(L, \omega_X^\bullet) =
R\SheafHom_{\mathcal{O}_Y}(Rf_*L, \omega_Y^\bullet)
$$
for $L$ in $D_\QCoh(\mathcal{O}_X)$.
\end{example}




\section{Dualizing modules}
\label{section-dualizing-module}

\noindent
If $(A, \mathfrak m, \kappa)$ is a Noetherian local ring and
$\omega_A^\bullet$ is a normalized dualizing complex, then
we say the module $\omega_A = H^{-\dim(A)}(\omega_A^\bullet)$, described
in Lemma \ref{lemma-depth-dualizing-module}, is a {\it dualizing module}
for $A$. This module is a canonical module of $A$.
It seems generally agreed upon to define a {\it canonical module}
for a Noetherian local ring $(A, \mathfrak m, \kappa)$ to be
a finite $A$-module $K$ such that
$$
\Hom_A(K, E) \cong H^{\dim(A)}_\mathfrak m(A)
$$
where $E$ is an injective hull of the residue field. A dualizing
module is canonical because
$$
\Hom_A(H^{\dim(A)}_\mathfrak m(A), E) = (\omega_A)^\wedge
$$
by Lemma \ref{lemma-special-case-local-duality} and hence applying
$\Hom_A(-, E)$ we get
\begin{align*}
\Hom_A(\omega_A, E)
& =
\Hom_A((\omega_A)^\wedge, E) \\
& =
\Hom_A(\Hom_A(H^{\dim(A)}_\mathfrak m(A), E), E) \\
& = H^{\dim(A)}_\mathfrak m(A)
\end{align*}
the first equality because $E$ is $\mathfrak m$-power torsion, the
second by the above, and the third by Matlis duality
(Proposition \ref{proposition-matlis}). The utility of the definition
of a canonical module given above lies in the fact that it makes sense
even if $A$ does not have a dualizing complex.

\medskip\noindent
Let $X$ be a Noetherian scheme and let $\omega_X^\bullet$ be a
dualizing complex. Let $n \in \mathbf{Z}$ be the smallest integer such that
$H^n(\omega_X^\bullet)$ is nonzero. In other words, $-n$ is the maximal
value of the dimension function associated to $\omega_X^\bullet$
(Lemma \ref{lemma-dimension-function-scheme}).
Sometimes $H^n(\omega_X^\bullet)$
is called a {\it dualizing module} or {\it dualizing sheaf}
for $X$ and then it is often denoted
by $\omega_X$. We will say ``let $\omega_X$ be a dualizing module''
to indicate the above.

\medskip\noindent
Care has to be taken when using dualizing modules $\omega_X$ on Noetherian
schemes $X$:
\begin{enumerate}
\item the integer $n$ may change when passing from $X$ to an open $U$
of $X$ and then it won't be true that $\omega_X|_U = \omega_U$,
\item the dualizing complex isn't unique; the dualizing module
is only unique up to tensoring by an invertible module.
\end{enumerate}
The second problem will often be irrelevant because we will work
with $X$ of finite type over a base change $S$ which is
endowed with a fixed dualizing complex $\omega_S^\bullet$ and
$\omega_X^\bullet$ will be the dualizing complex normalized relative
to $\omega_S^\bullet$.
The first problem will not occur if $X$ is equidimensional, more precisely,
if the dimension function associated to $\omega_X^\bullet$
(Lemma \ref{lemma-dimension-function-scheme})
maps every generic point of $X$ to the same integer.

\begin{example}
\label{example-proper-over-local}
Say $S = \Spec(A)$ with $(A, \mathfrak m, \kappa)$
a local Noetherian ring, and $\omega_S^\bullet$ corresponds to
a normalized dualizing complex $\omega_A^\bullet$. Then if
$f : X \to S$ is proper over $S$ and $\omega_X^\bullet = f^!\omega_S^\bullet$
the coherent sheaf
$$
\omega_X = H^{-\dim(X)}(\omega_X^\bullet)
$$
is a dualizing module and is often called the dualizing module
of $X$ (with $S$ and $\omega_S^\bullet$ being understood). We will
see that this has good properties.
\end{example}

\begin{example}
\label{example-equidimensional-over-field}
Say $X$ is an equidimensional scheme of finite type
over a field $k$. Then it is customary to take
$\omega_X^\bullet$ the dualizing complex normalized relative to $k[0]$
and to refer to
$$
\omega_X = H^{-\dim(X)}(\omega_X^\bullet)
$$
as the dualizing module of $X$.
\end{example}

\begin{lemma}
\label{lemma-dualizing-module}
Let $X$ be a connected Noetherian scheme and let $\omega_X$ be a dualizing
module on $X$. The support of $\omega_X$ is the union of the irreducible
components of maximal dimension with respect to any dimension function
and $\omega_X$ is a coherent $\mathcal{O}_X$-module having property $(S_2)$.
\end{lemma}

\begin{proof}
By our conventions discussed above there exists a dualizing complex
$\omega_X^\bullet$ such that $\omega_X$ is the leftmost nonvanishing
cohomology sheaf. Since $X$ is connected, any two dimension functions
differ by a constant
(Topology, Lemma \ref{topology-lemma-dimension-function-unique}).
Hence we may use the
dimension function associated to $\omega_X^\bullet$
(Lemma \ref{lemma-dimension-function-scheme}).
With these remarks in place, the lemma now
follows from Lemma \ref{lemma-depth-dualizing-module}
and the definitions (in particular
Cohomology of Schemes, Definition \ref{coherent-definition-depth}).
\end{proof}

\noindent
To say a bit more about dualizing modules we need a bit more information
about how the dimension functions change when passing to a scheme
of finite type over another.

\begin{lemma}
\label{lemma-good-dualizing-normalized}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $\omega_A^\bullet$ be a normalized dualizing complex.
Let $X$ be a scheme of finite type over $A$ and let
$\omega_X^\bullet$ be the dualizing complex normalized relative
to $\omega_A^\bullet$. If $x \in X$ is a closed point
lying over the closed point $s$ of $S = \Spec(A)$, then
$\omega_{X, x}^\bullet$
is a normalized dualizing complex over $\mathcal{O}_{X, x}$,
\end{lemma}

\begin{proof}
We may replace $X$ by an affine neighbourhood of $x$, hence we may
and do assume that $f : X \to S = \Spec(A)$ is compactifyable.
Then $\omega_X^\bullet = f^!\omega_S^\bullet$. We have to show that
$R\Hom_{\mathcal{O}_{X, x}}(\kappa(x), \omega_{X, x}^\bullet)$
is sitting in degree $0$. Let $i_x : x \to X$ denote the inclusion
morphism which is a closed immersion as $x$ is a closed point.
Hence $R\Hom_{\mathcal{O}_{X, x}}(\kappa(x), \omega_{X, x}^\bullet)$
represents $i_x^!\omega_X^\bullet$ by
Lemma \ref{lemma-shriek-closed-immersion}.
Since $x$ lives over the closed point we see that
$A \to \kappa(x)$ factors through $\kappa$ and since $x$
is a closed point of $X$ we see that
$\kappa \subset \kappa(x)$ is a finite extension
(Morphisms, Lemma
\ref{morphisms-lemma-closed-point-fibre-locally-finite-type}).
Thus we get a commutative diagram
$$
\xymatrix{
x \ar[r]_{i_x} \ar[d]_\pi & X \ar[d]^f \\
s \ar[r]^{i_s} & S
}
$$
with $\pi$ finite. We conclude that
$$
i_x^!\omega_X^\bullet = i_x^! f^! \omega_S^\bullet =
\pi^! i_s^! \omega_S^\bullet
$$
Since $\omega_A^\bullet$ is normalized and $s$ is the closed
point we see that $i_s^!\omega_S^\bullet = \kappa[0]$. We have
$$
R\pi_*(\pi^!(\kappa[0])) = R\SheafHom(R\pi_*(\kappa(x)[0]), \kappa[0]) =
\widetilde{\Hom_\kappa(\kappa(x), \kappa)}
$$
The first equality by Lemma \ref{lemma-proper-noetherian-relative}
applied with $L = \kappa(x)[0]$. The second equality holds because
$\pi_*$ is exact.
Thus $\pi^!(\kappa[0])$ is supported in degree $0$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-good-dualizing-dimension-function}
Let $S$ be a Noetherian scheme and let $\omega_S^\bullet$ be a
dualizing complex. Let $f : X \to S$ be of finite type
and let $\omega_X^\bullet$ be the dualizing complex
normalized relative to $\omega_S^\bullet$. For all $x \in X$
$$
\delta_X(x) - \delta_S(f(x)) = \text{trdeg}_{\kappa(f(x))}(\kappa(x))
$$
where $\delta_S$, resp.\ $\delta_X$
is the dimension function of
$\omega_S^\bullet$, resp.\ $\omega_X^\bullet$, see
Lemma \ref{lemma-dimension-function-scheme}.
\end{lemma}

\begin{proof}
We may replace $X$ by an affine neighbourhood of $x$. Hence we may
and do assume there is a compactification $X \subset \overline{X}$
over $S$. Then we may replace $X$ by $\overline{X}$ and assume
that $X$ is proper over $S$. We may also assume $X$ is connected
by replacing $X$ by the connected component of $X$ containing $x$.
Next, recall that both $\delta_X$ and the function
$x \mapsto \delta_S(f(x)) + \text{trdeg}_{\kappa(f(x))}(\kappa(x))$
are dimension functions on $X$, see
Morphisms, Lemma \ref{morphisms-lemma-dimension-function-propagates}.
By Topology, Lemma \ref{topology-lemma-dimension-function-unique}
we see that the difference is locally constant, hence constant as $X$ is
connected. Thus it suffices to prove equality in any point of $X$.
By Properties, Lemma \ref{properties-lemma-locally-Noetherian-closed-point}
the scheme $X$ has a closed point $x$. Since $X \to S$ is proper
the image $s$ of $x$ is closed in $S$. Thus we may apply
Lemma \ref{lemma-good-dualizing-normalized} to conclude.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-good-dualizing}
Let $X/A$ with $\omega_X^\bullet$ and $\omega_X$ be as in
Example \ref{example-proper-over-local}. Then
\begin{enumerate}
\item $H^i(\omega_X^\bullet) \not = 0 \Rightarrow
i \in \{-\dim(X), \ldots, 0\}$,
\item the dimension of the support of $H^i(\omega_X^\bullet)$ is at most $-i$,
\item $\text{Supp}(\omega_X)$ is the union of
the components of dimension $\dim(X)$, and
\item $\omega_X$ has property $(S_2)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\delta_X$ and $\delta_S$ be the dimension functions associated to
$\omega_X^\bullet$ and $\omega_S^\bullet$ as in
Lemma \ref{lemma-good-dualizing-dimension-function}.
As $X$ is proper over $A$, every closed subscheme of $X$ contains
a closed point $x$ which maps to the closed point $s \in S$
and $\delta_X(x) = \delta_S(s) = 0$. Hence
$\delta_X(\xi) = \dim(\overline{\{\xi\}}$ for any point
$\xi \in X$. Hence we can check each of
the statements of the lemma by looking at what happens over
$\Spec(\mathcal{O}_{X, x})$ in which case the result follows
from Lemmas \ref{lemma-sitting-in-degrees} and
\ref{lemma-depth-dualizing-module}.
Some details omitted.
The last two statements can also be deduced from
Lemma \ref{lemma-dualizing-module}.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-module-proper-over-A}
Let $X/A$ with dualizing module $\omega_X$ be as in
Example \ref{example-proper-over-local}.
Let $d = \dim(X_s)$ be the dimension
of the closed fibre. If $\dim(X) = d + \dim(A)$, then
the dualizing module $\omega_X$ represents the functor
$$
\mathcal{F} \longmapsto \Hom_A(H^d(X, \mathcal{F}), \omega_A)
$$
on the category of coherent $\mathcal{O}_X$-modules.
\end{lemma}

\begin{proof}
We have
\begin{align*}
\Hom_X(\mathcal{F}, \omega_X)
& =
\text{Ext}^{-\dim(X)}_X(\mathcal{F}, \omega_X^\bullet) \\
& =
\Hom_X(\mathcal{F}[\dim(X)], \omega_X^\bullet) \\
& =
\Hom_X(\mathcal{F}[\dim(X)], f^!(\omega_A^\bullet)) \\
& =
\Hom_S(Rf_*\mathcal{F}[\dim(X)], \omega_A^\bullet) \\
& =
\Hom_A(H^d(X, \mathcal{F}), \omega_A)
\end{align*}
The first equality because $H^i(\omega_X^\bullet) = 0$ for
$i < -\dim(X)$, see Lemma \ref{lemma-vanishing-good-dualizing} and
Derived Categories, Lemma \ref{derived-lemma-negative-exts}.
The second equality is follows from the definition of Ext groups.
The third equality is our choice of $\omega_X^\bullet$.
The fourth equality holds because $f^!$ is the
right adjoint of Lemma \ref{lemma-twisted-inverse-image} for
$f$, see Section \ref{section-duality}.
The final equality holds because $R^if_*\mathcal{F}$ is zero
for $i > d$ (Cohomology of Schemes, Lemma
\ref{coherent-lemma-higher-direct-images-zero-above-dimension-fibre})
and $H^j(\omega_A^\bullet)$ is zero for $j < -\dim(A)$.
\end{proof}








\section{Cohen-Macaulay schemes}
\label{section-CM}

\noindent
Duality takes a particularly simple form for Cohen-Macalaulay schemes.

\begin{lemma}
\label{lemma-depth-in-terms-dualizing-complex}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring with
normalized dualizing complex $\omega_A^\bullet$.
Then $\text{depth}(A)$ is equal to the smallest integer $\delta \geq 0$
such that $H^{-\delta}(\omega_A^\bullet) \not = 0$.
\end{lemma}

\begin{proof}
This follows immeduately from Lemma \ref{lemma-sitting-in-degrees}.
Here are two other ways to see that it is true.

\medskip\noindent
First alternative. By Nakayama's lemma we see that
$\delta$ is the smallest integer such that
$\Hom_A(H^{-\delta}(\omega_A^\bullet), \kappa) \not = 0$.
In other words, it is the smallest integer such that
$\text{Ext}_A^{-\delta}(\omega_A^\bullet, \kappa)$
is nonzero. Using Lemma \ref{lemma-dualizing} and the fact that
$\omega_A^\bullet$ is normalized this is equal to the
smallest integer such that $\text{Ext}_A^\delta(\kappa, A)$ is
nonzero. This is equal to the depth of $A$ by
Algebra, Lemma \ref{algebra-lemma-depth-ext}.

\medskip\noindent
Second alternative. By the local duality theorem
(in the form of Lemma \ref{lemma-special-case-local-duality})
$\delta$ is the smallest integer such that $H^\delta_\mathfrak m(A)$
is nonzero. This is equal to the depth of $A$ by
Lemma \ref{lemma-depth}.
\end{proof}

\begin{lemma}
\label{lemma-apply-CM}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring
with normalized dualizing complex $\omega_A^\bullet$
and dualizing module $\omega_A = H^{-\dim(A)}(\omega_A^\bullet)$.
The following are equivalent
\begin{enumerate}
\item $A$ is Cohen-Macaulay,
\item $\omega_A^\bullet$ is concentrated in a single degree, and
\item $\omega_A^\bullet = \omega_A[\dim(A)]$.
\end{enumerate}
In this case $\omega_A$ is a maximal Cohen-Macaulay module.
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-local-CM}.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-module-CM-scheme}
Let $X$ be a connected Cohen-Macaulay scheme. If $\omega_X^\bullet$
is a dualizing complex on $X$, then there is an integer $n$
and a coherent Cohen-Macaulay $\mathcal{O}_X$-module $\omega_X$
such that $\omega_X^\bullet = \omega_X[-n]$.
\end{lemma}

\begin{proof}
By definition and Lemma \ref{lemma-dualizing-localize} for every $x \in X$
the complex $\omega_{X, x}^\bullet$ is a dualizing complex over
$\mathcal{O}_{X, x}$. Let $n_x$ be the unique integer such that
$H^{n_{x}}(\omega_{X, x}^\bullet)$ is nonzero, see
Lemma \ref{lemma-apply-CM}. For an affine neighbourhood $U \subset X$
of $x$ we have $\omega_X^\bullet|_U$ is in $D^b_{\textit{Coh}}(\mathcal{O}_U)$
hence there are finitely many nonzero coherent modules
$H^i(\omega_X^\bullet)|_U$. Thus after shrinking $U$ we may assume
only $H^{n_x}$ is nonzero, see
Modules, Lemma \ref{modules-lemma-finite-type-stalk-zero}.
In this way we see that the map $x \mapsto n_x$ is locally constant.
Since $X$ is connected it is constant, say equal to $n$.
Setting $\omega_X = H^n(\omega_X^\bullet)$ we see that the lemma
holds because $\omega_X$ is Cohen-Macaulay by
Lemma \ref{lemma-apply-CM}
(and Cohomology of Schemes, Definition
\ref{coherent-definition-Cohen-Macaulay}).
\end{proof}

\begin{lemma}
\label{lemma-has-dualizing-module-CM-scheme}
Existence of a dualizing module implies Cohen-Macaulay.
\begin{enumerate}
\item Let $A$ be a Noetherian ring. If there exists a finite $A$-module
$\omega_A$ such that $\omega_A[0]$ is a dualizing complex, then
$A$ is Cohen-Macaulay.
\item Let $X$ be a locally Noetherian scheme. If there exists a coherent sheaf
$\omega_X$ such that $\omega_X[0]$ is a dualizing complex on $X$, then
$X$ is a Cohen-Macaulay scheme.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) follows from part (1) and our definitions.
To see (1) we may replace $A$ by the localization at a prime
(use Lemma \ref{lemma-dualizing-localize} and
Algebra, Definition \ref{algebra-definition-ring-CM}).
In this case the result follows immediately from
Lemma \ref{lemma-apply-CM}.
\end{proof}






\section{Gorenstein schemes}
\label{section-gorenstein}

\noindent
So far, the only explicit dualizing complex we seen is $\kappa$ on $\kappa$
for a field $\kappa$, see proof of Lemma \ref{lemma-find-function}.
By Proposition \ref{proposition-dualizing-essentially-finite-type}
this means that any finite type algebra over a field has a dualizing
complex. However, it turns out that there are Noetherian (local) rings
which do not have a dualizing complex. Namely, we have seen that
a ring which has a dualizing complex is universally catenary
(Lemma \ref{lemma-universally-catenary}) but there are examples of
Noetherian local rings which are not catenary, see
Examples, Section \ref{examples-section-non-catenary-Noetherian-local}.

\medskip\noindent
Nonetheless many rings in algebraic geometry have dualizing complexes
simply because they are quotients of Gorenstein rings. This condition
is in fact both necessary and sufficient. That is: a Noetherian ring
has dualizing complexes if and only if it is a quotient of a finite
dimensional Gorenstein ring. This is Sharp's conjecture (\cite{Sharp})
which can be found as \cite[Corollary 1.4]{Kawasaki} in the literature.
Returning to our current topic, here is the definition of Gorenstein rings.

\begin{definition}
\label{definition-gorenstein}
Gorenstein rings and schemes.
\begin{enumerate}
\item Let $A$ be a Noetherian local ring. We say $A$ is {\it Gorenstein}
if $A[0]$ is a dualizing complex for $A$.
\item Let $A$ be a Noetherian ring. We say $A$ is {\it Gorenstein}
if $A_\mathfrak p$ is Gorenstein for every prime $\mathfrak p$ of $A$.
\item Let $X$ be a locally Noetherian scheme. We say $X$ is {\it Gorenstein}
if $\mathcal{O}_{X, x}$ is Gorenstein for all $x \in X$.
\end{enumerate}
\end{definition}

\noindent
This definition makes sense, because if $A[0]$ is a dualizing complex
for $A$, then $S^{-1}A[0]$ is a dualizing complex for $S^{-1}A$ by
Lemma \ref{lemma-dualizing-localize}.
Observe that a Gorenstein ring or scheme is Cohen-Macaulay
(for example by Lemma \ref{lemma-apply-CM}).
We will see later that a finite dimensional Noetherian ring is Gorenstein
if it has finite injective dimension as a module over itself.

\begin{lemma}
\label{lemma-gorenstein}
Let $X$ be a locally Noetherian scheme.
\begin{enumerate}
\item If $X$ has a dualizing complex $\omega_X^\bullet$, then
$X$ is Gorenstein if and only if $\omega_X^\bullet$ is an invertible
object of $D(\mathcal{O}_X)$.
\item If $X$ is Gorenstein, then $X$ has a dualizing complex if and
only if $\mathcal{O}_X[0]$ is a dualizing complex.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1).
If $X$ has a dualizing complex $\omega_X^\bullet$ and is Gorenstein, then
locally on $X$ we see that $\omega_X^\bullet$ is equal to $\omega_X[n]$
for some coherent $\mathcal{O}_X$-module and some $n$ by
Lemma \ref{lemma-dualizing-module-CM-scheme}. Looking at the stalks
we find that $\omega_X$ is invertible and hence $\omega_X^\bullet$
is inveritible in $D(\mathcal{O}_X)$ (this is defined in
Section \ref{section-dualizing-schemes}). Conversely, if a
dualizing complex $\omega_X^\bullet$ exists and is invertible,
then it is locall isomorphic
to the shift of an invertible module and it is clear that the local
rings of $X$ are Gorenstein.

\medskip\noindent
If $\mathcal{O}_X[0]$ is a dualizing complex then $X$ is Gorenstein by
part (1). Conversely, we see that part (1) shows that
$\omega_X^\bullet$ is locally isomorphic to a shift of $\mathcal{O}_X$.
Since being a dualizing complex is local the result is clear.
\end{proof}

\noindent
An example of a Gorenstein ring is a regular ring.

\begin{lemma}
\label{lemma-regular-gorenstein}
A regular local ring is Gorenstein.
A regular ring is Gorenstein.
\end{lemma}

\begin{proof}
Let $A$ be a regular ring of finite dimension $d$. Then $A$ has finite
global dimension $d$, see
Algebra, Lemma \ref{algebra-lemma-finite-gl-dim-finite-dim-regular}.
Hence $\text{Ext}^{d + 1}_A(M, A) = 0$ for all $A$-modules $M$, see
Algebra, Lemma \ref{algebra-lemma-projective-dimension-ext}.
Thus $A$ has finite injective dimension as an $A$-module by
More on Algebra, Lemma \ref{more-algebra-lemma-injective-amplitude}.
It follows that $A[0]$ is a dualizing complex, hence $A$ is
Gorenstein by the remark following the definition.
\end{proof}

\begin{lemma}
\label{lemma-gorenstein-ext}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Then $A$ is Gorenstein if and only if $\text{Ext}^i_A(\kappa, A)$
is zero for $i \gg 0$.
\end{lemma}

\begin{proof}
Observe that $A[0]$ is a dualizing complex for $A$ if and only
if $A$ has finite injective dimension as an $A$-module
(follows immediately from Definition \ref{definition-dualizing}).
Thus the lemma follows from More on Algebra, Lemma
\ref{more-algebra-lemma-finite-injective-dimension-Noetherian-local}.
\end{proof}

\begin{lemma}
\label{lemma-gorenstein-divide-by-nonzerodivisor}
Let $(A, \mathfrak m, \kappa)$
be a Noetherian local ring. Let $f \in \mathfrak m$ be a
nonzerodivisor. Set $B = A/(f)$. Then $A$ is Gorenstein if and
only if $B$ is Gorenstein.
\end{lemma}

\begin{proof}
If $A$ is Gorenstein, then $B$ is Gorenstein by
Lemma \ref{lemma-divide-by-nonzerodivisor}.
Conversely, suppose that $B$ is Gorenstein. Then
$\text{Ext}^i_B(\kappa, B)$ is zero for $i \gg 0$
(Lemma \ref{lemma-gorenstein-ext}).
Recall that $R\Hom(B, -) : D(A) \to D(B)$ is a right adjoint
to restriction (Lemma \ref{lemma-right-adjoint}).
Hence
$$
R\Hom_A(\kappa, A) = R\Hom_B(\kappa, R\Hom(B, A)) =
R\Hom_B(\kappa, B[1])
$$
The final equality by direct computation or by applying the
very general Lemma \ref{lemma-compute-for-effective-Cartier}.
Thus we see that $\text{Ext}^i_A(\kappa, A)$ is zero for
$i \gg 0$ and $A$ is Gorenstein (Lemma \ref{lemma-gorenstein-ext}).
\end{proof}

\begin{lemma}
\label{lemma-flat-over-gorenstein-gorenstein-fibre}
Let $A \to B$ be a flat local homomorphism of Noetherian local rings.
If $A$ and $B/\mathfrak m_A B$ are Gorenstein, then $B$ is Gorenstein.
\end{lemma}

\begin{proof}
We will use Lemma \ref{lemma-gorenstein-ext} without further mention.
Let $\kappa_A$, $\kappa_B$ be the residue field of $A$, $B$.
Let $\mathfrak m \subset A$ be the maximal ideal. Using that
$R\Hom(B/\mathfrak m B, -) : D(B) \to D(B/\mathfrak m B)$ is a right adjoint
to restriction (Lemma \ref{lemma-right-adjoint}) we obtain
$$
R\Hom_B(\kappa_B, B) =
R\Hom_{B/\mathfrak m B}(\kappa_B, R\Hom(B/\mathfrak m B, B))
$$
The cohomology modules of $R\Hom(B/\mathfrak m B, B)$ are the
modules $\text{Ext}^i_B(B/\mathfrak mB, B)$ which by
More on Algebra, Remark
\ref{more-algebra-remark-pseudo-coherence-and-base-change-ext}
are equal to $\text{Ext}^i_A(\kappa_A, A) \otimes_A B$.
Since $A$ is Gorenstein, only a finite number of these are
nonzero and each $\text{Ext}^i_B(B/\mathfrak mB, B)$ is
isomorphic to a direct sum of copies of $B/\mathfrak m B$.
Hence since $B/\mathfrak mB$ is Gorenstein we conclude that
$R\Hom_B(\kappa_B, A)$ has only a finite number of nonzero
cohomology modules and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-flat-under-gorenstein}
Let $A \to B$ be a flat local homomorphism of Noetherian local rings.
If $B$ is Gorenstein, then $A$ is Gorenstein.
\end{lemma}

\begin{proof}
By More on Algebra, Remark
\ref{more-algebra-remark-pseudo-coherence-and-base-change-ext}
we have
$$
\text{Ext}^i_A(\kappa_A, A) \otimes_A B =
\text{Ext}^i_B(B/\mathfrak m_A B, B)
$$
for all $i$. Since $B$ is Gorenstein, $B$ has finite injective dimension
as a $B$-module. Hence $\text{Ext}^i_B(B/\mathfrak m_A B, B)$
is $0$ for $i \gg 0$. Since $A \to B$ is faithfully flat
we conclude that $\text{Ext}^i_A(\kappa_A, A)$ is $0$
for $i \gg 0$. We conclude by Lemma \ref{lemma-gorenstein-ext}.
\end{proof}

\begin{lemma}
\label{lemma-ubiquity-dualizing}
The following types of rings have a dualizing complex:
\begin{enumerate}
\item fields,
\item Noetherian complete local rings,
\item $\mathbf{Z}$,
\item Dedekind domains,
\item ring essentially of finite type over any of the above.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-regular-gorenstein} a regular local ring has a
dualizing complex. Thus any ring essentially of finite type over a
regular local ring has a dualizing complex by
Proposition \ref{proposition-dualizing-essentially-finite-type}.
A complete Noetherian local ring is the quotient of a regular
local ring by the Cohen structure theorem
(Algebra, Theorem \ref{algebra-theorem-cohen-structure-theorem}).
Let $A$ be a Dedekind domain. Then every ideal $I$ is a finite
projective $A$-module (follows from
Algebra, Lemma \ref{algebra-lemma-finite-projective}
and the fact that the local rings of $A$ are discrete valution ring
and hence PIDs). Thus every $A$-module has finite injective dimension
at most $1$ by
More on Algebra, Lemma \ref{more-algebra-lemma-injective-amplitude}.
It follows easily that $A[0]$ is a dualizing complex.
\end{proof}





\section{Formal fibres}
\label{section-formal-fibres}

\noindent
This section is a continuation of
More on Algebra, Section \ref{more-algebra-section-properties-formal-fibres}.
There we saw there is a (fairly) good theory of Noetherian rings
whose local rings have Cohen-Macaulay formal fibres. Similarly,
for Noetherian rings whose local rings have $(S_n)$ formal fibres.
Namely, we proved it suffices to check formal fibres at
maximal ideals and we checked that the property is inherited
by finite type ring extensions. see
More on Algebra, Lemma \ref{more-algebra-lemma-check-P-ring-maximal-ideals} and
Proposition \ref{more-algebra-proposition-finite-type-over-P-ring}.
The following lemma implies that the same is true for Noetherian rings
whose local rings have formal fibres which are Gorenstein.
This is relevant to this chapter because a Noetherian ring which has a
dualizing complex is an example.

\begin{lemma}
\label{lemma-formal-fibres-gorenstein}
Properties (A), (B), (C), and (D) of
More on Algebra, Section \ref{more-algebra-section-properties-formal-fibres}
hold for $P(k \to R) =$``$R$ is a Gorenstein ring''.
\end{lemma}

\begin{proof}
Since we already know the result holds for Cohen-Macaulay instead
of Gorenstein, we may in each step assume the ring we have is
Cohen-Macaulay. This is not particularly helpful for the proof, but
psychologically may be useful.

\medskip\noindent
Part (A). Let $k \subset K$ be a finitely generated field extension.
Let $R$ be a Gorenstein $k$-algebra.
We can find a global complete intersection
$A = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
over $k$ such that $K$ is isomorphic to the fraction field of $A$, see
Algebra, Lemma \ref{algebra-lemma-colimit-syntomic}.
Then $R \to R \otimes_k A$ is a relative global complete intersection.
Since $R_\mathfrak p$ is a dualizing complex over $R_\mathfrak p$,
we see that $R_\mathfrak p[x_1, \ldots, x_n]$ is a dualizing
complex over $R_\mathfrak p[x_1, \ldots, x_n]$ by
Lemma \ref{lemma-dualizing-polynomial-ring}.
Hence the polynomial ring over $R$ is Gorenstein.
Next, if $S$ is a Gorenstein local ring and $f \in S$ is
a nonzerodivisor, then $S/fS$ is Gorenstein by
Lemma \ref{lemma-divide-by-nonzerodivisor}.
In this way we see that $R \otimes_k A$ is a Gorenstein ring.
Thus $R \otimes_k K$ is too as a localization.

\medskip\noindent
Proof of (B). If a product of rings is Gorenstein, then each of
the factors is Gorenstein. This is clear because a ring is Gorenstein
if and only if all of its local rings are Gorenstein.

\medskip\noindent
Part (C). Let $A \to B \to C$ be flat maps of Noetherian rings.
Assume the fibres of $A \to B$ are Gorenstein and $B \to C$ is regular.
We have to show the fibres of $A \to C$ are Gorenstein.
Clearly, we may assume $A = k$ is a field. Then we may assume that
$B \to C$ is a regular local homomorphism of Noetherian local rings.
Then $B$ is Gorenstein and $C/\mathfrak m_B C$ is regular, in
particular Gorenstein (Lemma \ref{lemma-regular-gorenstein}).
Then $C$ is Gorenstein by
Lemma \ref{lemma-flat-over-gorenstein-gorenstein-fibre}.

\medskip\noindent
Part (D). This follows from Lemma \ref{lemma-flat-under-gorenstein}.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-gorenstein-formal-fibres}
Let $A$ be a Noetherian local ring. If $A$ has a dualizing complex,
then the formal fibres of $A$ are Gorenstein.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be a prime of $A$. The formal fibre of $A$ at $\mathfrak p$
is isomorphic to the formal fibre of $A/\mathfrak p$ at $(0)$. The quotient
$A/\mathfrak p$ has a dualizing complex
(Lemma \ref{lemma-dualizing-quotient}). Thus it suffices to check the statement
when $A$ is a local domain and $\mathfrak p = (0)$.
Let $\omega_A^\bullet$ be a dualizing complex for $A$. Then
$\omega_A^\bullet \otimes_A A^\wedge$ is a dualizing complex
for the completion $A^\wedge$ (Lemma \ref{lemma-flat-unramified}).
Then $\omega_A^\bullet \otimes_A f.f.(A)$ is a dualizing
complex for $K = f.f.(A)$ (Lemma \ref{lemma-dualizing-localize})
hence is isomorphic ot $K[n]$ for some $n \in \mathbf{Z}$.
Similarly, we conclude a dualizing complex for the formal fibre
$A^\wedge \otimes_A K$ is
$$
\omega_A^\bullet \otimes_A A^\wedge \otimes_{A^\wedge} (A^\wedge \otimes_A K) =
(\omega_A^\bullet \otimes_A K) \otimes_K (A^\wedge \otimes_A K) \cong
(A^\wedge \otimes_A K)[n]
$$
as desired.
\end{proof}

\noindent
Here is the verification promised in
Divided Power Algebra, Remark \ref{dpa-remark-no-good-ci-map}.

\begin{lemma}
\label{lemma-formal-fibres-lci}
Properties (A), (B), (C), and (D) of
More on Algebra, Section \ref{more-algebra-section-properties-formal-fibres}
hold for $P(k \to R) =$``$R$ is a local complete intersection''.
See Divided Power Algebra, Definition \ref{dpa-definition-lci}.
\end{lemma}

\begin{proof}
Part (A). Let $k \subset K$ be a finitely generated field extension.
Let $R$ be a $k$-algebra which is a local complete intersection.
We can find a global complete intersection
$A = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
over $k$ such that $K$ is isomorphic to the fraction field of $A$, see
Algebra, Lemma \ref{algebra-lemma-colimit-syntomic}.
Then $R \to R \otimes_k A$ is a relative global complete intersection.
It follows that $R \otimes_k A$ is a local complete intersection
by Divided Power Algebra, Lemma \ref{dpa-lemma-avramov}.

\medskip\noindent
Proof of (B). If a product of rings is a local complete intersection,
then each of the factors is a local complete intersection. This is clear
because a ring is a local complete intersection if and only if all of its
local rings are complete intersections.

\medskip\noindent
Part (C). Let $A \to B \to C$ be flat maps of Noetherian rings.
Assume the fibres of $A \to B$ are local complete intersections
and $B \to C$ is regular. We have to show the fibres of $A \to C$
are Gorenstein. Clearly, we may assume $A = k$ is a field.
Then we may assume that $B \to C$ is a regular local homomorphism
of Noetherian local rings. Then $B$ is a complete intersection and
$C/\mathfrak m_B C$ is regular, in particular a complete intersection
(by definition). Then $C$ is a complete intersection by
Divided Power Algebra, Lemma \ref{dpa-lemma-avramov}.

\medskip\noindent
Part (D). This follows by the same arguments as in (C) from
the other implication in
Divided Power Algebra, Lemma \ref{dpa-lemma-avramov}.
\end{proof}







\section{Finiteness of local cohomology, II}
\label{section-finiteness-II}

\noindent
We continue the discussion of finiteness of local cohomology
started in Section \ref{section-finiteness}.
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
Set $X = \Spec(A)$ and $Z = V(I) \subset X$. Let $M$ be a finite $A$-module.
We define
\begin{equation}
\label{equation-cutoff}
s_{A, I}(M) =
\min \{
\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q)
\mid
\mathfrak p \in X \setminus Z, \mathfrak q \in Z,
\mathfrak p \subset \mathfrak q
\}
\end{equation}
Our conventions on depth are that the depth of $0$ is $\infty$
thus we only need to consider primes $\mathfrak p$ in the support
of $M$. It will turn out that $s(M)$ is an important invariant of
the situation.

\begin{lemma}
\label{lemma-cutoff}
Let $A \to B$ be a finite homomorphism of Noetherian rings.
Let $I \subset A$ be an ideal and set $J = IB$. Let $M$ be
a finite $B$-module. If $A$ is universally catenary, then
$s_{B, J}(M) = s_{A, I}(M)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset \mathfrak q \subset A$ be primes with
$I \subset \mathfrak q$ and $I \not \subset \mathfrak p$.
Since $A \to B$ is finite there are finitely many primes
$\mathfrak p_i$ lying over $\mathfrak p$. By
Algebra, Lemma \ref{algebra-lemma-depth-goes-down-finite}
we have
$$
\text{depth}(M_\mathfrak p) = \min \text{depth}(M_{\mathfrak p_i})
$$
Let $\mathfrak p_i \subset \mathfrak q_{ij}$ be primes lying
over $\mathfrak q$. By going up for $A \to B$
(Algebra, Lemma \ref{algebra-lemma-integral-going-up})
there is at least one $\mathfrak q_{ij}$ for each $i$.
Then we see that
$$
\dim((B/\mathfrak p_i)_{\mathfrak q_{ij}}) =
\dim((A/\mathfrak p)_\mathfrak q)
$$
by the dimension formula, see
Algebra, Lemma \ref{algebra-lemma-dimension-formula}.
This implies that the minimum of the quantities
used to define $s_{B, J}(M)$
for the pairs $(\mathfrak p_i, \mathfrak q_{ij})$
is equal to the quantity for the pair $(\mathfrak p, \mathfrak q)$.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-cutoff-completion}
Let $A$ be a universally catenary Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be
a finite $A$-module. Then
$$
s_{A, I}(M) \geq s_{A^\wedge, I^\wedge}(M^\wedge)
$$
If the formal fibres of $A$ are $(S_n)$, then
$\min(n + 1, s_{A, I}(M)) \leq s_{A^\wedge, I^\wedge}(M^\wedge)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p' \subset \mathfrak q' \subset A^\wedge$
be primes with $\mathfrak p' \not \in Z^\wedge$ and
$\mathfrak q' \in Z^\wedge$. Let $\mathfrak p \subset \mathfrak q$
be the corresponding primes of $A$. Then $\mathfrak p \not \in Z$
and $\mathfrak q \in Z$. Picture
$$
\xymatrix{
\mathfrak p' \ar[r] & \mathfrak q' \ar[r] & A^\wedge \\
\mathfrak p \ar[r] \ar@{-}[u] &
\mathfrak q \ar[r] \ar@{-}[u] & A \ar[u]
}
$$
Let us write
\begin{align*}
a & = \dim(A/\mathfrak p) = \dim(A^\wedge/\mathfrak pA^\wedge),\\
b & = \dim(A/\mathfrak q) = \dim(A^\wedge/\mathfrak qA^\wedge),\\
a' & = \dim(A^\wedge/\mathfrak p'),\\
b' & = \dim(A^\wedge/\mathfrak q')
\end{align*}
Equalities by
Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-equals-total}.
We also write
\begin{align*}
p & = \dim(A^\wedge_{\mathfrak p'}/\mathfrak p A^\wedge_{\mathfrak p'}) =
\dim((A^\wedge/\mathfrak p A^\wedge)_{\mathfrak p'}) \\
q & = \dim(A^\wedge_{\mathfrak q'}/\mathfrak p A^\wedge_{\mathfrak q'}) =
\dim((A^\wedge/\mathfrak q A^\wedge)_{\mathfrak q'})
\end{align*}
Since $A$ is universally catenary we see that
$A^\wedge/\mathfrak pA^\wedge = (A/\mathfrak p)^\wedge$
is equidimensional of dimension $a$ (Proposition \ref{proposition-ratliff}).
Hence $a = a' + p$. Similarly $b = b' + q$.
By Algebra, Lemma \ref{algebra-lemma-apply-grothendieck-module}
applied to the flat local ring map
$A_\mathfrak p \to A^\wedge_{\mathfrak p'}$
we have
$$
\text{depth}(M^\wedge_{\mathfrak p'})
=
\text{depth}(M_\mathfrak p) +
\text{depth}(A^\wedge_{\mathfrak p'} / \mathfrak p A^\wedge_{\mathfrak p'})
$$
The quantity we are minimizing for $s_{A, I}(M)$ is
$$
s(\mathfrak p, \mathfrak q) =
\text{depth}(M_\mathfrak p) + \dim((A/\mathfrak p)_\mathfrak q) =
\text{depth}(M_\mathfrak p) + a - b
$$
(last equality because $A$ is catenary)
and the quantity we are minimizing for $s_{A^\wedge, I^\wedge}(M^\wedge)$
is
$$
s(\mathfrak p', \mathfrak q') =
\text{depth}(M^\wedge_{\mathfrak p'}) +
\dim((A^\wedge/\mathfrak p')_{\mathfrak q'}) =
\text{depth}(M^\wedge_{\mathfrak p'}) + a' - b'
$$
(last equality because $A^\wedge$ is catenary).
Now we have enough notation in place to start the proof.

\medskip\noindent
Let $\mathfrak p \subset \mathfrak q \subset A$ be primes
with $\mathfrak p \in X \setminus Z$ and $\mathfrak q \in Z$ such that
$s_{A, I}(M) = s(\mathfrak p, \mathfrak q)$.
Then we can pick $\mathfrak q'$ minimal over $\mathfrak q A^\wedge$
and $\mathfrak p' \subset \mathfrak q'$ minimal over
$\mathfrak p A^\wedge$ (using going down for $A \to A^\wedge$).
Then we have four primes as above with $p = 0$ and $q = 0$.
Moreover, we have
$\text{depth}(A^\wedge_{\mathfrak p'} / \mathfrak p A^\wedge_{\mathfrak p'})=0$
also because $p = 0$. This means that
$s(\mathfrak p', \mathfrak q') = s(\mathfrak p, \mathfrak q)$.
Thus we get the first inequality.

\medskip\noindent
Assume that the formal fibres of $A$ are $(S_n)$. Then
$\text{depth}(A^\wedge_{\mathfrak p'} / \mathfrak p A^\wedge_{\mathfrak p'})
\geq \min(n, p)$.
Hence
$$
s(\mathfrak p', \mathfrak q') \geq
s(\mathfrak p, \mathfrak q) + q + \min(n, p) - p \geq
s_{A, I}(M) + q + \min(n, p) - p
$$
Thus the only way we can get in trouble is if $p > n$. If this happens
then
\begin{align*}
s(\mathfrak p', \mathfrak q')
& =
\text{depth}(M^\wedge_{\mathfrak p'}) +
\dim((A^\wedge/\mathfrak p')_{\mathfrak q'}) \\
& =
\text{depth}(M_\mathfrak p) +
\text{depth}(A^\wedge_{\mathfrak p'} / \mathfrak p A^\wedge_{\mathfrak p'}) +
\dim((A^\wedge/\mathfrak p')_{\mathfrak q'}) \\
& \geq
0 + n + 1
\end{align*}
because $(A^\wedge/\mathfrak p')_{\mathfrak q'}$ has at least two primes.
This proves the second inequality.
\end{proof}

\noindent
The method of proof of the following lemma works more generally,
but the stronger results one gets will be subsumed in
Theorem \ref{theorem-finiteness} below.

\begin{lemma}
\label{lemma-local-annihilator}
\begin{reference}
This is a special case of
\cite[Satz 1]{Faltings-annulators}.
\end{reference}
Let $A$ be a Gorenstein Noetherian local ring. Let $I \subset A$
be an ideal and set $Z = V(I) \subset \Spec(A)$.
Let $M$ be a finite $A$-module. Let $s = s_{A, I}(M)$ as in
(\ref{equation-cutoff}). Then $H^i_Z(M)$ is finite for $i < s$,
but $H^s_Z(M)$ is not finite.
\end{lemma}

\begin{proof}
An important role will be played by the finite $A$-modules
$$
E^i = \text{Ext}_A^i(M, A)
$$
For $\mathfrak p \subset A$ we will write $H^i_\mathfrak p$ to denote the
local cohomology of a $A_\mathfrak p$-module. Then we see that
the $\mathfrak pA_\mathfrak p$-adic completion of
$$
(E^i)_\mathfrak p = \text{Ext}^i_{A_\mathfrak p}(M_\mathfrak p, A_\mathfrak p)
$$
is Matlis dual to
$$
H^{\dim(A_\mathfrak p) - i}_{\mathfrak p}(M_\mathfrak p)
$$
by Lemma \ref{lemma-special-case-local-duality} and the fact that
$A_\mathfrak p$ is Gorenstein. In particular we deduce from this the
following fact: an ideal $J \subset A$ annihilates
$(E^i)_\mathfrak p$ if and only if $J$ annihilates
$H^{\dim(A_\mathfrak p) - i}_{\mathfrak p}(M_\mathfrak p)$.
Set $Z_n = \{\mathfrak p \in Z \mid \dim(A/\mathfrak p) \leq n\}$.
Observe that $Z_{-1} = \emptyset$ and $Z_n = Z$ for $n = \dim(Z)$.

\medskip\noindent
Proof of finiteness for $i < s$. We will use a double induction to
do this. For $i < s$ consider the induction hypothesis $IH_i$:
$H^a_Z(M)$ is finite for $0 \leq a \leq i$. The case $IH_0$ is trivial
because $H^0_Z(M)$ is a submodule of $M$ and hence finite.

\medskip\noindent
Induction step. Assume $IH_{i - 1}$ holds for some $0 < i < s$.
For $0 \leq a \leq i - 1$ let $J_a$ be the annihilator of
$H^a_Z(M)$. Observe that $V(J_a) \subset Z$ as the support
of the finite $A$-module $H^a_Z(M)$ is contained in $Z$.
We will show by descending induction on $n$ that there
exists an ideal $J$ with $V(J) \subset Z$ such that the
associated primes of $J H^i_Z(M)$ are in $Z_n$.
For $n = -1$ this implies $JH^i_Z(M) = 0$ 
(Algebra, Lemma \ref{algebra-lemma-ass-zero})
and hence the finiteness of $H^i_Z(M)$ by
Lemma \ref{lemma-check-finiteness-local-cohomology-by-annihilator}.
The base case $n = \dim(Z)$ is trivial.

\medskip\noindent
Thus we assume given $J$ with the property for $n$. Let $\mathfrak q \in Z_n$.
With $Z_\mathfrak q = V(IA_\mathfrak q)$ we have
$H^j_Z(M)_\mathfrak q = H^j_{Z_\mathfrak q}(M_\mathfrak q)$
by Lemma \ref{lemma-torsion-change-rings}.
Consider the spectral sequence
$$
H_\mathfrak q^p(H^q_Z(M)_\mathfrak q) \Rightarrow
H^{p + q}_\mathfrak q(M_\mathfrak q)
$$
of Lemma \ref{lemma-local-cohomology-ss} for the ideals
$IA_\mathfrak q \subset \mathfrak qA_\mathfrak q \subset A_\mathfrak q$.
Below we will find an ideal $J' \subset A$ with $V(J') \subset Z$
such that $H^i_\mathfrak q(M_\mathfrak q)$ is annihilated by $J'$ for all
$\mathfrak q \in Z_n \setminus Z_{n - 1}$.
Claim: $JJ'J_0 \ldots J_{i - 1}$ will work for $n - 1$.
Namely, let $\mathfrak q \in Z_n \setminus Z_{n - 1}$.
The spectral sequence above defines a filtration
$$
E_\infty^{0, i} = E_{i + 2}^{0, i} \subset \ldots \subset E_3^{0, i} \subset
E_2^{0, i} = H^0_\mathfrak q(H^i_Z(M)_\mathfrak q)
$$
The module $E_\infty^{0, i}$ is annihilated by $J'$. The subquotients
$E_j^{0, i}/E_{j + 1}^{0, i}$ are annihilated by $J_{i - j + 1}$
because the target of $d_j^{0, i}$ is a subquotient of
$H^j_\mathfrak q(H^{i - j + 1}_Z(M))$.
Finally, by our choice of $J$ we have
$J H^i_Z(M)_\mathfrak q \subset H^0_\mathfrak q(H^i_Z(M)_\mathfrak q)$.
Thus $\mathfrak q$ cannot be an associated prime of
$JJ'J_0 \ldots J_{i - 1}H^i_Z(M)$ as desired.

\medskip\noindent
By our initial remarks we see that $J'$ should annihilate
$$
(E^{\dim(A_\mathfrak q) - i})_\mathfrak q =
(E^{\dim(A) - n - i})_\mathfrak q
$$
for all $\mathfrak q \in Z_n \setminus Z_{n - 1}$.
But if $J'$ works for one $\mathfrak q$, then it works for all
$\mathfrak q$ in an open neighbourhood of $\mathfrak q$
as the modules $E^{\dim(A) - n - i}$ are finite.
Since every subset of $X$ is Noetherian with the induced
topology (Topology, Lemma \ref{topology-lemma-Noetherian}),
we conclude that it suffices
to prove the existence of $J'$ for one $\mathfrak q$.

\medskip\noindent
Since the ext modules are finite the existence of $J'$ is
equivalent to
$$
\text{Supp}(E^{\dim(A) - n - i}) \cap \Spec(A_\mathfrak q) \subset Z.
$$
This is equivalent to showing the localization at every
$\mathfrak p \subset \mathfrak q$, $\mathfrak p \not \in Z$
is zero. Using local duality over $A_\mathfrak p$ we find that we need
to prove that
$$
H^{\dim(A_\mathfrak p) - \dim(A) + n + i}_\mathfrak p(M_\mathfrak p) =
H^{i - \dim((A/\mathfrak p)_\mathfrak q)}_\mathfrak p(M_\mathfrak p)
$$
is zero (this uses that $A$ is catenary). This vanishes exactly by
our definition of $s(M)$ and Lemma \ref{lemma-depth}.
This finishes the proof of finiteness for $i < s$.

\medskip\noindent
To prove $H^s_Z(M)$ is not finite we work
backwards through the arguments above. First, we pick a
$\mathfrak q \in Z$, $\mathfrak p \subset \mathfrak q$
with $\mathfrak p \not \in Z$ such that
$s = \text{depth}_{A_\mathfrak p}(M_\mathfrak p) +
\dim((A/\mathfrak p)_\mathfrak q)$. Then
$H^{i - \dim((A/\mathfrak p)_\mathfrak q)}_\mathfrak p(M_\mathfrak p)$
is nonzero by the nonvanishing in Lemma \ref{lemma-depth}.
Set $n = \dim(A/\mathfrak q)$. Then
there does not exist an ideal $J \subset A$ with $V(J) \subset Z$
such that $J(E^{\dim(A) - n - s})_\mathfrak q = 0$.
Thus $H^s_\mathfrak q(M_\mathfrak q)$ is not
annihilated by an ideal $J \subset A$ with $V(J) \subset Z$.
It follows from the spectral sequence displayed above
that at least one of the modules $H^i_Z(M)_\mathfrak q$,
$0 \leq i \leq s$ is not annihilated by an ideal $J \subset A$
with $V(J) \subset Z$. Since $H^i_Z(M)$ is finite for $i < s$
and hence are annihilated by such ideals,
we conclude that $H^s_Z(M)$ is not finite.
\end{proof}

\noindent
Observe that the hypotheses of the following theorem are satisfied
by excellent Noetherian rings (by definition),
by Noetherian rings which have a dualizing complex
(Lemmas \ref{lemma-universally-catenary} and
\ref{lemma-dualizing-gorenstein-formal-fibres}), and
by regular Noetherian rings.

\begin{theorem}
\label{theorem-finiteness}
\begin{reference}
This is a special case of \cite[Satz 2]{Faltings-finiteness}.
\end{reference}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
Set $Z = V(I) \subset \Spec(A)$. Let $M$ be a finite $A$-module.
Set $s = s_{A, I}(M)$ as in (\ref{equation-cutoff}).
Assume that
\begin{enumerate}
\item $A$ is universally catenary,
\item the formal fibres of the local rings of $A$ are Cohen-Macaulay.
\end{enumerate}
Then $H^i_Z(M)$ is finite for $0 \leq i < s$ and
$H^s_Z(M)$ is not finite.
\end{theorem}

\begin{proof}
By Lemma \ref{lemma-check-finiteness-local-cohomology-locally}
we may assume that $A$ is a local ring.

\medskip\noindent
If $A$ is a Noetherian complete local ring, then we can write $A$
as the quotient of a regular complete local ring $B$ by
Cohen's structure theorem
(Algebra, Theorem \ref{algebra-theorem-cohen-structure-theorem}).
Using Lemmas \ref{lemma-cutoff} and
\ref{lemma-local-cohomology-and-restriction}
we reduce to the case
of a regular local ring which is a consequence of
Lemma \ref{lemma-local-annihilator}
because a regular local ring is Gorenstein
(Lemma \ref{lemma-regular-gorenstein}).

\medskip\noindent
Let $A$ be a Noetherian local ring. Let $\mathfrak m$ be the maximal ideal.
We may assume $I \subset \mathfrak m$, otherwise the lemma is trivial.
Let $A^\wedge$ be the completion of $A$, let $Z^\wedge = V(IA^\wedge)$, and
let $M^\wedge = M \otimes_A A^\wedge$ be the completion of $M$
(Algebra, Lemma \ref{algebra-lemma-completion-tensor}).
Then $H^i_Z(M) \otimes_A A^\wedge = H^i_{Z^\wedge}(M^\wedge)$ by
Lemma \ref{lemma-torsion-change-rings} and flatness of $A \to A^\wedge$
(Algebra, Lemma \ref{algebra-lemma-completion-flat}).
Hence it suffices to show that $H^i_{Z^\wedge}(M^\wedge)$ is
finite for $i < s$ and not finite for $i = s$, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
Since we know the result is true for $A^\wedge$ it suffices
to show that $s_{A, I}(M) = s_{A^\wedge, I^\wedge}(M^\wedge)$.
This follows from Lemma \ref{lemma-cutoff-completion}.
\end{proof}

\begin{remark}
\label{remark-astute-reader}
The astute reader will have realized that we can get a away with a
slightly weaker condition on the formal fibres of the local rings
of $A$. Namely, in the situation of Theorem \ref{theorem-finiteness}
suppose we have an $n$ and we want to prove that
$H^i_Z(M)$ are finite for $i \leq n$. Then the exact same proof
shows that it suffices that $s_{A, I}(M) > n$ and that
the formal fibres of local rings of $A$ are $(S_n)$.
On the other hand, if we want to show that $H^n_Z(M)$
is not finite, then this will be true if $n = s_{A, I}(M)$
and the formal fibres of the local rings of $A$ are $(S_n)$.
\end{remark}







\section{Finiteness of pushforwards}
\label{section-finiteness-III}

\noindent
In this section we reap the fruits of the labor done in
Section \ref{section-finiteness-II}.

\begin{lemma}
\label{lemma-finiteness-Rjstar}
Let $X$ be a locally Noetherian scheme. Let $j : U \to X$ be the inclusion
of an open subscheme with complement $Z$. Let $\mathcal{F}$ be a coherent
$\mathcal{O}_U$-module. Assume
\begin{enumerate}
\item $X$ is universally catenary,
\item for every $z \in Z$ the formal fibres of
$\mathcal{O}_{X, z}$ are $(S_n)$, and
\item for $x \in \text{Supp}(\mathcal{F})$ and $z \in Z \cap \overline{\{x\}}$
we have $\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) +
\dim(\mathcal{O}_{\overline{\{x\}}, z}) \geq n$
\end{enumerate}
Then $R^pj_*\mathcal{F}$ is coherent for $0 \leq p < n$.
\end{lemma}

\begin{proof}
The statement is local on $X$, hence we may assume $X$ is affine.
Say $X = \Spec(A)$ and $Z = V(I)$. By
Properties, Lemma \ref{properties-lemma-extend-finite-presentation}
there exists a coherent $\mathcal{O}_X$-module $\mathcal{F}'$
whose restriction to $U$ is isomorphic to $\mathcal{F}$.
Say $\mathcal{F}'$ corresponds to the finite $A$-module $M$.
Note that $R^pj_*\mathcal{F}$ is quasi-coherent
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images})
and corresponds to the $A$-module $H^p(U, \mathcal{F})$.
By Lemma \ref{lemma-local-cohomology-is-local-cohomology}
and the general facts in
Cohomology, Section \ref{cohomology-section-cohomology-support}
we obtain an exact sequence
$$
0 \to H^0_Z(M) \to M \to H^0(U, \mathcal{F}) \to H^1_Z(M) \to 0
$$
and isomorphisms $H^p(U, \mathcal{F}) = H^{p + 1}_Z(M)$ for
$p \geq 1$.
Here we use that $H^j(X, \mathcal{F}') = 0$ for $j > 0$ as $X$ is affine
and $\mathcal{F}'$ is quasi-coherent (Cohomology of Schemes,
Lemma \ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}).
Thus $R^pj_*\mathcal{F}$ is coherent if and only if $H^{p + 1}_Z(M)$ is
a finite $A$-module. Observe that the minimum of the expressions
$\text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) +
\dim(\mathcal{O}_{\overline{\{x\}}, z})$
is the number $s_{A, I}(M)$ of (\ref{equation-cutoff}).
Having said this the lemma follows from
Theorem \ref{theorem-finiteness}
as elucidated by Remark \ref{remark-astute-reader}.
\end{proof}








\section{Duality for a finite morphism}
\label{section-duality-finite}

\noindent
In this section work out what some of the results above mean for
finite morphisms of schemes.

\begin{lemma}
\label{lemma-dualizing-finite}
Let $A \to B$ be a finite ring map of Noetherian rings.
Let $\omega_A^\bullet$ be a dualizing complex.
Then $R\Hom(B, \omega_A^\bullet)$ is a dualizing complex for $B$.
\end{lemma}

\begin{proof}
The proof is identical to the proof of Lemma \ref{lemma-dualizing-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-normalized-finite}
Let $(A, \mathfrak m, \kappa) \to (B, \mathfrak m', \kappa')$
be a finite local map of Noetherian local rings. Let $\omega_A^\bullet$
be a normalized dualizing complex. Then
$\omega_B^\bullet = R\Hom(B, \omega_A^\bullet)$ is a
normalized dualizing complex for $B$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dualizing-finite} the complex
$\omega_B^\bullet$ is dualizing for $B$. We compute
$$
R\Hom_B(\kappa', R\Hom(B, \omega_A^\bullet)) =
R\Hom_A(\kappa', \omega_A^\bullet) \cong
\Hom_\kappa(\kappa', \kappa)[0]
$$
which is isomorphic in $D(\kappa')$ to $\kappa'$ placed in degree $0$
as desired. The first equality holds by Lemma \ref{lemma-right-adjoint}.
\end{proof}

\noindent
Let $f : X \to Y$ be a finite morphism of schemes. Let us denote
$$
R\SheafHom(f_*\mathcal{O}_X, -) :
D(\mathcal{O}_Y)
\longrightarrow
D(f_*\mathcal{O}_X)
$$
the functor right adjoint to the restriction functor. It is the right
derived functor of the left exact functor
$\textit{Mod}(\mathcal{O}_Y) \to \textit{Mod}(f_*\mathcal{O}_X)$
given by
$\mathcal{G} \mapsto \SheafHom_{\mathcal{O}_Y}(f_*\mathcal{O}_X, \mathcal{G})$.
See Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.

\begin{lemma}
\label{lemma-finite-twisted}
Let $f : X \to Y$ be a finite pseudo-coherent morphism of schemes
(any finite morphism of Noetherian schemes is pseudo-coherent).
The functor $R\SheafHom(f_*\mathcal{O}_X, -)$ maps
$D_\QCoh^+(\mathcal{O}_Y)$ into $D_\QCoh^+(f_*\mathcal{O}_X)$
and the diagram
$$
\xymatrix{
D_\QCoh^+(\mathcal{O}_Y) \ar[rr]_a \ar[rd]_{R\SheafHom(f_*\mathcal{O}_X, -)}
& & D_\QCoh^+(\mathcal{O}_X) \ar[ld]^\Phi \\
& D_\QCoh^+(f_*\mathcal{O}_X)
}
$$
is commutative, where $a$ is the right adjoint of
Lemma \ref{lemma-twisted-inverse-image} for $f$ and $\Phi$ is the equivalence
of Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-morphism-equivalence}.
\end{lemma}

\begin{proof}
(The parenthetical remark follows from More on Morphisms, Lemma
\ref{more-morphisms-lemma-Noetherian-pseudo-coherent}.)
Since $f$ is pseudo-coherent, the $\mathcal{O}_Y$-module $f_*\mathcal{O}_X$ is
pseudo-coherent, see More on Morphisms, Lemma
\ref{more-morphisms-lemma-finite-pseudo-coherent}.
Thus $R\SheafHom(f_*\mathcal{O}_X, -)$ maps
$D_\QCoh^+(\mathcal{O}_Y)$ into
$D_\QCoh^+(f_*\mathcal{O}_X)$, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-internal-hom}.
Then $\Phi \circ a$ and $R\SheafHom(f_*\mathcal{O}_X, -)$
agree on $D_\QCoh^+(\mathcal{O}_Y)$ because these functors are
both right adjoint to the restriction functor
$D_\QCoh^+(f_*\mathcal{O}_X) \to D_\QCoh^+(\mathcal{O}_Y)$.
\end{proof}

\begin{remark}
\label{remark-trace-map-finite}
If $f : X \to Y$ is a finite of Noetherian schemes, then the diagram
$$
\xymatrix{
Rf_*a(K) \ar[r]_-{\text{Tr}_{f, K}} \ar@{=}[d] & K \ar@{=}[d] \\
R\SheafHom(f_*\mathcal{O}_X, K) \ar[r] & K
}
$$
is commutative for $K \in D_\QCoh^+(\mathcal{O}_Y)$. This follows
from Lemma \ref{lemma-finite-twisted}. The lower horizontal
arrow is induced by the map $\mathcal{O}_Y \to f_*\mathcal{O}_X$ and the
upper horizontal arrow is the trace map discussed in
Section \ref{section-trace}.
\end{remark}

\begin{remark}
\label{remark-dualizing-finite}
Let $S$ be a Noetherian scheme and let $\omega_S^\bullet$ be a dualizing
complex. Let $f : X \to Y$ be a finite morphism between schemes of finite
type over $S$. Let $\omega_X^\bullet$ and $\omega_Y^\bullet$ be
dualizing complexes normalized relative to $\omega_S^\bullet$.
Then we have
$$
f_*\omega_X^\bullet = R\SheafHom(f_*\mathcal{O}_X, \omega_Y^\bullet)
$$
in $D_\QCoh^+(f_*\mathcal{O}_X)$ by Lemmas \ref{lemma-finite-twisted} and
\ref{lemma-proper-map-good-dualizing-complex}
and the trace map of Example \ref{example-trace-proper} is the map
$$
\text{Tr}_f : Rf_*\omega_X^\bullet = f_*\omega_X^\bullet =
R\SheafHom(f_*\mathcal{O}_X, \omega_Y^\bullet) \longrightarrow
\omega_Y^\bullet
$$
which often goes under the name ``evaluation at $1$''.
\end{remark}









\section{Riemann-Roch and duality}
\label{section-Riemann-Roch}

\noindent
Let $k$ be a field. Let $X$ be a proper scheme of dimension $\leq 1$
over $k$. In Varieties, Section \ref{varieties-section-divisors-curves}
we have defined the degree of a locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of constant rank by the formula
$$
\deg(\mathcal{E}) =
\chi(X, \mathcal{E}) - \text{rank}(\mathcal{E})\chi(X, \mathcal{O}_X)
$$
see Varieties, Definition \ref{varieties-definition-degree-invertible-sheaf}.
In the chapter on Chow Homology we defined the first chern class of
$\mathcal{E}$ as an operation on cycles
(Chow Homology, Section
\ref{chow-section-intersecting-chern-classes}) and we proved that
$$
\deg(\mathcal{E}) = \deg(c_1(\mathcal{E}) \cap [X]_1)
$$
see Chow Homology, Lemma \ref{chow-lemma-degree-vector-bundle}.
Combining the two we obtain a Riemann-Roch formula of the form
$$
\chi(X, \mathcal{E}) =
\deg(c_1(\mathcal{E}) \cap [X]_1) +
\text{rank}(\mathcal{E})\chi(X, \mathcal{O}_X)
$$
To obtain a true Riemann-Roch theorem we would like to write
$\chi(X, \mathcal{O}_X)$ as the degree of a canonical zero cycle on $X$.
We refer to \cite{F} for a fully general version of this. We will use
duality to get a formula in the case where $X$ is Gorenstein; however,
in some sense this is a cheat (for example because this method cannot
work in higher dimension).

\medskip\noindent
First, let us assume that $X$ is Cohen-Macaulay and equidimensional of
dimension $1$. Let $\omega_X$ be the dualizing module of $X$, normalized
as in Example \ref{example-equidimensional-over-field}. For a coherent
sheaf $\mathcal{F}$ on $X$ we have
$$
\text{Ext}^i_X(\mathcal{F}, \omega_X[1]) = \Hom_k(H^{-i}(X, \mathcal{F}), k)
$$
functorially in $\mathcal{F}$. This holds essentially by definition of
$\omega_X$; the real miracle of duality comes from the fact that a
right adjoint to pushforward exists and that it transforms dualizing complexes
into dualizing complexes. Concretely, this gives
$$
\Hom_X(\mathcal{F}, \omega_X) = \Hom_k(H^1(X, \mathcal{F}), k)
$$
for $i = -1$ and for $i = 0$ we obtain
$$
\text{Ext}^1_X(\mathcal{F}, \omega_X) = \Hom_k(H^0(X, \mathcal{F}), k)
$$
For all other values of $i$ we obtain $0 = 0$.
If $\mathcal{F}$ is locally free, then we
have
$$
\text{Ext}^1_X(\mathcal{F}, \omega_X) =
H^1(X, \SheafHom(\mathcal{F}, \mathcal{O}_X) \otimes_{\mathcal{O}_X} \omega_X)
=
H^1(X, \SheafHom(\mathcal{F}, \omega_X))
$$
In particular, if we apply this when $\mathcal{F}$ is an invertible
$\mathcal{O}_X$-module $\mathcal{L}$, then we obtain canonical isomorphisms
$$
H^0(X, \mathcal{L}^{\otimes - 1} \otimes \omega_X) =
\Hom_k(H^1(X, \mathcal{L}), k)
$$
and
$$
H^1(X, \mathcal{L}^{\otimes - 1} \otimes \omega_X) =
\Hom_k(H^0(X, \mathcal{L}), k)
$$
Finally setting $\mathcal{L} = \mathcal{O}_X$ we arrive at the
realization that
\begin{align*}
\chi(X, \mathcal{O}_X)
& =
\dim H^0(X, \mathcal{O}_X) - \dim H^1(X, \mathcal{O}_X) \\
& =
\dim H^1(X, \omega_X) - \dim H^0(X, \omega_X) \\
& =
-\chi(X, \omega_X)
\end{align*}
To use this to get a formula for $\chi(X, \mathcal{O}_X)$ we are
going to assume that $\omega_X$ is invertible, i.e., that $X$ is Gorenstein.

\medskip\noindent
Thus, let us now assume that $X$ is Gorenstein and equidimensional of
dimension $1$. In this case $\omega_X$ (normalized as above) is an
invertible $\mathcal{O}_X$-module and we can put it into our Riemann-Roch
formula above to get
$$
\chi(X, \omega_X) = 
\deg(c_1(\omega_X) \cap [X]_1) + \chi(X, \mathcal{O}_X)
$$
Combined with the above this gives
$$
2\chi(X, \mathcal{O}_X) = - \deg(c_1(\omega_X) \cap [X]_1) = - \deg(\omega_X)
$$
Thus $-1/2$ of the first chern class of $\omega_X$ capped with the
cycle $[X]_1$ associated to $X$ is a natural zero
cycle on $X$ with half-integer coefficients whose degree is equal to
the Euler characteristic of the structure sheaf of $X$.
All in all the Riemann-Roch theorem for a Gorenstein curve over $k$
says that
$$
\chi(X, \mathcal{E}) = \deg(\mathcal{E}) -
\frac{1}{2} \text{rank}(\mathcal{E}) \deg(\omega_X)
$$
for a locally free $\mathcal{O}_X$-module $\mathcal{E}$ of constant rank
keeping in mind that $\deg(\mathcal{E})$ and $\deg(\omega_X)$ can be
computed using intersection theoretic methods, and keeping in mind that
$$
\dim H^i(X, \mathcal{E}) =
\dim H^{1 - i}(X, \mathcal{E}^\wedge \otimes \omega_X)
$$
by duality.






\section{Some vanishing results}
\label{section-vanishing}

\noindent
In this section we work in the following situation.

\begin{situation}
\label{situation-Cohen-Macaulay-curve}
Here $k$ is a field and $X$ is a proper scheme over $k$ which
is Cohen-Macaulay, equidimensional of dimension $1$, and
has $H^0(X, \mathcal{O}_X) = k$. Let $\omega_X$ be the dualizing
sheaf of $X$ as in Example \ref{example-equidimensional-over-field}.
\end{situation}

\noindent
From the discussion in Section \ref{section-Riemann-Roch} we see that the
dualizing sheaf $\omega_X$ on $X$ has nonvanishing $H^1$. It turns out
that anything slightly more ``positive'' than $\omega_X$ has vanishing $H^1$.

\begin{lemma}
\label{lemma-vanishing}
In Situation \ref{situation-Cohen-Macaulay-curve}. Given an exact sequence
$$
\omega_X \to \mathcal{F} \to \mathcal{Q} \to 0
$$
of coherent $\mathcal{O}_X$-modules with $H^1(X, \mathcal{Q}) = 0$
(for example if $\dim(\text{Supp}(\mathcal{Q})) = 0$), then
either $H^1(X, \mathcal{F}) = 0$ or
$\mathcal{F} = \omega_X \oplus \mathcal{Q}$.
\end{lemma}

\begin{proof}
(The parenthetical statement follows from
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-dimension-0}.)
Since $H^0(X, \mathcal{O}_X) = k$ is dual to $H^1(X, \omega_X)$
(see Section \ref{section-Riemann-Roch})
we see that $\dim H^1(X, \omega_X) = 1$. The sheaf $\omega_X$
represents the functor
$\mathcal{F} \mapsto \Hom_k(H^1(X, \mathcal{F}), k)$
on the category of coherent $\mathcal{O}_X$-modules
(Lemma \ref{lemma-dualizing-module-proper-over-A}).
Consider an exact sequence as in the statement of the lemma
and assume that $H^1(X, \mathcal{F}) \not = 0$. Since
$H^1(X, \mathcal{Q}) = 0$ we see that
$H^1(X, \omega_X) \to H^1(X, \mathcal{F})$ is an isomorphism.
By the universal property of $\omega_X$ stated above, we conclude there
is a map $\mathcal{F} \to \omega_X$ whose action on $H^1$ is the inverse
of this isomorphism. The composition $\omega_X \to \mathcal{F} \to \omega_X$
is the identity (by the universal property) and the lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-twist}
In Situation \ref{situation-Cohen-Macaulay-curve}. Let
$\mathcal{L}$ be an invertible $\mathcal{O}_X$-module which is
globally generated and not isomorphic to $\mathcal{O}_X$. Then
$H^1(X, \omega_X \otimes \mathcal{L}) = 0$.
\end{lemma}

\begin{proof}
By duality as discussed in Section \ref{section-Riemann-Roch} we have to
show that $H^0(X, \mathcal{L}^{\otimes - 1}) = 0$. If not, then we can
choose a global section $t$ of $\mathcal{L}^{\otimes - 1}$
and a global section $s$ of $\mathcal{L}$ such that $st \not = 0$.
However, then $st$ is a constant multiple of $1$, by our assumption
that $H^0(X, \mathcal{O}_X) = k$. It follows that
$\mathcal{L} \cong \mathcal{O}_X$, which is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-globally-generated}
In Situation \ref{situation-Cohen-Macaulay-curve}. Given an exact sequence
$$
\omega_X \to \mathcal{F} \to \mathcal{Q} \to 0
$$
of coherent $\mathcal{O}_X$-modules with $\dim(\text{Supp}(\mathcal{Q})) = 0$
and $\dim_k H^0(X, \mathcal{Q}) \geq 2$ and such that there is no nonzero
submodule $\mathcal{Q}' \subset \mathcal{F}$ such that
$\mathcal{Q}' \to \mathcal{Q}$ is injective.
Then the submodule of $\mathcal{F}$ generated by global
sections surjects onto $\mathcal{Q}$.
\end{lemma}

\begin{proof}
Let $\mathcal{F}' \subset \mathcal{F}$ be the submodule generated by
global sections and the image of $\omega_X \to \mathcal{F}$. Since
$\dim_k H^0(X, \mathcal{Q}) \geq 2$ and
$\dim_k H^1(X, \omega_X) = \dim_k H^0(X, \mathcal{O}_X) = 1$,
we see that $\mathcal{F}' \to \mathcal{Q}$ is not zero and
$\omega_X \to \mathcal{F}'$ is not an isomorphism.
Hence $H^1(X, \mathcal{F}') = 0$ by Lemma \ref{lemma-vanishing}
and our assumption on $\mathcal{F}$.
Consider the short exact sequence
$$
0 \to \mathcal{F}' \to \mathcal{F} \to
\mathcal{Q}/\Im(\mathcal{F}' \to \mathcal{Q}) \to 0
$$
If the quotient on the right is nonzero, then we obtain a contradiction
because then $H^0(X, \mathcal{F})$ is bigger than $H^0(X, \mathcal{F}')$.
\end{proof}

\noindent
Here is an example global generation statement.

\begin{lemma}
\label{lemma-globally-generated-curve}
In Situation \ref{situation-Cohen-Macaulay-curve} assume that
$X$ is integral. Let $0 \to \omega_X \to \mathcal{F} \to \mathcal{Q} \to 0$
be a short exact sequence of coherent $\mathcal{O}_X$-modules with
$\mathcal{F}$ torsion free, $\dim(\text{Supp}(\mathcal{Q})) = 0$,
and $\dim_k H^0(X, \mathcal{Q}) \geq 2$. Then $\mathcal{F}$
is globally generated.
\end{lemma}

\begin{proof}
Consider the submodule $\mathcal{F}'$ generated by the global sections. By
Lemma \ref{lemma-globally-generated} we see that $\mathcal{F}' \to \mathcal{Q}$
is surjective, in particular $\mathcal{F}' \not = 0$. Since $X$ is a curve, we
see that $\mathcal{F}' \subset \mathcal{F}$ is an inclusion of rank $1$
sheaves, hence $\mathcal{Q}' = \mathcal{F}/\mathcal{F}'$ is supported in
finitely many points. To get a contradiction, assume that
$\mathcal{Q}'$ is nonzero. Then we see that $H^1(X, \mathcal{F}') \not = 0$.
Then we get a nonzero map $\mathcal{F}' \to \omega_X$ by the universal
property (Lemma \ref{lemma-dualizing-module-proper-over-A}).
The image of the composition $\mathcal{F}' \to \omega_X \to \mathcal{F}$
is generated by global sections, hence is inside of $\mathcal{F}'$.
Thus we get a nonzero self map $\mathcal{F}' \to \mathcal{F}'$.
Since $\mathcal{F}'$ is torsion free of rank $1$ on a proper curve
this has to be an automorphism (details omitted). But then this implies that
$\mathcal{F}'$ is contained in $\omega_X \subset \mathcal{F}$
contradicting the surjectivity of $\mathcal{F}' \to \mathcal{Q}$.
\end{proof}

\begin{lemma}
\label{lemma-tensor-omega-with-globally-generated-invertible}
In Situation \ref{situation-Cohen-Macaulay-curve}. Let $\mathcal{L}$
be a very ample invertible $\mathcal{O}_X$-module with
$\deg(\mathcal{L}) \geq 2$. Then
$\omega_X \otimes_{\mathcal{O}_X} \mathcal{L}$ is globally generated.
\end{lemma}

\begin{proof}
Assume $k$ is algebraically closed. Let $x \in X$ be a closed point.
Let $C_i \subset X$ be the irreducible components and for each $i$
let $x_i \in C_i$ be the generic point. By
Varieties, Lemma \ref{varieties-lemma-very-ample-vanish-at-point}
we can choose a section $s \in H^0(X, \mathcal{L})$ such that $s$
vanishes at $x$ but not at $x_i$ for all $i$. The corresponding
module map $s : \mathcal{O}_X \to \mathcal{L}$ is injective with
cokernel $\mathcal{Q}$ supported in finitely many points and
with $H^0(X, \mathcal{Q}) \geq 2$. Consider the corresponding
exact sequence
$$
0 \to \omega_X \to \omega_X \otimes \mathcal{L} \to
\omega_X \otimes \mathcal{Q} \to 0
$$
By Lemma \ref{lemma-globally-generated} we see that the module generated
by global sections surjects onto $\omega_X \otimes \mathcal{Q}$.
Since $x$ was arbitrary this proves the lemma. Some details omitted.

\medskip\noindent
We will reduce the case where $k$ is not algebraically closed, to
the algebraically closed field case. We suggest the reader skip
the rest of the proof. Choose an algebraic closure $\overline{k}$
of $k$ and consider the base change $X_{\overline{k}}$. Let us
check that $X_{\overline{k}} \to \Spec(\overline{k})$ is an example
of Situation \ref{situation-Cohen-Macaulay-curve}. By flat base change
(Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology})
we see that $H^0(X_{\overline{k}}, \mathcal{O}) = \overline{k}$.
By Varieties, Lemma \ref{varieties-lemma-CM-base-change}
we see that $X_{\overline{k}}$ is Cohen-Macaulay. The scheme
$X_{\overline{k}}$ is proper over $\overline{k}$ (Morphisms,
Lemma \ref{morphisms-lemma-base-change-proper}) and
equidimensional of dimension $1$
(Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}).
The pullback of $\omega_X$ to $X_{\overline{k}}$ is the dualizing
module of $X_{\overline{k}}$ by Lemma \ref{lemma-more-base-change}.
The pullback of $\mathcal{L}$ to $X_{\overline{k}}$ is very ample
(Morphisms, Lemma \ref{morphisms-lemma-very-ample-base-change}).
The degree of the pullback of $\mathcal{L}$ to $X_{\overline{k}}$
is equal to the degree of $\mathcal{L}$ on $X$ (Varieties, Lemma
\ref{varieties-lemma-degree-base-change}). Finally, we see that
$\omega_X \otimes \mathcal{L}$ is globally generated if and only
if its base change is so
(Varieties, Lemma \ref{varieties-lemma-globally-generated-base-change}).
In this way we see that the result follows from the result in the
case of an algebraically closed ground field.
\end{proof}







\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
