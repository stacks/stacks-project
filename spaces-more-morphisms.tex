\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Morphisms of Spaces}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we continue our study of properties of morphisms of algebraic
spaces. A fundamental reference is \cite{Kn}.





\section{Conventions}
\label{section-conventions}

\noindent
The standing assumption is that all schemes are contained in
a big fppf site $\Sch_{fppf}$. And all rings $A$ considered
have the property that $\Spec(A)$ is (isomorphic) to an
object of this big site.

\medskip\noindent
Let $S$ be a scheme and let $X$ be an algebraic space over $S$.
In this chapter and the following we will write $X \times_S X$
for the product of $X$ with itself (in the category of algebraic
spaces over $S$), instead of $X \times X$.








\section{Radicial morphisms}
\label{section-radicial}

\noindent
It turns out that a radicial morphism is not the same thing as a
universally injective morphism, contrary to what happens with
morphisms of schemes. In fact it is a bit stronger.

\begin{definition}
\label{definition-radicial}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. We say $f$ is {\it radicial} if for any morphism
$\Spec(K) \to Y$ where $K$ is a field the reduction
$(\Spec(K) \times_Y X)_{red}$ is either empty or
representable by the spectrum of a purely inseparable field extension of $K$.
\end{definition}

\begin{lemma}
\label{lemma-radicial-implies-universally-injective}
A radicial morphism of algebraic spaces is universally injective.
\end{lemma}

\begin{proof}
Let $S$ be a scheme. Let $f : X \to Y$ be a radicial
morphism of algebraic spaces over $S$.
It is clear from the definition that given a morphism
$\Spec(K) \to Y$ there is at most one lift of this morphism
to a morphism into $X$. Hence we conclude that $f$ is universally
injective by
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-universally-injective}.
\end{proof}

\begin{example}
\label{example-universally-injective-not-radicial}
It is no longer true that universally injective is equivalent to radicial.
For example the morphism
$$
X = [\Spec(\overline{\mathbf{Q}})/
\text{Gal}(\overline{\mathbf{Q}}/\mathbf{Q})]
\longrightarrow
S = \Spec(\mathbf{Q})
$$
of
Spaces, Example \ref{spaces-example-Qbar}
is universally injective, but is not radicial in the sense above.
\end{example}

\noindent
Nonetheless it is often the case that the reverse implication holds.

\begin{lemma}
\label{lemma-when-universally-injective-radicial}
Let $S$ be a scheme. Let $f : X \to Y$ be a universally injective
morphism of algebraic spaces over $S$.
\begin{enumerate}
\item If $f$ is decent then $f$ is radicial.
\item If $f$ is quasi-separated then $f$ is radicial.
\item If $f$ is locally separated then $f$ is radicial.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathcal{P}$ be a property of morphisms of algebraic spaces
which is stable under base change and composition and holds for
closed immersions. Assume $f : X \to Y$ has $\mathcal{P}$ and
is universally injective. Then, in the situation of
Definition \ref{definition-radicial}
the morphism $(\Spec(K) \times_Y X)_{red} \to \Spec(K)$
is universally injective and has $\mathcal{P}$. This reduces the
problem of proving
$$
\mathcal{P} + \text{universally injective}
\Rightarrow
\text{radicial}
$$
to the problem of proving that any nonempty reduced algebraic space $X$
over field whose structure morphism $X \to \Spec(K)$ is universally
injective and $\mathcal{P}$ is representable by the spectrum of a field.
Namely, then $X \to \Spec(K)$ will be a morphism of schemes and
we conclude by the equivalence of radicial and universally injective for
morphisms of schemes, see
Morphisms, Lemma \ref{morphisms-lemma-universally-injective}.

\medskip\noindent
Let us prove (1). Assume $f$ is decent and universally injective. By
Decent Spaces,
Lemmas \ref{decent-spaces-lemma-base-change-relative-conditions},
\ref{decent-spaces-lemma-composition-relative-conditions}, and
\ref{decent-spaces-lemma-properties-trivial-implications}
(to see that an immersion is decent) we see that the discussion in
the first paragraph applies.
Let $X$ be a nonempty decent reduced algebraic space
universally injective over a field $K$. In particular we see that $|X|$
is a singleton. By
Decent Spaces, Lemma \ref{decent-spaces-lemma-when-field}
we conclude that $X \cong \Spec(L)$ for some extension
$K \subset L$ as desired.

\medskip\noindent
A quasi-separated morphism is decent, see
Decent Spaces,
Lemma \ref{decent-spaces-lemma-properties-trivial-implications}.
Hence (1) implies (2).

\medskip\noindent
Let us prove (3).
Recall that the separation axioms are stable under base change
and composition and that closed immersions are separated, see
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-base-change-separated},
\ref{spaces-morphisms-lemma-composition-separated}, and
\ref{spaces-morphisms-lemma-immersions-monomorphisms}.
Thus the discussion in the first paragraph of the proof applies.
Let $X$ be a reduced algebraic space universally injective and
locally separated over a field $K$.
In particular $|X|$ is a singleton hence $X$ is quasi-compact, see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-quasi-compact-space}.
We can find a surjective \'etale morphism $U \to X$ with $U$ affine, see
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-quasi-compact-affine-cover}.
Consider the morphism of schemes
$$
j :
U \times_X U
\longrightarrow
U \times_{\Spec(K)} U
$$
As $X \to \Spec(K)$ is universally injective $j$ is surjective,
and as $X \to \Spec(K)$ is locally separated $j$ is an immersion.
A surjective immersion is a closed immersion, see
Schemes, Lemma \ref{schemes-lemma-immersion-when-closed}.
Hence $R = U \times_X U$ is affine as a closed subscheme of an affine scheme.
In particular $R$ is quasi-compact.
It follows that $X = U/R$ is quasi-separated, and the result follows from (2).
\end{proof}

\begin{remark}
\label{remark-weakly-radicial}
Let $X \to Y$ be a morphism of algebraic spaces.
For some applications (of radicial morphisms)
it is enough to require that for every
$\Spec(K) \to Y$ where $K$ is a field
\begin{enumerate}
\item the space $|\Spec(K) \times_Y X|$ is a singleton,
\item there exists a monomorphism
$\Spec(L) \to \Spec(K) \times_Y X$, and
\item $K \subset L$ is purely inseparable.
\end{enumerate}
If needed later we will may call such a morphism {\it weakly radicial}.
For example if $X \to Y$ is a surjective weakly radicial morphism
then $X(k) \to Y(k)$ is surjective for every algebraically closed field $k$.
Note that the base change
$X_{\overline{\mathbf{Q}}} \to \Spec(\overline{\mathbf{Q}})$
of the morphism in
Example \ref{example-universally-injective-not-radicial}
is weakly radicial, but not radicial. The analogue of
Lemma \ref{lemma-when-universally-injective-radicial}
is that if $X \to Y$ has property ($\beta$) and is universally
injective, then it is weakly radicial (proof omitted).
\end{remark}

\begin{lemma}
\label{lemma-check-universally-injective}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic
spaces over $S$. Assume
\begin{enumerate}
\item $f$ is locally of finite type,
\item for every \'etale morphism $V \to Y$ the map $|X \times_Y V| \to |V|$
is injective.
\end{enumerate}
Then $f$ is universally injective.
\end{lemma}

\begin{proof}
The question is \'etale local on $Y$ by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-injective-local}.
Hence we may assume that $Y$ is a scheme.
Then $Y$ is in particular decent and by Decent Spaces, Lemma
\ref{decent-spaces-lemma-conditions-on-point-in-fibre-and-qf}
we see that $f$ is locally quasi-finite.
Let $y \in Y$ be a point and let $X_y$ be the scheme theoretic
fibre. Assume $X_y$ is not empty. By Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-locally-quasi-finite-over-field}
we see that $X_y$ is a scheme which is locally quasi-finite over
$\kappa(y)$. Since $|X_y| \subset |X|$ is the fibre of $|X| \to |Y|$
over $y$ we see that $X_y$ has a unique point $x$. The same is true
for $X_y \times_{\Spec(\kappa(y))} \Spec(k)$ for any
finite separable extension $\kappa(y) \subset k$
because we can realize $k$ as the residue field at a point
lying over $y$ in an \'etale scheme over $Y$, see
see More on Morphisms, Lemma
\ref{more-morphisms-lemma-realize-prescribed-residue-field-extension-etale}.
Thus $X_y$ is geometrically connected, see
Varieties, Lemma \ref{varieties-lemma-characterize-geometrically-disconnected}.
This implies that the finite extension $\kappa(y) \subset \kappa(x)$
is purely inseparable.

\medskip\noindent
We conclude (in the case that $Y$ is a scheme)
that for every $y \in Y$ either the fibre $X_y$ is empty,
or $(X_y)_{red} = \Spec(\kappa(x))$ with
$\kappa(y) \subset \kappa(x)$ purely inseparable.
Hence $f$ is radicial (some details omitted), whence universally injective by
Lemma \ref{lemma-radicial-implies-universally-injective}.
\end{proof}




\section{Monomorphisms}
\label{section-monomorphisms}

\noindent
This section is the continuation of
Morphisms of Spaces, Section \ref{spaces-morphisms-section-monomorphisms}.
We would like to know whether or not every monomorphism of algebraic
spaces is representable. If you can prove this is true or have a
counterexample, please email
\href{mailto:stacks.project@gmail.com}{stacks.project@gmail.com}.
For the moment this is known in the following cases
\begin{enumerate}
\item for monomorphisms which are locally of finite type
(more generally any separated, locally quasi-finite morphism
is representable by Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite-separated-representable}
and a monomorphism which is locally of finite type is
locally quasi-finite by Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-monomorphism-loc-finite-type-loc-quasi-finite}),
\item if the target is a disjoint union of spectra of zero dimensional
local rings (Decent Spaces, Lemma
\ref{decent-spaces-lemma-monomorphism-toward-disjoint-union-dim-0-rings}), and
\item for flat monomorphisms (see below).
\end{enumerate}

\begin{lemma}[David Rydh]
\label{lemma-flat-case}
A flat monomorphism of algebraic spaces is representable by schemes.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ be a flat morphism of algebraic spaces.
To prove $f$ is representable, we have to show
$X \times_Y V$ is a scheme for every scheme $V$ mapping to $Y$.
Since being a scheme is local (Properties of Spaces, 
Lemma \ref{spaces-properties-lemma-subscheme}), we may
assume $V$ is affine. Thus we may assume $Y = \Spec(B)$
is an affine scheme. Next, we can assume that $X$ is quasi-compact
by replacing $X$ by a quasi-compact open. The space $X$ is
separated as $X \to X \times_{\Spec(B)} X$ is an isomorphism.
Applying Limits of Spaces, Lemma \ref{spaces-limits-lemma-enough-local}
we reduce to the case where $B$ is local, $X \to \Spec(B)$ is a
flat monomorphism, and
there exists a point $x \in X$ mapping to the closed point of $\Spec(B)$.
Then $X \to \Spec(B)$ is surjective as generalizations
lift along flat morphisms of separated algebraic spaces, see
Decent Spaces, Lemma \ref{decent-spaces-lemma-generalizations-lift-flat}.
Hence we see that $\{X \to \Spec(B)\}$ is an fpqc cover.
Then $X \to \Spec(B)$ is a morphism which becomes an isomorphism
after base change by $X \to \Spec(B)$. Hence it is an isomorphism by
fpqc descent, see Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-isomorphism}.
\end{proof}

\noindent
The following is (in some sense) a variant of the lemma above.

\begin{lemma}
\label{lemma-ui-case}
Let $S$ be a scheme. Let $f : X \to Y$ be a quasi-compact monomorphism
of algebraic spaces $f : X \to Y$ such that for every $T \to X$ the map
$$
\mathcal{O}_T \to f_{T,*}\mathcal{O}_{X \times_Y T}
$$
is injective. Then $f$ is an isomorphism (and hence representable by schemes).
\end{lemma}

\begin{proof}
The question is \'etale local on $Y$, hence we may assume $Y = \Spec(A)$
is affine. Then $X$ is quasi-compact and we may choose an affine scheme
$U = \Spec(B)$ and a surjective \'etale morphism $U \to X$
(Properties of Spaces, Lemma
\ref{spaces-properties-lemma-quasi-compact-affine-cover}).
Note that $U \times_X U = \Spec(B \otimes_A B)$. Hence the category of
quasi-coherent $\mathcal{O}_X$-modules is equivalent to the
category $DD_{B/A}$ of descent data on modules for $A \to B$.
See Properties of Spaces, Proposition
\ref{spaces-properties-proposition-quasi-coherent},
Descent, Definition \ref{descent-definition-descent-datum-modules}, and
Descent, Subsection \ref{descent-subsection-descent-modules-morphisms}.
On the other hand,
$$
A \to B
$$
is a universally injective ring map. Namely, given an
$A$-module $M$ we see that $A \oplus M \to B \otimes_A (A \oplus M)$
is injective by the assumption of the lemma. Hence
$DD_{B/A}$ is equivalent to the category of $A$-modules by
Descent, Theorem \ref{descent-theorem-descent}. Thus pullback along
$f : X \to \Spec(A)$ determines an equivalence of categories of
quasi-coherent modules. In particular $f^*$ is exact on
quasi-coherent modules and we see that $f$ is flat
(small detail omitted). Moreover, it is clear that $f$ is surjective
(for example because $\Spec(B) \to \Spec(A)$ is surjective).
Hence we see that $\{X \to \Spec(A)\}$ is an fpqc cover.
Then $X \to \Spec(A)$ is a morphism which becomes an isomorphism
after base change by $X \to \Spec(A)$. Hence it is an isomorphism by
fpqc descent, see Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-isomorphism}.
\end{proof}

\begin{lemma}
\label{lemma-flat-surjective-monomorphism}
A quasi-compact flat surjective monomorphism of algebraic spaces
is an isomorphism.
\end{lemma}

\begin{proof}
Such a morphism satisfies the assumptions of Lemma \ref{lemma-ui-case}.
\end{proof}







\section{Conormal sheaf of an immersion}
\label{section-conormal-sheaf}

\noindent
Let $S$ be a scheme. Let $i : Z \to X$ be a closed immersion of algebraic
spaces over $S$. Let $\mathcal{I} \subset \mathcal{O}_X$ be the corresponding
quasi-coherent sheaf of ideals, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Consider the short exact sequence
$$
0 \to \mathcal{I}^2 \to \mathcal{I} \to \mathcal{I}/\mathcal{I}^2 \to 0
$$
of quasi-coherent sheaves on $X$. Since the sheaf $\mathcal{I}/\mathcal{I}^2$
is annihilated by $\mathcal{I}$ it corresponds to a sheaf on $Z$ by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-i-star-equivalence}.
This quasi-coherent $\mathcal{O}_Z$-module is the
{\it conormal sheaf of $Z$ in $X$} and is often denoted
$\mathcal{I}/\mathcal{I}^2$ by the abuse of notation mentioned in
Morphisms of Spaces,
Section \ref{spaces-morphisms-section-closed-immersions-quasi-coherent}.

\medskip\noindent
In case $i : Z \to X$ is a (locally closed) immersion we define the
conormal sheaf of $i$ as the conormal sheaf of the closed
immersion $i : Z \to X \setminus \partial Z$, see
Morphisms of Spaces, Remark \ref{spaces-morphisms-remark-immersion}.
It is often denoted
$\mathcal{I}/\mathcal{I}^2$ where $\mathcal{I}$ is the ideal sheaf
of the closed immersion $i : Z \to X \setminus \partial Z$.

\begin{definition}
\label{definition-conormal-sheaf}
Let $i : Z \to X$ be an immersion. The {\it conormal sheaf
$\mathcal{C}_{Z/X}$ of $Z$ in $X$} or the {\it conormal sheaf of $i$}
is the quasi-coherent $\mathcal{O}_Z$-module $\mathcal{I}/\mathcal{I}^2$
described above.
\end{definition}

\noindent
In \cite[IV Definition 16.1.2]{EGA} this sheaf is denoted
$\mathcal{N}_{Z/X}$. We will not follow this convention since we would
like to reserve the notation $\mathcal{N}_{Z/X}$
for the {\it normal sheaf of the immersion}. It is defined as
$$
\mathcal{N}_{Z/X} =
\SheafHom_{\mathcal{O}_Z}(\mathcal{C}_{Z/X}, \mathcal{O}_Z) =
\SheafHom_{\mathcal{O}_Z}(\mathcal{I}/\mathcal{I}^2, \mathcal{O}_Z)
$$
provided the conormal sheaf is of finite presentation (otherwise the
normal sheaf may not even be quasi-coherent). We will come back to the
normal sheaf later (insert future reference here).

\begin{lemma}
\label{lemma-etale-conormal}
Let $S$ be a scheme. Let $i : Z \to X$ be an immersion.
Let $\varphi : U \to X$ be an \'etale morphism where $U$ is a scheme.
Set $Z_U = U \times_X Z$ which is a locally closed subscheme of $U$.
Then
$$
\mathcal{C}_{Z/X}|_{Z_U} = \mathcal{C}_{Z_U/U}
$$
canonically and functorially in $U$.
\end{lemma}

\begin{proof}
Let $T \subset X$ be a closed subspace such that $i$ defines a closed
immersion into $X \setminus T$.
Let $\mathcal{I}$ be the quasi-coherent sheaf of ideals on
$X \setminus T$ defining $Z$. Then the lemma just states that
$\mathcal{I}|_{U \setminus \varphi^{-1}(T)}$ is the sheaf of ideals of
the immersion $Z_U \to U \setminus \varphi^{-1}(T)$.
This is clear from the construction of $\mathcal{I}$ in
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a commutative diagram of algebraic spaces over $S$.
Assume $i$, $i'$ immersions. There is a canonical map
of $\mathcal{O}_Z$-modules
$$
f^*\mathcal{C}_{Z'/X'}
\longrightarrow
\mathcal{C}_{Z/X}
$$
\end{lemma}

\begin{proof}
First find open subspaces $U' \subset X'$ and $U \subset X$ such that
$g(U) \subset U'$ and such that $i(Z) \subset U$ and $i(Z') \subset U'$
are closed (proof existence omitted). Replacing $X$ by $U$ and $X'$ by
$U'$ we may assume that $i$ and $i'$ are closed immersions.
Let $\mathcal{I}' \subset \mathcal{O}_{X'}$ and
$\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent sheaves of
ideals associated to $i'$ and $i$, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Consider the composition
$$
g^{-1}\mathcal{I}' \to g^{-1}\mathcal{O}_{X'}
\xrightarrow{g^\sharp} \mathcal{O}_X \to
\mathcal{O}_X/\mathcal{I} = i_*\mathcal{O}_Z
$$
Since $g(i(Z)) \subset Z'$ we conclude this composition is zero (see
statement on factorizations in
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}).
Thus we obtain a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\mathcal{I} \ar[r] &
\mathcal{O}_X \ar[r] &
i_*\mathcal{O}_Z \ar[r] &
0 \\
0 \ar[r] &
g^{-1}\mathcal{I}' \ar[r] \ar[u] &
g^{-1}\mathcal{O}_{X'} \ar[r] \ar[u] &
g^{-1}i'_*\mathcal{O}_{Z'} \ar[r] \ar[u] &
0
}
$$
The lower row is exact since $g^{-1}$ is an exact functor.
By exactness we also see that
$(g^{-1}\mathcal{I}')^2 = g^{-1}((\mathcal{I}')^2)$.
Hence the diagram induces a map
$g^{-1}(\mathcal{I}'/(\mathcal{I}')^2) \to \mathcal{I}/\mathcal{I}^2$.
Pulling back (using $i^{-1}$ for example) to $Z$ we obtain
$i^{-1}g^{-1}(\mathcal{I}'/(\mathcal{I}')^2) \to \mathcal{C}_{Z/X}$.
Since $i^{-1}g^{-1} = f^{-1}(i')^{-1}$ this gives a map
$f^{-1}\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$, which induces
the desired map.
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial-more}
Let $S$ be a scheme. The conormal sheaf of
Definition \ref{definition-conormal-sheaf}, and its functoriality of
Lemma \ref{lemma-conormal-functorial}
satisfy the following properties:
\begin{enumerate}
\item If $Z \to X$ is an immersion of schemes over $S$, then the conormal
sheaf agrees with the one from
Morphisms, Definition \ref{morphisms-definition-conormal-sheaf}.
\item If in
Lemma \ref{lemma-conormal-functorial}
all the spaces are schemes, then the map
$f^*\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$ is the same
as the one constructed in
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial}.
\item Given a commutative diagram
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} \ar[d]_{f'} & X' \ar[d]^{g'} \\
Z'' \ar[r]^{i''} & X''
}
$$
then the map $(f' \circ f)^*\mathcal{C}_{Z''/X''} \to \mathcal{C}_{Z/X}$
is the same as the composition of
$f^*\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$
with the pullback by $f$ of
$(f')^*\mathcal{C}_{Z''/X''} \to \mathcal{C}_{Z'/X'}$
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Note that Part (1) is a special case of
Lemma \ref{lemma-etale-conormal}.
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial-flat}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a fibre product diagram of algebraic spaces over $S$. Assume
$i$, $i'$ immersions. Then the canonical map
$f^*\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$ of
Lemma \ref{lemma-conormal-functorial}
is surjective. If $g$ is flat, then it is an isomorphism.
\end{lemma}

\begin{proof}
Choose a commutative diagram
$$
\xymatrix{
U \ar[r] \ar[d] & X \ar[d] \\
U' \ar[r] & X'
}
$$
where $U$, $U'$ are schemes and the horizontal arrows are surjective
and \'etale, see
Spaces, Lemma \ref{spaces-lemma-lift-morphism-presentations}.
Then using
Lemmas \ref{lemma-etale-conormal} and \ref{lemma-conormal-functorial-more}
we see that the question reduces to the case of a morphism of schemes.
In the schemes case this is
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial-flat}.
\end{proof}

\begin{lemma}
\label{lemma-transitivity-conormal}
Let $S$ be a scheme.
Let $Z \to Y \to X$ be immersions of algebraic spaces.
Then there is a canonical exact sequence
$$
i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
where the maps come from
Lemma \ref{lemma-conormal-functorial}
and $i : Z \to Y$ is the first morphism.
\end{lemma}

\begin{proof}
Let $U$ be a scheme and let $U \to X$ be a surjective \'etale morphism. Via
Lemmas \ref{lemma-etale-conormal} and \ref{lemma-conormal-functorial-more}
the exactness of the sequence translates immediately into the
exactness of the corresponding sequence for the immersions of schemes
$Z \times_X U \to Y \times_X U \to U$. Hence the lemma follows from
Morphisms, Lemma \ref{morphisms-lemma-transitivity-conormal}.
\end{proof}








\section{The normal cone of an immersion}
\label{section-normal-cone}

\noindent
Let $S$ be a scheme. Let $i : Z \to X$ be a closed immersion of algebraic
spaces over $S$. Let $\mathcal{I} \subset \mathcal{O}_X$ be the
corresponding quasi-coherent sheaf of ideals, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Consider the quasi-coherent sheaf of graded $\mathcal{O}_X$-algebras
$\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$.
Since the sheaves $\mathcal{I}^n/\mathcal{I}^{n + 1}$
are each annihilated by $\mathcal{I}$ this graded algebra
corresponds to a quasi-coherent sheaf of graded $\mathcal{O}_Z$-algebras by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-i-star-equivalence}.
This quasi-coherent graded $\mathcal{O}_Z$-algebra is called the
{\it conormal algebra of $Z$ in $X$} and is often simply denoted
$\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$
by the abuse of notation mentioned in
Morphisms of Spaces, Section
\ref{spaces-morphisms-section-closed-immersions-quasi-coherent}.

\medskip\noindent
In case $i : Z \to X$ is a (locally closed) immersion we define the conormal
algebra of $i$ as the conormal algebra of the closed immersion
$i : Z \to X \setminus \partial Z$, see Morphisms of Spaces, Remark
\ref{spaces-morphisms-remark-immersion}.
It is often denoted
$\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$
where $\mathcal{I}$ is the ideal sheaf
of the closed immersion $i : Z \to X \setminus \partial Z$.

\begin{definition}
\label{definition-conormal-algebra}
Let $i : Z \to X$ be an immersion. The {\it conormal algebra
$\mathcal{C}_{Z/X, *}$ of $Z$ in $X$} or the {\it conormal algebra of $i$}
is the quasi-coherent sheaf of graded $\mathcal{O}_Z$-algebras
$\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$ described above.
\end{definition}

\noindent
Thus $\mathcal{C}_{Z/X, 1} = \mathcal{C}_{Z/X}$ is the conormal sheaf
of the immersion. Also $\mathcal{C}_{Z/X, 0} = \mathcal{O}_Z$ and
$\mathcal{C}_{Z/X, n}$ is a quasi-coherent $\mathcal{O}_Z$-module
characterized by the property
\begin{equation}
\label{equation-conormal-in-degree-n}
i_*\mathcal{C}_{Z/X, n} = \mathcal{I}^n/\mathcal{I}^{n + 1}
\end{equation}
where $i : Z \to X \setminus \partial Z$ and $\mathcal{I}$ is the ideal
sheaf of $i$ as above. Finally, note that there is a canonical surjective map
\begin{equation}
\label{equation-conormal-algebra-quotient}
\text{Sym}^*(\mathcal{C}_{Z/X}) \longrightarrow \mathcal{C}_{Z/X, *}
\end{equation}
of quasi-coherent graded $\mathcal{O}_Z$-algebras which is an isomorphism
in degrees $0$ and $1$.

\begin{lemma}
\label{lemma-etale-conormal-algebra}
Let $S$ be a scheme. Let $i : Z \to X$ be an immersion of algebraic spaces
over $S$. Let $\varphi : U \to X$ be an \'etale morphism where $U$ is a
scheme. Set $Z_U = U \times_X Z$ which is a locally closed subscheme of $U$.
Then
$$
\mathcal{C}_{Z/X, *}|_{Z_U} = \mathcal{C}_{Z_U/U, *}
$$
canonically and functorially in $U$.
\end{lemma}

\begin{proof}
Let $T \subset X$ be a closed subspace such that $i$ defines a closed
immersion into $X \setminus T$. Let $\mathcal{I}$ be the quasi-coherent
sheaf of ideals on $X \setminus T$ defining $Z$. Then the lemma follows
from the fact that
$\mathcal{I}|_{U \setminus \varphi^{-1}(T)}$ is the sheaf of ideals of
the immersion $Z_U \to U \setminus \varphi^{-1}(T)$.
This is clear from the construction of $\mathcal{I}$ in
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-closed-immersion-ideals}.
\end{proof}

\begin{lemma}
\label{lemma-conormal-algebra-functorial}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a commutative diagram of algebraic spaces over $S$.
Assume $i$, $i'$ immersions. There is a canonical map
of graded $\mathcal{O}_Z$-algebras
$$
f^*\mathcal{C}_{Z'/X', *}
\longrightarrow
\mathcal{C}_{Z/X, *}
$$
\end{lemma}

\begin{proof}
First find open subspaces $U' \subset X'$ and $U \subset X$ such that
$g(U) \subset U'$ and such that $i(Z) \subset U$ and $i(Z') \subset U'$
are closed (proof existence omitted). Replacing $X$ by $U$ and $X'$ by
$U'$ we may assume that $i$ and $i'$ are closed immersions.
Let $\mathcal{I}' \subset \mathcal{O}_{X'}$ and
$\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent sheaves of
ideals associated to $i'$ and $i$, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Consider the composition
$$
g^{-1}\mathcal{I}' \to g^{-1}\mathcal{O}_{X'}
\xrightarrow{g^\sharp} \mathcal{O}_X \to
\mathcal{O}_X/\mathcal{I} = i_*\mathcal{O}_Z
$$
Since $g(i(Z)) \subset Z'$ we conclude this composition is zero (see
statement on factorizations in
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}).
Thus we obtain a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\mathcal{I} \ar[r] &
\mathcal{O}_X \ar[r] &
i_*\mathcal{O}_Z \ar[r] &
0 \\
0 \ar[r] &
g^{-1}\mathcal{I}' \ar[r] \ar[u] &
g^{-1}\mathcal{O}_{X'} \ar[r] \ar[u] &
g^{-1}i'_*\mathcal{O}_{Z'} \ar[r] \ar[u] &
0
}
$$
The lower row is exact since $g^{-1}$ is an exact functor.
By exactness we also see that
$(g^{-1}\mathcal{I}')^n = g^{-1}((\mathcal{I}')^n)$ for all $n \geq 1$.
Hence the diagram induces a map
$g^{-1}((\mathcal{I}')^n/(\mathcal{I}')^{n + 1}) \to
\mathcal{I}^n/\mathcal{I}^{n + 1}$.
Pulling back (using $i^{-1}$ for example) to $Z$ we obtain
$i^{-1}g^{-1}((\mathcal{I}')^n/(\mathcal{I}')^{n + 1}) \to
\mathcal{C}_{Z/X, n}$.
Since $i^{-1}g^{-1} = f^{-1}(i')^{-1}$ this gives maps
$f^{-1}\mathcal{C}_{Z'/X', n} \to \mathcal{C}_{Z/X, n}$, which induce
the desired map.
\end{proof}

\begin{lemma}
\label{lemma-conormal-algebra-functorial-flat}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a cartesion square of algebraic spaces over $S$ with
$i$, $i'$ immersions. Then the canonical map
$f^*\mathcal{C}_{Z'/X', *} \to \mathcal{C}_{Z/X, *}$ of
Lemma \ref{lemma-conormal-algebra-functorial}
is surjective. If $g$ is flat, then it is an isomorphism.
\end{lemma}

\begin{proof}
We may check the statement after \'etale localizing $X'$.
In this case we may assume $X' \to X$ is a morphism of schemes,
hence $Z$ and $Z'$ are schemes and the result follows from
the case of schemes, see
Divisors, Lemma \ref{divisors-lemma-conormal-algebra-functorial-flat}.
\end{proof}

\noindent
We use the same conventions for cones and vector bundles over
algebraic spaces as we do for schemes (where we use
the conventions of EGA), see
Constructions, Sections \ref{constructions-section-cone} and
\ref{constructions-section-vector-bundle}.
In particular, a vector bundle is a very general gadget
(and not locally isomorphic to an affine space bundle).

\begin{definition}
\label{definition-normal-cone}
Let $S$ be a scheme. Let $i : Z \to X$ be an immersion of algebraic spaces
over $S$. The {\it normal cone $C_ZX$} of $Z$ in $X$ is
$$
C_ZX = \underline{\Spec}_Z(\mathcal{C}_{Z/X, *})
$$
see Morphisms of Spaces,
Definition \ref{spaces-morphisms-definition-relative-spec}. The
{\it normal bundle} of $Z$ in $X$ is the vector bundle
$$
N_ZX = \underline{\Spec}_Z(\text{Sym}(\mathcal{C}_{Z/X}))
$$
\end{definition}

\noindent
Thus $C_ZX \to Z$ is a cone over $Z$ and $N_ZX \to Z$ is a vector bundle
over $Z$. Moreover, the canonical surjection
(\ref{equation-conormal-algebra-quotient}) of graded algebras
defines a canonical closed immersion
\begin{equation}
\label{equation-normal-cone-in-normal-bundle}
C_ZX \longrightarrow N_ZX
\end{equation}
of cones over $Z$.










\section{Sheaf of differentials of a morphism}
\label{section-sheaf-differentials}

\noindent
We suggest the reader take a look at the corresponding section
in the chapter on commutative algebra
(Algebra, Section \ref{algebra-section-differentials}),
the corresponding section in the chapter on morphism of schemes
(Morphisms, Section \ref{morphisms-section-sheaf-differentials})
as well as
Modules on Sites, Section \ref{sites-modules-section-differentials}.
We first show that the notion of sheaf of differentials for a
morphism of schemes agrees with the corresponding morphism of
small \'etale (ringed) sites.

\medskip\noindent
To clearly state the following lemma we temporarily go back to
denoting $\mathcal{F}^a$ the sheaf of $\mathcal{O}_{X_\etale}$-modules
associated to a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$
on the scheme $X$, see
Descent, Definition \ref{descent-definition-structure-sheaf}.

\begin{lemma}
\label{lemma-match-modules-differentials}
Let $f : X \to Y$ be a morphism of schemes. Let
$f_{small} : X_\etale \to Y_\etale$ be the associated
morphism of small \'etale sites, see
Descent, Remark \ref{descent-remark-change-topologies-ringed}.
Then there is a canonical isomorphism
$$
(\Omega_{X/Y})^a = \Omega_{X_\etale/Y_\etale}
$$
compatible with universal derivations. Here the first module
is the sheaf on $X_\etale$ associated
to the quasi-coherent $\mathcal{O}_X$-module $\Omega_{X/Y}$, see
Morphisms, Definition \ref{morphisms-definition-sheaf-differentials},
and the second module is the one from
Modules on Sites,
Definition \ref{sites-modules-definition-module-differentials}.
\end{lemma}

\begin{proof}
Let $h : U \to X$ be an \'etale morphism. In this case the natural map
$h^*\Omega_{X/Y} \to \Omega_{U/Y}$ is an isomorphism, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-sheaf-differentials-etale-localization}.
This means that there is a natural $\mathcal{O}_{Y_\etale}$-derivation
$$
\text{d}^a : \mathcal{O}_{X_\etale} \longrightarrow (\Omega_{X/Y})^a
$$
since we have just seen that the value of $(\Omega_{X/Y})^a$ on any object
$U$ of $X_\etale$ is canonically identified with
$\Gamma(U, \Omega_{U/Y})$. By the universal property of
$\text{d}_{X/Y} :
\mathcal{O}_{X_\etale}
\to
\Omega_{X_\etale/Y_\etale}$
there is a unique $\mathcal{O}_{X_\etale}$-linear map
$c : \Omega_{X_\etale/Y_\etale} \to (\Omega_{X/Y})^a$
such that
$\text{d}^a = c \circ \text{d}_{X/Y}$.

\medskip\noindent
Conversely, suppose that $\mathcal{F}$ is an
$\mathcal{O}_{X_\etale}$-module
and $D : \mathcal{O}_{X_\etale} \to \mathcal{F}$ is a
$\mathcal{O}_{Y_\etale}$-derivation. Then we can simply restrict
$D$ to the small Zariski site $X_{Zar}$ of $X$. Since sheaves on $X_{Zar}$
agree with sheaves on $X$, see
Descent, Remark \ref{descent-remark-Zariski-site-space},
we see that $D|_{X_{Zar}} : \mathcal{O}_X \to \mathcal{F}|_{X_{Zar}}$
is just a ``usual'' $Y$-derivation. Hence we obtain a map
$\psi : \Omega_{X/Y} \longrightarrow \mathcal{F}|_{X_{Zar}}$
such that $D|_{X_{Zar}} = \psi \circ \text{d}$. In particular, if we
apply this with $\mathcal{F} = \Omega_{X_\etale/Y_\etale}$
we obtain a map
$$
c' :
\Omega_{X/Y}
\longrightarrow
\Omega_{X_\etale/Y_\etale}|_{X_{Zar}}
$$
Consider the morphism of ringed sites
$\text{id}_{small, \etale, Zar} : X_\etale \to X_{Zar}$
discussed in
Descent, Remark \ref{descent-remark-change-topologies-ringed} and
Lemma \ref{descent-lemma-compare-sites}.
Since the restriction functor $\mathcal{F} \mapsto \mathcal{F}|_{X_{Zar}}$
is equal to $\text{id}_{small, \etale, Zar, *}$, since
$\text{id}_{small, \etale, Zar}^*$ is left adjoint to
$\text{id}_{small, \etale, Zar, *}$ and since
$(\Omega_{X/Y})^a = \text{id}_{small, \etale, Zar}^*\Omega_{X/Y}$
we see that $c'$ is adjoint to a map
$$
c'' :
(\Omega_{X/Y})^a
\longrightarrow
\Omega_{X_\etale/Y_\etale}.
$$
We claim that $c''$ and $c'$ are mutually inverse.
This claim finishes the proof of the lemma.
To see this it is enough to show that $c''(\text{d}(f)) = \text{d}_{X/Y}(f)$
and $c(\text{d}_{X/Y}(f)) = \text{d}(f)$ if $f$ is a local section of
$\mathcal{O}_X$ over an open of $X$. We omit the verification.
\end{proof}

\noindent
This clears the way for the following definition. For an alternative, see
Remark \ref{remark-alternative}.

\begin{definition}
\label{definition-sheaf-differentials}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. The {\it sheaf of differentials $\Omega_{X/Y}$ of $X$ over $Y$}
is sheaf of differentials
(Modules on Sites,
Definition \ref{sites-modules-definition-sheaf-differentials})
for the morphism of ringed topoi
$$
(f_{small}, f^\sharp) :
(X_\etale, \mathcal{O}_X)
\to
(Y_\etale, \mathcal{O}_Y)
$$
of
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-morphism-ringed-topoi}.
The {\it universal $Y$-derivation} will be denoted
$\text{d}_{X/Y} : \mathcal{O}_X \to \Omega_{X/Y}$.
\end{definition}

\noindent
By
Lemma \ref{lemma-match-modules-differentials}
this does not conflict with the already existing
notion in case $X$ and $Y$ are representable. From now on, if $X$ and $Y$
are representable, we no longer distinguish between the sheaf of differentials
defined above and the one defined in
Morphisms, Definition \ref{morphisms-definition-sheaf-differentials}.
We want to relate this to the usual modules of differentials for
morphisms of schemes. Here is the key lemma.

\begin{lemma}
\label{lemma-localize-differentials}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Consider any commutative diagram
$$
\xymatrix{
U \ar[d]_a \ar[r]_\psi & V \ar[d]^b \\
X \ar[r]^f & Y
}
$$
where the vertical arrows are \'etale morphisms of algebraic spaces. Then
$$
\Omega_{X/Y}|_{U_\etale} = \Omega_{U/V}
$$
In particular, if $U$, $V$ are schemes, then this is equal to the usual
sheaf of differentials of the morphism of schemes $U \to V$.
\end{lemma}

\begin{proof}
By
Properties of Spaces, Lemma \ref{spaces-properties-lemma-etale-morphism-topoi}
and Equation (\ref{spaces-properties-equation-restrict})
we may think of the restriction of a sheaf on $X_\etale$ to
$U_\etale$ as the pullback by $a_{small}$. Similarly for $b$. By
Modules on Sites, Lemma \ref{sites-modules-lemma-localize-differentials}
we have
$$
\Omega_{X/Y}|_{U_\etale} =
\Omega_{\mathcal{O}_{U_\etale}/
a_{small}^{-1}f_{small}^{-1}\mathcal{O}_{Y_\etale}}
$$
Since $a_{small}^{-1}f_{small}^{-1}\mathcal{O}_{Y_\etale}
= \psi_{small}^{-1}b_{small}^{-1}\mathcal{O}_{Y_\etale}
= \psi_{small}^{-1}\mathcal{O}_{V_\etale}$ we see that the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-module-differentials-quasi-coherent}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Then $\Omega_{X/Y}$ is a quasi-coherent $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
Choose a diagram as in
Lemma \ref{lemma-localize-differentials}
with $a$ and $b$ surjective and $U$ and $V$ schemes.
Then we see that $\Omega_{X/Y}|_U = \Omega_{U/V}$ which is
quasi-coherent (for example by
Morphisms, Lemma \ref{morphisms-lemma-differentials-diagonal}).
Hence we conclude that $\Omega_{X/Y}$ is quasi-coherent by
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-characterize-quasi-coherent}.
\end{proof}

\begin{remark}
\label{remark-alternative}
Now that we know that $\Omega_{X/Y}$ is quasi-coherent we can attempt
to construct it in another manner. For example we can use the result of
Properties of Spaces,
Section \ref{spaces-properties-section-quasi-coherent-presentation}
to construct the sheaf of differentials by glueing.
For example if $Y$ is a scheme and if $U \to X$ is a surjective \'etale morphism
from a scheme towards $X$, then we see that $\Omega_{U/Y}$ is
a quasi-coherent $\mathcal{O}_U$-module, and since $s, t : R \to U$
are \'etale we get an isomorphism
$$
\alpha : s^*\Omega_{U/Y} \to \Omega_{R/Y} \to t^*\Omega_{U/Y}
$$
by using
Morphisms, Lemma \ref{morphisms-lemma-triangle-differentials-smooth}.
You check that this satisfies the cocycle condition and you're done.
If $Y$ is not a scheme, then you define $\Omega_{U/Y}$ as the cokernel
of the map $(U \to Y)^*\Omega_{Y/S} \to \Omega_{U/S}$, and proceed as
before. This two step process is a little bit ugly. Another possibility
is to glue the sheaves $\Omega_{U/V}$ for any diagram as in
Lemma \ref{lemma-localize-differentials}
but this is not very elegant either. Both approaches will work however, and
will give a slightly more elementary construction of the sheaf of
differentials.
\end{remark}

\begin{lemma}
\label{lemma-functoriality-differentials}
Let $S$ be a scheme. Let
$$
\xymatrix{
X' \ar[d] \ar[r]_f & X \ar[d] \\
Y' \ar[r] & Y
}
$$
be a commutative diagram of algebraic spaces. The map
$f^\sharp : \mathcal{O}_X \to f_*\mathcal{O}_{X'}$ composed with the map
$f_*\text{d}_{X'/Y'} : f_*\mathcal{O}_{X'} \to f_*\Omega_{X'/Y'}$ is a
$Y$-derivation. Hence we obtain a canonical map of $\mathcal{O}_X$-modules
$\Omega_{X/Y} \to f_*\Omega_{X'/Y'}$, and by
adjointness of $f_*$ and $f^*$ a
canonical $\mathcal{O}_{X'}$-module homomorphism
$$
c_f : f^*\Omega_{X/Y} \longrightarrow \Omega_{X'/Y'}.
$$
It is uniquely characterized by the property that
$f^*\text{d}_{X/Y}(t)$ mapsto $\text{d}_{X'/Y'}(f^* t)$
for any local section $t$ of $\mathcal{O}_X$.
\end{lemma}

\begin{proof}
This is a special case of
Modules on Sites, Lemma
\ref{sites-modules-lemma-functoriality-differentials-ringed-topoi}.
\end{proof}

\begin{lemma}
\label{lemma-check-functoriality-differentials}
Let $S$ be a scheme. Let
$$
\xymatrix{
X'' \ar[d] \ar[r]_g & X' \ar[d] \ar[r]_f & X \ar[d] \\
Y'' \ar[r] & Y' \ar[r] & Y
}
$$
be a commutative diagram of algebraic spaces over $S$. Then we have
$$
c_{f \circ g} = c_g \circ g^* c_f
$$
as maps $(f \circ g)^*\Omega_{X/Y} \to \Omega_{X''/Y''}$.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the characterization of $c_f, c_g, c_{f \circ g}$
in terms of the effect these maps have on local sections.
\end{proof}

\begin{lemma}
\label{lemma-triangle-differentials}
Let $S$ be a scheme.
Let $f : X \to Y$, $g : Y \to B$ be morphisms of algebraic spaces over $S$.
Then there is a canonical exact sequence
$$
f^*\Omega_{Y/B} \to \Omega_{X/B} \to \Omega_{X/Y} \to 0
$$
where the maps come from applications of
Lemma \ref{lemma-functoriality-differentials}.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-triangle-differentials},
of this result via \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-immersion-differentials}
Let $S$ be a scheme. If $X \to Y$ is an immersion
of algebraic spaces over $S$ then $\Omega_{X/S}$ is zero.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-immersion-differentials},
of this result via \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-relative-immersion}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $i : Z \to X$ be an immersion of algebraic spaces over $B$.
There is a canonical exact sequence
$$
\mathcal{C}_{Z/X} \to i^*\Omega_{X/B} \to \Omega_{Z/B} \to 0
$$
where the first arrow is induced by $\text{d}_{X/B}$
and the second arrow comes from
Lemma \ref{lemma-functoriality-differentials}.
\end{lemma}

\begin{proof}
This is the algebraic spaces version of
Morphisms, Lemma \ref{morphisms-lemma-differentials-relative-immersion}
and will be a consequence of that lemma by
\'etale localization, see
Lemmas \ref{lemma-localize-differentials} and
\ref{lemma-etale-conormal}.
However, we should make sure we can define the first arrow globally.
Hence we explain the meaning of ``induced by $\text{d}_{X/B}$'' here.
Namely, we may assume that $i$ is a closed immersion after replacing $X$
by an open subspace. Let $\mathcal{I} \subset \mathcal{O}_X$
be the quasi-coherent sheaf of ideals corresponding to $Z \subset X$.
Then $\text{d}_{X/S} : \mathcal{I} \to \Omega_{X/S}$
maps the subsheaf $\mathcal{I}^2 \subset \mathcal{I}$ to
$\mathcal{I}\Omega_{X/S}$. Hence it induces a map
$\mathcal{I}/\mathcal{I}^2 \to \Omega_{X/S}/\mathcal{I}\Omega_{X/S}$
which is $\mathcal{O}_X/\mathcal{I}$-linear.
By
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-i-star-equivalence}
this corresponds to a map $\mathcal{C}_{Z/X} \to i^*\Omega_{X/S}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-differentials-relative-immersion-section}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $i : Z \to X$ be an immersion of algebraic spaces over $B$, and
assume $i$ (\'etale locally) has a left inverse. Then the canonical
sequence
$$
0 \to \mathcal{C}_{Z/X} \to i^*\Omega_{X/B} \to \Omega_{Z/B} \to 0
$$
of
Lemma \ref{lemma-differentials-relative-immersion}
is (\'etale locally) split exact.
\end{lemma}

\begin{proof}
Clarification: we claim that if $g : X \to Z$ is a left inverse of $i$
over $B$, then $i^*c_g$ is a right inverse of the map
$i^*\Omega_{X/B} \to \Omega_{Z/B}$.
Having said this, the result follows from the corresponding result for
morphisms of schemes by \'etale localization, see
Lemmas \ref{lemma-localize-differentials} and
\ref{lemma-etale-conormal}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-differentials}
Let $S$ be a scheme.
Let $X \to Y$ be a morphism of algebraic spaces over $S$.
Let $g : Y' \to Y$ be a morphism of algebraic spaces over $S$.
Let $X' = X_{Y'}$ be the base change of $X$.
Denote $g' : X' \to X$ the projection.
Then the map
$$
(g')^*\Omega_{X/Y} \to \Omega_{X'/Y'}
$$
of
Lemma \ref{lemma-functoriality-differentials}
is an isomorphism.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-differentials}
and \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-differential-product}
Let $S$ be a scheme.
Let $f : X \to B$ and $g : Y \to B$ be morphisms of algebraic spaces
over $S$ with the same target.
Let $p : X \times_B Y \to X$ and $q : X \times_B Y \to Y$ be the
projection morphisms. The maps from
Lemma \ref{lemma-functoriality-differentials}
$$
p^*\Omega_{X/B} \oplus q^*\Omega_{Y/B}
\longrightarrow
\Omega_{X \times_B Y/B}
$$
give an isomorphism.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-differential-product}
and \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-differentials}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
If $f$ is locally of finite type, then $\Omega_{X/Y}$ is
a finite type $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-finite-type-differentials}
and \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-differentials}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
If $f$ is locally of finite type, then $\Omega_{X/Y}$ is
an $\mathcal{O}_X$-module of finite presentation.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-differentials}
and \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}














\section{Topological invariance of the \'etale site}
\label{section-topological-invariance}

\noindent
We show that the site $X_{spaces, \etale}$ is a ``topological
invariant''. It then follows that $X_\etale$, which
consists of the representable objects in $X_{spaces, \etale}$,
is a topological invariant too, see Lemma \ref{lemma-topological-invariance}.

\begin{theorem}
\label{theorem-topological-invariance}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Assume $f$ is integral, universally injective and surjective.
The functor
$$
V \longmapsto V_X = X \times_Y V
$$
defines an equivalence of categories
$Y_{spaces, \etale} \to X_{spaces, \etale}$.
\end{theorem}

\begin{proof}
The morphism $f$ is representable and a universal homeomorphism, see
Morphisms of Spaces,
Section \ref{spaces-morphisms-section-universal-homeomorphisms}.

\medskip\noindent
We first prove that the functor is faithful.
Suppose that $V', V$ are objects of $Y_{spaces, \etale}$ and
that $a, b : V' \to V$ are distinct morphisms over $Y$.
Since $V', V$ are \'etale over $Y$ the equalizer
$$
E =  V' \times_{(a, b), V \times_Y V, \Delta_{V/Y}} V
$$
of $a, b$ is \'etale over $Y$ also. Hence $E \to V'$ is an \'etale monomorphism
(i.e., an open immersion) which is an isomorphism if and only if it is
surjective. Since $X \to Y$ is a universal homeomorphism we see that this
is the case if and only if $E_X = V'_X$, i.e., if and only if $a_X = b_X$.

\medskip\noindent
Next, we prove that the functor is fully faithful.
Suppose that $V', V$ are objects of $Y_{spaces, \etale}$ and
that $c : V'_X \to V_X$ is a morphism over $X$. We want to construct
a morphism $a : V' \to V$ over $Y$ such that $a_X = c$.
Let $a' : V'' \to V'$ be a surjective \'etale morphism such that $V''$ is
a separated algebraic space. If we can construct a morphism
$a'' : V'' \to V$ such that $a''_X = c \circ a'_X$, then the two compositions
$$
V'' \times_{V'} V'' \xrightarrow{\text{pr}_i} V'' \xrightarrow{a''} V
$$
will be equal by the faithfulness of the functor proved in the first
paragraph. Hence $a''$ will factor through a unique morphism
$a : V' \to V$ as $V'$ is (as a sheaf) the quotient of $V''$ by
the equivalence relation $V'' \times_{V'} V''$. Hence we may assume that
$V'$ is separated. In this case the graph
$$
\Gamma_c \subset (V' \times_Y V)_X
$$
is open and closed (details omitted). Since $X \to Y$ is a universal
homeomorphism, there exists an open and closed subspace
$\Gamma \subset V' \times_Y V$ such that $\Gamma_X = \Gamma_c$.
The projection $\Gamma \to V'$ is an \'etale morphism whose base
change to $X$ is an isomorphism. Hence $\Gamma \to V'$ is \'etale,
universally injective, and surjective, so an isomorphism by
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-universally-injective-open}.
Thus $\Gamma$ is the graph of a morphism $a : V' \to V$ as desired.

\medskip\noindent
Finally, we prove that the functor is essentially surjective.
Suppose that $U$ is an object of $X_{spaces, \etale}$.
We have to find an object $V$ of $Y_{spaces, \etale}$
such that $V_X \cong U$. Let $U' \to U$ be a surjective \'etale morphism
such that $U' \cong V'_X$ and $U' \times_U U' \cong V''_X$
for some objects $V'', V'$ of $Y_{spaces, \etale}$.
Then by fully faithfulness of the functor we obtain morphisms
$s, t : V'' \to V'$ with $t_X = \text{pr}_0$ and $s_X = \text{pr}_1$
as morphisms $U' \times_U U' \to U'$. Using that
$(\text{pr}_0, \text{pr}_1) : U' \times_U U' \to U' \times_S U'$
is an \'etale equivalence relation, and that $U' \to V'$ and
$U' \times_U U' \to V''$ are universally injective and surjective
we deduce that
$(t, s) : V'' \to V' \times_S V'$ is an \'etale equivalence relation.
Then the quotient $V = V'/V''$ (see
Spaces, Theorem \ref{spaces-theorem-presentation})
is an algebraic space $V$ over $Y$. There is a morphism
$V' \to V$ such that $V'' = V' \times_V V'$. Thus we obtain a morphism
$V \to Y$ (see
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-fpqc-universal-effective-epimorphisms}).
On base change to $X$ we see that we have a morphism $U' \to V_X$
and a compatible isomorphism $U' \times_{V_X} U' = U' \times_U U'$, which
implies that $V_X \cong U$ (by the lemma just cited once more).

\medskip\noindent
Pick a scheme $W$ and a surjective \'etale morphism $W \to Y$.
Pick a scheme $U'$ and a surjective \'etale morphism $U' \to U \times_X W_X$.
Note that $U'$ and $U' \times_U U'$ are schemes \'etale over $X$ whose
structure morphism to $X$ factors through the scheme $W_X$.
Hence by
\'Etale Cohomology,
Theorem \ref{etale-cohomology-theorem-topological-invariance}
there exist schemes $V', V''$ \'etale over $W$ whose base change to
$W_X$ is isomorphic to respectively $U'$ and $U' \times_U U'$.
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-topological-invariance}
With assumption and notation as in
Theorem \ref{theorem-topological-invariance}
the equivalence of categories
$Y_{spaces, \etale} \to X_{spaces, \etale}$
restricts to an equivalence of categories
$Y_\etale \to X_\etale$.
\end{lemma}

\begin{proof}
This is just the statement that given an object
$V \in Y_{spaces, \etale}$ we have $V$ is a scheme if and
only if $V \times_Y X$ is a scheme. Since $V \times_Y X \to V$
is integral, universally injective, and surjective (as a base
change of $X \to Y$) this
follows from Limits of Spaces, Lemma
\ref{spaces-limits-lemma-integral-universally-bijective-scheme}.
\end{proof}

\begin{remark}
\label{remark-topological-invariance-etale-site}
A universal homeomorphism of algebraic spaces need not be representable, see
Morphisms of Spaces,
Example \ref{spaces-morphisms-example-universal-homeomorphism}.
The argument in the proof of
Theorem \ref{theorem-topological-invariance}
above cannot be used in this case. In fact we do not know whether given
a universal homeomorphism of algebraic spaces
$f : X \to Y$ the categories $X_{spaces, \etale}$
and $Y_{spaces, \etale}$ are equivalent.
If you do, please email
\href{mailto:stacks.project@gmail.com}{stacks.project@gmail.com}.
\end{remark}








\section{Thickenings}
\label{section-thickenings}

\noindent
The following terminology may not be completely standard, but it is convenient.

\begin{definition}
\label{definition-thickening}
Thickenings. Let $S$ be a scheme.
\begin{enumerate}
\item We say an algebraic space $X'$ is a {\it thickening} of an algebraic
space $X$ if $X$ is a closed subspace of $X'$ and the associated topological
spaces are equal.
\item We say $X'$ is a {\it first order thickening} of $X$ if
$X$ is a closed subspace of $X'$ and the quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_{X'}$ defining $X$ has square zero.
\item Given two thickenings $X \subset X'$ and $Y \subset Y'$ a
{\it morphism of thickenings} is a morphism $f' : X' \to Y'$ such that
$f(X) \subset Y$, i.e., such that $f'|_X$ factors through the closed
subspace $Y$. In this situation we set $f = f'|_X : X \to Y$ and we say
that $(f, f') : (X \subset X') \to (Y \subset Y')$ is a morphism of
thickenings.
\item Let $B$ be an algebraic space. We similarly define
{\it thickenings over $B$}, and
{\it morphisms of thickenings over $B$}. This means that the spaces
$X, X', Y, Y'$ above are algebraic spaces endowed with a structure
morphism to $B$, and that the morphisms
$X \to X'$, $Y \to Y'$ and $f' : X' \to Y'$ are morphisms over $B$.
\end{enumerate}
\end{definition}

\noindent
The fundamental equivalence.
Note that if $X \subset X'$ is a thickening, then $X \to X'$
is integral and universally bijective. This implies that
\begin{equation}
\label{equation-equivalence-etale-spaces}
X_{spaces, \etale} = X'_{spaces, \etale}
\end{equation}
via the pullback functor, see
Theorem \ref{theorem-topological-invariance}.
Hence we may think of $\mathcal{O}_{X'}$ as a sheaf on
$X_{spaces, \etale}$. Thus a canonical equivalence
of locally ringed topoi
\begin{equation}
\label{equation-fundamental-equivalence}
(\Sh(X'_{spaces, \etale}), \mathcal{O}_{X'})
\cong
(\Sh(X_{spaces, \etale}), \mathcal{O}_{X'})
\end{equation}
Below we will frequently combine this with the fully faithfulness result of
Properties of Spaces, Theorem \ref{spaces-properties-theorem-fully-faithful}.
For example the closed immersion $i_X : X \to X'$ corresponds
to the surjective map $i_X^\sharp : \mathcal{O}_{X'} \to \mathcal{O}_X$.

\medskip\noindent
Let $S$ be a scheme, and let $B$ be an algebraic space over $S$.
Let $(f, f') : (X \subset X') \to (Y \subset Y')$ be a morphism of
thickenings over $B$. Note that the diagram of continuous functors
$$
\xymatrix{
X_{spaces, \etale} &
Y_{spaces, \etale} \ar[l] \\
X'_{spaces, \etale} \ar[u] &
Y'_{spaces, \etale} \ar[u] \ar[l]
}
$$
is commutative and the vertical arrows are equivalences. Hence
$f_{spaces, \etale}$, $f_{small}$,
$f'_{spaces, \etale}$, and $f'_{small}$
all define the same morphism of topoi. Thus we may think of
$$
(f')^\sharp :
f_{spaces, \etale}^{-1}\mathcal{O}_{Y'}
\longrightarrow
\mathcal{O}_{X'}
$$
as a map of sheaves of $\mathcal{O}_B$-algebras fitting into the commutative
diagram
$$
\xymatrix{
f_{spaces, \etale}^{-1}\mathcal{O}_Y \ar[r]_-{f^\sharp} \ar[r] &
\mathcal{O}_X \\
f_{spaces, \etale}^{-1}\mathcal{O}_{Y'} \ar[r]^-{(f')^\sharp}
\ar[u]^{i_Y^\sharp} &
\mathcal{O}_{X'} \ar[u]_{i_X^\sharp}
}
$$
Here $i_X : X \to X'$ and $i_Y : Y \to Y'$ are the names of the given
closed immersions.

\begin{lemma}
\label{lemma-first-order-thickening-maps}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $X \subset X'$ and $Y \subset Y'$ be thickenings
of algebraic spaces over $B$. Let $f : X \to Y$ be a morphism of algebraic
spaces over $B$. Given any map of $\mathcal{O}_B$-algebras
$$
\alpha : f_{spaces, \etale}^{-1}\mathcal{O}_{Y'} \to \mathcal{O}_{X'}
$$
such that
$$
\xymatrix{
f_{spaces, \etale}^{-1}\mathcal{O}_Y \ar[r]_-{f^\sharp} \ar[r] &
\mathcal{O}_X \\
f_{spaces, \etale}^{-1}\mathcal{O}_{Y'} \ar[r]^-\alpha
\ar[u]^{i_Y^\sharp} &
\mathcal{O}_{X'} \ar[u]_{i_X^\sharp}
}
$$
commutes, there exists a unique morphism of $(f, f')$ of
thickenings over $B$ such that $\alpha = (f')^\sharp$.
\end{lemma}

\begin{proof}
To find $f'$, by
Properties of Spaces, Theorem \ref{spaces-properties-theorem-fully-faithful},
all we have to do is show that the morphism of ringed topoi
$$
(f_{spaces, \etale}, \alpha) :
(\Sh(X_{spaces, \etale}), \mathcal{O}_{X'})
\longrightarrow
(\Sh(Y_{spaces, \etale}), \mathcal{O}_{Y'})
$$
is a morphism of locally ringed topoi. This follows directly
from the definition of morphisms of locally ringed topoi
(Modules on Sites,
Definition \ref{sites-modules-definition-morphism-locally-ringed-topoi}),
the fact that $(f, f^\sharp)$ is a morphism of locally ringed topoi
(Properties of Spaces,
Lemma \ref{spaces-properties-lemma-morphism-locally-ringed}),
that $\alpha$ fits into the given commutative diagram, and
the fact that the kernels of $i_X^\sharp$ and $i_Y^\sharp$ are
locally nilpotent. Finally, the fact that $f' \circ i_X = i_Y \circ f$
follows from the commutativity of the diagram and another application of
Properties of Spaces, Theorem \ref{spaces-properties-theorem-fully-faithful}.
We omit the verification that $f'$ is a morphism over $B$.
\end{proof}

\begin{lemma}
\label{lemma-open-subspace-thickening}
Let $S$ be a scheme. Let $X \subset X'$ be a thickening
of algebraic spaces over $S$. For any open subspace $U \subset X$ there
exists a unique open subspace $U' \subset X'$ such that
$U = X \times_{X'} U'$.
\end{lemma}

\begin{proof}
Let $U' \to X'$ be the object of $X'_{spaces, \etale}$
corresponding to the object $U \to X$ of $X_{spaces, \etale}$
via (\ref{equation-equivalence-etale-spaces}). The morphism
$U' \to X'$ is \'etale and universally injective, hence an open immersion, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-universally-injective-open}.
\end{proof}

\noindent
Finite order thickenings. Let $i_X : X \to X'$ be a thickening of
algebraic spaces. Any local section of the kernel
$\mathcal{I} = \Ker(i_X^\sharp) \subset \mathcal{O}_{X'}$ is
locally nilpotent.
Let us say that $X \subset X'$ is a {\it finite order thickening}
if the ideal sheaf $\mathcal{I}$ is ``globally'' nilpotent, i.e.,
if there exists an $n \geq 0$ such that $\mathcal{I}^{n + 1} = 0$.
Technically the class of finite order thickenings $X \subset X'$
is much easier to handle than the general case.
Namely, in this case we have a filtration
$$
0 \subset \mathcal{I}^n \subset \mathcal{I}^{n - 1} \subset
\ldots \subset \mathcal{I} \subset \mathcal{O}_{X'}
$$
and we see that $X'$ is filtered by closed subspaces
$$
X = X_0 \subset X_1 \subset \ldots \subset X_{n - 1} \subset X_{n + 1} = X'
$$
such that each pair $X_i \subset X_{i + 1}$ is a first order thickening
over $B$. Using simple induction arguments many results proved for first order
thickenings can be rephrased as results on finite order thickenings.

\begin{lemma}
\label{lemma-first-order-thickening-surjective}
Let $S$ be a scheme. Let $X \subset X'$ be a thickening
of algebraic spaces over $S$. Let $U$ be an affine object of
$X_{spaces, \etale}$. Then
$$
\Gamma(U, \mathcal{O}_{X'}) \to \Gamma(U, \mathcal{O}_X)
$$
is surjective where we think of $\mathcal{O}_{X'}$ as a sheaf on
$X_{spaces, \etale}$ via (\ref{equation-fundamental-equivalence}).
\end{lemma}

\begin{proof}
Let $U' \to X'$ be the \'etale morphism of algebraic spaces such that
$U = X \times_{X'} U'$, see Theorem \ref{theorem-topological-invariance}.
By Limits of Spaces, Lemma \ref{spaces-limits-lemma-affine} we see
that $U'$ is an affine scheme. Hence
$\Gamma(U, \mathcal{O}_{X'}) = \Gamma(U', \mathcal{O}_{U'}) \to
\Gamma(U, \mathcal{O}_U)$
is surjective as $U \to U'$ is a closed immersion of affine schemes.
Below we give a direct proof for finite order thickenings
which is the case most used in practice.
\end{proof}

\begin{proof}[Proof for finite order thickenings]
We may assume that $X \subset X'$ is a first order thickening by the
principle explained above. Denote $\mathcal{I}$ the kernel of the surjection
$\mathcal{O}_{X'} \to \mathcal{O}_X$. As $\mathcal{I}$ is a quasi-coherent
$\mathcal{O}_{X'}$-module and since $\mathcal{I}^2 = 0$ by the definition
of a first order thickening we may apply
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-i-star-equivalence}
to see that $\mathcal{I}$ is a quasi-coherent $\mathcal{O}_X$-module.
Hence the lemma follows from the long exact cohomology sequence
associated to the short exact sequence
$$
0 \to \mathcal{I} \to \mathcal{O}_{X'} \to \mathcal{O}_X \to 0
$$
and the fact that $H^1_\etale(U, \mathcal{I}) = 0$ as
$\mathcal{I}$ is quasi-coherent, see
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}
and Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
\end{proof}

\begin{lemma}
\label{lemma-thickening-scheme}
Let $S$ be a scheme. Let $X \subset X'$ be a thickening of algebraic spaces
over $S$. If $X$ is (representable by) a scheme, then so is $X'$.
\end{lemma}

\begin{proof}
Note that $X'_{red} = X_{red}$. Hence if $X$ is a scheme, then
$X'_{red}$ is a scheme. Thus the result follows from
Limits of Spaces, Lemma
\ref{spaces-limits-lemma-reduction-scheme}.
Below we give a direct proof for finite order thickenings which is
the case most often used in practice.
\end{proof}

\begin{proof}[Proof for finite order thickenings]
It suffices to prove this when $X'$ is a first order thickening of $X$. By
Properties of Spaces, Lemma \ref{spaces-properties-lemma-subscheme}
there is a largest open subspace of $X'$ which is a scheme. Thus we have
to show that every point $x$ of $|X'| = |X|$ is contained in an open subspace of
$X'$ which is a scheme. Using
Lemma \ref{lemma-open-subspace-thickening}
we may replace $X \subset X'$ by $U \subset U'$ with $x \in U$ and $U$
an affine scheme. Hence we may assume that $X$ is affine.
Thus we reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $X \subset X'$ is a first order thickening where $X$ is an affine
scheme. Set $A = \Gamma(X, \mathcal{O}_X)$ and
$A' = \Gamma(X', \mathcal{O}_{X'})$. By
Lemma \ref{lemma-first-order-thickening-surjective}
the map $A \to A'$ is surjective. The kernel $I$ is an ideal of square zero. By
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-morphism-to-affine-scheme}
we obtain a canonical morphism $f : X' \to \Spec(A')$ which fits
into the following commutative diagram
$$
\xymatrix{
X \ar@{=}[d] \ar[r] &  X' \ar[d]^f \\
\Spec(A) \ar[r] & \Spec(A')
}
$$
Because the horizontal arrows are thickenings it is clear that $f$ is
universally injective and surjective. Hence it suffices to show that
$f$ is \'etale, since then
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-universally-injective-open}
will imply that $f$ is an isomorphism.

\medskip\noindent
To prove that $f$ is \'etale choose an affine scheme $U'$ and an
\'etale morphism $U' \to X'$. It suffices to show that
$U' \to X' \to \Spec(A')$ is \'etale, see
Properties of Spaces, Definition \ref{spaces-properties-definition-etale}.
Write $U' = \Spec(B')$. Set $U = X \times_{X'} U'$. Since $U$
is a closed subspace of $U'$, it is a closed subscheme, hence
$U = \Spec(B)$ with $B' \to B$ surjective. Denote
$J = \Ker(B' \to B)$ and note that $J = \Gamma(U, \mathcal{I})$
where $\mathcal{I} = \Ker(\mathcal{O}_{X'} \to \mathcal{O}_X)$
on $X_{spaces, \etale}$ as in the proof of
Lemma \ref{lemma-first-order-thickening-surjective}.
The morphism $U' \to X' \to \Spec(A')$ induces a commutative
diagram
$$
\xymatrix{
0 \ar[r] &
J \ar[r] &
B' \ar[r] &
B \ar[r] & 0 \\
0 \ar[r] &
I \ar[r] \ar[u] &
A' \ar[r] \ar[u] &
A \ar[r] \ar[u] & 0
}
$$
Now, since $\mathcal{I}$ is a quasi-coherent $\mathcal{O}_X$-module
we have $\mathcal{I} = (\widetilde I)^a$, see
Descent, Definition \ref{descent-definition-structure-sheaf}
for notation and
Descent, Proposition \ref{descent-proposition-equivalence-quasi-coherent}
for why this is true. Hence we see that $J = I \otimes_A B$.
Finally, note that $A \to B$ is \'etale as $U \to X$ is \'etale as
the base change of the \'etale morphism $U' \to X'$.
We conclude that $A' \to B'$ is \'etale by
Algebra, Lemma \ref{algebra-lemma-lift-etale-infinitesimal}.
\end{proof}

\begin{lemma}
\label{lemma-thickening-equivalence}
Let $S$ be a scheme. Let $X \subset X'$ be a thickening of algebraic spaces
over $S$. The functor
$$
V' \longmapsto V = X \times_{X'} V'
$$
defines an equivalence of categories
$X'_\etale \to X_\etale$.
\end{lemma}

\begin{proof}
The functor $V' \mapsto V$ defines an equivalence of categories
$X'_{spaces, \etale} \to X_{spaces, \etale}$, see
Theorem \ref{theorem-topological-invariance}.
Thus it suffices to show that $V$ is a scheme if and only if $V'$ is
a scheme. This is the content of
Lemma \ref{lemma-thickening-scheme}.
\end{proof}

\noindent
First order thickening are described as follows.

\begin{lemma}
\label{lemma-first-order-thickening}
Let $S$ be a scheme.
Let $f : X \to B$ be a morphism of algebraic spaces over $S$.
Consider a short exact sequence
$$
0 \to \mathcal{I} \to \mathcal{A} \to \mathcal{O}_X \to 0
$$
of sheaves on $X_\etale$ where $\mathcal{A}$ is a sheaf of
$f^{-1}\mathcal{O}_B$-algebras, $\mathcal{A} \to \mathcal{O}_X$ is a surjection
of sheaves of $f^{-1}\mathcal{O}_B$-algebras, and $\mathcal{I}$ is its kernel.
If
\begin{enumerate}
\item $\mathcal{I}$ is an ideal of square zero in $\mathcal{A}$, and
\item $\mathcal{I}$ is quasi-coherent as an $\mathcal{O}_X$-module
\end{enumerate}
then there exists a first order thickening
$X \subset X'$ over $B$ and an isomorphism
$\mathcal{O}_{X'} \to \mathcal{A}$ of $f^{-1}\mathcal{O}_B$-algebras
compatible with the surjections to $\mathcal{O}_X$.
\end{lemma}

\begin{proof}
In this proof we redo some of the arguments used in the
proofs of
Lemmas \ref{lemma-first-order-thickening-surjective} and
\ref{lemma-thickening-scheme}.
We first handle the case $B = S = \Spec(\mathbf{Z})$.
Let $U$ be an affine scheme, and let $U \to X$ be \'etale.
Then
$$
0 \to \mathcal{I}(U) \to \mathcal{A}(U) \to \mathcal{O}_X(U) \to 0
$$
is exact as $H^1(U_\etale, \mathcal{I}) = 0$ as
$\mathcal{I}$ is quasi-coherent, see
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}
and Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
If $V \to U$ is a morphism of affine objects of $X_{spaces, \etale}$
then
$$
\mathcal{I}(V) = \mathcal{I}(U) \otimes_{\mathcal{O}_X(U)} \mathcal{O}_X(V)
$$
since $\mathcal{I}$ is a quasi-coherent $\mathcal{O}_X$-module, see
Descent, Proposition \ref{descent-proposition-equivalence-quasi-coherent}.
Hence $\mathcal{A}(U) \to \mathcal{A}(V)$ is an
\'etale ring map, see
Algebra, Lemma \ref{algebra-lemma-lift-etale-infinitesimal}.
Hence we see that
$$
U \longmapsto U' = \Spec(\mathcal{A}(U))
$$
is a functor from $X_{affine, \etale}$ to the category of affine
schemes and \'etale morphisms. In fact, we claim that this functor can
be extended to a functor $U \mapsto U'$ on all of $X_\etale$.
To see this, if $U$ is an object of $X_\etale$, note that
$$
0 \to \mathcal{I}|_{U_{Zar}} \to \mathcal{A}|_{U_{Zar}} \to
\mathcal{O}_X|_{U_{Zar}} \to 0
$$
and $\mathcal{I}|_{U_{Zar}}$ is a quasi-coherent sheaf on $U$, see
Descent,
Proposition \ref{descent-proposition-equivalence-quasi-coherent-functorial}.
Hence by
More on Morphisms, Lemma \ref{more-morphisms-lemma-first-order-thickening}
we obtain a first order thickening $U \subset U'$ of schemes such that
$\mathcal{O}_{U'}$ is isomorphic to $\mathcal{A}|_{U_{Zar}}$. It is clear that
this construction is compatible with the construction for affines above.

\medskip\noindent
Choose a presentation $X = U/R$, see
Spaces, Definition \ref{spaces-definition-presentation}
so that $s, t : R \to U$ define an \'etale equivalence relation.
Applying the functor above we obtain an \'etale equivalence
relation $s', t' : R' \to U'$ in schemes. Consider the algebraic space
$X' = U'/R'$ (see
Spaces, Theorem \ref{spaces-theorem-presentation}).
The morphism $X = U/R \to U'/R' = X'$ is a first order thickening.
Consider $\mathcal{O}_{X'}$ viewed as a sheaf on $X_\etale$.
By construction we have an isomorphism
$$
\gamma :
\mathcal{O}_{X'}|_{U_\etale}
\longrightarrow
\mathcal{A}|_{U_\etale}
$$
such that $s^{-1}\gamma$ agrees with $t^{-1}\gamma$ on $R_\etale$.
Hence by
Properties of Spaces, Lemma \ref{spaces-properties-lemma-descent-sheaf}
this implies that $\gamma$ comes from a unique isomorphism
$\mathcal{O}_{X'} \to \mathcal{A}$ as desired.

\medskip\noindent
To handle the case of a general base algebraic space $B$, we first
construct $X'$ as an algebraic space over $\mathbf{Z}$ as above.
Then we use the isomorphism $\mathcal{O}_{X'} \to \mathcal{A}$ to
define $f^{-1}\mathcal{O}_B \to \mathcal{O}_{X'}$. According to
Lemma \ref{lemma-first-order-thickening-maps}
this defines a morphism $X' \to B$ compatible with the given morphism
$X \to B$ and we are done.
\end{proof}

\begin{lemma}
\label{lemma-base-change-thickening}
Let $S$ be a scheme. Let $Y \subset Y'$ be a thickening of algebraic spaces
over $S$. Let $X' \to Y'$ be a morphism and set $X = Y \times_{Y'} X'$.
Then $(X \subset X') \to (Y \subset Y')$
is a morphism of thickenings. If $Y \subset Y'$ is a first
(resp.\ finite order) thickening, then $X \subset X'$ is a first
(resp.\ finite order) thickening.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-thickening}
Let $S$ be a scheme. If $X \subset X'$ and $X' \subset X''$ are
thickenings of algebraic spaces over $S$, then so is $X \subset X''$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-descending-property-thickening}
The property of being a thickening is fpqc local.
Similarly for first order thickenings.
\end{lemma}

\begin{proof}
The statement means the following: Let $S$ be a scheme and let
$X \to X'$ be a morphism of algebraic spaces over $S$.
Let $\{g_i : X'_i \to X'\}$ be an fpqc covering of algebraic spaces
such that the base change $X_i \to X'_i$ is a thickening for all $i$.
Then $X \to X'$ is a thickening. Since the morphisms $g_i$ are jointly
surjective we conclude that $X \to X'$ is surjective. By
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-closed-immersion}
we conclude that $X \to X'$ is a closed immersion.
Thus $X \to X'$ is a thickening. We omit the proof in the
case of first order thickenings.
\end{proof}

\begin{lemma}
\label{lemma-thicken-property-morphisms}
Let $S$ be a scheme. Let $(f, f') : (X \subset X') \to (Y \subset Y')$
be a morphism of thickenings of algebraic spaces over $S$. Then
\begin{enumerate}
\item $f$ is an affine morphism if and only if $f'$ is an affine morphism,
\item $f$ is a surjective morphism if and only if $f'$ is a surjective morphism,
\item $f$ is quasi-compact if and only if $f'$ quasi-compact,
\item $f$ is universally closed if and only if $f'$ is universally closed,
\item $f$ is integral if and only if $f'$ is integral,
\item $f$ is (quasi-)separated if and only if $f'$ is (quasi-)separated,
\item $f$ is universally injective if and only if $f'$ is universally injective,
\item $f$ is universally open if and only if $f'$ is universally open,
\item $f$ is representable if and only if $f'$ is representable, and
\item add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
Observe that $Y \to Y'$ and $X \to X'$ are integral and
universal homeomorphisms. This immediately implies parts
(2), (3), (4), (7), and (8).
Part (1) follows from
Limits of Spaces, Proposition \ref{spaces-limits-proposition-affine}
which tells us that there is a 1-to-1 correspondence between
affine schemes \'etale over $X$ and $X'$ and between affine schemes
\'etale over $Y$ and $Y'$.
Part (5) follows from (1) and (4) by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-integral-universally-closed}.
Finally, note that
$$
X \times_Y X = X \times_{Y'} X \to X \times_{Y'} X' \to X' \times_{Y'} X'
$$
is a thickening (the two arrows are thickenings by
Lemma \ref{lemma-base-change-thickening}).
Hence applying (3) and (4) to the morphism
$(X \subset X') \to (X \times_Y X \to X' \times_{Y'} X')$
we obtain (6). Finally, part (9) follows from the fact that an
algebraic space thickening of a scheme is again a scheme, see
Lemma \ref{lemma-thickening-scheme}.
\end{proof}

\begin{lemma}
\label{lemma-thicken-property-morphisms-cartesian}
Let $S$ be a scheme. Let $(f, f') : (X \subset X') \to (Y \subset Y')$ be a
morphism of thickenings of algebraic spaces over $S$ such that
$X = Y \times_{Y'} X'$. If $X \subset X'$ is a finite order thickening, then
\begin{enumerate}
\item $f$ is a closed immersion if and only if $f'$ is a closed immersion,
\item $f$ is locally of finite type if and only if $f'$ is
locally of finite type,
\item $f$ is locally quasi-finite if and only if $f'$ is locally
quasi-finite,
\item $f$ is locally of finite type of relative dimension $d$ if and
only if $f'$ is locally of finite type of relative dimension $d$,
\item $\Omega_{X/Y} = 0$ if and only if $\Omega_{X'/Y'} = 0$,
\item $f$ is unramified if and only if $f'$ is unramified,
\item $f$ is proper if and only if $f'$ is proper,
\item $f$ is a finite morphism if and only if $f'$ is an finite morphism,
\item $f$ is a monomorphism if and only if $f'$ is a monomorphism,
\item $f$ is an immersion if and only if $f'$ is an immersion, and
\item add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a scheme $V'$ and a surjective \'etale morphism $V' \to Y'$.
Choose a scheme $U'$ and a surjective \'etale morphism
$U' \to X' \times_{Y'} V'$. Set $V = Y \times_{Y'} V'$ and
$U = X \times_{X'} U'$. Then for \'etale local properties of morphisms
we can reduce to the morphism of thickenings of schemes
$(U \subset U') \to (V \subset V')$ and apply More on Morphisms, Lemma
\ref{more-morphisms-lemma-thicken-property-morphisms-cartesian}.
This proves (2), (3), (4), (5), and (6).

\medskip\noindent
The properties of morphisms in (1), (7), (8), (9), (10) are stable
under base change, hence if $f'$ has property $\mathcal{P}$, then so
does $f$. See
Spaces, Lemma \ref{spaces-lemma-base-change-immersions},
and
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-base-change-proper},
\ref{spaces-morphisms-lemma-base-change-integral}, and
\ref{spaces-morphisms-lemma-base-change-monomorphism}.

\medskip\noindent
The interesting direction in (1), (7), (8), (9), (10) is to assume
that $f$ has the property and deduce that $f'$ has it too.
By induction on the order of the thickening we may
assume that $Y \subset Y'$ is a first order thickening, see
discussion on finite order thickenings above.

\medskip\noindent
Proof of (1). Choose a scheme $V'$ and a surjective \'etale morphism
$V' \to Y'$. Set $V = Y \times_{Y'} V'$, $U' = X' \times_{Y'} V'$
and $U = X \times_Y V$. Then $U \to V$ is a closed immersion, which
implies that $U$ is a scheme, which in turn implies that $U'$ is
a scheme (Lemma \ref{lemma-thickening-scheme}). Thus we can apply
the lemma in the case of schemes
(More on Morphisms, Lemma
\ref{more-morphisms-lemma-thicken-property-morphisms-cartesian})
to $(U \subset U') \to (V \subset V')$ to conclude.

\medskip\noindent
Proof of (7). Follows by combining (2) with
results of Lemma \ref{lemma-thicken-property-morphisms}
and the fact that proper equals quasi-compact $+$
separated $+$ locally of finite type $+$ universally closed.

\medskip\noindent
Proof of (8). Follows by combining (2) with
results of Lemma \ref{lemma-thicken-property-morphisms}
and using the fact that finite equals integral $+$ locally
of finite type (Morphisms, Lemma \ref{morphisms-lemma-finite-integral}).

\medskip\noindent
Proof of (9). As $f$ is a monomorphism we have $X = X \times_Y X$.
We may apply the results proved so far to the morphism
of thickenings $(X \subset X') \to (X \times_Y X \subset X' \times_{Y'} X')$.
We conclude $X' \to X' \times_{Y'} X'$ is a closed immersion by (1).
In fact, it is a first order thickening as the ideal defining the
closed immersion $X' \to X' \times_{Y'} X'$ is contained in the pullback
of the ideal $\mathcal{I} \subset \mathcal{O}_{Y'}$ cutting out $Y$ in $Y'$.
Indeed, $X = X \times_Y X = (X' \times_{Y'} X') \times_{Y'} Y$ is contained
in $X'$. The conormal sheaf of the closed immersion
$\Delta : X' \to X' \times_{Y'} X'$ is equal to $\Omega_{X'/Y'}$
(this is the analogue of
Morphisms, Lemma \ref{morphisms-lemma-differentials-diagonal}
for algebraic spaces and follows either by \'etale localization
or by combining
Lemmas \ref{lemma-differentials-relative-immersion-section} and
\ref{lemma-differential-product}; some details omitted).
Thus it suffices to show that $\Omega_{X'/Y'} = 0$ which follows from (5)
and the corresponding statement for $X/Y$.

\medskip\noindent
Proof of (10). If $f : X \to Y$ is an immersion, then it factors as
$X \to V \to Y$ where $V \to Y$ is an open subspace and $X \to V$ is a
closed immersion, see
Morphisms of Spaces, Remark \ref{spaces-morphisms-remark-immersion}.
Let $V' \subset Y'$ be the open subspace whose
underlying topological space $|V'|$ is the same as $|V| \subset |Y| = |Y'|$.
Then $X' \to Y'$ factors through $V'$ and we conclude that $X' \to V'$
is a closed immersion by part (1). This finishes the proof.
\end{proof}

\noindent
The following lemma is a variant on the preceding one. Rather than assume
that the thickenings involved are finite order (which allows us to transfer
the property of being locally of finite type from $f$ to $f'$),
we instead take as given that each of $f$ and $f'$ is locally of
finite type.

\begin{lemma}
\label{lemma-properties-that-extend-over-thickenings}
Let $S$ be a scheme. Let $(f, f') : (X \subset X') \to (Y \to Y')$ be a
morphism of thickenings of algebraic spaces over $S$. Assume $f$ and $f'$
are locally of finite type and $X = Y \times_{Y'} X'$. Then
\begin{enumerate}
\item $f$ is locally quasi-finite if and only if $f'$ is locally quasi-finite,
\item $f$ is finite if and only if $f'$ is finite,
\item $f$ is a closed immersion if and only if $f'$ is a closed immersion,
\item $\Omega_{X/Y} = 0$ if and only if $\Omega_{X'/Y'} = 0$,
\item $f$ is unramified if and only if $f'$ is unramified,
\item $f$ is a monomorphism if and only if $f'$ is a monomorphism,
\item $f$ is an immersion if and only if $f'$ is an immersion,
\item $f$ is proper if and only if $f'$ is proper, and
\item add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a scheme $V'$ and a surjective \'etale morphism $V' \to Y'$.
Choose a scheme $U'$ and a surjective \'etale morphism
$U' \to X' \times_{Y'} V'$. Set $V = Y \times_{Y'} V'$ and
$U = X \times_{X'} U'$. Then for \'etale local properties of morphisms
we can reduce to the morphism of thickenings of schemes
$(U \subset U') \to (V \subset V')$ and apply
More on Morphisms, Lemma
\ref{more-morphisms-lemma-properties-that-extend-over-thickenings}.
This proves (1), (4), and (5).

\medskip\noindent
The properties in (2), (3), (6), (7), and (8) are stable
under base change, hence if $f'$ has property $\mathcal{P}$, then so
does $f$. See Spaces, Lemma \ref{spaces-lemma-base-change-immersions},
and
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-base-change-proper},
\ref{spaces-morphisms-lemma-base-change-integral}, and
\ref{spaces-morphisms-lemma-base-change-monomorphism}.
Hence in each case we need only to prove that if $f$ has
the desired property, so does $f'$.

\medskip\noindent
Case (2) follows from case (5) of Lemma \ref{lemma-thicken-property-morphisms}
and the fact that the finite morphisms are precisely
the integral morphisms that are locally of finite type
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-integral}).

\medskip\noindent
Case (3). This follows immediately from
Limits of Spaces, Lemma
\ref{spaces-limits-lemma-check-closed-infinitesimally}.

\medskip\noindent
Proof of (6). As $f$ is a monomorphism we have $X = X \times_Y X$.
We may apply the results proved so far to the morphism of thickenings
$(X \subset X') \to (X \times_Y X \subset X' \times_{Y'} X')$.
We conclude $\Delta_{X'/Y'} : X' \to X' \times_{Y'} X'$
is a closed immersion by (3). In fact $\Delta_{X'/Y'}$ induces a bijection
$|X'| \to |X' \times_{Y'} X'|$, hence $\Delta_{X'/Y'}$ is a thickening.
On the other hand $\Delta_{X'/Y'}$ is locally of finite presentation by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-diagonal-morphism-finite-type}.
In other words, $\Delta_{X'/Y'}(X')$ is cut out by
a quasi-coherent sheaf of ideals
$\mathcal{J} \subset \mathcal{O}_{X' \times_{Y'} X'}$ of finite type.
Since $\Omega_{X'/Y'} = 0$ by (5) we see that
the conormal sheaf of $X' \to X' \times_{Y'} X'$ is zero.
(The conormal sheaf of the closed immersion $\Delta_{X'/Y'}$ is equal to
$\Omega_{X'/Y'}$; this is the analogue of
Morphisms, Lemma \ref{morphisms-lemma-differentials-diagonal}
for algebraic spaces and follows either by \'etale localization
or by combining
Lemmas \ref{lemma-differentials-relative-immersion-section} and
\ref{lemma-differential-product}; some details omitted.)
In other words, $\mathcal{J}/\mathcal{J}^2 = 0$.
This implies $\Delta_{X'/Y'}$ is an isomorphism, for example
by Algebra, Lemma \ref{algebra-lemma-ideal-is-squared-union-connected}.

\medskip\noindent
Proof of (7). If $f : X \to Y$ is an immersion, then it factors as
$X \to V \to Y$ where $V \to Y$ is an open subspace and $X \to V$ is a
closed immersion, see
Morphisms of Spaces, Remark \ref{spaces-morphisms-remark-immersion}.
Let $V' \subset Y'$ be the open subspace whose
underlying topological space $|V'|$ is the same as $|V| \subset |Y| = |Y'|$.
Then $X' \to Y'$ factors through $V'$ and we conclude that $X' \to V'$
is a closed immersion by part (3).

\medskip\noindent
Case (8) follows from Lemma \ref{lemma-thicken-property-morphisms}
and the definition of proper morphisms as being the quasi-compact,
universally closed, and separated morphisms that are locally of finite type.
\end{proof}








\section{First order infinitesimal neighbourhood}
\label{section-first-order-infinitesimal-neighbourhood}

\noindent
A natural construction of first order thickenings is the following.
Suppose that $i : Z \to X$ be an immersion of algebraic spaces. Choose an
open subspace $U \subset X$ such that $i$ identifies $Z$ with a closed
subspace $Z \subset U$ (see
Morphisms of Spaces, Remark \ref{spaces-morphisms-remark-immersion}).
Let $\mathcal{I} \subset \mathcal{O}_U$ be the
quasi-coherent sheaf of ideals defining $Z$ in $U$, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Then we can consider
the closed subspace $Z' \subset U$ defined by the quasi-coherent sheaf
of ideals $\mathcal{I}^2$.

\begin{definition}
\label{definition-first-order-infinitesimal-neighbourhood}
Let $i : Z \to X$ be an immersion of algebraic spaces. The
{\it first order infinitesimal neighbourhood} of $Z$ in $X$ is
the first order thickening $Z \subset Z'$ over $X$ described above.
\end{definition}

\noindent
This thickening has the following universal property (which will assuage
any fears that the construction above depends on the choice of the open
$U$).

\begin{lemma}
\label{lemma-first-order-infinitesimal-neighbourhood}
Let $i : Z \to X$ be an immersion of algebraic spaces.
The first order infinitesimal neighbourhood $Z'$ of $Z$ in $X$
has the following universal property:
Given any commutative diagram
$$
\xymatrix{
Z \ar[d]_i & T \ar[l]^a \ar[d] \\
X & T' \ar[l]_b
}
$$
where $T \subset T'$ is a first order thickening over $X$, there exists
a unique morphism $(a', a) : (T \subset T') \to (Z \subset Z')$ of
thickenings over $X$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be the open subspace used in the construction of $Z'$,
i.e., an open such that $Z$ is identified with a closed subspace of $U$
cut out by the quasi-coherent sheaf of ideals $\mathcal{I}$.
Since $|T| = |T'|$ we see that $|b|(|T'|) \subset |U|$. Hence we can
think of $b$ as a morphism into $U$, see
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-factor-through-open-subspace}.
Let $\mathcal{J} \subset \mathcal{O}_{T'}$
be the square zero quasi-coherent sheaf of ideals cutting out $T$.
By the commutativity of the diagram we have $b|_T = i \circ a$ where
$i : Z \to U$ is the closed immersion. We conclude that
$b^\sharp(b^{-1}\mathcal{I}) \subset \mathcal{J}$ by
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
As $T'$ is a first order thickening of $T$ we see that $\mathcal{J}^2 = 0$
hence $b^\sharp(b^{-1}(\mathcal{I}^2)) = 0$. By
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}
this implies that $b$ factors through $Z'$. Letting $a' : T' \to Z'$
be this factorization we win.
\end{proof}

\begin{lemma}
\label{lemma-infinitesimal-neighbourhood-conormal}
Let $i : Z \to X$ be an immersion of algebraic spaces.
Let $Z \subset Z'$ be the first order infinitesimal neighbourhood
of $Z$ in $X$. Then the diagram
$$
\xymatrix{
Z \ar[r] \ar[d] & Z' \ar[d] \\
Z \ar[r] & X
}
$$
induces a map of conormal sheaves
$\mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Z'}$ by
Lemma \ref{lemma-conormal-functorial}.
This map is an isomorphism.
\end{lemma}

\begin{proof}
This is clear from the construction of $Z'$ above.
\end{proof}





\section{Formally smooth, \'etale, unramified transformations}
\label{section-formally-smooth-etale-unramified}

\noindent
Recall that a ring map $R \to A$ is called
{\it formally smooth}, resp.\ {\it formally \'etale},
resp.\ {\it formally unramified}
(see Algebra, Definition \ref{algebra-definition-formally-smooth},
resp.\ Definition \ref{algebra-definition-formally-etale},
resp.\ Definition \ref{algebra-definition-formally-unramified})
if for every commutative solid diagram
$$
\xymatrix{
A \ar[r] \ar@{-->}[rd] & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
where $I \subset B$ is an ideal of square zero, there
exists a, resp.\ exists a unique, resp.\ exists at most one dotted
arrow which makes the diagram commute. This motivates
the following analogue for morphisms of algebraic spaces, and more
generally functors.

\begin{definition}
\label{definition-formally-smooth-etale-unramified}
Let $S$ be a scheme.
Let $a : F \to G$ be a transformation of functors
$F, G : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Consider commutative solid diagrams of the form
$$
\xymatrix{
F \ar[d]_a & T \ar[d]^i \ar[l] \\
G & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T$ and $T'$ are affine schemes and $i$ is a closed immersion
defined by an ideal of square zero.
\begin{enumerate}
\item We say $a$ is {\it formally smooth} if given any solid
diagram as above there exists a dotted arrow making the diagram
commute\footnote{This is just one possible definition that one can
make here. Another slightly weaker condition would be to require that
the dotted arrow exists fppf locally on $T'$. This weaker notion
has in some sense better formal properties.}.
\item We say $a$ is {\it formally \'etale} if given any solid
diagram as above there exists exactly one dotted arrow making the diagram
commute.
\item We say $a$ is {\it formally unramified} if given any solid
diagram as above there exists at most one dotted arrow making the diagram
commute.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-formally-etale-is-combination}
Let $S$ be a scheme.
Let $a : F \to G$ be a transformation of functors
$F, G : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Then $a$ is formally \'etale if and only if $a$ is both formally
smooth and formally unramified.
\end{lemma}

\begin{proof}
Formal from the definition.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-smooth-etale-unramified}
Composition.
\begin{enumerate}
\item A composition of formally smooth transformations of functors is formally
smooth.
\item A composition of formally \'etale transformations of functors is formally
\'etale.
\item A composition of formally unramified transformations of functors is
formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-smooth-etale-unramified}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $F, G, H : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$, $b : H \to G$ be transformations of functors.
Consider the fibre product diagram
$$
\xymatrix{
H \times_{b, G, a} F \ar[r]_-{b'} \ar[d]_{a'} & F \ar[d]^a \\
H \ar[r]^b & G
}
$$
\begin{enumerate}
\item If $a$ is formally smooth, then the base change $a'$ is
formally smooth.
\item If $a$ is formally \'etale, then the base change $a'$ is
formally \'etale.
\item If $a$ is formally unramified, then the base change $a'$ is
formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-representable-property-formally-property}
Let $S$ be a scheme.
Let $F, G : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$ be a representable transformation of functors.
\begin{enumerate}
\item If $a$ is smooth then $a$ is formally smooth.
\item If $a$ is \'etale, then $a$ is formally \'etale.
\item If $a$ is unramified, then $a$ is formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider a solid commutative diagram
$$
\xymatrix{
F \ar[d]_a & T \ar[d]^i \ar[l] \\
G & T' \ar[l] \ar@{-->}[lu]
}
$$
as in
Definition \ref{definition-formally-smooth-etale-unramified}.
Then $F \times_G T'$ is a scheme smooth (resp.\ \'etale, resp.\ unramified)
over $T'$. Hence by
More on Morphisms, Lemma \ref{more-morphisms-lemma-smooth-formally-smooth}
(resp.\ Lemma \ref{more-morphisms-lemma-etale-formally-etale},
resp.\ Lemma \ref{more-morphisms-lemma-unramified-formally-unramified})
we can fill in (resp.\ uniquely fill in, resp.\ fill in in at most
one way) the dotted arrow in the diagram
$$
\xymatrix{
F \times_G T' \ar[d] & T \ar[d]^i \ar[l] \\
T' & T' \ar[l] \ar@{-->}[lu]
}
$$
an hence we also obtain the corresponding assertion in the first diagram.
\end{proof}

\begin{lemma}
\label{lemma-etale-on-top}
Let $S$ be a scheme contained in $\Sch_{fppf}$.
Let $F, G, H : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$, $b : G \to H$ be transformations of functors.
Assume that $a$ is representable, surjective, and \'etale.
\begin{enumerate}
\item If $b$ is formally smooth, then $b \circ a$ is formally smooth.
\item If $b$ is formally \'etale, then $b \circ a$ is formally \'etale.
\item If $b$ is formally unramified, then $b \circ a$ is formally unramified.
\end{enumerate}
Conversely, consider a solid commutative diagram
$$
\xymatrix{
G \ar[d]_b & T \ar[d]^i \ar[l] \\
H & T' \ar[l] \ar@{-->}[lu]
}
$$
with $T'$ an affine scheme over $S$
and $i : T \to T'$ a closed immersion defined by an ideal of square zero.
\begin{enumerate}
\item[(4)] If $b \circ a$ is formally smooth, then for every $t \in T$
there exists an \'etale morphism of affines $U' \to T'$ and a morphism
$U' \to G$ such that
$$
\xymatrix{
G \ar[d]_b & T \ar[l] & T \times_{T'} U' \ar[d] \ar[l]\\
H & T' \ar[l] & U' \ar[llu] \ar[l]
}
$$
commutes and $t$ is in the image of $U' \to T'$.
\item[(5)] If $b \circ a$ is formally unramified, then there exists at most
one dotted arrow in the diagram above, i.e., $b$ is formally unramified.
\item[(6)] If $b \circ a$ is formally \'etale, then there exists exactly one
dotted arrow in the diagram above, i.e., $b$ is formally \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $b$ is formally smooth (resp.\ formally \'etale,
resp.\ formally unramified). Since an \'etale morphism is both
smooth and unramified we see that $a$ is representable and smooth
(resp.\ \'etale, resp. unramified). Hence parts (1), (2) and (3)
follow from a combination of
Lemma \ref{lemma-representable-property-formally-property}
and
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}.

\medskip\noindent
Assume that $b \circ a$ is formally smooth. Consider a diagram
as in the statement of the lemma. Let $W = F \times_G T$.
By assumption $W$ is a scheme surjective \'etale over $T$. By
\'Etale Morphisms, Theorem \ref{etale-theorem-remarkable-equivalence}
there exists a scheme $W'$ \'etale over $T'$ such that $W = T \times_{T'} W'$.
Choose an affine open subscheme $U' \subset W'$ such that $t$ is in
the image of $U' \to T'$. Because $b \circ a$ is formally
smooth we see that the exist morphisms $U' \to F$ such that
$$
\xymatrix{
F \ar[d]_{b \circ a} & W \ar[l] & T \times_{T'} U' \ar[d] \ar[l]\\
H & T' \ar[l] & U' \ar[llu] \ar[l]
}
$$
commutes. Taking the composition $U' \to F \to G$ gives a
map as in part (5) of the lemma.

\medskip\noindent
Assume that $f, g : T' \to G$ are two dotted arrows fitting into the
diagram of the lemma. Let $W = F \times_G T$.
By assumption $W$ is a scheme surjective \'etale over $T$. By
\'Etale Morphisms, Theorem \ref{etale-theorem-remarkable-equivalence}
there exists a scheme $W'$ \'etale over $T'$ such that $W = T \times_{T'} W'$.
Since $a$ is formally \'etale the compositions
$$
W' \to T' \xrightarrow{f} G
\quad\text{and}\quad
W' \to T' \xrightarrow{g} G
$$
lift to morphisms $f', g' : W' \to F$ (lift on affine opens and glue by
uniqueness). Now if $b \circ a : F \to H$ is formally unramified, then
$f' = g'$ and hence $f = g$ as $W' \to T'$ is an \'etale covering. This proves
part (6) of the lemma.

\medskip\noindent
Assume that $b \circ a$ is formally \'etale. Then by part (4) we
can \'etale locally on $T'$ find a dotted arrow fitting into the diagram
and by part (5) this dotted arrow is unique. Hence we may glue the
local solutions to get assertion (6). Some details omitted.
\end{proof}

\begin{remark}
\label{remark-tempting}
It is tempting to think that in the situation of
Lemma \ref{lemma-etale-on-top}
we have
``$b$ formally smooth'' $\Leftrightarrow$ ``$b \circ a$ formally smooth''.
However, this is likely not true in general.
\end{remark}

\begin{lemma}
\label{lemma-formally-permanence}
Let $S$ be a scheme.
Let $F, G, H : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$, $b : G \to H$ be transformations of functors.
Assume $b$ is formally unramified.
\begin{enumerate}
\item If $b \circ a$ is formally unramified then $a$ is formally unramified.
\item If $b \circ a$ is formally \'etale then $a$ is formally \'etale.
\item If $b \circ a$ is formally smooth then $a$ is formally smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $T \subset T'$ be a closed immersion of affine schemes defined by an ideal
of square zero. Let $g' : T' \to G$ and $f : T \to F$ be given such that
$g'|_T = a \circ f$. Because $b$ is formally unramified, there is a one
to one correspondence between
$$
\{f' : T' \to F \mid f = f'|_T\text{ and }a \circ f' = g'\}
$$
and
$$
\{f' : T' \to F \mid f = f'|_T\text{ and }b \circ a \circ f' = b \circ g'\}.
$$
From this the lemma follows formally.
\end{proof}








\section{Formally unramified morphisms}
\label{section-formally-unramified}

\noindent
In this section we work out what it means that a morphism of algebraic spaces
is formally unramified.

\begin{definition}
\label{definition-formally-unramified}
Let $S$ be a scheme. A morphism $f : X \to Y$ of algebraic spaces over $S$
is said to be {\it formally unramified} if it is formally unramified as a
transformation of functors as in
Definition \ref{definition-formally-smooth-etale-unramified}.
\end{definition}

\noindent
We will not restate the results proved in the more general setting of
formally unramified transformations of functors in
Section \ref{section-formally-smooth-etale-unramified}.
It turns out we can characterize this property in terms of vanishing of the
module of relative differentials, see
Lemma \ref{lemma-characterize-formally-unramified}.

\begin{lemma}
\label{lemma-formally-unramified}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces over
$S$. The following are equivalent:
\begin{enumerate}
\item $f$ is formally unramified,
\item for every diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale
the morphism of schemes $\psi$ is formally unramified (as in
More on Morphisms,
Definition \ref{more-morphisms-definition-formally-unramified}), and
\item for one such diagram with surjective vertical arrows the morphism
$\psi$ is formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is formally unramified. By
Lemma \ref{lemma-representable-property-formally-property}
the morphisms $U \to X$ and $V \to Y$ are formally unramified. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally unramified. Then it follows from
Lemma \ref{lemma-formally-permanence}
that $U \to V$ is formally unramified. Thus (1) implies (2). And (2)
implies (3) trivially

\medskip\noindent
Assume given a diagram as in (3). By
Lemma \ref{lemma-representable-property-formally-property}
the morphism $V \to Y$ is formally unramified. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally unramified. Then it follows from
Lemma \ref{lemma-etale-on-top}
that $X \to Y$ is formally unramified, i.e., (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified-not-affine}
Let $S$ be a scheme.
If $f : X \to Y$ is a formally unramified morphism of algebraic spaces
over $S$, then given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T \subset T'$ is a first order thickening of algebraic spaces
over $S$ there exists at most one dotted arrow making the diagram commute.
In other words, in
Definition \ref{definition-formally-unramified}
the condition that $T$ be an affine scheme may be dropped.
\end{lemma}

\begin{proof}
This is true because there exists a surjective \'etale morphism
$U' \to T'$ where $U'$ is a disjoint union of affine schemes (see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-cover-by-union-affines})
and a morphism $T' \to X$ is determined by its restriction to $U'$.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-unramified}
A composition of formally unramified morphisms is formally unramified.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-unramified}
A base change of a formally unramified morphism is formally unramified.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-characterize-formally-unramified}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces over
$S$. The following are equivalent:
\begin{enumerate}
\item $f$ is formally unramified, and
\item $\Omega_{X/Y} = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a combination of
Lemma \ref{lemma-formally-unramified},
More on Morphisms,
Lemma \ref{more-morphisms-lemma-formally-unramified-differentials},
and
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-formally-unramified}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is unramified,
\item the morphism $f$ is locally of finite type and $\Omega_{X/Y} = 0$, and
\item the morphism $f$ is locally of finite type and formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale and
surjective. Then we see
\begin{align*}
f\text{ unramified}
& \Leftrightarrow
\psi\text{ unramified} \\
& \Leftrightarrow
\psi\text{ locally finite type and }\Omega_{U/V} = 0 \\
& \Leftrightarrow
f\text{ locally finite type and }\Omega_{X/Y} = 0 \\
& \Leftrightarrow
f\text{ locally finite type and formally unramified}
\end{align*}
Here we have used
Morphisms, Lemma \ref{morphisms-lemma-unramified-omega-zero} and
Lemma \ref{lemma-characterize-formally-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-unramified}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item $f$ is unramified and a monomorphism,
\item $f$ is unramified and universally injective,
\item $f$ is locally of finite type and a monomorphism,
\item $f$ is universally injective, locally of finite type, and
formally unramified.
\end{enumerate}
Moreover, in this case $f$ is also representable, separated, and
locally quasi-finite.
\end{lemma}

\begin{proof}
We have seen in
Lemma \ref{lemma-unramified-formally-unramified}
that being formally unramified and locally of finite type is the same thing
as being unramified.
Hence (4) is equivalent to (2).
A monomorphism is certainly formally unramified hence (3) implies (4).
It is clear that (1) implies (3). Finally, if (2) holds, then
$\Delta : X \to X \times_Y X$ is both an open immersion
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-diagonal-unramified-morphism})
and surjective
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-injective})
hence an isomorphism, i.e., $f$ is a monomorphism. In this way we see that
(2) implies (1).
Finally, we see that $f$ is representable, separated, and locally
quasi-finite by
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-monomorphism-loc-finite-type-loc-quasi-finite} and
\ref{spaces-morphisms-lemma-locally-quasi-finite-separated-representable}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-closed-immersion}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item $f$ is a closed immersion,
\item $f$ is universally closed, unramified, and a monomorphism,
\item $f$ is universally closed, unramified, and universally injective,
\item $f$ is universally closed, locally of finite type, and a monomorphism,
\item $f$ is universally closed, universally injective, locally of
finite type, and formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (2) -- (5) follows immediately from
Lemma \ref{lemma-universally-injective-unramified}.
Moreover, if (2) -- (5) are satisfied then $f$ is representable.
Similarly, if (1) is satisfied then $f$ is representable.
Hence the result follows from the case of schemes, see
\'Etale Morphisms, Lemma \ref{etale-lemma-characterize-closed-immersion}.
\end{proof}





\section{Universal first order thickenings}
\label{section-universal-thickening}

\noindent
Let $S$ be a scheme.
Let $h : Z \to X$ be a morphism of algebraic spaces over $S$.
A {\it universal first order thickening} of $Z$ over $X$ is a
first order thickening $Z \subset Z'$ over $X$ such that given
any first order thickening $T \subset T'$
over $X$ and a solid commutative diagram
\begin{equation}
\label{equation-universal-first-order-thickening}
\vcenter{
\xymatrix{
& Z \ar[ld] & & T \ar[rd] \ar[ll]^a \\
Z' \ar[rrd] & & & & T' \ar@{..>}[llll]_{a'} \ar[lld]^b \\
 & & X
}
}
\end{equation}
there exists a unique dotted arrow making the diagram commute.
Note that in this situation $(a, a') : (T \subset T') \to (Z \subset Z')$
is a morphism of thickenings over $X$. Thus if a universal first order
thickening exists, then it is unique up to unique isomorphism.
In general a universal first order thickening
does not exist, but if $h$ is formally unramified then it does.
Before we prove this, let us show that a universal first order thickening
in the category of schemes is a universal first order thickening in the
category of algebraic spaces.

\begin{lemma}
\label{lemma-check-universal-first-order-thickening}
Let $S$ be a scheme.
Let $h : Z \to X$ be a morphism of algebraic spaces over $S$.
Let $Z \subset Z'$ be a first order thickening over $X$.
The following are equivalent
\begin{enumerate}
\item $Z \subset Z'$ is a universal first order thickening,
\item for any diagram (\ref{equation-universal-first-order-thickening})
with $T'$ a scheme a unique dotted arrow exists making the diagram commute, and
\item for any diagram (\ref{equation-universal-first-order-thickening})
with $T'$ an affine scheme a unique dotted arrow exists making the
diagram commute.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (1) $\Rightarrow$ (2) $\Rightarrow$ (3) are formal.
Assume (3) a assume given an arbitrary diagram
(\ref{equation-universal-first-order-thickening}).
Choose a presentation $T' = U'/R'$, see
Spaces, Definition \ref{spaces-definition-presentation}.
We may assume that $U' = \coprod U'_i$ is a disjoint union
of affines, so $R' = U' \times_{T'} U' = \coprod_{i, j} U'_i \times_T' U'_j$.
For each pair $(i, j)$ choose an affine open covering
$U'_i \times_T' U'_j = \bigcup_k R'_{ijk}$. Denote $U_i, R_{ijk}$
the fibre products with $T$ over $T'$. Then each
$U_i \subset U'_i$ and $R_{ijk} \subset R'_{ijk}$
is a first order thickening of affine schemes.
Denote $a_i : U_i \to Z$, resp.\ $a_{ijk} : R_{ijk} \to Z$
the composition of $a : T \to Z$ with the morphism
$U_i \to T$, resp.\ $R_{ijk} \to T$.
By (3) applied to $a_i : U_i \to Z$
we obtain unique morphisms $a'_i : U'_i \to Z'$.
By (3) applied to $a_{ijk}$ we see that the two compositions
$R'_{ijk} \to R'_i \to Z'$ and $R'_{ijk} \to R'_j \to Z'$
are equal. Hence $a' = \coprod a'_i : U' = \coprod U'_i \to Z'$
descends to the quotient sheaf $T' = U'/R'$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-over-formally-etale}
Let $S$ be a scheme.
Let $Z \to Y \to X$ be morphisms of algebraic spaces over $S$.
If $Z \subset Z'$ is a universal first order thickening of
$Z$ over $Y$ and $Y \to X$ is formally \'etale, then $Z \subset Z'$ is
a universal first order thickening of $Z$ over $X$.
\end{lemma}

\begin{proof}
This is formal. Namely, by
Lemma \ref{lemma-check-universal-first-order-thickening}
it suffices to consider solid commutative diagrams
(\ref{equation-universal-first-order-thickening})
with $T'$ an affine scheme. The composition
$T \to Z \to Y$ lifts uniquely to $T' \to Y$ as $Y \to X$ is
assumed formally \'etale. Hence the fact that
$Z \subset Z'$ is a universal first order thickening over $Y$
produces the desired morphism $a' : T' \to Z'$.
\end{proof}

\begin{lemma}
\label{lemma-etale-morphism-of-universal-thickenings}
Let $S$ be a scheme.
Let $Z \to Y \to X$ be morphisms of algebraic spaces over $S$.
Assume $Z \to Y$ is \'etale.
\begin{enumerate}
\item If $Y \subset Y'$ is a universal first order thickening of
$Y$ over $X$, then the unique \'etale morphism $Z' \to Y'$ such
that $Z = Y \times_{Y'} Z'$ (see
Theorem \ref{theorem-topological-invariance})
is a universal first order thickening of $Z$ over $X$.
\item If $Z \to Y$ is surjective and
$(Z \subset Z') \to (Y \subset Y')$ is an \'etale morphism
of first order thickenings over $X$ and $Z'$ is a universal first
order thickening of $Z$ over $X$, then $Y'$ is a universal first
order thickening of $Y$ over $X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). By
Lemma \ref{lemma-check-universal-first-order-thickening}
it suffices to consider solid commutative diagrams
(\ref{equation-universal-first-order-thickening})
with $T'$ an affine scheme. The composition
$T \to Z \to Y$ lifts uniquely to $T' \to Y'$ as $Y'$ is
the universal first order thickening. Then the fact that
$Z' \to Y'$ is \'etale implies (see
Lemma \ref{lemma-representable-property-formally-property})
that $T' \to Y'$ lifts to the
desired morphism $a' : T' \to Z'$.

\medskip\noindent
Proof of (2). Let $T \subset T'$ be a first order thickening over
$X$ and let $a : T \to Y$ be a morphism. Set $W = T \times_Y Z$
and denote $c : W \to Z$ the projection
Let $W' \to T'$ be the unique \'etale morphism such that
$W = T \times_{T'} W'$, see
Theorem \ref{theorem-topological-invariance}.
Note that $W' \to T'$ is surjective as $Z \to Y$ is surjective.
By assumption we obtain a unique morphism $c' : W' \to Z'$
over $X$ restricting to $c$ on $W$. By uniqueness the two restrictions
of $c'$ to $W' \times_{T'} W'$ are equal (as the two restrictions of
$c$ to $W \times_T W$ are equal). Hence $c'$ descends to a unique
morphism $a' : T' \to Y'$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening}
Let $S$ be a scheme.
Let $h : Z \to X$ be a formally unramified morphism of algebraic
spaces over $S$.
There exists a universal first order thickening $Z \subset Z'$ of
$Z$ over $X$.
\end{lemma}

\begin{proof}
Choose any commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r] & U \ar[d] \\
Z \ar[r] & X
}
$$
where $V$ and $U$ are schemes and the vertical arrows are \'etale.
Note that $V \to U$ is a formally unramified morphism of schemes, see
Lemma \ref{lemma-formally-unramified}.
Combining
Lemma \ref{lemma-check-universal-first-order-thickening}
and
More on Morphisms, Lemma \ref{more-morphisms-lemma-universal-thickening}
we see that a universal first order thickening $V \subset V'$
of $V$ over $U$ exists. By
Lemma \ref{lemma-universal-thickening-over-formally-etale} part (1)
$V'$ is a universal first order thickening of $V$ over $X$.

\medskip\noindent
Fix a scheme $U$ and a surjective \'etale morphism $U \to X$.
The argument above shows that for any $V \to Z$ \'etale with $V$
a scheme such that $V \to Z \to X$ factors through $U$ a
universal first order thickening $V \subset V'$ of $V$ over $X$
exists (but does not depend on the chosen factorization of $V \to X$
through $U$). Now we may choose $V$ such that $V \to Z$ is surjective
\'etale (see
Spaces, Lemma \ref{spaces-lemma-lift-morphism-presentations}).
Then $R = V \times_Z V$ a scheme \'etale over $Z$ such that
$R \to X$ factors through $U$ also.
Hence we obtain universal first order thickenings
$V \subset V'$ and $R \subset R'$ over $X$.
As $V \subset V'$ is a universal first order thickening,
the two projections $s, t : R \to V$ lift to morphisms
$s', t': R' \to V'$. By
Lemma \ref{lemma-etale-morphism-of-universal-thickenings}
as $R'$ is the universal first order thickening of $R$ over $X$
these morphisms are \'etale.
Then $(t', s') : R' \to V'$ is an \'etale equivalence relation
and we can set $Z' = V'/R'$. Since $V' \to Z'$ is surjective \'etale
and $v'$ is the universal first order thickening of $V$ over $X$
we conclude from
Lemma \ref{lemma-universal-thickening-over-formally-etale} part (2)
that $Z'$ is a universal first order thickening of $Z$ over $X$.
\end{proof}

\begin{definition}
\label{definition-universal-thickening}
Let $S$ be a scheme.
Let $h : Z \to X$ be a formally unramified morphism of
algebraic spaces over $S$.
\begin{enumerate}
\item The {\it universal first order thickening} of $Z$ over $X$
is the thickening $Z \subset Z'$ constructed in
Lemma \ref{lemma-universal-thickening}.
\item The {\it conormal sheaf of $Z$ over $X$} is the conormal sheaf
of $Z$ in its universal first order thickening $Z'$ over $X$.
\end{enumerate}
We often denote the conormal sheaf $\mathcal{C}_{Z/X}$ in this situation.
\end{definition}

\noindent
Thus we see that there is a short exact sequence of sheaves
$$
0 \to \mathcal{C}_{Z/X} \to \mathcal{O}_{Z'} \to \mathcal{O}_Z \to 0
$$
on $Z_\etale$ and $\mathcal{C}_{Z/X}$ is a quasi-coherent
$\mathcal{O}_Z$-module. The following lemma proves that there is no
conflict between this definition and the definition in case $Z \to X$
is an immersion.

\begin{lemma}
\label{lemma-immersion-universal-thickening}
Let $S$ be a scheme.
Let $i : Z \to X$ be an immersion of algebraic spaces over $S$. Then
\begin{enumerate}
\item $i$ is formally unramified,
\item the universal first order thickening of $Z$ over $X$ is the first order
infinitesimal neighbourhood of $Z$ in $X$ of
Definition \ref{definition-first-order-infinitesimal-neighbourhood},
\item the conormal sheaf of $i$ in the sense of
Definition \ref{definition-conormal-sheaf}
agrees with the conormal sheaf of $i$ in the sense of
Definition \ref{definition-universal-thickening}.
\end{enumerate}
\end{lemma}

\begin{proof}
An immersion of algebraic spaces is by definition a representable morphism.
Hence by
Morphisms, Lemmas \ref{morphisms-lemma-open-immersion-unramified} and
\ref{morphisms-lemma-closed-immersion-unramified}
an immersion is unramified (via the abstract principle of
Spaces, Lemma
\ref{spaces-lemma-representable-transformations-property-implication}).
Hence it is formally unramified by
Lemma \ref{lemma-unramified-formally-unramified}.
The other assertions follow by combining
Lemmas \ref{lemma-first-order-infinitesimal-neighbourhood} and
\ref{lemma-infinitesimal-neighbourhood-conormal}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-unramified}
Let $S$ be a scheme.
Let $Z \to X$ be a formally unramified morphism of algebraic spaces over $S$.
Then the universal first order thickening $Z'$ is formally
unramified over $X$.
\end{lemma}

\begin{proof}
Let $T \subset T'$ be a first order thickening of affine schemes over $X$.
Let
$$
\xymatrix{
Z' \ar[d] & T \ar[l]^c \ar[d] \\
X & T' \ar[l] \ar[lu]^{a, b}
}
$$
be a commutative diagram. Set $T_0 = c^{-1}(Z) \subset T$ and
$T'_a = a^{-1}(Z)$ (scheme theoretically).
Since $Z'$ is a first order thickening of $Z$, we see that $T'$
is a first order thickening of $T'_a$. Moreover, since $c = a|_T$ we see that
$T_0 = T \cap T'_a$ (scheme theoretically). As $T'$ is a first order
thickening of $T$ it follows that $T'_a$
is a first order thickening of $T_0$. Now $a|_{T'_a}$ and $b|_{T'_a}$
are morphisms of $T'_a$ into $Z'$ over $X$ which agree on $T_0$ as
morphisms into $Z$. Hence by the universal property of $Z'$ we conclude that
$a|_{T'_a} = b|_{T'_a}$. Thus $a$ and $b$ are morphism from
the first order thickening $T'$ of $T'_a$ whose restrictions to
$T'_a$ agree as morphisms into $Z$. Thus using the universal property of
$Z'$ once more we conclude that $a = b$. In other words, the defining
property of a formally unramified morphism holds for $Z' \to X$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-functorial}
Let $S$ be a scheme
Consider a commutative diagram of algebraic spaces over $S$
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
with $h$ and $h'$ formally unramified. Let $Z \subset Z'$ be the universal
first order thickening of $Z$ over $X$. Let $W \subset W'$ be the universal
first order thickening of $W$ over $Y$. There exists a canonical morphism
$(f, f') : (Z, Z') \to (W, W')$ of thickenings over $Y$ which fits into
the following commutative diagram
$$
\xymatrix{
& & & Z' \ar[ld] \ar[d]^{f'} \\
Z \ar[rr] \ar[d]_f \ar[rrru] & & X \ar[d] & W' \ar[ld] \\
W \ar[rrru]|!{[rr];[rruu]}\hole \ar[rr] & & Y
}
$$
In particular the morphism $(f, f')$ of thickenings induces a morphism
of conormal sheaves $f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$.
\end{lemma}

\begin{proof}
The first assertion is clear from the universal property of $W'$.
The induced map on conormal sheaves is the map of
Lemma \ref{lemma-conormal-functorial}
applied to $(Z \subset Z') \to (W \subset W')$.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-fibre-product}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
be a fibre product diagram of algebraic spaces over $S$ with
$h'$ formally unramified. Then $h$ is formally unramified and if
$W \subset W'$ is the universal first order thickening of $W$ over $Y$,
then $Z = X \times_Y W \subset X \times_Y W'$ is the universal
first order thickening of $Z$ over $X$. In particular the canonical map
$f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$ of
Lemma \ref{lemma-universal-thickening-functorial}
is surjective.
\end{lemma}

\begin{proof}
The morphism $h$ is formally unramified by
Lemma \ref{lemma-base-change-formally-unramified}.
It is clear that $X \times_Y W'$ is a first order thickening.
It is straightforward to check that it has the universal property
because $W'$ has the universal property (by mapping properties of
fibre products). See
Lemma \ref{lemma-conormal-functorial-flat}
for why this implies that the map of conormal sheaves is surjective.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-fibre-product-flat}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
be a fibre product diagram of algebraic spaces over $S$ with
$h'$ formally unramified and $g$ flat. In this case the corresponding
map $Z' \to W'$ of universal first order thickenings is flat, and
$f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$ is an isomorphism.
\end{lemma}

\begin{proof}
Flatness is preserved under base change, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-flat}.
Hence the first statement follows from the description of $W'$ in
Lemma \ref{lemma-universal-thickening-fibre-product}.
It is clear that $X \times_Y W'$ is a first order thickening.
It is straightforward to check that it has the universal property
because $W'$ has the universal property (by mapping properties of
fibre products). See
Lemma \ref{lemma-conormal-functorial-flat}
for why this implies that the map of conormal sheaves is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-localize}
Taking the universal first order thickenings commutes with \'etale
localization. More precisely, let $h : Z \to X$ be a formally unramified
morphism of algebraic spaces over a base scheme $S$.
Let
$$
\xymatrix{
V \ar[d] \ar[r] & U \ar[d] \\
Z \ar[r] & X
}
$$
be a commutative diagram with \'etale vertical arrows.
Let $Z'$ be the universal first order thickening of $Z$ over $X$.
Then $V \to U$ is formally unramified and the universal first
order thickening $V'$ of $V$ over $U$ is \'etale over $Z'$.
In particular, $\mathcal{C}_{Z/X}|_V = \mathcal{C}_{V/U}$.
\end{lemma}

\begin{proof}
The first statement is
Lemma \ref{lemma-formally-unramified}.
The compatibility of universal first order thickenings is
a consequence of
Lemmas \ref{lemma-universal-thickening-over-formally-etale} and
\ref{lemma-etale-morphism-of-universal-thickenings}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-universally-unramified}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $h : Z \to X$ be a formally unramified morphism of algebraic spaces
over $B$. Let $Z \subset Z'$ be the universal first order thickening of $Z$
over $X$ with structure morphism $h' : Z' \to X$. The canonical map
$$
\text{d}h' : (h')^*\Omega_{X/B} \to \Omega_{Z'/B}
$$
induces an isomorphism
$h^*\Omega_{X/B} \to \Omega_{Z'/B} \otimes \mathcal{O}_Z$.
\end{lemma}

\begin{proof}
The map $c_{h'}$ is the map defined in
Lemma \ref{lemma-functoriality-differentials}.
If $i : Z \to Z'$ is the given closed immersion, then
$i^*c_{h'}$ is a map
$h^*\Omega_{X/S} \to \Omega_{Z'/S} \otimes \mathcal{O}_Z$.
Checking that it is an isomorphism reduces to the case of schemes
by \'etale localization, see
Lemma \ref{lemma-universal-thickening-localize}
and
Lemma \ref{lemma-localize-differentials}.
In this case the result is
More on Morphisms,
Lemma \ref{more-morphisms-lemma-differentials-universally-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-universally-unramified-differentials-sequence}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $h : Z \to X$ be a formally unramified morphism of algebraic
spaces over $B$.
There is a canonical exact sequence
$$
\mathcal{C}_{Z/X} \to h^*\Omega_{X/B} \to \Omega_{Z/B} \to 0.
$$
The first arrow is induced by $\text{d}_{Z'/B}$ where
$Z'$ is the universal first order neighbourhood of $Z$ over $X$.
\end{lemma}

\begin{proof}
We know that there is a canonical exact sequence
$$
\mathcal{C}_{Z/Z'} \to
\Omega_{Z'/S} \otimes \mathcal{O}_Z \to
\Omega_{Z/S} \to 0.
$$
see
Lemma \ref{lemma-differentials-relative-immersion}.
Hence the result follows on applying
Lemma \ref{lemma-differentials-universally-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-two-unramified-morphisms}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_i \ar[rd]_j & X \ar[d] \\
& Y
}
$$
be a commutative diagram of algebraic spaces over $S$
where $i$ and $j$ are formally unramified. Then there is a
canonical exact sequence
$$
\mathcal{C}_{Z/Y} \to
\mathcal{C}_{Z/X} \to
i^*\Omega_{X/Y} \to 0
$$
where the first arrow comes from
Lemma \ref{lemma-universal-thickening-functorial}
and the second from
Lemma \ref{lemma-universally-unramified-differentials-sequence}.
\end{lemma}

\begin{proof}
Since the maps have been defined, checking the sequence is exact
reduces to the case of schemes by \'etale localization, see
Lemma \ref{lemma-universal-thickening-localize}
and
Lemma \ref{lemma-localize-differentials}.
In this case the result is
More on Morphisms,
Lemma \ref{more-morphisms-lemma-two-unramified-morphisms}.
\end{proof}

\begin{lemma}
\label{lemma-transitivity-conormal-unramified}
Let $S$ be a scheme.
Let $Z \to Y \to X$ be formally unramified morphisms of
algebraic spaces over $S$.
\begin{enumerate}
\item If $Z \subset Z'$ is the universal first order thickening of $Z$
over $X$ and $Y \subset Y'$ is the universal first order thickening of $Y$
over $X$, then there is a morphism $Z' \to Y'$ and $Y \times_{Y'} Z'$ is
the universal first order thickening of $Z$ over $Y$.
\item There is a canonical exact sequence
$$
i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
where the maps come from
Lemma \ref{lemma-universal-thickening-functorial}
and $i : Z \to Y$ is the first morphism.
\end{enumerate}
\end{lemma}

\begin{proof}
The map $h : Z' \to Y'$ in (1) comes from
Lemma \ref{lemma-universal-thickening-functorial}.
The assertion that $Y \times_{Y'} Z'$ is the universal first order
thickening of $Z$ over $Y$ is clear from the universal properties
of $Z'$ and $Y'$. By
Lemma \ref{lemma-transitivity-conormal}
we have an exact sequence
$$
(i')^*\mathcal{C}_{Y \times_{Y'} Z'/Z'} \to
\mathcal{C}_{Z/Z'} \to
\mathcal{C}_{Z/Y \times_{Y'} Z'} \to 0
$$
where $i' : Z \to Y \times_{Y'} Z'$ is the given morphism. By
Lemma \ref{lemma-conormal-functorial-flat}
there exists a surjection
$h^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{Y \times_{Y'} Z'/Z'}$.
Combined with the equalities
$\mathcal{C}_{Y/Y'} = \mathcal{C}_{Y/X}$,
$\mathcal{C}_{Z/Z'} = \mathcal{C}_{Z/X}$, and
$\mathcal{C}_{Z/Y \times_{Y'} Z'} = \mathcal{C}_{Z/Y}$
this proves the lemma.
\end{proof}













\section{Formally \'etale morphisms}
\label{section-formally-etale}

\noindent
In this section we work out what it means that a morphism of algebraic spaces
is formally \'etale.

\begin{definition}
\label{definition-formally-etale}
Let $S$ be a scheme. A morphism $f : X \to Y$ of algebraic spaces over $S$
is said to be {\it formally \'etale} if it is formally \'etale as a
transformation of functors as in
Definition \ref{definition-formally-smooth-etale-unramified}.
\end{definition}

\noindent
We will not restate the results proved in the more general setting of
formally \'etale transformations of functors in
Section \ref{section-formally-smooth-etale-unramified}.

\begin{lemma}
\label{lemma-formally-etale}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces over
$S$. The following are equivalent:
\begin{enumerate}
\item $f$ is formally \'etale,
\item for every diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale
the morphism of schemes $\psi$ is formally \'etale (as in
More on Morphisms,
Definition \ref{more-morphisms-definition-formally-etale}), and
\item for one such diagram with surjective vertical arrows the morphism
$\psi$ is formally \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is formally \'etale. By
Lemma \ref{lemma-representable-property-formally-property}
the morphisms $U \to X$ and $V \to Y$ are formally \'etale. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally \'etale. Then it follows from
Lemma \ref{lemma-formally-permanence}
that $U \to V$ is formally \'etale. Thus (1) implies (2). And (2)
implies (3) trivially

\medskip\noindent
Assume given a diagram as in (3). By
Lemma \ref{lemma-representable-property-formally-property}
the morphism $V \to Y$ is formally \'etale. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally \'etale. Then it follows from
Lemma \ref{lemma-etale-on-top}
that $X \to Y$ is formally \'etale, i.e., (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-formally-etale-not-affine}
Let $S$ be a scheme.
Let $f : X \to Y$ be a formally \'etale morphism of algebraic spaces over $S$.
Then given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l]_a \\
Y & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T \subset T'$ is a first order thickening of algebraic spaces
over $Y$ there exists exactly one dotted arrow making the diagram commute.
In other words, in
Definition \ref{definition-formally-etale}
the condition that $T$ be affine may be dropped.
\end{lemma}

\begin{proof}
Let $U' \to T'$ be a surjective \'etale morphism where $U' = \coprod U'_i$
is a disjoint union of affine schemes. Let
$U_i = T \times_{T'} U'_i$. Then we get morphisms
$a'_i : U'_i \to X$ such that $a'_i|_{U_i}$ equals the composition
$U_i \to T \to X$. By uniqueness (see
Lemma \ref{lemma-formally-unramified-not-affine})
we see that $a'_i$ and $a'_j$ agree on the fibre product
$U'_i \times_{T'} U'_j$. Hence $\coprod a'_i : U' \to X$
descends to give a unique morphism $a' : T' \to X$.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-etale}
A composition of formally \'etale morphisms is formally \'etale.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-etale}
A base change of a formally \'etale morphism is formally \'etale.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-characterize-formally-etale}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$
The following are equivalent:
\begin{enumerate}
\item $f$ is formally \'etale,
\item $f$ is formally unramified and the universal first order thickening
of $X$ over $Y$ is equal to $X$,
\item $f$ is formally unramified and $\mathcal{C}_{X/Y} = 0$, and
\item $\Omega_{X/Y} = 0$ and $\mathcal{C}_{X/Y} = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Actually, the last assertion only make sense because $\Omega_{X/Y} = 0$
implies that $\mathcal{C}_{X/Y}$ is defined via
Lemma \ref{lemma-characterize-formally-unramified}
and
Definition \ref{definition-universal-thickening}.
This also makes it clear that (3) and (4) are equivalent.

\medskip\noindent
Either of the assumptions (1), (2), and (3) imply that $f$ is formally
unramified. Hence we may assume $f$ is formally unramified. The equivalence
of (1), (2), and (3) follow from the universal property of the universal
first order thickening $X'$ of $X$ over $S$ and the fact that
$X = X' \Leftrightarrow \mathcal{C}_{X/Y} = 0$ since
after all by definition $\mathcal{C}_{X/Y} = \mathcal{C}_{X/X'}$
is the ideal sheaf of $X$ in $X'$.
\end{proof}

\begin{lemma}
\label{lemma-unramified-flat-formally-etale}
An unramified flat morphism is formally \'etale.
\end{lemma}

\begin{proof}
Follows from the case of schemes, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-unramified-flat-formally-etale}
and \'etale localization, see
Lemmas \ref{lemma-formally-unramified} and \ref{lemma-formally-etale}
and
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-local}.
\end{proof}

\begin{lemma}
\label{lemma-etale-formally-etale}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is \'etale, and
\item the morphism $f$ is locally of finite presentation and
formally \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the case of schemes, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-etale-formally-etale}
and \'etale localization, see
Lemma \ref{lemma-formally-etale}
and
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-finite-presentation-local} and
\ref{spaces-morphisms-lemma-etale-local}.
\end{proof}















\section{Infinitesimal deformations of maps}
\label{section-action-by-derivations}

\noindent
In this section we explain how a derivation can be used to
infinitesimally move a map. Throughout this section we use that
a sheaf on a thickening $X'$ of $X$ can be seen as a sheaf on $X$, see
Equations (\ref{equation-equivalence-etale-spaces}) and
(\ref{equation-fundamental-equivalence}).

\begin{lemma}
\label{lemma-difference-derivation}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $X \subset X'$ and $Y \subset Y'$ be two first order thickenings
of algebraic spaces over $B$.
Let $(a, a'), (b, b') : (X \subset X') \to (Y \subset Y')$
be two morphisms of thickenings over $B$. Assume that
\begin{enumerate}
\item $a = b$, and
\item the two maps $a^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{X/X'}$
(Lemma \ref{lemma-conormal-functorial})
are equal.
\end{enumerate}
Then the map $(a')^\sharp - (b')^\sharp$ factors as
$$
\mathcal{O}_{Y'} \to \mathcal{O}_Y \xrightarrow{D}
a_*\mathcal{C}_{X/X'} \to a_*\mathcal{O}_{X'}
$$
where $D$ is an $\mathcal{O}_B$-derivation.
\end{lemma}

\begin{proof}
Instead of working on $Y$ we work on $X$. The advantage is that the pullback
functor $a^{-1}$ is exact. Using (1) and (2) we obtain a commutive diagram
with exact rows
$$
\xymatrix{
0 \ar[r] &
\mathcal{C}_{X/X'} \ar[r] &
\mathcal{O}_{X'} \ar[r] &
\mathcal{O}_X \ar[r] & 0 \\
0 \ar[r] &
a^{-1}\mathcal{C}_{Y/Y'} \ar[r] \ar[u] &
a^{-1}\mathcal{O}_{Y'}
\ar[r] \ar@<1ex>[u]^{(a')^\sharp} \ar@<-1ex>[u]_{(b')^\sharp} &
a^{-1}\mathcal{O}_Y \ar[r] \ar[u] & 0
}
$$
Now it is a general fact that in such a situation the difference of the
$\mathcal{O}_B$-algebra maps $(a')^\sharp$ and $(b')^\sharp$ is an
$\mathcal{O}_B$-derivation from $a^{-1}\mathcal{O}_Y$ to $\mathcal{C}_{X/X'}$.
By adjointness of the functors $a^{-1}$ and $a_*$ this is the same
thing as an $\mathcal{O}_B$-derivation from
$\mathcal{O}_Y$ into $a_*\mathcal{C}_{X/X'}$. Some details omitted.
\end{proof}

\noindent
Note that in the situation of the lemma above we may write
$D$ as
\begin{equation}
\label{equation-D}
D = \text{d}_{Y/B} \circ \theta
\end{equation}
where $\theta$ is an $\mathcal{O}_Y$-linear map
$\theta : \Omega_{Y/B} \to a_*\mathcal{C}_{X/X'}$.
Of course, then by adjunction again we may view $\theta$ as an
$\mathcal{O}_X$-linear map
$\theta : a^*\Omega_{Y/B} \to \mathcal{C}_{X/X'}$.

\begin{lemma}
\label{lemma-action-by-derivations}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $(a, a') : (X \subset X') \to (Y \subset Y')$
be a morphism of first order thickenings over $B$.
Let
$$
\theta : a^*\Omega_{Y/B} \to \mathcal{C}_{X/X'}
$$
be an $\mathcal{O}_X$-linear map. Then there exists a unique morphism of pairs
$(b, b') : (X \subset X') \to (Y \subset Y')$ such that
(1) and (2) of
Lemma \ref{lemma-difference-derivation}
hold and the derivation $D$ and $\theta$ are related by
Equation (\ref{equation-D}).
\end{lemma}

\begin{proof}
Consider the map
$$
\alpha = (a')^\sharp + D : a^{-1}\mathcal{O}_{Y'} \to \mathcal{O}_{X'}
$$
where $D$ is as in Equation (\ref{equation-D}). As $D$ is an
$\mathcal{O}_B$-derivation it follows that $\alpha$ is a map of
sheaves of $\mathcal{O}_B$-algebras. By construction we have
$i_X^\sharp \circ \alpha = a^\sharp \circ i_Y^\sharp$ where
$i_X : X \to X'$ and $i_Y : Y \to Y'$ are the given closed immersions. By
Lemma \ref{lemma-first-order-thickening-maps}
we obtain a unique morphism
$(a, b') : (X  \subset X') \to (Y \subset Y')$ of thickenings
over $B$ such that $\alpha = (b')^\sharp$. Setting $b = a$
we win.
\end{proof}

\begin{lemma}
\label{lemma-sheaf}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $X \subset X'$ and $Y \subset Y'$ be first order thickenings
over $B$. Assume given a morphism $a : X \to Y$ and a map
$A : a^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{X/X'}$ of
$\mathcal{O}_X$-modules. For an object $U'$ of
$(X')_{spaces, \etale}$ with $U = X \times_{X'} U'$
consider morphisms $a' : U' \to Y'$ such that
\begin{enumerate}
\item $a'$ is a morphism over $B$,
\item $a'|_U = a|_U$, and
\item the induced map
$a^*\mathcal{C}_{Y/Y'}|_U \to \mathcal{C}_{X/X'}|_U$
is the restriction of $A$ to $U$.
\end{enumerate}
Then the rule
\begin{equation}
\label{equation-sheaf}
U' \mapsto
\{a' : U' \to Y'\text{ such that (1), (2), (3) hold.}\}
\end{equation}
defines a sheaf of sets on $(X')_{spaces, \etale}$.
\end{lemma}

\begin{proof}
Denote $\mathcal{F}$ the rule of the lemma.
The restriction mapping $\mathcal{F}(U') \to \mathcal{F}(V')$ for
$V' \subset U' \subset X'$
of $\mathcal{F}$ is really the restriction map $a' \mapsto a'|_{V'}$.
With this definition in place it is clear that $\mathcal{F}$ is a
sheaf since morphisms of algebraic spaces satisfy \'etale descent, see
Descent on Spaces,
Lemma \ref{spaces-descent-lemma-fpqc-universal-effective-epimorphisms}.
\end{proof}

\begin{lemma}
\label{lemma-action-sheaf}
Same notation and assumptions as in Lemma \ref{lemma-sheaf}.
We identify sheaves on $X$ and $X'$ via
(\ref{equation-equivalence-etale-spaces}).
There is an action of the sheaf
$$
\SheafHom_{\mathcal{O}_X}(a^*\Omega_{Y/B}, \mathcal{C}_{X/X'})
$$
on the sheaf (\ref{equation-sheaf}). Moreover, the action
is simply transitive for any object $U'$ of $(X')_{spaces, \etale}$
over which the sheaf (\ref{equation-sheaf}) has a section.
\end{lemma}

\begin{proof}
This is a combination of
Lemmas \ref{lemma-difference-derivation},
\ref{lemma-action-by-derivations},
and \ref{lemma-sheaf}.
\end{proof}

\begin{remark}
\label{remark-special-case}
A special case of
Lemmas \ref{lemma-difference-derivation},
\ref{lemma-action-by-derivations},
\ref{lemma-sheaf}, and
\ref{lemma-action-sheaf}
is where $Y = Y'$. In this case the map $A$ is always zero.
The sheaf of
Lemma \ref{lemma-sheaf}
is just given by the rule
$$
U' \mapsto
\{a' : U' \to Y\text{ over }S\text{ with } a'|_U = a|_U\}
$$
and we act on this by the sheaf
$\SheafHom_{\mathcal{O}_X}(a^*\Omega_{Y/B}, \mathcal{C}_{X/X'})$.
The action of a local section $\theta$ on $a'$ is sometimes indicated by
$\theta \cdot a'$. Note that this means nothing else than the fact
that $(a')^\sharp$ and $(\theta \cdot a')^\sharp$ differ by a derivation
$D$ which is related to $\theta$ by Equation (\ref{equation-D}).
\end{remark}











\section{Infinitesimal deformations of algebraic spaces}
\label{section-deform}

\noindent
The following simple lemma is often a convenient tool to check whether
an infinitesimal deformation of a map is flat.

\begin{lemma}
\label{lemma-deform}
Let $S$ be a scheme. Let $(f, f') : (X \subset X') \to (Y \subset Y')$ be a
morphism of first order thickenings of algebraic spaces over $S$. Assume that
$f$ is flat. Then the following are equivalent
\begin{enumerate}
\item $f'$ is flat and $X = Y \times_{Y'} X'$, and
\item the canonical map $f^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{X/X'}$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a scheme $V'$ and a surjective \'etale morphism $V' \to Y'$.
Choose a scheme $U'$ and a surjective \'etale morphism
$U' \to X' \times_{Y'} V'$. Set $U = X \times_{X'} U'$ and
$V = Y \times_{Y'} V'$. According to our definition of a flat morphism
of algebraic spaces we see that the induced map $g : U \to V$ is a flat
morphism of schemes and that $f'$ is flat if and only if the corresponding
morphism $g' : U' \to V'$ is flat. Also, $X = Y \times_{Y'} X'$ if and only
if $U = V \times_{V'} V'$. Finally, the map
$f^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{X/X'}$
is an isomorphism if and only if
$g^*\mathcal{C}_{V/V'} \to \mathcal{C}_{U/U'}$ is an isomorphism.
Hence the lemma follows from its analogue for morphisms of schemes, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-deform}.
\end{proof}












\section{Formally smooth morphisms}
\label{section-formally-smooth}

\noindent
In this section we introduce the notion of a formally smooth morphism
$X \to Y$ of algebraic spaces. Such a morphism is
characterized by the property that $T$-valued points of $X$ lift
to infinitesimal thickenings of $T$ provided $T$ is affine.
The main result is that a morphism which is formally smooth and
locally of finite presentation is smooth, see
Lemma \ref{lemma-smooth-formally-smooth}.
It turns out that this criterion is often easier to use than the
Jacobian criterion.

\begin{definition}
\label{definition-formally-smooth}
Let $S$ be a scheme. A morphism $f : X \to Y$ of algebraic spaces over $S$
is said to be {\it formally smooth} if it is formally smooth as a
transformation of functors as in
Definition \ref{definition-formally-smooth-etale-unramified}.
\end{definition}

\noindent
In the cases of formally unramified and formally \'etale morphisms
the condition that $T'$ be affine could be dropped, see
Lemmas \ref{lemma-formally-unramified-not-affine} and
\ref{lemma-formally-etale-not-affine}.
This is no longer true in the case of formally smooth morphisms.
In fact, a slightly more natural condition would be that we should be
able to fill in the dotted arrow \'etale locally on $T'$.
In fact, analyzing the proof of
Lemma \ref{lemma-smooth-formally-smooth}
shows that this would be equivalent to the definition as it currently
stands. It is also true that requiring the existence of the dotted
arrow fppf locally on $T'$ would be sufficient, but that is slightly
more difficult to prove.

\medskip\noindent
We will not restate the results proved in the more general setting of
formally smooth transformations of functors in
Section \ref{section-formally-smooth-etale-unramified}.

\begin{lemma}
\label{lemma-composition-formally-smooth}
A composition of formally smooth morphisms is formally smooth.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-smooth}
A base change of a formally smooth morphism is formally smooth.
\end{lemma}

\begin{proof}
Omitted, but see
Algebra, Lemma \ref{algebra-lemma-base-change-fs}
for the algebraic version.
\end{proof}

\begin{lemma}
\label{lemma-formally-etale-unramified-smooth}
Let $f : X \to S$ be a morphism of schemes.
Then $f$ is formally \'etale if and only if
$f$ is formally smooth and formally unramified.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Here is a helper lemma which will be superseded by
Lemma \ref{lemma-formally-smooth}.

\begin{lemma}
\label{lemma-helper-formally-smooth}
Let $S$ be a scheme. Let
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
be a commutative diagram of morphisms of algebraic spaces over $S$.
If the vertical arrows are \'etale and $f$ is formally smooth, then
$\psi$ is formally smooth.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-representable-property-formally-property}
the morphisms $U \to X$ and $V \to Y$ are formally \'etale. By
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally smooth. By
Lemma \ref{lemma-formally-permanence}
we see $\psi : U \to V$ is formally smooth.
\end{proof}

\noindent
The following lemma is the main result of this section.
It implies, combined with
Limits of Spaces, Proposition
\ref{spaces-limits-proposition-characterize-locally-finite-presentation},
that we can recognize whether a morphism of algebraic spaces
$f : X \to Y$ is smooth in terms of ``simple'' properties of the
transformation of functors $X \to Y$.

\begin{lemma}[Infinitesimal lifting criterion]
\label{lemma-smooth-formally-smooth}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is smooth.
\item The morphism $f$ is locally of finite presentation, and
formally smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f : X \to S$ is locally of finite presentation and formally smooth.
Consider a commutative diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale and
surjective. By
Lemma \ref{lemma-helper-formally-smooth}
we see $\psi : U \to V$ is formally smooth. By
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-finite-presentation-local}
the morphism $\psi$ is locally of finite presentation.
Hence by the case of schemes the morphism
$\psi$ is smooth, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-smooth-formally-smooth}.
Hence $f$ is smooth, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-smooth-local}.

\medskip\noindent
Conversely, assume that $f : X \to Y$ is smooth.
Consider a solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l]^a \\
Y & T' \ar[l] \ar@{-->}[lu]
}
$$
as in Definition \ref{definition-formally-smooth}.
We will show the dotted arrow exists thereby
proving that $f$ is formally smooth.
Let $\mathcal{F}$ be the sheaf of sets on $(T')_{spaces, \etale}$ of
Lemma \ref{lemma-sheaf},
see also
Remark \ref{remark-special-case}.
Let
$$
\mathcal{H} =
\SheafHom_{\mathcal{O}_T}(a^*\Omega_{X/Y}, \mathcal{C}_{T/T'})
$$
be the sheaf of $\mathcal{O}_T$-modules on $T_\etale$ introduced in
Lemma \ref{lemma-action-sheaf}.
The action $\mathcal{H} \times \mathcal{F} \to \mathcal{F}$
turns $\mathcal{F}$ into a pseudo $\mathcal{H}$-torsor, see
Cohomology on Sites, Definition \ref{sites-cohomology-definition-torsor}.
Our goal is to show that $\mathcal{F}$ is a trivial $\mathcal{H}$-torsor.
There are two steps: (I) To show that $\mathcal{F}$ is a torsor
we have to show that $\mathcal{F}$ has \'etale locally a
section. (II) To show that $\mathcal{F}$ is the trivial torsor
it suffices to show that $H^1(T_\etale, \mathcal{H}) = 0$, see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-torsors-h1}.

\medskip\noindent
First we prove (I). To see this choose a commutative diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale and
surjective. As $f$ is assumed smooth we see that $\psi$ is smooth and
hence formally smooth by
Lemma \ref{lemma-representable-property-formally-property}.
By the same lemma the morphism $V \to Y$ is formally \'etale. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally smooth. Then (I) follows from
Lemma \ref{lemma-etale-on-top} part (4).

\medskip\noindent
Finally we prove (II). By
Lemma \ref{lemma-finite-presentation-differentials}
we see that $\Omega_{X/S}$ is of finite presentation.
Hence $a^*\Omega_{X/S}$ is of finite presentation (see
Properties of Spaces,
Section \ref{spaces-properties-section-properties-modules}).
Hence the sheaf
$\mathcal{H} =
\SheafHom_{\mathcal{O}_T}(a^*\Omega_{X/Y}, \mathcal{C}_{T/T'})$
is quasi-coherent by
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-properties-quasi-coherent}.
Thus by
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}
and Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}
we have
$$
H^1(T_{spaces, \etale}, \mathcal{H}) =
H^1(T_\etale, \mathcal{H}) =
H^1(T, \mathcal{H}) = 0
$$
as desired.
\end{proof}

\noindent
We do a bit more work to show that being formally smooth is \'etale local
on the source. To begin we show that a formally smooth morphism has a nice
sheaf of differentials. The notion of a locally projective quasi-coherent
module is defined in
Properties of Spaces,
Section \ref{spaces-properties-section-locally-projective}.

\begin{lemma}
\label{lemma-formally-smooth-sheaf-differentials}
Let $S$ be a scheme.
Let $f : X \to Y$ be a formally smooth morphism of algebraic spaces over $S$.
Then $\Omega_{X/Y}$ is locally projective on $X$.
\end{lemma}

\begin{proof}
Choose a diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are affine(!) schemes and the vertical arrows are \'etale.
By
Lemma \ref{lemma-helper-formally-smooth}
we see $\psi : U \to V$ is formally smooth. Hence
$\Gamma(V, \mathcal{O}_V) \to \Gamma(U, \mathcal{O}_U)$ is
a formally smooth ring map, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-affine-formally-smooth}.
Hence by
Algebra, Lemma \ref{algebra-lemma-characterize-formally-smooth-again}
the $\Gamma(U, \mathcal{O}_U)$-module
$\Omega_{\Gamma(U, \mathcal{O}_U)/\Gamma(V, \mathcal{O}_V)}$
is projective. Hence $\Omega_{U/V}$ is locally projective, see
Properties, Section \ref{properties-section-locally-projective}.
Since $\Omega_{X/Y}|_U = \Omega_{U/V}$ we see that $\Omega_{X/Y}$ is
locally projective too. (Because we can find an \'etale covering of
$X$ by the affine $U$'s fitting into diagrams as above -- details
omitted.)
\end{proof}

\begin{lemma}
\label{lemma-h1-is-zero}
Let $T$ be an affine scheme.
Let $\mathcal{F}$, $\mathcal{G}$ be quasi-coherent
$\mathcal{O}_T$-modules on $T_\etale$.
Consider the internal hom sheaf
$\mathcal{H} = \SheafHom_{\mathcal{O}_T}(\mathcal{F}, \mathcal{G})$
on $T_\etale$.
If $\mathcal{F}$ is locally projective, then
$H^1(T_\etale, \mathcal{H}) = 0$.
\end{lemma}

\begin{proof}
By the definition of a locally projective sheaf on an algebraic space (see
Properties of Spaces,
Definition \ref{spaces-properties-definition-locally-projective})
we see that $\mathcal{F}_{Zar} = \mathcal{F}|_{T_{Zar}}$ is a locally
projective sheaf on the scheme $T$. Thus $\mathcal{F}_{Zar}$ is a
direct summand of a free $\mathcal{O}_{T_{Zar}}$-module. Whereupon
we conclude (as $\mathcal{F} = (\mathcal{F}_{Zar})^a$, see
Descent, Proposition \ref{descent-proposition-equivalence-quasi-coherent})
that $\mathcal{F}$ is a direct summand of a free $\mathcal{O}_T$-module
on $T_\etale$. Hence we may assume that
$\mathcal{F} = \bigoplus_{i \in I} \mathcal{O}_T$ is a free module.
In this case $\mathcal{H} = \prod_{i \in I} \mathcal{G}$ is
a product of quasi-coherent modules. By
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-cohomology-products}
we conclude that $H^1 = 0$ because the cohomology of a quasi-coherent sheaf
on an affine scheme is zero, see
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}
and Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over
$S$. The following are equivalent:
\begin{enumerate}
\item $f$ is formally smooth,
\item for every diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale
the morphism of schemes $\psi$ is formally smooth (as in
More on Morphisms,
Definition \ref{more-morphisms-definition-formally-unramified}), and
\item for one such diagram with surjective vertical arrows the morphism
$\psi$ is formally smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
We have seen that (1) implies (2) and (3) in
Lemma \ref{lemma-helper-formally-smooth}.
Assume (3).
The proof that $f$ is formally smooth is entirely similar to
the proof of (1) $\Rightarrow$ (2) of
Lemma \ref{lemma-smooth-formally-smooth}.

\medskip\noindent
Consider a solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l]^a \\
Y & T' \ar[l] \ar@{-->}[lu]
}
$$
as in Definition \ref{definition-formally-smooth}.
We will show the dotted arrow exists thereby
proving that $f$ is formally smooth.
Let $\mathcal{F}$ be the sheaf of sets on $(T')_{spaces, \etale}$ of
Lemma \ref{lemma-sheaf},
see also
Remark \ref{remark-special-case}.
Let
$$
\mathcal{H} =
\SheafHom_{\mathcal{O}_T}(a^*\Omega_{X/Y}, \mathcal{C}_{T/T'})
$$
be the sheaf of $\mathcal{O}_T$-modules on $T_\etale$ introduced in
Lemma \ref{lemma-action-sheaf}.
The action $\mathcal{H} \times \mathcal{F} \to \mathcal{F}$
turns $\mathcal{F}$ into a pseudo $\mathcal{H}$-torsor, see
Cohomology on Sites, Definition \ref{sites-cohomology-definition-torsor}.
Our goal is to show that $\mathcal{F}$ is a trivial $\mathcal{H}$-torsor.
There are two steps: (I) To show that $\mathcal{F}$ is a torsor
we have to show that $\mathcal{F}$ has \'etale locally a
section. (II) To show that $\mathcal{F}$ is the trivial torsor
it suffices to show that $H^1(T_\etale, \mathcal{H}) = 0$, see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-torsors-h1}.

\medskip\noindent
First we prove (I). To see this consider a diagram
(which exists because we are assuming (3))
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes, the vertical arrows are \'etale and
surjective, and $\psi$ is formally smooth. By
Lemma \ref{lemma-representable-property-formally-property}
the morphism $V \to Y$ is formally \'etale. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally smooth. Then (I) follows from
Lemma \ref{lemma-etale-on-top} part (4).

\medskip\noindent
Finally we prove (II). By
Lemma \ref{lemma-formally-smooth-sheaf-differentials}
we see that $\Omega_{U/V}$ locally projective.
Hence $\Omega_{X/Y}$ is locally projective, see
Descent on Spaces,
Lemma \ref{spaces-descent-lemma-locally-projective-descends}.
Hence $a^*\Omega_{X/Y}$ is locally projective, see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-locally-projective-pullback}.
Hence
$$
H^1(T_\etale, \mathcal{H}) =
H^1(T_\etale,
\SheafHom_{\mathcal{O}_T}(a^*\Omega_{X/Y}, \mathcal{C}_{T/T'}) = 0
$$
by
Lemma \ref{lemma-h1-is-zero}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-descending-property-formally-smooth}
The property $\mathcal{P}(f) =$``$f$ is formally smooth''
is fpqc local on the base.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ be a morphism of algebraic spaces over a scheme $S$.
Choose an index set $I$ and diagrams
$$
\xymatrix{
U_i \ar[d] \ar[r]_{\psi_i} & V_i \ar[d] \\
X \ar[r]^f & Y
}
$$
with \'etale vertical arrows and $U_i$, $V_i$ affine schemes. Moreover,
assume that $\coprod U_i \to X$ and $\coprod V_i \to Y$ are surjective, see
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-cover-by-union-affines}.
By
Lemma \ref{lemma-formally-smooth}
we see that $f$ is formally smooth if and only if each of the morphisms
$\psi_i$ are formally smooth. Hence we reduce to the case of a morphism
of affine schemes. In this case the result follows from
Algebra, Lemma \ref{algebra-lemma-descent-formally-smooth}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-triangle-differentials-formally-smooth}
Let $S$ be a scheme.
Let $f : X \to Y$, $g : Y \to Z$ be morphisms of algebraic spaces over $S$.
Assume $f$ is formally smooth. Then
$$
0 \to f^*\Omega_{Y/Z} \to \Omega_{X/Z} \to \Omega_{X/Z} \to 0
$$
Lemma \ref{lemma-triangle-differentials}
is short exact.
\end{lemma}

\begin{proof}
Follows from the case of schemes, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-triangle-differentials-formally-smooth},
by \'etale localization, see
Lemmas \ref{lemma-formally-smooth} and \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-formally-unramified-formally-smooth}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $h : Z \to X$ be a formally unramified morphism of algebraic spaces
over $B$.
Assume that $Z$ is formally smooth over $B$. Then the
canonical exact sequence
$$
0 \to \mathcal{C}_{Z/X} \to i^*\Omega_{X/B} \to \Omega_{Z/B} \to 0
$$
of
Lemma \ref{lemma-universally-unramified-differentials-sequence}
is short exact.
\end{lemma}

\begin{proof}
Let $Z \to Z'$ be the universal first order thickening of $Z$ over $X$.
From the proof of
Lemma \ref{lemma-universally-unramified-differentials-sequence}
we see that our sequence is identified with the sequence
$$
\mathcal{C}_{Z/Z'} \to \Omega_{Z'/B} \otimes \mathcal{O}_Z \to
\Omega_{Z/B} \to 0.
$$
Since $Z \to S$ is formally smooth we can \'etale locally on $Z'$ find
a left inverse $Z' \to Z$ over $B$ to the inclusion map $Z \to Z'$.
Thus the sequence is \'etale locally split, see
Lemma \ref{lemma-differentials-relative-immersion-section}.
\end{proof}

\begin{lemma}
\label{lemma-two-unramified-morphisms-formally-smooth}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_i \ar[rd]_j & X \ar[d]^f \\
& Y
}
$$
be a commutative diagram of algebraic spaces over $S$
where $i$ and $j$ are formally unramified and $f$ is formally smooth.
Then the canonical exact sequence
$$
0 \to
\mathcal{C}_{Z/Y} \to
\mathcal{C}_{Z/X} \to
i^*\Omega_{X/Y} \to 0
$$
of
Lemma \ref{lemma-two-unramified-morphisms}
is exact and locally split.
\end{lemma}

\begin{proof}
Denote $Z \to Z'$ the universal first order thickening of $Z$ over $X$.
Denote $Z \to Z''$ the universal first order thickening of $Z$ over $Y$.
By
Lemma \ref{lemma-universally-unramified-differentials-sequence}
here is a canonical morphism $Z' \to Z''$ so that we have a commutative
diagram
$$
\xymatrix{
Z \ar[r]_{i'} \ar[rd]_{j'} & Z' \ar[r]_a \ar[d]^k & X \ar[d]^f \\
& Z'' \ar[r]^b & Y
}
$$
The sequence above is identified with the sequence
$$
\mathcal{C}_{Z/Z''} \to
\mathcal{C}_{Z/Z'} \to
(i')^*\Omega_{Z'/Z''} \to 0
$$
via our definitions concerning conormal sheaves of formally unramified
morphisms. Let $U'' \to Z''$ be an \'etale morphism with $U''$ affine.
Denote $U \to Z$ and $U' \to Z'$ the corresponding affine
schemes \'etale over $Z$ and $Z'$.
As $f$ is formally smooth there exists a morphism $h : U'' \to X$
which agrees with $i$ on $U$ and such that $f \circ h$ equals $b|_{U''}$.
Since $Z'$ is the universal first order thickening we obtain a unique
morphism $g : U'' \to Z'$ such that $g = a \circ h$. The universal
property of $Z''$ implies that $k \circ g$ is the inclusion map
$U'' \to Z''$. Hence $g$ is a left inverse to $k$. Picture
$$
\xymatrix{
U \ar[d] \ar[r] & Z' \ar[d]^k \\
U'' \ar[r] \ar[ru]^g & Z''
}
$$
Thus $g$ induces a map $\mathcal{C}_{Z/Z'}|_U \to \mathcal{C}_{Z/Z''}|_U$
which is a left inverse to the map
$\mathcal{C}_{Z/Z''} \to \mathcal{C}_{Z/Z'}$ over $U$.
\end{proof}











\section{Smoothness over a Noetherian base}
\label{section-smooth-Noetherian}

\noindent
This section is the analogue of
More on Morphisms, Section \ref{more-morphisms-section-smooth-Noetherian}.

\begin{lemma}
\label{lemma-lifting-along-artinian-at-point}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Let $x \in |X|$.
Assume that $Y$ is locally Noetherian and $f$ locally of finite type.
The following are equivalent:
\begin{enumerate}
\item $f$ is smooth at $x$,
\item for every solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & \Spec(B) \ar[d]^i \ar[l]^-\alpha \\
Y & \Spec(B') \ar[l]_-{\beta} \ar@{-->}[lu]
}
$$
where $B' \to B$ is a surjection of local rings with
$\Ker(B' \to B)$ of square zero, and $\alpha$ mapping the
closed point of $\Spec(B)$ to $x$ there exists
a dotted arrow making the diagram commute, and
\item same as in (2) but with $B' \to B$ ranging over small
extensions (see Algebra, Definition \ref{algebra-definition-small-extension}).
\end{enumerate}
\end{lemma}

\begin{proof}
Condition (1) means there is an open subspace $X' \subset X$
such that $X' \to Y$ is smooth. Hence (1) implies conditions (2) and (3) by
Lemma \ref{lemma-smooth-formally-smooth}. Condition (2) implies
condition (3) trivially. Assume (3). Choose a commutative diagram
$$
\xymatrix{
X \ar[d] & U \ar[l] \ar[d] \\
Y & V \ar[l]
}
$$
with $U$ and $V$ affine, horizontal arrows \'etale and
such that there is a point $u \in U$ mapping to $x$. Next, consider
a diagram
$$
\xymatrix{
X \ar[d] & U \ar[l] \ar[d] & \Spec(B) \ar[d]^i \ar[l]^-\alpha  \\
Y & V \ar[l] & \Spec(B') \ar[l]_-{\beta}
}
$$
as in (3) but for $u \in U \to V$. Let $\gamma : \Spec(B') \to X$
be the arrow we get from our assumption that (3) holds for $X$.
Because $U \to X$ is \'etale and
hence formally \'etale (Lemma \ref{lemma-etale-formally-etale})
the morphism $\gamma$
has a unique lift to $U$ compatible with $\alpha$. Then because
$V \to Y$ is \'etale hence formally \'etale this lift is compatible
with $\beta$. Hence (3) holds for $u \in U \to V$ and we conclude
that $U \to V$ is smooth at $u$ by
More on Morphisms, Lemma
\ref{more-morphisms-lemma-lifting-along-artinian-at-point}.
This proves that $X \to Y$ is smooth at $x$, thereby
finishing the proof.
\end{proof}

\noindent
Sometimes it is useful to know that one only needs to check the
lifting criterion for small extensions ``centered'' at points
of finite type (see
Morphisms of Spaces, Section \ref{spaces-morphisms-section-points-finite-type}).

\begin{lemma}
\label{lemma-lifting-along-artinian}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Assume $Y$ is locally Noetherian and $f$ locally of finite type.
The following are equivalent:
\begin{enumerate}
\item $f$ is smooth,
\item for every solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & \Spec(B) \ar[d]^i \ar[l]^-\alpha \\
Y & \Spec(B') \ar[l]_-{\beta} \ar@{-->}[lu]
}
$$
where $B' \to B$ is a small extension of Artinian local rings
and $\beta$ of finite type (!) there exists a dotted arrow making
the diagram commute.
\end{enumerate}
\end{lemma}

\begin{proof}
If $f$ is smooth, then the infinitesimal lifting criterion
(Lemma \ref{lemma-smooth-formally-smooth}) says
$f$ is formally smooth and (2) holds.

\medskip\noindent
Assume $f$ is not smooth. The set of points $x \in X$ where $f$ is not smooth
forms a closed subset $T$ of $|X|$. By
Morphisms of Spaces, Lemma 
\ref{spaces-morphisms-lemma-enough-finite-type-points}, there exists
a point $x \in T \subset X$ with $x \in X_{\text{ft-pts}}$. Choose a
commutative diagram
$$
\xymatrix{
X \ar[d] & U \ar[l] \ar[d] & u \ar@{|->}[d] \\
Y & V \ar[l] & v
}
$$
with $U$ and $V$ affine, horizontal arrows \'etale and
such that there is a point $u \in U$ mapping to $x$. Then $u$
is a finite type point of $U$. Since $U \to V$ is not smooth at
the point $u$, by
More on Morphisms,
Lemma \ref{more-morphisms-lemma-lifting-along-artinian-at-point}
there is a diagram
$$
\xymatrix{
X \ar[d] & U \ar[l] \ar[d] & \Spec(B) \ar[d]^i \ar[l]^-\alpha  \\
Y & V \ar[l] & \Spec(B') \ar[l]_-{\beta} \ar@{-->}[lu]
}
$$
with $B' \to B$ a small extension of (Artinian) local rings
such that the residue field of $B$ is equal to $\kappa(v)$ and such
that the dotted arrow does not exist. Since $U \to V$ is
of finite type, we see that $v$ is a finite type point of $V$. By
Morphisms, Lemma \ref{morphisms-lemma-artinian-finite-type}
the morphism $\beta$ is of finite type, hence the composition
$\Spec(B) \to Y$ is of finite type also.
Arguing exactly as in the proof of
Lemma \ref{lemma-lifting-along-artinian-at-point}
(using that $U \to X$ and $V \to Y$ are \'etale hence
formally \'etale)
we see that there cannot be an arrow $\Spec(B) \to X$
fitting into the outer rectangle of the last displayed diagram.
In other words, (2) doesn't hold and the proof is complete.
\end{proof}

\noindent
Here is a useful application.

\begin{lemma}
\label{lemma-check-smoothness-on-infinitesimal-nbhds}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of
algebraic spaces over $S$. Assume $f$ is
locally of finite type and $Y$ locally Noetherian.
Let $Z \subset Y$ be a closed subspace with $n$th infinitesimal
neighbourhood $Z_n \subset Y$. Set $X_n = Z_n \times_Y X$.
\begin{enumerate}
\item If $X_n \to Z_n$ is smooth for all $n$, then $f$
is smooth at every point of $f^{-1}(Z)$.
\item If $X_n \to Z_n$ is \'etale for all $n$, then $f$
is \'etale at every point of $f^{-1}(Z)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $X_n \to Z_n$ is smooth for all $n$.
Let $x \in X$ be a point lying over a point of $Z$.
Given a small extension $B' \to B$ and morphisms $\alpha$, $\beta$ as in
Lemma \ref{lemma-lifting-along-artinian-at-point} part (3)
the maximal ideal of $B'$ is nilpotent (as $B'$ is Artinian)
and hence the morphism $\beta$ factors through $Z_n$ and $\alpha$ factors
through $X_n$ for a suitable $n$. Thus the lifting property for
$X_n \to Z_n$ kicks in to get the desired dotted arrow in the diagram.
This proves (1). Part (2) follows from (1) and the fact that a morphism
is \'etale if and only if it is smooth of relative dimension $0$.
\end{proof}









\section{Openness of the flat locus}
\label{section-open-flat}

\noindent
This section is analogue of
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.
Note that we have defined the notion of flatness for quasi-coherent
modules on algebraic spaces in
Morphisms of Spaces, Section \ref{spaces-morphisms-section-flat-modules}.

\begin{theorem}
\label{theorem-openness-flatness}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Assume $f$ is locally of finite presentation and that
$\mathcal{F}$ is an $\mathcal{O}_X$-module which is
locally of finite presentation. Then
$$
\{x \in |X| : \mathcal{F}\text{ is flat over }Y\text{ at }x\}
$$
is open in $|X|$.
\end{theorem}

\begin{proof}
Choose a commutative diagram
$$
\xymatrix{
U \ar[d]_p \ar[r]_\alpha &
V \ar[d]^q \\
X \ar[r]^a & Y
}
$$
with $U$, $V$ schemes and $p$, $q$ surjective and \'etale as in
Spaces, Lemma \ref{spaces-lemma-lift-morphism-presentations}.
By
More on Morphisms, Theorem \ref{more-morphisms-theorem-openness-flatness}
the set
$U' = \{u \in |U| : p^*\mathcal{F}\text{ is flat over }V\text{ at }u\}$
is open in $U$. By
Morphisms of Spaces, Definition \ref{spaces-morphisms-definition-flat-module}
the image of $U'$ in $|X|$ is the set
of the theorem. Hence we are done because the map $|U| \to |X|$ is
open, see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-topology-points}.
\end{proof}

\begin{lemma}
\label{lemma-flat-locus-base-change}
Let $S$ be a scheme. Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
be a cartesian diagram of algebraic spaces over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume $g$ is flat, $f$ is locally of finite presentation,
and $\mathcal{F}$ is locally of finite presentation.
Then
$$
\{x' \in |X'| : (g')^*\mathcal{F}\text{ is flat over }Y'\text{ at }x'\}
$$
is the inverse image of the open subset of
Theorem \ref{theorem-openness-flatness}
under the continuous map $|g'| : |X'| \to |X|$.
\end{lemma}

\begin{proof}
This follows from
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-base-change-module-flat}.
\end{proof}












\section{Crit\`ere de platitude par fibres}
\label{section-criterion-flat-fibres}

\noindent
Let $S$ be a scheme. Consider a commutative diagram of algebraic spaces
over $S$
$$
\xymatrix{
X \ar[rr]_f \ar[dr]_g & & Y \ar[dl]^h \\
& Z
}
$$
and a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$.
Given a point $x \in |X|$ we consider the question as to whether
$\mathcal{F}$ is flat over $Y$ at $x$. If $\mathcal{F}$ is flat
over $Z$ at $x$, then the theorem below states this question is
intimately related to the question of whether the restriction of
$\mathcal{F}$ to the fibre of $X \to Z$ over $g(x)$
is flat over the fibre of $Y \to Z$ over $g(x)$. To make sense
out of this we offer the following preliminary lemma.

\begin{lemma}
\label{lemma-flat-on-fibres-at-point}
In the situation above the following are equivalent
\begin{enumerate}
\item Pick a geometric point $\overline{x}$ of $X$ lying over $x$.
Set $\overline{y} = f \circ \overline{x}$ and
$\overline{z} = g \circ \overline{x}$. Then the module
$\mathcal{F}_{\overline{x}}/
\mathfrak m_{\overline{z}}\mathcal{F}_{\overline{x}}$
is flat over
$\mathcal{O}_{Y, \overline{y}}/
\mathfrak m_{\overline{z}}\mathcal{O}_{Y, \overline{y}}$.
\item Pick a morphism $x : \Spec(K) \to X$ in the equivalence class of
$x$. Set $z = g \circ x$, $X_z = \Spec(K) \times_{z, Z} X$,
$Y_z = \Spec(K) \times_{z, Z} Y$, and $\mathcal{F}_z$ the pullback
of $\mathcal{F}$ to $X_z$. Then $\mathcal{F}_z$ is flat at $x$ over
$Y_z$ (as defined in Morphisms of Spaces,
Definition \ref{spaces-morphisms-definition-flat-module}).
\item Pick a commutative diagram
$$
\xymatrix{
& & & U \ar[llld]_a \ar[rr] \ar[dr] & & V \ar[llld]_>>>>>>>b \ar[dl] \\
X \ar[rr]_f \ar[dr]_g & & Y \ar[dl]^h &  & W \ar[llld]_c \\
& Z
}
$$
where $U, V, W$ are schemes, and $a, b, c$ are \'etale,
and a point $u \in U$ mapping to $x$. Let $w \in W$ be the image of
$u$. Let $\mathcal{F}_w$ be the pullback of $\mathcal{F}$ to
the fibre $U_w$ of $U \to W$ at $w$. Then $\mathcal{F}_w$
is flat over $V_w$ at $u$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that in (2) the morphism $x : \Spec(K) \to X$ defines a
$K$-rational point of $X_z$, hence the statement makes sense. Moreover,
the condition in (2) is independent of the choice of $\Spec(K) \to X$
in the equivalence class of $x$ (details omitted; this will also follow
from the arguments below because the other conditions do not depend
on this choice). Also note that we can always choose a diagram as in
(3) by: first choosing
a scheme $W$ and a surjective \'etale morphism $W \to Z$, then choosing
a scheme $V$ and a surjective \'etale morphism $V \to W \times_Z Y$, and
finally choosing a scheme $U$ and a surjective \'etale morphism
$U \to V \times_Y X$. Having made these choices we set $U \to W$ equal
to the composition $U \to V \to W$ and we can pick a point $u \in U$ mapping
to $x$ because the morphism $U \to X$ is surjective.

\medskip\noindent
Suppose given both a diagram as in (3) and a geometric point
$\overline{x} : \Spec(k) \to X$ as in (1). By
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-geometric-lift-to-usual}
we can choose a geometric point $\overline{u} : \Spec(k) \to U$
lying over $u$ such that $\overline{x} = a \circ \overline{u}$.
Denote $\overline{v} : \Spec(k) \to V$ and
$\overline{w} : \Spec(k) \to W$ the induced geometric points of
$V$ and $W$. In this setting we know that
$\mathcal{O}_{X, \overline{x}} = \mathcal{O}_{U, u}^{sh}$
and similarly for $Y$ and $Z$, see
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-describe-etale-local-ring}.
In the same vein we have
$$
\mathcal{F}_{\overline{x}} =
(a^*\mathcal{F})_u \otimes_{\mathcal{O}_{U, u}}
\mathcal{O}_{U, u}^{sh}
$$
see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-stalk-quasi-coherent}.
Note that the stalk of $\mathcal{F}_w$ at $u$ is given by
$$
(\mathcal{F}_w)_u = (a^*\mathcal{F})_u/\mathfrak m_w(a^*\mathcal{F})_u
$$
and the local ring of $V_w$ at $v$ is given by
$$
\mathcal{O}_{V_w, v} = \mathcal{O}_{V, v}/\mathfrak m_w\mathcal{O}_{V, v}.
$$
Since $\mathfrak m_{\overline{z}} =
\mathfrak m_w \mathcal{O}_{Z, \overline{z}} =
\mathfrak m_w \mathcal{O}_{W, w}^{sh}$
we see that
\begin{align*}
\mathcal{F}_{\overline{x}}/
\mathfrak m_{\overline{z}}\mathcal{F}_{\overline{x}} & =
(a^*\mathcal{F})_u \otimes_{\mathcal{O}_{U, u}}
\mathcal{O}_{X, \overline{x}}/
\mathfrak m_{\overline{z}}\mathcal{O}_{X, \overline{x}} \\
& =
(\mathcal{F}_w)_u \otimes_{\mathcal{O}_{U_w, u}}
\mathcal{O}_{U, u}^{sh}/\mathfrak m_w\mathcal{O}_{U, u}^{sh} \\
& = (\mathcal{F}_w)_u \otimes_{\mathcal{O}_{U_w, u}}
\mathcal{O}_{U_w, \overline{u}}^{sh} \\
& = (\mathcal{F}_w)_{\overline{u}}
\end{align*}
the penultimate equality by
Algebra, Lemma \ref{algebra-lemma-quotient-strict-henselization}
and the last equality by
Properties of Spaces, Lemma \ref{spaces-properties-lemma-stalk-quasi-coherent}.
The same arguments applied to the structure sheaves of $V$ and $Y$
show that
$$
\mathcal{O}_{V_w, \overline{v}}^{sh} =
\mathcal{O}_{V, v}^{sh}/\mathfrak m_w \mathcal{O}_{V, v}^{sh} =
\mathcal{O}_{Y, \overline{y}}/
\mathfrak m_{\overline{z}}\mathcal{O}_{Y, \overline{y}}.
$$
OK, and now we can use
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-at-point}
to see that (1) is equivalent to (3).

\medskip\noindent
Finally we prove the equivalence of (2) and (3).
To do this we pick a field extension $\tilde K$ of $K$ and
and a morphism $\tilde x : \Spec(\tilde K) \to U$ which
lies over $u$ (this is possible because $u \times_{X, x} \Spec(K)$
is a nonempty scheme). Set $\tilde z : \Spec(\tilde K) \to U \to W$
be the composition. We obtain a commutative diagram
$$
\xymatrix{
& & & U_w \times_w \tilde z \ar[llld]_a \ar[rr] \ar[dr] & &
V_w \times_w \tilde z \ar[llld]_>>>>>>>b \ar[dl] \\
X_z \ar[rr]_f \ar[dr]_g & & Y_z \ar[dl]^h &  & \tilde z \ar[llld]_c \\
& z
}
$$
where $z = \Spec(K)$ and $w = \Spec(\kappa(w))$. Now it
is clear that $\mathcal{F}_w$ and $\mathcal{F}_z$ pull back to the
same module on $U_w \times_w \tilde z$. This leads to a commutative
diagram
$$
\xymatrix{
X_z \ar[d] & U_w \times_w \tilde z \ar[l] \ar[d] \ar[r] & U_w \ar[d] \\
Y_z & V_w \times_w \tilde z \ar[l] \ar[r] & V_w
}
$$
both of whose squares are cartesian and whose bottom horizontal
arrows are flat: the lower left horizontal arrow is the composition
of the morphism $Y \times_Z \tilde z \to Y \times_Z z = Y_z$ (base change
of a flat morphism), the \'etale morphism
$V \times_Z \tilde z \to Y \times_Z \tilde z$, and
the \'etale morphism $V \times_W \tilde z \to V \times_Z \tilde z$.
Thus it follows from
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-base-change-module-flat}
that
$$
\mathcal{F}_z\text{ flat at }x\text{ over }Y_z
\Leftrightarrow
\mathcal{F}|_{U_w \times_w \tilde z}
\text{ flat at }\tilde x\text{ over }V_w \times_w \tilde z
\Leftrightarrow
\mathcal{F}_w\text{ flat at }u\text{ over }V_w
$$
and we win.
\end{proof}

\begin{definition}
\label{definition-module-flat-on-fibre}
Let $S$ be a scheme. Let $X \to Y \to Z$ be morphisms of algebraic
spaces over $S$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in |X|$ be a point and denote $z \in |Z|$ its image.
\begin{enumerate}
\item We say {\it the restriction of $\mathcal{F}$ to its fibre over $z$
is flat at $x$ over the fibre of $Y$ over $z$} if the equivalent conditions of
Lemma \ref{lemma-flat-on-fibres-at-point}
are satisfied.
\item We say {\it the fibre of $X$ over $z$ is flat at $x$ over the fibre of
$Y$ over $z$} if the equivalent conditions of
Lemma \ref{lemma-flat-on-fibres-at-point}
hold with $\mathcal{F} = \mathcal{O}_X$.
\item We say {\it the fibre of $X$ over $z$ is flat over the fibre of $Y$
over $z$} if for all $x \in |X|$ lying over $z$ the fibre of $X$ over $z$
is flat at $x$ over the fibre of $Y$ over $z$
\end{enumerate}
\end{definition}

\noindent
With this definition in hand we can state a version of the criterion as
follows. The Noetherian version can be found in
Section \ref{section-flat-over-Noetherian}.

\begin{theorem}
\label{theorem-criterion-flatness-fibre}
Let $S$ be a scheme.
Let $f : X \to Y$ and $Y \to Z$ be morphisms of algebraic spaces over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $Z$,
\item $\mathcal{F}$ an $\mathcal{O}_X$-module of finite presentation, and
\item $Y$ is locally of finite type over $Z$.
\end{enumerate}
Let $x \in |X|$ and let $y \in |Y|$ and $z \in |Z|$ be the images of
$x$. If $\mathcal{F}_{\overline{x}} \not = 0$, then the following are
equivalent:
\begin{enumerate}
\item $\mathcal{F}$ is flat over $Z$ at $x$ and
the restriction of $\mathcal{F}$ to its fibre over $z$
is flat at $x$ over the fibre of $Y$ over $z$, and
\item $Y$ is flat over $Z$ at $y$ and $\mathcal{F}$ is
flat over $Y$ at $x$.
\end{enumerate}
Moreover, the set of points $x$ where (1) and (2) hold is open in
$\text{Supp}(\mathcal{F})$.
\end{theorem}

\begin{proof}
Choose a diagram as in
Lemma \ref{lemma-flat-on-fibres-at-point} part (3).
It follows from the definitions that this reduces to the
corresponding theorem for the morphisms of schemes
$U \to V \to W$, the quasi-coherent sheaf $a^*\mathcal{F}$,
and the point $u \in U$. Thus the theorem follows from the
corresponding result for schemes which is
More on Morphisms,
Theorem \ref{more-morphisms-theorem-criterion-flatness-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-morphism-between-flat}
Let $S$ be a scheme.
Let $f : X \to Y$ and $Y \to Z$ be a morphism of algebraic spaces over $S$.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $Z$,
\item $X$ is flat over $Z$,
\item for every $z \in |Z|$ the fibre of $X$ over $z$
is flat over the fibre of $Y$ over $z$, and
\item $Y$ is locally of finite type over $Z$.
\end{enumerate}
Then $f$ is flat. If $f$ is also surjective, then $Y$ is flat over $Z$.
\end{lemma}

\begin{proof}
This is a special case of
Theorem \ref{theorem-criterion-flatness-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-criterion-flatness-fibre}
Let $S$ be a scheme. Let $f : X \to Y$ and $Y \to Z$ be morphisms of
algebraic spaces over $S$. Let $\mathcal{F}$ be a quasi-coherent
$\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $Z$,
\item $\mathcal{F}$ an $\mathcal{O}_X$-module of finite presentation,
\item $\mathcal{F}$ is flat over $Z$, and
\item $Y$ is locally of finite type over $Z$.
\end{enumerate}
Then the set
$$
A = \{x \in |X| : \mathcal{F} \text{ flat at }x \text{ over }Y\}.
$$
is open in $|X|$ and its formation commutes with arbitrary base change:
If $Z' \to Z$ is a morphism of algebraic spaces, and $A'$ is the set of
points of $X' = X \times_Z Z'$ where $\mathcal{F}' = \mathcal{F} \times_Z Z'$
is flat over $Y' = Y \times_Z Z'$, then $A'$ is the inverse image of
$A$ under the continuous map $|X'| \to |X|$.
\end{lemma}

\begin{proof}
One way to prove this is to translate the proof as given in
More on Morphisms, Lemma \ref{more-morphisms-lemma-morphism-between-flat}
into the category of algebraic spaces. Instead we will prove this
by reducing to the case of schemes. Namely, choose a diagram as in
Lemma \ref{lemma-flat-on-fibres-at-point} part (3)
such that $a$, $b$, and $c$ are surjective.
It follows from the definitions that this reduces to the
corresponding theorem for the morphisms of schemes
$U \to V \to W$, the quasi-coherent sheaf $a^*\mathcal{F}$,
and the point $u \in U$. The only minor point to make is that
given a morphism of algebraic spaces $Z' \to Z$ we choose a scheme
$W'$ and a surjective \'etale morphism $W' \to W \times_Z Z'$.
Then we set $U' = W' \times_W U$ and $V' = W' \times_W V$.
We write $a', b', c'$ for the morphisms from $U', V', W'$ to
$X', Y', Z'$. In this case $A$, resp.\ $A'$ are images of the open
subsets of $U$, resp.\ $U'$ associated to
$a^*\mathcal{F}$, resp.\ $(a')^*\mathcal{F}'$.
This indeed does reduce the lemma to
More on Morphisms, Lemma \ref{more-morphisms-lemma-morphism-between-flat}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-flatness-fibres}
Let $S$ be a scheme.
Let $f : X \to Y$ and $Y \to Z$ be a morphism of algebraic spaces over $S$.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $Z$,
\item $X$ is flat over $Z$, and
\item $Y$ is locally of finite type over $Z$.
\end{enumerate}
Then the set
$$
\{x \in |X| : X\text{ flat at }x \text{ over }Y\}.
$$
is open in $|X|$ and its formation commutes with arbitrary base change
$Z' \to Z$.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-base-change-criterion-flatness-fibre}.
\end{proof}






\section{Flatness over a Noetherian base}
\label{section-flat-over-Noetherian}

\noindent
Here is the ``Crit\`ere de platitude par fibres'' in the Noetherian case.

\begin{theorem}
\label{theorem-criterion-flatness-fibre-Noetherian}
Let $S$ be a scheme.
Let $f : X \to Y$ and $Y \to Z$ be morphisms of algebraic spaces over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X$, $Y$, $Z$ locally Noetherian, and
\item $\mathcal{F}$ a coherent $\mathcal{O}_X$-module.
\end{enumerate}
Let $x \in |X|$ and let $y \in |Y|$ and $z \in |Z|$ be the images of
$x$. If $\mathcal{F}_{\overline{x}} \not = 0$, then the following are
equivalent:
\begin{enumerate}
\item $\mathcal{F}$ is flat over $Z$ at $x$ and
the restriction of $\mathcal{F}$ to its fibre over $z$
is flat at $x$ over the fibre of $Y$ over $z$, and
\item $Y$ is flat over $Z$ at $y$ and $\mathcal{F}$ is
flat over $Y$ at $x$.
\end{enumerate}
\end{theorem}

\begin{proof}
Choose a diagram as in
Lemma \ref{lemma-flat-on-fibres-at-point} part (3).
It follows from the definitions that this reduces to the
corresponding theorem for the morphisms of schemes
$U \to V \to W$, the quasi-coherent sheaf $a^*\mathcal{F}$,
and the point $u \in U$. Thus the theorem follows from the
corresponding result for schemes which is
More on Morphisms,
Theorem \ref{more-morphisms-theorem-criterion-flatness-fibre-Noetherian}.
\end{proof}

\begin{lemma}
\label{lemma-morphism-between-flat-Noetherian}
Let $S$ be a scheme.
Let $f : X \to Y$ and $Y \to Z$ be a morphism of algebraic spaces over $S$.
Assume
\begin{enumerate}
\item $X$, $Y$, $Z$ locally Noetherian,
\item $X$ is flat over $Z$,
\item for every $z \in |Z|$ the fibre of $X$ over $z$
is flat over the fibre of $Y$ over $z$.
\end{enumerate}
Then $f$ is flat. If $f$ is also surjective, then $Y$ is flat over $Z$.
\end{lemma}

\begin{proof}
This is a special case of
Theorem \ref{theorem-criterion-flatness-fibre-Noetherian}.
\end{proof}

\noindent
Just like for checking smoothness, if the base is Noetherian it suffices
to check flatness over Artinian rings. Here is a sample statement.

\begin{lemma}
\label{lemma-flatness-over-Noetherian-ring}
Let $A$ be a Noetherian ring. Let $I \subset A$ be an ideal.
Let $X$ be an algebraic space locally of finite presentation over
$S = \Spec(A)$. For $n \geq 1$ set $S_n = \Spec(A/I^n)$ and
$X_n = S_n \times_S X$. Let $\mathcal{F}$ be coherent $\mathcal{O}_X$-module.
If for every $n \geq 1$ the pullback $\mathcal{F}_n$ of $\mathcal{F}$ to $X$
is flat over $S_n$, then the (open) locus where $\mathcal{F}$
is flat over $X$ contains the inverse image of $V(I)$ under $X \to S$.
\end{lemma}

\begin{proof}
The locus where $\mathcal{F}$ is flat over $S$ is open in $|X|$ by
Theorem \ref{theorem-openness-flatness}.
The statement is insensitive to replacing $X$ by the members of an
\'etale covering, hence we may assume $X$ is an affine scheme.
In this case the result follows immediately from
Algebra, Lemma \ref{algebra-lemma-flat-module-powers}.
Some details omitted.
\end{proof}







\section{Normalization revisited}
\label{section-normalization}

\noindent
Normalization commutes with smooth base change.

\begin{lemma}
\label{lemma-integral-closure-smooth-pullback}
Let $S$ be a scheme. Let $f : Y \to X$ be a smooth morphism of
algebraic spaces over $S$. Let $\mathcal{A}$ be a quasi-coherent
sheaf of $\mathcal{O}_X$-algebras. The integral closure
of $\mathcal{O}_Y$ in $f^*\mathcal{A}$ is equal to $f^*\mathcal{A}'$
where $\mathcal{A}' \subset \mathcal{A}$ is the integral closure of
$\mathcal{O}_X$ in $\mathcal{A}$.
\end{lemma}

\begin{proof}
By our construction of the integral closure, see
Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-integral-closure},
this reduces immediately to the case where $X$ and $Y$ are affine.
In this case the result is
Algebra, Lemma \ref{algebra-lemma-integral-closure-commutes-smooth}.
\end{proof}

\begin{lemma}[Normalization commutes with smooth base change]
\label{lemma-normalization-smooth-localization}
Let $S$ be a scheme. Let
$$
\xymatrix{
Y_2 \ar[r] \ar[d] & Y_1 \ar[d]^f \\
X_2 \ar[r]^\varphi & X_1
}
$$
be a fibre square of algebraic spaces over $S$. Assume $f$ is quasi-compact
and quasi-separated and $\varphi$ is smooth.
Let $Y_i \to X_i' \to X_i$ be the normalization of $X_i$ in $Y_i$.
Then $X_2' \cong X_2 \times_{X_1} X_1'$.
\end{lemma}

\begin{proof}
The base change of the factorization $Y_1 \to X_1' \to X_1$ to $X_2$
is a factorization $Y_2 \to X_2 \times_{X_1} X_1' \to X_1$ and
$X_2 \times_{X_1} X_1' \to X_1$ is integral
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-integral}).
Hence we get a morphism
$h : X_2' \to X_2 \times_{X_1} X_1'$ by the universal property of
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-characterize-normalization}.
Observe that $X_2'$ is the relative spectrum of the integral closure
of $\mathcal{O}_{X_2}$ in $f_{2, *}\mathcal{O}_{Y_2}$.
If $\mathcal{A}' \subset f_{1, *}\mathcal{O}_{Y_1}$ denotes the integral
closure of $\mathcal{O}_{X_2}$, then $X_2 \times_{X_1} X_1'$ is the
relative spectrum of $\varphi^*\mathcal{A}'$ as the construction of
the relative spectrum commutes with arbitrary base change. By
Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-flat-base-change-cohomology}
we know that $f_{2, *}\mathcal{O}_{Y_2} = \varphi^*f_{1, *}\mathcal{O}_{Y_1}$.
Hence the result follows from
Lemma \ref{lemma-integral-closure-smooth-pullback}.
\end{proof}







\section{Slicing Cohen-Macaulay morphisms}
\label{section-slice}

\noindent
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $f_1, \ldots, f_r \in \Gamma(X, \mathcal{O}_X)$. In this case we
denote $V(f_1, \ldots, f_r)$ the {\it closed subspace of $X$ cut out by
$f_1, \ldots, f_r$}. More precisely, we can define $V(f_1, \ldots, f_r)$
as the closed subspace of $X$ corresponding to the quasi-coherent sheaf
of ideals generated by $f_1, \ldots, f_r$, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Alternatively, we can choose a presentation $X = U/R$ and consider the
closed subscheme $Z \subset U$ cut out by $f_1|U, \ldots, f_r|_U$.
It is clear that $Z$ is an $R$-invariant (see
Groupoids, Definition \ref{groupoids-definition-invariant-open})
closed subscheme and we may set $V(f_1, \ldots, f_r) = Z/R_Z$.

\begin{lemma}
\label{lemma-slice}
Let $S$ be a scheme. Consider a cartesian diagram
$$
\xymatrix{
X \ar[d] & F \ar[l]^p \ar[d] \\
Y & \Spec(k) \ar[l]
}
$$
where $X \to Y$ is a morphism of algebraic spaces over $S$
which is flat and locally of finite presentation, and where
$k$ is a field over $S$. Let $f_1, \ldots, f_r \in \Gamma(X, \mathcal{O}_X)$
and $z \in |F|$ such that $f_1, \ldots, f_r$ map to a regular sequence
in the local ring $\mathcal{O}_{F, \overline{z}}$.
Then, after replacing $X$ by an open subspace containing $p(z)$, the morphism
$$
V(f_1, \ldots, f_r) \longrightarrow Y
$$
is flat and locally of finite presentation.
\end{lemma}

\begin{proof}
Set $Z = V(f_1, \ldots, f_r)$. It is clear that $Z \to X$ is locally of
finite presentation, hence the composition $Z \to Y$ is locally of finite
presentation, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-composition-finite-presentation}.
Hence it suffices to show that $Z \to Y$ is flat in a neighbourhood of $p(z)$.
Let $k \subset k'$ be an extension field. Then
$F' = F \times_{\Spec(k)} \Spec(k')$ is surjective and
flat over $F$, hence we can find a point $z' \in |F'|$ mapping to $z$
and the local ring map
$\mathcal{O}_{F, \overline{z}} \to \mathcal{O}_{F', \overline{z}'}$ is
flat, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-flat-at-point-etale-local-rings}.
Hence the image of $f_1, \ldots, f_r$ in
$\mathcal{O}_{F', \overline{z}'}$ is a regular sequence too, see
Algebra, Lemma \ref{algebra-lemma-flat-increases-depth}.
Thus, during the proof we may replace $k$ by an extension field.
In particular, we may assume that $z \in |F|$ comes from a section
$z : \Spec(k) \to F$ of the structure morphism $F \to \Spec(k)$.

\medskip\noindent
Choose a scheme $V$ and a surjective \'etale morphism
$V \to Y$. Choose a scheme $U$ and a surjective \'etale morphism
$U \to X \times_Y V$. After possibly enlarging $k$ once more we may
assume that $\Spec(k) \to F \to X$ factors through $U$ (as
$U \to X$ is surjective). Let
$u : \Spec(k) \to U$ be such a factorization and denote $v \in V$
the image of $u$. Note that the morphisms
$$
U_v \times_{\Spec(\kappa(v))} \Spec(k) =
U \times_V \Spec(k) \to U \times_Y \Spec(k) \to F
$$
are \'etale (the first as the base change of $V \to V \times_Y V$ and
the second as the base change of $U \to X$). Moreover, by construction
the point $u : \Spec(k) \to U$ gives a point of the left most
space which maps to $z$ on the right. Hence the elements
$f_1, \ldots, f_r$ map to a regular sequence in the local ring
on the right of the following map
$$
\mathcal{O}_{U_v, u}
\longrightarrow
\mathcal{O}_{U_v \times_{\Spec(\kappa(v)} \Spec(k), \overline{u}}
=
\mathcal{O}_{U \times_V \Spec(k), \overline{u}}.
$$
But since the displayed arrow is flat (combine
More on Flatness, Lemma \ref{flat-lemma-flat-up-down-henselization}
and
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-flat-at-point-etale-local-rings})
we see from
Algebra, Lemma \ref{algebra-lemma-flat-increases-depth}
that $f_1, \ldots, f_r$ maps to a regular sequence in
$\mathcal{O}_{U_v, u}$. By
More on Morphisms, Lemma \ref{more-morphisms-lemma-slice-given-elements}
we conclude that the morphism of schemes
$$
V(f_1, \ldots, f_r) \times_X U = V(f_1|_U, \ldots, f_r|_U) \to V
$$
is flat in an open neighbourhood $U'$ of $u$. Let $X' \subset X$
be the open subspace corresponding to the image of
$|U'| \to |X|$ (see
Properties of Spaces, Lemmas
\ref{spaces-properties-lemma-topology-points} and
\ref{spaces-properties-lemma-open-subspaces}).
We conclude that $V(f_1, \ldots, f_r) \cap X' \to Y$ is flat
(see
Morphisms of Spaces, Definition \ref{spaces-morphisms-definition-flat})
as
we have the commutative diagram
$$
\xymatrix{
V(f_1, \ldots, f_r) \times_X U' \ar[d]_a \ar[r] & V \ar[d]^b \\
V(f_1, \ldots, f_r) \cap X' \ar[r] & Y
}
$$
with $a, b$ \'etale and $a$ surjective.
\end{proof}









\section{\'Etale localization of morphisms}
\label{section-etale-localization}

\noindent
The section is the analogue of
More on Morphisms, Section \ref{more-morphisms-section-etale-localization}.

\begin{lemma}
\label{lemma-etale-splits-off-quasi-finite-part}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $y \in |Y|$. Let $x_1, \ldots, x_n \in |X|$ mapping to $y$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $f$ is separated,
\item $f$ is quasi-finite at $x_1, \ldots, x_n$, and
\item $f$ is quasi-compact or $Y$ is decent.
\end{enumerate}
Then there exists an \'etale morphism $(U, u) \to (Y, y)$
of pointed algebraic spaces and a decomposition
$$
U \times_Y X = W \amalg V
$$
into open and closed subspaces such that the morphism $V \to U$ is finite,
every point of the fibre of $|V| \to |U|$ over $u$ maps to an $x_i$,
and the fibre of $|W| \to |U|$ over $u$ contains no point mapping to an
$x_i$.
\end{lemma}

\begin{proof}
Let $(U, u) \to (Y, y)$ be an \'etale morphism of algebraic spaces
and consider the set of  $w \in |U \times_Y X|$ mapping to $u \in |U|$
and one of the $x_i \in |X|$. By
Decent Spaces, Lemma \ref{decent-spaces-lemma-qf-and-qc-finite-fibre}
(if $f$ is of finite type) or
Decent Spaces, Lemma \ref{decent-spaces-lemma-decent-finite-fibre}
(if $Y$ is decent) this set is finite.
It follows that we may replace $f$ by the base change
$U \times_Y X \to U$ and $x_1, \ldots, x_n$ by the set of these $w$.
In particular we may and do assume that $Y$ is an affine scheme,
whence $X$ is a separated algebraic space.

\medskip\noindent
Choose an affine scheme $Z$ and an \'etale morphism $Z \to X$ such that
$x_1, \ldots, x_n$ are in the image of $|Z| \to |X|$. The fibres of
$|Z| \to |X|$ are finite, see Properties of Spaces, Lemma
\ref{spaces-properties-lemma-finite-fibres-presentation}
(or the more general discussion in Decent Spaces, Section
\ref{decent-spaces-section-reasonable-decent}).
Let $\{z_1, \ldots, z_m\} \subset |Z|$ be the preimage of
$\{x_1, \ldots, x_n\}$. By More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical}
there exists an \'etale morphism $(U, u) \to (Y, y)$ such
that $U \times_Y Z = Z_1 \amalg Z_2$ with $Z_1 \to U$ finite and
$(Z_1)_y = \{z_1, \ldots, z_m\}$. We may assume that $U$ is affine
and hence $Z_1$ is affine too.

\medskip\noindent
Since $f$ is separated, the image $V$ of $Z_1 \to X$ is both open and closed
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-permanence}).
Set $W = X \setminus V$ to get a decomposition as in the lemma.
To finish the proof we have to show that $V \to U$ is finite.
As $Z_1 \to V$ is surjective and \'etale, $V$ is the quotient of
$Z_1$ by the \'etale equivalence relation $R = Z_1 \times_V Z_1$, see
Spaces, Lemma \ref{spaces-lemma-space-presentation}.
Since $f$ is separated, $V \to U$ is separated and $R$ is closed in
$Z_1 \times_U Z_1$. Since $Z_1 \to U$ is finite,
the projections $s, t : R \to Z_1$ are finite.
Thus $V$ is an affine scheme by
Groupoids, Proposition \ref{groupoids-proposition-finite-flat-equivalence}.
By Morphisms, Lemma \ref{morphisms-lemma-image-proper-is-proper}
we conclude that $V \to U$ is proper and by
Morphisms, Lemma \ref{morphisms-lemma-finite-proper}
we conclude that $V \to U$ is finite,
thereby finishing the proof.
\end{proof}

\begin{lemma}
\label{lemma-etale-splits-off-just-one-quasi-finite-part}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $x \in |X|$ with image $y \in |Y|$. Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $f$ is separated, and
\item $f$ is quasi-finite at $x$.
\end{enumerate}
Then there exists an \'etale morphism $(U, u) \to (Y, y)$
of pointed algebraic spaces and a decomposition
$$
U \times_Y X = W \amalg V
$$
into open and closed subspaces such that the morphism $V \to U$ is finite
and there exists a point $v \in |V|$ which maps to $x$ in $|X|$
and $u$ in $|U|$.
\end{lemma}

\begin{proof}
Pick a scheme $U$, a point $u \in U$, and an \'etale morphism
$U \to Y$ mapping $u$ to $y$. There exists a point $x' \in |U \times_Y X|$
mapping to $x$ in $|X|$ and $u$ in $|U|$ (Properties of Spaces,
Lemma \ref{spaces-properties-lemma-points-cartesian}).
To finish, apply Lemma \ref{lemma-etale-splits-off-quasi-finite-part}
to the morphism $U \times_Y X \to U$ and the point $x'$.
It applies because $U$ is a scheme and hence $u$ comes from
the monomorphism $\Spec(\kappa(u)) \to U$.
\end{proof}










\section{Zariski's Main Theorem}
\label{section-structure-quasi-finite}

\noindent
In this section we apply the results of the previous section to
prove Zariski's main theorem for morphisms of algebraic spaces.
This section is the analogue of More on Morphisms, Section
\ref{more-morphisms-section-application-etale-neighbourhoods}.

\begin{lemma}
\label{lemma-finite-type-separated}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic
spaces over $S$ which is of finite type and separated.
Let $Y'$ be the normalization of $Y$ in $X$. Picture:
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_{f'} & & Y' \ar[ld]^\nu \\
& Y &
}
$$
Then there exists an open subspace $U' \subset Y'$ such that
\begin{enumerate}
\item $(f')^{-1}(U') \to U'$ is an isomorphism, and
\item $(f')^{-1}(U') \subset X$ is the set of points at which
$f$ is quasi-finite.
\end{enumerate}
\end{lemma}

\begin{proof}
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part}
there is an open subspace $U \subset X$ corresponding to the points
of $|X|$ where $f$ is quasi-finite. We have to prove
\begin{enumerate}
\item[(a)] the image of $|U| \to |Y'|$ is $|U'|$ for some open subspace
$U'$ of $Y'$,
\item[(b)] $U = f^{-1}(U')$, and
\item[(c)] $U \to U'$ is an isomorphism.
\end{enumerate}
Since formation of $U$ commutes with arbitrary base change
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part}),
since formation of the normalization $Y'$ commutes with smooth
base change (Lemma \ref{lemma-normalization-smooth-localization}),
since \'etale morphisms are open, and
since ``being an isomorphism'' is fpqc local on the base
(Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-isomorphism}),
it suffices to prove (a), (b), (c) \'etale locally on $Y$
(some details omitted). Thus
we may assume $Y$ is an affine scheme. This implies that $Y'$ is
an (affine) scheme as well.

\medskip\noindent
Let $x \in |U|$. Claim: there exists an open
neighbourhood $f'(x) \in V \subset Y'$ such that $(f')^{-1}V \to V$ is an
isomorphism. We first prove the claim implies the lemma.
Namely, then $(f')^{-1}V \cong V$ is a scheme (as an open
of $Y'$), locally of finite type over $Y$ (as an open subspace of $X$),
and for $v \in V$ the residue field extension
$\kappa(v) \supset \kappa(\nu(v))$ is algebraic (as
$V \subset Y'$ and $Y'$ is integral over $Y$). Hence the fibres
of $V \to Y$ are discrete (Morphisms, Lemma
\ref{morphisms-lemma-algebraic-residue-field-extension-closed-point-fibre})
and $(f')^{-1}V \to Y$ is locally quasi-finite
(Morphisms, Lemma \ref{morphisms-lemma-locally-quasi-finite-fibres}).
This implies $(f')^{-1}V \subset U$ and $V \subset U'$. Since $x$ was
arbitrary we see that (a), (b), and (c) are true.

\medskip\noindent
Let $y = f(x) \in |Y|$. Let $(T, t) \to (Y, y)$ be an \'etale morphism
of pointed schemes. Denote by a subscript ${}_T$ the base change to $T$.
Let $z \in X_T$ be a point in the fibre $X_t$ lying over $x$.
Note that $U_T \subset X_T$ is the set of points where $f_T$ is
quasi-finite, see Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part}.
Note that
$$
X_T \xrightarrow{f'_T} Y'_T \xrightarrow{\nu_T} T
$$
is the normalization of $T$ in $X_T$, see
Lemma \ref{lemma-normalization-smooth-localization}.
Suppose that the claim holds for $z \in U_T \subset X_T \to Y'_T \to T$, i.e.,
suppose that we can find an open neighbourhood
$f'_T(z) \in V' \subset Y'_T$ such that $(f'_T)^{-1}V' \to V'$ is an
isomorphism. The morphism $Y'_T \to Y'$ is \'etale hence the image
$V \subset Y'$ of $V'$ is open. Observe that $f'(x) \in V$ as $f'_T(z) \in V'$.
Observe that
$$
\xymatrix{
(f'_T)^{-1}V' \ar[r] \ar[d] & (f')^{-1}(V) \ar[d] \\
V' \ar[r] & V
}
$$
is a fibre square (as $Y'_T \times_{Y'} X = X_T$).
Since the left vertical arrow is an isomorphism
and $\{V' \to V\}$ is a \'etale covering, we conclude that the right vertical
arrow is an isomorphism by
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-isomorphism}.
In other words, the claim holds for $x \in U \subset X \to Y' \to Y$.

\medskip\noindent
By the result of the previous paragraph to prove the claim for
$x \in |U|$, we may replace $Y$ by an \'etale neighbourhood $T$ of
$y = f(x)$ and $x$ by any point lying over $x$ in $T \times_Y X$.
Thus we may assume there is a decomposition
$$
X = V \amalg W
$$
into open and closed subspaces where $V \to Y$ is finite and $x \in V$,
see Lemma \ref{lemma-etale-splits-off-quasi-finite-part}.
Since $X$ is a disjoint union of $V$ and $W$ over $Y$ and since
$V \to Y$ is finite we see that the
normalization of $Y$ in $X$ is the morphism
$$
X = V \amalg W \longrightarrow V \amalg W' \longrightarrow S
$$
where $W'$ is the normalization of $Y$ in $W$, see
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-normalization-in-disjoint-union},
\ref{spaces-morphisms-lemma-finite-integral}, and
\ref{spaces-morphisms-lemma-normalization-in-integral}.
The claim follows and we win.
\end{proof}

\noindent
The following lemma is a duplicate of
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-finite-separated-quasi-affine}.
The reason for having two copies of the same lemma is that the
proofs are somewhat different. The proof given below
rests on Zariski's Main Theorem for nonrepresentable morphisms of
algebraic spaces as presented above, whereas the proof of
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-finite-separated-quasi-affine}
rests on Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}
to reduce to the case of morphisms of schemes.

\begin{lemma}
\label{lemma-quasi-finite-separated-quasi-affine}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Assume $f$ is quasi-finite and separated.
Let $Y'$ be the normalization of $Y$ in $X$.
Picture:
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_{f'} & & Y' \ar[ld]^\nu \\
& Y &
}
$$
Then $f'$ is a quasi-compact open immersion and $\nu$ is integral.
In particular $f$ is quasi-affine.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-finite-type-separated}. Namely, by
that lemma there exists an open subspace $U' \subset Y'$ such that
$(f')^{-1}(U') = X$ (!) and $X \to U'$ is an isomorphism! In other
words, $f'$ is an open immersion. Note that $f'$ is quasi-compact as
$f$ is quasi-compact and $\nu : Y' \to Y$ is separated
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-compact-permanence}).
Hence for every affine scheme $Z$ and morphism $Z \to Y$ the
fibre product $Z \times_Y X$ is a quasi-compact open subscheme
of the affine scheme $Z \times_Y Y'$. Hence $f$ is quasi-affine by
definition.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-separated-pass-through-finite}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Assume $f$ is quasi-finite and separated and assume that
$Y$ is quasi-compact and quasi-separated. Then there exists
a factorization
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_j & & T \ar[ld]^\pi \\
& Y &
}
$$
where $j$ is a quasi-compact open immersion and $\pi$ is finite.
\end{lemma}

\begin{proof}
Let $X \to Y' \to Y$ be as in the conclusion of
Lemma \ref{lemma-quasi-finite-separated-quasi-affine}.
By
Limits of Spaces, Lemma
\ref{spaces-limits-lemma-integral-algebra-directed-colimit-finite}
we can write
$\nu_*\mathcal{O}_{Y'} = \colim_{i \in I} \mathcal{A}_i$ as a
directed colimit of finite quasi-coherent $\mathcal{O}_X$-algebras
$\mathcal{A}_i \subset \nu_*\mathcal{O}_{Y'}$. Then
$\pi_i : T_i = \underline{\Spec}_Y(\mathcal{A}_i) \to Y$
is a finite morphism for each $i$.
Note that the transition morphisms $T_{i'} \to T_i$ are affine
and that $Y' = \lim T_i$.

\medskip\noindent
By Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-opens}
there exists an $i$ and a quasi-compact open
$U_i \subset T_i$ whose inverse image in $Y'$ equals
$f'(X)$. For $i' \geq i$ let $U_{i'}$ be the inverse image
of $U_i$ in $T_{i'}$. Then $X \cong f'(X) = \lim_{i' \geq i} U_{i'}$, see
Limits of Spaces, Lemma
\ref{spaces-limits-lemma-directed-inverse-system-has-limit}.
By
Limits of Spaces, Lemma
\ref{spaces-limits-lemma-finite-type-eventually-closed} we see that
$X \to U_{i'}$ is a closed immersion for some $i' \geq i$.
(In fact $X \cong U_{i'}$ for sufficiently
large $i'$ but we don't need this.) Hence $X \to T_{i'}$ is an immersion. By
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-factor-the-other-way}
we can factor this as $X \to T \to T_{i'}$ where the first arrow
is an open immersion and the second a closed immersion. Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-separated-pass-through-finite-addendum}
With notation and hypotheses as in
Lemma \ref{lemma-quasi-finite-separated-pass-through-finite}.
Assume moreover that $f$ is locally of finite presentation. Then we can
choose the factorization such that $T$ is finite and of
finite presentation over $Y$.
\end{lemma}

\begin{proof}
By Limits of Spaces, Lemma
\ref{spaces-limits-lemma-finite-in-finite-and-finite-presentation} we can write
$T = \lim T_i$ where all $T_i$ are finite and of finite presentation
over $Y$ and the transition morphisms $T_{i'} \to T_i$ are closed
immersions. By
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-opens}
there exists an $i$ and an open subscheme $U_i \subset T_i$ whose inverse
image in $T$ is $X$. By
Limits of Spaces, Lemma
\ref{spaces-limits-lemma-finite-type-eventually-closed}
we see that $X \cong U_i$ for large enough $i$.
Replacing $T$ by $T_i$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-characterize-finite}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. The following are equivalent:
\begin{enumerate}
\item $f$ is finite,
\item $f$ is proper and locally quasi-finite,
\item $f$ is proper and $|X_k|$ is a discrete space for every morphism
$\Spec(k) \to Y$ where $k$ is a field,
\item $f$ is universally closed, separated, locally of finite type
and $|X_k|$ is a discrete space for every morphism $\Spec(k) \to Y$
where $k$ is a field.
\end{enumerate}
\end{lemma}

\begin{proof}
We have (1) $\Rightarrow$ (2) by
Morphisms of Spaces, Lemmas \ref{spaces-morphisms-lemma-finite-proper},
\ref{spaces-morphisms-lemma-finite-quasi-finite}.
We have (2) $\Rightarrow$ (3) by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite}.
By definition (3) implies (4).

\medskip\noindent
Assume (4). Since $f$ is universally closed it is quasi-compact
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-quasi-compact}).
Pick a point $y$ of $|Y|$. We represent $y$ by a
morphism $\Spec(k) \to Y$. Note that $|X_k|$ is finite discrete
as a quasi-compact discrete space. The map $|X_k| \to |X|$ surjects
onto the fibre of $|X| \to |Y|$ over $y$
(Properties of Spaces, Lemma \ref{spaces-properties-lemma-points-cartesian}).
By
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-quasi-finite-at-point}
we see that $X \to Y$ is quasi-finite at all the points of the fibre
of $|X| \to |Y|$ over $y$.
Choose an elementary \'etale neighbourhood $(U, u) \to (Y, y)$
and decomposition $X_U = V \amalg W$ as in
Lemma \ref{lemma-etale-splits-off-quasi-finite-part}
adapted to all the points of $|X|$ lying over $y$.
Note that $W_u = \emptyset$ because we used all the points
in the fibre of $|X| \to |Y|$ over $y$.
Since $f$ is universally closed we see that
the image of $|W|$ in $|U|$ is a closed set not containing $u$.
After shrinking $U$ we may assume that $W = \emptyset$.
In other words we see that $X_U = V$ is finite over $U$.
Since $y \in |Y|$ was arbitrary
this means there exists a family $\{U_i \to Y\}$
of \'etale morphisms whose images cover $Y$ such that
the base changes $X_{U_i} \to U_i$ are finite.
We conclude that $f$ is finite by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-integral-local}.
\end{proof}

\noindent
As a consequence we have the following useful result.

\begin{lemma}
\label{lemma-proper-finite-fibre-finite-in-neighbourhood}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Let $y \in |Y|$. Assume
\begin{enumerate}
\item $f$ is proper, and
\item $f$ is quasi-finite at all $x \in |X|$ lying over $y$
(Decent Spaces, Lemma \ref{decent-spaces-lemma-conditions-on-fibre-and-qf}).
\end{enumerate}
Then there exists an open neighbourhood $V \subset Y$ of $y$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
By
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part} the
set of points at which $f$ is quasi-finite is an open $U \subset X$.
Let $Z = X \setminus U$. Then $y \not \in f(Z)$. Since $f$ is proper
the set $f(Z) \subset Y$ is closed. Choose any open neighbourhood
$V \subset Y$ of $y$ with $Z \cap V = \emptyset$. Then
$f^{-1}(V) \to V$ is locally quasi-finite and proper.
Hence $f^{-1}(V) \to V$ is finite by Lemma \ref{lemma-characterize-finite}.
\end{proof}

\begin{lemma}
\label{lemma-flat-proper-family-cannot-collapse-fibre}
\begin{slogan}
Collapsing a fibre of a proper family forces nearby ones to collapse too.
\end{slogan}
Let $S$ be a scheme. Let
$$
\xymatrix{
X \ar[rr]_h \ar[rd]_f & & Y \ar[ld]^g \\
& B
}
$$
be a commutative diagram of morphism of algebraic spaces over $S$.
Let $b \in B$ and let $\Spec(k) \to B$ be a morphism in the equivalence
class of $b$. Assume
\begin{enumerate}
\item $X \to B$ is a proper morphism,
\item $Y \to B$ is separated and locally of finite type,
\item one of the following is true
\begin{enumerate}
\item the image of $|X_k| \to |Y_k|$ is finite,
\item the image of $|f|^{-1}(\{b\})$ in $|Y|$ is finite
and $B$ is decent.
\end{enumerate}
\end{enumerate}
Then there is an open
subspace $B' \subset B$ containing $b$ such that $X_{B'} \to Y_{B'}$
factors through a closed subspace $Z \subset Y_{B'}$ finite over $B'$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be the scheme theoretic image of $h$, see
Morphisms of Spaces, Section
\ref{spaces-morphisms-section-scheme-theoretic-image}.
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-scheme-theoretic-image-is-proper}
the morphism $X \to Z$ is surjective and $Z \to B$ is proper.
Thus
$$
\{x \in |X|\text{ lying over }b\} \to
\{z \in |Z|\text{ lying over }b\}
$$
and $|X_k| \to |Z_k|$ are surjective. We see that either
(3)(a) or (3)(b) imply that $Z \to B$ is quasi-finite
all all points of $|Z|$ lying over $b$ by
Decent Spaces, Lemma \ref{decent-spaces-lemma-conditions-on-fibre-and-qf}.
Hence $Z \to B$ is finite in an open neighbourhood of $b$ by
Lemma \ref{lemma-proper-finite-fibre-finite-in-neighbourhood}.
\end{proof}







\section{Stein factorization}
\label{section-stein-factorization}

\noindent
Stein factorization is the statement that a proper morphism $f : X \to S$
with $f_*\mathcal{O}_X = \mathcal{O}_S$ has connected fibres.

\begin{lemma}
\label{lemma-stein-universally-closed}
Let $S$ be a scheme.
Let $f : X \to Y$ be a universally closed, quasi-compact and
quasi-separated morphism of algebraic spaces over $S$.
There exists a factorization
$$
\xymatrix{
X \ar[rr]_{f'} \ar[rd]_f & & Y' \ar[dl]^\pi \\
& Y &
}
$$
with the following properties:
\begin{enumerate}
\item the morphism $f'$ is universally closed, quasi-compact, quasi-separated,
and surjective,
\item the morphism $\pi : Y' \to Y$ is integral,
\item we have $f'_*\mathcal{O}_X = \mathcal{O}_{Y'}$,
\item we have $Y' = \underline{\Spec}_Y(f_*\mathcal{O}_X)$, and
\item $Y'$ is the normalization of $Y$ in $X$ as defined in
Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-normalization-X-in-Y}.
\end{enumerate}
Formation of the factorization $f = \pi \circ f'$ commutes with flat
base change.
\end{lemma}

\begin{proof}
We just define $Y'$ as the normalization of $Y$ in $X$, so (5) and (2) hold
automatically. By
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-normalization-in-universally-closed}
we see that (4) holds. The morphism $f'$ is universally closed by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-permanence}.
It is quasi-compact by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-compact-permanence}
and quasi-separated by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-compose-after-separated}.

\medskip\noindent
To show the remaining statements we may assume the base $Y$ is affine
(as taking normalization commutes with \'etale localization).
Say $Y = \Spec(R)$. Then $Y' = \Spec(A)$ with
$A = \Gamma(X, \mathcal{O}_X)$ an integral $R$-algebra.
Thus it is clear that $f'_*\mathcal{O}_X$
is $\mathcal{O}_{Y'}$ (because $f'_*\mathcal{O}_X$ is quasi-coherent,
by Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-pushforward},
and hence equal to $\widetilde{A}$). This proves (3).

\medskip\noindent
Let us show that $f'$ is surjective. As $f'$ is universally closed (see above)
the image of $f'$ is a closed subset
$V(I) \subset S' = \Spec(A)$. Pick $h \in I$. Then
$h|_X = f^\sharp(h)$ is a global section of the structure sheaf of
$X$ which vanishes at every point. As $X$ is quasi-compact this means
that $h|_X$ is a nilpotent section, i.e., $h^n|X = 0$ for some $n > 0$.
But $A = \Gamma(X, \mathcal{O}_X)$, hence $h^n = 0$.
In other words $I$ is contained in the radical ideal of $A$ and we conclude
that $V(I) = S'$ as desired.
\end{proof}

\noindent
Let $f : X \to Y$ be a morphism of algebraic spaces and let
$\overline{y} : \Spec(k) \to Y$ be a geometric point. Then the
{\it fibre of $f$ over $\overline{y}$} is the algebraic space
$X_{\overline{y}} = X \times_{Y, \overline{y}} \Spec(k)$ over $k$.
If $Y$ is a scheme and $y \in Y$ is a point, then we denote
$X_y = X \times_Y \Spec(\kappa(y))$ the fibre as usual.

\begin{lemma}
\label{lemma-characterize-geometrically-connected-fibres}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Let $\overline{y}$ be a geometric point of $Y$. Then
$X_{\overline{y}}$ is connected, if and only if for every \'etale
neighbourhood $(V, \overline{v}) \to (Y, \overline{y})$ where $V$
is a scheme the base change $X_V \to V$ has connected fibre $X_v$.
\end{lemma}

\begin{proof}
Since the category of \'etale neighbourhoods of $\overline{y}$ is
cofiltered and contains a cofinal collection of schemes
(Properties of Spaces, Lemma \ref{spaces-properties-lemma-cofinal-etale})
we may replace $Y$ by one of these neighbourhoods and assume that
$Y$ is a scheme. Let $y \in Y$ be the point corresponding to $\overline{y}$.
Then $X_y$ is geometrically connected over $\kappa(y)$ if and only if
$X_{\overline{y}}$ is connected and if and only if $(X_y)_{k'}$
is connected for every finite separable extension $k'$ of $\kappa(y)$.
See Spaces over Fields, Section
\ref{spaces-over-fields-section-geometrically-connected} and especially
Lemma \ref{spaces-over-fields-lemma-characterize-geometrically-disconnected}.
By More on Morphisms, Lemma
\ref{more-morphisms-lemma-realize-prescribed-residue-field-extension-etale}
there exists an affine \'etale neighbourhood $(V, v) \to (Y, y)$ such that
$\kappa(s) \subset \kappa(u)$ is identified with $\kappa(s) \subset k'$
any given finite separable extension. The lemma follows.
\end{proof}

\begin{theorem}[Stein factorization; Noetherian case]
\label{theorem-stein-factorization-Noetherian}
Let $S$ be a scheme. Let $f : X \to Y$ be a proper morphism of algebraic
spaces over $S$ with $Y$ locally Noetherian.
There exists a factorization
$$
\xymatrix{
X \ar[rr]_{f'} \ar[rd]_f & & Y' \ar[dl]^\pi \\
& Y &
}
$$
with the following properties:
\begin{enumerate}
\item the morphism $f'$ is proper with connected geometric fibres,
\item the morphism $\pi : Y' \to Y$ is finite,
\item we have $f'_*\mathcal{O}_X = \mathcal{O}_{Y'}$,
\item we have $Y' = \underline{\Spec}_Y(f_*\mathcal{O}_X)$, and
\item $Y'$ is the normalization of $Y$ in $X$, see
Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}.
\end{enumerate}
\end{theorem}

\begin{proof}
Let $f = \pi \circ f'$ be the factorization of
Lemma \ref{lemma-stein-universally-closed}. Note that besides the
conclusions of Lemma \ref{lemma-stein-universally-closed} we
also have that $f'$ is separated
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-compose-after-separated})
and finite type
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-permanence-finite-type}).
Hence $f'$ is proper. By
Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-proper-pushforward-coherent}
we see that $f_*\mathcal{O}_X$ is a coherent $\mathcal{O}_Y$-module.
Hence we see that $\pi$ is finite, i.e., (2) holds.

\medskip\noindent
This proves all but the most interesting assertion, namely that
the geometric fibres of $f'$ are connected. It is clear from the
discussion above that we may replace $Y$ by $Y'$. 
Then $Y$ is locally Noetherian,
$f : X \to Y$ is proper, and $f_*\mathcal{O}_X = \mathcal{O}_Y$.
Let $\overline{y}$ be a geometric point of $Y$.
At this point we apply the theorem on formal functions,
more precisely Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-formal-functions-stalk}.
It tells us that
$$
\mathcal{O}^\wedge_{Y, \overline{y}} =
\lim_n H^0(X_n, \mathcal{O}_{X_n})
$$
where $X_n =
\Spec(\mathcal{O}_{Y, \overline{y}}/\mathfrak m_{\overline{y}}^n) \times_Y X$.
Note that $X_1 = X_{\overline{y}} \to X_n$ is a (finite order) thickening
and hence the underlying topological space of $X_n$ is equal to that
of $X_{\overline{y}}$. Thus, if $X_{\overline{y}} = T_1 \amalg T_2$
is a disjoint union of nonempty open and closed subspaces, then similarly
$X_n = T_{1, n} \amalg T_{2, n}$ for all $n$. And this in turn means
$H^0(X_n, \mathcal{O}_{X_n})$ contains a nontrivial idempotent $e_{1, n}$,
namely the function which is identically $1$ on $T_{1, n}$ and
identically $0$ on $T_{2, n}$. It is clear that $e_{1, n + 1}$
restricts to $e_{1, n}$ on $X_n$. Hence $e_1 = \lim e_{1, n}$
is a nontrivial idempotent of the limit. This contradicts the fact
that $\mathcal{O}^\wedge_{Y, \overline{y}}$ is a local ring. Thus the
assumption was wrong, i.e., $X_{\overline{y}}$ is connected
as desired.
\end{proof}

\begin{theorem}[Stein factorization; general case]
\label{theorem-stein-factorization-general}
Let $S$ be a scheme. Let $f : X \to Y$ be a proper morphism of algebraic
spaces over $S$. There exists a factorization
$$
\xymatrix{
X \ar[rr]_{f'} \ar[rd]_f & & Y' \ar[dl]^\pi \\
& Y &
}
$$
with the following properties:
\begin{enumerate}
\item the morphism $f'$ is proper with connected geometric fibres,
\item the morphism $\pi : Y' \to Y$ is integral,
\item we have $f'_*\mathcal{O}_X = \mathcal{O}_{Y'}$,
\item we have $Y' = \underline{\Spec}_Y(f_*\mathcal{O}_X)$, and
\item $Y'$ is the normalization of $Y$ in $X$ (Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-normalization-X-in-Y}).
\end{enumerate}
\end{theorem}

\begin{proof}
We may apply Lemma \ref{lemma-stein-universally-closed} to get the
morphism $f' : X \to Y'$.
Note that besides the
conclusions of Lemma \ref{lemma-stein-universally-closed} we
also have that $f'$ is separated
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-compose-after-separated})
and finite type
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-permanence-finite-type}).
Hence $f'$ is proper. At this point we have proved all of the
statements except for the statement
that $f'$ has connected geometric fibres.

\medskip\noindent
It is clear from the discussion that we may replace $Y$ by $Y'$. 
Then $f : X \to Y$ is proper and $f_*\mathcal{O}_X = \mathcal{O}_Y$.
Note that these conditions are preserved under flat base change
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-proper}
and
Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-flat-base-change-cohomology}).
Let $\overline{y}$ be a geometric point of $Y$. By
Lemma \ref{lemma-characterize-geometrically-connected-fibres}
and the remark just made we reduce to the case where $Y$ is a
scheme, $y \in Y$ is a point, $f : X \to Y$ is a proper algebraic
space over $Y$ with $f_*\mathcal{O}_X = \mathcal{O}_Y$,
and we have to show the fibre $X_y$ is connected.
Replacing $Y$ by an affine neighbourhood of $y$ we may
assume that $Y = \Spec(R)$ is affine. Then $f_*\mathcal{O}_X = \mathcal{O}_Y$
signifies that the ring map
$R \to \Gamma(X, \mathcal{O}_X)$ is bijective.

\medskip\noindent
By Limits of Spaces, Lemma
\ref{spaces-limits-lemma-proper-limit-of-proper-finite-presentation-noetherian}
we can write $(X \to Y) = \lim (X_i \to Y_i)$ with $X_i \to Y_i$
proper and of finite presentation and $Y_i$ Noetherian. For $i$ large
enough $Y_i$ is affine (Limits of Spaces, Lemma
\ref{spaces-limits-lemma-limit-is-affine}).
Say $Y_i = \Spec(R_i)$. Let $R'_i = \Gamma(X_i, \mathcal{O}_{X_i})$.
Observe that we have ring maps $R_i \to R_i' \to R$. Namely, we have
the first because $X_i$ is an algebraic space over $R_i$ and the second because
we have $X \to X_i$ and $R = \Gamma(X, \mathcal{O}_X)$. Note that
$R = \colim R'_i$ by Limits of Spaces, Lemma
\ref{spaces-limits-lemma-descend-section}.
Then 
$$
\xymatrix{
X \ar[d]  \ar[r] & X_i \ar[d] \\
Y \ar[r] & Y'_i \ar[r] & Y_i
}
$$
is commutative with $Y'_i = \Spec(R'_i)$.
Let $y'_i \in Y'_i$ be the image of $y$.
We have $X_y = \lim X_{i, y'_i}$ because $X = \lim X_i$,
$Y = \lim Y'_i$, and $\kappa(y) = \colim \kappa(y'_i)$.
Now let $X_y = U \amalg V$ with $U$ and $V$ open and closed.
Then $U, V$ are the inverse images of opens $U_i, V_i$ in $X_{i, y'_i}$
(Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-opens}).
By Theorem \ref{theorem-stein-factorization-Noetherian} the fibres
of $X_i \to Y'_i$ are connected, hence either $U$ or $V$ is empty.
This finishes the proof.
\end{proof}

\noindent
Here is an application.

\begin{lemma}
\label{lemma-geometrically-connected-fibres-towards-normal}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic
spaces over $S$. Assume
\begin{enumerate}
\item $f$ is proper,
\item $Y$ is integral (Spaces over Fields, Definition
\ref{spaces-over-fields-definition-integral-algebraic-space})
with generic point $\xi$,
\item $Y$ is normal,
\item $X$ is reduced,
\item every generic point of an irreducible component of $|X|$ maps to $\xi$,
\item we have $H^0(X_\xi, \mathcal{O}) = \kappa(\xi)$.
\end{enumerate}
Then $f_*\mathcal{O}_X = \mathcal{O}_Y$ and $f$
has geometrically connected fibres.
\end{lemma}

\begin{proof}
Apply Theorem \ref{theorem-stein-factorization-general} to get a
factorization $X \to Y' \to Y$. It is enough to show that $Y' = Y$.
It suffices to show that $Y' \times_Y V \to V$ is an isomorphism,
where $V \to Y$ is an \'etale morphism and $V$ an affine integral scheme,
see Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-normal-integral-cover-by-affines}.
The formation of $Y'$ commutes with \'etale base change, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-properties-normalization}.
The generic points of $X \times_Y V$ lie over the generic points of $X$
(Decent Spaces, Lemma \ref{decent-spaces-lemma-decent-generic-points})
hence map to the generic point of $V$ by assumption (5). Moreover, condition
(6) is preserved under the base change by $V \to Y$, for example by
flat base change (Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-flat-base-change-cohomology}).
Thus it suffices to prove the lemma in case $Y$ is a normal
integral affine scheme.

\medskip\noindent
Assume $Y$ is a normal integral affine scheme. We will show $Y' \to Y$
is an isomorphism by an application of Morphisms, Lemma
\ref{morphisms-lemma-finite-birational-over-normal}.
Namely, $Y'$ is reduced because $X$ is reduced (Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-normalization-in-reduced}).
The morphism $Y' \to Y$ is integral by the theorem cited above.
Since $Y$ is decent and $X \to Y$ is separated, we see that
$X$ is decent too; to see this use
Decent Spaces, Lemmas
\ref{decent-spaces-lemma-properties-trivial-implications} and
\ref{decent-spaces-lemma-property-over-property}. By assumption (5),
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-normalization-generic},
and Decent Spaces, Lemma \ref{decent-spaces-lemma-decent-generic-points}
we see that every generic point of an irreducible component of $|Y'|$
maps to $\xi$. On the other hand, since $Y'$ is the relative
spectrum of $f_*\mathcal{O}_X$ we see that the scheme theoretic fibre
$Y'_\xi$ is the spectrum of $H^0(X_\xi, \mathcal{O})$ which is
equal to $\kappa(\xi)$ by assumption. Hence $Y'$ is an integral
scheme with function field equal to the function field of $Y$.
This finishes the proof.
\end{proof}








\section{Extending properties from an open}
\label{section-extending-properties}

\noindent
In this section we collect a number of results of the form: If $f : X \to Y$
is a flat morphism of algebraic spaces and $f$ satisfies some property over
a dense
open of $Y$, then $f$ satisfies the same property over all of $Y$.

\begin{lemma}
\label{lemma-flat-finite-type-finitely-presented-over-dense-open}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $V \subset Y$ be an open subspace. Assume
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is of finite type and flat over $Y$,
\item $V \to Y$ is quasi-compact and scheme theoretically dense,
\item $\mathcal{F}|_{f^{-1}V}$ is of finite presentation.
\end{enumerate}
Then $\mathcal{F}$ is of finite presentation.
\end{lemma}

\begin{proof}
It suffices to prove the pullback of $\mathcal{F}$ to a scheme surjective
and \'etale over $X$ is of finite presentation. Hence we may assume $X$
is a scheme. Similarly, we can replace $Y$ by a scheme surjective and
\'etale and over $Y$ (the inverse image of $V$ in this scheme is scheme
theoretically dense, see
Morphisms of Spaces, Section
\ref{spaces-morphisms-section-scheme-theoretic-closure}).
Thus we reduce to the case of schemes which is
More on Flatness, Lemma
\ref{flat-lemma-flat-finite-type-finitely-presented-over-dense-open}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-type-finitely-presented-over-dense-open-X}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $V \subset Y$ be an open subspace.
Assume
\begin{enumerate}
\item $f$ is locally of finite type and flat,
\item $V \to Y$ is quasi-compact and scheme theoretically dense,
\item $f|_{f^{-1}V} : f^{-1}V \to V$ is locally of finite presentation.
\end{enumerate}
Then $f$ is of locally of finite presentation.
\end{lemma}

\begin{proof}
The proof is identical to the proof of
Lemma \ref{lemma-flat-finite-type-finitely-presented-over-dense-open}
except one uses
More on Flatness, Lemma
\ref{flat-lemma-flat-finite-type-finitely-presented-over-dense-open-X}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-dimension-over-dense-open}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$ which is flat and locally of finite type. Let $V \subset Y$ be an
open subspace such that $|V| \subset |Y|$ is dense and such that $X_V \to V$
has relative dimension $\leq d$. If also either
\begin{enumerate}
\item $f$ is locally of finite presentation, or
\item $V \to Y$ is quasi-compact,
\end{enumerate}
then $f : X \to Y$ has relative dimension $\leq d$.
\end{lemma}

\begin{proof}
We may replace $Y$ by its reduction, hence we may assume $Y$ is reduced.
Then $V$ is scheme theoretically dense in $Y$, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-compact-immersion}.
By definition the property of having relative dimension $\leq d$ can
be checked on an \'etale covering, see
Morphisms of Spaces, Sections \ref{spaces-morphisms-section-relative-dimension}.
Thus it suffices to prove $f$ has relative dimension $\leq d$
after replacing $X$ by a scheme surjective and \'etale over $X$.
Similarly, we can replace $Y$ by a scheme surjective and
\'etale and over $Y$. The inverse image of $V$ in this scheme is scheme
theoretically dense, see
Morphisms of Spaces, Section
\ref{spaces-morphisms-section-scheme-theoretic-closure}.
Since a scheme theoretically dense open of a scheme is in particular
dense, we reduce to the case of schemes which is
More on Flatness, Lemma
\ref{flat-lemma-flat-finite-presentation-dimension-over-dense-open}.
\end{proof}

\begin{lemma}
\label{lemma-proper-flat-finite-over-dense-open}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$ which is flat and proper. Let $V \to Y$ be an open subspace
with $|V| \subset |Y|$ dense such that $X_V \to V$ is finite. If also
either $f$ is locally of finite presentation or $V \to Y$ is quasi-compact,
then $f$ is finite.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-finite-presentation-dimension-over-dense-open}
the fibres of $f$ have dimension zero.
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite-rel-dimension-0}
this implies that $f$ is locally quasi-finite.
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite-separated-representable}
this implies that $f$ is representable.
We can check whether $f$ is finite \'etale locally on $Y$,
hence we may assume $Y$ is a scheme. Since  $f$ is representable,
we reduce to the case of schemes which is
More on Flatness, Lemma \ref{flat-lemma-proper-flat-finite-over-dense-open}.
\end{proof}

\begin{lemma}
\label{lemma-zariski}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $V \subset Y$ be an open subspace. If
\begin{enumerate}
\item $f$ is separated, locally of finite type, and flat,
\item $f^{-1}(V) \to V$ is an isomorphism, and
\item $V \to Y$ is quasi-compact and scheme theoretically dense,
\end{enumerate}
then $f$ is an open immersion.
\end{lemma}

\begin{proof}
Applying
Lemma \ref{lemma-flat-finite-type-finitely-presented-over-dense-open-X}
we see that $f$ is locally of finite presentation. Applying
Lemma \ref{lemma-flat-finite-presentation-dimension-over-dense-open}
we see that $f$ has relative dimension $\leq 0$.
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite-rel-dimension-0}
this implies that $f$ is locally quasi-finite.
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite-separated-representable}
this implies that $f$ is representable.
By Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-open-immersion}
we can check whether $f$ is an open immersion \'etale locally on $Y$.
Hence we may assume that $Y$ is a scheme. Since $f$ is representable,
we reduce to the case of schemes which is
More on Flatness, Lemma \ref{flat-lemma-zariski}.
\end{proof}







\section{Blowing up and flatness}
\label{section-blowup-flat}

\noindent
Instead of redoing the work in
More on Flatness, Section \ref{flat-section-blowup-flat}
we prove an analogue of More on Flatness, Lemma \ref{flat-lemma-push-ideal}
which tells us that the problem of finding a suitable blowup
is often \'etale local on the base.

\begin{lemma}
\label{lemma-push-ideal}
Let $S$ be a scheme. Let $X$ be a quasi-compact and quasi-separated
algebraic space over $S$. Let $\varphi : W \to X$ be a quasi-compact
separated \'etale morphism. Let $U \subset X$ be a quasi-compact open
subspace. Let $\mathcal{I} \subset \mathcal{O}_U$ be a finite type
quasi-coherent sheaf of ideals such that
$V(\mathcal{I}) \cap \varphi^{-1}(U) = \emptyset$.
Then there exists a finite type quasi-coherent sheaf of ideals
$\mathcal{J} \subset \mathcal{O}_X$ such that
\begin{enumerate}
\item $V(\mathcal{J}) \cap U = \emptyset$, and
\item $\varphi^{-1}(\mathcal{J})\mathcal{O}_W = \mathcal{I} \mathcal{I}'$
for some finite type quasi-coherent ideal
$\mathcal{I}' \subset \mathcal{O}_W$.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a factorization $W \to Y \to X$ where $j : W \to Y$ is a
quasi-compact open immersion and $\pi : Y \to X$ is a finite
morphism of finite presentation
(Lemma \ref{lemma-quasi-finite-separated-pass-through-finite-addendum}).
Let $V = j(W) \cup \pi^{-1}(U) \subset Y$. Note that
$\mathcal{I}$ on $W \cong j(W)$ and $\mathcal{O}_{\pi^{-1}(U)}$
glue to a finite type quasi-coherent sheaf of ideals
$\mathcal{I}_1 \subset \mathcal{O}_V$. By
Limits of Spaces, Lemma \ref{spaces-limits-lemma-extend}
there exists a finite type quasi-coherent sheaf of ideals
$\mathcal{I}_2 \subset \mathcal{O}_Y$ such that
$\mathcal{I}_2|_V = \mathcal{I}_1$. In other words,
$\mathcal{I}_2 \subset \mathcal{O}_Y$
is a finite type quasi-coherent sheaf of ideals such that
$V(\mathcal{I}_2)$ is disjoint from $\pi^{-1}(U)$ and
$j^{-1}\mathcal{I}_2 = \mathcal{I}$. Denote $i : Z \to Y$
the corresponding closed immersion which is of finite presentation
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-closed-immersion-finite-presentation}).
In particular the composition $\tau = \pi \circ i : Z \to X$ is finite
and of finite presentation
(Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-composition-finite-presentation} and
\ref{spaces-morphisms-lemma-composition-integral}).

\medskip\noindent
Let $\mathcal{F} = \tau_*\mathcal{O}_Z$ which we think of as
a quasi-coherent $\mathcal{O}_X$-module. By
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-finite-finitely-presented-module}
we see that $\mathcal{F}$ is a finitely presented $\mathcal{O}_X$-module.
Let $\mathcal{J} = \text{Fit}_0(\mathcal{F})$. (Insert reference to
fitting modules on ringed topoi here.) This is a finite type quasi-coherent
sheaf of ideals on $X$ (as $\mathcal{F}$ is of finite presentation, see
More on Algebra, Lemma \ref{more-algebra-lemma-fitting-ideal-basics}).
Part (1) of the lemma holds because $|\tau|(|Z|) \cap |U| = \emptyset$
by our choice of $\mathcal{I}_2$ and because the $0$th Fitting ideal
of the trivial module equals the structure sheaf. To prove (2) note that
$\varphi^{-1}(\mathcal{J})\mathcal{O}_W = \text{Fit}_0(\varphi^*\mathcal{F})$
because taking Fitting ideals commutes with base change.
On the other hand, as $\varphi : W \to X$ is separated and \'etale
we see that $(1, j) : W \to W \times_X Y$ is an open and closed immersion.
Hence $W \times_Y Z = V(\mathcal{I}) \amalg Z'$ for some finite and
finitely presented morphism of algebraic spaces $\tau' : Z' \to W$.
Thus we see that
\begin{align*}
\text{Fit}_0(\varphi^*\mathcal{F}) & =
\text{Fit}_0((W \times_Y Z \to W)_*\mathcal{O}_{W \times_Y Z}) \\
& =
\text{Fit}_0(\mathcal{O}_W/\mathcal{I}) \cdot
\text{Fit}_0(\tau'_*\mathcal{O}_{Z'}) \\
& =
\mathcal{I} \cdot \text{Fit}_0(\tau'_*\mathcal{O}_{Z'})
\end{align*}
the second equality by
More on Algebra, Lemma \ref{more-algebra-lemma-fitting-ideal-basics}
translated in sheaves on ringed topoi.
Setting $\mathcal{I}' = \text{Fit}_0(\tau'_*\mathcal{O}_{Z'})$
finishes the proof of the lemma.
\end{proof}

\begin{theorem}
\label{theorem-flatten-module}
Let $S$ be a scheme. Let $B$ be a quasi-compact and quasi-separated
algebraic space over $S$. Let $X$ be an algebraic space over $B$.
Let $\mathcal{F}$ be a quasi-coherent module on $X$.
Let $U \subset B$ be a quasi-compact open subspace. Assume
\begin{enumerate}
\item $X$ is quasi-compact,
\item $X$ is locally of finite presentation over $B$,
\item $\mathcal{F}$ is a module of finite type,
\item $\mathcal{F}_U$ is of finite presentation, and
\item $\mathcal{F}_U$ is flat over $U$.
\end{enumerate}
Then there exists a $U$-admissible blowup $B' \to B$ such that the
strict transform $\mathcal{F}'$ of $\mathcal{F}$ is an
$\mathcal{O}_{X \times_B B'}$-module of finite presentation and
flat over $B'$.
\end{theorem}

\begin{proof}
Choose an affine scheme $V$ and a surjective \'etale morphism $V \to X$.
Because strict transform commutes with \'etale localization
(Divisors on Spaces, Lemma \ref{spaces-divisors-lemma-strict-transform-local})
it suffices to prove the result with $X$ replaced by $V$. Hence we
may assume that $X \to B$ is representable (in addition to the
hypotheses of the lemma).

\medskip\noindent
Assume that $X \to B$ is representable. Choose an affine scheme $W$ and a
surjective \'etale morphism $\varphi : W \to B$. Note that $X \times_B W$
is a scheme. By the case of schemes
(More on Flatness, Theorem \ref{flat-theorem-flatten-module})
we can find a finite type quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_W$ such that
(a) $|V(\mathcal{I})| \cap |\varphi^{-1}(U)| = \emptyset$ and (b)
the strict transform of $\mathcal{F}|_{X \times_B W}$ with respect
to the blowing up $W' \to W$ in $\mathcal{I}$ becomes flat over $W'$
and is a module of finite presentation. Choose a finite type sheaf of ideals
$\mathcal{J} \subset \mathcal{O}_B$ as in Lemma \ref{lemma-push-ideal}.
Let $B' \to B$ be the blowing up of $\mathcal{J}$. We claim that this
blow up works. Namely, it is clear that $B' \to B$ is $U$-admissible
by our choice of ideal $\mathcal{J}$. Moreover, the base change
$B' \times_B W \to W$ is the blowup of $W$ in
$\varphi^{-1}\mathcal{J} = \mathcal{I}\mathcal{I}'$
(compatibility of blowup with flat base change, see
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-flat-base-change-blowing-up}).
Hence there is a factorization
$$
W \times_B B' \to W' \to W
$$
where the first morphism is a blowup as well, see
Divisors on Spaces, Lemma \ref{spaces-divisors-lemma-blowing-up-two-ideals}).
The restriction of $\mathcal{F}'$ (which lives on $B' \times_B X$)
to $W \times_B B' \times_B X$ is the strict transform of
$\mathcal{F}|_{X \times_B W}$
(Divisors on Spaces, Lemma \ref{spaces-divisors-lemma-strict-transform-local})
and hence is the twice repeated strict transform of
$\mathcal{F}|_{X \times_B W}$ by the two blowups displayed above
(Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-strict-transform-composition-blowups}).
After the first blow up our sheaf is already flat over
the base and of finite presentation (by construction). Whence this holds 
after the second strict transform as well (since this is a
pullback by Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-strict-transform-flat}).
Thus we see that the restriction of $\mathcal{F}'$
to an \'etale cover of $B' \times_B X$ has the desired properties
and the theorem is proved.
\end{proof}







\section{Applications}
\label{section-applications-flattening-by-blowing-up}

\noindent
In this section we apply the result on flattening by blowing up.

\begin{lemma}
\label{lemma-flat-after-blowing-up}
Let $S$ be a scheme.
Let $B$ be a quasi-compact and quasi-separated algebraic space over $S$.
Let $X$ be an algebraic space over $B$.
Let $U \subset B$ be a quasi-compact open subspace.
Assume
\begin{enumerate}
\item $X \to B$ is of finite type and quasi-separated, and
\item $X_U \to U$ is flat and locally of finite presentation.
\end{enumerate}
Then there exists a $U$-admissible blowup $B' \to B$ such that
the strict transform of $X$ is flat and of finite presentation
over $B'$.
\end{lemma}

\begin{proof}
Let $B' \to B$ be a $U$-admissible blowup. Note that the strict transform
of $X$ is quasi-compact and quasi-separated over $B'$ as $X$ is quasi-compact
and quasi-separated over $B$. Hence we only need to worry about finding
a $U$-admissible blowup such that the strict transform becomes flat and
locally of finite presentation. We cannot directly apply
Theorem \ref{theorem-flatten-module} because $X$ is not locally of finite
presentation over $B$.

\medskip\noindent
Choose an affine scheme $V$ and a surjective \'etale morphism $V \to X$.
(This is possible as $X$ is quasi-compact as a finite type space over
the quasi-compact space $B$.) Then it suffices to show the result for
the morphism $V \to B$ (as strict transform commutes with \'etale
localization, see Divisors on Spaces,
Lemma \ref{spaces-divisors-lemma-strict-transform-local}).
Hence we may assume that $X \to B$ is separated as well as finite type.
In this case we can find a closed immersion $i : X \to Y$ with $Y \to B$
separated and of finite presentation, see
Limits of Spaces, Proposition
\ref{spaces-limits-proposition-separated-closed-in-finite-presentation}.

\medskip\noindent
Apply Theorem \ref{theorem-flatten-module} to $\mathcal{F} = i_*\mathcal{O}_X$
on $Y/B$. We find a $U$-admissible blowup $B' \to B$ such that that strict
transform of $\mathcal{F}$ is flat over $B'$ and of finite presentation.
Let $X'$ be the strict transform of $X$ under the blowup $B' \to B$.
Let $i' : X' \to Y \times_B B'$ be the induced morphism.
Since taking strict transform commutes with pushforward along affine
morphisms (Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-strict-transform-affine}),
we see that $i'_*\mathcal{O}_{X'}$ is flat over $B'$ and of
finite presentation as a $\mathcal{O}_{Y \times_B B'}$-module.
Thus $X' \to B'$ is flat and locally of finite presentation.
This implies the lemma by our earlier remarks.
\end{proof}

\begin{lemma}
\label{lemma-finite-after-blowing-up}
Let $S$ be a scheme. Let $B$ be a quasi-compact and quasi-separated
algebraic space over $B$. Let $X$ be an algebraic space over $S$.
Let $U \subset B$ be a quasi-compact open subspace. Assume
\begin{enumerate}
\item $X \to B$ is proper, and
\item $X_U \to U$ is finite locally free.
\end{enumerate}
Then there exists a $U$-admissible blowup $B' \to B$ such that
the strict transform of $X$ is finite locally free over $B'$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-after-blowing-up} we may assume that
$X \to B$ is flat and of finite presentation. After replacing
$B$ by a $U$-admissible blow up if necessary, we may assume
that $U \subset B$ is scheme theoretically dense. Then $f$ is
finite by Lemma \ref{lemma-proper-flat-finite-over-dense-open}.
Hence $f$ is finite locally free by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-flat}.
\end{proof}

\begin{lemma}
\label{lemma-zariski-after-blowup}
Let $S$ be a scheme.
Let $\varphi : X \to B$ be a morphism of algebraic spaces over $S$.
Assume $\varphi$ is of finite type with $B$ quasi-compact and quasi-separated.
Let $U \subset B$ be a quasi-compact open subspace such that
$\varphi^{-1}U \to U$ is an isomorphism. Then there exists a $U$-admissible
blowup $B' \to B$ such that $U$ is scheme theoretically dense in $B'$
and such that the strict transform $X'$ of $X$ is isomorphic
to an open subspace of $B'$.
\end{lemma}

\begin{proof}
As the composition of $U$-admissible blowups is $U$-admissible
(Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-composition-admissible-blowups})
we can proceed in stages. Pick a finite type quasi-coherent sheaf
of ideals $\mathcal{I} \subset \mathcal{O}_B$ with
$|B| \setminus |U| = |V(\mathcal{I})|$. Replace $B$ by the blowup
of $B$ in $\mathcal{I}$ and $X$ by the strict transform of $X$.
After this replacement $B \setminus U$ is the support of an effective
Cartier divisor $D$ (Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-blowing-up-gives-effective-Cartier-divisor}).
In particular $U$ is scheme theoretically dense in $B$
(Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-complement-effective-Cartier-divisor}).
Next, we do another $U$-admissible blowup to get to the situation where
$X \to B$ is flat and of finite presentation, see
Lemma \ref{lemma-flat-after-blowing-up}. Note that $U$ is still scheme
theoretically dense in $B$. Hence $X \to B$ is an open immersion by
Lemma \ref{lemma-zariski}.
\end{proof}

\noindent
The following lemma says that a modification can be dominated
by a blowup.

\begin{lemma}
\label{lemma-dominate-modification-by-blowup}
Let $S$ be a scheme.
Let $\varphi : X \to B$ be a proper morphism of algebraic spaces over $S$.
Assume $B$ quasi-compact and quasi-separated. Let $U \subset B$ be a
quasi-compact open subspace such that $\varphi^{-1}U \to U$ is an isomorphism.
Then there exists a $U$-admissible blowup $B' \to B$
which dominates $X$, i.e., such that there exists a factorization
$B' \to X \to B$ of the blowup morphism.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-zariski-after-blowup} we may find a $U$-admissible
blowup $B' \to B$ such that the strict transform $X'$ is an open subspace
of $B'$ and $U$ is scheme theoretically dense in $B'$.
Since $X' \to B'$ is proper we see that $|X'|$ is closed in $|B'|$.
As $U \subset B'$ is dense $X' = B'$.
\end{proof}






\section{Chow's lemma}
\label{section-chow}

\noindent
In this section we prove some variants of Chow's lemma. Since we have yet
to define projective morphisms of algebraic spaces, the statements will
involve representable proper morphisms, rather than projective ones.

\begin{lemma}
\label{lemma-find-common-blowups}
Let $S$ be a scheme. Let $Y$ be a quasi-compact and quasi-separated
algebraic space over $S$. Let $U \to X_1$ and $U \to X_2$ be open immersions
of algebraic spaces over $Y$ and assume $U$, $X_1$, $X_2$ of finite
type and separated over $Y$. Then there exists a commutative diagram
$$
\xymatrix{
X_1' \ar[d] \ar[r] & X & X_2' \ar[l] \ar[d] \\
X_1 & U \ar[l] \ar[lu] \ar[u] \ar[ru] \ar[r] & X_2
}
$$
of algebraic spaces over $Y$ where $X_i' \to X_i$ is a $U$-admissible
blowup, $X_i' \to X$ is an open immersion, and $X$ is separated and finite
type over $Y$.
\end{lemma}

\begin{proof}
Throughout the proof all the algebraic spaces will be separated of finite
type over $Y$. This in particular implies these algebraic spaces and
the morphisms between them will be quasi-compact and quasi-separated.
We will use that if $U \to W$ is an immersion of such spaces over $Y$,
then the scheme theoretic image $Z$ of $U$ in $W$ is a closed subspace
of $W$ and $U \to Z$ is an open immersion, $U \subset Z$ is scheme
theoretically dense, and $|U| \subset |Z|$ is dense. See
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-compact-immersion}.

\medskip\noindent
Let $X_{12} \subset X_1 \times_Y X_2$ be the scheme theoretic image
of $U \to X_1 \times_Y X_2$. We claim the projections $p_i : X_{12} \to X_i$
induce isomorphisms
$p_i^{-1}(U) \to U$. Namely, $p_i : X_{12} \to X_i$ is separated
and $U \to X_{12}$ is a section of $p_i$. Hence $U \to p_i^{-1}(U)$
is a closed immersion
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-semi-diagonal})
as well as scheme theoretically dense whence an isomorphism.
Choose a $U$-admissible blowup $X_i^i \to X_i$ such that
the strict transform $X_{12}^i$ of $X_{12}$ is isomorphic to an
open subspace of $X_i^i$, see
Lemma \ref{lemma-zariski-after-blowup}.
Let $\mathcal{I}_i \subset \mathcal{O}_{X_i}$ be the corresponding
finite type quasi-coherent sheaf of ideals.
Recall that $X_{12}^i \to X_{12}$ is the blowup in
$p_i^{-1}\mathcal{I}_i \mathcal{O}_{X_{12}}$.
Let $X_{12}'$ be the blowup of $X_{12}$ in
$p_1^{-1}\mathcal{I}_1 p_2^{-1}\mathcal{I}_2 \mathcal{O}_{X_{12}}$.
We obtain a commutative diagram
$$
\xymatrix{
X_{12}' \ar[d] \ar[r] & X_{12}^2 \ar[d] \\
X_{12}^1 \ar[r] & X_{12}
}
$$
where all the morphisms are $U$-admissible blowing ups.
Choose a finite type quasi-coherent sheaf of ideals
$\mathcal{J}_i$ on $X_i^i$ extending the pull back
of $\mathcal{I}_{1 - i}$ to $X_{12}^i$ (see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-extend}).
Let $X_i' \to X_i^i$ be the blowing up in $\mathcal{J}_i$.
By construction $X_{12}' \subset X_i'$ is an open subspace and the diagram
$$
\xymatrix{
X_{12}' \ar[d] \ar[r] & X_i' \ar[d] \\
X_{12}^i \ar[r] & X_i^i
}
$$
is commutative with vertical arrows blowing ups and horizontal arrows
open immersions. Note that $X'_{12} \to X_1' \times_Y X_2'$ is
an immersion and proper (use that $X'_{12} \to X_{12}$ is proper
and $X_{12} \to X_1 \times_Y X_2$ is closed and $X_1' \times_Y X_2' \to
X_1 \times_Y X_2$ is separated and apply Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-permanence}).
Thus $X'_{12} \to  X_1' \times_Y X_2'$ is a closed immersion.
It follows that if we define $X$ by glueing $X_1'$ and $X_2'$
along the common open subspace $X_{12}'$, then $X \to Y$ is of finite type
and separated (details omitted). As compositions of $U$-admissible blowups
are $U$-admissible blowups
(Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-composition-admissible-blowups})
the lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-blowup-to-find-embedding}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Let $U \subset X$ be an open subscheme. Assume
\begin{enumerate}
\item $U$ is quasi-compact,
\item $Y$ is quasi-compact and quasi-separated,
\item there exists an immersion $U \to \mathbf{P}^n_Y$ over $Y$,
\item $f$ is of finite type and separated.
\end{enumerate}
Then there exists a commutative diagram
$$
\xymatrix{
X' \ar[d] \ar[r] & \overline{X}' \ar[d] \\
X \ar[r] & Y
}
$$
where $X' \to X$ is a $U$-admissible blowup, $X' \to \overline{X}'$
is an open immersion, and $\overline{X}' \to Y$ is a proper and representable
morphism of algebraic spaces.
\end{lemma}

\begin{proof}
Let $Z \subset \mathbf{P}^n_Y$ be the scheme theoretic image of
the immersion $U \to \mathbf{P}^n_Y$. Since $U \to \mathbf{P}^n_Y$
is quasi-compact we see that $U \subset Z$ is a
(scheme theoretically) dense open subspace
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-compact-immersion}).
Apply Lemma \ref{lemma-find-common-blowups} to find a diagram
$$
\xymatrix{
X' \ar[d] \ar[r] & \overline{X}' & Z' \ar[l] \ar[d] \\
X & U \ar[l] \ar[lu] \ar[u] \ar[ru] \ar[r] & Z
}
$$
with properties as listed in the statement of that lemma.
Since $Z' \to Z \to Y$ is proper we see that $Z' \subset \overline{X}'$
is closed (see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-permanence}).
After replacing $\overline{X}'$ by a further $U$-admissible blowup
we may assume that $U$ is scheme theoretically dense in $\overline{X}'$
(details omitted; use
Divisors on Spaces, Lemmas
\ref{spaces-divisors-lemma-blowing-up-gives-effective-Cartier-divisor} and
\ref{spaces-divisors-lemma-complement-effective-Cartier-divisor}).
It follows that $Z' = \overline{X}'$ and the lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-chow-noetherian}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Assume $f$ separated, of finite type, and $Y$ Noetherian.
Then there exists a commutative diagram
$$
\xymatrix{
X' \ar[d] \ar[r] & \overline{X}' \ar[d] \\
X \ar[r] & Y
}
$$
where $X' \to X$ is a $U$-admissible blowup for some dense open
$U \subset X$, the morphism $X' \to \overline{X}'$
is an open immersion, and $\overline{X}' \to Y$ is a proper and representable
morphism of algebraic spaces.
\end{lemma}

\begin{proof}
By Limits of Spaces, Lemma
\ref{spaces-limits-lemma-embedding-into-affine-over-qs}
there exists a dense open subspace $U \subset X$ and an immersion
$U \to \mathbf{A}^n_Y$ over $Y$. Composing with the open immersion
$\mathbf{A}^n_Y \to \mathbf{P}^n_Y$ we obtain a situation as in
Lemma \ref{lemma-blowup-to-find-embedding} and the result
follows.
\end{proof}

\begin{remark}
\label{remark-chow-Noetherian}
In Lemma \ref{lemma-blowup-to-find-embedding}
the morphism $\overline{X}' \to Y$ is a composition
$$
\overline{X}' \to Z \to \mathbf{P}^n_Y \to Y
$$
where $b : \overline{X}' \to Z$ is a $U$-admissible blowing up
(in particular $b|_U : U \to b(U)$ is an isomorphism onto an open
subspace of $Z$) and where $Z \to \mathbf{P}^n_Y$ is a closed immersion.
This is immediate from the proof. It follows that the morphism
$\overline{X}' \to Y$ obtained in the statement of
Lemma \ref{lemma-chow-noetherian} has a factorization of this type as well.
\end{remark}

\noindent
The following result is \cite[IV Theorem 3.1]{Kn}. Note that the immersion
$X' \to \mathbf{P}^n_Y$ is quasi-compact, hence can be factored as
$X' \to \overline{X}' \to \mathbf{P}^n_Y$ where the first morphism is an
open immersion and the second morphism a closed immersion
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-compact-immersion}).

\begin{lemma}[Chow's lemma]
\label{lemma-chow-noetherian-separated}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Assume $f$ separated of finite type, and $Y$ separated and
Noetherian. Then there exists a commutative diagram
$$
\xymatrix{
X' \ar[d] \ar[r] & \mathbf{P}^n_Y \ar[d] \\
X \ar[r] & Y
}
$$
where $X' \to X$ is a $U$-admissible blowup for some dense open
$U \subset X$ and the morphism $X' \to \mathbf{P}^n_Y$ is an immersion.
\end{lemma}

\begin{proof}
In this first paragraph of the proof we reduce the lemma to the case
where $Y$ is of finite type over $\Spec(\mathbf{Z})$.
We may and do replace the base scheme $S$ by $\Spec(\mathbf{Z})$.
We can write $Y = \lim Y_i$ as a directed limit of separated
algebraic spaces of finite type over $\Spec(\mathbf{Z})$, see
Limits of Spaces, Proposition \ref{spaces-limits-proposition-approximate} and
Lemma \ref{spaces-limits-lemma-descend-separated}.
For all $i$ sufficiently large we can find a separated finite type morphism
$X_i \to Y_i$ such that $X = Y \times_{Y_i} X_i$, see
Limits of Spaces, Lemmas
\ref{spaces-limits-lemma-descend-finite-presentation} and
\ref{spaces-limits-lemma-descend-separated-morphism}.
Let $\eta_1, \ldots, \eta_n$ be the generic points of the irreducible
components of $|X|$ ($X$ is Noetherian as a finite type separated
algebraic space over the Noetherian algebraic space $Y$ and therefore
$|X|$ is a Noetherian topological space).
By Limits of Spaces, Lemma \ref{spaces-limits-lemma-topology-limit}
we find that the images of $\eta_1, \ldots, \eta_n$ in $|X_i|$
are distinct for $i$ large enough. We may replace
$X_i$ by the scheme theoretic image of the (quasi-compact, in fact affine)
morphism $X \to X_i$.
After this replacement we see that the images
of $\eta_1, \ldots, \eta_n$ in $|X_i|$ are the generic points of the
irreducible components of $|X_i|$, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-compact-scheme-theoretic-image}.
Having said this, suppose we can find a diagram
$$
\xymatrix{
X_i' \ar[d] \ar[r] & \mathbf{P}^n_{Y_i} \ar[d] \\
X_i \ar[r] & Y
}
$$
where $X_i' \to X_i$ is a $U_i$-admissible blowup for some dense open
$U_i \subset X_i$ and the morphism $X_i' \to \mathbf{P}^n_{Y_i}$
is an immersion. Then the strict transform $X' \to X$ of $X$ relative
to $X_i' \to X_i$ is a $U$-admissible blowing up where $U \subset X$
is the inverse image of $U_i$ in $X$. Because of our carefuly chosen
index $i$ it follows that $\eta_1, \ldots, \eta_n \in |U|$ and
$U \subset X$ is dense. Moreover, $X' \to \mathbf{P}^n_Y$ is an
immersion as $X'$ is closed in
$X_i' \times_{X_i} X = X_i' \times_{Y_i} Y$
which comes with an immersion into $\mathbf{P}^n_Y$. Thus we have reduced
to the situation of the following paragraph.

\medskip\noindent
Assume that $Y$ is separated of finite type over $\Spec(\mathbf{Z})$.
Then $X \to \Spec(\mathbf{Z})$ is separated of finite type as well.
We apply Lemma \ref{lemma-chow-noetherian}
to find a diagram
$$
\xymatrix{
X' \ar[d] \ar[r] & \overline{X}' \ar[d] \\
X \ar[r] & \Spec(\mathbf{Z})
}
$$
where $X' \to X$ is a $U$-admissible blowup for some dense open
$U \subset X$ and $X' \to \overline{X}'$ is an open immersion and
$\overline{X}' \to \Spec(\mathbf{Z})$ is representable and proper.
In fact, by Remark \ref{remark-chow-Noetherian} we see that 
$\overline{X}' \to \Spec(\mathbf{Z})$
can be factored as
$$
\overline{X}' \to Z \to \mathbf{P}^n_\mathbf{Z} \to \Spec(\mathbf{Z}).
$$
where the first morphism is a $U$-admissible blowing up, the second
morphism is a closed immersion, and the third morphism is the structure
morphism. Note that $Z$ has an ample invertible sheaf, namely
$\mathcal{O}_{\mathbf{P}^n}(1)|_Z$. Hence $\overline{X}' \to Z$
is a H-projective morphism by Morphisms, Lemma
\ref{morphisms-lemma-projective-over-quasi-projective-is-H-projective}.
It follows that $\overline{X}' \to \Spec(\mathbf{Z})$ is H-projective
by Morphisms, Lemma \ref{morphisms-lemma-H-projective-composition}.
Thus there exists a closed immersion
$\overline{X}' \to \mathbf{P}^n_{\Spec(\mathbf{Z})}$.
It follows that the diagonal map
$X' \to Y \times \mathbf{P}^n_{\Spec(\mathbf{Z})} = \mathbf{P}^n_Y$
is an immersion and we win.
\end{proof}






\section{Variants of Chow's Lemma}
\label{section-chows-lemma}

\noindent
In this section we prove a number of variants of Chow's lemma dealing
with morphisms between non-Noetherian algebraic spaces.
The Noetherian versions are
Lemma \ref{lemma-chow-noetherian}
and
Lemma \ref{lemma-chow-noetherian-separated}.

\begin{lemma}
\label{lemma-chow-finite-type}
Let $S$ be a  scheme. Let $Y$ be a quasi-compact and quasi-separated
algebraic space over $S$. Let $f : X \to Y$ be a separated morphism of
finite type. Then there exists a commutative diagram
$$
\xymatrix{
X' \ar[d] \ar[r] & \overline{X}' \ar[d] \\
X \ar[r] & Y
}
$$
where $X' \to X$ is proper surjective,
$X' \to \overline{X}'$ is an open immersion, and
$\overline{X}' \to Y$ is proper and representable morphism
of algebraic spaces.
\end{lemma}

\begin{proof}
By
Limits of Spaces, Proposition
\ref{spaces-limits-proposition-separated-closed-in-finite-presentation}
we can find a closed immersion $X \to X_1$ where $X_1$ is separated
and of finite presentation over $Y$. Clearly, if we prove the assertion
for $X_1 \to Y$, then the result follows for $X$. Hence we may assume that
$X$ is of finite presentation over $Y$.

\medskip\noindent
We may and do replace the base scheme $S$ by $\Spec(\mathbf{Z})$.
Write $Y = \lim_i Y_i$ as a directed limit of
quasi-separated algebraic spaces of finite type over $\Spec(\mathbf{Z})$, see
Limits of Spaces,
Proposition \ref{spaces-limits-proposition-approximate}.
By
Limits of Spaces,
Lemma \ref{spaces-limits-lemma-descend-finite-presentation}
we can
find an index $i \in I$ and a scheme $X_i \to Y_i$ of finite presentation
so that $X = Y \times_{Y_i} X_i$.
By
Limits of Spaces,
Lemma \ref{spaces-limits-lemma-descend-separated-morphism}
we may assume that $X_i \to Y_i$ is separated.
Clearly, if we prove the assertion for
$X_i$ over $Y_i$, then the assertion holds for $X$. The case
$X_i \to Y_i$ is treated by
Lemma \ref{lemma-chow-noetherian}.
\end{proof}

\begin{lemma}
\label{lemma-chow-finite-type-separated}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Assume $f$ separated of finite type, and $Y$ separated and
quasi-compact. Then there exists a commutative diagram
$$
\xymatrix{
X' \ar[d] \ar[r] & \mathbf{P}^n_Y \ar[d] \\
X \ar[r] & Y
}
$$
where $X' \to X$ is proper surjective morphism
and the morphism $X' \to \mathbf{P}^n_Y$ is an immersion.
\end{lemma}

\begin{proof}
By
Limits of Spaces, Proposition
\ref{spaces-limits-proposition-separated-closed-in-finite-presentation}
we can find a closed immersion $X \to X_1$ where $X_1$ is separated
and of finite presentation over $Y$. Clearly, if we prove the assertion
for $X_1 \to Y$, then the result follows for $X$. Hence we may assume that
$X$ is of finite presentation over $Y$.

\medskip\noindent
We may and do replace the base scheme $S$ by $\Spec(\mathbf{Z})$.
Write $Y = \lim_i Y_i$ as a directed limit of
quasi-separated algebraic spaces of finite type over $\Spec(\mathbf{Z})$, see
Limits of Spaces,
Proposition \ref{spaces-limits-proposition-approximate}.
By Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-separated}
we may assume that $Y_i$ is separated for all $i$.
By
Limits of Spaces,
Lemma \ref{spaces-limits-lemma-descend-finite-presentation}
we can
find an index $i \in I$ and a scheme $X_i \to Y_i$ of finite presentation
so that $X = Y \times_{Y_i} X_i$.
By
Limits of Spaces,
Lemma \ref{spaces-limits-lemma-descend-separated-morphism}
we may assume that $X_i \to Y_i$ is separated.
Clearly, if we prove the assertion for
$X_i$ over $Y_i$, then the assertion holds for $X$. The case
$X_i \to Y_i$ is treated by
Lemma \ref{lemma-chow-noetherian-separated}.
\end{proof}






\section{Grothendieck's existence theorem}
\label{section-existence-proper}

\noindent
In this section we discuss Grothendieck's existence theorem for algebraic
spaces. Instead of developing a theory of ``formal algebraic spaces''
we temporarily develop a bit of language that replaces the notion of a
``coherent module on a Noetherian adic formal space''.

\medskip\noindent
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals.
Below we will consider inverse systems $(\mathcal{F}_n)$ of coherent
$\mathcal{O}_X$-modules such that
\begin{enumerate}
\item $\mathcal{F}_n$ is annihilated by $\mathcal{I}^n$, and
\item the transition maps induce isomorphisms
$\mathcal{F}_{n + 1}/\mathcal{I}^n\mathcal{F}_{n + 1} \to \mathcal{F}_n$.
\end{enumerate}
A morphism $\alpha : (\mathcal{F}_n) \to (\mathcal{G}_n)$
of such inverse systems is simply a compatible system of morphisms
$\alpha_n : \mathcal{F}_n \to \mathcal{G}_n$.
Let us denote the category of these inverse systems with
$\textit{Coh}(X, \mathcal{I})$. We will develop some theory regarding
these systems that will parallel to the corresponding
results in the case of schemes, see
Cohomology of Schemes, Sections \ref{coherent-section-existence},
\ref{coherent-section-existence-proper}, and
\ref{coherent-section-algebraization}.

\medskip\noindent
Functoriality. Let $f : X \to Y$ be a
morphism of Noetherian algebraic spaces over a scheme $S$, and
let $\mathcal{J} \subset \mathcal{O}_Y$ be a quasi-coherent sheaf
of ideals. Set $\mathcal{I} = f^{-1}\mathcal{J}\mathcal{O}_X$.
In this situation there is a functor
$$
f^* : \textit{Coh}(Y, \mathcal{J}) \longrightarrow \textit{Coh}(X, \mathcal{I})
$$
which sends $(\mathcal{G}_n)$ to $(f^*\mathcal{G}_n)$. Compare with
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-pullback}.
If $f$ is \'etale, then we may think of this as simply the restriction
of the system to $X$, see Properties of Spaces, 
Equation \ref{spaces-properties-equation-restrict-modules}.

\medskip\noindent
\'Etale descent. Let $S$ be a scheme. Let $U_0 \to X$ be a surjective
\'etale morphism of Noetherian algebraic spaces. Set
$U_1 = U_0 \times_X U_0$ and $U_2 = U_0 \times_X U_0 \times_X U_0$.
Let $\mathcal{I} \subset \mathcal{O}_{X}$ be a quasi-coherent sheaf
of ideals. Set $\mathcal{I}_i = \mathcal{I}|_{U_i}$. In this situation
we obtain a diagram of categories
$$
\xymatrix{
\textit{Coh}(X, \mathcal{I}) \ar[r] &
\textit{Coh}(U_0, \mathcal{I}_0) \ar@<0.5ex>[r] \ar@<-0.5ex>[r] &
\textit{Coh}(U_1, \mathcal{I}_1) \ar@<1ex>[r] \ar[r] \ar@<-1ex>[r] &
\textit{Coh}(U_2, \mathcal{I}_2)
}
$$
an the first arrow presents $\textit{Coh}(X, \mathcal{I})$ as the
homotopy limit of the right part of the diagram. More precisely, given
a {\it descent datum}, i.e., a pair $((\mathcal{G}_n), \varphi)$ where
$(\mathcal{G}_n)$ is an object of $\textit{Coh}(U_0, \mathcal{I}_0)$ and
$\varphi : \text{pr}_0^*(\mathcal{G}_n) \to \text{pr}_1^*(\mathcal{G}_n)$
is an isomorphism in $\textit{Coh}(U_1, \mathcal{I}_1)$
satisfying the cocycle condition in $\textit{Coh}(U_2, \mathcal{I}_2)$,
then there exists a unique object $(\mathcal{F}_n)$ of
$\textit{Coh}(X, \mathcal{I})$ whose associated canonical descent datum
is isomorphic to $((\mathcal{G}_n), \varphi)$. Compare with
Descent on Spaces, Definition
\ref{spaces-descent-definition-descent-datum-effective-quasi-coherent}.
The proof of this statement follows immediately by applying
Descent on Spaces, Proposition
\ref{spaces-descent-proposition-fpqc-descent-quasi-coherent}
to the descent data $(\mathcal{G}_n, \varphi_n)$ for varying $n$.

\begin{lemma}
\label{lemma-inverse-systems-abelian}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$ and
let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals.
\begin{enumerate}
\item The category $\textit{Coh}(X, \mathcal{I})$ is abelian.
\item Exactness in $\textit{Coh}(X, \mathcal{I})$
can be checked \'etale locally.
\item For any flat morphism $f : X' \to X$ of Noetherian algebraic spaces
the functor $f^* : \textit{Coh}(X, \mathcal{I}) \to
\textit{Coh}(X', f^{-1}\mathcal{I}\mathcal{O}_{X'})$ is exact.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Choose an affine scheme $U_0$ and a surjective \'etale morphism
$U_0 \to X$. Set $U_1 = U_0 \times_X U_0$ and
$U_2 = U_0 \times_X U_0 \times_X U_0$ as in our discussion of
\'etale descent above. The categories $\textit{Coh}(U_i, \mathcal{I}_i)$
are abelian
(Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-abelian})
and the pullback functors are exact functors
$\textit{Coh}(U_0, \mathcal{I}_0) \to \textit{Coh}(U_1, \mathcal{I}_1)$
and
$\textit{Coh}(U_1, \mathcal{I}_1) \to \textit{Coh}(U_2, \mathcal{I}_2)$
(Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-pullback}).
The lemma then follows formally from the description of
$\textit{Coh}(X, \mathcal{I})$ as a category of descent data.
Some details omitted; compare with the proof of
Groupoids, Lemma \ref{groupoids-lemma-abelian}.

\medskip\noindent
Part (2) follows immediately from the discussion in the previous paragraph.
In the situation of (3) choose a commutative diagram
$$
\xymatrix{
U' \ar[d] \ar[r] & U \ar[d] \\
X' \ar[r] & X
}
$$
where $U'$ and $U$ are affine schemes and the vertical morphisms are
surjective \'etale. Then $U' \to U$ is a flat morphism of Noetherian
schemes (Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-local})
whence the pullback functor
$\textit{Coh}(U, \mathcal{I}\mathcal{O}_U) \to
\textit{Coh}(U', \mathcal{I}\mathcal{O}_{U'})$
is exact by
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-pullback}.
Since we can check exactness in $\textit{Coh}(X, \mathcal{O}_X)$
on $U$ and similarly for $X', U'$ the assertion follows.
\end{proof}

\begin{lemma}
\label{lemma-inverse-systems-surjective}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$
and let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf
of ideals. A map $(\mathcal{F}_n) \to (\mathcal{G}_n)$ is surjective in
$\textit{Coh}(X, \mathcal{I})$ if and only if
$\mathcal{F}_1 \to \mathcal{G}_1$ is surjective.
\end{lemma}

\begin{proof}
We can check on an affine \'etale cover of $X$ by
Lemma \ref{lemma-inverse-systems-abelian}.
Thus we reduce to the case of schemes which is
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-surjective}.
\end{proof}

\noindent
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$ and
let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals.
There is a functor
\begin{equation}
\label{equation-completion-functor}
\textit{Coh}(\mathcal{O}_X) \longrightarrow \textit{Coh}(X, \mathcal{I}), \quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
\end{equation}
which associates to the coherent $\mathcal{O}_X$-module $\mathcal{F}$
the object $\mathcal{F}^\wedge = (\mathcal{F}/\mathcal{I}^n\mathcal{F})$
of $\textit{Coh}(X, \mathcal{I})$.

\begin{lemma}
\label{lemma-exact}
The functor (\ref{equation-completion-functor}) is exact.
\end{lemma}

\begin{proof}
It suffices to check this \'etale locally on $X$, see
Lemma \ref{lemma-inverse-systems-abelian}.
Thus we reduce to the case of schemes which is
Cohomology of Schemes, Lemma \ref{coherent-lemma-exact}.
\end{proof}

\begin{lemma}
\label{lemma-completion-internal-hom}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$ and
let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals.
Let $\mathcal{F}$, $\mathcal{G}$ be coherent $\mathcal{O}_X$-modules. Set
$\mathcal{H} = \SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})$.
Then
$$
\lim H^0(X, \mathcal{H}/\mathcal{I}^n\mathcal{H}) =
\Mor_{\textit{Coh}(X, \mathcal{I})}
(\mathcal{F}^\wedge, \mathcal{G}^\wedge).
$$
\end{lemma}

\begin{proof}
Since $\mathcal{H}$ is a sheaf on $X_\etale$ and since
we have \'etale descent for objects of $\textit{Coh}(X, \mathcal{I})$
it suffices to prove this \'etale locally.
Thus we reduce to the case of schemes which is
Cohomology of Schemes, Lemma \ref{coherent-lemma-completion-internal-hom}.
\end{proof}

\noindent
We introduce the setting that we will focus on throughout the
rest of this section.

\begin{situation}
\label{situation-existence}
Here $A$ is a Noetherian ring complete with respect to an ideal $I$.
Also $f : X \to \Spec(A)$ is a finite type separated morphism of
algebraic spaces and $\mathcal{I} = I\mathcal{O}_X$.
\end{situation}

\noindent
In this situation we denote
$$
\textit{Coh}_{\text{support proper over } A}(\mathcal{O}_X)
$$
be the full subcategory of $\textit{Coh}(\mathcal{O}_X)$
consisting of those coherent $\mathcal{O}_X$-modules whose
scheme theoretic support is proper over $\Spec(A)$.
Similarly, we let
$$
\textit{Coh}_{\text{support proper over } A}(X, \mathcal{I})
$$
be the full subcategory of $\textit{Coh}(X, \mathcal{I})$
consisting of those objects $(\mathcal{F}_n)$ such that
the scheme theoretic support of $\mathcal{F}_1$ is proper over $\Spec(A)$.
Since the support of a quotient module is contained in the support
of the module, it follows that (\ref{equation-completion-functor})
induces a functor
\begin{equation}
\label{equation-completion-functor-proper-over-A}
\textit{Coh}_{\text{support proper over }A}(\mathcal{O}_X)
\longrightarrow
\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})
\end{equation}
Our first result is that this functor is fully faithful.

\begin{lemma}
\label{lemma-fully-faithful}
In Situation \ref{situation-existence}.
Let $\mathcal{F}$, $\mathcal{G}$ be coherent $\mathcal{O}_X$-modules.
Assume that the intersection of the scheme theoretic supports of
$\mathcal{F}$ and $\mathcal{G}$ is proper over $\Spec(A)$. Then the map
$$
\Mor_{\textit{Coh}(\mathcal{O}_X)}(\mathcal{F}, \mathcal{G})
\longrightarrow
\Mor_{\textit{Coh}(X, \mathcal{I})}
(\mathcal{F}^\wedge, \mathcal{G}^\wedge)
$$
coming from (\ref{equation-completion-functor}) is a bijection.
In particular, (\ref{equation-completion-functor-proper-over-A})
is fully faithful.
\end{lemma}

\begin{proof}
Let $\mathcal{H} = \SheafHom_{\mathcal{O}_X}(\mathcal{G}, \mathcal{F})$.
This is a coherent $\mathcal{O}_X$-module because its restriction
of schemes \'etale over $X$ is coherent by
Modules, Lemma \ref{modules-lemma-internal-hom-locally-kernel-direct-sum}.
By Lemma \ref{lemma-completion-internal-hom} the map
$$
\lim_n H^0(X, \mathcal{H}/\mathcal{I}^n\mathcal{H})
\to
\Mor_{\textit{Coh}(X, \mathcal{I})}
(\mathcal{G}^\wedge, \mathcal{F}^\wedge)
$$
is bijective. Let $i : Z \to X$ be the scheme theoretic support of
$\mathcal{H}$. It is clear that $Z$ is a closed subspace contained
in the intersection of the scheme theoretic supports of $\mathcal{F}$
and $\mathcal{G}$. Hence $Z \to \Spec(A)$ is proper by assumption.
Write $\mathcal{H} = i_*\mathcal{H}'$ for some coherent
$\mathcal{O}_Z$-module $\mathcal{H}'$. We have
$i_*(\mathcal{H}'/I^n\mathcal{H}') = \mathcal{H}/I^n\mathcal{H}$.
Hence we obtain
\begin{align*}
\lim_n H^0(X, \mathcal{H}/\mathcal{I}^n\mathcal{H})
& =
\lim_n H^0(Z, \mathcal{H}'/\mathcal{I}^n\mathcal{H}') \\
& =
H^0(Z, \mathcal{H}') \\
& =
H^0(X, \mathcal{H}) \\
& = 
\Mor_{\textit{Coh}(\mathcal{O}_X)}(\mathcal{F}, \mathcal{G})
\end{align*}
the second equality by the theorem on formal functions
functions
(Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-spell-out-theorem-formal-functions}).
This proves the lemma.
\end{proof}

\begin{remark}
\label{remark-inverse-systems-kernel-cokernel-annihilated-by}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$ and let
$\mathcal{I}, \mathcal{K} \subset \mathcal{O}_X$ be quasi-coherent sheaves of
ideals. Let $\alpha : (\mathcal{F}_n) \to (\mathcal{G}_n)$ be a morphism of
$\textit{Coh}(X, \mathcal{I})$.
Given an affine scheme $U = \Spec(A)$ and a surjective \'etale morphism
$U \to X$ denote $I, K \subset A$ the ideals corresponding to the restrictions
$\mathcal{I}|_U, \mathcal{K}|_U$. Denote $\alpha_U : M \to N$ of finite
$A^\wedge$-modules which corresponds to $\alpha|_U$ via
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-affine}.
We claim the following are equivalent
\begin{enumerate}
\item there exists an integer $t \geq 1$ such that
$\Ker(\alpha_n)$ and $\Coker(\alpha_n)$
are annihilated by $\mathcal{K}^t$ for all $n \geq 1$,
\item for any (or some) affine open $\Spec(A) = U \subset X$ as above
the modules $\Ker(\alpha_U)$ and $\Coker(\alpha_U)$
are annihilated by $K^t$ for some integer $t \geq 1$.
\end{enumerate}
If these equivalent conditions hold we will say that $\alpha$ is a
{\it map whose kernel and cokernel are annihilated by a power of
$\mathcal{K}$}. To see the equivalence we refer to
Cohomology of Schemes, Remark
\ref{coherent-remark-inverse-systems-kernel-cokernel-annihilated-by}.
\end{remark}

\begin{lemma}
\label{lemma-existence-easy}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$ and let
$\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals.
Let $\mathcal{G}$ be a coherent $\mathcal{O}_X$-module, $(\mathcal{F}_n)$
an object of $\textit{Coh}(X, \mathcal{I})$, and
$\alpha : (\mathcal{F}_n) \to \mathcal{G}^\wedge$
a map whose kernel and cokernel are annihilated by a power of $\mathcal{I}$.
Then there exists a unique (up to unique isomorphism) triple
$(\mathcal{F}, a, \beta)$ where
\begin{enumerate}
\item $\mathcal{F}$ is a coherent $\mathcal{O}_X$-module,
\item $a : \mathcal{F} \to \mathcal{G}$ is an $\mathcal{O}_X$-module map
whose kernel and cokernel are annihilated by a power of $\mathcal{I}$,
\item $\beta : (\mathcal{F}_n) \to \mathcal{F}^\wedge$ is an isomorphism, and
\item $\alpha = a^\wedge \circ \beta$.
\end{enumerate}
\end{lemma}

\begin{proof}
The uniqueness and \'etale descent for objects of
$\textit{Coh}(X, \mathcal{I})$ and $\textit{Coh}(\mathcal{O}_X)$
implies it suffices to construct $(\mathcal{F}, a, \beta)$ \'etale
locally on $X$. Thus we reduce to the case of schemes which is
Cohomology of Schemes, Lemma \ref{coherent-lemma-existence-easy}.
\end{proof}

\begin{lemma}
\label{lemma-existence-tricky}
In Situation \ref{situation-existence}. Let $\mathcal{K} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. Let $X_e \subset X$ be the closed subspace
cut out by $\mathcal{K}^e$. Let $\mathcal{I}_e = \mathcal{I}\mathcal{O}_{X_e}$.
Let $(\mathcal{F}_n)$ be an object of
$\textit{Coh}_{\text{support proper over } A}(X, \mathcal{I})$.
Assume
\begin{enumerate}
\item the functor
$\textit{Coh}_{\text{support proper over } A}(\mathcal{O}_{X_e})
\to \textit{Coh}_{\text{support proper over } A}(X_e, \mathcal{I}_e)$
is an equivalence for all $e \geq 1$, and
\item there exists an object $\mathcal{H}$ of
$\textit{Coh}_{\text{support proper over } A}(\mathcal{O}_X)$ and a map
$\alpha : (\mathcal{F}_n) \to \mathcal{H}^\wedge$ whose
kernel and cokernel are annihilated by a power of $\mathcal{K}$.
\end{enumerate}
Then $(\mathcal{F}_n)$ is in the essential image of
(\ref{equation-completion-functor-proper-over-A}).
\end{lemma}

\begin{proof}
During this proof we will use without further mention that for a closed
immersion $i : Z \to X$ the functor $i_*$ gives an equivalence between the
category of coherent modules on $Z$ and coherent modules on $X$ annihilated
by the ideal sheaf of $Z$, see
Cohomology of Spaces, Lemma \ref{spaces-cohomology-lemma-i-star-equivalence}.
In particular we think of
$$
\textit{Coh}_{\text{support proper over } A}(\mathcal{O}_{X_e})
\subset
\textit{Coh}_{\text{support proper over } A}(\mathcal{O}_X)
$$
as the full subcategory of consisting of modules annihilated by
$\mathcal{K}^e$ and
$$
\textit{Coh}_{\text{support proper over } A}(X_e, \mathcal{I}_e)
\subset
\textit{Coh}_{\text{support proper over } A}(X, \mathcal{I})
$$
as the full subcategory of of objects annihilated by $\mathcal{K}^e$.
Moreover (1) tells us these two categories are equivalent under the
completion functor (\ref{equation-completion-functor-proper-over-A}).

\medskip\noindent
Applying this equivalence we get a coherent $\mathcal{O}_X$-module
$\mathcal{G}_e$ annihilated by $\mathcal{K}^e$ corresponding to the system
$(\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n)$ of
$\textit{Coh}_{\text{support proper over } A}(X, \mathcal{I})$. The maps
$\mathcal{F}_n/\mathcal{K}^{e + 1}\mathcal{F}_n \to
\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n$ correspond to canonical maps
$\mathcal{G}_{e + 1} \to \mathcal{G}_e$ which induce isomorphisms
$\mathcal{G}_{e + 1}/\mathcal{K}^e\mathcal{G}_{e + 1} \to \mathcal{G}_e$.
We obtain an object $(\mathcal{G}_e)$ of the category
$\textit{Coh}_{\text{support proper over } A}(X, \mathcal{K})$.
The map $\alpha$ induces a system of maps
$$
\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n
\longrightarrow
\mathcal{H}/(\mathcal{I}^n + \mathcal{K}^e)\mathcal{H}
$$
whence maps $\mathcal{G}_e \to \mathcal{H}/\mathcal{K}^e\mathcal{H}$
(by the equivalence of categories again).
Let $t \geq 1$ be an integer, which exists by assumption (2),
such that $\mathcal{K}^t$ annihilates the kernel and cokernel of all the maps
$\mathcal{F}_n \to \mathcal{H}/\mathcal{I}^n\mathcal{H}$.
Then $\mathcal{K}^{2t}$ annihilates the kernel and cokernel of the maps
$\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n \to
\mathcal{H}/(\mathcal{I}^n + \mathcal{K}^e)\mathcal{H}$
(details omitted; see Cohomology of Schemes,
Remark \ref{coherent-remark-inverse-systems-kernel-cokernel-annihilated-by}).
Whereupon we conclude that $\mathcal{K}^{4t}$ annihilates the kernel and
the cokernel of the maps
$$
\mathcal{G}_e
\longrightarrow
\mathcal{H}/\mathcal{K}^e\mathcal{H},
$$
(details omitted;  see Cohomology of Schemes,
Remark \ref{coherent-remark-inverse-systems-kernel-cokernel-annihilated-by}).
We apply Lemma \ref{lemma-existence-easy} to obtain a coherent
$\mathcal{O}_X$-module $\mathcal{F}$, a map
$a : \mathcal{F} \to \mathcal{H}$ and an isomorphism
$\beta : (\mathcal{G}_e) \to (\mathcal{F}/\mathcal{K}^e\mathcal{F})$
in $\textit{Coh}(X, \mathcal{K})$. Working backwards, for a given $n$
the triple
$(\mathcal{F}/\mathcal{I}^n\mathcal{F}, a \bmod \mathcal{I}^n, \beta
\bmod \mathcal{I}^n)$ is a triple as in the lemma for the morphism
$\alpha_n \bmod \mathcal{K}^e :
(\mathcal{F}_n/\mathcal{K}^e\mathcal{F}_n) \to
(\mathcal{H}/(\mathcal{I}^n + \mathcal{K}^e)\mathcal{H})$
of $\textit{Coh}(X, \mathcal{K})$. Thus the uniqueness in
Lemma \ref{lemma-existence-easy}
gives a canonical isomorphism
$\mathcal{F}/\mathcal{I}^n\mathcal{F} \to \mathcal{F}_n$
compatible with all the morphisms in sight.

\medskip\noindent
To finish the proof of the lemma we still have to show that the
scheme theoretic support of $\mathcal{F}$ is proper over $A$.
By construction the kernel of $a : \mathcal{F} \to \mathcal{H}$
is annihilated by a power of $\mathcal{K}$. Hence the support of
this kernel is contained in the support of $\mathcal{G}_1$. Since
$\mathcal{G}_1$ is an object of
$\textit{Coh}_{\text{support proper over } A}(\mathcal{O}_{X_1})$
we see this is proper over $A$. Combined with the fact that the
support of $\mathcal{H}$ is proper over $A$ we conclude that the
support of $\mathcal{F}$ is proper over $A$ (some details omitted).
\end{proof}

\begin{lemma}
\label{lemma-inverse-systems-push-pull}
Let $S$ be a scheme. Let $f : X \to Y$ be a representable
proper morphism of Noetherian algebraic spaces over $S$. Let
$\mathcal{J}, \mathcal{K} \subset \mathcal{O}_Y$
be quasi-coherent sheaves of ideals.
Assume $f$ is an isomorphism over $V = Y \setminus V(\mathcal{K})$.
Set $\mathcal{I} = f^{-1}\mathcal{J} \mathcal{O}_X$.
Let $(\mathcal{G}_n)$ be an object of $\textit{Coh}(Y, \mathcal{J})$,
let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module, and let
$\beta : (f^*\mathcal{G}_n)  \to \mathcal{F}^\wedge$ be an isomorphism in
$\textit{Coh}(X, \mathcal{I})$. Then there exists a map
$$
\alpha :
(\mathcal{G}_n)
\longrightarrow
(f_*\mathcal{F})^\wedge
$$
in $\textit{Coh}(Y, \mathcal{J})$ whose kernel and cokernel
are annihilated by a power of $\mathcal{K}$.
\end{lemma}

\begin{proof}
Since $f$ is a proper morphism we see that $f_*\mathcal{F}$ is a coherent
$\mathcal{O}_Y$-module (Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-proper-pushforward-coherent}).
Thus the statement of the lemma makes sense. Consider the compositions
$$
\gamma_n : \mathcal{G}_n \to
f_*f^*\mathcal{G}_n \to
f_*(\mathcal{F}/\mathcal{I}^n\mathcal{F}).
$$
Here the first map is the adjunction map and the second is $f_*\beta_n$.
We claim that there exists a unique $\alpha$ as in the lemma
such that the compositions
$$
\mathcal{G}_n \xrightarrow{\alpha_n}
f_*\mathcal{F}/\mathcal{J}^nf_*\mathcal{F} \to
f_*(\mathcal{F}/\mathcal{I}^n\mathcal{F})
$$
equal $\gamma_n$ for all $n$. Because of the uniqueness and \'etale
descent for $\textit{Coh}(Y, \mathcal{J})$ it suffices
to prove this \'etale locally on $Y$. Thus we may assume $Y$
is the spectrum of a Noetherian ring. As $f$ is representable
we see that $X$ is a scheme as well. Thus we reduce to the case of
schemes, see proof of
Cohomology of Schemes, Lemma \ref{coherent-lemma-inverse-systems-push-pull}.
\end{proof}

\begin{theorem}[Grothendieck's existence theorem]
\label{theorem-grothendieck-existence}
In Situation \ref{situation-existence} the functor
(\ref{equation-completion-functor-proper-over-A})
is an equivalence.
\end{theorem}

\begin{proof}
We will use the equivalence of categories of
Cohomology of Spaces, Lemma \ref{spaces-cohomology-lemma-i-star-equivalence}
without further mention in the proof of the theorem.
By Lemma \ref{lemma-fully-faithful} the functor is fully faithful.
Thus we need to prove the functor is essentially surjective.

\medskip\noindent
Consider the collection $\Xi$ of quasi-coherent sheaves of ideals
$\mathcal{K} \subset \mathcal{O}_X$ such that the statement holds
for every object $(\mathcal{F}_n)$ of
$\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})$
annihilated by $\mathcal{K}$. We want to show $(0)$ is in $\Xi$.
If not, then since $X$ is Noetherian there exists a maximal
quasi-coherent sheaf of ideals $\mathcal{K}$ not in $\Xi$, see
Cohomology of Spaces, Lemma \ref{spaces-cohomology-lemma-acc-coherent}.
After replacing $X$ by the closed subscheme of $X$
corresponding to $\mathcal{K}$ we may assume that every nonzero
$\mathcal{K}$ is in $\Xi$. Let $(\mathcal{F}_n)$ be an object of
$\textit{Coh}_{\text{support proper over }A}(X, \mathcal{I})$.
We will show that this object is in the essential image, thereby
completing the proof of the theorem.

\medskip\noindent
Apply Chow's lemma (Lemma \ref{lemma-chow-noetherian-separated})
to find a proper surjective morphism $f : Y \to X$ which is an isomorphism
over a dense open $U \subset X$ such that $Y$ is H-quasi-projective
over $A$. Note that $Y$ is a scheme and $f$ representable.
Choose an open immersion $j : Y \to Y'$ with $Y'$ projective over $A$, see
Morphisms, Lemma \ref{morphisms-lemma-H-quasi-projective-open-H-projective}.
Let $T_n$ be the scheme theoretic support of $\mathcal{F}_n$.
Note that $|T_n| = |T_1|$, hence $T_n$ is proper over $A$ for all $n$
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-image-proper-is-proper}).
Then $f^*\mathcal{F}_n$ is supported on the closed subscheme
$f^{-1}T_n$ which is proper over $A$ (by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-composition-proper}
and properness of $f$).
In particular, the composition $f^{-1}T_n \to Y \to Y'$ is closed
(Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}).
Let $T'_n \subset Y'$ be the corresponding closed subscheme;
it is contained in the open subscheme $Y$ and equal to $f^{-1}T_n$
as a closed subscheme of $Y$. Let $\mathcal{F}_n'$
be the coherent $\mathcal{O}_{Y'}$-module corresponding to
$f^*\mathcal{F}_n$ viewed as a coherent module on $Y'$ via
the closed immersion $f^{-1}T_n = T'_n \subset Y'$.
Then $(\mathcal{F}_n')$
is an object of $\textit{Coh}(Y', I\mathcal{O}_{Y'})$.
By the projective case of Grothendieck's existence theorem
(Cohomology of Schemes, Lemma \ref{coherent-lemma-existence-projective})
there exists a coherent $\mathcal{O}_{Y'}$-module
$\mathcal{F}'$ and an isomorphism
$(\mathcal{F}')^\wedge \cong (\mathcal{F}'_n)$ in
$\textit{Coh}(Y', I\mathcal{O}_{Y'})$.
Let $Z' \subset Y'$ be the scheme theoretic support of $\mathcal{F}'$.
Since $\mathcal{F}'/I\mathcal{F}' = \mathcal{F}'_1$ we see
that $Z' \cap V(I\mathcal{O}_{Y'}) = T'_1$ set-theoretically.
The structure morphism $p' : Y' \to \Spec(A)$ is proper, hence
$p'(Z' \cap (Y' \setminus Y))$ is closed in $\Spec(A)$.
If nonempty, then it would contain a point of $V(I)$
as $I$ is contained in the radical of $A$
(Algebra, Lemma \ref{algebra-lemma-radical-completion}).
But we've seen above that $Z' \cap (p')^{-1}V(I) = T'_1 \subset Y$
hence we conclude that $Z' \subset Y$. Thus $\mathcal{F}'|_Y$
is supported on a closed subscheme of $Y$ proper over $A$.

\medskip\noindent
Let $\mathcal{K}$ be the quasi-coherent sheaf of ideals cutting
out the reduced complement $X \setminus U$.
By Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-proper-pushforward-coherent}
the $\mathcal{O}_X$-module $\mathcal{H} = f_*\mathcal{F}'$ is coherent
and by Lemma \ref{lemma-inverse-systems-push-pull}
there exists a morphism $\alpha : (\mathcal{F}_n) \to \mathcal{H}^\wedge$
in the category $\textit{Coh}_{\text{support proper over } A}(X, \mathcal{I})$
whose kernel and cokernel are annihilated by a power of $\mathcal{K}$.
Let $Z_0 \subset X$ be the scheme theoretic support of $\mathcal{H}$.
It is clear that $|Z_0| \subset f(|Z'|)$. Hence
$Z_0 \to \Spec(A)$ is proper
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-image-proper-is-proper}).
Thus $\mathcal{H}$ is an object of 
$\textit{Coh}_{\text{support proper over } A}(\mathcal{O}_X)$.
Since each of the sheaves of ideals $\mathcal{K}^e$ is an element of
$\Xi$ we see that the assumptions of Lemma \ref{lemma-existence-tricky}
are satisfied and we conclude.
\end{proof}

\begin{remark}[Unwinding Grothendieck's existence theorem]
\label{remark-reformulate-existence-theorem}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Write $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$.
Let $X \to S$ be a morphism of algebraic spaces that is separated and
of finite type. For $n \geq 1$ we set $X_n = X \times_S S_n$.
Picture:
$$
\xymatrix{
X_1 \ar[r]_{i_1} \ar[d] & X_2 \ar[r]_{i_2} \ar[d] & X_3 \ar[r] \ar[d] &
\ldots & X \ar[d] \\
S_1 \ar[r] & S_2 \ar[r] & S_3 \ar[r] & \ldots & S
}
$$
In this situation we consider systems $(\mathcal{F}_n, \varphi_n)$
where
\begin{enumerate}
\item $\mathcal{F}_n$ is a coherent $\mathcal{O}_{X_n}$-module,
\item $\varphi_n : i_n^*\mathcal{F}_{n + 1} \to \mathcal{F}_n$
is an isomorphism, and
\item $\text{Supp}(\mathcal{F}_1)$ is proper over $S_1$.
\end{enumerate}
Theorem \ref{theorem-grothendieck-existence} says that the
completion functor
$$
\begin{matrix}
\text{coherent }\mathcal{O}_X\text{-modules }\mathcal{F} \\
\text{with support proper over }A
\end{matrix}
\quad
\longrightarrow
\quad
\begin{matrix}
\text{systems }(\mathcal{F}_n) \\
\text{as above}
\end{matrix}
$$
is an equivalence of categories. In the special case that $X$ is
proper over $A$ we can omit the conditions on the supports.
\end{remark}







\section{Grothendieck's algebraization theorem}
\label{section-algebraization}

\noindent
This section is the analogue of
Cohomology of Schemes, Section \ref{coherent-section-algebraization}.
However, this section is missing the result on algebraization of deformations
of proper algebraic spaces endowed with ample invertible sheaves, as a
proper algebraic space which comes with an ample invertible sheaf is
a scheme. Our first result is a translation of Grothendieck's existence
theorem in terms of closed subschemes and finite morphisms.

\begin{lemma}
\label{lemma-algebraize-formal-closed-subscheme}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Write $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$.
Let $X \to S$ be a morphism of algebraic spaces that is separated
and of finite type.
For $n \geq 1$ we set $X_n = X \times_S S_n$.
Suppose given a commutative diagram
$$
\xymatrix{
Z_1 \ar[r] \ar[d] & Z_2 \ar[r] \ar[d] & Z_3 \ar[r] \ar[d] & \ldots \\
X_1 \ar[r]^{i_1} & X_2 \ar[r]^{i_2} & X_3 \ar[r] & \ldots
}
$$
of algebraic spaces with cartesian squares. Assume that
\begin{enumerate}
\item $Z_1 \to X_1$ is a closed immersion, and
\item $Z_1 \to S_1$ is proper.
\end{enumerate}
Then there exists a closed immersion of algebraic spaces $Z \to X$ such that
$Z_n = Z \times_S S_n$ for all $n \geq 1$. Moreover, $Z$ is proper over $S$.
\end{lemma}

\begin{proof}
Let's write $j_n : Z_n \to X_n$ for the vertical morphisms.
As the squares in the statement are cartesian
we see that the base change of $j_n$ to $X_1$ is $j_1$.
Thus Limits of Spaces, Lemma
\ref{spaces-limits-lemma-check-closed-infinitesimally}
shows that $j_n$ is a closed immersion.
Set $\mathcal{F}_n = j_{n, *}\mathcal{O}_{Z_n}$, so that
$j_n^\sharp$ is a surjection $\mathcal{O}_{X_n} \to \mathcal{F}_n$.
Again using that the squares are cartesian we see that
the pullback of $\mathcal{F}_{n + 1}$ to $X_n$ is $\mathcal{F}_n$.
Hence Grothendieck's existence theorem, as reformulated in
Remark \ref{remark-reformulate-existence-theorem},
tells us there exists a map
$\mathcal{O}_X \to \mathcal{F}$
of coherent $\mathcal{O}_X$-modules whose restriction to
$X_n$ recovers $\mathcal{O}_{X_n} \to \mathcal{F}_n$.
Moreover, the support of $\mathcal{F}$ is proper over $S$.
As the completion functor is exact (Lemma \ref{lemma-exact})
we see that $\mathcal{O}_X \to \mathcal{F}$
is surjective. Thus $\mathcal{F} = \mathcal{O}_X/\mathcal{J}$
for some quasi-coherent sheaf of ideals $\mathcal{J}$.
Setting $Z = V(\mathcal{J})$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-formal-algebraic-space-finite-over-proper}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Write $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$.
Let $X \to S$ be a morphism of algebraic spaces that is separated
and of finite type.
For $n \geq 1$ we set $X_n = X \times_S S_n$.
Suppose given a commutative diagram
$$
\xymatrix{
Y_1 \ar[r] \ar[d] & Y_2 \ar[r] \ar[d] & Y_3 \ar[r] \ar[d] & \ldots \\
X_1 \ar[r]^{i_1} & X_2 \ar[r]^{i_2} & X_3 \ar[r] & \ldots
}
$$
of algebraic spaces with cartesian squares. Assume that
\begin{enumerate}
\item $Y_1 \to X_1$ is a finite morphism, and
\item $Y_1 \to S_1$ is proper.
\end{enumerate}
Then there exists a finite morphism of algebraic spaces $Y \to X$ such that
$Y_n = Y \times_S S_n$ for all $n \geq 1$. Moreover, $Y$ is proper over $S$.
\end{lemma}

\begin{proof}
Let's write $f_n : Y_n \to X_n$ for the vertical morphisms.
As the squares in the statement are cartesian
we see that the base change of $f_n$ to $X_1$ is $f_1$.
Thus Lemma \ref{lemma-thicken-property-morphisms-cartesian}
shows that $f_n$ is a finite morphism.
Set $\mathcal{F}_n = f_{n, *}\mathcal{O}_{Y_n}$.
Using that the squares are cartesian we see that
the pullback of $\mathcal{F}_{n + 1}$ to $X_n$ is $\mathcal{F}_n$.
Hence Grothendieck's existence theorem, as reformulated in
Remark \ref{remark-reformulate-existence-theorem},
tells us there exists a coherent $\mathcal{O}_X$-module $\mathcal{F}$
whose restriction to $X_n$ recovers $\mathcal{F}_n$.
Moreover, the support of $\mathcal{F}$ is proper over $S$.
As the completion functor is fuly faithful
(Theorem \ref{theorem-grothendieck-existence})
we see that the multiplication maps
$\mathcal{F}_n \otimes_{\mathcal{O}_{X_n}} \mathcal{F}_n \to
\mathcal{F}_n$ fit together to give an algebra structure on $\mathcal{F}$.
Setting $Y = \underline{\Spec}_X(\mathcal{F})$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-morphism}
Let $A$ be a Noetherian ring complete with respect to an ideal $I$.
Write $S = \Spec(A)$ and $S_n = \Spec(A/I^n)$. Let $X$, $Y$ be algebraic
spaces over $S$. For $n \geq 1$ we set $X_n = X \times_S S_n$ and
$Y_n = Y \times_S S_n$. Suppose given a compatible system of
commutative diagrams
$$
\xymatrix{
& & X_{n + 1} \ar[rd] \ar[rr]_{g_{n + 1}} & & Y_{n + 1} \ar[ld] \\
X_n \ar[rru] \ar[rd] \ar[rr]_{g_n} & & Y_n \ar[rru] \ar[ld] & S_{n + 1} \\
& S_n \ar[rru]
}
$$
Assume that
\begin{enumerate}
\item $X \to S$ is proper, and
\item $Y \to S$ is separated of finite type.
\end{enumerate}
Then there exists a unique morphism of algebraic spaces $g : X \to Y$
over $S$ such that $g_n$ is the base change of $g$ to $S_n$.
\end{lemma}

\begin{proof}
The morphisms $(1, g_n) : X_n \to X_n \times_S Y_n$ are closed immersions
because $Y_n \to S_n$ is separated
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-section-immersion}).
Thus by Lemma \ref{lemma-algebraize-formal-closed-subscheme}
there exists a closed subspace $Z \subset X \times_S Y$
proper over $S$ whose base change to $S_n$ recovers
$X_n \subset X_n \times_S Y_n$. The first projection $p : Z \to X$
is a proper morphism (as $Z$ is proper over $S$, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-permanence})
whose base change to $S_n$ is an isomorphism for all $n$.
In particular, $p : Z \to X$ is quasi-finite on an open subspace
of $Z$ containing every point of $Z_0$ for example by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part}.
As $Z$ is proper over $S$ this open neighbourhood is all of $Z$.
We conclude that $p : Z \to X$ is finite by Zariski's main theorem
(for example apply
Lemma \ref{lemma-quasi-finite-separated-pass-through-finite}
and use properness of $Z$ over $X$ to see that the immersion is
a closed immersion). Applying the equivalence of
Theorem \ref{theorem-grothendieck-existence}
we see that $p_*\mathcal{O}_Z = \mathcal{O}_X$ as this is true
modulo $I^n$ for all $n$. Hence $p$ is an isomorphism and we obtain
the morphism $g$ as the composition $X \cong Z \to Y$.
We omit the proof of uniqueness.
\end{proof}










\section{Regular immersions}
\label{section-regular-immersions}

\noindent
This section is the analogue of
Divisors, Section \ref{divisors-section-regular-immersions}
for morphisms of algebraic spaces. The reader is encouraged to read up
on regular immersions of schemes in that section first.

\medskip\noindent
In
Divisors, Section \ref{divisors-section-regular-immersions}
we defined four types of regular immersions for morphisms of schemes.
Of these only three are (as far as we know) local on the target for
the \'etale topology; as usual plain old regular immersions aren't.
This is why for morphisms of algebraic spaces we cannot actually define
regular immersions. (These kinds of annoyances prompted Grothendieck
and his school to replace original notion of a regular immersion by a
Koszul-regular immersions, see
\cite[Exposee VII, Definition 1.4]{SGA6}.)
But we can define Koszul-regular, $H_1$-regular, and quasi-regular immersions.
Another remark is that since Koszul-regular immersions are not preserved by
arbitrary base change, we cannot use the strategy of
Morphisms of Spaces, Section \ref{spaces-morphisms-section-representable}
to define them. Similarly, as Koszul-regular immersions are not \'etale local
on the source, we cannot use
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-local-source-target}
to define them either. We replace this lemma instead by the
following.

\begin{lemma}
\label{lemma-representable-etale-local-target}
Let $\mathcal{P}$ be a property of morphisms of schemes which is \'etale
local on the target. Let $S$ be a scheme.
Let $f : X \to Y$ be a representable morphism of algebraic spaces over $S$.
Consider commutative diagrams
$$
\xymatrix{
X \times_Y V \ar[d] \ar[r] & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $V$ is a scheme and $V \to Y$ is \'etale.
The following are equivalent
\begin{enumerate}
\item for any diagram as above the projection $X \times_Y V \to V$
has property $\mathcal{P}$, and
\item for some diagram as above with $V \to Y$ surjective
the projection $X \times_Y V \to V$ has property $\mathcal{P}$.
\end{enumerate}
If $X$ and $Y$ are representable, then this is also equivalent to
$f$ (as a morphism of schemes) having property $\mathcal{P}$.
\end{lemma}

\begin{proof}
Let us prove the equivalence of (1) and (2).
The implication (1) $\Rightarrow$ (2) is immediate.
Assume
$$
\xymatrix{
X \times_Y V \ar[d] \ar[r] & V \ar[d] \\
X \ar[r]^f & Y
}
\quad\quad
\xymatrix{
X \times_Y V' \ar[d] \ar[r] & V' \ar[d] \\
X \ar[r]^f & Y
}
$$
are two diagrams as in the lemma. Assume $V \to Y$ is
surjective and $X \times_Y V \to V$ has property $\mathcal{P}$.
To show that (2) implies (1) we have to prove that
$X \times_Y V' \to V'$ has $\mathcal{P}$. To do
this consider the diagram
$$
\xymatrix{
X \times_Y V \ar[d] &
(X \times_Y V) \times_X (X \times_Y V') \ar[l] \ar[d] \ar[r] &
X \times_Y V' \ar[d] \\
V &
V \times_Y V' \ar[l] \ar[r] &
V'
}
$$
By our assumption that $\mathcal{P}$ is \'etale local on the source,
we see that $\mathcal{P}$ is preserved under \'etale base change, see
Descent, Lemma \ref{descent-lemma-pullback-property-local-target}.
Hence if the left vertical arrow has $\mathcal{P}$ the so does
the middle vertical arrow. Since $U \times_X U' \to U'$ is surjective
and \'etale (hence defines an \'etale covering of $U'$)
this implies (as $\mathcal{P}$ is assumed local for the \'etale topology
on the target) that the left vertical arrow has $\mathcal{P}$.

\medskip\noindent
If $X$ and $Y$ are representable, then we can take
$\text{id}_Y : Y \to Y$ as our \'etale covering to see the
final statement of the lemma is true.
\end{proof}

\noindent
Note that ``being a Koszul-regular (resp.\ $H_1$-regular, resp.\ quasi-regular)
immersion'' is a property of morphisms of schemes which is fpqc local on the
target, see
Descent, Lemma \ref{descent-lemma-descending-property-regular-immersion}.
Hence the following definition now makes sense.

\begin{definition}
\label{definition-regular-immersion}
Let $S$ be a scheme. Let $i : X \to Y$ be a morphism of algebraic
spaces over $S$.
\begin{enumerate}
\item We say $i$ is a {\it Koszul-regular immersion} if $i$ is representable
and the equivalent conditions of
Lemma \ref{lemma-representable-etale-local-target}
hold with $\mathcal{P}(f) =$``$f$ is a Koszul-regular immersion''.
\item We say $i$ is an {\it $H_1$-regular immersion} if $i$ is representable
and the equivalent conditions of
Lemma \ref{lemma-representable-etale-local-target}
hold with $\mathcal{P}(f) =$``$f$ is an $H_1$-regular immersion''.
\item We say $i$ is a {\it quasi-regular immersion} if $i$ is representable
and the equivalent conditions of
Lemma \ref{lemma-representable-etale-local-target}
hold with $\mathcal{P}(f) =$``$f$ is a quasi-regular immersion''.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-regular-quasi-regular-immersion}
Let $S$ be a scheme.
Let $i : Z \to X$ be an immersion of algebraic spaces over $S$.
We have the following implications:
$i$ is Koszul-regular $\Rightarrow$
$i$ is $H_1$-regular $\Rightarrow$
$i$ is quasi-regular.
\end{lemma}

\begin{proof}
Via the definition this lemma immediately reduces to
Divisors, Lemma \ref{divisors-lemma-regular-quasi-regular-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-regular-immersion-noetherian}
Let $S$ be a scheme.
Let $i : Z \to X$ be an immersion of algebraic spaces over $S$.
Assume $X$ is locally Noetherian. Then
$i$ is Koszul-regular $\Leftrightarrow$
$i$ is $H_1$-regular $\Leftrightarrow$
$i$ is quasi-regular.
\end{lemma}

\begin{proof}
Via Definition \ref{definition-regular-immersion}
(and the definition of a locally Noetherian algebraic space
in Properties of Spaces, Section
\ref{spaces-properties-section-types-properties})
this immediately translates to the case of schemes which is
Divisors, Lemma \ref{divisors-lemma-regular-immersion-noetherian}.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change-regular-immersion}
\begin{slogan}
Regular immersions are stable under flat base change.
\end{slogan}
Let $S$ be a scheme. Let $i : Z \to X$ be a Koszul-regular,
$H_1$-regular, or quasi-regular immersion of algebraic spaces over $S$.
Let $X' \to X$ be a flat morphism of algebraic spaces over $S$.
Then the base change $i' : Z \times_X X' \to X'$ is a Koszul-regular,
$H_1$-regular, or quasi-regular immersion.
\end{lemma}

\begin{proof}
Via Definition \ref{definition-regular-immersion}
(and the definition of a flat morphism of algebraic spaces
in Morphisms of Spaces, Section
\ref{spaces-morphisms-section-flat})
this lemma reduces to the case of schemes, see
Divisors, Lemma \ref{divisors-lemma-flat-base-change-regular-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-regular-immersion}
Let $S$ be a scheme. Let $i : Z \to X$ be an immersion of algebraic spaces
over $S$. Then $i$ is a quasi-regular immersion if and only if the following
conditions are satisfied
\begin{enumerate}
\item $i$ is locally of finite presentation,
\item the conormal sheaf $\mathcal{C}_{Z/X}$ is finite locally free, and
\item the map (\ref{equation-conormal-algebra-quotient}) is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the case of schemes
(Divisors, Lemma \ref{divisors-lemma-quasi-regular-immersion})
via \'etale localization (use Definition \ref{definition-regular-immersion}
and
Lemma \ref{lemma-etale-conormal-algebra}).
\end{proof}

\begin{lemma}
\label{lemma-transitivity-conormal-quasi-regular}
Let $S$ be a scheme. Let $Z \to Y \to X$ be immersions of algebraic spaces
over $S$. Assume that $Z \to Y$ is $H_1$-regular. Then the canonical
sequence of Lemma \ref{lemma-transitivity-conormal}
$$
0 \to i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
is exact and (\'etale) locally split.
\end{lemma}

\begin{proof}
Since $\mathcal{C}_{Z/Y}$ is finite locally free (see
Lemma \ref{lemma-quasi-regular-immersion}
and
Lemma \ref{lemma-regular-quasi-regular-immersion})
it suffices to prove that the sequence is exact.
It suffices to show that the first map is injective
as the sequence is already right exact in general.
After \'etale localization on $X$ this reduces to the case
of schemes, see
Divisors, Lemma \ref{divisors-lemma-transitivity-conormal-quasi-regular}.
\end{proof}

\noindent
A composition of quasi-regular immersions may not be quasi-regular, see
Algebra, Remark \ref{algebra-remark-join-quasi-regular-sequences}.
The other types of regular immersions are preserved under composition.

\begin{lemma}
\label{lemma-composition-regular-immersion}
Let $S$ be a scheme. Let $i : Z \to Y$ and $j : Y \to X$ be immersions of
algebraic spaces over $S$.
\begin{enumerate}
\item If $i$ and $j$ are Koszul-regular immersions, so is $j \circ i$.
\item If $i$ and $j$ are $H_1$-regular immersions, so is $j \circ i$.
\item If $i$ is an $H_1$-regular immersion and $j$ is a quasi-regular
immersion, then $j \circ i$ is a quasi-regular immersion.
\end{enumerate}
\end{lemma}

\begin{proof}
Immediate from the case of schemes, see
Divisors, Lemma \ref{divisors-lemma-composition-regular-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-permanence-regular-immersion}
Let $S$ be a scheme. Let $i : Z \to Y$ and $j : Y \to X$ be immersions of
algebraic spaces over $S$. Assume that the sequence
$$
0 \to i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
of Lemma \ref{lemma-transitivity-conormal} is exact and locally split.
\begin{enumerate}
\item If $j \circ i$ is a quasi-regular immersion, so is $i$.
\item If $j \circ i$ is a $H_1$-regular immersion, so is $i$.
\item If both $j$ and $j \circ i$ are Koszul-regular immersions, so is $i$.
\end{enumerate}
\end{lemma}

\begin{proof}
Immediate from the case of schemes, see
Divisors, Lemma \ref{divisors-lemma-permanence-regular-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-extra-permanence-regular-immersion-noetherian}
Let $S$ be a scheme. Let $i : Z \to Y$ and $j : Y \to X$ be immersions of
algebraic spaces over $S$. Assume $X$ is locally Noetherian.
The following are equivalent
\begin{enumerate}
\item $i$ and $j$ are Koszul regular immersions,
\item $i$ and $j \circ i$ are Koszul regular immersions,
\item $j \circ i$ is a Koszul regular immersion and the conormal sequence
$$
0 \to i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
is exact and locally split.
\end{enumerate}
\end{lemma}

\begin{proof}
Immediate from the case of schemes, see Divisors, Lemma
\ref{divisors-lemma-extra-permanence-regular-immersion-noetherian}.
\end{proof}















\section{Pseudo-coherent morphisms}
\label{section-pseudo-coherent}

\noindent
This section is the analogue of
More on Morphisms, Section \ref{more-morphisms-section-pseudo-coherent}
for morphisms of schemes. The reader is encouraged to read up
on pseudo-coherent morphisms of schemes in that section first.

\medskip\noindent
The property ``pseudo-coherent'' of morphisms of schemes is
\'etale local on the source-and-target. To see this use
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-descending-property-pseudo-coherent} and
\ref{more-morphisms-lemma-pseudo-coherent-fppf-local-source}
and
Descent, Lemma \ref{descent-lemma-etale-local-source-target}.
By
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-local-source-target}
we may define the notion of a pseudo-coherent morphism of algebraic spaces as
follows and it agrees with the already existing notion defined in
More on Morphisms, Section \ref{more-morphisms-section-pseudo-coherent}
when the algebraic spaces in question are representable.

\begin{definition}
\label{definition-pseudo-coherent}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
\begin{enumerate}
\item We say $f$ is {\it pseudo-coherent} if the equivalent conditions of
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-local-source-target}
hold with $\mathcal{P} =$``pseudo-coherent''.
\item Let $x \in |X|$. We say $f$ is {\it pseudo-coherent at $x$} if
there exists an open neighbourhood $X' \subset X$ of $x$ such
that $f|_{X'} : X' \to Y$ is pseudo-coherent.
\end{enumerate}
\end{definition}

\noindent
Beware that a base change of a pseudo-coherent morphism is not
pseudo-coherent in general.

\begin{lemma}
\label{lemma-flat-base-change-pseudo-coherent}
A flat base change of a pseudo-coherent morphism is pseudo-coherent.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-flat-base-change-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-composition-pseudo-coherent}
A composition of pseudo-coherent morphisms is pseudo-coherent.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-composition-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-pseudo-coherent-finite-presentation}
A pseudo-coherent morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
Immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-pseudo-coherent}
A flat morphism which is locally of finite presentation is pseudo-coherent.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-flat-finite-presentation-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-permanence-pseudo-coherent}
Let $f : X \to Y$ be a morphism of algebraic spaces pseudo-coherent
over a base algebraic space $B$. Then $f$ is pseudo-coherent.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-permanence-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-pseudo-coherent}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. If $Y$ is locally Noetherian, then $f$ is pseudo-coherent if
and only if $f$ is locally of finite type.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-Noetherian-pseudo-coherent}.
\end{proof}








\section{Perfect morphisms}
\label{section-perfect}

\noindent
This section is the analogue of
More on Morphisms, Section \ref{more-morphisms-section-perfect}
for morphisms of schemes. The reader is encouraged to read up
on perfect morphisms of schemes in that section first.

\medskip\noindent
The property ``perfect'' of morphisms of schemes is
\'etale local on the source-and-target. To see this use
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-descending-property-perfect} and
\ref{more-morphisms-lemma-perfect-fppf-local-source}
and
Descent, Lemma \ref{descent-lemma-etale-local-source-target}.
By
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-local-source-target}
we may define the notion of a perfect morphism of algebraic spaces as
follows and it agrees with the already existing notion defined in
More on Morphisms, Section \ref{more-morphisms-section-perfect}
when the algebraic spaces in question are representable.

\begin{definition}
\label{definition-perfect}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
\begin{enumerate}
\item We say $f$ is {\it perfect} if the equivalent conditions of
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-local-source-target}
hold with $\mathcal{P} =$``perfect''.
\item Let $x \in |X|$. We say $f$ is {\it perfect at $x$} if
there exists an open neighbourhood $X' \subset X$ of $x$ such
that $f|_{X'} : X' \to Y$ is perfect.
\end{enumerate}
\end{definition}

\noindent
Note that a perfect morphism is pseudo-coherent, hence locally of finite
presentation. Beware that a base change of a perfect morphism is not perfect
in general.

\begin{lemma}
\label{lemma-flat-base-change-perfect}
A flat base change of a perfect morphism is perfect.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-flat-base-change-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-composition-perfect}
A composition of perfect morphisms is perfect.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-composition-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-perfect}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces over
$S$. The following are equivalent
\begin{enumerate}
\item $f$ is flat and perfect, and
\item $f$ is flat and locally of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-flat-finite-presentation-perfect}.
\end{proof}









\section{Local complete intersection morphisms}
\label{section-lci}

\noindent
This section is the analogue of
More on Morphisms, Section \ref{more-morphisms-section-lci}
for morphisms of schemes. The reader is encouraged to read up
on local complete intersection morphisms of schemes in that section first.

\medskip\noindent
The property ``being a local complete intersection morphism'' of morphisms
of schemes is \'etale local on the source-and-target. To see this use
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-descending-property-lci} and
\ref{more-morphisms-lemma-lci-syntomic-local-source}
and
Descent, Lemma \ref{descent-lemma-etale-local-source-target}.
By
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-local-source-target}
we may define the notion of a local complete intersection morphism
of algebraic spaces as follows and it agrees with the already existing
notion defined in
More on Morphisms, Section \ref{more-morphisms-section-lci}
when the algebraic spaces in question are representable.

\begin{definition}
\label{definition-lci}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
\begin{enumerate}
\item We say $f$ is a {\it Koszul morphism}, or that $f$ is a
{\it local complete intersection morphism} if the equivalent conditions of
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-local-source-target}
hold with $\mathcal{P}(f) =$``$f$ is a local complete intersection morphism''.
\item Let $x \in |X|$. We say $f$ is {\it Koszul at $x$} if
there exists an open neighbourhood $X' \subset X$ of $x$ such
that $f|_{X'} : X' \to Y$ is a local complete intersection morphism.
\end{enumerate}
\end{definition}

\noindent
In some sense the defining property of a local complete intersection
morphism is the result of the following lemma.

\begin{lemma}
\label{lemma-lci}
Let $S$ be a scheme.
Let $f : X \to Y$ be a local complete intersection morphism
of algebraic spaces over $S$.
Let $P$ be an algebraic space smooth over $Y$.
Let $U \to X$ be an \'etale morphism of algebraic spaces
and let $i : U \to P$ an immersion of algebraic spaces over $Y$.
Picture:
$$
\xymatrix{
X \ar[rd] & U \ar[l] \ar[d] \ar[r]_i & P \ar[ld] \\
& Y
}
$$
Then $i$ is a Koszul-regular immersion of algebraic spaces.
\end{lemma}

\begin{proof}
Choose a scheme $V$ and a surjective \'etale morphism $V \to Y$.
Choose a scheme $W$ and a surjective \'etale morphism $W \to P \times_Y V$.
Set $U' = U \times_P W$, which is a scheme \'etale over $U$.
We have to show that $U' \to W$ is a Koszul-regular immersion of
schemes, see
Definition \ref{definition-regular-immersion}.
By
Definition \ref{definition-lci}
above the morphism of schemes $U' \to V$ is a local complete intersection
morphism. Hence the result follows from
More on Morphisms, Lemma \ref{more-morphisms-lemma-lci}.
\end{proof}

\noindent
It seems like a good idea to collect here some properties in common
with all Koszul morphisms.

\begin{lemma}
\label{lemma-lci-properties}
Let $S$ be a scheme. Let $f : X \to Y$ be a local complete intersection
morphism of algebraic spaces over $S$. Then
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $f$ is pseudo-coherent, and
\item $f$ is perfect.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-lci-properties}.
\end{proof}

\noindent
Beware that a base change of a Koszul morphism is not Koszul in general.

\begin{lemma}
\label{lemma-flat-base-change-lci}
A flat base change of a local complete intersection morphism is a
local complete intersection morphism.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-flat-base-change-lci}.
\end{proof}

\begin{lemma}
\label{lemma-composition-lci}
A composition of local complete intersection morphisms is a
local complete intersection morphism.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-composition-lci}.
\end{proof}

\begin{lemma}
\label{lemma-flat-lci}
\begin{slogan}
Syntomic equals flat plus lci (for algebraic spaces).
\end{slogan}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent
\begin{enumerate}
\item $f$ is flat and a local complete intersection morphism, and
\item $f$ is syntomic.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Use the schemes version of this lemma, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-flat-lci}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-lci-fibres}
Let $S$ be a scheme. Consider a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces over $S$. Assume that both $p$ and $q$
are flat and locally of finite presentation.
Then there exists an open subspace $U(f) \subset X$
such that $|U(f)| \subset |X|$ is the set of points where $f$ is Koszul.
Moreover, for any morphism of algebraic spaces $Z' \to Z$, if
$f' : X' \to Y'$ is the base change of $f$ by $Z' \to Z$, then
$U(f')$ is the inverse image of $U(f)$ under the projection $X' \to X$.
\end{lemma}

\begin{proof}
This lemma is the analogue of
More on Morphisms, Lemma \ref{more-morphisms-lemma-base-change-lci-fibres}
and in fact we will deduce the lemma from it. By
Definition \ref{definition-lci}
the set $\{x \in |X| : f \text{ is Koszul at }x\}$ is
open in $|X|$ hence by
Properties of Spaces, Lemma \ref{spaces-properties-lemma-open-subspaces}
it corresponds to an open subspace $U(f)$ of $X$. Hence we only need to
prove the final statement.

\medskip\noindent
Choose a scheme $W$ and a surjective \'etale morphism $W \to Z$.
Choose a scheme $V$ and a surjective \'etale morphism $V \to W \times_Z Y$.
Choose a scheme $U$ and a surjective \'etale morphism $U \to V \times_Y X$.
Finally, choose a scheme $W'$ and a surjective \'etale morphism
$W' \to W \times_Z Z'$.
Set $V' = W' \times_W V$ and $U' = W' \times_W U$, so that we obtain
surjective \'etale morphisms $V' \to Y'$ and $U' \to X'$.
We will use without further mention an \'etale morphism of algebraic spaces
induces an open map of associated topological spaces (see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-etale-open}).
Note that by definition $U(f)$ is the image in $|X|$ of the set $T$
of points in $U$ where the morphism of schemes $U \to V$ is Koszul.
Similarly, $U(f')$ is the image in $|X'|$ of the set $T'$ of points in
$U'$ where the morphism of schemes $U' \to V'$ is Koszul. Now, by construction
the diagram
$$
\xymatrix{
U' \ar[r] \ar[d] & U \ar[d] \\
V' \ar[r] & V
}
$$
is cartesian (in the category of schemes). Hence the aforementioned
More on Morphisms, Lemma \ref{more-morphisms-lemma-base-change-lci-fibres}
applies to show that $T'$ is the inverse image of $T$. Since
$|U'| \to |X'|$ is surjective this implies the lemma.
\end{proof}

\begin{lemma}
\label{lemma-unramified-lci}
Let $S$ be a scheme. Let $f : X \to Y$ be a local complete intersection
morphism of algebraic spaces over $S$. Then $f$ is unramified if and only
if $f$ is formally unramified and in this case the conormal sheaf
$\mathcal{C}_{X/Y}$ is finite locally free on $X$.
\end{lemma}

\begin{proof}
This follows from the corresponding result for morphisms of schemes, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-unramified-lci},
by \'etale localization, see
Lemma \ref{lemma-universal-thickening-localize}.
(Note that in the situation of this lemma the morphism $V \to U$
is unramified and a local complete intersection morphism by definition.)
\end{proof}

\begin{lemma}
\label{lemma-transitivity-conormal-lci}
Let $S$ be a scheme. Let $Z \to Y \to X$ be formally unramified morphisms
of algebraic spaces over $S$. Assume that $Z \to Y$ is a local complete
intersection morphism. The exact sequence
$$
0 \to i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
of
Lemma \ref{lemma-transitivity-conormal}
is short exact.
\end{lemma}

\begin{proof}
Choose a scheme $U$ and a surjective \'etale morphism $U \to X$.
Choose a scheme $V$ and a surjective \'etale morphism $V \to U \times_X Y$.
Choose a scheme $W$ and a surjective \'etale morphism $W \to V \times_Y Z$.
By
Lemma \ref{lemma-universal-thickening-localize}
the morphisms $W \to V$ and $V \to U$ are formally unramified.
Moreover the sequence
$i^*\mathcal{C}_{Y/X} \to \mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Y} \to 0$
restricts to the corresponding sequence
$i^*\mathcal{C}_{V/U} \to \mathcal{C}_{W/U} \to \mathcal{C}_{W/V} \to 0$
for $W \to V \to U$. Hence the result follows from the result for schemes
(More on Morphisms, Lemma \ref{more-morphisms-lemma-transitivity-conormal-lci})
as by definition the morphism $W \to V$ is a local complete intersection
morphism.
\end{proof}









\section{When is a morphism an isomorphism?}
\label{section-when-isomorphism}

\noindent
More generally we can ask:
``When does a morphism have property $\mathcal{P}$?''
A more precise question is the following. Suppose given a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces. Does there exist a monomorphism of algebraic spaces
$W \to Z$ with the following two properties:
\begin{enumerate}
\item the base change $f_W : X_W \to Y_W$ has property $\mathcal{P}$, and
\item any morphism $Z' \to Z$ of algebraic spaces factors through $W$ if
and only if the base change $f_{Z'} : X_{Z'} \to Y_{Z'}$ has property
$\mathcal{P}$.
\end{enumerate}
In many cases, if $W \to Z$ exists, then it is an immersion, open immersion,
or closed immersion.

\medskip\noindent
The answer to this question may depend on auxiliary properties of the
morphisms $f$, $p$, and $q$. An example is $\mathcal{P}(f) =$``$f$ is flat''
which we have discussed for morphisms of schemes in the case $Y = S$ in
great detail in the chapter ``More on Flatness'', starting with
More on Flatness, Section \ref{flat-section-flattening-functors}.

\begin{lemma}
\label{lemma-where-unramified}
Consider a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces. Assume that $p$ is locally of finite type and closed.
Then there exists an open subspace $W \subset Z$
such that a morphism $Z' \to Z$ factors through $W$ if and only if the
base change $f_{Z'} : X_{Z'} \to Y_{Z'}$ is unramified.
\end{lemma}

\begin{proof}
By
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-where-unramified}
there exists an open subspace $U(f) \subset X$ which is the set of
points where $f$ is unramified. Moreover, formation of $U(f)$ commutes
with arbitrary base change. Let $W \subset Z$ be the open subspace
(see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-open-subspaces})
with underlying set of points
$$
|W| = |Z| \setminus |p|\left(|X| \setminus |U(f)|\right)
$$
i.e., $z \in |Z|$ is a point of $W$ if and only if $f$ is unramified
at every point of $X$ above $z$. Note that this is open because we
assumed that $p$ is closed. Since the formation of $U(f)$
commutes with arbitrary base change we immediately see (using
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-factor-through-open-subspace})
that $W$ has the desired universal property.
\end{proof}

\begin{lemma}
\label{lemma-where-unramified-universally-injective}
Consider a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces. Assume that
\begin{enumerate}
\item $p$ is locally of finite type,
\item $p$ is closed, and
\item $p_2 : X \times_Y X \to Z$ is closed.
\end{enumerate}
Then there exists an open subspace $W \subset Z$
such that a morphism $Z' \to Z$ factors through $W$ if and only if the
base change $f_{Z'} : X_{Z'} \to Y_{Z'}$ is unramified and universally
injective.
\end{lemma}

\begin{proof}
After replacing $Z$ by the open subspace found in
Lemma \ref{lemma-where-unramified}
we may assume that $f$ is already unramified; note that this does not
destroy assumption (2) or (3). By
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-diagonal-unramified-morphism}
we see that $\Delta_{X/Y} : X \to X \times_Y X$ is an open immersion.
This remains true after any base change. Hence by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-injective}
we see that $f_{Z'}$ is universally injective if and only if
the base change of the diagonal $X_{Z'} \to (X \times_Y X)_{Z'}$
is an isomorphism. Let $W \subset Z$ be the open subspace
(see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-open-subspaces})
with underlying set of points
$$
|W| = |Z| \setminus
|p_2|\left(|X \times_Y X| \setminus \Im(|\Delta_{X/Y}|)\right)
$$
i.e., $z \in |Z|$ is a point of $W$ if and only if the fibre of
$|X \times_Y X| \to |Z|$ over $z$ is in the image of
$|X| \to |X \times_Y X|$. Then it is clear from the discussion above
that the restriction $p^{-1}(W) \to q^{-1}(W)$ of $f$ is
unramified and universally injective.

\medskip\noindent
Conversely, suppose that $f_{Z'}$ is unramified and universally injective.
In order to show that $Z' \to Z$ factors through $W$ it suffices to show
that $|Z'| \to |Z|$ has image contained in $|W|$, see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-factor-through-open-subspace}.
Hence it suffices to prove the result when $Z'$ is the spectrum of a field.
Denote $z \in |Z|$ the image of $|Z'| \to |Z|$. The discussion above shows
that
$$
|X_{Z'}| \longrightarrow |(X \times_Y X)_{Z'}|
$$
is surjective. By
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-points-cartesian}
in the commutative diagram
$$
\xymatrix{
|X_{Z'}| \ar[d] \ar[r] &
|(X \times_Y X)_{Z'}| \ar[d] \\
|p|^{-1}(\{z\}) \ar[r] &
|p_2|^{-1}(\{z\})
}
$$
the vertical arrows are surjective. It follows that $z \in |W|$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-where-closed-immersion}
Consider a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces. Assume that
\begin{enumerate}
\item $p$ is locally of finite type,
\item $p$ is universally closed, and
\item $q : Y \to Z$ is separated.
\end{enumerate}
Then there exists an open subspace $W \subset Z$
such that a morphism $Z' \to Z$ factors through $W$ if and only if the
base change $f_{Z'} : X_{Z'} \to Y_{Z'}$ is a closed immersion.
\end{lemma}

\begin{proof}
We will use the characterization of closed immersions as
universally closed, unramified, and universally injective morphisms, see
Lemma \ref{lemma-characterize-closed-immersion}.
First, note that since $p$ is universally closed and $q$ is
separated, we see that $f$ is universally closed, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-permanence}.
It follows that any base change of $f$ is universally closed, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-base-change-universally-closed}.
Thus to finish the proof of the lemma it suffices to prove that
the assumptions of
Lemma \ref{lemma-where-unramified-universally-injective}
are satisfied. The projection $\text{pr}_0 : X \times_Y X \to X$
is universally closed as a base change of $f$, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-base-change-universally-closed}.
Hence $X \times_Y X \to Z$ is universally closed as
a composition of universally closed morphisms (see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-composition-universally-closed}).
This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-where-flat}
Consider a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces. Assume that
\begin{enumerate}
\item $p$ is locally of finite presentation,
\item $p$ is flat,
\item $p$ is closed, and
\item $q$ is locally of finite type.
\end{enumerate}
Then there exists an open subspace $W \subset Z$
such that a morphism $Z' \to Z$ factors through $W$ if and only if the
base change $f_{Z'} : X_{Z'} \to Y_{Z'}$ is flat.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-base-change-flatness-fibres}
the set
$$
A = \{x \in |X| : X\text{ flat at }x \text{ over }Y\}.
$$
is open in $|X|$ and its formation commutes with arbitrary base
change. Let $W \subset Z$ be the open subspace
(see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-open-subspaces})
with underlying set of points
$$
|W| = |Z| \setminus |p|\left(|X| \setminus A\right)
$$
i.e., $z \in |Z|$ is a point of $W$ if and only if the whole fibre
of $|X| \to |Z|$ over $z$ is contained in $A$. This is open because
$p$ is closed. Since the formation of $A$ commutes with arbitrary
base change it follows that $W$ works.
\end{proof}

\begin{lemma}
\label{lemma-where-surjective-flat}
Consider a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces. Assume that
\begin{enumerate}
\item $p$ is locally of finite presentation,
\item $p$ is flat,
\item $p$ is closed,
\item $q$ is locally of finite type, and
\item $q$ is closed.
\end{enumerate}
Then there exists an open subspace $W \subset Z$
such that a morphism $Z' \to Z$ factors through $W$ if and only if the
base change $f_{Z'} : X_{Z'} \to Y_{Z'}$ is surjective and flat.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-where-flat}
we may assume that $f$ is flat.
Note that $f$ is locally of finite presentation by
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-finite-presentation-permanence}.
Hence $f$ is open, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-fppf-open}.
Let $W \subset Z$ be the open subspace (see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-open-subspaces})
with underlying set of points
$$
|W| = |Z| \setminus |q|\left(|Y| \setminus |f|(|X|)\right).
$$
in other words for $z \in |Z|$ we have $z \in |W|$ if and only
if the whole fibre of $|Y| \to |Z|$ over $z$ is in the image of
$|X| \to |Y|$. Since $q$ is closed this set is open in $|Z|$.
The morphism $X_W \to Y_W$ is surjective by construction.
Finally, suppose that $X_{Z'} \to Y_{Z'}$ is surjective.
In order to show that $Z' \to Z$ factors through $W$ it suffices to show
that $|Z'| \to |Z|$ has image contained in $|W|$, see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-factor-through-open-subspace}.
Hence it suffices to prove the result when $Z'$ is the spectrum of a field.
Denote $z \in |Z|$ the image of $|Z'| \to |Z|$. By
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-points-cartesian}
in the commutative diagram
$$
\xymatrix{
|X_{Z'}| \ar[d] \ar[r] &
|Y_{Z'}| \ar[d] \\
|p|^{-1}(\{z\}) \ar[r] &
|q|^{-1}(\{z\})
}
$$
the vertical arrows are surjective. It follows that $z \in |W|$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-where-isomorphism}
Consider a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces. Assume that
\begin{enumerate}
\item $p$ is locally of finite presentation,
\item $p$ is flat,
\item $p$ is universally closed,
\item $q$ is locally of finite type,
\item $q$ is closed, and
\item $q$ is separated.
\end{enumerate}
Then there exists an open subspace $W \subset Z$
such that a morphism $Z' \to Z$ factors through $W$ if and only if the
base change $f_{Z'} : X_{Z'} \to Y_{Z'}$ is an isomorphism.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-where-surjective-flat}
there exists an open subspace $W_1 \subset Z$ such that
$f_{Z'}$ is surjective and flat if and only if $Z' \to Z$
factors through $W_1$. By
Lemma \ref{lemma-where-closed-immersion}
there exists an open subspace $W_2 \subset Z$ such that
$f_{Z'}$ is a closed immersion if and only if $Z' \to Z$
factors through $W_2$. We claim that $W = W_1 \cap W_2$ works.
Certainly, if $f_{Z'}$ is an isomorphism, then $Z' \to Z$
factors through $W$. Hence it suffices to show that
$f_W$ is an isomorphism. By construction $f_W$ is a
surjective flat closed immersion. In particular $f_W$ is
representable. Since a surjective flat closed immersion of
schemes is an isomorphism (see
Morphisms, Lemma \ref{morphisms-lemma-characterize-flat-closed-immersions})
we win. (Note that actually $f_W$ is locally of finite presentation,
whence open, so you can avoid the use of this lemma if you like.)
\end{proof}

\begin{lemma}
\label{lemma-where-lci}
Consider a commutative diagram
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & & Y \ar[ld]^q \\
& Z
}
$$
of algebraic spaces. Assume that
\begin{enumerate}
\item $p$ is flat and locally of finite presentation,
\item $p$ is closed, and
\item $q$ is flat and locally of finite presentation,
\end{enumerate}
Then there exists an open subspace $W \subset Z$
such that a morphism $Z' \to Z$ factors through $W$ if and only if the
base change $f_{Z'} : X_{Z'} \to Y_{Z'}$ is a local complete intersection
morphism.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-base-change-lci-fibres}
there exists an open subspace $U(f) \subset X$ which is the set of
points where $f$ is Koszul. Moreover, formation of $U(f)$ commutes
with arbitrary base change. Let $W \subset Z$ be the open subspace
(see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-open-subspaces})
with underlying set of points
$$
|W| = |Z| \setminus |p|\left(|X| \setminus |U(f)|\right)
$$
i.e., $z \in |Z|$ is a point of $W$ if and only if $f$ is Koszul
at every point of $X$ above $z$. Note that this is open because we
assumed that $p$ is closed. Since the formation of $U(f)$
commutes with arbitrary base change we immediately see (using
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-factor-through-open-subspace})
that $W$ has the desired universal property.
\end{proof}








\section{Exact sequences of differentials and conormal sheaves}
\label{section-exact}

\noindent
In this section we collect some results on exact sequences of conormal
sheaves and sheaves of differentials. In some sense these are all
realizations of the triangle of cotangent complexes associated to
composable morphisms of algebraic spaces.

\medskip\noindent
In the sequences below each of the maps
are as constructed in either
Lemma \ref{lemma-functoriality-differentials} or
Lemma \ref{lemma-universal-thickening-functorial}.
Let $S$ be a scheme. Let $g : Z \to Y$ and $f : Y \to X$ be morphisms of
algebraic spaces over $S$.
\begin{enumerate}
\item There is a canonical exact sequence
$$
g^*\Omega_{Y/X} \to \Omega_{Z/X} \to \Omega_{Z/Y} \to 0,
$$
see
Lemma \ref{lemma-triangle-differentials}.
If $g : Z \to Y$ is formally smooth, then this sequence is a short
exact sequence, see
Lemma \ref{lemma-triangle-differentials-formally-smooth}.
\item If $g$ is formally unramified, then there is a canonical exact sequence
$$
\mathcal{C}_{Z/Y} \to g^*\Omega_{Y/X} \to \Omega_{Z/X} \to 0,
$$
see
Lemma \ref{lemma-universally-unramified-differentials-sequence}.
If $f \circ g : Z \to X$ is formally smooth, then this sequence is a short
exact sequence, see
Lemma \ref{lemma-differentials-formally-unramified-formally-smooth}.
\item if $g$ and $f \circ g$ are formally unramified, then there is a
canonical exact sequence
$$
\mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Y} \to g^*\Omega_{Y/X} \to 0,
$$
see
Lemma \ref{lemma-two-unramified-morphisms}.
If $f : Y \to X$ is formally smooth, then this sequence is a short
exact sequence, see
Lemma \ref{lemma-two-unramified-morphisms-formally-smooth}.
\item if $g$ and $f$ are formally unramified, then there is a canonical
exact sequence
$$
g^*\mathcal{C}_{Y/X} \to \mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Y} \to 0.
$$
see
Lemma \ref{lemma-transitivity-conormal-unramified}.
If $g : Z \to Y$ is a local complete intersection morphism,
then this sequence is a short exact sequence, see
Lemma \ref{lemma-transitivity-conormal-lci}.
\end{enumerate}













\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
