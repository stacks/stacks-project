\input{preamble}

% OK, start here.
%
\begin{document}

\title{Smoothing Ring Maps}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
The main result of this chapter is the following:
$$
\fbox{A regular map of Noetherian rings is a filtered colimit
of smooth ones.}
$$
This theorem is due to Popescu, see \cite{popescu-letter}.
A readable exposition of Popescu's proof was given by Richard Swan,
see \cite{swan} who used notes by Andr\'e and a paper of Ogoma, see
\cite{Ogoma}.

\medskip\noindent
Our exposition follows Swan's, but we first prove an intermediate result
which lets us work in a slightly simpler situation. Here is an overview.
We first solve the following ``lifting problem'': A flat infinitesimal
deformation of a filtered colimit of smooth algebras is a filtered colimit
of smooth algebras. This result essentially says that it suffices to prove
the main theorem for maps between reduced Noetherian rings. Next we prove
two very clever lemmas called the ``lifting lemma'' and the
``desingularization lemma''. We show that these lemmas combined
reduce the main theorem to proving a Noetherian, geometrically regular
algebra $\Lambda$ over a field $k$ is a filtered colimit of smooth $k$-algebras.
Next, we discuss the necessary local tricks that go into the
Popescu-Ogoma-Swan-Andr\'e proof. Finally, in the last three sections
we give the proof.

\medskip\noindent
We end this introduction with some pointers to references.
Let $A$ be a henselian Noetherian local ring.
We say $A$ has the {\it approximation property} if for any
$f_1, \ldots, f_m \in A[x_1, \ldots, x_n]$ the system of equations
$f_1 = 0, \ldots, f_m = 0$ has a solution in the completion
of $A$ if and only if it has a solution in $A$. This definition
is due to Artin.
Artin first proved the approximation property for analytic systems of
equations, see \cite{Artin-Analytic-Approximation}.
In \cite{Artin-Algebraic-Approximation} Artin proved the
approximation property for local rings
essentially of finite type over an excellent discrete valuation ring.
Artin conjectured (page 26 of \cite{Artin-Algebraic-Approximation})
that every excellent henselian local ring should have the
approximation property.

\medskip\noindent
At some point in time it became a conjecture
that every regular homomorphism of Noetherian rings is a
filtered colimit of smooth algebras (see for example
\cite{Raynaud-Rennes}, \cite{popescu-global}, \cite{Artin-power-series},
\cite{Artin-Denef}). We're not sure who this conjecture\footnote{The
question/conjecture as formulated in \cite{Artin-power-series},
\cite{Artin-Denef}, and \cite{popescu-global} is stronger and was shown
to be equivalent to the original version in \cite{Cipu}.}
is due to. The relationship with the approximation property is that if
$A \to A^\wedge$ is a colimit of smooth algebras with $A$ as above,
then the approximation
property holds (insert future reference here). Moreover, the main theorem
applies to the map $A \to A^\wedge$ if $A$ is an excellent local ring, as one
of the conditions of an excellent local ring is that the formal
fibres are geometrically regular. Note that excellent local rings
were defined by Grothendieck and their definition appeared in
print in 1965.

\medskip\noindent
In \cite{Artin-power-series} it was shown that
$R \to R^\wedge$ is a filtered colimit of smooth algebras for any
local ring $R$ essentially of finite type over a field.
In \cite{Rotthaus-Artin} it was shown that $R \to R^\wedge$
is a filtered colimit of smooth algebras for any local ring $R$
essentially of finite type over an excellent discrete valuation ring.
Finally, the main theorem was shown in
\cite{popescu-GND}, \cite{popescu-GNDA}, \cite{popescu-letter}, 
\cite{Ogoma}, and \cite{swan} as discussed above.

\medskip\noindent
Conversely, using some of the results above, in \cite{Rotthaus-excellent}
it was shown that any Noetherian local ring with the approximation property
is excellent.

\medskip\noindent
The paper \cite{Spivakovsky} provides an alternative approach to the
main theorem, but it seems hard to read (for example
\cite[Lemma 5.2]{Spivakovsky} appears to be an incorrectly reformulated
version of \cite[Lemma 3]{Elkik}). There is also a Bourbaki
lecture about this material, see \cite{Teissier}.












\section{Singular ideals}
\label{section-singular-ideal}

\noindent
Let $R \to A$ be a ring map. The singular ideal of $A$ over $R$
is the radical ideal in $A$ cutting out the singular locus of the
morphism $\Spec(A) \to \Spec(R)$. Here is a formal definition.

\begin{definition}
\label{definition-singular-ideal}
Let $R \to A$ be a ring map. The {\it singular ideal of $A$ over $R$},
denoted $H_{A/R}$ is the unique radical ideal $H_{A/R} \subset A$ with
$$
V(H_{A/R}) = \{\mathfrak q \in \Spec(A) \mid R \to A
\text{ not smooth at }\mathfrak q\}
$$
\end{definition}

\noindent
This makes sense because the set of primes where $R \to A$ is smooth
is open, see
Algebra, Definition \ref{algebra-definition-smooth-at-prime}.
In order to find an explicit set
of generators for the singular ideal we first prove the following lemma.

\begin{lemma}
\label{lemma-find-strictly-standard}
Let $R$ be a ring. Let $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
Let $\mathfrak q \subset A$ be a prime ideal. Assume $R \to A$ is smooth
at $\mathfrak q$. Then there exists an $a \in A$, $a \not \in \mathfrak q$,
an integer $c$, $0 \leq c \leq \min(n, m)$, subsets
$U \subset \{1, \ldots, n\}$, $V \subset \{1, \ldots, m\}$
of cardinality $c$ such that
$$
a = a' \det(\partial f_j/\partial x_i)_{j \in V, i \in U}
$$
for some $a' \in A$ and
$$
a f_\ell \in (f_j, j \in V) + (f_1, \ldots, f_m)^2
$$
for all $\ell \in \{1, \ldots, m\}$.
\end{lemma}

\begin{proof}
Set $I = (f_1, \ldots, f_m)$ so that the naive cotangent
complex of $A$ over $R$ is homotopy equivalent to
$I/I^2 \to \bigoplus A\text{d}x_i$, see
Algebra, Lemma \ref{algebra-lemma-NL-homotopy}.
We will use the formation of the naive cotangent complex commutes with
localization, see Algebra, Section \ref{algebra-section-netherlander},
especially Algebra, Lemma \ref{algebra-lemma-localize-NL}.
By Algebra, Definitions \ref{algebra-definition-smooth} and
\ref{algebra-definition-smooth-at-prime}
we see that $(I/I^2)_a \to \bigoplus A_a\text{d}x_i$
is a split injection for some $a \in A$, $a \not \in \mathfrak q$.
After renumbering $x_1, \ldots, x_n$ and $f_1, \ldots, f_m$ we may
assume that $f_1, \ldots, f_c$ form a basis for
the vector space $I/I^2 \otimes_A \kappa(\mathfrak q)$ and that
$\text{d}x_{c + 1}, \ldots, \text{d}x_n$ map to a basis of
$\Omega_{A/R} \otimes_A \kappa(\mathfrak q)$. Hence after replacing $a$
by $aa'$ for some $a' \in A$, $a' \not \in \mathfrak q$ we may assume
$f_1, \ldots, f_c$ form a basis for $(I/I^2)_a$ and that
$\text{d}x_{c + 1}, \ldots, \text{d}x_n$ map to a basis of
$(\Omega_{A/R})_a$. In this situation $a^N$ for some large integer
$N$ satisfies the conditions of the lemma (with $U = V = \{1, \ldots, c\}$).
\end{proof}

\noindent
We will use the notion of a {\it strictly standard} element in
$A$ over $R$. Our notion is slightly weaker than the
one in Swan's paper \cite{swan}. We also define an {\it elementary
standard} element to be one of the type we found in the lemma above.
We compare the different types of elements in
Lemma \ref{lemma-compare-standard}.

\begin{definition}
\label{definition-strictly-standard}
Let $R \to A$ be a ring map of finite presentation.
We say an element $a \in A$ is {\it elementary standard in $A$ over $R$}
if there exists a presentation
$A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
and $0 \leq c \leq \min(n, m)$ such that
\begin{equation}
\label{equation-elementary-standard-one}
a = a' \det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}
\end{equation}
for some $a' \in A$ and
\begin{equation}
\label{equation-elementary-standard-two}
a f_{c + j} \in (f_1, \ldots, f_c) + (f_1, \ldots, f_m)^2
\end{equation}
for $j = 1, \ldots, m - c$. We say $a \in A$ is
{\it strictly standard in $A$ over $R$} if there exists a presentation
$A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
and $0 \leq c \leq \min(n, m)$ such that
\begin{equation}
\label{equation-strictly-standard-one}
a = \sum\nolimits_{I \subset \{1, \ldots, n\},\ |I| = c}
a_I \det(\partial f_j/\partial x_i)_{j = 1, \ldots, c,\ i \in I}
\end{equation}
for some $a_I \in A$ and
\begin{equation}
\label{equation-strictly-standard-two}
a f_{c + j} \in (f_1, \ldots, f_c) + (f_1, \ldots, f_m)^2
\end{equation}
for $j = 1, \ldots, m - c$.
\end{definition}

\noindent
The following lemma is useful to find implications of
(\ref{equation-strictly-standard-one}).

\begin{lemma}
\label{lemma-parse-equation-strictly-standard-one}
Let $R$ be a ring. Let $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
and write $I = (f_1, \ldots, f_m)$. Let $a \in A$. Then
(\ref{equation-strictly-standard-one}) implies
there exists an $A$-linear map
$\psi : \bigoplus\nolimits_{i = 1, \ldots, n} A \text{d}x_i \to A^{\oplus c}$
such that the composition
$$
A^{\oplus c} \xrightarrow{(f_1, \ldots, f_c)}
I/I^2 \xrightarrow{f \mapsto \text{d}f}
\bigoplus\nolimits_{i = 1, \ldots, n} A \text{d}x_i
\xrightarrow{\psi}
A^{\oplus c}
$$
is multiplication by $a$. Conversely, if such a $\psi$ exists, then
$a^c$ satisfies (\ref{equation-strictly-standard-one}).
\end{lemma}

\begin{proof}
This is a special case of
Algebra, Lemma \ref{algebra-lemma-matrix-left-inverse}.
\end{proof}

\begin{lemma}[Elkik]
\label{lemma-elkik}
Let $R \to A$ be a ring map of finite presentation.
The singular ideal $H_{A/R}$ is the radical of the ideal
generated by strictly standard elements in $A$ over $R$
and also the radical of the ideal generated by elementary
standard elements in $A$ over $R$.
\end{lemma}

\begin{proof}
Assume $a$ is strictly standard in $A$ over $R$. We claim that
$A_a$ is smooth over $R$, which proves that $a \in H_{A/R}$. Namely,
let $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$, $c$, and $a' \in A$
be as in Definition \ref{definition-strictly-standard}.
Write $I = (f_1, \ldots, f_m)$ so that the naive cotangent
complex of $A$ over $R$ is given by $I/I^2 \to \bigoplus A\text{d}x_i$.
Assumption (\ref{equation-strictly-standard-two})
implies that $(I/I^2)_a$ is generated by the classes of $f_1, \ldots, f_c$.
Assumption (\ref{equation-strictly-standard-one}) implies
that the differential $(I/I^2)_a \to \bigoplus A_a\text{d}x_i$
has a left inverse, see
Lemma \ref{lemma-parse-equation-strictly-standard-one}.
Hence $R \to A_a$ is smooth by definition and
Algebra, Lemma \ref{algebra-lemma-localize-NL}.

\medskip\noindent
Let $H_e, H_s \subset A$ be the radical of the ideal generated by
elementary, resp.\ strictly standard elements of $A$ over $R$.
By definition and what we just proved we have
$H_e \subset H_s \subset H_{A/R}$. The inclusion $H_{A/R} \subset H_e$
follows from Lemma \ref{lemma-find-strictly-standard}.
\end{proof}

\begin{example}
\label{example-not-quasi-compact}
The set of points where a finitely presented ring map is smooth
needn't be a quasi-compact open. For example, let
$R = k[x, y_1, y_2, y_3, \ldots]/(xy_i)$ and $A = R/(x)$.
Then the smooth locus of $R \to A$ is
$\bigcup D(y_i)$ which is not quasi-compact.
\end{example}

\begin{lemma}
\label{lemma-strictly-standard-base-change}
Let $R \to A$ be a ring map of finite presentation.
Let $R \to R'$ be a ring map. If $a \in A$ is elementary,
resp.\ strictly standard in $A$ over $R$, then $a \otimes 1$
is elementary, resp.\ strictly standard in $A \otimes_R R'$ over $R'$.
\end{lemma}

\begin{proof}
If $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ is a presentation
of $A$ over $R$, then
$A \otimes_R R' = R'[x_1, \ldots, x_n]/(f'_1, \ldots, f'_m)$
is a presentation of $A \otimes_R R'$ over $R'$. Here $f'_j$ is
the image of $f_j$ in $R'[x_1, \ldots, x_n]$.
Hence the result follows from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-final-solve}
Let $R \to A \to \Lambda$ be ring maps with $A$ of finite presentation
over $R$. Assume that $H_{A/R} \Lambda = \Lambda$. Then there exists
a factorization $A \to B \to \Lambda$ with $B$ smooth over $R$.
\end{lemma}

\begin{proof}
Choose $f_1, \ldots, f_r \in H_{A/R}$ and
$\lambda_1, \ldots, \lambda_r \in \Lambda$ such that
$\sum f_i\lambda_i = 1$ in $\Lambda$. Set
$B = A[x_1, \ldots, x_r]/(f_1x_1 + \ldots + f_rx_r - 1)$
and define $B \to \Lambda$ by mapping $x_i$ to $\lambda_i$.
Details omitted.
\end{proof}





\section{Presentations of algebras}
\label{section-presentations}

\noindent
Some of the results in this section are due to Elkik. Note that the algebra
$C$ in the following lemma is a symmetric algebra over $A$. Moreover, if
$R$ is Noetherian, then $C$ is of finite presentation over $R$.

\begin{lemma}
\label{lemma-improve-presentation}
Let $R$ be a ring and let $A$ be a finitely presented $R$-algebra.
There exists finite type $R$-algebra map $A \to C$ which has a
retraction with the following two properties
\begin{enumerate}
\item for each $a \in A$ such that $R \to A_a$ is a local complete
intersection (More on Algebra, Definition
\ref{more-algebra-definition-local-complete-intersection})
the ring $C_a$ is smooth over $A_a$ and has a presentation
$C_a = R[y_1, \ldots, y_m]/J$ such that $J/J^2$ is free over $C_a$, and
\item for each $a \in A$ such that $A_a$ is smooth over $R$ the
module $\Omega_{C_a/R}$ is free over $C_a$.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a presentation $A = R[x_1, \ldots, x_n]/I$ and write
$I = (f_1, \ldots, f_m)$. Define the $A$-module $K$ by the short exact sequence
$$
0 \to K \to A^{\oplus m} \to I/I^2 \to 0
$$
where the $j$th basis vector $e_j$ in the middle is mapped to the class of
$f_j$ on the right. Set
$$
C = \text{Sym}^*_A(I/I^2).
$$
The retraction is just the projection onto the degree $0$ part of $C$.
We have a surjection $R[x_1, \ldots, x_n, y_1, \ldots, y_m] \to C$
which maps $y_j$ to the class of $f_j$ in $I/I^2$. The kernel $J$ of this
map is generated by the elements $f_1, \ldots, f_m$ and by elements
$\sum h_j y_j$ with $h_j \in R[x_1, \ldots, x_n]$ such that
$\sum h_j e_j$ defines an element of $K$. By
Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL}
applied to $R \to A \to C$ and the presentations above and
More on Algebra, Lemma
\ref{more-algebra-lemma-cotangent-complex-symmetric-algebra}
there is a short exact sequence
\begin{equation}
\label{equation-sequence}
I/I^2 \otimes_A C \to J/J^2 \to K \otimes_A C \to 0
\end{equation}
of $C$-modules. Let $h \in R[x_1, \ldots, x_n]$ be an element
with image $a \in A$. We will use as presentations for the localized rings
$$
A_a = R[x_0, x_1, \ldots, x_n]/I'
\quad\text{and}\quad
C_a = R[x_0, x_1, \ldots, x_n, y_1, \ldots, y_m]/J'
$$
where $I' = (hx_0 - 1, I)$ and $J' = (hx_0 - 1, J)$. Hence
$I'/(I')^2 = A_a \oplus (I/I^2)_a$ as $A_a$-modules and
$J'/(J')^2 = C_a \oplus (J/J^2)_a$ as $C_a$-modules.
Thus we obtain
\begin{equation}
\label{equation-sequence-localized}
C_a \oplus I/I^2 \otimes_A C_a \to
C_a \oplus (J/J^2)_a \to
K \otimes_A C_a \to 0
\end{equation}
as the sequence of
Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL}
corresponding to $R \to A_a \to C_a$ and the presentations above.

\medskip\noindent
Next, assume that $a \in A$ is such that $A_a$ is a local complete
intersection over $R$. Then $(I/I^2)_a$ is finite projective over $A_a$, see
More on Algebra, Lemma
\ref{more-algebra-lemma-quasi-regular-ideal-finite-projective}.
Hence we see $K_a \oplus (I/I^2)_a \cong A_a^{\oplus m}$ is free.
In particular $K_a$ is finite projective too.
By More on Algebra, Lemma \ref{more-algebra-lemma-transitive-lci-at-end}
the sequence (\ref{equation-sequence-localized}) is exact on the left.
Hence
$$
J'/(J')^2 \cong
C_a \oplus I/I^2 \otimes_A C_a \oplus K \otimes_A C_a \cong
C_a^{\oplus m + 1}
$$
This proves (1). Finally, suppose that in addition $A_a$ is smooth over
$R$. Then the same presentation shows that $\Omega_{C_a/R}$
is the cokernel of the map
$$
J'/(J')^2 \longrightarrow
\bigoplus\nolimits_i C_a\text{d}x_i \oplus \bigoplus\nolimits_j C_a\text{d}y_j
$$
The summand $C_a$ of $J'/(J')^2$ in the decomposition above
corresponds to $hx_0 - 1$ and hence maps
isomorphically to the summand $C_a\text{d}x_0$. The summand
$I/I^2 \otimes_A C_a$ of $J'/(J')^2$ maps injectively to
$\bigoplus_{i = 1, \ldots, n} C_a\text{d}x_i$
with quotient $\Omega_{A_a/R} \otimes_{A_a} C_a$. The summand
$K \otimes_A C_a$ maps injectively to
$\bigoplus_{j \geq 1} C_a\text{d}y_j$ with quotient isomorphic to
$I/I^2 \otimes_A C_a$. Thus the cokernel of the last displayed
map is the module
$I/I^2 \otimes_A C_a \oplus \Omega_{A_a/R} \otimes_{A_a} C_a$.
Since $(I/I^2)_a \oplus \Omega_{A_a/R}$ is
free (from the definition of smooth ring maps) we see that (2) holds.
\end{proof}

\noindent
The following proposition was proved for smooth ring maps over henselian
pairs by Elkik in \cite{Elkik}. For smooth ring maps it can be found in
\cite{Arabia}, where it is also proven that ring maps between smooth
algebras can be lifted.

\begin{proposition}
\label{proposition-lift-smooth}
\begin{slogan}
Smooth and syntomic algebras lift along surjections
\end{slogan}
Let $R \to R_0$ be a surjective ring map with kernel $I$.
\begin{enumerate}
\item If $R_0 \to A_0$ is a syntomic ring map, then there exists a syntomic
ring map $R \to A$ such that $A/IA \cong A_0$.
\item If $R_0 \to A_0$ is a smooth ring map, then there exists a smooth
ring map $R \to A$ such that $A/IA \cong A_0$.
\end{enumerate}
\end{proposition}

\begin{proof}
Assume $R_0 \to A_0$ syntomic, in particular a local complete intersection
(More on Algebra, Lemma \ref{more-algebra-lemma-syntomic-lci}).
Choose a presentation $A_0 = R_0[x_1, \ldots, x_n]/J_0$. Set
$C_0 = \text{Sym}^*_{A_0}(J_0/J_0^2)$. Note that $J_0/J_0^2$ is a finite
projective $A_0$-module (Algebra, Lemma
\ref{algebra-lemma-syntomic-presentation-ideal-mod-squares}).
By Lemma \ref{lemma-improve-presentation} the ring map
$A_0 \to C_0$ is smooth and we can find a presentation
$C_0 = R_0[y_1, \ldots, y_m]/K_0$ with $K_0/K_0^2$ free over $C_0$.
By Algebra, Lemma \ref{algebra-lemma-huber} we can assume
$C_0 = R_0[y_1, \ldots, y_m]/(\overline{f}_1, \ldots, \overline{f}_c)$
where $\overline{f}_1, \ldots, \overline{f}_c$ maps to a basis of
$K_0/K_0^2$ over $C_0$. Choose
$f_1, \ldots, f_c \in R[y_1, \ldots, y_c]$ lifting
$\overline{f}_1, \ldots, \overline{f}_c$ and set
$$
C = R[y_1, \ldots, y_m]/(f_1, \ldots, f_c)
$$
By construction $C_0 = C/IC$. By Algebra, Lemma
\ref{algebra-lemma-localize-relative-complete-intersection}
we can after replacing $C$ by $C_g$ assume that $C$ is a relative
global complete intersection over $R$.
We conclude that there exists a finite projective $A_0$-module
$P_0$ such that $C_0 = \text{Sym}^*_{A_0}(P_0)$
is isomorphic to $C/IC$ for some syntomic $R$-algebra $C$.

\medskip\noindent
Choose an integer $n$ and a direct sum decomposition
$A_0^{\oplus n} = P_0 \oplus Q_0$.
By More on Algebra, Lemma \ref{more-algebra-lemma-lift-projective-module}
we can find an \'etale ring map $C \to C'$ which induces
an isomorphism $C/IC \to C'/IC'$ and a finite projective
$C'$-module $Q$ such that $Q/IQ$ is isomorphic to
$Q_0 \otimes_{A_0} C/IC$.
Then $D = \text{Sym}_{C'}^*(Q)$ is a smooth $C'$-algebra (see
More on Algebra, Lemma \ref{more-algebra-lemma-symmetric-algebra-smooth}).
Picture
$$
\xymatrix{
R \ar[d] \ar[rr] & &
C \ar[r] \ar[d] &
C' \ar[r] \ar[d] &
D \ar[d] \\
R/I \ar[r] &
A_0 \ar[r] &
C/IC \ar[r]^{\cong} &
C'/IC' \ar[r] &
D/ID
}
$$
Observe that our choice of $Q$ gives
\begin{align*}
D/ID & =
\text{Sym}_{C/IC}^*(Q_0 \otimes_{A_0} C/IC) \\
& =
\text{Sym}_{A_0}^*(Q_0) \otimes_{A_0} C/IC \\
& =
\text{Sym}_{A_0}^*(Q_0) \otimes_{A_0}
\text{Sym}_{A_0}^*(P_0) \\
& =
\text{Sym}_{A_0}^*(Q_0 \oplus P_0) \\
& =
\text{Sym}_{A_0}^*(A_0^{\oplus n}) \\
& =
A_0[x_1, \ldots, x_n]
\end{align*}
Choose $f_1, \ldots, f_n \in D$ which map to $x_1, \ldots, x_n$
in $D/ID = A_0[x_1, \ldots, x_n]$. Set $A = D/(f_1, \ldots, f_n)$.
Note that $A_0 = A/IA$. We claim that $R \to A$ is syntomic
in a neighbourhood of $V(IA)$. If the claim is true, then we can
find a $f \in A$ mapping to $1 \in A_0$ such that $A_f$ is syntomic
over $R$ and the proof of (1) is finished.

\medskip\noindent
Proof of the claim. Observe that $R \to D$ is syntomic as a composition
of the syntomic ring map $R \to C$, the \'etale ring map $C \to C'$ and the
smooth ring map $C' \to D$ (Algebra, Lemmas
\ref{algebra-lemma-composition-syntomic} and
\ref{algebra-lemma-smooth-syntomic}).
The question is local on $\Spec(D)$, hence we
may assume that $D$ is a relative global complete intersection
(Algebra, Lemma \ref{algebra-lemma-syntomic}).
Say $D = R[y_1, \ldots, y_m]/(g_1, \ldots, g_s)$.
Let $f'_1, \ldots, f'_n \in R[y_1, \ldots, y_m]$ be lifts of
$f_1, \ldots, f_n$. Then we can apply
Algebra, Lemma \ref{algebra-lemma-localize-relative-complete-intersection}
to get the claim.

\medskip\noindent
Proof of (2). Since a smooth ring map is syntomic, we can find
a syntomic ring map $R \to A$ such that $A_0 = A/IA$.
By assumption the fibres of $R \to A$ are smooth over primes in $V(I)$
hence $R \to A$ is smooth in an open neighbourhood of $V(IA)$
(Algebra, Lemma \ref{algebra-lemma-flat-fibre-smooth}).
Thus we can replace $A$ by a localization to obtain the result we want.
\end{proof}

\noindent
We know that any syntomic ring map $R \to A$ is locally a relative global
complete intersection, see
Algebra, Lemma \ref{algebra-lemma-syntomic}.
The next lemma says that a vector bundle over $\Spec(A)$ is
a relative global complete intersection.

\begin{lemma}
\label{lemma-syntomic-complete-intersection}
Let $R \to A$ be a syntomic ring map. Then there exists a smooth $R$-algebra
map $A \to C$ with a retraction such that $C$ is a global relative complete
intersection over $R$, i.e.,
$$
C \cong R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
flat over $R$ and all fibres of dimension $n - c$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-improve-presentation} to get $A \to C$.
By Algebra, Lemma \ref{algebra-lemma-huber}
we can write $C = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
with $f_i$ mapping to a basis of $J/J^2$.
The ring map $R \to C$ is syntomic (hence flat)
as it is a composition of a syntomic and a smooth ring map.
The dimension of the fibres is $n - c$ by
Algebra, Lemma \ref{algebra-lemma-lci}
(the fibres are local complete intersections, so the lemma applies).
\end{proof}

\begin{lemma}
\label{lemma-smooth-standard-smooth}
Let $R \to A$ be a smooth ring map. Then there exists a smooth $R$-algebra
map $A \to B$ with a retraction such that $B$ is standard smooth over
$R$, i.e.,
$$
B \cong R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
and $\det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}$
is invertible in $B$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-syntomic-complete-intersection}
to get a smooth $R$-algebra map $A \to C$ with a retraction such that
$C = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
is a relative global complete intersection over $R$. As $C$ is smooth
over $R$ we have a short exact sequence
$$
0 \to
\bigoplus\nolimits_{j = 1, \ldots, c} C f_j \to
\bigoplus\nolimits_{i = 1, \ldots, n} C\text{d}x_i \to
\Omega_{C/R} \to 0
$$
Since $\Omega_{C/R}$ is a projective $C$-module this sequence is split.
Choose a left inverse $t$ to the first map. Say
$t(\text{d}x_i) = \sum c_{ij} f_j$
so that $\sum_i \frac{\partial f_j}{\partial x_i} c_{i\ell} = \delta_{j\ell}$
(Kronecker delta). Let
$$
B' = C[y_1, \ldots, y_c] =
R[x_1, \ldots, x_n, y_1, \ldots, y_c]/(f_1, \ldots, f_c)
$$
The $R$-algebra map $C \to B'$ has a retraction given by mapping $y_j$ to zero.
We claim that the map
$$
R[z_1, \ldots, z_n] \longrightarrow B',\quad
z_i \longmapsto x_i - \sum\nolimits_j c_{ij} y_j
$$
is \'etale at every point in the image of $\Spec(C) \to \Spec(B')$.
In $\Omega_{B'/R[z_1, \ldots, z_n]}$ we have
$$
0 =
\text{d}f_j - \sum\nolimits_i \frac{\partial f_j}{\partial x_i} \text{d}z_i
\equiv
\sum\nolimits_{i, \ell}
\frac{\partial f_j}{\partial x_i} c_{i\ell} \text{d}y_\ell
\equiv
\text{d}y_j \bmod (y_1, \ldots, y_c)\Omega_{B'/R[z_1, \ldots, z_n]}
$$
Since $0 = \text{d}z_i = \text{d}x_i$ modulo
$\sum B'\text{d}y_j + (y_1, \ldots, y_c)\Omega_{B'/R[z_1, \ldots, z_n]}$
we conclude that
$$
\Omega_{B'/R[z_1, \ldots, z_n]}/
(y_1, \ldots, y_c)\Omega_{B'/R[z_1, \ldots, z_n]} = 0.
$$
As $\Omega_{B'/R[z_1, \ldots, z_n]}$ is a finite $B'$-module
by Nakayama's lemma there exists a $g \in 1 + (y_1, \ldots, y_c)$
that $(\Omega_{B'/R[z_1, \ldots, z_n]})_g = 0$. This proves that
$R[z_1, \ldots, z_n] \to B'_g$ is unramified, see
Algebra, Definition \ref{algebra-definition-unramified}.
For any ring map $R \to k$ where $k$ is a field we obtain an
unramified ring map $k[z_1, \ldots, z_n] \to (B'_g) \otimes_R k$
between smooth $k$-algebras of dimension $n$. It follows that
$k[z_1, \ldots, z_n] \to (B'_g) \otimes_R k$ is flat by
Algebra, Lemmas \ref{algebra-lemma-CM-over-regular-flat} and
\ref{algebra-lemma-characterize-smooth-kbar}. By the crit\`ere
de platitude par fibre
(Algebra, Lemma \ref{algebra-lemma-criterion-flatness-fibre})
we conclude that $R[z_1, \ldots, z_n] \to B'_g$ is flat.
Finally, Algebra, Lemma \ref{algebra-lemma-characterize-etale}
implies that $R[z_1, \ldots, z_n] \to B'_g$ is \'etale.
Set $B = B'_g$. Note that $C \to B$ is smooth and has a retraction,
so also $A \to B$ is smooth and has a retraction.
Moreover, $R[z_1, \ldots, z_n] \to B$ is \'etale.
By Algebra, Lemma \ref{algebra-lemma-etale-standard-smooth}
we can write
$$
B = R[z_1, \ldots, z_n, w_1, \ldots, w_c]/(g_1, \ldots, g_c)
$$
with $\det(\partial g_j/\partial w_i)$ invertible in $B$.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-colimit-standard-smooth}
Let $R \to \Lambda$ be a ring map. If $\Lambda$ is a filtered colimit of
smooth $R$-algebras, then $\Lambda$ is a filtered colimit of standard
smooth $R$-algebras.
\end{lemma}

\begin{proof}
Let $A \to \Lambda$ be an $R$-algebra map with $A$
of finite presentation over $R$. According to
Algebra, Lemma \ref{algebra-lemma-when-colimit}
we have to factor this map through a standard smooth algebra, and
we know we can factor it as $A \to B \to \Lambda$ with $B$ smooth
over $R$. Choose an $R$-algebra map $B \to C$ with a retraction
$C \to B$ such that $C$ is standard smooth over $R$, see
Lemma \ref{lemma-smooth-standard-smooth}.
Then the desired factorization is $A \to B \to C \to B \to \Lambda$.
\end{proof}

\begin{lemma}
\label{lemma-standard-smooth-include-generators}
Let $R \to A$ be a standard smooth ring map.
Let $E \subset A$ be a finite subset of order $|E| = n$.
Then there exists a presentation
$A = R[x_1, \ldots, x_{n + m}]/(f_1, \ldots, f_c)$ with $c \geq n$,
with $\det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}$
invertible in $A$, and such that $E$ is the set of congruence classes of
$x_1, \ldots, x_n$.
\end{lemma}

\begin{proof}
Choose a presentation $A = R[y_1, \ldots, y_m]/(g_1, \ldots, g_d)$
such that the image of
$\det(\partial g_j/\partial y_i)_{i, j = 1, \ldots, d}$
is invertible in $A$. Choose an enumerations $E = \{a_1, \ldots, a_n\}$
and choose $h_i \in R[y_1, \ldots, y_m]$ whose image in $A$ is $a_i$.
Consider the presentation
$$
A = R[x_1, \ldots, x_n, y_1, \ldots, y_m]/
(x_1 - h_1, \ldots, x_n - h_n, g_1, \ldots, g_d)
$$
and set $c = n + d$.
\end{proof}

\begin{lemma}
\label{lemma-compare-standard}
Let $R \to A$ be a ring map of finite presentation.
Let $a \in A$. Consider the following conditions on $a$:
\begin{enumerate}
\item $A_a$ is smooth over $R$,
\item $A_a$ is smooth over $R$ and $\Omega_{A_a/R}$ is stably free,
\item $A_a$ is smooth over $R$ and $\Omega_{A_a/R}$ is free,
\item $A_a$ is standard smooth over $R$,
\item $a$ is strictly standard in $A$ over $R$,
\item $a$ is elementary standard in $A$ over $R$.
\end{enumerate}
Then we have
\begin{enumerate}
\item[(a)] (4) $\Rightarrow$ (3) $\Rightarrow$ (2) $\Rightarrow$ (1),
\item[(b)] (6) $\Rightarrow$ (5),
\item[(c)] (6) $\Rightarrow$ (4),
\item[(d)] (5) $\Rightarrow$ (2),
\item[(e)] (2) $\Rightarrow$ the elements $a^e$, $e \geq e_0$ are
strictly standard in $A$ over $R$,
\item[(f)] (4) $\Rightarrow$ the elements $a^e$, $e \geq e_0$ are
elementary standard in $A$ over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (a) is clear from the definitions and
Algebra, Lemma \ref{algebra-lemma-standard-smooth}.
Part (b) is clear from Definition \ref{definition-strictly-standard}.

\medskip\noindent
Proof of (c). Choose a presentation
$A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ such that
(\ref{equation-elementary-standard-one}) and
(\ref{equation-elementary-standard-two}) hold.
Choose $h \in R[x_1, \ldots, x_n]$ mapping to $a$. Then
$$
A_a = R[x_0, x_1, \ldots, x_n]/(x_0h - 1, f_1, \ldots, f_m).
$$
Write $J = (x_0h - 1, f_1, \ldots, f_m)$.
By (\ref{equation-elementary-standard-two}) we see that the $A_a$-module
$J/J^2$ is generated by $x_0h - 1, f_1, \ldots, f_c$
over $A_a$. Hence, as in the proof of Algebra, Lemma \ref{algebra-lemma-huber},
we can choose a $g \in 1 + J$ such that
$$
A_a = R[x_0, \ldots, x_n, x_{n + 1}]/
(x_0h - 1, f_1, \ldots, f_m, gx_{n + 1} - 1).
$$
At this point (\ref{equation-elementary-standard-one})
implies that $R \to A_a$ is standard smooth (use the coordinates
$x_0, x_1, \ldots, x_c, x_{n + 1}$ to take derivatives).

\medskip\noindent
Proof of (d). Choose a presentation
$A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ such that
(\ref{equation-strictly-standard-one}) and
(\ref{equation-strictly-standard-two}) hold.
Write $I = (f_1, \ldots, f_m)$.
We already know that $A_a$ is smooth over $R$, see
Lemma \ref{lemma-elkik}. By
Lemma \ref{lemma-parse-equation-strictly-standard-one}
we see that $(I/I^2)_a$ is free on $f_1, \ldots, f_c$
and maps isomorphically to a direct summand of
$\bigoplus A_a \text{d}x_i$. Since
$\Omega_{A_a/R} = (\Omega_{A/R})_a$
is the cokernel of the map
$(I/I^2)_a \to \bigoplus A_a \text{d}x_i$
we conclude that it is stably free.

\medskip\noindent
Proof of (e). Choose a presentation
$A = R[x_1, \ldots, x_n]/I$ with $I$ finitely generated.
By assumption we have a short exact sequence
$$
0 \to (I/I^2)_a \to \bigoplus\nolimits_{i = 1, \ldots, n} A_a\text{d}x_i \to
\Omega_{A_a/R} \to 0
$$
which is split exact. Hence we see that
$(I/I^2)_a \oplus \Omega_{A_a/R}$ is a free $A_a$-module.
Since $\Omega_{A_a/R}$ is stably free we see that $(I/I^2)_a$
is stably free as well. Thus replacing the presentation chosen
above by $A = R[x_1, \ldots, x_n, x_{n + 1}, \ldots, x_{n + r}]/J$ with
$J = (I, x_{n + 1}, \ldots, x_{n + r})$ for some $r$ we get that $(J/J^2)_a$
is (finite) free. Choose $f_1, \ldots, f_c \in J$ which map to a basis of
$(J/J^2)_a$. Extend this to a list of generators
$f_1, \ldots, f_m \in J$. Consider the presentation
$A = R[x_1, \ldots, x_{n + r}]/(f_1, \ldots, f_m)$.
Then (\ref{equation-strictly-standard-two}) holds for $a^e$
for all sufficiently large $e$ by construction. Moreover, since
$(J/J^2)_a \to \bigoplus\nolimits_{i = 1, \ldots, n + r} A_a\text{d}x_i$
is a split injection we can find an $A_a$-linear left inverse.
Writing this left inverse in terms of the basis $f_1, \ldots, f_c$
and clearing denominators we find a linear map
$\psi_0 : A^{\oplus n + r} \to A^{\oplus c}$ such that
$$
A^{\oplus c} \xrightarrow{(f_1, \ldots, f_c)}
J/J^2 \xrightarrow{f \mapsto \text{d}f}
\bigoplus\nolimits_{i = 1, \ldots, n + r} A \text{d}x_i
\xrightarrow{\psi_0}
A^{\oplus c}
$$
is multiplication by $a^{e_0}$ for some $e_0 \geq 1$. By
Lemma \ref{lemma-parse-equation-strictly-standard-one}
we see (\ref{equation-strictly-standard-one})
holds for all $a^{ce_0}$ and hence for $a^e$ for all $e$ with $e \geq ce_0$.

\medskip\noindent
Proof of (f). Choose a presentation
$A_a = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ such that
$\det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}$
is invertible in $A_a$. We may assume that for some
$m < n$ the classes of the elements $x_1, \ldots, x_m$
correspond $a_i/1$ where $a_1, \ldots, a_m \in A$ are generators of $A$
over $R$, see Lemma \ref{lemma-standard-smooth-include-generators}.
After replacing $x_i$ by $a^Nx_i$ for $m < i \leq n$
we may assume the class of $x_i$ is $a_i/1 \in A_a$ for some
$a_i \in A$. Consider the ring map
$$
\Psi : R[x_1, \ldots, x_n] \longrightarrow A,\quad
x_i \longmapsto a_i.
$$
This is a surjective ring map. By replacing $f_j$ by $a^Nf_j$ we may
assume that $f_j \in R[x_1, \ldots, x_n]$ and that
$\Psi(f_j) = 0$ (since after all $f_j(a_1/1, \ldots, a_n/1) = 0$
in $A_a$). Let $J = \Ker(\Psi)$. Then $A = R[x_1, \ldots, x_n]/J$
is a presentation and $f_1, \ldots, f_c \in J$ are elements such that
$(J/J^2)_a$ is freely generated by $f_1, \ldots, f_c$ and such
that $\det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}$
maps to an invertible element of $A_a$. It follows that
(\ref{equation-elementary-standard-one}) and
(\ref{equation-elementary-standard-two})
hold for $a^e$ and all large enough $e$ as desired.
\end{proof}






\section{Intermezzo: N\'eron desingularization}
\label{section-neron}

\noindent
We interrupt the attack on the general case of Popescu's theorem to
an easier but already very interesting case, namely, when
$R \to \Lambda$ is a homomorphism of discrete valuation rings.
This is discussed in
\cite[Section 4]{Artin-Algebraic-Approximation}.

\begin{situation}
\label{situation-neron}
Here $R \subset \Lambda$ is an extension of discrete valuation rings
with ramification index $1$ (More on Algebra, Definition
\ref{more-algebra-definition-extension-discrete-valuation-rings}).
We assume given a factorization
$$
R \to A \xrightarrow{\varphi} \Lambda
$$
with $R \to A$ flat and of finite type. Let $\mathfrak q = \Ker(\varphi)$
and $\mathfrak p = \varphi^{-1}(\mathfrak m_\Lambda)$.
\end{situation}

\noindent
In Situation \ref{situation-neron} let $\pi \in R$ be a uniformizer.
Recall that flatness of $A$ over $R$ signifies that $\pi$
is a nonzerodivisor on $A$
(More on Algebra, Lemma
\ref{more-algebra-lemma-valuation-ring-torsion-free-flat}).
By our assumption on $R \subset \Lambda$ we see that $\pi$ maps
to a uniformizer of $\Lambda$. Since $\pi \in \mathfrak p$ we can consider
N\'eron's affine blowup algebra (see
Algebra, Section \ref{algebra-section-blow-up})
$$
\varphi' :
A' = A[\textstyle{\frac{\mathfrak p}{\pi}}]
\longrightarrow
\Lambda
$$
which comes endowed with an induced map to $\Lambda$ sending
$a/\pi^n$, $a \in \mathfrak p^n$ to $\pi^{-n}\varphi(a)$ in $\Lambda$.
We will denote $\mathfrak q' \subset \mathfrak p' \subset A'$
the corresponding prime ideals of $A'$. Observe that the isomorphism
class of $A'$ does not depend on our choice of uniformizer.
Repeating the construction we obtain a sequence
$$
A \to A' \to A'' \to \ldots \to \Lambda
$$

\begin{lemma}
\label{lemma-neron-functorial}
In Situation \ref{situation-neron} N\'eron's blowup is functorial
in the following sense
\begin{enumerate}
\item if $a \in A$, $a \not \in \mathfrak p$, then N\'eron's blowup
of $A_a$ is $A'_a$, and
\item if $B \to A$ is a surjection of flat finite type $R$-algebras
with kernel $I$, then $A'$ is the quotient of $B'/IB'$ by its
$\pi$-power torsion.
\end{enumerate}
\end{lemma}

\begin{proof}
Both (1) and (2) are special cases of
Algebra, Lemma \ref{algebra-lemma-blowup-base-change}.
In fact, whenever we have $A_1 \to A_2 \to \Lambda$ such that
$\mathfrak p_1 A_2 = \mathfrak p_2$, we have that $A_2'$ is
the quotient of $A_1' \otimes_{A_1} A_2$ by its $\pi$-power torsion.
\end{proof}

\begin{lemma}
\label{lemma-neron-blowup-smooth}
In Situation \ref{situation-neron} assume that $R \to A$ is smooth
at $\mathfrak p$ and that $R/\pi R \subset \Lambda/\pi \Lambda$
is a separable field extension. Then $R \to A'$ is smooth at
$\mathfrak p'$ and there is a short exact sequence
$$
\Omega_{A/R} \otimes_A A'_{\mathfrak p'} \to
\Omega_{A'/R, \mathfrak p'} \to
(A'/\pi A')_{\mathfrak p'}^{\oplus c} \to 0
$$
where $c = \dim((A/\pi A)_\mathfrak p)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-neron-functorial} we may replace $A$ by a localization
at an element not in $\mathfrak p$; we will use this without further mention.
Write $\kappa = R/\pi R$. Since smoothness is stable under base change
(Algebra, Lemma \ref{algebra-lemma-base-change-smooth})
we see that $A/\pi A$ is smooth over $\kappa$ at $\mathfrak p$.
Hence $(A/\pi A)_\mathfrak p$ is a regular local ring
(Algebra, Lemma \ref{algebra-lemma-characterize-smooth-over-field}).
Choose $g_1, \ldots, g_c \in \mathfrak p$ which map to
a regular system of parameters in $(A/\pi A)_\mathfrak p$.
Then we see that $\mathfrak p = (\pi, g_1, \ldots, g_c)$
after possibly replacing $A$ by a localization.
Note that $\pi, g_1, \ldots, g_c$ is a regular sequence
in $A_\mathfrak p$ (first $\pi$ is a nonzerodivisor and
then Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}
for the rest of the sequence).
After replacing $A$ by a localization we may assume that
$\pi, g_1, \ldots, g_c$ is a regular sequence in $A$
(Algebra, Lemma \ref{algebra-lemma-regular-sequence-in-neighbourhood}).
It follows that
$$
A' = A[y_1, \ldots, y_c]/(\pi y_1 - g_1, \ldots, \pi y_c - g_c)
$$
by More on Algebra, Lemma \ref{more-algebra-lemma-blowup-regular-sequence}.
The exact sequence of Algebra, Lemma \ref{algebra-lemma-differential-seq}
for the surjection $A[y_1, \ldots, y_c] \to A'$
produces an exact sequence
$$
(A')^{\oplus c} \longrightarrow
\Omega_{A/R} \otimes_A A' \oplus
\bigoplus\nolimits_{i = 1, \ldots, c} A' \text{d}y_i \longrightarrow
\Omega_{A'/R} \to 0
$$
where the $i$the basis element in the first module is mapped
to $- \text{d}g_i + \pi \text{d}y_i$ in the second. To finish the proof it
therefore suffices to show that $\text{d}g_1, \ldots, \text{d}g_c$
forms part of a basis for $\Omega_{A/R, \mathfrak p}$.
Since $\Omega_{A/R, \mathfrak p}$ is a finite free $A_\mathfrak p$-module
(part of the definition of smoothness) it suffices to show
that the images of $\text{d}g_i$ are $\kappa(\mathfrak p)$-linearly
independent in
$\Omega_{A/R, \mathfrak p}/\pi = \Omega_{(A/\pi A)/\kappa, \mathfrak p}$
(equality by Algebra, Lemma \ref{algebra-lemma-differentials-base-change}).
Since $\kappa \subset \kappa(\mathfrak p) \subset \Lambda/\pi \Lambda$
we see that $\kappa(\mathfrak p)$ is separable over $\kappa$
(Algebra, Definition \ref{algebra-definition-separable-field-extension}).
The desired linear independence now follows from
Algebra, Lemma \ref{algebra-lemma-computation-differential}.
\end{proof}

\begin{lemma}
\label{lemma-neron-when-smooth}
In Situation \ref{situation-neron} assume that $R \to A$ is smooth
at $\mathfrak q$ and that we have a surjection of $R$-algebras
$B \to A$ with kernel $I$. Assume $R \to B$ smooth at
$\mathfrak p_B = (B \to A)^{-1}\mathfrak p$. If the cokernel of
$$
I/I^2 \otimes_A \Lambda \to \Omega_{B/R} \otimes_B \Lambda
$$
is a free $\Lambda$-module, then $R \to A$ is smooth at $\mathfrak p$.
\end{lemma}

\begin{proof}
The cokernel of the map $I/I^2 \to \Omega_{B/R} \otimes_B A$
is $\Omega_{A/R}$, see Algebra, Lemma \ref{algebra-lemma-differential-seq}.
Let $d = \dim_\mathfrak q(A/R)$ be the relative dimension of $R \to A$
at $\mathfrak q$, i.e., the dimension of $\Spec(A[1/\pi])$ at $\mathfrak q$.
See Algebra, Definition \ref{algebra-definition-relative-dimension}.
Then $\Omega_{A/R, \mathfrak q}$ is free over $A_\mathfrak q$ of rank $d$
(Algebra, Lemma \ref{algebra-lemma-characterize-smooth-over-field}).
Thus if the hypothesis of the lemma holds,
then $\Omega_{A/R} \otimes_A \Lambda$ is free of rank $d$.
It follows that $\Omega_{A/R} \otimes_A \kappa(\mathfrak p)$
has dimension $d$ (as it is true upon tensoring with $\Lambda/\pi \Lambda$).
Since $R \to A$ is flat and since $\mathfrak p$
is a specialization of $\mathfrak q$, we see that
$\dim_\mathfrak p(A/R) \geq d$ by Algebra, Lemma
\ref{algebra-lemma-dimension-fibres-bounded-open-upstairs}.
Then it follows that $R \to A$ is smooth at $\mathfrak p$ by
Algebra, Lemmas \ref{algebra-lemma-flat-fibre-smooth} and
\ref{algebra-lemma-characterize-smooth-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-neron-desingularization}
In Situation \ref{situation-neron}
assume that $R \to A$ is smooth at $\mathfrak q$
and that $R/\pi R \subset \Lambda/\pi \Lambda$ is a separable
extension of fields. Then after a finite number of affine N\'eron
blowups the algebra $A$ becomes smooth over $R$ at $\mathfrak p$.
\end{lemma}

\begin{proof}
We choose an $R$-algebra $B$ and a surjection $B \to A$. Set
$\mathfrak p_B = (B \to A)^{-1}(\mathfrak p)$ and denote $r$
the relative dimension of $R \to B$ at $\mathfrak p_B$. We choose $B$
such that $R \to B$ is smooth at $\mathfrak p_B$.
For example we can take $B$ to be a polynomial algebra in $r$ variables
over $R$. Consider the complex
$$
I/I^2 \otimes_A \Lambda \longrightarrow \Omega_{B/R} \otimes_B \Lambda
$$
of Lemma \ref{lemma-neron-when-smooth}. By the structure of finite modules
over $\Lambda$ (More on Algebra, Lemma \ref{more-algebra-lemma-modules-PID})
we see that the cokernel looks like
$$
\Lambda^{\oplus d} \oplus
\bigoplus\nolimits_{i = 1, \ldots, n} \Lambda/\pi^{e_i} \Lambda
$$
for some $d \geq 0$, $n \geq 0$, and $e_i \geq 1$. Observe that $d$
is the relative dimension of $A/R$ at $\mathfrak q$
(Algebra, Lemma \ref{algebra-lemma-characterize-smooth-over-field}).
If the defect $e = \sum_{i = 1, \ldots, n} e_i$ is zero, then we are done by
Lemma \ref{lemma-neron-when-smooth}.

\medskip\noindent
Next, we consider what happens when we perform the N\'eron blowup.
Recall that $A'$ is the quotient of $B'/IB'$ by its $\pi$-power
torsion (Lemma \ref{lemma-neron-functorial}) and that $R \to B'$ is smooth at
$\mathfrak p_{B'}$ (Lemma \ref{lemma-neron-blowup-smooth}).
Thus after blowup we have exactly the same setup. Picture
$$
\xymatrix{
0 \ar[r] & I' \ar[r] & B' \ar[r] & A' \ar[r] & 0 \\
0 \ar[r] & I \ar[u] \ar[r] & B \ar[u] \ar[r] & A \ar[r] \ar[u] & 0
}
$$
Since $I \subset \mathfrak p_B$, we see that $I \to I'$
factors through $\pi I'$. Hence if we look at the induced map of
complexes we get
$$
\xymatrix{
I'/(I')^2 \otimes_{A'} \Lambda \ar[r] &
\Omega_{B'/R} \otimes_{B'} \Lambda \ar@{=}[r] & M' \\
I/I^2 \otimes_A \Lambda \ar[r] \ar[u] &
\Omega_{B/R} \otimes_B \Lambda \ar[u] \ar@{=}[r] & M
}
$$
Let $c = \dim((B/\pi B)_{\mathfrak p_B})$. Observe that $M \subset M'$
are free $\Lambda$-modules of rank $r$. The quotient $M'/M$
has length at most $c$ by Lemma \ref{lemma-neron-blowup-smooth}.
Let $N \subset M$ and $N' \subset M'$ be the images of the horizontal
maps. Then $N \subset N'$ are free $\Lambda$-modules of rank $r - d$.
Since $I$ maps into $\pi I'$ we see that $N \subset \pi N'$.
Hence $N'/N$ has length at least $r - d$.
We conclude by a simple lemma with modules over
discrete valuation rings that $e$ decreases by at least
$r - d - c$ (we will see below this quantity is $\geq 0$).

\medskip\noindent
Since $B$ is smooth over $R$ of relative dimension $r$ at $\mathfrak p_B$
we see that $r = c + \text{trdeg}_\kappa(\kappa(\mathfrak p_B))$ by
Algebra, Lemma \ref{algebra-lemma-dimension-at-a-point-finite-type-field}.
Let $J = \Ker(A \to A_\mathfrak q)$ so that $A/J$ is a domain
with $A_\mathfrak q = (A/J)_\mathfrak q$. It follows that
$A_g = (A/J)_g$ for some $g \in A$, $g \not \in \mathfrak q$
and hence $\dim_\mathfrak q((A/J)/R)$ is $d$ as this is true for $A$.
By the same lemma as before applied twice, the fraction field of $A/J$
has transcendence degree $d$ over the field $R[1/\pi]$.
Applying the dimension formula
(Algebra, Lemma \ref{algebra-lemma-dimension-formula})
to $R \to A/J$ we find
$$
1 \leq \dim((A/J)_\mathfrak p) \leq 1 + d -
\text{trdeg}_\kappa(\kappa(\mathfrak p)) = 1 + d - r + c
$$
First inequality as $(A/J)_\mathfrak p$ has at least two primes.
Equality as $\kappa(\mathfrak p) = \kappa(\mathfrak p_B)$.
Thus we see that $r - d - c \geq 0$ and zero if and only if $r = d + c$.

\medskip\noindent
To finish the proof we have to show that $N'$ is strictly bigger
than $\pi^{-1}N$; this is the key computation one has to do
in N\'eron's argument. To do this, we consider the exact sequence
$$
I/I^2 \otimes_B \kappa(\mathfrak p_B)
\to \Omega_{B/R} \otimes_B \kappa(\mathfrak p_B)
\to \Omega_{A/R} \otimes_A \kappa(\mathfrak p) \to 0
$$
(follows from Algebra, Lemma \ref{algebra-lemma-differential-seq}).
Since we may assume that $R \to A$ is not
smooth at $\mathfrak p$ we see that the dimension $s$ of
$\Omega_{A/R} \otimes_A \kappa(\mathfrak p)$
is bigger than $d$. On the other hand
the first arrow factors through the injective map
$$
\mathfrak p B_\mathfrak p/\mathfrak p^2 B_\mathfrak p
\to \Omega_{B/R} \otimes_B \kappa(\mathfrak p_B)
$$
of Algebra, Lemma \ref{algebra-lemma-computation-differential};
note that $\kappa(\mathfrak p)$ is separable over $k$
by our assumption on $R/\pi R \subset \Lambda/\pi \Lambda$.
Hence we conclude that we can find generators
$g_1, \ldots, g_r \in I$ such that $g_j \in \mathfrak p^2$
for $j > r - s$. Then the images of $g_j$ in $A'$ are in $\pi^2 I'$
for $j > r - s$. Since $r - s < r - d$
we find that at least one of the minimal generators
of $N$ becomes divisible by $\pi^2$ in $N'$.
Thus we see that $e$ decreases by at least $1$ and we win.
\end{proof}

\noindent
If $R \to \Lambda$ is an extension of discrete valuation rings,
then $R \to \Lambda$ is regular if and only if
(a) the ramification index is $1$,
(b) the extension of fraction fields is separable, and
(c) $R/\mathfrak m_R \subset \Lambda/\mathfrak m_\Lambda$
is separable. Thus the following result is a special case
of general N\'eron desingularization in
Theorem \ref{theorem-popescu}.

\begin{lemma}
\label{lemma-neron-colimit}
\begin{slogan}
Unramified extensions of DVRs are ind-smooth AKA N\'eron desingularization
\end{slogan}
Let $R \subset \Lambda$ be an extension of discrete valuation
rings which has ramification index $1$ and induces a separable
extension of residue fields and of fraction fields.
Then $\Lambda$ is a filtered colimit of smooth $R$-algebras.
\end{lemma}

\begin{proof}
By Algebra, Lemma \ref{algebra-lemma-when-colimit} it suffices to show
that any $R \to A \to \Lambda$ as in Situation \ref{situation-neron}
can be factored as $A \to B \to \Lambda$ with $B$ a
smooth $R$-algebra. After replacing $A$ by its image in $\Lambda$
we may assume that $A$ is a domain whose fraction field $K$
is a subfield of the fraction field of $\Lambda$.
In particular, $A$ is separable over the fraction field of $R$
by our assumptions. Then $R \to A$ is smooth at $\mathfrak q = (0)$ by
Algebra, Lemma \ref{algebra-lemma-smooth-at-generic-point}.
After a finite number of N\'eron blowups, we may assume $R \to A$
is smooth at $\mathfrak p$, see Lemma \ref{lemma-neron-desingularization}.
Then, after replacing $A$ by a localization
at an element $a \in A$, $a \not \in \mathfrak p$ it becomes
smooth over $R$ and the lemma is proved.
\end{proof}












\section{The lifting problem}
\label{section-lifting}

\noindent
The goal in this section is to prove (Proposition \ref{proposition-lift})
that the collection of algebras which are filtered colimits of smooth algebras
is closed under infinitesimal flat deformations. The proof is elementary
and only uses the results on presentations of smooth algebras from
Section \ref{section-presentations}.

\begin{lemma}
\label{lemma-lift-once}
Let $R \to \Lambda$ be a ring map. Let $I \subset R$ be an ideal.
Assume that
\begin{enumerate}
\item $I^2 = 0$, and
\item $\Lambda/I\Lambda$ is a filtered colimit of smooth $R/I$-algebras.
\end{enumerate}
Let $\varphi : A \to \Lambda$ be an $R$-algebra map with $A$ of finite
presentation over $R$. Then there exists a factorization
$$
A \to B/J \to \Lambda
$$
where $B$ is a smooth $R$-algebra and $J \subset IB$ is a finitely generated
ideal.
\end{lemma}

\begin{proof}
Choose a factorization
$$
A/IA \to \bar B \to \Lambda/I\Lambda
$$
with $\bar B$ standard smooth over $R/I$; this is possible by
assumption and Lemma \ref{lemma-colimit-standard-smooth}. Write
$$
\bar B = A/IA[t_1, \ldots, t_r]/(\bar g_1, \ldots, \bar g_s)
$$
and say $\bar B \to \Lambda/I\Lambda$ maps $t_i$ to the class
of $\lambda_i$ modulo $I\Lambda$. Choose
$g_1, \ldots, g_s \in A[t_1, \ldots, t_r]$ lifting
$\bar g_1, \ldots, \bar g_s$. Write
$\varphi(g_i)(\lambda_1, \ldots, \lambda_r) =
\sum \epsilon_{ij} \mu_{ij}$
for some $\epsilon_{ij} \in I$ and $\mu_{ij} \in \Lambda$. Define
$$
A' = A[t_1, \ldots, t_r, \delta_{i, j}]/
(g_i - \sum \epsilon_{ij} \delta_{ij})
$$
and consider the map
$$
A' \longrightarrow \Lambda,\quad
a \longmapsto \varphi(a),\quad
t_i \longmapsto \lambda_i,\quad
\delta_{ij} \longmapsto \mu_{ij}
$$
We have
$$
A'/IA' = A/IA[t_1, \ldots, t_r]/(\bar g_1, \ldots, \bar g_s)[\delta_{ij}]
\cong \bar B[\delta_{ij}]
$$
This is a standard smooth algebra over $R/I$ as $\bar B$ is standard
smooth. Choose a presentation
$A'/IA' = R/I[x_1, \ldots, x_n]/(\bar f_1, \ldots, \bar f_c)$ with
$\det(\partial \bar f_j/\partial x_i)_{i, j = 1, \ldots, c}$ invertible in
$A'/IA'$. Choose lifts $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$ of
$\bar f_1, \ldots, \bar f_c$. Then
$$
B = R[x_1, \ldots, x_n, x_{n + 1}]/
(f_1, \ldots, f_c,
x_{n + 1}\det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c} - 1)
$$
is smooth over $R$. Since smooth ring maps are formally smooth
(Algebra, Proposition \ref{algebra-proposition-smooth-formally-smooth})
there exists an $R$-algebra map $B \to A'$ which is an isomorphism
modulo $I$. Then $B \to A'$ is surjective by Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK}).
Thus $A' = B/J$ with $J \subset IB$ finitely generated (see
Algebra, Lemma \ref{algebra-lemma-finite-presentation-independent}).
\end{proof}

\begin{lemma}
\label{lemma-lift-twice}
Let $R \to \Lambda$ be a ring map. Let $I \subset R$ be an ideal.
Assume that
\begin{enumerate}
\item $I^2 = 0$,
\item $\Lambda/I\Lambda$ is a filtered colimit of smooth $R/I$-algebras, and
\item $R \to \Lambda$ is flat.
\end{enumerate}
Let $\varphi : B \to \Lambda$ be an $R$-algebra map with $B$
smooth over $R$. Let $J \subset IB$ be a finitely generated ideal
such that $\varphi(J) = 0$.
Then there exists $R$-algebra maps
$$
B \xrightarrow{\alpha} B' \xrightarrow{\beta} \Lambda
$$
such that $B'$ is smooth over $R$, such that $\alpha(J) = 0$ and
such that $\beta \circ \alpha = \varphi \bmod I\Lambda$.
\end{lemma}

\begin{proof}
If we can prove the lemma in case $J = (h)$, then we can prove the
lemma by induction on the number of generators of $J$. Namely, suppose
that $J$ can be generated by $n$ elements $h_1, \ldots, h_n$ and the
lemma holds for all cases where $J$ is generated by $n - 1$ elements.
Then we apply the case $n = 1$ to produce $B \to B' \to \Lambda$
where the first map kills of $h_n$. Then we let $J'$ be the
ideal of $B'$ generated by the images of $h_1, \ldots, h_{n - 1}$
and we apply the case for $n - 1$ to produce $B' \to B'' \to \Lambda$.
It is easy to verify that $B \to B'' \to \Lambda$ does the job.

\medskip\noindent
Assume $J = (h)$ and write $h = \sum \epsilon_i b_i$
for some $\epsilon_i \in I$ and $b_i \in B$. Note that
$0 = \varphi(h) = \sum \epsilon_i \varphi(b_i)$.
As $\Lambda$ is flat over $R$, the equational criterion for
flatness (Algebra, Lemma \ref{algebra-lemma-flat-eq})
implies that we can find $\lambda_j \in \Lambda$,
$j = 1, \ldots, m$ and $a_{ij} \in R$ such that
$\varphi(b_i) = \sum_j a_{ij} \lambda_j$ and $\sum_i \epsilon_i a_{ij} = 0$.
Set
$$
C = B[x_1, \ldots, x_m]/(b_i - \sum a_{ij} x_j)
$$
with $C \to \Lambda$ given by $\varphi$ and $x_j \mapsto \lambda_j$.
Choose a factorization
$$
C \to B'/J' \to \Lambda
$$
as in Lemma \ref{lemma-lift-once}. Since $B$ is smooth over $R$ we can
lift the map $B \to C \to B'/J'$ to a map $\psi : B \to B'$. We claim that
$\psi(h) = 0$. Namely, the fact that $\psi$ agrees with
$B \to C \to B'/J'$ mod $I$ implies that
$$
\psi(b_i) = \sum a_{ij} \xi_j + \theta_i
$$
for some $\xi_i \in B'$ and $\theta_i \in IB'$. Hence we see that
$$
\psi(h) = \psi(\sum \epsilon_i b_i) =
\sum \epsilon_i a_{ij} \xi_j + \sum \epsilon_i \theta_i = 0
$$
because of the relations above and the fact that $I^2 = 0$.
\end{proof}

\begin{proposition}
\label{proposition-lift}
\begin{slogan}
Ind-smoothness of an algebra is stable under infinitesimal deformations
\end{slogan}
Let $R \to \Lambda$ be a ring map. Let $I \subset R$ be an ideal.
Assume that
\begin{enumerate}
\item $I$ is nilpotent,
\item $\Lambda/I\Lambda$ is a filtered colimit of smooth $R/I$-algebras, and
\item $R \to \Lambda$ is flat.
\end{enumerate}
Then $\Lambda$ is a filtered colimit of smooth $R$-algebras.
\end{proposition}

\begin{proof}
Since $I^n = 0$ for some $n$, it follows by induction on $n$ that
it suffices to consider the case where $I^2 = 0$. Let
$\varphi : A \to \Lambda$ be an $R$-algebra map with $A$ of finite
presentation over $R$. We have to find a factorization $A \to B \to \Lambda$
with $B$ smooth over $R$, see Algebra, Lemma \ref{algebra-lemma-when-colimit}.
By Lemma \ref{lemma-lift-once} we may assume that
$A = B/J$ with $B$ smooth over $R$ and $J \subset IB$
a finitely generated ideal. By
Lemma \ref{lemma-lift-twice}
we can find a (possibly noncommutative) diagram
$$
\xymatrix{
B \ar[rr]_\alpha \ar[rd]_\varphi & & B' \ar[ld]^\beta \\
& \Lambda
}
$$
of $R$-algebras which commutes modulo $I$ and such that $\alpha(J) = 0$.
The map
$$
D : B \longrightarrow I\Lambda,\quad
b \longmapsto \varphi(b) - \beta(\alpha(b))
$$
is a derivation over $R$ hence we can write it as
$D = \xi \circ \text{d}_{B/R}$ for some $B$-linear map
$\xi : \Omega_{B/R} \to I\Lambda$. Since $\Omega_{B/R}$ is a
finite projective $B$-module we can write
$\xi = \sum_{i = 1, \ldots, n} \epsilon_i \Xi_i$
for some $\epsilon_i \in I$ and $B$-linear maps
$\Xi_i : \Omega_{B/R} \to \Lambda$.
(Details omitted. Hint: write $\Omega_{B/R}$ as a direct sum of
a finite free module to reduce to the finite free case.)
We define
$$
B'' = \text{Sym}^*_{B'}\left(\bigoplus\nolimits_{i = 1, \ldots, n}
\Omega_{B/R} \otimes_{B, \alpha} B'\right)
$$
and we define $\beta' : B'' \to \Lambda$ by
$\beta$ on $B'$ and by
$$
\beta'|_{i\text{th summand }\Omega_{B/R} \otimes_{B, \alpha} B'} =
\Xi_i \otimes \beta
$$
and $\alpha' : B \to B''$ by
$$
\alpha'(b) =
\alpha(b) \oplus \sum \epsilon_i \text{d}_{B/R}(b) \otimes 1
\oplus 0 \oplus \ldots
$$
At this point the diagram
$$
\xymatrix{
B \ar[rr]_{\alpha'} \ar[rd]_\varphi & & B'' \ar[ld]^{\beta'} \\
& \Lambda
}
$$
does commute. Moreover, it is direct from the definitions that
$\alpha'(J) = 0$ as $I^2 = 0$. Hence the desired factorization.
\end{proof}






\section{The lifting lemma}
\label{section-lifting-lemma}

\noindent
Here is a fiendishly clever lemma.

\begin{lemma}
\label{lemma-lifting}
Let $R$ be a Noetherian ring. Let $\Lambda$ be an $R$-algebra.
Let $\pi \in R$ and assume that $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$ and
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
Suppose we have $R$-algebra maps
$R/\pi^2R \to \bar C \to \Lambda/\pi^2\Lambda$
with $\bar C$ of finite presentation.
Then there exists an $R$-algebra homomorphism
$D \to \Lambda$ and a commutative diagram
$$
\xymatrix{
R/\pi^2R \ar[r] \ar[d] &
\bar C \ar[r] \ar[d] &
\Lambda/\pi^2\Lambda \ar[d] \\
R/\pi R \ar[r] &
D/\pi D \ar[r] &
\Lambda/\pi \Lambda
}
$$
with the following properties
\begin{enumerate}
\item[(a)] $D$ is of finite presentation,
\item[(b)] $R \to D$ is smooth at any prime $\mathfrak q$ with
$\pi \not \in \mathfrak q$,
\item[(c)] $R \to D$ is smooth at any prime $\mathfrak q$ with
$\pi \in \mathfrak q$ lying over a prime of $\bar C$ where
$R/\pi^2 R \to \bar C$ is smooth, and
\item[(d)] $\bar C/\pi \bar C \to D/\pi D$ is smooth at any prime
lying over a prime of $\bar C$ where $R/\pi^2R \to \bar C$ is smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
We choose a presentation
$$
\bar C = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)
$$
We also denote $I = (f_1, \ldots, f_m)$ and $\bar I$ the image of
$I$ in $R/\pi^2R[x_1, \ldots, x_n]$. Since $R$ is Noetherian, so is
$\bar C$. Hence the smooth locus of $R/\pi^2 R \to \bar C$
is quasi-compact, see
Topology, Lemma \ref{topology-lemma-Noetherian}.
Applying
Lemma \ref{lemma-find-strictly-standard}
we may choose a finite list of elements
$a_1, \ldots, a_r \in R[x_1, \ldots, x_n]$ such that
\begin{enumerate}
\item the union of the open subspaces
$\Spec(\bar C_{a_k}) \subset \Spec(\bar C)$
cover the smooth locus of $R/\pi^2 R \to \bar C$, and
\item for each $k = 1, \ldots, r$ there exists a finite subset
$E_k \subset \{1, \ldots, m\}$ such that
$(\bar I/\bar I^2)_{a_k}$ is freely generated by the classes of
$f_j$, $j \in E_k$.
\end{enumerate}
Set $I_k = (f_j, j \in E_k) \subset I$ and denote $\bar I_k$ the
image of $I_k$ in $R/\pi^2R[x_1, \ldots, x_n]$.
By (2) and Nakayama's lemma we see that $(\bar I/\bar I_k)_{a_k}$
is annihilated by $1 + b'_k$ for some $b'_k \in \bar I_{a_k}$.
Suppose $b'_k$ is the image of $b_k/(a_k)^N$ for some $b_k \in I$
and some integer $N$. After replacing $a_k$ by $a_kb_k$ we get
\begin{enumerate}
\item[(3)] $(\bar I_k)_{a_k} = (\bar I)_{a_k}$.
\end{enumerate}
Thus, after possibly replacing $a_k$ by a high power, we may write
\begin{enumerate}
\item[(4)]
$a_k f_\ell = \sum\nolimits_{j \in E_k} h_{k, \ell}^jf_j + \pi^2 g_{k, \ell}$
\end{enumerate}
for any $\ell \in \{1, \ldots, m\}$ and some
$h_{i, \ell}^j, g_{i, \ell} \in R[x_1, \ldots, x_n]$.
If $\ell \in E_k$ we choose $h_{k, \ell}^j = a_k\delta_{\ell, j}$
(Kronecker delta) and $g_{k, \ell} = 0$. Set
$$
D = R[x_1, \ldots, x_n, z_1, \ldots, z_m]/
(f_j - \pi z_j, p_{k, \ell}).
$$
Here $j \in \{1, \ldots, m\}$, $k \in \{1, \ldots, r\}$,
$\ell \in \{1, \ldots, m\}$, and
$$
p_{k, \ell} = a_k z_\ell - \sum\nolimits_{j \in E_k} h_{k, \ell}^j z_j
- \pi g_{k, \ell}.
$$
Note that for $\ell \in E_k$ we have $p_{k, \ell} = 0$ by our choices above.

\medskip\noindent
The map $R \to D$ is the given one.
Say $\bar C \to \Lambda/\pi^2\Lambda$ maps $x_i$
to the class of $\lambda_i$ modulo $\pi^2$. For an element
$f \in R[x_1, \ldots, x_n]$ we denote $f(\lambda) \in \Lambda$
the result of substituting $\lambda_i$ for $x_i$. Then we know that
$f_j(\lambda) = \pi^2 \mu_j$ for some $\mu_j \in \Lambda$.
Define $D \to \Lambda$ by the rules $x_i \mapsto \lambda_i$ and
$z_j \mapsto \pi\mu_j$. This is well defined because
\begin{align*}
p_{k, \ell} & \mapsto
a_k(\lambda) \pi \mu_\ell -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(\lambda) \pi \mu_j
- \pi g_{k, \ell}(\lambda) \\
& =
\pi\left(a_k(\lambda) \mu_\ell -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(\lambda) \mu_j
- g_{k, \ell}(\lambda)\right)
\end{align*}
Substituting $x_i = \lambda_i$ in (4) above we see that the expression
inside the brackets is annihilated by $\pi^2$, hence it is annihilated
by $\pi$ as we have assumed
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
The map $\bar C \to D/\pi D$ is determined by $x_i \mapsto x_i$
(clearly well defined). Thus we are done if we can prove (b), (c), and (d).

\medskip\noindent
Using (4) we obtain the following key equality
\begin{align*}
\pi p_{k, \ell} & =
\pi a_k z_\ell - \sum\nolimits_{j \in E_k} \pi h_{k, \ell}^jz_j
- \pi^2 g_{k, \ell} \\
& =
- a_k (f_\ell - \pi z_\ell) + a_k f_\ell +
\sum\nolimits_{j \in E_k} h_{k, \ell}^j (f_j - \pi z_j) -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j f_j - \pi^2 g_{k, \ell} \\
& =
-a_k(f_\ell - \pi z_\ell) +
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(f_j - \pi z_j)
\end{align*}
The end result is an element of the ideal generated by $f_j - \pi z_j$.
In particular, we see that $D[1/\pi]$ is isomorphic to
$R[1/\pi][x_1, \ldots, x_n, z_1, \ldots, z_m]/(f_j - \pi z_j)$
which is isomorphic to $R[1/\pi][x_1, \ldots, x_n]$ hence smooth
over $R$. This proves (b).

\medskip\noindent
For fixed $k \in \{1, \ldots, r\}$ consider the ring
$$
D_k = R[x_1, \ldots, x_n, z_1, \ldots, z_m]/
(f_j - \pi z_j, j \in E_k, p_{k, \ell})
$$
The number of equations is $m = |E_k| + (m - |E_k|)$ as $p_{k, \ell}$
is zero if $\ell \in E_k$. Also, note that
\begin{align*}
(D_k/\pi D_k)_{a_k}
& =
R/\pi R[x_1, \ldots, x_n, 1/a_k, z_1, \ldots, z_m]/
(f_j, j \in E_k, p_{k, \ell}) \\
& =
(\bar C/\pi \bar C)_{a_k}[z_1, \ldots, z_m]/
(a_kz_\ell - \sum\nolimits_{j \in E_k} h_{k, \ell}^j z_j) \\
& \cong
(\bar C/\pi \bar C)_{a_k}[z_j, j \in E_k]
\end{align*}
In particular $(D_k/\pi D_k)_{a_k}$ is smooth over $(\bar C/\pi \bar C)_{a_k}$.
By our choice of $a_k$ we have that $(\bar C/\pi \bar C)_{a_k}$ is smooth
over $R/\pi R$ of relative dimension $n - |E_k|$, see (2). Hence for a prime
$\mathfrak q_k \subset D_k$ containing $\pi$ and lying over
$\Spec(\bar C_{a_k})$ the fibre ring of $R \to D_k$
is smooth at $\mathfrak q_k$ of dimension $n$. Thus $R \to D_k$ is syntomic
at $\mathfrak q_k$ by our count of the number of equations above, see
Algebra, Lemma \ref{algebra-lemma-localize-relative-complete-intersection}.
Hence $R \to D_k$ is smooth at $\mathfrak q_k$, see
Algebra, Lemma \ref{algebra-lemma-flat-fibre-smooth}.

\medskip\noindent
To finish the proof, let $\mathfrak q \subset D$ be a prime
containing $\pi$ lying over a prime where $R/\pi^2 R \to \bar C$
is smooth. Then $a_k \not \in \mathfrak q$ for some $k$ by (1).
We will show that the surjection $D_k \to D$ induces
an isomorphism on local rings at $\mathfrak q$. Since we know that
the ring maps $\bar C/\pi \bar C \to D_k/\pi D_k$ and
$R \to D_k$ are smooth at the corresponding prime $\mathfrak q_k$
by the preceding paragraph this will prove (c) and (d) and thus
finish the proof.

\medskip\noindent
First, note that for any $\ell$ the equation
$\pi p_{k, \ell} = -a_k(f_\ell - \pi z_\ell) +
\sum_{j \in E_k} h_{k, \ell}^j (f_j - \pi z_j)$ proved above shows that
$f_\ell - \pi z_\ell$ maps to zero in $(D_k)_{a_k}$ and in particular
in $(D_k)_{\mathfrak q_k}$.
The relations (4) imply that $a_k f_\ell =
\sum_{j \in E_k} h_{k, \ell}^j f_j$ in $I/I^2$.
Since $(\bar I_k/\bar I_k^2)_{a_k}$ is free on $f_j$, $j \in E_k$
we see that
$$
a_{k'} h_{k, \ell}^j -
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'} h_{k, j'}^j
$$
is zero in $\bar C_{a_k}$ for every $k, k', \ell$ and $j \in E_k$.
Hence we can find a large integer $N$ such that
$$
a_k^N\left(
a_{k'} h_{k, \ell}^j -
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'} h_{k, j'}^j
\right)
$$
is in $I_k + \pi^2R[x_1, \ldots, x_n]$. Computing modulo $\pi$ we have
\begin{align*}
&
a_kp_{k', \ell} - a_{k'}p_{k, \ell} + \sum h_{k', \ell}^{j'} p_{k, j'}
\\
&
=
- a_k \sum h_{k', \ell}^{j'} z_{j'}
+ a_{k'} \sum h_{k, \ell}^j z_j
+ \sum h_{k', \ell}^{j'} a_k z_{j'}
- \sum \sum h_{k', \ell}^{j'} h_{k, j'}^j z_j \\
&
=
\sum \left(
a_{k'} h_{k, \ell}^j
- \sum h_{k', \ell}^{j'} h_{k, j'}^j
\right) z_j
\end{align*}
with Einstein summation convention. Combining with the above we see
$a_k^{N + 1} p_{k', \ell}$ is contained in the ideal generated
by $I_k$ and $\pi$ in $R[x_1, \ldots, x_n, z_1, \ldots, z_m]$.
Thus $p_{k', \ell}$ maps into $\pi (D_k)_{a_k}$. On the other hand,
the equation
$$
\pi p_{k', \ell} =
-a_{k'} (f_\ell - \pi z_\ell) +
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'}(f_{j'} - \pi z_{j'})
$$
shows that $\pi p_{k', \ell}$ is zero in $(D_k)_{a_k}$.
Since we have assumed that $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$
and since $(D_k)_{\mathfrak q_k}$ is smooth hence flat over $R$
we see that
$\text{Ann}_{(D_k)_{\mathfrak q_k}}(\pi) =
\text{Ann}_{(D_k)_{\mathfrak q_k}}(\pi^2)$.
We conclude that $p_{k', \ell}$ maps to zero as well, hence
$D_{\mathfrak q} = (D_k)_{\mathfrak q_k}$ and we win.
\end{proof}






\section{The desingularization lemma}
\label{section-desingularization-lemma}

\noindent
Here is another fiendishly clever lemma.

\begin{lemma}
\label{lemma-desingularize}
Let $R$ be a Noetherian ring.
Let $\Lambda$ be an $R$-algebra. Let $\pi \in R$ and
assume that $\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$. Let
$A \to \Lambda$ be an $R$-algebra map with $A$ of finite
presentation. Assume
\begin{enumerate}
\item the image of $\pi$ is strictly standard in $A$ over $R$, and
\item there exists a section $\rho : A/\pi^4 A \to R/\pi^4 R$
which is compatible with the map to $\Lambda/\pi^4 \Lambda$.
\end{enumerate}
Then we can find $R$-algebra maps $A \to B \to \Lambda$ with $B$
of finite presentation such that $\mathfrak a B \subset H_{B/R}$ where
$\mathfrak a = \text{Ann}_R(\text{Ann}_R(\pi^2)/\text{Ann}_R(\pi))$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)
$$
and $0 \leq c \leq \min(n, m)$ such that
(\ref{equation-strictly-standard-one}) holds for $\pi$ and such that
\begin{equation}
\label{equation-star}
\pi f_{c + j} \in (f_1, \ldots, f_c) + (f_1, \ldots, f_m)^2
\end{equation}
for $j = 1, \ldots, m - c$. Say $\rho$ maps $x_i$ to the class of
$r_i \in R$. Then we can replace $x_i$ by $x_i - r_i$. Hence we may
assume $\rho(x_i) = 0$ in $R/\pi^4 R$. This implies that
$f_j(0) \in \pi^4R$ and that $A \to \Lambda$ maps $x_i$
to $\pi^4\lambda_i$ for some $\lambda_i \in \Lambda$. Write
$$
f_j = f_j(0) + \sum\nolimits_{i = 1, \ldots, n} r_{ji} x_i + \text{h.o.t.}
$$
This implies that the constant term of $\partial f_j/\partial x_i$ is
$r_{ji}$. Apply $\rho$ to (\ref{equation-strictly-standard-one})
for $\pi$ and we see that
$$
\pi = \sum\nolimits_{I \subset \{1, \ldots, n\},\ |I| = c}
r_I \det(r_{ji})_{j = 1, \ldots, c,\ i \in I} \bmod \pi^4R
$$
for some $r_I \in R$. Thus we have
$$
u\pi = \sum\nolimits_{I \subset \{1, \ldots, n\},\ |I| = c}
r_I \det(r_{ji})_{j = 1, \ldots, c,\ i \in I}
$$
for some $u \in 1 + \pi^3R$. By
Algebra, Lemma \ref{algebra-lemma-matrix-left-inverse}
this implies there exists a $n \times c$ matrix $(s_{ik})$ such that
$$
u\pi \delta_{jk} = \sum\nolimits_{i = 1, \ldots, n} r_{ji}s_{ik}\quad
\text{for all } j, k = 1, \ldots, c
$$
(Kronecker delta). We introduce auxiliary variables
$v_1, \ldots, v_c, w_1, \ldots, w_n$ and we set
$$
h_i = x_i - \pi^2 \sum\nolimits_{j = 1, \ldots c} s_{ij} v_j - \pi^3 w_i
$$
In the following we will use that
$$
R[x_1, \ldots, x_n, v_1, \ldots, v_c, w_1, \ldots, w_n]/
(h_1, \ldots, h_n) = R[v_1, \ldots, v_c, w_1, \ldots, w_n]
$$
without further mention. In
$R[x_1, \ldots, x_n, v_1, \ldots, v_c, w_1, \ldots, w_n]/
(h_1, \ldots, h_n)$ we have
\begin{align*}
f_j & = f_j(x_1 - h_1, \ldots, x_n - h_n) \\
& =
\pi^2 \sum\nolimits_{k = 1}^c
\left(\sum\nolimits_{i = 1}^n r_{ji} s_{ik}\right) v_k
+
\pi^3 \sum\nolimits_{i = 1}^n r_{ji}w_i \bmod \pi^4 \\
& =
\pi^3 v_j + \pi^3 \sum\nolimits_{i = 1}^n r_{ji}w_i \bmod \pi^4
\end{align*}
for $1 \leq j \leq c$. Hence we can choose elements
$g_j \in R[v_1, \ldots, v_c, w_1, \ldots, w_n]$
such that $g_j = v_j + \sum r_{ji}w_i \bmod \pi$
and such that $f_j = \pi^3 g_j$ in the $R$-algebra
$R[x_1, \ldots, x_n, v_1, \ldots, v_c, w_1, \ldots, w_n]/
(h_1, \ldots, h_n)$. We set
$$
B = R[x_1, \ldots, x_n, v_1, \ldots, v_c, w_1, \ldots, w_n]/
(f_1, \ldots, f_m, h_1, \ldots, h_n, g_1, \ldots, g_c).
$$
The map $A \to B$ is clear. We define $B \to \Lambda$ by mapping
$x_i \to \pi^4\lambda_i$, $v_i \mapsto 0$, and $w_i \mapsto \pi \lambda_i$.
Then it is clear that the elements $f_j$ and $h_i$ are mapped to zero
in $\Lambda$. Moreover, it is clear that $g_i$ is mapped to an element
$t$ of $\pi\Lambda$ such that $\pi^3t = 0$ (as $f_i = \pi^3 g_i$ modulo
the ideal generated by the $h$'s). Hence our assumption that
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$ implies that $t = 0$.
Thus we are done if we can prove the statement about smoothness.

\medskip\noindent
Note that $B_\pi \cong A_\pi[v_1, \ldots, v_c]$ because the equations
$g_i = 0$ are implied by $f_i = 0$. Hence $B_\pi$ is smooth over $R$
as $A_\pi$ is smooth over $R$ by the assumption that $\pi$ is strictly
standard in $A$ over $R$, see
Lemma \ref{lemma-elkik}.

\medskip\noindent
Set $B' = R[v_1, \ldots, v_c, w_1, \ldots, w_n]/(g_1, \ldots, g_c)$.
As $g_i = v_i + \sum r_{ji}w_i \bmod \pi$ we see that
$B'/\pi B' = R/\pi R[w_1, \ldots, w_n]$. Hence
$R \to B'$ is smooth of relative dimension $n$ at every
point of $V(\pi)$ by
Algebra, Lemmas
\ref{algebra-lemma-localize-relative-complete-intersection} and
\ref{algebra-lemma-flat-fibre-smooth}
(the first lemma shows it is syntomic at those primes, in particular
flat, whereupon the second lemma shows it is smooth).

\medskip\noindent
Let $\mathfrak q \subset B$ be a prime with $\pi \in \mathfrak q$ and
for some $r \in \mathfrak a$, $r \not \in \mathfrak q$.
Denote $\mathfrak q' = B' \cap \mathfrak q$.
We claim the surjection $B' \to B$ induces an isomorphism of local
rings $(B')_{\mathfrak q'} \to B_\mathfrak q$. This will
conclude the proof of the lemma. Note that $B_\mathfrak q$ is the
quotient of $(B')_{\mathfrak q'}$ by the ideal generated by
$f_{c + j}$, $j = 1, \ldots, m - c$. We observe two things:
first the image of $f_{c + j}$ in $(B')_{\mathfrak q'}$ is
divisible by $\pi^2$ and
second the image of $\pi f_{c + j}$ in $(B')_{\mathfrak q'}$
can be written as $\sum b_{j_1 j_2} f_{c + j_1}f_{c + j_2}$ by
(\ref{equation-star}). Thus we see that the image of each $\pi f_{c + j}$
is contained in the ideal generated by the elements $\pi^2 f_{c + j'}$.
Hence $\pi f_{c + j} = 0$ in $(B')_{\mathfrak q'}$ as this is a
Noetherian local ring, see
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero}.
As $R \to (B')_{\mathfrak q'}$ is flat we see that
$$
\left(\text{Ann}_R(\pi^2)/\text{Ann}_R(\pi)\right)
\otimes_R (B')_{\mathfrak q'}
=
\text{Ann}_{(B')_{\mathfrak q'}}(\pi^2)/\text{Ann}_{(B')_{\mathfrak q'}}(\pi)
$$
Because $r \in \mathfrak a$ is invertible in
$(B')_{\mathfrak q'}$ we see that this module is zero.
Hence we see that the image of $f_{c + j}$ is zero in
$(B')_{\mathfrak q'}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-desingularize-strictly-standard}
Let $R$ be a Noetherian ring. Let $\Lambda$ be an $R$-algebra.
Let $\pi \in R$ and assume that $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$ and
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
Let $A \to \Lambda$ and $D \to \Lambda$ be $R$-algebra maps with
$A$ and $D$ of finite presentation. Assume
\begin{enumerate}
\item $\pi$ is strictly standard in $A$ over $R$, and
\item there exists an $R$-algebra map $A/\pi^4 A \to D/\pi^4 D$ compatible
with the maps to $\Lambda/\pi^4 \Lambda$.
\end{enumerate}
Then we can find an $R$-algebra map $B \to \Lambda$ with $B$ of finite
presentation and $R$-algebra maps $A \to B$ and $D \to B$
compatible with the maps to $\Lambda$ such that $H_{D/R}B \subset H_{B/D}$
and $H_{D/R}B \subset H_{B/R}$.
\end{lemma}

\begin{proof}
We apply Lemma \ref{lemma-desingularize} to
$$
D \longrightarrow A \otimes_R D \longrightarrow \Lambda
$$
and the image of $\pi$ in $D$. By
Lemma \ref{lemma-strictly-standard-base-change}
we see that $\pi$ is strictly standard in $A \otimes_R D$ over $D$.
As our section $\rho : (A \otimes_R D)/\pi^4 (A \otimes_R D) \to D/\pi^4 D$
we take the map induced by the map in (2). Thus
Lemma \ref{lemma-desingularize} applies and we obtain a factorization
$A \otimes_R D \to B \to \Lambda$ with $B$ of finite presentation
and $\mathfrak a B \subset H_{B/D}$ where
$$
\mathfrak a = \text{Ann}_D(\text{Ann}_D(\pi^2)/\text{Ann}_D(\pi)).
$$
For any prime $\mathfrak q$ of $D$ such that $D_\mathfrak q$ is flat over $R$
we have
$\text{Ann}_{D_\mathfrak q}(\pi^2)/\text{Ann}_{D_\mathfrak q}(\pi) = 0$
because annihilators of elements commutes with flat base change and
we assumed $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$. Because $D$ is
Noetherian we see that $\text{Ann}_D(\pi^2)/\text{Ann}_D(\pi)$ is a finite
$D$-module, hence formation of its annihilator commutes with localization.
Thus we see that $\mathfrak a \not \subset \mathfrak q$. Hence we see
that $D \to B$ is smooth at any prime of $B$ lying over $\mathfrak q$.
Since any prime of $D$ where $R \to D$ is smooth is one where
$D_\mathfrak q$ is flat over $R$ we conclude that $H_{D/R}B \subset H_{B/D}$.
The final inclusion $H_{D/R}B \subset H_{B/R}$ follows because compositions
of smooth ring maps are smooth
(Algebra, Lemma \ref{algebra-lemma-compose-smooth}).
\end{proof}

\begin{lemma}
\label{lemma-desingularize-lifting-apply}
Let $R$ be a Noetherian ring. Let $\Lambda$ be an $R$-algebra.
Let $\pi \in R$ and assume that $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$ and
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
Let $A \to \Lambda$ be an $R$-algebra map with
$A$ of finite presentation and assume $\pi$ is strictly standard
in $A$ over $R$. Let
$$
A/\pi^8A \to \bar C \to \Lambda/\pi^8\Lambda
$$
be a factorization with $\bar C$ of finite presentation.
Then we can find a factorization $A \to B \to \Lambda$ with $B$ of finite
presentation such that $R_\pi \to B_\pi$ is smooth and such that
$$
H_{\bar C/(R/\pi^8 R)} \cdot \Lambda/\pi^8\Lambda
\subset
\sqrt{H_{B/R} \Lambda} \bmod \pi^8\Lambda.
$$
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-lifting} to get $R \to D \to \Lambda$
with a factorization
$\bar C/\pi^4\bar C \to D/\pi^4 D \to \Lambda/\pi^4\Lambda$
such that $R \to D$ is smooth at any prime not containing $\pi$
and at any prime lying over a prime of $\bar C/\pi^4\bar C$
where $R/\pi^8 R \to \bar C$ is smooth.
By Lemma \ref{lemma-desingularize-strictly-standard}
we can find a finitely presented $R$-algebra $B$ and
factorizations $A \to B \to \Lambda$ and $D \to B \to \Lambda$
such that $H_{D/R}B \subset H_{B/R}$. We omit the verification that
this is a solution to the problem posed by the lemma.
\end{proof}












\section{Warmup: reduction to a base field}
\label{section-reduction}

\noindent
In this section we apply the lemmas in the previous sections
to prove that it suffices to prove the main result when the base
ring is a field, see Lemma \ref{lemma-reduce-to-field}.

\begin{situation}
\label{situation-global}
Here $R \to \Lambda$ is a regular ring map of Noetherian rings.
\end{situation}

\noindent
Let $R \to \Lambda$ be as in Situation \ref{situation-global}.
We say {\it PT holds for $R \to \Lambda$} if $\Lambda$ is a
filtered colimit of smooth $R$-algebras.

\begin{lemma}
\label{lemma-product}
Let $R_i \to \Lambda_i$, $i = 1, 2$ be as in Situation \ref{situation-global}.
If PT holds for $R_i \to \Lambda_i$, $i = 1, 2$, then PT holds for
$R_1 \times R_2 \to \Lambda_1 \times \Lambda_2$.
\end{lemma}

\begin{proof}
Omitted. Hint: A product of colimits is a colimit.
\end{proof}

\begin{lemma}
\label{lemma-delocalize-base}
Let $R \to A \to \Lambda$ be ring maps with $A$ of finite presentation
over $R$. Let $S \subset R$ be a multiplicative
set. Let $S^{-1}A \to B' \to S^{-1}\Lambda$ be a factorization with
$B'$ smooth over $S^{-1}R$. Then we can find a factorization
$A \to B \to \Lambda$ such that some $s \in S$ maps to an elementary standard
element in $B$ over $R$.
\end{lemma}

\begin{proof}
We first apply Lemma \ref{lemma-smooth-standard-smooth} to $S^{-1}R \to B'$.
Thus we may assume $B'$ is standard smooth over $S^{-1}R$.
Write $A = R[x_1, \ldots, x_n]/(g_1, \ldots, g_t)$ and say
$x_i \mapsto \lambda_i$ in $\Lambda$. We may write
$B' = S^{-1}R[x_1, \ldots, x_{n + m}]/(f_1, \ldots, f_c)$
for some $c \geq n$ where
$\det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}$
is invertible in $B'$ and such that $A \to B'$ is given by $x_i \mapsto x_i$,
see Lemma \ref{lemma-standard-smooth-include-generators}.
After multiplying $x_i$, $i > n$ by an element of $S$ and correspondingly
modifying the equations $f_j$ we may assume $B' \to S^{-1}\Lambda$ maps
$x_i$ to $\lambda_i/1$ for some $\lambda_i \in \Lambda$ for $i > n$.
Choose a relation
$$
1 =
a_0 \det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}
+
\sum\nolimits_{j = 1, \ldots, c} a_jf_j
$$
for some $a_j \in S^{-1}R[x_1, \ldots, x_{n + m}]$. Since each element of $S$
is invertible in $B'$ we may (by clearing denominators) assume that
$f_j, a_j \in R[x_1, \ldots, x_{n + m}]$ and that
$$
s_0 = a_0 \det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}
+
\sum\nolimits_{j = 1, \ldots, c} a_jf_j
$$
for some $s_0 \in S$. Since $g_j$ maps to zero in
$S^{-1}R[x_1, \ldots, x_{n + m}]/(f_1, \ldots, x_c)$
we can find elements $s_j \in S$ such that $s_j g_j = 0$ in
$R[x_1, \ldots, x_{n + m}]/(f_1, \ldots, f_c)$.
Since $f_j$ maps to zero in $S^{-1}\Lambda$ we can find $s'_j \in S$
such that $s'_j f_j(\lambda_1, \ldots, \lambda_{n + m}) = 0$ in
$\Lambda$. Consider the ring
$$
B = R[x_1, \ldots, x_{n + m}]/
(s'_1f_1, \ldots, s'_cf_c, g_1, \ldots, g_t)
$$
and the factorization $A \to B \to \Lambda$ with $B \to \Lambda$ given by
$x_i \mapsto \lambda_i$. We claim that $s = s_0s_1 \ldots s_ts'_1 \ldots s'_c$
is elementary standard in $B$ over $R$ which finishes the proof.
Namely, $s_j g_j \in (f_1, \ldots, f_c)$ and hence
$sg_j \in (s'_1f_1, \ldots, s'_cf_c)$. Finally, we have
$$
a_0\det(\partial s'_jf_j/\partial x_i)_{i, j = 1, \ldots, c}
+
\sum\nolimits_{j = 1, \ldots, c}
(s'_1 \ldots \hat{s'_j} \ldots s'_c) a_j s'_jf_j
=
s_0s'_1\ldots s'_c
$$
which divides $s$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-reduce-to-field}
\begin{slogan}
Proving Popescu approximation reduces to algebras over a field
\end{slogan}
If for every Situation \ref{situation-global} where $R$
is a field PT holds, then PT holds in general.
\end{lemma}

\begin{proof}
Assume PT holds for any Situation \ref{situation-global} where $R$ is a field.
Let $R \to \Lambda$ be as in Situation \ref{situation-global} arbitrary.
Note that $R/I \to \Lambda/I\Lambda$ is another regular ring map
of Noetherian rings, see
More on Algebra, Lemma \ref{more-algebra-lemma-regular-base-change}.
Consider the set of ideals
$$
\mathcal{I} = \{I \subset R \mid R/I \to \Lambda/I\Lambda
\text{ does not have PT}\}
$$
We have to show that $\mathcal{I}$ is empty. If this set is nonempty,
then it contains a maximal element because $R$ is Noetherian.
Replacing $R$ by $R/I$ and $\Lambda$ by $\Lambda/I$ we obtain a
situation where PT holds for $R/I \to \Lambda/I\Lambda$ for any
nonzero ideal of $R$. In particular, we see by applying
Proposition \ref{proposition-lift}
that $R$ is a reduced ring.

\medskip\noindent
Let $A \to \Lambda$ be an $R$-algebra homomorphism with $A$ of
finite presentation. We have to find a factorization $A \to B \to \Lambda$
with $B$ smooth over $R$, see Algebra, Lemma \ref{algebra-lemma-when-colimit}.

\medskip\noindent
Let $S \subset R$ be the set of nonzerodivisors and
consider the total ring of fractions $Q = S^{-1}R$ of $R$. We know that
$Q = K_1 \times \ldots \times K_n$ is a product of fields, see
Algebra, Lemmas \ref{algebra-lemma-total-ring-fractions-no-embedded-points} and
\ref{algebra-lemma-Noetherian-irreducible-components}.
By Lemma \ref{lemma-product} and our assumption
PT holds for the ring map $S^{-1}R \to S^{-1}\Lambda$.
Hence we can find a factorization $S^{-1}A \to B' \to S^{-1}\Lambda$
with $B'$ smooth over $S^{-1}R$.

\medskip\noindent
We apply Lemma \ref{lemma-delocalize-base}
and find a factorization $A \to B \to \Lambda$ such that
some $\pi \in S$ is elementary standard in $B$ over $R$.
After replacing $A$ by $B$ we may assume that $\pi$ is
elementary standard, hence strictly standard in $A$. We know that
$R/\pi^8R \to \Lambda/\pi^8\Lambda$ satisfies PT.
Hence we can find a factorization
$R/\pi^8 R \to A/\pi^8A \to \bar C \to \Lambda/\pi^8\Lambda$
with $R/\pi^8 R \to \bar C$ smooth. By
Lemma \ref{lemma-lifting}
we can find an $R$-algebra map $D \to \Lambda$ with $D$ smooth over $R$
and a factorization
$R/\pi^4 R \to A/\pi^4A \to D/\pi^4D \to \Lambda/\pi^4\Lambda$.
By Lemma \ref{lemma-desingularize-strictly-standard}
we can find $A \to B \to \Lambda$ with $B$ smooth over $R$
which finishes the proof.
\end{proof}










\section{Local tricks}
\label{section-local}


\begin{situation}
\label{situation-local}
We are given a Noetherian ring $R$ and an $R$-algebra map $A \to \Lambda$
and a prime $\mathfrak q \subset \Lambda$. We assume $A$ is of
finite presentation over $R$. In this situation we denote
$\mathfrak h_A = \sqrt{H_{A/R} \Lambda}$.
\end{situation}

\noindent
Let $R \to A \to \Lambda \supset \mathfrak q$ be as in
Situation \ref{situation-local}. We say
{\it $R \to A \to \Lambda \supset \mathfrak q$
can be resolved} if there exists a factorization $A \to B \to \Lambda$
with $B$ of finite presentation and
$\mathfrak h_A \subset \mathfrak h_B \not \subset \mathfrak q$.
In this case we will call the factorization $A \to B \to \Lambda$
a {\it resolution of $R \to A \to \Lambda \supset \mathfrak q$}.

\begin{lemma}
\label{lemma-lift-solution}
Let $R \to A \to \Lambda \supset \mathfrak q$ be as in
Situation \ref{situation-local}. Let $r \geq 1$ and
$\pi_1, \ldots, \pi_r \in R$ map to elements of $\mathfrak q$. Assume
\begin{enumerate}
\item for $i = 1, \ldots, r$ we have
$$
\text{Ann}_{R/(\pi_1^8, \ldots, \pi_{i - 1}^8)R}(\pi_i)
=
\text{Ann}_{R/(\pi_1^8, \ldots, \pi_{i - 1}^8)R}(\pi_i^2)
$$
and
$$
\text{Ann}_{\Lambda/(\pi_1^8, \ldots, \pi_{i - 1}^8)\Lambda}(\pi_i)
=
\text{Ann}_{\Lambda/(\pi_1^8, \ldots, \pi_{i - 1}^8)\Lambda}(\pi_i^2)
$$
\item for $i = 1, \ldots, r$ the element $\pi_i$ maps to a strictly
standard element in $A$ over $R$.
\end{enumerate}
Then, if
$$
R/(\pi_1^8, \ldots, \pi_r^8)R \to A/(\pi_1^8, \ldots, \pi_r^8)A
\to \Lambda/(\pi_1^8, \ldots, \pi_r^8)\Lambda \supset
\mathfrak q/(\pi_1^8, \ldots, \pi_r^8)\Lambda
$$
can be resolved, so can $R \to A \to \Lambda \supset \mathfrak q$.
\end{lemma}

\begin{proof}
We are going to prove this by induction on $r$.

\medskip\noindent
The case $r = 1$. Here the assumption is that there exists a
factorization $A/\pi_1^8 \to \bar C \to \Lambda/\pi_1^8$
which resolves the situation modulo $\pi_1^8$. Conditions (1) and
(2) are the assumptions needed to apply
Lemma \ref{lemma-desingularize-lifting-apply}.
Thus we can ``lift'' the resolution $\bar C$
to a resolution of $R \to A \to \Lambda \supset \mathfrak q$.

\medskip\noindent
The case $r > 1$. In this case we apply the induction hypothesis for $r - 1$
to the situation
$R/\pi_1^8 \to A/\pi_1^8 \to \Lambda/\pi_1^8
\supset \mathfrak q/\pi_1^8\Lambda$.
Note that property (2) is preserved by
Lemma \ref{lemma-strictly-standard-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-delocalize-weak}
\begin{reference}
\cite[Lemma 12.2]{swan} or
\cite[Lemma 2]{popescu-GND}
\end{reference}
Let $R \to A \to \Lambda \supset \mathfrak q$ be as in
Situation \ref{situation-local}. Let $\mathfrak p = R \cap \mathfrak q$.
Assume that $\mathfrak q$ is minimal over $\mathfrak h_A$ and that
$R_\mathfrak p \to A_\mathfrak p \to \Lambda_\mathfrak q
\supset \mathfrak q\Lambda_\mathfrak q$ can be resolved.
Then there exists a factorization $A \to C \to \Lambda$ with $C$ of
finite presentation such that $H_{C/R} \Lambda \not \subset \mathfrak q$.
\end{lemma}

\begin{proof}
Let $A_\mathfrak p \to C \to \Lambda_\mathfrak q$ be a resolution of
$R_\mathfrak p \to A_\mathfrak p \to \Lambda_\mathfrak q
\supset \mathfrak q\Lambda_\mathfrak q$. By our assumption
that $\mathfrak q$ is minimal over $\mathfrak h_A$ this
means that $H_{C/R_\mathfrak p} \Lambda_\mathfrak q = \Lambda_\mathfrak q$.
By Lemma \ref{lemma-final-solve}
we may assume that $C$ is smooth over $R_\mathfrak p$.
By Lemma \ref{lemma-smooth-standard-smooth} we may assume that
$C$ is standard smooth over $R_\mathfrak p$.
Write $A = R[x_1, \ldots, x_n]/(g_1, \ldots, g_t)$ and say
$A \to \Lambda$ is given by $x_i \mapsto \lambda_i$.
Write $C = R_\mathfrak p[x_1, \ldots, x_{n + m}]/(f_1, \ldots, f_c)$
for some $c \geq n$ such that $A \to C$ maps $x_i$ to $x_i$ and such that
$\det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}$
is invertible in $C$, see
Lemma \ref{lemma-standard-smooth-include-generators}.
After clearing denominators we may assume
$f_1, \ldots, f_c$ are elements of $R[x_1, \ldots, x_{n + m}]$.
Of course
$\det(\partial f_j/\partial x_i)_{i, j = 1, \ldots, c}$
is not invertible in $R[x_1, \ldots, x_{n + m}]/(f_1, \ldots, f_c)$
but it becomes invertible after inverting some element $s_0 \in R$,
$s_0 \not \in \mathfrak p$.
As $g_j$ maps to zero under $R[x_1, \ldots, x_n] \to A \to C$
we can find $s_j \in R$, $s_j \not \in \mathfrak p$ such that
$s_j g_j$ is zero in $R[x_1, \ldots, x_{n + m}]/(f_1, \ldots, f_c)$.
Write $f_j = F_j(x_1, \ldots, x_{n + m}, 1)$
for some polynomial
$F_j \in R[x_1, \ldots, x_n, X_{n + 1}, \ldots, X_{n + m + 1}]$
homogeneous in $X_{n + 1}, \ldots, X_{n + m + 1}$.
Pick $\lambda_{n + i} \in \Lambda$, $i = 1, \ldots, m + 1$ with
$\lambda_{n + m + 1} \not \in \mathfrak q$ such that $x_{n + i}$ maps to
$\lambda_{n + i}/\lambda_{n + m + 1}$ in $\Lambda_\mathfrak q$.
Then
\begin{align*}
F_j(\lambda_1, \ldots, \lambda_{n + m + 1})
& =
(\lambda_{n + m + 1})^{\deg(F_j)} F_j(\lambda_1, \ldots, \lambda_n,
\frac{\lambda_{n + 1}}{\lambda_{n + m + 1}}, \ldots,
\frac{\lambda_{n + m}}{\lambda_{n + m + 1}}, 1) \\
& =
(\lambda_{n + m + 1})^{\deg(F_j)} f_j(\lambda_1, \ldots, \lambda_n,
\frac{\lambda_{n + 1}}{\lambda_{n + m + 1}}, \ldots,
\frac{\lambda_{n + m}}{\lambda_{n + m + 1}}) \\
& = 0
\end{align*}
in $\Lambda_\mathfrak q$. Thus we can find
$\lambda_0 \in \Lambda$, $\lambda_0 \not \in \mathfrak q$ such that
$\lambda_0 F_j(\lambda_1, \ldots, \lambda_{n + m + 1}) = 0$
in $\Lambda$. Now we set $B$ equal to
$$
R[x_0, \ldots, x_{n + m + 1}]/
(g_1, \ldots, g_t, x_0F_1(x_1, \ldots, x_{n + m + 1}), \ldots,
x_0F_c(x_1, \ldots, x_{n + m + 1}))
$$
which we map to $\Lambda$ by mapping $x_i$ to $\lambda_i$.
Let $b$ be the image of $x_0 x_{n + m + 1} s_0 s_1 \ldots s_t$ in $B$.
Then $B_b$ is isomorphic to
$$
R_{s_0s_1 \ldots s_t}[x_0, x_1, \ldots, x_{n + m + 1}, 1/x_0x_{n + m + 1}]/
(f_1, \ldots, f_c)
$$
which is smooth over $R$ by construction.
Since $b$ does not map to an element of $\mathfrak q$, we win.
\end{proof}

\begin{lemma}
\label{lemma-delocalize-height-zero}
Let $R \to A \to \Lambda \supset \mathfrak q$ be as in
Situation \ref{situation-local}. Let $\mathfrak p = R \cap \mathfrak q$.
Assume
\begin{enumerate}
\item $\mathfrak q$ is minimal over $\mathfrak h_A$,
\item $R_\mathfrak p \to A_\mathfrak p \to \Lambda_\mathfrak q
\supset \mathfrak q\Lambda_\mathfrak q$ can be resolved, and
\item $\dim(\Lambda_\mathfrak q) = 0$.
\end{enumerate}
Then $R \to A \to \Lambda \supset \mathfrak q$ can be resolved.
\end{lemma}

\begin{proof}
By (3) the ring $\Lambda_\mathfrak q$ is Artinian local hence
$\mathfrak q\Lambda_\mathfrak q$ is nilpotent. Thus
$(\mathfrak h_A)^N \Lambda_\mathfrak q = 0$ for some $N > 0$.
Thus there exists a $\lambda \in \Lambda$, $\lambda \not \in \mathfrak q$
such that $\lambda (\mathfrak h_A)^N = 0$ in $\Lambda$.
Say $H_{A/R} = (a_1, \ldots, a_r)$ so that $\lambda a_i^N = 0$
in $\Lambda$. By Lemma \ref{lemma-delocalize-weak} we can find a factorization
$A \to C \to \Lambda$ with $C$ of finite presentation such that
$\mathfrak h_C \not \subset \mathfrak q$.
Write $C = A[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
Set
$$
B = A[x_1, \ldots, x_n, y_1, \ldots, y_r, z, t_{ij}]/
(f_j - \sum y_i t_{ij}, zy_i)
$$
where $t_{ij}$ is a set of $rm$ variables.
Note that there is a map $B \to C[y_i, z]/(y_iz)$ given by setting $t_{ij}$
equal to zero. The map $B \to \Lambda$ is the composition
$B \to C[y_i, z]/(y_iz) \to \Lambda$ where $C[y_i, z]/(y_iz) \to \Lambda$
is the given map $C \to \Lambda$, maps $z$ to $\lambda$, and maps
$y_i$ to the image of $a_i^N$ in $\Lambda$.

\medskip\noindent
We claim that $B$ is a solution for $R \to A \to \Lambda \supset \mathfrak q$.
First note that $B_z$ is isomorphic to $C[y_1, \ldots, y_r, z, z^{-1}]$
and hence is smooth. On the other hand,
$B_{y_\ell} \cong A[x_i, y_i, y_\ell^{-1}, t_{ij}, i \not = \ell]$
which is smooth over $A$. Thus we see that $z$ and $a_\ell y_\ell$
(compositions of smooth maps are smooth) are all
elements of $H_{B/R}$. This proves the lemma.
\end{proof}




\section{Separable residue fields}
\label{section-separable}

\noindent
In this section we explain how to solve a local problem in the case
of a separable residue field extension.

\begin{lemma}[Ogoma]
\label{lemma-ogoma}
Let $A$ be a Noetherian ring and let $M$ be a finite $A$-module.
Let $S \subset A$ be a multiplicative set. If $\pi \in A$ and
$\Ker(\pi : S^{-1}M \to S^{-1}M) =
\Ker(\pi^2 : S^{-1}M \to S^{-1}M)$
then there exists an $s \in S$ such that for any $n > 0$ we have
$\Ker(s^n\pi : M \to M) = \Ker((s^n\pi)^2 : M \to M)$.
\end{lemma}

\begin{proof}
Let $K = \Ker(\pi : M \to M)$ and
$K' = \{m \in M \mid \pi^2 m = 0\text{ in }S^{-1}M\}$ and
$Q = K'/K$. Note that $S^{-1}Q = 0$ by assumption. Since $A$
is Noetherian we see that $Q$ is a finite $A$-module.
Hence we can find an $s \in S$ such that $s$ annihilates $Q$.
Then $s$ works.
\end{proof}

\begin{lemma}
\label{lemma-find-sequence}
Let $\Lambda$ be a Noetherian ring. Let $I \subset \Lambda$ be an ideal.
Let $I \subset \mathfrak q$ be a prime. Let $n, e$ be positive integers
Assume that $\mathfrak q^n\Lambda_\mathfrak q \subset I\Lambda_\mathfrak q$
and that $\Lambda_\mathfrak q$ is a regular local ring of dimension $d$.
Then there exists an $n > 0$ and
$\pi_1, \ldots, \pi_d \in \Lambda$ such that
\begin{enumerate}
\item $(\pi_1, \ldots, \pi_d)\Lambda_\mathfrak q =
\mathfrak q\Lambda_\mathfrak q$,
\item $\pi_1^n, \ldots, \pi_d^n \in I$, and
\item for $i = 1, \ldots, d$ we have
$$
\text{Ann}_{\Lambda/(\pi_1^e, \ldots, \pi_{i - 1}^e)\Lambda}(\pi_i) =
\text{Ann}_{\Lambda/(\pi_1^e, \ldots, \pi_{i - 1}^e)\Lambda}(\pi_i^2).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Set $S = \Lambda \setminus \mathfrak q$ so that
$\Lambda_\mathfrak q = S^{-1}\Lambda$.
First pick $\pi_1, \ldots, \pi_d$ with (1) which is possible
as $\Lambda_\mathfrak q$ is regular. By assumption
$\pi_i^n \in I\Lambda_\mathfrak q$. Thus we can find
$s_1, \ldots, s_d \in S$ such that $s_i\pi_i^n \in I$.
Replacing $\pi_i$ by $s_i\pi_i$ we get (2).
Note that (1) and (2) are preserved by further multiplying by elements of $S$.
Suppose that (3) holds for $i = 1, \ldots, t$ for some
$t \in \{0, \ldots, d\}$. Note that
$\pi_1, \ldots, \pi_d$ is a regular sequence in $S^{-1}\Lambda$, see
Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}.
In particular $\pi_1^e, \ldots, \pi_t^e, \pi_{t + 1}$ is a
regular sequence in $S^{-1}\Lambda = \Lambda_\mathfrak q$ by
Algebra, Lemma \ref{algebra-lemma-regular-sequence-powers}.
Hence we see that
$$
\text{Ann}_{S^{-1}\Lambda/(\pi_1^e, \ldots, \pi_{i - 1}^e)}(\pi_i) =
\text{Ann}_{S^{-1}\Lambda/(\pi_1^e, \ldots, \pi_{i - 1}^e)}(\pi_i^2).
$$
Thus we get (3) for $i = t + 1$ after replacing $\pi_{t + 1}$ by $s\pi_{t + 1}$
for some $s \in S$ by Lemma \ref{lemma-ogoma}. By induction on $t$ this
produces a sequence satisfying (1), (2), and (3).
\end{proof}

\begin{lemma}
\label{lemma-resolve-special}
Let $k \to A \to \Lambda \supset \mathfrak q$ be as in
Situation \ref{situation-local} where
\begin{enumerate}
\item $k$ is a field,
\item $\Lambda$ is Noetherian,
\item $\mathfrak q$ is minimal over $\mathfrak h_A$,
\item $\Lambda_\mathfrak q$ is a regular local ring, and
\item the field extension $k \subset \kappa(\mathfrak q)$ is separable.
\end{enumerate}
Then $k \to A \to \Lambda \supset \mathfrak q$ can be resolved.
\end{lemma}

\begin{proof}
Set $d = \dim \Lambda_\mathfrak q$. Set $R = k[x_1, \ldots, x_d]$.
Choose $n > 0$ such that
$\mathfrak q^n\Lambda_\mathfrak q \subset \mathfrak h_A\Lambda_\mathfrak q$
which is possible as $\mathfrak q$ is minimal over $\mathfrak h_A$.
Choose generators $a_1, \ldots, a_r$ of $H_{A/R}$. Set
$$
B = A[x_1, \ldots, x_d, z_{ij}]/(x_i^n - \sum z_{ij}a_j)
$$
Each $B_{a_j}$ is smooth over $R$ it is a polynomial
algebra over $A_{a_j}[x_1, \ldots, x_d]$ and $A_{a_j}$ is smooth over $k$.
Hence $B_{x_i}$ is smooth over $R$. Let $B \to C$ be the $R$-algebra
map constructed in Lemma \ref{lemma-improve-presentation}
which comes with a $R$-algebra retraction $C \to B$. In particular
a map $C \to \Lambda$ fitting into the diagram above.
By construction $C_{x_i}$ is a smooth $R$-algebra with
$\Omega_{C_{x_i}/R}$ free. Hence we can find $c > 0$
such that $x_i^c$ is strictly standard in $C/R$, see
Lemma \ref{lemma-compare-standard}.
Now choose $\pi_1, \ldots, \pi_d \in \Lambda$ as in
Lemma \ref{lemma-find-sequence}
where $n = n$, $e = 8c$, $\mathfrak q = \mathfrak q$ and $I = \mathfrak h_A$.
Write $\pi_i^n = \sum \lambda_{ij} a_j$ for some $\pi_{ij} \in \Lambda$.
There is a map $B \to \Lambda$ given by $x_i \mapsto \pi_i$
and $z_{ij} \mapsto \lambda_{ij}$. Set $R = k[x_1, \ldots, x_d]$.
Diagram
$$
\xymatrix{
R \ar[r] & B \ar[rd] \\
k \ar[u] \ar[r] & A \ar[u] \ar[r] & \Lambda
}
$$
Now we apply
Lemma \ref{lemma-lift-solution}
to $R \to C \to \Lambda \supset \mathfrak q$
and the sequence of elements $x_1^c, \ldots, x_d^c$ of $R$.
Assumption (2) is clear. Assumption (1) holds for $R$
by inspection and for $\Lambda$ by our choice of
$\pi_1, \ldots, \pi_d$. (Note that if
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$, then we have
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^c)$ for all $c > 0$.)
Thus it suffices to resolve
$$
R/(x_1^e, \ldots, x_d^e) \to C/(x_1^e, \ldots, x_d^e) \to
\Lambda/(\pi_1^e, \ldots, \pi_d^e) \supset
\mathfrak q/(\pi_1^e, \ldots, \pi_d^e)
$$
for $e = 8c$. By
Lemma \ref{lemma-delocalize-height-zero}
it suffices to resolve this after localizing at $\mathfrak q$.
But since $x_1, \ldots, x_d$ map to a regular sequence
in $\Lambda_\mathfrak q$ we see that $R_\mathfrak p \to \Lambda_\mathfrak q$
is flat, see Algebra, Lemma \ref{algebra-lemma-flat-over-regular}. Hence
$$
R_\mathfrak p/(x_1^e, \ldots, x_d^e) \to
\Lambda_\mathfrak q/(\pi_1^e, \ldots, \pi_d^e)
$$
is a flat ring map of Artinian local rings.
Moreover, this map induces a separable field extension
on residue fields by assumption. Thus this map is a filtered colimit
of smooth algebras by
Algebra, Lemma \ref{algebra-lemma-colimit-syntomic}
and Proposition \ref{proposition-lift}.
Existence of the desired solution follows from
Algebra, Lemma \ref{algebra-lemma-when-colimit}.
\end{proof}






\section{Inseparable residue fields}
\label{section-inseparable}

\noindent
In this section we explain how to solve a local problem in the case
of an inseparable residue field extension.

\begin{lemma}
\label{lemma-helper}
Let $k$ be a field of characteristic $p > 0$.
Let $(\Lambda, \mathfrak m, K)$ be an Artinian local $k$-algebra.
Assume that $\dim H_1(L_{K/k}) < \infty$.
Then $\Lambda$ is a filtered colimit of Artinian
local $k$-algebras $A$ with each map $A \to \Lambda$ flat, with
$\mathfrak m_A \Lambda = \mathfrak m$, and with
$A$ essentially of finite type over $k$.
\end{lemma}

\begin{proof}
Note that the flatness of $A \to \Lambda$ implies that $A \to \Lambda$
is injective, so the lemma really tells us that $\Lambda$ is a
directed union of these types of subrings $A \subset \Lambda$.
Let $n$ be the minimal integer such that $\mathfrak m^n = 0$.
We will prove this lemma by induction on $n$. The case $n = 1$ is clear
as a field extension is a union of finitely generated field extensions.

\medskip\noindent
Pick $\lambda_1, \ldots, \lambda_d \in \mathfrak m$ which generate
$\mathfrak m$. As $K$ is formally smooth over $\mathbf{F}_p$ (see
Algebra, Lemma \ref{algebra-lemma-formally-smooth-extensions-easy}) we can
find a ring map $\sigma : K \to \Lambda$ which is a section of the
quotient map $\Lambda \to K$. In general $\sigma$ is {\bf not}
a $k$-algebra map. Given $\sigma$ we define
$$
\Psi_\sigma : K[x_1, \ldots, x_d] \longrightarrow \Lambda
$$
using $\sigma$ on elements of $K$ and mapping $x_i$ to $\lambda_i$.
Claim: there exists a $\sigma : K \to \Lambda$
and a subfield $k \subset F \subset K$ finitely generated over $k$
such that the image of $k$ in $\Lambda$ is contained in
$\Psi_\sigma(F[x_1, \ldots, x_d])$.

\medskip\noindent
We will prove the claim by induction on the least integer $n$ such that
$\mathfrak m^n = 0$. It is clear for $n = 1$. If $n > 1$ set
$I = \mathfrak m^{n - 1}$ and $\Lambda' = \Lambda/I$.
By induction we may assume
given $\sigma' : K \to \Lambda'$ and $k \subset F' \subset K$ finitely
generated such that the image of $k \to \Lambda \to \Lambda'$
is contained in $A' = \Psi_{\sigma'}(F'[x_1, \ldots, x_d])$.
Denote $\tau' : k \to A'$ the induced map.
Choose a lift $\sigma : K \to \Lambda$ of $\sigma'$ (this is possible
by the formal smoothness of $K/\mathbf{F}_p$ we mentioned above).
For later reference we note that we can change $\sigma$ to
$\sigma + D$ for some derivation $D : K \to I$.
Set $A = F[x_1, \ldots, x_d]/(x_1, \ldots, x_d)^n$.
Then $\Psi_\sigma$ induces a ring map
$\Psi_\sigma : A \to \Lambda$. The composition with the
quotient map $\Lambda \to \Lambda'$ induces a surjective
map $A \to A'$ with nilpotent kernel.
Choose a lift $\tau : k \to A$ of $\tau'$ (possible as $k/\mathbf{F}_p$
is formally smooth). Thus we obtain two maps $k \to \Lambda$, namely
$\Psi_\sigma \circ \tau : k \to \Lambda$ and the given map $i : k \to \Lambda$.
These maps agree modulo $I$, whence the difference is a
derivation $\theta = i - \Psi_\sigma \circ \tau : k \to I$.
Note that if we change $\sigma$ into $\sigma + D$ then we change
$\theta$ into $\theta - D|_k$.

\medskip\noindent
Choose a set of elements $\{y_j\}_{j \in J}$ of $k$ whose differentials
$\text{d}y_j$ form a basis of $\Omega_{k/\mathbf{F}_p}$. The Jacobi-Zariski
sequence for $\mathbf{F}_p \subset k \subset K$ is
$$
0 \to H_1(L_{K/k}) \to \Omega_{k/\mathbf{F}_p} \otimes K \to
\Omega_{K/\mathbf{F}_p} \to \Omega_{K/k} \to 0
$$
As $\dim H_1(L_{K/k}) < \infty$ we can find a finite subset $J_0 \subset J$
such that the image of the first map is contained in
$\bigoplus_{j \in J_0} K\text{d}y_j$. Hence the elements
$\text{d}y_j$, $j \in J \setminus J_0$ map to $K$-linearly independent
elements of $\Omega_{K/\mathbf{F}_p}$. Therefore we can choose
a $D : K \to I$ such that $\theta - D|_k = \xi \circ \text{d}$
where $\xi$ is a composition
$$
\Omega_{k/\mathbf{F}_p} = \bigoplus\nolimits_{j \in J} k \text{d}y_j
\longrightarrow \bigoplus\nolimits_{j \in J_0} k \text{d}y_j
\longrightarrow I
$$
Let $f_j = \xi(\text{d}y_j) \in I$ for $j \in J_0$.
Change $\sigma$ into $\sigma + D$ as above. Then we see that
$\theta(a) = \sum_{j \in J_0} a_j f_j$ for $a \in k$ where
$\text{d}a = \sum a_j \text{d}y_j$ in $\Omega_{k/\mathbf{F}_p}$.
Note that $I$ is generated by the monomials
$\lambda^E = \lambda_1^{e_1} \ldots \lambda_d^{e_d}$ of
total degree $|E| = \sum e_i = n - 1$ in $\lambda_1, \ldots, \lambda_d$.
Write $f_j = \sum_E c_{j, E} \lambda^E$ with $c_{j, E} \in K$.
Replace $F'$ by $F = F'(c_{j, E})$. Then the claim holds.

\medskip\noindent
Choose $\sigma$ and $F$ as in the claim. The kernel of $\Psi_\sigma$ is
generated by finitely many polynomials
$g_1, \ldots, g_t \in K[x_1, \ldots, x_d]$ and we may assume their
coefficients are in $F$ after enlarging $F$ by adjoining finitely many
elements. In this case it is clear that the map
$A = F[x_1, \ldots, x_d]/(g_1, \ldots, g_t) \to
K[x_1, \ldots, x_d]/(g_1, \ldots, g_t) = \Lambda$ is flat.
By the claim $A$ is a $k$-subalgebra of $\Lambda$.
It is clear that $\Lambda$ is the filtered colimit of these
algebras, as $K$ is the filtered union of the subfields $F$.
Finally, these algebras are essentially of finite type over $k$ by
Algebra, Lemma
\ref{algebra-lemma-essentially-of-finite-type-into-artinian-local}.
\end{proof}

\begin{lemma}
\label{lemma-solution-modulo}
Let $k$ be a field of characteristic $p > 0$.
Let $\Lambda$ be a Noetherian geometrically regular $k$-algebra.
Let $\mathfrak q \subset \Lambda$ be a prime ideal.
Let $n \geq 1$ be an integer and let
$E \subset \Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$
be a finite subset.
Then we can find $m \geq 0$ and
$\varphi : k[y_1, \ldots, y_m] \to \Lambda$ with the following properties
\begin{enumerate}
\item setting $\mathfrak p = \varphi^{-1}(\mathfrak q)$ we have
$\mathfrak q\Lambda_\mathfrak q = \mathfrak p \Lambda_\mathfrak q$
and $k[y_1, \ldots, y_m]_\mathfrak p \to \Lambda_\mathfrak q$ is flat,
\item there is a factorization by homomorphisms of local Artinian rings
$$
k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n k[y_1, \ldots, y_m]_\mathfrak p
\to D \to
\Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q
$$
where the first arrow is essentially smooth and the second is flat,
\item $E$ is contained in $D$ modulo $\mathfrak q^n\Lambda_\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Set $\bar \Lambda = \Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$.
Note that $\dim H_1(L_{\kappa(\mathfrak q)/k}) < \infty$ by
More on Algebra, Proposition
\ref{more-algebra-proposition-characterization-geometrically-regular}.
Pick $A \subset \bar \Lambda$ containing $E$ such that $A$ is local
Artinian, essentially of finite type over $k$, the map
$A \to \bar \Lambda$ is flat, and $\mathfrak m_A$ generates the maximal
ideal of $\bar \Lambda$, see Lemma \ref{lemma-helper}.
Denote $F = A/\mathfrak m_A$ the residue field so that $k \subset F \subset K$.
Pick $\lambda_1, \ldots, \lambda_t \in \Lambda$ which map
to elements of $A$ in $\bar \Lambda$ such that moreover the images
of $\text{d}\lambda_1, \ldots, \text{d}\lambda_t$ form a basis
of $\Omega_{F/k}$. Consider the map
$\varphi' : k[y_1, \ldots, y_t] \to \Lambda$ sending $y_j$ to $\lambda_j$.
Set $\mathfrak p' = (\varphi')^{-1}(\mathfrak q)$. By
More on Algebra, Lemma
\ref{more-algebra-lemma-geometrically-regular-over-field}
the ring map $k[y_1, \ldots, y_t]_{\mathfrak p'} \to \Lambda_\mathfrak q$
is flat and $\Lambda_\mathfrak q/\mathfrak p' \Lambda_\mathfrak q$ is
regular. Thus we can choose further elements
$\lambda_{t + 1}, \ldots, \lambda_m \in \Lambda$
which map into $A \subset \bar \Lambda$ and which
map to a regular system of parameters of
$\Lambda_\mathfrak q/\mathfrak p' \Lambda_\mathfrak q$.
We obtain $\varphi : k[y_1, \ldots, y_m] \to \Lambda$ having
property (1) such that
$k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n k[y_1, \ldots, y_m]_\mathfrak p
\to \bar\Lambda$
factors through $A$. Thus
$k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n k[y_1, \ldots, y_m]_\mathfrak p
\to A$ is flat by
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}.
By construction the residue field extension $\kappa(\mathfrak p) \subset F$
is finitely generated and $\Omega_{F/\kappa(\mathfrak p)} = 0$. Hence it is
finite separable by
More on Algebra, Lemma \ref{more-algebra-lemma-cartier-equality}.
Thus
$k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n k[y_1, \ldots, y_m]_\mathfrak p
\to A$
is finite by Algebra, Lemma
\ref{algebra-lemma-essentially-of-finite-type-into-artinian-local}.
Finally, we conclude that it is \'etale by
Algebra, Lemma \ref{algebra-lemma-characterize-etale}.
Since an \'etale ring map is certainly essentially smooth we win.
\end{proof}

\begin{lemma}
\label{lemma-enlarge-solution-modulo}
Let $\varphi : k[y_1, \ldots, y_m] \to \Lambda$, $n$, $\mathfrak q$,
$\mathfrak p$ and
$$
k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n \to
D \to \Lambda_\mathfrak q/\mathfrak q^n \Lambda_\mathfrak q
$$
be as in Lemma \ref{lemma-solution-modulo}. Then for any
$\lambda \in \Lambda \setminus \mathfrak q$
there exists an integer $q > 0$ and a factorization
$$
k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n \to
D \to D' \to \Lambda_\mathfrak q/\mathfrak q^n \Lambda_\mathfrak q
$$
such that $D \to D'$ is an essentially smooth map of local Artinian rings,
the last arrow is flat, and $\lambda^q$ is in $D'$.
\end{lemma}

\begin{proof}
Set $\bar \Lambda = \Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$.
Let $\bar \lambda$ be the image of $\lambda$ in $\bar \Lambda$.
Let $\alpha \in \kappa(\mathfrak q)$ be the image of $\lambda$ in the
residue field.
Let $k \subset F \subset \kappa(\mathfrak q)$ be the residue field of $D$.
If $\alpha$ is in $F$ then we can find an
$x \in D$ such that $x \bar\lambda = 1 \bmod \mathfrak q$. Hence
$(x \bar \lambda)^q = 1 \bmod (\mathfrak q)^q$ if $q$ is divisible by $p$.
Hence $\bar\lambda^q$ is in $D$. If $\alpha$ is
transcendental over $F$, then we can take $D' = (D[\bar \lambda])_\mathfrak m$
equal to the subring generated by $D$ and $\bar \lambda$ localized
at $\mathfrak m = D[\bar \lambda] \cap \mathfrak q \bar \Lambda$.
This works because $D[\bar \lambda]$ is in fact a polynomial algebra
over $D$ in this case. Finally, if $\lambda \bmod \mathfrak q$ is
algebraic over $F$, then we can find a $p$-power $q$ such that
$\alpha^q$ is separable algebraic over $F$, see
Fields, Section \ref{fields-section-algebraic}.
Note that $D$ and $\bar\Lambda$ are henselian local rings, see
Algebra, Lemma \ref{algebra-lemma-local-dimension-zero-henselian}.
Let $D \to D'$ be a finite \'etale extension
whose residue field extension is $F \subset F(\alpha^q)$, see
Algebra, Lemma \ref{algebra-lemma-henselian-cat-finite-etale}.
Since $\bar\Lambda$ is henselian and $F(\alpha^q)$ is contained
in its residue field we can find a factorization
$D' \to \bar \Lambda$. By the first part of the argument
we see that $\bar\lambda^{qq'} \in D'$ for some $q' > 0$.
\end{proof}

\begin{lemma}
\label{lemma-resolve-general}
Let $k \to A \to \Lambda \supset \mathfrak q$ be as in
Situation \ref{situation-local} where
\begin{enumerate}
\item $k$ is a field of characteristic $p > 0$,
\item $\Lambda$ is Noetherian and geometrically regular over $k$,
\item $\mathfrak q$ is minimal over $\mathfrak h_A$.
\end{enumerate}
Then $k \to A \to \Lambda \supset \mathfrak q$ can be resolved.
\end{lemma}

\begin{proof}
The lemma is proven by the following steps in the given order.
We will justify each of these steps below.
\begin{enumerate}
\item
\label{item-power}
Pick an integer $N > 0$ such that
$\mathfrak q^N\Lambda_\mathfrak q \subset H_{A/k}\Lambda_\mathfrak q$.
\item
\label{item-generators}
Pick generators $a_1, \ldots, a_t \in A$ of the ideal $H_{A/R}$.
\item
\label{item-dimension}
Set $d = \dim(\Lambda_\mathfrak q)$.
\item
\label{item-standardizer}
Set $B = A[x_1, \ldots, x_d, z_{ij}]/(x_i^{2N} - \sum z_{ij}a_j)$.
\item
\label{item-elkik}
Consider $B$ as a $k[x_1, \ldots, x_d]$-algebra and let
$B \to C$ be as in
Lemma \ref{lemma-improve-presentation}.
We also obtain a section $C \to B$.
\item
\label{item-strictly-standard}
Choose $c > 0$ such that each $x_i^c$
is strictly standard in $C$ over $k[x_1, \ldots, x_d]$.
\item
\label{item-set-n}
Set $n = N + dc$ and $e = 8c$.
\item
\label{item-set-E}
Let $E \subset \Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$
be the images of generators of $A$ as a $k$-algebra.
\item
\label{item-NP}
Choose an integer $m$ and a $k$-algebra map
$\varphi : k[y_1, \ldots, y_m] \to \Lambda$
and a factorization by local Artinian rings
$$
k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n k[y_1, \ldots, y_m]_\mathfrak p
\to D \to
\Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q
$$
such that the first arrow is essentially smooth, the second is flat,
$E$ is contained in $D$, with $\mathfrak p = \varphi^{-1}(\mathfrak q)$
the map $k[y_1, \ldots, y_m]_\mathfrak p \to \Lambda_\mathfrak q$ is
flat, and $\mathfrak p \Lambda_\mathfrak q = \mathfrak q \Lambda_\mathfrak q$.
\item
\label{item-choose-pii}
Choose $\pi_1, \ldots, \pi_d \in \mathfrak p$ which map to a
regular system of parameters of $k[y_1, \ldots, y_m]_\mathfrak p$.
\item
\label{item-set-R}
Let $R = k[y_1, \ldots, y_m, t_1, \ldots, t_m]$ and $\gamma_i = \pi_i t_i$.
\item
\label{item-modify-pii}
If necessary modify the choice of $\pi_i$ such that
for $i = 1, \ldots, d$ we have 
$$
\text{Ann}_{R/(\gamma_1^e, \ldots, \gamma_{i - 1}^e)R}(\gamma_i)
=
\text{Ann}_{R/(\gamma_1^e, \ldots, \gamma_{i - 1}^e)R}(\gamma_i^2)
$$
\item
\label{item-choose-deltai}
There exist $\delta_1, \ldots, \delta_d \in \Lambda$,
$\delta_i \not \in \mathfrak q$ and a factorization
$D \to D' \to \Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$
with $D'$ local Artinian, $D \to D'$ essentially smooth, the map
$D' \to \Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$
flat such that, with $\pi_i' = \delta_i \pi_i$, we have for
$i = 1, \ldots, d$
\begin{enumerate}
\item $(\pi_i')^{2N} = \sum a_j\lambda_{ij}$ in $\Lambda$ where
$\lambda_{ij} \bmod \mathfrak q^n\Lambda_\mathfrak q$ is an element of $D'$,
\item $\text{Ann}_{\Lambda/({\pi'}_1^e, \ldots, {\pi'}_{i - 1}^e)}({\pi'}_i) =
\text{Ann}_{\Lambda/({\pi'}_1^e, \ldots, {\pi'}_{i - 1}^e)}({\pi'}_i^2)$,
\item $\delta_i \bmod \mathfrak q^n\Lambda_\mathfrak q$ is an element of $D'$.
\end{enumerate}
\item
\label{item-map-B-Lambda}
Define $B \to \Lambda$ by sending $x_i$ to $\pi'_i$ and
$z_{ij}$ to $\lambda_{ij}$ found above. Define $C \to \Lambda$
by composing the map $B \to \Lambda$ with the retraction $C \to B$.
\item
\label{item-set-map-R}
Map $R \to \Lambda$ by $\varphi$ on $k[y_1, \ldots, y_m]$
and by sending $t_i$ to $\delta_i$. Further introduce a map
$$
k[x_1, \ldots, x_d]
\longrightarrow
R = k[y_1, \ldots, y_m, t_1, \ldots, t_d]
$$
by sending $x_i$ to $\gamma_i = \pi_i t_i$.
\item
\label{item-first-solve}
It suffices to resolve
$$
R
\to
C \otimes_{k[x_1, \ldots, x_d]} R
\to
\Lambda \supset \mathfrak q
$$
\item
\label{item-set-I}
Set $I = (\gamma_1^e, \ldots, \gamma_d^e) \subset R$.
\item
\label{item-second-resolve}
It suffices to resolve
$$
R/I
\to
C \otimes_{k[x_1, \ldots, x_d]} R/I
\to
\Lambda/I\Lambda \supset \mathfrak q/I\Lambda
$$
\item
\label{item-set-r}
We denote $\mathfrak r \subset R = k[y_1, \ldots, y_m, t_1, \ldots, t_d]$
the inverse image of $\mathfrak q$.
\item
\label{item-third-resolve}
It suffices to resolve
$$
(R/I)_\mathfrak r \to
C \otimes_{k[x_1, \ldots, x_d]} (R/I)_\mathfrak r \to
\Lambda_\mathfrak q/I\Lambda_\mathfrak q
\supset
\mathfrak q\Lambda_\mathfrak q/I\Lambda_\mathfrak q
$$
\item
\label{item-fourth-resolve}
Set $J = (\pi_1^e, \ldots, \pi_d^e)$ in $k[y_1, \ldots, y_m]$.
\item
\label{item-fifth-resolve}
It suffices to resolve
$$
(R/JR)_\mathfrak p \to
C \otimes_{k[x_1, \ldots, x_d]} (R/JR)_\mathfrak p \to
\Lambda_\mathfrak q/J\Lambda_\mathfrak q
\supset
\mathfrak q\Lambda_\mathfrak q/J\Lambda_\mathfrak q
$$
\item
\label{item-sixth-resolve}
It suffices to resolve
$$
(R/\mathfrak p^nR)_\mathfrak p \to
C \otimes_{k[x_1, \ldots, x_d]} (R/\mathfrak p^nR)_\mathfrak p \to
\Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q
\supset
\mathfrak q\Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q
$$
\item
\label{item-seventh-resolve}
It suffices to resolve
$$
(R/\mathfrak p^nR)_\mathfrak p \to
B \otimes_{k[x_1, \ldots, x_d]} (R/\mathfrak p^nR)_\mathfrak p \to
\Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q
\supset
\mathfrak q\Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q
$$
\item
\label{item-eighth-resolve}
The ring $D'[t_1, \ldots, t_d]$ is given the structure of an
$R_\mathfrak p/\mathfrak p^nR_\mathfrak p$-algebra by the given map
$k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n k[y_1, \ldots, y_m]_\mathfrak p
\to D'$ and by sending $t_i$ to $t_i$. It suffices to find a factorization
$$
B \otimes_{k[x_1, \ldots, x_d]} (R/\mathfrak p^nR)_\mathfrak p
\to D'[t_1, \ldots, t_d] \to
\Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q
$$
where the second arrow sends $t_i$ to $\delta_i$ and induces the given
homomorphism $D' \to \Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$.
\item
\label{item-done}
Such a factorization exists by our choice of $D'$ above.
\end{enumerate}
We now give the justification for each of the steps, except that we
skip justifying the steps which just introduce notation.

\medskip\noindent
Ad (\ref{item-power}). This is possible as $\mathfrak q$ is minimal
over $\mathfrak h_A = \sqrt{H_{A/k}\Lambda}$.

\medskip\noindent
Ad (\ref{item-strictly-standard}). Note that $A_{a_i}$ is smooth
over $k$. Hence $B_{a_j}$, which is isomorphic to a polynomial
algebra over $A_{a_j}[x_1, \ldots, x_d]$, is smooth over
$k[x_1, \ldots, x_d]$. Thus $B_{x_i}$ is smooth over $k[x_1, \ldots, x_d]$.
By Lemma \ref{lemma-improve-presentation}
we see that $C_{x_i}$ is smooth over $k[x_1, \ldots, x_d]$
with finite free module of differentials. Hence some power of
$x_i$ is strictly standard in $C$ over $k[x_1, \ldots, x_n]$
by Lemma \ref{lemma-compare-standard}.

\medskip\noindent
Ad (\ref{item-NP}). This follows by applying Lemma \ref{lemma-solution-modulo}.

\medskip\noindent
Ad (\ref{item-choose-pii}). Since
$k[y_1, \ldots, y_m]_\mathfrak p \to \Lambda_\mathfrak q$ is
flat and $\mathfrak p \Lambda_\mathfrak q = \mathfrak q \Lambda_\mathfrak q$
by construction
we see that $\dim(k[y_1, \ldots, y_m]_\mathfrak p) = d$ by
Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-equals-total}.
Thus we can find $\pi_1, \ldots, \pi_d \in \Lambda$ which map to
a regular system of parameters in $\Lambda_\mathfrak q$.

\medskip\noindent
Ad (\ref{item-modify-pii}). By
Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}
any permutation of the sequence $\pi_1, \ldots, \pi_d$ is a
regular sequence in $k[y_1, \ldots, y_m]_\mathfrak p$. Hence
$\gamma_1 = \pi_1 t_1, \ldots, \gamma_d = \pi_d t_d$ is a regular
sequence in
$R_\mathfrak p = k[y_1, \ldots, y_m]_\mathfrak p[t_1, \ldots, t_d]$, see
Algebra, Lemma \ref{algebra-lemma-regular-sequence-in-polynomial-ring}.
Let $S = k[y_1, \ldots, y_m] \setminus \mathfrak p$ so that
$R_\mathfrak p = S^{-1}R$. Note that $\pi_1, \ldots, \pi_d$
and $\gamma_1, \ldots, \gamma_d$
remain regular sequences if we multiply our $\pi_i$ by elements of $S$.
Suppose that
$$
\text{Ann}_{R/(\gamma_1^e, \ldots, \gamma_{i - 1}^e)R}(\gamma_i)
=
\text{Ann}_{R/(\gamma_1^e, \ldots, \gamma_{i - 1}^e)R}(\gamma_i^2)
$$
holds for $i = 1, \ldots, t$ for some $t \in \{0, \ldots, d\}$. Note that
$\gamma_1^e, \ldots, \gamma_t^e, \gamma_{t + 1}$ is a
regular sequence in $S^{-1}R$ by
Algebra, Lemma \ref{algebra-lemma-regular-sequence-powers}.
Hence we see that
$$
\text{Ann}_{S^{-1}R/(\gamma_1^e, \ldots, \gamma_{i - 1}^e)}(\gamma_i) =
\text{Ann}_{S^{-1}R/(\gamma_1^e, \ldots, \gamma_{i - 1}^e)}(\gamma_i^2).
$$
Thus we get
$$
\text{Ann}_{R/(\gamma_1^e, \ldots, \gamma_t^e)R}(\gamma_{t + 1})
=
\text{Ann}_{R/(\gamma_1^e, \ldots, \gamma_t^e)R}(\gamma_{t + 1}^2)
$$
after replacing $\pi_{t + 1}$ by $s\pi_{t + 1}$ for some $s \in S$ by
Lemma \ref{lemma-ogoma}. By induction on $t$ this produces the desired
sequence.

\medskip\noindent
Ad (\ref{item-choose-deltai}). Let $S = \Lambda \setminus \mathfrak q$
so that $\Lambda_\mathfrak q = S^{-1}\Lambda$. Set
$\bar \Lambda = \Lambda_\mathfrak q/\mathfrak q^n \Lambda_\mathfrak q$.
Suppose that we have a $t \in \{0, \ldots, d\}$ and
$\delta_1, \ldots, \delta_t \in S$ and a factorization
$D \to D' \to \bar \Lambda$ as in (\ref{item-choose-deltai})
such that (a), (b), (c) hold for $i = 1, \ldots, t$. We have
$\pi_{t + 1}^N \in H_{A/k}\Lambda_\mathfrak q$
as $\mathfrak q^N \Lambda_\mathfrak q \subset H_{A/k}\Lambda_\mathfrak q$
by (\ref{item-power}). Hence
$\pi_{t + 1}^N \in H_{A/k} \bar\Lambda$. Hence
$\pi_{t + 1}^N \in H_{A/k}D'$ as $D' \to \bar \Lambda$
is faithfully flat, see
Algebra, Lemma \ref{algebra-lemma-faithfully-flat-universally-injective}.
Recall that $H_{A/k} = (a_1, \ldots, a_t)$.
Say $\pi_{t + 1}^N = \sum a_j d_j$ in $D'$ and choose
$c_j \in \Lambda_\mathfrak q$ lifting $d_j \in D'$. Then
$\pi_{t + 1}^N = \sum c_j a_j + \epsilon$ with
$\epsilon \in \mathfrak q^n\Lambda_\mathfrak q \subset
\mathfrak q^{n - N}H_{A/k}\Lambda_\mathfrak q$.
Write $\epsilon = \sum a_j c'_j$ for some
$c'_j \in \mathfrak q^{n - N}\Lambda_\mathfrak q$.
Hence $\pi_{t + 1}^{2N} = \sum (\pi_{t + 1}^N c_j + \pi_{t + 1}^N c'_j) a_j$.
Note that $\pi_{t + 1}^Nc'_j$ maps to zero in $\bar \Lambda$; this trivial
but key observation will ensure later that (a) holds.
Now we choose $s \in S$ such that there exist
$\mu_{t + 1j} \in \Lambda$ such that on the one hand
$\pi_{t + 1}^N c_j + \pi_{t + 1}^N c'_j = \mu_{t + 1j}/s^{2N}$
in $S^{-1}\Lambda$ and on the other
$(s \pi_{t + 1})^{2N} = \sum \mu_{t + 1j}a_j$
in $\Lambda$ (minor detail omitted). We may further replace $s$ by
a power and enlarge $D'$ such that $s$ maps to an element of $D'$.
With these choices $\mu_{t + 1j}$ maps to $s^{2N}d_j$ which is
an element of $D'$. Note that $\pi_1, \ldots, \pi_d$ are a regular
sequence of parameters in $S^{-1}\Lambda$ by our
choice of $\varphi$. Hence $\pi_1, \ldots, \pi_d$ forms a regular sequence
in $\Lambda_\mathfrak q$ by
Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}.
It follows that ${\pi'}_1^e, \ldots, {\pi'}_t^e, s\pi_{t + 1}$ is a
regular sequence in $S^{-1}\Lambda$ by
Algebra, Lemma \ref{algebra-lemma-regular-sequence-powers}.
Thus we get
$$
\text{Ann}_{S^{-1}\Lambda/({\pi'}_1^e, \ldots, {\pi'}_t^e)}(s\pi_{t + 1}) =
\text{Ann}_{S^{-1}\Lambda/({\pi'}_1^e, \ldots, {\pi'}_t^e)}((s\pi_{t + 1})^2).
$$
Hence we may apply Lemma \ref{lemma-ogoma} to find an $s' \in S$
such that
$$
\text{Ann}_{\Lambda/({\pi'}_1^e, \ldots, {\pi'}_t^e)}((s')^qs\pi_{t + 1})
=
\text{Ann}_{\Lambda/({\pi'}_1^e, \ldots, {\pi'}_t^e)}(((s')^qs\pi_{t + 1})^2).
$$
for any $q > 0$. By Lemma \ref{lemma-enlarge-solution-modulo}
we can choose $q$ and enlarge $D'$ such that $(s')^q$ maps to an element
of $D'$. Setting $\delta_{t + 1} = (s')^qs$ and we conclude that
(a), (b), (c) hold for $i = 1, \ldots, t + 1$. For (a) note that
$\lambda_{t + 1j} = (s')^{2Nq}\mu_{t + 1j}$ works.
By induction on $t$ we win.

\medskip\noindent
Ad (\ref{item-first-solve}). By construction the radical of
$H_{(C \otimes_{k[x_1, \ldots, x_d]} R)/R} \Lambda$ contains
$\mathfrak h_A$. Namely, the elements $a_j \in H_{A/k}$
map to elements of $H_{B/k[x_1, \ldots, x_n]}$, hence map to elements
of $H_{C/k[x_1, \ldots, x_n]}$, hence $a_j \otimes 1$ map to elements of
$H_{C \otimes_{k[x_1, \ldots, x_d]} R/R}$. Moreover, if we have a solution
$C \otimes_{k[x_1, \ldots, x_n]} R \to T \to \Lambda$ of
$$
R
\to
C \otimes_{k[x_1, \ldots, x_d]} R
\to
\Lambda \supset \mathfrak q
$$
then $H_{T/R} \subset H_{T/k}$ as $R$ is smooth over $k$.
Hence $T$ will also be a solution for
the original situation $k \to A \to \Lambda \supset \mathfrak q$.

\medskip\noindent
Ad (\ref{item-second-resolve}). Follows on applying
Lemma \ref{lemma-lift-solution} to
$R \to C \otimes_{k[x_1, \ldots, x_d]} R
\to \Lambda \supset \mathfrak q$ and the sequence of
elements $\gamma_1^c, \ldots, \gamma_d^c$. We note that since $x_i^c$
are strictly standard in $C$ over $k[x_1, \ldots, x_d]$ the elements
$\gamma_i^c$ are strictly standard in $C \otimes_{k[x_1, \ldots, x_d]} R$
over $R$ by Lemma \ref{lemma-strictly-standard-base-change}.
The other assumption of Lemma \ref{lemma-lift-solution} holds by steps
(\ref{item-modify-pii}) and (\ref{item-choose-deltai}).

\medskip\noindent
Ad (\ref{item-third-resolve}). Apply Lemma \ref{lemma-delocalize-height-zero}
to the situation in (\ref{item-second-resolve}). In the rest of the
arguments the target ring is local Artinian, hence we are looking for
a factorization by a smooth algebra $T$ over the source ring.

\medskip\noindent
Ad (\ref{item-fifth-resolve}).
Suppose that $C \otimes_{k[x_1, \ldots, x_d]} (R/JR)_\mathfrak p \to
T \to \Lambda_\mathfrak q/J\Lambda_\mathfrak q$ is a solution to
$$
(R/JR)_\mathfrak p \to
C \otimes_{k[x_1, \ldots, x_d]} (R/JR)_\mathfrak p \to
\Lambda_\mathfrak q/J\Lambda_\mathfrak q
\supset
\mathfrak q\Lambda_\mathfrak q/J\Lambda_\mathfrak q
$$
Then $C \otimes_{k[x_1, \ldots, x_d]} (R/I)_\mathfrak r \to T_\mathfrak r \to
\Lambda_\mathfrak q/I\Lambda_\mathfrak q$
is a solution to the situation in (\ref{item-third-resolve}).

\medskip\noindent
Ad (\ref{item-sixth-resolve}). Our $n = N + dc$ is large enough so that
$\mathfrak p^nk[y_1, \ldots, y_m]_\mathfrak p \subset J_\mathfrak p$
and $\mathfrak q^n \Lambda_\mathfrak q \subset J\Lambda_\mathfrak q$.
Hence if we have a solution
$C \otimes_{k[x_1, \ldots, x_d]} (R/\mathfrak p^nR)_\mathfrak p \to
T \to \Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$
of (\ref{item-fifth-resolve}
then we can take $T/JT$ as the solution for
(\ref{item-sixth-resolve}).

\medskip\noindent
Ad (\ref{item-seventh-resolve}). This is true because we have a
section $C \to B$ in the category of $R$-algebras.

\medskip\noindent
Ad (\ref{item-eighth-resolve}). This is true because $D'$ is
essentially smooth over the local Artinian ring
$k[y_1, \ldots, y_m]_\mathfrak p/\mathfrak p^n k[y_1, \ldots, y_m]_\mathfrak p$
and
$$
R_\mathfrak p/\mathfrak p^nR_\mathfrak p =
k[y_1, \ldots, y_m]_\mathfrak p/
\mathfrak p^n k[y_1, \ldots, y_m]_\mathfrak p[t_1, \ldots, t_d].
$$
Hence $D'[t_1, \ldots, t_d]$ is a filtered colimit of smooth
$R_\mathfrak p/\mathfrak p^nR_\mathfrak p$-algebras and
$B \otimes_{k[x_1, \ldots, x_d]} (R_\mathfrak p/\mathfrak p^nR_\mathfrak p)$
factors through one of these.

\medskip\noindent
Ad (\ref{item-done}). The final twist of the proof is that we cannot
just use the map $B \to D'$ which maps $x_i$ to the image of $\pi_i'$
in $D'$ and $z_{ij}$ to the image of $\lambda_{ij}$ in $D'$
because we need the diagram
$$
\xymatrix{
B \ar[r] & D'[t_1, \ldots, t_d] \\
k[x_1, \ldots, x_d] \ar[r] \ar[u] &
R_\mathfrak p/\mathfrak p^nR_\mathfrak p \ar[u]
}
$$
to commute and we need the composition
$B \to D'[t_1, \ldots, t_d] \to
\Lambda_\mathfrak q/\mathfrak q^n\Lambda_\mathfrak q$
to be the map of (\ref{item-map-B-Lambda}).
This requires us to map $x_i$ to the image of
$\pi_i t_i$ in $D'[t_1, \ldots, t_d]$.
Hence we map $z_{ij}$ to the image of
$\lambda_{ij} t_i^{2N} / \delta_i^{2N}$ in $D'[t_1, \ldots, t_d]$
and everything is clear.
\end{proof}







\section{The main theorem}
\label{section-main}

\noindent
In this section we wrap up the discussion.

\begin{theorem}[Popescu]
\label{theorem-popescu}
Any regular homomorphism of Noetherian rings is a filtered colimit
of smooth ring maps.
\end{theorem}

\begin{proof}
By Lemma \ref{lemma-reduce-to-field}
it suffices to prove this for $k \to \Lambda$
where $\Lambda$ is Noetherian and geometrically regular over $k$.
Let $k \to A \to \Lambda$ be a factorization with $A$ a finite type
$k$-algebra. It suffices to construct a factorization
$A \to B \to \Lambda$ with $B$ of finite type such that
$\mathfrak h_B = \Lambda$, see Lemma \ref{lemma-final-solve}.
Hence we may perform Noetherian induction on the ideal $\mathfrak h_A$.
Pick a prime $\mathfrak q \supset \mathfrak h_A$ such that
$\mathfrak q$ is minimal over $\mathfrak h_A$.
It now suffices to resolve $k \to A \to \Lambda \supset \mathfrak q$
(as defined in the text following Situation \ref{situation-local}).
If the characteristic of $k$ is zero, this follows from
Lemma \ref{lemma-resolve-special}.
If the characteristic of $k$ is $p > 0$, this follows from
Lemma \ref{lemma-resolve-general}.
\end{proof}




\section{The approximation property for G-rings}
\label{section-approximation-G-rings}

\noindent
Let $R$ be a Noetherian local ring. In this case $R$ is a G-ring if and
only if the ring map $R \to R^\wedge$ is regular, see
More on Algebra, Lemma \ref{more-algebra-lemma-check-G-ring-maximal-ideals}.
In this case it is true that the henselization $R^h$ and the strict
henselization $R^{sh}$ of $R$ are G-rings, see
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-G-ring}.
Moreover, any algebra essentially of finite type over a field, over a
complete local ring, over $\mathbf{Z}$, or over a characteristic zero
Dedekind ring is a G-ring, see
More on Algebra, Proposition \ref{more-algebra-proposition-ubiquity-G-ring}.
This gives an ample supply of rings to which the result below applies.

\medskip\noindent
Let $R$ be a ring. Let $f_1, \ldots, f_m \in R[x_1, \ldots, x_n]$.
Let $S$ be an $R$-algebra. In this situation we say a vector
$(a_1, \ldots, a_n) \in S^n$ is a {\it solution in $S$}
if and only if
$$
f_j(a_1, \ldots, a_n) = 0 \text{ in } S, \text{ for }
j = 1, \ldots, m
$$
Of course an important question in algebraic geometry is to see when
systems of polynomial equations have solutions. The following theorem
tells us that having solutions in the completion of a local Noetherian
ring is often enough to show there exist solutions in the henselization
of the ring.

\begin{theorem}
\label{theorem-approximation-property}
Let $R$ be a Noetherian local ring. Let
$f_1, \ldots, f_m \in R[x_1, \ldots, x_n]$.
Suppose that $(a_1, \ldots, a_n) \in (R^\wedge)^n$ is a solution
in $R^\wedge$. If $R$ is a henselian G-ring, then for every integer
$N$ there exists a solution $(b_1, \ldots, b_n) \in R^n$ in $R$ such that
$a_i - b_i \in \mathfrak m^NR^\wedge$.
\end{theorem}

\begin{proof}
Let $c_i \in R$ be an element such that $a_i - c_i \in \mathfrak m^N$.
Choose generators $\mathfrak m^N = (d_1, \ldots, d_M)$.
Write $a_i = c_i + \sum a_{i, l} d_l$.
Consider the polynomial ring $R[x_{i, l}]$ and the elements
$$
g_j = f_j(c_1 + \sum x_{1, l} d_l , \ldots, c_n + \sum x_{n, l} d_{n, l})
\in R[x_{i, l}]
$$
The system of equations $g_j = 0$ has the solution $(a_{i, l})$.
Suppose that we can show that $g_j$ as a solution $(b_{i, l})$ in $R$.
Then it follows that $b_i = c_i + \sum b_{i, l}d_l$ is a solution
of $f_j = 0$ which is congruent to $a_i$ modulo $\mathfrak m^N$.
Thus it suffices to show that solvability over $R^\wedge$ implies
solvability over $R$.

\medskip\noindent
Let $A \subset R^\wedge$ be the $R$-subalgebra generated by
$a_1, \ldots, a_n$. Since we've assumed $R$ is a G-ring, i.e.,
that $R \to R^\wedge$ is regular, we see that
there exists a factorization
$$
A \to B \to R^\wedge
$$
with $B$ smooth over $R$, see Theorem \ref{theorem-popescu}.
Denote $\kappa = R/\mathfrak m$ the residue field. It is also
the residue field of $R^\wedge$, so we get a commutative diagram
$$
\xymatrix{
B \ar[rd] \ar@{..>}[r] & R' \ar@{..>}[d] \\
R \ar[r] \ar[u] & \kappa
}
$$
Since the vertical arrow is smooth,
More on Algebra, Lemma \ref{more-algebra-lemma-lift-section-smooth-morphism}
implies that there exists an \'etale ring map $R \to R'$
which induces an isomorphism $R/\mathfrak m \to R'/\mathfrak mR'$
and an $R$-algebra map $B \to R'$ making the diagram above commute.
Since $R$ is henselian we see that $R \to R'$ has a section, see
Algebra, Lemma \ref{algebra-lemma-characterize-henselian}.
Let $b_i \in R$ be the image of $a_i$ under the ring maps
$A \to B \to R' \to R$. Since all of these maps are $R$-algebra
maps, we see that $(b_1, \ldots, b_n)$ is a solution in $R$.
\end{proof}

\noindent
Given a Noetherian local ring $(R, \mathfrak m)$, an \'etale
ring map $R \to R'$, and a maximal ideal $\mathfrak m' \subset R'$
lying over $\mathfrak m$ with $\kappa(\mathfrak m) = \kappa(\mathfrak m')$,
then we have inclusions
$$
R \subset R_{\mathfrak m'} \subset R^h \subset R^\wedge,
$$
by Algebra, Lemma \ref{algebra-lemma-henselian-functorial-prepare} and
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-noetherian}.

\begin{theorem}
\label{theorem-approximation-property-variant}
Let $R$ be a Noetherian local ring. Let
$f_1, \ldots, f_m \in R[x_1, \ldots, x_n]$.
Suppose that $(a_1, \ldots, a_n) \in (R^\wedge)^n$ is a solution.
If $R$ is a G-ring, then for every integer $N$ there exist
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a maximal ideal $\mathfrak m' \subset R'$ lying over $\mathfrak m$
\item a solution $(b_1, \ldots, b_n) \in (R')^n$ in $R'$
\end{enumerate}
such that $\kappa(\mathfrak m) = \kappa(\mathfrak m')$ and
$a_i - b_i \in (\mathfrak m')^NR^\wedge$.
\end{theorem}

\begin{proof}
We could deduce this theorem from Theorem \ref{theorem-approximation-property}
using that the henselization $R^h$ is a G-ring by
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-G-ring}
and writing $R^h$ as a directed colimit of \'etale extension $R'$.
Instead we prove this by redoing the proof of the previous theorem
in this case.

\medskip\noindent
Let $c_i \in R$ be an element such that $a_i - c_i \in \mathfrak m^N$.
Choose generators $\mathfrak m^N = (d_1, \ldots, d_M)$.
Write $a_i = c_i + \sum a_{i, l} d_l$.
Consider the polynomial ring $R[x_{i, l}]$ and the elements
$$
g_j = f_j(c_1 + \sum x_{1, l} d_l , \ldots, c_n + \sum x_{n, l} d_{n, l})
\in R[x_{i, l}]
$$
The system of equations $g_j = 0$ has the solution $(a_{i, l})$.
Suppose that we can show that $g_j$ as a solution $(b_{i, l})$ in $R'$
for some \'etale ring map $R \to R'$ endowed with a maximal ideal
$\mathfrak m'$ such that $\kappa(\mathfrak m) = \kappa(\mathfrak m')$.
Then it follows that $b_i = c_i + \sum b_{i, l}d_l$ is a solution
of $f_j = 0$ which is congruent to $a_i$ modulo $(\mathfrak m')^N$.
Thus it suffices to show that solvability over $R^\wedge$ implies
solvability over some \'etale ring extension which induces a trivial
residue field extension at some prime over $\mathfrak m$.

\medskip\noindent
Let $A \subset R^\wedge$ be the $R$-subalgebra generated by
$a_1, \ldots, a_n$. Since we've assumed $R$ is a G-ring, i.e.,
that $R \to R^\wedge$ is regular, we see that
there exists a factorization
$$
A \to B \to R^\wedge
$$
with $B$ smooth over $R$, see Theorem \ref{theorem-popescu}.
Denote $\kappa = R/\mathfrak m$ the residue field. It is also
the residue field of $R^\wedge$, so we get a commutative diagram
$$
\xymatrix{
B \ar[rd] \ar@{..>}[r] & R' \ar@{..>}[d] \\
R \ar[r] \ar[u] & \kappa
}
$$
Since the vertical arrow is smooth,
More on Algebra, Lemma \ref{more-algebra-lemma-lift-section-smooth-morphism}
implies that there exists an \'etale ring map $R \to R'$
which induces an isomorphism $R/\mathfrak m \to R'/\mathfrak mR'$
and an $R$-algebra map $B \to R'$ making the diagram above commute.
Let $b_i \in R'$ be the image of $a_i$ under the ring maps
$A \to B \to R'$. Since all of these maps are $R$-algebra
maps, we see that $(b_1, \ldots, b_n)$ is a solution in $R'$.
\end{proof}

\begin{example}
\label{example-describe-henselian}
Let $(R, \mathfrak m)$ be a Noetherian local ring with henselization $R^h$.
The map on completions $R^\wedge \to (R^h)^\wedge$ is an isomorphism, see
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-noetherian}.
Since also $R^h$ is Noetherian (ibid.) we may think of $R^h$ as a subring
of its completion (because the completion is faithfully flat). In this way
we see that we may identify $R^h$ with a subring of $R^\wedge$.

\medskip\noindent
Let us try to understand which elements of $R^\wedge$ are in $R^h$. For
simplicity we assume $R$ is a domain with fraction field $K$. Clearly,
every element $f$ of $R^h$ is algebraic over $R$, in the sense that
there exists an equation of the form $a_n f^n + \ldots + a_1 f + a_0 = 0$
for some $a_i \in R$ with $n > 0$ and $a_n \not = 0$.

\medskip\noindent
Conversely, assume that $f \in R^\wedge$, $n \in \mathbf{N}$, and
$a_0, \ldots, a_n \in R$ with $a_n \not = 0$ such that
$a_n f^n + \ldots + a_1 f + a_0 = 0$. If $R$ is a G-ring, then, for
every $N > 0$ there exists an element $g \in R^h$ with
$a_n g^n + \ldots + a_1 g + a_0 = 0$ and $f - g \in \mathfrak m^N R^\wedge$,
see Theorem \ref{theorem-approximation-property-variant}.
We'd like to conclude that $f = g$ when $N \gg 0$.
If this is not true, then we find infinitely many roots $g$ of $P(T)$
in $R^h$. This is impossible because (1) $R^h \subset R^h \otimes_R K$
and (2) $R^h \otimes_R K$ is a finite product of field extensions of $K$.
Namely, $R \to K$ is injective and $R \to R^h$ is flat, hence
$R^h \to R^h \otimes_R K$ is injective and (2) follows from
More on Algebra, Lemma \ref{more-algebra-lemma-fibres-henselization}.

\medskip\noindent
Conclusion: If $R$ is a Noetherian local domain with fraction field $K$
and a G-ring, then $R^h \subset R^\wedge$ is the set of all elements which
are algebraic over $K$.
\end{example}

\noindent
Here is another variant of the main theorem of this section.

\begin{lemma}
\label{lemma-approximation-property-variant}
Let $R$ be a Noetherian ring. Let $\mathfrak p \subset R$ be a prime ideal. Let
$f_1, \ldots, f_m \in R[x_1, \ldots, x_n]$.
Suppose that $(a_1, \ldots, a_n) \in ((R_\mathfrak p)^\wedge)^n$ is a solution.
If $R_\mathfrak p$ is a G-ring, then for every integer $N$ there exist
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a prime ideal $\mathfrak p' \subset R'$ lying over $\mathfrak p$
\item a solution $(b_1, \ldots, b_n) \in (R')^n$ in $R'$
\end{enumerate}
such that $\kappa(\mathfrak p) = \kappa(\mathfrak p')$ and
$a_i - b_i \in (\mathfrak p')^N(R'_{\mathfrak p'})^\wedge$.
\end{lemma}

\begin{proof}
By Theorem \ref{theorem-approximation-property-variant}
we can find a solution $(b'_1, \ldots, b'_n)$ in some ring
$R''$ \'etale over $R_\mathfrak p$ which comes with a
prime ideal $\mathfrak p''$ lying over $\mathfrak p$ such
that $\kappa(\mathfrak p) = \kappa(\mathfrak p'')$ and
$a_i - b'_i \in (\mathfrak p'')^N(R''_{\mathfrak p''})^\wedge$.
We can write
$R'' = R' \otimes_R R_\mathfrak p$ for some \'etale $R$-algebra $R'$
(see Algebra, Lemma \ref{algebra-lemma-etale}). After replacing
$R'$ by a principal localization if necessary we may assume
$(b'_1, \ldots, b'_n)$ come from a solution $(b_1, \ldots, b_n)$
in $R'$. Setting $\mathfrak p' = R' \cap \mathfrak p''$ we
see that $R''_{\mathfrak p''} = R'_{\mathfrak p'}$ which finishes the proof.
\end{proof}



\section{Approximation for henselian pairs}
\label{section-approximation-pairs}

\noindent
We can generalize the discussion of
Section \ref{section-approximation-G-rings} to the case of henselian pairs.
Henselian pairs where defined in
More on Algebra, Section \ref{more-algebra-section-henselian-pairs}.

\begin{lemma}
\label{lemma-henselian-pair}
\begin{slogan}
Approximation for henselian pairs.
\end{slogan}
Let $(A, I)$ be a henselian pair with $A$ Noetherian.
Let $A^\wedge$ be the $I$-adic completion
of $A$. Assume at least one of the following
conditions holds
\begin{enumerate}
\item $A \to A^\wedge$ is a regular ring map,
\item $A$ is a Noetherian G-ring, or
\item $(A, I)$ is the henselization
(More on Algebra, Lemma \ref{more-algebra-lemma-henselization})
of a pair $(B, J)$ where $B$ is a Noetherian G-ring.
\end{enumerate}
Given $f_1, \ldots, f_m \in A[x_1, \ldots, x_n]$
and $\hat{a}_1, \ldots, \hat{a}_n \in A^\wedge$ such that
$f_j(\hat{a}_1, \ldots, \hat{a}_n) = 0$
for $j = 1, \ldots, m$, for every $N \geq 1$ there exist
$a_1, \ldots, a_n \in A$ such that
$\hat{a}_i - a_i \in I^N$ and such that $f_j(a_1, \ldots, a_n) = 0$
for $j = 1, \ldots, m$.
\end{lemma}

\begin{proof}
By More on Algebra, Lemma
\ref{more-algebra-lemma-henselization-pair-G-ring}
we see that (3) implies (2). By More on Algebra, Lemma
\ref{more-algebra-lemma-map-G-ring-to-completion-regular}
we see that (2) implies (1).
Thus it suffices to prove the lemma in case $A \to A^\wedge$ is
a regular ring map.

\medskip\noindent
Let $\hat{a}_1, \ldots, \hat{a}_n$ be as in the statement of the lemma.
By Theorem \ref{theorem-popescu} we can find a factorization
$A \to B \to A^\wedge$ with $A \to P$ smooth and
$b_1, \ldots, b_n \in B$ with $f_j(b_1, \ldots, b_n) = 0$ in $B$.
Denote $\sigma : B \to A^\wedge \to A/I^N$ the composition.
By More on Algebra, Lemma \ref{more-algebra-lemma-lift-section-smooth-morphism}
we can find an \'etale ring
map $A \to A'$ which induces an isomorphism $A/I^N \to A'/I^NA'$
and an $A$-algebra map $\tilde \sigma : B \to A'$ lifting $\sigma$.
Since $(A, I)$ is henselian, there is an $A$-algebra map $\chi : A' \to A$,
see More on Algebra, Lemma \ref{more-algebra-lemma-characterize-henselian-pair}.
Then setting $a_i = \chi(\tilde \sigma(b_i))$ gives a solution.
\end{proof}



\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
