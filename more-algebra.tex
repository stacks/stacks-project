\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Algebra}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we prove some results in commutative algebra which
are less elementary than those in the first chapter on commutative
algebra, see
Algebra, Section \ref{algebra-section-introduction}.
A reference is \cite{MatCA}.






\section{A comment on the Artin-Rees property}
\label{section-artin-rees}

\noindent
Some of this material is taken from \cite{conrad-dejong}. A general
discussion with additional references can be found in
\cite[Section 1]{Eis}.

\medskip\noindent
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal. Given a
homomorphism $f : M \to N$ of finite $A$-modules there exists a $c \geq 0$
such that
$$
f(M) \cap I^nN \subset f(I^{n - c}M)
$$
for all $n \geq c$, see Algebra, Lemma \ref{algebra-lemma-map-AR}. In this
situation we will say {\it $c$ works for $f$ in the Artin-Rees lemma}.

\begin{lemma}
\label{lemma-approximate-complex}
Let $A$ be a Noetherian ring. Let $I \subset A$ be an ideal contained in
the Jacobson radical of $A$. Let
$$
S : L \xrightarrow{f} M \xrightarrow{g} N
\quad\text{and}\quad
S' : L \xrightarrow{f'} M \xrightarrow{g'} N
$$
be two complexes of finite $A$-modules as shown. Assume that
\begin{enumerate}
\item $c$ works in the Artin-Rees lemma for $f$ and $g$,
\item the complex $S$ is exact, and
\item $f' = f \bmod I^{c + 1}M$ and $g' = g \bmod I^{c + 1}N$.
\end{enumerate}
Then $c$ works in the Artin-Rees lemma for $g'$ and the
complex $S'$ is exact.
\end{lemma}

\begin{proof}
We first show that $g'(L) \cap I^nM \subset g'(I^{n - c}L)$ for $n \geq c$.
Let $a$ be an element of $M$ such that $g'(a) \in I^nN$. We want to
adjust $a$ by an element of $f'(L)$, i.e, without changing $g'(a)$, so
that $a \in I^{n-c}M$. Assume that $a \in I^rM$, where $r < n - c$.
Then
$$
g(a) = g'(a) + (g - g')(a) \in
I^n N + I^{r + c + 1}N = I^{r + c + 1}N.
$$
By Artin-Rees for $g$ we have $g(a) \in g(I^{r + 1}M)$. Say $g(a) = g(a_1)$
with $a_1 \in I^{r + 1}M$. Since the sequence $S$ is exact, $a - a_1 \in f(L)$.
Accordingly, we write $a = f(b) + a_1$ for some $b \in L$.
Then $f(b) = a - a_1 \in I^rM$. Artin-Rees for $f$ shows that
if $r \geq c$, we may replace $b$ by an element of $I^{r - c}L$.
Then in all cases, $a = f'(b) + a_2$, where
$a_2 = (f - f')(b) + a_1 \in I^{r + 1}M$. (Namely, either $c \geq r$
and $(f - f')(b) \in I^{r + 1}M$ by assumption, or $c < r$ and
$b \in I^{r - c}$, whence again $(f - f')(b) \in I^{c + 1} I^{r - c} M =
I^{r + 1}M$.) So we can adjust $a$ by the element $f'(b) \in f'(L)$ to
increase $r$ by $1$.

\medskip\noindent
In fact, the argument above shows that
$(g')^{-1}(I^nM) \subset f'(L) + I^{n - c}M$ for all $n \geq c$.
Hence $S'$ is exact because
$$
(g')^{-1}(0) = (g')^{-1}(\bigcap I^nN) \subset
\bigcap f'(L) + I^{n - c}M = f'(L)
$$
as $I \subset \text{rad}(A)$, see Algebra, Lemma
\ref{algebra-lemma-intersection-powers-ideal-module}.
\end{proof}

\noindent
Given an ideal $I \subset A$ of a ring $A$ and an $A$-module $M$
we set
$$
\text{Gr}_I(M) = \bigoplus I^nM/I^{n + 1}M.
$$
We think of this as a graded $\text{Gr}_I(A)$-module.

\begin{lemma}
\label{lemma-approximate-complex-graded}
Assumptions as in Lemma \ref{lemma-approximate-complex}.
Let $Q = \text{Coker}(g)$ and $Q' = \text{Coker}(g')$. Then
$\text{Gr}_I(Q) \cong \text{Gr}_I(Q')$
as graded $\text{Gr}_I(A)$-modules.
\end{lemma}

\begin{proof}
In degree $n$ we have
$\text{Gr}_I(Q)_n = I^nN/(I^{n + 1}N + g(M) \cap I^nN)$
and similarly for $Q'$. We claim that
$$
g(M) \cap I^nN \subset I^{n + 1}N + g'(M) \cap I^nN.
$$
By symmetry (the proof of the claim will only use that $c$ works
for $g$ which also holds for $g'$ by the lemma) this will imply that
$$
I^{n + 1}N + g(M) \cap I^nN = I^{n + 1}N + g'(M) \cap I^nN
$$
whence $\text{Gr}_I(Q)_n$ and $\text{Gr}_I(Q')_n$ agree as subquotients
of $N$, implying the lemma. Observe that the claim is clear for
$n \leq c$ as $f = f' \bmod I^{c + 1}N$. If $n > c$, then suppose
$b \in g(M) \cap I^nN$. Write $b = g(a)$ for $a \in I^{n - c}M$.
Set $b' = g'(a)$. We have $b - b' = (g - g')(a) \in I^{n + 1}N$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-works-flat-extension}
Let $A \to B$ be a flat map of Noetherian rings. Let $I \subset A$ be
an ideal. Let $f : M \to N$ be a homomorphism of finite $A$-modules.
Assume that $c$ works for $f$ in the Artin-Rees lemma. Then $c$ works for
$f \otimes 1 : M \otimes_A B \to N \otimes_A B$ in the Artin-Rees lemma
for the ideal $IB$.
\end{lemma}

\begin{proof}
Note that
$$
(f \otimes 1)(M) \cap I^n N \otimes_A B
= (f \otimes 1)\left((f \otimes 1)^{-1}(I^n N \otimes_A B)\right)
$$
On the other hand,
\begin{align*}
(f \otimes 1)^{-1}(I^n N \otimes_A B) &
= \text{Ker}(M \otimes_A B \to N \otimes_A B/(I^n N \otimes_A B)) \\
& =
\text{Ker}(M \otimes_A B \to (N/I^nN) \otimes_A B)
\end{align*}
As $A \to B$ is flat taking kernels and cokernels commutes with
tensoring with $B$, whence this is equal to
$f^{-1}(I^nN) \otimes_A B$. By assumption $f^{-1}(I^nN)$ is contained in
$\text{Ker}(f) + I^{n - c}M$. Thus the lemma holds.
\end{proof}








\section{Fibre products of rings}
\label{section-fibre-products-rings}

\noindent
Fibre products of rings have to do with pushouts of schemes. A special
case of pushouts of schemes is discussed in
More on Morphisms, Section \ref{more-morphisms-section-pushouts}.

\begin{lemma}
\label{lemma-fibre-product-finite-type}
Let $R$ be a ring. Let $A \to B$ and $C \to B$ be $R$-algebra maps.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $A$, $B$, $C$ are of finite type over $R$,
\item $A \to B$ is surjective, and
\item $B$ is finite over $C$.
\end{enumerate}
Then $A \times_B C$ is of finite type over $R$.
\end{lemma}

\begin{proof}
Set $D = A \times_B C$. There is a commutative diagram
$$
\xymatrix{
0 \ar[r] &
I \ar[r] &
A \ar[r] &
B \ar[r] &
0 \\
0 \ar[r] &
I \ar[r] \ar[u] &
D \ar[r] \ar[u] &
C \ar[r] \ar[u] &
0
}
$$
with exact rows. Choose $y_1, \ldots, y_n \in B$ which are generators for
$B$ as a $C$-module. Choose $x_i \in A$ mapping to $y_i$.
Then $1, x_1, \ldots, x_n$ are generators for $A$ as a $D$-module.
The map $D \to A \times C$ is injective, and the ring $A \times C$ is finite
as a $D$-module (because it is the direct sum of the finite $D$-modules
$A$ and $C$). Hence the lemma follows from the Artin-Tate lemma
(Algebra, Lemma \ref{algebra-lemma-Artin-Tate}).
\end{proof}

\begin{lemma}
\label{lemma-formal-consequence}
Let $R$ be a Noetherian ring. Let $I$ be a finite set. Suppose given a
cartesian diagram
$$
\xymatrix{
P \ar[d] \ar[r] & \prod A_i \ar[d]^{\prod \varphi_i} \\
Q \ar[r]^{\prod \psi_i} & \prod B_i
}
$$
with $\psi_i$ and $\varphi_i$ surjective, and $Q$, $A_i$, $B_i$ of
finite type over $R$. Then $R$ is of finite type over $R$.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-fibre-product-finite-type}
and induction on the size of $I$.
Namely, let $I = I' \amalg \{i_0\}$. Let $P'$ be the ring defined
by the diagram of the lemma using $I'$. Then $P'$ is of finite type
by the lemma. Finally, $P$ sits in a fibre product diagram
$$
\xymatrix{
P \ar[d] \ar[r] & A_{i_0} \ar[d] \\
P' \ar[r] & B_{i_0}
}
$$
to which the lemma applies.
\end{proof}

\begin{lemma}
\label{lemma-diagram-localize}
Suppose given a cartesian diagram of rings
$$
\xymatrix{
B \ar[r]_s & R \\
B'\ar[u] \ar[r] & R', \ar[u]_t
}
$$
i.e., $B' = B \times_R R'$. If $h \in B'$ corresponds to $g \in B$
and $f \in R'$ such that $s(g) = t(f)$, then the diagram
$$
\xymatrix{
B_g \ar[r]_-s & R_{s(g)} = R_{t(f)} \\
(B')_h \ar[u] \ar[r] & (R')_f \ar[u]_t
}
$$
is cartesian too.
\end{lemma}

\begin{proof}
Note that $B' = \{(b, r') \in B \times R' \mid s(b) = t(r')\}$.
So $h = (g, f) \in B'$. First we show that $(B')_h$ maps
injectively into $B_g \times (R')_f$. Namely, suppose that
$(x, y)/h^n$ maps to zero. This means that
$g^Nx = 0$ for some $N$ and $f^My$ is zero for some $M$.
Thus $h^{\max(N, M)}(x, y) = 0$ in $B'$ and hence $(x, y)/h^n = 0$
in $B'_h$.
Next, suppose that $x/g^n$ and $y/f^m$ are elements
which map to the same element of $R_{s(g)}$.
This means that $s(g)^N(t(f)^ms(x) - s(g)^nt(y)) = 0$ in $R'$
for some $N \gg 0$. We can rewrite this as
$s(g^{m + N}x) = t(f^{n + N}y)$. Hence we see that the
pair $(x/g^n, y/f^m)$ is the image of the element
$(g^{m + N}x, f^{n + N}y)/h^{n + m + N}$ of
$(B')_h$.
\end{proof}

\begin{situation}
\label{situation-module-over-fibre-product}
In the following we will consider ring maps
$$
\xymatrix{
B \ar[r] & A & A' \ar[l]
}
$$
where we assume $A' \to A$ is surjective with kernel $I$.
In this situation we set $B' = B \times_A A'$ to
obtain a cartesian square
$$
\xymatrix{
A & A' \ar[l] \\
B \ar[u] & B' \ar[l] \ar[u]
}
$$
We'd like to understand $B'$-modules in terms of modules over $A'$, $A$,
and $B$. In order to do this we consider the functor (where the
fibre product of categories as constructed in
Categories, Example \ref{categories-example-2-fibre-product-categories})
\begin{equation}
\label{equation-functor}
\text{Mod}_{B'} \longrightarrow
\text{Mod}_B \times_{\text{Mod}_A} \text{Mod}_{A'},\quad
L' \longmapsto (L' \otimes_{B'} B, L' \otimes_{B'} A', can)
\end{equation}
where $can$ is the canonical identification
$L' \otimes_{B'} B \otimes_B A = L' \otimes_{B'} A' \otimes_{A'} A$.
In the following we will write $(N, M', \varphi)$ for an object
of the right hand side, i.e., $N$ is a $B$-module, $M'$ is an $A'$-module
and $\varphi : N \otimes_B A \to M' \otimes_{A'} A$ is an isomorphism.
However, it is often more convenient think of $\varphi$ as a $B$-linear
map $\varphi : N \to M'/IM'$ which induces an isomorphism
$N \otimes_B A \to M' \otimes_{A'} A = M'/IM'$.
\end{situation}

\begin{lemma}
\label{lemma-module-over-fibre-product}
In Situation \ref{situation-module-over-fibre-product}
the functor (\ref{equation-functor}) has a right adjoint, namely
the functor
$$
F : (N, M', \varphi) \longmapsto N \times_{\varphi, M} M'
$$
where $M = M'/IM'$. Moreover, the composition of $F$ with
(\ref{equation-functor}) is the identity functor on
$\text{Mod}_B \times_{\text{Mod}_A} \text{Mod}_{A'}$. In other words,
setting $N' = N \times_{\varphi, M} M'$ we have
$N' \otimes_{B'} B = N$ and $N' \otimes_{B'} A' = M'$.
\end{lemma}

\begin{proof}
The adjointness statement is that for a $B'$-module $L'$ and
a triple $(N, M', \varphi)$ we have
$$
\Hom_{B'}(L', N \times_{\varphi, M} M') =
\Hom_B(L' \otimes_{B'} B, N)
\times_{\Hom_A(L' \otimes_{B'} A, M)}
\Hom_{A'}(L' \otimes_{B'} A', M')
$$
This follows from
Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}
and the fact that an element of the left hand side is given by a pair
of $B'$-linear maps $L' \to N$ and $L' \to M'$ agreeing as maps to $M$.
To prove the final assertion, recall that
$B' = B \times_A A'$ and $N' = N \times_{\varphi, M} M'$ and extend
these equalities to 
$$
\vcenter{
\xymatrix{
A & A' \ar[l] & I \ar[l] \\
B \ar[u] & B' \ar[l] \ar[u] & J \ar[l] \ar[u]
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
M & M' \ar[l] & K \ar[l] \\
N \ar[u]_\varphi & N' \ar[l] \ar[u] & L \ar[l] \ar[u]
}
}
$$
where $I, J, K, L$ are the kernels of the horizontal maps of the original
diagrams. We present the proof as a sequence of observations:
\begin{enumerate}
\item $K = IM'$ (see statement lemma),
\item $B' \to B$ is surjective with kernel $J$ and $J \to I$ is bijective,
\item $N' \to N$ is surjective with kernel $L$ and $L \to K$ is bijective,
\item $JN' \subset L$,
\item $\text{Im}(N \to M)$ generates $M$ as an $A$-module
(because $N \otimes_B A = M$),
\item $\text{Im}(N' \to M')$ generates $M'$ as an $A'$-module
(because it holds modulo $K$ and $L$ maps isomorphically to $K$),
\item $JN' = L$ (because $L \cong K = I M'$
is generated by images of elements $x n'$ with $x \in I$ and
$n' \in N'$ by the previous statement),
\item $N' \otimes_{B'} B = N$ (because $N = N'/L$, $B = B'/J$, and
the previous statement),
\item there is a map $\gamma : N' \otimes_{B'} A' \to M'$,
\item $\gamma$ is surjective (see above),
\item the kernel of the composition $N' \otimes_{B'} A' \to M' \to M$ 
is generated by elements $l \otimes 1$ and $n' \otimes x$ with
$l \in K$, $n' \in N'$, $x \in I$ (because $M = N \otimes_B A$ by assumption
and because $N' \to N$ and $A' \to A$ are surjective with kernels
$L$ and $I$),
\item any element of $N' \otimes_{B'} A'$ in the submodule generated
by the elements $l \otimes 1$ and $n' \otimes x$ with
$l \in L$, $n' \in N'$, $x \in I$ can be written as $l \otimes 1$
for some $l \in L$ (because $J$ maps isomorphically to $I$ we see
that $n' \otimes x = n'x \otimes 1$ in $N' \otimes_{B'} A'$;
similarly $x n' \otimes a' = n' \otimes xa' = n'(xa') \otimes 1$
in $N' \otimes_{B'} A'$ when $n' \in N'$, $x \in J$ and $a' \in A'$;
since we have seen that $JN' = L$ this proves the assertion),
\item the kernel of $\gamma$ is zero (because by (10) and (11) any element of
the kernel is of the form $l \otimes 1$ with $l \in L$ which
is mapped to $l \in K \subset M'$ by $\gamma$).
\end{enumerate}
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-module-over-fibre-product-bis}
In the situation of Lemma \ref{lemma-module-over-fibre-product}
for a $B'$-module $L'$ the adjunction map
$$
L' \longrightarrow 
(L' \otimes_{B'} B) \times_{(L' \otimes_{B'} A)} (L' \otimes_{B'} A')
$$
is surjective but in general not injective.
\end{lemma}

\begin{proof}
As in the proof of Lemma \ref{lemma-module-over-fibre-product}
let $J \subset B'$ be the kernel of the map $B' \to B$.
Then $L' \otimes_{B'} B = L'/JL'$. Hence to prove surjectivity it suffices
to show that elements of the form $(0, z)$ of the fibre product are in the
image of the map of the lemma. The kernel of the map
$L' \otimes_{B'} A' \to L' \otimes_{B'} A$ is the image of
$L' \otimes_{B'} I \to L' \otimes_{B'} A'$. Since the map $J \to I$
induced by $B' \to A'$ is an isomorphism
the composition
$$
L' \otimes_{B'} J \to L' \to
(L' \otimes_{B'} B) \times_{(L' \otimes_{B'} A)} (L' \otimes_{B'} A')
$$
induces a surjection of $L' \otimes_{B'} J$ onto the set of elements
of the form $(0, z)$. To see the map is not injective in general we
present a simple example. Namely, take a field $k$,
set $B' = k[x, y]/(xy)$, $A = B'/(x)$, $B = B'/(y)$, $A = B'/(x, y)$
and $L' = B'/(x - y)$. In that case the class of $x$ in $L'$ is nonzero
but is mapped to zero under the displayed arrow.
\end{proof}

\begin{lemma}
\label{lemma-surjection-module-over-fibre-product}
In Situation \ref{situation-module-over-fibre-product}
let $(N_1, M'_1, \varphi_1) \to (N_2, M'_2, \varphi_2)$ be a morphism
of $\text{Mod}_B \times_{\text{Mod}_A} \text{Mod}_{A'}$
with $N_1 \to N_2$ and $M'_1 \to M'_2$ surjective. Then
$$
N_1 \times_{M_1} M'_1 \to N_2 \times_{M_2} M'_2
$$
is surjective.
\end{lemma}

\begin{proof}
Pick $(x_2, y_2) \in N_2 \times_{M_2} M'_2$. Choose $x_1 \in N_1$
mapping to $x_2$. Since $M'_1 \to M_1$ is surjective we can find
$y_1 \in M'_1$ mapping to $\varphi_1(x_1)$. Then $(x_1, y_1)$
maps to $(x_2, y'_2)$ in $N_2 \times_{M_2} M'_2$. Thus it suffices
to show that elements of the form $(0, y_2)$ are in the image of the map.
Here we see that $y_2 \in IM'_2$. Write $y_2 = \sum t_i y_{2, i}$
with $t_i \in I$. Choose $y_{1, i} \in M'_1$ mapping to $y_{2, i}$.
Then $y_1 = \sum t_iy_{1, i} \in IM'_1$ and the element $(0, y_1)$
does the job.
\end{proof}

\begin{situation}
\label{situation-relative-module-over-fibre-product}
Let $A, A', B, B', I$ be as in
Situation \ref{situation-module-over-fibre-product}.
Let $B' \to D'$ be a ring map. Set $D = D' \otimes_{B'} B$,
$C' = D' \otimes_{B'} A'$, and $C = D' \otimes_{B'} A$. This leads
to a big commutative diagram
$$
\xymatrix{
C & & & C' \ar[lll] \\
& A \ar[ul] & A' \ar[l] \ar[ru] \\
& B \ar[u] \ar[ld] & B' \ar[l] \ar[u] \ar[rd] \\
D \ar[uuu] & & & D' \ar[lll] \ar[uuu]
}
$$
of rings.
Observe that we do {\bf not} assume that the map $D' \to D \times_C C'$
is an isomorphism. In this situation we have the functor
\begin{equation}
\label{equation-relative-functor}
\text{Mod}_{D'} \longrightarrow
\text{Mod}_D \times_{\text{Mod}_C} \text{Mod}_{C'},\quad
L' \longmapsto (L' \otimes_{D'} D, L' \otimes_{D'} C', can)
\end{equation}
analoguous to (\ref{equation-functor}). Note that
$L' \otimes_{D'} D = L \otimes_{D'} (D' \otimes_{B'} B) = L \otimes_{B'} B$
and similarly
$L' \otimes_{D'} C' = L \otimes_{D'} (D' \otimes_{B'} A') = L \otimes_{B'} A'$
hence the diagram
$$
\xymatrix{
\text{Mod}_{D'} \ar[r] \ar[d] &
\text{Mod}_D \times_{\text{Mod}_C} \text{Mod}_{C'} \ar[d] \\
\text{Mod}_{B'} \ar[r] &
\text{Mod}_B \times_{\text{Mod}_A} \text{Mod}_{A'}
}
$$
is commutative. In the following we will write $(N, M', \varphi)$ for an
object of $\text{Mod}_D \times_{\text{Mod}_C} \text{Mod}_{C'}$,
i.e., $N$ is a $D$-module, $M'$ is an $C'$-module
and $\varphi : N \otimes_B A \to M' \otimes_{A'} A$ is an isomorphism
of $C$-modules.
However, it is often more convenient think of $\varphi$ as a $D$-linear
map $\varphi : N \to M'/IM'$ which induces an isomorphism
$N \otimes_B A \to M' \otimes_{A'} A = M'/IM'$.
\end{situation}

\begin{lemma}
\label{lemma-relative-module-over-fibre-product}
In Situation \ref{situation-relative-module-over-fibre-product}
the functor (\ref{equation-relative-functor}) has a right adjoint, namely
the functor
$$
F : (N, M', \varphi) \longmapsto N \times_{\varphi, M} M'
$$
where $M = M'/IM'$. Moreover, the composition of $F$ with
(\ref{equation-relative-functor}) is the identity functor on
$\text{Mod}_D \times_{\text{Mod}_C} \text{Mod}_{C'}$. In other words,
setting $N' = N \times_{\varphi, M} M'$ we have
$N' \otimes_{D'} D = N$ and $N' \otimes_{D'} C' = M'$.
\end{lemma}

\begin{proof}
The adjointness statement is that for a $D'$-module $L'$ and
a triple $(N, M', \varphi)$ we have
$$
\Hom_{D'}(L', N \times_{\varphi, M} M') =
\Hom_D(L' \otimes_{D'} D, N)
\times_{\Hom_C(L' \otimes_{D'} C, M)}
\Hom_{C'}(L' \otimes_{D'} C', M')
$$
This follows from
Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}
and the fact that an element of the left hand side is given by a pair
of $D'$-linear maps $L' \to N$ and $L' \to M'$ agreeing as maps to $M$.
The final assertion follows from the corresponding assertion of
Lemma \ref{lemma-module-over-fibre-product}.
\end{proof}

\begin{lemma}
\label{lemma-relative-surjection-ideals}
In Situation \ref{situation-relative-module-over-fibre-product}
the map $JD' \to IC'$ is surjective where $J = \text{Ker}(B' \to B)$.
\end{lemma}

\begin{proof}
Since $C' = D' \otimes_{B'} A'$ we have that $IC'$ is the image
of $D' \otimes_{B'} I = C' \otimes_{A'} I \to C'$. As the ring
map $B' \to A'$ induces an isomorphism $J \to I$ the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-relative-finite-module-over-fibre-product}
Let $A, A', B, B', C, C', D, D', I, M', M, N, \varphi$ be as in
Lemma \ref{lemma-relative-module-over-fibre-product}.
If $N$ finite over $D$ and $M'$
finite over $C'$, then $N' = N \times_M M'$ is finite over $D'$.
\end{lemma}

\begin{proof}
We will use the results of
Lemma \ref{lemma-relative-module-over-fibre-product}
without further mention. Choose generators $x_1, \ldots, x_r$ of $N$ over $B$
and generators $y_1, \ldots, y_s$ of $M'$ over $A'$. Using that
$N = N' \otimes_{D'} D$ and $D' \to D$ is surjective we can find
$u_1, \ldots, u_r \in N'$ mapping to $x_1, \ldots, x_r$ in $N$.
Using that $M' = N' \otimes_{D'} C'$ we can find $v_1, \ldots, v_t \in N'$
such that $y_i = \sum v_j \otimes c'_{ij}$ for some $c'_{ij} \in C'$.
In particular we see that the images $\overline{v}_j$ of the $v_j$ generate
$M'$ over $C'$. We claim that $u_1, \ldots, u_r, v_1, \ldots, v_t$
generate $N'$ as a $D'$-module. Namely, pick $\xi \in N'$. We first choose
$d'_1, \ldots, d'_r \in D'$ such that $\xi$ and $\sum d'_i u_i$ map
to the same element of $N$. This is possible because $D' \to D$
is surjective and $x_1, \ldots, x_r$ generate $N$.
The difference $\xi - \sum d'_i u_i$ is of the form $(0, \theta)$
for some $\theta$ in $IM'$. Say $\theta$ is $\sum t_j\overline{v}_j$
with $t_j \in IC'$. By Lemma \ref{lemma-relative-surjection-ideals}
we can choose $s_j \in JD'$ mapping to $t_j$.
Because $N' = N \times_M M'$ it follows
that $\xi = \sum b'_i u_i + \sum s_j v_j$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-relative-flat-module-over-fibre-product}
With $A, A', B, B', C, C', D, D', I$ as in
Situation \ref{situation-relative-module-over-fibre-product}.
\begin{enumerate}
\item Let $(N, M', \varphi)$ be an object of
$\text{Mod}_D \times_{\text{Mod}_C} \text{Mod}_{C'}$.
If $M'$ is flat over $A'$ and $N$ is flat over $B$, then
$N' = N \times_M M'$ is flat over $B'$.
\item If $L'$ is a $D'$-module flat over $B'$, then
$L' = (L \otimes_{D'} D) \times_{(L \otimes_{D'} C)} (L \otimes_{D'} C')$.
\item The category of $D'$-modules flat over $B'$
is equivalent to the categories of objects $(N, M', \varphi)$
of $\text{Mod}_D \times_{\text{Mod}_C} \text{Mod}_{C'}$
with $N$ flat over $B$ and $M'$ flat over $A'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $J \subset B'$ be an ideal.
We have to show that $J \otimes_{B'} N' \to N'$
is injective, see Algebra, Lemma \ref{algebra-lemma-flat}. We know that
$$
J/(J \cap I) \otimes_{B'} N' = J/(J \cap I) \otimes_B N \to N
$$
is injective as $N$ is flat over $B$. As
$J \cap I \to J \to J/(J \cap I) \to 0$ is exact, we
conclude that it suffices to show that $(J \cap I) \otimes_{B'} N' \to N'$
is injective. Thus we may assume that $J \subset I$; in particular we can
think of $J$ as an $A'$-module and an ideal of $A'$ and
$$
J \otimes_{B'} N' = J \otimes_{A'} A' \otimes_{B'} N' =
J \otimes_{A'} M'
$$
which maps injectively into $M'$ by our assumption that $M'$ is flat
over $A'$. We conclude that $J \otimes_{B'} N' \to N' \to M'$ is injective
and hence the first map is injective as desired.

\medskip\noindent
Proof of (2). This follows by tensoring the short exact sequence
$0 \to B' \to B \oplus A' \to A \to 0$ with $L'$ over $B'$
and using that $L' \otimes_{D'} D = L' \otimes_{B'} B$,
$L' \otimes_{D'} C' = L' \otimes_{B'} A'$, and
$L' \otimes_{D'} C = L' \otimes_{B'} A$, see discussion in
Situation \ref{situation-relative-module-over-fibre-product}.

\medskip\noindent
Proof of (3). Immediate consequence of (1) and (2).
\end{proof}

\begin{lemma}
\label{lemma-relative-finitely-presented-module-over-fibre-product}
Let $A, A', B, B', C, C', D, D', I, M', M, N, \varphi$ be as in
Lemma \ref{lemma-relative-module-over-fibre-product}. If
\begin{enumerate}
\item $N$ is finitely presented over $D$ and flat over $B$,
\item $M'$ finitely presented over $C'$ and flat over $A'$, and
\item the ring map $B' \to D'$ factors as $B' \to D'' \to D''$
with $B' \to D''$ flat and $D'' \to D'$ of finite presentation,
\end{enumerate}
then $N' = N \times_M M'$ is finitely presented over $D'$.
\end{lemma}

\begin{proof}
Choose a surjection $D''' = D''[x_1, \ldots, x_n] \to D'$.
By Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}
it suffices to show that $N'$ is finitely presented as a
$D'''$-module. Thus we may replace $D'$ by $D'''$. Since $D'''$ is
flat over $B'$, it follows that we may assume that $B' \to D'$ is flat.

\medskip\noindent
Assume $B' \to D'$ is flat.
By Lemma \ref{lemma-relative-finite-module-over-fibre-product}
the module $N'$ is finite over $D'$. Choose a surjection
$(D')^{\oplus n} \to N'$ with kernel $K'$. By base change we obtain maps
$D^{\oplus n} \to N$, $(C')^{\oplus n} \to M'$, and $C^{\oplus n} \to M$
with kernels $K_D$, $K_{C'}$, and $K_C$. There is a canonical map
$$
K' \longrightarrow K_D \times_{K_C} K_{C'}
$$
On the other hand, since $N' = N \times_M M'$ and
$D' = D \times_C C'$ (by
Lemma \ref{lemma-relative-flat-module-over-fibre-product})
there is also a
canonical map $K_D \times_{K_C} K_{C'} \to K'$ inverse to the displayed
arrow. Hence the displayed map is an isomorphism. By
Algebra, Lemma \ref{algebra-lemma-finite-presentation-module-independent}
the modules $K_D$ and $K_{C'}$ are finite. We conclude from
Lemma \ref{lemma-relative-finite-module-over-fibre-product}
that $K'$ is a finite $D'$-module provided that $K_D \to K_C$ and
$K_{C'} \to K_C$ induce isomorphisms
$K_D \otimes_B A = K_C = K_{C'} \otimes_{A'} A$.
This is true because the flatness assumptions implies the sequences
$$
0 \to K_D \to D^{\oplus n} \to N \to 0
\quad\text{and}\quad
0 \to K_{C'} \to (C')^{\oplus n} \to M' \to 0
$$
stay exact upon tensoring, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
\end{proof}

\begin{lemma}
\label{lemma-properties-algebras-over-fibre-product}
Let $A, A', B, B', I$ be as in
Lemma \ref{lemma-module-over-fibre-product}.
Let $(D, C', \varphi)$ be a system consisting of an $B$-algebra $D$,
a $A'$-algebra $C'$ and an isomorphism $D \otimes_B A \to C'/IC = C$.
Set $D' = D \times_C C'$ (as in
Lemma \ref{lemma-module-over-fibre-product}). Then
\begin{enumerate}
\item $B' \to D'$ is finite type if and only if $B \to D$ and
$A' \to C'$ are finite type,
\item $B' \to D'$ is flat if and only if $B \to D$ and $A' \to C'$ are flat,
\item $B' \to D'$ is flat and of finite presentation if and only if
$B \to D$ and $A' \to C'$ are flat and of finite presentation,
\item $B' \to D'$ is smooth if and only if $B \to D$ and $A' \to C'$ are smooth,
\item $B' \to D'$ is \'etale if and only if $B \to D$ and $A' \to C'$
are \'etale.
\end{enumerate}
Moreover, if $D'$ is a flat $B'$-algebra, then
$D' \to (D' \otimes_{B'} B) \times_{(D' \otimes_{B'} A)} (D' \otimes_{B'} A')$
is an isomorphism. In this way the category of flat $B'$-algebras
is equivalent to the categories of systems $(D, C', \varphi)$ as above
with $D$ flat over $B$ and $C'$ flat over $A'$.
\end{lemma}

\begin{proof}
The implication ``$\Rightarrow$'' follows from
Algebra, Lemmas \ref{algebra-lemma-base-change-finiteness},
\ref{algebra-lemma-flat-base-change},
\ref{algebra-lemma-base-change-smooth}, and
\ref{algebra-lemma-etale} because we have
$D' \otimes_{B'} B = D$ and $D' \otimes_{B'} A' = C'$
by Lemma \ref{lemma-module-over-fibre-product}.
Thus it suffices to prove the implications in the other direction.

\medskip\noindent
Ad (1). Assume $D$ of finite type over $B$ and $C'$ of finite type over $A'$.
We will use the results of
Lemma \ref{lemma-module-over-fibre-product}
without further mention. Choose generators $x_1, \ldots, x_r$ of $D$ over $B$
and generators $y_1, \ldots, y_s$ of $C'$ over $A'$. Using that
$N = N' \otimes_{B'} B$ and $B' \to B$ is surjective we can find
$u_1, \ldots, u_r \in D'$ mapping to $x_1, \ldots, x_r$ in $D$.
Using that $C' = D' \otimes_{B'} A'$ we can find $v_1, \ldots, v_t \in D'$
such that $y_i = \sum v_j \otimes a'_{ij}$ for some $a'_{ij} \in A'$.
In particular, the images of $v_j$ in $C'$ generate $C'$ as an
$A'$-algebra. Set $N = r + t$ and consider the cube of rings
$$
\xymatrix{
A[x_1, \ldots, x_N] & & A'[x_1, \ldots, x_N] \ar[ll] \\
& A \ar[lu] & & A' \ar[ll] \ar[lu] \\
B[x_1, \ldots, x_N] \ar[uu] & & B'[x_1, \ldots, x_N] \ar[uu] \ar[ll] \\
& B \ar[uu] \ar[lu] & & B' \ar[ll] \ar[uu] \ar[lu]
}
$$
Observe that the back square is cartesian as well.
Consider the ring map
$$
B'[x_1, \ldots, x_N] \to D',\quad
x_i \mapsto u_i \quad\text{and}\quad x_{r + j} \mapsto v_j.
$$
Then we see that the induced maps $B[x_1, \ldots, x_N] \to D$ and
$A'[x_1, \ldots, x_N] \to C'$
are surjective, in particular finite. We conclude from
Lemma \ref{lemma-relative-finite-module-over-fibre-product}
that $B'[x_1, \ldots, x_N] \to D'$ is finite, which implies that $D'$
is of finite type over $B'$ for example by
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.

\medskip\noindent
Ad (2). The implication ``$\Leftarrow$'' follows from
Lemma \ref{lemma-relative-flat-module-over-fibre-product}.
Moreover, the final statement follows from the final
statement of Lemma \ref{lemma-relative-flat-module-over-fibre-product}.

\medskip\noindent
Ad (3). Assume $B \to D$ and $A' \to C'$ are flat and of finite presentation.
The flatness of $B' \to D'$ we've seen in (2). We know $B' \to D'$
is of finite type by (1). Choose a surjection $B'[x_1, \ldots, x_N] \to D'$.
By Algebra, Lemma \ref{algebra-lemma-finite-presentation-independent}
the ring $D$ is of finite presentation as a $B[x_1, \ldots, x_N]$-module
and the ring $C'$ is of finite presentation as a
$A'[x_1, \ldots, x_N]$-module. By
Lemma \ref{lemma-relative-finitely-presented-module-over-fibre-product}
we see that $D'$ is of finite presentation as a $B'[x_1, \ldots, x_N]$-module,
i.e., $B' \to D'$ is of finite presentation.

\medskip\noindent
Ad (4). Assume $B \to D$ and $A' \to C'$ smooth.
By (3) we see that $B' \to D'$ is flat and of finite presentation.
By Algebra, Lemma \ref{algebra-lemma-flat-fibre-smooth}
it suffices to check that $D' \otimes_{B'} k$ is smooth for any
field $k$ over $B'$. If the composition $J \to B' \to k$ is zero,
then $B' \to k$ factors as $B' \to B \to k$ and we see that
$$
D' \otimes_{B'} k = D' \otimes_{B'} B \otimes_B k
= D \otimes_B k
$$
is smooth as $B \to D$ is smooth. If the composition $J \to B' \to k$
is nonzero, then there exists an $h \in J$ which does not map to zero
in $k$. Then $B' \to k$ factors as $B' \to B'_h \to k$.
Observe that $h$ maps to zero in $B$, hence $B_h = 0$.
Thus by Lemma \ref{lemma-diagram-localize} we have $B'_h = A'_h$ and we get
$$
D' \otimes_{B'} k = D' \otimes_{B'} B'_h \otimes_{B'_h} k
= C'_h \otimes_{A'_h} k
$$
is smooth as $A' \to C'$ is smooth.

\medskip\noindent
Ad (5). Assume $B \to D$ and $A' \to C'$ are \'etale. By (4) we see that
$B' \to D'$ is smooth. As we can read off whether or not a smooth
map is \'etale from the dimension of fibres we see that (5) holds
(argue as in the proof of (4) to indentify fibres -- some details omitted).
\end{proof}

\begin{remark}
\label{remark-relative-modules-over-fibre-product}
In Situation \ref{situation-relative-module-over-fibre-product}.
Assume $B' \to D'$ is of finite presentation and
suppose we are given a finite $D'$-module $L'$.
We claim there is a bijective correspondence between
\begin{enumerate}
\item surjections of $D'$-modules $L' \to Q'$ with $Q'$ of finite presentation
over $D'$ and flat over $B'$, and
\item pairs of surjections of modules
$(L' \otimes_{D'} D \to Q_1, L' \otimes_{D'} C' \to Q_2)$
with
\begin{enumerate}
\item $Q_1$ of finite presentation over $D$ and flat over $B$,
\item $Q_2$ of finite presentation over $C'$ and flat over $A'$,
\item $Q_1 \otimes_D C = Q_2 \otimes_{C'} C$ as quotients of
$L' \otimes_{D'} C$.
\end{enumerate}
\end{enumerate}
The correspondence between these is given by $Q \mapsto (Q_1, Q_2)$ with
$Q_1 = Q \otimes_{D'} D$ and $Q_2 = Q \otimes_{D'} C'$. And for the converse
we use $Q = Q_1 \times_{Q_{12}} Q_2$ where $Q_{12}$ the common quotient
$Q_1 \otimes_D C = Q_2 \otimes_{C'} C$ of $L' \otimes_{D'} C$. As quotient
map we use
$$
L' \longrightarrow
(L' \otimes_{D'} D) \times_{(L' \otimes_{D'} C)} (L' \otimes_{D'} C')
\longrightarrow Q_1 \times_{Q_{12}} Q_2 = Q
$$
where the first arrow is surjective by
Lemma \ref{lemma-module-over-fibre-product-bis}
and the second by Lemma \ref{lemma-surjection-module-over-fibre-product}.
The claim follows by
Lemmas \ref{lemma-relative-flat-module-over-fibre-product} and
\ref{lemma-relative-finitely-presented-module-over-fibre-product}.
\end{remark}








\section{Fitting ideals}
\label{section-fitting-ideals}

\noindent
The fitting ideals of a finite module are the ideals determined
by the construction of Lemma \ref{lemma-fitting-ideal}.

\begin{lemma}
\label{lemma-ideals-generated-by-minors}
Let $R$ be a ring. Let $A$ be an $n \times m$ matrix with coefficients
in $R$. Let $I_r(A)$ be the ideal generated by the $r \times r$-minors
of $A$ with the convention that $I_0(A) = R$ and $I_r(A) = 0$ if
$r > \min(n, m)$. Then
\begin{enumerate}
\item $I_0(A) \supset I_1(A) \supset I_2(A) \ldots$,
\item if $B$ is an $(n + n') \times m$ matrix, and $A$ is the first
$n$ rows of $B$, then $I_{r + n'}(B) \subset I_r(A)$,
\item if $C$ is an $n \times n$ matrix then $I_r(CA) \subset I_r(A)$.
\item If $A$ is a block matrix
$$
\left(
\begin{matrix}
A_1 & 0 \\
0 & A_2 
\end{matrix}
\right)
$$
then $I_r(A) = \sum_{r_1 + r_2 = r} I_{r_1}(A_1) I_{r_2}(A_2)$.
\item Add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. (Hint: Use that a determinant can be computed by expanding
along a column or a row.)
\end{proof}

\begin{lemma}
\label{lemma-fitting-ideal}
Let $R$ be a ring. Let $M$ be a finite $R$-module. Choose a presentation
$$
\bigoplus\nolimits_{j \in J} R \longrightarrow R^{\oplus n}
\longrightarrow M \longrightarrow 0.
$$
of $M$. Let $A = (a_{ij})_{i = 1, \ldots, n, j \in J}$ be the matrix
of the map $\bigoplus_{j \in J} R \to R^{\oplus n}$.
The ideal $\text{Fit}_k(M)$ generated by the
$(n - k) \times (n - k)$ minors of
$A$ is independent of the choice of the presentation.
\end{lemma}

\begin{proof}
Let $K \subset R^{\oplus n}$ be the kernel of the surjection
$R^{\oplus n} \to M$. Pick $z_1, \ldots, z_{n - k} \in K$
and write $z_j = (z_{1j}, \ldots, z_{nj})$.
Another description of the ideal $\text{Fit}_k(M)$
is that it is the ideal generated by the $(n - k) \times (n - k)$ minors of
all the matrices $(z_{ij})$ we obtain in this way.

\medskip\noindent
Suppose we change the surjection into the surjection
$R^{\oplus n + n'} \to M$ with kernel $K'$ where we use the original
map on the first $n$ standard basis elements of $R^{\oplus n + n'}$
and $0$ on the last $n'$ basis vectors. Then the corresponding ideals
are the same. Namely, if $z_1, \ldots, z_{n - k} \in K$ as above,
let $z'_j = (z_{1j}, \ldots, z_{nj}, 0, \ldots, 0) \in K'$ for
$j = 1, \ldots, n - k$ and
$z'_{n + j'} = (0, \ldots, 0, 1, 0, \ldots, 0) \in K'$. Then we see that
the ideal of $(n - k) \times (n - k)$ minors of $(z_{ij})$ agrees
with the ideal of $(n + n' - k) \times (n + n' - k)$ minors of
$(z'_{ij})$. This gives one of the inclusions.
Conversely, given  $z'_1, \ldots, z'_{n + n' - k}$
in $K'$ we can project these to $R^{\oplus n}$ to get
$z_1, \ldots, z_{n + n' - k}$ in $K$. By
Lemma \ref{lemma-ideals-generated-by-minors}
we see that the ideal generated by the
$(n + n' - k) \times (n + n' - k)$ minors of
$(z'_{ij})$ is contained in the ideal generated by the
$(n - k) \times (n - k)$ minors of $(z_{ij})$. This gives the
other inclusion.

\medskip\noindent
Let $R^{\oplus m} \to M$ be another surjection with kernel $L$.
By the previous paragraph we may assume $m = n$.
By Algebra, Lemma \ref{algebra-lemma-lift-map} we can choose a map
$R^{\oplus n} \to R^{\oplus m}$ commuting with the surjections to $M$.
Let $C = (c_{li})$ be the matrix of this map (it is a square
matrix as $n = m$). Then given
$z_1, \ldots, z_{n - k} \in K$ as above we get
$Cz_1, \ldots, Cz_{n - k} \in L$. By
Lemma \ref{lemma-ideals-generated-by-minors} we get one of the
inclusions. By symmetry we get the other.
\end{proof}

\begin{definition}
\label{definition-fitting-ideal}
Let $R$ be a ring. Let $M$ be a finite $R$-module. Let $k \geq 0$.
The {\it $k$th fitting ideal} of $M$ is the ideal $\text{Fit}_k(M)$
constructed in Lemma \ref{lemma-ideals-generated-by-minors}.
\end{definition}

\noindent
Since the fitting ideals are the ideals of minors of a big matrix
(numbered in reverse ordering from the ordering in
Lemma \ref{lemma-ideals-generated-by-minors})
we see that
$$
\text{Fit}_0(M) \subset \text{Fit}_1(M) \subset \ldots
\subset \text{Fit}_t(M) = R
$$
for some $t \gg 0$. Here are some basic properties of fitting ideals.

\begin{lemma}
\label{lemma-fitting-ideal-basics}
Let $R$ be a ring. Let $M$ be a finite $R$-module.
\begin{enumerate}
\item If $M$ can be generated by $n$ elemements, then
$\text{Fit}_n(M) = R$.
\item Given a second finite $R$-module $M'$ we have
$$
\text{Fit}_k(M \oplus M') =
\sum\nolimits_{k + k' = l} \text{Fit}_k(M)\text{Fit}_{k'}(M')
$$
\item If $R \to R'$ is a ring map, then $\text{Fit}_k(M \otimes_R R')$
is the ideal of $R'$ generated by the image of $\text{Fit}_k(M)$.
\item If $M$ is an $R$-module of finite presentation, then $\text{Fit}_k(M)$
is a finitely generated ideal.
\item If $M \to M'$ is a surjection, then
$\text{Fit}_k(M) \subset \text{Fit}_k(M')$.
\item Add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from the fact that $I_0(A) = R$ in
Lemma \ref{lemma-ideals-generated-by-minors}.
part (2) follows form the corresponding statement in
Lemma \ref{lemma-ideals-generated-by-minors}.
Part (3) follows from the fact that $\otimes_R R'$ is right exact,
so the base change of a presentation of $M$ is a presentation of
$M \otimes_R R'$.
Proof of (4). Let $R^{\oplus m} \xrightarrow{A} R^{\oplus n} \to M \to 0$
be a presentation. Then $\text{Fit}_k(M)$ is the ideal generated by the
$n - k \times n - k$ minors of the matrix $A$.
Part (5) is immediate from the definition.
\end{proof}

\begin{example}
\label{example-fitting-free}
Let $R$ be a ring.
The fitting ideals of the finite free module $M = R^{\oplus n}$ are
are $\text{Fit}_k(M) = 0$ for $k < n$ and $\text{Fit}_k(M) = R$
for $k \geq n$.
\end{example}

\begin{lemma}
\label{lemma-fitting-ideal-generate-locally}
Let $R$ be a ring. Let $M$ be a finite $R$-module. Let $k \geq 0$.
Let $\mathfrak p$ be a prime ideal with
$\text{Fit}_k(M) \not \subset \mathfrak p$. Then there exists
an $f \in R$, $f \not \in \mathfrak p$ such that $M_f$ can be
generated by $k$ elements over $R_f$.
\end{lemma}

\begin{proof}
By Nakayama's lemma (Algebra, Lemma \ref{algebra-lemma-NAK}) we see that
$M_f$ can be generated by $k$ elements over $R_f$ for some
$f \in R$, $f \not \in \mathfrak p$ if $M \otimes_R \kappa(\mathfrak p)$
can be generated by $k$ elements. This reduces the problem to the
case where $R$ is a field and $\mathfrak p = (0)$. In this case
the result follows from Example \ref{example-fitting-free}.
\end{proof}

\begin{lemma}
\label{lemma-fitting-ideal-finite-locally-free}
Let $R$ be a ring. Let $M$ be a finite $R$-module. Let $r \geq 0$.
The following are equivalent
\begin{enumerate}
\item $M$ is finite locally free of rank $k$
(Algebra, Definition \ref{algebra-definition-locally-free}),
\item $\text{Fit}_{r - 1}(M) = 0$ and $\text{Fit}_r(M) = R$, and
\item $\text{Fit}_k(M) = 0$ for $k < r$ and $\text{Fit}_k(M) = R$
for $k \geq r$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is immediate that (2) is equivalent to (3) because the fitting ideals
form an increasing sequence of ideals.
Since the formation of $\text{Fit}_k(M)$ commutes with base change
(Lemma \ref{lemma-fitting-ideal-basics}) we see that (1) implies (2) by
Example \ref{example-fitting-free}
and glueing results (Algebra, Section \ref{algebra-section-more-glueing}).
Conversely, assume (2). By
Lemma \ref{lemma-fitting-ideal-generate-locally} we may assume that $M$
is generated by $r$ elements. Thus a presentation
$\bigoplus_{j \in J} R \to R^{\oplus r} \to M \to 0$.
But now the assumption that $\text{Fit}_{r - 1}(M) = 0$ implies
that all entries of the matrix of the map
$\bigoplus_{j \in J} R \to R^{\oplus r}$ are zero.
Thus $M$ is free.
\end{proof}










\section{Computing Tor}
\label{section-computing-tor}

\noindent
Let $R$ be a ring. We denote $D(R)$ the derived category of the
abelian category $\text{Mod}_R$ of $R$-modules. Note that $\text{Mod}_R$
has enough projectives as every free $R$-module is projective.
Thus we can define the left derived functors of any additive functor
from $\text{Mod}_R$ to any abelian category.

\medskip\noindent
This implies in particular to the functor
$ - \otimes_R M : \text{Mod}_R \to \text{Mod}_R$
whose right derived functors are the Tor functors $\text{Tor}_i^R(-, M)$, see
Algebra, Section \ref{algebra-section-tor}.
There is also a total right derived functor
\begin{equation}
\label{equation-derived-tensor-module}
-\otimes_R^{\mathbf{L}} M :
D^{-}(R)
\longrightarrow
D^{-}(R)
\end{equation}
which is denoted $-\otimes_R^{\mathbf{L}} M$. Its satellites are the
Tor modules, i.e., we have
$$
H^{-p}(N \otimes_R^{\mathbf{L}} M) = \text{Tor}_p^R(N, M).
$$

\medskip\noindent
A special situation occurs when we consider the tensor product with
an $R$-algebra $A$. In this case we think of $- \otimes_R A$
as a functor from $\text{Mod}_R$ to $\text{Mod}_A$. Hence the total
right derived functor
\begin{equation}
\label{equation-derived-tensor-algebra}
-\otimes_R^{\mathbf{L}} A :
D^{-}(R)
\longrightarrow
D^{-}(A)
\end{equation}
which is denoted $-\otimes_R^{\mathbf{L}} A$. Its satellites are the
tor groups, i.e., we have
$$
H^{-p}(N \otimes_R^{\mathbf{L}} A) = \text{Tor}_p^R(N, A).
$$
In particular these Tor groups naturally have the structure of $A$-modules.







\section{Derived tensor product}
\label{section-derived-tensor-product}

\noindent
We can construct the derived tensor product in greater generality.
In fact, it turns out that the boundedness assumptions are not
necessary, provided we choose K-flat resolutions.

\begin{lemma}
\label{lemma-derived-tor-homotopy}
Let $R$ be a ring.
Let $P^\bullet$ be a complex of $R$-modules.
Let $\alpha, \beta : L^\bullet \to M^\bullet$ be homotopy equivalent
maps of complexes. Then $\alpha$ and $\beta$ induce homotopy equivalent
maps
$$
\text{Tot}(\alpha \otimes \text{id}_P),
\text{Tot}(\beta \otimes \text{id}_P) :
\text{Tot}(L^\bullet \otimes_R P^\bullet)
\longrightarrow
\text{Tot}(M^\bullet \otimes_R P^\bullet).
$$
In particular the construction
$L^\bullet \mapsto \text{Tot}(L^\bullet \otimes_R P^\bullet)$
defines an endo-functor of the homotopy category of complexes.
\end{lemma}

\begin{proof}
Say $\alpha = \beta + dh + hd$ for some homotopy $h$ defined by
$h^n : L^n \to M^{n - 1}$. Set
$$
H^n = \bigoplus\nolimits_{a + b = n} h^a \otimes \text{id}_{P^b} :
\bigoplus\nolimits_{a + b = n} L^a \otimes_R P^b
\longrightarrow
\bigoplus\nolimits_{a + b = n} M^{a - 1} \otimes_R P^b
$$
Then a straightforward computation shows that
$$
\text{Tot}(\alpha \otimes \text{id}_P) =
\text{Tot}(\beta \otimes \text{id}_P) + dH + Hd
$$
as maps $\text{Tot}(L^\bullet \otimes_R P^\bullet) \to
\text{Tot}(M^\bullet \otimes_R P^\bullet)$.
\end{proof}

\begin{lemma}
\label{lemma-derived-tor-exact}
Let $R$ be a ring.
Let $P^\bullet$ be a complex of $R$-modules.
The functor
$$
K(\text{Mod}_R) \longrightarrow K(\text{Mod}_R), \quad
L^\bullet \longmapsto \text{Tot}(L^\bullet \otimes_R P^\bullet)
$$
is an exact functor of triangulated categories.
\end{lemma}

\begin{proof}
By our definition of the triangulated structure on
$K(\text{Mod}_R)$ we have to check that our functor maps
a termwise split short exact sequence of complexes to a termwise
split short exact sequence of complexes. As the terms of
$\text{Tot}(L^\bullet \otimes_R P^\bullet)$ are direct sums
of the tensor products $L^a \otimes_R P^b$ this is clear.
\end{proof}

\noindent
The following definition will allow us to think intelligently
about derived tensor products of unbounded complexes.

\begin{definition}
\label{definition-K-flat}
Let $R$ be a ring. A complex $K^\bullet$ is called {\it K-flat}
if for every acyclic complex $M^\bullet$ the total complex
$\text{Tot}(M^\bullet \otimes_R K^\bullet)$ is acyclic.
\end{definition}

\begin{lemma}
\label{lemma-K-flat-quasi-isomorphism}
Let $R$ be a ring. Let $K^\bullet$ be a K-flat complex.
Then the functor
$$
K(\text{Mod}_R) \longrightarrow K(\text{Mod}_R), \quad
L^\bullet \longmapsto \text{Tot}(L^\bullet \otimes_R K^\bullet)
$$
transforms quasi-isomorphisms into quasi-isomorphisms.
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-derived-tor-exact}
and the fact that quasi-isomorphisms in $K(\text{Mod}_R)$ and
$K(\text{Mod}_A)$ are characterized by having acyclic cones.
\end{proof}

\begin{lemma}
\label{lemma-base-change-K-flat}
Let $R \to R'$ be a ring map. If $K^\bullet$ is a K-flat complex
of $R$-modules, then $K^\bullet \otimes_R R'$ is a K-flat complex
of $R'$-modules.
\end{lemma}

\begin{proof}
Follows from the definitions and the fact that
$(K^\bullet \otimes_R R') \otimes_{R'} L^\bullet =
K^\bullet \otimes_R L^\bullet$ for any complex
$L^\bullet$ of $R'$-modules.
\end{proof}

\begin{lemma}
\label{lemma-tensor-product-K-flat}
Let $R$ be a ring. If $K^\bullet$, $L^\bullet$ are K-flat complexes
of $R$-modules, then $\text{Tot}(K^\bullet \otimes_R L^\bullet)$ is a
K-flat complex of $R$-modules.
\end{lemma}

\begin{proof}
Follows from the isomorphism
$$
\text{Tot}(M^\bullet \otimes_R \text{Tot}(K^\bullet \otimes_R L^\bullet))
=
\text{Tot}(\text{Tot}(M^\bullet \otimes_R K^\bullet) \otimes_R L^\bullet)
$$
and the definition.
\end{proof}

\begin{lemma}
\label{lemma-K-flat-two-out-of-three}
Let $R$ be a ring. Let $(K_1^\bullet, K_2^\bullet, K_3^\bullet)$ be
a distinguished triangle in $K(\text{Mod}_R)$. If two out of three
of $K_i^\bullet$ are K-flat, so is the third.
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-derived-tor-exact}
and the fact that in a distinguished triangle in
$K(\text{Mod}_A)$ if two out of three are acyclic, so is the third.
\end{proof}

\begin{lemma}
\label{lemma-derived-tor-quasi-isomorphism}
Let $R$ be a ring. Let $P^\bullet$ be a bounded above complex of
flat $R$-modules. Then $P^\bullet$ is K-flat.
\end{lemma}

\begin{proof}
Let $L^\bullet$ be an acyclic complex of $R$-modules.
Let $\xi \in H^n(\text{Tot}(L^\bullet \otimes_R P^\bullet))$.
We have to show that $\xi = 0$.
Since $\text{Tot}^n(L^\bullet \otimes_R P^\bullet)$ is a direct
sum with terms $L^a \otimes_R P^b$ we see that $\xi$ comes from
an element in $H^n(\text{Tot}(\tau_{\leq m}L^\bullet \otimes_R P^\bullet))$
for some $m \in \mathbf{Z}$. Since $\tau_{\leq m}L^\bullet$ is also
acyclic we may replace $L^\bullet$ by $\tau_{\leq m}L^\bullet$.
Hence we may assume that $L^\bullet$ is bounded above.
In this case the spectral sequence of
Homology, Lemma \ref{homology-lemma-first-quadrant-ss}
has
$$
{}'E_1^{p, q} = H^p(L^\bullet \otimes_R P^q)
$$
which is zero as $P^q$ is flat and $L^\bullet$ acyclic. Hence
$H^*(\text{Tot}(L^\bullet \otimes_R P^\bullet)) = 0$.
\end{proof}

\noindent
In the following lemma by a colimit of a system of complexes we mean
the termwise colimit.

\begin{lemma}
\label{lemma-colimit-K-flat}
Let $R$ be a ring.
Let $K_1^\bullet \to K_2^\bullet \to \ldots$
be a system of K-flat complexes.
Then $\colim_i K_i^\bullet$ is K-flat.
\end{lemma}

\begin{proof}
Because we are taking termwise colimits it is clear that
$$
\colim_i \text{Tot}(M^\bullet \otimes_R K_i^\bullet)
=
\text{Tot}(M^\bullet \otimes_R \colim_i K_i^\bullet)
$$
Hence the lemma follows from the fact that filtered colimits are
exact.
\end{proof}

\begin{lemma}
\label{lemma-K-flat-resolution}
Let $R$ be a ring. For any complex $M^\bullet$ there exists a
$K$-flat complex $K^\bullet$ and a quasi-isomorphism
$K^\bullet \to M^\bullet$. Moreover each $K^n$ is a flat $R$-module.
\end{lemma}

\begin{proof}
Let $\mathcal{P} \subset \Ob(\text{Mod}_R)$ be the
class of flat $R$-modules. By
Derived Categories, Lemma \ref{derived-lemma-special-direct-system}
there exists a system
$K_1^\bullet \to K_2^\bullet \to \ldots$
and a diagram
$$
\xymatrix{
K_1^\bullet \ar[d] \ar[r] &
K_2^\bullet \ar[d] \ar[r] & \ldots \\
\tau_{\leq 1}M^\bullet \ar[r] &
\tau_{\leq 2}M^\bullet \ar[r] & \ldots
}
$$
with the properties (1), (2), (3) listed in that lemma.
These properties imply each complex $K_i^\bullet$ is a bounded
above complex of flat modules. Hence $K_i^\bullet$ is K-flat by
Lemma \ref{lemma-derived-tor-quasi-isomorphism}.
The induced map $\colim_i K_i^\bullet \to M^\bullet$
is a quasi-isomorphism by construction. The complex
$\colim_i K_i^\bullet$ is K-flat by
Lemma \ref{lemma-colimit-K-flat}.
The final assertion of the lemma is true because the colimit of
a system of flat modules is flat, see
Algebra, Lemma \ref{algebra-lemma-colimit-flat}.
\end{proof}

\begin{lemma}
\label{lemma-derived-tor-quasi-isomorphism-other-side}
Let $R$ be a ring. Let
$\alpha : P^\bullet \to Q^\bullet$ be a quasi-isomorphism of
K-flat complexes of $R$-modules. For every complex $L^\bullet$
of $R$-modules the induced map
$$
\text{Tot}(\text{id}_L \otimes \alpha) :
\text{Tot}(L^\bullet \otimes_R P^\bullet)
\longrightarrow
\text{Tot}(L^\bullet \otimes_R Q^\bullet)
$$
is a quasi-isomorphism.
\end{lemma}

\begin{proof}
Choose a quasi-isomorphism $K^\bullet \to L^\bullet$ with
$K^\bullet$ a K-flat complex, see
Lemma \ref{lemma-K-flat-resolution}.
Consider the commutative diagram
$$
\xymatrix{
\text{Tot}(K^\bullet \otimes_R P^\bullet) \ar[r] \ar[d] &
\text{Tot}(K^\bullet \otimes_R Q^\bullet) \ar[d] \\
\text{Tot}(L^\bullet \otimes_R P^\bullet) \ar[r] &
\text{Tot}(L^\bullet \otimes_R Q^\bullet)
}
$$
The result follows as by
Lemma \ref{lemma-K-flat-quasi-isomorphism}
the vertical arrows and the top horizontal arrow are quasi-isomorphisms.
\end{proof}

\noindent
Let $R$ be a ring.
Let $M^\bullet$ be an object of $D(R)$.
Choose a K-flat resolution $K^\bullet \to M^\bullet$, see
Lemma \ref{lemma-K-flat-resolution}.
By
Lemmas \ref{lemma-derived-tor-homotopy} and \ref{lemma-derived-tor-exact}
we obtain an exact functor of triangulated categories
$$
K(\text{Mod}_R) \longrightarrow K(\text{Mod}_R), \quad
L^\bullet \longmapsto \text{Tot}(L^\bullet \otimes_R K^\bullet)
$$
By
Lemma \ref{lemma-K-flat-quasi-isomorphism}
this functor induces a functor $D(R) \to D(R)$ simply because
$D(R)$ is the localization of $K(\text{Mod}_R)$ at quasi-isomorphism.
By
Lemma \ref{lemma-derived-tor-quasi-isomorphism-other-side}
the resulting functor (up to isomorphism)
does not depend on the choice of the K-flat resolution.

\begin{definition}
\label{definition-derived-tor}
Let $R$ be a ring. Let $M^\bullet$ be an object of $D(R)$.
The {\it derived tensor product}
$$
- \otimes_R^{\mathbf{L}} M^\bullet : D(R) \longrightarrow D(R)
$$
is the exact functor of triangulated categories described above.
\end{definition}

\noindent
This functor extends the functor (\ref{equation-derived-tensor-module}).
It is clear from our explicit constructions that
there is a canonical isomorphism
$$
M^\bullet \otimes_R^{\mathbf{L}} L^\bullet
\cong
L^\bullet \otimes_R^{\mathbf{L}} M^\bullet
$$
whenever both $L^\bullet$ and $M^\bullet$ are in $D(R)$.
Hence when we write $M^\bullet \otimes_R^{\mathbf{L}} L^\bullet$
we will usually be agnostic about which variable we are using to
define the derived tensor product with.





\section{Derived change of rings}
\label{section-derived-base-change}

\noindent
Let $R \to A$ be a ring map. Let $N$ be an $A$-module. We can also use K-flat
resolutions to define a functor
$$
- \otimes_R^{\mathbf{L}} N : D(R) \to D(A)
$$
which is the left derived functor of the functor
$\text{Mod}_R \to \text{Mod}_A$, $M \mapsto M \otimes_R N$.
In particular, taking $N = A$ we obtain a derived base change functor
$$
- \otimes_R^{\mathbf{L}} A : D(R) \to D(A)
$$
extending the functor (\ref{equation-derived-tensor-algebra}).
Namely, for every complex of $R$-modules $M^\bullet$ we can
choose a K-flat resolution $K^\bullet \to M^\bullet$ and set
$M^\bullet \otimes_R^{\mathbf{L}} N = K^\bullet \otimes_R N$.
You can use
Lemmas \ref{lemma-K-flat-resolution} and
\ref{lemma-derived-tor-quasi-isomorphism-other-side}
to see that this is well defined. However, to cross all the t's and dot all
the i's it is perhaps more convenient to use some general theory.

\begin{lemma}
\label{lemma-derived-base-change}
The construction above is independent of choices and defines an exact
functor of triangulated categories $- \otimes_R^\mathbf{L} N : D(R) \to D(A)$.
There is a functorial isomorphism
$$
E \otimes_R^\mathbf{L} N = (E \otimes_R^\mathbf{L} A) \otimes_A^\mathbf{L} N
$$
for $E$ in $D(R)$.
\end{lemma}

\begin{proof}
To prove the existence of the derived functor $- \otimes_R^\mathbf{L} N$
we use the general theory developed in
Derived Categories, Section \ref{derived-section-derived-functors}.
Set $\mathcal{D} = K(\text{Mod}_R)$ and $\mathcal{D}' = D(A)$.
Let us write $F : \mathcal{D} \to \mathcal{D}'$ the exact functor
of triangulated categories defined by the rule
$F(M^\bullet) = M^\bullet \otimes_R N$. We let $S$ be the set of
quasi-isomorphisms in $\mathcal{D} = K(\text{Mod}_R)$.
This gives a situation as in
Derived Categories, Situation \ref{derived-situation-derived-functor}
so that
Derived Categories, Definition
\ref{derived-definition-right-derived-functor-defined}
applies. We claim that $LF$ is everywhere defined.
This follows from
Derived Categories, Lemma \ref{derived-lemma-find-existence-computes}
with $\mathcal{P} \subset \Ob(\mathcal{D})$ the collection
of $K$-flat complexes: (1) follows from
Lemma \ref{lemma-K-flat-resolution}
and (2) follows from
Lemma \ref{lemma-derived-tor-quasi-isomorphism-other-side}.
Thus we obtain a derived functor
$$
LF : D(R) = S^{-1}\mathcal{D} \longrightarrow \mathcal{D}' = D(A)
$$
see
Derived Categories, Equation (\ref{derived-equation-everywhere}).
Finally,
Derived Categories, Lemma \ref{derived-lemma-find-existence-computes}
guarantees that $LF(K^\bullet) = F(K^\bullet) = K^\bullet \otimes_R N$
when $K^\bullet$ is K-flat, i.e., $LF$ is indeed computed in the way
described above. Moreover, by Lemma \ref{lemma-base-change-K-flat}
the complex $K^\bullet \otimes_R A$ is a K-flat complex of $A$-modules.
Hence
$$
(K^\bullet \otimes_R^\mathbf{L} A) \otimes_A^\mathbf{L} N =
(K^\bullet \otimes_R A) \otimes_A N =
K^\bullet \otimes_A N =
K^\bullet \otimes_A^\mathbf{L} N
$$
which proves the final statement of the lemma.
\end{proof}

\begin{remark}[Warning]
\label{remark-warning-compute-base-change}
Let $R \to A$ be a ring map, and let $N$ and $N'$ be $A$-modules.
Denote $N_R$ and $N'_R$ the restriction of $N$ and $N'$ to $R$-modules,
see Algebra, Section \ref{algebra-section-base-change}.
In this situation, the objects $N_R \otimes_R^\mathbf{L} N'$
and $N \otimes_R^\mathbf{L} N'_R$ of $D(A)$ are in general
not isomorphic! In other words, one has to pay careful attention
as to which of the two sides is being used to provide the
$A$-module structure.

\medskip\noindent
For a specific example, set $R = k[x, y]$, $A = R/(xy)$, $N = R/(x)$
and $N' = A = R/(xy)$. The resolution
$0 \to R \xrightarrow{xy} R \to N'_R \to 0$
shows that $N \otimes_R^\mathbf{L} N'_R = N[1] \oplus N$ in $D(A)$.
The resolution
$0 \to R \xrightarrow{x} R \to N_R \to 0$
shows that $N_R \otimes_R^\mathbf{L} N'$ is represented by
the complex $A \xrightarrow{x} A$. To see these two complexes
are not isomorphic, one can show that the second complex is
not isomorphic in $D(A)$ to the direct sum of its cohomology groups,
or one can show that the first complex is not a perfect object of $D(A)$
whereas the second one is. Some details omitted.
\end{remark}

\begin{lemma}
\label{lemma-double-base-change}
Let $A \to B \to C$ be ring maps. Let $M$ be an $A$-module,
$N$ a $B$-module, and $K$ a $C$-module. Then
$$
(M \otimes_A^\mathbf{L} N) \otimes_B^\mathbf{L} K =
(M \otimes_A^\mathbf{L} K) \otimes_C^\mathbf{L} (N \otimes_B^\mathbf{L} C) =
(M \otimes_A^\mathbf{L} C) \otimes_C^\mathbf{L} (N \otimes_B^\mathbf{L} K)
$$
in $D(C)$.
\end{lemma}

\begin{proof}
Let $M^\bullet \to M$ be a free resoluton of $M$ as an $A$-module
and let $N^\bullet$ be a free resolution of $N$ as a $B$-module.
We have
\begin{align*}
M \otimes_A^\mathbf{L} N
& =
M^\bullet \otimes_A N \\
& =
M^\bullet \otimes_A B \otimes_B N \\
& \leftarrow
\text{Tot}((M^\bullet \otimes_A B) \otimes_B N^\bullet) \\
& = \text{Tot}(M^\bullet \otimes_A N^\bullet)
\end{align*}
Here the arrow is a quasi-isomorphism in $D(B)$ as $M^\bullet \otimes_A B$
is a bounded above complex of free $B$-modules, hence K-flat
(Lemma \ref{lemma-derived-tor-quasi-isomorphism})
and hence Lemma \ref{lemma-K-flat-quasi-isomorphism} applies.
Now the complex $\text{Tot}(M^\bullet \otimes_A N^\bullet)$ is a
complex of free $B$-modules hence we see that
$$
(M \otimes_A^\mathbf{L} N) \otimes_B^\mathbf{L} K =
\text{Tot}(M^\bullet \otimes_A N^\bullet) \otimes_B K =
\text{Tot}(M^\bullet \otimes_A N^\bullet \otimes_B K)
$$
On the other hand,
$$
M \otimes_A^\mathbf{L} K = M^\bullet \otimes_A K
\quad\text{and}\quad
N \otimes_B^\mathbf{L} C = N^\bullet \otimes_B C
$$
and the second is a bounded above
complex of free $C$-modules hence we see that
$$
(M \otimes_A^\mathbf{L} K) \otimes_C^\mathbf{L} (N \otimes_B^\mathbf{L} C) =
\text{Tot}((M^\bullet \otimes_A K) \otimes_C (N^\bullet \otimes_B C)) =
\text{Tot}(M^\bullet \otimes_A N^\bullet \otimes_B K)
$$
which proves the first equality of the statement of the lemma.
To prove the seconed we use that
$$
M \otimes_A^\mathbf{L} C = M^\bullet \otimes_A C
\quad\text{and}\quad
N \otimes_B^\mathbf{L} K = N^\bullet \otimes_B K
$$
and the first is a bounded above complex of free $C$-modules so that
$$
(M \otimes_A^\mathbf{L} C) \otimes_C^\mathbf{L} (N \otimes_B^\mathbf{L} K) =
\text{Tot}((M^\bullet \otimes_A C) \otimes_C (N^\bullet \otimes_B K)) =
\text{Tot}(M^\bullet \otimes_A N^\bullet \otimes_B K)
$$
as before.
\end{proof}






\section{Tor independence}
\label{section-tor-independece}

\noindent
We often encounter the following situation. Suppose that
$$
\xymatrix{
A \ar[r] & A' \\
R \ar[r] \ar[u] & R' \ar[u]
}
$$
is a ``base change'' diagram of rings, i.e., $A' = A \otimes_R R'$.
In this situation, for any $A$-module $M$ we have
$M \otimes_A A' = M \otimes_R R'$. Thus $- \otimes_R R'$
is equal to $- \otimes_A A'$ as a functor $\text{Mod}_A \to \text{Mod}_{A'}$.
In general this equality {\bf does not extend} to derived tensor products.
Let $K^\bullet \in D^{-}(A)$. We have
$$
K^\bullet \otimes_A^{\mathbf{L}} A' = P^\bullet \otimes_A A'
$$
where $P^\bullet \to K^\bullet$ is a projective resolution in the
category of $A$-modules. Pick a projective resolution
$E^\bullet \to P^\bullet$ in the category of $R$-modules.
Then it is also the case that $E^\bullet \to K^\bullet$ is a projective
resolution in the category of $R$-modules. Hence
$$
K^\bullet \otimes_R^{\mathbf{L}} R' = E^\bullet \otimes_R R'
$$
The map $E^\bullet \to P^\bullet$ and the map $R' \to A'$
combined determine a comparison map
\begin{equation}
\label{equation-comparison-map}
K^\bullet \otimes_R^{\mathbf{L}} R' =
E^\bullet \otimes_R R'
\longrightarrow
P^\bullet \otimes_A A' =
K^\bullet \otimes_A^{\mathbf{L}} A'
\end{equation}
A simple example where this is not an isomorphism is to take
$R = k[x]$, $A = R' = A' = k[x]/(x) = k$ and $K^\bullet = A[0]$.
Clearly, a necessary condition is that $\text{Tor}_p^R(A, R') = 0$
for all $p > 0$.

\begin{definition}
\label{definition-tor-independent}
Let $R$ be a ring. Let $A$, $B$ be $R$-algebras. We say
$A$ and $B$ are {\it Tor independent over $R$} if
$\text{Tor}_p^R(A, B) = 0$ for all $p > 0$.
\end{definition}

\begin{lemma}
\label{lemma-base-change-comparison}
The comparison map (\ref{equation-comparison-map}) is an isomorphism
if $A$ and $R'$ are Tor independent over $R$.
\end{lemma}

\begin{proof}
To prove this we choose a free resolution $F^\bullet \to R'$
of $R'$ as an $R$-module. Because $A$ and $R'$ are Tor independent over $R$
we see that $F^\bullet \otimes_R A$ is a free $A$-module resolution of $A'$
over $A$. By our general construction of the derived tensor product
above we see that
$$
P^\bullet \otimes_A A' \cong
\text{Tot}(P^\bullet \otimes_A (F^\bullet \otimes_R A)) =
\text{Tot}(P^\bullet \otimes_R F^\bullet) \cong
\text{Tot}(E^\bullet \otimes_R F^\bullet) \cong
E^\bullet \otimes_R R'
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-tor-independent-flat}
Consider a commutative diagram of rings
$$
\xymatrix{
A' & R' \ar[r] \ar[l] & B' \\
A \ar[u] & R \ar[l] \ar[u] \ar[r] & B \ar[u]
}
$$
Assume that $R'$ is flat over $R$ and $A'$ is flat over $A \otimes_R R'$
and $B'$ is flat over $R' \otimes_R B$. Then
$$
\text{Tor}_i^R(A, B) \otimes_{(A \otimes_R B)} (A' \otimes_{R'} B') =
\text{Tor}_i^{R'}(A', B')
$$
\end{lemma}

\begin{proof}
By Algebra, Section \ref{algebra-section-functoriality-tor} there are
canonical maps
$$
\text{Tor}_i^R(A, B) \longrightarrow
\text{Tor}_i^{R'}(A \otimes_R R', B \otimes_R R') \longrightarrow
\text{Tor}_i^{R'}(A', B')
$$
These induce a map from left to right in the formula of the lemma.

\medskip\noindent
Take a free resolution $F_\bullet \to A$ of $A$ as an $R$-module.
Then we see that $F_\bullet \otimes_R R'$ is a resolution of $A \otimes_R R'$.
Hence $\text{Tor}_i^{R'}(A \otimes_R R', B \otimes_R R')$ is computed
by $F_\bullet \otimes_R B \otimes_R R'$. By our assumption that $R'$
is flat over $R$, this computes $\text{Tor}_i^R(A, B) \otimes_R R'$.
Thus $\text{Tor}_i^{R'}(A \otimes_R R', B \otimes_R R') =
\text{Tor}_i^R(A, B) \otimes_R R'$ (uses only flatness of $R'$ over $R$).

\medskip\noindent
By Lazard's theorem (Algebra, Theorem \ref{algebra-theorem-lazard})
we can write $A'$, resp.\ $B'$ as a filtered colimit of finite free
$A \otimes_R R'$, resp.\ $B \otimes_R R'$-modules. Say
$A' = \colim M_i$ and $B' = \colim N_j$. The result above gives
$$
\text{Tor}_i^{R'}(M_i, N_j) =
\text{Tor}_i^R(A, B) \otimes_{A \otimes_R B} (M_i \otimes_{R'} N_j)
$$
as one can see by writing everything out in terms of bases.
Taking the colimit we get the result of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-tor-independent}
Let $R$ be a ring. Let $A$, $B$ be $R$-algebras. The following are equivalent
\begin{enumerate}
\item $A$ and $B$ are Tor independent over $R$,
\item for every pair of primes $\mathfrak p \subset A$ and
$\mathfrak q \subset B$ lying over the same prime $\mathfrak r \subset R$
the rings $A_\mathfrak p$ and $B_\mathfrak q$ are Tor independent over
$R_\mathfrak r$, and
\item For every prime $\mathfrak s$ of $A \otimes_R B$ the module
$$
\text{Tor}_i^R(A, B)_\mathfrak s =
\text{Tor}_i^{R_\mathfrak r}(A_\mathfrak p, B_\mathfrak q)_\mathfrak s
$$
(where $\mathfrak p = A \cap \mathfrak s$, $\mathfrak q = B \cap \mathfrak s$
and $\mathfrak r = R \cap \mathfrak s$) is zero.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak s$ be a prime of $A \otimes_R B$ as in (3).
The equality
$$
\text{Tor}_i^R(A, B)_\mathfrak s =
\text{Tor}_i^{R_\mathfrak r}(A_\mathfrak p, B_\mathfrak q)_\mathfrak s
$$
where $\mathfrak p = A \cap \mathfrak s$, $\mathfrak q = B \cap \mathfrak s$
and $\mathfrak r = R \cap \mathfrak s$ follows from
Lemma \ref{lemma-tor-independent-flat}.
Hence (2) implies (3).
Since we can test the vanishing of modules by localizing at primes
(Algebra, Lemma \ref{algebra-lemma-characterize-zero-local})
we conclude that (3) implies (1). For
(1) $\Rightarrow$ (2) we use that
$$
\text{Tor}_i^{R_\mathfrak r}(A_\mathfrak p, B_\mathfrak q) =
\text{Tor}_i^R(A, B) \otimes_{(A \otimes_R B)}
(A_\mathfrak p \otimes_{R_{\mathfrak r}} B_\mathfrak q)
$$
again by Lemma \ref{lemma-tor-independent-flat}.
\end{proof}








\section{Spectral sequences for Tor}
\label{section-spectral-sequence-tor}


\noindent
In this section we collect various spectral sequences that come up
when considering the Tor functors.

\begin{example}
\label{example-cohomology-complex-tensored}
Let $R$ be a ring. Let $K_\bullet$ be a bounded above chain complex
of $R$-modules. Let $M$ be an $R$-module. Then there is a
spectral sequence with $E_2$-page
$$
\text{Tor}^R_i(H_j(K_\bullet), M)
\Rightarrow
H_{i + j}(K_\bullet \otimes^{\mathbf{L}}_R M)
$$
and another spectral sequence with $E_1$-page
$$
\text{Tor}^R_i(K_j, M)
\Rightarrow
H_{i + j}(K_\bullet \otimes^{\mathbf{L}}_R M)
$$
This follows from the dual to
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
\end{example}

\begin{example}
\label{example-tor-change-rings}
Let $R \to S$ be a ring map. Let $M$ be an $R$-module and let
$N$ be an $S$-module. Then there is a spectral sequence
$$
\text{Tor}^S_n(\text{Tor}^R_m(M, S), N) \Rightarrow
\text{Tor}^R_{n + m}(M, N).
$$
To construct it choose a $R$-free resolution $P_\bullet$ of $M$. Then we have
$$
M \otimes_R^{\mathbf{L}} N = P^\bullet \otimes_R N =
(P^\bullet \otimes_R S) \otimes_S N
$$
and then apply the first spectral sequence of
Example \ref{example-cohomology-complex-tensored}.
\end{example}

\begin{example}
\label{example-tor-base-change}
Consider a commutative diagram
$$
\xymatrix{
B \ar[r] & B' = B \otimes_A A' \\
A \ar[r] \ar[u] & A' \ar[u]
}
$$
and $B$-modules $M, N$. Set $M' = M \otimes_A A' = M \otimes_B B'$
and $N' = N \otimes_A A' = N \otimes_B B'$.
{\it Assume that $A \to B$ is flat and that $M$ and $N$ are $A$-flat.}
Then there is a spectral sequence
$$
\text{Tor}^A_i(\text{Tor}_j^B(M, N), A')
\Rightarrow
\text{Tor}^{B'}_{i + j}(M', N')
$$
The reason is as follows. Choose free resolution
$F_\bullet \to M$ as a $B$-module. As $B$ and $M$ are $A$-flat we see
that $F_\bullet \otimes_A A'$ is a free $B'$-resolution of $M'$.
Hence we see that the groups $\text{Tor}^{B'}_n(M', N')$ are
computed by the complex
$$
(F_\bullet \otimes_A A') \otimes_{B'} N' =
(F_\bullet \otimes_B N) \otimes_A A' =
(F_\bullet \otimes_B N) \otimes^{\mathbf{L}}_A A'
$$
the last equality because $F_\bullet \otimes_B N$ is a complex
of flat $A$-modules as $N$ is flat over $A$. Hence we obtain the
spectral sequence by applying the spectral sequence of
Example \ref{example-cohomology-complex-tensored}.
\end{example}

\begin{example}
\label{example-tor}
Let $K^\bullet, L^\bullet$ be objects of $D^{-}(R)$.
Then there are spectral sequences
$$
E_2^{p, q} = H^p(K^\bullet \otimes_R^{\mathbf{L}} H^q(L^\bullet))
\Rightarrow H^{p + q}(K^\bullet \otimes_R^{\mathbf{L}} L^\bullet)
$$
with $d_2^{p, q} : E_2^{p, q} \to E_2^{p + 2, q - 1}$
and
$$
H^q(H^p(K^\bullet) \otimes_R^{\mathbf{L}} L^\bullet)
\Rightarrow H^{p + q}(K^\bullet \otimes_R^{\mathbf{L}} L^\bullet)
$$
After replacing $K^\bullet$ and $L^\bullet$ by bounded above complexes
of projectives, these spectral sequences are simply the two spectral
sequences for computing the cohomology of
$\text{Tot}(K^\bullet \otimes L^\bullet)$ discussed in
Homology, Section \ref{homology-section-double-complex}.
\end{example}









\section{Products and Tor}
\label{section-products-tor}

\noindent
The simplest example of the product maps comes from the following situation.
Suppose that $K^\bullet, L^\bullet \in D(R)$ with one of them contained
in $D^{-}(R)$. Then there are maps
\begin{equation}
\label{equation-simple-tor-product}
H^i(K^\bullet) \otimes_R H^j(L^\bullet)
\longrightarrow
H^{i + j}(K^\bullet \otimes_R^{\mathbf{L}} L^\bullet)
\end{equation}
Namely, to define these maps we may assume that one of $K^\bullet, L^\bullet$
is a bounded above complex of projective $R$-modules. In that case
$K^\bullet \otimes_R^{\mathbf{L}} L^\bullet$ is represented by the
complex $\text{Tot}(K^\bullet \otimes_R L^\bullet)$, see
Section \ref{section-computing-tor}.
Next, suppose that $\xi \in H^i(K^\bullet)$ and $\zeta \in H^j(L^\bullet)$.
Choose $k \in \text{Ker}(K^i \to K^{i + 1})$ and
$l \in \text{Ker}(L^j \to L^{j + 1})$ representing $\xi$ and $\zeta$.
Then we set
$$
\xi \cup \zeta =
\text{class of }k \otimes l\text{ in }
H^{i + j}(\text{Tot}(K^\bullet \otimes_R L^\bullet)).
$$
This make sense because the formula (see
Homology, Definition \ref{homology-definition-associated-simple-complex})
for the differential $\text{d}$ on the total complex shows that
$k \otimes l$ is a cocycle. Moreover, if $k' = d_K(k'')$ for some
$k'' \in K^{i - 1}$, then $k' \otimes l = \text{d}(k'' \otimes l)$
because $l$ is a cocycle. Similarly, altering the choice of $l$
representing $\zeta$ does not change the class of $k \otimes l$.
It is equally clear that $\cup$ is bilinear, and hence
to a general element of $H^i(K^\bullet) \otimes_R H^j(L^\bullet)$
we assign
$$
\sum \xi_i \otimes \zeta_i \longmapsto \sum \xi_i \cup \zeta_i
$$
in $H^{i + j}(\text{Tot}(K^\bullet \otimes_R L^\bullet))$.

\medskip\noindent
Let $R \to A$ be a ring map. Let $K^\bullet, L^\bullet \in D^{-}(R)$.
Then we have a canonical identification
\begin{equation}
\label{equation-pullback-derived-tensor-product}
(K^\bullet \otimes_R^{\mathbf{L}} A)
\otimes_A^{\mathbf{L}}
(L^\bullet \otimes_R^{\mathbf{L}} A)
=
(K^\bullet \otimes_R^{\mathbf{L}} L^\bullet) \otimes_R^{\mathbf{L}} A
\end{equation}
in $D(A)$. It is constructed as follows. First, choose projective resolutions
$P^\bullet \to K^\bullet$ and $Q^\bullet \to L^\bullet$
over $R$. Then the left hand side is represented by the complex
$\text{Tot}((P^\bullet \otimes_R A) \otimes_A (Q^\bullet \otimes_R A))$
and the right hand side by the complex
$\text{Tot}(P^\bullet \otimes_R Q^\bullet) \otimes_R A$. These
complexes are canonically isomorphic. Thus the construction above
induces products
$$
\text{Tor}^R_n(K^\bullet, A) \otimes_A \text{Tor}^R_m(L^\bullet, A)
\longrightarrow \text{Tor}_{n + m}^R(K^\bullet \otimes_R L^\bullet, A)
$$
which are occasionally usefull.

\medskip\noindent
Let $M$, $N$ be $R$-modules. Using the general construction above and
functoriality of $\text{Tor}$ we obtain canonical maps
\begin{equation}
\label{equation-tor-product}
\text{Tor}^R_n(M, A) \otimes_A \text{Tor}^R_m(N, A)
\longrightarrow \text{Tor}_{n + m}^R(M \otimes_R N, A)
\end{equation}
Here is a direct construction using projective resolutions. First, choose
projective resolutions
$$
P_\bullet \to M, \quad Q_\bullet \to N, \quad T_\bullet \to M \otimes_R N
$$
over $R$. We have
$H_0(\text{Tot}(P_\bullet \otimes_R Q_\bullet)) = M \otimes_R N$ by
right exactness of $\otimes_R$. Hence
Derived Categories, Lemmas \ref{derived-lemma-morphisms-lift-projective} and
\ref{derived-lemma-morphisms-equal-up-to-homotopy-projective}
guarantee the existence and uniqueness of a map of complexes
$\mu : \text{Tot}(P_\bullet \otimes_R Q_\bullet) \to T_\bullet$ such that
$H_0(\mu) = \text{id}_{M \otimes_R N}$. This induces a canonical map
\begin{align*}
(M \otimes_R^{\mathbf{L}} A) \otimes_A^{\mathbf{L}}
(N \otimes_R^{\mathbf{L}} A)
& =
\text{Tot}((P_\bullet \otimes_R A) \otimes_A (Q_\bullet \otimes_R A)) \\
& =
\text{Tot}(P_\bullet \otimes_R Q_\bullet) \otimes_R A \\
& \to
T_\bullet \otimes_R A \\
& = (M \otimes_R N) \otimes_R^{\mathbf{L}} A
\end{align*}
in $D(A)$. Hence the products (\ref{equation-tor-product}) above are
constructed using (\ref{equation-simple-tor-product}) over $A$ to construct
$$
\text{Tor}^R_n(M, A) \otimes_A \text{Tor}^R_m(N, A) \to
H^{-n-m}((M \otimes_R^{\mathbf{L}} A) \otimes_A^{\mathbf{L}}
(N \otimes_R^{\mathbf{L}} A))
$$
and then composing by the displayed map above to end up in
$\text{Tor}_{n + m}^R(M \otimes_R N, A)$.

\medskip\noindent
An interesting special case of the above occurs when $M = N = B$
where $B$ is an $R$-algebra. In this case we obtain maps
$$
\text{Tor}_n^R(B, A) \otimes_A \text{Tor}_m^R(B, A)
\longrightarrow
\text{Tor}_n^R(B \otimes_R B, A)
\longrightarrow
\text{Tor}_n^R(B, A)
$$
the second arrow being induced by the multiplication map
$B \otimes_R B \to B$ via functoriality for $\text{Tor}$.
In other words we obtain an $A$-algebra structure on
$\text{Tor}^R_{\star}(B, A)$. This algebra structure has many intriguing
properties (associativity, graded commutative, $B$-algebra structure,
divided powers in some case, etc) which we will discuss elsewhere (insert
future reference here).

\begin{lemma}
\label{lemma-functoriality-product-tor}
Let $R$ be a ring. Let $A, B, C$ be $R$-algebras and let $B \to C$ be an
$R$-algebra map. Then the induced map
$$
\text{Tor}^R_{\star}(B, A)
\longrightarrow
\text{Tor}^R_{\star}(C, A)
$$
is an $A$-algebra homomorphism.
\end{lemma}

\begin{proof}
Omitted. Hint: You can prove this by working through the definitions,
writing all the complexes explicitly.
\end{proof}









\section{Lifting}
\label{section-lifting}

\noindent
In this section we collection some lemmas concerning lifting
statements of the following kind: If $A$ is a ring and $I \subset A$
is an ideal, and $\overline{\xi}$ is some kind of structure over
$A/I$, then we can lift $\overline{\xi}$ to a similar kind of structure
$\xi$ over $A$ or over some \'etale extension of $A$. Here are some types
of structure for which we have already proved some results:
\begin{enumerate}
\item idempotents, see
Algebra, Lemmas \ref{algebra-lemma-lift-idempotents} and
\ref{algebra-lemma-lift-idempotents-noncommutative},
\item projective modules, see
Algebra, Lemma \ref{algebra-lemma-lift-projective-module},
\item basis elements, see
Algebra, Lemmas \ref{algebra-lemma-local-artinian-basis-when-flat} and
\ref{algebra-lemma-lift-basis},
\item ring maps, i.e., proving certain algebras are formally smooth, see
Algebra, Lemma \ref{algebra-lemma-polynomial-ring-formally-smooth},
Proposition \ref{algebra-proposition-smooth-formally-smooth}, and
Lemma \ref{algebra-lemma-smooth-strong-lift},
\item syntomic ring maps, see
Algebra, Lemma \ref{algebra-lemma-lift-syntomic},
\item smooth ring maps, see
Algebra, Lemma \ref{algebra-lemma-lift-smooth},
\item \'etale ring maps, see
Algebra, Lemma \ref{algebra-lemma-lift-etale},
\item factoring polynomials, see
Algebra, Lemma \ref{algebra-lemma-factor-mod-lift-etale}, and
\item Algebra, Section \ref{algebra-section-henselian} discusses henselian
local rings.
\end{enumerate}
The interested reader will find more results of this nature in
Smoothing Ring Maps, Section \ref{smoothing-section-presentations}
in particular
Smoothing Ring Maps, Proposition \ref{smoothing-proposition-lift-smooth}.

\medskip\noindent
Let $A$ be a ring and let $I \subset A$ be an ideal. Let $\overline{\xi}$
be some kind of structure over $A/I$. In the following lemmas we look for
\'etale ring maps $A \to A'$ which induce isomorphisms $A/I \to A'/IA'$
and objects $\xi'$ over $A'$ lifting $\overline{\xi}$. A general remark is
that given \'etale ring maps $A \to A' \to A''$ such that
$A/I \cong A'/IA'$ and $A'/IA' \cong A''/IA''$ the composition
$A \to A''$ is also \'etale (Algebra, Lemma \ref{algebra-lemma-etale})
and also satisfies $A/I \cong A''/IA''$.
We will frequently use this in the following lemmas without further mention.
Here is a trivial example of the type of result we are looking for.

\begin{lemma}
\label{lemma-lift-invertible-element}
Let $A$ be a ring, let $I \subset A$ be an ideal, let $\overline{u} \in A/I$
be an invertible element. There exists an \'etale ring map $A \to A'$ which
induces an isomorphism $A/I \to A'/IA'$ and an invertible element $u' \in A'$
lifting $\overline{u}$.
\end{lemma}

\begin{proof}
Choose any lift $f \in A$ of $\overline{u}$ and set $A' = A_f$ and $u$
the image of $f$ in $A'$.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotent}
Let $A$ be a ring, let $I \subset A$ be an ideal, let $\overline{e} \in A/I$
be an idempotent. There exists an \'etale ring map $A \to A'$ which
induces an isomorphism $A/I \to A'/IA'$ and an idempotent $e' \in A'$
lifting $\overline{e}$.
\end{lemma}

\begin{proof}
Choose any lift $x \in A$ of $\overline{e}$. Set
$$
A' = A[t]/(t^2 - t)\left[\frac{1}{t - 1 + x}\right].
$$
The ring map $A \to A'$ is \'etale because $(2t - 1)\text{d}t = 0$
and $(2t - 1)(2t - 1) = 1$ which is invertible. We have
$A'/IA' = A/I[t]/(t^2 - t)[\frac{1}{t - 1 + \overline{e}}] \cong A/I$
the last map sending $t$ to $\overline{e}$ which works as
$\overline{e}$ is a root of $t^2 - t$. This also shows that setting
$e'$ equal to the class of $t$ in $A'$ works.
\end{proof}

\begin{lemma}
\label{lemma-lift-open-covering}
Let $A$ be a ring, let $I \subset A$ be an ideal. Let
$\Spec(A/I) = \coprod_{j \in J} \overline{U}_j$ be a finite disjoint open
covering. Then there exists an \'etale ring map $A \to A'$ which
induces an isomorphism $A/I \to A'/IA'$ and a finite disjoint open covering
$\Spec(A') = \coprod_{j \in J} U'_j$ lifting the given covering.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-lift-idempotent} and
the fact that open and closed subsets of Spectra correspond
to idempotents, see Algebra, Lemma \ref{algebra-lemma-disjoint-decomposition}.
\end{proof}

\begin{lemma}
\label{lemma-localize-upstairs}
Let $A \to B$ be a ring map and $J \subset B$ an ideal. If
$A \to B$ is \'etale at every prime of $V(J)$, then there exists
a $g \in B$ mapping to an invertible element
of $B/J$ such that $A' = B_g$ is \'etale over $A$.
\end{lemma}

\begin{proof}
The set of points of $\Spec(B)$ where $A \to B$ is not \'etale is a
closed subset of $\Spec(B)$, see
Algebra, Definition \ref{algebra-definition-etale}.
Write this as $V(J')$ for some ideal $J' \subset B$. Then
$V(J') \cap V(J) = \emptyset$ hence $J + J' = B$ by
Algebra, Lemma \ref{algebra-lemma-Zariski-topology}.
Write $1 = f + g$ with $f \in J$ and $g \in J'$.
Then $g$ works.
\end{proof}

\noindent
The assumption on the leading coefficient in the following lemma
will be removed in Lemma \ref{lemma-lift-factorization}.

\begin{lemma}
\label{lemma-lift-factorization-easy}
Let $A$ be a ring, let $I \subset A$ be an ideal. Let $f \in A[x]$ be a
monic polynomial. Let $\overline{f} = \overline{g} \overline{h}$ be a
factorization of $f$ in $A/I[x]$ and assume
\begin{enumerate}
\item the leading coefficient of $\overline{g}$ is an invertible element
of $A/I$, and
\item $\overline{g}$, $\overline{h}$ generate the unit ideal in $A/I[x]$.
\end{enumerate}
Then there exists an \'etale ring map $A \to A'$ which induces an
isomorphism $A/I \to A'/IA'$ and a factorization $f = g' h'$ in $A'[x]$
lifting the given factorization over $A/I$.
\end{lemma}

\begin{proof}
Applying Lemma \ref{lemma-lift-invertible-element} we may assume that
the leading coefficient of $\overline{g}$ is the reduction of an
invertible element $u \in A$. Then we may replace $\overline{g}$ by
$\overline{u}^{-1}\overline{g}$ and $\overline{h}$ by
$\overline{u}\overline{h}$. Thus we may assume that $\overline{g}$
is monic. Since $f$ is monic we conclude that $\overline{h}$ is monic
too. Say $\deg(\overline{g}) = n$ and $\deg(\overline{h}) = m$ so
that $\deg(f) = n + m$. Write $f = x^{n + m} + \sum \alpha_i x^{n + m - i}$
for some $\alpha_1, \ldots, \alpha_{n + m} \in A$. Consider the ring map
$$
R = \mathbf{Z}[a_1, \ldots, a_{n + m}]
\longrightarrow
S = \mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m]
$$
of Algebra, Example \ref{algebra-example-factor-polynomials-etale}.
Let $R \to A$ be the ring map which sends $a_i$ to $\alpha_i$.
Set
$$
B = A \otimes_R S
$$
By construction the image of $f$ in $B[x]$ factors.
Write $\overline{g} = x^n + \sum \overline{\beta}_i x^{n - i}$ and
$\overline{h} = x^m + \sum \overline{\gamma}_i x^{m - i}$.
The $A$-algebra map
$$
B \longrightarrow A/I, \quad
1 \otimes b_i \mapsto \overline{\beta}_i, \quad
1 \otimes c_i \mapsto \overline{\gamma}_i
$$
maps the factorization of $f$ over $B$ to the given factorization over
$A/I$. The displayed map is surjective; denote $J \subset B$ its kernel.
From the discussion in 
Algebra, Example \ref{algebra-example-factor-polynomials-etale}
it is clear that $A \to B$ is etale at all points of $V(J) \subset \Spec(B)$.
Choose $g \in B$ as in Lemma \ref{lemma-localize-upstairs} and
set $A' = B_g$.
\end{proof}

\begin{lemma}
\label{lemma-lift-factorization}
Let $A$ be a ring, let $I \subset A$ be an ideal.
Let $f \in A[x]$ be a monic polynomial.
Let $\overline{f} = \overline{g} \overline{h}$ be a factorization of $f$
in $A/I[x]$ and assume that  $\overline{g}$, $\overline{h}$ generate
the unit ideal in $A/I[x]$. Then there exists an \'etale ring map
$A \to A'$ which induces an isomorphism $A/I \to A'/IA'$ and a factorization
$f = g' h'$ in $A'[x]$ lifting the given factorization over $A/I$.
\end{lemma}

\begin{proof}
Say $f = x^d + a_1 x^{d - 1} + \ldots + a_d$ has degree $d$.
Write $\overline{g} = \sum \overline{b}_j x^j$ and
$\overline{h} = \sum \overline{c}_j x^j$. Then we see that
$1 = \sum \overline{b}_j \overline{c}_{d - j}$. It follows that
$\Spec(A/I)$ is covered by the standard opens
$D(\overline{b}_j \overline{c}_{d - j})$. However, each point
$\mathfrak p$ of $\Spec(A/I)$ is contained in at most one of these as
by looking at the induced factorization of $f$ over the field
$\kappa(\mathfrak p)$ we see that $\deg(\overline{g} \bmod \mathfrak p) +
\deg(\overline{h} \bmod \mathfrak p) = d$. Hence our open covering
is a disjoint open covering. Applying Lemma \ref{lemma-lift-open-covering}
(and replacing $A$ by $A'$) we see that we may assume there is a
corresponding disjoint open covering of $\Spec(A)$. This disjoint open
covering corresponds to a product decomposition of $A$, see
Algebra, Lemma \ref{algebra-lemma-disjoint-implies-product}. It follows that
$$
A = A_0 \times \ldots \times A_d,
\quad
I = I_0 \times \ldots \times I_d,
$$
where the image of $\overline{g}$, resp.\ $\overline{h}$ in $A_j/I_j$
has degree $j$, resp.\ $d - j$ with invertible leading coefficient.
Clearly, it suffices to prove the result for each factor $A_j$
separatedly. Hence the lemma follows from
Lemma \ref{lemma-lift-factorization-easy}.
\end{proof}

\begin{lemma}
\label{lemma-separate-image-closed-from-closed}
Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal of $R$
and let $J \subset S$ be an ideal of $S$. If the closure of the image
of $V(J)$ in $\Spec(R)$ is disjoint from $V(I)$, then there exists
an element $f \in R$ which maps to $1$ in $R/I$ and to an element
of $J$ in $S$.
\end{lemma}

\begin{proof}
Let $I' \subset R$ be an ideal such that $V(I')$ is the closure of
the image of $V(J)$. Then $V(I) \cap V(I') = \emptyset$ by assumption
and hence $I + I' = R$ by
Algebra, Lemma \ref{algebra-lemma-Zariski-topology}.
Write $1 = g + f$ with $g \in I$ and $f \in I'$.
We have $V(f') \supset V(J)$ where $f'$ is the image of $f$ in $S$.
Hence $(f')^n \in J$ for some $n$, see
Algebra, Lemma \ref{algebra-lemma-Zariski-topology}.
Replacing $f$ by $f^n$ we win.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotent-upstairs}
Let $A$ be a ring, let $I \subset A$ be an ideal.
Let $A \to B$ be an integral ring map.
Let $\overline{e} \in B/IB$ be an idempotent.
Then there exists an \'etale ring map $A \to A'$
which induces an isomorphism $A/I \to A'/IA'$ and an idempotent
$e' \in B \otimes_A A'$ lifting $\overline{e}$.
\end{lemma}

\begin{proof}
Choose an element $y \in B$ lifting $\overline{e}$.
Then $z = y^2 - y$ is an element of $IB$. By
Algebra, Lemma \ref{algebra-lemma-integral-integral-over-ideal}
there exist a monic polynomial
$g(x) = x^d + \sum a_j x^j$ of degree $d$ with $a_j \in I$ such that
$g(z) = 0$ in $B$. Hence $f(x) = g(x^2 - x) \in A[x]$ is a monic
polynomial such that $f(x) \equiv x^d(x - 1)^d \bmod I$
and such that $f(y) = 0$ in $B$.
By Lemma \ref{lemma-lift-factorization-easy}
we can find an \'etale ring map $A \to A'$ which induces
an isomorphism $A/I \to A'/IA'$ and such that $f = gh$
in $A[x]$ with $g(x) = x^d \bmod IA'$ and $h(x) = (x - 1)^d \bmod IA'$.
After replacing $A$ by $A'$ we may assume that the factorization
is defined over $A$. In that case we see that
$b_1 = g(y) \in B$ is a lift of $\overline{e}^d = \overline{e}$ and
$b_2 = h(y) \in B$ is a lift of
$(\overline{e} - 1)^d = (-1)^d (1 - \overline{e})^d = (-1)^d(1 - \overline{e})$
and moreover $b_1b_2 = 0$. Thus $(b_1, b_2)B/IB = B/IB$ and
$V(b_1, b_2) \subset \Spec(B)$ is disjoint from $V(IB)$. Since
$\Spec(B) \to \Spec(A)$ is closed (see
Algebra, Lemmas \ref{algebra-lemma-integral-going-up} and
\ref{algebra-lemma-going-up-closed})
we can find an $a \in A$ which maps to an invertible element
of $A/I$ whose image in $B$ lies in $(b_1, b_2)$, see
Lemma \ref{lemma-separate-image-closed-from-closed}.
After replacing $A$ by the localization $A_a$ we get that
$(b_1, b_2) = B$. Then $\Spec(B) = D(b_1) \amalg D(b_2)$;
disjoint union because $b_1b_2 = 0$. Let $e \in B$ be the idempotent
corresponding to the open and closed subset $D(b_1)$, see
Algebra, Lemma \ref{algebra-lemma-disjoint-decomposition}.
Since $b_1$ is a lift of $\overline{e}$ and $b_2$ is a
lift of $\pm (1 - \overline{e})$ we conclude that $e$ is
a lift of $\overline{e}$ by the uniqueness statement in
Algebra, Lemma \ref{algebra-lemma-disjoint-decomposition}.
\end{proof}

\begin{lemma}
\label{lemma-lift-projective-module}
Let $A$ be a ring, let $I \subset A$ be an ideal.
Let $\overline{P}$ be finite projective $A/I$-module.
Then there exists an \'etale ring map $A \to A'$ which induces
an isomorphism $A/I \to A'/IA'$ and a finite projective
$A'$-module $P'$ lifting $\overline{P}$.
\end{lemma}

\begin{proof}
We can choose an integer $n$ and a direct sum decomposition
$(A/I)^{\oplus n} = \overline{P} \oplus \overline{K}$
for some $R/I$-module $\overline{K}$. Choose a lift
$\varphi : A^{\oplus n} \to A^{\oplus n}$ of the projector $\overline{p}$
associated to the direct summand $\overline{P}$.
Let $f \in A[x]$ be the characteristic polynomial of $\varphi$.
Set $B = A[x]/(f)$. By Cayley-Hamilton
(Algebra, Lemma \ref{algebra-lemma-charpoly}) there is a map
$B \to \text{End}_A(A^{\oplus n})$ mapping $x$ to $\varphi$.
For every prime $\mathfrak p \supset I$ the image of $f$ in
$\kappa(\mathfrak p)$ is $(x - 1)^rx^{n - r}$ where $r$ is the
dimension of $\overline{P} \otimes_{A/I} \kappa(\mathfrak p)$.
Hence $(x - 1)^nx^n$ maps to zero in $B \otimes_A \kappa(\mathfrak p)$
for all $\mathfrak p \supset I$. Hence the image of $(x - 1)^nx^n$
in $B$ is contained in
$$
\bigcup\nolimits_{\mathfrak p \supset I} \mathfrak pB =
(\bigcup\nolimits_{\mathfrak p \supset I} \mathfrak p)B =
\sqrt{I} B
$$
the first equality because $B$ is a free $A$-module and the second
by Algebra, Lemma \ref{algebra-lemma-Zariski-topology}.
Thus $(x - 1)^N x^N$ is contained in $IB$ for some $N$.
It follows that $x^N + (1 - x)^N$ is a unit in $B/IB$ and that
$$
\overline{e} = \text{image of }\frac{x^N}{x^N + (1 - x)^N}\text{ in }B/IB
$$
is an idempotent as both assertions hold in $\mathbf{Z}[x]/(x^n(x - 1)^N)$.
The image of $\overline{e}$ in $\text{End}_{A/I}((A/I)^{\oplus n})$ is
$$
\frac{\overline{p}^N}{\overline{p}^N + (1 - \overline{p})^N} = \overline{p}
$$
as $\overline{p}$ is an idempotent. After replacing $A$ by an \'etale
extension $A'$ as in the lemma, we may assume there exists an idempotent
$e \in B$ which maps to $\overline{e}$ in $B/IB$, see
Lemma \ref{lemma-lift-idempotent-upstairs}.
Then the image of $e$ under the map
$$
B = A[x]/(f) \longrightarrow \text{End}_A(A^{\oplus n}).
$$
is an idempotent element $p$ which lifts $\overline{p}$.
Setting $P = \text{Im}(p)$ we win.
\end{proof}

\begin{lemma}
\label{lemma-cotangent-complex-symmetric-algebra}
Let $A$ be a ring. Let $0 \to K \to A^{\oplus m} \to M \to 0$
be a sequence of $A$-modules. Consider the $A$-algebra
$C = \text{Sym}^*_A(M)$ with its presentation
$\alpha : A[y_1, \ldots, y_m] \to C$
coming from the surjection $A^{\oplus m} \to M$. Then
$$
\NL(\alpha) =
(K \otimes_A C \to \bigoplus\nolimits_{j = 1, \ldots, m} C \text{d}y_j)
$$
(see Algebra, Section \ref{algebra-section-netherlander})
in particular $\Omega_{C/A} = M \otimes_A C$.
\end{lemma}

\begin{proof}
Let $J = \text{Ker}(\alpha)$. The lemma asserts that
$J/J^2 \cong K \otimes_A C$. Note that $\alpha$ is a homomorphism
of graded algebras. We will prove that in degree $d$ we have
$(J/J^2)_d = K \otimes_A C_{d - 1}$. Note that
$$
J_d = \text{Ker}(\text{Sym}^d_A(A^{\oplus m}) \to \text{Sym}^d_A(M))
= \text{Im}(K \otimes_A \text{Sym}^{d - 1}_A(A^{\oplus m})
\to \text{Sym}^d_A(A^{\oplus m})),
$$
see Algebra, Lemma \ref{algebra-lemma-presentation-sym-exterior}.
It follows that $(J^2)_d = \sum_{a + b = d} J_a \cdot J_b$ is the image of
$$
K \otimes_A K \otimes_A \text{Sym}^{d - 2}_A(A^{\otimes m})
\to \text{Sym}^d_A(A^{\oplus m}).
$$
The cokernel of the map $K \otimes_A \text{Sym}^{d - 2}_A(A^{\otimes m}) \to
\text{Sym}^{d - 1}_A(A^{\oplus m})$ is $\text{Sym}^{d - 1}_A(M)$ by
the lemma referenced above.
Hence it is clear that $(J/J^2)_d = J_d/(J^2)_d$ is equal to
\begin{align*}
\text{Coker}(
K \otimes_A K \otimes_A \text{Sym}^{d - 2}_A(A^{\otimes m})
\to K \otimes_A \text{Sym}^{d - 1}_A(A^{\otimes m}))
& = K \otimes_A \text{Sym}^{d - 1}_A(M) \\
& = K \otimes_A C_{d -1}
\end{align*}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-symmetric-algebra-smooth}
Let $A$ be a ring. Let $M$ be an $A$-module. Then $C = \text{Sym}_A^*(M)$
is smooth over $A$ if and only if $M$ is a finite projective $A$-module.
\end{lemma}

\begin{proof}
Let $\sigma : C \to A$ be the projection onto the degree $0$ part of $C$.
Then $J = \text{Ker}(\sigma)$ is the part of degree $> 0$ and we see that
$J/J^2 = M$ as an $A$-module. Hence if $A \to C$ is smooth then $M$ is
a finite projective $A$-module by
Algebra, Lemma \ref{algebra-lemma-section-smooth}.

\medskip\noindent
Conversely, assume that $M$ is finite projective and choose a surjection
$A^{\oplus n} \to M$ with kernel $K$. Of course the sequence
$0 \to K \to A^{\oplus n} \to M \to 0$ is split as $M$ is projective.
In particular we see that $K$ is a finite $A$-module and hence
$C$ is of finite presentation over $A$ as $C$ is a quotient of
$A[x_1, \ldots, x_n]$ by the ideal generated by $K \subset \bigoplus Ax_i$.
The computation of Lemma \ref{lemma-cotangent-complex-symmetric-algebra}
shows that $\NL_{C/A}$ is homotopy equivalent to $(K \to M) \otimes_A C$.
Hence $\NL_{C/A}$ is quasi-isomorphic to $C \otimes_A M$ placed in degree
$0$ which means that $C$ is smooth over $A$ by
Algebra, Definition \ref{algebra-definition-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-lift-section-smooth-morphism}
Let $A$ be a ring, let $I \subset A$ be an ideal. Consider a commutative
diagram
$$
\xymatrix{
B \ar[rd] \\
A \ar[u] \ar[r] & A/I
}
$$
where $B$ is a smooth $A$-algebra. Then there exists an \'etale ring
map $A \to A'$ which induces an isomorphism $A/I \to A'/IA'$ and an
$A$-algebra map $B \to A'$ lifting the ring map $B \to A/I$.
\end{lemma}

\begin{proof}
Let $J \subset B$ be the kernel of $B \to A/I$ so that $B/J = A/I$. By
Algebra, Lemma \ref{algebra-lemma-application-NL-smooth} the sequence
$$
0 \to I/I^2 \to J/J^2 \to \Omega_{B/A} \otimes_B B/J \to 0
$$
is split exact. Thus $\overline{P} = J/(J^2 + IB) = \Omega_{B/A} \otimes_B B/J$
is a finite projective $A/I$-module. Choose an integer $n$ and a direct sum
decomposition $A/I^{\oplus n} = \overline{P} \oplus \overline{K}$.
By Lemma \ref{lemma-lift-projective-module} we can find an
\'etale ring map $A \to A'$ which induces an isomorphism
$A/I \to A'/IA'$ and a finite projective $A$-module $K$ which
lifts $\overline{K}$. We may and do replace $A$ by $A'$.
Set $B' = B \otimes_A \text{Sym}_A^*(K)$. Since $A \to \text{Sym}_A^*(K)$
is smooth by Lemma \ref{lemma-symmetric-algebra-smooth} we see that
$B \to B'$ is smooth which in turn implies that $A \to B'$ is smooth (see
Algebra, Lemmas \ref{algebra-lemma-base-change-smooth} and
\ref{algebra-lemma-locally-smooth}).
Moreover the section $\text{Sym}^*_A(K) \to A$ determines a section
$B' \to B$ and we let $B' \to A/I$ be the composition $B' \to B \to A/I$.
Let $J' \subset B'$ be the kernel of $B' \to A/I$. We have
$JB' \subset J'$ and $B \otimes_A K \subset J'$. These maps combine
to give an isomorphism
$$
(A/I)^{\oplus n} \cong J/J^2 \oplus \overline{K}
\longrightarrow
J'/((J')^2 + IB')
$$
Thus, after replacing $B$ by $B'$ we may assume that
$J/(J^2 + IB) = \Omega_{B/A} \otimes_B B/J$ is a free
$A/I$-module of rank $n$.

\medskip\noindent
In this case, choose $f_1, \ldots, f_n \in J$ which map to a
basis of $J/(J^2 + IB)$. Consider the finitely presented $A$-algebra
$C = B/(f_1, \ldots, f_n)$. Note that we have an exact sequence
$$
0 \to H_1(L_{C/A}) \to (f_1, \ldots, f_n)/(f_1, \ldots, f_n)^2
\to \Omega_{B/A} \otimes_B C \to \Omega_{C/A} \to 0
$$
see Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL} (note that
$H_1(L_{B/A}) = 0$ and that $\Omega_{B/A}$ is finite projective,
in particular flat so the Tor group vanishes). For any prime
$\mathfrak q \supset J$ of $B$ the module $\Omega_{B/A, \mathfrak q}$
is free of rank $n$ because $\Omega_{B/A}$ is finite projective and
because $\Omega_{B/A} \otimes_B B/J$ is free of rank $n$. By our choice
of $f_1, \ldots, f_n$ the map
$$
\left((f_1, \ldots, f_n)/(f_1, \ldots, f_n)^2\right)_{\mathfrak q}
\to
\Omega_{B/A, \mathfrak q}
$$
is surjective modulo $I$. Hence we see that this map of modules over
the local ring $C_{\mathfrak q}$ has to be an isomorphism. Thus
$H_1(L_{C/A})_{\mathfrak q} = 0$ and $\Omega_{C/A, \mathfrak q} = 0$. By
Algebra, Lemma \ref{algebra-lemma-smooth-at-point}
we see that $A \to C$ is smooth at the prime $\overline{\mathfrak q}$
of $C$ corresponding to $\mathfrak q$. Since
$\Omega_{C/A, \mathfrak q} = 0$ it is actually \'etale at
$\overline{\mathfrak q}$. Thus $A \to C$ is \'etale at all primes
of $C$ containing $JC$. By Lemma \ref{lemma-localize-upstairs}
we can find an $f \in C$ mapping to an invertible element of $C/JC$ such that
$A \to C_f$ is \'etale. By our choice of $f$ it is still true that
$C_f/JC_f = A/I$. The map $C_f/IC_f \to A/I$ is surjective and
\'etale by Algebra, Lemma \ref{algebra-lemma-map-between-etale}.
Hence $A/I$ is isomorphic to the localization of $C_f/IC_f$ at
some element $g \in C$, see
Algebra, Lemma \ref{algebra-lemma-surjective-flat-finitely-presented}.
Set $A' = C_{fg}$ to conclude the proof.
\end{proof}









\section{Auto-associated rings}
\label{section-auto-ass}

\noindent
Some of this material is in \cite{Autour}.

\begin{definition}
\label{definition-auto-ass}
A ring $R$ is said to be {\it auto-associated} if $R$ is local and its
maximal ideal $\mathfrak m$ is weakly associated to $R$.
\end{definition}

\begin{lemma}
\label{lemma-auto-ass-implies-P}
An auto-associated ring $R$ has the following property: (P)
Every proper finitely generated ideal $I \subset R$ has a nonzero
annihilator.
\end{lemma}

\begin{proof}
By assumption there exists a nonzero element $x \in R$ such that for every
$f \in \mathfrak m$ we have $f^n x = 0$. Say $I = (f_1, \ldots, f_r)$.
Then $x$ is in the kernel of $R \to \bigoplus R_{f_i}$. Hence we see
that there exists a nonzero $y \in R$ such that $f_i y = 0$ for all $i$, see
Algebra, Lemma \ref{algebra-lemma-when-injective-covering}.
As $y \in \text{Ann}_R(I)$ we win.
\end{proof}

\begin{lemma}
\label{lemma-P-universally-injective}
Let $R$ be a ring having property (P) of
Lemma \ref{lemma-auto-ass-implies-P}.
Let $u : N \to M$ be a homomorphism of projective $R$-modules.
Then $u$ is universally injective if and only if $u$ is injective.
\end{lemma}

\begin{proof}
Assume $u$ is injective. Our goal is to show $u$ is universally injective.
First we choose a module $Q$ such that $N \oplus Q$ is free. On considering
the map $N \oplus Q \to M \oplus Q$ we see that it suffices to prove
the lemma in case $N$ is free. In this case $N$ is a directed colimit of
finite free $R$-modules. Thus we reduce to the case that $N$ is a finite
free $R$-module, say $N = R^{\oplus n}$. We prove the lemma by induction
on $n$. The case $n = 0$ is trivial.

\medskip\noindent
Let $u : R^{\oplus n} \to M$ be an injective module map with $M$ projective.
Choose an $R$-module $Q$ such that $M \oplus Q$ is free. After replacing
$u$ by the composition $R^{\oplus n} \to M \to M \oplus Q$ we see that
we may assume that $M$ is free. Then we can find a direct summand
$R^{\oplus m} \subset M$ such that $u(R^{\oplus n}) \subset R^{\oplus m}$.
Hence we may assume that $M = R^{\oplus m}$.
In this case $u$ is given by a matrix $A = (a_{ij})$ so that
$u(x_1, \ldots, x_n) = (\sum x_i a_{i1}, \ldots, \sum x_i a_{im})$.
As $u$ is injective, in particular
$u(x, 0, \ldots, 0) = (xa_{11}, xa_{12}, \ldots, xa_{1m}) \not = 0$ if
$x \not = 0$, and as $R$ has property (P) we see that
$a_{11}R + a_{12}R + \ldots + a_{1m}R = R$. Hence see that
$R(a_{11}, \ldots, a_{1m}) \subset R^{\oplus m}$ is a direct summand
of $R^{\oplus m}$, in particular $R^{\oplus m}/R(a_{11}, \ldots, a_{1m})$
is a projective $R$-module. We get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
R \ar[rr] \ar[d]^1 & & R^{\oplus n} \ar[r] \ar[d]^u &
R^{\oplus n - 1} \ar[r] \ar[d] & 0 \\
0 \ar[r] & R \ar[rr]^{(a_{11}, \ldots, a_{1m})} & &
R^{\oplus m} \ar[r] & R^{\oplus m}/R(a_{11}, \ldots, a_{1m}) \ar[r] & 0
}
$$
with split exact rows. Thus the right vertical arrow is injective
and we may apply the induction hypothesis to conclude that
the right verical arrow is universally injective. It follows that the
middle vertical arrow is universally injective.
\end{proof}

\begin{lemma}
\label{lemma-P-fPD-zero}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ has property (P) of
Lemma \ref{lemma-auto-ass-implies-P},
\item any injective map of projective $R$-modules is
universally injective,
\item if $u : N \to M$ is injective and $N$, $M$ are finite projective
$R$-modules then $\text{Coker}(u)$ is a finite projective $R$-module,
\item if $N \subset M$ and $N$, $M$ are finite projective as $R$-modules, then
$N$ is a direct summand of $M$, and
\item any injective map $R \to R^{\oplus n}$ is a split injection.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is
Lemma \ref{lemma-P-universally-injective}.
It is clear that (3) and (4) are equivalent.
We have (2) $\Rightarrow$ (3), (4) by
Algebra, Lemma \ref{algebra-lemma-universally-exact-split}.
Part (5) is a special case of (4).
Assume (5). Let $I = (a_1, \ldots, a_n)$ be a proper finitely generated
ideal of $R$. As $I \not = R$ we see that
$R \to R^{\oplus n}$, $x \mapsto (xa_1, \ldots, xa_n)$
is not a split injection. Hence it has a nonzero kernel and we conclude
that $\text{Ann}_R(I) \not = 0$. Thus (1) holds.
\end{proof}

\begin{example}
\label{example-auto-ass-weird-flat}
If the equivalent conditions of
Lemma \ref{lemma-P-fPD-zero}
hold, then it is not always the case that every injective map of
free $R$-modules is a split injection. For example suppose that
$R = k[x_1, x_2, x_3, \ldots]/(x_i^2)$. This is an auto-associated ring.
Consider the map of free $R$-modules
$$
u :
\bigoplus\nolimits_{i \geq 1} Re_i
\longrightarrow
\bigoplus\nolimits_{i \geq 1} Rf_i, \quad
e_i \longmapsto f_i - x_if_{i + 1}.
$$
For any integer $n$ the restriction of $u$ to
$\bigoplus_{i = 1, \ldots, n} Re_i$ is injective as the images
$u(e_1), \ldots, u(e_n)$ are $R$-linearly independent. Hence
$u$ is injective and hence universally injective by the lemma.
Since $u \otimes \text{id}_k$ is bijective we see that if
$u$ were a split injection then $u$ would be surjective. But $u$ is not
surjective because the inverse image of $f_1$ would be the element
$$
\sum\nolimits_{i \geq 0} x_1 \ldots x_ie_{i + 1} =
e_1 + x_1e_2 + x_1x_2e_3 + \ldots
$$
which is not an element of the direct sum. A side remark is that
$\text{Coker}(u)$ is a flat (because $u$ is universally injective),
countably generated $R$-module which is not projective (as $u$ is not
split), hence not Mittag-Leffler (see
Algebra, Lemma \ref{algebra-lemma-countgen-projective}).
\end{example}









\section{Flattening stratification}
\label{section-flattening}

\noindent
Let $R \to S$ be a ring map and let $N$ be an $S$-module.
For any $R$-algebra $R'$ we can consider the base changes
$S' = S \otimes_R R'$ and $M' = M \otimes_R R'$.
We say $R \to R'$ {\it flattens} $M$ if the module $M'$ is flat over $R'$.
We would like to understand the structure of the collection of ring maps
$R \to R'$ which flatten $M$. In particular we would like to know
if there exists a {\it universal flattening $R \to R_{univ}$ of $M$},
i.e., a ring map $R \to R_{univ}$ which flattens $M$ and has the property
that any ring map $R \to R'$ which flattens $M$ factors through
$R \to R_{univ}$. It turns out that such a universal solution usually
does not exist.

\medskip\noindent
We will discuss {\it universal flattenings} and
{\it flattening stratifications} in a scheme theoretic
setting $\mathcal{F}/X/S$ in
More on Flatness, Section \ref{flat-section-flattening}.
If the universal flattening $R \to R_{univ}$ exists then the
morphism of schemes $\Spec(R_{univ}) \to \Spec(R)$ is the
universal flattening of the quasi-coherent module
$\widetilde{M}$ on $\Spec(S)$.

\medskip\noindent
In this and the next few sections we prove some basic algebra facts
related to this. The most basic result is perhaps the following.

\begin{lemma}
\label{lemma-intersection-flat}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $I_1$, $I_2$ be ideals of $R$.
If $M/I_1M$ is flat over $R/I_1$ and $M/I_2M$ is flat over $R/I_2$,
then $M/(I_1 \cap I_2)M$ is flat over $R/(I_1 \cap I_2)$.
\end{lemma}

\begin{proof}
By replacing $R$ with $R/(I_1 \cap I_2)$ and $M$ by $M/(I_1 \cap I_2)M$
we may assume that $I_1 \cap I_2 = 0$. Let $J \subset R$ be an ideal.
To prove that $M$ is flat over $R$ we have to show that
$J \otimes_R M \to M$ is injective, see
Algebra, Lemma \ref{algebra-lemma-flat}.
By flatness of $M/I_1M$ over $R/I_1$ the map
$$
J/(J \cap I_1) \otimes_R M =
(J + I_1)/I_1 \otimes_{R/I_1} M/I_1M
\longrightarrow M/I_1M
$$
is injective. As $0 \to (J \cap I_1) \to J \to J/(J \cap I_1) \to 0$
is exact we obtain a diagram
$$
\xymatrix{
(J \cap I_1) \otimes_R M \ar[r] \ar[d] &
J \otimes_R M \ar[r] \ar[d] &
J/(J \cap I_1) \otimes_R M \ar[r] \ar[d] & 0 \\
M \ar@{=}[r] &
M \ar[r] &
M/I_1M
}
$$
hence it suffices to show that $(J \cap I_1) \otimes_R M \to M$ is
injective. Since $I_1 \cap I_2 = 0$ the ideal $J \cap I_1$
maps isomorphically to an ideal $J' \subset R/I_2$ and we see that
$(J \cap I_1) \otimes_R M = J' \otimes_{R/I_2} M/I_2M$. By flatness
of $M/I_2M$ over $R/I_2$ the map $J' \otimes_{R/I_2} M/I_2M \to M/I_2M$
is injective, which clearly implies that $(J \cap I_1) \otimes_R M \to M$ is
injective.
\end{proof}





\section{Flattening over an Artinian ring}
\label{section-flattening-artinian}

\noindent
A universal flattening exists when the base ring is an Artinian local
ring. It exists for an arbitrary module. Hence, as we will see later,
a flatting stratification exists when the base scheme is the spectrum
of an Artinian local ring.

\begin{lemma}
\label{lemma-flattening-artinian}
Let $R$ be an Artinian ring.
Let $M$ be an $R$-module.
Then there exists a smallest ideal $I \subset R$ such that
$M/IM$ is flat over $R/I$.
\end{lemma}

\begin{proof}
This follows directly from
Lemma \ref{lemma-intersection-flat}
and the Artinian property.
\end{proof}

\noindent
This ideal has the following universal property.

\begin{lemma}
\label{lemma-flattening-artinian-universal-property}
Let $R$ be an Artinian ring. Let $M$ be an $R$-module.
Let $I \subset R$ be the smallest ideal $I \subset R$ such that
$M/IM$ is flat over $R/I$.
Then $I$ has the following universal property:
For every ring map $\varphi : R \to R'$ we have
$$
R' \otimes_R M\text{ is flat over }R'
\Leftrightarrow
\text{we have }\varphi(I) = 0.
$$
\end{lemma}

\begin{proof}
Note that $I$ exists by
Lemma \ref{lemma-flattening-artinian}.
The implication $\Rightarrow$ follows from
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Let $\varphi : R \to R'$ be such that $M \otimes_R R'$ is flat over $R'$.
Let $J = \text{Ker}(\varphi)$. By
Algebra,
Lemma \ref{algebra-lemma-descent-flatness-injective-map-artinian-rings}
and as $R' \otimes_R M = R' \otimes_{R/J} M/JM$ is
flat over $R'$ we conclude that $M/JM$ is flat over $R/J$.
Hence $I \subset J$ as desired.
\end{proof}











\section{Flattening over a closed subset of the base}
\label{section-flattening-local-base}

\noindent
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
In the following we will consider the following condition
\begin{equation}
\label{equation-flat-at-primes-over}
\forall \mathfrak q \in V(IS) \subset \Spec(S) :
M_{\mathfrak q}\text{ is flat over }R.
\end{equation}
Geometrically, this means that $M$ is flat over $R$ along the inverse
image of $V(I)$ in $\Spec(S)$. If $R$ and $S$ are Noetherian rings and
$M$ is a finite $S$-module, then (\ref{equation-flat-at-primes-over})
is equivalent to the condition that $M/I^nM$ is flat over $R/I^n$
for all $n \geq 1$, see
Algebra, Lemma \ref{algebra-lemma-flat-module-powers}.

\begin{lemma}
\label{lemma-base-change-flat-at-primes-over}
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
Let $R \to R'$ be a ring map and $IR' \subset I' \subset R'$ an ideal.
If (\ref{equation-flat-at-primes-over}) holds for
$(R \to S, I, M)$, then (\ref{equation-flat-at-primes-over})
holds for $(R' \to S \otimes_R R', I', M \otimes_R R')$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes-over}) holds for
$(R \to S, I \subset R, M)$.
Let $I'(S \otimes_R R') \subset \mathfrak q'$ be a prime of $S \otimes_R R'$.
Let $\mathfrak q \subset S$ be the corresponding prime of $S$.
Then $IS \subset \mathfrak q$. Note that $(M \otimes_R R')_{\mathfrak q'}$
is a localization of the base change $M_{\mathfrak q} \otimes_R R'$.
Hence $(M \otimes_R R')_{\mathfrak q'}$ is flat over $R'$ as a localization
of a flat module, see
Algebra, Lemmas \ref{algebra-lemma-flat-base-change} and
\ref{algebra-lemma-flat-localization}.
\end{proof}

\begin{lemma}
\label{lemma-flat-descent-flat-at-primes-over}
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
Let $R \to R'$ be a ring map and $IR' \subset I' \subset R'$ an ideal
such that
\begin{enumerate}
\item the map $V(I') \to V(I)$ induced by
$\Spec(R') \to \Spec(R)$ is surjective, and
\item $R'_{\mathfrak p'}$ is flat over $R$ for all primes
$\mathfrak p' \in V(I')$.
\end{enumerate}
If (\ref{equation-flat-at-primes-over}) holds for
$(R' \to S \otimes_R R', I', M \otimes_R R')$, then
(\ref{equation-flat-at-primes-over}) holds for $(R \to S, I, M)$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes-over}) holds for
$(R' \to S \otimes_R R', IR', M \otimes_R R')$. Pick a prime
$IS \subset \mathfrak q \subset S$. Let $I \subset \mathfrak p \subset R$
be the corresponding prime of $R$. By assumption there exists
a prime $\mathfrak p' \in V(I')$ of $R'$ lying over $\mathfrak p$ and
$R_{\mathfrak p} \to R'_{\mathfrak p'}$ is flat. Choose a prime
$\overline{\mathfrak q}' \subset
\kappa(\mathfrak q) \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p')$
which corresponds to a prime $\mathfrak q' \subset S \otimes_R R'$ which
lies over $\mathfrak q$ and over $\mathfrak p'$. Note that
$(S \otimes_R R')_{\mathfrak q'}$ is a localization of
$S_{\mathfrak q} \otimes_{R_{\mathfrak p}} R'_{\mathfrak p'}$.
By assumption the module $(M \otimes_R R')_{\mathfrak q'}$ is
flat over $R'_{\mathfrak p'}$. Hence
Algebra, Lemma \ref{algebra-lemma-base-change-flat-up-down}
implies that $M_{\mathfrak q}$ is flat over $R_{\mathfrak p}$
which is what we wanted to prove.
\end{proof}

\begin{lemma}
\label{lemma-limit-preserving-flat-at-primes-over}
Let $R \to S$ be a ring map of finite presentation.
Let $M$ be an $S$-module of finite presentation.
Let $R' = \colim_{\lambda \in \Lambda} R_\lambda$
be a directed colimit of $R$-algebras. Let $I_\lambda \subset R_\lambda$
be ideals such that $I_\lambda R_\mu \subset I_\mu$ for all $\mu \geq \lambda$
and set $I' = \colim_\lambda I_\lambda$.
If (\ref{equation-flat-at-primes-over}) holds for
$(R' \to S \otimes_R R', I', M \otimes_R R')$, then there exists
a $\lambda \in \Lambda$ such that
(\ref{equation-flat-at-primes-over}) holds for
$(R_\lambda \to S \otimes_R R_\lambda, I_\lambda, M \otimes_R R_\lambda)$.
\end{lemma}

\begin{proof}
We are going to write $S_\lambda = S \otimes_R R_\lambda$,
$S' = S \otimes_R R'$, $M_\lambda = M \otimes_R R_\lambda$, and
$M' = M \otimes_R R'$.
The base change $S'$ is of finite presentation over $R'$ and
$M'$ is of finite presentation over $S'$ and similarly for the
versions with subscript $\lambda$, see
Algebra, Lemma \ref{algebra-lemma-base-change-finiteness}.
By
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
the set
$$
U' = \{\mathfrak q' \in \Spec(S') \mid
M'_{\mathfrak q'}\text{ is flat over }R'\}
$$
is open in $\Spec(S')$. Note that $V(I'S')$ is a quasi-compact space
which is contained in $U'$ by assumption. Hence there exist finitely many
$g'_j \in S'$, $j = 1, \ldots, m$ such that $D(g'_j) \subset U'$ and such
that $V(I'S') \subset \bigcup D(g'_j)$.
Note that in particular $(M')_{g'_j}$ is a flat module over $R'$.

\medskip\noindent
We are going to pick increasingly large elements $\lambda \in \Lambda$.
First we pick it large enough so that we can find
$g_{j, \lambda} \in S_{\lambda}$ mapping to $g'_j$.
The inclusion $V(I'S') \subset \bigcup D(g'_j)$ means that
$I'S' + (g'_1, \ldots, g'_m) = S'$ which can be expressed as
$1 = \sum z_sh_s + \sum f_jg'_j$ for some $z_s \in I'$, $h_s, f_j \in S'$.
After increasing $\lambda$ we may assume such an equation holds in
$S_\lambda$. Hence we may assume that
$V(I_\lambda S_\lambda) \subset \bigcup D(g_{j, \lambda})$. By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that for some sufficiently large $\lambda$ the modules
$(M_\lambda)_{g_{j, \lambda}}$ are flat over $R_\lambda$.
In particular the module $M_\lambda$ is flat over $R_\lambda$
at all the primes lying over the ideal $I_\lambda$.
\end{proof}









\section{Flattening over a closed subsets of source and base}
\label{section-flattening-local-source-base}

\noindent
In this section we slightly generalize the discussion in
Section \ref{section-flattening-local-base}.
We strongly suggest the reader first read and understand
that section.

\begin{situation}
\label{situation-flattening-general}
Let $R \to S$ be a ring map. Let $J \subset S$ be an ideal.
Let $M$ be an $S$-module.
\end{situation}

\noindent
In this situation, given an $R$-algebra $R'$ and an ideal $I' \subset R'$
we set $S' = S \otimes_R R'$ and $M' = M \otimes_R R'$.
We will consider the condition
\begin{equation}
\label{equation-flat-at-primes}
\forall \mathfrak q' \in V(I'S' + JS') \subset \Spec(S') :
M'_{\mathfrak q'}\text{ is flat over }R'.
\end{equation}
Geometrically, this means that $M'$ is flat over $R'$ along the intersection
of the inverse image of $V(I')$ with the inverse image of $V(J)$.
Since $(R \to S, J, M)$ are fixed, condition (\ref{equation-flat-at-primes})
only depends on the pair $(R', I')$ where $R'$ is viewed as an $R$-algebra.

\begin{lemma}
\label{lemma-base-change-flat-at-primes}
In Situation \ref{situation-flattening-general}
let $R' \to R''$ be an $R$-algebra map.
Let $I' \subset R'$ and $I'R'' \subset I'' \subset R''$ be ideals.
If (\ref{equation-flat-at-primes}) holds for
$(R', I')$, then (\ref{equation-flat-at-primes})
holds for $(R'', I'')$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes}) holds for $(R', I')$.
Let $I''S'' + JS'' \subset \mathfrak q''$ be a prime of $S''$.
Let $\mathfrak q' \subset S'$ be the corresponding prime of $S'$.
Then both $I'S' \subset \mathfrak q'$ and $JS' \subset \mathfrak q'$
because the corresponding conditions hold for $\mathfrak q''$.
Note that $(M'')_{\mathfrak q''}$
is a localization of the base change $M'_{\mathfrak q'} \otimes_R R''$.
Hence $(M'')_{\mathfrak q''}$ is flat over $R''$ as a localization
of a flat module, see
Algebra, Lemmas \ref{algebra-lemma-flat-base-change} and
\ref{algebra-lemma-flat-localization}.
\end{proof}

\begin{lemma}
\label{lemma-flat-descent-flat-at-primes}
In Situation \ref{situation-flattening-general}
let $R' \to R''$ be an $R$-algebra map.
Let $I' \subset R'$ and $I'R'' \subset I'' \subset R''$ be ideals.
Assume
\begin{enumerate}
\item the map $V(I'') \to V(I')$ induced by
$\Spec(R'') \to \Spec(R')$ is surjective, and
\item $R''_{\mathfrak p''}$ is flat over $R'$ for all primes
$\mathfrak p'' \in V(I'')$.
\end{enumerate}
If (\ref{equation-flat-at-primes}) holds for
$(R'', I'')$, then (\ref{equation-flat-at-primes}) holds for $(R', I')$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes}) holds for $(R'', I'')$. Pick a prime
$I'S' + JS' \subset \mathfrak q' \subset S'$. Let
$I' \subset \mathfrak p' \subset R'$ be the corresponding prime of $R'$.
By assumption there exists a prime $\mathfrak p'' \in V(I'')$ of $R''$
lying over $\mathfrak p'$ and $R'_{\mathfrak p'} \to R''_{\mathfrak p''}$
is flat. Choose a prime
$\overline{\mathfrak q}'' \subset
\kappa(\mathfrak q') \otimes_{\kappa(\mathfrak p')} \kappa(\mathfrak p'')$.
This corresponds to a prime $\mathfrak q'' \subset S'' = S' \otimes_{R'} R''$
which lies over $\mathfrak q'$ and over $\mathfrak p''$. In particular
we see that $I''S'' \subset \mathfrak q''$ and that
$JS'' \subset \mathfrak q''$. Note that
$(S' \otimes_{R'} R'')_{\mathfrak q''}$ is a localization of
$S'_{\mathfrak q'} \otimes_{R'_{\mathfrak p'}} R''_{\mathfrak p''}$.
By assumption the module $(M' \otimes_{R'} R'')_{\mathfrak q''}$ is
flat over $R''_{\mathfrak p''}$. Hence
Algebra, Lemma \ref{algebra-lemma-base-change-flat-up-down}
implies that $M'_{\mathfrak q'}$ is flat over $R'_{\mathfrak p'}$
which is what we wanted to prove.
\end{proof}

\begin{lemma}
\label{lemma-limit-preserving-flat-at-primes}
In Situation \ref{situation-flattening-general}
assume $R \to S$ is essentially of finite presentation
and $M$ is an $S$-module of finite presentation. Let
$R' = \colim_{\lambda \in \Lambda} R_\lambda$
be a directed colimit of $R$-algebras. Let $I_\lambda \subset R_\lambda$
be ideals such that $I_\lambda R_\mu \subset I_\mu$ for all
$\mu \geq \lambda$ and set $I' = \colim_\lambda I_\lambda$.
If (\ref{equation-flat-at-primes}) holds for
$(R', I')$, then there exists a $\lambda \in \Lambda$ such that
(\ref{equation-flat-at-primes}) holds for $(R_\lambda, I_\lambda)$.
\end{lemma}

\begin{proof}
We first prove the lemma in case $R \to S$ is of finite presentation
and then we explain what needs to be changed in the general case.
We are going to write $S_\lambda = S \otimes_R R_\lambda$,
$S' = S \otimes_R R'$, $M_\lambda = M \otimes_R R_\lambda$, and
$M' = M \otimes_R R'$.
The base change $S'$ is of finite presentation over $R'$ and
$M'$ is of finite presentation over $S'$ and similarly for the
versions with subscript $\lambda$, see
Algebra, Lemma \ref{algebra-lemma-base-change-finiteness}.
By
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
the set
$$
U' = \{\mathfrak q' \in \Spec(S') \mid
M'_{\mathfrak q'}\text{ is flat over }R'\}
$$
is open in $\Spec(S')$. Note that $V(I'S' + JS')$
is a quasi-compact space which is contained in $U'$ by assumption.
Hence there exist finitely many $g'_j \in S'$, $j = 1, \ldots, m$
such that $D(g'_j) \subset U'$ and such
that $V(I'S' + JS') \subset \bigcup D(g'_j)$.
Note that in particular $(M')_{g'_j}$ is a flat module over $R'$.

\medskip\noindent
We are going to pick increasingly large elements $\lambda \in \Lambda$.
First we pick it large enough so that we can find
$g_{j, \lambda} \in S_{\lambda}$ mapping to $g'_j$.
The inclusion $V(I'S' + JS') \subset \bigcup D(g'_j)$ means that
$I'S' + JS' + (g'_1, \ldots, g'_m) = S'$ which can be expressed as
$$
1 = \sum y_tk_t + \sum z_sh_s + \sum f_jg'_j
$$
for some $z_s \in I'$, $y_t \in J$, $k_t, h_s, f_j \in S'$.
After increasing $\lambda$ we may assume such an equation holds in
$S_\lambda$. Hence we may assume that
$V(I_\lambda S_\lambda + J S_\lambda) \subset \bigcup D(g_{j, \lambda})$. By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that for some sufficiently large $\lambda$ the modules
$(M_\lambda)_{g_{j, \lambda}}$ are flat over $R_\lambda$.
In particular the module $M_\lambda$ is flat over $R_\lambda$
at all the primes corresponding to points of
$V(I_\lambda S_\lambda + J S_\lambda)$.

\medskip\noindent
In the case that $S$ is essentially of finite presentation, we can write
$S = \Sigma^{-1}C$ where $R \to C$ is of finite presentation and
$\Sigma \subset C$ is a multiplicative subset. We can also write
$M = \Sigma^{-1}N$ for some finitely presented $C$-module $N$, see
Algebra, Lemma \ref{algebra-lemma-construct-fp-module}.
At this point we introduce $C_\lambda$, $C'$, $N_\lambda$, $N'$. Then in
the discussion above we obtain an open $U' \subset \Spec(C')$
over which $N'$ is flat over $R'$. The assumption that
(\ref{equation-flat-at-primes}) is true means that $V(I'S' + JS')$ maps
into $U'$, because for a prime $\mathfrak q' \subset S'$, corresponding
to a prime $\mathfrak r' \subset C'$ we have
$M'_{\mathfrak q'} = N'_{\mathfrak r'}$. Thus we can find
$g'_j \in C'$ such that $\bigcup D(g'_j)$ contains the image of
$V(I'S' + JS')$. The rest of the proof is exactly the same as before.
\end{proof}

\begin{lemma}
\label{lemma-flat-module-powers-variant}
In Situation \ref{situation-flattening-general}.
Let $I \subset R$ be an ideal. Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $M$ is a finite $S$-module, and
\item for each $n \geq 1$ and any prime
$\mathfrak q \in V(J + IS)$ the module $(M/I^n M)_{\mathfrak q}$
is flat over $R/I^n$.
\end{enumerate}
Then (\ref{equation-flat-at-primes}) holds for $(R, I)$, i.e.,
for every prime $\mathfrak q \in V(J + IS)$
the localization $M_{\mathfrak q}$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $\mathfrak q \in V(J + IS)$. Then
Algebra, Lemma \ref{algebra-lemma-flat-module-powers}
applied to $R \to S_{\mathfrak q}$ and $M_{\mathfrak q}$
implies that $M_{\mathfrak q}$ is flat over $R$.
\end{proof}










\section{Flattening over a Noetherian complete local ring}
\label{section-flattening-Noetherian-complete-local}

\noindent
The following three lemmas give a completely algebraic proof of the existence
of the ``local'' flattening stratification when the base is a complete
local Noetherian ring $R$ and the given module is finite over a finite
type $R$-algebra $S$.

\begin{lemma}
\label{lemma-flattening-complete-local-noetherian}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $(R, \mathfrak m)$ is a complete local Noetherian ring,
\item $S$ is a Noetherian ring, and
\item $M$ is finite over $S$.
\end{enumerate}
Then there exists an ideal $I \subset \mathfrak m$ such that
\begin{enumerate}
\item $(M/IM)_{\mathfrak q}$ is flat over $R/I$ for all
primes $\mathfrak q$ of $S/IS$ lying over $\mathfrak m$, and
\item if $J \subset R$ is an ideal such that $(M/JM)_{\mathfrak q}$
is flat over $R/J$ for all primes $\mathfrak q$ lying over
$\mathfrak m$, then $I \subset J$.
\end{enumerate}
In other words, $I$ is the smallest ideal of $R$ such that
(\ref{equation-flat-at-primes-over}) holds for
$(\overline{R} \to \overline{S}, \overline{\mathfrak m}, \overline{M})$
where $\overline{R} = R/I$, $\overline{S} = S/IS$,
$\overline{\mathfrak m} = \mathfrak m/I$ and $\overline{M} = M/IM$.
\end{lemma}

\begin{proof}
Let $J \subset R$ be an ideal. Apply
Algebra, Lemma \ref{algebra-lemma-flat-module-powers}
to the module $M/JM$ over the ring $R/J$.
Then we see that $(M/JM)_{\mathfrak q}$
is flat over $R/J$ for all primes $\mathfrak q$ of $S/JS$
if and only if $M/(J + \mathfrak m^n)M$ is flat over
$R/(J + \mathfrak m^n)$ for all $n \geq 1$.
We will use this remark below.

\medskip\noindent
For every $n \geq 1$ the local ring $R/\mathfrak m^n$ is Artinian.
Hence, by
Lemma \ref{lemma-flattening-artinian}
there exists a smallest ideal $I_n \supset \mathfrak m^n$ such that
$M/I_nM$ is flat over $R/I_n$. It is clear that $I_{n + 1} + \mathfrak m^n$
is contains $I_n$ and applying
Lemma \ref{lemma-intersection-flat}
we see that $I_n = I_{n + 1} + \mathfrak m^n$. Since
$R = \lim_n\ R/\mathfrak m^n$ we see that $I = \lim_n\ I_n/\mathfrak m^n$
is an ideal in $R$ such that $I_n = I + \mathfrak m^n$ for all $n \geq 1$.
By the initial remarks of the proof we see that $I$ verifies (1)
and (2). Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-noetherian-property-by-finite-type}
With notation $R \to S$, $M$, and $I$ and assumptions as in
Lemma \ref{lemma-flattening-complete-local-noetherian}.
Consider a local homomorphism of local rings
$\varphi : (R, \mathfrak m) \to (R', \mathfrak m')$
such that $R'$ is Noetherian. Then the following are equivalent
\begin{enumerate}
\item condition (\ref{equation-flat-at-primes-over}) holds
for $(R' \to S \otimes_R R', \mathfrak m', M \otimes_R R')$, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-base-change-flat-at-primes-over}.
Let $\varphi : R \to R'$ be as in the lemma satisfying (1).
We have to show that $\varphi(I) = 0$.
This is equivalent to the condition that $\varphi(I)R' = 0$.
By Artin-Rees in the Noetherian local ring $R'$ (see
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero})
this is equivalent to the condition that
$\varphi(I)R' + (\mathfrak m')^n = (\mathfrak m')^n$ for all $n > 0$.
Hence this is equivalent to the condition that the composition
$\varphi_n : R \to R' \to R'/(\mathfrak m')^n$ annihilates $I$ for each $n$.
Now assumption (1) for $\varphi$ implies assumption (1) for
$\varphi_n$ by
Lemma \ref{lemma-base-change-flat-at-primes-over}.
This reduces us to the case where $R'$ is Artinian local.

\medskip\noindent
Assume $R'$ Artinian. Let $J = \text{Ker}(\varphi)$. We have to show that
$I \subset J$. By the construction of $I$ in
Lemma \ref{lemma-flattening-complete-local-noetherian}
it suffices to show that $(M/JM)_{\mathfrak q}$ is flat over $R/J$
for every prime $\mathfrak q$ of $S/JS$ lying over $\mathfrak m$.
As $R'$ is Artinian, condition (1) signifies that $M \otimes_R R'$
is flat over $R'$. As $R'$ is Artinian and $R/J \to R'$ is a local
injective ring map, it follows that $R/J$ is Artinian
too. Hence the flatness of $M \otimes_R R' = M/JM \otimes_{R/J} R'$ over
$R'$ implies that $M/JM$ is flat over $R/J$ by
Algebra,
Lemma \ref{algebra-lemma-descent-flatness-injective-map-artinian-rings}.
This concludes the proof.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-universal-property}
With notation $R \to S$, $M$, and $I$ and assumptions as in
Lemma \ref{lemma-flattening-complete-local-noetherian}.
In addition assume that $R \to S$ is of finite type.
Then for any local homomorphism of local rings
$\varphi : (R, \mathfrak m) \to (R', \mathfrak m')$
the following are equivalent
\begin{enumerate}
\item condition (\ref{equation-flat-at-primes-over}) holds
for $(R' \to S \otimes_R R', \mathfrak m', M \otimes_R R')$, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-base-change-flat-at-primes-over}.
Let $\varphi : R \to R'$ be as in the lemma satisfying (1).
As $R$ is Noetherian we see that $R \to S$ is of finite presentation
and $M$ is an $S$-module of finite presentation.
Write $R' = \colim_\lambda R_\lambda$
as a directed colimit of local $R$-subalgebras $R_\lambda \subset R'$,
with maximal ideals $\mathfrak m_\lambda = R_\lambda \cap \mathfrak m'$
such that each $R_\lambda$ is essentially of finite type over $R$. By
Lemma \ref{lemma-limit-preserving-flat-at-primes-over}
we see that condition (\ref{equation-flat-at-primes-over}) holds for
$(R_\lambda \to S \otimes_R R_\lambda, \mathfrak m_\lambda,
M \otimes_R R_\lambda)$ for some $\lambda$. Hence
Lemma \ref{lemma-flattening-complete-local-noetherian-property-by-finite-type}
applies to the ring map $R \to R_\lambda$ and we see that
$I$ maps to zero in $R_\lambda$, a fortiori it maps to zero in $R'$.
\end{proof}




\section{Descent flatness along integral maps}
\label{section-descent-flatness-integral}

\noindent
First a few simple lemmas.

\begin{lemma}
\label{lemma-have-one-root}
Let $R$ be a ring. Let $P(T)$ be a monic polynomial with coefficients
in $R$. If there exists an $\alpha \in R$ such that $P(\alpha) = 0$, then
$P(T) = (T - \alpha)Q(T)$ for some monic polynomial $Q(T) \in R[T]$.
\end{lemma}

\begin{proof}
By induction on the degree of $P$. If $\deg(P) = 1$, then
$P(T) = T - \alpha$ and the result is true. If $\deg(P) > 1$, then
we can write $P(T) = (T - \alpha)Q(T) + r$ for some polynomial
$Q \in R[T]$ of degree $< \deg(P)$ and some $r \in R$ by long
division. By assumption $0 = P(\alpha) = (\alpha - \alpha)Q(\alpha) + r = r$
and we conclude that $r = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-adjoin-one-root}
Let $R$ be a ring. Let $P(T)$ be a monic polynomial with coefficients
in $R$. There exists a finite free ring map $R \to R'$ such that
$P(T) = (T - \alpha)Q(T)$ for some $\alpha \in R'$ and some
monic polynomial $Q(T) \in R'[T]$.
\end{lemma}

\begin{proof}
Write $P(T) = T^d + a_1T^{d - 1} + \ldots + a_0$.
Set $R' = R[x]/(x^d + a_1x^{d - 1} + \ldots + a_0)$.
Set $\alpha$ equal to the congruence class of $x$.
Then it is clear that $P(\alpha) = 0$. Thus we win by
Lemma \ref{lemma-have-one-root}.
\end{proof}

\begin{lemma}
\label{lemma-finite-split}
Let $R \to S$ be a finite ring map.
There exists a finite free ring extension $R \subset R'$ such
that $S \otimes_R R'$ is a quotient of a ring of the form
$$
R'[T_1, \ldots, T_n]/(P_1(T_1), \ldots, P_n(T_n))
$$
with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$ for some
$\alpha_{ij} \in R'$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n \in S$ be generators of $S$ over $R$.
For each $i$ we can choose a monic polynomial $P_i(T) \in R[T]$
such that $P(x_i) = 0$ in $S$, see
Algebra, Lemma \ref{algebra-lemma-finite-is-integral}.
Say $\deg(P_i) = d_i$. By
Lemma \ref{lemma-adjoin-one-root}
(applied $\sum d_i$ times) there exists a finite free ring
extension $R \subset R'$ such that each $P_i$ splits completely:
$$
P_i(T) = \prod\nolimits_{j = 1, \ldots, d_i} (T - \alpha_{ij})
$$
for certain $\alpha_{ik} \in R'$. Let
$R'[T_1, \ldots, T_n] \to S \otimes_R R'$ be the $R'$-algebra map
which maps $T_i$ to $x_i \otimes 1$. As this maps $P_i(T_i)$ to zero,
this induces the desired surjection.
\end{proof}

\begin{lemma}
\label{lemma-split-image}
Let $R$ be a ring.
Let $S = R[T_1, \ldots, T_n]/J$.
Assume $J$ contains elements of the form $P_i(T_i)$
with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$ for some
$\alpha_{ij} \in R$. For $\underline{k} = (k_1, \ldots, k_n)$
with $1 \leq k_i \leq d_i$ consider the ring map
$$
\Phi_{\underline{k}} : R[T_1, \ldots, T_n] \to R,
\quad
T_i \longmapsto \alpha_{ik_i}
$$
Set $J_{\underline{k}} = \Phi_{\underline{k}}(J)$.
Then the image of $\Spec(S) \to \Spec(R)$ is equal to
$V(\bigcap J_{\underline{k}})$.
\end{lemma}

\begin{proof}
This lemma proves itself. Hint:
$V(\bigcap J_{\underline{k}}) = \bigcup V(J_{\underline{k}})$.
\end{proof}

\noindent
The following result is due to Ferrand, see \cite{Ferrand}.

\begin{lemma}
\label{lemma-descent-flatness-injective-finite-Noetherian-rings}
Let $R \to S$ be a finite injective homomorphism of Noetherian rings.
Let $M$ be an $R$-module. If $M \otimes_R S$ is a flat $S$-module,
then $M$ is a flat $R$-module.
\end{lemma}

\begin{proof}
Let $M$ be an $R$-module such that $M \otimes_R S$ is flat over $S$. By
Algebra, Lemma \ref{algebra-lemma-flatness-descends}
in order to prove that $M$ is flat we may replace $R$ by any faithfully flat
ring extension. By
Lemma \ref{lemma-finite-split}
we can find a finite locally free ring extension $R \subset R'$ such
that $S' = S \otimes_R R' = R'[T_1, \ldots, T_n]/J$ for some ideal
$J \subset R'[T_1, \ldots, T_n]$ which contains the  elements of the form
$P_i(T_i)$ with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$
for some $\alpha_{ij} \in R'$. Note that $R'$ is Noetherian
and that $R' \subset S'$ is a finite extension of rings. Hence we may
replace $R$ by $R'$ and assume that $S$ has a presentation as in
Lemma \ref{lemma-split-image}.
Note that $\Spec(S) \to \Spec(R)$ is surjective, see
Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective}.
Thus, using
Lemma \ref{lemma-split-image}
we conclude that $I = \bigcap J_{\underline{k}}$ is an ideal
such that $V(I) = \Spec(R)$. This means that
$I \subset \sqrt{(0)}$, and since $R$ is Noetherian that $I$
is nilpotent. The maps $\Phi_{\underline{k}}$ induce commutative
diagrams
$$
\xymatrix{
S \ar[rr] & & R/J_{\underline{k}} \\
& R \ar[lu] \ar[ru]
}
$$
from which we conclude that $M/J_{\underline{k}}M$ is flat over
$R/J_{\underline{k}}$. By
Lemma \ref{lemma-intersection-flat}
we see that $M/IM$ is flat over $R/I$. Finally, applying
Algebra, Lemma \ref{algebra-lemma-lift-flatness}
we conclude that $M$ is flat over $R$.
\end{proof}

\begin{lemma}
\label{lemma-descent-flatness-injective-integral}
Let $R \to S$ be an injective integral ring map.
Let $M$ be a finitely presented module over $R[x_1, \ldots, x_n]$.
If $M \otimes_R S$ is flat over $S$, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
R[x_1, \ldots, x_n]^{\oplus t} \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Let's say that the first map is given by the $r \times t$-matrix
$T = (f_{ij})$ with $f_{ij} \in R[x_1, \ldots, x_n]$. Write
$f_{ij} = \sum f_{ij, I} x^I$ with $f_{ij, I} \in R$ (multi-index notation).
Consider diagrams
$$
\xymatrix{
R \ar[r] & S \\
R_\lambda \ar[u] \ar[r] & S_\lambda \ar[u]
}
$$
where $R_\lambda$ is a finitely generated $\mathbf{Z}$-subalgebra of
$R$ containing all $f_{ij, I}$ and $S_\lambda$ is a finite
$R_\lambda$-subalgebra of $S$. Let $M_\lambda$ be the finite
$R_\lambda[x_1, \ldots, x_n]$-module defined by a presentation
as above, using the same matrix $T$ but now viewed as a matrix
over $R_\lambda[x_1, \ldots, x_n]$. Note that $S$ is the directed colimit
of the $S_\lambda$ (details omitted). By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that for some $\lambda$ the module
$M_\lambda \otimes_{R_\lambda} S_\lambda$ is flat over $S_\lambda$. By
Lemma \ref{lemma-descent-flatness-injective-finite-Noetherian-rings}
we conclude that $M_\lambda$ is flat over $R_\lambda$. Since
$M = M_\lambda \otimes_{R_\lambda} R$ we win by
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
\end{proof}




\section{Torsion and flatness}
\label{section-torsion-flat}

\noindent
In this section we discuss the relationship between torsion and flatness.

\begin{definition}
\label{definition-torsion}
Let $R$ be a domain. Let $M$ be an $R$-module.
\begin{enumerate}
\item We say an element $x \in M$ is {\it torsion} if there exists
a nonzero $f \in R$ such that $fx = 0$.
\item We say $M$ is {\it torsion free} if the only torsion element of $M$
is $0$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-torsion}
Let $R$ be a domain. Let $M$ be an $R$-module.
The set of torsion elements of $M$ forms a submodule $M_{tors} \subset M$.
The quotient module $M/M_{tors}$ is torsion free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-flat-torsion-free}
Let $R$ be a domain. Any flat $R$-module is torsion free.
\end{lemma}

\begin{proof}
If $x \in R$ is nonzero, then $x : R \to R$ is injective, and hence if $M$
is flat over $R$, then $x : M \to M$ is injective. Thus if $M$ is flat over
$R$, then $M$ is torsion free.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-torsion-free-flat}
Let $A$ be a valuation ring.
An $A$-module $M$ is flat over $A$ if and only if $M$ is torsion free.
\end{lemma}

\begin{proof}
The implication ``flat $\Rightarrow$ torsion free'' is
Lemma \ref{lemma-flat-torsion-free}.
For the converse, assume $M$ is torsion free.
By the equational criterion of flatness (see
Algebra, Lemma \ref{algebra-lemma-flat-eq})
we have to show that every relation in $M$ is trivial. To do this assume that
$\sum_{i = 1, \ldots, n} a_i x_i = 0$ with $x_i \in M$ and $f_i \in A$.
After renumbering we may assume that $v(a_1) \leq v(a_i)$ for all $i$.
Hence we can write $a_i = a'_i a_1$ for some $a'_i \in A$. Note that
$a'_1 = 1$. As $A$ is torsion free we see that
$x_1 = - \sum_{i \geq 2} a'_i x_i$. Thus, if we choose
$y_i = x_i$, $i = 2, \ldots, n$ then
$$
x_1 = \sum\nolimits_{j \geq 2} -a'_j y_j, \quad
x_i = y_i, (i \geq 2)\quad
0 = a_1 \cdot (-a'_j) + a_j \cdot 1 (j \geq 2)
$$
shows that the relation was trivial (to be explicit the elements
$a_{ij}$ are defined by setting $a_{1j} = -a'_j$ and $a_{ij} = \delta_{ij}$
for $i, j \geq 2$).
\end{proof}






\section{Flatness and finiteness conditions}
\label{section-flat-finite}

\noindent
In this section we discuss some implications of the type
``flat $+$ finite type $\Rightarrow$ finite presentation''.
We will revisit this result in the chapter on flatness, see
More on Flatness, Section \ref{flat-section-introduction}.
A first result of this type was proved in
Algebra, Lemma \ref{algebra-lemma-finite-flat-module-finitely-presented}.

\begin{lemma}
\label{lemma-flat-finite-type-finite-presentation-local-module}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]$ be a polynomial
ring over $R$. Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item there exist finitely many primes $\mathfrak p_1, \ldots, \mathfrak p_m$
of $R$ such that the map $R \to \prod R_{\mathfrak p_j}$ is injective,
\item $M$ is a finite $S$-module,
\item $M$ flat over $R$, and
\item for every prime $\mathfrak p$ of $R$ the module $M_{\mathfrak p}$
is of finite presentation over $S_{\mathfrak p}$.
\end{enumerate}
Then $M$ is of finite presentation over $S$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
0 \to K \to S^{\oplus r} \to M \to 0
$$
of $M$ as an $S$-module. Let $\mathfrak q$ be a prime ideal of $S$
lying over a prime $\mathfrak p$ of $R$. By assumption there exist
finitely many elements $k_1, \ldots, k_t \in K$ such that if we set
$K' = \sum Sk_j \subset K$ then
$K'_{\mathfrak p} = K_{\mathfrak p}$ and
$K'_{\mathfrak p_j} = K_{\mathfrak p_j}$ for $j = 1, \ldots, m$.
Setting $M' = S^{\oplus r}/K'$ we deduce that in particular
$M'_{\mathfrak q} = M_{\mathfrak q}$. By openness of flatness, see
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
we conclude that there exists a $g \in S$, $g \not \in \mathfrak q$
such that $M'_g$ is flat over $R$. Thus $M'_g \to M_g$ is a surjective
map of flat $R$-modules. Consider the commutative diagram
$$
\xymatrix{
M'_g \ar[r] \ar[d] & M_g \ar[d] \\
\prod (M'_g)_{\mathfrak p_j} \ar[r] & \prod (M_g)_{\mathfrak p_j}
}
$$
The bottom arrow is an isomorphism by choice of $k_1, \ldots, k_t$.
The left vertical arrow is an injective map as
$R \to \prod R_{\mathfrak p_j}$ is injective and $M'_g$ is flat over $R$.
Hence the top horizontal arrow is injective, hence an isomorphism.
This proves that $M_g$ is of finite presentation over $S_g$.
We conclude by applying
Algebra, Lemma \ref{algebra-lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-type-finite-presentation-local}
Let $R \to S$ be a ring homomorphism.
Assume
\begin{enumerate}
\item there exist finitely many primes
$\mathfrak p_1, \ldots, \mathfrak p_m$ of $R$ such that
the map $R \to \prod R_{\mathfrak p_j}$ is injective,
\item $R \to S$ is of finite type,
\item $S$ flat over $R$, and
\item for every prime $\mathfrak p$ of $R$ the ring $S_{\mathfrak p}$
is of finite presentation over $R_{\mathfrak p}$.
\end{enumerate}
Then $S$ is of finite presentation over $R$.
\end{lemma}

\begin{proof}
By assumption $S$ is a quotient of a polynomial ring over $R$.
Thus the result follows directly from
Lemma \ref{lemma-flat-finite-type-finite-presentation-local-module}.
\end{proof}

\begin{lemma}
\label{lemma-flat-graded-finite-type-finite-presentation-module}
Let $R$ be a ring.
Let $S = R[x_1, \ldots, x_n]$ be a graded polynomial algebra over $R$,
i.e., $\deg(x_i) > 0$ but not necessarily equal to $1$.
Let $M$ be a graded $S$-module.
Assume
\begin{enumerate}
\item $R$ is a local ring,
\item $M$ is a finite $S$-module, and
\item $M$ is flat over $R$.
\end{enumerate}
Then $M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
Let $M = \bigoplus M_d$ be the grading on $M$.
Pick homogeneous generators $m_1, \ldots, m_r \in M$ of $M$.
Say $\deg(m_i) = d_i \in \mathbf{Z}$. This gives us a presentation
$$
0 \to K \to \bigoplus\nolimits_{i = 1, \ldots, r} S(-d_i) \to M \to 0
$$
which in each degree $d$ leads to the short exact sequence
$$
0 \to K_d \to \bigoplus\nolimits_{i = 1, \ldots, r} S_{d - d_i} \to
M_d \to 0.
$$
By assumption each $M_d$ is a finite flat $R$-module. By
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
this implies each $M_d$ is a finite free $R$-module. Hence
we see each $K_d$ is a finite $R$-module. Also each $K_d$ is flat
over $R$ by
Algebra, Lemma \ref{algebra-lemma-flat-ses}.
Hence we conclude that each $K_d$ is finite free by
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
again.

\medskip\noindent
Let $\mathfrak m$ be the maximal ideal of $R$. By the flatness of $M$
over $R$ the short exact sequences above remain short exact after tensoring
with $\kappa = \kappa(\mathfrak m)$. As the ring $S \otimes_R \kappa$ is
Noetherian we see that there exist homogeneous elements
$k_1, \ldots, k_t \in K$ such that the images $\overline{k}_j$
generate $K \otimes_R \kappa$ over $S \otimes_R \kappa$. Say $\deg(k_j) = e_j$.
Thus for any $d$ the map
$$
\bigoplus\nolimits_{j = 1, \ldots, t} S_{d - e_j}
\longrightarrow
K_d
$$
becomes surjective after tensoring with $\kappa$. By
Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
this implies the map is surjective over $R$. Hence $K$ is generated
by $k_1, \ldots, k_t$ over $S$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-flat-graded-finite-type-finite-presentation}
Let $R$ be a ring. Let $S = \bigoplus_{n \geq 0} S_n$ be a graded $R$-algebra.
Let $M = \bigoplus_{d \in \mathbf{Z}} M_d$ be a graded $S$-module.
Assume $S$ is finitely generated as an $R$-algebra, assume $S_0$ is a finite
$R$-algebra, and assume there exist finitely many primes
$\mathfrak p_j$, $i = 1, \ldots, m$ such that
$R \to \prod R_{\mathfrak p_j}$ is injective.
\begin{enumerate}
\item If $S$ is flat over $R$, then $S$ is a finitely presented $R$-algebra.
\item If $M$ is flat as an $R$-module and finite as an $S$-module,
then $M$ is finitely presented as an $S$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
As $S$ is finitely generated as an $R$-algebra, it is finitely generated
as an $S_0$ algebra, say by homogeneous elements $t_1, \ldots, t_n \in S$
of degrees $d_1, \ldots, d_n > 0$. Set $P = R[x_1, \ldots, x_n]$ with
$\deg(x_i) = d_i$. The ring map $P \to S$, $x_i \to t_i$ is finite
as $S_0$ is a finite $R$-module. To prove (1) it suffices to prove
that $S$ is a finitely presented $P$-module.  To prove (2) it suffices
to prove that $M$ is a finitely presented $P$-module. Thus it suffices
to prove that if $S = P$ is a graded polynomial ring and $M$ is a finite
$S$-module flat over $R$, then $M$ is finitely presented as an $S$-module. By
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation-module}
we see $M_{\mathfrak p}$ is a finitely presented $S_{\mathfrak p}$-module
for every prime $\mathfrak p$ of $R$. Thus the result follows from
Lemma \ref{lemma-flat-finite-type-finite-presentation-local-module}.
\end{proof}

\begin{remark}
\label{remark-when-does-condition-hold}
Let $R$ be a ring. When does $R$ satisfy the condition mentioned in
Lemmas \ref{lemma-flat-finite-type-finite-presentation-local-module},
\ref{lemma-flat-finite-type-finite-presentation-local}, and
\ref{lemma-flat-graded-finite-type-finite-presentation}?
This holds if
\begin{enumerate}
\item $R$ is local,
\item $R$ is Noetherian,
\item $R$ is a domain,
\item $R$ is a reduced ring with finitely many minimal primes, or
\item $R$ has finitely many weakly associated primes, see
Algebra, Lemma \ref{algebra-lemma-zero-at-weakly-ass-zero}.
\end{enumerate}
Thus these lemmas hold in all cases listed above.
\end{remark}

\noindent
The following lemma wil be improved below, see
Proposition \ref{proposition-flat-finite-type-finite-presentation-domain}.

\begin{lemma}
\label{lemma-flat-finite-type-valuation-ring-finite-presentation}
Let $A$ be a valuation ring. Let $A \to B$ be a ring map of finite type.
Let $M$ be a finite $B$-module.
\begin{enumerate}
\item If $B$ is flat over $A$, then $B$ is a finitely presented $A$-algebra.
\item If $M$ is flat as an $A$-module, then $M$ is finitely presented
as a $B$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We are going to use that an $A$-module is flat if and only if it is
torsion free, see
Lemma \ref{lemma-valuation-ring-torsion-free-flat}.
By
Algebra, Lemma \ref{algebra-lemma-homogenize}
we can find a graded $A$-algebra $S$ with $S_0 = A$ and generated
by finitely many elements in degree $1$, an element $f \in S_1$ and a
finite graded $S$-module $N$ such that $B \cong S_{(f)}$ and
$M \cong N_{(f)}$. If $M$ is torsion free, then we can take $N$ torsion
free by replacing it by $N/N_{tors}$, see
Lemma \ref{lemma-torsion}.
Similarly, if $B$ is torsion free, then we can take
$S$ torsion free by replacing it by $S/S_{tors}$.
Hence in case (1), we may apply
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation}
to see that $S$ is a finitely presented
$A$-algebra, which implies that $B = S_{(f)}$ is a finitely
presented $A$-algebra. To see (2) we may first replace $S$ by
a graded polynomial ring, and then we may apply
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation-module}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-helper-finite-type-flat-finite-presentation}
Let $R$ be a domain with fraction field $K$.
Let $S = R[x_1, \ldots, x_n]$ be a polynomial ring over $R$.
Let $M$ be a finite $S$-module. Assume that $M$ is flat over $R$.
If for every subring $R \subset R' \subset K$, $R \not = R'$
the module $M \otimes_R R'$ is finitely presented
over $S \otimes_R R'$, then $M$ is finitely presented over $S$.
\end{lemma}

\begin{proof}
Suppose that $f_1, \ldots, f_n \in R$ are elements which generate the
unit ideal. If $R \not = R_{f_i}$ for each $i = 1, \ldots, n$, then
we conclude that $M_{f_i}$ is finitely presented over
$S_{f_i}$ for each $i$, and hence $M$ is finitely presented over $S$ by
Algebra, Lemma \ref{algebra-lemma-cover}.
Thus we are done if such a sequence of elements exists.
Assume this is not the case. In particular, for every $x \in R$ we
have either $x \in R^*$, or $1 - x \in R^*$. This implies that $R$ is
local, see
Algebra, Lemma \ref{algebra-lemma-characterize-local-ring}.

\medskip\noindent
Choose a presentation
$$
0 \to K \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Throughout the rest of the proof we will use that this sequence stays exact
after tensoring with any $R$-algebra, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Let $R'$ be the integral closure of $R$ in its fraction field.
If $R \not = R'$, then we see that $M \otimes_R R'$ is finitely presented over
$R'[x_1, \ldots, x_n]$. In particular, the module $K \otimes_R R'$
is finitely generated. Thus we may pick $k_1, \ldots, k_t \in K$ such that
$k_1 \otimes 1, \ldots, k_t \otimes 1$ generate $K \otimes_R R'$.
Set $K' = \sum R[x_1, \ldots, x_n]k_i \subset K$. Set
$M' = R[x_1, \ldots, x_n]^{\oplus t}/K'$. Then $M'$ is a finitely presented
module over $R[x_1, \ldots, x_n]$ such that
$M' \otimes_R R' \cong M \otimes_R R'$ is flat over $R'$. By
Lemma \ref{lemma-descent-flatness-injective-integral}
we conclude that $M'$ is flat over $R$. Hence the surjective
map $M' \to M$ is also injective as $M'$ is torsion free, see
Lemma \ref{lemma-flat-torsion-free}.
In other words, $M' \cong M$ and we conclude that $M$ is finitely presented.
Thus we are done if $R$ is not a normal domain.
Assume this is not the case. This reduces us to the case where $R$ is
a normal local domain.

\medskip\noindent
Pick any pair of nonzero elements $x, y \in R$. Consider the inclusions
$R \subset R[x/y]$ and $R[y/x]$. As $R$ is a normal domain we get a short
exact sequence
$$
0 \to R \xrightarrow{(-1, 1)} R[x/y] \oplus R[y/x] \xrightarrow{(1, 1)}
R[x/y, y/x] \to 0
$$
see
Algebra, Lemma \ref{algebra-lemma-silly-normal}.
If $R \not = R[x/y]$ and $R \not = R[y/x]$ then we see that
$K \otimes_R R[x/y]$ and $K \otimes_R R[y/x]$ are finitely generated
as $R[x/y][x_1, \ldots, x_n]$ and $R[y/x][x_1, \ldots, x_n]$ modules.
Thus we can find $k_1, \ldots, k_t \in K$ such that the elements
$k_i \otimes 1$ generate
$K \otimes_R R[x/y]$ and $K \otimes_R R[y/x]$ as $R[x/y][x_1, \ldots, x_n]$
and $R[y/x][x_1, \ldots, x_n]$ modules.
Set $K' = \sum R[x_1, \ldots, x_n]k_i \subset K$. Tensoring the sequence
above with $K' \subset K$ we get the diagram
$$
\xymatrix{
 &
K' \ar[d] \ar[r] &
K' \otimes_R R[x/y] \oplus K' \otimes_R R[y/x] \ar[d] \ar[r] &
K' \otimes_R R[x/y, y/x] \ar[d] \ar[r] &
0 \\
0 \ar[r] &
K \ar[r] &
K \otimes_R R[x/y] \oplus K \otimes_R R[y/x] \ar[r] &
K \otimes_R R[x/y, y/x] \ar[r] &
0
}
$$
Now we know that the vertical arrows in the middle and on the right
are isomorphisms. The lower row is exact as $K$ is flat over $R$.
Hence the left vertical arrow is surjective, i.e., an isomorphism.
Thus we win if there exists a pair of nonzero elements such that
neither $x/y$ nor $y/x$ is an element of $R$. Assume this is not the case.
Then we know that $R \subset f.f.(R)$ is a normal local domain such
that for every $x \in f.f.(R)$ either $x \in R$, or $x^{-1} \in R$.
In other words, $R$ is a valuation ring, see
Algebra, Lemma \ref{algebra-lemma-x-or-x-inverse-valuation-ring}.
In this case $M$ is finitely presented by
Lemma \ref{lemma-flat-finite-type-valuation-ring-finite-presentation}
and we win.
\end{proof}

\noindent
The following result is a special case of results in \cite{GruRay}
which we discuss in great detail in
More on Flatness, Section \ref{flat-section-introduction}.

\begin{proposition}
\label{proposition-flat-finite-type-finite-presentation-domain}
Let $R$ be a domain.
Let $R \to S$ be a ring map of finite type.
Let $M$ be a finite $S$-module.
\begin{enumerate}
\item If $S$ is flat over $R$, then $S$ is a finitely presented $R$-algebra.
\item If $M$ is flat as an $R$-module, then $M$ is finitely presented
as a $S$-module.
\end{enumerate}
\end{proposition}

\begin{proof}
It suffices to prove part (2) in case $S = R[x_1, \ldots, x_n]$.
Choose a presentation
$$
0 \to K \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Throughout the rest of the proof we will use that this sequence stays exact
after tensoring with any $R$-algebra, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Let $L$ be the fraction field of $R$.
Consider the set
$$
\mathcal{R} = \{R' \mid
R \subset R' \subset L
\text{ and }
M \otimes_R R'
\text{ not of finite presentation over }
S \otimes_R R'\}
$$
We order $\mathcal{R}$ by inclusion. Suppose that
$\{R_i\}_{i \in I}$ is a totally ordered subset of $\mathcal{R}$.
Set $R_{\infty} = \bigcup_{i \in I} R_i$.
We claim that $R_\infty \in \mathcal{R}$.
Namely, if $M \otimes_R R_{\infty}$ is finitely presented over
$S \otimes_R R_\infty$, then $K \otimes_R R_\infty$ is finitely
generated, say by $k_1, \ldots, k_t$. Then for some $i\in I$
we have $k_1, \ldots, k_t \in K \otimes_R R_i$. For any
$i' \geq i$ set
$M_{i'} = R_i[x_1, \ldots, x_n]^{\oplus r}/\sum R_i[x_1, \ldots, x_n]k_i$.
By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that $M_{i'}$ is flat over $R_i$ for some sufficiently large
$i' \in I$. For such an $i'$ the surjective map
$M_{i'} \to M \otimes_R R_i$ is also injective as
$M_{i'}$ is torsion free. Hence we conclude that
$M \otimes_R R_i$ is finitely presented which is a contradiction.
In other words $R_\infty \in \mathcal{R}$.
This shows that Zorn's lemma applies to $\mathcal{R}$ if $\mathcal{R}$
is not empty. But
Lemma \ref{lemma-helper-finite-type-flat-finite-presentation}
shows that $\mathcal{R}$ does not have any maximal elements and the
proposition is proved.
\end{proof}




\section{Blowing up and flatness}
\label{section-blowup-flat}

\noindent
In this section we begin our discussion of results of the form: ``After a
blow up the strict transform becomes flat''. More results of this type may
be found in More on Flatness, Section \ref{flat-section-blowup-flat}.

\begin{definition}
\label{definition-strict-transform}
Let $R$ be a domain. Let $M$ be an $R$-module. Let $R \subset R'$ be an
extension of domains. The {\it strict transform of $M$ along
$R \to R'$}\footnote{This is somewhat nonstandard notation.} is
the torsion free $R'$-module
$$
M' = (M \otimes_R R')/(M \otimes_R R')_{tors}.
$$
\end{definition}

\noindent
The following is a very weak version of flattening by blowing up, but
it is already sometimes a useful result.

\begin{lemma}
\label{lemma-flatten-on-affine-blowup}
Let $(R, \mathfrak m)$ be a local domain with fraction field $K$.
Let $S$ be a finite type $R$-algebra.
Let $M$ be a finite $S$-module.
For every valuation ring $A \subset K$ dominating $R$
there exists an ideal $I \subset \mathfrak m$ and a nonzero
element $a \in I$ such that
\begin{enumerate}
\item $I$ is finitely generated,
\item $A$ has center on $R[\frac{I}{a}]$,
\item the fibre ring of $R \to R[\frac{I}{a}]$ at $\mathfrak m$
is not zero, and
\item the strict transform $S_{I, a}$ of $S$ along $R \to R[\frac{I}{a}]$
is flat and of finite presentation over $R$, and the strict transform
$M_{I, a}$ of $M$ along $R \to R[\frac{I}{a}]$ is flat over $R$ and
finitely presented over $S_{I, a}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the assertion makes sense as $R[\frac{I}{a}]$
is a domain, and $R \to R[\frac{I}{a}]$ is injective, see
Algebra, Lemmas \ref{algebra-lemma-blowup-domain} and
\ref{algebra-lemma-blowup-dominant}.
Before we start the proof of the Lemma, note that there is
no loss in generality assuming that $S = R[x_1, \ldots, x_n]$
is a polynomial ring over $R$. We also fix a presentation
$$
0 \to K \to S^{\oplus r} \to M \to 0.
$$
Let $M_A$ be the strict transform of $M$ along $R \to A$. It is a finite
module over $S_A = A[x_1, \ldots, x_n]$. By
Lemma \ref{lemma-valuation-ring-torsion-free-flat}
we see that $M_A$ is flat over $A$. By
Lemma \ref{lemma-flat-finite-type-valuation-ring-finite-presentation}
we see that $M_A$ is finitely presented. Hence there exist finitely many
elements $k_1, \ldots, k_t \in S_A^{\oplus r}$ which generate the
kernel of the presentation $S_A^{\oplus r} \to M_A$ as
an $S_A$-module. For any choice of $a \in I \subset \mathfrak m$
satisfying (1), (2), and (3) we denote $M_{I, a}$ the strict transform of
$M$ along $R \to R[\frac{I}{a}]$. It is a finite module over
$S_{I, a} = R[\frac{I}{a}][x_1, \ldots, x_n]$. By
Algebra, Lemma \ref{algebra-lemma-valuation-ring-colimit-affine-blowups}
we have $A = \colim_{I, a} R[\frac{I}{a}]$.
This implies that $S_A = \colim S_{I, a}$ and
$M_A = \colim_{I, a} M_{I, a}$.
Thus we may choose $a \in I \subset R$ such that
$k_1, \ldots, k_t$ are elements of $S_{I, a}^{\oplus r}$ and
map to zero in $M_{I, a}$. For any such pair $(I, a)$ we set
$$
M'_{I, a} = S_{I, a}^{\oplus r}/ \sum S_{I, a}k_j.
$$
Since $M_A = S_A^{\oplus r}/ \sum S_Ak_j$ we see that also
$M_A = \colim_{I, a} M'_{I, a}$.
At this point we may apply
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat} (3)
to conclude that $M'_{I, a}$ is flat for some pair $(I, a)$.
(This lemma does not apply a priori to the system $M_{I, a}$
as the transition maps may not satisfy the assumptions of the lemma.)
Since flatness implies torsion free (
Lemma \ref{lemma-flat-torsion-free}),
we also conclude that $M'_{I, a} = M_{I, a}$ for such a pair and we win.
\end{proof}












\section{Completion and flatnes}
\label{section-completion-flat}

\noindent
In this section we discuss when the completion of a ``big'' flat module
is flat.

\begin{lemma}
\label{lemma-ui-completion-direct-sum-into-product}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $A$ be a set.
Assume $R$ is Noetherian and complete with respect to $I$. There is a
canonical map
$$
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\longrightarrow
\prod\nolimits_{\alpha \in A} R
$$
from the $I$-adic completion of the direct sum into the product
which is universally injective.
\end{lemma}

\begin{proof}
By definition an element $x$ of the left hand side is $x = (x_n)$ where
$x_n = (x_{n, \alpha}) \in \bigoplus\nolimits_{\alpha \in A} R/I^n$
such that $x_{n, \alpha} = x_{n + 1, \alpha} \bmod I^n$.
As $R = R^\wedge$ we see that for any $\alpha$ there exists a $y_\alpha \in R$
such that $x_{n, \alpha} = y_\alpha \bmod I^n$. Note that for each $n$ there
are only finitely many $\alpha$ such that the elements $x_{n, \alpha}$ are
nonzero. Conversely, given $(y_\alpha) \in \prod_\alpha R$ such that for each
$n$ there are only finitely many $\alpha$ such that $y_{\alpha} \bmod I^n$
is nonzero, then this defines an element of the left hand side.
Hence we can think of an element of the left hand side as infinite
``convergent sums'' $\sum_\alpha y_\alpha$ with $y_\alpha \in R$
such that for each $n$ there are only finitely many $y_\alpha$
which are nonzero modulo $I^n$. The displayed map maps this element
to the element to $(y_\alpha)$ in the product.
In particular the map is injective.

\medskip\noindent
Let $Q$ be a finite $R$-module. We have to show that the map
$$
Q \otimes_R \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\longrightarrow
Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)
$$
is injective, see
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
Choose a presentation $R^{\oplus k} \to R^{\oplus m} \to Q \to 0$
and denote $q_1, \ldots, q_m \in Q$ the corresponding generators for $Q$.
By Artin-Rees
(Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
there exists a constant $c$ such that
$\text{Im}(R^{\oplus k} \to R^{\oplus m}) \cap (I^N)^{\oplus m}
\subset \text{Im}((I^{N - c})^{\oplus k} \to R^{\oplus m})$.
Let us contemplate the diagram
$$
\xymatrix{
\bigoplus_{l = 1}^k \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
\bigoplus_{j = 1}^m \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
Q \otimes_R \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
0 \\
\bigoplus_{l = 1}^k \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
\bigoplus_{j = 1}^m \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
0
}
$$
with exact rows. Pick an element $\sum_j \sum_\alpha y_{j, \alpha}$ of
$\bigoplus_{j = 1, \ldots, m}
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$.
If this element maps to zero in the module
$Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)$,
then we see in particular that
$\sum_j q_j \otimes y_{j, \alpha} = 0$ in $Q$ for each $\alpha$.
Thus we can find an element
$(z_{1, \alpha}, \ldots, z_{k, \alpha}) \in \bigoplus_{l = 1, \ldots, k} R$
which maps to
$(y_{1, \alpha}, \ldots, y_{m, \alpha}) \in \bigoplus_{j = 1, \ldots, m} R$.
Moreover, if $y_{j, \alpha} \in I^{N_\alpha}$ for $j = 1, \ldots, m$, then
we may assume that $z_{l, \alpha} \in I^{N_\alpha - c}$ for
$l = 1, \ldots, k$.
Hence the sum $\sum_l \sum_\alpha z_{l, \alpha}$ is ``convergent'' and
defines an element of
$\bigoplus_{l = 1, \ldots, k}
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$
which maps to the element $\sum_j \sum_\alpha y_{j, \alpha}$ we started
out with. Thus the right vertical arrow is injective and we win.
\end{proof}

\noindent
The following lemma can also be deduced from
Lemma \ref{lemma-limit-flat} below.

\begin{lemma}
\label{lemma-completed-direct-sum-flat}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $A$ be a set.
Assume $R$ is Noetherian. The completion
$(\bigoplus\nolimits_{\alpha \in A} R)^\wedge$
is a flat $R$-module.
\end{lemma}

\begin{proof}
Denote $R^\wedge$ the completion of $R$ with respect to $I$. As
$R \to R^\wedge$ is flat by
Algebra, Lemma \ref{algebra-lemma-completion-flat}
it suffices to prove that
$(\bigoplus\nolimits_{\alpha \in A} R)^\wedge$ is a flat
$R^\wedge$-module (use
Algebra, Lemma \ref{algebra-lemma-composition-flat}).
Since
$$
(\bigoplus\nolimits_{\alpha \in A} R)^\wedge
=
(\bigoplus\nolimits_{\alpha \in A} R^\wedge)^\wedge
$$
we may replace $R$ by $R^\wedge$ and assume that $R$ is complete with
respect to $I$ (see
Algebra, Lemma \ref{algebra-lemma-completion-complete}).
In this case
Lemma \ref{lemma-ui-completion-direct-sum-into-product}
tells us the map
$(\bigoplus\nolimits_{\alpha \in A} R)^\wedge \to \prod_{\alpha \in A} R$
is universally injective. Thus, by
Algebra, Lemma \ref{algebra-lemma-ui-flat-domain}
it suffices to show that $\prod_{\alpha \in A} R$ is flat. By
Algebra, Proposition \ref{algebra-proposition-characterize-coherent}
(and
Algebra, Lemma \ref{algebra-lemma-Noetherian-coherent})
we see that $\prod_{\alpha \in A} R$ is flat.
\end{proof}

\begin{lemma}
\label{lemma-tor-strictly-pro-zero}
Let $A$ be a Noetherian ring. Let $I$ be an ideal of $A$.
Let $M$ be a finite $A$-module. For every $p > 0$ there exists a $c > 0$
such that $\text{Tor}_p^A(M, A/I^{n + c}) \to \text{Tor}_p^A(M, A/I^n)$
is zero.
\end{lemma}

\begin{proof}
Proof for $p = 1$. Choose a short exact sequence
$0 \to K \to R^{\oplus t} \to M \to 0$. Then
$\text{Tor}_1^A(M, A/I^n) = K \cap (I^n)^{\oplus t}/I^nK$.
By Artin-Rees (Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
there is a constant $c \geq 0$ such that
$K \cap (I^{n + c})^{\oplus t} \subset I^nK$. Thus the result
for $p = 1$. For $p > 1$ we have
$\text{Tor}_p^A(M, A/I^n) = \text{Tor}_{p - 1}(K, A/I^n)$.
Thus the lemma follows by induction.
\end{proof}

\begin{lemma}
\label{lemma-limit-flat}
Let $A$ be a Noetherian ring. Let $I$ be an ideal of $A$. Let
$(M_n)$ be an inverse system of $A$-modules such that
\begin{enumerate}
\item $M_n$ is a flat $A/I^n$-module,
\item $M_{n + 1} \to M_n$ is surjective.
\end{enumerate}
Then $M = \lim M_n$ is a flat $A$-module.
\end{lemma}

\begin{proof}
We claim that $Q \otimes_A M = \lim Q \otimes_A M_n$ for every finite
$A$-module $Q$. Choose a resolution $F_2 \to F_1 \to F_0 \to Q \to 0$
by finite free $A$-modules $F_i$. Then
$$
F_2 \otimes_A M_n \to F_1 \otimes_A M_n \to F_0 \otimes_A M_n
$$
is a chain complex whose homology in degree $0$ is $Q \otimes_A M_n$
and whose homology in degree $1$ is
$$
\text{Tor}_1^A(Q, M_n) = \text{Tor}_1^A(Q, A/I^n) \otimes_{A/I^n} M_n
$$
as $M_n$ is flat over $A/I^n$. By Lemma \ref{lemma-tor-strictly-pro-zero}
we see that this system is essentially constant (with value $0$).
It follows from Homology, Lemma \ref{homology-lemma-apply-Mittag-Leffler-again}
that $\lim Q \otimes_A A/I^n =
\text{Coker}(\lim F_1 \otimes_A M_n \to \lim F_0 \otimes_A M_n)$.
Since $F_i$ is finite free this equals
$\text{Coker}(F_1 \otimes_A M \to F_0 \otimes_A M) = Q \otimes_A M$.

\medskip\noindent
Next, let $Q \to Q'$ be an injective map of finite $A$-modules.
We have to show that $Q \otimes_A M \to Q' \otimes_A M$ is injective
(Algebra, Lemma \ref{algebra-lemma-flat}). By the above we see
$$
\text{Ker}(Q \otimes_A M \to Q' \otimes_A M) =
\text{Ker}(\lim Q \otimes_A M_n \to \lim Q' \otimes_A M_n).
$$
For each $n$ we have an exact sequence
$$
\text{Tor}_1^A(Q', M_n) \to \text{Tor}_1^A(Q'', M_n) \to
Q \otimes_A M_n \to Q' \otimes_A M_n
$$
where $Q'' = \text{Coker}(Q \to Q')$. Above we have seen that the
inverse systems of Tor's are essentially constant with value $0$.
It follows from
Homology, Lemma \ref{homology-lemma-apply-Mittag-Leffler-again}
that the inverse limit of the right most maps is injective.
\end{proof}











\section{The Koszul complex}
\label{section-koszul}

\noindent
We define the Koszul complex as follows.

\begin{definition}
\label{definition-koszul}
Let $R$ be a ring. Let $\varphi : E \to R$ be an $R$-module map. The
{\it Koszul complex} $K_\bullet(\varphi)$ associated to $\varphi$
is the commutative differential graded algebra defined as follows:
\begin{enumerate}
\item the underlying graded algebra is the exterior algebra
$K_\bullet(\varphi) = \wedge(E)$,
\item the differential $d : K_\bullet(\varphi) \to K_\bullet(\varphi)$
is the unique derivation such that $d(e) = \varphi(e)$ for all
$e \in E = K_1(\varphi)$.
\end{enumerate}
\end{definition}

\noindent
Explicitly, if $e_1 \wedge \ldots \wedge e_n$ is one of the generators of
degree $n$ in $K_\bullet(\varphi)$, then
$$
d(e_1 \wedge \ldots \wedge e_n) =
\sum\nolimits_{i = 1, \ldots, n} (-1)^{i + 1}
\varphi(e_i)e_1 \wedge \ldots \wedge \widehat{e_i} \wedge \ldots \wedge e_n.
$$
It is straightforward to see that this gives a well defined derivation
on the tensor algebra, which annihilates $e \otimes e$ and hence factors
through the exterior algebra.

\medskip\noindent
We often assume that $E$ is a finite free module, say $E = R^{\oplus n}$.
In this case the map $\varphi$ is given by a sequence of elements
$f_1, \ldots, f_n \in R$.

\begin{definition}
\label{definition-koszul-complex}
Let $R$ be a ring and let $f_1, \ldots, f_r \in R$. The
{\it Koszul complex on $f_1, \ldots, f_r$} is the Koszul complex
associated to the map $(f_1, \ldots, f_r) : R^{\oplus r} \to R$.
Notation $K_\bullet(f_\bullet)$, $K_\bullet(f_1, \ldots, f_r)$,
$K_\bullet(R, f_1, \ldots, f_r)$, or $K_\bullet(R, f_\bullet)$.
\end{definition}

\noindent
Of course, if $E$ is finite locally free, then $K_\bullet(\varphi)$ is
locally on $\Spec(R)$ isomorphic to a Koszul complex
$K_\bullet(f_1, \ldots, f_r)$.
This complex has many interesting formal properties.

\begin{lemma}
\label{lemma-functorial}
Let $\varphi : E \to R$ and $\varphi : E' \to R$ be an $R$-module maps.
Let $\psi : E \to E'$ be an $R$-module map such that
$\varphi' \circ \psi = \varphi$. Then $\psi$ induces a
homomorphism of differential graded algebras
$K_\bullet(\varphi) \to K_\bullet(\varphi')$.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-change-basis}
Let $f_1, \ldots, f_r \in R$ be a sequence.
Let $(x_{ij})$ be an invertible $r \times r$-matrix with
coefficients in $R$. Then the complexes
$K_\bullet(f_\bullet)$ and
$$
K_\bullet(\sum x_{1j}f_j, \sum x_{2j}f_j, \ldots, \sum x_{cj}f_j)
$$
are isomorphic.
\end{lemma}

\begin{proof}
Set $g_i = \sum x_{ij}f_j$.
The matrix $(x_{ij})$ gives an isomorphism $x : R^{\oplus r} \to R^{\oplus r}$
such that $(g_1, \ldots, g_r) \circ x = (f_1, \ldots, f_r)$.
Hence this follows from the functoriality of the Koszul complex
described in
Lemma \ref{lemma-functorial}.
\end{proof}

\begin{lemma}
\label{lemma-homotopy-koszul-abstract}
Let $R$ be a ring. Let $\varphi : E \to R$ be an $R$-module map.
Let $e \in E$ with image $f = \varphi(e)$ in $R$. Then
$$
f = de + ed
$$
as endomorphisms of $K_\bullet(\varphi)$.
\end{lemma}

\begin{proof}
This is true because $d(ea) = d(e)a - ed(a) = fa - ed(a)$.
\end{proof}

\begin{lemma}
\label{lemma-homotopy-koszul}
Let $R$ be a ring. Let $f_1, \ldots, f_r \in R$ be a sequence.
Multiplication by $f_i$ on $K_\bullet(f_\bullet)$ is homotopic to
zero, and in particular the cohomology modules $H_i(K_\bullet(f_\bullet))$
are annihilated by the ideal $(f_1, \ldots, f_r)$.
\end{lemma}

\begin{proof}
Special case of
Lemma \ref{lemma-homotopy-koszul-abstract}.
\end{proof}

\noindent
In
Derived Categories, Section \ref{derived-section-cones}
we defined the cone of a morphism of cochain complexes.
The cone $C(f)_\bullet$ of a morphism of chain complexes
$f : A_\bullet \to B_\bullet$ is the complex $C(f)_\bullet$ given by
$C(f)_n = B_n \oplus A_{n - 1}$ and differential
\begin{equation}
\label{equation-differential-cone}
d_{C(f), n} =
\left(
\begin{matrix}
d_{B, n} & f_{n - 1} \\
0 & -d_{A, n - 1}
\end{matrix}
\right)
\end{equation}
It comes equipped with canonical morphisms of complexes
$i : B_\bullet \to C(f)_\bullet$ and
$p : C(f)_\bullet \to A_\bullet[-1]$
induced by the obvious maps $B_n \to C(f)_n \to A_{n - 1}$.

\begin{lemma}
\label{lemma-cone-koszul-abstract}
Let $R$ be a ring. Let $\varphi : E \to R$ be an $R$-module map.
Let $f \in R$. Set $E' = E \oplus R$ and define $\varphi' : E' \to R$
by $\varphi$ on $E$ and multiplication by $f$ on $R$.
The complex $K_\bullet(\varphi')$ is isomorphic to the
cone of the map of complexes
$$
f :
K_\bullet(\varphi)
\longrightarrow
K_\bullet(\varphi).
$$
\end{lemma}

\begin{proof}
Denote $e_0 \in E'$ the element $1 \in R \subset R \oplus E$.
By our definition of the cone above we see that
$$
C(f)_n = K_n(\varphi) \oplus K_{n - 1}(\varphi) =
\wedge^n(E) \oplus \wedge^{n - 1}(E) = \wedge^n(E')
$$
where in the last $=$ we map $(0, e_1 \wedge \ldots \wedge e_{n - 1})$
to $e_0 \wedge e_1 \wedge \ldots \wedge e_{n - 1}$ in $\wedge^n(E')$.
A computation shows that this isomorphism is compatible with
differentials. Namely, this is clear for elements of the first
summand as $\varphi'|_E = \varphi$ and $d_{C(f)}$ restricted to
the first summand is just $d_{K_\bullet(\varphi)}$.
On the other hand, if $e_1 \wedge \ldots \wedge e_{n - 1}$
is in the first summand, then
$$
d_{C(f)}(0, e_1 \wedge \ldots \wedge e_{n - 1}) =
fe_1 \wedge \ldots \wedge e_{n - 1}
- d_{K_\bullet(\varphi)}(e_1 \wedge \ldots \wedge e_{n - 1})
$$
and on the other hand
$$
\begin{matrix}
d_{K_\bullet(\varphi')}(e_0 \wedge e_1 \wedge \ldots \wedge e_{n - 1})
\hfill \\
= \sum\nolimits_{i = 0, \ldots, n - 1}
(-1)^i \varphi'(e_i)e_0 \wedge \ldots \wedge \widehat{e_i}
\wedge \ldots \wedge e_{n - 1} \hfill \\
= fe_1 \wedge \ldots \wedge e_{n - 1} +
\sum\nolimits_{i = 1, \ldots, n - 1}
(-1)^i \varphi(e_i)e_0 \wedge \ldots \wedge \widehat{e_i}
\wedge \ldots \wedge e_{n - 1} \hfill \\
= fe_1 \wedge \ldots \wedge e_{n - 1} -
e_0 \left(\sum\nolimits_{i = 1, \ldots, n - 1}
(-1)^{i + 1} \varphi(e_i)e_1 \wedge \ldots \wedge \widehat{e_i}
\wedge \ldots \wedge e_{n - 1}\right)
\end{matrix}
$$
which is the image of the result of the previous computation.
\end{proof}

\begin{lemma}
\label{lemma-cone-koszul}
Let $R$ be a ring. Let $f_1, \ldots, f_r$ be a sequence of elements
of $R$. The complex $K_\bullet(f_1, \ldots, f_r)$ is isomorphic to the
cone of the map of complexes
$$
f_n :
K_\bullet(f_1, \ldots, f_{r - 1})
\longrightarrow
K_\bullet(f_1, \ldots, f_{r - 1}).
$$
\end{lemma}

\begin{proof}
Special case of
Lemma \ref{lemma-cone-koszul-abstract}.
\end{proof}

\begin{lemma}
\label{lemma-cone-squared}
Let $R$ be a ring. Let $A_\bullet$ be a complex of $R$-modules.
Let $f, g \in R$. Let $C(f)_\bullet$ be the cone of
$f : A_\bullet \to A_\bullet$. Define similarly $C(g)_\bullet$ and
$C(fg)_\bullet$. Then $C(fg)_\bullet$ is homotopy equivalent to the
cone of a map
$$
C(f)_\bullet[1] \longrightarrow C(g)_\bullet
$$
\end{lemma}

\begin{proof}
We first prove this if $A_\bullet$ is the complex consisting of $R$ placed
in degree $0$. In this case the map we use is
$$
\xymatrix{
0 \ar[r] \ar[d] &
0 \ar[r] \ar[d] &
R \ar[r]^f \ar[d]^1 &
R \ar[r] \ar[d] & 0 \ar[d] \\
0 \ar[r] & R \ar[r]^g & R \ar[r] & 0 \ar[r] & 0
}
$$
The cone of this is the chain complex consisting of $R \oplus R$ placed in
degrees $1$ and $0$ and differential (\ref{equation-differential-cone})
$$
\left(
\begin{matrix}
g & 1 \\
0 & -f
\end{matrix}
\right) :
R^{\oplus 2} \longrightarrow R^{\oplus 2}
$$
We leave it to the reader to show this this chain complex is
homotopic to the complex $fg : R \to R$. In general we
write $C(f)_\bullet$ and $C(g)_\bullet$
as the total complex of the double complexes
$$
(R \xrightarrow{f} R) \otimes_R A_\bullet
\quad\text{and}\quad
(R \xrightarrow{g} R) \otimes_R A_\bullet
$$
and in this way we deduce the result from the special case discussed above.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-koszul-mult-abstract}
Let $R$ be a ring. Let $\varphi : E \to R$ be an $R$-module map.
Let $f, g \in R$. Set $E' = E \oplus R$ and define
$\varphi'_f, \varphi'_g, \varphi'_{fg} : E' \to R$
by $\varphi$ on $E$ and multiplication by $f, g, fg$ on $R$.
The complex $K_\bullet(\varphi'_{fg})$ is isomorphic to the
cone of a map of complexes
$$
K_\bullet(\varphi'_f)[1]
\longrightarrow
K_\bullet(\varphi'_g).
$$
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-cone-koszul-abstract}
the complex $K_\bullet(\varphi'_f)$ is isomorphic to the cone of
multiplication by $f$ on $K_\bullet(\varphi)$ and similarly
for the other two cases. Hence the the lemma follows from
Lemma \ref{lemma-cone-squared}.
\end{proof}

\begin{lemma}
\label{lemma-koszul-mult}
Let $R$ be a ring. Let $f_1, \ldots, f_{r - 1}$ be a sequence of elements
of $R$. Let $f, g \in R$. The complex
$K_\bullet(f_1, \ldots, f_{r - 1}, fg)$
is homotopy equivalent to the cone of a map of complexes
$$
K_\bullet(f_1, \ldots, f_{r - 1}, f)[1]
\longrightarrow
K_\bullet(f_1, \ldots, f_{r - 1}, g)
$$
\end{lemma}

\begin{proof}
Special case of
Lemma \ref{lemma-koszul-mult-abstract}.
\end{proof}

\begin{lemma}
\label{lemma-join-sequences-koszul-complex}
Let $A$ be a ring.
Let $f_1, \ldots, f_r$, $g_1, \ldots, g_s$ be elements of $A$.
Then there is an isomorphism of Koszul complexes
$$
K_\bullet(A, f_1, \ldots, f_r, g_1, \ldots, g_s) =
\text{Tot}(K_\bullet(A, f_1, \ldots, f_r) \otimes_A
K_\bullet(A, g_1, \ldots, g_s)).
$$
\end{lemma}

\begin{proof}
We first show that $K_\bullet(A, f_1, \ldots, f_r, g_1, \ldots, g_s)$ is
isomorphic to the tensor product
$K_\bullet(A, f_1, \ldots, f_r) \otimes_A K_\bullet(A, g_1, \ldots, g_s)$
as a differential graded $A$-algebra. This is clear as the multiplication map
$$
\wedge(A^{\oplus r}) \otimes_A \wedge(A^{\oplus s})
\longrightarrow
\wedge(A^{\oplus r} \oplus A^{\oplus s})
$$
is an isomorphism and the fact that the $d$ of generators agree.
Thus the lemma follows from
Homology, Lemma \ref{homology-lemma-total-complex-tensor-product}.
\end{proof}

\begin{lemma}
\label{lemma-extended-alternating-Cech-is-colimit-koszul}
Let $R$ be a ring. Let $f_1, \ldots, f_r \in R$.
The extended alternating {\v C}ech complex
$$
R \to \prod\nolimits_{i_0} R_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} R_{f_{i_0}f_{i_1}} \to
\ldots \to R_{f_1\ldots f_r}
$$
is a colimit of the Koszul complexes $K(R, f_1^n, \ldots, f_r^n)$.
\end{lemma}

\begin{proof}
The transition maps $K(R, f_1^n, \ldots, f_r^n) \to
K(R, f_1^{n + 1}, \ldots, f_r^{n + 1})$ are the maps
sending $e_{i_1} \wedge \ldots \wedge e_{i_p}$ to
$f_{i_{p + 1}} \ldots f_{i_r} e_{i_1} \wedge \ldots \wedge e_{i_p}$
where the indices are such that $\{1, \ldots, r\} = \{i_1, \ldots, i_r\}$.
In particular the transition maps are always $1$ in degree $r$
and equal to $f_1\ldots f_r$ in degree $0$.
The terms of the colimit are equal to the terms of the
extended alternating {\v C}ech complex by
Algebra, Lemma \ref{algebra-lemma-localization-colimit}.
\end{proof}




\section{Koszul regular sequences}
\label{section-koszul-regular}

\noindent
Please take a look at
Algebra, Sections \ref{algebra-section-depth} and
\ref{algebra-section-quasi-regular}
before looking at this one.

\begin{definition}
\label{definition-koszul-regular-sequence}
Let $R$ be a ring.
A sequence of elements $f_1, \ldots, f_r$ of $R$ is called
{\it Koszul-regular} if $H_i(K_\bullet(f_1, \ldots, f_r)) = 0$ for
all $i \not = 0$.
A sequence of elements $f_1, \ldots, f_r$ of $R$ is called
{\it $H_1$-regular} if $H_1(K_\bullet(f_1, \ldots, f_r)) = 0$.
\end{definition}

\noindent
Clear a Koszul-regular sequence is $H_1$-regular. If $f = f_1 \in R$
is a length $1$ sequence then it is clear that the following are
all equivalent
\begin{enumerate}
\item $f$ is a regular sequence of length one,
\item $f$ is a Koszul-regular sequence of length one, and
\item $f$ is a $H_1$-regular sequence of length one.
\end{enumerate}
It is also clear that these imply that $f$ is a quasi-regular sequence
of length one. But there do exist quasi-regular sequences of length $1$
which are not regular sequences. Namely, let
$$
R = k[x, y_0, y_1, \ldots]/(xy_0, xy_1 - y_0, xy_2 - y_1, \ldots)
$$
and let $f$ be the image of $x$ in $R$. Then $f$ is a zerodivisor, but
$\bigoplus_{n \geq 0} (f^n)/(f^{n + 1}) \cong k[x]$ is a polynomial ring.

\begin{lemma}
\label{lemma-regular-koszul-regular}
A regular sequence is Koszul-regular.
\end{lemma}

\begin{proof}
Let $f_1, \ldots, f_r$ be a regular sequence. Then $f_1$ is a nonzero
divisor in $R$. Hence
$$
0 \to K_\bullet(R, f_2, \ldots, f_r) \xrightarrow{f_1}
K_\bullet(R, f_2, \ldots, f_r) \to
K_\bullet(R/(f_1), \overline{f}_2, \ldots, \overline{f}_r) \to 0
$$
is a short exact sequence of complexes. By
Lemma \ref{lemma-cone-koszul}
the complex $K_\bullet(R, f_1, \ldots, f_r)$
is isomorphic to the cone of the first map. Hence
$K_\bullet(R/(f_1), \overline{f}_2, \ldots, \overline{f}_r)$
is quasi-isomorphic to $K_\bullet(R, f_1, \ldots, f_r)$.
As $\overline{f}_2, \ldots, \overline{f}_r$ is a regular sequence
in $R/(f_1)$ the result follows from the case $r = 1$ discussed above and
induction.
\end{proof}

\begin{lemma}
\label{lemma-mult-koszul-regular}
Let $f_1, \ldots, f_{r - 1} \in R$ be a sequence and $f, g \in R$.
\begin{enumerate}
\item If $f_1, \ldots, f_{r - 1}, f$ and $f_1, \ldots, f_{r - 1}, g$
are $H_1$-regular then $f_1, \ldots, f_{r - 1}, fg$ is an
$H_1$-regular sequence too.
\item If $f_1, \ldots, f_{r - 1}, f$ and $f_1, \ldots, f_{r - 1}, f$ are
Koszul-regular then $f_1, \ldots, f_{r - 1}, fg$ is a Koszul-regular
sequence too.
\end{enumerate}
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-koszul-mult}
we have exact sequences
$$
H_i(K_\bullet(f_1, \ldots, f_{r - 1}, f)) \to
H_i(K_\bullet(f_1, \ldots, f_{r - 1}, fg)) \to
H_i(K_\bullet(f_1, \ldots, f_{r - 1}, g))
$$
for all $i$.
\end{proof}

\begin{lemma}
\label{lemma-koszul-regular-flat-base-change}
Let $\varphi : R \to S$ be a flat ring map.
\begin{enumerate}
\item If $f_1, \ldots, f_r$ is a $H_1$-regular sequence in $R$, then
$\varphi(f_1), \ldots, \varphi(f_r)$ is a $H_1$-regular sequence in $S$.
\item If $f_1, \ldots, f_r$ is a Koszul-regular sequence in $R$, then
$\varphi(f_1), \ldots, \varphi(f_r)$ is a Koszul-regular sequence in $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is true because
$K_\bullet(f_1, \ldots, f_r) \otimes_R S =
K_\bullet(\varphi(f_1), \ldots, \varphi(f_r))$.
\end{proof}

\begin{lemma}
\label{lemma-H1-regular-quasi-regular}
An $H_1$-regular sequence is quasi-regular.
\end{lemma}

\begin{proof}
Let $f_1, \ldots, f_r$ be an $H_1$-regular sequence.
Denote $J = (f_1, \ldots, f_r)$. The assumption means that we have
an exact sequence
$$
\wedge^2(R^r) \to R^{\oplus r} \to J \to 0
$$
where the first arrow is given by $e_i \wedge e_j \mapsto f_ie_j - f_je_i$.
In particular this implies that
$$
J/J^2 = J \otimes_R R/J = (R/J)^r
$$
is a finite free module. To finish the proof we have to prove
for every $n \geq 2$ the following: if
$$
\xi = \sum\nolimits_{|I| = n, I = (i_1, \ldots, i_r)}
a_I f_1^{i_1} \ldots f_r^{i_r} \in J^{n + 1}
$$
then $a_I \in J$ for all $I$. Note that $f_1, \ldots, f_{r - 1}, f_r^n$
is a $H_1$-regular sequence by
Lemma \ref{lemma-mult-koszul-regular}.
Hence we see that the required result holds for
the multi-index $I = (0, \ldots, 0, n)$. It turns out that we can
reduce the general case to this case as follows.

\medskip\noindent
Let $S = R[x_1, x_2, \ldots, x_r, 1/x_r]$.
The ring map $R \to S$ is faithfully
flat, hence $f_1, \ldots, f_r$ is an $H_1$-regular sequence in $S$, see
Lemma \ref{lemma-koszul-regular-flat-base-change}.
By
Lemma \ref{lemma-change-basis}
we see that
$$
g_1 = f_1 - x_1/x_r f_r, \ldots
g_{r - 1} = f_{r - 1} - x_{r - 1}/x_r f_r,
g_r = (1/x_r)f_r
$$
is an $H_1$-regular sequence in $S$. Finally, note that our element
$\xi$ can be rewritten
$$
\xi = \sum\nolimits_{|I| = n, I = (i_1, \ldots, i_r)}
a_I (g_1 + x_r g_r)^{i_1} \ldots (g_{r - 1} + x_r g_r)^{i_{r - 1}}
(x_rg_r)^{i_r}
$$
and the coefficient of $g_r^n$ in this expression is
$$
\sum a_I x_1^{i_1} \ldots x_r^{i_r} \in JS.
$$
Since the monomials $x_1^{i_1} \ldots x_r^{i_r}$ form part of an $R$-basis
of $S$ over $R$ we conclude that $a_I \in J$ for all $I$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-H1-regular-in-quotient}
Let $A$ be a ring. Let $I \subset A$ be an ideal.
Let $g_1, \ldots, g_m$ be a sequence in $A$ whose image in
$A/I$ is $H_1$-regular. Then $I \cap (g_1, \ldots, g_m) =
I(g_1, \ldots, g_m)$.
\end{lemma}

\begin{proof}
Consider the exact sequence of complexes
$$
0 \to I \otimes_A K_\bullet(A, g_1, \ldots, g_m)
\to K_\bullet(A, g_1, \ldots, g_m) \to
K_\bullet(A/I, g_1, \ldots, g_m) \to 0
$$
Since the complex on the right has $H_1 = 0$ by assumption we
see that
$$
\text{Coker}(I^{\oplus m} \to I)
\longrightarrow
\text{Coker}(A^{\oplus m} \to A)
$$
is injective. This is equivalent to the assertion of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-conormal-sequence-H1-regular}
Let $A$ be a ring. Let $I \subset J \subset A$ be ideals.
Assume that $J/I \subset A/I$ is generated by an $H_1$-regular sequence.
Then $I \cap J^2 = IJ$.
\end{lemma}

\begin{proof}
To prove this choose $g_1, \ldots, g_m \in J$
whose images in $A/I$ form a $H_1$-regular sequence which generates $J/I$.
In particular $J = I + (g_1, \ldots, g_m)$.
Suppose that $x \in I \cap J^2$. Because $x \in J^2$ can write
$$
x =
\sum a_{ij} g_ig_j +
\sum a_j g_j +
a
$$
with $a_{ij} \in A$, $a_j \in I$ and $a \in I^2$.
Then $\sum a_{ij}g_ig_j \in I \cap (g_1, \ldots, g_m)$
hence by
Lemma \ref{lemma-H1-regular-in-quotient}
we see that $\sum a_{ij}g_ig_j \in I(g_1, \ldots, g_m)$.
Thus $x \in IJ$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-join-quasi-regular-H1-regular}
Let $A$ be a ring. Let $I$ be an ideal generated by a quasi-regular
sequence $f_1, \ldots, f_n$ in $A$. Let $g_1, \ldots, g_m \in A$ be
elements whose images $\overline{g}_1, \ldots, \overline{g}_m$ form an
$H_1$-regular sequence in $A/I$. Then $f_1, \ldots, f_n, g_1, \ldots, g_m$
is a quasi-regular sequence in $A$.
\end{lemma}

\begin{proof}
We claim that $g_1, \ldots, g_m$ forms an $H_1$-regular sequence in
$A/I^d$ for every $d$. By induction assume that this holds in
$A/I^{d - 1}$. We have a short exact sequence of complexes
$$
0 \to K_\bullet(A, g_\bullet) \otimes_A I^{d - 1}/I^d
\to K_\bullet(A/I^d, g_\bullet) \to
K_\bullet(A/I^{d - 1}, g_\bullet) \to 0
$$
Since $f_1, \ldots, f_n$ is quasi-regular we see that the first complex
is a direct sum of copies of $K_\bullet(A/I, g_1, \ldots, g_m)$
hence acyclic in degree $1$. By induction hypothesis the last complex is
acyclic in degree $1$. Hence also the middle complex is.
In particular, the sequence $g_1, \ldots, g_m$ forms a quasi-regular
sequence in $A/I^d$ for every $d \geq 1$, see
Lemma \ref{lemma-H1-regular-quasi-regular}.
Now we are ready to prove that $f_1, \ldots, f_n, g_1, \ldots, g_m$
is a quasi-regular sequence in $A$.
Namely, set $J = (f_1, \ldots, f_n, g_1, \ldots, g_m)$ and suppose
that (with multinomial notation)
$$
\sum\nolimits_{|N| + |M| = d} a_{N, M} f^N g^M \in J^{d + 1}
$$
for some $a_{N, M} \in A$. We have to show that $a_{N, M} \in J$
for all $N, M$. Let $e \in \{0, 1, \ldots, d\}$. Then
$$
\sum\nolimits_{|N| = d - e, \ |M| = e} a_{N, M} f^N g^M \in
(g_1, \ldots, g_m)^{e + 1} + I^{d - e + 1}
$$
Because $g_1, \ldots, g_m$ is a quasi-regular sequence in $A/I^{d - e + 1}$
we deduce
$$
\sum\nolimits_{|N| = d - e} a_{N, M} f^N \in
(g_1, \ldots, g_m) + I^{d - e + 1}
$$
for each $M$ with $|M| = e$. By
Lemma \ref{lemma-H1-regular-in-quotient}
applied to $I^{d - e}/I^{d - e + 1}$ in the ring $A/I^{d - e + 1}$
this implies $\sum_{|N| = d - e} a_{N, M} f^N \in I^{d - e}(g_1, \ldots, g_m)$.
Since $f_1, \ldots, f_n$ is quasi-regular in $A$ this implies
that $a_{N, M} \in J$ for each $N, M$ with $|N| = d - e$ and $|M| = e$.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-join-H1-regular-sequences}
Let $A$ be a ring. Let $I$ be an ideal generated by an
$H_1$-regular sequence $f_1, \ldots, f_n$ in $A$.
Let $g_1, \ldots, g_m \in A$ be elements whose images
$\overline{g}_1, \ldots, \overline{g}_m$ form an $H_1$-regular sequence
in $A/I$. Then $f_1, \ldots, f_n, g_1, \ldots, g_m$ is an $H_1$-regular
sequence in $A$.
\end{lemma}

\begin{proof}
We have to show that $H_1(A, f_1, \ldots, f_n, g_1, \ldots, g_m) = 0$.
To do this consider the commutative diagram
$$
\xymatrix{
\wedge^2(A^{\oplus n + m}) \ar[r] \ar[d] &
A^{\oplus n + m} \ar[r] \ar[d] &
A \ar[r] \ar[d] & 0 \\
\wedge^2(A/I^{\oplus m}) \ar[r] &
A/I^{\oplus m} \ar[r] &
A/I \ar[r] & 0
}
$$
Consider an element $(a_1, \ldots, a_{n + m}) \in A^{\oplus n + m}$
which maps to zero in $A$. Because $\overline{g}_1, \ldots, \overline{g}_m$
form an $H_1$-regular sequence in $A/I$ we see that
$(\overline{a}_{n + 1}, \ldots, \overline{a}_{n + m})$ is the image
of some element $\overline{\alpha}$ of $\wedge^2(A/I^{\oplus m})$.
We can lift $\overline{\alpha}$ to an element
$\alpha \in \wedge^2(A^{\oplus n + m})$ and substract the image of it
in $A^{\oplus n + m}$ from our element $(a_1, \ldots, a_{n + m})$.
Thus we may assume that $a_{n + 1}, \ldots, a_{n + m} \in I$.
Since $I = (f_1, \ldots, f_n)$ we can modify our element
$(a_1, \ldots, a_{n + m})$ by linear combinations of the elements
$$
(0, \ldots, g_j, 0, \ldots, 0, f_i, 0, \ldots, 0)
$$
in the image of the top left horizontal arrow to reduce to the case
that $a_{n + 1}, \ldots, a_{n + m}$ are zero. In this case
$(a_1, \ldots, a_n, 0, \ldots, 0)$ defines an element of
$H_1(A, f_1, \ldots, f_n)$ which we assumed to be zero.
\end{proof}

\begin{lemma}
\label{lemma-truncate-H1-regular}
Let $A$ be a ring. Let $f_1, \ldots, f_n, g_1, \ldots, g_m \in A$
be an $H_1$-regular sequence. Then the images
$\overline{g}_1, \ldots, \overline{g}_m$ in $A/(f_1, \ldots, f_n)$
form an $H_1$-regular sequence.
\end{lemma}

\begin{proof}
Set $I = (f_1, \ldots, f_n)$. We have to show that any relation
$\sum_{j = 1, \ldots, m} \overline{a}_j \overline{g}_j$ in $A/I$
is a linear combination of trivial relations. Because
$I = (f_1, \ldots, f_n)$ we can lift this relation to a relation
$$
\sum\nolimits_{j = 1, \ldots, m} a_j g_j +
\sum\nolimits_{i = 1, \ldots, n} b_if_i = 0
$$
in $A$. By assumption this relation in $A$ is a linear combination of
trivial relations. Taking the image in $A/I$ we obtain what we want.
\end{proof}

\begin{lemma}
\label{lemma-join-koszul-regular-sequences}
Let $A$ be a ring. Let $I$ be an ideal generated by a Koszul-regular
sequence $f_1, \ldots, f_n$ in $A$. Let $g_1, \ldots, g_m \in A$ be
elements whose images $\overline{g}_1, \ldots, \overline{g}_m$ form a
Koszul-regular sequence in $A/I$. Then $f_1, \ldots, f_n, g_1, \ldots, g_m$
is a Koszul-regular sequence in $A$.
\end{lemma}

\begin{proof}
Our assumptions say that $K_\bullet(A, f_1, \ldots, f_n)$ is a finite free
resolution of $A/I$ and
$K_\bullet(A/I, \overline{g}_1, \ldots, \overline{g}_m)$ is a
finite free resolution of $A/(f_i, g_j)$ over $A/I$. Then
\begin{align*}
K_\bullet(A, f_1, \ldots, f_n, g_1, \ldots, g_m)
& = \text{Tot}(K_\bullet(A, f_1, \ldots, f_n) \otimes_A
K_\bullet(A, g_1, \ldots, g_m)) \\
& \cong \text{Tot}(A/I \otimes_A K_\bullet(A, g_1, \ldots, g_m)) \\
& = K_\bullet(A/I, \overline{g}_1, \ldots, \overline{g}_m) \\
& \cong A/(f_i, g_j)
\end{align*}
The first equality by
Lemma \ref{lemma-join-sequences-koszul-complex}.
The first quasi-isomorphism by
Lemma \ref{lemma-derived-tor-quasi-isomorphism}.
The second equality is clear. The last quasi-isomorphism by assumption.
Hence we win.
\end{proof}

\noindent
To conclude in the following lemma it is necessary to assume that both
$f_1, \ldots, f_n$ and $f_1, \ldots, f_n, g_1, \ldots, g_m$
are Koszul-regular. A counter example to dropping the assumption
that $f_1, \ldots, f_n$ is Koszul-regular is
Examples, Lemma \ref{examples-lemma-strange-regular-sequence}.

\begin{lemma}
\label{lemma-truncate-koszul-regular}
Let $A$ be a ring. Let $f_1, \ldots, f_n, g_1, \ldots, g_m \in A$.
If both $f_1, \ldots, f_n$ and $f_1, \ldots, f_n, g_1, \ldots, g_m$
are Koszul-regular sequences in $A$, then
$\overline{g}_1, \ldots, \overline{g}_m$ in $A/(f_1, \ldots, f_n)$
form a Koszul-regular sequence.
\end{lemma}

\begin{proof}
Set $I = (f_1, \ldots, f_n)$.
Our assumptions say that $K_\bullet(A, f_1, \ldots, f_n)$ is a finite free
resolution of $A/I$ and
$K_\bullet(A, f_1, \ldots, f_n, g_1, \ldots, g_m)$ is a
finite free resolution of $A/(f_i, g_j)$ over $A$. Then
\begin{align*}
A/(f_i, g_j) & \cong K_\bullet(A, f_1, \ldots, f_n, g_1, \ldots, g_m) \\
& = \text{Tot}(K_\bullet(A, f_1, \ldots, f_n) \otimes_A
K_\bullet(A, g_1, \ldots, g_m)) \\
& \cong \text{Tot}(A/I \otimes_A K_\bullet(A, g_1, \ldots, g_m)) \\
& = K_\bullet(A/I, \overline{g}_1, \ldots, \overline{g}_m)
\end{align*}
The first quasi-isomorphism by assumption.
The first equality by
Lemma \ref{lemma-join-sequences-koszul-complex}.
The second quasi-isomorphism by
Lemma \ref{lemma-derived-tor-quasi-isomorphism}.
The second equality is clear. Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-independence-of-generators}
Let $R$ be a ring. Let $I$ be an ideal generated by $f_1, \ldots, f_r \in R$.
\begin{enumerate}
\item If $I$ can be generated by a quasi-regular sequence of length $r$,
then $f_1, \ldots, f_r$ is a quasi-regular sequence.
\item If $I$ can be generated by an $H_1$-regular sequence of length $r$,
then $f_1, \ldots, f_r$ is an $H_1$-regular sequence.
\item If $I$ can be generated by a Koszul-regular sequence of length $r$,
then $f_1, \ldots, f_r$ is a Koszul-regular sequence.
\end{enumerate}
\end{lemma}

\begin{proof}
If $I$ can be generated by a quasi-regular sequence of length $r$,
then $I/I^2$ is free of rank $r$ over $R/I$. Since $f_1, \ldots, f_r$
generate by assumption we see that the images $\overline{f}_i$ form a basis of
$I/I^2$ over $R/I$. It follows that $f_1, \ldots, f_r$ is a quasi-regular
sequence as all this means, besides the freeness of $I/I^2$, is that the maps
$\text{Sym}^n_{R/I}(I/I^2) \to I^n/I^{n + 1}$ are isomorphisms.

\medskip\noindent
We continue to assume that $I$ can be generated by a
quasi-regular sequence, say
$g_1, \ldots, g_r$. Write $g_j = \sum a_{ij}f_i$. As $f_1, \ldots, f_r$
is quasi-regular according to the previous paragraph, we see that
$\det(a_{ij})$ is invertible mod $I$. The matrix
$a_{ij}$ gives a map $R^{\oplus r} \to R^{\oplus r}$ which induces
a map of Koszul complexes
$\alpha : K_\bullet(R, f_1, \ldots, f_r) \to K_\bullet(R, g_1, \ldots, g_r)$,
see
Lemma \ref{lemma-functorial}.
This map becomes an isomorphism on inverting $\det(a_{ij})$.
Since the cohomology modules of both $K_\bullet(R, f_1, \ldots, f_r)$ and
$K_\bullet(R, g_1, \ldots, g_r)$ are annihilated by $I$, see
Lemma \ref{lemma-homotopy-koszul},
we see that $\alpha$ is a quasi-isomorphism. Hence if $g_1, \ldots, g_r$
is $H_1$-regular, then so is $f_1, \ldots, f_r$. Similarly
for Koszul-regular.
\end{proof}

\begin{lemma}
\label{lemma-base-change-H1-regular}
Let $A \to B$ be a ring map.
Let $f_1, \ldots, f_r$ be a sequence in $B$ such that $B/(f_1, \ldots, f_r)$
is $A$-flat. Let $A \to A'$ be a ring map. Then the canonical map
$$
H_1(K_\bullet(B, f_1, \ldots, f_r)) \otimes_A A'
\longrightarrow
H_1(K_\bullet(B', f'_1, \ldots, f'_r))
$$
is surjective, where $B' = B \otimes_A A'$ and $f_i' \in B'$ is the image
of $f_i$.
\end{lemma}

\begin{proof}
The sequence
$$
\wedge^2(B^{\oplus r}) \to B^{\oplus r} \to B \to B/J \to 0
$$
is a complex of $A$-modules with $B/J$ flat over $A$ and
cohomology group $H_1 = H_1(K_\bullet(B, f_1, \ldots, f_r))$ in the spot
$B^{\oplus r}$. If we tensor this with $A'$ we obtain a complex
$$
\wedge^2((B')^{\oplus r}) \to (B')^{\oplus r} \to B' \to B'/J' \to 0
$$
which is exact at $B'$ and $B'/J'$. In order to compute its
cohomology group $H'_1 = H_1(K_\bullet(B', f'_1, \ldots, f'_r))$
at $(B')^{\oplus r}$ we split the first sequence above into
short exact sequences
$0 \to J \to B \to B/J \to 0$ and
$0 \to K \to B^{\oplus r} \to J \to 0$ and
$\wedge^2(B^{\oplus r}) \to K \to H_1 \to 0$.
Tensoring with $A'$ over $A$ we obtain the exact sequences
$$
\begin{matrix}
0 \to J \otimes_A A' \to B \otimes_A A' \to (B/J) \otimes_A A' \to 0 \\
K \otimes_A A' \to B^{\oplus r} \otimes_A A' \to J \otimes_A A' \to 0 \\
\wedge^2(B^{\oplus r}) \otimes_A A' \to K \otimes_A A' \to H_1 \otimes_A A'
\to 0
\end{matrix}
$$
where the first one is exact as $B/J$ is flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Hence we conclude what we want.
\end{proof}

\begin{lemma}
\label{lemma-make-nonzero-divisor}
Let $R$ be a ring. Let $a_1, \ldots, a_n \in R$ be elements such
that $R \to R^{\oplus n}$, $x \mapsto (xa_1, \ldots, xa_n)$ is injective.
Then the element $\sum a_i t_i$ of the polynomial ring $R[t_1, \ldots, t_n]$
is a nonzerodivisor.
\end{lemma}

\begin{proof}
If one of the $a_i$ is a unit this is just the statement that any
element of the form $t_1 + a_2 t_2 + \ldots + a_n t_n$ is a nonzero
divisor in the polynomial ring over $R$.

\medskip\noindent
Case I: $R$ is Noetherian. Let $\mathfrak q_j$, $j = 1, \ldots, m$
be the associated primes of $R$. We have to show that
each of the maps
$$
\sum a_i t_i :
\text{Sym}^d(R^{\oplus n})
\longrightarrow
\text{Sym}^{d + 1}(R^{\oplus n})
$$
is injective. As $\text{Sym}^d(R^{\oplus n})$ is a free $R$-module its
associated primes are $\mathfrak q_j$, $j = 1, \ldots, m$. For each $j$
there exists an $i = i(j)$ such that $a_i \not \in \mathfrak q_j$ because
there exists an $x \in R$ with $\mathfrak q_jx = 0$ but $a_i x \not = 0$
for some $i$ by assumption. Hence $a_i$ is a unit in $R_{\mathfrak q_j}$
and the map is injective after localizing at $\mathfrak q_j$. Thus the map
is injective, see
Algebra, Lemma \ref{algebra-lemma-zero-at-ass-zero}.

\medskip\noindent
Case II: $R$ general. We can write $R$ as the union of Noetherian
rings $R_\lambda$ with $a_1, \ldots, a_n \in R_\lambda$. For each $R_\lambda$
the result holds, hence the result holds for $R$.
\end{proof}

\begin{lemma}
\label{lemma-Koszul-regular-flat-locally-regular}
Let $R$ be a ring. Let $f_1, \ldots, f_n$ be a Koszul-regular sequence
in $R$. Consider the faithfully flat, smooth ring map
$$
R \longrightarrow
S = R[\{t_{ij}\}_{i \leq j}, t_{11}^{-1}, t_{22}^{-1}, \ldots, t_{nn}^{-1}]
$$
For $1 \leq i \leq n$ set
$$
g_i = \sum\nolimits_{i \leq j} t_{ij} f_j \in S.
$$
Then $g_1, \ldots, g_n$ is a regular sequence in $S$ and
$(f_1, \ldots, f_n)S = (g_1, \ldots, g_n)$.
\end{lemma}

\begin{proof}
The equality of ideals is obvious as the matrix
$$
\left(
\begin{matrix}
t_{11} & t_{12} & t_{13} & \ldots \\
0 & t_{22} & t_{23} & \ldots \\
0 & 0 & t_{33} & \ldots \\
\ldots & \ldots & \ldots & \ldots
\end{matrix}
\right)
$$
is invertible in $S$.
Because $f_1, \ldots, f_n$ is a Koszul-regular sequence we see that
the kernel of
$R \to R^{\oplus n}$, $x \mapsto (xf_1, \ldots, xf_n)$ is zero (as it
computes the $n$the Koszul homology of $R$ w.r.t.\ $f_1, \ldots, f_n$).
Hence by
Lemma \ref{lemma-make-nonzero-divisor}
we see that $g_1 = f_1 t_{11} + \ldots + f_n t_{1n}$ is a nonzerodivisor
in $S' = R[t_{11}, t_{12}, \ldots, t_{1n}, t_{11}^{-1}]$. We see that
$g_1, f_2, \ldots, f_n$ is a Koszul-sequence in $S'$ by
Lemma \ref{lemma-koszul-regular-flat-base-change} and
\ref{lemma-independence-of-generators}.
We conclude that
$\overline{f}_2, \ldots, \overline{f}_n$ is a Koszul-regular sequence
in $S'/(g_2)$ by
Lemma \ref{lemma-truncate-koszul-regular}.
Hence by induction on $n$ we see that the images
$\overline{g}_2, \ldots, \overline{g}_n$ of $g_2, \ldots, g_n$ in
$S'/(g_2)[\{t_{ij}\}_{2 \leq i \leq j}, t_{22}^{-1}, \ldots, t_{nn}^{-1}]$
form a regular sequence. This in turn means that
$g_1, \ldots, g_n$ forms a regular sequence in $S$.
\end{proof}






\section{Regular ideals}
\label{section-ideals}

\noindent
We will discuss the notion of a regular ideal sheaf in great generality in
Divisors, Section \ref{divisors-section-regular-ideal-sheaves}.
Here we define the corresponding notion in the affine case, i.e., in
the case of an ideal in a ring.

\begin{definition}
\label{definition-regular-ideal}
Let $R$ be a ring and let $I \subset R$ be an ideal.
\begin{enumerate}
\item We say $I$ is a {\it regular ideal} if for every
$\mathfrak p \in V(I)$ there exists a $g \in R$, $g \not \in \mathfrak p$
and a regular sequence $f_1, \ldots, f_r \in R_g$ such that $I_g$
is generated by $f_1, \ldots, f_r$.
\item We say $I$ is a {\it Koszul-regular ideal} if for every
$\mathfrak p \in V(I)$ there exists a $g \in R$, $g \not \in \mathfrak p$
and a Koszul-regular sequence $f_1, \ldots, f_r \in R_g$ such that $I_g$
is generated by $f_1, \ldots, f_r$.
\item We say $I$ is a {\it $H_1$-regular ideal} if for every
$\mathfrak p \in V(I)$ there exists a $g \in R$, $g \not \in \mathfrak p$
and an $H_1$-regular sequence $f_1, \ldots, f_r \in R_g$ such that $I_g$
is generated by $f_1, \ldots, f_r$.
\item We say $I$ is a {\it quasi-regular ideal} if for every
$\mathfrak p \in V(I)$ there exists a $g \in R$, $g \not \in \mathfrak p$
and a quasi-regular sequence $f_1, \ldots, f_r \in R_g$ such that $I_g$
is generated by $f_1, \ldots, f_r$.
\end{enumerate}
\end{definition}

\noindent
It is clear that given $I \subset R$ we have the implications
\begin{align*}
I\text{ is a regular ideal}
& \Rightarrow
I\text{ is a Koszul-regular ideal} \\
& \Rightarrow
I\text{ is a }H_1\text{-regular ideal} \\
& \Rightarrow
I\text{ is a quasi-regular ideal}
\end{align*}
see Lemmas \ref{lemma-regular-koszul-regular} and
\ref{lemma-H1-regular-quasi-regular}. Such an ideal is always finitely
generated.

\begin{lemma}
\label{lemma-quasi-regular-ideal-finite}
A quasi-regular ideal is finitely generated.
\end{lemma}

\begin{proof}
Let $I \subset R$ be a quasi-regular ideal. Since $V(I)$ is quasi-compact,
there exist $g_1, \ldots, g_m \in R$ such that
$V(I) \subset D(g_1) \cup \ldots \cup D(g_m)$
and such that $I_{g_j}$ is generated by a quasi-regular sequence
$g_{j1}, \ldots, g_{jr_j} \in R_{g_j}$. Write $g_{ji} = g'_{ji}/g_j^{e_{ij}}$
for some $g'_{ij} \in I$. Write $1 + x = \sum g_j h_j$
for some $x \in I$ which is possible as
$V(I) \subset D(g_1) \cup \ldots \cup D(g_m)$.
Note that $\Spec(R) = D(g_1) \cup \ldots \cup D(g_m) \bigcup D(x)$
Then $I$ is generated by the elements $g'_{ij}$ and $x$ as
these generate on each of the pieces of the cover, see
Algebra, Lemma \ref{algebra-lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-regular-ideal-finite-projective}
Let $I \subset R$ be a quasi-regular ideal of a ring.
Then $I/I^2$ is a finite projective $R/I$-module.
\end{lemma}

\begin{proof}
This follows from Algebra, Lemma \ref{algebra-lemma-finite-projective}
and the definitions.
\end{proof}

\noindent
We prove flat descent for Koszul-regular, $H_1$-regular, quasi-regular
ideals.

\begin{lemma}
\label{lemma-flat-descent-regular-ideal}
Let $A \to B$ be a faithfully flat ring map. Let $I \subset A$ be an ideal.
If $IB$ is a Koszul-regular
(resp.\ $H_1$-regular, resp.\ quasi-regular) ideal in $B$, then
$I$ is a Koszul-regular (resp.\ $H_1$-regular, resp.\ quasi-regular)
ideal in $A$.
\end{lemma}

\begin{proof}
We fix the prime $\mathfrak p \supset I$ throughout the proof.
Assume $IB$ is quasi-regular. By
Lemma \ref{lemma-quasi-regular-ideal-finite}
$IB$ is a finite module, hence $I$ is a finite $A$-module by
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
As $A \to B$ is flat we see that
$$
I/I^2 \otimes_{A/I} B/IB = I/I^2 \otimes_A B = IB/(IB)^2.
$$
As $IB$ is quasi-regular, the $B/IB$-module $IB/(IB)^2$ is finite
locally free. Hence $I/I^2$ is finite projective, see
Algebra, Proposition \ref{algebra-proposition-ffdescent-finite-projectivity}.
In particular, after replacing $A$ by $A_f$ for some
$f \in A$, $f \not \in \mathfrak p$ we may assume that $I/I^2$ is free of
rank $r$. Pick $f_1, \ldots, f_r \in I$ which
give a basis of $I/I^2$. By Nakayama's lemma (see
Algebra, Lemma \ref{algebra-lemma-NAK})
we see that, after another replacement $A \leadsto A_f$ as above,
$I$ is generated by $f_1, \ldots, f_r$.

\medskip\noindent
Proof of the ``quasi-regular'' case. Above we have seen that
$I/I^2$ is free on the $r$-generators $f_1, \ldots, f_r$.
To finish the proof in this case we have to show that the maps
$\text{Sym}^d(I/I^2) \to I^d/I^{d + 1}$ are isomorphisms
for each $d \geq 2$. This is clear as the faithfully flat
base changes $\text{Sym}^d(IB/(IB)^2) \to (IB)^d/(IB)^{d + 1}$
are isomorphisms locally on $B$ by assumption.
Details omitted.

\medskip\noindent
Proof of the ``$H_1$-regular'' and ``Koszul-regular'' case.
Consider the sequence of elements $f_1, \ldots, f_r$ generating
$I$ we constructed above. By
Lemma \ref{lemma-independence-of-generators}
we see that $f_1, \ldots, f_r$ map to a $H_1$-regular or Koszul-regular
sequence in $B_g$ for any $g \in B$ such that $IB$ is generated by
an $H_1$-regular or Koszul-regular sequence. Hence
$K_\bullet(A, f_1, \ldots, f_r) \otimes_A B_g$ has vanishing
$H_1$ or $H_i$, $i > 0$. Since the homology of
$K_\bullet(B, f_1, \ldots, f_r) = K_\bullet(A, f_1, \ldots, f_r) \otimes_A B$
is annihilated by $IB$ (see
Lemma \ref{lemma-homotopy-koszul})
and since $V(IB) \subset \bigcup_{g\text{ as above}} D(g)$ we conclude that
$K_\bullet(A, f_1, \ldots, f_r) \otimes_A B$ has vanishing homology in
degree $1$ or all positive degrees. Using that $A \to B$ is faithfully
flat we conclude that the same is true for
$K_\bullet(A, f_1, \ldots, f_r)$.
\end{proof}

\begin{lemma}
\label{lemma-conormal-sequence-H1-regular-ideal}
Let $A$ be a ring. Let $I \subset J \subset A$ be ideals.
Assume that $J/I \subset A/I$ is a $H_1$-regular ideal.
Then $I \cap J^2 = IJ$.
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-conormal-sequence-H1-regular}
by localizing.
\end{proof}







\section{Local complete intersection maps}
\label{section-lci}

\noindent
We can use the material above to define a local complete intersection
map between rings using presentations by (finite) polynomial algebras.

\begin{lemma}
\label{lemma-koszul-independence-presentation}
Let $A \to B$ be a finite type ring map. If for some presentation
$\alpha : A[x_1, \ldots, x_n] \to B$ the kernel $I$ is a Koszul-regular ideal
then for any presentation $\beta : A[y_1, \ldots, y_m] \to B$ the kernel
$J$ is a Koszul-regular ideal.
\end{lemma}

\begin{proof}
Choose $f_j \in A[x_1, \ldots, x_n]$ with $\alpha(f_j) = \beta(y_j)$
and $g_i \in A[y_1, \ldots, y_m]$ with $\beta(g_i) = \alpha(x_i)$.
Then we get a commutative diagram
$$
\xymatrix{
A[x_1, \ldots, x_n, y_1, \ldots, y_m]
\ar[d]^{x_i \mapsto g_i} \ar[rr]_-{y_j \mapsto f_j} & &
A[x_1, \ldots, x_n] \ar[d] \\
A[y_1, \ldots, y_m] \ar[rr] & & B
}
$$
Note that the kernel $K$ of $A[x_i, y_j] \to B$ is equal to
$K = (I, y_j - f_j) = (J, x_i - f_i)$. In particular, as
$I$ is finitely generated by
Lemma \ref{lemma-quasi-regular-ideal-finite}
we see that $J = K/(x_i - f_i)$ is finitely generated too.

\medskip\noindent
Pick a prime $\mathfrak q \subset B$. Since
$I/I^2 \oplus B^{\oplus m} = J/J^2 \oplus B^{\oplus n}$
(Algebra, Lemma \ref{algebra-lemma-conormal-module})
we see that
$$
\dim J/J^2 \otimes_B \kappa(\mathfrak q) + n =
\dim I/I^2 \otimes_B \kappa(\mathfrak q) + m.
$$
Pick $p_1, \ldots, p_t \in I$ which map to a basis of
$I/I^2 \otimes \kappa(\mathfrak q) = I \otimes_{A[x_i]} \kappa(\mathfrak q)$.
Pick $q_1, \ldots, q_s \in J$ which map to a basis of
$J/J^2 \otimes \kappa(\mathfrak q) = J \otimes_{A[y_j]} \kappa(\mathfrak q)$.
So $s + n = t + m$. By Nakayama's lemma there exist $h \in A[x_i]$ and
$h' \in A[y_j]$ both mapping to a nonzero element of $\kappa(\mathfrak q)$
such that $I_h = (p_1, \ldots, p_t)$ in $A[x_i, 1/h]$ and
$J_{h'} = (q_1, \ldots, q_s)$ in $A[y_j, 1/h']$.
As $I$ is Koszul-regular we may also assume that $I_h$ is generated
by a Koszul regular sequence. This sequence must necessarily have length
$t = \dim I/I^2 \otimes_B \kappa(\mathfrak q)$, hence we see that
$p_1, \ldots, p_t$ is a Koszul-regular sequence by
Lemma \ref{lemma-independence-of-generators}.
As also $y_1 - f_1, \ldots, y_m - f_m$ is a regular sequence we
conclude
$$
y_1 - f_1, \ldots, y_m - f_m, p_1, \ldots, p_t
$$
is a Koszul-regular sequence in $A[x_i, y_j, 1/h]$
(see Lemma \ref{lemma-join-koszul-regular-sequences}).
This sequence generates the ideal $K_h$. Hence the
ideal $K_{hh'}$ is generated by a Koszul-regular sequence
of length $m + t = n + s$. But it is also generated by the sequence
$$
x_1 - g_1, \ldots, x_n - g_n, q_1, \ldots, q_s
$$
of the same length which is thus a Koszul-regular sequence by
Lemma \ref{lemma-independence-of-generators}.
Finally, by
Lemma \ref{lemma-truncate-koszul-regular}
we conclude that the images of $q_1, \ldots, q_s$ in
$$
A[x_i, y_j, 1/hh']/(x_1 - g_1, \ldots, x_n - g_n)
\cong A[y_j, 1/h'']
$$
form a Koszul-regular sequence generating $J_{h''}$. Since $h''$
is the image of $hh'$ it doesn't map to zero in $\kappa(\mathfrak q)$
and we win.
\end{proof}

\noindent
This lemma allows us to make the following definition.

\begin{definition}
\label{definition-local-complete-intersection}
A ring map $A \to B$ is called a {\it local complete intersection}
if it is of finite type and for some (equivalently any) presentation
$B = A[x_1, \ldots, x_n]/I$ the ideal $I$ is Koszul-regular.
\end{definition}

\noindent
This notion is local.

\begin{lemma}
\label{lemma-lci-local}
Let $R \to S$ be a ring map. Let $g_1, \ldots, g_m \in S$
generate the unit ideal. If each $R \to S_{g_j}$ is a local
complete intersection so is $R \to S$.
\end{lemma}

\begin{proof}
Let $S = R[x_1, \ldots, x_n]/I$ be a presentation. Pick
$h_j \in R[x_1, \ldots, x_n]$ mapping to $g_j$ in $S$.
Then $R[x_1, \ldots, x_n, x_{n + 1}]/(I, x_{n + 1}h_j - 1)$
is a presentation of $S_{g_j}$. Hence
$I_j = (I, x_{n + 1}h_j - 1)$ is a Koszul-regular ideal in
$R[x_1, \ldots, x_n, x_{n + 1}]$. Pick a prime
$I \subset \mathfrak q \subset R[x_1, \ldots, x_n]$.
Then $h_j \not \in \mathfrak q$ for some $j$ and
$\mathfrak q_j = (\mathfrak q, x_{n + 1}h_j - 1)$ is a prime
ideal of $V(I_j)$ lying over $\mathfrak q$.
Pick $f_1, \ldots, f_r \in I$ which map to a basis of
$I/I^2 \otimes \kappa(\mathfrak q)$. Then
$x_{n + 1}h_j - 1, f_1, \ldots, f_r$ is a sequence of elements of $I_j$
which map to a basis of $I_j \otimes \kappa(\mathfrak q_j)$.
By Nakayma's lemma there exists an $h \in R[x_1, \ldots, x_n, x_{n + 1}]$
such that $(I_j)_h$ is generated by $x_{n + 1}h_j - 1, f_1, \ldots, f_r$.
We may also assume that $(I_j)_h$ is generated by a Koszul regular
sequence of some length $e$. Looking at the dimension of
$I_j \otimes \kappa(\mathfrak q_j)$ we see that $e = r + 1$.
Hence by
Lemma \ref{lemma-independence-of-generators}
we see that $x_{n + 1}h_j - 1, f_1, \ldots, f_r$ is a
Koszul-regular sequence generating $(I_j)_h$ for some
$h \in R[x_1, \ldots, x_n, x_{n + 1}]$, $h \not \in \mathfrak q_j$. By
Lemma \ref{lemma-truncate-koszul-regular}
we see that $I_{h'}$ is generated by a Koszul-regular sequence for some
$h' \in R[x_1, \ldots, x_n]$, $h' \not \in \mathfrak q$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-relative-global-complete-intersection-koszul}
Let $R$ be a ring. Let
$R[x_1, \ldots, x_n]$. If $R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
be a relative global complete intersection. Then $f_1, \ldots, f_c$
is a Koszul regular sequence.
\end{lemma}

\begin{proof}
Recall that the homology groups $H_i(K_\bullet(f_\bullet))$ are
annihilated by the ideal $(f_1, \ldots, f_c)$. Hence it suffices
to show that $H_i(K_\bullet(f_\bullet))_\mathfrak q$ is zero for
all primes $\mathfrak q \subset R[x_1, \ldots, x_n]$
containing $(f_1, \ldots, f_c)$. This follows from
Algebra, Lemma
\ref{algebra-lemma-relative-global-complete-intersection-conormal}
and the fact that a regular sequence is Koszul regular
(Lemma \ref{lemma-regular-koszul-regular}).
\end{proof}

\begin{lemma}
\label{lemma-syntomic-lci}
A syntomic ring map is a local complete intersection.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-relative-global-complete-intersection-koszul} and
\ref{lemma-lci-local} and
Algebra, Lemma \ref{algebra-lemma-syntomic}.
\end{proof}

\noindent
For a local complete intersection $R \to S$ we have $H_n(L_{S/R}) = 0$ for
$n \geq 2$. Since we haven't (yet) defined the full cotangent complex
we can't state and prove this, but we can deduce one of the consequences.

\begin{lemma}
\label{lemma-transitive-lci-at-end}
Let $A \to B \to C$ be ring maps. Assume $B \to C$ is a local complete
intersection homomorphism. Choose a presentation
$\alpha : A[x_s, s \in S] \to B$ with kernel $I$. Choose a presentation
$\beta : B[y_1, \ldots, y_m] \to C$ with kernel $J$. Let
$\gamma : A[x_s, y_t] \to C$ be the induced presentation of $C$ with kernel
$K$. Then we get a canonical commutative diagram
$$
\xymatrix{
0 \ar[r] &
\Omega_{A[x_s]/A} \otimes C \ar[r] &
\Omega_{A[x_s, y_t]/A} \otimes C \ar[r] &
\Omega_{B[y_t]/B} \otimes C \ar[r] &
0 \\
0 \ar[r] &
I/I^2 \otimes C \ar[r] \ar[u] &
K/K^2 \ar[r] \ar[u] &
J/J^2 \ar[r] \ar[u] &
0
}
$$
with exact rows. In particular, the six term exact sequence of
Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL}
can be completed with a zero on the left, i.e., the sequence
$$
0 \to H_1(\NL_{B/A} \otimes_B C) \to
H_1(L_{C/A}) \to
H_1(L_{C/B}) \to
\Omega_{B/A} \otimes_B C \to
\Omega_{C/A} \to
\Omega_{C/B} \to 0
$$
is exact.
\end{lemma}

\begin{proof}
The only thing to prove is the injectivity of the map
$I/I^2 \otimes C \to K/K^2$.
By assumption the ideal $J$ is Koszul-regular.
Hence we have $IA[x_s, y_j] \cap K^2 = IK$ by
Lemma \ref{lemma-conormal-sequence-H1-regular-ideal}.
This means that the kernel of $K/K^2 \to J/J^2$ is
isomorphic to $IA[x_s, y_j]/IK$. Since
$I/I^2 \otimes_A C = IA[x_s, y_j]/IK$
this provides us with the desired injectivity of
$I/I^2 \otimes_A C \to K/K^2$ so that the result
follows from the snake lemma, see
Homology, Lemma \ref{homology-lemma-snake}.
\end{proof}

\begin{lemma}
\label{lemma-transitive-colimit-lci-at-end}
Let $A \to B \to C$ be ring maps.
If $B \to C$ is a filtered colimit of local complete intersection
homomorphisms then the conclusion of
Lemma \ref{lemma-transitive-lci-at-end}
remains valid.
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-transitive-lci-at-end}
and
Algebra, Lemma \ref{algebra-lemma-colimits-NL}.
\end{proof}








\section{Cartier's equality and geometric regularity}
\label{section-cartier-equality}

\noindent
A reference for this section and the next is \cite[Section 39]{MatCA}.
In order to comfortably read this section the reader should be
familiar with the naive cotangent complex and its properties, see
Algebra, Section \ref{algebra-section-netherlander}.

\begin{lemma}[Cartier equality]
\label{lemma-cartier-equality}
Let $K/k$ be a finitely generated field extension.
Then $\Omega_{K/k}$ and $H_1(L_{K/k})$ are finite dimensional and
$\text{trdeg}_k(K) = \dim_K \Omega_{K/k} - \dim_k H_1(L_{K/k})$.
\end{lemma}

\begin{proof}
We can find a global complete intersection
$A = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
over $k$ such that
$K$ is isomorphic to the fraction field of $A$, see
Algebra, Lemma \ref{algebra-lemma-colimit-syntomic}
and its proof. In this case we see that $\NL_{K/k}$ is homotopy
equivalent to the complex
$$
\bigoplus\nolimits_{j = 1, \ldots, c} K \longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} K\text{d}x_i
$$
by Algebra, Lemmas \ref{algebra-lemma-NL-homotopy} and
\ref{algebra-lemma-localize-NL}.
The transcendence degree of $K$ over $k$ is the dimension of $A$
(by Algebra, Lemma \ref{algebra-lemma-dimension-prime-polynomial-ring})
which is $n - c$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-transitivity-gamma}
Let $K \subset L \subset M$ be field extensions. Then the Jacobi-Zariski
sequence
$$
0 \to H_1(L_{L/K}) \otimes_L M \to
H_1(L_{M/K}) \to
H_1(L_{M/L}) \to
\Omega_{L/K} \otimes_L M \to
\Omega_{M/K} \to
\Omega_{M/L} \to 0
$$
is exact.
\end{lemma}

\begin{proof}
Combine
Lemma \ref{lemma-transitive-colimit-lci-at-end}
with
Algebra, Lemma \ref{algebra-lemma-colimit-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-gamma-commutative-diagram}
Given a commutative diagram of fields
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
with $k \subset k'$ and $K \subset K'$ finitely generated field extensions
the kernel and cokernel of the maps
$$
\alpha : \Omega_{K/k} \otimes_K K' \to \Omega_{K'/k'}
\quad\text{and}\quad
\beta : H_1(L_{K/k}) \otimes_K K' \to H_1(L_{K'/k'})
$$
are finite dimensional and
$$
\dim \text{Ker}(\alpha) - \dim \text{Coker}(\alpha)
-\dim \text{Ker}(\beta) + \dim \text{Coker}(\beta)
=
\text{trdeg}_k(k') - \text{trdeg}_K(K')
$$
\end{lemma}

\begin{proof}
The Jacobi-Zariski sequences for $k \subset k' \subset K'$ and
$k \subset K \subset K'$ are
$$
0 \to H_1(L_{k'/k}) \otimes K'  \to
H_1(L_{K'/k}) \to
H_1(L_{K'/k'}) \to
\Omega_{k'/k} \otimes K' \to
\Omega_{K'/k} \to
\Omega_{K'/k} \to 0
$$
and
$$
0 \to H_1(L_{K/k}) \otimes K' \to
H_1(L_{K'/k}) \to
H_1(L_{K'/K}) \to
\Omega_{K/k} \otimes K' \to
\Omega_{K'/k} \to
\Omega_{K'/K} \to 0
$$
By
Lemma \ref{lemma-cartier-equality}
the vector spaces $\Omega_{k'/k}$, $\Omega_{K'/K}$, $H_1(L_{K'/K})$, and
$H_1(L_{k'/k})$ are finite dimensional and the alternating sum of their
dimensions is $\text{trdeg}_k(k') - \text{trdeg}_K(K')$.
The lemma follows.
\end{proof}





\section{Geometric regularity}
\label{section-geometrically-regular}

\noindent
Let $k$ be a field. Let $(A, \mathfrak m, K)$ be a Noetherian local
$k$-algebra. The Jacobi-Zariski sequence
(Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL})
is a canonical exact sequence
$$
H_1(L_{K/k}) \to \mathfrak m/\mathfrak m^2 \to \Omega_{A/k} \otimes_A K \to
\Omega_{K/k} \to 0
$$
because $H_1(L_{K/A}) = \mathfrak m/\mathfrak m^2$ by
Algebra, Lemma \ref{algebra-lemma-NL-surjection}.
We will show that exactness on the left of this sequence characterizes
whether or not a regular local ring $A$ is geometrically regular over $k$.
We will link this to the notion of formal smoothness in
Section \ref{section-regular-fs}.

\begin{proposition}
\label{proposition-characterization-geometrically-regular}
Let $k$ be a field of characteristic $p > 0$.
Let $(A, \mathfrak m, K)$ be a Noetherian local
$k$-algebra. The following are equivalent
\begin{enumerate}
\item $A$ is geometrically regular over $k$,
\item for all $k \subset k' \subset k^{1/p}$
finite over $k$ the ring $A \otimes_k k'$ is regular,
\item $A$ is regular and the canonical map
$H_1(L_{K/k}) \to \mathfrak m/\mathfrak m^2$ is injective, and
\item $A$ is regular and the map
$\Omega_{k/\mathbf{F}_p} \otimes_k K \to \Omega_{A/\mathbf{F}_p} \otimes_A K$
is injective.
\end{enumerate}
\end{proposition}

\begin{proof}
Proof of (3) $\Rightarrow$ (1).
Assume (3). Let $k \subset k'$ be a finite purely inseparable extension.
Set $A' = A \otimes_k k'$. This is a local ring with maximal ideal
$\mathfrak m'$. Set $K' = A'/\mathfrak m'$. We get a commutative
diagram
$$
\xymatrix{
0 \ar[r] &
H_1(L_{K/k}) \otimes K' \ar[r] \ar[d]_\beta &
\mathfrak m/\mathfrak m^2 \otimes K' \ar[r] \ar[d] &
\Omega_{A/k} \otimes_A K' \ar[r] \ar[d]_{\cong} &
\Omega_{K/k} \otimes K' \ar[r] \ar[d]_\alpha &
0
\\
 &
H_1(L_{K'/k'}) \ar[r] &
\mathfrak m'/(\mathfrak m')^2 \ar[r] &
\Omega_{A'/k'} \otimes_{A'} K' \ar[r] &
\Omega_{K'/k'} \ar[r] &
0
}
$$
with exact rows. The third vertical arrow is an isomorphism by base
change for modules of differentials
(Algebra, Lemma \ref{algebra-lemma-differentials-base-change}).
Thus $\alpha$ is surjective. By
Lemma \ref{lemma-gamma-commutative-diagram} we have
$$
\dim \text{Ker}(\alpha) - \dim \text{Ker}(\beta) + \dim \text{Coker}(\beta) = 0
$$
(and these dimensions are all finite). A diagram chase shows that
$\dim \mathfrak m'/(\mathfrak m')^2 \leq \dim \mathfrak m/\mathfrak m^2$.
However, since $A \to A'$ is finite flat we see that
$\dim(A) = \dim(A')$, see
Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-total}.
Hence $A'$ is regular by definition.

\medskip\noindent
Equivalence of (3) and (4). Consider the Jacobi-Zariski sequences
for rows of the commutative diagram
$$
\xymatrix{
\mathbf{F}_p \ar[r] & A \ar[r] & K \\
\mathbf{F}_p \ar[r] \ar[u] & k \ar[r] \ar[u] & K \ar[u]
}
$$
to get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\mathfrak m/\mathfrak m^2 \ar[r] &
\Omega_{A/\mathbf{F}_p} \otimes_A K \ar[r] &
\Omega_{K/\mathbf{F}_p} \ar[r] & 0 & \\
0 \ar[r] &
H_1(L_{K/k}) \ar[r] \ar[u] &
\Omega_{k/\mathbf{F}_p} \otimes_k K \ar[r] \ar[u] &
\Omega_{K/\mathbf{F}_p} \ar[r] \ar[u] &
\Omega_{K/k} \ar[r] \ar[u] &
0
}
$$
with exact rows. We have used that $H_1(L_{K/A}) = \mathfrak m/\mathfrak m^2$
and that $H_1(L_{K/\mathbf{F}_p}) = 0$ as $K/\mathbf{F}_p$ is separable, see
Algebra, Proposition
\ref{algebra-proposition-characterize-separable-field-extensions}.
Thus it is clear that the kernels of
$H_1(L_{K/k}) \to \mathfrak m/\mathfrak m^2$
and
$\Omega_{k/\mathbf{F}_p} \otimes_k K \to \Omega_{A/\mathbf{F}_p} \otimes_A K$
have the same dimension.

\medskip\noindent
Proof of (2) $\Rightarrow$ (4) following Faltings, see
\cite{Faltings-einfacher}. Let $a_1, \ldots, a_n \in k$ be elements
such that $\text{d}a_1, \ldots, \text{d}a_n$ are linearly independent
in $\Omega_{k/\mathbf{F}_p}$. Consider the field extension
$k' = k(a_1^{1/p}, \ldots, a_n^{1/p})$. By
Algebra, Lemma \ref{algebra-lemma-size-extension-pth-roots}
we see that $k' = k[x_1, \ldots, x_n]/(x_1^p - a_1, \ldots, x_n^p - a_n)$.
In particular we see that the naive cotangent complex of $k'/k$
is homotopic to the complex
$\bigoplus_{j = 1, \ldots, n} k' \rightarrow \bigoplus_{i = 1, \ldots, n} k'$
with the zero differential as
$\text{d}(x_j^p - a_j) = 0$ in $\Omega_{k[x_1, \ldots, x_n]/k}$.
Set $A' = A \otimes_k k'$ and $K' = A'/\mathfrak m'$ as above.
By Algebra, Lemma \ref{algebra-lemma-change-base-NL}
we see that $\NL_{A'/A}$ is homotopy equivalent to the complex
$\bigoplus_{j = 1, \ldots, n} A' \rightarrow \bigoplus_{i = 1, \ldots, n} A'$
with the zero differential, i.e., $H_1(L_{A'/A})$ and
$\Omega_{A'/A}$ are free of rank $n$. The Jacobi-Zariski sequence for
$\mathbf{F}_p \to A \to A'$ is
$$
H_1(L_{A'/A}) \to \Omega_{A/\mathbf{F}_p} \otimes_A A'
\to \Omega_{A'/\mathbf{F}_p} \to \Omega_{A'/A} \to 0
$$
Using the presentation $A[x_1, \ldots, x_n] \to A'$ with
kernel $(x_j^p - a_j)$ we see, unwinding the maps in
Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL},
that the $j$th basis vector of $H_1(L_{A'/A})$ maps to
$\text{d}a_j \otimes 1$ in $\Omega_{A/\mathbf{F}_p} \otimes A'$.
As $\Omega_{A'/A}$ is free (hence flat) we get on tensoring with $K'$
an exact sequence
$$
K'^{\oplus n} \to \Omega_{A/\mathbf{F}_p} \otimes_A K'
\xrightarrow{\beta} \Omega_{A'/\mathbf{F}_p} \otimes_{A'} K' \to
K'^{\oplus n} \to 0
$$
We conclude that the elements $\text{d}a_j \otimes 1$ generate
$\text{Ker}(\beta)$ and we have to show that are linearly independent, i.e.,
we have to show $\dim(\text{ker}(\beta)) = n$.
Consider the following big diagram
$$
\xymatrix{
0 \ar[r] &
\mathfrak m'/(\mathfrak m')^2 \ar[r] &
\Omega_{A'/\mathbf{F}_p} \otimes K' \ar[r] &
\Omega_{K'/\mathbf{F}_p} \ar[r] & 0 \\
0 \ar[r] &
\mathfrak m/\mathfrak m^2 \otimes K' \ar[r] \ar[u]^\alpha &
\Omega_{A/\mathbf{F}_p} \otimes K' \ar[r] \ar[u]^\beta &
\Omega_{K/\mathbf{F}_p} \otimes K' \ar[r] \ar[u]^\gamma & 0
}
$$
By Lemma \ref{lemma-cartier-equality} and the Jacobi-Zariski sequence for
$\mathbf{F}_p \to K \to K'$ we see that the kernel and cokernel of
$\gamma$ have the same finite dimension.
By assumption $A'$ is regular (and of the same dimension as $A$, see
above) hence the kernel and cokernel of $\alpha$ have the same dimension.
It follows that the kernel and cokernel of $\beta$ have the same
dimension which is what we wanted to show.

\medskip\noindent
The implication (1) $\Rightarrow$ (2) is trivial. This finishes
the proof of the proposition.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-regular-over-field}
Let $k$ be a field of characteristic $p > 0$. Let $(A, \mathfrak m, K)$
be a Noetherian local $k$-algebra. Assume $A$ is geometrically regular
over $k$. Let $k \subset F \subset K$ be a finitely generated subextension.
Let $\varphi : k[y_1, \ldots, y_m] \to A$ be a $k$-algebra map
such that $y_i$ maps to an element of $F$ in $K$ and such that
$\text{d}y_1, \ldots, \text{d}y_m$ map to a basis of $\Omega_{F/k}$.
Set $\mathfrak p = \varphi^{-1}(\mathfrak m)$. Then
$$
k[y_1, \ldots, y_m]_\mathfrak p \to A
$$
is flat and $A/\mathfrak pA$ is regular.
\end{lemma}

\begin{proof}
Set $A_0 = k[y_1, \ldots, y_m]_\mathfrak p$ with maximal ideal
$\mathfrak m_0$ and residue field $K_0$. Note that
$\Omega_{A_0/k}$ is free of rank $m$ and
$\Omega_{A_0/k} \otimes K_0 \to \Omega_{K_0/k}$ is an isomorphism.
It is clear that $A_0$ is geometrically regular over $k$. Hence
$H_1(L_{K_0/k}) \to \mathfrak m_0/\mathfrak m_0^2$ is an isomorphism, see
Proposition \ref{proposition-characterization-geometrically-regular}.
Now consider
$$
\xymatrix{
H_1(L_{K_0/k}) \otimes K \ar[d] \ar[r] &
\mathfrak m_0/\mathfrak m_0^2 \otimes K \ar[d] \\
H_1(L_{K/k}) \ar[r] & \mathfrak m/\mathfrak m^2
}
$$
Since the left vertical arrow is injective by
Lemma \ref{lemma-transitivity-gamma}
and the lower horizontal by
Proposition \ref{proposition-characterization-geometrically-regular}
we conclude that the right vertical one is too.
Hence a regular system of parameters in $A_0$ maps to
part of a regular system of parameters in $A$.
We win by
Algebra, Lemmas \ref{algebra-lemma-flat-over-regular} and
\ref{algebra-lemma-regular-ring-CM}.
\end{proof}












\section{Topological rings and modules}
\label{section-topological-ring}

\noindent
Let's quickly discuss some properties of topological abelian groups.
An abelian group $M$ is a {\it topological abelian group} if $M$ is
endowed with a topology such that addition $M \times M \to M$ is
continuous. A {\it homomorphism of topological abelian groups}
is just a homomorphism of abelian groups which is continuous.
The category of commutative topological groups is additive and
has kernels and cokernels, but is not abelian (as the axiom
$\text{Im} = \text{Coim}$ doesn't hold). If $N \subset M$ is a
subgroup, then we think of $N$ and $M/N$ as topological groups
also, namely using the induced topology on $N$ and the quotient
topology on $M/N$ (i.e., such that $M \to M/N$ is submersive).
Note that if $N \subset M$ is an open subgroup, then the topology
on $M/N$ is discrete.

\medskip\noindent
We say the topology on $M$ is {\it linear} if there exists a fundamental
system of neighbourhoods of $0$ consisting of subgroups. If so then these
subgroups are also open. An example is the following. Let $I$ be a directed
partially ordered set and let $G_i$ be an inverse system of (discrete)
abelian groups over $I$. Then
$$
G = \lim_{i \in I} G_i
$$
with the inverse limit topology is linearly topologized with a fundamental
system of neighbourhoods of $0$ given by $\text{Ker}(G \to G_i)$.
Conversely, let $M$ be a linearly topologized abelian group.
Choose any fundamental system of open subgroups $U_i \subset M$, $i \in I$
(i.e., the $U_i$ form a fundamental system of open neighbourhoods and
each $U_i$ is a subgroup of $M$). Setting
$i \geq i' \Leftrightarrow U_i \subset U_{i'}$ we see that $I$
is a directed partially ordered set. We obtain a homomorphism of
linearly topologized abelian groups
$$
c : M \longrightarrow \lim_{i \in I} M/U_i.
$$
It is clear that $M$ is {\it separated} (as a topological space)
if and only if $c$ is injective. We say that $M$ is {\it complete}
if $c$ is an isomorphism\footnote{We include being separated as part
of being complete as we'd like to have a unique limits in complete
groups. There is a definition of completeness for any topological group,
agreeing, modulo the separation issue, with this one in our special case.}.
We leave it to the reader to check that this condition is independent of
the choice of fundamental system of open subgroups $\{U_i\}_{i \in I}$
chosen above. In fact the topological abelian group
$M^\wedge = \lim_{i \in I} M/U_i$ is independent of this
choice and is sometimes called the {\it completion} of $M$.
Any $G = \lim G_i$ as above is complete, in particular,
the completion $M^\wedge$ is always complete.

\begin{definition}[Topological rings]
\label{definition-topological-ring}
Let $R$ be a ring and let $M$ be an $R$-module.
\begin{enumerate}
\item We say $R$ is a {\it topological ring} if $R$ is endowed with a topology
such that both addition and multiplication are continuous as maps
$R \times R \to R$ where $R \times R$ has the product topology.
In this case we say $M$ is a {\it topological module} if $M$ is endowed
with a topology such that addition $M \times M \to M$ and
scalar multiplication $R \times M \to M$ are continuous.
\item A {\it homomorphism of topological modules} is just a continuous
$R$-module map. A {\it homomorphism of topological rings} is a
ring homomorphism which is continuous for the given topologies.
\item We say $M$ is {\it linearly topologized} if $0$ has a fundamental
system of neighbourhoods consisting of submodules. We say $R$ is
{\it linearly topologized} if $0$ has a fundamental system of neighbourhoods
consisting of ideals.
\item If $R$ is linearly topologized, we say that $I \subset R$ is an
{\it ideal of definition} if $I$ is open and if every neighbourhood
of $0$ contains $I^n$ for some $n$.
\item If $R$ is linearly topologized, we say that $R$ is {\it pre-admissible}
if $R$ has an ideal of definition.
\item If $R$ is linearly topologized, we say that $R$ is {\it admissible} if
it is pre-admissible and
complete\footnote{By our conventions this includes separated.}.
\item If $R$ is linearly topologized, we say that $R$ is {\it pre-adic} if
there exists an ideal of definition $I$ such that $\{I^n\}_{n \geq 0}$
forms a fundamental system of neighbourhoods of $0$.
\item If $R$ is linearly topologized, we say that $R$ is {\it adic} if
$R$ is pre-adic and complete.
\end{enumerate}
Note that a (pre)adic ring is the same thing as a (pre)admissible
ring which has an ideal of definition $I$ such that $I^n$ is
open for all $n \geq 1$.
\end{definition}

\noindent
Let $R$ be a ring and let $M$ be an $R$-module. Let $I \subset R$ be
an ideal. Then we can consider the linear topology on $R$ which has
$\{I^n\}_{n \geq 0}$ as a fundamental system of neighbourhoods of $0$.
This topology is called the $I$-adic topology; $R$ is a pre-adic
toplogical ring in the $I$-adic topology\footnote{Thus the $I$-adic
topology is sometimes called the $I$-pre-adic topology.}. Moreover, the
linear topology
on $M$ which has $\{I^nM\}_{n \geq 0}$ as a fundamental system of open
neighbourhoods of $0$ turns $M$ into a topological $R$-module.
This is called the {\it $I$-adic topology} on $M$. We see that
$M$ is $I$-adically complete (as defined in
Algebra, Definition \ref{algebra-definition-complete})
if and only $M$ is complete in the $I$-adic topology\footnote{
It may happen that the $I$-adic completion $M^\wedge$
is not $I$-adically complete, even though $M^\wedge$
is always complete with respect to the limit topology. If $I$ is finitely
generated then the $I$-adic topology and the limit topology on $M^\wedge$
agree, see Algebra, Lemma \ref{algebra-lemma-hathat-finitely-generated} and
its proof.}.
In particular, we see that $R$ is $I$-adically complete if and
only if $R$ is an adic topological ring in the $I$-adic topology.

\medskip\noindent
As a special case, note that the discrete topology is the $0$-adic
topology and that any ring in the discrete topology is adic.

\begin{lemma}
\label{lemma-continuous}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ and $J \subset S$ be ideals
and endow $R$ with the $I$-adic topology and $S$ with the $J$-adic
topology. Then $\varphi$ is a homomorphism of topological rings
if and only if $\varphi(I^n) \subset J$ for some $n \geq 1$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}












\section{Formally smooth maps of topological rings}
\label{section-formally-smooth}

\noindent
There is a version of formal smoothness which applies to
homomorphisms of topological rings.

\begin{definition}
\label{definition-formally-smooth}
Let $R \to S$ be a homomorphism of topological rings with $R$ and $S$
linearly topologized. We say $S$ is {\it formally smooth over $R$} if
for every commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/J \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
of homomorphisms of topological rings where $A$ is a discrete ring and
$J \subset A$ is an ideal of square zero, a dotted arrow exists which
makes the diagram commute.
\end{definition}

\noindent
We will mostly use this notion when given ideals $\mathfrak m \subset R$
and $\mathfrak n \subset S$ and we endow $R$ with the $\mathfrak m$-adic
topology and $S$ with the $\mathfrak n$-adic topology. Continuity of
$\varphi : R \to S$ holds if and only if
$\varphi(\mathfrak m^m) \subset  \mathfrak n$ for some $m \geq 1$, see
Lemma \ref{lemma-continuous}. It turns out that
in this case only the topology on $S$ is relevant.

\begin{lemma}
\label{lemma-formally-smooth}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item If $R \to S$ is formally smooth in
the sense of Algebra, Definition \ref{algebra-definition-formally-smooth},
then $R \to S$ is formally smooth for any linear topology on $R$ and
any pre-adic topology on $S$ such that $R \to S$ is continuous.
\item Let $\mathfrak n \subset S$ and $\mathfrak m \subset R$
ideals such that $\varphi$ is continuous for the $\mathfrak m$-adic
topology on $R$ and the $\mathfrak n$-adic topology
on $S$. Then the following are equivalent
\begin{enumerate}
\item $\varphi$ is formally smooth for the $\mathfrak m$-adic topology on
$R$ and the $\mathfrak n$-adic topology on $S$, and
\item $\varphi$ is formally smooth for the discrete topology
on $R$ and the $\mathfrak n$-adic topology on $S$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $R \to S$ is formally smooth in
the sense of Algebra, Definition \ref{algebra-definition-formally-smooth}.
If $S$ has a pre-adic topology, then
there exists an ideal $\mathfrak n \subset S$ such that $S$ has the
$\mathfrak n$-adic topology. Suppose given a solid commutative diagram as in
Definition \ref{definition-formally-smooth}.
Continuity of $S \to A/J$ means that $\mathfrak n^k$ maps to zero
in $A/J$ for some $k \geq 1$, see Lemma \ref{lemma-continuous}.
We obtain a ring map $\psi : S \to A$ from the assumed formal smoothness of
$S$ over $R$. Then $\psi(\mathfrak n^k) \subset J$ hence
$\psi(\mathfrak n^{2k}) = 0$ as $J^2 = 0$. Hence $\psi$ is continuous by
Lemma \ref{lemma-continuous}. This proves (1).

\medskip\noindent
The proof of (2)(b) $\Rightarrow$ (2)(a) is the same as the proof of (1).
Assume (2)(a). Suppose given a solid commutative diagram as in
Definition \ref{definition-formally-smooth} where we use the discrete
topology on $R$. Since $\varphi$ is continuos we see that
$\varphi(\mathfrak m^n) \subset \mathfrak n$ for some $m \geq 1$.
As $S \to A/J$ is continuous we see that $\mathfrak n^k$ maps to
zero in $A/J$ for some $k \geq 1$. Hence $\mathfrak m^{nk}$ maps
in $J$ under the map $R \to A$. Thus $\mathfrak m^{2nk}$ maps to zero
in $A$ and we see that $R \to A$ is continuous in the $\mathfrak m$-adic
topology. Thus (2)(a) gives a dotted arrow as desired.
\end{proof}

\begin{definition}
\label{definition-formally-smooth-adic}
Let $R \to S$ be a ring map. Let $\mathfrak n \subset S$ be an
ideal. If the equivalent conditions (2)(a) and (2)(b) of
Lemma \ref{lemma-formally-smooth} hold, then we say
$R \to S$ is {\it formally smooth for the $\mathfrak n$-adic topology}.
\end{definition}

\noindent
This property is inherited by the completions.

\begin{lemma}
\label{lemma-formally-smooth-completion}
Let $(R, \mathfrak m)$ and $(S, \mathfrak n)$ be rings endowed
with finitely generated ideals. Endow $R$ and $S$ with the
$\mathfrak m$-adic and $\mathfrak n$-adic topologies.
Let $R \to S$ be a homomorphism of topological rings.
The following are equivalent
\begin{enumerate}
\item $R \to S$ is formally smooth for the $\mathfrak n$-adic topology,
\item $R \to S^\wedge$ is formally smooth for the $\mathfrak n^\wedge$-adic
topology,
\item $R^\wedge \to S^\wedge$ is formally smooth for the
$\mathfrak n^\wedge$-adic topology.
\end{enumerate}
Here $R^\wedge$ and $S^\wedge$ are the $\mathfrak m$-adic and
$\mathfrak n$-adic completions of $R$ and $S$.
\end{lemma}

\begin{proof}
The assumption that $\mathfrak m$ is finitely generated implies that
$R^\wedge$ is $\mathfrak mR^\wedge$-adically complete, that
$\mathfrak mR^\wedge = \mathfrak m^\wedge$ and that
$R^\wedge/\mathfrak m^nR^\wedge = R/\mathfrak m^n$,
see Algebra, Lemma \ref{algebra-lemma-hathat-finitely-generated}
and its proof. Similarly for $(S, \mathfrak n)$. Thus it is clear that
diagrams as in Definition \ref{definition-formally-smooth}
for the cases (1), (2), and (3) are in 1-to-1 correspondence.
\end{proof}

\noindent
The advantage of working with adic rings is that one gets a
stronger lifting property.

\begin{lemma}
\label{lemma-lift-continuous}
Let $R \to S$ be a ring map. Let $\mathfrak n$ be an ideal of $S$.
Assume that $R \to S$ is formally smooth in the $\mathfrak n$-adic
topology. Consider a solid commutative diagram
$$
\xymatrix{
S \ar[r]_\psi \ar@{-->}[rd] & A/J \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
of homomorphisms of topological rings where $A$ is adic
and $A/J$ is the quotient (as topological ring) of $A$ by a closed ideal
$J \subset A$ such that $J^t$ is contained in an ideal of definition
of $A$ for some $t \geq 1$. Then there exists a dotted arrow in the category of
topological rings which makes the diagram commute.
\end{lemma}

\begin{proof}
Let $I \subset A$ be an ideal of definition so that $I \supset J^t$
for some $n$. Then $A = \lim A/I^n$ and $A/J = \lim A/J + I^n$
because $J$ is assumed closed. Consider the following diagram of
discrete $R$ algebras $A_{n, m} = A/J^n + I^m$:
$$
\xymatrix{
A/J^3 + I^3 \ar[r] \ar[d] &
A/J^2 + I^3 \ar[r] \ar[d] &
A/J + I^3 \ar[d] \\
A/J^3 + I^2 \ar[r] \ar[d] &
A/J^2 + I^2 \ar[r] \ar[d] &
A/J + I^2 \ar[d] \\
A/J^3 + I \ar[r] &
A/J^2 + I \ar[r] &
A/J + I
}
$$
Note that each of the commutative squares defines a surjection
$$
A_{n + 1, m + 1} \longrightarrow A_{n + 1, m} \times_{A_{n, m}} A_{n, m + 1}
$$
of $R$-algebras whose kernel has square zero.
We will inductively construct $R$-algebra maps
$\varphi_{n, m} : S \to A_{n, m}$.
Namely, we have the maps $\varphi_{1, m} = \psi \bmod J + I^m$.
Note that each of these maps is continuous as $\psi$ is.
We can inductively choose the maps $\varphi_{n, 1}$ by starting
with our choice of $\varphi_{1, 1}$ and lifting up, using the
formal smoothness of $S$ over $R$, along the right column of the
diagram above. We construct the remaining maps $\varphi_{n, m}$
by induction on $n + m$. Namely, we choose $\varphi_{n + 1, m + 1}$
by lifting the pair $(\varphi_{n + 1, m}, \varphi_{n, m + 1})$
along the displayed surjection above (again using the formal smoothness
of $S$ over $R$). In this way all of the maps $\varphi_{n, m}$ are
compatible with the transition maps of the system.
As $J^t \subset I$ we see that for example
$\varphi_n = \varphi_{nt, n} \bmod I^n$ induces a map $S \to A/I^n$.
Taking the limit $\varphi = \lim \varphi_n$ we obtain a map
$S \to A = \lim A/I^n$. The composition into $A/J$ agrees
with $\psi$ as we have seen that $A/J = \lim A/J + I^n$.
Finally we show that $\varphi$ is continuous. Namely, we know that
$\psi(\mathfrak n^r) \subset J + I^r/J$ for some $r$ by our
assumption that $\psi$ is a morphism of topological rings, see
Lemma \ref{lemma-continuous}. Hence $\varphi(\mathfrak n^r) \subset J + I$
hence $\varphi(\mathfrak n^{rt}) \subset I$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-increase-ideal}
Let $R \to S$ be a ring map. Let $\mathfrak n \subset \mathfrak n' \subset S$
be ideals. If $R \to S$ is formally smooth for the $\mathfrak n$-adic
topology, then $R \to S$ is formally smooth for the $\mathfrak n'$-adic
topology.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-compose-formally-smooth}
A composition of formally smooth continuous homomorphisms of linearly
topologized rings is formally smooth.
\end{lemma}

\begin{proof}
Omitted. (Hint: This is completely formal, and follows from considering
a suitable diagram.)
\end{proof}

\begin{lemma}
\label{lemma-base-change-fs}
Let $R$, $S$ be rings. Let $\mathfrak n \subset S$ be an ideal.
Let $R \to S$ be formally smooth for the $\mathfrak n$-adic topology.
Let $R \to R'$ be any ring map. Then $R' \to S' = S \otimes_R R'$
is formally smooth in the $\mathfrak n' = \mathfrak nS'$-adic
topology.
\end{lemma}

\begin{proof}
Let a solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rrd] & S' \ar[r] \ar@{-->}[rd] & A/J \\
R  \ar[u] \ar[r] & R' \ar[r] \ar[u] & A \ar[u]
}
$$
as in Definition \ref{definition-formally-smooth} be given.
Then the composition $S \to S' \to A/J$ is continuous.
By assumption the longer dotted arrow exists. By the universal
property of tensor product we obtain the shorter dotted arrow.
\end{proof}

\noindent
We have seen descent for formal smoothness along faithfully flat ring
maps in Algebra, Lemma \ref{algebra-lemma-descent-formally-smooth}.
Something similar holds in the current setting of topological rings.
However, here we just prove the following very simple and easy to prove
version which is already quite useful.

\begin{lemma}
\label{lemma-descent-fs}
Let $R$, $S$ be rings. Let $\mathfrak n \subset S$ be an ideal.
Let $R \to R'$ be a ring map. Set $S' = S \otimes_R R'$ and
$\mathfrak n' = \mathfrak nS$. If
\begin{enumerate}
\item the map $R \to R'$ embeds $R$ as a direct summand of $R'$
as an $R$-module, and
\item $R' \to S'$ is formally smooth for the $\mathfrak n'$-adic topology,
\end{enumerate}
then $R \to S$ is formally smooth in the $\mathfrak n$-adic topology.
\end{lemma}

\begin{proof}
Let a solid diagram
$$
\xymatrix{
S \ar[r] & A/J \\
R \ar[u] \ar[r] & A \ar[u]
}
$$
as in Definition \ref{definition-formally-smooth} be given.
Set $A' = A \otimes_R R'$ and $J' = \text{Im}(J \otimes_R R' \to A')$.
The base change of the diagram above is the diagram
$$
\xymatrix{
S' \ar[r] \ar@{-->}[rd]^{\psi'} & A'/J' \\
R' \ar[u] \ar[r] & A' \ar[u]
}
$$
with continuous arrows. By condition (2) we obtain the dotted arrow
$\psi' : S' \to A'$. Using condition (1) choose a direct summand decomposition
$R' = R \oplus C$ as $R$-modules. (Warning: $C$ isn't an ideal in $R'$.)
Then $A' = A \oplus A \otimes_R C$. Set
$$
J'' = \text{Im}(J \otimes_R C \to A \otimes_R C) \subset J' \subset A'.
$$
Then $J' = J \oplus J''$ as $A$-modules. The image of the composition
$\psi : S \to A'$ of $\psi'$ with $S \to S'$ is contained in
$A + J' = A \oplus J''$. However, in the ring $A + J' = A \oplus J''$
the $A$-submodule $J''$ is an ideal! (Use that $J^2 = 0$.) Hence the
composition $S \to A + J' \to (A + J')/J'' = A$ is the arrow we were
looking for.
\end{proof}

\noindent
The following lemma will be improved on in
Section \ref{section-regular-fs}.

\begin{lemma}
\label{lemma-fs-implies-regular}
Let $k$ be a field and let $(A, \mathfrak m, K)$ be a Noetherian
local $k$-algebra. If $k \to A$ is formally smooth for the
$\mathfrak m$-adic topology, then $A$ is a regular local ring.
\end{lemma}

\begin{proof}
Let $k_0 \subset k$ be the prime field. Then $k_0$ is perfect, hence
$k / k_0$ is separable, hence formally smooth by
Algebra, Lemma \ref{algebra-lemma-formally-smooth-extensions-easy}. By
Lemmas \ref{lemma-formally-smooth} and \ref{lemma-compose-formally-smooth}
we see that $k_0 \to A$ is formally smooth for the $\mathfrak m$-adic
topology on $A$. Hence we may assume $k = \mathbf{Q}$ or $k = \mathbf{F}_p$.

\medskip\noindent
By Algebra, Lemmas \ref{algebra-lemma-completion-faithfully-flat} and
\ref{algebra-lemma-flat-under-regular} it
suffices to prove the completion $A^\wedge$ is regular.
By Lemma \ref{lemma-formally-smooth-completion} we may replace
$A$ by $A^\wedge$. Thus we may assume that $A$ is a Noetherian
complete local ring. By the Cohen structure theorem
(Algebra, Theorem \ref{algebra-theorem-cohen-structure-theorem})
there exist a map $K \to A$. As $k$ is the prime field we see that
$K \to A$ is a $k$-algebra map.

\medskip\noindent
Let $x_1, \dots, x_n \in \mathfrak m$ be elements whose images
form a basis of $\mathfrak m/\mathfrak m^2$.
Set $T = K[[X_1, \dots, X_n]]$. Note that
$$
A/\mathfrak m^2 \cong K[x_1, \ldots, x_n]/(x_ix_j)
$$
and
$$
T/\mathfrak m_T^2 \cong K[X_1, \ldots, X_n]/(X_iX_j).
$$
Let $A/\mathfrak m^2 \to T/m_T^2$ be the local $K$-algebra isomorphism
given by mapping the class of $x_i$ to the class of $X_i$.
Denote $f_1 : A \to T/\mathfrak m_T^2$ the composition of this
isomorphism with the quotient map $A \to A/\mathfrak m^2$.
The assumption that $k \to A$ is formally smooth in the $\mathfrak m$-adic
topology means we can lift $f_1$ to a map
$f_2 : A \to T/\mathfrak{m}_T^3$, then to a map
$f_3 : A \to T/\mathfrak{m}_T^4$, and so on, for all $n \geq 1$.
Warning: the maps $f_n$ are continuous $k$-algebra maps and may not
be $K$-algebra maps. We get an induced map
$f : A \to T = \lim T/\mathfrak m_T^n$ of local $k$-algebras.
By our choice of $f_1$, the map $f$ induces an
isomorphism $\mathfrak m/\mathfrak m^2 \to \mathfrak m_T/\mathfrak m_T^2$
hence each $f_n$ is surjective and we conclude $f$ is surjective as $A$ is
complete. This implies $\dim(A) \geq \dim(T) = n$. Hence $A$ is regular
by definition. (It also follows that $f$ is an isomorphism.)
\end{proof}

\noindent
The following result will be improved on in
Section \ref{section-regular-fs}

\begin{lemma}
\label{lemma-regular-implies-fs}
Let $k$ be a field. Let $(A, \mathfrak m, K)$ be a regular local
$k$-algebra such that $K/k$ is separable. Then $k \to A$
is formally smooth in the $\mathfrak m$-adic topology.
\end{lemma}

\begin{proof}
It suffices to prove that the completion of $A$ is formally
smooth over $k$, see Lemma \ref{lemma-formally-smooth-completion}.
Hence we may assume that $A$ is a complete local regular $k$-algebra
with residue field $K$ separable over $k$. Since $K$ is formally
smooth over $k$ by Algebra, Proposition
\ref{algebra-proposition-characterize-separable-field-extensions}
we can successively find maps
$$
\xymatrix{
& & & K \ar@{-->}[llld] \ar@{-->}[lld] \ar@{-->}[ld] \ar[d] \\
\ldots \ar[r] &
A/\mathfrak m^4 \ar[r] &
A/\mathfrak m^3 \ar[r] &
A/\mathfrak m^2 \ar[r] &
K
}
$$
of $k$-algebras. Since $A$ is complete this defines a $k$-algebra
map $K \to A$. Pick $a_1, \ldots, a_n \in \mathfrak m$ which map to
a $K$-basis of $\mathfrak m/\mathfrak m^2$. Consider the $K$-algebra map
$$
c : K[[x_1, \ldots, x_n]] \longrightarrow A
$$
which maps $x_i$ to $a_i$ (existence of $c$ follows from
the universal property of the powerseries ring). By construction the maps
$K[[x_1, \ldots, x_n]] \to A/\mathfrak m^e$ are surjective for all
$e \geq 1$. Since $K[[x_1, \ldots, x_n]]$ is complete we see that $c$
is surjective. Since $\dim(A) = n$ as $A$ is regular and since
$K[[x_1, \ldots, x_n]]$ is a domain of dimension $n$ we see that the
kernel of $c$ is zero. Hence $c$ is an isomorphism.

\medskip\noindent
We win because the power series ring $K[[x_1, \ldots, x_n]]$ is formally
smooth over $k$. Namely, $K$ is formally smooth over $k$ and
$K[x_1, \ldots, x_n]$ is formally smooth over $K$ as a polynomial algebra.
Hence $K[x_1, \ldots, x_n]$ is formally smooth over $k$ by
Algebra, Lemma \ref{algebra-lemma-compose-formally-smooth}.
It follows that $k \to K[x_1, \ldots, x_n]$ is formally smooth
for the $(x_1, \ldots, x_n)$-adic topology by
Lemma \ref{lemma-formally-smooth}.
Finally, it follows that $k \to K[[x_1, \ldots, x_n]]$ is formally
smooth for the $(x_1, \ldots, x_n)$-adic topology by
Lemma \ref{lemma-formally-smooth-completion}.
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth-finite-type}
Let $A \to B$ be a finite type ring map with $A$ Noetherian.
Let $\mathfrak q \subset B$ be a prime ideal lying over
$\mathfrak p \subset A$. The following are equivalent
\begin{enumerate}
\item $A \to B$ is smooth at $\mathfrak q$, and
\item $A_\mathfrak p \to B_\mathfrak q$ is formally smooth in
the $\mathfrak q$-adic topology.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Algebra, Lemma \ref{algebra-lemma-smooth-test-artinian}.
Conversely, if $A \to B$ is smooth at $\mathfrak q$, then
$A \to B_g$ is smooth for some $g \in B$, $g \not \in \mathfrak q$.
Then $A \to B_g$ is formally smooth by
Algebra, Proposition \ref{algebra-proposition-smooth-formally-smooth}.
Hence $A_\mathfrak p \to B_\mathfrak q$ is formally smooth
as localization preserves formal smoothness (for example by
the criterion of Algebra, Proposition
\ref{algebra-proposition-characterize-formally-smooth}
and the fact that the cotangent complex behaves well with respect to
localization, see
Algebra, Lemmas \ref{algebra-lemma-NL-localize-bottom} and
\ref{algebra-lemma-localize-NL}).
Finally, Lemma \ref{lemma-formally-smooth} implies that
$A_\mathfrak p \to B_\mathfrak q$ is formally smooth in the
$\mathfrak q$-adic topology.
\end{proof}









\section{Some results on power series rings}
\label{section-power-series}

\noindent
Questions on formally smooth maps between Noetherian local rings
can often be reduced to questions on maps between power series
rings. In this section we prove some helper lemmas to facilitate
this kind of argument.

\begin{lemma}
\label{lemma-power-series-ring-over-Cohen-fs}
Let $K$ be a field of characteristic $0$ and $A = K[[x_1, \ldots, x_n]]$.
Let $L$ be a field of characteristic $p > 0$ and $B = L[[x_1, \ldots, x_n]]$.
Let $\Lambda$ be a Cohen ring. Let $C = \Lambda[[x_1, \ldots, x_n]]$.
\begin{enumerate}
\item $\mathbf{Q} \to A$ is formally smooth in the 
$\mathfrak m$-adic topology.
\item $\mathbf{F}_p \to B$ is formally smooth in the 
$\mathfrak m$-adic topology.
\item $\mathbf{Z} \to C$ is formally smooth in the
$\mathfrak m$-adic topology.
\end{enumerate}
\end{lemma}

\begin{proof}
By the universal property of power series rings it suffices to prove:
\begin{enumerate}
\item $\mathbf{Q} \to K$ is formally smooth.
\item $\mathbf{F}_p \to L$ is formally smooth.
\item $\mathbf{Z} \to \Lambda$ is formally smooth in the
$\mathfrak m$-adic topology.
\end{enumerate}
The first two are
Algebra, Proposition
\ref{algebra-proposition-characterize-separable-field-extensions}.
The third follows from
Algebra, Lemma \ref{algebra-lemma-cohen-ring-formally-smooth}
since for any test diagram as in Definition \ref{definition-formally-smooth}
some power of $p$ will be zero in $A/J$ and hence some power of $p$ will
be zero in $A$.
\end{proof}

\begin{lemma}
\label{lemma-quotient-power-series-ring-over-Cohen}
Let $K$ be a field and $A = K[[x_1, \ldots, x_n]]$.
Let $\Lambda$ be a Cohen ring and let $B = \Lambda[[x_1, \ldots, x_n]]$.
\begin{enumerate}
\item If $y_1, \ldots, y_n \in A$ is a regular system of parameters
then $K[[y_1, \ldots, y_n]] \to A$ is an isomorphism.
\item If $z_1, \ldots, z_r \in A$ form part of a regular system of
parameters for $A$, then $r \leq n$ and
$A/(z_1, \ldots, z_r) \cong K[[y_1, \ldots, y_{n - r}]]$.
\item If $p, y_1, \ldots, y_n \in B$ is a regular system of parameters
then $\Lambda[[y_1, \ldots, y_n]] \to B$ is an isomorphism.
\item If $p, z_1, \ldots, z_r \in B$ form part of a regular system of
parameters for $B$, then $r \leq n$ and
$B/(z_1, \ldots, z_r) \cong \Lambda[[y_1, \ldots, y_{n - r}]]$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Set $A' = K[[y_1, \ldots, y_n]]$. It is clear that
the map $A' \to A$ induces an isomorphism
$A'/\mathfrak m_{A'}^n \to A/\mathfrak m_A^n$ for all $n \geq 1$.
Since $A$ and $A'$ are both complete we deduce that $A' \to A$ is an
isomorphism.
Proof of (2). Extend $z_1, \ldots, z_r$ to a regular system of parameters
$z_1, \ldots, z_r, y_1, \ldots, y_{n - r}$ of $A$. Consider the map
$A' = K[[z_1, \ldots, z_r, y_1, \ldots, y_{n - r}]] \to A$.
This is an isomorphism by (1). Hence (2) follows as it is clear that
$A'/(z_1, \ldots, z_r) \cong K[[y_1, \ldots, y_{n - r}]]$.
The proofs of (3) and (4) are exactly the same as the proofs of (1) and (2).
\end{proof}

\begin{lemma}
\label{lemma-embed-map-Noetherian-complete-local-rings}
Let $A \to B$ be a local homomorphism of Noetherian complete local rings.
Then there exists a commutative diagram
$$
\xymatrix{
S \ar[r] & B \\
R \ar[u] \ar[r] & A \ar[u]
}
$$
with the following properties:
\begin{enumerate}
\item the horizontal arrows are surjective,
\item if the characteristic of $A/\mathfrak m_A$ is zero, then $S$ and $R$
are power series rings over fields,
\item if the characteristic of $A/\mathfrak m_A$ is $p > 0$, then $S$ and $R$
are power series rings over Cohen rings, and
\item $R \to S$ maps a regular system of parameters of $R$ to part of a
regular system of parameters of $S$.
\end{enumerate}
In particular $R \to S$ is flat (see Algebra,
Lemma \ref{algebra-lemma-flat-over-regular}) with regular fibre
$S/\mathfrak m_R S$ (see Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}).
\end{lemma}

\begin{proof}
Use the Cohen structure theorem
(Algebra, Theorem \ref{algebra-theorem-cohen-structure-theorem})
to choose a surjection $S \to B$ as in the statement of the lemma
where we choose $S$ to be a power series over a Cohen ring if the
residue characteristic is $p > 0$ and a power series over a field else.
Let $J \subset S$ be the kernel of $S \to B$.
Next, choose a surjection $R = \Lambda[[x_1, \ldots, x_n]] \to A$ where
we choose $\Lambda$ to be a Cohen ring if the residue characteristic of
$A$ is $p > 0$ and $\Lambda$ equal to the residue field of $A$ otherwise.
We lift the composition $\Lambda[[x_1, \ldots, x_n]] \to A \to B$
to a map $\varphi : R \to S$. This is possible because
$\Lambda[[x_1, \ldots, x_n]]$ is formally smooth over $\mathbf{Z}$
in the $\mathfrak m$-adic topology (see
Lemma \ref{lemma-power-series-ring-over-Cohen-fs})
by an application of Lemma \ref{lemma-lift-continuous}.
Finally, we replace $\varphi$ by the map
$\varphi' : R = \Lambda[[x_1, \ldots, x_n]] \to S' = S[[y_1, \ldots, y_n]]$
with $\varphi'|_\Lambda = \varphi|_\Lambda$ and
$\varphi'(x_i) = \varphi(x_i) + y_i$. We also replace $S \to B$
by the map $S' \to B$ which maps $y_i$ to zero. After this replacement
it is clear that a regular system of parameters of $R$ maps to part of a
regular sequence in $S'$ and we win.
\end{proof}







\section{Geometric regularity and formal smoothness}
\label{section-regular-fs}

\noindent
In this section we combine the results of the previous
sections to prove the following characterization of geometrically
regular local rings over fields. We then recycle some of our
arguments to prove a characterization of formally smooth
maps in the $\mathfrak m$-adic topology between Noetherian local
rings.

\begin{theorem}
\label{theorem-regular-fs}
Let $k$ be a field. Let $(A, \mathfrak m, K)$ be a Noetherian local
$k$-algebra. If the characteristic of $k$ is zero then the following
are equivalent
\begin{enumerate}
\item $A$ is a regular local ring, and
\item $k \to A$ is formally smooth in the $\mathfrak m$-adic topology.
\end{enumerate}
If the characteristic of $k$ is $p > 0$ then the following are equivalent
\begin{enumerate}
\item $A$ is geometrically regular over $k$,
\item $k \to A$ is formally smooth in the $\mathfrak m$-adic topology.
\item for all $k \subset k' \subset k^{1/p}$
finite over $k$ the ring $A \otimes_k k'$ is regular,
\item $A$ is regular and the canonical map
$H_1(L_{K/k}) \to \mathfrak m/\mathfrak m^2$ is injective, and
\item $A$ is regular and the map
$\Omega_{k/\mathbf{F}_p} \otimes_k K \to \Omega_{A/\mathbf{F}_p} \otimes_A K$
is injective.
\end{enumerate}
\end{theorem}

\begin{proof}
If the characteristic of $k$ is zero, then the equivalence of (1) and (2)
follows from
Lemmas \ref{lemma-fs-implies-regular} and \ref{lemma-regular-implies-fs}.

\medskip\noindent
If the characteristic of $k$ is $p > 0$, then it follows from
Proposition \ref{proposition-characterization-geometrically-regular}
that (1), (3), (4), and (5) are equivalent. Assume (2) holds.
By Lemma \ref{lemma-base-change-fs} we see that
$k' \to A' = A \otimes_k k'$ is formally smooth for the
$\mathfrak m' = \mathfrak mA$-adic topology. Hence if $k \subset k'$ is
finite purely inseparable, then $A'$ is a regular local ring by
Lemma \ref{lemma-fs-implies-regular}. Thus we see that (1) holds.

\medskip\noindent
Finally, we will prove that (5) implies (2). Choose a solid diagram
$$
\xymatrix{
A \ar[r]_{\bar\psi} \ar@{-->}[rd] & B/J \\
k \ar[u]^i \ar[r]^\varphi & B \ar[u]_\pi
}
$$
as in Definition \ref{definition-formally-smooth}. As $J^2 = 0$ we see
that $J$ has a canonical $B/J$ module structure and via $\bar\psi$ an
$A$-module structure. As $\bar\psi$ is continuous for the
$\mathfrak m$-adic topology we see that $\mathfrak m^nJ = 0$ for some $n$.
Hence we can filter $J$ by $B/J$-submodules
$0 \subset J_1 \subset J_2 \subset \ldots \subset J_n = J$
such that each quotient $J_{t + 1}/J_t$ is annihilated by $\mathfrak m$.
Considering the sequence of ring maps
$B \to B/J_1 \to B/J_2 \to \ldots \to B/J$
we see that it suffices to prove the existence of the dotted arrow when
$J$ is annihilated by $\mathfrak m$, i.e., when $J$ is a $K$-vector space.

\medskip\noindent
Assume given a diagram as above such that $J$ is annihilated by $\mathfrak m$.
By Lemma \ref{lemma-regular-implies-fs} we see that $\mathbf{F}_p \to A$ is
formally smooth in the $\mathfrak m$-adic topology. Hence we can find a ring
map $\psi : A \to B$ such that $\pi \circ \psi = \bar \psi$. Then
$\psi \circ i, \varphi : k \to B$ are two maps whose compositions with $\pi$
are equal. Hence $D = \psi \circ i - \varphi : k \to J$ is a derivation.
By Algebra, Lemma \ref{algebra-lemma-universal-omega} we can write
$D = \xi \circ \text{d}$ for some $k$-linear map
$\xi : \Omega_{k/\mathbf{F}_p} \to J$. Using the $K$-vector space structure
on $J$ we extend $\xi$ to a $K$-linear map
$\xi' : \Omega_{k/\mathbf{F}_p} \otimes_k K \to J$.
Using (5) we can find a $K$-linear map
$\xi'' : \Omega_{A/\mathbf{F}_p} \otimes_A K$ whose restriction to
$\Omega_{k/\mathbf{F}_p} \otimes_k K$ is $\xi'$. Write
$$
D' : A \xrightarrow{\text{d}} \Omega_{A/\mathbf{F}_p}
\to \Omega_{A/\mathbf{F}_p} \otimes_A K \xrightarrow{\xi''} J.
$$
Finally, set $\psi' = \psi - D' : A \to B$. The reader verifies that $\psi'$
is a ring map such that $\pi \circ \psi' = \bar \psi$ and such that
$\psi' \circ i = \varphi$ as desired.
\end{proof}

\begin{example}
\label{example-fs}
Let $k$ be a field of characteristic $p > 0$. Suppose that $a \in k$
is an element which is not a $p$th power. A standard example of a
geometrically regular local $k$-algebra whose residue field is
purely inseparable over $k$ is the ring
$$
A = k[x, y]_{(x, y^p - a)}/(y^p - a - x)
$$
Namely, $A$ is a localization of a smooth algebra over $k$ hence $k \to A$
is formally smooth, hence $k \to A$ is formally smooth for the
$\mathfrak m$-adic topology. A closely related example
is the following. Let $k = \mathbf{F}_p(s)$ and $K = \mathbf{F}_p(t)^{perf}$.
We claim the ring map
$$
k \longrightarrow A = K[[x]],\quad s \longmapsto t + x
$$
is formally smooth for the $(x)$-adic topology on $A$. Namely,
$\Omega_{k/\mathbf{F}_p}$ is $1$-dimensional with basis $\text{d}s$.
It maps to the element
$\text{d}x + \text{d}t = \text{d}x$ in $\Omega_{A/\mathbf{F}_p}$.
We leave it to the reader to show that $\Omega_{A/\mathbf{F}_p}$ is
free on $\text{d}x$ as an $A$-module. Hence we see that condition (5)
of Theorem \ref{theorem-regular-fs} holds and we conclude that $k \to A$
is formally smooth in the $(x)$-adic topology.
\end{example}

\begin{lemma}
\label{lemma-formally-smooth-flat}
Let $A \to B$ be a local homomorphism of Noetherian local rings.
Assume $A \to B$ is formally smooth in the $\mathfrak m_B$-adic
topology. Then $A \to B$ is flat.
\end{lemma}

\begin{proof}
We may assume that $A$ and $B$ a Noetherian complete local rings
by Lemma \ref{lemma-formally-smooth-completion} and
Algebra, Lemma \ref{algebra-lemma-completion-Noetherian-Noetherian}
(this also uses
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general} and
\ref{algebra-lemma-completion-faithfully-flat}
to see that flatness of the map on completions implies flatness of
$A \to B$).
Choose a commutative diagram
$$
\xymatrix{
S \ar[r] & B \\
R \ar[u] \ar[r] & A \ar[u]
}
$$
as in Lemma \ref{lemma-embed-map-Noetherian-complete-local-rings}
with $R \to S$ flat. Let $I \subset R$ be the kernel of $R \to A$.
Because $B$ is formally smooth over $A$ we see that the $A$-algebra map
$$
S/IS \longrightarrow B
$$
has a section, see Lemma \ref{lemma-lift-continuous}.
Hence $B$ is a direct summand of the flat $A$-module $S/IS$
(by base change of flatness, see
Algebra, Lemma \ref{algebra-lemma-flat-base-change}),
whence flat.
\end{proof}

\begin{proposition}
\label{proposition-fs-flat-fibre-fs}
Let $A \to B$ be a local homomorphism of Noetherian local rings.
Let $k$ be the residue field of $A$ and $\overline{B} = B \otimes_A k$
the special fibre. The following are equivalent
\begin{enumerate}
\item $A \to B$ is flat and $\overline{B}$ is geometrically regular
over $k$,
\item $A \to B$ is flat and $k \to \overline{B}$ is formally smooth
in the $\mathfrak m_{\overline{B}}$-adic topology, and
\item $A \to B$ is formally smooth in the $\mathfrak m_B$-adic
topology.
\end{enumerate}
\end{proposition}

\begin{proof}
The equivalence of (1) and (2) follows from Theorem \ref{theorem-regular-fs}.

\medskip\noindent
Assume (3). By Lemma \ref{lemma-formally-smooth-flat} we see that
$A \to B$ is flat. By Lemma \ref{lemma-base-change-fs} we see that
$k \to \overline{B}$ is formally smooth in the
$\mathfrak m_{\overline{B}}$-adic topology. Thus (2) holds.

\medskip\noindent
Assume (2). Lemma \ref{lemma-formally-smooth-completion}
tells us formal smoothness is preserved under completion. The same is true
for flatness by Algebra, Lemma \ref{algebra-lemma-completion-faithfully-flat}.
Hence we may replace $A$ and $B$ by their respective completions and
assume that $A$ and $B$ are Noetherian complete local rings.
In this case choose a diagram
$$
\xymatrix{
S \ar[r] & B \\
R \ar[u] \ar[r] & A \ar[u]
}
$$
as in Lemma \ref{lemma-embed-map-Noetherian-complete-local-rings}.
We will use all of the properties of this diagram without further mention.
Fix a regular system of parameters $t_1, \ldots, t_d$ of $R$
with $t_1 = p$ in case the characteristic of $k$ is $p > 0$.
Set $\overline{S} = S \otimes_R k$. Consider the short exact sequence
$$
0 \to J \to S \to B \to 0
$$
Since $B$ is flat over $A$ we see that $J \otimes_R k$ is the kernel
of $\overline{S} \to \overline{B}$. As $\overline{B}$ and $\overline{S}$
are regular we see that $J \otimes_R k$ is generated by elements
$\overline{x}_1, \ldots, \overline{x}_r$ which form part of a regular
system of parameters of $\overline{S}$, see
Algebra, Lemma \ref{algebra-lemma-regular-quotient-regular}.
Lift these elements to $x_1, \ldots, x_r \in J$. Then
$t_1, \ldots, t_d, x_1, \ldots, x_r$ is part of a regular system of
parameters for $S$. Hence $S/(x_1, \ldots, x_r)$ is a power
series ring over a field (if the characteristic of $k$ is zero)
or a power series ring over a Cohen ring (if the characteristic of
$k$ is $p > 0$), see
Lemma \ref{lemma-quotient-power-series-ring-over-Cohen}.
Moreover, it is still the case that $R \to S/(x_1, \ldots, x_r)$
maps $t_1, \ldots, t_d$ to a part of a regular system of parameters
of $S/(x_1, \ldots, x_r)$. In other words, we may replace $S$ by
$S/(x_1, \ldots, x_r)$ and assume we have a diagram
$$
\xymatrix{
S \ar[r] & B \\
R \ar[u] \ar[r] & A \ar[u]
}
$$
as in Lemma \ref{lemma-embed-map-Noetherian-complete-local-rings}
with moreover $\overline{S} = \overline{B}$. In this case the map
$$
S \otimes_R A \longrightarrow B
$$
is an isomorphism as it is surjective and an isomorphism on special
fibres, see Algebra, Lemma \ref{algebra-lemma-mod-injective}. Thus by
Lemma \ref{lemma-base-change-fs}
it suffices to show that $R \to S$ is formally
smooth in the $\mathfrak m_S$-adic topology.
Of course, since $\overline{S} = \overline{B}$, we have
that $\overline{S}$ is formally smooth over $k = R/\mathfrak m_R$.

\medskip\noindent
Choose elements $y_1, \ldots, y_m \in S$ such that
$t_1, \ldots, t_d, y_1, \ldots, y_m$ is a regular system of parameters
for $S$. If the characteristic of $k$ is zero, choose a coefficient
field $K \subset S$ and if the characteristic of $k$ is $p > 0$
choose a Cohen ring $\Lambda \subset S$ with residue field $K$.
At this point the map $K[[t_1, \ldots, t_d, y_1, \ldots, y_m]] \to S$
(characteristic zero case) or
$\Lambda[[t_2, \ldots, t_d, y_1, \ldots, y_m]] \to S$
(characteristic $p > 0$ case) is an isomorphism, see
Lemma \ref{lemma-quotient-power-series-ring-over-Cohen}.
From now on we think of $S$ as the above power series ring.

\medskip\noindent
The rest of the proof is analogous to the argument
in the proof of Theorem \ref{theorem-regular-fs}. Choose a solid diagram
$$
\xymatrix{
S \ar[r]_{\bar\psi} \ar@{-->}[rd] & N/J \\
R \ar[u]^i \ar[r]^\varphi & N \ar[u]_\pi
}
$$
as in Definition \ref{definition-formally-smooth}. As $J^2 = 0$ we see
that $J$ has a canonical $N/J$ module structure and via $\bar\psi$ a
$S$-module structure. As $\bar\psi$ is continuous for the
$\mathfrak m_S$-adic topology we see that $\mathfrak m_S^nJ = 0$ for some
$n$. Hence we can filter $J$ by $N/J$-submodules
$0 \subset J_1 \subset J_2 \subset \ldots \subset J_n = J$
such that each quotient $J_{t + 1}/J_t$ is annihilated by $\mathfrak m_S$.
Considering the sequence of ring maps
$N \to N/J_1 \to N/J_2 \to \ldots \to N/J$
we see that it suffices to prove the existence of the dotted arrow when
$J$ is annihilated by $\mathfrak m_S$, i.e., when $J$ is a
$K$-vector space.

\medskip\noindent
Assume given a diagram as above such that $J$ is annihilated by
$\mathfrak m_S$. As $\mathbf{Q} \to S$ (characteristic zero case)
or $\mathbf{Z} \to S$ (characteristic $p > 0$ case)
is formally smooth in the $\mathfrak m_S$-adic topology (see
Lemma \ref{lemma-power-series-ring-over-Cohen-fs}), we can find
a ring map $\psi : S \to N$ such that $\pi \circ \psi = \bar \psi$.
Since $S$ is a power series ring in $t_1, \ldots, t_d$ (characteristic zero)
or $t_2, \ldots, t_d$ (characteristic $p > 0$) over
a subring, it follows from the universal property of power series rings
that we can change our choice of $\psi$ so that $\psi(t_i)$ equals
$\varphi(t_i)$ (automatic for $t_1 = p$ in the characteristic $p$ case).
Then $\psi \circ i$ and $\varphi : R \to N$ are two maps whose
compositions with $\pi$ are equal and which agree on $t_1, \ldots, t_d$.
Hence $D = \psi \circ i - \varphi : R \to J$ is a derivation which
annihilates $t_1, \ldots, t_d$.
By Algebra, Lemma \ref{algebra-lemma-universal-omega} we can write
$D = \xi \circ \text{d}$ for some $R$-linear map
$\xi : \Omega_{R/\mathbf{Z}} \to J$ which annihilates
$\text{d}t_1, \ldots, \text{d}t_d$ (by construction) and
$\mathfrak m_R \Omega_{R/\mathbf{Z}}$ (as $J$ is annihilated by
$\mathfrak m_R$). Hence $\xi$ factors as a composition
$$
\Omega_{R/\mathbf{Z}} \to \Omega_{k/\mathbf{Z}} \xrightarrow{\xi'} J
$$
where $\xi'$ is $k$-linear. Using the $K$-vector space structure on $J$ we
extend $\xi'$ to a $K$-linear map
$$
\xi'' : \Omega_{k/\mathbf{Z}} \otimes_k K \longrightarrow J.
$$
Using that $\overline{S}/k$ is formally smooth we see that
$$
\Omega_{k/\mathbf{Z}} \otimes_k K \to
\Omega_{\overline{S}/\mathbf{Z}} \otimes_S K
$$
is injective by Theorem \ref{theorem-regular-fs} (this is true also
in the characteristic zero case as it is even true that
$\Omega_{k/\mathbf{Z}} \to \Omega_{K/\mathbf{Z}}$ is injective
in characteristic zero, see Algebra,
Proposition \ref{algebra-proposition-characterize-separable-field-extensions}).
Hence we can find a $K$-linear map
$\xi''' : \Omega_{\overline{S}/\mathbf{Z}} \otimes_S K \to J$ whose
restriction to $\Omega_{k/\mathbf{Z}} \otimes_k K$ is $\xi''$. Write
$$
D' : S \xrightarrow{\text{d}} \Omega_{S/\mathbf{Z}}
\to \Omega_{\overline{S}/\mathbf{Z}} \to
\Omega_{\overline{S}/\mathbf{Z}} \otimes_S K \xrightarrow{\xi'''} J.
$$
Finally, set $\psi' = \psi - D' : S \to N$. The reader verifies that $\psi'$
is a ring map such that $\pi \circ \psi' = \bar \psi$ and such that
$\psi' \circ i = \varphi$ as desired.
\end{proof}

\noindent
As an application of the result above we prove that deformations
of formally smooth algebras are unobstructed.

\begin{lemma}
\label{lemma-lift-fs}
Let $A$ be a Noetherian complete local ring with residue field $k$.
Let $B$ be a Noetherian complete local $k$-algebra. Assume $k \to B$
is formally smooth in the $\mathfrak m_B$-adic topology.
Then there exists a Noetherian complete local ring $C$
and a local homomorphism $A \to C$ which is formally smooth
in the $\mathfrak m_C$-adic topology such that $C \otimes_A k \cong B$.\
\end{lemma}

\begin{proof}
Choose a diagram
$$
\xymatrix{
S \ar[r] & B \\
R \ar[u] \ar[r] & A \ar[u]
}
$$
as in Lemma \ref{lemma-embed-map-Noetherian-complete-local-rings}.
Let $t_1, \ldots, t_d$ be a regular system of parameters for $R$
with $t_1 = p$ in case the characteristic of $k$ is $p > 0$.
As $B$ and $\overline{S} = S \otimes_A k$
are regular we see that $\text{Ker}(\overline{S} \to B)$ is generated by
elements $\overline{x}_1, \ldots, \overline{x}_r$ which form part of a
regular system of parameters of $\overline{S}$, see
Algebra, Lemma \ref{algebra-lemma-regular-quotient-regular}.
Lift these elements to $x_1, \ldots, x_r \in S$. Then
$t_1, \ldots, t_d, x_1, \ldots, x_r$ is part of a regular system of
parameters for $S$. Hence $S/(x_1, \ldots, x_r)$ is a power
series ring over a field (if the characteristic of $k$ is zero)
or a power series ring over a Cohen ring (if the characteristic of
$k$ is $p > 0$), see
Lemma \ref{lemma-quotient-power-series-ring-over-Cohen}.
Moreover, it is still the case that $R \to S/(x_1, \ldots, x_r)$
maps $t_1, \ldots, t_d$ to a part of a regular system of parameters
of $S/(x_1, \ldots, x_r)$. In other words, we may replace $S$ by
$S/(x_1, \ldots, x_r)$ and assume we have a diagram
$$
\xymatrix{
S \ar[r] & B \\
R \ar[u] \ar[r] & A \ar[u]
}
$$
as in Lemma \ref{lemma-embed-map-Noetherian-complete-local-rings}
with moreover $\overline{S} = B$. In this case $R \to S$ is
formally smooth in the $\mathfrak m_S$-adic topology by
Proposition \ref{proposition-fs-flat-fibre-fs}.
Hence the base change $C = S \otimes_R A$ is formally smooth
over $A$ in the $\mathfrak m_C$-adic topology by
Lemma \ref{lemma-base-change-fs}.
\end{proof}

\begin{remark}
\label{remark-what-does-it-mean}
The assertion of Lemma \ref{lemma-lift-fs} is quite strong. Namely,
suppose that we have a diagram
$$
\xymatrix{
& B \\
A \ar[r] & A' \ar[u]
}
$$
of local homomorphisms of Noetherian complete local rings where
$A \to A'$ induces an isomorphism of residue fields
$k = A/\mathfrak m_A = A'/\mathfrak m_{A'}$ and with
$B \otimes_{A'} k$ formally smooth over $k$.
Then we can extend this to a commutative diagram
$$
\xymatrix{
C \ar[r] & B \\
A \ar[r] \ar[u] & A' \ar[u]
}
$$
of local homomorphisms of Noetherian complete local rings
where $A \to C$ is formally smooth in the $\mathfrak m_C$-adic
topology and where $C \otimes_A k \cong B \otimes_{A'} k$.
Namely, pick $A \to C$ as in Lemma \ref{lemma-lift-fs}
lifting $B \otimes_{A'} k$ over $k$. By formal smoothness we
can find the arrow $C \to B$, see
Lemma \ref{lemma-lift-continuous}.
Denote $C \otimes_A^\wedge A'$ the completion of
$C \otimes_A A'$ with respect to the ideal $C \otimes_A \mathfrak m_{A'}$.
Note that $C \otimes_A^\wedge A'$ is a Noetherian complete local
ring (see Algebra, Lemma \ref{algebra-lemma-completion-Noetherian})
which is flat over $A'$ (see
Algebra, Lemma \ref{algebra-lemma-flat-module-powers}).
We have moreover
\begin{enumerate}
\item $C \otimes_A^\wedge A' \to B$ is surjective,
\item if $A \to A'$ is surjective, then $C \to B$ is surjective,
\item if $A \to A'$ is finite, then $C \to B$ is finite, and
\item if $A' \to B$ is flat, then $C \otimes_A^\wedge A' \cong B$.
\end{enumerate}
Namely, by Nakayama's lemma for nilpotent ideals (see
Algebra, Lemma \ref{algebra-lemma-NAK}) we see that
$C \otimes_A k \cong B \otimes_{A'} k$ implies that
$C \otimes_A A'/\mathfrak m_{A'}^n \to B/\mathfrak m_{A'}^nB$
is surjective for all $n$. This proves (1). Parts (2) and (3) follow
from part (1). Part (4) follows from
Algebra, Lemma \ref{algebra-lemma-mod-injective}.
\end{remark}




\section{Regular ring maps}
\label{section-regular}

\noindent
Let $k$ be a field. Recall that a Noetherian $k$-algebra $A$ is
said to be {\it geometrically regular} over $k$ if and only if
$A \otimes_k k'$ is regular for all finite purely inseparable
extensions $k'$ of $k$, see
Algebra, Definition \ref{algebra-definition-geometrically-regular}.
Moreover, if this is the case then $A \otimes_k k'$ is regular
for every finitely generated field extension $k \subset k'$, see
Algebra, Lemma \ref{algebra-lemma-geometrically-regular}.
We use this notion in the following definition.

\begin{definition}
\label{definition-regular}
A ring map $R \to \Lambda$ is {\it regular} if it is flat and
for every prime $\mathfrak p \subset R$ the fibre ring
$$
\Lambda \otimes_R \kappa(\mathfrak p) =
\Lambda_\mathfrak p/\mathfrak p\Lambda_\mathfrak p
$$
is Noetherian and geometrically regular over $\kappa(\mathfrak p)$.
\end{definition}

\noindent
If $R \to \Lambda$ is a ring map with $\Lambda$ Noetherian, then the
fibre rings are always Noetherian.

\begin{lemma}[Regular is a local property]
\label{lemma-regular-local}
Let $R \to \Lambda$ be a ring map with $\Lambda$ Noetherian.
Then $R \to \Lambda$ is regular if and only if the local ring maps
$R_\mathfrak p \to \Lambda_\mathfrak q$ are regular for all
$\mathfrak q \subset \Lambda$ lying over $\mathfrak p \subset R$.
\end{lemma}

\begin{proof}
This is true because a Noetherian ring is regular if and only if
all the local rings are regular local rings, see
Algebra, Definition \ref{definition-regular}
and a ring map is flat if and only if all the induced maps of local
rings are flat, see
Algebra, Lemma \ref{algebra-lemma-flat-localization}.
\end{proof}

\begin{lemma}[Regular maps and base change]
\label{lemma-regular-base-change}
Let $R \to \Lambda$ be a regular ring map.
For any finite type ring map $R \to R'$ the base change
$R' \to \Lambda \otimes_R R'$ is regular too.
\end{lemma}

\begin{proof}
Flatness is preserved under any base change, see
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Consider a prime $\mathfrak p' \subset R'$ lying over
$\mathfrak p \subset R$. The residue field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak p')$ is
finitely generated as $R'$ is of finite type over $R$.
Hence the fibre ring
$$
(\Lambda \otimes_R R') \otimes_{R'} \kappa(\mathfrak p') =
\Lambda \otimes_R \kappa(\mathfrak p) \otimes_{\kappa(\mathfrak p)} 
\kappa(\mathfrak p')
$$
is Noetherian by
Algebra, Lemma \ref{algebra-lemma-Noetherian-field-extension}
and the assumption on the fibre rings of $R \to \Lambda$.
Geometric regularity of the fibres is preserved by
Algebra, Lemma \ref{algebra-lemma-geometrically-regular}.
\end{proof}

\begin{lemma}[Composition of regular maps]
\label{lemma-regular-composition}
Let $A \to B \to C$ be regular ring maps.
If the fibre rings of $A \to C$ are Noetherian, then
$A \to C$ is regular.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset A$ be a prime. Let $\kappa(\mathfrak p) \subset k$
be a finite purely inseparable extension. We have to show that
$C \otimes_A k$ is regular. By Lemma \ref{lemma-regular-base-change}
we may assume that $A = k$ and we reduce to proving that $C$ is regular.
The assumption is that $B$ is regular and that $B \to C$ is flat
with regular fibres. Then $C$ is regular by Algebra, Lemma
\ref{algebra-lemma-flat-over-regular-with-regular-fibre}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-colimit-smooth-regular}
Let $R$ be a ring. Let $(A_i, \varphi_{ii'})$ be a directed system
of smooth $R$-algebras. Set $\Lambda = \colim A_i$. If the fibre
rings $\Lambda \otimes_R \kappa(\mathfrak p)$ are Noetherian for all
$\mathfrak p \subset R$, then $R \to \Lambda$ is regular.
\end{lemma}

\begin{proof}
Note that $\Lambda$ is flat over $R$ by
Algebra, Lemmas \ref{algebra-lemma-colimit-flat} and
\ref{algebra-lemma-smooth-syntomic}.
Let $\kappa(\mathfrak p) \subset k$ be a finite purely inseparable
extension. Note that
$$
\Lambda \otimes_R \kappa(\mathfrak p) \otimes_{\kappa(\mathfrak p)} k =
\Lambda \otimes_R k = \colim A_i \otimes_R k
$$
is a colimit of smooth $k$-algebras, see
Algebra, Lemma \ref{algebra-lemma-base-change-smooth}.
Since each local ring of a smooth $k$-algebra is regular by
Algebra, Lemma \ref{algebra-lemma-characterize-smooth-over-field}
we conclude that all local rings of $\Lambda \otimes_R k$ are
regular by
Algebra, Lemma \ref{algebra-lemma-colimit-regular}.
This proves the lemma.
\end{proof}

\noindent
Let's see when a field extension defines a regular ring map.

\begin{lemma}
\label{lemma-regular-field-extension}
Let $k \subset K$ be a field extension. Then $k \to K$ is a regular
ring map if and only if $K$ is a separable field extension of $k$.
\end{lemma}

\begin{proof}
If $k \to K$ is regular, then $K$ is geometrically reduced over $k$,
hence $K$ is separable over $k$ by
Algebra, Proposition
\ref{algebra-proposition-characterize-separable-field-extensions}.
Conversely, if $K/k$ is separable, then $K$ is a colimit of smooth
$k$-algebras, see
Algebra, Lemma \ref{algebra-lemma-colimit-syntomic}
hence is regular by
Lemma \ref{lemma-colimit-smooth-regular}.
\end{proof}

\begin{lemma}
\label{lemma-regular-permanence}
Let $A \to B \to C$ be ring maps. If $A \to C$ is regular and $B \to C$
is flat and surjective on spectra, then $A \to B$ is regular.
\end{lemma}

\begin{proof}
By Algebra, Lemma \ref{algebra-lemma-flat-permanence} we see that
$A \to B$ is flat. Let $\mathfrak p \subset A$ be a prime. The ring
map $B \otimes_A \kappa(\mathfrak p) \to C \otimes_A \kappa(\mathfrak p)$
is flat and surjective on spectra. Hence $B \otimes_A \kappa(\mathfrak p)$
is geometrically regular by
Algebra, Lemma \ref{algebra-lemma-geometrically-regular-descent}.
\end{proof}




\section{Ascending properties along regular ring maps}
\label{section-ascending-properties}

\noindent
This section is the analogue of
Algebra, Section \ref{algebra-section-ascending-properties}
but where the ring map $R \to S$ is regular.

\begin{lemma}
\label{lemma-reduced-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ is regular,
\item $S$ is Noetherian, and
\item $R$ is Noetherian and reduced.
\end{enumerate}
Then $S$ is reduced.
\end{lemma}

\begin{proof}
For Noetherian rings being reduced is the same as having properties
$(S_1)$ and $(R_0)$, see
Algebra, Lemma \ref{algebra-lemma-criterion-reduced}.
Hence we may apply
Algebra, Lemmas \ref{algebra-lemma-Sk-goes-up} and
\ref{algebra-lemma-Rk-goes-up}.
\end{proof}







\section{Permanence of properties under completion}
\label{section-permanence-completion}

\noindent
Given a Noetherian local ring $A$ we denote $A^\wedge$ the completion of
$A$ with respect to its maximal ideal. We will use without further mention
that $A^\wedge$ is a Noetherian complete local ring
(Algebra, Lemmas \ref{algebra-lemma-completion-Noetherian-Noetherian} and
\ref{algebra-lemma-hathat-finitely-generated})
and that $A \to A^\wedge$ is flat
(Algebra, Lemma \ref{algebra-lemma-completion-flat}).

\begin{lemma}
\label{lemma-completion-dimension}
Let $A$ be a Noetherian local ring.
Then $\dim(A) = \dim(A^\wedge)$.
\end{lemma}

\begin{proof}
See for example
Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-equals-total}.
\end{proof}

\begin{lemma}
\label{lemma-completion-depth}
Let $A$ be a Noetherian local ring. Then
$\text{depth}(A) = \text{depth}(A^\wedge)$.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-apply-grothendieck}.
\end{proof}

\begin{lemma}
\label{lemma-completion-CM}
Let $A$ be a Noetherian local ring.
Then $A$ is Cohen-Macaulay if and only if $A^\wedge$ is so.
\end{lemma}

\begin{proof}
A local ring $A$ is Cohen-Macaulay if and only $\dim(A) = \text{depth}(A)$.
As both of these invariants are preserved under completion
(Lemmas \ref{lemma-completion-dimension} and \ref{lemma-completion-depth})
the claim follows.
\end{proof}

\begin{lemma}
\label{lemma-completion-regular}
Let $A$ be a Noetherian local ring.
Then $A$ is regular if and only if $A^\wedge$ is so.
\end{lemma}

\begin{proof}
If $A^\wedge$ is regular, then $A$ is regular by
Algebra, Lemma \ref{algebra-lemma-flat-under-regular}.
Assume $A$ is regular. Let $\mathfrak m$ be the maximal ideal
of $A$. Then $\dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2 =
\dim(A) = \dim(A^\wedge)$ (Lemma \ref{lemma-completion-dimension}).
On the other hand, $\mathfrak mA^\wedge$ is the maximal ideal of
$A^\wedge$ and hence $\mathfrak m_{A^\wedge}$
is generated by at most $\dim(A^\wedge)$ elements. Thus $A^\wedge$ is regular.
(You can also use
Algebra, Lemma \ref{algebra-lemma-flat-over-regular-with-regular-fibre}.)
\end{proof}

\begin{lemma}
\label{lemma-completion-reduced}
Let $A$ be a Noetherian local ring.
\begin{enumerate}
\item If $A^\wedge$ is reduced, then so is $A$.
\item In general $A$ reduced does not imply $A^\wedge$ is reduced.
\item If $A$ is Nagata, then $A$ is reduced if and only if $A^\wedge$
is reduced.
\end{enumerate}
\end{lemma}

\begin{proof}
As $A \to A^\wedge$ is faithfully flat we have (1) by
Algebra, Lemma \ref{algebra-lemma-descent-reduced}.
For (2) see Algebra, Example \ref{algebra-example-bad-dvr-char-p}
(there are also examples in characteristic zero, see
Algebra, Remark \ref{algebra-remark-resolution-dim-1}).
For (3) see Algebra, Lemmas
\ref{algebra-lemma-local-nagata-domain-analytically-unramified} and
\ref{algebra-lemma-analytically-unramified-easy}.
\end{proof}







\section{Permanence of properties under henselization}
\label{section-permanence-henselization}

\noindent
Given a local ring $R$ we denote $R^h$, resp.\ $R^{sh}$ the henselization,
resp.\ strict henselization of $R$, see
Algebra, Definition \ref{algebra-definition-henselization}.
Many of the properties of $R$ are
reflected in $R^h$ and $R^{sh}$ as we will show in this section.

\begin{lemma}
\label{lemma-dumb-properties-henselization}
Let $(R, \mathfrak m, \kappa)$ be a local ring. Then we have the following
\begin{enumerate}
\item $R \to R^h \to R^{sh}$ are faithfully flat ring maps,
\item $\mathfrak m R^h = \mathfrak m^h$ and
$\mathfrak m R^{sh} = \mathfrak m^h R^{sh} = \mathfrak m^{sh}$,
\item $R/\mathfrak m^n = R^h/\mathfrak m^nR^h$ for all $n$,
\item there exist elements $x_i \in R^{sh}$ such that
$R^{sh}/\mathfrak m^nR^{sh}$ is a free $R/\mathfrak m^n$-module
on $x_i \bmod \mathfrak m^nR^{sh}$.
\end{enumerate}
\end{lemma}

\begin{proof}
By construction $R^h$ is a colimit of \'etale $R$-algebras, see
Algebra, Lemma \ref{algebra-lemma-henselization}. Since \'etale
ring maps are flat (Algebra, Lemma \ref{algebra-lemma-etale}) we see that
$R^h$ is flat over $R$ by
Algebra, Lemma \ref{algebra-lemma-colimit-flat}.
As a flat local ring homomorphism is faithfully flat
(Algebra, Lemma \ref{algebra-lemma-local-flat-ff})
we see that $R \to R^h$ is faithfully flat.
The ring map $R^h \to R^{sh}$ is a colimit of finite \'etale ring
maps, see proof of Algebra, Lemma \ref{algebra-lemma-strict-henselization}.
Hence the same arguments as above show that $R^h \to R^{sh}$ is
faithfully flat.

\medskip\noindent
Part (2) follows from Algebra, Lemmas \ref{algebra-lemma-henselization} and
\ref{algebra-lemma-strict-henselization}. Part (3) follows from
Algebra, Lemma \ref{algebra-lemma-local-artinian-basis-when-flat}
because $R/\mathfrak m \to R^h/\mathfrak mR^h$ is an isomorphism and
$R/\mathfrak m^n \to R^h/\mathfrak m^nR^h$ is flat as a base change of
the flat ring map $R \to R^h$
(Algebra, Lemma \ref{algebra-lemma-flat-base-change}).
Let $\kappa^{sep}$ be the residue field of $R^{sh}$ (it is a
separable algebraic closure of $\kappa$). Choose $x_i \in R^{sh}$
mapping to a basis of $\kappa^{sep}$ as a $\kappa$-vector space.
Then (4) follows from
Algebra, Lemma \ref{algebra-lemma-local-artinian-basis-when-flat}
in exactly the same way as above.
\end{proof}

\begin{lemma}
\label{lemma-henselization-formally-smooth}
Let $(R, \mathfrak m, \kappa)$ be a local ring. Then
\begin{enumerate}
\item $R \to R^h$, $R^h \to R^{sh}$, and $R \to R^{sh}$ are formally \'etale,
\item $R \to R^h$, $R^h \to R^{sh}$, resp.\ $R \to R^{sh}$ are formally
smooth in the $\mathfrak m^h$, $\mathfrak m^{sh}$,
resp.\ $\mathfrak m^{sh}$-topology.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from the fact that $R^h$ and $R^{sh}$ are directed
colimits of \'etale algebras (by construction), that \'etale algebras
are formally \'etale
(Algebra, Lemma \ref{algebra-lemma-formally-etale-etale}),
and that colimits of formally \'etale algebras are formally etale
(Algebra, Lemma \ref{algebra-lemma-colimit-formally-etale}).
Part (2) follows from the fact that a formally \'etale ring
map is formally smooth and Lemma \ref{lemma-formally-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-henselization-noetherian}
Let $R$ be a local ring. The following are equivalent
\begin{enumerate}
\item $R$ is Noetherian,
\item $R^h$ is Noetherian, and
\item $R^{sh}$ is Noetherian.
\end{enumerate}
In this case we have
\begin{enumerate}
\item[(a)] $(R^h)^\wedge$ and $(R^{sh})^\wedge$ are Noetherian complete
local rings,
\item[(b)] $R^\wedge \to (R^h)^\wedge$ is an isomorphism,
\item[(c)] $R^h \to (R^h)^\wedge$ and $R^{sh} \to (R^{sh})^\wedge$ are flat,
\item[(d)] $R^\wedge \to (R^{sh})^\wedge$ is formally smooth in
the $\mathfrak m_{(R^{sh})^\wedge}$-adic topology.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $R \to R^h \to R^{sh}$ are faithfully flat
(Lemma \ref{lemma-dumb-properties-henselization}),
we see that $R^h$ or $R^{sh}$ being Noetherian implies that $R$
is Noetherian, see Algebra, Lemma \ref{algebra-lemma-descent-Noetherian}.
In the rest of the proof we assume $R$ is Noetherian.
As $\mathfrak m \subset R$ is finitely generated it follows that
$\mathfrak m^h = \mathfrak m R^h$ and $\mathfrak m^{sh} = \mathfrak mR^{sh}$
are finitely generated, see Lemma \ref{lemma-dumb-properties-henselization}.
Hence $(R^h)^\wedge$ and $(R^{sh})^\wedge$ are Noetherian by
Algebra, Lemma \ref{algebra-lemma-complete-local-ring-Noetherian}.
This proves (a).

\medskip\noindent
Note that (b) is immediate from
Lemma \ref{lemma-dumb-properties-henselization}.
In particular we see that $(R^h)^\wedge$ is flat over $R$, see
Algebra, Lemma \ref{algebra-lemma-completion-faithfully-flat}.

\medskip\noindent
Next, we show that $R^h \to (R^h)^\wedge$ is flat.
Write $R^h = \colim_i R_i$ as a directed colimit of
localizations of \'etale $R$-algebras. By
Algebra, Lemma \ref{algebra-lemma-colimit-rings-flat}
if $(R^h)^\wedge$ is flat over each $R_i$, then $R^h \to (R^h)^\wedge$ is
flat. Note that $R^h = R_i^h$ (by construction).
Hence $R_i^\wedge = (R^h)^\wedge$
by part (b) is flat over $R_i$ as desired. To finish the proof of (c)
we show that $R^{sh} \to (R^{sh})^\wedge$ is flat. To do this, by a
limit argument as above, it suffices to show that $R^{sh}$ is flat over $R$.
Note that it follows from Lemma \ref{lemma-dumb-properties-henselization}
that $(R^{sh})^\wedge$ is the completion of a free $R$-module.
By Lemma \ref{lemma-completed-direct-sum-flat}
we see this is flat over $R$ as desired. This finishes the proof of (c).

\medskip\noindent
Part (d) follows from Lemma \ref{lemma-henselization-formally-smooth}
and Lemma \ref{lemma-formally-smooth-completion}.
\end{proof}

\begin{lemma}
\label{lemma-henselization-reduced}
Let $R$ be a local ring.
The following are equivalent: $R$ is reduced,
the henselization $R^h$ of $R$ is reduced, and
the strict henselization $R^{sh}$ of $R$ is reduced.
\end{lemma}

\begin{proof}
The ring maps $R \to R^h \to R^{sh}$ are faithfully flat.
Hence one direction of the implications follows from
Algebra, Lemma \ref{algebra-lemma-descent-reduced}.
Conversely, assume $R$ is reduced. Since $R^h$ and $R^{sh}$
are filtered colimits of \'etale, hence smooth $R$-algebras, the\
result follows from
Algebra, Lemma \ref{algebra-lemma-reduced-goes-up}.
\end{proof}

\begin{lemma}
\label{lemma-henselization-normal}
Let $R$ be a local ring.
The following are equivalent: $R$ is a normal domain,
the henselization $R^h$ of $R$ is a normal domain, and
the strict henselization $R^{sh}$ of $R$ is a normal domain.
\end{lemma}

\begin{proof}
A preliminary remark is that a local ring is normal if and only if it is
a normal domain (see
Algebra, Definition \ref{algebra-definition-ring-normal}).
The ring maps $R \to R^h \to R^{sh}$ are faithfully flat.
Hence one direction of the implications follows from
Algebra, Lemma \ref{algebra-lemma-descent-normal}.
Conversely, assume $R$ is normal. Since $R^h$ and $R^{sh}$
are filtered colimits of \'etale, hence smooth $R$-algebras, the\
result follows from
Algebra, Lemma \ref{algebra-lemma-normal-goes-up}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-etale-extension}
If $A \to B$ is an \'etale ring map and $\mathfrak q$ is a prime of
$B$ lying over $\mathfrak p \subset A$, then
$\dim(A_{\mathfrak p}) = \dim(B_{\mathfrak q})$.
\end{lemma}

\begin{proof}
Namely, because $A_{\mathfrak p} \to B_{\mathfrak q}$ is flat we have
going down, and hence the inequality
$\dim(A_{\mathfrak p}) \leq \dim(B_{\mathfrak q})$, see
Algebra, Lemma \ref{algebra-lemma-dimension-going-up}.
On the other hand, suppose that
$\mathfrak q_0 \subset \mathfrak q_1 \subset \ldots \subset \mathfrak q_n$
is a chain of primes in $B_{\mathfrak q}$. Then the corresponding
sequence of primes
$\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n$
(with $\mathfrak p_i = \mathfrak q_i \cap A_{\mathfrak p}$) is chain
also (i.e., no equalities in the sequence) as an
\'etale ring map is quasi-finite (see
Algebra, Lemma \ref{algebra-lemma-etale-quasi-finite})
and a quasi-finite ring map induces a map of spectra with
discrete fibres (by definition).
This means that $\dim(A_{\mathfrak p}) \geq \dim(B_{\mathfrak q})$ as
desired.
\end{proof}

\begin{lemma}
\label{lemma-henselization-dimension}
Given any local ring $R$ we have $\dim(R) = \dim(R^h) = \dim(R^{sh})$.
\end{lemma}

\begin{proof}
Since $R \to R^{sh}$ is faithfully flat
(Lemma \ref{lemma-dumb-properties-henselization})
we see that $\dim(R^{sh}) \geq \dim(R)$ by going down, see
Algebra, Lemma \ref{algebra-lemma-dimension-going-up}.
For the converse, we write $R^{sh} = \colim R_i$ as
a directed colimit of local rings $R_i$ each of which is a
localization of an \'etale $R$-algebra. Now if
$\mathfrak q_0 \subset \mathfrak q_1 \subset \ldots \subset \mathfrak q_n$
is a chain of prime ideals in $R^{sh}$, then for some sufficiently
large $i$ the sequence
$$
R_i \cap \mathfrak q_0 \subset
R_i \cap \mathfrak q_1 \subset \ldots \subset
R_i \cap \mathfrak q_n
$$
is a chain of primes in $R_i$. Thus we see that
$\dim(R^{sh}) \leq \sup_i \dim(R_i)$.
But by the result of
Lemma \ref{lemma-dimension-etale-extension}
we have $\dim(R_i) = \dim(R)$ for each $i$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-henselization-depth}
Given a Noetherian local ring $R$ we have
$\text{depth}(R) = \text{depth}(R^h) = \text{depth}(R^{sh})$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-henselization-noetherian}
we know that $R^h$ and $R^{sh}$ are Noetherian. Hence the lemma follows
from
Algebra, Lemma \ref{algebra-lemma-apply-grothendieck}.
\end{proof}

\begin{lemma}
\label{lemma-henselization-CM}
Let $R$ be a Noetherian local ring. The following are equivalent:
$R$ is Cohen-Macaulay, the henselization $R^h$ of $R$ is Cohen-Macaulay,
and the strict henselization $R^{sh}$ of $R$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-henselization-noetherian}
we know that $R^h$ and $R^{sh}$ are Noetherian, hence the lemma makes
sense. Since we have
$\text{depth}(R) = \text{depth}(R^h) = \text{depth}(R^{sh})$
and
$\dim(R) = \dim(R^h) = \dim(R^{sh})$
by
Lemmas \ref{lemma-henselization-depth} and
\ref{lemma-henselization-dimension}
we conclude.
\end{proof}

\begin{lemma}
\label{lemma-henselization-regular}
Let $R$ be a Noetherian local ring. The following are equivalent:
$R$ is a regular local ring, the henselization $R^h$ of $R$ is a regular
local ring, and the strict henselization $R^{sh}$ of $R$ is a regular
local ring.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-henselization-noetherian}
we know that $R^h$ and $R^{sh}$ are Noetherian, hence the lemma makes
sense. Let $\mathfrak m$ be the maximal ideal of $R$.
Let $x_1, \ldots, x_t \in \mathfrak m$ be a minimal system of
generators of $\mathfrak m$, i.e., such that the images in
$\mathfrak m/\mathfrak m^2$ form a basis over $\kappa = R/\mathfrak m$.
Because $R \to R^h$ and $R \to R^{sh}$ are faithfully flat, it follows
that the images $x_1^h, \ldots, x_t^h$ in $R^h$,
resp.\  $x_1^{sh}, \ldots, x_t^{sh}$ in $R^{sh}$
are a minimal system of generators for
$\mathfrak m^h = \mathfrak mR^h$,
resp.\ $\mathfrak m^{sh} = \mathfrak mR^{sh}$.
Regularity of $R$ by definition means $t = \dim(R)$ and similarly
for $R^h$ and $R^{sh}$. Hence the lemma follows from the equality
of dimensions $\dim(R) = \dim(R^h) = \dim(R^{sh})$ of
Lemma \ref{lemma-henselization-dimension}
\end{proof}

\begin{lemma}
\label{lemma-fibres-henselization}
Let $R$ be a Noetherian local ring. Let $\mathfrak p \subset R$ be a prime.
Then
$$
R^h \otimes_R \kappa(\mathfrak p) =
\prod\nolimits_{i = 1, \ldots, t} \kappa(\mathfrak q_i)
\quad\text{resp.}\quad
R^{sh} \otimes_R \kappa(\mathfrak p) =
\prod\nolimits_{i = 1, \ldots, s} \kappa(\mathfrak r_i)
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$,
resp.\ $\mathfrak r_1, \ldots, \mathfrak r_s$
are the prime of $R^h$, resp.\ $R^{sh}$ lying over $\mathfrak p$.
Moreover, the field extensions
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q_i)$
resp.\ $\kappa(\mathfrak p) \subset \kappa(\mathfrak q_i)$
are separable algebraic.
\end{lemma}

\begin{proof}
We will use without further mention the results of
Lemmas \ref{lemma-dumb-properties-henselization} and
\ref{lemma-henselization-noetherian}.
Note that $R^h/\mathfrak pR^h$, resp.\ $R^{sh}/\mathfrak pR^{sh}$
is the henselization, resp.\ strict henselization of $R/\mathfrak p$,
see Algebra, Lemma \ref{algebra-lemma-quotient-henselization}
resp.\ Algebra, Lemma \ref{algebra-lemma-quotient-strict-henselization}.
Hence we may replace $R$ by $R/\mathfrak p$ and assume that $R$
is a Noetherian local domain and that $\mathfrak p = (0)$.
Since $R^h$, resp.\ $R^{sh}$ is Noetherian, it has finitely many
minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$,
resp.\ $\mathfrak r_1, \ldots, \mathfrak r_s$.
Since $R \to R^h$, resp.\ $R \to R^{sh}$ is flat these are exactly
the primes lying over $\mathfrak p = (0)$ (by going down).
Finally, as $R$ is a domain, we see that $R^h$, resp.\ $R^{sh}$
is reduced, see Lemma \ref{lemma-henselization-reduced}.
Thus we see that $R^h \otimes_R f.f.(R) = R^h \otimes_R \kappa(\mathfrak p)$
resp.\ $R^{sh} \otimes_R f.f.(R) = R^{sh} \otimes_R \kappa(\mathfrak p)$
is a reduced Noetherian ring with finitely many primes, all of which
are minimal (and hence maximal). Thus these rings are Artinian and are
products of their localizations at maximal ideals, each necessarily a field
(see Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring} and
Algebra, Lemma \ref{algebra-lemma-minimal-prime-reduced-ring}).

\medskip\noindent
The final statement follows from the fact that $R \to R^h$,
resp.\ $R \to R^{sh}$ is a colimit of \'etale ring maps and hence
the induced residue field extensions are colimits of finite separable
extensions, see
Algebra, Lemma \ref{algebra-lemma-etale-at-prime}.
\end{proof}









\section{Field extensions, revisited}
\label{section-p-bases}

\noindent
In this section we study some peculiarities of field extensions in
characteristic $p > 0$.

\begin{definition}
\label{definition-p-basis}
Let $p$ be a prime number. Let $k \to K$ be an extension of fields
of characteristic $p$. Denote $kK^p$ the compositum of $k$ and $K^p$
in $K$.
\begin{enumerate}
\item A subset $\{x_i\} \subset K$ is called {\it p-independent
over $k$} if the elements $x^E = \prod x_i^{e_i}$ where
$0 \leq e_i < p$ are linearly independent over $kK^p$.
\item A subset $\{x_i\}$ of $K$ is called a
{\it p-basis of $K$ over $k$} if the elements
$x^E$ form a basis of $K$ over $kK^p$.
\end{enumerate}
\end{definition}

\noindent
This is related to the notion of a $p$-basis of a $\mathbf{F}_p$-algebra
which we will discuss later (insert future reference here).

\begin{lemma}
\label{lemma-p-basis}
Let $k \subset K$ be a field extension. Assume $k$ has characteristic
$p > 0$. Let $\{x_i\}$ be a subset of $K$. The following are equivalent
\begin{enumerate}
\item the elements $\{x_i\}$ are $p$-independent over $k$, and
\item the elements $\text{d}x_i$ are $K$-linearly independent
in $\Omega_{K/k}$.
\end{enumerate}
Any $p$-independent collection can be extended to a $p$-basis of $K$ over $k$.
In particular, the field $K$ has a $p$-basis over $k$.
Moreover, the following are equivalent:
\begin{enumerate}
\item[(a)] $\{x_i\}$ is a $p$-basis of $K$ over $k$, and
\item[(b)] $\text{d}x_i$ is a basis of the $K$-vector space $\Omega_{K/k}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (2) and suppose that $\sum a_E x^E = 0$ is a linear relation
with $a_E \in k K^p$. Let $\theta_i : K \to K$ be a $k$-derivation such that
$\theta_i(x_j) = \delta_{ij}$ (Kronecker delta). Note that any $k$-derivation
of $K$ annihilates $kK^p$. Applying $\theta_i$ to the given relation we
obtain new relations
$$
\sum\nolimits_{E, e_i > 0}
e_i a_E x_1^{e_1}\ldots x_i^{e_i - 1} \ldots x_n^{e_n} = 0
$$
Hence if we pick $\sum a_E x^E$ as the relation with minimal
total degree $|E| = \sum e_i$ for some $a_E \not = 0$, then we
get a contradiction. Hence (2) holds.

\medskip\noindent
If $\{x_i\}$ is a $p$-basis for $K$ over $k$, then
$K \cong kK^p[X_i]/(X_i^p - x_i^p)$. Hence we see that
$\text{d}x_i$ forms a basis for $\Omega_{K/k}$ over $K$.
Thus (a) implies (b).

\medskip\noindent
Let $\{x_i\}$ be a $p$-independent subset of $K$ over $k$. An application
of Zorn's lemma shows that we can enlarge this to a maximal $p$-independent
subset of $K$ over $k$. We claim that any maximal $p$-independent subset
$\{x_i\}$ of $K$ is a $p$-basis of $K$ over $k$. The claim will imply
that (1) implies (2) and establish the existence of $p$-bases.
To prove the claim let $L$ be the subfield of $K$ generated by
$kK^p$ and the $x_i$. We have to show that $L = K$. If $x \in K$
but $x \not \in L$, then $x^p \in L$ and $L(x) \cong L[z]/(z^p - x)$.
Hence $\{x_i\} \cup \{x\}$ is $p$-independent over $k$, a contradiction.

\medskip\noindent
Finally, we have to show that (b) implies (a). By the equivalence of (1)
and (2) we see that $\{x_i\}$ is a maximal $p$-independent subset
of $K$ over $k$. Hence by the claim above it is a $p$-basis.
\end{proof}

\begin{lemma}
\label{lemma-intersection-subfields-subspace}
Let $k \subset K$ be a field extension. Let $\{K_\alpha\}_{\alpha \in A}$
be a collection of subfields of $K$ with the following properties
\begin{enumerate}
\item $k \subset K_\alpha$ for all $\alpha \in A$,
\item $k = \bigcap_{\alpha \in A} K_\alpha$,
\item for $\alpha, \alpha' \in A$ there exists an $\alpha'' \in A$
such that $K_{\alpha''} \subset K_\alpha \cap K_{\alpha'}$.
\end{enumerate}
Then for $n \geq 1$ and $V \subset K^{\oplus n}$ a $K$-vector space
we have $V \cap k^{\oplus n} \not = 0$ if and only if
$V \cap K_\alpha^{\oplus n} \not = 0$ for all $\alpha \in A$.
\end{lemma}

\begin{proof}
By induction on $n$. The case $n = 1$ follows from the assumptions.
Assume the result proven for subspaces of $K^{\oplus n - 1}$.
Assume that $V \subset K^{\oplus n}$ has nonzero intersection with
$K_\alpha^{\oplus n}$ for all $\alpha \in A$. If
$V \cap0 \oplus k^{\oplus n - 1}$ is nonzero then we win. Hence we may
assume this is not the case. By induction hypothesis we can find
an $\alpha$ such that $V \cap 0 \oplus K_\alpha^{\oplus n - 1}$
is zero. Let $v = (x_1, \ldots, x_n) \in V \cap K_\alpha$ be a nonzero element.
By our choice of $\alpha$ we see that $x_1$ is not zero.
Replace $v$ by $x_1^{-1}v$ so that $v = (1, x_2, \ldots, x_n)$.
Note that if $v' = (x_1', \ldots, x'_n) \in V \cap K_\alpha$, then
$v' - x_1'v = 0$ by our choice of $\alpha$. Hence we see that
$V \cap K_\alpha^{\oplus n} = K_\alpha v$. If we choose some
$\alpha'$ such that $K_{\alpha'} \subset K_\alpha$, then we
see that necessarily $v \in V \cap K_{\alpha'}^{\oplus n}$ (by the
same arguments applied to $\alpha'$). Hence
$$
x_2, \ldots, x_n \in
\bigcap\nolimits_{\alpha' \in A, K_{\alpha'} \subset K_\alpha} K_{\alpha'}
$$
which equals $k$ by (2) and (3).
\end{proof}

\begin{lemma}
\label{lemma-intersection-subfields}
Let $K$ be a field of characteristic $p$. Let $\{K_\alpha\}_{\alpha \in A}$
be a collection of subfields of $K$ with the following properties
\begin{enumerate}
\item $K^p \subset K_\alpha$ for all $\alpha \in A$,
\item $K^p = \bigcap_{\alpha \in A} K_\alpha$,
\item for $\alpha, \alpha' \in A$ there exists an $\alpha'' \in A$
such that $K_{\alpha''} \subset K_\alpha \cap K_{\alpha'}$.
\end{enumerate}
Then
\begin{enumerate}
\item the intersection of the kernels of the maps
$\Omega_{K/\mathbf{F}_p} \to \Omega_{K/K_\alpha}$ is zero,
\item for any finite extension $K \subset L$ we have
$L^p = \bigcap_{\alpha \in A} L^pK_\alpha$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1).
Choose a $p$-basis $\{x_i\}$ for $K$ over $\mathbf{F}_p$.
Suppose that $\eta = \sum_{i \in I'} y_i \text{d}x_i$ maps to zero in
$\Omega_{K/K_\alpha}$ for every $\alpha \in A$. Here the index set
$I'$ is finite. By Lemma \ref{lemma-p-basis}
this means that for every $\alpha$ there exists a relation
$$
\sum\nolimits_E a_{E, \alpha} x^E,\quad a_{E, \alpha} \in K_\alpha
$$
where $E$ runs over multi-indices $E = (e_i)_{i \in I'}$ with
$0 \leq e_i < p$. On the other hand, Lemma \ref{lemma-p-basis}
guarantees there is no such relation $\sum a_E x^E = 0$ with
$a_E \in K^p$. This is a contradiction by
Lemma \ref{lemma-intersection-subfields-subspace}.

\medskip\noindent
Proof of (2). Suppose that we have a tower $K \subset M \subset L$
of finite extensions of fields. Set $M_\alpha = M^p K_\alpha$
and $L_\alpha = L^p K_\alpha = L^p M_\alpha$. Then we can first prove that
$M^p = \bigcap_{\alpha \in A} M_\alpha$, and after that prove
that $L^p = \bigcap_{\alpha \in A} L_\alpha$. Hence it suffices to
prove (2) for primitive field extensions having no nontrivial subfields.
First, assume that $L = K(\theta)$ is separable over $K$. Then
$L$ is generated by $\theta^p$ over $K$, hence we may assume that
$\theta \in L^p$. In this case we see that
$$
L^p = K^p \oplus K^p\theta \oplus \ldots K^p\theta^{d - 1}
\quad\text{and}\quad
L^pK_\alpha =
K_\alpha \oplus K_\alpha \theta \oplus \ldots K_\alpha\theta^{d - 1}
$$
where $d = [L : K]$. Thus the conclusion is clear in this case. The other
case is where $L = K(\theta)$ with $\theta^p = t \in K$, $t \not \in K^p$.
In this case we have
$$
L^p = K^p \oplus K^pt \oplus \ldots K^pt^{p - 1}
\quad\text{and}\quad
L^pK_\alpha =
K_\alpha \oplus K_\alpha t \oplus \ldots K_\alpha t^{p - 1}
$$
Again the result is clear.
\end{proof}

\begin{lemma}
\label{lemma-power-series-ring-subfields}
Let $k$ be a field of characteristic $p > 0$. Let $n, m \geq 0$.
As $k'$ ranges through all subfields $k^p \subset k' \subset k$
with $[k : k'] < \infty$ the subfields
$$
f.f.(k'[[x_1^p, \ldots, x_n^p]][y_1^p, \ldots, y_m^p])
\subset
f.f.(k[[x_1, \ldots, x_d]][y_1, \ldots, y_m])
$$
form a family of subfields as in Lemma \ref{lemma-intersection-subfields}.
Moreover, each of the ring extensions
$k'[[x_1^p, \ldots, x_n^p]][y_1^p, \ldots, y_m^p] \subset
k[[x_1, \ldots, x_n]][y_1, \ldots, y_m]$ is finite.
\end{lemma}

\begin{proof}
Write $A = k[[x_1, \ldots, x_n]][y_1, \ldots, y_m]$
and $A' = k'[[x_1^p, \ldots, x_n^p]][y_1^p, \ldots, y_m^p]$.
We also set $K = f.f.(A)$ and $K' = f.f.(A')$. The ring extension
$k'[[x_1^p, \ldots, x_d^p]] \subset k[[x_1, \ldots, x_d]]$ is finite
by Algebra, Lemma \ref{algebra-lemma-finite-after-completion}
which implies that $A \to A'$ is finite.
For $f \in A$ we see that $f^p \in A'$. Hence $K^p \subset K'$.
Any element of $K'$ can be written as $a/b^p$ with $a \in A'$ and $b \in A$
nonzero. Suppose that $f/g^p \in K$, $f, g \in A$, $g \not = 0$
is contained in $K'$ for every choice of $k'$.
Fix a choice of $k'$ for the moment. By the above we see
$f/g^p = a/b^p$ for some $a \in A'$ and some nonzero $b \in A$.
Hence $b^p f \in A'$. For any $A'$-derivation $D : A \to A$ we see
that $0 = D(b^pf) = b^p D(f)$ hence $D(f) = 0$ as $A$ is a domain.
Taking $D = \partial_{x_i}$ and $D = \partial_{y_j}$ we conclude that
that $f \in k[[x_1^p, \ldots, x_n^p]][y_1^p, \ldots, y_d^p]$.
Applying a $k'$-derivation $\theta : k \to k$
we similarly conclude that all coefficients of $f$ are in $k'$, i.e.,
$f \in A'$. Since it is clear that
$A = \bigcap\nolimits_{k'} A'$ where $k'$ ranges over all subfields
as in the lemma we win.
\end{proof}





\section{The singular locus}
\label{section-singular-locus}

\noindent
Let $R$ be a Noetherian ring. The {\it regular locus} $\text{Reg}(X)$
of $X = \Spec(R)$ is the set of primes $\mathfrak p$ such that
$R_\mathfrak p$ is a regular local ring. The {\it singular locus}
$\text{Sing}(X)$ of $X = \Spec(R)$ is the complement
$X \setminus \text{Reg}(X)$, i.e., the set of primes $\mathfrak p$ such that
$R_\mathfrak p$ is not a regular local ring. By the discussion preceding
Algebra, Definition \ref{algebra-definition-regular}
we see that $\text{Reg}(X)$ is stable under generalization
In the section we study conditions that guarantee that $\text{Reg}(X)$
is open.

\begin{definition}
\label{definition-J}
Let $R$ be a Noetherian ring. Let $X = \Spec(R)$.
\begin{enumerate}
\item We say $R$ is {\it J-0} if $\text{Reg}(X)$ contains a nonempty open.
\item We say $R$ is {\it J-1} if $\text{Reg}(X)$ is open.
\item We say $R$ is {\it J-2} if any finite type $R$-algebra is J-1.
\end{enumerate}
\end{definition}

\noindent
The ring $\mathbf{Q}[x]/(x^2)$ does not satisfy J-0. On the other
hand J-1 implies J-0 for domains and even reduced rings as such
a ring is regular at the minimal primes.
Here is a characterization of the J-1 property.

\begin{lemma}
\label{lemma-J-1}
Let $R$ be a Noetherian ring. Let $X = \Spec(R)$.
The ring $R$ is J-1 if and only if $V(\mathfrak p) \cap \text{Reg}(X)$
contains a nonempty open subset of $V(\mathfrak p)$ for all
$\mathfrak p \in \text{Reg}(X)$.
\end{lemma}

\begin{proof}
This follows immediately from
Topology, Lemma \ref{topology-lemma-characterize-open-Noetherian}.
\end{proof}

\begin{lemma}
\label{lemma-intersection-regular-with-closed}
Let $R$ be a Noetherian ring. Let $X = \Spec(R)$. Assume that for all
$\mathfrak p \subset R$ the ring $R/\mathfrak p$ is J-0.
Then $R$ is J-1.
\end{lemma}

\begin{proof}
We will show that the criterion of Lemma \ref{lemma-J-1} applies.
Let $\mathfrak p \in \text{Reg}(X)$ be a prime of height $r$.
Pick $f_1, \ldots, f_r \in \mathfrak p$ which map to generators
of $\mathfrak pR_\mathfrak p$. Since $\mathfrak p \in \text{Reg}(X)$
we see that $f_1, \ldots, f_r$ maps to a regular sequence in $R_\mathfrak p$,
see Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}. Thus by
Algebra, Lemma \ref{algebra-lemma-regular-sequence-in-neighbourhood}
we see that after replacing $R$ by $R_g$ for some $g \in R$,
$g \not \in \mathfrak p$ the sequence $f_1, \ldots, f_r$ is a
regular sequence in $R$. Next, let $\mathfrak p \subset \mathfrak q$
be a prime ideal such that $(R/\mathfrak p)_\mathfrak q$ is
a regular local ring. By the assumption of the lemma there
exists a non-empty open subset of $V(\mathfrak p)$ consisting
of such primes, hence it suffices to prove $R_\mathfrak q$ is regular.
Note that $f_1, \ldots, f_r$ is a regular sequence in $R_\mathfrak q$
such that $R_\mathfrak q/(f_1, \ldots, f_r)R_\mathfrak q$ is regular.
Hence $R_\mathfrak q$ is regular by
Algebra, Lemma \ref{algebra-lemma-regular-mod-x}.
\end{proof}

\begin{lemma}
\label{lemma-J-0-goes-down}
Let $R \to S$ be a ring map. Assume that
\begin{enumerate}
\item $R$ is a Noetherian domain,
\item $R \to S$ is injective and of finite type, and
\item $S$ is a domain and J-0.
\end{enumerate}
Then $R$ is J-0.
\end{lemma}

\begin{proof}
After replacing $S$ by $S_g$ for some nonzero $g \in S$ we may assume
that $S$ is a regular ring. By generic flatness we may assume that also
$R \to S$ is faithfully flat, see
Algebra, Lemma \ref{algebra-lemma-generic-flatness-Noetherian}.
Then $R$ is regular by
Algebra, Lemma \ref{algebra-lemma-descent-regular}.
\end{proof}

\begin{lemma}
\label{lemma-J-0-goes-up}
Let $R \to S$ be a ring map. Assume that
\begin{enumerate}
\item $R$ is a Noetherian domain and J-0,
\item $R \to S$ is injective and of finite type, and
\item $S$ is a domain and $f.f.(R) \to f.f.(S)$ is separable.
\end{enumerate}
Then $S$ is J-0.
\end{lemma}

\begin{proof}
We may replace $R$ by a principal localization and assume $R$ is
a regular ring. By Algebra, Lemma \ref{algebra-lemma-smooth-at-generic-point}
the ring map $R \to S$ is smooth at $(0)$.
Hence after replacing $S$ by a principal localization
we may assume that $S$ is smooth over $R$.
Then $S$ is regular too, see
Algebra, Lemma \ref{algebra-lemma-regular-goes-up}.
\end{proof}

\begin{lemma}
\label{lemma-J-2}
Let $R$ be a Noetherian ring. The following are equivalent
\begin{enumerate}
\item $R$ is J-2,
\item every finite type $R$-algebra which is a domain is J-0,
\item every finite $R$-algebra is J-1,
\item for every prime $\mathfrak p$ and every finite purely inseparable
extension $\kappa(\mathfrak p) \subset L$ there exists a finite
$R$-algebra $R'$ which is a domain, which is J-0, and whose field
of fractions is $L$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that we have the implications (1) $\Rightarrow$ (2) and
(2) $\Rightarrow$ (4). Recall that a domain which is
J-1 is J-0. Hence we also have the implications
(1) $\Rightarrow$ (3) and (3) $\Rightarrow$ (4).

\medskip\noindent
Let $R \to S$ be a finite type ring map and let's try to show $S$ is J-1. By
Lemma \ref{lemma-intersection-regular-with-closed} it suffices
to prove that $S/\mathfrak q$ is J-0 for every prime $\mathfrak q$
of $S$. In this way we see (2) $\Rightarrow$ (1).

\medskip\noindent
Assume (4). We will show that (2) holds which will finish the proof.
Let $R \to S$ be a finite type ring map with $S$ a domain.
Let $\mathfrak p = \text{Ker}(R \to S)$. Set $K = f.f.(S)$. There exists
a diagram of fields
$$
\xymatrix{
K \ar[r] & K' \\
\kappa(\mathfrak p) \ar[u] \ar[r] & L \ar[u]
}
$$
where the horizontal arrows are finite purely inseparable field extensions
and where $K'/L$ is separable, see
Algebra, Lemma \ref{algebra-lemma-make-separably-generated}.
Choose $R' \subset L$ as in (4) and let
$S'$ be the image of the map $S \otimes_R R' \to K'$.
Then $S'$ is a domain whose fraction field is $K'$, hence
$S'$ is J-0 by Lemma \ref{lemma-J-0-goes-up} and our choice of $R'$.
Then we apply Lemma \ref{lemma-J-0-goes-down} to see that $S$
is J-0 as desired.
\end{proof}



\section{Regularity and derivations}
\label{section-regularity-derivations}

\noindent
Let $R \to S$ be a ring map. Let $D : R \to R$ be a derivation.
We say that $D$ {\it extends to} $S$
if there exists a derivation $D' : S \to S$ such that
$$
\xymatrix{
S \ar[r]_{D'} & S \\
R \ar[u] \ar[r]^D & R \ar[u]
}
$$
is commutative.

\begin{lemma}
\label{lemma-derivation-extends}
Let $R$ be a ring. Let $D : R \to R$ be a derivation.
\begin{enumerate}
\item For any ideal $I \subset R$ the derivation $D$ extends
canonically to a derication $D^\wedge : R^\wedge \to R^\wedge$
on the $I$-adic completion.
\item For any mulitplicative subset $S \subset R$ the derivation
$D$ extends uniquely to the localization $S^{-1}R$ of $R$.
\end{enumerate}
If $R \subset R'$ is an finite type extension of rings such that
$R_g \cong R'_g$ for some nonzerodivisor $g \in R$, then $g^ND$ extends
to $R'$ for some $N \geq 0$.
\end{lemma}

\begin{proof}
Proof of (1). For $n \geq 2$ we have $D(I^n) \subset I^{n - 1}$
by the Leibniz rule. Hence $D$ induces maps $D_n : R/I^n \to R/I^{n - 1}$.
Taking the limit we obtain $D^\wedge$. We omit the verification that
$D^\wedge$ is a derivation.

\medskip\noindent
Proof of (2). To extend $D$ to $S^{-1}R$ just set
$D(r/s) = D(r)/s - rD(s)/s^2$ and check the axioms.

\medskip\noindent
Proof of the final statement. Let $x_1, \ldots, x_n \in R'$ be generators
of $R'$ over $R$. Choose an $N$ such that $g^Nx_i \in R$.
Consider $g^{N + 1}D$. By (2) this extends to $R_g$. Moreover, by
the Leibniz rule and our construction of the extension above we have
$$
g^{N + 1}D(x_i) = g^{N + 1}D(g^{-N} g^Nx_i) = -Ng^Nx_iD(g) +
gD(g^Nx_i)
$$
and both terms are in $R$. This implies that
$$
g^{N + 1}D(x_1^{e_1} \ldots x_n^{e_n}) =
\sum e_i x_1^{e_1} \ldots x_i^{e_i - 1} \ldots x_n^{e_n} g^{N + 1}D(x_i)
$$
is an element of $R'$. Hence every element of $R'$ (which can be written
as a sum of monomials in the $x_i$ with coefficients in $R$) is mapped to an
element of $R'$ by $g^{N + 1}D$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-quotient-regular}
Let $R$ be a regular ring. Let $f \in R$. Assume there exists a
derivation $D : R \to R$ such that $D(f)$ is a unit of $R/(f)$.
Then $R/(f)$ is regular.
\end{lemma}

\begin{proof}
It suffices to prove this when $R$ is a local ring with maximal ideal
$\mathfrak m$ and residue field $\kappa$. In this case it suffices
to prove that $f \not \in \mathfrak m^2$, see
Algebra, Lemma \ref{algebra-lemma-regular-ring-CM}.
However, if $f \in \mathfrak m^2$ then $D(f) \in \mathfrak m$
by the Leibniz rule, a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-degree-p-extension-regular}
Let $R$ be a regular $\mathbf{F}_p$-algebra. Let $f \in R$.
Assume there exists a derivation $D : R \to R$ such that $D(f)$ is a unit
of $R$. Then $R[z]/(z^p - f)$ is regular.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-quotient-regular}
to the extension of $D$ to $R[z]$ which maps $z$ to zero.
\end{proof}

\begin{lemma}
\label{lemma-find-D}
Let $p$ be a prime number. Let $B$ be a domain with $p = 0$ in $B$.
Let $f \in B$ be an element which is not a $p$th power in the fraction
field of $B$. If $B$ is of finite type over a Noetherian complete
local ring, then there exists a derivation $D : B \to B$ such that $D(f)$
is not zero.
\end{lemma}

\begin{proof}
Let $R$ be a Noetherian complete local ring such that there exists
a finite type ring map $R \to B$. Of course we may replace $R$ by
its image in $B$, hence we may assume $R$ is a domain of characteristic
$p > 0$ (as well as Noetherian complete local). By Algebra, Lemma
\ref{algebra-lemma-complete-local-Noetherian-domain-finite-over-regular}
we can write $R$ as a finite extension of $k[[x_1, \ldots, x_n]]$ for some
field $k$ and integer $n$. Hence we may replace $R$ by $k[[x_1, \ldots, x_n]]$.
Next, we use
Algebra, Lemma \ref{algebra-lemma-Noether-normalization-over-a-domain}
to factor $R \to B$ as
$$
R \subset R[y_1, \ldots, y_d] \subset B' \subset B
$$
with $B'$ finite over $R[y_1, \ldots, y_d]$ and $B'_g \cong B_g$
for some nonzero $g \in R$. Note that $f' = g^{pN} f \in B'$ for some
large integer $N$. It is clear that $f'$ is not a $p$th power in
$f.f.(B') = f.f.(B)$. If we can find a derivation
$D' : B' \to B'$ with $D'(f') \not = 0$, then
Lemma \ref{lemma-derivation-extends}
guarantees that $D = g^MD'$ extends to $S$ for some $M > 0$. Then
$D(f) = g^ND'(f) = g^MD'(g^{-pN}f') = g^{M - pN}D'(f')$ is nonzero.
Thus it suffices to prove the lemma in case
$B$ is a finite exteion of $A = k[[x_1, \ldots, x_n]][y_1, \ldots, y_m]$.

\medskip\noindent
Note that $\text{d}f$ is not zero in $\Omega_{f.f.(B)/\mathbf{F}_p}$, see
Algebra, Lemma \ref{algebra-lemma-derivative-zero-pth-power}.
We apply Lemma \ref{lemma-power-series-ring-subfields} to find a subfield
$k' \subset k$ of finite index such that with
$A' = k'[[x_1^p, \ldots, x_n^p]][y_1^p, \ldots, y_m^p]$ the element
$\text{d}f$ does not map to zero in $\Omega_{f.f.(B)/f.f.(A')}$.
Thus we can choose a $f.f.(A')$-derivation $D' : f.f.(B) \to f.f.(B)$
with $D'(f) \not = 0$. Since $A' \subset A$ and $A \subset B$ are
finite by construction we see that $A' \subset B$ is finite.
Choose $b_1, \ldots, b_t \in B$ which generate $B$ as an $A'$-module.
Then $D'(b_i) = f_i/g_i$ for some $f_i, g_i \in B$ with $g_i \not = 0$.
Setting $D = g_1 \ldots g_t D'$ we win.
\end{proof}

\begin{lemma}
\label{lemma-complete-Noetherian-domain-J-0}
Let $A$ be a Noetherian complete local domain. Then $A$ is J-0.
\end{lemma}

\begin{proof}
By Algebra, Lemma
\ref{algebra-lemma-complete-local-Noetherian-domain-finite-over-regular}
we can find a regular subring $A_0 \subset A$ with $A$ finite over $A_0$.
If $f.f.(A_0) \subset f.f.(A)$ is separable, then we are done by
Lemma \ref{lemma-J-0-goes-up}. If not, then $A_0$ and $A$
have characteristic $p > 0$. For any subextension
$f.f.(A_0) \subset M \subset f.f.(A)$ there exists a finite subextension
$A_0 \subset B \subset A$ such that $f.f.(B) = M$.
Hence, arguing by induction on $[f.f.(A) : f.f.(A_0)]$ we may
assume there exists $A_0 \subset B \subset A$ such that
$B$ is J-0 and $f.f.(B) \subset f.f.(A)$ has no nontrivial subextensions.
In this case, if $f.f.(B) \subset f.f.(A)$ is separable, then we
see that $A$ is J-0 by Lemma \ref{lemma-J-0-goes-up}.
If not, then $f.f.(A) = f.f.(B)[z]/(z^p - b)$ for some $b \in B$
which is not a $p$th power in $f.f.(B)$.
By Lemma \ref{lemma-find-D}
we can find a derivation $D : B \to B$ with $D(f) \not = 0$.
Applying Lemma \ref{lemma-degree-p-extension-regular}
we see that $A_\mathfrak p$ is regular for any prime
$\mathfrak p$ of $A$ lying over a regular prime of $B$
and not containing $D(f)$. As $B$ is J-0 we conclude $A$ is too.
\end{proof}

\begin{proposition}
\label{proposition-ubiquity-J-2}
The following types of rings are J-2:
\begin{enumerate}
\item fields,
\item Noetherian complete local rings,
\item $\mathbf{Z}$,
\item Dedekind domains with fraction field of characteristic zero,
\item finite type ring extensions of any of the above.
\end{enumerate}
\end{proposition}

\begin{proof}
For fields, $\mathbf{Z}$ and Dedekind domains of characteristic zero
you just check condition (4) of Lemma \ref{lemma-J-2}.
In the case of Noetherian complete local rings, note that if
$R \to R'$ is finite and $R$ is a Noetherian complete local ring,
then $R'$ is a product of Noetherian complete local rings, see
Algebra, Lemma \ref{algebra-lemma-quotient-complete-local}.
Hence it suffices to prove that a Noetherian complete local ring
which is a domain is J-0, which is
Lemma \ref{lemma-complete-Noetherian-domain-J-0}.
\end{proof}





\section{Formal smoothness and regularity}
\label{section-fs-regular}

\noindent
The title of this section refers to Proposition \ref{proposition-fs-regular}.

\begin{lemma}
\label{lemma-lift-derivation-through-fs}
Let $A \to B$ be a local homomorphism of Noetherian local rings.
Let $D : A \to A$ be a derivation. Assume that $B$ is complete
and $A \to B$ is formally smooth in the $\mathfrak m_B$-adic topology.
Then there exists an extension $D' : B \to B$ of $D$.
\end{lemma}

\begin{proof}
Denote $B[\epsilon] = B[x]/(x^2)$ the ring of dual numbers over $B$.
Consider the ring map $\psi : A \to B[\epsilon]$,
$a \mapsto a + \epsilon D(a)$.
Consider the commutative diagram
$$
\xymatrix{
B \ar[r]_1 & B \\
A \ar[u] \ar[r]^\psi & B[\epsilon] \ar[u]
}
$$
By Lemma \ref{lemma-lift-continuous} and the assumption of formal
smoothness of $B/A$ we find a map $\varphi : B \to B[\epsilon]$ fitting into
the diagram. Write $\varphi(b) = b + \epsilon D'(b)$. Then $D' : B \to B$
is the desired extension.
\end{proof}

\begin{proposition}
\label{proposition-fs-regular}
Let $A \to B$ be a local homomorphism of Noetherian complete local rings.
The following are equivalent
\begin{enumerate}
\item $A \to B$ is regular,
\item $A \to B$ is flat and $\overline{B}$ is geometrically regular
over $k$,
\item $A \to B$ is flat and $k \to \overline{B}$ is formally smooth
in the $\mathfrak m_{\overline{B}}$-adic topology, and
\item $A \to B$ is formally smooth in the $\mathfrak m_B$-adic
topology.
\end{enumerate}
\end{proposition}

\begin{proof}
We have seen the equivalence of (2), (3), and (4) in
Proposition \ref{proposition-fs-flat-fibre-fs}.
It is clear that (1) implies (2).
Thus we assume the equivalent conditions (2), (3), and (4) hold
and we prove (1).

\medskip\noindent
Let $\mathfrak p$ be a prime of $A$. We will show that
$B \otimes_A \kappa(\mathfrak p)$ is geometrically regular
over $\kappa(\mathfrak p)$.
By Lemma \ref{lemma-base-change-fs}
we may replace $A$ by $A/\mathfrak p$ and $B$ by $B/\mathfrak pB$.
Thus we may assume that $A$ is a domain and that $\mathfrak p = (0)$.

\medskip\noindent
Choose $A_0 \subset A$ as in Algebra, Lemma
\ref{algebra-lemma-complete-local-Noetherian-domain-finite-over-regular}.
We will use all the properties stated in that lemma without further mention.
As $A_0 \to A$ induces an isomorphism on residue fields, and as
$B/\mathfrak m_A B$ is geometrically regular over $A/\mathfrak m_A$
we can find a diagram
$$
\xymatrix{
C \ar[r] & B \\
A_0 \ar[r] \ar[u] & A \ar[u]
}
$$
with $A_0 \to C$ formally smooth in the $\mathfrak m_C$-adic topology
such that $B = C \otimes_{A_0} A$, see Remark \ref{remark-what-does-it-mean}.
(Completion in the tensor product is not needed as $A_0 \to A$ is
finite, see Algebra, Lemma \ref{algebra-lemma-completion-tensor}.)
Hence it suffices to show that $C \otimes_{A_0} f.f.(A_0)$
is a geometrically regular algebra over $f.f.(A_0)$.

\medskip\noindent
The upshot of the preceding paragraph is that we may assume that
$A = k[[x_1, \ldots, x_n]]$ where $k$ is a field or
$A = \Lambda[[x_1, \ldots, x_n]]$ where $\Lambda$ is a Cohen ring.
In this case $B$ is a regular ring, see
Algebra, Lemma \ref{algebra-lemma-flat-over-regular-with-regular-fibre}.
Hence $B \otimes_A f.f.(A)$ is a regular ring too and we win
if the characteristic of $f.f.(A)$ is zero.

\medskip\noindent
Thus we are left with the case where $A = k[[x_1, \ldots, x_n]]$
and $k$ is a field of characteristic $p > 0$. Set $K = f.f.(A)$.
Let $L \supset K$ be a finite purely inseparable field extension.
We will show by induction on $[L : K]$ that $B \otimes_A L$
is regular. The base case is $L = K$ which we've seen above.
Let $K \subset M \subset L$ be a subfield such that
$L$ is a degree $p$ extension of $M$ obtained by adjoining a $p$th root
of an element $f \in M$. Let $A'$ be a finite $A$-subalgebra
of $M$ with fraction field $M$. Clearing denominators, we may and do assume
$f \in A'$. Set $A'' = A'[z]/(z^p -f)$ and note that $A' \subset A''$
is finite and that the fraction field of $A''$ is $L$.
By induction we know that $B \otimes_A M$ ring is regular.
We have
$$
B \otimes_A L = B \otimes_A M[z]/(z^p - f)
$$
By Lemma \ref{lemma-find-D} we know there exists a derivation
$D : A' \to A'$ such that $D(f) \not = 0$. As $A' \to B \otimes_A A'$
is formally smooth in the $\mathfrak m$-adic topology by
Lemma \ref{lemma-descent-fs}
we can use
Lemma \ref{lemma-lift-derivation-through-fs}
to extend $D$ to a derivation $D' : B \otimes_A A' \to B \otimes_A A'$.
Note that $D'(f) = D(f)$ is a unit in $B \otimes_A M$ as $D(f)$
is not zero in $A' \subset M$. Hence $B \otimes_A L$ is regular by
Lemma \ref{lemma-degree-p-extension-regular} and we win.
\end{proof}





\section{G-rings}
\label{section-G-ring}

\noindent
Let $A$ be a Noetherian local ring $A$. In
Section \ref{section-permanence-completion}
we have seen that some but not all properties of $A$ are reflected in
the completion $A^\wedge$ of $A$. To study this further we introduce
some terminology. For a prime $\mathfrak q$ of $A$ the fibre ring
$$
(A^\wedge) \otimes_A \kappa(\mathfrak q) =
(A^\wedge)_\mathfrak q/\mathfrak q(A^\wedge)_\mathfrak q
$$
is called a {\it formal fibre} of $A$. We think of the formal
fibre as an algebra over $\kappa(\mathfrak q)$. Thus $A \to A^\wedge$
is a regular ring homomorphism if and only if all the formal fibres are
geometrically regular algebras.

\begin{definition}
\label{definition-G-ring}
A ring $R$ is called a {\it G-ring} if $R$ is Noetherian and for every
prime $\mathfrak p$ of $R$ the ring map
$R_\mathfrak p \to (R_\mathfrak p)^\wedge$ is regular.
\end{definition}

\noindent
By the discussion above we see that $R$ is a G-ring if and only if
every local ring $R_\mathfrak p$ has geometrically regular formal fibres.
Note that if $\mathbf{Q} \subset R$, then it suffices to check the
formal fibres are regular.
Another way to express the G-ring condition is described in the
following lemma.

\begin{lemma}
\label{lemma-check-G-ring-easy}
Let $R$ be a Noetherian ring. Then $R$ is a G-ring if and only if
for every pair of primes $\mathfrak q \subset \mathfrak p \subset R$
the algebra
$$
(R/\mathfrak q)_\mathfrak p^\wedge \otimes_{R/\mathfrak q} \kappa(\mathfrak q)
$$
is geometrically regular over $\kappa(\mathfrak q)$.
\end{lemma}

\begin{proof}
This follows from the fact that
$$
R_\mathfrak p^\wedge \otimes_R \kappa(\mathfrak q) =
(R/\mathfrak q)_\mathfrak p^\wedge \otimes_{R/\mathfrak q} \kappa(\mathfrak q)
$$
as algebras over $\kappa(\mathfrak q)$.
\end{proof}

\begin{lemma}
\label{lemma-G-ring-goes-up-quasi-finite}
Let $R \to R'$ be a finite type map of Noetherian rings and let
$$
\xymatrix{
\mathfrak q' \ar[r] & \mathfrak p' \ar[r] & R' \\
\mathfrak q \ar[r] \ar@{-}[u] &
\mathfrak p \ar[r] \ar@{-}[u] & R \ar[u]
}
$$
be primes. Assume $R \to R'$ is quasi-finite at $\mathfrak p'$.
\begin{enumerate}
\item If the formal fibre $R_\mathfrak p^\wedge \otimes_R \kappa(\mathfrak q)$
is geometrically regular over $\kappa(\mathfrak q)$, then the formal fibre
$R'_{\mathfrak p'} \otimes_{R'} \kappa(\mathfrak q')$ is geometrically regular
over $\kappa(\mathfrak q')$.
\item If the formal fibres of $R_\mathfrak p$ are geometrically regular,
then the formal fibres of $R'_{\mathfrak p'}$ are geometrically regular.
\item If $R \to R'$ is quasi-finite and $R$ is a G-ring, then $R'$ is
a G-ring.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) $\Rightarrow$ (2) $\Rightarrow$ (3).
Assume $R_\mathfrak p^\wedge \otimes_R \kappa(\mathfrak q)$
is geometrically regular over $\kappa(\mathfrak q)$.
By Algebra, Lemma \ref{algebra-lemma-completion-at-quasi-finite-prime}
we see that
$$
R_\mathfrak p^\wedge \otimes_R R'
=
(R'_{\mathfrak p'})^\wedge \times B
$$
for some $R_\mathfrak p^\wedge$-algebra $B$. Hence
$R'_{\mathfrak p'} \to (R'_{\mathfrak p'})^\wedge$ is a factor of
a base change of the map $R_\mathfrak p \to R_\mathfrak p^\wedge$.
It follows that $(R'_{\mathfrak p'})^\wedge \otimes_{R'} \kappa(\mathfrak q')$
is a factor of
$$
R_\mathfrak p^\wedge \otimes_R R' \otimes_{R'} \kappa(\mathfrak q') =
R_\mathfrak p^\wedge \otimes_R \kappa(\mathfrak q)
\otimes_{\kappa(\mathfrak q)} \kappa(\mathfrak q').
$$
Thus the result follows as extension of base field preserves
geometric regularity, see
Algebra, Lemma \ref{algebra-lemma-geometrically-regular}.
\end{proof}

\begin{lemma}
\label{lemma-check-G-ring}
Let $R$ be a Noetherian ring. Then $R$ is a G-ring if and only if
for every finite free ring map $R \to S$ the formal fibres of $S$
are regular rings.
\end{lemma}

\begin{proof}
Assume that for any finite free ring map $R \to S$ the ring $S$ has
regular formal fibres. Let $\mathfrak q \subset \mathfrak p \subset R$
be primes and let $\kappa(\mathfrak q) \subset L$ be a finite purely
inseparable extension. To show that $R$ is a G-ring it suffices to
show that
$$
R_\mathfrak p^\wedge \otimes_R \kappa(\mathfrak q)
\otimes_{\kappa(\mathfrak q)} L
$$
is a regular ring. Choose a finite free extension $R \to R'$ such that
$\mathfrak q' = \mathfrak qR'$ is a prime and such that $\kappa(\mathfrak q')$
is isomorphic to $L$ over $\kappa(\mathfrak q)$, see
Algebra, Lemma \ref{algebra-lemma-finite-free-given-residue-field-extension}.
By
Algebra, Lemma \ref{algebra-lemma-completion-finite-extension}
we have
$$
R_\mathfrak p^\wedge \otimes_R R' = \prod (R'_{\mathfrak p_i'})^\wedge
$$
where $\mathfrak p_i'$ are the primes of $R'$ lying over $\mathfrak p$.
Thus we have
$$
R_\mathfrak p^\wedge \otimes_R \kappa(\mathfrak q)
\otimes_{\kappa(\mathfrak q)} L =
R_\mathfrak p^\wedge \otimes_R R'
\otimes_{R'} \kappa(\mathfrak q')
=
\prod (R'_{\mathfrak p_i'})^\wedge
\otimes_{R'_{\mathfrak p'_i}} \kappa(\mathfrak q')
$$
Our assumption is that the rings on the right are regular, hence the
ring on the left is regular too. Thus $R$ is a G-ring. The converse
follows from Lemma \ref{lemma-G-ring-goes-up-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-helper-G-ring}
Let $k$ be a field of characteristic $p$.
Let $A = k[[x_1, \ldots, x_n]][y_1, \ldots, y_n]$ and denote $K = f.f.(A)$.
Let $\mathfrak p \subset A$ be a prime. Then
$A_\mathfrak p^\wedge \otimes_A K$ is geometrically regular over $K$.
\end{lemma}

\begin{proof}
Let $L \supset K$ be a finite purely inseparable field extension.
We will show by induction on $[L : K]$ that $A_\mathfrak p^\wedge \otimes L$
is regular. The base case is $L = K$: as $A$ is regular,
$A_\mathfrak p^\wedge$ is regular (Lemma \ref{lemma-completion-regular}),
hence the localization $A_\mathfrak p^\wedge \otimes K$ is regular.
Let $K \subset M \subset L$ be a subfield such that
$L$ is a degree $p$ extension of $M$ obtained by adjoining a $p$th root
of an element $f \in M$. Let $B$ be a finite $A$-subalgebra
of $M$ with fraction field $M$. Clearing denominators, we may and do assume
$f \in B$. Set $C = B[z]/(z^p -f)$ and note that $B \subset C$
is finite and that the fraction field of $C$ is $L$. Since
$A \subset B \subset C$ are finite and $L/M/K$ are purely
inseparable we see that for every element of $B$ or $C$ some power of
it lies in $A$. Hence there is a unique prime $\mathfrak r \subset B$,
resp.\ $\mathfrak q \subset C$ lying over $\mathfrak p$. Note that
$$
A_\mathfrak p^\wedge \otimes_A M = B_\mathfrak r^\wedge \otimes_B M
$$
see Algebra, Lemma \ref{algebra-lemma-completion-finite-extension}.
By induction we know that this ring is regular. In the same manner we have
$$
A_\mathfrak p^\wedge \otimes_A L =
C_\mathfrak r^\wedge \otimes_C L =
B_\mathfrak r^\wedge \otimes_B M[z]/(z^p - f)
$$
the last equality because the completion of
$C = B[z]/(z^p - f)$ equals $B_\mathfrak r^\wedge[z]/(z^p -f)$.
By Lemma \ref{lemma-find-D} we know there exists a derivation
$D : B \to B$ such that $D(f) \not = 0$. In other words, $g = D(f)$
is a unit in $M$! By Lemma \ref{lemma-derivation-extends}
$D$ extends to a derivation of $B_\mathfrak r$, $B_\mathfrak r^\wedge$
and $B_\mathfrak r^\wedge \otimes_B M$ (successively extending through a
localization, a completion, and a localization). Since it is an
extension we end up with a derivation of $B_\mathfrak r^\wedge \otimes_B M$
which maps $f$ to $g$ and $g$ is a unit of the ring
$B_\mathfrak r^\wedge \otimes_B M$.
Hence $A_\mathfrak p^\wedge \otimes_A L$ is regular by
Lemma \ref{lemma-degree-p-extension-regular} and we win.
\end{proof}

\begin{proposition}
\label{proposition-Noetherian-complete-G-ring}
A Noetherian complete local ring is a G-ring.
\end{proposition}

\begin{proof}
Let $A$ be a Noetherian complete local ring. By
Lemma \ref{lemma-check-G-ring-easy}
it suffices to check that $B = A/\mathfrak q$ has geometrically regular
formal fibres over the minimal prime $(0)$ of $B$. Thus we may assume
that $A$ is a domain and it suffices to check the condition for
the formal fibres over the minimal prime $(0)$ of $A$.
Set $K = f.f(A)$.

\medskip\noindent
We can choose a subring $A_0 \subset A$ which is a regular complete local
ring such that $A$ is finite over $A_0$, see Algebra, Lemma
\ref{algebra-lemma-complete-local-Noetherian-domain-finite-over-regular}.
Moreover, we may assume that $A_0$ is a power series ring over a
field or a Cohen ring. By Lemma \ref{lemma-G-ring-goes-up-quasi-finite}
we see that it suffices to prove the result for $A_0$.

\medskip\noindent
Assume that $A$ is a power series ring over a field or a Cohen ring.
Since $A$ is regular the localizations $A_\mathfrak p$ are regular
(see Algebra, Definition \ref{algebra-definition-regular} and the
discussion preceding it).
Hence the completions $A_\mathfrak p^\wedge$ are regular, see
Lemma \ref{lemma-completion-regular}.
Hence the fibre $A_{\mathfrak p}^\wedge \otimes_A K$ is, as a localization
of $A_\mathfrak p^\wedge$, also regular. Thus we are done if the
characteristic of $K$ is $0$. The positive characteristic case
is the case $A = k[[x_1, \ldots, x_d]]$ which is a special case of
Lemma \ref{lemma-helper-G-ring}.
\end{proof}

\begin{lemma}
\label{lemma-check-G-ring-maximal-ideals}
Let $R$ be a Noetherian ring. Then $R$ is a G-ring if and only if
$R_\mathfrak m$ has geometrically regular formal fibres for every
maximal ideal $\mathfrak m$ of $R$.
\end{lemma}

\begin{proof}
Assume $R_\mathfrak m \to R_\mathfrak m^\wedge$ is regular for every
maximal ideal $\mathfrak m$ of $R$. Let $\mathfrak p$ be a prime of
$R$ and choose a maximal ideal $\mathfrak p \subset \mathfrak m$.
Since $R_\mathfrak m \to R_\mathfrak m^\wedge$ is faithfully flat
we can choose a prime $\mathfrak p'$ if $R_\mathfrak m^\wedge$
lying over $\mathfrak pR_\mathfrak m$. Consider the commutative diagram
$$
\xymatrix{
R_\mathfrak m^\wedge \ar[r] &
(R_\mathfrak m^\wedge)_{\mathfrak p'} \ar[r] &
(R_\mathfrak m^\wedge)_{\mathfrak p'}^\wedge
\\
R_\mathfrak m \ar[u] \ar[r] & R_\mathfrak p \ar[u] \ar[r] &
R_\mathfrak p^\wedge \ar[u]
}
$$
By assumption the ring map $R_\mathfrak m \to R_\mathfrak m^\wedge$ is
regular. By Proposition \ref{proposition-Noetherian-complete-G-ring}
$(R_\mathfrak m^\wedge)_{\mathfrak p'} \to
(R_\mathfrak m^\wedge)_{\mathfrak p'}^\wedge$ is regular.
Hence $R_\mathfrak m \to (R_\mathfrak m^\wedge)_{\mathfrak p'}^\wedge$
is regular and since it factors through the localization
$R_\mathfrak p$, also the ring map
$R_\mathfrak p \to (R_\mathfrak m^\wedge)_{\mathfrak p'}^\wedge$
is regular. Thus we may apply Lemma \ref{lemma-regular-permanence} to see that
$R_\mathfrak p \to R_\mathfrak p^\wedge$ is regular.
\end{proof}

\begin{lemma}
\label{lemma-henselization-G-ring}
Let $R$ be a Noetherian local ring ring which is a G-ring.
Then the henselization $R^h$ and the strict henselization $R^{sh}$
are G-rings.
\end{lemma}

\begin{proof}
We will use the criterion of Lemma \ref{lemma-check-G-ring-maximal-ideals}.
Let $\mathfrak q \subset R^h$ be a prime and set
$\mathfrak p = R \cap \mathfrak q$. Set $\mathfrak q_1 = \mathfrak q$
and let $\mathfrak q_2, \ldots, \mathfrak q_t$
be the other primes of $R^h$ lying over $\mathfrak p$, so that
$R^h \otimes_R \kappa(\mathfrak p) =
\prod\nolimits_{i = 1, \ldots, t} \kappa(\mathfrak q_i)$, see
Lemma \ref{lemma-fibres-henselization}.
Using that $(R^h)^\wedge = R^\wedge$
(Lemma \ref{lemma-henselization-noetherian}) we see
$$
\prod\nolimits_{i = 1, \ldots, t}
(R^h)^\wedge \otimes_{R^h} \kappa(\mathfrak q_i) =
(R^h)^\wedge \otimes_{R^h} (R^h \otimes_R \kappa(\mathfrak p)) =
R^\wedge \otimes_R \kappa(\mathfrak p)
$$
Hence $(R^h)^\wedge \otimes_{R^h} \kappa(\mathfrak q_i)$
is geometrically regular over $\kappa(\mathfrak p)$ by assumption.
Since $\kappa(\mathfrak q_i)$ is separable algebraic over $\kappa(\mathfrak p)$
it follows from Algebra, Lemma
\ref{algebra-lemma-geometrically-regular-over-separable-algebraic} that
$(R^h)^\wedge \otimes_{R^h} \kappa(\mathfrak q_i)$ is
geometrically regular over $\kappa(\mathfrak q_i)$.

\medskip\noindent
Let $\mathfrak r \subset R^{sh}$ be a prime and set
$\mathfrak p = R \cap \mathfrak r$. Set $\mathfrak r_1 = \mathfrak r$
and let $\mathfrak r_2, \ldots, \mathfrak r_s$
be the other primes of $R^{sh}$ lying over $\mathfrak p$, so that
$R^{sh} \otimes_R \kappa(\mathfrak p) =
\prod\nolimits_{i = 1, \ldots, t} \kappa(\mathfrak q_i)$, see
Lemma \ref{lemma-fibres-henselization}.
Then we see that
$$
\prod\nolimits_{i = 1, \ldots, t}
(R^{sh})^\wedge \otimes_{R^{sh}} \kappa(\mathfrak r_i) =
(R^{sh})^\wedge \otimes_{R^{sh}} (R^{sh} \otimes_R \kappa(\mathfrak p)) =
(R^{sh})^\wedge \otimes_R \kappa(\mathfrak p)
$$
Note that $R^\wedge \to (R^{sh})^\wedge$ is formally smooth
in the $\mathfrak m_{(R^{sh})^\wedge}$-adic topology, see
Lemma \ref{lemma-henselization-noetherian}.
Hence $R^\wedge \to (R^{sh})^\wedge$ is regular by
Proposition \ref{proposition-fs-regular}.
We conclude that $(R^{sh})^\wedge \otimes_{R^h} \kappa(\mathfrak q_i)$
is regular over $\kappa(\mathfrak p)$ by
Lemma \ref{lemma-regular-composition} as
$R^\wedge \otimes_R \kappa(\mathfrak p)$ is regular over $\kappa(\mathfrak p)$
by assumption. Since $\kappa(\mathfrak r_i)$ is separable algebraic over
$\kappa(\mathfrak p)$
it follows from Algebra, Lemma
\ref{algebra-lemma-geometrically-regular-over-separable-algebraic} that
$(R^{sh})^\wedge \otimes_{R^{sh}} \kappa(\mathfrak r_i)$ is
geometrically regular over $\kappa(\mathfrak r_i)$.
\end{proof}

\begin{lemma}
\label{lemma-another-helper-G-ring}
Let $p$ be a prime number. Let $A$ be a Noetherian complete local domain
with fraction field $K$ of characteristic $p$. Let $\mathfrak q \subset A[x]$
be a maximal ideal lying over the maximal ideal of $A$ and let
$\mathfrak r \subset \mathfrak q$ be a prime lying over $(0) \subset A$. Then
$A[x]_\mathfrak q^\wedge \otimes_{A[x]} \kappa(\mathfrak r)$ is geometrically
regular over $\kappa(\mathfrak r)$.
\end{lemma}

\begin{proof}
Note that $K \subset \kappa(r)$ is finite. Hence, given a finite purely
inseparable extension $\kappa(r) \subset L$ there exists a finite
extension of Noetherian complete local domains $A \subset B$ such that
$\kappa(r) \otimes_A B$ surjects onto $L$. Namely, you take $B \subset L$
a finite $A$-subalgebra whose field of fractions is $L$. Denote
$\mathfrak r' \subset B[x]$ the kernel of the map
$B[x] = A[x] \otimes_A B \to \kappa(\mathfrak r) \otimes_A B \to L$
so that $\kappa(\mathfrak r') = L$. Then
$$
A[x]_\mathfrak q^\wedge \otimes_{A[x]} L =
A[x]_\mathfrak q^\wedge \otimes_{A[x]} B[x]
\otimes_{B[x]} \kappa(\mathfrak r') =
\prod B[x]_{\mathfrak q_i}^\wedge \otimes_{B[x]} \kappa(\mathfrak r')
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the primes of $B[x]$
lying over $\mathfrak q$, see
Algebra, Lemma \ref{algebra-lemma-completion-finite-extension}.
Thus we see that it suffices to prove the rings
$B[x]_{\mathfrak q_i}^\wedge \otimes_{B[x]} \kappa(\mathfrak r')$
are regular. This reduces us to showing that
$A[x]_\mathfrak q^\wedge \otimes_{A[x]} \kappa(\mathfrak r)$
is regular in the special case that $K = \kappa(\mathfrak r)$.

\medskip\noindent
Assume $K = \kappa(\mathfrak r)$. In this case we see that
$\mathfrak r K[x]$ is generated by $x - f$ for some $f \in K$
and
$$
A[x]_\mathfrak q^\wedge \otimes_{A[x]} \kappa(\mathfrak r)
=
(A[x]_\mathfrak q^\wedge \otimes_A K)/(x - f)
$$
The derivation $D = \text{d}/\text{d}x$ of $A[x]$ extends to $K[x]$ and
maps $x - f$ to a unit of $K[x]$. Moreover $D$ extends to
$A[x]_\mathfrak q^\wedge \otimes_A K$ by Lemma \ref{lemma-derivation-extends}.
As $A \to A[x]_\mathfrak q^\wedge$ is formally smooth (see
Lemmas \ref{lemma-formally-smooth} and
\ref{lemma-formally-smooth-completion})
the ring $A[x]_\mathfrak q^\wedge \otimes_A K$ is regular by
Proposition \ref{proposition-fs-regular} (the arguments of the
proof of that proposition simplify significantly in this particular case).
We conclude by Lemma \ref{lemma-quotient-regular}.
\end{proof}

\begin{proposition}
\label{proposition-finite-type-over-G-ring}
Let $R$ be a G-ring. If $R \to S$ is essentially of finite type
then $S$ is a G-ring.
\end{proposition}

\begin{proof}
Since being a G-ring is a property of the local rings it is clear
that a localization of a G-ring is a G-ring. Conversely, if every
localization at a prime is a G-ring, then the ring is a G-ring.
Thus it suffices to show that $S_\mathfrak q$ is a G-ring for every
finite type $R$-algebra $S$ and every prime $\mathfrak q$ of $S$.
Writing $S$ as a quotient of $R[x_1, \ldots, x_n]$ we see from
Lemma \ref{lemma-G-ring-goes-up-quasi-finite} that it suffices to prove
that $R[x_1, \ldots, x_n]$ is a G-ring. By induction on $n$ it
suffices to prove that $R[x]$ is a G-ring. Let $\mathfrak q \subset R[x]$
be a maximal ideal. By Lemma \ref{lemma-check-G-ring-maximal-ideals}
it suffices to show that
$$
R[x]_\mathfrak q \longrightarrow R[x]_\mathfrak q^\wedge
$$
is regular. If $\mathfrak q$ lies over $\mathfrak p \subset R$, then
we may replace $R$ by $R_\mathfrak p$. Hence we may assume that $R$
is a Noetherian local G-ring with maximal ideal $\mathfrak m$ and
that $\mathfrak q \subset R[x]$ lies over $\mathfrak m$. Note that
there is a unique prime $\mathfrak q' \subset R^\wedge[x]$
lying over $\mathfrak q$. Consider the diagram
$$
\xymatrix{
R[x]_\mathfrak q^\wedge \ar[r] &
(R^\wedge[x]_{\mathfrak q'})^\wedge \\
R[x]_\mathfrak q \ar[r] \ar[u] & R^\wedge[x]_{\mathfrak q'} \ar[u]
}
$$
Since $R$ is a G-ring the lower horizontal arrow is regular
(as a localization of a base change of the regular ring map
$R \to R^\wedge$). Suppose we can prove the right vertical arrow
is regular. Then it follows that the composition
$R[x]_\mathfrak q \to (R^\wedge[x]_{\mathfrak q'})^\wedge$
is regular, and hence the left vertical arrow is regular by
Lemma \ref{lemma-regular-permanence}.
Hence we see that we may assume $R$ is a Noetherian complete
local ring and $\mathfrak q$ a prime lying over the maximal
ideal of $R$.

\medskip\noindent
Let $R$ be a Noetherian complete local ring and let $\mathfrak q \subset R[x]$
be a maximal ideal lying over the maximal ideal of $R$. Let
$\mathfrak r \subset \mathfrak q$ be a prime ideal. We want to show that
$R[x]_\mathfrak q^\wedge \otimes_{R[x]} \kappa(\mathfrak r)$ is
a geometrically regular algebra over $\kappa(\mathfrak r)$.
Set $\mathfrak p = R \cap \mathfrak r$. Then we can replace $R$
by $R/\mathfrak p$ and $\mathfrak q$ and $\mathfrak r$ by their
images in $R/\mathfrak p[x]$, see
Lemma \ref{lemma-check-G-ring-easy}.
Hence we may assume that $R$ is a domain and that $\mathfrak r \cap R = (0)$.

\medskip\noindent
By  Algebra, Lemma
\ref{algebra-lemma-complete-local-Noetherian-domain-finite-over-regular}
we can find $R_0 \subset R$ which is regular and such that $R$ is
finite over $R_0$. Applying Lemma \ref{lemma-G-ring-goes-up-quasi-finite}
we see that it suffices to prove
$R[x]_\mathfrak q^\wedge \otimes_{R[x]} \kappa(\mathfrak r)$
is geometrically regular over $\kappa(r)$ when, in addition to the above,
$R$ is a regular complete local ring.

\medskip\noindent
Now $R$ is a regular complete local ring, we have
$\mathfrak q \subset \mathfrak r \subset R[x]$, we have
$(0) = R \cap \mathfrak r$ and $\mathfrak q$ is a maximal ideal
lying over the maximal ideal of $R$. Since $R$ is regular the
ring $R[x]$ is regular (Algebra, Lemma \ref{algebra-lemma-regular-goes-up}).
Hence the localization $R[x]_\mathfrak q$ is regular.
Hence the completions $R[x]_\mathfrak q^\wedge$ are regular, see
Lemma \ref{lemma-completion-regular}.
Hence the fibre $R[x]_{\mathfrak q}^\wedge \otimes_{R[x]} \kappa(\mathfrak r)$
is, as a localization of $R[x]_\mathfrak q^\wedge$, also regular.
Thus we are done if the characteristic of $f.f.(R)$ is $0$.

\medskip\noindent
If the characteristic of $R$ is positive, then $R = k[[x_1, \ldots, x_n]]$.
In this case we split the argument in two subcases:
\begin{enumerate}
\item The case $\mathfrak r = (0)$. The result is a direct consequence
of Lemma \ref{lemma-helper-G-ring}.
\item The case $\mathfrak r \not = (0)$. This is
Lemma \ref{lemma-another-helper-G-ring}.
\end{enumerate}
\end{proof}

\begin{remark}
\label{remark-G-does-not-survive-completion}
Let $R$ be a G-ring and let $I \subset R$ be an ideal.
In general it is not the case that the $I$-adic completion $R^\wedge$
is a G-ring. An example was given by Nishimura in \cite{Nishimura}.
A generalization and, in some sense, clarification of this example can
be found in the last section of \cite{Dumitrescu}.
\end{remark}

\begin{proposition}
\label{proposition-ubiquity-G-ring}
The following types of rings are G-rings:
\begin{enumerate}
\item fields,
\item Noetherian complete local rings,
\item $\mathbf{Z}$,
\item Dedekind domains with fraction field of characteristic zero,
\item finite type ring extensions of any of the above.
\end{enumerate}
\end{proposition}

\begin{proof}
For fields, $\mathbf{Z}$ and Dedekind domains of characteristic zero
this follows immediately from the definition and the fact that the
completion of a discrete valuation ring is a discrete valuation ring.
A Noetherian complete local ring is a G-ring by
Proposition \ref{proposition-Noetherian-complete-G-ring}.
The statement on finite type overrings is
Proposition \ref{proposition-finite-type-over-G-ring}.
\end{proof}






\section{Excellent rings}
\label{section-excellent}

\noindent
In this section we discuss Grothendieck's notion of excellent rings.
For the definitions of G-rings, J-2 rings, and universally catenary rings
we refer to Definition \ref{definition-G-ring},
Definition \ref{definition-J}, and
Algebra, Definition \ref{algebra-definition-universally-catenary}.

\begin{definition}
\label{definition-excellent}
Let $R$ be a ring.
\begin{enumerate}
\item We say $R$ is {\it quasi-excellent} if $R$ is Noetherian,
a G-ring, and J-2.
\item We say $R$ is {\it excellent} if $R$ is quasi-excellent
and universally catenary.
\end{enumerate}
\end{definition}

\noindent
Thus a Noetherian ring is quasi-excellent if it has geometrically regular
formal fibres and if any finite type algebra over it has closed singular
set. For such a ring to be excellent we require in addition that there
exists (locally) a good dimension function.

\begin{lemma}
\label{lemma-finite-type-over-excellent}
Any localization of a finite type ring over a (quasi-)excellent ring
is (quasi-)excellent.
\end{lemma}

\begin{proof}
For finite type algebras this follows from the definitions for
the properties J-2 and universally catenary. For G-rings, see
Proposition \ref{proposition-finite-type-over-G-ring}. We omit
the proof that localization preserves (quasi-)excellency.
\end{proof}

\begin{lemma}
\label{lemma-quasi-excellent-nagata}
A quasi-excellent ring is Nagata.
\end{lemma}

\begin{proof}
Let $R$ be quasi-excellent.
Using that a finite type algebra over $R$ is quasi-excellent
(Lemma \ref{lemma-finite-type-over-excellent}) we see that
it suffices to show that any quasi-excellent domain is N-1, see
Algebra, Lemma \ref{algebra-lemma-check-universally-japanese}.
Applying Algebra, Lemma \ref{algebra-lemma-characterize-N-1}
(and using that a quasi-excellent ring is J-2) we reduce
to showing that a quasi-excellent local domain $R$ is N-1.
As $R \to R^\wedge$ is regular we see that $R^\wedge$
is reduced by Lemma \ref{lemma-reduced-goes-up}.
In other words, $R$ is analytically unramified.
Hence $R$ is N-1 by
Algebra, Lemma \ref{algebra-lemma-analytically-unramified-easy}.
\end{proof}

\begin{proposition}
\label{proposition-ubiquity-excellent}
The following types of rings are excellent:
\begin{enumerate}
\item fields,
\item Noetherian complete local rings,
\item $\mathbf{Z}$,
\item Dedekind domains with fraction field of characteristic zero,
\item finite type ring extensions of any of the above.
\end{enumerate}
\end{proposition}

\begin{proof}
See Propositions \ref{proposition-ubiquity-G-ring} and
\ref{proposition-ubiquity-J-2} to see that these rings are
G-rings and have J-2. Any Cohen-Macaulay ring is universally
catenary (in particular fields, Dedekind rings, and more generally
regular rings are universally catenary). Via the Cohen structure theorem 
we see that complete local rings are universally catenary, see
Algebra, Remark
\ref{algebra-remark-Noetherian-complete-local-ring-universally-catenary}.
\end{proof}






\section{Pseudo-coherent modules}
\label{section-pseudo-coherent}

\noindent
Suppose that $R$ is a ring. Recall that an $R$-module $M$ is of finite type
if there exists a surjection $R^{\oplus a} \to M$ and of finite presentation
if there exists a presentation
$R^{\oplus a_1} \to R^{\oplus a_0} \to M \to 0$.
Similarly, we can consider those $R$-modules for which there exists
a length $n$ resolution
\begin{equation}
\label{equation-pseudo-coherent}
R^{\oplus a_n} \to R^{\oplus a_{n - 1}} \to \ldots \to R^{\oplus a_0} \to
M \to 0
\end{equation}
by finite free $R$-modules. A module is called {\it pseudo-coherent}
of we can find such a resolution for every $n$. Here is the formal
definition.

\begin{definition}
\label{definition-pseudo-coherent}
Let $R$ be a ring. Denote $D(R)$ its derived category.
Let $m \in \mathbf{Z}$.
\begin{enumerate}
\item An object $K^\bullet$ of $D(R)$ is {\it $m$-pseudo-coherent}
if there exists a bounded complex $E^\bullet$ of finite free $R$-modules
and a morphism $\alpha : E^\bullet \to K^\bullet$ such that
$H^i(\alpha)$ is an isomorphism for $i > m$ and $H^m(\alpha)$
is surjective.
\item An object $K^\bullet$ of $D(R)$ is {\it pseudo-coherent}
if it is quasi-isomorphic to a bounded above complex of finite
free $R$-modules.
\item An $R$-module $M$ is called {\it $m$-pseudo-coherent} if
if $M[0]$ is an $m$-pseudo-coherent object of $D(R)$.
\item An $R$-module $M$ is called
{\it pseudo-coherent}\footnote{This clashes with what is meant by
a pseudo-coherent module in \cite{Bourbaki-CA}.}
if $M[0]$ is a pseudo-coherent object of $D(R)$.
\end{enumerate}
\end{definition}

\noindent
As usual we apply this terminology also to complexes of $R$-modules.
Since any morphism $E^\bullet \to K^\bullet$ in $D(R)$ is represented
by an actual map of complexes, see
Derived Categories, Lemma \ref{derived-lemma-morphisms-from-projective-complex},
there is no ambiguity.
It turns out that $K^\bullet$ is pseudo-coherent if and only if
$K^\bullet$ is $m$-pseudo-coherent for all $m \in \mathbf{Z}$, see
Lemma \ref{lemma-pseudo-coherent}.
Also, if the ring is Noetherian the condition can be understood
as a finite generation condition on the cohomology, see
Lemma \ref{lemma-Noetherian-pseudo-coherent}.
Let us first relate this to the informal discussion above.

\begin{lemma}
\label{lemma-cone-pseudo-coherent}
Let $R$ be a ring and $m \in \mathbf{Z}$.
Let $(K^\bullet, L^\bullet, M^\bullet, f, g, h)$ be a distinguished
triangle in $D(R)$.
\begin{enumerate}
\item If $K^\bullet$ is $(m + 1)$-pseudo-coherent and
$L^\bullet$ is $m$-pseudo-coherent then $M^\bullet$ is
$m$-pseudo-coherent.
\item If $K^\bullet, M^\bullet$ are $m$-pseudo-coherent, then
$L^\bullet$ is $m$-pseudo-coherent.
\item If $L^\bullet$ is $(m + 1)$-pseudo-coherent and $M^\bullet$
is $m$-pseudo-coherent, then $K^\bullet$ is $(m + 1)$-pseudo-coherent.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Choose $\alpha : P^\bullet \to K^\bullet$
with $P^\bullet$ a bounded complex of finite free modules
such that $H^i(\alpha)$ is an isomorphism for $i > m + 1$ and
surjective for $i = m + 1$. We may replace $P^\bullet$ by
$\sigma_{\geq m + 1}P^\bullet$ and hence we may assume that $P^i = 0$
for $i < m + 1$. Choose $\beta : E^\bullet \to L^\bullet$ with $E^\bullet$
a bounded complex of finite free modules such that
$H^i(\beta)$ is an isomorphism for $i > m$ and
surjective for $i = m$. By
Derived Categories,
Lemma \ref{derived-lemma-lift-map}
we can find a map $\alpha : P^\bullet \to E^\bullet$ such that the diagram
$$
\xymatrix{
K^\bullet \ar[r] & L^\bullet \\
P^\bullet \ar[u] \ar[r]^\alpha & E^\bullet \ar[u]
}
$$
is commutative in $D(R)$. The cone $C(\alpha)^\bullet$ is a bounded
complex of finite free $R$-modules, and the commutativity of the
diagram implies that there exists a morphism of distinguished triangles
$$
(P^\bullet, E^\bullet, C(\alpha)^\bullet)
\longrightarrow
(K^\bullet, L^\bullet, M^\bullet).
$$
It follows from the induced map on long exact cohomology sequences and
Homology, Lemmas \ref{homology-lemma-four-lemma} and
\ref{homology-lemma-five-lemma}
that $C(\alpha)^\bullet \to M^\bullet$ induces an isomorphism
on cohomology in degrees $> m$ and a surjection in degree $m$.
Hence $M^\bullet$ is $m$-pseudo-coherent.

\medskip\noindent
Assertions (2) and (3) follow from (1) by rotating the distinguished
triangle.
\end{proof}

\begin{lemma}
\label{lemma-finite-cohomology}
Let $R$ be a ring. Let $K^\bullet$ be a complex of $R$-modules.
Let $m \in \mathbf{Z}$.
\begin{enumerate}
\item If $K^\bullet$ is $m$-pseudo-coherent and $H^i(K^\bullet) = 0$
for $i > m$, then $H^m(K^\bullet)$ is a finite type $R$-module.
\item If $K^\bullet$ is $m$-pseudo-coherent and $H^i(K^\bullet) = 0$
for $i > m + 1$, then $H^{m + 1}(K^\bullet)$ is a finitely presented
$R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Choose a bounded complex $E^\bullet$ of finite projective
$R$-modules and a map $\alpha : E^\bullet \to K^\bullet$ which induces
an isomorphism on cohomology in degrees $> m$ and a surjection in degree $m$.
It is clear that it suffices to prove the result for $E^\bullet$.
Let $n$ be the largest integer such that $E^n \not = 0$.
If $n = m$, then the result is clear.
If $n > m$, then $E^{n - 1} \to E^n$ is surjective as
$H^n(E^\bullet) = 0$. As $E^n$ is finite projective we see that
$E^{n - 1} = E' \oplus E^n$. Hence it suffices to prove the result
for the complex $(E')^\bullet$ which is the same as $E^\bullet$
except has $E'$ in degree $n - 1$ and $0$ in degree $n$.
We win by induction on $n$.

\medskip\noindent
Proof of (2). Choose a bounded complex $E^\bullet$ of finite projective
$R$-modules and a map $\alpha : E^\bullet \to K^\bullet$ which induces
an isomorphism on cohomology in degrees $> m$ and a surjection in degree $m$.
As in the proof of (1) we can reduce to the case that $E^i = 0$ for
$i > m + 1$. Then we see that
$H^{m + 1}(K^\bullet) \cong
H^{m + 1}(E^\bullet) = \text{Coker}(E^m \to E^{m + 1})$
which is of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-n-pseudo-module}
Let $R$ be a ring. Let $M$ be an $R$-module.
Then
\begin{enumerate}
\item $M$ is $0$-pseudo-coherent if and only if $M$ is a finite type
$R$-module,
\item $M$ is $(-1)$-pseudo-coherent if and only if $M$ is a finitely
presented $R$-module,
\item $M$ is $(-d)$-pseudo-coherent if and only if there exists a
resolution
$$
R^{\oplus a_d} \to R^{\oplus a_{d - 1}} \to \ldots \to R^{\oplus a_0} \to
M \to 0
$$
of length $d$, and
\item $M$ is pseudo-coherent if and only if there exists an
infinite resolution
$$
\ldots \to R^{\oplus a_1} \to R^{\oplus a_0} \to M \to 0
$$
by finite free $R$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
If $M$ is of finite type (resp.\ of finite presentation), then $M$
is $0$-pseudo-coherent (resp.\ $(-1)$-pseudo-coherent) as follows from the
discussion preceding
Definition \ref{definition-pseudo-coherent}.
Conversely, if $M$ is $0$-pseudo-coherent, then $M = H^0(M[0])$
is of finite type by
Lemma \ref{lemma-finite-cohomology}.
If $M$ is $(-1)$-pseudo-coherent, then it is $0$-pseudo-coherent hence
of finite type. Choose a surjection $R^{\oplus a} \to M$ and denote
$K = \text{Ker}(R^{\oplus a} \to M)$. By
Lemma \ref{lemma-cone-pseudo-coherent}
we see that $K$ is $0$-pseudo-coherent, hence of finite type, whence
$M$ is of finite presentation.

\medskip\noindent
To prove the third and fourth statement use
induction and an argument similar to the above (details omitted).
\end{proof}

\begin{lemma}
\label{lemma-pseudo-coherent}
Let $R$ be a ring. Let $K^\bullet$ be a complex of $R$-modules.
The following are equivalent
\begin{enumerate}
\item $K^\bullet$ is pseudo-coherent,
\item $K^\bullet$ is $m$-pseudo-coherent for every $m \in \mathbf{Z}$, and
\item $K^\bullet$ is quasi-isomorphic to a bounded above complex of finite
projective $R$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
We see that (1) $\Rightarrow$ (3) as a finite free module is a finite
projective $R$-module. Conversely, suppose $P^\bullet$ is a bounded
above complex of finite projective $R$-modules. Say $P^i = 0$ for
$i > n_0$. We choose a direct sum decompositions
$F^{n_0} = P^{n_0} \oplus C^{n_0}$ with $F^{n_0}$ a finite free
$R$-module, and inductively
$$
F^{n - 1} = P^{n - 1} \oplus C^n \oplus C^{n - 1}
$$
for $n \leq n_0$ with $F^{n_0}$ a finite free $R$-module. As a complex
$F^\bullet$ has maps $F^{n - 1} \to F^n$ which agree with $P^{n - 1} \to P^n$,
induce the identity $C^n \to C^n$, and are zero on $C^{n - 1}$. The map
$F^\bullet \to P^\bullet$ is a quasi-isomorphism (even a homotopy equivalence)
and hence (3) implies (1).

\medskip\noindent
Assume (1). Let $E^\bullet$ be a bounded above complex of finite free
$R$-modules and let $E^\bullet \to K^\bullet$ be a
quasi-isomorphism. Then the induced maps
$\sigma_{\geq m}E^\bullet \to K^\bullet$ from the stupid truncation
of $E^\bullet$ to $K^\bullet$ show that $K^\bullet$ is $m$-pseudo-coherent.
Hence (1) implies (2).

\medskip\noindent
Assume (2). We first apply (2) for $n = 0$ to obtain a
map of complexes $\alpha : F^\bullet \to K^\bullet$ where $F^\bullet$ is
bounded above, consists of finite free $R$-modules and such that
$H^i(\alpha)$ is an isomorphism for $i > 0$ and surjective for $i = 0$.
Note that these conditions remain satisfied after replacing $F^\bullet$
by $\sigma_{\geq 0}F^\bullet$. Picture
$$
\xymatrix{
& F^0 \ar[r] \ar[d]^\alpha & F^1 \ar[d]^\alpha \ar[r] & \ldots \\
K^{-1} \ar[r] & K^0 \ar[r] & K^1 \ar[r] & \ldots
}
$$
By induction on $n < 0$ we are going to extend $F^\bullet$ to a complex
$F^n \to F^{n + 1} \to \ldots \to F^{-1} \to F^0 \to \ldots$
of finite free $R$-modules and extend $\alpha$ such that $H^i(\alpha)$
is an isomorphism for $i > n$ and surjective for $i = n$.
By shifting it suffices to prove the induction step for $n = -1$, i.e.,
it suffices to extend the diagram above by adding $F^{-1}$.
Let $C^\bullet$ be the cone on $\alpha$
(Derived Categories, Definition \ref{derived-definition-cone}).
The long exact sequence
of cohomology shows that $H^i(C^\bullet) = 0$ for $i \geq 0$.
By Lemma \ref{lemma-cone-pseudo-coherent} we see that $C^\bullet$
is $(-1)$-pseudo-coherent. By
Lemma \ref{lemma-finite-cohomology}
we see that $H^{-1}(C^\bullet)$ is a finite $R$-module.
Choose a finite free $R$-module $F^{-1}$ and a map
$\beta : F^{-1} \to C^{-1}$ such that the composition
$F^{-1} \to C^{-1} \to C^0$ is zero and such that $F^{-1}$
surjects onto $H^{-1}(C^\bullet)$. Since $C^{-1} = K^{-1} \oplus F^0$
we can write $\beta = (\alpha^{-1}, -d^{-1})$. The vanishing of the
composition $F^{-1} \to C^{-1} \to C^0$ implies
these maps fit into a morphism of complexes
$$
\xymatrix{
& F^{-1} \ar[d]^{\alpha^{-1}} \ar[r]_{d^{-1}} &
F^0 \ar[r] \ar[d]^\alpha &
F^1 \ar[d]^\alpha \ar[r] & \ldots \\
\ldots \ar[r] &
K^{-1} \ar[r] & K^0 \ar[r] & K^1 \ar[r] & \ldots
}
$$
Moreover, these maps define a morphism of distinguished triangles
$$
\xymatrix{
(F^0 \to \ldots) \ar[r] \ar[d] &
(F^{-1} \to \ldots) \ar[r] \ar[d] &
F^{-1} \ar[r] \ar[d]_\beta &
(F^0 \to \ldots)[1] \ar[d] \\
(F^0 \to \ldots) \ar[r] &
K^\bullet \ar[r] &
C^\bullet \ar[r] &
(F^0 \to \ldots)[1]
}
$$
Hence our choice of $\beta$ implies that the map of complexes
$(F^{-1} \to \ldots) \to K^\bullet$ induces an isomorphism on
cohomology in degrees $\geq 0$ and a surjection in degree $-1$.
This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-two-out-of-three-pseudo-coherent}
Let $R$ be a ring. Let $(K^\bullet, L^\bullet, M^\bullet, f, g, h)$
be a distinguished triangle in $D(R)$. If two out of three of
$K^\bullet, L^\bullet, M^\bullet$ are
pseudo-coherent then the third is also pseudo-coherent.
\end{lemma}

\begin{proof}
Combine
Lemmas \ref{lemma-cone-pseudo-coherent} and \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-recognize-pseudo-coherent}
Let $R$ be a ring. Let $K^\bullet$ be a complex of $R$-modules.
Let $m \in \mathbf{Z}$.
\begin{enumerate}
\item If $H^i(K^\bullet) = 0$ for all $i \geq m$, then
$K^\bullet$ is $m$-pseudo-coherent.
\item If $H^i(K^\bullet) = 0$ for $i > m$ and $H^m(K^\bullet)$ is
a finite $R$-module, then $K^\bullet$ is $m$-pseudo-coherent.
\item If $H^i(K^\bullet) = 0$ for $i > m + 1$, the module
$H^{m + 1}(K^\bullet)$ is of finite presentation, and
$H^m(K^\bullet)$ is of finite type, then $K^\bullet$ is
$m$-pseudo-coherent.
\end{enumerate}
\end{lemma}

\begin{proof}
It suffices to prove (3). Set $M = H^{m + 1}(K^\bullet)$.
Note that $\tau_{\geq m + 1}K^\bullet$ is quasi-isomorphic to
$M[- m - 1]$. By
Lemma \ref{lemma-n-pseudo-module}
we see that $M[- m - 1]$ is $m$-pseudo-coherent. Since we have
the distinguished triangle
$$
(\tau_{\leq m}K^\bullet, K^\bullet, \tau_{\geq m + 1}K^\bullet)
$$
(Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle}) by
Lemma \ref{lemma-cone-pseudo-coherent}
it suffices to prove that $\tau_{\leq m}K^\bullet$ is pseudo-coherent.
By assumption $H^m(\tau_{\leq m}K^\bullet)$ is a finite type $R$-module.
Hence we can find a finite free $R$-module $E$ and a map
$E \to \text{Ker}(d_K^m)$ such that the composition
$E \to \text{Ker}(d_K^m) \to H^m(\tau_{\leq m}K^\bullet)$ is surjective.
Then $E[-m] \to \tau_{\leq m}K^\bullet$ witnesses the fact
that $\tau_{\leq m}K^\bullet$ is $m$-pseudo-coherent.
\end{proof}

\begin{lemma}
\label{lemma-summands-pseudo-coherent}
Let $R$ be a ring. Let $m \in \mathbf{Z}$. If $K^\bullet \oplus L^\bullet$
is $m$-pseudo-coherent (resp.\ pseudo-coherent)
so are $K^\bullet$ and $L^\bullet$.
\end{lemma}

\begin{proof}
In this proof we drop the superscript ${}^\bullet$.
Assume that $K \oplus L$ is $m$-pseudo-coherent.
It is clear that $K, L \in D^{-}(R)$.
Note that there is a distinguished triangle
$$
(K \oplus L, K \oplus L, L \oplus L[1]) =
(K, K, 0) \oplus (L, L, L \oplus L[1])
$$
see
Derived Categories, Lemma \ref{derived-lemma-direct-sum-triangles}.
By
Lemma \ref{lemma-cone-pseudo-coherent}
we see that $L \oplus L[1]$ is $m$-pseudo-coherent.
Hence also $L[1] \oplus L[2]$ is $m$-pseudo-coherent.
By induction $L[n] \oplus L[n + 1]$ is $m$-pseudo-coherent.
By
Lemma \ref{lemma-recognize-pseudo-coherent}
we see that $L[n]$ is $m$-pseudo-coherent for large $n$.
Hence working backwards, using the distinguished triangles
$$
(L[n], L[n] \oplus L[n - 1], L[n - 1])
$$
we conclude that $L[n], L[n - 1], \ldots, L$ are $m$-pseudo-coherent
as desired. The pseudo-coherent case follows from this and
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-complex-pseudo-coherent-modules}
Let $R$ be a ring. Let $m \in \mathbf{Z}$. Let $K^\bullet$ be a bounded
above complex of $R$-modules such that $K^i$ is $(m - i)$-pseudo-coherent
for all $i$. Then $K^\bullet$ is $m$-pseudo-coherent.
In particular, if $K^\bullet$ is a bounded above complex of
pseudo-coherent $R$-modules, then $K^\bullet$ is pseudo-coherent.
\end{lemma}

\begin{proof}
We may replace $K^\bullet$ by $\sigma_{\geq m - 1}K^\bullet$ (for example) and
hence assume that $K^\bullet$ is bounded.
Then the complex $K^\bullet$ is $m$-pseudo-coherent as each
$K^i[-i]$ is $m$-pseudo-coherent by induction on the length of the
complex: use
Lemma \ref{lemma-two-out-of-three-pseudo-coherent}
and the stupid truncations.
For the final statement, it suffices to prove that
$K^\bullet$ is $m$-pseudo-coherent for all $m \in \mathbf{Z}$, see
Lemma \ref{lemma-pseudo-coherent}.
This follows from the first part.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-pseudo-coherent}
Let $R$ be a ring. Let $m \in \mathbf{Z}$.
Let $K^\bullet \in D^{-}(R)$ such that $H^i(K^\bullet)$ is
$(m - i)$-pseudo-coherent (resp.\ pseudo-coherent) for all $i$.
Then $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent).
\end{lemma}

\begin{proof}
Assume $K^\bullet$ is an object of $D^{-}(R)$ such that
each $H^i(K^\bullet)$ is $(m - i)$-pseudo-coherent.
Let $n$ be the largest integer such that $H^n(K^\bullet)$ is nonzero.
We will prove the lemma by induction on $n$.
If $n < m$, then $K^\bullet$ is $m$-pseudo-coherent by
Lemma \ref{lemma-recognize-pseudo-coherent}.
If $n \geq m$, then we have the distinguished triangle
$$
(\tau_{\leq n - 1}K^\bullet, K^\bullet, H^n(K^\bullet)[-n])
$$
(Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle})
Since $H^n(K^\bullet)[-n]$ is $m$-pseudo-coherent by assumption, we
can use
Lemma \ref{lemma-cone-pseudo-coherent}
to see that it suffices to prove that $\tau_{\leq n - 1}K^\bullet$
is $m$-pseudo-coherent. By induction on $n$ we win. (The pseudo-coherent
case follows from this and
Lemma \ref{lemma-pseudo-coherent}.)
\end{proof}

\begin{lemma}
\label{lemma-finite-push-pseudo-coherent}
Let $A \to B$ be a ring map. Assume that $B$ is pseudo-coherent as an
$A$-module. Let $K^\bullet$ be a complex of $B$-modules.
The following are equivalent
\begin{enumerate}
\item $K^\bullet$ is $m$-pseudo-coherent
as a complex of $B$-modules, and
\item $K^\bullet$ is $m$-pseudo-coherent
as a complex of $A$-modules.
\end{enumerate}
The same equivalence holds for pseudo-coherence.
\end{lemma}

\begin{proof}
Assume (1). Choose a bounded complex of finite free $B$-modules
$E^\bullet$ and a map $\alpha : E^\bullet \to K^\bullet$ which is
an isomorphism on cohomology in degrees $> m$ and a surjection in degree $m$.
Consider the distinguished triangle
$(E^\bullet, K^\bullet, C(\alpha)^\bullet)$. By
Lemma \ref{lemma-recognize-pseudo-coherent}
$C(\alpha)^\bullet$ is $m$-pseudo-coherent as a complex of
$A$-modules. Hence it suffices to prove that $E^\bullet$ is
pseudo-coherent as a complex of $A$-modules, which follows from
Lemma \ref{lemma-complex-pseudo-coherent-modules}.
The pseudo-coherent case of (1) $\Rightarrow$ (2) follows from this and
Lemma \ref{lemma-pseudo-coherent}.

\medskip\noindent
Assume (2). Let $n$ be the largest integer such that $H^n(K^\bullet) \not = 0$.
We will prove that $K^\bullet$ is $m$-pseudo-coherent as a complex
of $B$-modules by induction on $n - m$. The case $n < m$ follows from
Lemma \ref{lemma-recognize-pseudo-coherent}.
Choose a bounded complex of finite free $A$-modules $E^\bullet$ and a
map $\alpha : E^\bullet \to K^\bullet$ which is an isomorphism on
cohomology in degrees $> m$ and a surjection in degree $m$.
Consider the induced map of complexes
$$
\alpha \otimes 1 : E^\bullet \otimes_A B \to K^\bullet.
$$
Note that $C(\alpha \otimes 1)^\bullet$ is acyclic in degrees
$\geq n$ as $H^n(E) \to H^n(E^\bullet \otimes_A B) \to H^n(K^\bullet)$
is surjective by construction and since $H^i(E^\bullet \otimes_A B) = 0$
for $i > n$ by the spectral sequence of
Example \ref{example-tor}.
On the other hand, $C(\alpha \otimes 1)^\bullet$
is $m$-pseudo-coherent as a complex of $A$-modules because
both $K^\bullet$ and $E^\bullet \otimes_A B$ (see
Lemma \ref{lemma-complex-pseudo-coherent-modules})
are so, see
Lemma \ref{lemma-cone-pseudo-coherent}.
Hence by induction we see that $C(\alpha \otimes 1)^\bullet$
is $m$-pseudo-coherent as a complex of $B$-modules. Finally
another application of
Lemma \ref{lemma-cone-pseudo-coherent}
shows that $K^\bullet$ is $m$-pseudo-coherent as a complex of $B$-modules
(as clearly $E^\bullet \otimes_A B$ is pseudo-coherent as a complex
of $B$-modules). The pseudo-coherent case
of (2) $\Rightarrow$ (1) follows from this and
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-pull-pseudo-coherent}
Let $A \to B$ be a ring map.
Let $K^\bullet$ be an $m$-pseudo-coherent (resp.\ pseudo-coherent)
complex of $A$-modules. Then $K^\bullet \otimes_A^{\mathbf{L}} B$
is an $m$-pseudo-coherent (resp.\ pseudo-coherent) complex of $B$-modules.
\end{lemma}

\begin{proof}
First we note that the statement of the lemma makes sense as
$K^\bullet$ is bounded above and hence $K^\bullet \otimes_A^{\mathbf{L}} B$
is defined by Equation (\ref{equation-derived-tensor-algebra}).
Having said this, choose a bounded complex $E^\bullet$
of finite free $A$-modules and $\alpha : E^\bullet \to K^\bullet$
with $H^i(\alpha)$ an isomorphism for $i > m$ and surjective for
$i = m$. Then the cone $C(\alpha)^\bullet$ is acyclic in degrees
$\geq m$. Since $-\otimes_A^{\mathbf{L}} B$ is an exact functor
we get a distinguished triangle
$$
(E^\bullet \otimes_A^{\mathbf{L}} B, K^\bullet \otimes_A^{\mathbf{L}} B,
C(\alpha)^\bullet \otimes_A^{\mathbf{L}} B)
$$
of complexes of $B$-modules. By the dual to
Derived Categories, Lemma \ref{derived-lemma-negative-vanishing}
we see that $H^i(C(\alpha)^\bullet \otimes_A^{\mathbf{L}} B) = 0$
for $i \geq m$. Since $E^\bullet$ is a complex of projective $R$-modules
we see that $E^\bullet \otimes_A^{\mathbf{L}} B = E^\bullet \otimes_A B$
and hence
$$
E^\bullet \otimes_A B
\longrightarrow
K^\bullet \otimes_A^{\mathbf{L}} B
$$
is a morphism of complexes of $B$-modules that witnesses the
fact that $K^\bullet \otimes_A^{\mathbf{L}} B$ is $m$-pseudo-coherent.
The case of pseudo-coherent complexes follows from the case
of $m$-pseudo-coherent complexes via
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change-pseudo-coherent}
Let $A \to B$ be a flat ring map.
Let $M$ be an $m$-pseudo-coherent (resp.\ pseudo-coherent)
$A$-module. Then $M \otimes_A B$
is an $m$-pseudo-coherent (resp.\ pseudo-coherent) $B$-module.
\end{lemma}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-pull-pseudo-coherent}
and the fact that $M \otimes_A^{\mathbf{L}} B = M \otimes_A B$
because $B$ is flat over $A$.
\end{proof}

\noindent
The following lemma also follows from the stronger
Lemma \ref{lemma-glue-pseudo-coherent}.

\begin{lemma}
\label{lemma-glue-pseudo-coherent}
Let $R$ be a ring. Let $f_1, \ldots, f_r \in R$ be elements which
generate the unit ideal. Let $m \in \mathbf{Z}$. Let $K^\bullet$
be a complex of $R$-modules. If for each $i$ the complex
$K^\bullet \otimes_R R_{f_i}$ is $m$-pseudo-coherent
(resp.\ pseudo-coherent), then $K^\bullet$ is $m$-pseudo-coherent
(resp.\ pseudo-coherent).
\end{lemma}

\begin{proof}
We will use without further mention that $- \otimes_R R_{f_i}$ is
an exact functor and that therefore
$$
H^i(K^\bullet)_{f_i} =
H^i(K^\bullet) \otimes_R R_{f_i} = H^i(K^\bullet \otimes_R R_{f_i}).
$$
Assume $K^\bullet \otimes_R R_{f_i}$ is $m$-pseudo-coherent
for $i = 1, \ldots, r$. Let $n \in \mathbf{Z}$ be the largest
integer such that $H^n(K^\bullet \otimes_R R_{f_i})$ is nonzero
for some $i$. This implies in particular that $H^i(K^\bullet) = 0$
for $i > n$ (and that $H^n(K^\bullet) \not = 0$) see
Algebra, Lemma \ref{algebra-lemma-cover}.
We will prove the lemma by induction on $n - m$.
If $n < m$, then the lemma is true by
Lemma \ref{lemma-recognize-pseudo-coherent}.
If $n \geq m$, then $H^n(K^\bullet)_{f_i}$ is a finite $R_{f_i}$-module
for each $i$, see
Lemma \ref{lemma-finite-cohomology}.
Hence $H^n(K^\bullet)$ is a finite $R$-module, see
Algebra, Lemma \ref{algebra-lemma-cover}.
Choose a finite free $R$-module $E$ and a surjection $E \to H^n(K^\bullet)$.
As $E$ is projective we can lift this to a map of complexes
$\alpha : E[-n] \to K^\bullet$. Then the cone $C(\alpha)^\bullet$ has
vanishing cohomology in degrees $\geq n$. On the other hand, the
complexes $C(\alpha)^\bullet \otimes_R R_{f_i}$ are $m$-pseudo-coherent
for each $i$, see
Lemma \ref{lemma-cone-pseudo-coherent}.
Hence by induction we see that $C(\alpha)^\bullet$ is $m$-pseudo-coherent
as a complex of $R$-modules. Applying
Lemma \ref{lemma-cone-pseudo-coherent}
once more we conclude.
\end{proof}

\begin{lemma}
\label{lemma-flat-descent-pseudo-coherent}
Let $R$ be a ring. Let $m \in \mathbf{Z}$. Let $K^\bullet$
be a complex of $R$-modules. Let $R \to R'$ be a faithfully flat
ring map. If the complex $K^\bullet \otimes_R R'$ is $m$-pseudo-coherent
(resp.\ pseudo-coherent), then $K^\bullet$ is $m$-pseudo-coherent
(resp.\ pseudo-coherent).
\end{lemma}

\begin{proof}
We will use without further mention that $- \otimes_R R'$ is
an exact functor and that therefore
$$
H^i(K^\bullet) \otimes_R R' = H^i(K^\bullet \otimes_R R').
$$
Assume $K^\bullet \otimes_R R'$ is $m$-pseudo-coherent.
Let $n \in \mathbf{Z}$ be the largest integer such that
$H^n(K^\bullet)$ is nonzero; then $n$ is also the largest integer
such that $H^n(K^\bullet \otimes_R R')$ is nonzero.
We will prove the lemma by induction on $n - m$.
If $n < m$, then the lemma is true by
Lemma \ref{lemma-recognize-pseudo-coherent}.
If $n \geq m$, then $H^n(K^\bullet) \otimes_R R'$ is a finite
$R'$-module, see
Lemma \ref{lemma-finite-cohomology}.
Hence $H^n(K^\bullet)$ is a finite $R$-module, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
Choose a finite free $R$-module $E$ and a surjection $E \to H^n(K^\bullet)$.
As $E$ is projective we can lift this to a map of complexes
$\alpha : E[-n] \to K^\bullet$. Then the cone $C(\alpha)^\bullet$ has
vanishing cohomology in degrees $\geq n$. On the other hand, the
complex $C(\alpha)^\bullet \otimes_R R'$ is $m$-pseudo-coherent, see
Lemma \ref{lemma-cone-pseudo-coherent}.
Hence by induction we see that $C(\alpha)^\bullet$ is $m$-pseudo-coherent
as a complex of $R$-modules. Applying
Lemma \ref{lemma-cone-pseudo-coherent}
once more we conclude.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-pseudo-coherent}
Let $R$ be a Noetherian ring. Then
\begin{enumerate}
\item A complex of $R$-modules $K^\bullet$ is $m$-pseudo-coherent
if and only if $K^\bullet \in D^{-}(R)$ and
$H^i(K^\bullet)$ is a finite $R$-module for $i \geq m$.
\item A complex of $R$-modules $K^\bullet$ is pseudo-coherent
if and only if $K^\bullet \in D^{-}(R)$ and
$H^i(K^\bullet)$ is a finite $R$-module for all $i$.
\item An $R$-module is pseudo-coherent if and only if it is finite.
\end{enumerate}
\end{lemma}

\begin{proof}
In
Algebra, Lemma \ref{algebra-lemma-resolution-by-finite-free}
we have seen that any finite $R$-module is pseudo-coherent.
On the other hand, a pseudo-coherent module is finite, see
Lemma \ref{lemma-n-pseudo-module}.
Hence (3) holds. Suppose that $K^\bullet$ is an $m$-pseudo-coherent complex.
Then there exists a bounded complex of finite free $R$-modules $E^\bullet$
such that $H^i(K^\bullet)$ is isomorphic to $H^i(E^\bullet)$ for
$i > m$ and such that $H^m(K^\bullet)$ is a quotient of $H^m(E^\bullet)$.
Thus it is clear that each $H^i(K^\bullet)$, $i \geq m$ is a finite module.
The converse implication in (1) follows from
Lemma \ref{lemma-cohomology-pseudo-coherent}
and part (3).
Part (2) follows from (1) and
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{remark}
\label{remark-pseudo-coherence-and-ext}
Let $R$ be ring map. Let $L$, $M$, $N$ be $R$-modules.
Consider the canonical map
$$
\Hom_R(M, N) \otimes_R L \to \Hom_R(M, N \otimes_R L)
$$
Choose a two term free resolution $F_1 \to F_0 \to M \to 0$.
Assuming $L$ flat over $R$ we obtain a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\Hom_R(M, N) \otimes_R L \ar[r] \ar[d] &
\Hom_R(F_0, N) \otimes_R L \ar[r] \ar[d] &
\Hom_R(F_1, N) \otimes_R L \ar[d] \\
0 \ar[r] &
\Hom_R(M, N \otimes_R L) \ar[r] &
\Hom_R(F_0, N \otimes_R L) \ar[r] &
\Hom_R(F_1, N \otimes_R L)
}
$$
with exact rows. We conclude that if $F_0$ and $F_1$ are finite
free, i.e., if $M$ is finitely presented, then the first displayed
map is an isomorphism. Similarly, if $M$ is $(-m)$-pseudo-coherent
and still assuming $L$ is flat over $R$, then the map
$$
\text{Ext}^i_R(M, N) \otimes_R L \to \text{Ext}^i_R(M, N \otimes_R L)
$$
is an isomorphism for $i < m$.
\end{remark}

\begin{remark}
\label{remark-pseudo-coherence-and-base-change-ext}
Let $R$ be ring map. Let $M$, $N$ be $R$-modules.
Let $R \to R'$ be a flat ring map. By
Algebra, Lemma \ref{algebra-lemma-flat-base-change-ext}
we have
$\text{Ext}^i_{R'}(M \otimes_R R', N \otimes_R R') =
\text{Ext}^i_R(M, N \otimes_R R')$.
Combined with Remark \ref{remark-pseudo-coherence-and-ext}
we conclude that
$$
\Hom_R(M, N) \otimes_R R' = \Hom_{R'}(M \otimes_R R', N \otimes_R R')
$$
if $M$ is a finitely presented $R$-module and that
$$
\text{Ext}^i_R(M, N) \otimes_R R' =
\text{Ext}^i_{R'}(M \otimes_R R', N \otimes_R R')
$$
is an isomorphism for $i < m$ if $M$ is $(-m)$-pseudo-coherent.
In particular if $R$ is Noetherian and $M$ is a finite module this
holds for all $i$.
\end{remark}







\section{Tor dimension}
\label{section-tor}

\noindent
Instead of resolving by projective modules we can look
at resolutions by flat modules. This leads to the following
concept.

\begin{definition}
\label{definition-tor-amplitude}
Let $R$ be a ring. Denote $D(R)$ its derived category.
Let $a, b \in \mathbf{Z}$.
\begin{enumerate}
\item An object $K^\bullet$ of $D(R)$ has
{\it tor-amplitude in $[a, b]$}
if $H^i(K^\bullet \otimes_R^\mathbf{L} M) = 0$ for all $R$-modules
$M$ and all $i \not \in [a, b]$.
\item An object $K^\bullet$ of $D(R)$ has {\it finite tor dimension}
if it has tor-amplitude in $[a, b]$ for some $a, b$.
\item An $R$-module $M$ has {\it tor dimension $\leq d$} if
if $M[0]$ as an object of $D(R)$ has tor-amplitude in $[-d, 0]$.
\item An $R$-module $M$ has {\it finite tor dimension}
if $M[0]$ as an object of $D(R)$ has finite tor dimension.
\end{enumerate}
\end{definition}

\noindent
We observe that if $K^\bullet$ has finite tor dimension,
then $K^\bullet \in D^b(R)$.

\begin{lemma}
\label{lemma-last-one-flat}
Let $R$ be a ring. Let $K^\bullet$ be a bounded above complex of
flat $R$-modules with tor-amplitude in $[a, b]$.
Then $\text{Coker}(d_K^{a - 1})$ is a flat $R$-module.
\end{lemma}

\begin{proof}
As $K^\bullet$ is a bounded above complex of flat modules we see
that $K^\bullet \otimes_R M = K^\bullet \otimes_R^{\mathbf{L}} M$.
Hence for every $R$-module $M$ the sequence
$$
K^{a - 2} \otimes_R M \to K^{a - 1} \otimes_R M \to K^a \otimes_R M
$$
is exact in the middle. Since
$K^{a - 2} \to K^{a - 1} \to K^a \to \text{Coker}(d_K^{a - 1}) \to 0$
is a flat resolution this implies that
$\text{Tor}_1^R(\text{Coker}(d_K^{a - 1}), M) = 0$
for all $R$-modules $M$. This means that
$\text{Coker}(d_K^{a - 1})$ is flat, see
Algebra, Lemma \ref{algebra-lemma-characterize-flat}.
\end{proof}

\begin{lemma}
\label{lemma-tor-amplitude}
Let $R$ be a ring. Let $K^\bullet$ be an object of $D(R)$.
Let $a, b \in \mathbf{Z}$. The following are equivalent
\begin{enumerate}
\item $K^\bullet$ has tor-amplitude in $[a, b]$.
\item $K^\bullet$ is quasi-isomorphic to a complex
$E^\bullet$ of flat $R$-modules with $E^i = 0$ for $i \not \in [a, b]$.
\end{enumerate}
\end{lemma}

\begin{proof}
If (2) holds, then we may compute
$K^\bullet \otimes_R^\mathbf{L} M = E^\bullet \otimes_R M$
and it is clear that (1) holds.
Assume that (1) holds. We may replace $K^\bullet$ by
a projective resolution.
Let $n$ be the largest integer such that $K^n \not = 0$.
If $n > b$, then $K^{n - 1} \to K^n$ is surjective as
$H^n(K^\bullet) = 0$. As $K^n$ is projective we see that
$K^{n - 1} = K' \oplus K^n$. Hence it suffices to prove the result
for the complex $(K')^\bullet$ which is the same as $K^\bullet$
except has $K'$ in degree $n - 1$ and $0$ in degree $n$.
Thus, by induction on $n$, we reduce to the case that $K^\bullet$
is a complex of projective $R$-modules with $K^i = 0$ for $i > b$.

\medskip\noindent
Set $E^\bullet = \tau_{\geq a}K^\bullet$. Everything is clear except
that $E^a$ is flat which follows immediately from
Lemma \ref{lemma-last-one-flat}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-cone-tor-amplitude}
Let $R$ be a ring.
Let $(K^\bullet, L^\bullet, M^\bullet, f, g, h)$ be a distinguished
triangle in $D(R)$. Let $a, b \in \mathbf{Z}$.
\begin{enumerate}
\item If $K^\bullet$ has tor-amplitude in $[a + 1, b + 1]$ and
$L^\bullet$ has tor-amplitude in $[a, b]$ then $M^\bullet$ has
tor-amplitude in $[a, b]$.
\item If $K^\bullet, M^\bullet$ have tor-amplitude in $[a, b]$, then
$L^\bullet$ has tor-amplitude in $[a, b]$.
\item If $L^\bullet$ has tor-amplitude in $[a + 1, b + 1]$
and $M^\bullet$ has tor-amplitude in $[a, b]$, then
$K^\bullet$ has tor-amplitude in $[a + 1, b + 1]$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: This just follows from the long exact cohomology sequence
associated to a distinguished triangle and the fact that
$- \otimes_R^{\mathbf{L}} M$ preserves distinguished triangles.
The easiest one to prove is (2) and the others follow from it by
translation.
\end{proof}

\begin{lemma}
\label{lemma-tor-dimension}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $d \geq 0$. The following are equivalent
\begin{enumerate}
\item $M$ has tor dimension $\leq d$, and
\item there exists a resolution
$$
0 \to F_d \to \ldots \to F_1 \to F_0 \to M \to 0
$$
with $F_i$ a flat $R$-module.
\end{enumerate}
In particular an $R$-module has tor dimension $0$ if and only if
it is a flat $R$-module.
\end{lemma}

\begin{proof}
Assume (2). Then the complex $E^\bullet$ with $E^{-i} = F_i$
is quasi-isomorphic to $M$. Hence the Tor dimension of $M$ is
at most $d$ by
Lemma \ref{lemma-tor-amplitude}.
Conversely, assume (1). Let $P^\bullet \to M$ be a projective
resolution of $M$. By
Lemma \ref{lemma-last-one-flat}
we see that $\tau_{\geq -d}P^\bullet$ is a flat resolution of
$M$ of length $d$, i.e., (2) holds.
\end{proof}

\begin{lemma}
\label{lemma-summands-tor-amplitude}
Let $R$ be a ring. Let $a, b \in \mathbf{Z}$.
If $K^\bullet \oplus L^\bullet$ has tor amplitude in $[a, b]$
so do $K^\bullet$ and $L^\bullet$.
\end{lemma}

\begin{proof}
Clear from the fact that the Tor functors are additive.
\end{proof}

\begin{lemma}
\label{lemma-complex-finite-tor-dimension-modules}
Let $R$ be a ring. Let $K^\bullet$ be a bounded complex of $R$-modules
such that $K^i$ has tor amplitude in $[a - i, b - i]$ for all $i$.
Then $K^\bullet$ has tor amplitude in $[a, b]$. In particular
if $K^\bullet$ is a finite complex of $R$-modules of finite tor dimension,
then $K^\bullet$ has finite tor dimension.
\end{lemma}

\begin{proof}
Follows by induction on the length of the finite complex: use
Lemma \ref{lemma-cone-tor-amplitude}
and the stupid truncations.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-tor-amplitude}
Let $R$ be a ring. Let $a, b \in \mathbf{Z}$. Let $K^\bullet \in D^b(R)$
such that $H^i(K^\bullet)$ has tor amplitude in $[a - i, b - i]$
for all $i$. Then $K^\bullet$ has tor amplitude in $[a, b]$. In particular
if $K^\bullet \in D^{-}(R)$ and all its cohomology groups have finite tor
dimension then $K^\bullet$ has finite tor dimension.
\end{lemma}

\begin{proof}
Follows by induction on the length of the finite complex: use
Lemma \ref{lemma-cone-tor-amplitude}
and the canonical truncations.
\end{proof}

\begin{lemma}
\label{lemma-flat-push-tor-amplitude}
Let $A \to B$ be a ring map. Assume that $B$ is flat as an
$A$-module. Let $K^\bullet$ be a complex of $B$-modules.
Let $a, b \in \mathbf{Z}$. If $K^\bullet$ as a complex of $B$-modules
has tor amplitude in $[a, b]$, then $K^\bullet$ as a complex of
$A$-modules has tor amplitude in $[a, b]$.
\end{lemma}

\begin{proof}
This is true because
$K^\bullet \otimes_A^{\mathbf{L}} M =
K^\bullet \otimes_B^{\mathbf{L}} (M \otimes_A B)$
since any projective resolution of $K^\bullet$ as a complex of $B$-modules
is a flat resolution of $K^\bullet$ as a complex of $A$-modules and
can be used to compute $K^\bullet \otimes_A^{\mathbf{L}} M$.
\end{proof}

\begin{lemma}
\label{lemma-finite-tor-dimension-push-tor-amplitude}
Let $A \to B$ be a ring map. Assume that $B$ has tor dimension $\leq d$
as an $A$-module. Let $K^\bullet$ be a complex of $B$-modules.
Let $a, b \in \mathbf{Z}$. If $K^\bullet$ as a complex of $B$-modules
has tor amplitude in $[a, b]$, then $K^\bullet$ as a complex of
$A$-modules has tor amplitude in $[a - d, b]$.
\end{lemma}

\begin{proof}
Let $M$ be an $A$-module. Choose a free resolution $F^\bullet \to M$.
Then
$$
K^\bullet \otimes_A^{\mathbf{L}} M =
\text{Tot}(K^\bullet \otimes_A F^\bullet) =
\text{Tot}(K^\bullet \otimes_B (F^\bullet \otimes_A B)) =
K^\bullet \otimes_B^{\mathbf{L}} (M \otimes_A^{\mathbf{L}} B).
$$
By our assumption on $B$ as an $A$-module we see that
$M \otimes_A^{\mathbf{L}} B$ has cohomology only in degrees
$-d, -d + 1, \ldots, 0$. Because $K^\bullet$ has tor amplitude in
$[a, b]$ we see from the spectral sequence in
Example \ref{example-tor}
that $K^\bullet \otimes_B^{\mathbf{L}} (M \otimes_A^{\mathbf{L}} B)$
has cohomology only in degrees $[-d + a, b]$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-pull-tor-amplitude}
Let $A \to B$ be a ring map.
Let $a, b \in \mathbf{Z}$.
Let $K^\bullet$ be a complex of $A$-modules with tor amplitude in $[a, b]$.
Then $K^\bullet \otimes_A^{\mathbf{L}} B$ as a complex of $B$-modules
has tor amplitude in $[a, b]$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-tor-amplitude}
we can find a quasi-isomorphism $E^\bullet \to K^\bullet$ where
$E^\bullet$ is a complex of flat $A$-modules with $E^i = 0$ for
$i \not \in [a, b]$. Then $E^\bullet \otimes_A B$ computes
$K^\bullet \otimes_A ^{\mathbf{L}} B$ by construction and
each $E^i \otimes_A B$ is a flat $B$-module by
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Hence we conclude by
Lemma \ref{lemma-tor-amplitude}.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change-finite-tor-dimension}
Let $A \to B$ be a flat ring map. Let $d \geq 0$.
Let $M$ be an $A$-module of tor dimension $\leq d$.
Then $M \otimes_A B$ is a $B$-module of tor dimension $\leq d$.
\end{lemma}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-pull-tor-amplitude}
and the fact that $M \otimes_A^{\mathbf{L}} B = M \otimes_A B$
because $B$ is flat over $A$.
\end{proof}

\begin{lemma}
\label{lemma-glue-tor-amplitude}
Let $R$ be a ring. Let $f_1, \ldots, f_r \in R$ be elements which
generate the unit ideal. Let $a, b \in \mathbf{Z}$. Let $K^\bullet$
be a complex of $R$-modules. If for each $i$ the complex
$K^\bullet \otimes_R R_{f_i}$ has tor amplitude in $[a, b]$,
then $K^\bullet$ has tor amplitude in $[a, b]$.
\end{lemma}

\begin{proof}
Note that $- \otimes_R R_{f_i}$ is an exact functor and that therefore
$$
H^i(K^\bullet)_{f_i} =
H^i(K^\bullet) \otimes_R R_{f_i} = H^i(K^\bullet \otimes_R R_{f_i}).
$$
and similarly for every $R$-module $M$ we have
$$
H^i(K^\bullet \otimes_R^{\mathbf{L}} M)_{f_i} =
H^i(K^\bullet \otimes_R^{\mathbf{L}} M) \otimes_R R_{f_i} =
H^i(K^\bullet \otimes_R R_{f_i} \otimes_{R_{f_i}}^{\mathbf{L}} M_{f_i}).
$$
Hence the result follows from the fact that an $R$-module $N$
is zero if and only if $N_{f_i}$ is zero for each $i$, see
Algebra, Lemma \ref{algebra-lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-flat-descent-tor-amplitude}
Let $R$ be a ring. Let $a, b \in \mathbf{Z}$. Let $K^\bullet$
be a complex of $R$-modules. Let $R \to R'$ be a faithfully flat
ring map. If the complex $K^\bullet \otimes_R R'$ has tor amplitude
in $[a, b]$, then $K^\bullet$ has tor amplitude in $[a, b]$.
\end{lemma}

\begin{proof}
Let $M$ be an $R$-module. Since $R \to R'$ is flat we see that
$$
(M \otimes_R^{\mathbf{L}} K^\bullet) \otimes_R R'
=
((M \otimes_R R') \otimes_{R'}^{\mathbf{L}} (K^\bullet \otimes_R R')
$$
and taking cohomology commutes with tensoring with $R'$.
Hence $\text{Tor}_i^R(M, K^\bullet) =
\text{Tor}_i^{R'}(M \otimes_R R', K^\bullet \otimes_R R')$.
Since $R \to R'$ is faithfully flat, the vanishing of
$\text{Tor}_i^{R'}(M \otimes_R R', K^\bullet \otimes_R R')$ for
$i \not \in [a, b]$ implies the same thing for
$\text{Tor}_i^R(M, K^\bullet)$.
\end{proof}

\begin{lemma}
\label{lemma-finite-gl-dim-tor-dimension}
Let $R$ be a ring of finite global dimension $d$. Then
\begin{enumerate}
\item every module has finite tor dimension $\leq d$,
\item a complex of $R$-modules $K^\bullet$ with $H^i(K^\bullet) \not = 0$
only if $i \in [a, b]$ has tor amplitude in $[a - d, b]$, and
\item a complex of $R$-modules $K^\bullet$ has finite tor dimension if and only
if $K^\bullet \in D^b(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The assumption on $R$ means that every module has a finite projective
resolution of length at most $d$, in particular every module has finite
tor dimension. The second statement follows from
Lemma \ref{lemma-cohomology-tor-amplitude}
and the definitions. The third statement is a rephrasing of the second.
\end{proof}















\section{Perfect complexes}
\label{section-perfect}

\noindent
A perfect complex is a pseudo-coherent complex of finite tor dimension.
But we can also define the directly as follows.

\begin{definition}
\label{definition-perfect}
Let $R$ be a ring. Denote $D(R)$ the derived category of the abelian
category of $R$-modules.
\begin{enumerate}
\item An object $K$ of $D(R)$ is {\it perfect} if it is quasi-isomorphic
to a bounded complex of finite projective $R$-modules.
\item An $R$-module $M$ is {\it perfect} if $M[0]$ is a perfect object
in $D(R)$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-perfect}
Let $K^\bullet$ be an object of $D(R)$. The following are equivalent
\begin{enumerate}
\item $K^\bullet$ is perfect, and
\item $K^\bullet$ is pseudo-coherent and has finite tor dimension.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2), see
Lemmas \ref{lemma-pseudo-coherent} and \ref{lemma-tor-amplitude}.
Assume (2). Choose a bounded above complex $F^\bullet$
of finite free $R$-modules and a quasi-isomorphism $F^\bullet \to K^\bullet$.
Assume that $K^\bullet$ has tor-amplitude in $[a, b]$.
Set $E^\bullet = \tau_{\geq a}F^\bullet$. Note that $E^i$ is finite free
except $E^a$ which is a finitely presented $R$-module.
By
Lemma \ref{lemma-last-one-flat}
$E^a$ is flat. Hence by
Algebra, Lemma \ref{algebra-lemma-finite-projective}
we see that $E^a$ is finite projective.
\end{proof}

\begin{lemma}
\label{lemma-perfect-module}
Let $M$ be a module over a ring $R$. The following are equivalent
\begin{enumerate}
\item $M$ is a perfect module, and
\item there exists a resolution
$$
0 \to F_d \to \ldots \to F_1 \to F_0 \to M \to 0
$$
with each $F_i$ a finite projective $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (2). Then the complex $E^\bullet$ with $E^{-i} = F_i$
is quasi-isomorphic to $M[0]$. Hence $M$ is perfect.
Conversely, assume (1). By
Lemmas \ref{lemma-perfect} and \ref{lemma-n-pseudo-module}
we can find resolution $E^\bullet \to M$ with $E^{-i}$ a finite free
$R$-module. By
Lemma \ref{lemma-last-one-flat}
we see that $F_d = \text{Coker}(E^{d - 1} \to E^d)$ is flat for
some $d$ sufficiently large. By
Algebra, Lemma \ref{algebra-lemma-finite-projective}
we see that $F_d$ is finite projective.
Hence
$$
0 \to F_d \to E^{-d+1} \to \ldots \to E^0 \to M \to 0
$$
is the desired resolution.
\end{proof}

\begin{lemma}
\label{lemma-two-out-of-three-perfect}
Let $R$ be a ring. Let $(K^\bullet, L^\bullet, M^\bullet, f, g, h)$
be a distinguished triangle in $D(R)$. If two out of three of
$K^\bullet, L^\bullet, M^\bullet$ are
perfect then the third is also perfect.
\end{lemma}

\begin{proof}
Combine
Lemmas \ref{lemma-perfect}, \ref{lemma-two-out-of-three-pseudo-coherent}, and
\ref{lemma-cone-tor-amplitude}.
\end{proof}

\begin{lemma}
\label{lemma-summands-perfect}
Let $R$ be a ring. If $K^\bullet \oplus L^\bullet$ is perfect, then
so are $K^\bullet$ and $L^\bullet$.
\end{lemma}

\begin{proof}
Follows from
Lemmas \ref{lemma-perfect}, \ref{lemma-summands-pseudo-coherent}, and
\ref{lemma-summands-tor-amplitude}.
\end{proof}

\begin{lemma}
\label{lemma-complex-perfect-modules}
Let $R$ be a ring. Let $K^\bullet$ be a bounded complex of perfect
$R$-modules. Then $K^\bullet$ is a perfect complex.
\end{lemma}

\begin{proof}
Follows by induction on the length of the finite complex: use
Lemma \ref{lemma-two-out-of-three-perfect}
and the stupid truncations.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-perfect}
Let $R$ be a ring. If $K^\bullet \in D^b(R)$ and all its cohomology
modules are perfect, then $K^\bullet$ is perfect.
\end{lemma}

\begin{proof}
Follows by induction on the length of the finite complex: use
Lemma \ref{lemma-two-out-of-three-perfect}
and the canonical truncations.
\end{proof}

\begin{lemma}
\label{lemma-perfect-push-perfect}
Let $A \to B$ be a ring map. Assume that $B$ is perfect as
an $A$-module. Let $K^\bullet$ be a perfect complex of $B$-modules.
Then $K^\bullet$ is perfect as a complex of $A$-modules.
\end{lemma}

\begin{proof}
Using
Lemma \ref{lemma-perfect}
this translates into the corresponding results for pseudo-coherent modules
and modules of finite tor dimension. See
Lemma \ref{lemma-finite-tor-dimension-push-tor-amplitude}
and
Lemma \ref{lemma-finite-push-pseudo-coherent}
for those results.
\end{proof}

\begin{lemma}
\label{lemma-pull-perfect}
Let $A \to B$ be a ring map.
Let $K^\bullet$ be a perfect
complex of $A$-modules. Then $K^\bullet \otimes_A^{\mathbf{L}} B$
is a perfect complex of $B$-modules.
\end{lemma}

\begin{proof}
Using
Lemma \ref{lemma-perfect}
this translates into the corresponding results for pseudo-coherent modules
and modules of finite tor dimension. See
Lemma \ref{lemma-pull-tor-amplitude}
and
Lemma \ref{lemma-pull-pseudo-coherent}
for those results.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change-perfect}
Let $A \to B$ be a flat ring map. Let $M$ be a perfect $A$-module.
Then $M \otimes_A B$ is a perfect $B$-module.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-perfect-module}
the assumption implies that $M$ has a finite resolution $F_\bullet$ by
finite projective $R$-modules. As $A \to B$ is flat the complex
$F_\bullet \otimes_A B$ is a finite length resolution of $M \otimes_A B$
by finite projective modules over $B$. Hence $M \otimes_A B$ is perfect.
\end{proof}

\begin{lemma}
\label{lemma-glue-perfect}
Let $R$ be a ring. Let $f_1, \ldots, f_r \in R$ be elements which
generate the unit ideal. Let $K^\bullet$
be a complex of $R$-modules. If for each $i$ the complex
$K^\bullet \otimes_R R_{f_i}$ is perfect,
then $K^\bullet$ is perfect.
\end{lemma}

\begin{proof}
Using
Lemma \ref{lemma-perfect}
this translates into the corresponding results for pseudo-coherent modules
and modules of finite tor dimension. See
Lemma \ref{lemma-glue-tor-amplitude}
and
Lemma \ref{lemma-glue-pseudo-coherent}
for those results.
\end{proof}

\begin{lemma}
\label{lemma-flat-descent-perfect}
Let $R$ be a ring. Let $a, b \in \mathbf{Z}$. Let $K^\bullet$
be a complex of $R$-modules. Let $R \to R'$ be a faithfully flat
ring map. If the complex $K^\bullet \otimes_R R'$ has tor amplitude
in $[a, b]$, then $K^\bullet$ has tor amplitude in $[a, b]$.
\end{lemma}

\begin{proof}
Using
Lemma \ref{lemma-perfect}
this translates into the corresponding results for pseudo-coherent modules
and modules of finite tor dimension. See
Lemma \ref{lemma-flat-descent-tor-amplitude}
and
Lemma \ref{lemma-flat-descent-pseudo-coherent}
for those results.
\end{proof}

\begin{lemma}
\label{lemma-regular-perfect}
Let $R$ be a regular ring of finite dimension. Then
\begin{enumerate}
\item an $R$-module is perfect if and only if it is a finite $R$-module, and
\item a complex of $R$-modules $K^\bullet$ is perfect if and only
if $K^\bullet \in D^b(R)$ and each $H^i(K^\bullet)$ is a finite $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-finite-gl-dim-finite-dim-regular}
the assumption on $R$ means that $R$ has finite global dimension.
Hence every module has finite tor dimension, see
Lemma \ref{lemma-finite-gl-dim-tor-dimension}.
On the other hand, as $R$ is Noetherian, a module is pseudo-coherent
if and only if it is finite, see
Lemma \ref{lemma-Noetherian-pseudo-coherent}.
This proves part (1).

\medskip\noindent
Let $K^\bullet$ be a complex of $R$-modules.
If $K^\bullet$ is perfect, then it is in $D^b(R)$ and it is
quasi-isomorphic to a finite complex of finite projective $R$-modules
so certainly each $H^i(K^\bullet)$ is a finite $R$-module (as $R$ is
Noetherian). Conversely, suppose that $K^\bullet$ is in $D^b(R)$
and each $H^i(K^\bullet)$ is a finite $R$-module. Then by (1) each
$H^i(K^\bullet)$ is a perfect $R$-module, whence $K^\bullet$ is
perfect by
Lemma \ref{lemma-cohomology-perfect}
\end{proof}

\begin{lemma}
\label{lemma-cut-complex-in-two}
Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime ideal.
Let $i \in \mathbf{Z}$. Let $K^\bullet$ be a pseudo-coherent complex
of $R$-modules such that
$H^i(K^\bullet \otimes_R^{\mathbf{L}} \kappa(\mathfrak p)) = 0$.
Then there exists an $f \in R$, $f \not \in \mathfrak p$ such that
$$
K^\bullet \otimes_R R_f =
\tau_{\geq i + 1}K^\bullet \otimes_R R_f \oplus
\tau_{\leq i - 1}K^\bullet \otimes_R R_f
$$
in $D(R_f)$ with $\tau_{\geq i + 1}K^\bullet \otimes_R R_f$ a perfect
complex with tor amplitude in $[i + 1, j]$ for some $j \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
We may assume that $K^\bullet$ is a bounded above
complex of finite free $R$-modules. Let us inspect what is happening
in degree $i$:
$$
\ldots \to K^{i - 2} \to R^{\oplus l}
\to R^{\oplus m} \to R^{\oplus n} \to K^{i + 2} \to \ldots
$$
Let $A$ be the $m \times l$ matrix corresponding to $K^{i - 1} \to K^i$
and let $B$ be the $n \times m$ matrix corresponding to $K^i \to K^{i + 1}$.
The assumption is that $A \bmod \mathfrak p$ has rank $r$ and that
$B \bmod \mathfrak p$ has rank $m - r$. In other words, there is some
$r \times r$ minor $a$ of $A$ which is not in $\mathfrak p$ and there is
some $(m - r) \times (m - r)$-minor $b$ of $B$ which is not in $\mathfrak p$.
Set $f = ab$. Then after inverting $f$ we can find direct sum decompositions
$K^{i - 1} = R^{\oplus l - r} \oplus R^{\oplus r}$,
$K^i = R^{\oplus r} \oplus R^{\oplus m - r}$,
$K^{i + 1} = R^{\oplus m - r} \oplus R^{\oplus n - m + r}$
such that the module map $K^{i - 1} \to K^i$ kills of
$R^{\oplus l - r}$ and induces an isomorphism of $R^{\oplus r}$ onto the
corresponding summand of $K^i$ and such that the module map $K^i \to K^{i + 1}$
kills of $R^{\oplus r}$ and induces an isomorphism of $R^{\oplus m - r}$
onto the corresponding summand of $K^{i + 1}$. Thus $K^\bullet$ becomes
quasi-isomorphic to
$$
\ldots \to K^{i - 2} \to R^{\oplus l - r}
\to 0 \to R^{\oplus n - m + r} \to K^{i + 2} \to \ldots
$$
and everything is clear.
\end{proof}

\begin{lemma}
\label{lemma-check-perfect-pointwise}
Let $R$ be a ring. Let $a, b \in \mathbf{Z}$.
Let $K^\bullet$ be a pseudo-coherent complex of $R$-modules.
The following are equivalent
\begin{enumerate}
\item $K^\bullet$ is perfect with tor amplitude in $[a, b]$,
\item for every prime $\mathfrak p$ we have
$H^i(K^\bullet \otimes_R^{\mathbf{L}} \kappa(\mathfrak p)) = 0$ for all
$i \not \in [a, b]$, and
\item for every maximal ideal $\mathfrak m$ we have
$H^i(K^\bullet \otimes_R^{\mathbf{L}} \kappa(\mathfrak m)) = 0$ for all
$i \not \in [a, b]$.
\end{enumerate}
\end{lemma}

\begin{proof}
We omit the proof of the implications (1) $\Rightarrow$ (2) $\Rightarrow$ (3).
Assume (3). Let $i \in \mathbf{Z}$ with $i \not \in [a, b]$. By
Lemma \ref{lemma-cut-complex-in-two}
we see that the assumption implies that $H^i(K^\bullet)_{\mathfrak m} = 0$
for all maximal ideals of $R$. Hence $H^i(K^\bullet) = 0$, see
Algebra, Lemma \ref{algebra-lemma-characterize-zero-local}.
Moreover,
Lemma \ref{lemma-cut-complex-in-two}
now also implies that for every maximal ideal
$\mathfrak m$ there exists an element $f \in R$, $f \not \in \mathfrak m$
such that $K^\bullet \otimes_R R_f$ is perfect with tor amplitude in
$[a, b]$. Hence we conclude by applealing to
Lemmas \ref{lemma-glue-perfect} and \ref{lemma-glue-tor-amplitude}.
\end{proof}

\begin{lemma}
\label{lemma-check-perfect-stalks}
Let $R$ be a ring. Let $K^\bullet$ be a pseudo-coherent
complex of $R$-modules. The following are equivalent
\begin{enumerate}
\item $K^\bullet$ is perfect,
\item for every prime ideal $\mathfrak p$ the complex
$K^\bullet \otimes_R R_{\mathfrak p}$ is perfect,
\item for every prime $\mathfrak p$ we have
$H^i(K^\bullet \otimes_R^{\mathbf{L}} \kappa(\mathfrak p)) = 0$ for all
$i \ll 0$,
\item for every maximal ideal $\mathfrak m$ the complex
$K^\bullet \otimes_R R_{\mathfrak m}$ is perfect,
\item for every maximal ideal $\mathfrak m$ we have
$H^i(K^\bullet \otimes_R^{\mathbf{L}} \kappa(\mathfrak m)) = 0$ for all
$i \ll 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (5). Pick a maximal ideal $\mathfrak m$ of $R$. By
Lemma \ref{lemma-cut-complex-in-two}
we see that the assumption implies that $K^\bullet \otimes_R R_f$
is a perfect complex for some $f \in R$, $f \not \in \mathfrak m$.
Since $\Spec(R)$ is quasi-compact we conclude that $K^\bullet$
is perfect by
Lemmas \ref{lemma-glue-perfect}.
The proof of the other implications is omitted.
\end{proof}

\noindent
The following lemma useful in order to find perfect complexes
over a polynomial ring $B = A[x_1, \ldots, x_d]$.

\begin{lemma}
\label{lemma-perfect-over-polynomial-ring}
Let $A \to B$ be a ring map. Let $a, b \in \mathbf{Z}$. Let $d \geq 0$.
Let $K^\bullet$ be a complex of $B$-modules. Assume
\begin{enumerate}
\item the ring map $A \to B$ is flat,
\item for every prime $\mathfrak p \subset A$ the ring
$B \otimes_A \kappa(\mathfrak p)$ has finite global dimension $\leq d$,
\item $K^\bullet$ is pseudo-coherent as a complex of $B$-modules, and
\item $K^\bullet$ has tor amplitude in $[a, b]$ as a complex
of $A$-modules.
\end{enumerate}
Then $K^\bullet$ is perfect as a complex of $B$-modules
with tor amplitude in $[a - d, b]$.
\end{lemma}

\begin{proof}
We may assume that $K^\bullet$ is a bounded above complex of
finite free $B$-modules. In particular, $K^\bullet$ is flat as a
complex of $A$-modules and
$K^\bullet \otimes_A M = K^\bullet \otimes_A^{\mathbf{L}}$ for any
$A$-module $M$. For every prime $\mathfrak p$ of $A$ the complex
$$
K^\bullet \otimes_A \kappa(\mathfrak p)
$$
is a bounded above complex of finite free modules over
$B \otimes_A \kappa(\mathfrak p)$ with vanishing $H^i$ except
for $i \in [a, b]$. As $B \otimes_A \kappa(\mathfrak p)$
has global dimension $d$ we see from
Lemma \ref{lemma-finite-gl-dim-tor-dimension}
that $K^\bullet \otimes_A \kappa(\mathfrak p)$ has tor amplitude in
$[a - d, b]$. Let $\mathfrak q$ be a prime of $B$ lying over $\mathfrak p$.
Since $K^\bullet \otimes_A \kappa(\mathfrak p)$ is a bounded above
complex of free $B \otimes_A \kappa(\mathfrak q)$-modules we see
that
\begin{align*}
K^\bullet \otimes_B^{\mathbf{L}} \kappa(\mathfrak q)
& = K^\bullet \otimes_B \kappa(\mathfrak q) \\
& = (K^\bullet \otimes_A \kappa(\mathfrak p))
\otimes_{B \otimes_A \kappa(\mathfrak q)} \kappa(\mathfrak q) \\
& = (K^\bullet \otimes_A \kappa(\mathfrak p))
\otimes^{\mathbf{L}}_{B \otimes_A \kappa(\mathfrak q)} \kappa(\mathfrak q)
\end{align*}
Hence the arguments above imply that
$H^i(K^\bullet \otimes_B^{\mathbf{L}} \kappa(\mathfrak q)) = 0$
for $i \not \in [a - d, b]$. We conclude by
Lemma \ref{lemma-check-perfect-pointwise}.
\end{proof}

\begin{lemma}
\label{lemma-dual-perfect-complex}
Let $K^\bullet$ be a perfect complex over a ring $A$. There exists a
perfect complex $E^\bullet$ such that we have functorial isomorphisms
$$
H^0(K^\bullet \otimes_A^\mathbf{L} L^\bullet) =
\text{Ext}_A^0(E^\bullet, L^\bullet)
$$
for $L^\bullet \in D(A)$.
\end{lemma}

\begin{proof}
We may assume that $K^\bullet$ is a finite complex of finite projective
$A$-modules. The cohomology group on the left is simply
$H^0(\text{Tot}(K^\bullet \otimes_A L^\bullet))$. Set
$E^\bullet = \Hom_A(K^\bullet, A)$, i.e., $E^n = \Hom_A(K^{-n}, A)$
with differentials the transpose of the differentials of $K^\bullet$.
Observe that $E^\bullet$ is a finite complex of finite projective $A$-modules.
The group on the right
is $\text{Mor}_{K(\text{Mod}_A)}(E^\bullet, L^\bullet)$ by
Derived Categories, Lemma \ref{derived-lemma-morphisms-from-projective-complex}
and the definition of Ext groups, see
Derived Categories, Section \ref{derived-section-ext}.
By definition this is the cohomology of
$$
\prod\nolimits_n \Hom_A(E^n, L^{n - 1})
\to
\prod\nolimits_n \Hom_A(E^n, L^n)
\to
\prod\nolimits_n \Hom_A(E^n, L^{n + 1})
$$
Using $\Hom_A(E^n, L) = K^{-n} \otimes_A L$ as $K^{-n}$ is finite
projective, we see that the cohomology groups are the same.
\end{proof}





\section{Characterizing perfect complexes}
\label{section-perfect-compact}

\noindent
Let $R$ be a ring. Recall that $D(R)$ has direct sums which are given
simply by taking direct sums of complexes, see
Derived Categories, Lemma \ref{derived-lemma-product-derived-Ab4*}.
We will use this in the lemmas of this section without further mention. 

\begin{lemma}
\label{lemma-commutes-with-countable-sums}
Let $R$ be a ring. Let $K \in D(R)$ be an object such that for every
countable set of objects $E_n \in D(R)$ the canonical map
$$
\bigoplus \Hom_{D(R)}(K, E_n) \longrightarrow \Hom_{D(R)}(K, \bigoplus E_n)
$$
is a bijection. Then, given any system $L_n^\bullet$ of complexes over
$\mathbf{N}$ we have that
$$
\colim \Hom_{D(R)}(K, L^\bullet_n) \longrightarrow \Hom_{D(R)}(K, L^\bullet)
$$
is a bijection, where $L^\bullet$ is the termwise colimit, i.e.,
$L^m = \colim L_n^m$ for all $m \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Consider the short exact sequence of complexes
$$
0 \to \bigoplus L_n^\bullet \to \bigoplus L_n^\bullet \to L^\bullet \to 0
$$
where the first map is given by $1 - t_n$ in degree $n$ where
$t_n : L_n^\bullet \to L_{n + 1}^\bullet$ is the transition map.
By
Derived Categories, Lemma \ref{derived-lemma-derived-canonical-delta-functor}
this is a distinguished triangle in $D(R)$.
Apply the homological functor $\Hom_{D(R)}(K, -)$, see
Derived Categories, Lemma \ref{derived-lemma-representable-homological}.
Thus a long exact cohomology sequence
$$
\xymatrix{
& \ldots \ar[r] & \Hom_{D(R)}(K, \colim L^\bullet_n[-1]) \ar[lld] \\
\Hom_{D(R)}(K, \bigoplus L^\bullet_n) \ar[r] &
\Hom_{D(R)}(K, \bigoplus L^\bullet_n) \ar[r] &
\Hom_{D(R)}(K, \colim L^\bullet_n) \ar[lld] \\
\Hom_{D(R)}(K, \bigoplus L^\bullet_n[1]) \ar[r] & \ldots
}
$$
Since we have assumed that $\Hom_{D(R)}(K, \bigoplus L^\bullet_n)$
is equal to $\bigoplus \Hom_{D(R)}(K, L^\bullet_n)$ we see that the first
map on every row of the diagram is injective (by the explicit description
of this map as the sum of the maps induced by $1 - t_n$). Hence
we conclude that $\Hom_{D(R)}(K, \colim L^\bullet_n)$ is the cokernel
of the first map of the middle row in the diagram above which is what
we had to show.
\end{proof}

\begin{definition}
\label{definition-compact-object}
Let $\mathcal{D}$ be an additive category with arbitrary direct
sums. A {\it compact object} of $\mathcal{D}$ is an object $K$
such that the map
$$
\bigoplus\nolimits_{i \in I} \Hom_{\mathcal{D}}(K, E_i)
\longrightarrow
\Hom_{\mathcal{D}}(K, \bigoplus\nolimits_{i \in I} E_i)
$$
is bijective for any set $I$ and objects
$E_i \in \Ob(\mathcal{D})$ parametrized by $i \in I$.
\end{definition}

\noindent
The following proposition shows up in various places. See for example
\cite[proof of Proposition 6.3]{Rickard} (this treats the bounded case),
\cite[Theorem 2.4.3]{TT} (the statement doesn't match exactly), and
\cite[Proposition 6.4]{Bokstedt-Neeman} (watch out for
horrendous notational conventions).

\begin{proposition}
\label{proposition-perfect-is-compact}
Let $R$ be a ring. For an object $K$ of $D(R)$ the following are equivalent
\begin{enumerate}
\item $K$ is perfect, and
\item $K$ is a compact object of $D(R)$.
\end{enumerate}
\end{proposition}

\begin{proof}
Assume $K$ is perfect, i.e., $K$ is quasi-isomorphic to a bounded complex
$P^\bullet$ of finite projective modules, see
Definition \ref{definition-perfect}. If $E_i$ is represented by the complex
$E_i^\bullet$, then $\bigoplus E_i$ is represented by the complex
whose degree $n$ term is $\bigoplus E_i^n$. On the other hand,
as $P^n$ is projective for all $n$ we have
$\Hom_{D(R)}(P^\bullet, K^\bullet) = \Hom_{K(R)}(P^\bullet, K^\bullet)$
for every complex of $R$-modules $K^\bullet$, see
Derived Categories,
Lemma \ref{derived-lemma-morphisms-from-projective-complex}.
Thus $\Hom_{D(R)}(P^\bullet, E^\bullet)$ is the cohomology of the complex
$$
\prod \Hom_R(P^n, E^{n - 1}) \to
\prod \Hom_R(P^n, E^n) \to
\prod \Hom_R(P^n, E^{n + 1}).
$$
Since $P^\bullet$ is bounded we see that we may replace the $\prod$
signs by $\bigoplus$ signs in the complex above. Since each $P^n$ is a finite
$R$-module we see that
$\Hom_R(P^n, \bigoplus_i E_i^m) = \bigoplus_i \Hom_R(P^n, E_i^m)$
for all $n, m$.
Combining these remarks we see that the map of
Definition \ref{definition-compact-object}
is a bijection.

\medskip\noindent
Conversely, assume $K$ is compact.
Represent $K$ by a complex $K^\bullet$ and consider the map
$$
K^\bullet
\longrightarrow
\bigoplus\nolimits_{n \geq 0} \tau_{\geq n} K^\bullet
$$
where we have used the canonical truncations, see
Homology, Section \ref{homology-section-truncations}.
This makes sense as in each degree the direct sum on the right is finite.
By assumption this map factors through a finite direct sum.
We conclude that $K \to \tau_{\geq n} K$ is zero for at least one $n$,
i.e., $K$ is in $D^{-}(R)$.

\medskip\noindent
Since $K \in D^{-}(R)$ and since every $R$-module is a quotient of a free
module, we may represent $K$ by a bounded above complex $K^\bullet$
of free $R$-modules, see
Derived Categories, Lemma \ref{derived-lemma-subcategory-left-resolution}.
Note that we have
$$
K^\bullet = \bigcup\nolimits_{n \leq 0} \sigma_{\geq n}K^\bullet
$$
where we have used the stupid truncations, see
Homology, Section \ref{homology-section-truncations}.
Hence by Lemma \ref{lemma-commutes-with-countable-sums} we see that
$1 : K^\bullet \to K^\bullet$ factors through
$\sigma_{\geq n}K^\bullet \to K^\bullet$ in $D(R)$.
Thus we see that $1 : K^\bullet \to K^\bullet$ factors as
$$
K^\bullet \xrightarrow{\varphi} L^\bullet \xrightarrow{\psi} K^\bullet
$$
in $D(R)$ for some complex $L^\bullet$ which is bounded and whose terms
are free $R$-modules. Say $L^i = 0$ for $i \not \in [a, b]$.
Fix $a, b$ from now on. Let $c$ be the largest integer $\leq b + 1$
such that we can find a factorization of $1_{K^\bullet}$ as above
with $L^i$ is finite free for $i < c$. We will show by induction that
$c = b + 1$. Namely, write $L^c = \bigoplus_{\lambda \in \Lambda} R$.
Since $L^{c - 1}$ is finite free we can find a finite subset
$\Lambda' \subset \Lambda$ such that $L^{c - 1} \to L^c$ factors
through $\bigoplus_{\lambda \in \Lambda'} R \subset L^c$. Consider the
map of complexes
$$
\pi :
L^\bullet
\longrightarrow
(\bigoplus\nolimits_{\lambda \in \Lambda \setminus \Lambda'} R)[-i]
$$
given by the projection onto the factors corresponding to
$\Lambda \setminus \Lambda'$ in degree $i$.
By our assumption on $K$ we see that, after possibly replacing $\Lambda'$ by
a larger finite subset, we may assume that $\pi \circ \varphi = 0$
in $D(R)$. Let $(L')^\bullet \subset L^\bullet$ be the kernel of $\pi$.
Since $\pi$ is surjective we get a short exact sequence of complexes,
which gives a distinguished triangle in $D(R)$ (see
Derived Categories, Lemma \ref{derived-lemma-derived-canonical-delta-functor}).
Since $\Hom_{D(R)}(K, -)$ is homological (see
Derived Categories, Lemma \ref{derived-lemma-representable-homological})
and $\pi \circ \varphi = 0$, we can find a morphism
$\varphi' : K^\bullet \to (L')^\bullet$ in $D(R)$ whose
composition with $(L')^\bullet \to L^\bullet$ gives $\varphi$.
Setting $\psi'$ equal to the composition of $\psi$ with
$(L')^\bullet \to L^\bullet$ we obtain a new factorization.
Since $(L')^\bullet$ agrees with $L^\bullet$ except in degree $c$
and since $(L')^c = \bigoplus_{\lambda \in \Lambda'} R$ the
induction step is proved.

\medskip\noindent
The conclusion of the discussion of the preceding paragraph is that
$1_K : K \to K$ factors as
$$
K \xrightarrow{\varphi} L \xrightarrow{\psi} K
$$
in $D(R)$ where $L$ can be represented by a finite
complex of free $R$-modules. In particular we see that $L$ is
perfect. Note that $e = \varphi \circ \psi \in \text{End}_{D(R)}(L)$
is an idempotent. By Derived Categories,
Lemma \ref{derived-lemma-projectors-have-images-triangulated}
we see that $L = \text{Ker}(e) \oplus \text{Ker}(1 - e)$
(see also discussion preceding
Derived Categories, Lemma \ref{derived-lemma-projectors-have-images}).
The map $\varphi : K \to L$ induces an isomorphism with
$\text{Ker}(1 - e)$ in $D(R)$. Hence we finally conclude that
$K$ is perfect by Lemma \ref{lemma-summands-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-perfect-modulo-nilpotent-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $K$ be an object of $D(R)$. Assume that
\begin{enumerate}
\item $K \otimes_R^\mathbf{L} R/I$ is perfect in $D(R/I)$, and
\item $I$ is a nilpotent ideal.
\end{enumerate}
Then $K$ is perfect in $D(R)$.
\end{lemma}

\begin{proof}
Assumption (2) means that $I^n = 0$ for some $n$. The result holds if $n = 1$.
Below we will prove the result holds for $n = 2$. This will imply that the
complex $K \otimes_R^\mathbf{L} R/I^2$ is perfect in $D(R/I^2)$. Since
$(I^2)^{\lceil n/2 \rceil} = 0$ we see that we win by induction on $n$.

\medskip\noindent
We prove the lemma in case $I^2 = 0$. First, we may represent $K$
by a $K$-flat complex $K^\bullet$ with all $K^n$ flat, see
Lemma \ref{lemma-K-flat-resolution}. Then we see that we have a short
exact sequence of complexes
$$
0 \to
K^\bullet \otimes_R I \to
K^\bullet \to
K^\bullet \otimes_R R/I \to 0
$$
Note that $K^\bullet \otimes_R R/I$ represents $K \otimes^\mathbf{L}_R R/I$
by constuction of the derived tensor product. Also
$$
K^\bullet \otimes_R I \cong K^\bullet \otimes_R R/I \otimes_{R/I} I
$$
represents $K \otimes^\mathbf{L}_R R/I \otimes^\mathbf{L}_{R/I} I$
because $K^\bullet \otimes_R R/I$ is a K-flat complex over $R/I$, see
Lemma \ref{lemma-base-change-K-flat}.
By assumption (1) we see that both $K^\bullet \otimes_R R/I$ and
$K^\bullet \otimes_R I$ have finitely many nonzero cohomology groups
(since a perfect complex has finite Tor-amplitude, see
Lemma \ref{lemma-perfect}). We conclude that $K \in D^b(R)$ by the
long exact cohomology sequence associated to short exact sequence
of complexes displayed above. In particular we can represent $K$
by a bounded above complex $K^\bullet$ of free $R$-modules (see
Derived Categories, Lemma \ref{derived-lemma-subcategory-left-resolution}).
Then for any complex $E^\bullet$ of $R$-modules we have
$$
\Hom_{D(R)}(K, E^\bullet) = \Hom_{K(R)}(K^\bullet, E^\bullet)
$$
see Derived Categories,
Lemma \ref{derived-lemma-morphisms-from-projective-complex}.

\medskip\noindent
We will now show that $K$ is perfect using the criterion of
Proposition \ref{proposition-perfect-is-compact}. Thus we let
$E_j \in D(R)$ be a family of objects parametrized by a set $J$.
We choose complexes $E_j^\bullet$ with flat terms
representing $E_j$, see for example Lemma \ref{lemma-K-flat-resolution}.
It is clear that
$$
0 \to
E_j^\bullet \otimes_R I \to
E_j^\bullet \to
E_j^\bullet \otimes_R R/I \to 0
$$
is a short exact sequence of complexes. Taking direct sums we obtain a
similar short exact sequence
$$
0 \to
\bigoplus E_j^\bullet \otimes_R I \to
\bigoplus E_j^\bullet \to
\bigoplus E_j^\bullet \otimes_R R/I \to 0
$$
(Note that $- \otimes_R I$ and $- \otimes_R R/I$ commute with
direct sums.) This short exact sequence determines a distinguished
triangle in $D(R)$, see
Derived Categories, Lemma \ref{derived-lemma-derived-canonical-delta-functor}.
Apply the homological functor $\Hom_{D(R)}(K, -)$ (see
Derived Categories, Lemma \ref{derived-lemma-representable-homological})
to get a commutative diagram
$$
\xymatrix{
\bigoplus \Hom_{D(R)}(K^\bullet, E_j^\bullet \otimes_R R/I)[-1] \ar[r] \ar[d] &
\Hom_{D(R)}(K^\bullet, \bigoplus E_j^\bullet \otimes_R R/I)[-1] \ar[d] \\
\bigoplus \Hom_{D(R)}(K^\bullet, E_j^\bullet \otimes_R I) \ar[r] \ar[d] &
\Hom_{D(R)}(K^\bullet, \bigoplus E_j^\bullet \otimes_R I) \ar[d] \\
\bigoplus \Hom_{D(R)}(K^\bullet, E_j^\bullet) \ar[r] \ar[d] &
\Hom_{D(R)}(K^\bullet, \bigoplus E_j^\bullet) \ar[d] \\
\bigoplus \Hom_{D(R)}(K^\bullet, E_j^\bullet \otimes_R R/I) \ar[r] \ar[d] &
\Hom_{D(R)}(K^\bullet, \bigoplus E_j^\bullet \otimes_R R/I) \ar[d] \\
\bigoplus \Hom_{D(R)}(K^\bullet, E_j^\bullet \otimes_R I)[1] \ar[r] &
\Hom_{D(R)}(K^\bullet, \bigoplus E_j^\bullet \otimes_R I)[1]
}
$$
with exact columns. Note that the complexes $E_j^\bullet \otimes_R R/I$
and $E_j^\bullet \otimes_R I$ have terms annihilated by $I$. Hence
the 5 lemma (see Homology, Lemma \ref{homology-lemma-five-lemma})
shows it suffices to show that given any collection of complexes
$M_j^\bullet$ with $IM_j^n = 0$ for all $n, j$ the map
$$
\bigoplus \Hom_{D(R)}(K^\bullet, M_j^\bullet)
\longrightarrow
\Hom_{D(R)}(K^\bullet, \bigoplus M_j^\bullet)
$$
is a bijection. By our choice of $K^\bullet$ we can rewrite this as
$$
\bigoplus \Hom_{K(R)}(K^\bullet, M_j^\bullet)
\longrightarrow
\Hom_{K(R)}(K^\bullet, \bigoplus M_j^\bullet)
$$
Since $I$ annihilates $M_j^n$ we see this is equal to
$$
\bigoplus \Hom_{K(R/I)}(K^\bullet \otimes_R R/I, M_j^\bullet)
\longrightarrow
\Hom_{K(R)}(K^\bullet \otimes_R R/I, \bigoplus M_j^\bullet).
$$
Using that $K^\bullet \otimes_R R/I$ is a bounded above complex
of free $R/I$-modules we see this is equal to the map
$$
\bigoplus \Hom_{D(R/I)}(K^\bullet \otimes_R R/I, M_j^\bullet)
\longrightarrow
\Hom_{D(R)}(K^\bullet \otimes_R R/I, \bigoplus M_j^\bullet)
$$
by Derived Categories,
Lemma \ref{derived-lemma-morphisms-from-projective-complex} as before.
The complex $K^\bullet \otimes_R R/I$ represents $K \otimes_R^\mathbf{L} R/I$
since $K^\bullet$ is K-flat (Lemma \ref{lemma-derived-tor-quasi-isomorphism}).
We conclude that $K^\bullet \otimes_R R/I$ is compact (by
Proposition \ref{proposition-perfect-is-compact}). Hence the last
displayed map is a bijection and we win.
\end{proof}








\section{Relatively finitely presented modules}
\label{section-relative-finite-presentation}

\noindent
Let $R$ be a ring. Let $A \to B$ be a finite map of finite type $R$-algebras.
Let $M$ be a finite $B$-module. In this case it is {\bf not true} that
$$
M\text{ of finite presentation over }B
\Leftrightarrow
M\text{ of finite presentation over }A
$$
A counter example is $R = k[x_1, x_2, x_3, \ldots]$, $A = R$, $B = R/(x_i)$,
and $M = B$. To ``fix'' this we introduce a relative notion of finite
presentation.

\begin{lemma}
\label{lemma-relatively-finitely-presented}
Let $R \to A$ be a ring map of finite type.
Let $M$ be an $A$-module.
The following are equivalent
\begin{enumerate}
\item for some presentation $\alpha : R[x_1, \ldots, x_n] \to A$
the module $M$ is a finitely presented $R[x_1, \ldots, x_n]$-module,
\item for all presentations $\alpha : R[x_1, \ldots, x_n] \to A$
the module $M$ is a finitely presented $R[x_1, \ldots, x_n]$-module, and
\item for any surjection $A' \to A$ where $A'$ is a finitely presented
$R$-algebra, the module $M$ is finitely presented as $A'$-module.
\end{enumerate}
In this case $M$ is a finitely presented $A$-module.
\end{lemma}

\begin{proof}
If $\alpha : R[x_1, \ldots, x_n] \to A$ and
$\beta : R[y_1, \ldots, y_m] \to A$ are presentations.
Choose $f_j \in R[x_1, \ldots, x_n]$ with $\alpha(f_j) = \beta(y_j)$
and $g_i \in R[y_1, \ldots, y_m]$ with $\beta(g_i) = \alpha(x_i)$.
Then we get a commutative diagram
$$
\xymatrix{
R[x_1, \ldots, x_n, y_1, \ldots, y_m]
\ar[d]^{x_i \mapsto g_i} \ar[rr]_-{y_j \mapsto f_j} & &
R[x_1, \ldots, x_n] \ar[d] \\
R[y_1, \ldots, y_m] \ar[rr] & & A
}
$$
Hence the equivalence of (1) and (2) follows by applying
Algebra, Lemmas \ref{algebra-lemma-finitely-presented-over-subring} and
\ref{algebra-lemma-finite-finitely-presented-extension}.
The equivalence of (2) and (3) follows by choosing a presentation
$A' = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ and using
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}
to show that $M$ is finitely presented as $A'$-module if and only if
$M$ is finitely presented as a $R[x_1, \ldots, x_n]$-module.
\end{proof}

\begin{definition}
\label{definition-relatively-finitely-presented}
Let $R \to A$ be a finite type ring map. Let $M$ be an $A$-module.
We say $M$ is {\it an $A$-module finitely presented relative to $R$}
if the equivalent conditions of
Lemma \ref{lemma-relatively-finitely-presented}
hold.
\end{definition}

\noindent
Note that if $R \to A$ is of finite presentation, then $M$ is an
$A$-module finitely presented relative to $R$ if and only if $M$
is a finitely presented $A$-module. It is equally clear that $A$ as
an $A$-module is finitely presented relative to $R$ if and only if
$A$ is of finite presentation over $R$. If $R$ is Noetherian the notion
is uninteresting. Now we can formulate the result we were looking for.

\begin{lemma}
\label{lemma-finite-extension}
Let $R$ be a ring. Let $A \to B$ be a finite map of finite type $R$-algebras.
Let $M$ be a $B$-module. Then
$M$ is an $A$-module finitely presented relative to $R$
if and only if
$M$ is a $B$-module finitely presented relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$.
Choose $y_1, \ldots, y_m \in B$ which generate $B$ over $A$.
As $A \to B$ is finite each $y_i$ satisfies a monic equation with
coefficients in $A$. Hence we can find monic polynomials
$P_j(T) \in R[x_1, \ldots, x_n][T]$ such that $P_j(y_j) = 0$ in $B$.
Then we get a commutative diagram
$$
\xymatrix{
R[x_1, \ldots, x_n] \ar[d] \ar[r] &
R[x_1, \ldots, x_n, y_1, \ldots, y_m]/(P_j(y_j)) \ar[d] \\
A \ar[r] & B
}
$$
Since the top arrow is a finite and finitely presented ring map
we conclude by
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}
and the definition.
\end{proof}

\noindent
With this result in hand we see that the relative notion makes sense
and behaves well with regards to finite maps of rings of finite type
over $R$. It is also stable under localization, stable under
base change, and "glues" well.

\begin{lemma}
\label{lemma-localize-relative-finite-presentation}
Let $R$ be a ring, $f \in R$ an element, $R_f \to A$ is a finite type ring map,
$g \in A$, and $M$ an $A$-module. If $M$ of finite presentation relative
to $R_f$, then $M_g$ is an $A_g$-module of finite presentation relative
to $R$.
\end{lemma}

\begin{proof}
Choose a presentation $R_f[x_1, \ldots, x_n] \to A$. We write
$R_f = R[x_0]/(fx_0 - 1)$. Consider the presentation
$R[x_0, x_1, \ldots, x_n, x_{n + 1}] \to A_g$ which extends the given
map, maps $x_0$ to the image of $1/f$, and maps $x_{n + 1}$ to $1/g$.
Choose $g' \in R[x_0, x_1, \ldots, x_n]$ which maps to $g$ (this is
possible). Suppose that
$$
R_f[x_1, \ldots, x_n]^{\oplus s} \to
R_f[x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
is a presentation of $M$ given by a matrix $(h_{ij})$. Pick
$h'_{ij} \in R[x_0, x_1, \ldots, x_n]$ which map to $h_{ij}$.
Then
$$
R[x_0, x_1, \ldots, x_n, x_{n + 1}]^{\oplus s + 2t} \to
R[x_0, x_1, \ldots, x_n, x_{n + 1}]^{\oplus t} \to M_g \to 0
$$
is a presentation of $M_f$.
Here the $t \times (s + 2t)$ matrix defining the map has a first
$t \times s$ block consisting of the matrix $h'_{ij}$, a second
$t \times t$ block which is $(x_0f - )I_t$, and a third block
which is $(x_{n + 1}g' - 1)I_t$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-relative-finite-presentation}
Let $R \to A$ be a finite type ring map. Let $M$ be an $A$-module finitely
presented relative to $R$. For any ring map $R \to R'$ the
$A \otimes_R R'$-module
$$
M \otimes_A A' = M \otimes_R R'
$$
is finitely presented relative to $R'$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$. Choose a presentation
$$
R[x_1, \ldots, x_n]^{\oplus s} \to
R[x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
Then
$$
R'[x_1, \ldots, x_n]^{\oplus s} \to
R'[x_1, \ldots, x_n]^{\oplus t} \to M \otimes_R R' \to 0
$$
is a presentation of the base change and we win.
\end{proof}

\begin{lemma}
\label{lemma-pull-relative-finite-presentation}
Let $R \to A$ be a finite type ring map.
Let $M$ be an $A$-module finitely presented relative to $R$.
Let $A \to A'$ be a ring map of finite presentation.
$A'$-module $M \otimes_A A'$ is finitely presented relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$. Choose a presentation
$A' = A[y_1, \ldots, y_m]/(g_1, \ldots, g_l)$.
Pick $g'_i \in R[x_1, \ldots, x_n, y_1, \ldots, y_m]$ mapping to $g_i$.
Say
$$
R[x_1, \ldots, x_n]^{\oplus s} \to
R[x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
is a presentation of $M$ given by a matrix $(h_{ij})$.
Then
$$
R[x_1, \ldots, x_n, y_1, \ldots, y_m]^{\oplus s + tl} \to
R[x_0, x_1, \ldots, x_n, y_1, \ldots, y_m]^{\oplus t} \to M \otimes_A A' \to 0
$$
is a presentation of $M \otimes_A A'$.
Here the $t \times (s + lt)$ matrix defining the map has a first
$t \times s$ block consisting of the matrix $h_{ij}$, followed
by $l$ blocks of size $t \times t$ which are $g'_iI_t$.
\end{proof}

\begin{lemma}
\label{lemma-composition-relative-finite-presentation}
Let $R \to A \to B$ be finite type ring maps. Let $M$ be a $B$-module.
If $M$ is finitely presented relative to $A$ and $A$ is of finite presentation
over $R$, then $M$ is finitely presented relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $A[x_1, \ldots, x_n] \to B$.
Choose a presentation
$$
A[x_1, \ldots, x_n]^{\oplus s} \to
A[x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
given by a matrix $(h_{ij})$. Choose a presentation
$$
A = R[y_1, \ldots, y_m]/(g_1, \ldots, g_u).
$$
Choose $h'_{ij} \in R[y_1, \ldots, y_m, x_1, \ldots, x_n]$
mapping to $h_{ij}$. Then we obtain the presentation
$$
R[y_1, \ldots, y_m, x_1, \ldots, x_n]^{\oplus s + tu} \to
R[y_1, \ldots, y_m, x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
where the $t \times (s + tu)$-matrix is given by a first $t \times s$ block
consisting of $h'_{ij}$ followed by $u$ blocks of size $t \times t$ given
by $g_iI_t$, $i = 1, \ldots, u$.
\end{proof}

\begin{lemma}
\label{lemma-glue-relative-finite-presentation}
Let $R \to A$ be a finite type ring map. Let $M$ be an $A$-module.
Let $f_1, \ldots, f_r \in A$ generate the unit ideal.
The following are equivalent
\begin{enumerate}
\item each $M_{f_i}$ is finitely presented relative to $R$, and
\item $M$ is finitely presented relative to $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) is in
Lemma \ref{lemma-localize-relative-finite-presentation}.
Assume (1). Write $1 = \sum f_ig_i$ in $A$.
Choose a surjection
$R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r] \to A$.
such that $y_i$ maps to $f_i$ and $z_i$ maps to $g_i$. Then we
see that there exists a surjection
$$
P = R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r]/(\sum y_iz_i - 1)
\longrightarrow
A.
$$
By
Lemma \ref{lemma-relatively-finitely-presented}
we see that $M_{f_i}$ is a finitely presented $A_{f_i}$-module, hence by
Algebra, Lemma \ref{algebra-lemma-cover}
we see that $M$ is a finitely presented $A$-module.
Hence $M$ is a finite $P$-module (with $P$ as above).
Choose a surjection $P^{\oplus t} \to M$.
We have to show that the kernel $K$ of this map is a finite
$P$-module. Since $P_{y_i}$ surjects onto
$A_{f_i}$ we see by
Lemma \ref{lemma-relatively-finitely-presented}
and
Algebra, Lemma \ref{algebra-lemma-finite-presentation-module-independent}
that the localization $K_{y_i}$ is a finitely generated
$P_{y_i}$-module. Choose elements
$k_{i, j} \in K$, $i = 1, \ldots, r$, $j = 1, \ldots, s_i$ such
that the images of $k_{i, j}$ in $K_{y_i}$ generate.
Set $K' \subset K$ equal to the $P$-module
generated by the elements $k_{i, j}$. Then $K/K'$ is a module
whose localization at $y_i$ is zero for all $i$. Since $(y_1, \ldots, y_r) = P$
we see that $K/K' = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-ses-relatively-finite-presentation}
Let $R \to A$ be a finite type ring map. Let $0 \to M' \to M \to M'' \to 0$
be a short exact sequence of $A$-modules.
\begin{enumerate}
\item If $M', M''$ are finitely presented relative to $R$, then so is $M$.
\item If $M'$ is finite a type $A$-module and $M$ is finitely presented
relative to $R$, then $M''$ is finitely presented relative to $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows immediately from
Algebra, Lemma \ref{algebra-lemma-extension}.
\end{proof}

\begin{lemma}
\label{lemma-sum-relatively-finite-presentation}
Let $R \to A$ be a finite type ring map.
Let $M, M'$ be $A$-modules. If $M \oplus M'$ is
finitely presented relative to $R$, then so are $M$ and $M'$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}






\section{Relatively pseudo-coherent modules}
\label{section-relative-pseudo-coherent}

\noindent
This section is the analogue of
Section \ref{section-relative-finite-presentation}
for pseudo-coherence.

\begin{lemma}
\label{lemma-pull-push}
Let $R$ be a ring. Let $K^\bullet$ be an object of $D^{-}(R)$.
Consider the $R$-algebra map $R[x] \to R$ which maps $x$ to zero. Then
$$
K^\bullet \otimes_{R[x]}^{\mathbf{L}} R \cong K^\bullet \oplus K^\bullet[1]
$$
in $D(R)$.
\end{lemma}

\begin{proof}
Choose a projective resolution $P^\bullet \to K^\bullet$ over $R$.
Then
$$
P^\bullet \otimes_R R[x] \xrightarrow{x} P^\bullet \otimes_R R[x]
$$
is a double complex of projective $R[x]$-modules whose associated
total complex is quasi-isomorphic to $P^\bullet$. Hence
\begin{align*}
K^\bullet \otimes_{R[x]}^{\mathbf{L}} R
& \cong
\text{Tot}(P^\bullet \otimes_R R[x] \xrightarrow{x} P^\bullet \otimes_R R[x])
\otimes_{R[x]} R =
\text{Tot}(P^\bullet \xrightarrow{0} P^\bullet) \\
& = P^\bullet \oplus P^\bullet[1] \cong K^\bullet \oplus K^\bullet[1]
\end{align*}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-add-variable-pseudo-coherent}
Let $R$ be a ring and $K^\bullet$ a complex of $R$-modules.
Let $m \in \mathbf{Z}$. Consider the $R$-algebra map $R[x] \to R$
which maps $x$ to zero. Then $K^\bullet$ is $m$-pseudo-coherent as
a complex of $R$-modules if and only if $K^\bullet$ is $m$-pseudo-coherent
as a complex of $R[x]$-modules.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-finite-push-pseudo-coherent}.
We also prove it in another way as follows.

\medskip\noindent
Note that $0 \to R[x] \to R[x] \to R \to 0$ is exact. Hence $R$ is
pseudo-coherent as an $R[x]$-module. Thus one implication of the lemma
follows from
Lemma \ref{lemma-finite-push-pseudo-coherent}.
To prove the other implication, assume that $K^\bullet$ is
$m$-pseudo-coherent as a complex of $R[x]$-modules. By
Lemma \ref{lemma-pull-pseudo-coherent}
we see that $K^\bullet \otimes^{\mathbf{L}}_{R[x]} R$ is
$m$-pseudo-coherent as a comples of $R$-modules. By
Lemma \ref{lemma-pull-push}
we see that $K^\bullet \oplus K^\bullet[1]$ is $m$-pseudo-coherent
as a complex of $R$-modules.
Finally, we conclude that $K^\bullet$ is $m$-pseudo-coherent
as a complex of $R$-modules from
Lemma \ref{lemma-summands-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-relatively-pseudo-coherent}
Let $R \to A$ be a ring map of finite type.
Let $K^\bullet$ be a complex of $A$-modules.
Let $m \in \mathbf{Z}$.
The following are equivalent
\begin{enumerate}
\item for some presentation $\alpha : R[x_1, \ldots, x_n] \to A$
the complex $K^\bullet$ is an $m$-pseudo-coherent complex of
$R[x_1, \ldots, x_n]$-modules,
\item for all presentations $\alpha : R[x_1, \ldots, x_n] \to A$
the complex $K^\bullet$ is an $m$-pseudo-coherent complex of
$R[x_1, \ldots, x_n]$-modules.
\end{enumerate}
In particular the same equivalence holds for pseudo-coherence.
\end{lemma}

\begin{proof}
If $\alpha : R[x_1, \ldots, x_n] \to A$ and
$\beta : R[y_1, \ldots, y_m] \to A$ are presentations.
Choose $f_j \in R[x_1, \ldots, x_n]$ with $\alpha(f_j) = \beta(y_j)$
and $g_i \in R[y_1, \ldots, y_m]$ with $\beta(g_i) = \alpha(x_i)$.
Then we get a commutative diagram
$$
\xymatrix{
R[x_1, \ldots, x_n, y_1, \ldots, y_m]
\ar[d]^{x_i \mapsto g_i} \ar[rr]_-{y_j \mapsto f_j} & &
R[x_1, \ldots, x_n] \ar[d] \\
R[y_1, \ldots, y_m] \ar[rr] & & A
}
$$
After a change of coordinates the ring homomorphism
$R[x_1, \ldots, x_n, y_1, \ldots, y_m] \to R[x_1, \ldots, x_n]$
is isomorphic to the ring homomorphism which maps
each $y_i$ to zero. Similarly for the left vertical map in the
diagram. Hence, by induction on the number of variables this lemma follows from
Lemma \ref{lemma-add-variable-pseudo-coherent}.
The pseudo-coherent case follows from this and
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{definition}
\label{definition-relatively-pseudo-coherent}
Let $R \to A$ be a finite type ring map.
Let $K^\bullet$ be a complex of $A$-modules.
Let $M$ be an $A$-module.
Let $m \in \mathbf{Z}$.
\begin{enumerate}
\item We say $K^\bullet$ is {\it $m$-pseudo-coherent relative to $R$}
if the equivalent conditions of
Lemma \ref{lemma-relatively-pseudo-coherent}
hold.
\item We say $K^\bullet$ is {\it pseudo-coherent relative to $R$}
if $K^\bullet$ is $m$-pseudo-coherent relative to $R$ for all
$m \in \mathbf{Z}$.
\item We say $M$ is {\it $m$-pseudo-coherent relative to $R$}
if $M[0]$ is $m$-pseudo-coherent.
\item We say $M$ is {\it pseudo-coherent relative to $R$}
if $M[0]$ is pseudo-coherent relative to $R$.
\end{enumerate}
\end{definition}

\noindent
Part (2) means that $K^\bullet$ is pseudo-coherent as a complex
of $R[x_1, \ldots, x_n]$-modules for any surjection
$R[y_1, \ldots, y_m] \to A$, see
Lemma \ref{lemma-pseudo-coherent}.
This definition has the following pleasing property.

\begin{lemma}
\label{lemma-finite-extension-pseudo-coherent}
Let $R$ be a ring. Let $A \to B$ be a finite map of finite type $R$-algebras.
Let $m \in \mathbf{Z}$. Let $K^\bullet$ be a complex of $B$-modules.
Then $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
relative to $R$ if and only if $K^\bullet$ seen as a complex of $A$-modules
is $m$-pseudo-coherent (pseudo-coherent) relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$.
Choose $y_1, \ldots, y_m \in B$ which generate $B$ over $A$.
As $A \to B$ is finite each $y_i$ satisfies a monic equation with
coefficients in $A$. Hence we can find monic polynomials
$P_j(T) \in R[x_1, \ldots, x_n][T]$ such that $P_j(y_j) = 0$ in $B$.
Then we get a commutative diagram
$$
\xymatrix{
& R[x_1, \ldots, x_n, y_1, \ldots, y_m] \ar[d] \\
R[x_1, \ldots, x_n] \ar[d] \ar[r] &
R[x_1, \ldots, x_n, y_1, \ldots, y_m]/(P_j(y_j)) \ar[d] \\
A \ar[r] & B
}
$$
The top horizontal arrow and the top right vertial arrow
satisfy the assumptions of
Lemma \ref{lemma-finite-push-pseudo-coherent}.
Hence $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent) as a complex
of $R[x_1, \ldots, x_n]$-modules if and only if $K^\bullet$ is
$m$-pseudo-coherent (resp.\ pseudo-coherent) as a complex of
$R[x_1, \ldots, x_n, y_1, \ldots, y_m]$-modules.
\end{proof}

\begin{lemma}
\label{lemma-cone-relatively-pseudo-coherent}
Let $R$ be a ring. Let $R \to A$ be a finite type ring map.
Let $m \in \mathbf{Z}$. Let $(K^\bullet, L^\bullet, M^\bullet, f, g, h)$
be a distinguished triangle in $D(A)$.
\begin{enumerate}
\item If $K^\bullet$ is $(m + 1)$-pseudo-coherent relative to $R$ and
$L^\bullet$ is $m$-pseudo-coherent relative to $R$ then $M^\bullet$ is
$m$-pseudo-coherent relative to $R$.
\item If $K^\bullet, M^\bullet$ are $m$-pseudo-coherent relative to $R$,
then $L^\bullet$ is $m$-pseudo-coherent relative to $R$.
\item If $L^\bullet$ is $(m + 1)$-pseudo-coherent relative to $R$
and $M^\bullet$ is $m$-pseudo-coherent relative to $R$, then
$K^\bullet$ is $(m + 1)$-pseudo-coherent relative to $R$.
\end{enumerate}
Moreover, if two out of three of $K^\bullet, L^\bullet, M^\bullet$
are pseudo-coherent relative to $R$, the so is the third.
\end{lemma}

\begin{proof}
Follows immediately from
Lemma \ref{lemma-cone-pseudo-coherent}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-rel-n-pseudo-module}
Let $R \to A$ be a finite type ring map. Let $M$ be an $A$-module.
Then
\begin{enumerate}
\item $M$ is $0$-pseudo-coherent relative to $R$ if and only if
$M$ is a finite type $A$-module,
\item $M$ is $(-1)$-pseudo-coherent relative to $R$ if and only if
$M$ is a finitely presented relative to $R$,
\item $M$ is $(-d)$-pseudo-coherent relative to $R$ if and only if
for every surjection $R[x_1, \ldots, x_n] \to A$ there exists a
resolution
$$
R[x_1, \ldots, x_n]^{\oplus a_d} \to R[x_1, \ldots, x_n]^{\oplus a_{d - 1}}
\to \ldots \to R[x_1, \ldots, x_n]^{\oplus a_0} \to M \to 0
$$
of length $d$, and
\item $M$ is pseudo-coherent relative to $R$ if and only if
for every presentation $R[x_1, \ldots, x_n] \to A$ there exists an
infinite resolution
$$
\ldots \to R[x_1, \ldots, x_n]^{\oplus a_1} \to
R[x_1, \ldots, x_n]^{\oplus a_0} \to M \to 0
$$
by finite free $R[x_1, \ldots, x_n]$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows immediately from
Lemma \ref{lemma-n-pseudo-module}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-summands-relative-pseudo-coherent}
Let $R \to A$ be a finite type ring map.
Let $m \in \mathbf{Z}$. Let $K^\bullet, L^\bullet \in D(A)$.
If $K^\bullet \oplus L^\bullet$
is $m$-pseudo-coherent (resp.\ pseudo-coherent) relative to $R$
so are $K^\bullet$ and $L^\bullet$.
\end{lemma}

\begin{proof}
Immediate from
Lemma \ref{lemma-summands-pseudo-coherent}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-complex-relative-pseudo-coherent-modules}
Let $R \to A$ be a finite type ring map.
Let $m \in \mathbf{Z}$. Let $K^\bullet$ be a bounded
above complex of $A$-modules such that $K^i$ is $(m - i)$-pseudo-coherent
relative to $R$ for all $i$. Then $K^\bullet$ is $m$-pseudo-coherent
relative to $R$. In particular, if $K^\bullet$ is a bounded above complex of
$A$-modules pseudo-coherent relative to $R$, then $K^\bullet$ is
pseudo-coherent relative to $R$.
\end{lemma}

\begin{proof}
Immediate from
Lemma \ref{lemma-complex-pseudo-coherent-modules}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-relative-pseudo-coherent}
Let $R \to A$ be a finite type ring map. Let $m \in \mathbf{Z}$.
Let $K^\bullet \in D^{-}(A)$ such that $H^i(K^\bullet)$ is
$(m - i)$-pseudo-coherent (resp.\ pseudo-coherent) relative to $R$
for all $i$. Then $K^\bullet$ is $m$-pseudo-coherent
(resp.\ pseudo-coherent) relative to $R$.
\end{lemma}

\begin{proof}
Immediate from
Lemma \ref{lemma-cohomology-pseudo-coherent}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-localize-relative-pseudo-coherent}
Let $R$ be a ring, $f \in R$ an element, $R_f \to A$ is a finite type ring map,
$g \in A$, and $K^\bullet$ a complex of $A$-modules.
If $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
relative to $R_f$, then $K^\bullet \otimes_A A_g$ is
$m$-pseudo-coherent (resp.\ pseudo-coherent) relative to $R$.
\end{lemma}

\begin{proof}
First we show that $K^\bullet$ is $m$-pseudo-coherent relative to $R$.
Namely, suppose $R_f[x_1, \ldots, x_n] \to A$ is surjective. Write
$R_f = R[x_0]/(fx_0 - 1)$. Then $R[x_0, x_1, \ldots, x_n] \to A$
is surjective, and $R_f[x_1, \ldots, x_n]$ is pseudo-coherent as
an $R[x_0, \ldots, x_n]$-module. Hence by
Lemma \ref{lemma-finite-push-pseudo-coherent}
we see that $K^\bullet$ is $m$-pseudo-coherent as a complex of
$R[x_0, x_1, \ldots, x_n]$-modules.

\medskip\noindent
Choose an element $g' \in R[x_0, x_1, \ldots, x_n]$ which maps to $g \in A$. By
Lemma \ref{lemma-pull-pseudo-coherent}
we see that
\begin{align*}
K^\bullet \otimes_{R[x_0, x_1, \ldots, x_n]}^{\mathbf{L}}
R[x_0, x_1, \ldots, x_n, \frac{1}{g'}] & =
K^\bullet \otimes_{R[x_0, x_1, \ldots, x_n]}
R[x_0, x_1, \ldots, x_n, \frac{1}{g'}] \\
& = K^\bullet \otimes_A A_f
\end{align*}
is $m$-pseudo-coherent as a complex of
$R[x_0, x_1, \ldots, x_n, \frac{1}{g'}]$-modules.
write
$$
R[x_0, x_1, \ldots, x_n, \frac{1}{g'}] =
R[x_0, \ldots, x_n, x_{n + 1}]/(x_{n + 1}g' - 1).
$$
As $R[x_0, x_1, \ldots, x_n, \frac{1}{g'}]$ is pseudo-coherent as a
$R[x_0, \ldots, x_n, x_{n + 1}]$-module we conclude (see
Lemma \ref{lemma-finite-push-pseudo-coherent})
that $K^\bullet \otimes_A A_g$ is $m$-pseudo-coherent as a complex of
$R[x_0, \ldots, x_n, x_{n + 1}]$-modules as desired.
\end{proof}

\begin{lemma}
\label{lemma-base-change-relative-pseudo-coherent}
Let $R \to A$ be a finite type ring map. Let $m \in \mathbf{Z}$.
Let $K^\bullet$ be a complex of $A$-modules which is $m$-pseudo-coherent
(resp.\ pseudo-coherent) relative to $R$. Let $R \to R'$ be a ring
map such that $A$ and $R'$ are Tor independent over $R$. Set
$A' = A \otimes_R R'$. Then
$K^\bullet \otimes_A^{\mathbf{L}} A'$ is
is $m$-pseudo-coherent (resp.\ pseudo-coherent) relative to $R'$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$.
Note that
$$
K^\bullet \otimes_A^{\mathbf{L}} A' =
K^\bullet \otimes_R^{\mathbf{L}} R' =
K^\bullet \otimes_{R[x_1, \ldots, x_n]}^{\mathbf{L}} R'[x_1, \ldots, x_n]
$$
by
Lemma \ref{lemma-base-change-comparison}
applied twice. Hence we win by
Lemma \ref{lemma-pull-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-pull-relative-pseudo-coherent}
Let $R \to A \to B$ be finite type ring maps.
Let $m \in \mathbf{Z}$.
Let $K^\bullet$ be a complex of $A$-modules.
Assume $B$ as a $B$-module is pseudo-coherent relative to $A$.
If $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
relative to $R$, then $K^\bullet \otimes_A^{\mathbf{L}} B$ is
$m$-pseudo-coherent (resp.\ pseudo-coherent) relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $A[y_1, \ldots, y_m] \to B$.
Choose a surjection $R[x_1, \ldots, x_n] \to A$.
Combined we get a surjection $R[x_1, \ldots, x_n, y_1, \ldots y_m] \to B$.
Choose a resolution $E^\bullet \to B$ of $B$ by a complex of
finite free $A[y_1, \ldots, y_n]$-modules (which is possible
by our assumption on the ring map $A \to B$). We may assume
that $K^\bullet$ is a bounded above complex of flat $A$-modules. Then
\begin{align*}
K^\bullet \otimes_A^{\mathbf{L}} B & =
\text{Tot}(K^\bullet \otimes_A B[0]) \\
& = \text{Tor}(K^\bullet \otimes_A A[y_1, \ldots, y_m]
\otimes_{A[y_1, \ldots, y_m]} B[0]) \\
& \cong
\text{Tot}\left(
(K^\bullet \otimes_A A[y_1, \ldots, y_m])
\otimes_{A[y_1, \ldots, y_m]} E^\bullet
\right) \\
& =
\text{Tot}(K^\bullet \otimes_A E^\bullet)
\end{align*}
in $D(A[y_1, \ldots, y_m])$. The quasi-isomorphism $\cong$ comes from
an application of
Lemma \ref{lemma-derived-tor-quasi-isomorphism}.
Thus we have to show that
$\text{Tot}(K^\bullet \otimes_A E^\bullet)$ is $m$-pseudo-coherent
as a complex of $R[x_1, \ldots, x_n, y_1, \ldots y_m]$-modules.
Note that $\text{Tot}(K^\bullet \otimes_A E^\bullet)$ has a filtration by
subcomplexes with successive quotients the complexes
$K^\bullet \otimes_A E^i[-i]$. Note that for $i \ll 0$ the
complexes $K^\bullet \otimes_A E^i[-i]$ have zero cohomology
in degrees $\leq m$ and hence are $m$-pseudo-coherent (over any ring).
Hence, applying
Lemma \ref{lemma-cone-relatively-pseudo-coherent}
and induction, it suffices to show that $K^\bullet \otimes_A E^i[-i]$ is
pseudo-coherent relative to $R$ for all $i$. Note that $E^i = 0$ for
$i > 0$. Since also $E^i$ is finite free this
reduces to proving that $K^\bullet \otimes_A A[y_1, \ldots, y_m]$ is
$m$-pseudo-coherent relative to $R$ which follows from
Lemma \ref{lemma-base-change-relative-pseudo-coherent}
for instance.
\end{proof}

\begin{lemma}
\label{lemma-pull-relative-pseudo-coherent-module}
Let $R \to A \to B$ be finite type ring maps.
Let $m \in \mathbf{Z}$. Let $M$ be an $A$-module.
Assume $B$ as a $B$-module is flat and pseudo-coherent relative to $A$.
If $M$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
relative to $R$, then $M \otimes_A B$ is
$m$-pseudo-coherent (resp.\ pseudo-coherent) relative to $R$.
\end{lemma}

\begin{proof}
Immediate from
Lemma \ref{lemma-pull-relative-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-composition-relative-pseudo-coherent}
Let $R$ be a ring. Let $A \to B$ be a map of finite type $R$-algebras.
Let $m \in \mathbf{Z}$. Let $K^\bullet$ be a complex of $B$-modules.
Assume $A$ is pseudo-coherent relative to $R$. Then the following are
equivalent
\begin{enumerate}
\item $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
relative to $A$, and
\item $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
relative to $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$.
Choose a surjection $A[y_1, \ldots, y_m] \to B$.
Then we get a surjection
$$
R[x_1, \ldots, x_n, y_1, \ldots, y_m] \to A[y_1, \ldots, y_m]
$$
which is a flat base change of $R[x_1, \ldots, x_n] \to A$.
By assumption $A$ is a pseudo-coherent module over $R[x_1, \ldots, x_n]$
hence by
Lemma \ref{lemma-flat-base-change-pseudo-coherent}
we see that $A[y_1, \ldots, y_m]$ is pseudo-coherent over
$R[x_1, \ldots, x_n, y_1, \ldots, y_m]$. Thus the lemma follows from
Lemma \ref{lemma-finite-push-pseudo-coherent}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-glue-relative-pseudo-coherent}
Let $R \to A$ be a finite type ring map.
Let $K^\bullet$ be a complex of $A$-modules.
Let $m \in \mathbf{Z}$.
Let $f_1, \ldots, f_r \in A$ generate the unit ideal.
The following are equivalent
\begin{enumerate}
\item each $K^\bullet \otimes_A A_{f_i}$ is
$m$-pseudo-coherent relative to $R$, and
\item $K^\bullet$ is $m$-pseudo-coherent relative to $R$.
\end{enumerate}
The same equivalence holds for pseudo-coherence.
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) is in
Lemma \ref{lemma-localize-relative-pseudo-coherent}.
Assume (1). Write $1 = \sum f_ig_i$ in $A$.
Choose a surjection
$R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r] \to A$.
such that $y_i$ maps to $f_i$ and $z_i$ maps to $g_i$. Then we
see that there exists a surjection
$$
P = R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r]/(\sum y_iz_i - 1)
\longrightarrow
A.
$$
Note that $P$ is pseudo-coherent as an
$R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r]$-module
and that $P[1/y_i]$ is pseudo-coherent as an
$R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r, 1/y_i]$-module.
Hence by
Lemma \ref{lemma-finite-push-pseudo-coherent}
we see that
$K^\bullet \otimes_A A_{f_i}$ is an $m$-pseudo-coherent complex
of $P[1/y_i]$-modules for each $i$.
Thus by
Lemma \ref{lemma-glue-pseudo-coherent}
we see that $K^\bullet$ is pseudo-coherent as a complex of
$P$-modules, and
Lemma \ref{lemma-finite-push-pseudo-coherent}
shows that  $K^\bullet$ is pseudo-coherent as a complex of
$R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r]$-modules.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-relative-pseudo-coherent}
Let $R$ be a Noetherian ring. Let $R \to A$ be a finite type ring map. Then
\begin{enumerate}
\item A complex of $A$-modules $K^\bullet$ is $m$-pseudo-coherent
relative to $R$ if and only if $K^\bullet \in D^{-}(A)$ and
$H^i(K^\bullet)$ is a finite $A$-module for $i \geq m$.
\item A complex of $A$-modules $K^\bullet$ is pseudo-coherent relative to $R$
if and only if $K^\bullet \in D^{-}(A)$ and
$H^i(K^\bullet)$ is a finite $A$-module for all $i$.
\item An $A$-module is pseudo-coherent relative to $R$
if and only if it is finite.
\end{enumerate}
\end{lemma}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-Noetherian-pseudo-coherent}
and the definitions.
\end{proof}










\section{Pseudo-coherent and perfect ring maps}
\label{section-pseudo-coherent-perfect-ring-map}

\noindent
We can define these types of ring maps as follows.

\begin{definition}
\label{definition-pseudo-coherent-perfect}
Let $A \to B$ be a ring map.
\begin{enumerate}
\item We say $A \to B$ is a {\it pseudo-coherent ring map} if it is of finite
type and $B$, as a $B$-module, is pseudo-coherent relative to $A$.
\item We say $A \to B$ is a {\it perfect ring map} if it is a
pseudo-coherent ring map such that $B$ as an $A$-module has finite
tor dimension.
\end{enumerate}
\end{definition}

\noindent
This terminology may be nonstandard. Using
Lemma \ref{lemma-rel-n-pseudo-module}
we see that $A \to B$ is pseudo-coherent if and only if
$B = A[x_1, \ldots, x_n]/I$ and $B$ as an $A[x_1, \ldots, x_n]$-module
has a resolution by finite free $A[x_1, \ldots, x_n]$-modules.
The motivation for the definition of a perfect ring map is
Lemma \ref{lemma-perfect}.
The following lemmas gives a more useful and intuitive
characterization of a perfect ring map.

\begin{lemma}
\label{lemma-perfect-ring-map}
A ring map $A \to B$ is perfect if and only if $B = A[x_1, \ldots, x_n]/I$
and $B$ as an $A[x_1, \ldots, x_n]$-module has a finite resolution by
finite projective $A[x_1, \ldots, x_n]$-modules.
\end{lemma}

\begin{proof}
If $A \to B$ is perfect, then $B = A[x_1, \ldots, x_n]/I$ and
$B$ is pseudo-coherent as an $A[x_1, \ldots, x_n]$-module and
has finite tor dimension as an $A$-module. Hence
Lemma \ref{lemma-perfect-over-polynomial-ring}
implies that $B$ is perfect as a $A[x_1, \ldots, x_n]$-module, i.e.,
it has a finite resolution by finite projective $A[x_1, \ldots, x_n]$-modules
(Lemma \ref{lemma-perfect-module}).
Conversely, if $B = A[x_1, \ldots, x_n]/I$
and $B$ as an $A[x_1, \ldots, x_n]$-module has a finite resolution by
finite projective $A[x_1, \ldots, x_n]$-modules then
$B$ is pseudo-coherent as an $A[x_1, \ldots, x_n]$-module,
hence $A \to B$ is pseudo-coherent. Moreover, the given resolution
over $A[x_1, \ldots, x_n]$ is a finite resolution by flat
$A$-modules and hence $B$ has finite tor dimension as an $A$-module.
\end{proof}

\noindent
Lots of the results of the preceding sections can be reformulated
in terms of this terminology. We  also refer to
More on Morphisms, Sections \ref{more-morphisms-section-pseudo-coherent}
and \ref{more-morphisms-section-perfect}
for the corresponding discussion concerning morphisms of schemes.

\begin{lemma}
\label{lemma-Noetherian-pseudo-coherent-ring-map}
A finite type ring map of Noetherian rings is pseudo-coherent.
\end{lemma}

\begin{proof}
See
Lemma \ref{lemma-Noetherian-relative-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-perfect}
A ring map which is flat and of finite presentation is perfect.
\end{lemma}

\begin{proof}
Let $A \to B$ be a ring map which is flat and of finite presentation.
It is clear that $B$ has finite tor dimension. By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
there exists a finite type $\mathbf{Z}$-algebra $A_0 \subset A$
and a flat finite type ring map $A_0 \to B_0$ such that
$B = B_0 \otimes_{A_0} A$. By
Lemma \ref{lemma-Noetherian-relative-pseudo-coherent}
we see that $A_0 \to B_0$ is pseudo-coherent.
As $A_0 \to B_0$ is flat we see that $B_0$ and $A$ are tor independent
over $A_0$, hence we may use
Lemma \ref{lemma-base-change-relative-pseudo-coherent}
to conclude that $A \to B$ is pseudo-coherent.
\end{proof}

\begin{lemma}
\label{lemma-regular-perfect-ring-map}
Let $A \to B$ be a finite type ring map with $A$ a regular ring
of finite dimension. Then $A \to B$ is perfect.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-finite-gl-dim-finite-dim-regular}
the assumption on $A$ means that $A$ has finite global dimension.
Hence every module has finite tor dimension, see
Lemma \ref{lemma-finite-gl-dim-tor-dimension},
in particular $B$ does. By
Lemma \ref{lemma-Noetherian-pseudo-coherent-ring-map}
the map is pseudo-coherent.
\end{proof}

\begin{lemma}
\label{lemma-lci-perfect}
A local complete intersection homomorphism is perfect.
\end{lemma}

\begin{proof}
Let $A \to B$ he a local complete intersection homomorphism.
By Definition \ref{definition-local-complete-intersection} this
means that $B = A[x_1, \ldots, x_n]/I$ where $I$ is a Koszul ideal
in $A[x_1, \ldots, x_n]$. 
By Lemmas \ref{lemma-perfect-ring-map} and \ref{lemma-perfect-module}
it suffices to show that $I$ is a perfect module over $A[x_1, \ldots, x_n]$.
By Lemma \ref{lemma-glue-perfect} this is a local question. Hence we
may assume that $I$ is generated by a Koszul-regular sequence (by
Definition \ref{definition-regular-ideal}).
Of course this means that $I$ has a finite free resolution and we win.
\end{proof}







\section{Rlim of abelian groups and modules}
\label{section-Rlim}

\noindent
We briefly discuss $R\lim$ on abelian groups and modules.
In this section we will denote $\textit{Ab}(\mathbf{N})$ the
abelian category of inverse systems of abelian groups.
This makes sense as an inverse system of abelian groups is
the same thing as a sheaf of groups on the category $\mathbf{N}$
(with a unique morphism $i \to j$ if $i \leq j$), see
Remark \ref{remark-Rlim-cohomology}. Many of the arguments in this
section duplicate the arguments used to construct the cohomological
machinery for modules on ringed sites.

\begin{lemma}
\label{lemma-compute-Rlim}
The functor $\lim : \textit{Ab}(\mathbf{N}) \to \textit{Ab}$
has a right derived functor
\begin{equation}
\label{equation-Rlim}
R\lim : D(\textit{Ab}(\mathbf{N})) \longrightarrow D(\textit{Ab})
\end{equation}
As usual we set $R^p\lim(K) = H^p(R\lim(K))$. Moreover, we have
\begin{enumerate}
\item for any $(A_n)$ in $\textit{Ab}(\mathbf{N})$ we have
$R^p\lim A_n = 0$ for $p > 1$,
\item the object $R\lim A_n$ of $D(\textit{Ab})$ is represented
by the complex
$$
\prod A_n \to \prod A_n,\quad (x_n) \mapsto (x_n - f_{n + 1}(x_{n + 1}))
$$
sitting in degrees $0$ and $1$,
\item if $(A_n)$ is ML, then $R^1\lim A_n = 0$, i.e., $(A_n)$
is right acyclic for $\lim$,
\item every $K^\bullet \in D(\textit{Ab}(\mathbf{N}))$ is quasi-isomorphic
to a complex whose terms are right acyclic for $\lim$, and
\item if each $K^p = (K^p_n)$ is right acyclic for $\lim$, i.e.,
of $R^1\lim_n K^p_n = 0$, then $R\lim K$ is represented by the
complex whose term in degree $p$ is $\lim_n K_n^p$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $(A_n)$ be an arbitrary inverse system. Let $(B_n)$ be the inverse
system with
$$
B_n = A_n \oplus A_{n - 1} \oplus \ldots \oplus A_1
$$
and transition maps given by projections. Let $A_n \to B_n$ be given
by $(1, f_n, f_{n - 1} \circ f_n, \ldots, f_2 \circ \ldots \circ f_n$
where $f_i : A_i \to A_{i - 1}$ are the transition maps.
In this way we see that every inverse system is a subobject of a
ML system (Homology, Section \ref{homology-section-inverse-systems}).
It follows from
Derived Categories, Lemma \ref{derived-lemma-subcategory-right-acyclics}
using Homology, Lemma \ref{homology-lemma-Mittag-Leffler}
that every ML system is right acyclic for $\lim$, i.e., (3) holds.
This already implies that $RF$ is defined on $D^+(\textit{Ab}(\mathbf{N}))$,
see Derived Categories, Proposition \ref{derived-proposition-enough-acyclics}.
Set $C_n = A_{n - 1} \oplus \ldots \oplus A_1$ for $n > 1$ and
$C_1 = 0$ with transition maps given by projections as well.
Then there is a short exact sequence of inverse systems
$0 \to (A_n) \to (B_n) \to (C_n) \to 0$ where $B_n \to C_n$
is given by $(x_i) \mapsto (x_i - f_{i + 1}(x_{i + 1}))$.
Since $(C_n)$ is ML as well, we conclude that (2) holds
(by proposition reference above) which also implies (1).
Finally, this implies by Derived Categories, Lemma
\ref{derived-lemma-unbounded-right-derived}
that $R\lim$ is in fact defined on all of $D(\textit{Ab}(\mathbf{N}))$.
In fact, the proof of Derived Categories, Lemma
\ref{derived-lemma-unbounded-right-derived}
proceeds by proving assertions (4) and (5).
\end{proof}

\noindent
We give two simple applications. The first is the ``correct'' formulation of
Homology, Lemma \ref{homology-lemma-apply-Mittag-Leffler-again}.

\begin{lemma}
\label{lemma-apply-Mittag-Leffler-again}
Let
$$
(A^{-2}_n \to A^{-1}_n \to A^0_n \to A^1_n)
$$
be an inverse system of complexes of abelian groups and denote
$A^{-2} \to A^{-1} \to A^0 \to A^1$ its limit. Denote
$(H_n^{-1})$, $(H_n^0)$ the inverse systems of cohomologies, and
denote $H^{-1}$, $H^0$ the cohomologies of $A^{-2} \to A^{-1} \to A^0 \to A^1$.
If
\begin{enumerate}
\item $(A^{-2}_n)$ and $(A^{-1}_n)$ have vanishing $R^1\lim$,
\item $(H^{-1}_n)$ has vanishing $R^1\lim$,
\end{enumerate}
then $H^0 = \lim H_i^0$.
\end{lemma}

\begin{proof}
Let $K \in D(\textit{Ab}(\mathbf{N}))$ be the object represented
by the system of complexes whose $n$th constituent
is the complex $A^{-2}_n \to A^{-1}_n \to A^0_n \to A^1_n$.
We will compute $H^0(R\lim K)$ using both spectral
sequences\footnote{To use these spectral sequences we have to
show that $\textit{Ab}(\mathbf{N})$ has enough injectives.
A inverse system $(I_n)$ of abelian groups is injective if and only
if each $I_n$ is an injective abelian group and the transition maps are
split surjections. Every system embeds in one of these. Details omitted.} of
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
The first has $E_1$-page
$$
\begin{matrix}
0 & 0 & R^1\lim A^0_n  & R^1\lim A^1_n \\
A^{-2} & A^{-1} & A^0  & A^1
\end{matrix}
$$
with horizontal differentials and all higher differentials are zero.
The second has $E_2$ page
$$
\begin{matrix}
R^1\lim H^{-2}_n & 0 & R^1\lim H^0_n & R^1 \lim H^1_n \\
\lim H^{-2}_n &
\lim H^{-1}_n &
\lim H^0_n &
\lim H^1_n
\end{matrix}
$$
and degenerates at this point. The result follows.
\end{proof}

\begin{lemma}
\label{lemma-map-into-Rlim}
Let $\mathcal{D}$ be a triangulated category. Let
$(K_n)$ be an inverse system of objects of $\mathcal{D}$.
Let $K$ be a derived limit of the system $(K_n)$.
Then for every $L$ in $\mathcal{D}$ we have short exact sequences
$$
0 \to R^1\lim \Hom_\mathcal{D}(L, K_n[1]) \to
\Hom_\mathcal{D}(L, K) \to
\lim \Hom_\mathcal{D}(L, K_n) \to 0
$$
\end{lemma}

\begin{proof}
This follows from
Derived Categories, Definition \ref{derived-definition-derived-limit} and
Lemma \ref{derived-lemma-representable-homological},
and the description of $\lim$ and $R^1\lim$ in
Lemma \ref{lemma-compute-Rlim} above.
\end{proof}

\begin{remark}[Rlim as cohomology]
\label{remark-Rlim-cohomology}
Consider the category $\mathbf{N}$ whose objects are natural numbers and
whose morphisms are unique arrows $i \to j$ if $j \geq i$. Endow $\mathbf{N}$
with the chaotic topology (Sites, Example \ref{sites-example-indiscrete}) so
that a sheaf $\mathcal{F}$ is the same thing as an inverse system
$$
\mathcal{F}_1 \leftarrow \mathcal{F}_2 \leftarrow \mathcal{F}_3
\leftarrow \ldots
$$
of sets over $\mathbf{N}$. Note that
$\Gamma(\mathbf{N}, \mathcal{F}) = \lim \mathcal{F}_n$. For an inverse
system of abelian groups $\mathcal{F}_n$ we have
$$
R^p\lim \mathcal{F}_n = H^p(\mathbf{N}, \mathcal{F})
$$
because both sides are the higher right derived functors of
$\mathcal{F} \mapsto \lim \mathcal{F}_n = H^0(\mathbf{N}, \mathcal{F})$.
Thus the existence of $R\lim$ also follows from the general material in
Cohomology on Sites, Sections
\ref{sites-cohomology-section-cohomology-sheaves} and
\ref{sites-cohomology-section-unbounded}.
\end{remark}

\noindent
{\bf Warning.} An object of $D(\textit{Ab}(\mathbf{N}))$ is a complex of
inverse systems of abelian groups. You can also think of this as an inverse
system $(K_n^\bullet)$ of complexes. However, this is {\bf not} the
same thing as an inverse system of objects of $D(\textit{Ab})$; we
will come back and explain the difference later.

\medskip\noindent
The products in the following lemma can be seen as termwise products
of complexes or as products in the derived category $D(\textit{Ab})$, see
Derived Categories, Lemma \ref{derived-lemma-product-derived-Ab4*}.
This lemma in particular shows the notation in this section is
compatible with the notation introduced in
Derived Categories, Section \ref{derived-section-derived-limit}.
See Remark \ref{remark-compare-derived-limit} for more explanation.

\begin{lemma}
\label{lemma-distinguished-triangle-Rlim}
Let $K = (K_n^\bullet)$ be an object of $D(\textit{Ab}(\mathbf{N}))$.
There exists a canonical distinguished triangle
$$
R\lim K \to \prod\nolimits_n K_n^\bullet \to \prod\nolimits_n K_n^\bullet
\to R\lim K[1]
$$
in $D(\textit{Ab})$ where the middle map fits into the commutative diagrams
$$
\xymatrix{
\prod\nolimits_n K_n^\bullet \ar[r] \ar[d] & 
\prod\nolimits_n K_n^\bullet \ar[d] \\
K_n^\bullet \oplus K_{n + 1}^\bullet \ar[r]^{1 - \pi} &
K_n^\bullet
}
$$
whose vertical maps are projections and where
$\pi : K_{n + 1}^\bullet \to K_n^\bullet$ is the transition map of the system.
\end{lemma}

\begin{proof}
Suppose that for each $p$ the inverse system $(K_n^p)$ is right
acyclic for $\lim$. By Lemma \ref{lemma-compute-Rlim}
this gives a short exact sequence
$$
0 \to \lim_n K^p_n \to \prod\nolimits_n K^p_n \to \prod\nolimits_n K^p_n \to 0
$$
for each $p$. Since the complex consisting of $\lim_n K^p_n$
computes $R\lim K$ by Lemma \ref{lemma-compute-Rlim} we see that the
lemma holds in this case.

\medskip\noindent
Next, assume $K = (K_n^\bullet)$ is general. By Lemma \ref{lemma-compute-Rlim}
there is a quasi-isomorphism $K \to L$ in $D(\textit{Ab}(\mathbf{N}))$
such that $(L_n^p)$ is acyclic for each $p$. Then $\prod K_n^\bullet$
is quasi-isomorphic to $\prod L_n^\bullet$ as products are exact in
$\textit{Ab}$, whence the result for $L$ (proved above) implies the
result for $K$.
\end{proof}

\begin{lemma}
\label{lemma-break-long-exact-sequence}
With notation as in Lemma \ref{lemma-distinguished-triangle-Rlim}
the long exact cohomology sequence associated to the distinguished
triangle breaks up into short exact sequences
$$
0 \to R^1\lim_n H^{p - 1}(K_n^\bullet) \to
H^p(R\lim K) \to
\lim_n H^p(K_n^\bullet) \to 0
$$
\end{lemma}

\begin{proof}
The long exact sequence of the distinguished triangle is
$$
\ldots \to H^p(R\lim K) \to \prod\nolimits_n H^p(K_n^\bullet)
\to \prod\nolimits_n H^p(K_n^\bullet) \to
H^{p + 1}(R\lim K) \to \ldots
$$
The map in the middle has kernel $\lim_n H^p(K_n^\bullet)$ by its
explict description given in the lemma.
The cokernel of this map is $R^1\lim_n H^p(K_n^\bullet)$
by Lemma \ref{lemma-compute-Rlim}.
\end{proof}

\begin{lemma}
\label{lemma-Rlim-pro-equal}
Let $E \to D$ be a morphism of $D(\textit{Ab}(\mathbf{N}))$.
Let $(E_n)$, resp.\ $(D_n)$ be the system of objects of
$D(\textit{Ab})$ associated to $E$, resp.\ $D$.
If $(E_n) \to (D_n)$ is an isomorphism of pro-objects, then
$R\lim E \to R\lim D$ is an isomorphism in $D(\textit{Ab})$.
\end{lemma}

\begin{proof}
The assumption in particular implies that the pro-objects
$H^p(E_n)$ and $H^p(D_n)$ are isomorphic. By the short exact sequences of
Lemma \ref{lemma-break-long-exact-sequence}
it suffices to show that given a map $(A_n) \to (B_n)$ of inverse
systems of abelian groupsc which induces an isomorphism
of pro-objects, then $\lim A_n \cong \lim B_n$ and
$R^1\lim A_n \cong R^1\lim B_n$.

\medskip\noindent
The assumption implies there are $1 \leq m_1 < m_2 < m_3 < \ldots$
and maps $\varphi_n : B_{m_n} \to A_n$ such that
$(\varphi_n) : (B_{m_n}) \to (A_n)$ is a map of systems
which is inverse to the given map $\psi = (\psi_n) : (A_n) \to (B_n)$
as a morphism of pro-objects. What this means is that
(after possibly replacing $m_n$ by larger integers) we may
assume that the compositions $A_{m_n} \to B_{m_n} \to A_n$ and
$B_{m_n} \to A_n \to B_n$ are equal to the transition maps
of the inverse systems. Now, if $(b_n) \in \lim B_n$ we can set
$a_n = \varphi_{m_n}(b_{m_n})$. This defines an inverse
$\lim B_n \to \lim A_n$ (computation omitted). Let us use the
cokernel of the map
$$
\prod B_n \longrightarrow \prod B_n
$$
as an avatar of $R^1\lim B_n$ (Lemma \ref{lemma-compute-Rlim}).
Any element in this cokernel can be represented by an element
$(b_i)$ with $b_i = 0$ if $i \not = m_n$ for some $n$ (computation omitted).
We can define a map $R^1\lim B_n \to R^1\lim A_n$ by mapping the class
of such a special element $(b_n)$ to the class of $(\varphi_n(b_{m_n}))$.
We omit the verification this map is inverse to the map
$R^1\lim A_n \to R^1\lim B_n$.
\end{proof}

\begin{lemma}
\label{lemma-Rlim-zero-of-direct-sums}
Let $(A_n)$ be an inverse system of abelian groups.
The following are equivalent
\begin{enumerate}
\item $(A_n)$ is zero as a pro-object,
\item $\lim A_n = 0$ and $R^1\lim A_n = 0$ and
the same holds for $\bigoplus_{i \in \mathbf{N}} (A_n)$.
\end{enumerate}
\end{lemma}

\begin{proof}
It follows from Lemma \ref{lemma-Rlim-pro-equal} that (1) implies (2).
For $m \geq n$ let $A_{n, m} = \text{Im}(A_m \to A_n)$
so that $A_n = A_{n, n} \supset A_{n, n + 1} \supset \ldots$.
Note that $(A_n)$ is zero as a pro-object if and only if for every
$n$ there is an $m \geq n$ such that $A_{n, m} = 0$.
Note that $(A_n)$ is ML if and only if for every $n$ there is an $m_n \geq n$
such that $A_{n, m} = A_{n, m + 1} = \ldots$. In the ML case it is
clear that $\lim A_n = 0$ implies that $A_{n, m_n} = 0$
because the maps $A_{n + 1, m_{n + 1}} \to A_{n, m}$ are surjective.

\medskip\noindent
Assume $(A_n)$ is not zero as a pro-object and not ML.
Then we can pick an $n$ and a sequence
of integers $n < m_1 < m_2 < \ldots$ and elements
$x_i \in A_{m_i}$ whose image $y_i \in A_n$ is not in $A_{n, m_i + 1}$.
Set $B_n = \bigoplus_{i \in \mathbf{N}} A_n$.
Let $\xi = (\xi_n) \in \prod B_n$ be the element with
$\xi_n = 0$ unless $n = m_i$ and $\xi_{m_i} = (0, \ldots, 0, x_i, 0, \ldots)$
with $x_i$ placed in the $i$th summand. We claim that $\xi$ is not in the
image of the map $\prod B_n \to \prod B_n$ of Lemma \ref{lemma-compute-Rlim}.
This shows that $R^1\lim B_n$ is nonzero and finishes the proof.
Namely, suppose that $\xi$ is the image of $\eta = (z_1, z_2, \ldots)$
with $z_n = \sum z_{n, i} \in \bigoplus_i A_n$.
Observe that $x_i = z_{m_i, i} \bmod A_{m_i, m_i + 1}$.
Then $z_{m_i - 1, i}$ is the image of $z_{m_i, i}$ under
$A_{m_i} \to A_{m_i - 1}$, and so on, and we conclude that
$z_{n, i}$ is the image of $z_{m_i, i}$ under $A_{m_i} \to A_n$.
We conclude that $z_{n, i}$ is congruent to $y_i$ modulo
$A_{n, m_i + 1}$. In particular $z_{n, i} \not = 0$.
This is impossible as $\sum z_{n, i} \in \bigoplus_i A_n$
hence only a finite number of $z_{n, i}$ can be nonzero.
\end{proof}

\noindent
Let $(A_n)$ be an inverse system of rings. We will denote
$\textit{Mod}(\mathbf{N}, (A_n))$ the category of inverse systems
$(M_n)$ of abelian groups such that each $M_n$ is given the
structure of a $A_n$-module and the transition maps
$M_{n + 1} \to M_n$ are $A_{n + 1}$-module maps.
This is an abelian category. Set $A = \lim A_n$.
Given an object $(M_n)$ of $\textit{Mod}(\mathbf{N}, (A_n))$
the limit $\lim M_n$ is an $A$-module.

\begin{lemma}
\label{lemma-compute-Rlim-modules}
In the situation above. The functor
$\lim : \textit{Mod}(\mathbf{N}, (A_n)) \to \text{Mod}_A$
has a right derived functor
$$
R\lim :
D(\textit{Mod}(\mathbf{N}, (A_n)))
\longrightarrow
D(A)
$$
As usual we set $R^p\lim(K) = H^p(R\lim(K))$. Moreover, we have
\begin{enumerate}
\item for any $(A_n)$ in $\textit{Mod}(\mathbf{N}, (A_n))$ we have
$R^p\lim A_n = 0$ for $p > 1$,
\item the object $R\lim A_n$ of $D(\text{Mod}_A)$ is represented
by the complex
$$
\prod A_n \to \prod A_n,\quad (x_n) \mapsto (x_n - f_{n + 1}(x_{n + 1}))
$$
sitting in degrees $0$ and $1$,
\item if $(A_n)$ is ML, then $R^1\lim A_n = 0$, i.e., $(A_n)$
is right acyclic for $\lim$,
\item every $K^\bullet \in D(\textit{Mod}(\mathbf{N}, (A_n)))$
is quasi-isomorphic to a complex whose terms are right acyclic for $\lim$, and
\item if each $K^p = (K^p_n)$ is right acyclic for $\lim$, i.e.,
of $R^1\lim_n K^p_n = 0$, then $R\lim K$ is represented by the
complex whose term in degree $p$ is $\lim_n K_n^p$.
\end{enumerate}
\end{lemma}

\begin{proof}
The proof of this is word for word the same as the proof of
Lemma \ref{lemma-compute-Rlim}.
\end{proof}

\begin{remark}
\label{remark-Rlim-cohomology-modules}
This remark is a continuation of Remark \ref{remark-Rlim-cohomology}.
A sheaf of rings on $\mathbf{N}$ is just an inverse system of rings
$(A_n)$. A sheaf of modules over $(A_n)$ is exactly the same thing
as an object of the category $\textit{Mod}(\mathbf{N}, (A_n))$
defined above. The derived functor $R\lim$ of
Lemma \ref{lemma-compute-Rlim-modules}
is simply $R\Gamma(\mathbf{N}, -)$ from the derived category of
modules to the derived category of modules over the global sections
of the structure sheaf.
is true in general that cohomology of groups and modules agree, see
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-cohomology-modules-abelian-agree}.
\end{remark}

\begin{lemma}
\label{lemma-get-ML-system}
Let $(A_n)$ be an inverse system of rings. Every
$K \in D(\textit{Mod}(\mathbf{N}, (A_n)))$
can be represented by a system of complexes $(M_n^\bullet)$
such that all the transition maps $M_{n + 1}^\bullet \to M_n^\bullet$
are surjective.
\end{lemma}

\begin{proof}
Let $K$ be represented by the system $(K_n^\bullet)$. Set
$M_1^\bullet = K_1^\bullet$. Suppose we have constructed surjective maps
of complexes $M_n^\bullet \to M_{n - 1}^\bullet \to \ldots \to M_1^\bullet$
and homotopy equivalences $\psi_e : K_e^\bullet \to M_e^\bullet$ such that
the diagrams
$$
\xymatrix{
K_{e + 1}^\bullet \ar[d] \ar[r] & K_e^\bullet \ar[d] \\
M_{e + 1}^\bullet \ar[r] & M_e^\bullet
}
$$
commute for all $e < n$. Then we consider the diagram
$$
\xymatrix{
K_{n + 1}^\bullet \ar[r] & K_n^\bullet \ar[d] \\
& M_n^\bullet
}
$$
By Derived Categories, Lemma \ref{derived-lemma-make-surjective}
we can factor the composition $K_{n + 1}^\bullet \to M_n^\bullet$ as
$K_{n + 1}^\bullet \to M_{n + 1}^\bullet \to M_n^\bullet$
such that the first arrow is a homotopy equivalence and the
second a termwise split surjection. The lemma follows
from this and induction.
\end{proof}

\begin{lemma}
\label{lemma-get-K-flat-system}
Let $(A_n)$ be an inverse system of rings. Every
$K \in D(\textit{Mod}(\mathbf{N}, (A_n)))$
can be represented by a system of complexes $(K_n^\bullet)$
such that each $K_n^\bullet$ is K-flat.
\end{lemma}

\begin{proof}
First use Lemma \ref{lemma-get-ML-system} to represent $K$ by a
system of complexes $(M_n^\bullet)$ such that all the transition maps
$M_{n + 1}^\bullet \to M_n^\bullet$ are surjective.
Next, let $K_1^\bullet \to M_1^\bullet$ be a quasi-isomorphism
with $K_1^\bullet$ a K-flat complex of $A_1$-modules
(Lemma \ref{lemma-K-flat-resolution}).
Suppose we have constructed
$K_n^\bullet \to K_{n - 1}^\bullet \to \ldots \to K_1^\bullet$
and maps of complexes $\psi_e : K_e^\bullet \to M_e^\bullet$ such that
$$
\xymatrix{
K_{e + 1}^\bullet \ar[d] \ar[r] & K_e^\bullet \ar[d] \\
M_{e + 1}^\bullet \ar[r] & M_e^\bullet
}
$$
commutes for all $e < n$. Then we consider the diagram
$$
\xymatrix{
C^\bullet \ar@{..>}[d] \ar@{..>}[r] & K_n^\bullet \ar[d]^{\psi_n} \\
M_{n + 1}^\bullet \ar[r]^{\varphi_n} & M_n^\bullet
}
$$
in $D(A_{n + 1})$. As $M_{n + 1}^\bullet \to M_n^\bullet$ is
termwise surjective, the complex $C^\bullet$ fitting into the left
upper corner with terms
$$
C^p = M_{n + 1}^p \times_{M_n^p} K_n^p
$$
is quasi-isomorphic to $M_{n + 1}^\bullet$ (details omitted).
Choose a quasi-isomorphism $K_{n + 1}^\bullet \to C^\bullet$
with $K_{n +1}^\bullet$ K-flat.
Thus the lemma holds by induction.
\end{proof}

\begin{lemma}
\label{lemma-derived-tensor-product-systems}
Let $(A_n)$ be an inverse system of rings. Given
$K, L \in D(\textit{Mod}(\mathbf{N}, (A_n)))$ there is a canonical derived
tensor product $K \otimes^\mathbf{L} L$ in $D(\mathbf{N}, (A_n))$
compatible with the maps to $D(A_n)$. The construction is symmetric
in $K$ and $L$ and an exact functor of triangulated categories in
each variable.
\end{lemma}

\begin{proof}
Choose a representive $(K_n^\bullet)$ for $K$ such that each $K_n^\bullet$
is a K-flat complex (Lemma \ref{lemma-get-K-flat-system}).
Then you can define $K \otimes^\mathbf{L} L$ as the object represented by
the system of complexes
$$
(\text{Tot}(K_n^\bullet \otimes_{A_n} L_n^\bullet))
$$
for any choice of representative $(L_n^\bullet)$ for $L$.
This is well defined in both variables by
Lemmas \ref{lemma-K-flat-quasi-isomorphism} and
\ref{lemma-derived-tor-quasi-isomorphism-other-side}.
Compatibility with the map to $D(A_n)$ is clear.
Exactness follows exactly as in
Lemma \ref{lemma-derived-tor-exact}.
\end{proof}

\noindent
As in the case of abelian groups an object $M = (M_n^\bullet)$ of
$D(\textit{Mod}(\mathbf{N}, (A_n)))$ is an inverse system of complexes
of modules, which is {\bf not} the same thing as an inverse system of
objects in the derived categories. In the following lemma we show
how an inverse system of objects in derived categories always lifts
to an object of $D(\textit{Mod}(\mathbf{N}, (A_n)))$.

\begin{lemma}
\label{lemma-lift-to-system-complexes}
Let $(A_n)$ be an inverse system of rings. Suppose that we are given
\begin{enumerate}
\item for every $n$ an object $K_n^\bullet$ of $D(A_n)$, and
\item for every $n$ a map $\varphi_n : K_{n + 1}^\bullet \to K^\bullet_n$ of
$D(A_{n + 1})$ where we think of $K_n^\bullet$ as an object of $D(A_{n + 1})$
by restriction via the restriction map $A_{n + 1} \to A_n$.
\end{enumerate}
There exists an object
$M = (M_n^\bullet) \in D(\textit{Mod}(\mathbf{N}, (A_n)))$
and isomorphisms $\psi_n : M_n^\bullet \to K_n^\bullet$ in $D(A_n)$
such that the diagrams
$$
\xymatrix{
M_{n + 1}^\bullet \ar[d]_{\psi_{n + 1}} \ar[r] &
M_n^\bullet \ar[d]^{\psi_n} \\
K_n^\bullet \ar[r]^{\varphi_n} & K_n^\bullet
}
$$
commute in $D(A_{n + 1})$.
\end{lemma}

\begin{proof}
Namely, set $M_1^\bullet = K_1^\bullet$. Suppose
we have constructed
$M_n^\bullet \to M_{n - 1}^\bullet \to \ldots \to M_1^\bullet$
and maps of complexes $\psi_e : M_e^\bullet \to K_e^\bullet$ such that
the diagrams above commute for all $e < n$. Then we consider the diagram
$$
\xymatrix{
& M_n^\bullet \ar[d]^{\psi_n} \\
K_{n + 1}^\bullet \ar[r]^{\varphi_n} & K_n^\bullet
}
$$
in $D(A_{n + 1})$. By the definition of morphisms in $D(A_{n + 1})$ we can
find a quasi-isomorphism
$\psi_{n + 1} : M_{n + 1}^\bullet \to K_{n + 1}^\bullet$
of complexes of $A_{n + 1}$-modules such that there exists a morphism
of complexes $M_{n + 1}^\bullet \to M_n^\bullet$ of $A_{n + 1}$-modules
representing the composition 
$\psi_n^{-1} \circ \varphi_n \circ \psi_{n + 1}$ in $D(A_{n + 1})$.
Thus the lemma holds by induction.
\end{proof}

\begin{remark}
\label{remark-how-unique}
With assumptions as in Lemma \ref{lemma-lift-to-system-complexes}.
A priori there are many isomorphism classes of objects $M$ of
$D(\textit{Mod}(\mathbf{N}, (A_n)))$ which give rise to the system
$(K_n^\bullet, \varphi_n)$ as above. For each such $M$ we can consider the
complex $R\lim M \in D(A)$ where $A = \lim A_n$. By
Lemma \ref{lemma-distinguished-triangle-Rlim}
there exists a canonical distinguished triangle
$$
R\lim M \to \prod\nolimits_n K_n^\bullet \to \prod\nolimits_n K_n^\bullet
\to R\lim M[1]
$$
in $D(A)$. Hence we see that the isomorphism class of $R\lim M$ in
$D(A)$ is independent of the choices made in constructing $M$, by
axiom TR3 of triangulated categories and
Derived Categories, Lemma \ref{derived-lemma-third-isomorphism-triangle}.
\end{remark}

\begin{remark}
\label{remark-compare-derived-limit}
Let $(K_n)$ be an inverse system of objects of $D(\textit{Ab})$.
Let $K = R\lim K_n$ be a derived limit of this system (see
Derived Categories, Section \ref{derived-section-derived-limit}). Such
a derived limit exists because $D(\textit{Ab})$ has countable products
(Derived Categories, Lemma \ref{derived-lemma-product-derived-Ab4*}).
By Lemma \ref{lemma-lift-to-system-complexes} we can also lift
$(K_n)$ to an object $M$ of $D(\mathbf{N})$.
Then $K \cong R\lim M$ where $R\lim$ is the functor (\ref{equation-Rlim})
because $R\lim M$ is also a derived limit of the system $(K_n)$
(by Lemma \ref{lemma-distinguished-triangle-Rlim})
and derived limits are unique up to isomorphism. In particular
for every $p \in \mathbf{Z}$ there is a canonical short exact sequence
$$
0 \to R^1\lim H^{p - 1}(K_n) \to H^p(K) \to \lim H^p(K_n) \to 0
$$
as follows from Lemma \ref{lemma-distinguished-triangle-Rlim} for $M$.
This can also been seen directly, without invoking the existence of $M$,
by applying the argument of the proof of
Lemma \ref{lemma-distinguished-triangle-Rlim} to the (defining)
distinguished triangle $K \to \prod K_n \to \prod K_n \to K[1]$.
\end{remark}






\section{Derived categories of modules}
\label{section-derived-modules}

\noindent
In this section we put some generalities concerning the
derived category of modules over a ring.

\medskip\noindent
Let $A$ be a ring. The category of $A$-modules has products
and products are exact. Hence every complex of $A$-modules
is quasi-isomorphic to a K-injective complex and
$D(A)$ has products
(Derived Categories, Lemmas \ref{derived-lemma-product-derived-Ab4*} and
\ref{derived-lemma-enough-K-injectives-Ab4*}).
This implies that every inverse system of objects of $D(A)$
has a derived limit (well defined up to isomorphism), see
Derived Categories, Section \ref{derived-section-derived-limit}.

\begin{lemma}
\label{lemma-K-injective-flat}
Let $R \to S$ be a flat ring map. If $I^\bullet$ is a K-injective
complex of $S$-modules, then $I^\bullet$ is K-injective as a
complex of $R$-modules.
\end{lemma}

\begin{proof}
This is true because
$\Hom_{K(R)}(M^\bullet, I^\bullet) =
\Hom_{K(S)}(M^\bullet \otimes_R S, I^\bullet)$
by Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}
and the fact that tensoring with $S$ is exact.
\end{proof}

\begin{lemma}
\label{lemma-K-injective-epimorphism}
Let $R \to S$ be an epimorphism of rings. Let $I^\bullet$ be a complex
of $S$-modules. If $I^\bullet$ is K-injective as a complex of
$R$-modules, then $I^\bullet$ is an injective $S$-module.
\end{lemma}

\begin{proof}
This is true because
$\Hom_{K(R)}(N^\bullet, I^\bullet) =
\Hom_{K(S)}(N^\bullet, I^\bullet)$ for any complex of $S$-modules
$N^\bullet$,
see Algebra, Lemma \ref{algebra-lemma-epimorphism-modules}.
\end{proof}

\begin{lemma}
\label{lemma-hom-K-injective}
Let $A \to B$ be a ring map. If $I^\bullet$ is a K-injective complex of
$A$-modules, then $\Hom_A(B, I^\bullet)$ is a K-injective complex of
$B$-modules.
\end{lemma}

\begin{proof}
This is true because
$\Hom_{K(B)}(N^\bullet, \Hom_A(B, I^\bullet)) =
\Hom_{K(A)}(N^\bullet, I^\bullet)$
by Algebra, Lemma \ref{algebra-lemma-adjoint-hom-restrict}.
\end{proof}

\begin{remark}
\label{remark-constructing-tensor-with-limits-functorially}
Let $A$ be a ring. Let $(E_n)$ be an inverse system of objects
of $D(A)$. We've seen above that a derived limit $R\lim E_n$
exists. Thus for every object $K$ of $D(A)$ also the derived
limit $R\lim( K \otimes_A^\mathbf{L} E_n )$ exists.
It turns out that we can construct these derived limits
functorially in $K$ and obtain an exact functor
$$
R\lim(- \otimes_A^\mathbf{L} E_n) : D(A) \longrightarrow D(A)
$$
of triangulated categories. Namely, we first lift $(E_n)$ to an object $E$
of $D(\mathbf{N}, A)$, see Lemma \ref{lemma-lift-to-system-complexes}.
(The functor will depend on the choice of this lift.)
Next, observe that there is a ``diagonal'' or ``constant'' functor
$$
\Delta : D(A) \longrightarrow D(\mathbf{N}, A)
$$
mapping the complex $K^\bullet$ to the constant inverse system of
complexes with value $K^\bullet$. Then we simply define
$$
R\lim(K \otimes_A^\mathbf{L} E_n) = R\lim(\Delta(K)\otimes^\mathbf{L} E)
$$
where on the right hand side we use the functor $R\lim$ of
Lemma \ref{lemma-compute-Rlim-modules}
and the functor $- \otimes^\mathbf{L} -$ of
Lemma \ref{lemma-derived-tensor-product-systems}.
\end{remark}

\begin{lemma}
\label{lemma-tensor-Rlim-exact}
Let $A$ be a ring. Let $E \to D \to F \to E[1]$ be a distinguished
triangle of $D(\mathbf{N}, A)$. Let $(E_n)$, resp.\ $(D_n)$, resp.\ $(F_n)$
be the system of objects of $D(A)$ associated to $E$, resp.\ $D$, resp.\ $F$.
Then for every $K \in D(A)$ there is a canonical distinguished triangle
$$
R\lim (K \otimes_A E_n) \to
R\lim (K \otimes_A D_n) \to
R\lim (K \otimes_A F_n) \to
R\lim (K \otimes_A E_n)[1]
$$
in $D(A)$ with notation as in
Remark \ref{remark-constructing-tensor-with-limits-functorially}.
\end{lemma}

\begin{proof}
This is clear from the construction in
Remark \ref{remark-constructing-tensor-with-limits-functorially}
and the fact that $\Delta : D(A) \to D(\mathbf{N}, A)$,
$- \otimes^\mathbf{L} -$, and $R\lim$ are exact functors of triangulated
categories.
\end{proof}

\begin{lemma}
\label{lemma-tensor-Rlim-pro-equal}
Let $A$ be a ring. Let $E \to D$ be a morphism of
$D(\mathbf{N}, A)$. Let $(E_n)$, resp.\ $(D_n)$
be the system of objects of $D(A)$ associated to $E$, resp.\ $D$.
If $(E_n) \to (D_n)$ is an isomorphism of pro-objects, then for every
$K \in D(A)$ the corresponding map
$$
R\lim (K \otimes_A E_n) \longrightarrow R\lim (K \otimes_A D_n)
$$
in $D(A)$ is an isomorphism
(notation as in
Remark \ref{remark-constructing-tensor-with-limits-functorially}).
\end{lemma}

\begin{proof}
Follows from the definitions and Lemma \ref{lemma-Rlim-pro-equal}.
\end{proof}










\section{Formal glueing of module categories}
\label{section-formal-glueing}

\noindent
Fix a noetherian scheme $X$, and a closed subscheme $Z$ with complement $U$.
Our goal is to explain a result of Artin that describes how coherent sheaves on
$X$ can be constructed (uniquely) from coherent sheaves on the formal
completion of $X$ along $Z$, and those on $U$ with a suitable compatibility on
the overlap.

\medskip\noindent
Here are some references treating some of the material in this section:
\cite[Section 2]{ArtinII},
\cite[Appendix]{Ferrand-Raynaud},
\cite{MB}, and
\cite[Section 4.6]{dJ-crystalline}.

\begin{definition}
\label{definition-f-power-torsion}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item Let $I \subset R$ be an ideal. We say $M$ is an
{\it $I$-power torsion module} if for every $m \in M$ there exists an $n > 0$
such that $I^n m = 0$.
\item Let $f \in R$. We say $M$ is
{\it an $f$-power torsion module} if for each
$m \in M$, there exists an $n > 0$ such that $f^n m = 0$.
\end{enumerate}
\end{definition}

\noindent
Thus an $f$-power torsion module is the same thing as a $I$-power torsion
module for $I = (f)$. We sometimes use the notation
$M[I^n] = \{m \in M \mid I^nm = 0\}$ and $M[I^\infty] = \bigcup M[I^n]$
for an $R$-module $M$. Thus $M$ is $I$-power torsion if and only if
$M = M[I^\infty]$ if and only if $M = \bigcup M[I^n]$.

\begin{lemma}
\label{lemma-characterize-flatness-on-torsion}
Let $\varphi : R \to S$ be a ring map. Let $I \subset R$ be an ideal.
The following are equivalent
\begin{enumerate}
\item $\varphi$ is flat and $R/I \to S/IS$ is faithfully flat,
\item $\varphi$ is flat, and the map
$\Spec(S/IS) \to \Spec(R/I)$ is surjective.
\item $\varphi$ is flat, and the base change functor
$M \mapsto M \otimes_R S$ is faithful on modules annihilated by $I$, and
\item $\varphi$ is flat, and the base change functor
$M \mapsto M \otimes_R S$ is faithful on $I$-power torsion modules.
\end{enumerate}
\end{lemma}

\begin{proof}
If $R \to S$ is flat, then $R/I^n \to S/I^nS$ is flat for every $n$, see
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Hence (1) and (2) are equivalent by
Algebra, Lemma \ref{algebra-lemma-ff-rings}.
The equivalence of (1) with (3) follows by identifying $I$-torsion
$R$-modules with $R/I$-modules, using that
$$
M \otimes_R S = M \otimes_{R/I} S/IS
$$
for $R$-modules $M$ annihilated by $I$, and
Algebra, Lemma \ref{algebra-lemma-easy-ff}.
The implication (4) $\Rightarrow$ (3) is immediate. Assume (3). We have
seen above that $R/I^n \to S/I^nS$ is flat, and by assumption it induces
a surjection on spectra, as $\Spec(R/I^n) = \Spec(R/I)$ and
similarly for $S$. Hence the base change functor is faithful on modules
annihilated by $I^n$. Since any $I$-power torsion module $M$ is the union
$M = \bigcup M_n$ where $M_n$ is annihilated by $I^n$ we see that the base
change functor is faithful on the category of all $I$-power torsion modules
(as tensor product commutes with colimits).
\end{proof}

\begin{lemma}
\label{lemma-I-power-torsion-presentation}
Let $R$ be a ring.
Let $I$ be an ideal of $R$.
Let $M$ be an $I$-power torsion module.
Then $M$ admits a resolution
$$
\ldots \to K_2 \to K_1 \to K_0 \to M \to 0
$$
with each $K_i$ a direct sum of copies of $R/I^n$ for $n$ variable.
\end{lemma}

\begin{proof}
There is a canonical surjection
$$
\oplus_{m \in M} R/I^{n_m} \to M \to 0
$$
where $n_m$ is the smallest positive integer such that $I^{n_m} \cdot m = 0$.
The kernel of the preceding surjection is also an $I$-power torsion module.
Proceeding inductively, we construct the desired resolution of $M$.
\end{proof}

\begin{lemma}
\label{lemma-neighbourhood-isomorphism}
Assume $(\varphi : R \to S, I)$ satisfies the equivalent conditions of
Lemma \ref{lemma-characterize-flatness-on-torsion}.
The following are equivalent
\begin{enumerate}
\item for any $I$-power torsion module $M$, the natural map
$M \to M \otimes_R S$ is an isomorphism, and
\item $R/I \to S/IS$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is immediate.
Assume (2). First assume that $M$ is annihilated by $I$.
In this case, $M$ is an $R/I$-module. Hence, we have an isomorphism
$$
M \otimes_R S = M \otimes_{R/I} S/IS = M \otimes_{R/I} R/I = M
$$
proving the claim. Next we prove by induction that $M \to M \otimes_R S$
is an isomorphism for any module $M$ is annihilated by $I^n$. Assume
the induction hypothesis holds for $n$ and assume $M$ is annihilated by
$I^{n + 1}$. Then we have a short exact sequence
$$
0 \to I^nM \to M \to M/I^nM \to 0
$$
and as $R \to S$ is flat this gives rise to a short exact sequence
$$
0 \to I^nM \otimes_R S \to M \otimes_R S \to M/I^nM \otimes_R S \to 0
$$
Using that the canonical map is an isomorphism for $M' = I^nM$ and
$M'' = M/I^nM$ (by induction hypothesis) we conclude the same thing is
true for $M$. Finally, suppose that $M$ is a general $I$-power torsion
module. Then $M = \bigcup M_n$ where $M_n$ is annihilated by $I^n$
and we conclude using that tensor products commute with colimits.
\end{proof}

\begin{lemma}
\label{lemma-torsion-free}
Let $R$ be a ring. Let $I$ be an ideal of $R$.
For any $R$-module $M$ set $M[I^n] = \{m \in M \mid I^nm = 0\}$.
If $I$ is finitely generated then the following are equivalent
\begin{enumerate}
\item $M[I] = 0$,
\item $M[I^n] = 0$ for all $n \geq 1$, and
\item if $I = (f_1, \ldots, f_t)$, then the map
$M \to \bigoplus M_{f_i}$ is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemma \ref{algebra-lemma-when-injective-covering}.
\end{proof}

\begin{lemma}
\label{lemma-divide-by-torsion}
Let $R$ be a ring. Let $I$ be an ideal of $R$. For any $R$-module $M$
set $M[I^\infty] = \bigcup_{n \geq 1} M[I^n]$.
If $I$ is finitely generated, then $(M/M[I^\infty])[I] = 0$.
\end{lemma}

\begin{proof}
Let $m \in M$. If $m$ maps to an element of $(M/M[I^\infty])[I]$
then $Im \subset M[I^\infty]$.
Write $I = (f_1, \ldots, f_t)$. Then we see that
$f_i m \in M[I^\infty]$, i.e., $I^{n_i}f_i m = 0$ for some $n_i > 0$.
Thus we see that $I^Nm = 0$ with $N = \sum n_i + 2$.
Hence $m$ maps to zero in $(M/M[I^\infty])$ which proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-neighbourhood-equivalence}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism. Then
\begin{enumerate}
\item for any $R$-module $M$ the map $M \to M \otimes_R S$ induces
an isomorphism
$M[I^\infty] \to (M \otimes_R S)[(IS)^\infty]$ of $I$-power
torsion submodules,
\item the natural map
$$
\Hom_R(M, N) \longrightarrow \Hom_S(M \otimes_R S, N \otimes_R S)
$$
is an isomorphism if either $M$ or $N$ is $I$-power torsion, and
\item the base change functor $M \mapsto M \otimes_R S$ defines an
equivalence of categories between $I$-power torsion modules
and $IS$-power torsion modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the equivalent conditions of both
Lemma \ref{lemma-characterize-flatness-on-torsion} and
Lemma \ref{lemma-neighbourhood-isomorphism}
are satisfied. We will use these without further mention.
We first prove (1). Let $M$ be any $R$-module.
Set $M' = M/M[I^\infty]$ and consider the exact sequence
$$
0 \to M[I^\infty] \to M \to M' \to 0
$$
As $M[I^\infty] = M[I^\infty] \otimes_R S$ we see that it suffices to
show that $(M' \otimes_R S)[(IS)^\infty] = 0$.
Write $I = (f_1, \ldots, f_t)$. By
Lemma \ref{lemma-divide-by-torsion}
we see that $M'[I^\infty] = 0$. Hence for every $n > 0$ the map
$$
M' \longrightarrow \bigoplus\nolimits_{i = 1, \ldots t} M',
\quad
x \longmapsto (f_1^n x, \ldots, f_t^n x)
$$
is injective. As $S$ is flat over $R$ also the corresponding map
$M' \otimes_R S \to \bigoplus_{i = 1, \ldots t} M' \otimes_R S$
is injective. This means that $(M' \otimes_R S)[I^n] = 0$ as desired.

\medskip\noindent
Next we prove (2). If $N$ is $I$-power torsion, then
$N \otimes_R S = N$ and the displayed map of (2) is an isomorphism by
Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}.
If $M$ is $I$-power torsion, then the image of any map
$M \to N$ factors through $M[I^\infty]$ and the image of any map
$M \otimes_R S \to N \otimes_R S$ factors through
$(N \otimes_R S)[(IS)^\infty]$. Hence in this case
part (1) guarantees that we may replace $N$ by $N[I^\infty]$
and the result follows from the case where $N$ is $I$-power torsion
we just discussed.

\medskip\noindent
Next we prove (3). The functor is fully faithful by (2).
For essential surjectivity, we simply note that for any $IS$-power torsion
$S$-module $N$, the natural map $N \otimes_R S \to N$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-map-identifies-koszul-and-cech-complexes}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism.
For any $f_1, \ldots, f_r \in R$ such that $V(f_1, \ldots, f_r) = V(I)$
\begin{enumerate}
\item the map of Koszul complexes
$K(R, f_1, \ldots, f_r) \to K(S, f_1, \ldots, f_r)$ is a quasi-isomorphism, and
\item The map of extended alternating {\v C}ech complexes
$$
\xymatrix{
R \to \prod_{i_0} R_{f_{i_0}} \to \prod_{i_0 < i_1} R_{f_{i_0}f_{i_1}}
\to \ldots \to R_{f_1\ldots f_r} \ar[d] \\
S \to \prod_{i_0} S_{f_{i_0}} \to \prod_{i_0 < i_1} S_{f_{i_0}f_{i_1}}
\to \ldots \to S_{f_1\ldots f_r}
}
$$
is a quasi-isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
In both cases we have a complex $K_\bullet$ of $R$ modules and we want
to show that $K_\bullet \to K_\bullet \otimes_R S$ is a quasi-isomorphism.
By Lemma \ref{lemma-neighbourhood-isomorphism} and the flatness of
$R \to S$ this will hold as soon as all homology groups of $K$ are $I$-power
torsion. This is true for the Koszul complex by
Lemma \ref{lemma-homotopy-koszul}.
Since the alternating {\v C}ech complex is a colimit of Koszul
complexes (Lemma \ref{lemma-extended-alternating-Cech-is-colimit-koszul})
the case of the Koszul complex implies the second statement too.
\end{proof}

\begin{lemma}
\label{lemma-naive-Koszul-complex}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. Let $M$ be the $R$-module generated by elements
$e_1, \ldots, e_n$ subject to the relations $f_i e_j - f_j e_i = 0$.
There exists a short exact sequence
$$
0 \to K \to M \to I \to 0
$$
such that $K$ is annihilated by $I$.
\end{lemma}

\begin{proof}
This is just a truncation of the Koszul complex.
The map $M \to I$ is is determined by the rule $e_i \mapsto f_i$. If
$m = \sum a_i e_i$ is in the kernel of $M \to I$, i.e., $\sum a_i f_i = 0$,
then $f_j m = \sum f_j a_i e_i = (\sum f_i a_i) e_j = 0$.
\end{proof}

\begin{lemma}
\label{lemma-explicit-ext}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. For any $R$-module $N$ set
$$
H_1(N, f_\bullet) =
\frac{\{(x_1, \ldots, x_n) \in N^{\oplus n} \mid f_i x_j = f_j x_i \}}
{\{f_1x, \ldots, f_nx) \mid x \in N\}}
$$
For any $R$-module $N$ there exists a canonical short exact sequence
$$
0 \to \text{Ext}_R(R/I, N) \to H_1(N, f_\bullet) \to \Hom_R(K, N)
$$
where $K$ is as in
Lemma \ref{lemma-naive-Koszul-complex}.
\end{lemma}

\begin{proof}
The notation above indicates the $\text{Ext}$-groups in $\text{Mod}_R$
as defined in
Homology, Section \ref{homology-section-extensions}.
These are denoted $\text{Ext}_R(M, N)$. Using the long exact sequence of
Homology, Lemma \ref{homology-lemma-six-term-sequence-ext}
associated to the short exact sequence $0 \to I \to R \to R/I \to 0$
and the fact that $\text{Ext}_R(R, N) = 0$ we see that
$$
\text{Ext}_R(R/I, N) =
\text{Coker}(N \longrightarrow \Hom(I, N))
$$
Using the short exact sequence of
Lemma \ref{lemma-naive-Koszul-complex}
we see that we get a complex
$$
N \to \Hom(M, N) \to \Hom_R(K, N)
$$
whose homology in the middle is canonically isomorphic to
$\text{Ext}_R(R/I, N)$. The proof of the lemma is now complete
as the cokernel of the first map
is canonically isomorphic to $H_1(N, f_\bullet)$.
\end{proof}

\begin{lemma}
\label{lemma-koszul-homology-annihilated}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. For any $R$-module $N$ the Koszul homology group
$H_1(N, f_\bullet)$ defined in
Lemma \ref{lemma-explicit-ext}
is annihilated by $I$.
\end{lemma}

\begin{proof}
Let $(x_1, \ldots, x_n) \in N^{\oplus n}$ with $f_i x_j = f_j x_i$.
Then we have $f_i(x_1, \ldots, x_n) = (f_i x_i, \ldots, f_i x_n)$.
In other words $f_i$ annihilates $H_1(N, f_\bullet)$.
\end{proof}

\noindent
We can improve on the full faithfulness of
Lemma \ref{lemma-neighbourhood-equivalence}
by showing that $\text{Ext}$-groups whose source is $I$-power torsion
are insensitive to passing to $S$ as well. See
Remark \ref{remark-neighbourhood-extensions}
below for a more highbrow version of the following lemma.

\begin{lemma}
\label{lemma-neighbourhood-extensions}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism.
Let $M$, $N$ be $R$-modules. Assume $M$ is $I$-power torsion.
Given an short exact sequence
$$
0 \to N \otimes_R S \to \tilde E \to M \otimes_R S \to 0
$$
there exists a commutative diagram
$$
\xymatrix{
0 \ar[r] &
N \ar[r] \ar[d] &
E \ar[r] \ar[d] &
M \ar[r] \ar[d] &
0 \\
0 \ar[r] &
N \otimes_R S \ar[r] &
\tilde E \ar[r] &
M \otimes_R S \ar[r] &
0
}
$$
with exact rows.
\end{lemma}

\begin{proof}
As $M$ is $I$-power torsion we see that $M \otimes_R S = M$, see
Lemma \ref{lemma-neighbourhood-isomorphism}.
We will use this identification without further mention.
As $R \to S$ is flat, the base change functor is exact and we
obtain a functorial map of $\text{Ext}$-groups
$$
\text{Ext}_R(M, N)
\longrightarrow
\text{Ext}_S(M \otimes_R S, N \otimes_R S),
$$
see
Homology, Lemma \ref{homology-lemma-exact-functor-ext}.
The claim of the lemma is that this map is surjective when
$M$ is $I$-power torsion. In fact we will show that it is an
isomorphism. By
Lemma \ref{lemma-I-power-torsion-presentation}
we can find a surjection $M' \to M$ with $M'$ a direct sum of
modules of the form $R/I^n$. Using the long exact sequence of
Homology, Lemma \ref{homology-lemma-six-term-sequence-ext}
we see that it suffices to prove the lemma for $M'$.
Using compatibility of $\text{Ext}$ with direct sums (details omitted)
we reduce to the case where $M = R/I^n$ for some $n$.

\medskip\noindent
Let $f_1, \ldots, f_t$ be generators for $I^n$. By
Lemma \ref{lemma-explicit-ext}
we have a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\text{Ext}_R(R/I^n, N) \ar[r] \ar[d] &
H_1(N, f_\bullet) \ar[r] \ar[d] &
\Hom_R(K, N) \ar[d] \\
0 \ar[r] &
\text{Ext}_S(S/I^nS, N \otimes S) \ar[r] &
H_1(N \otimes S, f_\bullet) \ar[r] &
\Hom_S(K \otimes S, N \otimes S)
}
$$
with exact rows where $K$ is as in
Lemma \ref{lemma-naive-Koszul-complex}.
Hence it suffices to prove that the two right vertical arrows are
isomorphisms. Since $K$ is annihilated by $I^n$ we see that
$\Hom_R(K, N) = \Hom_S(K \otimes_R S, N \otimes_R S)$ by
Lemma \ref{lemma-neighbourhood-equivalence}.
As $R \to S$ is flat we have
$H_1(N, f_\bullet) \otimes_R S = H_1(N \otimes_R S, f_\bullet)$.
As $H_1(N, f_\bullet)$ is annihilated by $I^n$, see
Lemma \ref{lemma-koszul-homology-annihilated}
we have $H_1(N, f_\bullet) \otimes_R S = H_1(N, f_\bullet)$ by
Lemma \ref{lemma-neighbourhood-isomorphism}.
\end{proof}

\begin{remark}
\label{remark-neighbourhood-extensions}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism.
Let $M$, $N$ be $R$-modules and assume $M$ is $I$-power torsion.
Then the canonical map
$$
\text{Ext}^i_R(M, N)
\longrightarrow
\text{Ext}^i_S(M \otimes_R S, N \otimes_R S)
$$
is an isomorphism for all $i$. Namely, we can construct an inverse
to this map as follows. Think of an element $\xi$ of the right hand side
as a morphism $\xi : M \otimes_R S \to N \otimes_R S[i]$ in $D(S)$.
Let $\check{\mathcal{C}}_R \to \check{\mathcal{C}}_S$ be
the quasi-isomorphism of extended alternating {\v C}ech complexes of
Lemma \ref{lemma-map-identifies-koszul-and-cech-complexes}.
Tensoring over $S$ with $\check{\mathcal{C}}_S$ is equal to derived
tensor, hence we obtain
$$
\xi \otimes \text{id} :
M \otimes_R \check{\mathcal{C}}_S \to N \otimes_R \check{\mathcal{C}}_S[i]
$$
in $D(S)$. On the one hand the complex $M \otimes_R \check{\mathcal{C}}_S$
is equal to $M = M \otimes_R S$ because $M$ is $I$-power torsion.
On the other hand, in $D(R)$ we have
$$
N \otimes_R \check{\mathcal{C}}_S =
N \otimes_R \check{\mathcal{C}}_R \longrightarrow N
$$
just because there is a map of complexes $\check{\mathcal{C}}_R \to R$.
Combining all of the above we obtain a map $M \to N[i]$ in $D(R)$
as desired. We omit the verification that this construction indeed produces
an inverse to the first map. If we ever need to use this result we will put
in a more detailed proof.
\end{remark}

\noindent
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_t \in R$ and $I = (f_1, \ldots, f_t)$.
Then for any $R$-module $M$ we can define a complex
\begin{equation}
\label{equation-glueing-complex}
0 \to M \xrightarrow{\alpha}
M \otimes_R S \times \prod M_{f_i} \xrightarrow{\beta}
\prod (M \otimes_R S)_{f_i}
\times
\prod M_{f_if_j}
\end{equation}
where $\alpha(m) = (m \otimes 1, m/1, \ldots, m/1)$ and
$$
\beta(m', m_1, \ldots, m_t) =
((m'/1 - m_1 \otimes 1, \ldots, m'/1 - m_t \otimes 1),
(m_1 - m_2, \ldots, m_{t - 1} - m_t).
$$
We would like to know when this complex is exact.

\begin{lemma}
\label{lemma-recover-module-from-glueing-data}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism.
Let $M$ be an $R$-module. Then the
complex (\ref{equation-glueing-complex})
is exact.
\end{lemma}

\begin{proof}
First proof. Denote $\check{\mathcal{C}}_R \to \check{\mathcal{C}}_S$
the quasi-isomorphism of extended alternating {\v C}ech complexes of
Lemma \ref{lemma-map-identifies-koszul-and-cech-complexes}.
Since these complexes are finite with flat terms, we see that
$M \otimes_R \check{\mathcal{C}}_R \to M \otimes_R \check{\mathcal{C}}_S$
is a quasi-isomorphism too (Lemmas
\ref{lemma-derived-tor-quasi-isomorphism} and
\ref{lemma-derived-tor-quasi-isomorphism-other-side}). Now the complex
(\ref{equation-glueing-complex}) is a truncation of the cone
of the map
$M \otimes_R \check{\mathcal{C}}_R \to M \otimes_R \check{\mathcal{C}}_S$
and we win.

\medskip\noindent
Second computational proof.
Let $m \in M$. If $\alpha(m) = 0$, then $m \in M[I^\infty]$, see
Lemma \ref{lemma-torsion-free}. Pick $n$ such that $I^n m = 0$
and consider the map $\varphi : R/I^n \to M$.
If $m \otimes 1 = 0$, then $\varphi \otimes 1_S = 0$, hence
$\varphi = 0$ (see
Lemma \ref{lemma-neighbourhood-equivalence})
hence $m = 0$. In this way we see that $\alpha$ is injective.

\medskip\noindent
Let $(m', m'_1, \ldots, m'_t) \in \text{Ker}(\beta)$.
Write $m'_i = m_i/f_i^n$ for some $n > 0$ and $m_i \in M$.
We may, after possibly enlarging $n$ assume that
$f_i^n m' = m_i \otimes 1$ in $M \otimes_R S$ and
$f_j^nm_i - f_i^nm_j = 0$ in $M$.
In particular we see that
$(m_1, \ldots, m_t)$ defines an element $\xi$ of
$H_1(M, (f_1^n, \ldots, f_t^n))$.
Since $H_1(M, (f_1^n, \ldots, f_t^n))$ is annihilated by $I^{tn + 1}$ (see
Lemma \ref{lemma-koszul-homology-annihilated})
and since $R \to S$ is flat we see that
$$
H_1(M, (f_1^n, \ldots, f_t^n)) =
H_1(M, (f_1^n, \ldots, f_t^n)) \otimes_R S =
H_1(M \otimes_R S, (f_1^n, \ldots, f_t^n))
$$
by
Lemma \ref{lemma-neighbourhood-isomorphism}
The existence of $m'$ implies that $\xi$ maps to zero in the last group, i.e.,
the element $\xi$ is zero. Thus there exists an $m \in M$ such that
$m_i = f_i^n m$. Then $(m', m'_1, \ldots, m'_t) - \alpha(m)
= (m'', 0, \ldots, 0)$ for some $m'' \in (M \otimes_R S)[(IS)^\infty]$.
By
Lemma \ref{lemma-neighbourhood-equivalence}
we conclude that $m'' \in M[I^\infty]$ and we win.
\end{proof}

\begin{remark}
\label{remark-glueing-data}
In this remark we define a category of glueing data.
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_t \in R$ and $I = (f_1, \ldots, f_t)$.
Consider the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
as the category whose
\begin{enumerate}
\item objects are systems $(M', M_i, \alpha_i, \alpha_{ij})$, where
$M'$ is an $S$-module, $M_i$ is an $R_{f_i}$-module,
$\alpha_i : (M')_{f_i} \to M_i \otimes_R S$ is an isomorphism, and
$\alpha_{ij} : (M_i)_{f_j} \to (M_j)_{f_i}$ are isomorphisms
such that
\begin{enumerate}
\item $\alpha_{ij} \circ \alpha_i = \alpha_j$ as maps
$(M')_{f_if_j} \to (M_j)_{f_i}$, and
\item $\alpha_{jk} \circ \alpha_{ij} = \alpha_{ik}$ as maps
$(M_i)_{f_jf_k} \to (M_k)_{f_if_j}$ (cocycle condition).
\end{enumerate}
\item morphisms
$(M', M_i, \alpha_i, \alpha_{ij}) \to (N', N_i, \beta_i, \beta_{ij})$
are given by maps $\varphi' : M' \to N'$ and $\varphi_i : M_i \to N_i$
compatible with the given maps $\alpha_i, \beta_i, \alpha_{ij}, \beta_{ij}$.
\end{enumerate}
There is a canonical functor
$$
\text{Can} : \text{Mod}_R
\longrightarrow
\text{Glue}(R \to S, f_1, \ldots, f_t),
\quad
M \longmapsto (M \otimes_R S, M_{f_i}, \text{can}_i, \text{can}_{ij})
$$
where $\text{can}_i : (M \otimes_R S)_{f_i} \to M_{f_i} \otimes_R S$
and $\text{can}_{ij} : (M_{f_i})_{f_j} \to (M_{f_j})_{f_i}$
are the canonical isomorphisms. For any object
$\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$ of the category
$\text{Glue}(R \to S, f_1, \ldots, f_t)$ we define
$$
H^0(\mathbf{M}) =
\{(m', m_i) \mid \alpha_i(m') = m_i \otimes 1, \alpha_{ij}(m_i) = m_j\}
$$
in other words defined by the exact sequence
$$
0 \to H^0(\mathbf{M}) \to
M' \times \prod M_i \to
\prod M'_{f_i}
\times
\prod (M_i)_{f_j}
$$
similar to (\ref{equation-glueing-complex}).
We think of $H^0(\mathbf{M})$ as an $R$-module. Thus we also get a functor
$$
H^0 :
\text{Glue}(R \to S, f_1, \ldots, f_t)
\longrightarrow
\text{Mod}_R
$$
Our next goal is to show that the functors
$\text{Can}$ and $H^0$ are sometimes quasi-inverse to each other.
\end{remark}

\begin{lemma}
\label{lemma-H0-inverse}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism. Then the functor $H^0$
is a left quasi-inverse to the functor $\text{Can}$ of
Remark \ref{remark-glueing-data}.
\end{lemma}

\begin{proof}
This is a reformulation of
Lemma \ref{lemma-recover-module-from-glueing-data}.
\end{proof}

\begin{lemma}
\label{lemma-exact}
Assume $\varphi : R \to S$ is a flat ring map and let
$I = (f_1, \ldots, f_t) \subset R$ be an ideal.
Then $\text{Glue}(R \to S, f_1, \ldots, f_t)$ is an abelian category, and
the functor $\text{Can}$ is exact and commutes with arbitrary colimits.
\end{lemma}

\begin{proof}
Given a morphism
$(\varphi', \varphi_i) :
(M', M_i, \alpha_i, \alpha_{ij})
\to
(N', N_i, \beta_i, \beta_{ij})$
of the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
we see that its kernel exists and is equal to the object
$(\text{Ker}(\varphi'), \text{Ker}(\varphi_i), \alpha_i, \alpha_{ij})$
and its cokernel exists and is equal to the object
$(\text{Coker}(\varphi'), \text{Coker}(\varphi_i), \beta_i, \beta_{ij})$.
This works because $R \to S$ is flat, hence taking kernels/cokernels
commutes with $- \otimes_R S$. Details omitted.
The exactness follows from the $R$-flatness of $R_{f_i}$ and $S$, while
commuting with colimits follows as tensor products commute with colimits.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-I-unit}
Let $\varphi : R \to S$ be a flat ring map and $(f_1, \ldots, f_t) = R$.
Then $\text{Can}$ and $H^0$ are quasi-inverse equivalences of categories
$$
\text{Mod}_R = \text{Glue}(R \to S, f_1, \ldots, f_t)
$$
\end{lemma}

\begin{proof}
Consider an object $\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$
of $\text{Glue}(R \to S, f_1, \ldots, f_t)$. By
Algebra, Lemma \ref{algebra-lemma-glue-modules}
there exists a unique module $M$ and isomorphisms
$M_{f_i} \to M_i$ which recover the glueing data $\alpha_{ij}$.
Then both $M'$ and $M \otimes_R S$ are $S$-modules
which recover the modules $M_i \otimes_R S$ upon localizing at $f_i$.
Whence there is a canonical isomorphism $M \otimes_R S \to M'$.
This shows that $\mathbf{M}$ is in the essential image of $\text{Can}$.
Combined with
Lemma \ref{lemma-H0-inverse}
the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-base-change-glue}
Let $\varphi : R \to S$ be a flat ring map and $I = (f_1, \ldots, f_t)$
and ideal. Let $R \to R'$ be a flat ring map, and set $S' = S \otimes_R R'$.
Then we obtain a commutative diagram of categories and functors
$$
\xymatrix{
\text{Mod}_R \ar[r]_-{\text{Can}} \ar[d]_{-\otimes_R R'} &
\text{Glue}(R \to S, f_1, \ldots, f_t) \ar[r]_-{H^0} \ar[d]^{-\otimes_R R'} &
\text{Mod}_R \ar[d]^{-\otimes_R R'} \\
\text{Mod}_{R'} \ar[r]^-{\text{Can}} &
\text{Glue}(R' \to S', f_1, \ldots, f_t) \ar[r]^-{H^0} &
\text{Mod}_{R'}
}
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{proposition}
\label{proposition-equivalence}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism. Then $\text{Can}$ and
$H^0$ are quasi-inverse equivalences of categories
$$
\text{Mod}_R = \text{Glue}(R \to S, f_1, \ldots, f_t)
$$
\end{proposition}

\begin{proof}
We have already seen that $H^0 \circ \text{Can}$ is isomorphic to the
identity functor, see
Lemma \ref{lemma-H0-inverse}.
Consider an object $\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$
of $\text{Glue}(R \to S, f_1, \ldots, f_t)$.
We get a natural morphism
$$
\Psi :
(H^0(\mathbf{M}) \otimes_R S, H^0(\mathbf{M})_{f_i},
\text{can}_i, \text{can}_{ij})
\longrightarrow
(M', M_i, \alpha_i, \alpha_{ij}).
$$
Namely, by definition $H^0(\mathbf{M})$ comes equipped with compatible
$R$-module maps $H^0(\mathbf{M}) \to M'$ and $H^0(\mathbf{M}) \to M_i$.
We have to show that this map is an isomorphism.

\medskip\noindent
Pick an index $i$ and set $R' = R_{f_i}$. Combining
Lemmas \ref{lemma-base-change-glue} and \ref{lemma-equivalence-I-unit}
we see that $\Psi \otimes_R R'$ is an isomorphism.
Hence the kernel, resp.\ cokernel of $\Psi$ is a system of the form
$(K, 0, 0, 0)$, resp.\ $(Q, 0, 0, 0)$. Note that
$H^0((K, 0, 0, 0)) = K$, that $H^0$ is left exact, and that by
construction $H^0(\Psi)$ is bijective. Hence we see $K = 0$, i.e.,
the kernel of $\Psi$ is zero.

\medskip\noindent
The conclusion of the above is that we obtain a short exact sequence
$$
0 \to H^0(\mathbf{M}) \otimes_R S \to M' \to Q \to 0
$$
and that $M_i = H^0(\mathbf{M})_{f_i}$.
Note that we may think of $Q$ as an $R$-module which is $I$-power
torsion so that $Q = Q \otimes_R S$. By
Lemma \ref{lemma-neighbourhood-extensions}
we see that there exists a commutative diagram
$$
\xymatrix{
0 \ar[r] &
H^0(\mathbf{M}) \ar[r] \ar[d] &
E \ar[r] \ar[d] &
Q \ar[r] \ar[d] &
0 \\
0 \ar[r] &
H^0(\mathbf{M}) \otimes_R S \ar[r] &
M' \ar[r] &
Q \ar[r] &
0
}
$$
with exact rows. This clearly determines an isomorphism
$\text{Can}(E) \to (M', M_i, \alpha_i, \alpha_{ij})$
in the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
and we win. (Of course, a posteriori we have $Q = 0$.)
\end{proof}

\noindent
Next, we specialize this very general proposition to get something
more useable. Namely, if $I = (f)$ is a principal ideal then the objects
of $\text{Glue}(R \to S, f)$ are simply triples $(M', M_1, \alpha_1)$
and there is {\it no} cocycle condition to check!

\begin{theorem}
\label{theorem-formal-glueing}
Let $R$ be a ring, and let $f \in R$.
Let $\varphi : R \to S$ be a flat ring map inducing an isomorphism
$R/fR \to S/fS$. Then the functor
$$
\text{Mod}_R
\longrightarrow
\text{Mod}_S \times_{\text{Mod}_{S_f}} \text{Mod}_{R_f},
\quad
M
\longmapsto
(M \otimes_R S, M_f, \text{can})
$$
is an equivalence.
\end{theorem}

\begin{proof}
The category appearing on the right side of the arrow
is the category of triples $(M', M_1, \alpha_1)$ where $M'$ is an
$S$-module, $M_1$ is a $R_f$-module, and
$\alpha_1 : M'_f \to M_1 \otimes_R S$ is a $S_f$-isomorphism, see
Categories, Example \ref{categories-example-2-fibre-product-categories}.
Hence this theorem is a special case of
Proposition \ref{proposition-equivalence}.
\end{proof}

\noindent
A useful special case of
Theorem \ref{theorem-formal-glueing}
is when $R$ is noetherian, and $S$ is a completion of $R$ at an
element $f$. The completion $R \to S$ is flat, and the functor
$M \mapsto M \otimes_R S$ can be identified with the $f$-adic
completion functor when $M$ is finitely generated. To state
this more precisely, let $\text{Mod}_{fg}(R)$ denote the category
of finitely generated $R$-modules.

\begin{proposition}
\label{proposition-formal-glueing}
Let $R$ be a noetherian ring.
Let $f \in R$ be an element.
Let $R^\wedge$ be the $f$-adic completion of $R$.
Then the functor $M \mapsto (M^\wedge, M_f, \text{can})$
defines an equivalence
$$
\text{Mod}_{fg}(R)
\longrightarrow
\text{Mod}_{fg}(R^\wedge)
\times_{\text{Mod}_{fg}(R^\wedge_f)}
\text{Mod}_{fg}(R_f)
$$
\end{proposition}

\begin{proof}
The ring map $R \to R^\wedge$ is flat by
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
It is clear that $R/fR = R^\wedge/fR^\wedge$.
By
Algebra, Lemma \ref{algebra-lemma-completion-tensor}
the completion of a finite $R$-module $M$ is equal to $M \otimes_R R^\wedge$.
Hence the displayed functor of the proposition is equal to the
functor occuring in
Theorem \ref{theorem-formal-glueing}.
In particular it is fully faithful. Let $(M_1, M_2, \psi)$ be an
object of the right hand side. By
Theorem \ref{theorem-formal-glueing}
there exists an $R$-module $M$ such that
$M_1 = M \otimes_R R^\wedge$ and $M_2 = M_f$. As $R \to R^\wedge \times R_f$
is faithfully flat we conclude from
Algebra, Lemma \ref{algebra-lemma-cover}
that $M$ is finitely generated, i.e., $M \in \text{Mod}_{fg}(R)$.
This proves the proposition.
\end{proof}

\begin{remark}
\label{remark-formal-glueing-algebras}
The equivalences of
Proposition \ref{proposition-equivalence},
Theorem \ref{theorem-formal-glueing}, and
Proposition \ref{proposition-formal-glueing}
preserve the $\otimes$-structures on either side.
Thus, it defines equivalences of various categories
built out of the pair $(\text{Mod}_R, \otimes)$, such as the category of
$R$-algebras.
\end{remark}

\begin{remark}
\label{remark-topological-analogue}
Given a differential manifold $X$ with a compact closed submanifold $Z$
having complement $U$, specifying a sheaf on $X$ is the same as specifying
a sheaf on $U$, a sheaf on an unspecified tubular neighbourhood $T$ of $Z$ in
$X$, and an isomorphism between the two resulting sheaves along $T \cap U$.
Tubular neighbourhoods do not exist in algebraic geometry as such, but
results such as
Proposition \ref{proposition-equivalence},
Theorem \ref{theorem-formal-glueing}, and
Proposition \ref{proposition-formal-glueing}
allow us to work with formal neighbourhoods instead.
\end{remark}















\section{Derived Completion}
\label{section-derived-completion}

\noindent
Some references for the material in this section are
\cite{Greenlees-May}, \cite{dag12}, and \cite{BS}.

\noindent
Let $K \in D(A)$. Let $f \in A$. We denote $T(K, f)$ a derived limit
of the system
$$
\ldots \to K \xrightarrow{f} K \xrightarrow{f} K
$$
in $D(A)$.

\begin{lemma}
\label{lemma-hom-from-Af}
Let $A$ be a ring. Let $f \in A$. Let $K \in D(A)$.
The following are equivalent
\begin{enumerate}
\item $\text{Ext}^n_A(A_f, K) = 0$ for all $n$,
\item $\Hom_{D(A)}(E, K) = 0$ for all $E$ in $D(A_f)$,
\item $T(K, f) = 0$,
\item for every $p \in \mathbf{Z}$ we have $T(H^p(K), f) = 0$,
\item for every $p \in \mathbf{Z}$ we have
$\text{Hom}_A(A_f, H^p(K)) = 0$ and $\text{Ext}^1_A(A_f, H^p(K)) = 0$,
\item add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (2) implies (1). Assume (1).
Let $I^\bullet$ be a K-injective complex of $A$-modules representing $K$.
Condition (1) signifies that $\Hom_A(A_f, I^\bullet)$ is acyclic.
Let $M^\bullet$ be a complex of $A_f$-modules representing $E$.
Then
$$
\Hom_{D(A)}(E, K) =
\Hom_{K(A)}(M^\bullet, I^\bullet) =
\Hom_{K(A_f)}(M^\bullet, \Hom_A(A_f, I^\bullet))
$$
by Algebra, Lemma \ref{algebra-lemma-adjoint-hom-restrict}.
As $\Hom_A(A_f, I^\bullet)$ is a K-injective complex of
$A_f$-modules by Lemma \ref{lemma-hom-K-injective}
the fact that it is acyclic implies that it is homotopy equivalent to zero
(Derived Categories, Lemma \ref{derived-lemma-K-injective}).
Thus we get (2).

\medskip\noindent
A free resolution of the $A$-module $A_f$ is given by
$$
0 \to \bigoplus\nolimits_{n \in \mathbf{N}} A \to
\bigoplus\nolimits_{n \in \mathbf{N}} A
\to A_f \to 0
$$
where the first map sends the $(x_0, x_1, \ldots)$ to
$(fx_0 - x_1, fx_1 - x_2, \ldots)$ and the second map sends
$(x_0, x_1, \ldots)$ to $x_0 + x_1/f + x_2/f^2 + \ldots$.
Applying $\Hom_A(-, I^\bullet)$ we get
$$
0 \to \Hom_A(A_f, I^\bullet) \to \prod I^\bullet \to \prod I^\bullet \to 0
$$
This means that the object $T(K, f)$ is a representative of
$R\Hom_A(A_f, K)$ in $D(A)$. Thus the equivalence of (1) and (3).

\medskip\noindent
There is a spectral sequence
$$
E_2^{p, q} = \text{Ext}^q_A(A_f, H^p(K)) \Rightarrow
\text{Ext}^{p + q}_A(A_f, K)
$$
(details omitted). This spectral sequence degenerates at $E_2$ because
$A_f$ has a length $1$ resolution by projective $A$-modules (see above)
hence the $E_2$-page has only 2 nonzero rows. Thus we obtain short exact
sequences
$$
0 \to \text{Ext}^1_A(A_f, H^{p - 1}(K)) \to \text{Ext}^p_A(A_f, K)
\to \Hom_A(A_f, H^p(K)) \to 0
$$
This proves (4) and (5) are equivalent to (1).
\end{proof}

\begin{lemma}
\label{lemma-ideal-of-elements-complete-wrt}
Let $A$ be a ring. Let $K \in D(A)$. The set $I$ of $f \in A$ such that
$T(K, f) = 0$ is an ideal of $A$.
\end{lemma}

\begin{proof}
We will use the results of Lemma \ref{lemma-hom-from-Af}
without furhter mention.
If $f \in I$, and $g \in A$, then $A_{gf}$ is an $A_f$-module
hence $\text{Ext}^n_A(A_{gf}, K) = 0$ for all $n$, hence $gf \in I$.
Suppose $f, g \in I$. Then there is a short exact sequence
$$
0 \to A_{f + g} \to A_{f(f + g)} \oplus A_{g(f + g)} \to A_{gf(f + g)} \to 0
$$
because $f, g$ generate the unit ideal in $A_{f + g}$. This follows from
Algebra, Lemma \ref{algebra-lemma-standard-covering}
and the easy fact that the last arrow is surjective.
By the long exact sequence of $\text{Ext}$
and the vanishing of
$\text{Ext}^n_A(A_{f(f + g)}, K)$,
$\text{Ext}^n_A(A_{g(f + g)}, K)$, and
$\text{Ext}^n_A(A_{gf(f + g)}, K)$
we get the vanishing of 
$\text{Ext}^n_A(A_{f + g}, K)$.
\end{proof}

\begin{lemma}
\label{lemma-complete-derived-complete}
Let $A$ be a ring. Let $I \subset A$ be an ideal. Let $M$ be an $A$-module.
\begin{enumerate}
\item If $M$ is $I$-adically complete, then $T(M, f) = 0$ for all $f \in I$.
\item Conversely, if $T(M, f) = 0$ for all $f \in I$ and $I$ is finitely
generated, then $M \to \lim M/I^nM$ is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Assume $M$ is $I$-adically complete.
By Lemma \ref{lemma-hom-from-Af} it suffices to prove
$\text{Ext}^1_A(A_f, M) = 0$ and $\Hom_A(A_f, M) = 0$.
Since $M = \lim M/I^nM$ and since $\Hom_A(A_f, M/I^nM) = 0$
it follows that $\Hom_A(A_f, M) = 0$. Suppose we have an extension
$$
0 \to M \to E \to A_f \to 0
$$
For $n \geq 0$ pick $e_n \in E$ mapping to $1/f^n$.
Set $\delta_n = fe_{n + 1} - e_n \in M$ for $n \geq 0$.
Replace $e_n$ by
$$
e'_n = e_n + \delta_n + f\delta_{n + 1} + f^2 \delta_{n + 2} + \ldots
$$
The infinite sum exists as $M$ is complete with respect to $I$ and $f \in I$.
A simple calculation shows that $fe'_{n + 1} = e'_n$. Thus we get a splitting
of the extension by mapping $1/f^n$ to $e'_n$.

\medskip\noindent
Proof of (2). Assume that $I = (f_1, \ldots, f_r)$ and that $T(M, f_i) = 0$
for $i = 1, \ldots, r$. By
Algebra, Lemma \ref{algebra-lemma-when-surjective-to-completion}
we may assume $I = (f)$ and $T(M, f) = 0$. Let $x_n \in M$ for $n \geq 0$.
Consider the extension
$$
0 \to M \to E \to A_f \to 0
$$
given by
$$
E = M \oplus \bigoplus Ae_n\Big/\langle x_n - fe_{n + 1} + e_n\rangle
$$
mapping $e_n$ to $1/f^n$ in $A_f$ (see above).
By assumption and Lemma \ref{lemma-hom-from-Af}
this extension is split, hence we obtain an element
$x + e_0$ which generates a copy of $A_f$ in $E$.
Then
$$
x + e_0 = x - x_0 + fe_1 = x - x_0 - x_1 + f^2 e_2 = \ldots
$$
Since $M/f^nM = E/f^nE$ by the snake lemma, we see that
$x = x_0 + fx_1 + \ldots + f^{n - 1}x_{n - 1}$ modulo $f^nM$.
In other words, the map $M \to M/(f^n)M$ is surjective as desired.
\end{proof}

\noindent
Motivated by the results above we make the following definition.

\begin{definition}
\label{definition-derived-complete}
Let $A$ be a ring. Let $K \in D(A)$. Let $I \subset A$ be an ideal.
We say $K$ is {\it derived complete with respect to $I$}
if for every $f \in I$ we have $T(K, f) = 0$.
If $M$ is an $A$-module, then we say $M$ is
{\it derived complete with respect to $I$}
if $M[0] \in D(A)$ is derived complete with respect to $I$.
\end{definition}

\noindent
We will often simply say $M$ is a derived complete module if
the choice of the ideal $I$ is clear from the context.

\begin{proposition}
\label{proposition-derived-complete-modules}
Let $I \subset A$ be a finitely generated ideal of a ring $A$.
Let $M$ be an $A$-module. The following are equivalent
\begin{enumerate}
\item $M$ is $I$-adically complete, and
\item $M$ is derived complete with respect to $I$ and $\bigcap I^nM = 0$.
\end{enumerate}
\end{proposition}

\begin{proof}
This is clear from the results of
Lemma \ref{lemma-complete-derived-complete}.
\end{proof}

\begin{lemma}
\label{lemma-serre-subcategory}
Let $I$ be an ideal of a ring $A$.
\begin{enumerate}
\item The derived complete $A$-modules form a weak Serre
subcategory $\mathcal{C}$ of $\text{Mod}_A$.
\item $D_\mathcal{C}(A) \subset D(A)$ is the full subcategory
of derived complete objects.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) is immediate from Lemma \ref{lemma-hom-from-Af}
and the definitions. For part (1), suppose that $M \to N$ is
a map of derived complete modules. Denote $K = (M \to N)$
the corresponding object of $D(A)$. Pick $f \in I$. Then
$\text{Ext}_A^n(A_f, K)$ is zero for all $n$ because
$\text{Ext}_A^n(A_f, M)$ and $\text{Ext}_A^n(A_f, N)$ are zero for all $n$.
Hence $K$ is derived complete. By (2) we see that $\text{Ker}(M \to N)$ and
$\text{Coker}(M \to N)$ are objects of $\mathcal{C}$.
Finally, suppose that $0 \to M_1 \to M_2 \to M_3 \to 0$
is a short exact sequence of $A$-modules and
$M_1$, $M_3$ are derived complete. Then it follows from
the long exact sequence of $\text{Ext}$'s that $M_2$
is derived complete. Thus $\mathcal{C}$ is a weak Serre subcategory by
Homology, Lemma \ref{homology-lemma-characterize-weak-serre-subcategory}.
\end{proof}

\begin{lemma}
\label{lemma-derived-completion}
Let $I$ be a finitely generated ideal of a ring $A$. Let $D_{comp}(A)$
denote the full subcategory of derived complete objects.
The inclusion functor $D_{comp}(A) \to D(A)$ has a left adjoint, i.e.,
given any object $K$ of $D(A)$ there exists a map $K \to K^\wedge$
of $K$ into a derived complete object of $D(A)$ such that the map
$$
\Hom_{D(A)}(K^\wedge, E) \longrightarrow \Hom_{D(A)}(K, E)
$$
is bijective whenever $E$ is a derived complete object of $D(A)$.
\end{lemma}

\begin{proof}
Let $I = (f_1, \ldots, f_r)$. For each $i \in \{1, \ldots, r\}$
let $D_i(A)$ denote the full subcategory of objects which are
derived complete with respect to $(f_i)$.
Then $D_{comp}(A) = D_1(A) \cap \ldots \cap D_r(A)$.
It formally follows from this that it suffices to construct
a left adjoint of the inclusion functor $D_i(A) \to D(A)$.
In other words: we may assume $I$ is generated by a single element.

\medskip\noindent
Let $I = (f)$. Any object of $D(A)$ can be represented by a K-injective
complex of $A$-modules $K^\bullet$. Let $L^\bullet = \Hom_A(A_f, K^\bullet)$.
Note that $L^\bullet$ is a K-injective complex of $A_f$-modules and
K-injective as a complex of $A$-modules, by
Lemmas \ref{lemma-hom-K-injective} and \ref{lemma-K-injective-flat}.
There is a canonical map of complexes $L^\bullet \to K^\bullet$
given by evaluation at $1$. We claim that
$$
M^\bullet = \text{Cone}(L^\bullet \to K^\bullet)
$$
endowed with the canonical map $K^\bullet \to M^\bullet$ has the required
universal property. First, observe we have a distinguished triangle
$$
L^\bullet \to K^\bullet \to M^\bullet \to L^\bullet[1]
$$
Next, for any complex of $A_f$-modules $N^\bullet$ we have
\begin{align*}
\Hom_{D(A)}(N^\bullet, L^\bullet)
& =
\Hom_{K(A)}(N^\bullet, L^\bullet) \\
& =
\Hom_{K(A_f)}(N^\bullet, L^\bullet) \\
& =
\Hom_{K(A_f)}(N^\bullet, \Hom_A(A_f, K^\bullet)) \\
& =
\Hom_{K(A)}(N^\bullet, K^\bullet) \\
& =
\Hom_{D(A)}(N^\bullet, K^\bullet)
\end{align*}
The first equality holds as $L^\bullet$ is K-injective as a complex of
$A$-modules, the second holds by
Algebra, Lemma \ref{algebra-lemma-epimorphism-modules},
the third by definition of $L^\bullet$,
the fourth by 
Algebra, Lemma \ref{algebra-lemma-adjoint-hom-restrict},
the fifth as $K^\bullet$ is a K-injective complex of $A$-modules.
From the distinguished triangle and
Derived Categories, Lemma \ref{derived-lemma-representable-homological}
it follows that $\Hom_{D(A)}(N^\bullet, M^\bullet) = 0$, i.e.,
$M^\bullet$ is derived complete by Lemma \ref{lemma-hom-from-Af}.
Next, assume that $E$ is a derived complete object.
Then $\Hom_{D(A)}(L^\bullet, E) = 0$ since $L^\bullet$
is a complex of $A_f$-modules. Hence from the distinguished
triangle we obtain
$\Hom_{D(A)}(K^\bullet, E) = \Hom_{D(A)}(M^\bullet, E)$.
This finishes the proof.
\end{proof}

\noindent
Let $A$ be a ring and let $I \subset A$ be an ideal. For any
$K \in D(A)$ we can consider the derived limit
$$
K' = R\lim (K \otimes_A^\mathbf{L} A/I^n)
$$
This is a functor in $K$, see
Remark \ref{remark-constructing-tensor-with-limits-functorially}.
The system of maps $A \to A/I^n$ induces a map $K \to K'$.
It turns out that $K'$ is derived complete with respect to $I$.
This ``naive'' derived completion construction does not agree
with the adjoint of Lemma \ref{lemma-derived-completion} in general.
For example, if $A = \mathbf{Z}_p \oplus \mathbf{Q}_p/\mathbf{Z}_p$
with the second summand an ideal of square zero, $K = A[0]$, and $I = (p)$,
then the naive derived completion gives $\mathbf{Z}_p[0]$, but the
construction of Lemma \ref{lemma-derived-completion} gives
$K^\wedge \cong \mathbf{Z}_p[1] \oplus \mathbf{Z}_p[0]$ (computation omitted).

\begin{lemma}
\label{lemma-naive-derived-completion}
Let $A$ be a ring and let $I \subset A$ be an ideal. For
$K \in D(A)$ the naive derived completion
$K' = R\lim (K \otimes_A^\mathbf{L} A/I^n)$
is derived complete with respect to $I$.
\end{lemma}

\begin{proof}
Let $f \in I$. The groups $\text{Ext}^p_A(A_f, K')$
sit in short exact sequences
$$
0 \to R^1\lim \text{Ext}^{p - 1}_A(A_f, K \otimes_A^\mathbf{L} A/I^n) \to
\text{Ext}^p_A(A_f, K') \to
\lim \text{Ext}^p_A(A_f, K \otimes_A^\mathbf{L} A/I^n) \to 0
$$
by Lemma \ref{lemma-map-into-Rlim}. We conclude since $f$ acts both
as an isomorphism and nilpotently on the outer terms.
\end{proof}

\begin{lemma}
\label{lemma-lift-universally}
Let $A$ be a ring. Let $f \in A$. If there exists an integer $c \geq 1$
such that $A[f^c] = A[f^{c + 1}] = A[f^{c + 2}] = \ldots$ (for example
if $A$ is Noetherian), then for all $n \geq 1$ there exist maps
$$
(A \xrightarrow{f^n} A) \longrightarrow A/(f^n),
\quad\text{and}\quad
A/(f^{n + c}) \longrightarrow (A \xrightarrow{f^n} A)
$$
in $D(A)$ inducing an isomorphism of the pro-objects $\{A/(f^n)\}$ and
$\{(f^n : A \to A)\}$ in $D(A)$.
\end{lemma}

\begin{proof}
The first displayed arrow is obvious. We can define the second arrow of
the lemma by the diagram
$$
\xymatrix{
A/A[f^c] \ar[r]_-{f^{n + c}} \ar[d]_{f^c} & A \ar[d]^1 \\
A \ar[r]^{f^n} & A
}
$$
Since the top horzontal arrow is injective the complex
in the top row is quasi-isomorphic to $A/f^{n + c}A$.
We omit the calculation of compositions needed to show
the statement on pro objects.
\end{proof}

\noindent
Let $A$ be a ring. Let $f_1, \ldots, f_r \in A$. We are going
to consider the sequence of Koszul complexes
$K_n^\bullet = K_\bullet(A, f_1^n, \ldots, f_r^n)$
placed in cohomological degrees $-r, -r + 1, \ldots, 0$.
Using the functoriality of Lemma \ref{lemma-functorial}
we get maps
$$
\ldots \to K_3^\bullet \to K_2^\bullet \to K_1^\bullet
$$
compatible with $H^0(K_n^\bullet) = A/(f_1^n, \ldots, f_r^n)$
and the natural maps between these quotients. A key feature of the
discussion below will use that for $m > n$ the map
$$
K_m^{-p} = \wedge^p(A^{\oplus r}) \to \wedge^p(A^{\oplus r}) = K_n^{-p}
$$
is given by multiplication by $f_{i_1}^{m - n} \ldots f_{i_p}^{m - n}$
on the basis element $e_{i_1} \wedge \ldots \wedge e_{i_p}$.
Finally, note that there is a compatible system of maps $A \to K_n^\bullet$.

\begin{lemma}
\label{lemma-koszul-derived-completion-complete}
With notation as above, let $I = (f_1, \ldots, f_r) \subset A$. For
$K \in D(A)$ the object $K' = R\lim (K \otimes_A^\mathbf{L} K_n^\bullet)$
is derived complete with respect to $I$.
\end{lemma}

\begin{proof}
Let $f \in I$. We have short exact sequences
$$
0 \to
R^1\lim \text{Ext}^{p - 1}_A(A_f, K \otimes_A^\mathbf{L} K_n^\bullet) \to
\text{Ext}^p_A(A_f, K') \to
\lim \text{Ext}^p_A(A_f, K \otimes_A^\mathbf{L} K_n^\bullet) \to 0
$$
by Lemma \ref{lemma-map-into-Rlim}. We conclude the middle term is zero
as $f$ acts both as an isomorphism and nilpotently on the outer terms
(recall that $f_i^n$ acts by an endomorphism of $K_n^\bullet$ which is
homotopic to zero). Thus $K$ is derived complete with respect to $I$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-derived-complete-Koszul}
With notation as above. Let $I = (f_1, \ldots, f_r)$.
Let $K \in D(A)$. The following are equivalent
\begin{enumerate}
\item $K$ is derived complete with respect to $I$, and
\item the canonical map $K \to R\lim (K \otimes_A^\mathbf{L} K_n^\bullet)$
is an isomorphism of $D(A)$.
\end{enumerate}
\end{lemma}

\begin{proof}
If (2) holds, then $K$ is derived complete with respect to $I$
by Lemma \ref{lemma-koszul-derived-completion-complete}.
Conversely, assume that $K$ is derived complete with respect to $I$.
Consider the filtrations
$$
K_n^\bullet \supset
\sigma_{\geq -r + 1}K_n^\bullet \supset
\sigma_{\geq -r + 2}K_n^\bullet \supset \ldots \supset
\sigma_{\geq -1}K_n^\bullet \supset
\sigma_{\geq 0}K_n^\bullet = A
$$
by stupid truncations (Homology, Section \ref{homology-section-truncations}).
Because the construction $R\lim(K \otimes E)$ is exact in
the second variable (Lemma \ref{lemma-tensor-Rlim-exact})
we see that it suffices to show
$$
R\lim \left(
K \otimes_A^\mathbf{L}
(\sigma_{\geq p}K_n^\bullet/ \sigma_{\geq p + 1}K_n^\bullet)
\right) = 0
$$
for $p < 0$. The explicit description of the Koszul complexes above
shows that
$$
R\lim \left(
K \otimes_A^\mathbf{L}
(\sigma_{\geq p}K_n^\bullet/ \sigma_{\geq p + 1}K_n^\bullet)
\right) =
\bigoplus\nolimits_{i_1, \ldots, i_{-p}}
T(K, f_{i_1}\ldots f_{i_{-p}})
$$
which is zero for $p < 0$ by assumption on $K$.
\end{proof}

\begin{lemma}
\label{lemma-derived-completion-koszul}
With notation as above. Let $I = (f_1, \ldots, f_r) \subset A$.
The functor which sends $K \in D(A)$ to the derived limit
$K' = R\lim( K \otimes_A^\mathbf{L} K_n^\bullet )$ is the left
adjoint to the inclusion functor $D_{comp}(A) \to D(A)$
constructed in Lemma \ref{lemma-derived-completion}.
\end{lemma}

\begin{proof}
The assigment $K \leadsto K'$ is a functor and $K'$ is derived
complete with respect to $I$ by
Lemma \ref{lemma-koszul-derived-completion-complete}.
By a formal argument (omitted) we see that it suffices
to show $K \to K'$ is an isomorphism if $K$ is derived complete
with respect to $I$. This is
Lemma \ref{lemma-characterize-derived-complete-Koszul}.
\end{proof}

\begin{lemma}
\label{lemma-sequence-Koszul-complexes}
With notation as above. If $A$ is Noetherian, then for every $n$
there exists an $m \geq n$ such that $K_m^\bullet \to K_n^\bullet$
factors through the map $K_m^\bullet \to A/(f_1^m, \ldots, f_r^m)$.
In other words, the pro-objects $\{K_n^\bullet\}$ and
$\{A/(f_1^n, \ldots, f_r^n)\}$ of $D(A)$ are isomorphic.
\end{lemma}

\begin{proof}
Note that the Koszul complexes have length $r$. Thus the dual of
Derived Categories, Lemma \ref{derived-lemma-trick-vanishing-composition}
implies it suffices to show that for every $p < 0$ and $n \in \mathbf{N}$
there exists an $m \geq n$ such that $H^p(K_m^\bullet) \to H^p(K_n^\bullet)$
is zero. Since $A$ is Noetherian, we see that
$$
H^p(K_n^\bullet) =
\frac{\text{Ker}(K_n^p \to K_n^{p + 1})}{\text{Im}(K_n^{p - 1} \to K_n^p)}
$$
is a finite $A$-module. Moreover, the map $K_m^p \to K_n^p$ is given
by a diagonal matrix whose entries are in the ideal
$(f_1^{m - n}, \ldots, f_r^{m - n})$ if $p < 0$ (in fact they are in the
$|p|$th power of that ideal). Note that $H^p(K_n^\bullet)$ is annihilated by
$I = (f_1^n, \ldots, f_r^n)$, see Lemma \ref{lemma-homotopy-koszul}. Now
$I^t \subset (f_1^{m - n}, \ldots, f_r^{m - n})$ for $m = n + tr$.
Thus by Artin-Rees (Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
for some $m$ large enough we see that
the image of $K_m^p \to K_n^p$ intersected with
$\text{Ker}(K_n^p \to K_n^{p + 1})$ is contained in
$I \text{Ker}(K_n^p \to K_n^{p + 1})$. For this $m$ we get the zero map.
\end{proof}

\begin{proposition}
\label{proposition-noetherian-naive-completion-is-completion}
Let $A$ be a Noetherian ring. Let $I \subset A$ be an ideal.
The functor which sends $K \in D(A)$ to the derived limit
$K' = R\lim( K \otimes_A^\mathbf{L} A/I^n )$ is the left
adjoint to the inclusion functor $D_{comp}(A) \to D(A)$
constructed in Lemma \ref{lemma-derived-completion}.
\end{proposition}

\begin{proof}
Say $(f_1, \ldots, f_r) = I$ and let $K_n^\bullet$ be the Koszul complex
with respect to $f_1^n, \ldots, f_r^n$. By
Lemma \ref{lemma-derived-completion-koszul}
it suffices to prove that
$$
R\lim (K \otimes_A^\mathbf{L} K_n^\bullet) =
R\lim (K \otimes_A^\mathbf{L} A/(f_1^n, \ldots, f_r^n) ) =
R\lim (K \otimes_A^\mathbf{L} A/I^n ).
$$
By Lemma \ref{lemma-sequence-Koszul-complexes} the pro-objects
$\{K_n^\bullet\}$ and $\{A/(f_1^n, \ldots, f_r^n)\}$ of $D(A)$ are
isomorphic. It is clear that the pro-objects
$\{A/(f_1^n, \ldots, f_r^n)\}$ and $\{A/I^n\}$ are isomorphic.
Thus the map from left to right is an isomorphism by
Lemma \ref{lemma-tensor-Rlim-pro-equal}.
\end{proof}

\begin{remark}
\label{remark-when-does-it-work}
Let $A$ be a ring and $f \in A$. Set $I = (f)$. In this situation
we have the naive derived $I$-adic completion functor
$K \mapsto K' = R\lim (K \otimes_A^\mathbf{L} A/f^nA)$ and the functor
$$
K \mapsto K^\wedge = R\lim (K \otimes_A^\mathbf{L} (A \xrightarrow{f^n} A))
$$
of Lemmas \ref{lemma-derived-completion-koszul} and
\ref{lemma-derived-completion}.
There is a natural transformation of functors $K^\wedge \to K'$.
Thus we ask: When is this transformation an isomorphism of functors?
We have seen in
Proposition \ref{proposition-noetherian-naive-completion-is-completion}
that this is true if $A$ is Noetherian. More generally, the same
argument shows this is true if the pro-objects
$\{(f^n : A \to A)\}$ and $\{A/f^nA\}$ are equal, for example
if $f$-torsion is bounded (Lemma \ref{lemma-lift-universally}).
Conversely, we see from Lemma \ref{lemma-tensor-Rlim-exact}
that the condition is exactly that
$$
R\lim (K \otimes_A^\mathbf{L} A[f^n])
$$
is zero for all $K \in D(A)$. Here the maps of the system $(A[f^n])$
are given by multiplication by $f$. Taking $K = A$ and
$K = \bigoplus_{i \in \mathbf{N}} A$ we see from
Lemma \ref{lemma-Rlim-zero-of-direct-sums}
this implies $(A[f^n])$ is zero as a pro-object, i.e.,
$f^{n - 1}A[f^n] = 0$ for some $n$, i.e., $A[f^{n - 1}] = A[f^n]$, i.e.,
the $f$-torsion is bounded.
\end{remark}

\begin{lemma}
\label{lemma-restriction-derived-complete}
Let $A \to B$ be a ring map. Let $I \subset A$ be an ideal. The inverse
image of $D_{comp}(B, IB)$ under the restriction functor $D(B) \to D(A)$ is
$D_{comp}(A, I)$.
\end{lemma}

\begin{proof}
Using Lemma \ref{lemma-ideal-of-elements-complete-wrt}
we see that $L \in D(B)$ is in $D_{comp}(B, IB)$
if and only if $T(L, f)$ is zero for every local section
$f \in I$. Observe that the cohomology of
$T(L, f)$ is computed in the category of abelian groups,
so it doesn't matter whether we think of $f$ as an element of $A$
or take the image of $f$ in $B$.
The lemma follows immediately from this and the
definition of derived complete objects.
\end{proof}

\begin{lemma}
\label{lemma-restriction-derived-complete-equivalence}
Let $A \to B$ be a ring map. Let $I \subset A$ be a finitely generated ideal.
If $A \to B$ is flat and $A/I \cong B/IB$, then the restriction functor
$D(B) \to D(A)$ induces an equivalence
$D_{comp}(B, IB) \to D_{comp}(A, I)$.
\end{lemma}

\begin{proof}
Choose generators $f_1, \ldots, f_r$ of $I$.
Denote $\check{\mathcal{C}}^\bullet_A \to \check{\mathcal{C}}^\bullet_B$
the quasi-isomorphism of extended alternating {\v C}ech complexes of
Lemma \ref{lemma-map-identifies-koszul-and-cech-complexes}.
Let $K \in D_{comp}(A, I)$. Let $I^\bullet$ be a K-injective
complex of $A$-modules representing $K$. Since $\text{Ext}^n_A(A_f, K)$
and $\text{Ext}^n_A(B_f, K)$ are zero for all $f \in I$ and
$n \in \mathbf{Z}$ (Lemma \ref{lemma-hom-from-Af}) we conclude that
$\check{\mathcal{C}}^\bullet_A \to A$ and
$\check{\mathcal{C}}^\bullet_B \to B$ induce quasi-isomorphisms
$$
I^\bullet = \Hom_A(A, I^\bullet) \longrightarrow
\text{Tot}(\Hom_A(\check{\mathcal{C}}^\bullet_A, I^\bullet))
$$
and
$$
\Hom_A(B, I^\bullet) \longrightarrow
\text{Tot}(\Hom_A(\check{\mathcal{C}}^\bullet_B, I^\bullet))
$$
Some details omitted.
Since $\check{\mathcal{C}}^\bullet_A \to \check{\mathcal{C}}^\bullet_B$
is a quasi-isomorphism and $I^\bullet$ is K-injective we conclude
that $\Hom_A(B, I^\bullet) \to I^\bullet$ is a quasi-isomorphism.
As the complex $\Hom_A(B, I^\bullet)$ is a complex of $B$-modules
we conclude that $K$ is in the image of the restriction map, i.e.,
the functor is essentially surjective

\medskip\noindent
In fact, the argument shows that
$F : D_{comp}(A, I) \to D_{comp}(B, IB)$, $K \mapsto \Hom_A(B, I^\bullet)$
is a left inverse to restriction. Finally, suppose that
$L \in D_{comp}(B, IB)$. Represent $L$ by a K-injective complex
$J^\bullet$ of $B$-modules.
Then $J^\bullet$ is also K-injective as a complex of $A$-modules
(Lemma \ref{lemma-K-injective-flat}) hence
$F(\text{restriction of }L) = \Hom_A(B, J^\bullet)$.
There is a map $J^\bullet \to \Hom_A(B, J^\bullet)$
of complexes of $B$-modules, whose composition with
$\Hom_A(B, J^\bullet) \to J^\bullet$ is the identity.
We conclude that $F$ is also a right inverse to restriction
and the proof is finished.
\end{proof}






\section{Local cohomology}
\label{section-local-cohomology}

\noindent
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal
(if $I$ is not finitely generated perhaps a different definition
should be used). Consider the functor
$$
\Gamma_Z : \text{Mod}_A \longrightarrow \text{Mod}_A,\quad
M \longmapsto \bigcup M[I^n]
$$
which sends $M$ to the submodule of $I$-power torsion.
This functor is left exact and has a derived extension
$R\Gamma_Z : D(A) \to D(A)$. Note that for every $K \in D(A)$
there is a canonical map $R\Gamma_Z(K) \to K$.

\begin{lemma}
\label{lemma-local-cohomology-closed}
With notation as above. The functors $\Gamma_Z$ and $R\Gamma_Z$
depend only on the closed subset $Z = V(I) \subset \Spec(A)$.
\end{lemma}

\begin{proof}
Let $M$ be an $A$-module. Let $x \in M$. If $x \in \Gamma_Z(M)$, then $x$
maps to zero in $M_f$ for all $f \in I$. Hence $x$ maps to zero in
$M_\mathfrak p$ for all $\mathfrak p \not \supset I$. Conversely, if $x$
maps to zero in $M_\mathfrak p$ for all $\mathfrak p \not \supset I$,
then $x$ maps to zero in $M_f$ for all $f \in I$. Hence if
$I = (f_1, \ldots, f_r)$, then $f_i^{n_i}x = 0$ for some $n_i \geq 1$.
It follows that $x \in M[I^{\sum n_i}]$. Thus $\Gamma_Z(M)$ is
the kernel of $M \to \prod_{\mathfrak p \not \in Z} M_\mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-ext}
With notation as above. For any $A$-module $M$ we have
$$
R^q\Gamma_Z(M) = \colim_n \text{Ext}_A^q(A/I^n, M)
$$
\end{lemma}

\begin{proof}
This follows immediately from the fact that $M[I^n] = \Hom_A(A/I^n, M)$.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-if-annihilated-noetherian}
With notation as above. If $A$ is Noetherian and the $A$-module $M$
is $I$-power torsion, then the canonical map $R\Gamma_Z(M) \to M$ is an
isomorphism in $D(A)$.
\end{lemma}

\begin{proof}
By Dualizing Complexes, Lemma \ref{dualizing-lemma-injective-module-divide}
we see that $M$ has an injective resolution $M \to J^0 \to J^1 \to \ldots$
with $J^p = J^p[I^\infty]$ completely $I$-power torsion. The result follows.
\end{proof}

\begin{lemma}
\label{lemma-compute-local-cohomology-noetherian}
If $A$ is a Noetherian ring and $I = (f_1, \ldots, f_r)$ an ideal.
There is a canonical isomorphism
$$
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \longrightarrow R\Gamma_Z(A)
$$
in $D(A)$.
\end{lemma}

\begin{proof}
There is a canonical map of complexes
$$
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \longrightarrow A.
$$
Applying $R\Gamma_Z$ we get a map
$$
R\Gamma_Z(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \longrightarrow R\Gamma_Z(A).
$$
This map is an isomorphism as clearly $R\Gamma_Z(A_f) = 0$
for all $f \in I$. On the other hand, the homology modules
of the complex
$A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}$
are $I$-power torsion by
Lemmas \ref{lemma-extended-alternating-Cech-is-colimit-koszul} and
\ref{lemma-homotopy-koszul}. Thus the canonical map
$$
\xymatrix{
R\Gamma_Z(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \ar[d] \\
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})
}
$$
is an isomorphism in $D(A)$ by
Lemma \ref{lemma-local-cohomology-if-annihilated-noetherian}
and the spectral sequence of
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-change-rings}
If $A \to B$ is a homomorphism of Noetherian rings and $I \subset A$
is an ideal, then
$$
R\Gamma_Z(A) \otimes_A^\mathbf{L} B = R\Gamma_Y(B)
$$
where $Y = V(IB) \subset \Spec(B)$.
\end{lemma}

\begin{proof}
This is clear from Lemma \ref{lemma-compute-local-cohomology-noetherian}
and the fact that formation of the extended {\v C}ech complex
commutes with base change.
\end{proof}







\section{Weakly \'etale ring maps}
\label{section-weakly-etale}

\noindent
Most of the results in this section are from the paper
\cite{Olivier-AF} by Olivier. See also the related paper
\cite{Ferrand-epi}.

\begin{definition}
\label{definition-weakly-etale}
A ring $A$ is called {\it absolutely flat} if every $A$-module is flat over
$A$. A ring map $A \to B$ is {\it weakly \'etale} or {\it absolutely flat}
if both $A \to B$ and $B \to B \otimes_A B$ are flat.
\end{definition}

\noindent
For example a localization is weakly \'etale. An \'etale ring map is weakly
\'etale. Here is a simple, yet key property.

\begin{lemma}
\label{lemma-key}
Let $A \to B$ be a ring map such that $B \otimes_A B \to B$ is flat.
Let $N$ be a $B$-module. If $N$ is flat as an $A$-module, then
$N$ is flat as a $B$-module.
\end{lemma}

\begin{proof}
Assume $N$ is a flat as an $A$-module.
Then the functor
$$
\text{Mod}_B \longrightarrow \text{Mod}_{B \otimes_A B},\quad
N' \mapsto N \otimes_A N'
$$
is exact. As $B \otimes_A B \to B$ is flat we conclude that the functor
$$
\text{Mod}_B \longrightarrow \text{Mod}_B,\quad
N' \mapsto (N \otimes_A N') \otimes_{B \otimes_A B} B = N \otimes_B N'
$$
is exact, hence $N$ is flat over $B$.
\end{proof}

\begin{definition}
\label{definition-weak-dimension}
Let $A$ be a ring. Let $d \geq 0$ be an integer.
We say that $A$ has {\it weak dimension $\leq d$}
if every $A$-module has tor dimension $\leq d$.
\end{definition}

\begin{lemma}
\label{lemma-weak-dimension-goes-up}
Let $A \to B$ be a weakly \'etale ring map.
If $A$ has weak dimension at most $d$, then so does $B$.
\end{lemma}

\begin{proof}
Let $N$ be a $B$-module. If $d = 0$, then $N$ is flat as an $A$-module,
hence flat as a $B$-module by Lemma \ref{lemma-key}.
Assume $d > 0$. Choose a resolution $F_\bullet \to N$
by free $B$-modules. Our assumption implies that
$K = \text{Im}(F_d \to F_{d - 1})$ is $A$-flat, see
Lemma \ref{lemma-last-one-flat}. Hence it is $B$-flat
by Lemma \ref{lemma-key}. Thus
$0 \to K \to F_{d - 1} \to \ldots \to F_0 \to N \to 0$
is a flat resolution of length $d$ and we see that $N$ has
tor dimensoin at most $d$.
\end{proof}

\begin{lemma}
\label{lemma-absolutely-flat}
Let $A$ be a ring. The following are equivalent
\begin{enumerate}
\item $A$ has weak dimension $\leq 0$,
\item $A$ is absolutely flat, and
\item $A$ is reduced and every prime is maximal.
\end{enumerate}
In this case every local ring of $A$ is a field.
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is immediate.
Assume $A$ is absolutely flat. This implies every ideal of $A$ is pure, see
Algebra, Definition \ref{algebra-definition-pure-ideal}.
Hence every finitely generated ideal is generated by an idempotent by
Algebra, Lemma \ref{algebra-lemma-finitely-generated-pure-ideal}.
If $f \in A$, then $(f) = (e)$ for some idempotent $e \in A$
and $D(f) = D(e)$ is open and closed
(Algebra, Lemma \ref{algebra-lemma-idempotent-spec}).
This already implies every ideal of $A$ is maximal
for example by
Algebra, Lemma \ref{algebra-lemma-ring-with-only-minimal-primes}.
Moreover, if $f$ is nilpotent, then $e = 0$ hence $f = 0$.
Thus $A$ is reduced.

\medskip\noindent
Assume $A$ is reduced and every prime of $A$ is maximal.
Let $M$ be an $A$-module. Our goal is to show that $M$ is flat.
We may write $M$ as a filtered colimit of finite $A$-modules, hence
we may assume $M$ is finite
(Algebra, Lemma \ref{algebra-lemma-colimit-flat}).
There is a finite filtration of $M$ by modules of the form
$A/I$ (Algebra, Lemma \ref{algebra-lemma-trivial-filter-finite-module}),
hence we may assume that $M = A/I$
(Algebra, Lemma \ref{algebra-lemma-flat-ses}).
Thus it suffices to show every ideal of $A$ is pure.
Since $A$ every local ring of $A$ is a field
(by Algebra, Lemma \ref{algebra-lemma-minimal-prime-reduced-ring} and
the fact that every prime of $A$ is minimal),
we see that every ideal $I \subset A$ is radical.
Note that every closed subset of $\Spec(A)$ is closed under specialization.
Thus every (radical) ideal of $A$ is pure by
Algebra, Lemma \ref{algebra-lemma-pure-open-closed-specializations}.
\end{proof}

\begin{lemma}
\label{lemma-product-fields-absolutely-flat}
A product of fields is an absolutely flat ring.
\end{lemma}

\begin{proof}
Let $K_i$ be a family of fields. If $f = (f_i) \in \prod K_i$, then
the ideal generated by $f$ is the same as the ideal generated by
the idempotent $e = (e_i)$ with $e_i = 0, 1$ according to whether
$f_i$ is $0, 1$. Thus $D(f) = D(e)$ is open and closed and we conclude
by Lemma \ref{lemma-absolutely-flat} and
Algebra, Lemma \ref{algebra-lemma-ring-with-only-minimal-primes}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-weakly-etale}
Let $A \to B$ and $A \to A'$ be ring maps. Let $B' = B \otimes_A A'$
be the base change of $B$.
\begin{enumerate}
\item If $B \otimes_A B \to B$ is flat, then $B' \otimes_{A'} B' \to B'$
is flat.
\item If $A \to B$ is weakly \'etale, then $A' \to B'$ is weakly \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $B \otimes_A B \to B$ is flat.
The ring map $B' \otimes_{A'} B' \to B'$ is the base change of
$B \otimes_A B \to B$ by $A \to A'$. Hence it is flat by
Algebra, Lemma \ref{algebra-lemma-flat-base-change}. This proves (1).
Part (2) follows from (1) and the fact (just used) that the
base change of a flat ring map is flat.
\end{proof}

\begin{lemma}
\label{lemma-absolutely-flat-over-absolutely-flat}
Let $A \to B$ be a ring map such that $B \otimes_A B \to B$ is flat.
\begin{enumerate}
\item If $A$ is an absolutely flat ring, then so is $B$.
\item If $A$ is reduced and $A \to B$ is weakly \'etale, then $B$ is reduced.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows immediately from Lemma \ref{lemma-key} and the definitions.
If $A$ is reduced, then there exists an injection
$A \to A' = \prod_{\mathfrak p \subset A\text{ minimal}} A_\mathfrak p$
of $A$ into an absolutely flat ring
(Algebra, Lemma \ref{algebra-lemma-reduced-ring-sub-product-fields} and
Lemma \ref{lemma-product-fields-absolutely-flat}).
If $A \to B$ is flat, then the induced map $B \to B' = B \otimes_A A'$
is injective too. By Lemma \ref{lemma-base-change-weakly-etale}
the ring map $A' \to B'$ is weakly \'etale.
By part (1) we see that $B'$ is absolutely flat.
By Lemma \ref{lemma-absolutely-flat} the ring $B'$ is reduced.
Hence $B$ is reduced.
\end{proof}

\begin{lemma}
\label{lemma-composition-weakly-etale}
Let $A \to B$ and $B \to C$ be ring maps.
\begin{enumerate}
\item If $B \otimes_A B \to B$ and $C \otimes_B C \to C$
are flat, then $C \otimes_A C \to C$ is flat.
\item If $A \to B$ and $B \to C$ are weakly \'etale, then $A \to C$
is weakly \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from the factorization
$$
C \otimes_A C \longrightarrow C \otimes_B C \longrightarrow C
$$
of the mutliplication map, the fact that
$$
C \otimes_B C = (C \otimes_A C) \otimes_{B \otimes_A B} B,
$$
the fact that a base change of a flat map is flat, and the
fact that the composition of flat ring maps is flat.
See Algebra, Lemmas \ref{algebra-lemma-flat-base-change} and
\ref{algebra-lemma-composition-flat}.
Part (2) follows from (1) and the fact (just used) that the
composition of flat ring maps is flat.
\end{proof}

\begin{lemma}
\label{lemma-go-down}
Let $A \to B \to C$ be ring maps.
\begin{enumerate}
\item If $B \to C$ is faithfully flat and $C \otimes_A C \to C$ is flat,
then $B \otimes_A B \to B$ is flat.
\item If $B \to C$ is faithfully flat and $A \to C$ is weakly \'etale,
then $A \to B$ is weakly \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $B \to C$ is faithfully flat and $C \otimes_A C \to C$ is flat.
Consider the commutative diagram
$$
\xymatrix{
C \otimes_A C \ar[r] & C \\
B \otimes_A B \ar[r] \ar[u] & B \ar[u]
}
$$
The vertical arrows are flat, the top horizontal arrow is flat.
Hence $C$ is flat as a $B \otimes_A B$-module. The map $B \to C$ is
faithfully flat and $C = B \otimes_B C$. Hence $B$ is flat as a
$B \otimes_A B$-module by
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}.
This proves (1). Part (2) follows from (1) and the fact that
$A \to B$ is flat if $A \to C$ is flat and $B \to C$ is faithfully flat
(Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}).
\end{proof}

\begin{lemma}
\label{lemma-weakly-etale-permanence}
Let $A$ be a ring. Let $B \to C$ be an $A$-algebra map of weakly \'etale
$A$-algebras. Then $B \to C$ is weakly \'etale.
\end{lemma}

\begin{proof}
Write $B \to C$ as the composition $B \to B \otimes_A C \to C$.
The first map is flat as the base change of the flat ring map $A \to C$.
The second is the base change of the flat ring map $B \otimes_A B \to B$
by the ring map $B \otimes_A B \to B \otimes_A C$, hence flat.
Thus $B \to C$ is flat. The ring map
$C \otimes_A C \to C \otimes_B C$ is surjective, hence an epimorphism.
Thus Lemma \ref{lemma-key} implies, that since
$C$ is flat over $C \otimes_A C$ it follows that $C$ is
flat over $C \otimes_B C$.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified}
Let $A \to B$ be a ring map such that $B \otimes_A B \to B$ is flat.
Then $\Omega_{B/A} = 0$, i.e., $B$ is formally unramified over $A$.
\end{lemma}

\begin{proof}
Let $I \subset B \otimes_A B$ be the kernel of the flat surjective map
$B \otimes_A B \to B$. Then $I$ is a pure ideal
(Algebra, Definition \ref{algebra-definition-pure-ideal}),
so $I^2 = I$ (Algebra, Lemma \ref{algebra-lemma-pure}).
Since $\Omega_{B/A} = I/I^2$
(Algebra, Lemma \ref{algebra-lemma-differentials-diagonal})
we obtain the vanishing. This means $B$ is formally unramfied over
$A$ by
Algebra, Lemma \ref{algebra-lemma-characterize-formally-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-when-weakly-etale}
Let $A \to B$ be a ring map. Then $A \to B$ is weakly \'etale in each
of the following cases
\begin{enumerate}
\item $B = S^{-1}A$ is a localization of $A$,
\item $A \to B$ is \'etale,
\item $B$ is a filtered colimit of weakly \'etale $A$-algebras.
\end{enumerate}
\end{lemma}

\begin{proof}
An \'etale ring map is flat and the map $B \otimes_A B \to B$ is
also \'etale as a map between \'etale $A$-algebras
(Algebra, Lemma \ref{algebra-lemma-map-between-etale}).
This proves (2).

\medskip\noindent
Let $B_i$ be a directed system of weakly \'etale $A$-algebras.
Then $B = \colim B_i$ is flat over $A$ by
Algebra, Lemma \ref{algebra-lemma-colimit-flat}.
Note that the transition maps $B_i \to B_{i'}$ are flat
by Lemma \ref{lemma-weakly-etale-permanence}.
Hence $B$ is flat over $B_i$ for each $i$, and we see that $B$ is flat
over $B_i \otimes_A B_i$ by
Algebra, Lemma \ref{algebra-lemma-composition-flat}.
Thus $B$ is flat over $B \otimes_A B = \colim B_i \otimes_A B_i$
by Algebra, Lemma \ref{algebra-lemma-colimit-rings-flat}.

\medskip\noindent
Part (1) can be proved directly, but also follows by combining
(2) and (3).
\end{proof}

\begin{lemma}
\label{lemma-absolutely-flat-fields}
Let $K \subset L$ be an extension of fields. If $L \otimes_K L \to L$
is flat, then $L$ is an algebraic separable extension of $K$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-go-down} we see that any subfield
$K \subset L' \subset L$ the map $L' \otimes_K L' \to L'$ is flat.
Thus we may assume $L$ is a finitely generated field extension of $K$.
In this case the fact that $L/K$ is formally unramified
(Lemma \ref{lemma-formally-unramified})
implies that $L/K$ is finite separable, see Algebra, Lemma
\ref{algebra-lemma-characterize-separable-algebraic-field-extensions}.
\end{proof}

\begin{lemma}
\label{lemma-absolutely-flat-over-field}
Let $K$ be a field. Let $K \to B$ be a ring map such that
$B \otimes_K B \to B$ is flat. Then $B$ is a filtered colimit of
\'etale $K$-algebras.
\end{lemma}

\begin{proof}
A field is absolutely flat ring, hence $B$ is a absolutely
flat ring by Lemma \ref{lemma-absolutely-flat-over-absolutely-flat}.
Hence $B$ is reduced and every local
ring is a field, see Lemma \ref{lemma-absolutely-flat}.

\medskip\noindent
Let $\mathfrak q \subset B$ be a prime. The ring map
$B \to B_\mathfrak q$ is weakly \'etale, hence $B_\mathfrak q$
is weakly \'etale over $K$ (Lemma \ref{lemma-composition-weakly-etale}).
Thus $B_\mathfrak p$ is a separable algebraic extension of $K$ by
Lemma \ref{lemma-absolutely-flat-fields}.

\medskip\noindent
Let $K \subset A \subset B$ be a finitely generated $K$-sub algebra.
Then every minimal prime $\mathfrak p \subset A$ is the image of a prime
$\mathfrak q$ of $B$, see
Algebra, Lemma \ref{algebra-lemma-injective-minimal-primes-in-image}.
Thus $\kappa(\mathfrak p)$ as a subfiedl of
$B_\mathfrak q = \kappa(\mathfrak q)$ is separable algebraic over $K$.
Hence every generic point of $\Spec(A)$
is closed (Algebra, Lemma \ref{algebra-lemma-finite-residue-extension-closed}).
Thus $\dim(A) = 0$.
Then $A$ is the product of its local rings, e.g., by
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}.
Moreover, since $A$ is reduced, all local rings are equal
to their residue fields wich are finite separable over $K$.
This means that $A$ is \'etale over $K$ by
Algebra, Lemma \ref{algebra-lemma-etale-over-field}
and finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-weakly-etale-residue-field-extensions}
Let $A \to B$ be a ring map. If $A \to B$ is weakly \'etale, then
$A \to B$ induces separable algebraic residue field extensions.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be a prime of $A$. Then
$\kappa(\mathfrak p) \to B \otimes_A \kappa(\mathfrak p)$ is weakly \'etale by
Lemma \ref{lemma-base-change-weakly-etale}.
Hence $B \otimes_A \kappa(\mathfrak p)$ is a filtered colimit of
\'etale $\kappa(\mathfrak p)$-algebras by
Lemma \ref{lemma-absolutely-flat-over-field}.
Hence for $\mathfrak q \subset B$ lying over $\mathfrak p$ the
extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is
a filtered colimit of finite separable extensions by
Algebra, Lemma \ref{algebra-lemma-etale-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-weak-dimension-at-most-1}
Let $A$ be a ring. The following are equivalent
\begin{enumerate}
\item $A$ has weak dimension $\leq 1$,
\item every ideal of $A$ is flat,
\item every finitely generated ideal of $A$ is flat,
\item every submodule of a flat $A$-module is flat.
\end{enumerate}
\end{lemma}

\begin{proof}
If $A$ has weak dimension $\leq 1$, then the resolution
$0 \to I \to A \to A/I \to 0$ shows that every ideal $I$ is
is flat by Lemma \ref{lemma-last-one-flat}.
Hence (1) $\Rightarrow$ (2).

\medskip\noindent
Assume (4). Let $M$ be an $A$-module. Choose a surjection
$F \to M$ where $F$ is a free $A$-module. Then $\text{Ker}(F \to M)$
is flat by assumption, and we see that $M$ has tor dimension
$\leq 1$ by Lemma \ref{lemma-tor-dimension}.
Hence (4) $\Rightarrow$ (1).

\medskip\noindent
Every ideal is the union of the finitely generated ideals
contained in it. Hence (3) implies (2) by
Algebra, Lemma \ref{algebra-lemma-colimit-flat}.
Thus (3) and (2) are equivalent.

\medskip\noindent
Assume (2). Suppose that $N \subset M$ with $M$ a flat $A$-module.
We will prove that $N$ is flat.
We can write $M = \colim M_i$ with each $M_i$ finite free, see
Algebra, Theorem \ref{algebra-theorem-lazard}.
Setting $N_i \subset M_i$ the inverse image of $N$ we see that
$N = \colim N_i$. By
Algebra, Lemma \ref{algebra-lemma-colimit-flat}.
it suffices to prove $N_i$ is flat and we reduce
to the case $M = R^{\oplus n}$. In this case
the module $N$ has a finite filtration by the submodules
$R^{\oplus j} \cap N$ whose subquotients are ideals.
By (2) these ideals are flat and hence $N$ is flat by
Algebra, Lemma \ref{algebra-lemma-flat-ses}.
\end{proof}

\begin{lemma}
\label{lemma-product-weak-dimension-at-most-1}
Let $J$ be a set. For each $j \in J$ let
$A_j$ be a valuation ring with fraction field $K_j$.
Set $A = \prod A_j$ and $K = \prod K_j$.
Then $A$ is has weak dimension at most $1$ and $A \to K$ is
a localization.
\end{lemma}

\begin{proof}
Let $I \subset A$ be a finitely generated ideal.
By Lemma \ref{lemma-weak-dimension-at-most-1}
it suffices to show that $I$ is a flat $A$-module.
Let $I_j \subset A_j$ be the image of $I$.
Observe that $I_j = I \otimes_A A_j$, hence
$I \to \prod I_j$ is surjective by
Algebra, Proposition \ref{algebra-proposition-fg-tensor}.
Thus $I = \prod I_j$.
Since $A_j$ is a valuation ring, the ideal $I_j$
is generated by a single element
(Algebra, Lemma \ref{algebra-lemma-characterize-valuation-ring}).
Say $I_j = (f_j)$. Then $I$ is generated by the element $f = (f_j)$.
Let $e \in A$ be the idempotent which has a $0$ or $1$
in $A_j$ depending on whether $f_j$ is $0$ or $1$.
Then $f = g e$ for some nonzero divisor $g \in A$:
take $g = (g_j)$ with $g_j = 1$ if $f_j = 0$ and $g_j = f_j$ else.
Thus $I \cong (e)$ as a module. We conclude $I$ is flat as $(e)$ is a
direct summand of $A$. The final statement is true because
$K = S^{-1}A$ where $S = \prod (A_j \setminus \{0\})$.
\end{proof}

\begin{lemma}
\label{lemma-product-found-valuation-rings}
Let $A$ be a normal domain with fraction field $K$.
There exists a cartesian diagram
$$
\xymatrix{
A \ar[d] \ar[r] & K \ar[d] \\
V \ar[r] & L
}
$$
of rings where $V$ has weak dimension at most $1$
and $V \to L$ is a flat, injective, epimorphism of rings.
\end{lemma}

\begin{proof}
For every $x \in K$, $x \not \in A$ pick $V_x \subset K$ as in
Algebra, Lemma \ref{algebra-lemma-find-valuation-rings}.
Set $V = \prod_{x \in K \setminus A} V_x$ and
$L = \prod_{x \in K \setminus A} K$. The ring $V$
has weak dimension at most $1$ by
Lemma \ref{lemma-product-weak-dimension-at-most-1}
which also shows that $V \to K$ is a localization.
A localization is flat and an epimorphism, see
Algebra, Lemmas \ref{algebra-lemma-flat-localization} and
\ref{algebra-lemma-epimorphism-local}.
\end{proof}

\begin{lemma}
\label{lemma-weak-dimension-at-most-1-integrally-closed}
Let $A$ be a ring of weak dimension at most $1$.
If $A \to B$ is a flat, injective, epimorphism of rings, then
$A$ is integrally closed in $B$.
\end{lemma}

\begin{proof}
Let $x \in B$ be integral over $A$. Let $A' = A[x] \subset B$.
Then $A'$ is a finite ring extension of $A$ by
Algebra, Lemma \ref{algebra-lemma-characterize-finite-in-terms-of-integral}.
To show $A = A'$ it suffices to show $A \to A'$ is an epimorphism by
Algebra, Lemma \ref{algebra-lemma-finite-epimorphism-surjective}.
Note that $A'$ is flat over $A$ by assumption on $A$ and the fact that
$B$ is flat over $A$ (Lemma \ref{lemma-weak-dimension-at-most-1}).
Hence the composition
$$
A' \otimes_A A' \to B \otimes_A A' \to B \otimes_A B \to B
$$
is injective, i.e., $A' \otimes_A A' \cong A'$ and the lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-normality-goes-up}
Let $A$ be a normal domain with fraction field $K$.
Let $A \to B$ be weakly \'etale. Then
$B$ is integrally closed in $B \otimes_A K$.
\end{lemma}

\begin{proof}
Choose a diagram as in Lemma \ref{lemma-product-found-valuation-rings}.
As $A \to B$ is flat, the base change gives a cartesian diagram
$$
\xymatrix{
B \ar[d] \ar[r] & B \otimes_A K \ar[d] \\
B \otimes_A V \ar[r] & B \otimes_A L
}
$$
of rings. Note that $V \to B \otimes_A V$ is weakly \'etale
(Lemma \ref{lemma-base-change-weakly-etale}), hence $B \otimes_A V$
has weak dimension at most $1$ by Lemma \ref{lemma-weak-dimension-goes-up}.
Note that $B \otimes_A V \to B \otimes_A L$ is a flat, injective,
epimorphism of rings as a flat base change of such
(Algebra, Lemmas \ref{algebra-lemma-flat-base-change} and
\ref{algebra-lemma-base-change-epimorphism}).
By Lemma \ref{lemma-weak-dimension-at-most-1-integrally-closed}
we see that $B \otimes_A V$ is integrally closed in $B \otimes_A L$.
It follows from the cartesian property of the diagram
that $B$ is integrally closed in $B \otimes_A K$.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-henselian}
Let $A \to B$ be a ring homomorphism.
Assume
\begin{enumerate}
\item $A$ is a henselian local ring,
\item $A \to B$ is integral,
\item $B$ is a domain.
\end{enumerate}
Then $B$ is a henselian local ring and $A \to B$ is a local homomorphism.
If $A$ is strictly henselian, then $B$ is a strictly henselian local ring
and the extension $\kappa(\mathfrak m_A) \subset \kappa(\mathfrak m_B)$
of residue fields is purely inseparable.
\end{lemma}

\begin{proof}
Write $B$ as a filtered colimit $B = \colim B_i$ of finite $A$-sub algebras.
If we prove the results for each $B_i$, then the result follows for $B$.
See Algebra, Lemma \ref{algebra-lemma-colimit-henselian}.
If $A \to B$ is finite, then $B$ is a product of local henselian rings by
Algebra, Lemma \ref{algebra-lemma-finite-over-henselian}.
Since $B$ is a domain we see that $B$ is a local ring.
The maximal ideal of $B$ lies over the maximal ideal of $A$ by
going up for $A \to B$ (Algebra, Lemma \ref{algebra-lemma-integral-going-up}).
If $A$ is strictly henselian, then the field extension
$\kappa(\mathfrak m_A) \subset \kappa(\mathfrak m_B)$
being algebraic, has to be purely inseparable.
Of course, then $\kappa(\mathfrak m_B)$ is separably algebraically
closed and $B$ is strictly henselian.
\end{proof}

\begin{lemma}
\label{lemma-local-tensor-with-integral}
Let $A \to B$ and $A \to C$ be local homomorphisms of local rings.
If $A \to C$ is integral and
$\kappa(\mathfrak m_A) \subset \kappa(\mathfrak m_C)$ is purely
inseparable, then $D = B \otimes_A C$ is a local ring and
$B \to D$ and $C \to D$ are local.
\end{lemma}

\begin{proof}
Any maximal ideal of $D$ lies over the maximal ideal of $B$ by
going up for the integral ring map
$B \to D$ (Algebra, Lemma \ref{algebra-lemma-integral-going-up}).
Now $D/\mathfrak m_B D = \kappa(\mathfrak m_B) \otimes_A C =
\kappa(\mathfrak m_B) \otimes_{\kappa(\mathfrak m_A)} C/\mathfrak m_A C$.
The spectrum of $C/\mathfrak m_A C$ consists of a
single point, namely $\mathfrak m_C$. Thus the spectrum of
$D/\mathfrak m_B D$ is the same as the spectrum of
$\kappa(\mathfrak m_B) \otimes_{\kappa(\mathfrak m_A)} \kappa(\mathfrak m_C)$
which is a single point by our assumption that
$\kappa(\mathfrak m_A) \subset \kappa(\mathfrak m_C)$ is purely
inseparable. This proves that $D$ is local and that the ring maps
$B \to D$ and $C \to D$ are local.
\end{proof}

\begin{theorem}[Olivier]
\label{theorem-olivier}
Let $A \to B$ be a local homomorphism of local rings.
If $A$ is strictly henselian and $A \to B$ is weakly \'etale, then
$A = B$.
\end{theorem}

\begin{proof}
We will show that for all $\mathfrak p \subset A$ there is a unique
prime $\mathfrak q \subset B$ lying over $\mathfrak p$ and
$\kappa(\mathfrak p) = \kappa(\mathfrak q)$.
This implies that $B \otimes_A B \to B$ is bijective on spectra
as well as surjective and flat. Hence it is an isomorphism
for example by the description of pure ideals in
Algebra, Lemma \ref{algebra-lemma-pure-open-closed-specializations}.
Hence $A \to B$ is a faithfully flat epimorphism of rings. We get
$A = B$ by
Algebra, Lemma \ref{algebra-lemma-faithfully-flat-epimorphism}.

\medskip\noindent
Note that the fibre ring $B \otimes_A \kappa(\mathfrak p)$
is a colimit of \'etale extensions of $\kappa(\mathfrak p)$ by
Lemmas \ref{lemma-base-change-weakly-etale} and
\ref{lemma-absolutely-flat-over-field}.
Hence, if there exists more than one prime lying over $\mathfrak p$
or if $\kappa(\mathfrak p) \not = \kappa(\mathfrak q)$ for some $\mathfrak q$,
then $B \otimes_A L$ has a nontrivial idempotent for some (separable)
algebraic field extension $L \supset \kappa(\mathfrak p)$.

\medskip\noindent
Let $\kappa(\mathfrak p) \subset L$ be an algebraic field extension.
Let $A' \subset L$ be the integral closure of $A/\mathfrak p$ in $L$.
By Lemma \ref{lemma-integral-over-henselian}
we see that $A'$ is a strictly henselian local ring
whose residue field is a purely inseparable extension of the residue
field of $A$. Thus $B \otimes_A A'$ is a local ring by
Lemma \ref{lemma-local-tensor-with-integral}.
On the other hand, $B \otimes_A A'$ is integrally closed in
$B \otimes_A L$ by Lemma \ref{lemma-normality-goes-up}.
Since $B \otimes_A A'$ is local, it follows that the ring
$B \otimes_A L$ does not have nontrivial
idempotents which is what we wanted to prove.
\end{proof}















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
