\input{preamble}

% OK, start here.
%
\begin{document}

\title{Obsolete}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we put some lemmas that have become ``obsolete''
(see \cite{Miller}).


\section{Preliminaries}
\label{section-preliminaries}

\begin{remark}
\label{remark-composition-of-adjoints-isomorphic-to-identity}
The information which used to be contained in this remark is now
subsumed in the combination of
Categories, Lemmas \ref{categories-lemma-adjoint-fully-faithful} and
\ref{categories-lemma-left-adjoint-composed-fully-faithful}.
\end{remark}


\section{Homological algebra}
\label{section-homological-algebra}

\begin{remark}
\label{remark-weak-serre-subcategory}
The following remarks are obsolete as they are subsumed in
Homology, Lemmas \ref{homology-lemma-biregular-ss-converges} and
\ref{homology-lemma-first-quadrant-ss}.
Let $\mathcal{A}$ be an abelian category.
Let $\mathcal{C} \subset \mathcal{A}$
be a weak Serre subcategory (see
Homology, Definition \ref{homology-definition-serre-subcategory}).
Suppose that $K^{\bullet, \bullet}$ is a double complex to which
Homology, Lemma \ref{homology-lemma-first-quadrant-ss}
applies such that for some $r \geq 0$ all the objects
${}'E_r^{p, q}$ belong to $\mathcal{C}$. Then all the cohomology groups
$H^n(sK^\bullet)$ belong to $\mathcal{C}$. Namely, the assumptions imply
that the kernels and images of ${}'d_r^{p, q}$ are in $\mathcal{C}$.
Whereupon we see that each ${}'E_{r + 1}^{p, q}$ is in $\mathcal{C}$.
By induction we see that each ${}'E_\infty^{p, q}$ is in $\mathcal{C}$.
Hence each $H^n(sK^\bullet)$ has a finite filtration whose subquotients
are in $\mathcal{C}$. Using that $\mathcal{C}$ is closed under extensions
we conclude that $H^n(sK^\bullet)$ is in $\mathcal{C}$ as claimed.
The same result holds for the second spectral sequence associated
to $K^{\bullet, \bullet}$. Similarly, if $(K^\bullet, F)$ is a filtered
complex to which
Homology, Lemma \ref{homology-lemma-biregular-ss-converges}
applies and for some $r \geq 0$ all the objects $E_r^{p, q}$
belong to $\mathcal{C}$, then each $H^n(K^\bullet)$ is
an object of $\mathcal{C}$.
\end{remark}




\section{Obsolete algebra lemmas}
\label{section-algebra}

\begin{lemma}
\label{lemma-finite-presentation-module-independent}
Let $M$ be an $R$-module of finite presentation.
For any surjection $\alpha : R^{\oplus n} \to M$ the
kernel of $\alpha$ is a finite $R$-module.
\end{lemma}

\begin{proof}
This is a special case of Algebra, Lemma \ref{algebra-lemma-extension}.
\end{proof}

\begin{lemma}
\label{lemma-p-ring-map}
Let $\varphi : R \to S$ be a ring map. If
\begin{enumerate}
\item for any $x \in S$ there exists $n > 0$ such that
$x^n$ is in the image of $\varphi$, and
\item for any $x \in \Ker(\varphi)$ there exists $n > 0$
such that $x^n = 0$,
\end{enumerate}
then $\varphi$ induces a homeomorphism on spectra. Given a
prime number $p$ such that
\begin{enumerate}
\item[(a)] $S$ is generated as an $R$-algebra by elements $x$ such
that there exists an $n > 0$ with $x^{p^n} \in \varphi(R)$ and
$p^nx \in \varphi(R)$, and
\item[(b)] the kernel of $\varphi$ is generated by nilpotent elements,
\end{enumerate}
then (1) and (2) hold, and for any ring map $R \to R'$
the ring map $R' \to R' \otimes_R S$ also satisfies (a), (b), (1), and (2)
and in particular induces a homeomorphism on spectra.
\end{lemma}

\begin{proof}
This is a combination of
Algebra, Lemmas \ref{algebra-lemma-powers} and
\ref{algebra-lemma-p-ring-map}.
\end{proof}

\noindent
The following technical lemma says that you can lift any sequence
of relations from a fibre to the whole space of a ring
map which is essentially of finite type, in a suitable sense.

\begin{lemma}
\label{lemma-lift-elements-ideal}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p$.
Assume $S_{\mathfrak q}$ is essentially of finite type over $R_\mathfrak p$.
Assume given
\begin{enumerate}
\item an integer $n \geq 0$,
\item a prime $\mathfrak a \subset \kappa(\mathfrak p)[x_1, \ldots, x_n]$,
\item a surjective $\kappa(\mathfrak p)$-homomorphism
$$
\psi : (\kappa(\mathfrak p)[x_1, \ldots, x_n])_{\mathfrak a}
\longrightarrow
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q},
$$
and
\item elements $\overline{f}_1, \ldots, \overline{f}_e$ in $\Ker(\psi)$.
\end{enumerate}
Then there exist
\begin{enumerate}
\item an integer $m \geq 0$,
\item and element $g \in S$, $g \not\in \mathfrak q$,
\item a map
$$
\Psi :
R[x_1, \ldots, x_n, x_{n + 1}, \ldots, x_{n + m}]
\longrightarrow
S_g,
$$
and
\item elements $f_1, \ldots, f_e, f_{e + 1}, \ldots, f_{e + m}$
of $\Ker(\Psi)$
\end{enumerate}
such that
\begin{enumerate}
\item the following diagram commutes
$$
\xymatrix{
R[x_1, \ldots, x_{n + m}] \ar[d]_\Psi
\ar[rr]_-{x_{n + j} \mapsto 0} & &
(\kappa(\mathfrak p)[x_1, \ldots, x_n])_{\mathfrak a} \ar[d]^\psi \\
S_g \ar[rr] & &
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q}
},
$$
\item the element $f_i$, $i \leq n$ maps to a unit times
$\overline{f}_i$ in the local ring
$$
(\kappa(\mathfrak p)[x_1, \ldots, x_{n + m}])_{
(\mathfrak a, x_{n + 1}, \ldots, x_{n + m})},
$$
\item the element $f_{e + j}$ maps to
a unit times $x_{n + j}$ in the same local ring, and
\item the induced map $R[x_1, \ldots, x_{n + m}]_{\mathfrak b}
\to S_{\mathfrak q}$ is surjective, where
$\mathfrak b = \Psi^{-1}(\mathfrak qS_g)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We claim that it suffices to prove the lemma in case $R$
and $S$ are local with maximal ideals $\mathfrak p$ and $\mathfrak q$.
Namely, suppose we have constructed
$$
\Psi' : R_{\mathfrak p}[x_1, \ldots, x_{n + m}]
\longrightarrow
S_{\mathfrak q}
$$
and $f_1', \ldots, f_{e + m}' \in R_{\mathfrak p}[x_1, \ldots, x_{n + m}]$
with all the required properties. Then there exists an element
$f \in R$, $f \not \in \mathfrak p$ such that each
$ff_k'$ comes from an element $f_k \in R[x_1, \ldots, x_{n + m}]$.
Moreover, for a suitable $g \in S$, $g \not \in \mathfrak q$
the elements $\Psi'(x_i)$ are the image of elements
$y_i \in S_g$. Let $\Psi$ be the $R$-algebra map defined
by the rule $\Psi(x_i) = y_i$. Since $\Psi(f_i)$ is zero
in the localization $S_{\mathfrak q}$ we may after possibly
replacing $g$ assume that $\Psi(f_i) = 0$. This proves the claim.

\medskip\noindent
Thus we may assume $R$ and $S$ are local
with maximal ideals $\mathfrak p$ and $\mathfrak q$.
Pick $y_1, \ldots, y_n \in S$ such that
$y_i \bmod \mathfrak pS = \psi(x_i)$.
Let $y_{n + 1}, \ldots, y_{n + m} \in S$ be elements which generate
an $R$-subalgebra of which $S$ is the localization.
These exist by the assumption that $S$ is essentially of
finite type over $R$. Since $\psi$ is surjective we
may write $y_{n + j} \bmod \mathfrak pS = \psi(h_j)$ for
some $h_j \in \kappa(\mathfrak p)[x_1, \ldots, x_n]_{\mathfrak a}$.
Write $h_j = g_j/d$, $g_j \in \kappa(\mathfrak p)[x_1, \ldots, x_n]$
for some common denominator $d \in \kappa(\mathfrak p)[x_1, \ldots, x_n]$,
$d \not \in \mathfrak a$. Choose lifts $G_j, D \in R[x_1, \ldots, x_n]$
of $g_j$ and $d$. Set
$y_{n + j}' = D(y_1, \ldots, y_n) y_{n + j} - G_j(y_1, \ldots, y_n)$.
By construction $y_{n + j}' \in \mathfrak p S$.
It is clear that $y_1, \ldots, y_n, y_n', \ldots, y_{n + m}'$
generate an $R$-subalgebra of $S$ whose localization is $S$.
We define
$$
\Psi : R[x_1, \ldots, x_{n + m}] \to S
$$
to be the map that sends $x_i$ to $y_i$ for $i = 1, \ldots, n$
and $x_{n + j}$ to $y'_{n + j}$ for $j = 1, \ldots, m$. Properties
(1) and (4) are clear by construction. Moreover the ideal
$\mathfrak b$ maps onto the ideal
$(\mathfrak a, x_{n + 1}, \ldots, x_{n + m})$
in the polynomial ring $\kappa(\mathfrak p)[x_1, \ldots, x_{n + m}]$.

\medskip\noindent
Denote $J = \Ker(\Psi)$. We have a short exact sequence
$$
0 \to J_{\mathfrak b}
\to R[x_1, \ldots, x_{n + m}]_{\mathfrak b}
\to S_{\mathfrak q}
\to 0.
$$
The surjectivity comes from our choice of
$y_1, \ldots, y_n, y_n', \ldots, y_{n + m}'$ above.
This implies that
$$
J_{\mathfrak b}/ \mathfrak pJ_{\mathfrak b}
\to \kappa(\mathfrak p)[x_1, \ldots, x_{n + m}]_{
(\mathfrak a, x_{n + 1}, \ldots, x_{n + m})}
\to S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}
\to 0
$$
is exact. By construction $x_i$ maps to $\psi(x_i)$ and
$x_{n + j}$ maps to zero under the last map.
Thus it is easy to choose $f_i$ as in
(2) and (3) of the lemma.
\end{proof}

\begin{remark}[Projective resolutions]
\label{remark-projective-resolution}
Let $R$ be a ring.
For any set $S$ we let $F(S)$ denote the free $R$-module on $S$.
Then any left $R$-module has the following two step resolution
$$
F(M \times M) \oplus F(R \times M) \to F(M) \to M \to 0.
$$
The first map is given by the rule
$$
[m_1, m_2] \oplus [r, m] \mapsto [m_1 + m_2] - [m_1] - [m_2] + [rm] - r[m].
$$
\end{remark}

\begin{lemma}
\label{lemma-spec-localization-first}
Let $S$ be a multiplicative set of $A$. Then the map
$$
f: \Spec(S^{-1}A)\longrightarrow \Spec(A)
$$
induced by the canonical ring map
$A \to S^{-1}A$ is a homeomorphism onto its image and
$\Im(f) = \{ \mathfrak p \in \Spec(A) : \mathfrak p\cap S = \emptyset \}$.
\end{lemma}

\begin{proof}
This is a duplicate of Algebra, Lemma \ref{algebra-lemma-spec-localization}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-over-integral-algebra}
Let $A \to B$ be a finite type, flat ring map with $A$ an integral
domain. Then $B$ is a finitely presented $A$-algebra.
\end{lemma}

\begin{proof}
Special case of More on Flatness, Proposition
\ref{flat-proposition-flat-finite-type-finite-presentation-domain}.
\end{proof}

\begin{lemma}
\label{lemma-helper-finite-type-flat-finite-presentation}
Let $R$ be a domain with fraction field $K$.
Let $S = R[x_1, \ldots, x_n]$ be a polynomial ring over $R$.
Let $M$ be a finite $S$-module. Assume that $M$ is flat over $R$.
If for every subring $R \subset R' \subset K$, $R \not = R'$
the module $M \otimes_R R'$ is finitely presented
over $S \otimes_R R'$, then $M$ is finitely presented over $S$.
\end{lemma}

\begin{proof}
This lemma is true because $M$ is finitely presented even without the
assumption that $M \otimes_R R'$ is finitely presented for every $R'$
as in the statement of the lemma. This follows from More on Flatness,
Proposition \ref{flat-proposition-flat-finite-type-finite-presentation-domain}.
Originally this lemma had an erroneous proof (thanks to Ofer Gabber
for finding the gap) and was used in an alternative proof of
the proposition cited. To reinstate this lemma, we need a correct argument
in case $R$ is a local normal domain using only
results from the chapters on commutative algebra; please email
\href{mailto:stacks.project@gmail.com}{stacks.project@gmail.com}
if you have an argument.
\end{proof}

\begin{lemma}
\label{lemma-relative-effective-cartier-algebra}
Let $A \to B$ be a ring map. Let $f \in B$. Assume that
\begin{enumerate}
\item $A \to B$ is flat,
\item $f$ is a nonzerodivisor, and
\item $A \to B/fB$ is flat.
\end{enumerate}
Then for every ideal $I \subset A$ the map
$f : B/IB \to B/IB$ is injective.
\end{lemma}

\begin{proof}
Note that $IB = I \otimes_A B$ and $I(B/fB) = I \otimes_A B/fB$
by the flatness of $B$ and $B/fB$ over $A$.
In particular $IB/fIB \cong I \otimes_A B/fB$ maps injectively
into $B/fB$. Hence the result follows from the snake lemma applied
to the diagram
$$
\xymatrix{
0 \ar[r] &
I \otimes_A B \ar[r] \ar[d]^f &
B \ar[r] \ar[d]^f &
B/IB \ar[r] \ar[d]^f &
0 \\
0 \ar[r] &
I \otimes_A B \ar[r] &
B \ar[r] &
B/IB \ar[r] &
0
}
$$
with exact rows.
\end{proof}

\begin{lemma}
\label{lemma-faithfully-flat-injective}
If $R \to S$ is a faithfully flat ring map then for every $R$-module
$M$ the map $M \to S \otimes_R M$, $x \mapsto 1 \otimes x$ is injective.
\end{lemma}

\begin{proof}
This lemma is a duplicate of
Algebra, Lemma \ref{algebra-lemma-faithfully-flat-universally-injective}.
\end{proof}

\begin{remark}
\label{remark-section-colimits}
This reference/tag used to refer to a Section in
the chapter Smoothing Ring Maps, but the material has
since been subsumed in Algebra, Section \ref{algebra-section-colimits-flat}.
\end{remark}

\begin{lemma}
\label{lemma-not-domain}
Let $(R, \mathfrak m)$ be a reduced Noetherian local ring of dimension $1$
and let $x \in \mathfrak m$ be a nonzerodivisor. Let
$\mathfrak q_1, \ldots, \mathfrak q_r$ be the minimal primes of $R$.
Then
$$
\text{length}_R(R/(x)) = \sum\nolimits_i \text{ord}_{R/\mathfrak q_i}(x)
$$
\end{lemma}

\begin{proof}
Special (very easy) case of
Chow Homology, Lemma \ref{chow-lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-bound-primes}
Let $A$ be a Noetherian local normal domain of dimension $2$.
For $f \in \mathfrak m$ nonzero denote
$\text{div}(f) = \sum n_i (\mathfrak p_i)$
the divisor associated to $f$ on the punctured spectrum of $A$.
We set $|f| = \sum n_i$. There exist integers $N$ and $M$
such that $|f + g| \leq M$ for all $g \in \mathfrak m^N$.
\end{lemma}

\begin{proof}
Pick $h \in \mathfrak m$ such that $f, h$ is a regular sequence in $A$
(this follows from Algebra, Lemmas \ref{algebra-lemma-criterion-normal} and
\ref{algebra-lemma-depth-drops-by-one}).
We will prove the lemma with $M = \text{length}_A(A/(f, h))$ and with
$N$ any integer such that $\mathfrak m^N \subset (f, h)$. Such
an integer $N$ exists because $\sqrt{(f, h)} = \mathfrak m$. Note that
$M = \text{length}_A(A/(f + g, h))$ for all $g \in \mathfrak m^N$
because $(f, h) = (f + g, h)$. This moreover implies that $f + g, h$
is a regular sequence in $A$ too, see
Algebra, Lemma \ref{algebra-lemma-reformulate-CM}.
Now suppose that $\text{div}(f + g ) = \sum m_j (\mathfrak q_j)$.
Then consider the map
$$
c : A/(f + g) \longrightarrow \prod A/\mathfrak q_j^{(m_j)}
$$
where $\mathfrak q_j^{(m_j)}$ is the symbolic power, see
Algebra, Section \ref{algebra-section-symbolic-power}.
Since $A$ is normal, we see that $A_{\mathfrak q_i}$ is
a discrete valuation ring and hence
$$
A_{\mathfrak q_i}/(f + g) =
A_{\mathfrak q_i}/\mathfrak q_i^{m_i} A_{\mathfrak q_i} =
(A/\mathfrak q_i^{(m_i)})_{\mathfrak q_i}
$$
Since $V(f + g, h) = \{\mathfrak m\}$ this implies that $c$ becomes
an isomorphism on inverting $h$ (small detail omitted). Since $h$ is a
nonzerodivisor on $A/(f + g)$ we see that the length of $A/(f + g, h)$
equals the Herbrand quotient $e_A(A/(f + g), 0, h)$
as defined in Chow Homology, Section
\ref{chow-section-periodic-complexes}.
Similarly the length of $A/(h, \mathfrak q_j^{(m_j)})$ equals
$e_A(A/\mathfrak q_j^{(m_j)}, 0, h)$. Then we have
\begin{align*}
M & = \text{length}_A(A/(f + g, h) \\
& =
e_A(A/(f + g), 0, h) \\
& =
\sum\nolimits_i e_A(A/\mathfrak q_j^{(m_j)}, 0, h) \\
& =
\sum\nolimits_i \sum\nolimits_{m = 0, \ldots, m_j - 1}
e_A(\mathfrak q_j^{(m)}/\mathfrak q_j^{(m + 1)}, 0, h)
\end{align*}
The equalities follow from Chow Homology, Lemmas
\ref{chow-lemma-additivity-periodic-length} and
\ref{chow-lemma-finite-periodic-length}
using in particular that
the cokernel of $c$ has finite length as discussed above.
It is straightforward to prove that
$e_A(\mathfrak q^{(m)}/\mathfrak q^{(m + 1)}, 0, h)$
is at least $1$ by Nakayama's lemma. This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-flat-over-gorenstein-gorenstein-fibre}
Let $A \to B$ be a flat local homomorphism of Noetherian local rings.
If $A$ and $B/\mathfrak m_A B$ are Gorenstein, then $B$ is Gorenstein.
\end{lemma}

\begin{proof}
Follows immediately from
Dualizing Complexes, Lemma \ref{dualizing-lemma-flat-under-gorenstein}.
\end{proof}

\begin{lemma}
\label{lemma-kill-local}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Let $s$ be an integer. Assume
\begin{enumerate}
\item $A$ has a dualizing complex,
\item if $\mathfrak p \not \in V(I)$ and
$V(\mathfrak p) \cap V(I) \not = \{\mathfrak m\}$, then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > s$.
\end{enumerate}
Then there exists an $n > 0$ and an ideal $J \subset A$
with $V(J) \cap V(I) = \{\mathfrak m\}$ such that $JI^n$ annihilates
$H^i_\mathfrak m(M)$ for $i \leq s$.
\end{lemma}

\begin{proof}
According to
Local Cohomology, Lemma \ref{local-cohomology-lemma-sitting-in-degrees}
we have to show this for the finite $A$-module
$E^i = \text{Ext}^{-i}_A(M, \omega_A^\bullet)$
for $i \leq s$. The support $Z$ of $E^0 \oplus \ldots \oplus E^s$
is closed in $\Spec(A)$ and does not contain any prime as in (2).
Hence it is contained in $V(JI^n)$ for some $J$ as in
the statement of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-algebraize-local-cohomology-bis-bis}
Let $(A, \mathfrak m)$ be a Noetherian local ring.
Let $I \subset A$ be an ideal. Let $M$ be a finite $A$-module.
Let $s$ and $d$ be integers. Assume
\begin{enumerate}
\item[(a)] $A$ has a dualizing complex,
\item[(b)] $\text{cd}(A, I) \leq d$,
\item[(c)] if $\mathfrak p \not \in V(I)$ then
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) > s$ or
$\text{depth}_{A_\mathfrak p}(M_\mathfrak p) + \dim(A/\mathfrak p) > d + s$.
\end{enumerate}
Then the assumptions of
Algebraic and Formal Geometry, Lemma
\ref{algebraization-lemma-algebraize-local-cohomology-bis} hold
for $A, I, \mathfrak m, M$ and
$H^i_\mathfrak m(M) \to \lim H^i_\mathfrak m(M/I^nM)$
is an isomorphism for $i \leq s$ and these modules are
annihilated by a power of $I$.
\end{lemma}

\begin{proof}
The assumptions of Algebraic and Formal Geometry, Lemma
\ref{algebraization-lemma-algebraize-local-cohomology-bis}
by the more general Algebraic and Formal Geometry, Lemma
\ref{algebraization-lemma-bootstrap-bis-bis}.
Then the conclusion of Algebraic and Formal Geometry, Lemma
\ref{algebraization-lemma-algebraize-local-cohomology-bis}
gives the second statement.
\end{proof}

\begin{lemma}
\label{lemma-combine-one}
In Algebraic and Formal Geometry, Situation
\ref{algebraization-situation-bootstrap}
we have $H^s_\mathfrak a(M) = \lim H^s_\mathfrak a(M/I^nM)$.
\end{lemma}

\begin{proof}
This is immediate from Algebraic and Formal Geometry, Theorem
\ref{algebraization-theorem-final-bootstrap}.
The original version of this lemma, which had additional
assumptions, was superseded by the this theorem.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-simple-one}
Let $A$ be a Noetherian ring. Let $f \in \mathfrak a$ be an element of
an ideal of $A$. Let $U = \Spec(A) \setminus V(\mathfrak a)$. Assume
\begin{enumerate}
\item $A$ has a dualizing complex and is complete with respect to $f$,
\item $A_f$ is $(S_2)$ and for every minimal prime $\mathfrak p \subset A$,
$f \not \in \mathfrak p$ and
$\mathfrak q \in V(\mathfrak p) \cap V(\mathfrak a)$ we have
$\dim((A/\mathfrak p)_\mathfrak q) \geq 3$.
\end{enumerate}
Then the completion functor
$$
\textit{Coh}(\mathcal{O}_U)
\longrightarrow
\textit{Coh}(U, I\mathcal{O}_U),
\quad
\mathcal{F} \longmapsto \mathcal{F}^\wedge
$$
is fully faithful on the full subcategory of finite locally free objects.
\end{lemma}

\begin{proof}
This lemma is a special case of Algebraic and Formal Geometry, Lemma
\ref{algebraization-lemma-fully-faithful-simple-two}.
\end{proof}





\section{Lemmas related to ZMT}
\label{section-ZMT}

\noindent
The lemmas in this section were originally used in the proof of the
(algebraic version of) Zariski's Main Theorem,
Algebra, Theorem \ref{algebra-theorem-main-theorem}.

\begin{lemma}
\label{lemma-change-equation-multiply}
Let $R$ be a ring and let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$. If $t$ is integral over
$R[x]$, then there exists an $\ell \geq 0$ such that
for every $a \in R$ the element $\varphi(a)^\ell t$
is integral over $\varphi_a : R[y] \to S$, defined by
$y \mapsto \varphi(ax)$ and $r \mapsto \varphi(r)$
for $r\in R$.
\end{lemma}

\begin{proof}
Say $t^d + \sum_{i < d} \varphi(f_i)t^i = 0$
with $f_i \in R[x]$. Let $\ell$ be the maximum degree
in $x$ of all the $f_i$. Multiply the equation
by $\varphi(a)^\ell$ to get
$\varphi(a)^\ell t^d + \sum_{i < d} \varphi(a^\ell f_i)t^i = 0$.
Note that each $\varphi(a^\ell f_i)$ is in the image of
$\varphi_a$. The result follows from
Algebra, Lemma \ref{algebra-lemma-make-integral-trivial}.
\end{proof}

\begin{lemma}
\label{lemma-make-integral-less-trivial}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Set $u_n = \varphi(a_n)$, $u_{n-1} = u_n t + \varphi(a_{n-1})$,
and so on till $u_1 = u_2 t + \varphi(a_1)$.
Then all of $u_n, u_{n-1}, \ldots, u_1$ and
$u_nt, u_{n-1}t, \ldots, u_1t$ are integral over $R$,
and the ideals $(\varphi(a_0), \ldots, \varphi(a_n))$ and
$(u_n, \ldots, u_1)$ of $S$ are equal.
\end{lemma}

\begin{proof}
We prove this by induction on $n$. As $u_n = \varphi(a_n)$ we
conclude from
Algebra, Lemma \ref{algebra-lemma-make-integral-trivial}
that $u_nt$ is integral over $R$. Of course
$u_n = \varphi(a_n)$ is integral over $R$. Then
$u_{n - 1} = u_n t  + \varphi(a_{n - 1})$ is integral over $R$ (see
Algebra, Lemma \ref{algebra-lemma-integral-closure-is-ring})
and we have
$$
\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_{n - 1})t^{n - 1} +
u_{n - 1}t^{n - 1} = 0.
$$
Hence by the induction hypothesis applied to the map
$S' \to S$ where $S'$ is the integral closure of $R$ in $S$
and the displayed equation we see that
$u_{n-1}, \ldots, u_1$ and $u_{n-1}t, \ldots, u_1t$
are all in $S'$ too. The statement on the ideals is immediate from the
shape of the elements and the fact that $u_1t + \varphi(a_0) = 0$.
\end{proof}

\begin{lemma}
\label{lemma-make-integral-not-in-ideal}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Let $J \subset S$ be an ideal such that for at
least one $i$ we have $\varphi(a_i) \not \in J$.
Then there exists a $u \in S$, $u \not\in J$ such
that both $u$ and $ut$ are integral over $R$.
\end{lemma}

\begin{proof}
This is immediate from Lemma \ref{lemma-make-integral-less-trivial}
since one of the elements $u_i$ will not be in $J$.
\end{proof}

\noindent
The following two lemmas are a way of describing closed
subschemes of $\mathbf{P}^1_R$ cut out by one (nondegenerate)
equation.

\begin{lemma}
\label{lemma-P1}
Let $R$ be a ring.
Let $F(X, Y) \in R[X, Y]$ be homogeneous of degree
$d$. Assume that for every prime $\mathfrak p$ of $R$
at least one coefficient of $F$ is not in $\mathfrak p$.
Let $S = R[X, Y]/(F)$ as a graded ring.
Then for all $n \geq d$ the $R$-module $S_n$
is finite locally free of rank $d$.
\end{lemma}

\begin{proof}
The $R$-module $S_n$ has a presentation
$$
R[X, Y]_{n-d} \to R[X, Y]_n \to S_n \to 0.
$$
Thus by Algebra, Lemma \ref{algebra-lemma-cokernel-flat}
it is enough to show that multiplication
by $F$ induces an injective map
$\kappa(\mathfrak p)[X, Y]
\to \kappa(\mathfrak p)[X, Y]$
for all primes $\mathfrak p$.
This is clear from the assumption that
$F$ does not map to the zero polynomial mod $\mathfrak p$.
The assertion on ranks is clear from this as well.
\end{proof}

\begin{lemma}
\label{lemma-rel-prime-pols}
Let $k$ be a field. Let $F, G \in k[X, Y]$ be homogeneous
of degrees $d, e$. Assume $F, G$ relatively prime.
Then multiplication by $G$ is injective on $S = k[X, Y]/(F)$.
\end{lemma}

\begin{proof}
This is one way to define ``relatively prime''. If you have another
definition, then you can show it is equivalent to this one.
\end{proof}

\begin{lemma}
\label{lemma-P1-localize}
Let $R$ be a ring. Let $F(X, Y) \in R[X, Y]$ be homogeneous of degree
$d$. Let $S = R[X, Y]/(F)$ as a graded ring.
Let $\mathfrak p \subset R$ be a prime such that
some coefficient of $F$ is not in $\mathfrak p$.
There exists an $f \in R$ $f \not\in \mathfrak p$,
an integer $e$, and a $G \in R[X, Y]_e$
such that multiplication by $G$ induces isomorphisms
$(S_n)_f \to (S_{n + e})_f$ for all $n \geq d$.
\end{lemma}

\begin{proof}
During the course of the proof we may replace $R$ by $R_f$
for $f\in R$, $f\not\in \mathfrak p$ (finitely often).
As a first step we do such a replacement such that
some coefficient of $F$ is invertible in $R$.
In particular the modules $S_n$ are now locally
free of rank $d$ for $n \geq d$ by Lemma \ref{lemma-P1}.
Pick any $G \in R[X, Y]_e$ such that the image of
$G$ in $\kappa(\mathfrak p)[X, Y]$ is relatively
prime to the image of $F(X, Y)$ (this is possible for some $e$).
Apply Algebra, Lemma \ref{algebra-lemma-cokernel-flat} to the map
induced by multiplication by $G$ from $S_d \to S_{d + e}$.
By our choice of $G$ and Lemma \ref{lemma-rel-prime-pols}
we see
$S_d \otimes \kappa(\mathfrak p) \to S_{d + e} \otimes \kappa(\mathfrak p)$
is bijective. Thus, after replacing $R$ by $R_f$ for a suitable
$f$ we may assume that $G : S_d \to S_{d + e}$
is bijective. This in turn implies that the image
of $G$ in $\kappa(\mathfrak p')[X, Y]$ is relatively
prime to the image of $F$ for all primes $\mathfrak p'$
of $R$. And then by Algebra, Lemma \ref{algebra-lemma-cokernel-flat}
again we see that all the maps
$G : S_d \to S_{d + e}$, $n \geq d$ are isomorphisms.
\end{proof}

\begin{remark}
\label{remark-algebra}
Let $R$ be a ring. Suppose that we have $F \in R[X, Y]_d$
and $G \in R[X, Y]_e$ such that, setting $S = R[X, Y]/(F)$
we have (1) $S_n$ is finite locally free of rank $d$ for
all $n \geq d$, and (2) multiplication by $G$ defines
isomorphisms $S_n \to S_{n + e}$ for all $n \geq d$. In this
case we may define a finite, locally free $R$-algebra
$A$ as follows:
\begin{enumerate}
\item as an $R$-module $A = S_{ed}$, and
\item multiplication $A \times A \to A$ is given by
the rule that $H_1 H_2 = H_3$ if and only if $G^d H_3 = H_1 H_2$
in $S_{2ed}$.
\end{enumerate}
This makes sense because multiplication by $G^d$
induces a bijective map $S_{de} \to S_{2de}$.
It is easy to see that this defines a ring structure.
Note the confusing fact that the element $G^d$
defines the unit element of the ring $A$.
\end{remark}

\begin{lemma}
\label{lemma-finite-after-localization}
Let $R$ be a ring, let $f \in R$.
Suppose we have $S$, $S'$ and the solid arrows
forming the following commutative diagram of rings
$$
\xymatrix{
& S'' \ar@{-->}[rd] \ar@{-->}[dd] &
\\
R \ar[rr] \ar@{-->}[ru] \ar[d] &  & S \ar[d]
\\
R_f \ar[r] & S' \ar[r] & S_f
}
$$
Assume that $R_f \to S'$ is finite. Then we can find
a finite ring map $R \to S''$ and dotted arrows as
in the diagram such that $S' = (S'')_f$.
\end{lemma}

\begin{proof}
Namely, suppose that $S'$ is generated by
$x_i$ over $R_f$, $i = 1, \ldots, w$. Let $P_i(t) \in R_f[t]$
be a monic polynomial such that $P_i(x_i) = 0$.
Say $P_i$ has degree $d_i > 0$. Write
$P_i(t) = t^{d_i} + \sum_{j < d_i} (a_{ij}/f^n) t^j$
for some uniform $n$. Also write
the image of $x_i$ in $S_f$ as $g_i / f^n$
for suitable $g_i \in S$. Then we know
that the element
$\xi_i = f^{nd_i} g_i^{d_i} + \sum_{j < d_i} f^{n(d_i - j)} a_{ij} g_i^j$
of $S$ is killed by a power of $f$.
Hence upon increasing $n$ to $n'$, which replaces
$g_i$ by $f^{n' - n}g_i$ we may assume $\xi_i = 0$.
Then $S'$ is generated by the elements
$f^n x_i$, each of which is a zero of the
monic polynomial $Q_i(t) = t^{d_i} +
\sum_{j < d_i} f^{n(d_i - j)} a_{ij} t^j$
with coefficients in $R$. Also, by construction
$Q_i(f^ng_i) = 0$ in $S$. Thus we get a finite $R$-algebra
$S'' = R[z_1, \ldots, z_w]/(Q_1(z_1), \ldots, Q_w(z_w))$
which fits into a commutative diagram as above.
The map $\alpha : S'' \to S$ maps $z_i$ to $f^ng_i$ and
the map $\beta : S'' \to S'$ maps $z_i$ to $f^nx_i$.
It may not yet be the case that $\beta$ induces an
isomorphism $(S'')_f \cong S'$.
For the moment we only know that this map
is surjective. The problem is that there could be
elements $h/f^n \in (S'')_f$ which map to zero
in $S'$ but are not zero. In this case $\beta(h)$
is an element of $S$ such that $f^N \beta(h) = 0$
for some $N$. Thus $f^N h$ is an element of the ideal
$J = \{h \in S'' \mid \alpha(h) = 0 \text{ and }
\beta(h) = 0\}$ of $S''$. OK, and it is easy to see that
$S''/J$ does the job.
\end{proof}




\section{Formally smooth ring maps}
\label{section-formally-smooth}

\begin{lemma}
\label{lemma-formally-smooth-smooth}
Let $R$ be a ring. Let $S$ be a $R$-algebra.
If $S$ is of finite presentation and formally smooth over $R$
then $S$ is smooth over $R$.
\end{lemma}

\begin{proof}
See Algebra, Proposition \ref{algebra-proposition-smooth-formally-smooth}.
\end{proof}

\begin{remark}
\label{remark-equation-derivatives}
This tag used to refer to an equation in the proof of
Algebraization of Formal Spaces, Proposition
\ref{restricted-proposition-approximate}
which became unused because of a rearrangement of the material.
\end{remark}

\begin{remark}
\label{remark-equation-ci}
This tag used to refer to an equation in the proof of
Algebraization of Formal Spaces, Proposition
\ref{restricted-proposition-approximate}
which became unused because of a rearrangement of the material.
\end{remark}

\begin{remark}
\label{remark-equation-in-ideal}
This tag used to refer to an equation in the proof of
Algebraization of Formal Spaces, Proposition
\ref{restricted-proposition-approximate}
which became unused because of a rearrangement of the material.
\end{remark}

\begin{remark}
\label{remark-equation-derivatives-analogue}
This tag used to refer to an equation in the proof of
Algebraization of Formal Spaces, Proposition
\ref{restricted-proposition-approximate}
which became unused because of a rearrangement of the material.
\end{remark}

\begin{remark}
\label{remark-equation-go-down}
This tag used to refer to an equation in the proof of
Algebraization of Formal Spaces, Lemma
\ref{restricted-lemma-lift-approximation}
which became unused because of a rearrangement of the material.
\end{remark}

\begin{lemma}
\label{lemma-get-morphism-general}
Let $A$ be a Noetherian ring. Let $I \subset A$ be an ideal.
Let $t$ be the minimal number of generators for $I$.
Let $C$ be a Noetherian $I$-adically complete $A$-algebra.
There exists an integer $d \geq 0$ depending only on
$I \subset A \to C$ with the following property: given
\begin{enumerate}
\item $c \geq 0$ and $B$ in
Algebraization of Formal Spaces, Equation (\ref{restricted-equation-C-prime})
such that for $a \in I^c$
multiplication by $a$ on $\NL_{B/A}^\wedge$ is zero in $D(B)$,
\item an integer $n > 2t\max(c, d)$,
\item an $A/I^n$-algebra map $\psi_n : B/I^nB \to C/I^nC$,
\end{enumerate}
there exists a map $\varphi : B \to C$ of $A$-algebras such
that $\psi_n \bmod I^{m - c} = \varphi \bmod I^{m - c}$
with $m = \lfloor \frac{n}{t} \rfloor$.
\end{lemma}

\begin{proof}
This lemma has been obsoleted by the stronger
Algebraization of Formal Spaces, Lemma
\ref{restricted-lemma-get-morphism-general-better}.
In fact, we will deduce the lemma from it.

\medskip\noindent
Let $I \subset A \to C$ be given as in the statement above.
Denote $d(\text{Gr}_I(C))$ and $q(\text{Gr}_I(C))$ the integers found in 
Local Cohomology, Section \ref{local-cohomology-section-uniform}.
Observe that $t$ is an upper bound for the minimal number of generators
of $IC$ and hence we have $d(\text{Gr}_I(C)) + 1 \leq t$, see discussion in
Local Cohomology, Section \ref{local-cohomology-section-uniform}.
We may and do assume $t \geq 1$ since otherwise the lemma does
not say anything. We claim that the lemma is true with
$$
d = q(\text{Gr}_I(C))
$$
Namely, suppose that $c$, $B$, $n$, $\psi_n$ are as in the statement above.
Then we see that
$$
n > 2t\max(c, d) \Rightarrow n \geq 2tc + 1 \Rightarrow
n \geq 2(d(\text{Gr}_I(C)) + 1)c + 1
$$
On the other hand, we have
$$
n > 2t\max(c, d) \Rightarrow n > t(c + d) \Rightarrow
n \geq q(C) + tc \geq q(\text{Gr}_I(C)) + (d(\text{Gr}_I(C)) + 1)c
$$
Hence the assumptions of
Algebraization of Formal Spaces, Lemma
\ref{restricted-lemma-get-morphism-general-better}
are satisfied and we obtain an $A$-algebra homomorphism
$\varphi : B \to C$ which is congruent with $\psi_n$
module $I^{n - (d(\text{Gr}_I(C)) + 1)c}C$.
Since
\begin{align*}
n - (d(\text{Gr}_I(C)) + 1)c
& = \frac{n}{t} + \frac{(t - 1)n}{t} - (d(\text{Gr}_I(C)) + 1)c \\
& \geq \frac{n}{t} + \frac{(d(\text{Gr}_I(C))n}{t} - (d(\text{Gr}_I(C)) + 1)c \\
& > \frac{n}{t} + \frac{d(\text{Gr}_I(C))2tc}{t} - (d(\text{Gr}_I(C)) + 1)c \\
& = \frac{n}{t} + 2d(\text{Gr}_I(C))c - (d(\text{Gr}_I(C)) + 1)c \\
& = \frac{n}{t} + d(\text{Gr}_I(C))c - c \\
& \geq m - c
\end{align*}
we see that we have the congruence of
$\varphi$ and $\psi_n$ module $I^{m - c}C$ as desired.
\end{proof}




\section{Sites and sheaves}
\label{section-sites}

\begin{remark}[No map from lower shriek to pushforward]
\label{remark-from-shriek-to-star}
Let $U$ be an object of a site $\mathcal{C}$. For any abelian sheaf
$\mathcal{G}$ on $\mathcal{C}/U$ one may wonder whether
there is a canonical map
$$
c : j_{U!}\mathcal{G} \longrightarrow j_{U*}\mathcal{G}
$$
To construct such a thing is the same as constructing a map
$j_U^{-1}j_{U!}\mathcal{G} \to \mathcal{G}$.
Note that restriction commutes with sheafification.
Thus we can use the presheaf of
Modules on Sites, Lemma \ref{sites-modules-lemma-extension-by-zero}.
Hence it suffices to define for $V/U$ a map
$$
\bigoplus\nolimits_{\varphi \in \Mor_\mathcal{C}(V, U)}
\mathcal{G}(V \xrightarrow{\varphi} U)
\longrightarrow
\mathcal{G}(V/U)
$$
compatible with restrictions. It looks like we can take the
which is zero on all summands except for the one where $\varphi$
is the structure morphism $\varphi_0 : V \to U$ where we take $1$.
However, this isn't compatible with restriction mappings: namely,
if $\alpha : V' \to V$ is a morphism of $\mathcal{C}$, then
denote $V'/U$ the object of $\mathcal{C}/U$ with structure
morphism $\varphi'_0 = \varphi_0 \circ \alpha$.
We need to check that the diagram
$$
\xymatrix{
\bigoplus\nolimits_{\varphi \in \Mor_\mathcal{C}(V, U)}
\mathcal{G}(V \xrightarrow{\varphi} U)
\ar[d] \ar[r] &
\mathcal{G}(V/U) \ar[d] \\
\bigoplus\nolimits_{\varphi' \in \Mor_\mathcal{C}(V', U)}
\mathcal{G}(V' \xrightarrow{\varphi'} U)
\ar[r] &
\mathcal{G}(V'/U)
}
$$
commutes. The problem here is that there
may be a morphism $\varphi : V \to U$ different from $\varphi_0$
such that $\varphi \circ \alpha = \varphi'_0$.
Thus the left vertical arrow will send the summand corresponding
to $\varphi$ into the summand on which the lower horizontal arrow is
equal to $1$ and almost surely the diagram doesn't commute.
\end{remark}




\section{Cohomology}
\label{section-cohomology}

\noindent
Obsolete lemmas about cohomology.

\begin{lemma}
\label{lemma-ML-general}
Let $I$ be an ideal of a ring $A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules
such that $\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$.
Assume
$$
\bigoplus\nolimits_{n \geq 0} H^1(X, I^n\mathcal{F}_{n + 1})
$$
satisfies the ascending chain condition as a graded
$\bigoplus_{n \geq 0} I^n/I^{n + 1}$-module.
Then the inverse system $M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the
Mittag-Leffler condition.
\end{lemma}

\begin{proof}
This is a special case of the more general
Cohomology, Lemma \ref{cohomology-lemma-ML-general}.
\end{proof}

\begin{lemma}
\label{lemma-ML-general-better}
Let $I$ be an ideal of a ring $A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules
such that $\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$.
Given $n$ define
$$
H^1_n =
\bigcap\nolimits_{m \geq n}
\Im\left(
H^1(X, I^n\mathcal{F}_{m + 1}) \to H^1(X, I^n\mathcal{F}_{n + 1})
\right)
$$
If $\bigoplus H^1_n$ satisfies the ascending chain condition as a graded
$\bigoplus_{n \geq 0} I^n/I^{n + 1}$-module, then the inverse system
$M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the Mittag-Leffler condition.
\end{lemma}

\begin{proof}
This is a special case of the more general
Cohomology, Lemma \ref{cohomology-lemma-ML-general-better}.
\end{proof}

\begin{lemma}
\label{lemma-topology-I-adic-general}
Let $I$ be a finitely generated ideal of a ring $A$.
Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_3 \to \mathcal{F}_2 \to \mathcal{F}_1
$$
be an inverse system of $\mathcal{O}_X$-modules such that
$\mathcal{F}_n = \mathcal{F}_{n + 1}/I^n\mathcal{F}_{n + 1}$. Assume
$$
\bigoplus\nolimits_{n \geq 0} H^0(X, I^n\mathcal{F}_{n + 1})
$$
satisfies the ascending chain condition as a graded
$\bigoplus_{n \geq 0} I^n/I^{n + 1}$-module.
Then the limit topology on $M = \lim \Gamma(X, \mathcal{F}_n)$
is the $I$-adic topology.
\end{lemma}

\begin{proof}
This is a special case of the more general
Cohomology, Lemma \ref{cohomology-lemma-topology-I-adic-general}.
\end{proof}

\begin{lemma}
\label{lemma-pullback-K-flat}
Let $(\Sh(\mathcal{C}), \mathcal{O}_\mathcal{C})$ be a ringed topos.
For any complex of $\mathcal{O}_\mathcal{C}$-modules $\mathcal{G}^\bullet$
there exists a quasi-isomorphism $\mathcal{K}^\bullet \to \mathcal{G}^\bullet$
such that $f^*\mathcal{K}^\bullet$ is a K-flat complex of
$\mathcal{O}_\mathcal{D}$-modules for any morphism
$f : (\Sh(\mathcal{D}), \mathcal{O}_\mathcal{D}) \to
(\Sh(\mathcal{C}), \mathcal{O}_\mathcal{C})$ of ringed topoi.
\end{lemma}

\begin{proof}
This follows from Cohomology on Sites, Lemmas
\ref{sites-cohomology-lemma-K-flat-resolution} and
\ref{sites-cohomology-lemma-pullback-K-flat}.
\end{proof}

\begin{remark}
\label{remark-pullback-K-flat}
This remark used to discuss what we know about pullbacks of K-flat complexes
being K-flat or not, but is now obsoleted by
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-pullback-K-flat}.
\end{remark}

\noindent
The following lemma computes the cohomology sheaves of the
derived limit in a special case.

\begin{lemma}
\label{lemma-Rlim-of-system}
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site. Let $(K_n)$
be an inverse system of objects of $D(\mathcal{O})$.
Let $\mathcal{B} \subset \Ob(\mathcal{C})$ be a subset.
Let $d \in \mathbf{N}$. Assume
\begin{enumerate}
\item $K_n$ is an object of $D^+(\mathcal{O})$ for all $n$,
\item for $q \in \mathbf{Z}$ there exists
$n(q)$ such that $H^q(K_{n + 1}) \to H^q(K_n)$ is an isomorphism for
$n \geq n(q)$,
\item every object of $\mathcal{C}$ has a covering whose members are
elements of $\mathcal{B}$,
\item for every $U \in \mathcal{B}$ we have $H^p(U, H^q(K_n)) = 0$
for $p > d$ and all $q$.
\end{enumerate}
Then we have $H^m(R\lim K_n) = \lim H^m(K_n)$ for all $m \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Set $K = R\lim K_n$. Let $U \in \mathcal{B}$. For each $n$ there is a spectral
sequence
$$
H^p(U, H^q(K_n)) \Rightarrow H^{p + q}(U, K_n)
$$
which converges as $K_n$ is bounded below, see
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
If we fix $m \in \mathbf{Z}$, then we see from our assumption (4)
that only $H^p(U, H^q(K_n))$ contribute to $H^m(U, K_n)$
for $0 \leq p \leq d$ and $m - d \leq q \leq m$. By assumption (2)
this implies that $H^m(U, K_{n + 1}) \to H^m(U, K_n)$ is an isomorphism
as soon as $n \geq \max{n(m), \ldots, n(m - d)}$. The functor $R\Gamma(U, -)$
commutes with derived limits by
Injectives, Lemma \ref{injectives-lemma-RF-commutes-with-Rlim}.
Thus we have
$$
H^m(U, K) = H^m(R\lim R\Gamma(U, K_n))
$$
On the other hand we have just seen that the complexes $R\Gamma(U, K_n)$
have eventually constant cohomology groups. Thus by
More on Algebra, Remark \ref{more-algebra-remark-compare-derived-limit}
we find that $H^m(U, K)$ is equal to $H^m(U, K_n)$ for
all $n \gg 0$ for some bound independent of $U \in \mathcal{B}$.
Pick such an $n$. Finally, recall that $H^m(K)$ is the sheafification of
the presheaf $U \mapsto H^m(U, K)$ and $H^m(K_n)$ is the sheafification
of the presheaf $U \mapsto H^m(U, K_n)$. On the elements
of $\mathcal{B}$ these presheaves have the same values. Therefore assumption
(3) guarantees that the sheafifications are the same too.
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-trivialities-cohomological-descent-abelian}
In Simplicial Spaces, Situation
\ref{spaces-simplicial-situation-simplicial-site}
let $a_0$ be an augmentation towards a site $\mathcal{D}$ as in
Simplicial Spaces, Remark \ref{spaces-simplicial-remark-augmentation-site}.
Suppose given strictly full weak Serre subcategories
$$
\mathcal{A} \subset \textit{Ab}(\mathcal{D}),\quad
\mathcal{A}_n \subset \textit{Ab}(\mathcal{C}_n)
$$
Then
\begin{enumerate}
\item[(1)]
the collection of abelian sheaves $\mathcal{F}$ on $\mathcal{C}_{total}$
whose restriction to $\mathcal{C}_n$ is in $\mathcal{A}_n$ for all $n$
is a strictly full weak Serre subcategory
$\mathcal{A}_{total} \subset \textit{Ab}(\mathcal{C}_{total})$.
\end{enumerate}
If $a_n^{-1}$ sends $\mathcal{A}$ into $\mathcal{A}_n$
for all $n$, then
\begin{enumerate}
\item[(2)] $a^{-1}$ sends $\mathcal{A}$ into $\mathcal{A}_{total}$ and
\item[(3)] $a^{-1}$ sends $D_\mathcal{A}(\mathcal{D})$ into
$D_{\mathcal{A}_{total}}(\mathcal{C}_{total})$.
\end{enumerate}
If $R^qa_{n, *}$ sends $\mathcal{A}_n$ into $\mathcal{A}$
for all $n, q$, then
\begin{enumerate}
\item[(4)] $R^qa_*$ sends $\mathcal{A}_{total}$ into $\mathcal{A}$ for all $q$,
and
\item[(5)] $Ra_*$ sends $D_{\mathcal{A}_{total}}^+(\mathcal{C}_{total})$
into $D_\mathcal{A}^+(\mathcal{D})$.
\end{enumerate}
\end{lemma}

\begin{proof}
The only interesting assertions are (4) and (5).
Part (4) follows from the spectral sequence in
Simplicial Spaces, Lemma
\ref{spaces-simplicial-lemma-augmentation-spectral-sequence}
and Homology, Lemma \ref{homology-lemma-biregular-ss-converges}.
Then part (5) follows by considering the spectral sequence
associated to the canonical filtration on an object
$K$ of $D_{\mathcal{A}_{total}}^+(\mathcal{C}_{total})$ given by truncations.
We omit the details.
\end{proof}

\begin{remark}
\label{remark-cohomology-topics}
This tag used to refer to a section of the chapter on cohomology
listing topics to be treated.
\end{remark}

\begin{remark}
\label{remark-sites-cohomology-topics}
This tag used to refer to a section of the chapter on cohomology
listing topics to be treated.
\end{remark}

\begin{remark}
\label{remark-V-implies-C}
This tag used to refer to the special case of
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-V-implies-C-general}
pertaining to the situation described in
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-compare-qc-zar}.
\end{remark}

\begin{remark}
\label{remark-V-implies-cohomology}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-V-implies-cohomology-general}
pertaining to the situation described in
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-compare-qc-zar}.
\end{remark}

\begin{remark}
\label{remark-induction-step-V-C}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-induction-step-V-C-general}
pertaining to the situation described in
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-compare-qc-zar}.
\end{remark}

\begin{remark}
\label{remark-V-implies-C-etale-fppf}
This tag used to refer to the special case of
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-V-implies-C-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-fppf-etale}.
\end{remark}

\begin{remark}
\label{remark-V-implies-cohomology-etale-fppf}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-V-implies-cohomology-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-fppf-etale}.
\end{remark}

\begin{remark}
\label{remark-induction-step-V-C-etale-fppf}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-induction-step-V-C-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-fppf-etale}.
\end{remark}

\begin{remark}
\label{remark-V-implies-C-etale-ph}
This tag used to refer to the special case of
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-V-implies-C-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-ph-etale}.
\end{remark}

\begin{remark}
\label{remark-V-implies-cohomology-etale-ph}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-V-implies-cohomology-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-ph-etale}.
\end{remark}

\begin{remark}
\label{remark-V-implies-cohomology-etale-ph-extra}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-V-implies-cohomology-extra-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-ph-etale}.
\end{remark}

\begin{remark}
\label{remark-make-class-zero}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-make-class-zero-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-ph-etale}.
\end{remark}

\begin{remark}
\label{remark-induction-step-V-C-etale-ph}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-induction-step-V-C-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-ph-etale}.
\end{remark}

\begin{remark}
\label{remark-V-implies-C-etale-h}
This tag used to refer to the special case of
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-V-implies-C-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-h-etale}.
\end{remark}

\begin{remark}
\label{remark-V-implies-cohomology-etale-h}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-V-implies-cohomology-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-h-etale}.
\end{remark}

\begin{remark}
\label{remark-V-implies-cohomology-etale-h-extra}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-V-implies-cohomology-extra-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-h-etale}.
\end{remark}

\begin{remark}
\label{remark-induction-step-V-C-etale-h}
This tag used to refer to the special case of
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-induction-step-V-C-general}
pertaining to the situation described in
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-compare-h-etale}.
\end{remark}

\begin{remark}
\label{remark-how-used}
This tag used to be in the chapter on \'etale cohomology, but is no
longer suitable there because of a reorganization. The content of
the tag was the following:
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-when-ctf}
can be used to prove that if $f : X \to Y$ is a separated, finite type
morphism of schemes and $Y$ is Noetherian, then $Rf_!$ induces a functor
$D_{ctf}(X_\etale, \Lambda) \to D_{ctf}(Y_\etale, \Lambda)$.
An example of this argument, when $Y$ is the spectrum of a field and
$X$ is a curve is given in The Trace Formula,
Proposition \ref{trace-proposition-projective-curve-constructible-cohomology}.
\end{remark}

\begin{lemma}
\label{lemma-glue-f-upper-shriek}
Let $f : X \to Y$ be a locally quasi-finite morphism of schemes.
There exists a unique functor
$f^! : \textit{Ab}(Y_\etale) \to \textit{Ab}(X_\etale)$ such that
\begin{enumerate}
\item for any open $j : U \to X$ with $f \circ j$ separated there
is a canonical isomorphism $j^! \circ f^! = (f \circ j)^!$, and
\item these isomorphisms for $U \subset U' \subset X$ are compatible
with the isomorphisms in More \'Etale Cohomology, Lemma
\ref{more-etale-lemma-upper-shriek-restriction}.
\end{enumerate}
\end{lemma}

\begin{proof}
Immediate consequence of More \'Etale Cohomology, Lemmas
\ref{more-etale-lemma-lqf-f-upper-shriek} and
\ref{more-etale-lemma-upper-shriek-restriction}.
\end{proof}

\begin{proposition}
\label{proposition-lqf-shriek}
Let $f : X \to Y$ be a locally quasi-finite morphism. There exist
adjoint functors $f_! : \textit{Ab}(X_\etale) \to \textit{Ab}(Y_\etale)$
and $f^! : \textit{Ab}(Y_\etale) \to \textit{Ab}(X_\etale)$
with the following properties
\begin{enumerate}
\item the functor $f^!$ is the one constructed in More \'Etale Cohomology,
Lemma \ref{more-etale-lemma-lqf-f-upper-shriek},
\item for any open $j : U \to X$ with $f \circ j$ separated
there is a canonical isomorphism $f_! \circ j_! = (f \circ j)_!$, and
\item these isomorphisms for $U \subset U' \subset X$ are compatible
with the isomorphisms in More \'Etale Cohomology,
Lemma \ref{more-etale-lemma-f-shriek-composition}.
\end{enumerate}
\end{proposition}

\begin{proof}
See More \'Etale Cohomology, Sections
\ref{more-etale-section-finite-support} and
\ref{more-etale-section-duality-locally-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-lqf-f-upper-shriek-stalk}
Let $f : X \to Y$ be a morphism of schemes which is locally quasi-finite.
For an abelian group $A$ and a geometric point
$\overline{y} : \Spec(k) \to Y$ we have
$f^!(\overline{y}_*A) = \prod\nolimits_{f(\overline{x}) = \overline{y}}
\overline{x}_*A$.
\end{lemma}

\begin{proof}
Follows from the corresponding statement in
More \'Etale Cohomology, Lemma \ref{more-etale-lemma-lqf-f-upper-shriek}.
\end{proof}

\begin{lemma}
\label{lemma-lqf-f-shriek-composition}
Let $f : X \to Y$ and $g : Y \to Z$ be composable locally
quasi-finite morphisms of schemes. Then $g_! \circ f_! = (g \circ f)_!$
and $f^! \circ g^! = (g \circ f)^!$.
\end{lemma}

\begin{proof}
Combination of More \'Etale Cohomology, Lemmas
\ref{more-etale-lemma-lqf-shriek-composition} and
\ref{more-etale-lemma-upper-shriek-restriction}.
\end{proof}









\section{Differential graded algebra}
\label{section-dga}


\begin{lemma}
\label{lemma-P-not-preserved-base-change}
Let $(A, \text{d})$ and $(B, \text{d})$ be differential graded algebras.
Let $N$ be a differential graded $(A, B)$-bimodule with property
(P). Let $M$ be a differential graded $A$-module with property (P).
Then $Q = M \otimes_A N$ is a differential graded $B$-module which represents
$M \otimes_A^\mathbf{L} N$ in $D(B)$ and which has a filtration
$$
0 = F_{-1}Q \subset F_0Q \subset F_1Q \subset \ldots \subset Q
$$
by differential graded submodules such that $Q = \bigcup F_pQ$,
the inclusions $F_iQ \to F_{i + 1}Q$ are admissible monomorphisms,
the quotients $F_{i + 1}Q/F_iQ$ are isomorphic as differential
graded $B$-modules to a direct sum of $(A \otimes_R B)[k]$.
\end{lemma}

\begin{proof}
Choose filtrations $F_\bullet$ on $M$ and $N$. Then consider the filtration
on $Q = M \otimes_A N$ given by
$$
F_n(Q) = \sum\nolimits_{i + j = n}
F_i(M) \otimes_A F_j(N)
$$
This is clearly a differential graded $B$-submodule. We see that
$$
F_n(Q)/F_{n - 1}(Q) =
\bigoplus\nolimits_{i + j = n}
F_i(M)/F_{i - 1}(M) \otimes_A F_j(N)/F_{j - 1}(N)
$$
for example because the filtration of $M$ is split in the category
of graded $A$-modules. Since by assumption the quotients on the right
hand side are isomorphic to direct sums of shifts of $A$ and
$A \otimes_R B$ and since
$A \otimes_A (A \otimes_R B) = A \otimes_R B$,
we conclude that the left hand side is a direct sum of shifts
of $A \otimes_R B$ as a differential graded $B$-module.
(Warning: $Q$ does not have a structure of $(A, B)$-bimodule.)
This proves the first statement of the lemma.
The second statement is immediate from
the definition of the functor in
Differential Graded Algebra, Lemma \ref{dga-lemma-derived-bc}.
\end{proof}












\section{Simplicial methods}
\label{section-simplicial}


\begin{lemma}
\label{lemma-equiv}
Assumptions and notation as in
Simplicial, Lemma \ref{simplicial-lemma-section}.
There exists a section $g : U \to V$ to the morphism $f$ and
the composition $g \circ f$ is homotopy equivalent to the identity
on $V$. In particular, the morphism $f$ is a homotopy equivalence.
\end{lemma}

\begin{proof}
Immediate from Simplicial, Lemmas \ref{simplicial-lemma-section} and
\ref{simplicial-lemma-trivial-kan-homotopy}.
\end{proof}

\begin{lemma}
\label{lemma-cosk-hom-deltak}
Let $\mathcal{C}$ be a category with finite coproducts
and finite limits. Let $X$ be an object of $\mathcal{C}$.
Let $k \geq 0$. The canonical map
$$
\Hom(\Delta[k], X)
\longrightarrow
\text{cosk}_1 \text{sk}_1 \Hom(\Delta[k], X)
$$
is an isomorphism.
\end{lemma}

\begin{proof}
For any simplicial object $V$ we have
\begin{eqnarray*}
\Mor(V, \text{cosk}_1 \text{sk}_1 \Hom(\Delta[k], X))
& = &
\Mor(\text{sk}_1 V, \text{sk}_1 \Hom(\Delta[k], X)) \\
& = &
\Mor(i_{1!} \text{sk}_1 V, \Hom(\Delta[k], X)) \\
& = &
\Mor(i_{1!} \text{sk}_1 V \times \Delta[k], X)
\end{eqnarray*}
The first equality by the adjointness of $\text{sk}$ and $\text{cosk}$,
the second equality by the adjointness of $i_{1!}$ and $\text{sk}_1$, and
the first equality by
Simplicial, Definition \ref{simplicial-definition-hom-from-simplicial-set}
where the last $X$ denotes the constant simplicial object with value $X$.
By Simplicial, Lemma \ref{simplicial-lemma-augmentation-howto} an element
in this set depends only on the terms of degree $0$ and $1$
of $i_{1!} \text{sk}_1 V \times \Delta[k]$. These
agree with the degree $0$ and $1$ terms of
$V \times \Delta[k]$, see
Simplicial, Lemma \ref{simplicial-lemma-recovering-U-for-real}.
Thus the set above is equal to
$\Mor(V \times \Delta[k], X) = \Mor(V, \Hom(\Delta[k], X))$.
\end{proof}

\begin{lemma}
\label{lemma-cosk0-hom-deltak}
Let $\mathcal{C}$ be a category. Let $X$ be an object of $\mathcal{C}$
such that the self products $X \times \ldots \times X$ exist.
Let $k \geq 0$ and let $C[k]$ be as in
Simplicial, Example \ref{simplicial-example-simplex-cosimplicial-set}.
With notation as in
Simplicial, Lemma \ref{simplicial-lemma-morphism-into-product}
the canonical map
$$
\Hom(C[k], X)_1
\longrightarrow
(\text{cosk}_0 \text{sk}_0 \Hom(C[k], X))_1
$$
is identified with the map
$$
\prod\nolimits_{\alpha : [k] \to [1]} X
\longrightarrow
X \times X
$$
which is the projection onto the factors where $\alpha$
is a constant map.
\end{lemma}

\begin{proof}
This is shown in the proof of
Hypercoverings, Lemma \ref{hypercovering-lemma-covering}.
\end{proof}




\section{Results on schemes}
\label{section-devissage}

\noindent
Lemmas that seem superfluous.

\begin{lemma}
\label{lemma-stein-projective}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
Let $X \subset \mathbf{P}^n_R$ be a closed subscheme.
Assume that $R = \Gamma(X, \mathcal{O}_X)$. Then the special fibre
$X_k$ is geometrically connected.
\end{lemma}

\begin{proof}
This is a special case of
More on Morphisms, Theorem
\ref{more-morphisms-theorem-stein-factorization-general}.
\end{proof}

\begin{lemma}
\label{lemma-property-irreducible-higher-rank}
Let $X$ be a Noetherian scheme.
Let $Z_0 \subset X$ be an irreducible closed subset with generic point $\xi$.
Let $\mathcal{P}$ be a property of coherent sheaves on $X$ such that
\begin{enumerate}
\item For any short exact sequence of coherent sheaves if two
out of three of them have property $\mathcal{P}$ then so does the
third.
\item If $\mathcal{P}$ holds for a direct sum of coherent sheaves
then it holds for both.
\item For every integral closed subscheme $Z \subset Z_0 \subset X$,
$Z \not = Z_0$ and every quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_Z$ we have
$\mathcal{P}$ for $(Z \to X)_*\mathcal{I}$.
\item There exists some coherent sheaf $\mathcal{G}$ on $X$ such that
\begin{enumerate}
\item $\text{Supp}(\mathcal{G}) = Z_0$,
\item $\mathcal{G}_\xi$ is annihilated by $\mathfrak m_\xi$, and
\item property $\mathcal{P}$ holds for $\mathcal{G}$.
\end{enumerate}
\end{enumerate}
Then property $\mathcal{P}$ holds for every coherent sheaf
$\mathcal{F}$ on $X$ whose support is contained in $Z_0$.
\end{lemma}

\begin{proof}
The proof is a variant on the proof of
Cohomology of Schemes, Lemma \ref{coherent-lemma-property-irreducible}.
In exactly the same manner as in that proof we see that
any coherent sheaf whose support is strictly contained in $Z_0$
has property $\mathcal{P}$.

\medskip\noindent
Consider a coherent sheaf $\mathcal{G}$ as in (3).
By Cohomology of Schemes, Lemma \ref{coherent-lemma-prepare-filter-irreducible}
there exists a sheaf of ideals $\mathcal{I}$ on $Z_0$ and
a short exact sequence
$$
0 \to
\left((Z_0 \to X)_*\mathcal{I}\right)^{\oplus r} \to
\mathcal{G} \to
\mathcal{Q} \to 0
$$
where the support of $\mathcal{Q}$ is strictly contained in $Z_0$.
In particular $r > 0$ and $\mathcal{I}$ is nonzero
because the support of $\mathcal{G}$ is equal to $Z$.
Since $\mathcal{Q}$ has property $\mathcal{P}$ we conclude that
also $\left((Z_0 \to X)_*\mathcal{I}\right)^{\oplus r}$
has property $\mathcal{P}$.
By (2) we deduce property $\mathcal{P}$ for
$(Z_0 \to X)_*\mathcal{I}$. Slotting this into the proof of
Cohomology of Schemes, Lemma \ref{coherent-lemma-property-irreducible}
at the appropriate point gives the lemma.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-property-higher-rank}
Let $X$ be a Noetherian scheme.
Let $\mathcal{P}$ be a property of coherent sheaves on $X$ such that
\begin{enumerate}
\item For any short exact sequence of coherent sheaves if two
out of three of them have property $\mathcal{P}$ then so does the
third.
\item If $\mathcal{P}$ holds for a direct sum of coherent sheaves
then it holds for both.
\item For every integral closed subscheme $Z \subset X$
with generic point $\xi$ there exists
some coherent sheaf $\mathcal{G}$ such that
\begin{enumerate}
\item $\text{Supp}(\mathcal{G}) = Z$,
\item $\mathcal{G}_\xi$ is annihilated by $\mathfrak m_\xi$, and
\item property $\mathcal{P}$ holds for $\mathcal{G}$.
\end{enumerate}
\end{enumerate}
Then property $\mathcal{P}$ holds for every coherent sheaf
on $X$.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-property-irreducible-higher-rank}
in exactly the same way that
Cohomology of Schemes, Lemma \ref{coherent-lemma-property} follows from
Cohomology of Schemes, Lemma \ref{coherent-lemma-property-irreducible}.
\end{proof}

\begin{lemma}
\label{lemma-section-maps-back-into}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$ be a section.
Let $\mathcal{F}' \subset \mathcal{F}$ be quasi-coherent
$\mathcal{O}_X$-modules. Assume that
\begin{enumerate}
\item $X$ is quasi-compact,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}'|_{X_s} = \mathcal{F}|_{X_s}$.
\end{enumerate}
Then there exists an $n \geq 0$ such that
multiplication by $s^n$ on $\mathcal{F}$ factors
through $\mathcal{F}'$.
\end{lemma}

\begin{proof}
In other words we claim that
$s^n\mathcal{F} \subset
\mathcal{F}' \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes n}$
for some $n \geq 0$. In other words, we claim that the quotient map
$\mathcal{F} \to \mathcal{F}/\mathcal{F}'$ becomes
zero after multiplying by a power of $s$.
This follows from Properties, Lemma
\ref{properties-lemma-section-maps-backwards}.
\end{proof}

\begin{lemma}
\label{lemma-bound-degree-in-nbhd-generic-point}
Let $f : X \to Y$ be a morphism schemes. Assume
\begin{enumerate}
\item $X$ and $Y$ are integral schemes,
\item $f$ is locally of finite type and dominant,
\item $f$ is either quasi-compact or separated,
\item $f$ is generically finite, i.e., one of (1) -- (5) of
Morphisms, Lemma \ref{morphisms-lemma-finite-degree} holds.
\end{enumerate}
Then there is a nonempty open $V \subset Y$ such that
$f^{-1}(V) \to V$ is finite locally free of degree $\deg(X/Y)$.
In particular, the degrees of the fibres of $f^{-1}(V) \to V$
are bounded by $\deg(X/Y)$.
\end{lemma}

\begin{proof}
We may choose $V$ such that $f^{-1}(V) \to V$ is finite.
Then we may shrink $V$ and assume that $f^{-1}(V) \to V$
is flat and of finite presentation by generic flatness
(Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}).
Then the morphism is finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
Since $V$ is irreducible the morphism has a fixed degree.
The final statement follows from this and
Morphisms, Lemma \ref{morphisms-lemma-finite-locally-free-universally-bounded}.
\end{proof}







\section{Derived categories of varieties}
\label{section-equiv}

\noindent
Some lemma which were originally part of the
chapter on derived categories of varieties but
are no longer needed.

\begin{lemma}
\label{lemma-preserves-Coh}
Let $k$ be a field. Let $X$ be a separated scheme of finite type over $k$ which
is regular. Let $F : D_{perf}(\mathcal{O}_X) \to D_{perf}(\mathcal{O}_X)$
be a $k$-linear exact functor. Assume for every coherent
$\mathcal{O}_X$-module $\mathcal{F}$ with $\dim(\text{Supp}(\mathcal{F})) = 0$
there is an isomorphism of $k$-vector spaces
$$
\Hom_X(\mathcal{F}, M) = \Hom_X(\mathcal{F}, F(M))
$$
functorial in $M$ in $D_{perf}(\mathcal{O}_X)$. Then there exists an
automorphism $f : X \to X$ over $k$ which induces the identity on the
underlying topological space\footnote{This often forces $f$
to be the identity, see Varieties, Lemma \ref{varieties-lemma-automorphism}.}
and an invertible $\mathcal{O}_X$-module $\mathcal{L}$
such that $F$ and $F'(M) = f^*M \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{L}$
are siblings.
\end{lemma}

\begin{proof}
By Derived Categories of Varieties, Lemma \ref{equiv-lemma-duality-at-point}
we conclude that for every
coherent $\mathcal{O}_X$-module $\mathcal{F}$ whose support is a
closed point there are isomorphisms
$$
H^0(X, M \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{F}) =
H^0(X, F(M) \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{F})
$$
functorial in $M$.

\medskip\noindent
Let $x \in X$ be a closed point and apply the above with
$\mathcal{F} = \mathcal{O}_x$ the skyscraper sheaf with value
$\kappa(x)$ at $x$. We find
$$
\dim_{\kappa(x)} 
\text{Tor}^{\mathcal{O}_{X, x}}_p(M_x, \kappa(x)) =
\dim_{\kappa(x)} 
\text{Tor}^{\mathcal{O}_{X, x}}_p(F(M)_x, \kappa(x))
$$
for all $p \in \mathbf{Z}$. In particular, if
$H^i(M) = 0$ for $i > 0$, then $H^i(F(M)) = 0$ for $i > 0$
by Derived Categories of Varieties, Lemma
\ref{equiv-lemma-orthogonal-point-sheaf}.

\medskip\noindent
If $\mathcal{E}$ is locally free of rank $r$, then
$F(\mathcal{E})$ is locally free of rank $r$. This is
true because a perfect complex $K$ over $\mathcal{O}_{X, x}$
with
$$
\dim_{\kappa(x)} \text{Tor}^{\mathcal{O}_{X, x}}_i(K, \kappa(x)) =
\left\{
\begin{matrix}
r & \text{if} & i = 0 \\
0 & \text{if} & i \not = 0
\end{matrix}
\right.
$$
is equal to a free module of rank $r$ placed in degree $0$. See
for example More on Algebra, Lemma
\ref{more-algebra-lemma-lift-perfect-from-residue-field}.

\medskip\noindent
If $M$ is supported on a closed subscheme $Z \subset X$, then
$F(M)$ is also supported on $Z$. This is clear because
we will have $M \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_x = 0$
for $x \not \in Z$ and hence the same will be true for $F(M)$
and hence we get the conclusion from
Derived Categories of Varieties, Lemma
\ref{equiv-lemma-orthogonal-point-sheaf}.

\medskip\noindent
In particular $F(\mathcal{O}_x)$ is supported at $\{x\}$.
Let $i \in \mathbf{Z}$ be the minimal integer such that
$H^i(\mathcal{O}_x) \not = 0$. We know that $i \leq 0$.
If $i < 0$, then there is a morphism
$\mathcal{O}_x[-i] \to F(\mathcal{O}_x)$
which contradicts the fact that all morphisms
$\mathcal{O}_x[-i] \to \mathcal{O}_x$ are zero.
Thus $F(\mathcal{O}_x) = \mathcal{H}[0]$ where
$\mathcal{H}$ is a skyscraper sheaf at $x$.

\medskip\noindent
Let $\mathcal{G}$ be a coherent $\mathcal{O}_X$-module with
$\dim(\text{Supp}(\mathcal{G})) = 0$. Then there exists a
filtration
$$
0 = \mathcal{G}_0 \subset \mathcal{G}_1 \subset \ldots \subset
\mathcal{G}_n = \mathcal{G}
$$
such that for $n \geq i \geq 1$ the quotient $\mathcal{G}_i/\mathcal{G}_{i - 1}$
is isomorphic to $\mathcal{O}_{x_i}$ for some closed point $x_i \in X$.
Then we get distinguished triangles
$$
F(\mathcal{G}_{i - 1}) \to F(\mathcal{G}_i) \to F(\mathcal{O}_{x_i})
$$
and using induction we find that $F(\mathcal{G}_i)$ is a
coherent sheaf placed in degree $0$.

\medskip\noindent
Let $\mathcal{G}$ be a coherent $\mathcal{O}_X$-module. We know that
$H^i(F(\mathcal{G})) = 0$ for $i > 0$. To get a contradiction assume
that $H^i(F(\mathcal{G}))$ is nonzero for some $i < 0$. We choose
$i$ minimal with this property so that we have a morphism
$H^i(F(\mathcal{G}))[-i] \to F(\mathcal{G})$ in $D_{perf}(\mathcal{O}_X)$.
Choose a closed point $x \in X$ in the support of $H^i(F(\mathcal{G}))$.
By More on Algebra, Lemma
\ref{more-algebra-lemma-kollar-kovacs-pseudo-coherent}
there exists an $n > 0$ such that
$$
H^i(F(\mathcal{G}))_x \otimes_{\mathcal{O}_{X, x}}
\mathcal{O}_{X, x}/\mathfrak m_x^n
\longrightarrow
\text{Tor}^{\mathcal{O}_{X, x}}_{-i}(F(\mathcal{G})_x,
\mathcal{O}_{X, x}/\mathfrak m_x^n)
$$
is nonzero. Next, we take $m \geq 1$ and we consider the short
exact sequence
$$
0 \to \mathfrak m_x^m \mathcal{G} \to \mathcal{G} \to
\mathcal{G}/\mathfrak m_x^m\mathcal{G} \to 0
$$
By the above we know that $F(\mathcal{G}/\mathfrak m_x^m\mathcal{G})$
is a sheaf placed in degree $0$. Hence
$H^i(F(\mathfrak m_x^m \mathcal{G})) \to H^i(F(\mathcal{G}))$
is an isomorphism. Consider the commutative diagram
$$
\xymatrix{
H^i(F(\mathfrak m_x^m\mathcal{G}))_x \otimes_{\mathcal{O}_{X, x}}
\mathcal{O}_{X, x}/\mathfrak m_x^n \ar[r] \ar[d] &
\text{Tor}^{\mathcal{O}_{X, x}}_{-i}(F(\mathfrak m_x^m\mathcal{G})_x,
\mathcal{O}_{X, x}/\mathfrak m_x^n) \ar[d] \\
H^i(F(\mathcal{G}))_x \otimes_{\mathcal{O}_{X, x}}
\mathcal{O}_{X, x}/\mathfrak m_x^n \ar[r] &
\text{Tor}^{\mathcal{O}_{X, x}}_{-i}(F(\mathcal{G})_x,
\mathcal{O}_{X, x}/\mathfrak m_x^n)
}
$$
Since the left vertical arrow is an isomorphism and the bottom arrow
is nonzero, we conclude that
the right vertical arrow is nonzero for all $m \geq 1$.
On the other hand, by the first paragraph of the proof,
we know this arrow is isomorphic to the arrow
$$
\text{Tor}^{\mathcal{O}_{X, x}}_{-i}(\mathfrak m_x^m\mathcal{G}_x,
\mathcal{O}_{X, x}/\mathfrak m_x^n)
\longrightarrow
\text{Tor}^{\mathcal{O}_{X, x}}_{-i}(\mathcal{G}_x,
\mathcal{O}_{X, x}/\mathfrak m_x^n)
$$
However, this arrow is zero for $m \gg n$ by
More on Algebra, Lemma \ref{more-algebra-lemma-tor-annihilated}
which is the contradiction we're looking for.

\medskip\noindent
Thus we know that $F$ preserves coherent modules. By
Derived Categories of Varieties, Lemma
\ref{equiv-lemma-exact-functor-preserving-Coh}
we find $F$ is a sibling to the Fourier-Mukai functor $F'$ given by
a coherent $\mathcal{O}_{X \times X}$-module $\mathcal{K}$
flat over $X$ via $\text{pr}_1$ and finite over $X$ via $\text{pr}_2$.
Since $F(\mathcal{O}_X)$ is an invertible $\mathcal{O}_X$-module
$\mathcal{L}$ placed in degree $0$ we see that
$$
\mathcal{L} \cong F(\mathcal{O}_X) \cong F'(\mathcal{O}_X) \cong
\text{pr}_{2, *}\mathcal{K}
$$
Thus by
Functors and Morphisms, Lemma \ref{functors-lemma-pushforward-invertible-pre}
there
is a morphism $s : X \to X \times X$ with $\text{pr}_2 \circ s = \text{id}_X$
such that $\mathcal{K} = s_*\mathcal{L}$. Set $f = \text{pr}_1 \circ s$.
Then we have
\begin{align*}
F'(M)
& =
R\text{pr}_{2, *}(L\text{pr}_1^*K \otimes \mathcal{K}) \\
& =
R\text{pr}_{2, *}(L\text{pr}_1^*M \otimes s_*\mathcal{L}) \\
& =
R\text{pr}_{2, *}(Rs_*(Lf^*M \otimes \mathcal{L})) \\
& =
Lf^*M \otimes \mathcal{L}
\end{align*}
where we have used
Derived Categories of Schemes, Lemma \ref{perfect-lemma-cohomology-base-change}
in the third step.
Since for all closed points $x \in X$ the module $F(\mathcal{O}_x)$
is supported at $x$, we see that $f$ induces the identity on the
underlying topological space of $X$. We still have to show that
$f$ is an isomorphism which we will do in the next paragraph.

\medskip\noindent
Let $x \in X$ be a closed point.
For $n \geq 1$ denote $\mathcal{O}_{x, n}$ the skyscaper
sheaf at $x$ with value $\mathcal{O}_{X, x}/\mathfrak m_x^n$.
We have
$$
\Hom_X(\mathcal{O}_{x, m}, \mathcal{O}_{x, n}) \cong
\Hom_X(\mathcal{O}_{x, m}, F(\mathcal{O}_{x, n})) \cong
\Hom_X(\mathcal{O}_{x, m}, f^*\mathcal{O}_{x, n} \otimes \mathcal{L})
$$
functorially with respect to $\mathcal{O}_X$-module homomorphisms
between the $\mathcal{O}_{x, n}$. (The first isomorphism exists
by assumption and the second isomorphism because $F$ and $F'$ are siblings.)
For $m \geq n$ we have $\mathcal{O}_{X, x}/\mathfrak m^n =
\Hom_X(\mathcal{O}_{x, m}, \mathcal{O}_{x, n})$
via the action on $\mathcal{O}_{x, n}$
we conclude that $f^\sharp : \mathcal{O}_{X, x}/\mathfrak m_x^n \to
\mathcal{O}_{X, x}/\mathfrak m_x^n$ is bijective for all $n$.
Thus $f$ induces isomorphisms on complete local rings at closed
points and hence is \'etale
(\'Etale Morphisms, Lemma \ref{etale-lemma-characterize-etale-completions}).
Looking at closed points we see that
$\Delta_f : X \to X \times_{f, X, f} X$ (which is an open immersion
as $f$ is \'etale) is bijective hence an isomorphism.
Hence $f$ is a monomorphism. Finally, we conclude $f$ is an isomorphism
as Descent, Lemma
\ref{descent-lemma-flat-surjective-quasi-compact-monomorphism-isomorphism}
tells us it is an open immersion.
\end{proof}










\section{Representability in the regular proper case}
\label{section-regular-proper}

\noindent
This section is obsolete because we improved
Derived Categories of Varieties,
Theorem \ref{equiv-theorem-bondal-van-den-bergh}
to apply to all proper schemes over a field (whereas before
we only proved it for projective schemes over a field).

\begin{lemma}
\label{lemma-trace-map}
\begin{reference}
The proof given here follows the argument given in
\cite[Remark 3.4]{MS}
\end{reference}
Let $f : X' \to X$ be a proper birational morphism of integral Noetherian
schemes with $X$ regular. The map $\mathcal{O}_X \to Rf_*\mathcal{O}_{X'}$
canonically splits in $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Set $E = Rf_*\mathcal{O}_{X'}$ in $D(\mathcal{O}_X)$.
Observe that $E$ is in $D^b_{\textit{Coh}}(\mathcal{O}_X)$ by
Derived Categories of Schemes, Lemma \ref{perfect-lemma-direct-image-coherent}.
By 
Derived Categories of Schemes, Lemma \ref{perfect-lemma-perfect-on-regular}
we find that $E$ is a perfect object of $D(\mathcal{O}_X)$.
Since $\mathcal{O}_{X'}$ is a sheaf of algebras, we have the
relative cup product $\mu : E \otimes_{\mathcal{O}_X}^\mathbf{L} E \to E$
by Cohomology, Remark \ref{cohomology-remark-cup-product}.
Let $\sigma : E \otimes E^\vee \to E^\vee \otimes E$ be the commutativity
constraint on the symmetric monoidal category $D(\mathcal{O}_X)$
(Cohomology, Lemma \ref{cohomology-lemma-symmetric-monoidal-derived}).
Denote $\eta : \mathcal{O}_X \to E \otimes E^\vee$ and
$\epsilon : E^\vee \otimes E \to \mathcal{O}_X$ the maps
constructed in Cohomology, Example \ref{cohomology-example-dual-derived}.
Then we can consider the map
$$
E \xrightarrow{\eta \otimes 1} E \otimes E^\vee \otimes E
\xrightarrow{\sigma \otimes 1} E^\vee \otimes E \otimes E
\xrightarrow{1 \otimes \mu} E^\vee \otimes E
\xrightarrow{\epsilon} \mathcal{O}_X
$$
We claim that this map is a one sided inverse to the map in the
statement of the lemma. To see this it suffices to show that
the composition $\mathcal{O}_X \to \mathcal{O}_X$ is the identity
map. This we may do in the generic point of $X$ (or on an open
subscheme of $X$ over which $f$ is an isomorphism). In this
case $E = \mathcal{O}_X$ and $\mu$ is the usual multiplication map
and the result is clear.
\end{proof}

\begin{lemma}
\label{lemma-characterize-dbcoh-proper-regular}
Let $X$ be a proper scheme over a field $k$ which is regular. Let
$K \in \Ob(D_\QCoh(\mathcal{O}_X))$. The following are equivalent
\begin{enumerate}
\item $K \in D^b_{\textit{Coh}}(\mathcal{O}_X) = D_{perf}(\mathcal{O}_X)$, and
\item $\sum_{i \in \mathbf{Z}} \dim_k \Ext^i_X(E, K) < \infty$
for all perfect $E$ in $D(\mathcal{O}_X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The equality in (1) holds by Derived Categories of Schemes,
Lemma \ref{perfect-lemma-perfect-on-regular}.
The implication (1) $\Rightarrow$ (2) follows from
Derived Categories of Varieties, Lemma \ref{equiv-lemma-finiteness}.
The implication (2) $\Rightarrow$ (1) follows from
More on Morphisms, Lemma
\ref{more-morphisms-lemma-characterize-relatively-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-bondal-van-den-bergh}
Let $X$ be a proper scheme over a field $k$ which is regular.
\begin{enumerate}
\item Let $F : D_{perf}(\mathcal{O}_X)^{opp} \to \text{Vect}_k$
be a $k$-linear cohomological functor such that
$$
\sum\nolimits_{n \in \mathbf{Z}} \dim_k F(E[n]) < \infty
$$
for all $E \in D_{perf}(\mathcal{O}_X)$. Then $F$ is isomorphic to a functor
of the form $E \mapsto \Hom_X(E, K)$ for some $K \in D_{perf}(\mathcal{O}_X)$.
\item Let $G : D_{perf}(\mathcal{O}_X) \to \text{Vect}_k$
be a $k$-linear homological functor such that
$$
\sum\nolimits_{n \in \mathbf{Z}} \dim_k G(E[n]) < \infty
$$
for all $E \in D_{perf}(\mathcal{O}_X)$. Then $G$ is isomorphic to a functor
of the form $E \mapsto \Hom_X(K, E)$ for some $K \in D_{perf}(\mathcal{O}_X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Derived Categories of Varieties, Theorem
\ref{equiv-theorem-bondal-van-den-bergh} and
Lemma \ref{equiv-lemma-homological-representable}.
We also give another proof below.

\medskip\noindent
Proof of (1). The derived category $D_\QCoh(\mathcal{O}_X)$ has direct sums,
is compactly generated, and $D_{perf}(\mathcal{O}_X)$ is the full subcategory
of compact objects, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-direct-sums},
Theorem \ref{perfect-theorem-bondal-van-den-Bergh}, and
Proposition \ref{perfect-proposition-compact-is-perfect}.
By Derived Categories of Varieties, Lemma \ref{equiv-lemma-van-den-bergh}
we may assume
$F(E) = \Hom_X(E, K)$ for some $K \in \Ob(D_\QCoh(\mathcal{O}_X))$.
Then it follows that $K$ is in $D^b_{\textit{Coh}}(\mathcal{O}_X)$
by Lemma \ref{lemma-characterize-dbcoh-proper-regular}.

\medskip\noindent
Proof of (2). Consider the contravariant functor $E \mapsto E^\vee$
on $D_{perf}(\mathcal{O}_X)$, see
Cohomology, Lemma \ref{cohomology-lemma-dual-perfect-complex}.
This functor is an exact anti-self-equivalence of $D_{perf}(\mathcal{O}_X)$.
Hence we may apply part (1) to the functor $F(E) = G(E^\vee)$ to find
$K \in D_{perf}(\mathcal{O}_X)$ such that $G(E^\vee) = \Hom_X(E, K)$.
It follows that $G(E) = \Hom_X(E^\vee, K) = \Hom_X(K^\vee, E)$
and we conclude that taking $K^\vee$ works.
\end{proof}









\section{Functor of quotients}
\label{section-quotients}

\begin{lemma}
\label{lemma-factors-through-quotient}
Let $S = \Spec(R)$ be an affine scheme. Let $X$ be an algebraic space over
$S$. Let $q_i : \mathcal{F} \to \mathcal{Q}_i$, $i = 1, 2$
be surjective maps of quasi-coherent $\mathcal{O}_X$-modules.
Assume $\mathcal{Q}_1$ flat over $S$. Let $T \to S$ be a quasi-compact
morphism of schemes such that there exists a factorization
$$
\xymatrix{
& \mathcal{F}_T \ar[rd]^{q_{2, T}} \ar[ld]_{q_{1, T}} \\
\mathcal{Q}_{1, T} & & \mathcal{Q}_{2, T} \ar@{..>}[ll]
}
$$
Then exists a closed subscheme $Z \subset S$ such that
(a) $T \to S$ factors through $Z$ and (b)
$q_{1, Z}$ factors through $q_{2, Z}$.
If $\Ker(q_2)$ is a finite type $\mathcal{O}_X$-module and $X$
quasi-compact, then we can take $Z \to S$ of finite presentation.
\end{lemma}

\begin{proof}
Apply Flatness on Spaces, Lemma \ref{spaces-flat-lemma-F-zero-somewhat-closed}
to the map $\Ker(q_2) \to \mathcal{Q}_1$.
\end{proof}







\section{Spaces and fpqc coverings}
\label{section-fpqc}

\noindent
The material here was made obsolete by Gabber's argument showing that
algebraic spaces satisfy the sheaf condition with respect to fpqc
coverings. Please visit
Properties of Spaces, Section \ref{spaces-properties-section-fpqc}.

\begin{lemma}
\label{lemma-separated-fpqc}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $\{f_i : T_i \to T\}_{i \in I}$ be a fpqc covering of schemes over $S$.
Then the map
$$
\Mor_S(T, X)
\longrightarrow
\prod\nolimits_{i \in I} \Mor_S(T_i, X)
$$
is injective.
\end{lemma}

\begin{proof}
Immediate consequence of
Properties of Spaces, Proposition
\ref{spaces-properties-proposition-sheaf-fpqc}.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-fpqc-open-covering}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $X = \bigcup_{j \in J} X_j$ be a Zariski covering, see
Spaces, Definition \ref{spaces-definition-Zariski-open-covering}.
If each $X_j$ satisfies the sheaf property for the fpqc topology
then $X$ satisfies the sheaf property for the fpqc topology.
\end{lemma}

\begin{proof}
This is true because all algebraic spaces satisfy the sheaf property
for the fpqc topology, see
Properties of Spaces, Proposition
\ref{spaces-properties-proposition-sheaf-fpqc}.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-fpqc-quasi-separated}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
If $X$ is Zariski locally quasi-separated over $S$, then $X$ satisfies
the sheaf condition for the fpqc topology.
\end{lemma}

\begin{proof}
Immediate consequence of the general
Properties of Spaces, Proposition
\ref{spaces-properties-proposition-sheaf-fpqc}.
\end{proof}

\begin{remark}
\label{remark-proof-works-when}
This remark used to discuss to what extend the original proof of
Lemma \ref{lemma-sheaf-fpqc-quasi-separated} (of December 18, 2009)
generalizes.
\end{remark}






\section{Very reasonable algebraic spaces}
\label{section-very-reasonable}

\noindent
Material that is somewhat obsolete.

\begin{lemma}
\label{lemma-reasonable-kolmogorov}
Let $S$ be a scheme.
Let $X$ be a reasonable algebraic space over $S$.
Then $|X|$ is Kolmogorov (see
Topology, Definition \ref{topology-definition-generic-point}).
\end{lemma}

\begin{proof}
Follows from the definitions and
Decent Spaces, Lemma \ref{decent-spaces-lemma-kolmogorov}.
\end{proof}

\noindent
In the rest of this section we make some remarks about very reasonable
algebraic spaces. If there exists a scheme $U$ and a
surjective, \'etale, quasi-compact
morphism $U \to X$, then $X$ is very reasonable, see
Decent Spaces, Lemma \ref{decent-spaces-lemma-characterize-very-reasonable}.

\begin{lemma}
\label{lemma-scheme-very-reasonable}
A scheme is very reasonable.
\end{lemma}

\begin{proof}
This is true because the identity map is a quasi-compact, surjective
\'etale morphism.
\end{proof}

\begin{lemma}
\label{lemma-very-reasonable-Zariski-local}
Let $S$ be a scheme.
Let $X$ be an algebraic space over $S$.
If there exists a Zariski open covering $X = \bigcup X_i$ such that
each $X_i$ is very reasonable, then $X$ is very reasonable.
\end{lemma}

\begin{proof}
This is case $(\epsilon)$ of
Decent Spaces, Lemma \ref{decent-spaces-lemma-properties-local}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-separated-very-reasonable}
An algebraic space which is Zariski locally quasi-separated is very reasonable.
In particular any quasi-separated algebraic space is very reasonable.
\end{lemma}

\begin{proof}
This is one of the implications of
Decent Spaces, Lemma \ref{decent-spaces-lemma-bounded-fibres}.
\end{proof}

\begin{lemma}
\label{lemma-representable-very-reasonable}
Let $S$ be a scheme.
Let $X$, $Y$ be algebraic spaces over $S$.
Let $Y \to X$ be a representable morphism.
If $X$ is very reasonable, so is $Y$.
\end{lemma}

\begin{proof}
This is case $(\epsilon)$ of
Decent Spaces, Lemma \ref{decent-spaces-lemma-representable-properties}.
\end{proof}

\begin{remark}
\label{remark-very-reasonable-Zariski-locally-quasi-separated}
Very reasonable algebraic spaces form a strictly larger collection than
Zariski locally quasi-separated algebraic spaces. Consider
an algebraic space of the form $X = [U/G]$ (see
Spaces, Definition \ref{spaces-definition-quotient})
where $G$ is a finite group acting without fixed points on a
non-quasi-separated scheme $U$. Namely, in this case
$U \times_X U = U \times G$ and clearly both projections to $U$ are
quasi-compact, hence $X$ is very reasonable. On the other hand, the diagonal
$U \times_X U \to U \times U$ is not quasi-compact, hence this
algebraic space is not quasi-separated. Now, take $U$ the infinite
affine space over a field $k$ of characteristic $\not = 2$ with
zero doubled, see
Schemes, Example \ref{schemes-example-not-quasi-separated}.
Let $0_1, 0_2$ be the two zeros of $U$. Let $G = \{+1, -1\}$, and
let $-1$ act by $-1$ on all coordinates, and by switching
$0_1$ and $0_2$. Then $[U/G]$ is very reasonable but not Zariski locally
quasi-separated (details omitted).
\end{remark}

\noindent
Warning: The following lemma should be used with caution, as the schemes
$U_i$ in it are not necessarily separated or even quasi-separated.

\begin{lemma}
\label{lemma-very-reasonable-quasi-compact-pieces}
Let $S$ be a scheme.
Let $X$ be a very reasonable algebraic space over $S$.
There exists a set of schemes
$U_i$ and morphisms $U_i \to X$ such that
\begin{enumerate}
\item each $U_i$ is a quasi-compact scheme,
\item each $U_i \to X$ is \'etale,
\item both projections $U_i \times_X U_i \to U_i$ are quasi-compact, and
\item the morphism $\coprod U_i \to X$ is surjective (and \'etale).
\end{enumerate}
\end{lemma}

\begin{proof}
Decent Spaces, Definition \ref{decent-spaces-definition-very-reasonable}
says that there exist $U_i \to X$ such that (2), (3) and (4) hold.
Fix $i$, and set $R_i = U_i \times_X U_i$, and denote $s, t : R_i \to U_i$
the projections.
For any affine open $W \subset U_i$ the open $W' = t(s^{-1}(W)) \subset U_i$
is a quasi-compact $R_i$-invariant open (see
Groupoids, Lemma \ref{groupoids-lemma-constructing-invariant-opens}).
Hence $W'$ is a quasi-compact scheme, $W' \to X$ is \'etale, and
$W' \times_X W' = s^{-1}(W') = t^{-1}(W')$ so both projections
$W' \times_X W' \to W'$ are quasi-compact. This means the family of
$W' \to X$, where $W \subset U_i$ runs through the members of affine
open coverings of the $U_i$ gives what we want.
\end{proof}




\section{Obsolete lemmas on algebraic spaces}
\label{section-obsolete-on-spaces}

\noindent
Lemmas that seem superfluous or are no longer used in the text.

\begin{lemma}
\label{lemma-vanishing-surjective}
In Cohomology of Spaces, Situation \ref{spaces-cohomology-situation-vanishing}
the morphism $p : X \to \Spec(A)$ is surjective.
\end{lemma}

\begin{proof}
This lemma was originally used in the proof of
Cohomology of Spaces, Proposition
\ref{spaces-cohomology-proposition-vanishing-affine}
but now is a consequence of it.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-universally-closed}
In Cohomology of Spaces, Situation \ref{spaces-cohomology-situation-vanishing}
the morphism $p : X \to \Spec(A)$ is universally closed.
\end{lemma}

\begin{proof}
This lemma was originally used in the proof of
Cohomology of Spaces, Proposition
\ref{spaces-cohomology-proposition-vanishing-affine}
but now is a consequence of it.
\end{proof}

\begin{remark}
\label{remark-equation-first}
This tag used to refer to an equation in the proof of
Formal Spaces, Lemma \ref{formal-spaces-lemma-iff-adic-star}.
\end{remark}

\begin{remark}
\label{remark-equation-second}
This tag used to refer to an equation in the proof of
Formal Spaces, Lemma \ref{formal-spaces-lemma-iff-adic-star}.
\end{remark}





\section{Obsolete lemmas on algebraic stacks}
\label{section-obsolete-on-stacks}

\noindent
Lemmas that seem superfluous or are no longer used in the text.

\begin{lemma}
\label{lemma-infinite-sequence}
Let $S$ be a locally Noetherian scheme. Let $\mathcal{X}$ be a category
fibred in groupoids over $(\Sch/S)_{fppf}$ having (RS*).
Let $x$ be an object of
$\mathcal{X}$ over an affine scheme $U$ of finite type over $S$.
Let $u_n \in U$, $n \geq 1$ be pairwise distinct finite type points
such that $x$ is not versal at $u_n$ for all $n$. After replacing
$u_n$ by a subsequence, there exist morphisms
$$
x \to x_1 \to x_2 \to \ldots
\quad\text{in }\mathcal{X}\text{ lying over }\quad
U \to U_1 \to U_2 \to \ldots
$$
over $S$ such that
\begin{enumerate}
\item for each $n$ the morphism $U \to U_n$ is a first order
thickening,
\item for each $n$ we have a short exact sequence
$$
0 \to \kappa(u_n) \to \mathcal{O}_{U_n} \to \mathcal{O}_{U_{n - 1}} \to 0
$$
with $U_0 = U$ for $n = 1$,
\item for each $n$ there does {\bf not} exist a pair $(W, \alpha)$
consisting of an open neighbourhood $W \subset U_n$ of $u_n$
and a morphism $\alpha : x_n|_W \to x$
such that the composition
$$
x|_{U \cap W} \xrightarrow{\text{restriction of }x \to x_n}
x_n|_W \xrightarrow{\alpha} x
$$
is the canonical morphism $x|_{U \cap W} \to x$.
\end{enumerate}
\end{lemma}

\begin{proof}
This lemma was originally used in the proof of a criterion for
openness of versality
(Artin's Axioms, Lemma \ref{artin-lemma-SGE-implies-openness-versality}) but it
got replaced by Artin's Axioms, Lemma \ref{artin-lemma-infinite-sequence-pre}
from which it readily follows. Namely,
after replacing $u_n$, $n \geq 1$ by a subsequence we may and do
assume that there are no specializations among these points, see
Properties, Lemma \ref{properties-lemma-thin-infinite-sequence}.
Then we can apply
Artin's Axioms, Lemma \ref{artin-lemma-infinite-sequence-pre}
to finish the proof.
\end{proof}







\section{Variants of cotangent complexes for schemes}
\label{section-cotangent-schemes-variant}

\noindent
This section gives an alternative construction of the cotangent complex
of a morphism of schemes. This section is currently in the obsolete
chapter as we can get by with the easier version discussed in
Cotangent, Section \ref{cotangent-section-cotangent-schemes-variant}
for applications.

\medskip\noindent
Let $f : X \to Y$ be a morphism of schemes. Let $\mathcal{C}_{X/Y}$ be the
category whose objects are commutative diagrams
\begin{equation}
\label{equation-object}
\vcenter{
\xymatrix{
X \ar[d] & U \ar[l] \ar[d] \ar[r]_i & A \ar[ld] \\
Y & V \ar[l]
}
}
\end{equation}
of schemes where
\begin{enumerate}
\item $U$ is an open subscheme of $X$,
\item $V$ is an open subscheme of $Y$, and
\item there exists an isomorphism $A = V \times \Spec(P)$ over $V$
where $P$ is a polynomial algebra over $\mathbf{Z}$ (on some set
of variables).
\end{enumerate}
In other words, $A$ is an (infinite dimensional) affine space over $V$.
Morphisms are given by commutative diagrams.

\medskip\noindent
{\bf Notation.} An object of $\mathcal{C}_{X/Y}$, i.e., a diagram
(\ref{equation-object}), is often denoted $U \to A$ where it is
understood that (a) $U$ is an open subscheme of $X$, (b)
$U \to A$ is a morphism over $Y$, (c) the image of the
structure morphism $A \to Y$ is an open $V \subset Y$, and (d)
$A \to V$ is an affine space. We'll write $U \to A/V$ to indicate
$V \subset Y$ is the image of $A \to Y$.
Recall that $X_{Zar}$ denotes the small Zariski site $X$.
There are forgetful functors
$$
\mathcal{C}_{X/Y} \to X_{Zar},\ (U \to A) \mapsto U
\quad\text{and}\quad
\mathcal{C}_{X/Y} \mapsto Y_{Zar},\ (U \to A/V) \mapsto V.
$$

\begin{lemma}
\label{lemma-category-fibred}
Let $X \to Y$ be a morphism of schemes.
\begin{enumerate}
\item The category $\mathcal{C}_{X/Y}$ is fibred over $X_{Zar}$.
\item The category $\mathcal{C}_{X/Y}$ is fibred over $Y_{Zar}$.
\item The category $\mathcal{C}_{X/Y}$ is fibred over the
category of pairs $(U, V)$ where $U \subset X$, $V \subset Y$ are
open and $f(U) \subset V$.
\end{enumerate}
\end{lemma}

\begin{proof}
Ad (1). Given an object $U \to A$ of $\mathcal{C}_{X/Y}$ and a morphism
$U' \to U$ of $X_{Zar}$ consider the object $i' : U' \to A$ of
$\mathcal{C}_{X/Y}$ where $i'$ is the composition of $i$ and $U' \to U$.
The morphism $(U' \to A) \to (U \to A)$ of $\mathcal{C}_{X/Y}$
is strongly cartesian over $X_{Zar}$.

\medskip\noindent
Ad (2). Given an object $U \to A/V$ and $V' \to V$ we can set
$U' = U \cap f^{-1}(V')$ and $A' = V' \times_V A$ to obtain a strongly
cartesian morphism $(U' \to A') \to (U \to A)$ over $V' \to V$.

\medskip\noindent
Ad (3). Denote $(X/Y)_{Zar}$ the category in (3). Given $U \to A/V$
and a morphism $(U', V') \to (U, V)$ in $(X/Y)_{Zar}$ we can consider
$A' = V' \times_V A$. Then the morphism $(U' \to A'/V') \to (U \to A/V)$
is strongly cartesian in $\mathcal{C}_{X/Y}$ over $(X/Y)_{Zar}$.
\end{proof}

\noindent
We obtain a topology $\tau_X$ on $\mathcal{C}_{X/Y}$ by
using the topology inherited from $X_{Zar}$ (see
Stacks, Section \ref{stacks-section-topology}). If not otherwise
stated this is the topology on $\mathcal{C}_{X/Y}$ we will consider.
To be precise, a family of morphisms $\{(U_i \to A_i) \to (U \to A)\}$
is a covering of $\mathcal{C}_{X/Y}$ if and only if
\begin{enumerate}
\item $U = \bigcup U_i$, and
\item $A_i = A$ for all $i$.
\end{enumerate}
We obtain the same collection of sheaves if we allow $A_i \cong A$ in (2).
The functor $u$ defines a morphism of topoi
$\pi : \Sh(\mathcal{C}_{X/Y}) \to \Sh(X_{Zar})$.

\medskip\noindent
The site $\mathcal{C}_{X/Y}$ comes with several sheaves of rings.
\begin{enumerate}
\item The sheaf $\mathcal{O}$ given by the rule
$(U \to A) \mapsto \mathcal{O}(A)$.
\item The sheaf $\underline{\mathcal{O}}_X = \pi^{-1}\mathcal{O}_X$ given by
the rule $(U \to A) \mapsto \mathcal{O}(U)$.
\item The sheaf $\underline{\mathcal{O}}_Y$ given by the rule
$(U \to A/V) \mapsto \mathcal{O}(V)$.
\end{enumerate}
We obtain morphisms of ringed topoi
\begin{equation}
\label{equation-pi-schemes}
\vcenter{
\xymatrix{
(\Sh(\mathcal{C}_{X/Y}), \underline{\mathcal{O}}_X) \ar[r]_i \ar[d]_\pi &
(\Sh(\mathcal{C}_{X/Y}), \mathcal{O}) \\
(\Sh(X_{Zar}), \mathcal{O}_X)
}
}
\end{equation}
The morphism $i$ is the identity on underlying topoi and
$i^\sharp : \mathcal{O} \to \underline{\mathcal{O}}_X$
is the obvious map.
The map $\pi$ is a special case of Cohomology on Sites, Situation
\ref{sites-cohomology-situation-fibred-category}.
An important role will be played in the following
by the derived functors
$
Li^* : D(\mathcal{O}) \longrightarrow D(\underline{\mathcal{O}}_X)
$
left adjoint to $Ri_* = i_* : D(\underline{\mathcal{O}}_X) \to D(\mathcal{O})$
and
$
L\pi_! : D(\underline{\mathcal{O}}_X) \longrightarrow D(\mathcal{O}_X)
$
left adjoint to
$\pi^* = \pi^{-1} : D(\mathcal{O}_X) \to D(\underline{\mathcal{O}}_X)$.

\begin{remark}
\label{remark-different-topologies}
We obtain a second topology $\tau_Y$ on $\mathcal{C}_{X/Y}$
by taking the topology inherited from $Y_{Zar}$.
There is a third topology $\tau_{X \to Y}$ where a family of morphisms
$\{(U_i \to A_i) \to (U \to A)\}$ is a covering if and only
if $U = \bigcup U_i$, $V = \bigcup V_i$ and $A_i \cong V_i \times_V A$.
This is the topology inherited from the topology on the site
$(X/Y)_{Zar}$ whose underlying category is the category of pairs
$(U, V)$ as in Lemma \ref{lemma-category-fibred} part (3). The coverings
of $(X/Y)_{Zar}$ are families $\{(U_i, V_i) \to (U, V)\}$ such that
$U = \bigcup U_i$ and $V = \bigcup V_i$. There are morphisms of topoi
$$
\xymatrix{
\Sh(\mathcal{C}_{X/Y})
= \Sh(\mathcal{C}_{X/Y}, \tau_X) &
\Sh(\mathcal{C}_{X/Y}, \tau_{X \to Y}) \ar[l] \ar[r] &
\Sh(\mathcal{C}_{X/Y}, \tau_Y)
}
$$
(recall that $\tau_X$ is our ``default'' topology). The pullback functors
for these arrows are sheafification and pushforward is the identity on
underlying presheaves. The diagram of topoi
$$
\xymatrix{
\Sh(X_{Zar}) \ar[d]^f & \Sh(\mathcal{C}_{X/Y}) \ar[l]^\pi &
\Sh(\mathcal{C}_{X/Y}, \tau_{X \to Y}) \ar[l] \ar[d] \\
\Sh(Y_{Zar}) & & \Sh(\mathcal{C}_{X/Y}, \tau_Y) \ar[ll]
}
$$
is {\bf not} commutative. Namely, the pullback of a nonzero abelian sheaf on
$Y$ is a nonzero abelian sheaf on $(\mathcal{C}_{X/Y}, \tau_{X \to Y})$,
but we can certainly find examples where such a sheaf pulls back to zero
on $X$. Note that any presheaf $\mathcal{F}$ on
$Y_{Zar}$ gives a sheaf $\underline{\mathcal{F}}$ on $\mathcal{C}_{Y/X}$
by the rule which assigns to $(U \to A/V)$ the set $\mathcal{F}(V)$.
Even if $\mathcal{F}$ happens to be a sheaf it isn't true in general that
$\underline{\mathcal{F}} = \pi^{-1}f^{-1}\mathcal{F}$. This is related
to the noncommutativity of the diagram above, as we can describe
$\underline{\mathcal{F}}$ as the pushforward of the pullback
of $\mathcal{F}$ to $\Sh(\mathcal{C}_{X/Y}, \tau_{X \to Y})$ via
the lower horizontal and right vertical arrows. An
example is the sheaf $\underline{\mathcal{O}}_Y$.
But what is true is that there is a map
$\underline{\mathcal{F}} \to \pi^{-1}f^{-1}\mathcal{F}$
which is transformed (as we shall see later)
into an isomorphism after applying $\pi_!$.
\end{remark}










\section{Deformations and obstructions of flat modules}
\label{section-modules}

\noindent
In this section we sketch a construction of a deformation theory for the
stack of coherent sheaves for any algebraic space $X$ over a ring $\Lambda$.
This material is obsolete due to the improved discussion in
Quot, Section \ref{quot-section-not-flat}.

\medskip\noindent
Our setup will be the following. We assume given
\begin{enumerate}
\item a ring $\Lambda$,
\item an algebraic space $X$ over $\Lambda$,
\item a $\Lambda$-algebra $A$, set
$X_A = X \times_{\Spec(\Lambda)} \Spec(A)$, and
\item a finitely presented $\mathcal{O}_{X_A}$-module $\mathcal{F}$
flat over $A$.
\end{enumerate}
In this situation we will consider all possible surjections
$$
0 \to I \to A' \to A \to 0
$$
where $A'$ is a $\Lambda$-algebra whose kernel $I$ is an ideal of square zero
in $A'$. Given $A'$ we obtain a first order thickening $X_A \to X_{A'}$
of algebraic spaces over $\Spec(\Lambda)$. For each of these we consider
the problem of lifting $\mathcal{F}$ to a finitely presented module
$\mathcal{F}'$ on $X_{A'}$ flat over $A'$. We would like to replicate the
results of Deformation Theory, Lemma \ref{defos-lemma-flat-ringed-topoi}
in this setting.

\medskip\noindent
To be more precise let $\textit{Lift}(\mathcal{F}, A')$ denote the category
of pairs $(\mathcal{F}', \alpha)$ where $\mathcal{F}'$ is a
finitely presented module on $X_{A'}$ flat over $A'$ and
$\alpha : \mathcal{F}'|_{X_A} \to \mathcal{F}$ is an isomorphism.
Morphisms $(\mathcal{F}'_1, \alpha_1) \to (\mathcal{F}'_2, \alpha_2)$
are isomorphisms $\mathcal{F}'_1 \to \mathcal{F}'_2$ which are compatible
with $\alpha_1$ and $\alpha_2$.
The set of isomorphism classes of $\textit{Lift}(\mathcal{F}, A')$
is denoted $\text{Lift}(\mathcal{F}, A')$.

\medskip\noindent
Let $\mathcal{G}$ be a sheaf of $\mathcal{O}_X \otimes_\Lambda A$-modules
on $X_\etale$ flat over $A$. We introduce the category
$\textit{Lift}(\mathcal{G}, A')$ of pairs
$(\mathcal{G}', \beta)$ where $\mathcal{G}'$ is a sheaf of
$\mathcal{O}_X \otimes_\Lambda A'$-modules flat over $A'$ and $\beta$
is an isomorphism $\mathcal{G}' \otimes_{A'} A \to \mathcal{G}$.

\begin{lemma}
\label{lemma-equivalence}
Notation and assumptions as above. Let $p : X_A \to X$ denote the projection.
Given $A'$ denote $p' : X_{A'} \to X$ the projection. The functor $p'_*$
induces an equivalence of categories between
\begin{enumerate}
\item the category $\textit{Lift}(\mathcal{F}, A')$, and
\item the category $\textit{Lift}(p_*\mathcal{F}, A')$.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\noindent
Let $\mathcal{H}$ be a sheaf of $\mathcal{O} \otimes_\Lambda A$-modules
on $\mathcal{C}_{X/\Lambda}$ flat over $A$. We introduce the category
$\textit{Lift}_\mathcal{O}(\mathcal{H}, A')$
whose objects are pairs $(\mathcal{H}', \gamma)$ where $\mathcal{H}'$
is a sheaf of $\mathcal{O} \otimes_\Lambda A'$-modules flat over $A'$
and $\gamma : \mathcal{H}' \otimes_A A' \to \mathcal{H}$
is an isomorphism of $\mathcal{O} \otimes_\Lambda A$-modules.

\medskip\noindent
Let $\mathcal{G}$ be a sheaf of $\mathcal{O}_X \otimes_\Lambda A$-modules
on $X_\etale$ flat over $A$.
Consider the morphisms $i$ and $\pi$ of
Cotangent, Equation (\ref{cotangent-equation-pi-spaces}).
Denote $\underline{\mathcal{G}} = \pi^{-1}(\mathcal{G})$. It is
simply given by the rule $(U \to \mathbf{A}) \mapsto \mathcal{G}(U)$
hence it is a sheaf of $\underline{\mathcal{O}}_X \otimes_\Lambda A$-modules.
Denote $i_*\underline{\mathcal{G}}$ the same sheaf but viewed as a
sheaf of $\mathcal{O} \otimes_\Lambda A$-modules.

\begin{lemma}
\label{lemma-second-equivalence}
Notation and assumptions as above.
The functor $\pi_!$ induces an equivalence of categories between
\begin{enumerate}
\item the category
$\textit{Lift}_\mathcal{O}(i_*\underline{\mathcal{G}}, A')$, and
\item the category $\textit{Lift}(\mathcal{G}, A')$.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-second-equivalence-obs}
Notation and assumptions as in Lemma \ref{lemma-second-equivalence}.
Consider the object
$$
L = L(\Lambda, X, A, \mathcal{G}) = L\pi_!(Li^*(i_*(\underline{\mathcal{G}})))
$$
of $D(\mathcal{O}_X \otimes_\Lambda A)$. Given a surjection $A' \to A$ of
$\Lambda$-algebras with square zero kernel $I$ we have
\begin{enumerate}
\item The category $\textit{Lift}(\mathcal{G}, A')$ is nonempty
if and only if a certain class
$\xi \in \Ext^2_{\mathcal{O}_X \otimes A}(L, \mathcal{G} \otimes_A I)$
is zero.
\item If $\textit{Lift}(\mathcal{G}, A')$ is nonempty, then
$\text{Lift}(\mathcal{G}, A')$ is principal homogeneous under
$\Ext^1_{\mathcal{O}_X \otimes A}(L, \mathcal{G} \otimes_A I)$.
\item Given a lift $\mathcal{G}'$, the set of automorphisms of
$\mathcal{G}'$ which pull back to $\text{id}_\mathcal{G}$ is canonically
isomorphic to
$\Ext^0_{\mathcal{O}_X \otimes A}(L, \mathcal{G} \otimes_A I)$.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\noindent
Finally, we put everything together as follows.

\begin{proposition}
\label{proposition-conclusion}
With $\Lambda$, $X$, $A$, $\mathcal{F}$ as above. There exists a canonical
object $L = L(\Lambda, X, A, \mathcal{F})$ of $D(X_A)$ such that given a
surjection $A' \to A$ of $\Lambda$-algebras with square zero kernel $I$ we
have
\begin{enumerate}
\item The category $\textit{Lift}(\mathcal{F}, A')$ is nonempty
if and only if a certain class $\xi \in \Ext^2_{X_A}(L,
\mathcal{F} \otimes_A I)$ is zero.
\item If $\textit{Lift}(\mathcal{F}, A')$ is nonempty, then
$\text{Lift}(\mathcal{F}, A')$ is principal homogeneous under
$\Ext^1_{X_A}(L, \mathcal{F} \otimes_A I)$.
\item Given a lift $\mathcal{F}'$, the set of automorphisms of
$\mathcal{F}'$ which pull back to $\text{id}_\mathcal{F}$ is canonically
isomorphic to
$\Ext^0_{X_A}(L, \mathcal{F} \otimes_A I)$.
\end{enumerate}
\end{proposition}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-pseudo-coherent}
In the situation of Proposition \ref{proposition-conclusion}, if
$X \to \Spec(\Lambda)$ is locally of finite type and $\Lambda$ is Noetherian,
then $L$ is pseudo-coherent.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}






\section{The stack of coherent sheaves in the non-flat case}
\label{section-not-flat}

\noindent
In Quot, Theorem \ref{quot-theorem-coherent-algebraic}
the assumption that $f : X \to B$ is flat is not necessary.
In this section we modify the method of proof based on ideas from
derived algebraic geometry to get around the flatness hypothesis.
An entirely different method is used in
Quot, Section \ref{quot-section-not-flat}
to get exactly the same result; this is why the
method from this section is obsolete.

\medskip\noindent
The only step in the proof of
Quot, Theorem \ref{quot-theorem-coherent-algebraic}
which uses flatness is in the application of
Quot, Lemma \ref{quot-lemma-coherent-defo-thy}.
The lemma is used to construct an obstruction theory as in
Artin's Axioms, Section \ref{artin-section-dual}.
The proof of the lemma relies on
Deformation Theory, Lemmas \ref{defos-lemma-flat-ringed-topoi} and
\ref{defos-lemma-verify-iv-ringed-topoi} from
Deformation Theory, Section \ref{defos-section-flat-ringed-topoi}.
This is how the assumption that $f$ is flat comes about.
Before we go on, note that results (2) and (3) of
Deformation Theory, Lemmas \ref{defos-lemma-flat-ringed-topoi}
do hold without the assumption that $f$ is flat as they rely
on Deformation Theory, Lemmas \ref{defos-lemma-inf-ext-rel-ringed-topoi}
and \ref{defos-lemma-inf-map-rel-ringed-topoi}
which do not have any flatness assumptions.

\medskip\noindent
Before we give the details we give some motivation for the construction
from derived algebraic geometry, since we think it will clarify what
follows. Let $A$ be a finite type algebra over the locally Noetherian
base $S$. Denote $X \otimes^\mathbf{L} A$ a ``derived base change''
of $X$ to $A$ and denote $i : X_A \to X \otimes^\mathbf{L} A$ the
canonical inclusion morphism. The object $X \otimes^\mathbf{L} A$
does not (yet) have a definition in the Stacks project; we may think of it
as the algebraic space $X_A$ endowed with a simplicial sheaf of rings
$\mathcal{O}_{X \otimes^\mathbf{L} A}$ whose homology sheaves are
$$
H_i(\mathcal{O}_{X \otimes^\mathbf{L} A}) =
\text{Tor}^{\mathcal{O}_S}_i(\mathcal{O}_X, A).
$$
The morphism $X \otimes^\mathbf{L} A \to \Spec(A)$ is flat
(the terms of the simplicial sheaf of rings being $A$-flat),
so the usual material for deformations of flat modules applies to it.
Thus we see that we get an obstruction theory using the groups
$$
\Ext^i_{X \otimes^\mathbf{L} A}(i_*\mathcal{F},
i_*\mathcal{F} \otimes_A M)
$$
where $i = 0, 1, 2$ for inf auts, inf defs, obstructions. Note that
a flat deformation of $i_*\mathcal{F}$ to $X \otimes^\mathbf{L} A'$
is automatically of the form $i'_*\mathcal{F}'$ where $\mathcal{F}'$
is a flat deformation of $\mathcal{F}$. By adjunction
of the functors $Li^*$ and $i_* = Ri_*$ these ext groups are equal to
$$
\Ext^i_{X_A}(Li^*(i_*\mathcal{F}), \mathcal{F} \otimes_A M)
$$
Thus we obtain obstruction groups of exactly the same form as in the
proof of Quot, Lemma \ref{quot-lemma-coherent-defo-thy}
with the only change being
that one replaces the first occurrence of $\mathcal{F}$ by the complex
$Li^*(i_*\mathcal{F})$.

\medskip\noindent
Below we prove the non-flat version of the lemma by a ``direct''
construction of $E(\mathcal{F}) = Li^*(i_*\mathcal{F})$ and direct
proof of its relationship to the deformation theory of $\mathcal{F}$.
In fact, it suffices to construct $\tau_{\geq -2}E(\mathcal{F})$, as we
are only interested in the ext groups
$\Ext^i_{X_A}(Li^*(i_*\mathcal{F}), \mathcal{F} \otimes_A M)$
for $i = 0, 1, 2$. We can even identify the cohomology sheaves
$$
H^i(E(\mathcal{F})) =
\left\{
\begin{matrix}
0 & \text{if }i > 0 \\
\mathcal{F} & \text{if } i = 0 \\
0 & \text{if } i = -1 \\
\text{Tor}_1^{\mathcal{O}_S}(\mathcal{O}_X, A)
\otimes_{\mathcal{O}_X} \mathcal{F} &
\text{if } i = -2
\end{matrix}
\right.
$$
This observation will guide our construction of $E(\mathcal{F})$
in the remarks below.

\begin{remark}[Direct construction]
\label{remark-construction-E}
Let $S$ be a scheme. Let $f : X \to B$ be a
morphism of algebraic spaces over $S$. Let $U$ be another algebraic
space over $B$. Denote $q : X \times_B U \to U$ the second projection.
Consider the distinguished triangle
$$
Lq^*L_{U/B} \to L_{X \times_B U/B} \to E \to Lq^*L_{U/B}[1]
$$
of Cotangent, Section \ref{cotangent-section-fibre-product}.
For any sheaf $\mathcal{F}$ of
$\mathcal{O}_{X \times_B U}$-modules we have the Atiyah class
$$
\mathcal{F} \to
L_{X \times_B U/B}
\otimes_{\mathcal{O}_{X \times_B U}}^\mathbf{L} \mathcal{F}[1]
$$
see Cotangent, Section \ref{cotangent-section-atiyah-general}.
We can compose this with the map to $E$ and choose a distinguished
triangle
$$
E(\mathcal{F}) \to \mathcal{F} \to
\mathcal{F} \otimes_{\mathcal{O}_{X \times_B U}}^\mathbf{L} E[1] \to
E(\mathcal{F})[1]
$$
in $D(\mathcal{O}_{X \times_B U})$.
By construction the Atiyah class lifts to a map
$$
e_\mathcal{F} :
E(\mathcal{F})
\longrightarrow
Lq^*L_{U/B} \otimes_{\mathcal{O}_{X \times_B U}}^\mathbf{L} \mathcal{F}[1]
$$
fitting into a morphism of distinguished triangles
$$
\xymatrix{
\mathcal{F} \otimes^\mathbf{L} Lq^*L_{U/B}[1] \ar[r] &
\mathcal{F} \otimes^\mathbf{L} L_{X \times_B U/B}[1] \ar[r] &
\mathcal{F} \otimes^\mathbf{L} E[1] \\
E(\mathcal{F}) \ar[r] \ar[u]^{e_\mathcal{F}} &
\mathcal{F} \ar[r] \ar[u]^{Atiyah} &
\mathcal{F} \otimes^\mathbf{L} E[1] \ar[u]^{=}
}
$$
Given $S, B, X, f, U, \mathcal{F}$ we fix a choice of $E(\mathcal{F})$
and $e_\mathcal{F}$.
\end{remark}

\begin{remark}[Construction of obstruction class]
\label{remark-construction-ob}
With notation as in Remark \ref{remark-construction-E} let $i : U \to U'$ be a
first order thickening of $U$ over $B$. Let
$\mathcal{I} \subset \mathcal{O}_{U'}$ be the quasi-coherent sheaf of
ideals cutting out $B$ in $B'$. The fundamental triangle
$$
Li^*L_{U'/B} \to L_{U/B} \to L_{U/U'} \to Li^*L_{U'/B}[1]
$$
together with the map $L_{U/U'} \to \mathcal{I}[1]$ determine a
map $e_{U'} : L_{U/B} \to \mathcal{I}[1]$. Combined with the map
$e_\mathcal{F}$ of the previous remark we obtain
$$
(\text{id}_\mathcal{F} \otimes Lq^*e_{U'}) \cup e_\mathcal{F} :
E(\mathcal{F})
\longrightarrow
\mathcal{F} \otimes_{\mathcal{O}_{X \times_B U}} q^*\mathcal{I}[2]
$$
(we have also composed with the map from the derived tensor product to
the usual tensor product). In other words, we obtain an element
$$
\xi_{U'} \in
\Ext^2_{\mathcal{O}_{X \times_B U}}(
E(\mathcal{F}),
\mathcal{F} \otimes_{\mathcal{O}_{X \times_B U}} q^*\mathcal{I})
$$
\end{remark}

\begin{lemma}
\label{lemma-ob-is-obstruction}
In the situation of Remark \ref{remark-construction-ob} assume that
$\mathcal{F}$ is flat over $U$. Then the vanishing of the class
$\xi_{U'}$ is a necessary and sufficient condition for the existence of a
$\mathcal{O}_{X \times_B U'}$-module $\mathcal{F}'$ flat over $U'$
with $i^*\mathcal{F}' \cong \mathcal{F}$.
\end{lemma}

\begin{proof}[Proof (sketch)]
We will use the criterion of
Deformation Theory, Lemma \ref{defos-lemma-inf-obs-ext-rel-ringed-topoi}.
We will abbreviate $\mathcal{O} = \mathcal{O}_{X \times_B U}$ and
$\mathcal{O}' = \mathcal{O}_{X \times_B U'}$.
Consider the short exact sequence
$$
0 \to \mathcal{I} \to \mathcal{O}_{U'} \to \mathcal{O}_U \to 0.
$$
Let $\mathcal{J} \subset \mathcal{O}'$ be the quasi-coherent
sheaf of ideals cutting out $X \times_B U$. By the above we obtain an exact
sequence
$$
\text{Tor}_1^{\mathcal{O}_B}(\mathcal{O}_X, \mathcal{O}_U) \to
q^*\mathcal{I} \to \mathcal{J} \to 0
$$
where the $\text{Tor}_1^{\mathcal{O}_B}(\mathcal{O}_X, \mathcal{O}_U)$
is an abbreviation for
$$
\text{Tor}_1^{h^{-1}\mathcal{O}_B}(p^{-1}\mathcal{O}_X, q^{-1}\mathcal{O}_U)
\otimes_{(p^{-1}\mathcal{O}_X\otimes_{h^{-1}\mathcal{O}_B}q^{-1}\mathcal{O}_U)}
\mathcal{O}.
$$
Tensoring with $\mathcal{F}$ we obtain the exact sequence
$$
\mathcal{F} \otimes_\mathcal{O}
\text{Tor}_1^{\mathcal{O}_B}(\mathcal{O}_X, \mathcal{O}_U) \to
\mathcal{F} \otimes_\mathcal{O}
q^*\mathcal{I} \to
\mathcal{F} \otimes_\mathcal{O} \mathcal{J} \to 0
$$
(Note that the roles of the letters $\mathcal{I}$ and $\mathcal{J}$
are reversed relative to the notation in
Deformation Theory, Lemma \ref{defos-lemma-inf-obs-ext-rel-ringed-topoi}.)
Condition (1) of the lemma is that the last map above is an
isomorphism, i.e., that the first map is zero.
The vanishing of this map may be checked on stalks at geometric points 
$\overline{z} = (\overline{x}, \overline{u}) : \Spec(k) \to X \times_B U$.
Set $R = \mathcal{O}_{B, \overline{b}}$, $A = \mathcal{O}_{X, \overline{x}}$,
$B = \mathcal{O}_{U, \overline{u}}$, and
$C = \mathcal{O}_{\overline{z}}$.
By Cotangent, Lemma \ref{cotangent-lemma-fibre-product}
and the defining triangle for $E(\mathcal{F})$ we see that
$$
H^{-2}(E(\mathcal{F}))_{\overline{z}} =
\mathcal{F}_{\overline{z}} \otimes \text{Tor}_1^R(A, B)
$$
The map $\xi_{U'}$ therefore induces a map
$$
\mathcal{F}_{\overline{z}} \otimes \text{Tor}_1^R(A, B)
\longrightarrow
\mathcal{F}_{\overline{z}} \otimes_B \mathcal{I}_{\overline{u}}
$$
We claim this map is the same as the stalk of the map described above
(proof omitted; this is a purely ring theoretic statement).
Thus we see that condition (1) of 
Deformation Theory, Lemma \ref{defos-lemma-inf-obs-ext-rel-ringed-topoi}
is equivalent to the vanishing
$H^{-2}(\xi_{U'}) :
H^{-2}(E(\mathcal{F})) \to \mathcal{F} \otimes \mathcal{I}$.

\medskip\noindent
To finish the proof we show that, assuming that condition (1) is satisfied,
condition (2) is equivalent to the vanishing of $\xi_{U'}$. In the rest
of the proof we write $\mathcal{F} \otimes \mathcal{I}$ to denote
$\mathcal{F} \otimes_\mathcal{O} q^*\mathcal{I} =
\mathcal{F} \otimes_\mathcal{O} \mathcal{J}$. A consideration
of the spectral sequence
$$
\Ext^i(H^{-j}(E(\mathcal{F})), \mathcal{F} \otimes \mathcal{I})
\Rightarrow
\Ext^{i + j}(E(\mathcal{F}), \mathcal{F} \otimes \mathcal{I})
$$
using that $H^0(E(\mathcal{F})) = \mathcal{F}$ and
$H^{-1}(E(\mathcal{F})) = 0$
shows that there is an exact sequence
$$
0 \to
\Ext^2(\mathcal{F}, \mathcal{F} \otimes \mathcal{I}) \to
\Ext^2(E(\mathcal{F}), \mathcal{F} \otimes \mathcal{I}) \to
\Hom(H^{-2}(E(\mathcal{F})), \mathcal{F} \otimes \mathcal{I})
$$
Thus our element $\xi_{U'}$ is an element of
$\Ext^2(\mathcal{F}, \mathcal{F} \otimes \mathcal{I})$.
The proof is finished by showing this element agrees with the
element of
Deformation Theory, Lemma \ref{defos-lemma-inf-obs-ext-rel-ringed-topoi}
a verification we omit.
\end{proof}

\begin{lemma}
\label{lemma-coherent-defo-thy-general}
In Quot, Situation \ref{quot-situation-coherent} assume that
$S$ is a locally Noetherian scheme and $S = B$.
Let $\mathcal{X} = \textit{Coh}_{X/B}$.
Then we have openness of versality for $\mathcal{X}$ (see
Artin's Axioms, Definition \ref{artin-definition-openness-versality}).
\end{lemma}

\begin{proof}[Proof (sketch)]
Let $U \to S$ be of finite type morphism of schemes, $x$ an object of
$\mathcal{X}$ over $U$ and $u_0 \in U$ a finite type point such that
$x$ is versal at $u_0$. After shrinking $U$ we may assume that $u_0$
is a closed point (Morphisms, Lemma \ref{morphisms-lemma-point-finite-type})
and $U = \Spec(A)$ with $U \to S$ mapping into an
affine open $\Spec(\Lambda)$ of $S$. We will use
Artin's Axioms, Lemma \ref{artin-lemma-dual-openness} to prove the lemma.
Let $\mathcal{F}$ be the coherent module on $X_A = \Spec(A) \times_S X$
flat over $A$ corresponding to the given object $x$.

\medskip\noindent
Choose $E(\mathcal{F})$ and $e_\mathcal{F}$ as in
Remark \ref{remark-construction-E}.
The description of the cohomology sheaves of $E(\mathcal{F})$ shows
that
$$
\Ext^1(E(\mathcal{F}), \mathcal{F} \otimes_A M) =
\Ext^1(\mathcal{F}, \mathcal{F} \otimes_A M)
$$
for any $A$-module $M$. Using this and using
Deformation Theory, Lemma \ref{defos-lemma-inf-ext-rel-ringed-topoi}
we have an isomorphism of functors
$$
T_x(M) = \Ext^1_{X_A}(E(\mathcal{F}), \mathcal{F} \otimes_A M)
$$
By Lemma \ref{lemma-ob-is-obstruction} given any surjection $A' \to A$
of $\Lambda$-algebras with square zero kernel $I$ we have an obstruction class
$$
\xi_{A'} \in \Ext^2_{X_A}(E(\mathcal{F}), \mathcal{F} \otimes_A I)
$$
Apply Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-compute-ext}
to the computation of the Ext groups
$\Ext^i_{X_A}(E(\mathcal{F}), \mathcal{F} \otimes_A M)$
for $i \leq m$ with $m = 2$. We omit the verification that
$E(\mathcal{F})$ is in $D^-_{\textit{Coh}}$; hint: use
Cotangent, Lemma \ref{cotangent-lemma-cotangent-finite}.
We find a perfect object $K \in D(A)$
and functorial isomorphisms
$$
H^i(K \otimes_A^\mathbf{L} M)
\longrightarrow
\Ext^i_{X_A}(E(\mathcal{F}), \mathcal{F} \otimes_A M)
$$
for $i \leq m$ compatible with boundary maps. This object $K$, together
with the displayed identifications above gives us a datum as in
Artin's Axioms, Situation \ref{artin-situation-dual}.
Finally, condition (iv) of
Artin's Axioms, Lemma \ref{artin-lemma-dual-obstruction}
holds by a variant of
Deformation Theory, Lemma \ref{defos-lemma-verify-iv-ringed-topoi}
whose formulation and proof we omit.
Thus Artin's Axioms, Lemma \ref{artin-lemma-dual-openness}
applies and the lemma is proved.
\end{proof}

\begin{theorem}
\label{theorem-coherent-algebraic-general}
Let $S$ be a scheme. Let $f : X \to B$ be morphism of algebraic spaces
over $S$. Assume that $f$ is of finite presentation and separated. Then
$\textit{Coh}_{X/B}$ is an algebraic stack over $S$.
\end{theorem}

\begin{proof}
This theorem is a copy of Quot, Theorem
\ref{quot-theorem-coherent-algebraic-general}.
The reason we have this copy here is that with the
material in this section we get a second proof (as discussed
at the beginning of this section). Namely,
we argue exactly as in the proof of
Quot, Theorem \ref{quot-theorem-coherent-algebraic}
except that we substitute
Lemma \ref{lemma-coherent-defo-thy-general} for
Quot, Lemma \ref{quot-lemma-coherent-defo-thy}.
\end{proof}







\section{Modifications}
\label{section-modifications}

\noindent
Here is a obsolete result on the category of
Algebraization of Formal Spaces, Equation
(\ref{restricted-equation-modification}).
Please visit Algebraization of Formal Spaces, Section
\ref{restricted-section-modifications}
for the current material.

\begin{lemma}
\label{lemma-henselian}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
The category of
Algebraization of Formal Spaces, Equation
(\ref{restricted-equation-modification})
for $A$ is equivalent to the category
Algebraization of Formal Spaces, Equation
(\ref{restricted-equation-modification})
for the henselization $A^h$ of $A$.
\end{lemma}

\begin{proof}
This is a special case of Algebraization of Formal Spaces, Lemma
\ref{restricted-lemma-equivalence-to-completion}.
\end{proof}

\noindent
The following lemma on rational singularities is no longer needed
in the chapter on resolving surface singularities.

\begin{lemma}
\label{lemma-double-dual-rational}
In Resolution of Surfaces, Situation \ref{resolve-situation-rational}.
Let $M$ be a finite reflexive $A$-module. Let $M \otimes_A \mathcal{O}_X$
denote the pullback of the associated $\mathcal{O}_S$-module. Then
$M \otimes_A \mathcal{O}_X$ maps onto its double dual.
\end{lemma}

\begin{proof}
Let $\mathcal{F} = (M \otimes_A \mathcal{O}_X)^{**}$ be the double dual and
let $\mathcal{F}' \subset \mathcal{F}$ be the image of the evaluation map
$M \otimes_A \mathcal{O}_X \to \mathcal{F}$. Then we have a short exact
sequence
$$
0 \to \mathcal{F}' \to \mathcal{F} \to \mathcal{Q} \to 0
$$
Since $X$ is normal, the local rings $\mathcal{O}_{X, x}$ are discrete
valuation rings for points of codimension $1$ (see
Properties, Lemma \ref{properties-lemma-criterion-normal}).
Hence $\mathcal{Q}_x = 0$ for such points by
More on Algebra, Lemma \ref{more-algebra-lemma-cokernel-map-double-dual-dvr}.
Thus $\mathcal{Q}$ is supported in finitely many closed points and is
globally generated by
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-dimension-0}.
We obtain the exact sequence
$$
0 \to H^0(X, \mathcal{F}') \to H^0(X, \mathcal{F}) \to H^0(X, \mathcal{Q}) \to 0
$$
because $\mathcal{F}'$ is generated by global sections
(Resolution of Surfaces, Lemma \ref{resolve-lemma-globally-generated}).
Since $X \to \Spec(A)$ is an isomorphism over the complement of the
closed point, and since $M$ is reflexive, we see that the maps
$$
M \to H^0(X, \mathcal{F}') \to H^0(X, \mathcal{F})
$$
induce isomorphisms after localization at any nonmaximal prime of $A$.
Hence these maps are isomorphisms by More on Algebra, Lemma
\ref{more-algebra-lemma-check-isomorphism-via-depth-and-ass}
and the fact that reflexive modules over normal rings have property $(S_2)$
(More on Algebra, Lemma \ref{more-algebra-lemma-reflexive-over-normal}).
Thus we conclude that $\mathcal{Q} = 0$ as desired.
\end{proof}



\section{Intersection theory}
\label{section-intersection-theory}

\begin{lemma}
\label{lemma-good-blowing-up}
Let $b : X' \to X$ be the blowing up of a smooth projective
scheme over a field $k$ in a smooth closed subscheme $Z \subset X$.
Picture
$$
\xymatrix{
E \ar[r]_j \ar[d]_\pi & X' \ar[d]^b \\
Z \ar[r]^i & X
}
$$
Assume there exists an element of $K_0(X)$ whose restriction to
$Z$ is equal to the class of $\mathcal{C}_{Z/X}$ in $K_0(Z)$.
Then $[Lb^*\mathcal{O}_Z] = [\mathcal{O}_E] \cdot \alpha''$
in $K_0(X')$ for some $\alpha'' \in K_0(X')$.
\end{lemma}

\begin{proof}
The schemes $X$, $X'$, $E$, $Z$ are smooth and projective over
$k$ and hence we have $K'_0(X) = K_0(X) = K_0(\textit{Vect}(X)) =
K_0(D^b_{\textit{Coh}}(X)))$
and similarly for the other $3$. See
Derived Categories of Schemes, Lemmas \ref{perfect-lemma-Noetherian-Kprime},
\ref{perfect-lemma-Kprime-K}, and \ref{perfect-lemma-K-is-old-K}.
We will switch between these versions at will in this proof.
Consider the short exact sequence
$$
0 \to \mathcal{F} \to \pi^*\mathcal{C}_{Z/X} \to \mathcal{C}_{E/X'} \to 0
$$
of finite locally free $\mathcal{O}_E$-modules defining $\mathcal{F}$.
Observe that $\mathcal{C}_{E/X'} = \mathcal{O}_{X'}(-E)|_E$
is the restriction of the invertible $\mathcal{O}_X$-module
$\mathcal{O}_{X'}(-E)$.
Let $\alpha \in K_0(X)$ be an element such that
$i^*\alpha = [\mathcal{C}_{Z/X}]$ in $K_0(Z)$.
Let $\alpha' = b^*\alpha - [\mathcal{O}_{X'}(-E)]$.
Then $j^*\alpha' = [\mathcal{F}]$. We deduce that
$j^*\lambda^i(\alpha') = [\wedge^i(\mathcal{F})]$ by
Weil Cohomology Theories, Lemma \ref{weil-lemma-lambda-operations}.
This means that $[\mathcal{O}_E] \cdot \alpha' = [\wedge^i\mathcal{F}]$
in $K_0(X)$, see
Derived Categories of Schemes, Lemma \ref{perfect-lemma-projection-formula}.
Let $r$ be the maximum codimension of an irreducible component of $Z$
in $X$. A computation which we omit shows that
$H^{-i}(Lb^*\mathcal{O}_Z) = \wedge^i\mathcal{F}$
for $i \geq 0, 1, \ldots, r - 1$ and zero in other degrees.
It follows that in $K_0(X)$ we have
\begin{align*}
[Lb^*\mathcal{O}_Z] & =
\sum\nolimits_{i = 0, \ldots, r - 1} (-1)^i[\wedge^i\mathcal{F}] \\
& =
\sum\nolimits_{i = 0, \ldots, r - 1} (-1)^i[\mathcal{O}_E] \lambda^i(\alpha') \\
& =
[\mathcal{O}_E] \left(\sum\nolimits_{i = 0, \ldots, r - 1}
(-1)^i \lambda^i(\alpha')\right)
\end{align*}
This proves the lemma with
$\alpha'' = \sum_{i = 0, \ldots, r - 1} (-1)^i \lambda^i(\alpha')$.
\end{proof}



\begin{lemma}
\label{lemma-gysin-factors-principal}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $X$ be integral and $n = \dim_\delta(X)$.
Let $a \in \Gamma(X, \mathcal{O}_X)$ be a nonzero function.
Let $i : D = Z(a) \to X$ be the closed immersion of the zero scheme of $a$.
Let $f \in R(X)^*$.
In this case $i^*\text{div}_X(f) = 0$ in $A_{n - 2}(D)$.
\end{lemma}

\begin{proof}
Special case of Chow Homology, Lemma \ref{chow-lemma-gysin-factors-general}.
\end{proof}

\begin{remark}
\label{remark-not-true-not-quasi-compact}
This remark used to say that it wasn't clear whether the arrows
of Chow Homology, Lemma \ref{chow-lemma-cycles-k-group} were isomorphisms
in general. However, we've now found a proof of this fact.
\end{remark}







\subsection{Blowing up lemmas}
\label{section-blowing-up-lemmas}

\noindent
In this section we prove some lemmas on representing
Cartier divisors by suitable effective Cartier divisors
on blowups. These lemmas can be found in \cite[Section 2.4]{F}.
We have adapted the formulation so they also work
in the non-finite type setting. It may happen that the morphism $b$
of Lemma \ref{lemma-blowing-up-intersections} is a composition of
infinitely many blowups, but over any given quasi-compact open
$W \subset X$ one needs only finitely many blowups
(and this is the result of loc.\ cit.).

\begin{lemma}
\label{lemma-push-pull-effective-Cartier}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a proper morphism.
Let $D \subset Y$ be an effective Cartier divisor.
Assume $X$, $Y$ integral, $n = \dim_\delta(X) = \dim_\delta(Y)$ and
$f$ dominant. Then
$$
f_*[f^{-1}(D)]_{n - 1} = [R(X) : R(Y)] [D]_{n - 1}.
$$
In particular if $f$ is birational then $f_*[f^{-1}(D)]_{n - 1} = [D]_{n - 1}$.
\end{lemma}

\begin{proof}
Immediate from Chow Homology, Lemma \ref{chow-lemma-equal-c1-as-cycles}
and the fact that $D$ is the zero
scheme of the canonical section $1_D$ of $\mathcal{O}_X(D)$.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-denominators}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral with $\dim_\delta(X) = n$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
Let $U \subset X$ be the maximal open subscheme such that
$s$ corresponds to a section of $\mathcal{L}$ over $U$.
There exists a projective morphism
$$
\pi : X' \longrightarrow X
$$
such that
\begin{enumerate}
\item $X'$ is integral,
\item $\pi|_{\pi^{-1}(U)} : \pi^{-1}(U) \to U$ is an isomorphism,
\item there exist effective Cartier divisors $D, E \subset X'$
such that
$$
\pi^*\mathcal{L} = \mathcal{O}_{X'}(D - E),
$$
\item the meromorphic section $s$ corresponds, via the isomorphism above,
to the meromorphic section $1_D \otimes (1_E)^{-1}$ (see
Divisors, Definition
\ref{divisors-definition-invertible-sheaf-effective-Cartier-divisor}),
\item we have
$$
\pi_*([D]_{n - 1} - [E]_{n - 1}) = \text{div}_\mathcal{L}(s)
$$
in $Z_{n - 1}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent ideal sheaf
of denominators of $s$, see Divisors, Definition
\ref{divisors-definition-regular-meromorphic-ideal-denominators}.
By Divisors, Lemma \ref{divisors-lemma-blowing-up-denominators}
we get (2), (3), and (4).
By Divisors, Lemma \ref{divisors-lemma-blow-up-integral-scheme}
we get (1). By Divisors, Lemma \ref{divisors-lemma-blowing-up-projective}
the morphism $\pi$ is projective.
We still have to prove (5).
By Chow Homology, Lemma \ref{chow-lemma-equal-c1-as-cycles} we have
$$
\pi_*(\text{div}_{\mathcal{L}'}(s')) = \text{div}_\mathcal{L}(s).
$$
Hence it suffices to show that
$\text{div}_{\mathcal{L}'}(s') = [D]_{n - 1} - [E]_{n - 1}$.
This follows from the equality
$s' = 1_D \otimes 1_E^{-1}$ and additivity, see
Divisors, Lemma \ref{divisors-lemma-c1-additive}.
\end{proof}

\begin{definition}
\label{definition-epsilon}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = n - 1$. The {\it $\epsilon$-invariant}
of this situation is
$$
\epsilon_Z(D_1, D_2) = n_Z \cdot m_Z
$$
where $n_Z$, resp.\ $m_Z$ is the coefficient of
$Z$ in the $(n - 1)$-cycle $[D_1]_{n - 1}$, resp.\ $[D_2]_{n - 1}$.
\end{definition}

\begin{lemma}
\label{lemma-two-divisors}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z$ be an open and closed subscheme of the scheme $D_1 \cap D_2$.
Assume $\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Then there exists a morphism
$b : X' \to X$, and Cartier divisors
$D_1', D_2', E$ on $X'$ with the following properties
\begin{enumerate}
\item $X'$ is integral,
\item $b$ is projective,
\item $b$ is the blowup of $X$ in the closed subscheme $Z$,
\item $E = b^{-1}(Z)$,
\item $b^{-1}(D_1) = D'_1 + E$, and $b^{-1}D_2 = D_2' + E$,
\item $\dim_\delta(D'_1 \cap D'_2) \leq n - 2$, and if
$Z = D_1 \cap D_2$ then $D'_1 \cap D'_2 = \emptyset$,
\item for every integral closed subscheme $W'$
with $\dim_\delta(W') = n - 1$ we have
\begin{enumerate}
\item if $\epsilon_{W'}(D'_1, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_1, E) < \epsilon_W(D_1, D_2),
$$
\item if $\epsilon_{W'}(D'_2, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_2, E) < \epsilon_W(D_1, D_2),
$$
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the quasi-coherent ideal sheaf
$\mathcal{I} = \mathcal{I}_{D_1} + \mathcal{I}_{D_2}$
defines the scheme theoretic intersection $D_1 \cap D_2 \subset X$.
Since $Z$ is a union of connected components of $D_1 \cap D_2$
we see that for every $z \in Z$ the kernel of
$\mathcal{O}_{X, z} \to \mathcal{O}_{Z, z}$ is equal to $\mathcal{I}_z$.
Let $b : X' \to X$ be the blowup of $X$ in $Z$. (So Zariski locally
around $Z$ it is the blowup of $X$ in $\mathcal{I}$.)
Denote $E = b^{-1}(Z)$ the corresponding effective Cartier divisor, see
Divisors,
Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
Since $Z \subset D_1$ we have $E \subset f^{-1}(D_1)$ and hence
$D_1 = D_1' + E$ for some effective Cartier divisor $D'_1 \subset X'$,
see Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}.
Similarly $D_2 = D_2' + E$. This takes care of assertions (1) -- (5).

\medskip\noindent
Note that if $W'$ is as in (7) (a) or (7) (b), then the image $W$
of $W'$ is contained in $D_1 \cap D_2$. If $W$ is not contained in
$Z$, then $b$ is an isomorphism at the generic point of $W$ and
we see that $\dim_\delta(W) = \dim_\delta(W') = n - 1$ which
contradicts the assumption that
$\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Hence $W \subset Z$. This means that
to prove (6) and (7) we may work locally around $Z$ on $X$.

\medskip\noindent
Thus we may assume that $X = \Spec(A)$ with
$A$ a Noetherian domain, and $D_1 = \Spec(A/a)$,
$D_2 = \Spec(A/b)$ and $Z = D_1 \cap D_2$.
Set $I = (a, b)$. Since $A$ is a domain and $a, b \not = 0$ we can
cover the blowup by two patches, namely
$U = \Spec(A[s]/(as - b))$ and $V = \Spec(A[t]/(bt -a))$.
These patches are glued using the isomorphism
$A[s, s^{-1}]/(as - b) \cong A[t, t^{-1}]/(bt - a)$
which maps $s$ to $t^{-1}$.
The effective Cartier divisor $E$ is described by
$\Spec(A[s]/(as - b, a)) \subset U$ and
$\Spec(A[t]/(bt - a, b)) \subset V$.
The closed subscheme $D'_1$ corresponds to
$\Spec(A[t]/(bt - a, t)) \subset U$.
The closed subscheme $D'_2$ corresponds to
$\Spec(A[s]/(as -b, s)) \subset V$.
Since ``$ts = 1$'' we see that $D'_1 \cap D'_2 = \emptyset$.

\medskip\noindent
Suppose we have a prime $\mathfrak q \subset A[s]/(as - b)$
of height one with $s, a \in \mathfrak q$.
Let $\mathfrak p \subset A$ be the corresponding prime of $A$.
Observe that $a, b \in \mathfrak p$.
By the dimension formula we see that $\dim(A_{\mathfrak p}) = 1$
as well. The final assertion to be shown is that
$$
\text{ord}_{A_{\mathfrak p}}(a)
\text{ord}_{A_{\mathfrak p}}(b)
>
\text{ord}_{B_{\mathfrak q}}(a)
\text{ord}_{B_{\mathfrak q}}(s)
$$
where $B = A[s]/(as - b)$. By
Algebra, Lemma \ref{algebra-lemma-quasi-finite-extension-dim-1}
we have $\text{ord}_{A_{\mathfrak p}}(x) \geq \text{ord}_{B_{\mathfrak q}}(x)$
for $x = a, b$. Since $\text{ord}_{B_{\mathfrak q}}(s) > 0$ we win
by additivity of the $\text{ord}$ function and the fact that
$as = b$.
\end{proof}

\begin{definition}
\label{definition-locally-finite-sum-effective-Cartier-divisors}
Let $X$ be a scheme.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$.
Suppose given a function
$I \to \mathbf{Z}_{\geq 0}$, $i \mapsto n_i$.
The {\it sum of the effective Cartier divisors}
$D = \sum n_i D_i$, is the unique effective Cartier divisor
$D \subset X$ such that on any quasi-compact open $U \subset X$
we have $D|_U = \sum_{D_i \cap U \not = \emptyset} n_iD_i|_U$
is the sum as in Divisors,
Definition \ref{divisors-definition-sum-effective-Cartier-divisors}.
\end{definition}

\begin{lemma}
\label{lemma-sum-divisors-associated-Weil}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$.
Suppose given $n_i \geq 0$ for $i \in I$.
Then
$$
[D]_{n - 1} = \sum\nolimits_i n_i[D_i]_{n - 1}
$$
in $Z_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Since we are proving an equality of cycles we may work locally on $X$.
Hence this reduces to a finite sum, and by induction to a sum of
two effective Cartier divisors $D = D_1 + D_2$.
By Chow Homology, Lemma \ref{chow-lemma-compute-c1} we see that
$D_1 = \text{div}_{\mathcal{O}_X(D_1)}(1_{D_1})$ where
$1_{D_1}$ denotes the canonical section of $\mathcal{O}_X(D_1)$.
Of course we have the same statement for $D_2$ and $D$.
Since $1_D = 1_{D_1} \otimes 1_{D_2}$ via the identification
$\mathcal{O}_X(D) = \mathcal{O}_X(D_1) \otimes \mathcal{O}_X(D_2)$
we win by Divisors, Lemma \ref{divisors-lemma-c1-additive}.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-intersections}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = d$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection of
effective Cartier divisors on $X$.
Assume that for all $\{i, j, k\} \subset I$, $\#\{i, j, k\} = 3$
we have $D_i \cap D_j \cap D_k = \emptyset$.
Then there exist
\begin{enumerate}
\item an open subscheme $U \subset X$ with
$\dim_\delta(X \setminus U) \leq d - 3$,
\item a morphism $b : U' \to U$, and
\item effective Cartier divisors $\{D'_j\}_{j \in J}$ on $U'$
\end{enumerate}
with the following properties:
\begin{enumerate}
\item $b$ is proper morphism $b : U' \to U$,
\item $U'$ is integral,
\item $b$ is an isomorphism over the complement of the union of the pairwise
intersections of the $D_i|_U$,
\item $\{D'_j\}_{j \in J}$ is a locally finite collection of effective
Cartier divisors on $U'$,
\item $\dim_\delta(D'_j \cap D'_{j'}) \leq d - 2$ if $j \not = j'$, and
\item $b^{-1}(D_i|_U) = \sum n_{ij} D'_j$ for certain $n_{ij} \geq 0$.
\end{enumerate}
Moreover, if $X$ is quasi-compact, then we may assume $U = X$ in the above.
\end{lemma}

\begin{proof}
Let us first prove this in the quasi-compact case, since it is perhaps
the most interesting case. In this case we produce inductively a sequence
of blowups
$$
X = X_0 \xleftarrow{b_0} X_1 \xleftarrow{b_1} X_2 \leftarrow \ldots
$$
and finite sets of effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \amalg P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$. Finally, we will have
$$
b_n^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$
We conclude that for each $n \geq 0$ we have
$(b_0 \circ \ldots \circ b_n)^{-1}(D_i)$ is a nonnegative
integer combination of the divisors $D_{n + 1, j}$, $j \in I_{n + 1}$.

\medskip\noindent
To start the induction we set $X_0 = X$ and
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\}_{i \in I_n})$ let $X_{n + 1}$ be the
blowup of $X_n$ in the closed subscheme
$Z_n = \bigcup_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Note that the closed subschemes $D_{n, i} \cap D_{n, i'}$ are pairwise
disjoint by our assumption on triple intersections.
In other words we may write
$Z_n = \coprod_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Moreover, in a Zariski neighbourhood of $D_{n, i} \cap D_{n, i'}$ the
morphism $b_n$ is equal to the blowup of the scheme $X_n$
in the closed subscheme $D_{n, i} \cap D_{n, i'}$, and the results
of Lemma \ref{lemma-two-divisors} apply.
Hence setting $D_{n + 1, \{i, i'\}} = b_n^{-1}(D_i \cap D_{i'})$
we get an effective Cartier divisor.
The Cartier divisors $D_{n + 1, \{i, i'\}}$ are pairwise disjoint.
Clearly we have
$b_n^{-1}(D_{n, i}) \supset D_{n + 1, \{i, i'\}}$ for
every $i' \in I_n$, $i' \not = i$. Hence, applying
Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}
we see that indeed $b^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$
for some effective Cartier divisor $D_{n + 1, i}$ on $X_{n + 1}$.
In a neighbourhood of $D_{n + 1, \{i, i'\}}$ these divisors
$D_{n + 1, i}$ play the role of the primed divisors of
Lemma \ref{lemma-two-divisors}. In particular we conclude that
$D_{n + 1, i} \cap D_{n + 1, i'} = \emptyset$ if $i \not = i'$,
$i, i' \in I_n$ by part (6) of Lemma \ref{lemma-two-divisors}.
This already implies that triple intersections
of the divisors $D_{n + 1, i}$ are zero.

\medskip\noindent
OK, and at this point we can use the quasi-compactness of $X$
to conclude that the invariant
\begin{equation}
\label{equation-invariant}
\epsilon(X, \{D_i\}_{i \in I}) =
\max\{\epsilon_Z(D_i, D_{i'}) \mid
Z \subset X,
\dim_\delta(Z) = d - 1,
\{i, i'\} \in P(I)\}
\end{equation}
is finite, since after all each $D_i$ has at most finitely many irreducible
components. We claim that for some $n$ the invariant
$\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ is zero. Namely, if not then
by Lemma \ref{lemma-two-divisors} we have a strictly decreasing sequence
$$
\epsilon(X, \{D_i\}_{i \in I})
=
\epsilon(X_0, \{D_{0, i}\}_{i \in I_0})
>
\epsilon(X_1, \{D_{1, i}\}_{i \in I_1})
>
\ldots
$$
of positive integers which is a contradiction. Take $n$ with
invariant $\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ equal to zero.
This means that there is no integral closed subscheme $Z \subset X_n$
and no pair of indices $i, i' \in I_n$
such that $\epsilon_Z(D_{n, i}, D_{n, i'}) > 0$.
In other words, $\dim_\delta(D_{n, i}, D_{n, i'}) \leq d - 2$ for
all pairs $\{i, i'\} \in P(I_n)$ as desired.

\medskip\noindent
Next, we come to the general case where we no longer assume that
the scheme $X$ is quasi-compact. The problem with the idea from
the first part of the proof is that we may get and infinite sequence
of blowups with centers dominating a fixed point of $X$. In order to
avoid this we cut out suitable closed subsets of codimension $\geq 3$
at each stage. Namely, we will construct by induction
a sequence of morphisms having the following shape
$$
\xymatrix{
X = X_0 \\
U_0 \ar[u]^{j_0} & X_1 \ar[l]_{b_0} \\
 & U_1 \ar[u]^{j_1} & X_2 \ar[l]_{b_1} \\
 & & U_2 \ar[u]^{j_2} & X_3 \ar[l]_{b_2}
}
$$
Each of the morphisms $j_n : U_n \to X_n$ will be an open immersion.
Each of the morphisms $b_n : X_{n + 1} \to U_n$ will be a proper birational
morphism of integral schemes. As in the quasi-compact case we will have
effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$ on $X_n$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \amalg P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$.
Finally, we will arrange it so that
$$
b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$

\medskip\noindent
We start the induction by setting $X_0 = X$,
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\})$ we construct the open subscheme
$U_n$ as follows. For each pair $\{i, i'\} \in P(I_n)$ consider
the closed subscheme $D_{n, i} \cap D_{n, i'}$. This has ``good''
irreducible components which have $\delta$-dimension $d - 2$ and
``bad'' irreducible components which have $\delta$-dimension $d - 1$.
Let us set
$$
\text{Bad}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 1} W
$$
and similarly
$$
\text{Good}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 2} W.
$$
Then $D_{n, i} \cap D_{n, i'} = \text{Bad}(i, i') \cup \text{Good}(i, i')$
and moreover we have
$\dim_\delta(\text{Bad}(i, i') \cap \text{Good}(i, i')) \leq d - 3$.
Here is our choice of $U_n$:
$$
U_n
=
X_n
\setminus
\bigcup\nolimits_{\{i, i'\} \in P(I_n)}
\text{Bad}(i, i') \cap \text{Good}(i, i').
$$
By our condition on triple intersections of the divisors $D_{n, i}$
we see that the union is actually a disjoint union. Moreover,
we see that (as a scheme)
$$
D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}
=
Z_{n, i, i'} \amalg G_{n, i, i'}
$$
where $Z_{n, i, i'}$ is $\delta$-equidimensional of dimension $d - 1$
and $G_{n, i, i'}$ is $\delta$-equidimensional of dimension $d - 2$.
(So topologically $Z_{n, i, i'}$ is the union of the bad components
but throw out intersections with good components.) Finally we set
$$
Z_n =
\bigcup\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'} =
\coprod\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'},
$$
and we let $b_n : X_{n + 1} \to X_n$ be the blowup in $Z_n$.
Note that Lemma \ref{lemma-two-divisors}
applies to the morphism $b_n : X_{n + 1} \to X_n$ locally around
each of the loci $D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}$. Hence,
exactly as in the first part of the proof we obtain effective
Cartier divisors $D_{n + 1, \{i, i'\}}$ for $\{i, i'\} \in P(I_n)$
and effective Cartier divisors $D_{n + 1, i}$ for $i \in I_n$
such that
$b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$.
For each $n$ denote $\pi_n : X_n \to X$ the morphism obtained
as the composition $j_0 \circ \ldots \circ j_{n - 1} \circ b_{n - 1}$.

\medskip\noindent
{\bf Claim:} given any quasi-compact open $V \subset X$
for all sufficiently large $n$ the maps
$$
\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V) \leftarrow \ldots
$$
are all isomorphisms. Namely, if the map
$\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V)$ is not an isomorphism,
then $Z_{n, i, i'} \cap \pi_n^{-1}(V) \not = \emptyset$ for some
$\{i, i'\} \in P(I_n)$. Hence there exists an irreducible component
$W \subset D_{n, i} \cap D_{n, i'}$ with $\dim_\delta(W) = d - 1$.
In particular we see that $\epsilon_W(D_{n, i}, D_{n, i'}) > 0$.
Applying Lemma \ref{lemma-two-divisors} repeatedly we see that
$$
\epsilon_W(D_{n, i}, D_{n, i'})
<
\epsilon(V, \{D_i|_V\}) - n
$$
with $\epsilon(V, \{D_i|_V\})$ as in (\ref{equation-invariant}).
Since $V$ is quasi-compact, we have
$\epsilon(V, \{D_i|_V\}) < \infty$ and taking $n > \epsilon(V, \{D_i|_V\})$
we see the result.

\medskip\noindent
Note that by construction the difference $X_n \setminus U_n$
has $\dim_\delta(X_n \setminus U_n) \leq d - 3$.
Let $T_n = \pi_n(X_n \setminus U_n)$ be its image in $X$.
Traversing in the diagram of maps above using each $b_n$ is closed
it follows that $T_0 \cup \ldots \cup T_n$ is a closed subset of $X$
for each $n$. Any $t \in T_n$ satisfies $\delta(t) \leq d - 3$
by construction. Hence $\overline{T_n} \subset X$ is a closed subset
with $\dim_\delta(T_n) \leq d - 3$. By the claim above we see
that for any quasi-compact open $V \subset X$ we have
$T_n \cap V \not = \emptyset$ for at most finitely many $n$.
Hence $\{\overline{T_n}\}_{n \geq 0}$ is a locally finite
collection of closed subsets, and we may set
$U = X \setminus \bigcup \overline{T_n}$. This will be
$U$ as in the lemma.

\medskip\noindent
Note that $U_n \cap \pi_n^{-1}(U) = \pi_n^{-1}(U)$ by construction
of $U$. Hence all the morphisms
$$
b_n : \pi_{n + 1}^{-1}(U) \longrightarrow \pi_n^{-1}(U)
$$
are proper. Moreover, by the claim they eventually become isomorphisms
over each quasi-compact open of $X$. Hence we can define
$$
U' = \lim_n \pi_n^{-1}(U).
$$
The induced morphism $b : U' \to U$ is proper since this is local
on $U$, and over each compact open the limit stabilizes. Similarly
we set $J = \bigcup_{n \geq 0} I_n$ using the inclusions
$I_n \to I_{n + 1}$ from the construction. For $j \in J$ choose
an $n_0$ such that $j$ corresponds to $i \in I_{n_0}$ and define
$D'_j = \lim_{n \geq n_0} D_{n, i}$. Again this makes sense
as locally over $X$ the morphisms stabilize.
The other claims of the lemma are verified as in the case
of a quasi-compact $X$.
\end{proof}









\section{Commutativity of intersecting divisors}
\label{section-commutativity}

\noindent
The results of this section were originally used to provide an alternative
proof of the lemmas of Chow Homology, Section \ref{chow-section-commutativity}
and a weak version of
Chow Homology, Lemma \ref{chow-lemma-gysin-commutes-gysin}.

\begin{lemma}
\label{lemma-improved-additivity}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\{i_j : D_j \to X \}_{j \in J}$ be a locally finite collection
of effective Cartier divisors on $X$. Let $n_j > 0$, $j\in J$.
Set $D = \sum_{j \in J} n_j D_j$, and denote $i : D \to X$ the
inclusion morphism. Let $\alpha \in Z_{k + 1}(X)$. Then
$$
p : \coprod\nolimits_{j \in J} D_j \longrightarrow D
$$
is proper and
$$
i^*\alpha = p_*\left(\sum n_j i_j^*\alpha\right)
$$
in $\CH_k(D)$.
\end{lemma}

\begin{proof}
The proof of this lemma is made a bit longer than expected
by a subtlety concerning infinite sums of rational equivalences.
In the quasi-compact case the family $D_j$ is finite and the result
is altogether easy and a straightforward consequence of
Chow Homology, Lemma \ref{chow-lemma-compute-c1} and
Divisors, Lemma \ref{divisors-lemma-c1-additive} and the definitions.

\medskip\noindent
The morphism $p$ is proper since the family $\{D_j\}_{j \in J}$
is locally finite. Write $\alpha = \sum_{a \in A} m_a [W_a]$
with $W_a \subset X$ an integral closed subscheme of
$\delta$-dimension $k + 1$.
Denote $i_a : W_a \to X$ the closed immersion.
We assume that $m_a \not = 0$ for all $a \in A$ such that
$\{W_a\}_{a \in A}$ is locally finite on $X$.

\medskip\noindent
Observe that by
Chow Homology, Definition \ref{chow-definition-gysin-homomorphism}
the class $i^*\alpha$ is the class of a cycle
$\sum m_a\beta_a$ for certain $\beta_a \in Z_k(W_a \cap D)$.
Namely, if $W_a \not \subset D$ then $\beta_a = [D \cap W_a]_k$
and if $W_a \subset D$, then $\beta_a$ is a cycle
representing $c_1(\mathcal{O}_X(D)) \cap [W_a]$.

\medskip\noindent
For each $a \in A$ write $J = J_{a, 1} \amalg J_{a, 2} \amalg J_{a, 3}$
where
\begin{enumerate}
\item $j \in J_{a, 1}$ if and only if $W_a \cap D_j = \emptyset$,
\item $j \in J_{a, 2}$ if and only if
$W_a \not = W_a \cap D_1 \not = \emptyset$, and
\item $j \in J_{a, 3}$ if and only if $W_a \subset D_j$.
\end{enumerate}
Since the family $\{D_j\}$ is locally finite we see that
$J_{a, 3}$ is a finite set. For every $a \in A$ and $j \in J$
we choose a cycle $\beta_{a, j} \in Z_k(W_a \cap D_j)$ as follows
\begin{enumerate}
\item if $j \in J_{a, 1}$ we set $\beta_{a, j} = 0$,
\item if $j \in J_{a, 2}$ we set $\beta_{a, j} = [D_j \cap W_a]_k$, and
\item if $j \in J_{a, 3}$ we choose $\beta_{a, j} \in Z_k(W_a)$
representing $c_1(i_a^*\mathcal{O}_X(D_j)) \cap [W_j]$.
\end{enumerate}
We claim that
$$
\beta_a \sim_{rat}
\sum\nolimits_{j \in J} n_j \beta_{a, j}
$$
in $\CH_k(W_a \cap D)$.

\medskip\noindent
Case I: $W_a \not \subset D$. In this case $J_{a, 3} = \emptyset$.
Thus it suffices to show that
$[D \cap W_a]_k = \sum n_j [D_j \cap W_a]_k$ as cycles.
This is Lemma \ref{lemma-sum-divisors-associated-Weil}.

\medskip\noindent
Case II: $W_a \subset D$. In this case $\beta_a$ is a cycle representing
$c_1(i_a^*\mathcal{O}_X(D)) \cap [W_a]$.
Write $D = D_{a, 1} + D_{a, 2} + D_{a, 3}$ with
$D_{a, s} = \sum_{j \in J_{a, s}} n_jD_j$.
By Divisors, Lemma \ref{divisors-lemma-c1-additive} we have
\begin{eqnarray*}
c_1(i_a^*\mathcal{O}_X(D)) \cap [W_a] & = &
c_1(i_a^*\mathcal{O}_X(D_{a, 1})) \cap [W_a] +
c_1(i_a^*\mathcal{O}_X(D_{a, 2})) \cap [W_a] \\
& &
 + c_1(i_a^*\mathcal{O}_X(D_{a, 3})) \cap [W_a].
\end{eqnarray*}
It is clear that the first term of the sum is zero.
Since $J_{a, 3}$ is finite we see that the last term agrees
with $\sum\nolimits_{j \in J_{a, 3}} n_jc_1(i_a^*\mathcal{L}_j) \cap [W_a]$,
see Divisors, Lemma \ref{divisors-lemma-c1-additive}.
This is represented by $\sum_{j \in J_{a, 3}} n_j \beta_{a, j}$.
Finally, by Case I we see that the middle term is represented by the cycle
$\sum\nolimits_{j \in J_{a, 2}} n_j[D_j \cap W_a]_k =
\sum_{j \in J_{a, 2}} n_j\beta_{a, j}$.
Whence the claim in this case.

\medskip\noindent
At this point we are ready to finish the proof of the lemma.
Namely, we have $i^*D \sim_{rat} \sum m_a\beta_a$ by our
choice of $\beta_a$. For each $a$ we have
$\beta_a \sim_{rat} \sum_j \beta_{a, j}$ with the rational
equivalence taking place on $D \cap W_a$.
Since the collection of closed subschemes $D \cap W_a$
is locally finite on $D$, we see that also
$\sum m_a \beta_a \sim_{rat} \sum_{a, j} m_a\beta_{a, j}$
on $D$! (See
Chow Homology, Remark \ref{chow-remark-infinite-sums-rational-equivalences}.)
Ok, and now it is clear that $\sum_a m_a\beta_{a, j}$ (viewed
as a cycle on $D_j$) represents $i_j^*\alpha$ and hence
$\sum_{a, j} m_a\beta_{a, j}$ represents $p_* \sum_j i_j^*\alpha$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D$, $D'$ be effective Cartier divisors on $X$.
Assume $\dim_\delta(D \cap D') = n - 2$. Let $i : D \to X$,
resp.\ $i' : D' \to X$ be the corresponding closed immersions.
Then
\begin{enumerate}
\item there exists a cycle $\alpha \in Z_{n - 2}(D \cap D')$
whose pushforward to $D$ represents
$i^*[D']_{n - 1} \in \CH_{n - 2}(D)$
and whose pushforward to $D'$ represents
$(i')^*[D]_{n - 1} \in \CH_{n - 2}(D')$, and
\item we have
$$
D \cdot [D']_{n - 1}
=
D' \cdot [D]_{n - 1}
$$
in $\CH_{n - 2}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) is a trivial consequence of part (1).
Let us write $[D]_{n - 1} = \sum n_a[Z_a]$ and
$[D']_{n - 1} = \sum m_b[Z_b]$ with $Z_a$ the irreducible
components of $D$ and $[Z_b]$ the irreducible
components of $D'$. According to
Chow Homology, Definition \ref{chow-definition-gysin-homomorphism},
we have $i^*D' = \sum m_b i^*[Z_b]$ and $(i')^*D = \sum n_a(i')^*[Z_a]$.
By assumption, none of the irreducible components $Z_b$
is contained in $D$, and hence $i^*[Z_b] = [Z_b\cap D]_{n - 2}$
by definition. Similarly $(i')^*[Z_a] = [Z_a \cap D']_{n - 2}$.
Hence we are trying to prove the equality of cycles
$$
\sum n_a[Z_a \cap D']_{n - 2} = \sum m_b[Z_b \cap D]_{n - 2}
$$
which are indeed supported on $D \cap D'$.
Let $W \subset X$ be an integral closed subscheme
with $\dim_\delta(W) = n - 2$. Let $\xi \in W$ be its generic point.
Set $R = \mathcal{O}_{X, \xi}$. It is a Noetherian local domain.
Note that $\dim(R) = 2$. Let $f \in R$, resp.\ $f' \in R$
be an element defining the ideal of $D$, resp.\ $D'$.
By assumption $\dim(R/(f, f')) = 0$. Let
$\mathfrak q'_1, \ldots, \mathfrak q'_t \subset R$ be the minimal
primes over $(f')$, let $\mathfrak q_1, \ldots, \mathfrak q_s \subset R$
be the minimal primes over $(f)$.
The equality above comes down to the equality
$$
\sum_{i = 1, \ldots, s}
\text{length}_{R_{\mathfrak q_i}}(R_{\mathfrak q_i}/(f))
\text{ord}_{R/\mathfrak q_i}(f')
=
\sum_{j = 1, \ldots, t}
\text{length}_{R_{\mathfrak q'_j}}(R_{\mathfrak q'_j}/(f'))
\text{ord}_{R/\mathfrak q'_j}(f).
$$
By Chow Homology, Lemma \ref{chow-lemma-length-multiplication} 
applied with $M = R/(f)$ the left hand side of
this equation is equal to
$$
\text{length}_R(R/(f, f'))
-
\text{length}_R(\Ker(f' : R/(f) \to R/(f)))
$$
OK, and now we note that
$\Ker(f' : R/(f) \to R/(f))$ is canonically isomorphic
to $((f) \cap (f'))/(ff')$ via the map $x \bmod (f) \mapsto
f'x \bmod (ff')$. Hence the left hand side is
$$
\text{length}_R(R/(f, f'))
-
\text{length}_R((f) \cap (f')/(ff'))
$$
Since this is symmetric in $f$ and $f'$ we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection-infinite}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\{D_j\}_{j \in J}$ be a locally finite collection of
effective Cartier divisors on $X$. Let $n_j, m_j \geq 0$ be
collections of nonnegative integers. Set
$D = \sum n_j D_j$ and $D' = \sum m_j D_j$.
Assume that $\dim_\delta(D_j \cap D_{j'}) = n - 2$ for every
$j \not = j'$. Then $D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}$ in
$\CH_{n - 2}(X)$.
\end{lemma}

\begin{proof}
This lemma is a trivial consequence of
Lemmas \ref{lemma-sum-divisors-associated-Weil} and
\ref{lemma-commutativity-effective-Cartier-proper-intersection}
in case the sums are finite, e.g., if $X$ is quasi-compact.
Hence we suggest the reader skip the proof.

\medskip\noindent
Here is the proof in the general case.
Let $i_j : D_j \to X$ be the closed immersions
Let $p : \coprod D_j \to X$ denote coproduct of the morphisms $i_j$.
Let $\{Z_a\}_{a \in A}$ be the collection of irreducible components of
$\bigcup D_j$. For each $j$ we write
$$
[D_j]_{n - 1} = \sum d_{j, a}[Z_a].
$$
By Lemma \ref{lemma-sum-divisors-associated-Weil} we have
$$
[D]_{n - 1} = \sum n_j d_{j, a} [Z_a],
\quad
[D']_{n - 1} = \sum m_j d_{j, a} [Z_a].
$$
By Lemma \ref{lemma-improved-additivity}
we have
$$
D \cdot [D']_{n - 1} = p_*\left(\sum n_j i_j^*[D']_{n - 1} \right),
\quad
D' \cdot [D]_{n - 1} = p_*\left(\sum m_{j'} i_{j'}^*[D]_{n - 1} \right).
$$
As in the definition of the Gysin homomorphisms (see
Chow Homology, Definition \ref{chow-definition-gysin-homomorphism})
we choose cycles $\beta_{a, j}$ on $D_j \cap Z_a$ representing
$i_j^*[Z_a]$. (Note that in fact $\beta_{a, j} = [D_j \cap Z_a]_{n - 2}$
if $Z_a$ is not contained in $D_j$, i.e., there is no choice in that case.)
Now since $p$ is a closed immersion when restricted to each of the $D_j$
we can (and we will) view $\beta_{a, j}$ as a cycle on $X$.
Plugging in the formulas for $[D]_{n - 1}$ and $[D']_{n - 1}$ obtained
above we see that
$$
D \cdot [D']_{n - 1} =
\sum\nolimits_{j, j', a} n_j m_{j'} d_{j', a} \beta_{a, j},
\quad
D' \cdot [D]_{n - 1} =
\sum\nolimits_{j, j', a} m_{j'} n_j d_{j, a} \beta_{a, j'}.
$$
Moreover, with the same conventions we also have
$$
D_j \cdot [D_{j'}]_{n - 1} = \sum d_{j', a} \beta_{a, j}.
$$
In these terms
Lemma \ref{lemma-commutativity-effective-Cartier-proper-intersection}
(see also its proof)
says that for $j \not = j'$ the cycles
$\sum d_{j', a} \beta_{a, j}$ and $\sum d_{j, a} \beta_{a, j'}$
are equal as cycles! Hence we see that
\begin{eqnarray*}
D \cdot [D']_{n - 1}
& = &
\sum\nolimits_{j, j', a} n_j m_{j'} d_{j', a} \beta_{a, j} \\
& = &
\sum\nolimits_{j \not = j'} n_j m_{j'}
\left(\sum\nolimits_a d_{j', a} \beta_{a, j}\right) +
\sum\nolimits_{j, a} n_j m_j d_{j, a} \beta_{a, j} \\
& = &
\sum\nolimits_{j \not = j'} n_j m_{j'}
\left(\sum\nolimits_a d_{j, a} \beta_{a, j'}\right) +
\sum\nolimits_{j, a} n_j m_j d_{j, a} \beta_{a, j} \\
& = &
\sum\nolimits_{j, j', a} m_{j'} n_j d_{j, a} \beta_{a, j'} \\
& = &
D' \cdot [D]_{n - 1}
\end{eqnarray*}
and we win.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier}
Let $(S, \delta)$ be as in Chow Homology, Situation \ref{chow-situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D$, $D'$ be effective Cartier divisors on $X$.
Then
$$
D \cdot [D']_{n - 1} = D' \cdot [D]_{n - 1}
$$
in $\CH_{n - 2}(X)$.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-commutativity-effective-Cartier}]
First, let us prove this in case $X$ is quasi-compact.
In this case, apply
Lemma \ref{lemma-blowing-up-intersections} to $X$ and the
two element set $\{D, D'\}$ of effective Cartier divisors.
Thus we get a proper morphism $b : X' \to X$,
a finite collection of effective Cartier
divisors $D'_j \subset X'$ intersecting pairwise in codimension $\geq 2$,
with $b^{-1}(D) = \sum n_j D'_j$, and $b^{-1}(D') = \sum m_j D'_j$.
Note that $b_*[b^{-1}(D)]_{n - 1} = [D]_{n - 1}$ in $Z_{n - 1}(X)$
and similarly for $D'$,
see Lemma \ref{lemma-push-pull-effective-Cartier}.
Hence, by Chow Homology, Lemma \ref{chow-lemma-pushforward-cap-c1} we have
$$
D \cdot [D']_{n - 1} = b_*\left(b^{-1}(D) \cdot [b^{-1}(D')]_{n - 1}\right)
$$
in $\CH_{n - 2}(X)$ and similarly for the other term. Hence the
lemma follows from the equality
$b^{-1}(D) \cdot [b^{-1}(D')]_{n - 1} = b^{-1}(D') \cdot [b^{-1}(D)]_{n - 1}$
in $\CH_{n - 2}(X')$ of Lemma
\ref{lemma-commutativity-effective-Cartier-proper-intersection-infinite}.

\medskip\noindent
Note that in the proof above, each referenced lemma works also
in the general case (when $X$ is not assumed quasi-compact). The
only minor change in the general case is that the morphism
$b : U' \to U$ we get from applying
Lemma \ref{lemma-blowing-up-intersections}
has as its target
an open $U \subset X$ whose complement has codimension $\geq 3$.
Hence by Chow Homology, Lemma \ref{chow-lemma-restrict-to-open} we see that
$\CH_{n - 2}(U) = \CH_{n - 2}(X)$
and after replacing $X$ by $U$ the rest of the proof goes through
unchanged.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-commutativity-effective-Cartier}]
Let $\mathcal{I} = \mathcal{O}_X(-D)$ and
$\mathcal{I}' = \mathcal{O}_X(-D')$ be the invertible
ideal sheaves of $D$ and $D'$.
We denote
$\mathcal{I}_{D'} = \mathcal{I} \otimes_{\mathcal{O}_X} \mathcal{O}_{D'}$
and
$\mathcal{I}'_D = \mathcal{I}' \otimes_{\mathcal{O}_X} \mathcal{O}_D$.
We can restrict the inclusion map $\mathcal{I} \to \mathcal{O}_X$
to $D'$ to get a map
$$
\varphi : \mathcal{I}_{D'} \longrightarrow \mathcal{O}_{D'}
$$
and similarly
$$
\psi : \mathcal{I}'_D \longrightarrow \mathcal{O}_D
$$
It is clear that
$$
\Coker(\varphi)
\cong
\mathcal{O}_{D \cap D'}
\cong
\Coker(\psi)
$$
and
$$
\Ker(\varphi)
\cong
\frac{\mathcal{I} \cap \mathcal{I}'}{\mathcal{I}\mathcal{I}'}
\cong
\Ker(\psi).
$$
Hence we see that
$$
\gamma =
[\mathcal{I}_{D'}] - [\mathcal{O}_{D'}]
=
[\mathcal{I}'_D] - [\mathcal{O}_D]
$$
in $K_0(\textit{Coh}_{\leq n - 1}(X))$. On the other hand it is clear that
$$
[\mathcal{I}'_D]_{n - 1} = [D]_{n - 1}, \quad
[\mathcal{I}_{D'}]_{n - 1} = [D']_{n - 1}.
$$
and that
$$
\mathcal{O}_X(D') \otimes \mathcal{I}'_D = \mathcal{O}_D, \quad
\mathcal{O}_X(D) \otimes \mathcal{I}_{D'} = \mathcal{O}_{D'}.
$$
By Chow Homology, Lemma \ref{chow-lemma-coherent-sheaf-cap-c1}
(applied two times)
this means that the element $\gamma$ is an element of $B_{n - 2}(X)$, and
maps to both $c_1(\mathcal{O}_X(D')) \cap [D]_{n - 1}$ and to
$c_1(\mathcal{O}_X(D)) \cap [D']_{n - 1}$ and we win (since the
map $B_{n - 2}(X) \to \CH_{n - 2}(X)$ is well defined -- which is
the key to this proof).
\end{proof}











\section{Dualizing modules on regular proper models}
\label{section-dualizing}

\noindent
In Semistable Reduction, Situation \ref{models-situation-regular-model} we let
$\omega_{X/R}^\bullet = f^!\mathcal{O}_{\Spec(R)}$
be the relative dualizing complex of $f : X \to \Spec(R)$
as introduced in
Duality for Schemes, Remark \ref{duality-remark-relative-dualizing-complex}.
Since $f$ is Gorenstein of relative dimension $1$
by Semistable Reduction, Lemma \ref{models-lemma-gorenstein} we can use
Duality for Schemes, Lemmas
\ref{duality-lemma-affine-flat-Noetherian-gorenstein},
\ref{duality-lemma-CM-shriek}, and
\ref{duality-lemma-gorenstein-CM-morphism}
to see that
$$
\omega_{X/R}^\bullet = \omega_X[1]
$$
for some invertible $\mathcal{O}_X$-module $\omega_X$.
This invertible module is often called the
{\it relative dualizing module of $X$ over $R$}.
Since $R$ is regular (hence Gorenstein) of dimension $1$
we see that $\omega_R^\bullet = R[1]$ is a
normalized dualizing complex for $R$. Hence
$\omega_X = H^{-2}(f^!\omega_R^\bullet)$ and we
see that $\omega_X$ is not just a relative dualizing module
but also a dualizing module, see
Duality for Schemes, Example \ref{duality-example-proper-over-local}.
Thus $\omega_X$ represents the functor
$$
\textit{Coh}(\mathcal{O}_X) \to \textit{Sets},\quad
\mathcal{F} \mapsto \Hom_R(H^1(X, \mathcal{F}), R)
$$
by Duality for Schemes, Lemma
\ref{duality-lemma-dualizing-module-proper-over-A}.
This gives an alternative definition of the relative
dualizing module in
Semistable Reduction, Situation \ref{models-situation-regular-model}.
The formation of $\omega_X$ commutes with arbitrary base change
(for any proper Gorenstein morphism of given relative dimension);
this follows from the corresponding fact for the relative dualizing
complex discussed in
Duality for Schemes, Remark \ref{duality-remark-relative-dualizing-complex}
which goes back to
Duality for Schemes, Lemma \ref{duality-lemma-proper-flat-base-change}.
Thus $\omega_X$ pulls back to the dualizing module $\omega_C$ of $C$ over $K$
discussed in Algebraic Curves, Lemma \ref{curves-lemma-duality-dim-1-CM}.
Note that $\omega_C$ is isomorphic to $\Omega_{C/K}$ by
Algebraic Curves, Lemma \ref{curves-lemma-duality-dim-1}.
Similarly $\omega_X|_{X_k}$ is the dualizing module $\omega_{X_k}$
of $X_k$ over $k$.

\begin{lemma}
\label{lemma-dualizing-components}
In Semistable Reduction, Situation \ref{models-situation-regular-model}
the dualizing module of $C_i$ over $k$ is
$$
\omega_{C_i} = \omega_X(C_i)|_{C_i}
$$
where $\omega_X$ is as above.
\end{lemma}

\begin{proof}
Let $t : C_i \to X$ be the closed immersion. Since $t$ is
the inclusion of an effective Cartier divisor we conclude from
Duality for Schemes, Lemmas
\ref{duality-lemma-twisted-inverse-image-closed} and
\ref{duality-lemma-sheaf-with-exact-support-effective-Cartier}
that we have $t^!(\mathcal{L}) = \mathcal{L}(C_i)|_{C_i}$
for every invertible $\mathcal{O}_X$-module $\mathcal{L}$.
Consider the commutative diagram
$$
\xymatrix{
C_i \ar[r]_t \ar[d]_g & X \ar[d]^f \\
\Spec(k) \ar[r]^s & \Spec(R)
}
$$
Observe that $C_i$ is a Gorenstein curve
(Semistable Reduction, Lemma \ref{models-lemma-gorenstein}) with invertible
dualizing module $\omega_{C_i}$ characterized by the property
$\omega_{C_i}[0] = g^!\mathcal{O}_{\Spec(k)}$. See
Algebraic Curves, Lemma \ref{curves-lemma-duality-dim-1}, its proof, and
Algebraic Curves, Lemmas \ref{curves-lemma-duality-dim-1-CM} and
\ref{curves-lemma-rr}.
On the other hand, $s^!(R[1]) = k$ and hence
$$
\omega_{C_i}[0] =
g^! s^!(R[1]) = t^!f^!(R[1]) = t^!\omega_X
$$
Combining the above we obtain the statement of the lemma.
\end{proof}






\section{Duplicate and split out references}
\label{section-duplicates}

\noindent
This section is a place where we collect duplicates
and references which used to say several things at the
same time but are now split into their constituent parts.

\begin{lemma}
\label{lemma-directed-colimit-finite-type}
Let $X$ be a scheme. Assume $X$ is quasi-compact and quasi-separated.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then $\mathcal{F}$ is the directed colimit of its finite type
quasi-coherent submodules.
\end{lemma}

\begin{proof}
This is a duplicate of Properties, Lemma
\ref{properties-lemma-quasi-coherent-colimit-finite-type}.
\end{proof}

\begin{lemma}
\label{lemma-points-monomorphism}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
The map $\{\Spec(k) \to X \text{ monomorphism}\} \to |X|$ is injective.
\end{lemma}

\begin{proof}
This is a duplicate of
Properties of Spaces, Lemma \ref{spaces-properties-lemma-points-monomorphism}.
\end{proof}

\begin{theorem}
\label{theorem-equivalence-sheaves-point}
Let $S = \Spec(K)$ with $K$ a field.
Let $\overline{s}$ be a geometric point of $S$.
Let $G = \text{Gal}_{\kappa(s)}$ denote the absolute Galois group.
Then there is an equivalence of categories
$\Sh(S_\etale) \to G\textit{-Sets}$,
$\mathcal{F} \mapsto \mathcal{F}_{\overline{s}}$.
\end{theorem}

\begin{proof}
This is a duplicate of \'Etale Cohomology, Theorem
\ref{etale-cohomology-theorem-equivalence-sheaves-point}.
\end{proof}

\begin{remark}
\label{remark-tangent-spaces}
You got here because of a duplicate tag. Please see
Formal Deformation Theory, Section \ref{formal-defos-section-tangent-spaces}
for the actual content.
\end{remark}

\begin{lemma}
\label{lemma-locally-ringed-space-direct-summand-free}
Let $X$ be a locally ringed space. A direct summand of a finite free
$\mathcal{O}_X$-module is finite locally free.
\end{lemma}

\begin{proof}
This is a duplicate of Modules, Lemma
\ref{modules-lemma-direct-summand-of-locally-free-is-locally-free}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-injective}
Let $R$ be a ring. Let $E$ be an $R$-module. The following are equivalent
\begin{enumerate}
\item $E$ is an injective $R$-module, and
\item given an ideal $I \subset R$ and a module map $\varphi : I \to E$
there exists an extension of $\varphi$ to an $R$-module map $R \to E$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is Baer's criterion, see
Injectives, Lemma \ref{injectives-lemma-criterion-baer}.
\end{proof}

\begin{lemma}
\label{lemma-periodic-length}
Let $R$ be a local ring.
\begin{enumerate}
\item If $(M, N, \varphi, \psi)$ is a $2$-periodic complex
such that $M$, $N$ have finite length. Then
$e_R(M, N, \varphi, \psi) = \text{length}_R(M) - \text{length}_R(N)$.
\item If $(M, \varphi, \psi)$ is a $(2, 1)$-periodic complex
such that $M$ has finite length. Then
$e_R(M, \varphi, \psi) = 0$.
\item Suppose that we have a short exact sequence of
$2$-periodic complexes
$$
0 \to (M_1, N_1, \varphi_1, \psi_1)
\to (M_2, N_2, \varphi_2, \psi_2)
\to (M_3, N_3, \varphi_3, \psi_3)
\to 0
$$
If two out of three have cohomology modules of finite length so does
the third and we have
$$
e_R(M_2, N_2, \varphi_2, \psi_2) =
e_R(M_1, N_1, \varphi_1, \psi_1) +
e_R(M_3, N_3, \varphi_3, \psi_3).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Chow Homology, Lemmas
\ref{chow-lemma-additivity-periodic-length} and
\ref{chow-lemma-finite-periodic-length}.
\end{proof}


\begin{lemma}
\label{lemma-extensions-of-rings}
Let $A$ be a ring and let $I$ be an $A$-module.
\begin{enumerate}
\item The set of extensions of rings $0 \to I \to A' \to A \to 0$
where $I$ is an ideal of square zero is canonically bijective to
$\Ext^1_A(\NL_{A/\mathbf{Z}}, I)$.
\item Given a ring map $A \to B$, a $B$-module $N$, an $A$-module
map $c : I \to N$, and given extensions of rings with square zero kernels:
\begin{enumerate}
\item[(a)] $0 \to I \to A' \to A \to 0$ corresponding to
$\alpha \in \Ext^1_A(\NL_{A/\mathbf{Z}}, I)$, and
\item[(b)] $0 \to N \to B' \to B \to 0$ corresponding to
$\beta \in \Ext^1_B(\NL_{B/\mathbf{Z}}, N)$
\end{enumerate}
then there is a map $A' \to B'$ fitting into
Deformation Theory, Equation (\ref{defos-equation-to-solve})
if and only if $\beta$ and $\alpha$
map to the same element of
$\Ext^1_A(\NL_{A/\mathbf{Z}}, N)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Deformation Theory, Lemmas
\ref{defos-lemma-extensions-of-algebras} and
\ref{defos-lemma-extensions-of-algebras-functorial}.
\end{proof}

\begin{lemma}
\label{lemma-extensions-of-ringed-spaces}
Let $(S, \mathcal{O}_S)$ be a ringed space and let $\mathcal{J}$
be an $\mathcal{O}_S$-module.
\begin{enumerate}
\item The set of extensions of sheaves of rings
$0 \to \mathcal{J} \to \mathcal{O}_{S'} \to \mathcal{O}_S \to 0$
where $\mathcal{J}$ is an ideal of square zero is canonically bijective to
$\Ext^1_{\mathcal{O}_S}(\NL_{S/\mathbf{Z}}, \mathcal{J})$.
\item Given a morphism of ringed spaces
$f : (X, \mathcal{O}_X) \to (S, \mathcal{O}_S)$, an $\mathcal{O}_X$-module
$\mathcal{G}$, an $f$-map $c : \mathcal{J} \to \mathcal{G}$, and
given extensions of sheaves of rings with square zero kernels:
\begin{enumerate}
\item[(a)] $0 \to \mathcal{J} \to \mathcal{O}_{S'} \to \mathcal{O}_S \to 0$
corresponding to
$\alpha \in \Ext^1_{\mathcal{O}_S}(\NL_{S/\mathbf{Z}}, \mathcal{J})$,
\item[(b)] $0 \to \mathcal{G} \to \mathcal{O}_{X'} \to \mathcal{O}_X \to 0$
corresponding to
$\beta \in \Ext^1_{\mathcal{O}_X}(\NL_{X/\mathbf{Z}}, \mathcal{G})$
\end{enumerate}
then there is a morphism $X' \to S'$ fitting into
Deformation Theory, Equation
(\ref{defos-equation-to-solve-ringed-spaces})
if and only if $\beta$ and $\alpha$
map to the same element of
$\Ext^1_{\mathcal{O}_X}(Lf^*\NL_{S/\mathbf{Z}}, \mathcal{G})$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Deformation Theory, Lemmas
\ref{defos-lemma-extensions-of-relative-ringed-spaces} and
\ref{defos-lemma-extensions-of-relative-ringed-spaces-functorial}.
\end{proof}

\begin{lemma}
\label{lemma-extensions-of-ringed-topoi}
Let $(\Sh(\mathcal{B}), \mathcal{O}_\mathcal{B})$ be a ringed topos
and let $\mathcal{J}$ be an $\mathcal{O}_\mathcal{B}$-module.
\begin{enumerate}
\item The set of extensions of sheaves of rings
$0 \to \mathcal{J} \to \mathcal{O}_{\mathcal{B}'} \to
\mathcal{O}_\mathcal{B} \to 0$
where $\mathcal{J}$ is an ideal of square zero is canonically bijective to
$\Ext^1_{\mathcal{O}_\mathcal{B}}(
\NL_{\mathcal{O}_\mathcal{B}/\mathbf{Z}}, \mathcal{J})$.
\item Given a morphism of ringed topoi
$f : (\Sh(\mathcal{C}), \mathcal{O}) \to
(\Sh(\mathcal{B}), \mathcal{O}_\mathcal{B})$, an $\mathcal{O}$-module
$\mathcal{G}$, an $f^{-1}\mathcal{O}_\mathcal{B}$-module map
$c : f^{-1}\mathcal{J} \to \mathcal{G}$, and
given extensions of sheaves of rings with square zero kernels:
\begin{enumerate}
\item[(a)] $0 \to \mathcal{J} \to \mathcal{O}_{\mathcal{B}'} \to
\mathcal{O}_\mathcal{B} \to 0$ corresponding to
$\alpha \in \Ext^1_{\mathcal{O}_\mathcal{B}}(
\NL_{\mathcal{O}_\mathcal{B}/\mathbf{Z}}, \mathcal{J})$,
\item[(b)] $0 \to \mathcal{G} \to \mathcal{O}' \to \mathcal{O} \to 0$
corresponding to
$\beta \in \Ext^1_\mathcal{O}(\NL_{\mathcal{O}/\mathbf{Z}}, \mathcal{G})$
\end{enumerate}
then there is a morphism $(\Sh(\mathcal{C}), \mathcal{O}') \to
(\Sh(\mathcal{B}, \mathcal{O}_{\mathcal{B}'})$ fitting into
Deformation Theory, Equation (\ref{defos-equation-to-solve-ringed-topoi})
if and only if $\beta$ and $\alpha$ map to the same element of
$\Ext^1_\mathcal{O}(
Lf^*\NL_{\mathcal{O}_\mathcal{B}/\mathbf{Z}}, \mathcal{G})$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Deformation Theory, Lemmas
\ref{defos-lemma-extensions-of-relative-ringed-topoi} and
\ref{defos-lemma-extensions-of-relative-ringed-topoi-functorial}.
\end{proof}

\begin{remark}
\label{remark-examples-formal-defos}
This tag used to point to a section describing several examples
of deformation problems. These now each have their own section.
See Deformation Problems, Sections
\ref{examples-defos-section-finite-projective-modules},
\ref{examples-defos-section-representations},
\ref{examples-defos-section-continuous-representations}, and
\ref{examples-defos-section-graded-algebras}.
\end{remark}

\begin{lemma}
\label{lemma-examples-have-RS}
Deformation Problems, Examples
\ref{examples-defos-example-finite-projective-modules},
\ref{examples-defos-example-representations},
\ref{examples-defos-example-continuous-representations}, and
\ref{examples-defos-example-graded-algebras}
satisfy the Rim-Schlessinger condition (RS).
\end{lemma}

\begin{proof}
This follows from Deformation Problems, Lemmas
\ref{examples-defos-lemma-finite-projective-modules-RS},
\ref{examples-defos-lemma-representations-RS},
\ref{examples-defos-lemma-continuous-representations-RS}, and
\ref{examples-defos-lemma-graded-algebras-RS}.
\end{proof}

\begin{lemma}
\label{lemma-tangent-and-inf}
We have the following canonical $k$-vector space identifications:
\begin{enumerate}
\item In Deformation Problems, Example
\ref{examples-defos-example-finite-projective-modules}
if $x_0 = (k, V)$, then $T_{x_0}\mathcal{F} = (0)$
and $\text{Inf}_{x_0}(\mathcal{F}) = \text{End}_k(V)$
are finite dimensional.
\item In Deformation Problems, Example
\ref{examples-defos-example-representations}
if $x_0 = (k, V, \rho_0)$, then
$T_{x_0}\mathcal{F} = \Ext^1_{k[\Gamma]}(V, V) = H^1(\Gamma, \text{End}_k(V))$
and $\text{Inf}_{x_0}(\mathcal{F}) = H^0(\Gamma, \text{End}_k(V))$
are finite dimensional if $\Gamma$ is finitely generated.
\item In Deformation Problems, Example
\ref{examples-defos-example-continuous-representations}
if $x_0 = (k, V, \rho_0)$, then
$T_{x_0}\mathcal{F} = H^1_{cont}(\Gamma, \text{End}_k(V))$
and
$\text{Inf}_{x_0}(\mathcal{F}) = H^0_{cont}(\Gamma, \text{End}_k(V))$
are finite dimensional if $\Gamma$ is topologically finitely generated.
\item In Deformation Problems, Example
\ref{examples-defos-example-graded-algebras}
if $x_0 = (k, P)$, then
$T_{x_0}\mathcal{F}$ and $\text{Inf}_{x_0}(\mathcal{F}) = \text{Der}_k(P, P)$
are finite dimensional if $P$ is finitely generated over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Deformation Problems, Lemmas
\ref{examples-defos-lemma-finite-projective-modules-TI},
\ref{examples-defos-lemma-representations-TI},
\ref{examples-defos-lemma-continuous-representations-TI}, and
\ref{examples-defos-lemma-graded-algebras-TI}.
\end{proof}






\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
