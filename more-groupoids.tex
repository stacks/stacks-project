\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Groupoid Schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter is devoted to advanced topics on groupoid schemes.
Even though the results are stated in terms of groupoid schemes, the
reader should keep in mind the $2$-cartesian diagram
\begin{equation}
\label{equation-quotient-stack}
\vcenter{
\xymatrix{
R \ar[r] \ar[d] & U \ar[d] \\
U \ar[r] & [U/R]
}
}
\end{equation}
where $[U/R]$ is the quotient stack, see
Groupoids in Spaces, Remark \ref{spaces-groupoids-remark-fundamental-square}.
Many of the results are motivated by thinking about this diagram.
See for example the beautiful paper \cite{K-M} by Keel and Mori.





\section{Notation}
\label{section-notation}

\noindent
We continue to abide by the conventions and notation introduced in
Groupoids, Section \ref{groupoids-section-notation}.






\section{Useful diagrams}
\label{section-diagrams}

\noindent
We briefly restate the results of
Groupoids, Lemmas \ref{groupoids-lemma-diagram} and
\ref{groupoids-lemma-diagram-pull}
for easy reference in this chapter.
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
In the commutative diagram
\begin{equation}
\label{equation-diagram}
\vcenter{
\xymatrix{
& U & \\
R \ar[d]_s \ar[ru]^t &
R \times_{s, U, t} R
\ar[l]^-{\text{pr}_0} \ar[d]^{\text{pr}_1} \ar[r]_-c &
R \ar[d]^s \ar[lu]_t \\
U & R \ar[l]_t \ar[r]^s & U
}
}
\end{equation}
the two lower squares are fibre product squares.
Moreover, the triangle on top (which is really a square)
is also cartesian.

\medskip\noindent
The diagram
\begin{equation}
\label{equation-pull}
\vcenter{
\xymatrix{
R \times_{t, U, t} R
\ar@<1ex>[r]^-{\text{pr}_1} \ar@<-1ex>[r]_-{\text{pr}_0}
\ar[d]_{\text{pr}_0 \times c \circ (i, 1)} &
R \ar[r]^t \ar[d]^{\text{id}_R} &
U \ar[d]^{\text{id}_U} \\
R \times_{s, U, t} R
\ar@<1ex>[r]^-c \ar@<-1ex>[r]_-{\text{pr}_0} \ar[d]_{\text{pr}_1} &
R \ar[r]^t \ar[d]^s &
U \\
R \ar@<1ex>[r]^s \ar@<-1ex>[r]_t &
U
}
}
\end{equation}
is commutative. The two top rows are isomorphic via the vertical maps given.
The two lower left squares are cartesian.





\section{Sheaf of differentials}
\label{section-differentials}

\noindent
The following lemma is the analogue of
Groupoids, Lemma \ref{groupoids-lemma-group-scheme-module-differentials}.

\begin{lemma}
\label{lemma-sheaf-differentials}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
The sheaf of differentials of $R$ seen as a scheme over
$U$ via $t$ is a quotient of the pullback via $t$ of the conormal sheaf of
the immersion $e : U \to R$. In a formula: there is a canonical surjection
$t^*\mathcal{C}_{U/R} \to \Omega_{R/U}$. If $s$ is flat, then
this map is an isomorphism.
\end{lemma}

\begin{proof}
Note that $e : U \to R$ is an immersion as it is a section
of the morphism $s$, see
Schemes, Lemma \ref{schemes-lemma-section-immersion}.
Consider the following diagram
$$
\xymatrix{
R \ar[r]_-{(1, i)} \ar[d]_t &
R \times_{s, U, t} R \ar[d]^c \ar[rr]_{(\text{pr}_0, i \circ \text{pr}_1)} & &
R \times_{t, U, t} R \\
U \ar[r]^e &
R
}
$$
The square on the left is cartesian, because if $a \circ b = e$, then
$b = i(a)$. The composition of the horizontal maps is the diagonal
morphism of $t : R \to U$. The right top horizontal arrow is an
isomorphism. Hence since $\Omega_{R/U}$ is the conormal sheaf of the
composition it is isomorphic to the conormal sheaf of
$(1, i)$. By
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial-flat}
we get the surjection $t^*\mathcal{C}_{U/R} \to \Omega_{R/U}$
and if $c$ is flat, then this is an isomorphism. Since $c$ is a base change
of $s$ by the properties of Diagram (\ref{equation-pull})
we conclude that if $s$ is flat, then $c$ is flat, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-flat}.
\end{proof}






\section{Local structure}
\label{section-local}

\noindent
Let $S$ be a scheme.
Let $(U, R, s, t, c, e, i)$ be a groupoid scheme over $S$.
Let $u \in U$ be a point. In this section we explain what
kind of structure we obtain on the local rings
$$
A = \mathcal{O}_{U, u}
\quad\text{and}\quad
B = \mathcal{O}_{R, e(u)}
$$
The convention we will use is to denote the local ring homomorphisms
induced by the morphisms $s, t, c, e, i$ by the corresponding letters.
In particular we have a commutative diagram
$$
\xymatrix{
A \ar[rd]_t \ar[rrd]^1 \\
& B \ar[r]^e & A \\
A \ar[ru]^s \ar[rru]_1
}
$$
of local rings. Thus if $I \subset B$ denotes the kernel of $e : B \to A$,
then $B = s(A) \oplus I = t(A) \oplus I$. Let us denote
$$
C = \mathcal{O}_{R \times_{s, U, t} R, (e(u), e(u))}
$$
Then we have
$$
C = (B \otimes_{s, A, t} B)_{\mathfrak m_B \otimes B + B \otimes \mathfrak m_B}
$$
Let $J \subset C$ be the ideal of $C$ generated by $I \otimes B + B \otimes I$.
Then $J$ is also the kernel of the local ring homomorphism
$$
(e, e) : C \longrightarrow A
$$
The composition law $c : R \times_{s, U, t} R \to R$ corresponds to a
ring map
$$
c : B \longrightarrow C
$$
sending $I$ into $J$.

\begin{lemma}
\label{lemma-first-order-structure-c}
The map $I/I^2 \to J/J^2$ induced by $c$ is the composition
$$
I/I^2 \xrightarrow{(1, 1)} I/I^2 \oplus I/I^2 \to J/J^2
$$
where the second arrow comes from the equality
$J = (I \otimes B + B \otimes I)C$.
The map $i : B \to B$ induces the map $-1 : I/I^2 \to I/I^2$.
\end{lemma}

\begin{proof}
To describe a local homomorphism from $C$ to another local ring
it is enough to say what happens to elements of the form
$b_1 \otimes b_2$. Keeping this in mind we have the two canonical maps
$$
e_2 : C \to B,\ b_1 \otimes b_2 \mapsto b_1s(e(b_2)),\quad
e_1 : C \to B,\ b_1 \otimes b_2 \mapsto t(e(b_1))b_2
$$
corresponding to the embeddings
$R \to R \times_{s, U, t} R$ given by
$r \mapsto (r, e(s(r)))$ and $r \mapsto (e(t(r)), r)$.
These maps define maps $J/J^2 \to I/I^2$ which jointly
give an inverse to the map $I/I^2 \oplus I/I^2 \to J/J^2$
of the lemma. Thus to prove statement we only have to show
that $e_1 \circ c : B \to B$ and $e_2 \circ c : B \to B$
are the identity maps. This follows from the fact that both
compositions $R \to R \times_{s, U, t} R \to R$ are identities.

\medskip\noindent
The statement on $i$ follows from the statement on $c$ and the
fact that $c \circ (1, i) = e \circ t$. Some details omitted.
\end{proof}






\section{Properties of groupoids}
\label{section-technical-lemma}

\noindent
Let $(U, R, s, t, c)$ be a groupoid scheme.
The idea behind the results in this section is that $s: R \to U$
is a base change of the morphism $U \to [U/R]$ (see
Diagram (\ref{equation-quotient-stack}).
Hence the local properties of $s : R \to U$ should reflect local
properties of the morphism $U \to [U/R]$.
This doesn't work, because $[U/R]$ is not always an algebraic stack, and
hence we cannot speak of geometric or algebraic properties of
$U \to [U/R]$.
But it turns out that we can make some of it work without even
referring to the quotient stack at all.

\medskip\noindent
Here is a first example of such a result. The open $W \subset U'$ found
in the lemma is roughly speaking the locus where the morphism
$U' \to [U/R]$ has property $\mathcal{P}$.

\begin{lemma}
\label{lemma-local-source}
Let $S$ be a scheme.
Let $(U, R, s, t, c, e, i)$ be a groupoid over $S$.
Let $g : U' \to U$ be a morphism of schemes.
Denote $h$ the composition
$$
\xymatrix{
h : U' \times_{g, U, t} R \ar[r]_-{\text{pr}_1} & R \ar[r]_s & U.
}
$$
Let $\mathcal{P}, \mathcal{Q}, \mathcal{R}$ be properties of morphisms
of schemes. Assume
\begin{enumerate}
\item $\mathcal{R} \Rightarrow \mathcal{Q}$,
\item $\mathcal{Q}$ is preserved under base change and composition,
\item for any morphism $f : X \to Y$ which has $\mathcal{Q}$ there exists a
largest open $W(\mathcal{P}, f) \subset X$ such that $f|_{W(\mathcal{P}, f)}$
has $\mathcal{P}$, and
\item for any morphism $f : X \to Y$ which has $\mathcal{Q}$,
and any morphism $Y' \to Y$ which has $\mathcal{R}$ we have
$Y' \times_Y W(\mathcal{P}, f) = W(\mathcal{P}, f')$, where
$f' : X_{Y'} \to Y'$ is the base change of $f$.
\end{enumerate}
If $s, t$ have $\mathcal{R}$ and $g$ has $\mathcal{Q}$, then
there exists an open subscheme $W \subset U'$ such that
$W \times_{g, U, t} R = W(\mathcal{P}, h)$.
\end{lemma}

\begin{proof}
Note that the following diagram is commutative
$$
\xymatrix{
U' \times_{g, U, t} R \times_{t, U, t} R
\ar[rr]_-{\text{pr}_{12}}
\ar@<1ex>[d]^-{\text{pr}_{02}} \ar@<-1ex>[d]_-{\text{pr}_{01}} & &
R \times_{t, U, t} R
\ar@<1ex>[d]^-{\text{pr}_1} \ar@<-1ex>[d]_-{\text{pr}_0}
\\
U' \times_{g, U, t} R \ar[rr]^{\text{pr}_1} & & R
}
$$
with both squares cartesian (this uses that the two maps
$t \circ \text{pr}_i : R \times_{t, U, t} R \to U$ are equal).
Combining this with the properties of diagram (\ref{equation-pull})
we get a commutative diagram
$$
\xymatrix{
U' \times_{g, U, t} R \times_{t, U, t} R
\ar[rr]_-{c \circ (i, 1)}
\ar@<1ex>[d]^-{\text{pr}_{02}} \ar@<-1ex>[d]_-{\text{pr}_{01}} & &
R
\ar@<1ex>[d]^-{s} \ar@<-1ex>[d]_-{t}
\\
U' \times_{g, U, t} R \ar[rr]^h & & U
}
$$
where both squares are cartesian.

\medskip\noindent
Assume $s, t$ have $\mathcal{R}$ and $g$ has $\mathcal{Q}$.
Then $h$ has $\mathcal{Q}$ as a composition of $s$ (which has
$\mathcal{R}$ hence $\mathcal{Q}$) and a base change of $g$ (which
has $\mathcal{Q}$). Thus $W(\mathcal{P}, h) \subset U' \times_{g, U, t} R$
exists. By our assumptions we have
$\text{pr}_{01}^{-1}(W(\mathcal{P}, h)) =
\text{pr}_{02}^{-1}(W(\mathcal{P}, h))$
since both are the largest open on which $c \circ (i, 1)$ has $\mathcal{P}$.
Note that the projection $U' \times_{g, U, t} R \to U'$ has a section, namely
$\sigma : U' \to U' \times_{g, U, t} R$, $u' \mapsto (u', e(g(u')))$.
Also via the isomorphism
$$
(U' \times_{g, U, t} R) \times_{U'} (U' \times_{g, U, t} R)
=
U' \times_{g, U, t} R \times_{t, U, t} R
$$
the two projections of the left hand side
to $U' \times_{g, U, t} R$ agree with the morphisms $\text{pr}_{01}$
and $\text{pr}_{02}$ on the right hand side. Since
$\text{pr}_{01}^{-1}(W(\mathcal{P}, h)) =
\text{pr}_{02}^{-1}(W(\mathcal{P}, h))$
we conclude that $W(\mathcal{P}, h)$ is the inverse image of a subset of $U$,
which is necessarily the open set
$W = \sigma^{-1}(W(\mathcal{P}, h))$.
\end{proof}

\begin{remark}
\label{remark-local-source-warning}
Warning:
Lemma \ref{lemma-local-source}
should be used with care.
For example, it applies to $\mathcal{P}=$``flat'', $\mathcal{Q}=$``empty'',
and $\mathcal{R}=$``flat and locally of finite presentation''. But given a
morphism of schemes $f : X \to Y$ the largest open $W \subset X$ such that
$f|_W$ is flat is {\it not} the set of points where $f$ is flat!
\end{remark}

\begin{remark}
\label{remark-local-source-apply}
Notwithstanding the warning in
Remark \ref{remark-local-source-warning}
there are some cases where
Lemma \ref{lemma-local-source}
can be used without causing too much ambiguity.
We give a list. In each case we omit the verification of
assumptions (1) and (2) and we give references which imply
(3) and (4). Here is the list:
\begin{enumerate}
\item $\mathcal{Q} = \mathcal{R} =$``locally of finite type'', and
$\mathcal{P} =$``relative dimension $\leq d$''.
See
Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}
and
Morphisms, Lemmas \ref{morphisms-lemma-openness-bounded-dimension-fibres} and
\ref{morphisms-lemma-dimension-fibre-after-base-change}.
\item $\mathcal{Q} = \mathcal{R} =$``locally of finite type'', and
$\mathcal{P} =$``locally quasi-finite''.
This is the case $d = 0$ of the previous item, see
Morphisms, Lemma \ref{morphisms-lemma-locally-quasi-finite-rel-dimension-0}.
\item $\mathcal{Q} = \mathcal{R} =$``locally of finite type'', and
$\mathcal{P} =$``unramified''.
See
Morphisms, Lemmas \ref{morphisms-lemma-unramified-characterize} and
\ref{morphisms-lemma-set-points-where-fibres-unramified}.
\end{enumerate}
What is interesting about the cases listed above is that we do not
need to assume that $s, t$ are flat to get a conclusion about the locus
where the morphism $h$ has property $\mathcal{P}$. We continue the
list:
\begin{enumerate}
\item[(4)] $\mathcal{Q} =$``locally of finite presentation'',
$\mathcal{R} =$``flat and locally of finite presentation'', and
$\mathcal{P} =$``flat''. See
More on Morphisms, Theorem
\ref{more-morphisms-theorem-openness-flatness} and
Lemma \ref{more-morphisms-lemma-flat-locus-base-change}.
\item[(5)] $\mathcal{Q} =$``locally of finite presentation'',
$\mathcal{R} =$``flat and locally of finite presentation'', and
$\mathcal{P}=$``Cohen-Macaulay''. See
More on Morphisms, Definition \ref{more-morphisms-definition-CM}
and
More on Morphisms, Lemmas \ref{more-morphisms-lemma-base-change-CM} and
\ref{more-morphisms-lemma-flat-finite-presentation-CM-open}.
\item[(6)] $\mathcal{Q} =$``locally of finite presentation'',
$\mathcal{R} =$``flat and locally of finite presentation'', and
$\mathcal{P}=$``syntomic'' use
Morphisms, Lemma \ref{morphisms-lemma-set-points-where-fibres-lci}
(the locus is automatically open).
\item[(7)] $\mathcal{Q} =$``locally of finite presentation'',
$\mathcal{R} =$``flat and locally of finite presentation'', and
$\mathcal{P}=$``smooth''. See
Morphisms, Lemma \ref{morphisms-lemma-set-points-where-fibres-smooth}
(the locus is automatically open).
\item[(8)] $\mathcal{Q} =$``locally of finite presentation'',
$\mathcal{R} =$``flat and locally of finite presentation'', and
$\mathcal{P}=$``\'etale''. See
Morphisms, Lemma \ref{morphisms-lemma-set-points-where-fibres-etale}
(the locus is automatically open).
\end{enumerate}
\end{remark}

\noindent
Here is the second result. The $R$-invariant open $W \subset U$ should be
thought of as the inverse image of the largest open of $[U/R]$ over which
the morphism $U \to [U/R]$ has property $\mathcal{P}$.

\begin{lemma}
\label{lemma-property-invariant}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $\tau \in \{Zariski, \linebreak[0] fppf,
\linebreak[0] \etale, \linebreak[0]
smooth, \linebreak[0] syntomic\}$\footnote{The fact that $fpqc$ is missing
is not a typo.}. Let $\mathcal{P}$ be a property of morphisms of schemes
which is $\tau$-local on the target
(Descent, Definition \ref{descent-definition-property-morphisms-local}).
Assume $\{s : R \to U\}$ and $\{t : R \to U\}$ are coverings for the
$\tau$-topology. Let $W \subset U$ be the maximal open subscheme such that
$s|_{s^{-1}(W)} : s^{-1}(W) \to W$ has property $\mathcal{P}$.
Then $W$ is $R$-invariant, see
Groupoids, Definition \ref{groupoids-definition-invariant-open}.
\end{lemma}

\begin{proof}
The existence and properties of the open $W \subset U$ are described in
Descent, Lemma \ref{descent-lemma-largest-open-of-the-base}.
In
Diagram (\ref{equation-diagram})
let $W_1 \subset R$ be the maximal open subscheme over which the morphism
$\text{pr}_1 : R \times_{s, U, t} R \to R$ has property $\mathcal{P}$.
It follows from the aforementioned
Descent, Lemma \ref{descent-lemma-largest-open-of-the-base}
and the assumption that $\{s : R \to U\}$ and $\{t : R \to U\}$ are coverings
for the $\tau$-topology that $t^{-1}(W) = W_1 = s^{-1}(W)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-property-G-invariant}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $G \to U$ be its stabilizer group scheme.
Let $\tau \in \{fppf, \linebreak[0] \etale, \linebreak[0]
smooth, \linebreak[0] syntomic\}$.
Let $\mathcal{P}$ be a property of morphisms which is $\tau$-local
on the target. Assume $\{s : R \to U\}$ and $\{t : R \to U\}$ are coverings
for the $\tau$-topology. Let $W \subset U$ be the maximal open subscheme
such that $G_W \to W$ has property $\mathcal{P}$. Then $W$ is $R$-invariant
(see
Groupoids, Definition
\ref{groupoids-definition-invariant-open}).
\end{lemma}

\begin{proof}
The existence and properties of the open $W \subset U$ are described in
Descent, Lemma \ref{descent-lemma-largest-open-of-the-base}.
The morphism
$$
G \times_{U, t} R \longrightarrow R \times_{s, U} G, \quad
(g, r) \longmapsto (r, r^{-1} \circ g \circ r)
$$
is an isomorphism over $R$ (where $\circ$ denotes
composition in the groupoid). Hence $s^{-1}(W) = t^{-1}(W)$ by the
properties of $W$ proved in the aforementioned
Descent, Lemma \ref{descent-lemma-largest-open-of-the-base}.
\end{proof}



\section{Comparing fibres}
\label{section-fibres}

\noindent
Let $(U, R, s, t, c, e, i)$ be a groupoid scheme over $S$.
Diagram (\ref{equation-diagram})
gives us a way to compare the fibres of the map $s : R \to U$ in a groupoid.
For a point $u \in U$ we will denote $F_u = s^{-1}(u)$ the scheme
theoretic fibre of $s : R \to U$ over $u$. For example the diagram
implies that if $u, u' \in U$ are points such
that $s(r) = u$ and $t(r) = u'$, then
$(F_u)_{\kappa(r)} \cong (F_{u'})_{\kappa(r)}$.
This is a special case of the more general and more precise
Lemma \ref{lemma-two-fibres}
below. To see this take $r' = i(r)$.

\medskip\noindent
A pair $(X, x)$ consisting of a scheme $X$ and a point $x \in X$ is sometimes
called the {\it germ of $X$ at $x$}.
A {\it morphism of germs} $f : (X, x) \to (S, s)$
is a morphism $f : U \to S$ defined on an open neighbourhood
of $x$ with $f(x) = s$. Two such
$f$, $f'$ are said to give the same morphism of germs
if and only if $f$ and $f'$ agree in some open neighbourhood of $x$.
Let $\tau \in \{Zariski, \etale, smooth, syntomic, fppf\}$.
We temporarily introduce the following concept: We say that two morphisms
of germs $f : (X, x) \to (S, s)$ and $f' : (X', x') \to (S', s')$
are {\it isomorphic locally on the base in the $\tau$-topology},
if there exists a pointed scheme $(S'', s'')$ and morphisms of germs
$g : (S'', s'') \to (S, s)$, and $g' : (S'', s'') \to (S', s')$
such that
\begin{enumerate}
\item $g$ and $g'$ are an open immersion (resp.\ \'etale, smooth, syntomic,
flat and locally of finite presentation) at $s''$,
\item there exists an isomorphism
$$
(S'' \times_{g, S, f} X, \tilde x)
\cong
(S'' \times_{g', S', f'} X', \tilde  x')
$$
of germs over the germ $(S'', s'')$ for some choice of points
$\tilde x$ and $\tilde x'$ lying over $(s'', x)$ and $(s'', x')$.
\end{enumerate}
Finally, we simply say that the maps of germs
$f : (X, x) \to (S, s)$ and $f' : (X', x') \to (S', s')$
are {\it flat locally on the base isomorphic} if there exist
$S'', s'', g, g'$ as above but with (1) replaced by
the condition that $g$ and $g'$ are flat at $s''$ (this is
much weaker than any of the $\tau$ conditions above
as a flat morphism need not be open).

\begin{lemma}
\label{lemma-two-fibres}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $r, r' \in R$ with $t(r) = t(r')$ in $U$.
Set $u = s(r)$, $u' = s(r')$.
Denote $F_u = s^{-1}(u)$ and $F_{u'} = s^{-1}(u')$ the scheme
theoretic fibres.
\begin{enumerate}
\item There exists a common field extension
$\kappa(u) \subset k$, $\kappa(u') \subset k$ and
an isomorphism $(F_u)_k \cong (F_{u'})_k$.
\item We may choose the isomorphism of (1) such that a point
lying over $r$ maps to a point lying over $r'$.
\item If the morphisms $s$, $t$ are flat then the morphisms of germs
$s : (R, r) \to (U, u)$ and $s : (R, r') \to (U, u')$ are flat
locally on the base isomorphic.
\item If the morphisms $s$, $t$ are \'etale
(resp.\ smooth, syntomic, or flat and locally of finite presentation)
then the morphisms of germs $s : (R, r) \to (U, u)$ and
$s : (R, r') \to (U, u')$ are locally on the base isomorphic
in the \'etale (resp.\ smooth, syntomic, or fppf) topology.
\end{enumerate}
\end{lemma}

\begin{proof}
We repeatedly use the properties and the existence of
diagram (\ref{equation-diagram}).
By the properties of the diagram (and
Schemes, Lemma \ref{schemes-lemma-points-fibre-product})
there exists a point $\xi$ of $R \times_{s, U, t} R$
with $\text{pr}_0(\xi) = r$ and $c(\xi) = r'$.
Let $\tilde r = \text{pr}_1(\xi) \in R$.

\medskip\noindent
Proof of (1). Set $k = \kappa(\tilde r)$. Since $t(\tilde r) = u$
and $s(\tilde r) = u'$ we see that $k$ is a common extension
of both $\kappa(u)$ and $\kappa(u')$ and in fact that
both $(F_u)_k$ and $(F_{u'})_k$ are isomorphic to the fibre of
$\text{pr}_1 : R \times_{s, U, t} R \to R$ over $\tilde r$.
Hence (1) is proved.

\medskip\noindent
Part (2) follows since the point $\xi$ maps to $r$, resp.\ $r'$.

\medskip\noindent
Part (3) is clear from the above (using the point $\xi$ for
$\tilde u$ and $\tilde u'$) and the definitions.

\medskip\noindent
If $s$ and $t$ are flat and of finite presentation, then
they are open morphisms (Morphisms, Lemma \ref{morphisms-lemma-fppf-open}).
Hence the image of some affine open neighbourhood $V''$ of $\tilde r$ will
cover an open neighbourhood $V$ of $u$, resp.\ $V'$ of $u'$.
These can be used to show that properties (1) and (2) of the
definition of ``locally on the base isomorphic in the
$\tau$-topology''.
\end{proof}







\section{Cohen-Macaulay presentations}
\label{section-CM}

\noindent
Given any groupoid $(U, R, s, t, c)$ with $s, t$ flat and
locally of finite presentation there exists an ``equivalent''
groupoid $(U', R', s', t', c')$ such that $s'$ and $t'$ are
Cohen-Macaulay morphisms (and locally of finite presentation). See
More on Morphisms, Section \ref{more-morphisms-section-CM}
for more information on Cohen-Macaulay morphisms.
Here ``equivalent'' can be taken to mean that the quotient stacks
$[U/R]$ and $[U'/R']$ are equivalent stacks, see
Groupoids in Spaces, Section \ref{spaces-groupoids-section-stacks}
and Section \ref{spaces-groupoids-section-quotient-stack-restrict}.

\begin{lemma}
\label{lemma-make-CM}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Assume $s$ and $t$ are flat and locally of finite presentation.
Then there exists an open $U' \subset U$ such that
\begin{enumerate}
\item $t^{-1}(U') \subset R$ is the largest open subscheme of
$R$ on which the morphism $s$ is Cohen-Macaulay,
\item $s^{-1}(U') \subset R$ is the largest open subscheme of
$R$ on which the morphism $t$ is Cohen-Macaulay,
\item the morphism $t|_{s^{-1}(U')} : s^{-1}(U') \to U$ is
surjective,
\item the morphism $s|_{t^{-1}(U')} : t^{-1}(U') \to U$ is
surjective, and
\item the restriction $R' = s^{-1}(U') \cap t^{-1}(U')$
of $R$ to $U'$ defines a groupoid $(U', R', s', t', c')$ which has the property
that the morphisms $s'$ and $t'$ are Cohen-Macaulay and locally of
finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Apply
Lemma \ref{lemma-local-source}
with
$g = \text{id}$ and
$\mathcal{Q} =$``locally of finite presentation'',
$\mathcal{R} =$``flat and locally of finite presentation'', and
$\mathcal{P}=$``Cohen-Macaulay'', see
Remark \ref{remark-local-source-apply}.
This gives us an open $U' \subset U$ such that
Let $t^{-1}(U') \subset R$ is the largest open subscheme of $R$
on which the morphism $s$ is Cohen-Macaulay.
This proves (1).
Let $i : R \to R$ be the inverse of the groupoid.
Since $i$ is an isomorphism, and $s \circ i = t$ and $t \circ i = s$
we see that $s^{-1}(U')$ is also the largest open of $R$ on which $t$ is
Cohen-Macaulay. This proves (2).
By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-flat-finite-presentation-CM-open}
the open subset $t^{-1}(U')$ is dense in every fibre of $s : R \to U$.
This proves (3). Same argument for (4).
Part (5) is a formal consequence of (1) and (2) and the discussion
of restrictions in
Groupoids, Section \ref{groupoids-section-restrict-groupoid}.
\end{proof}








\section{Restricting groupoids}
\label{section-restricting-groupoids}

\noindent
In this section we collect a bunch of lemmas on
properties of groupoids which are inherited by restrictions.
Most of these lemmas can be proved by contemplating the
defining diagram
\begin{equation}
\label{equation-restriction}
\vcenter{
\xymatrix{
R' \ar[d] \ar[r] \ar@/_3pc/[dd]_{t'} \ar@/^1pc/[rr]^{s'}&
R \times_{s, U} U' \ar[r] \ar[d] &
U' \ar[d]^g \\
U' \times_{U, t} R \ar[d] \ar[r] &
R \ar[r]^s \ar[d]_t &
U \\
U' \ar[r]^g &
U
}
}
\end{equation}
of a restriction. See
Groupoids, Lemma \ref{groupoids-lemma-restrict-groupoid}.

\begin{lemma}
\label{lemma-restrict-preserves-type}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ be a morphism of schemes.
Let $(U', R', s', t', c')$ be the restriction of
$(U, R, s, t, c)$ via $g$.
\begin{enumerate}
\item If $s, t$ are locally of finite type and $g$ is locally of finite
type, then $s', t'$ are locally of finite type.
\item If $s, t$ are locally of finite presentation and $g$ is locally of finite
presentation, then $s', t'$ are locally of finite presentation.
\item If $s, t$ are flat and $g$ is flat, then $s', t'$ are flat.
\item Add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
The property of being locally of finite type is stable under composition
and arbitrary base change, see
Morphisms, Lemmas \ref{morphisms-lemma-composition-finite-type} and
\ref{morphisms-lemma-base-change-finite-type}.
Hence (1) is clear from Diagram (\ref{equation-restriction}).
For the other cases, see
Morphisms, Lemmas \ref{morphisms-lemma-composition-finite-presentation},
\ref{morphisms-lemma-base-change-finite-presentation},
\ref{morphisms-lemma-composition-flat}, and
\ref{morphisms-lemma-base-change-flat}.
\end{proof}

\noindent
The following lemma could have been used to prove the results of the preceding
lemma in a more uniform way.

\begin{lemma}
\label{lemma-restrict-property}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ be a morphism of schemes.
Let $(U', R', s', t', c')$ be the restriction of
$(U, R, s, t, c)$ via $g$, and let
$h = s \circ \text{pr}_1 : U' \times_{g, U, t} R \to U$. If
$\mathcal{P}$ is a property of morphisms of schemes such that
\begin{enumerate}
\item $h$ has property $\mathcal{P}$, and
\item $\mathcal{P}$ is preserved under base change,
\end{enumerate}
then $s', t'$ have property $\mathcal{P}$.
\end{lemma}

\begin{proof}
This is clear as $s'$ is the base change of $h$ by
Diagram (\ref{equation-restriction})
and $t'$ is isomorphic to $s'$ as a morphism of schemes.
\end{proof}

\begin{lemma}
\label{lemma-double-restrict}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ and $g' : U'' \to U'$ be morphisms of schemes.
Set $g'' = g \circ g'$.
Let $(U', R', s', t', c')$ be the restriction of $R$ to $U'$.
Let $h = s \circ \text{pr}_1 : U' \times_{g, U, t} R \to U$,
let $h' = s' \circ \text{pr}_1 : U'' \times_{g', U', t} R \to U'$, and
let $h'' = s \circ \text{pr}_1 : U'' \times_{g'', U, t} R \to U$.
The following diagram is commutative
$$
\xymatrix{
U'' \times_{g', U', t} R' \ar[d]^{h'} &
(U' \times_{g, U, t} R) \times_U (U'' \times_{g'', U, t} R)
\ar[l] \ar[r] \ar[d] &
U'' \times_{g'', U, t} R \ar[d]_{h''} \\
U' &
U' \times_{g, U, t} R \ar[l]_{\text{pr}_0} \ar[r]^h &
U
}
$$
with both squares cartesian where the left upper horizontal arrow
is given by the rule
$$
\begin{matrix}
(U' \times_{g, U, t} R) \times_U (U'' \times_{g'', U, t} R) &
\longrightarrow &
U'' \times_{g', U', t} R' \\
((u', r_0), (u'', r_1)) &
\longmapsto &
(u'', (c(r_1, i(r_0)), (g'(u''), u')))
\end{matrix}
$$
with notation as explained in the proof.
\end{lemma}

\begin{proof}
We work this out by exploiting the functorial point of view
and reducing the lemma to a statement on arrows in restrictions
of a groupoid category. In the last formula of the lemma the
notation $((u', r_0), (u'', r_1))$ indicates a $T$-valued point of
$(U' \times_{g, U, t} R) \times_U (U'' \times_{g'', U, t} R)$.
This means that $u', u'', r_0, r_1$ are $T$-valued points of $U', U'', R, R$
and that $g(u') = t(r_0)$, $g(g'(u'')) = g''(u'') = t(r_1)$, and
$s(r_0) = s(r_1)$. It would be more correct here to write
$g \circ u' = t \circ r_0$ and so on but this makes the notation
even more unreadable. If we think of $r_1$ and $r_0$ as arrows in
a groupoid category then we can represent this by the picture
$$
\xymatrix{
t(r_0) = g(u') &
s(r_0) = s(r_1) \ar[l]_{r_0} \ar[r]^-{r_1} &
t(r_1) = g(g'(u''))
}
$$
This diagram in particular demonstrates that the composition
$c(r_1, i(r_0))$ makes sense. Recall that
$$
R' = R \times_{(t, s), U \times_S U, g \times g} U' \times_S U'
$$
hence a $T$-valued point of $R'$ looks like $(r, (u'_0, u'_1))$
with $t(r) = g(u'_0)$ and $s(r) = g(u'_1)$. In particular given
$((u', r_0), (u'', r_1))$ as above we get the $T$-valued point
$(c(r_1, i(r_0)), (g'(u''), u'))$ of $R'$ because we have
$t(c(r_1, i(r_0))) = t(r_1) = g(g'(u''))$ and
$s(c(r_1, i(r_0))) = s(i(r_0)) = t(r_0) = g(u')$.
We leave it to the reader to show that the left square commutes
with this definition.

\medskip\noindent
To show that the left square is cartesian,
suppose we are given $(v'', p')$ and $(v', p)$ which are $T$-valued points of
$U'' \times_{g', U', t} R'$ and $U' \times_{g, U, t} R$ with
$v' = s'(p')$. This also means that $g'(v'') = t'(p')$ and
$g(v') = t(p)$. By the discussion above we know that we can write
$p' = (r, (u_0', u_1'))$ with $t(r) = g(u'_0)$ and
$s(r) = g(u'_1)$. Using this notation we see that
$v' = s'(p') = u_1'$ and
$g'(v'') = t'(p') = u_0'$. Here is a picture
$$
\xymatrix{
s(p) \ar[r]^-p &
g(v') = g(u'_1) \ar[r]^-r &
g(u'_0) = g(g'(v''))
}
$$
What we have to show is that there exists a unique $T$-valued point
$((u', r_0), (u'', r_1))$ as above such that
$v' = u'$, $p = r_0$, $v'' = u''$ and $p' = (c(r_1, i(r_0)), (g'(u''), u'))$.
Comparing the two diagrams above it is clear that we have no choice
but to take
$$
((u', r_0), (u'', r_1)) = ((v', p), (v'', c(r, p))
$$
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-double-restrict-property}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ and $g' : U'' \to U'$ be morphisms of schemes.
Set $g'' = g \circ g'$.
Let $(U', R', s', t', c')$ be the restriction of $R$ to $U'$.
Let $h = s \circ \text{pr}_1 : U' \times_{g, U, t} R \to U$,
let $h' = s' \circ \text{pr}_1 : U'' \times_{g', U', t} R \to U'$, and
let $h'' = s \circ \text{pr}_1 : U'' \times_{g'', U, t} R \to U$.
Let $\tau \in \{Zariski, \linebreak[0] \etale, \linebreak[0]
smooth, \linebreak[0] syntomic, \linebreak[0] fppf, \linebreak[0] fpqc\}$. Let
$\mathcal{P}$ be a property of morphisms of schemes
which is preserved under base change, and which
is local on the target for the $\tau$-topology. If
\begin{enumerate}
\item $h(U' \times_U R)$ is open in $U$,
\item $\{h : U' \times_U R \to h(U' \times_U R)\}$ is a $\tau$-covering,
\item $h'$ has property $\mathcal{P}$,
\end{enumerate}
then $h''$ has property $\mathcal{P}$. Conversely, if
\begin{enumerate}
\item[(a)] $\{t : R \to U\}$ is a $\tau$-covering,
\item[(d)] $h''$ has property $\mathcal{P}$,
\end{enumerate}
then $h'$ has property $\mathcal{P}$.
\end{lemma}

\begin{proof}
This follows formally from the properties of the diagram of
Lemma \ref{lemma-double-restrict}.
In the first case, note that the image of the morphism
$h''$ is contained in the image of $h$, as $g'' = g \circ g'$.
Hence we may replace the $U$ in the lower right corner of the
diagram by $h(U' \times_U R)$. This explains the significance of
conditions (1) and (2) in the lemma. In the second case, note that
$\{\text{pr}_0 : U' \times_{g, U, t} R \to U'\}$ is a $\tau$-covering
as a base change of $\tau$ and condition (a).
\end{proof}






\section{Properties of groupoids on fields}
\label{section-properties-groupoids-on-fields}

\noindent
A ``groupoid on a field'' indicates a groupoid scheme $(U, R, s, t, c)$
where $U$ is the spectrum of a field. It does {\bf not} mean that
$(U, R, s, t, c)$ is defined over a field, more precisely, it does
{\bf not} mean that the morphisms $s, t : R \to U$ are equal.
Given any field $k$, an abstract group $G$ and a group homomorphism
$\varphi : G \to \text{Aut}(k)$ we obtain a groupoid scheme
$(U, R, s, t, c)$ over $\mathbf{Z}$ by setting
\begin{align*}
U & = \Spec(k) \\
R & = \coprod\nolimits_{g \in G} \Spec(k) \\
s & = \coprod\nolimits_{g \in G} \Spec(\text{id}_k) \\
t & = \coprod\nolimits_{g \in G} \Spec(\varphi(g)) \\
c & = \text{composition in }G
\end{align*}
This example still is a groupoid scheme over $\Spec(k^G)$.
Hence, if $G$ is finite, then $U = \Spec(k)$ is finite over
$\Spec(k^G)$.
In some sense our goal in this section is to show that suitable
finiteness conditions on $s, t$ force any groupoid on a field
to be defined over a finite index subfield $k' \subset k$.

\medskip\noindent
If $k$ is a field and $(G, m)$ is a group scheme over $k$ with structure
morphism $p : G \to \Spec(k)$, then $(\Spec(k), G, p, p, m)$
is an example of a groupoid on a field (and in this case of course the whole
structure is defined over a field). Hence this section can be viewed as the
analogue of
Groupoids, Section \ref{groupoids-section-properties-group-schemes-field}.

\begin{lemma}
\label{lemma-groupoid-on-field-open-multiplication}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. If $U$ is the spectrum of a field, then the composition
morphism $c : R \times_{s, U, t} R \to R$ is open.
\end{lemma}

\begin{proof}
The composition is isomorphic to the projection map
$\text{pr}_1 : R \times_{t, U, t} R \to R$ by
Diagram (\ref{equation-pull}).
The projection is open by
Morphisms, Lemma \ref{morphisms-lemma-scheme-over-field-universally-open}.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-separated}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. If $U$ is the spectrum of a field,
then $R$ is a separated scheme.
\end{lemma}

\begin{proof}
By
Groupoids, Lemma \ref{groupoids-lemma-group-scheme-over-field-separated}
the stabilizer group scheme $G \to U$ is separated. By
Groupoids, Lemma \ref{groupoids-lemma-diagonal}
the morphism $j = (t, s) : R \to U \times_S U$ is separated.
As $U$ is the spectrum of a field the scheme
$U \times_S U$ is affine (by the construction of fibre products in
Schemes, Section \ref{schemes-section-fibre-products}).
Hence $R$ is a separated scheme, see
Schemes, Lemma \ref{schemes-lemma-separated-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-homogeneous}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U = \Spec(k)$ with $k$ a field.
For any points $r, r' \in R$ there exists a field extension
$k \subset k'$ and points
$r_1, r_2 \in R \times_{s, \Spec(k)} \Spec(k')$
and a diagram
$$
\xymatrix{
R &
R \times_{s, \Spec(k)} \Spec(k')
\ar[l]_-{\text{pr}_0} \ar[r]^\varphi &
R \times_{s, \Spec(k)} \Spec(k')
\ar[r]^-{\text{pr}_0} &
R
}
$$
such that $\varphi$ is an isomorphism of schemes over $\Spec(k')$,
we have $\varphi(r_1) = r_2$, $\text{pr}_0(r_1) = r$, and
$\text{pr}_0(r_2) = r'$.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-two-fibres}
parts (1) and (2).
\end{proof}

\begin{lemma}
\label{lemma-restrict-groupoid-on-field}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U = \Spec(k)$ with $k$ a field.
Let $k \subset k'$ be a field extension, $U' = \Spec(k')$
and let $(U', R', s', t', c')$ be the restriction of
$(U, R, s, t, c)$ via $U' \to U$. In the defining diagram
$$
\xymatrix{
R' \ar[d] \ar[r] \ar@/_3pc/[dd]_{t'} \ar@/^1pc/[rr]^{s'} \ar@{..>}[rd] &
R \times_{s, U} U' \ar[r] \ar[d] &
U' \ar[d] \\
U' \times_{U, t} R \ar[d] \ar[r] &
R \ar[r]^s \ar[d]_t &
U \\
U' \ar[r] &
U
}
$$
all the morphisms are surjective, flat, and universally open.
The dotted arrow $R' \to R$ is in addition affine.
\end{lemma}

\begin{proof}
The morphism $U' \to U$ equals $\Spec(k') \to \Spec(k)$,
hence is affine, surjective and flat. The morphisms $s, t : R \to U$
and the morphism $U' \to U$ are universally open by
Morphisms, Lemma \ref{morphisms-lemma-scheme-over-field-universally-open}.
Since $R$ is not empty and $U$ is the spectrum of a field the morphisms
$s, t : R \to U$ are surjective and flat. Then you conclude by using
Morphisms, Lemmas \ref{morphisms-lemma-base-change-surjective},
\ref{morphisms-lemma-composition-surjective},
\ref{morphisms-lemma-composition-open},
\ref{morphisms-lemma-base-change-affine},
\ref{morphisms-lemma-composition-affine},
\ref{morphisms-lemma-base-change-flat}, and
\ref{morphisms-lemma-composition-flat}.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-explain-points}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U = \Spec(k)$ with $k$ a field.
For any point $r \in R$ there exist
\begin{enumerate}
\item a field extension $k \subset k'$ with $k'$ algebraically closed,
\item a point $r' \in R'$ where $(U', R', s', t', c')$ is the
restriction of $(U, R, s, t, c)$ via $\Spec(k') \to \Spec(k)$
\end{enumerate}
such that
\begin{enumerate}
\item the point $r'$ maps to $r$ under the morphism $R' \to R$, and
\item the maps $s', t' : R' \to \Spec(k')$ induce isomorphisms
$k' \to \kappa(r')$.
\end{enumerate}
\end{lemma}

\begin{proof}
Translating the geometric statement into a statement on fields,
this means that we can find a diagram
$$
\xymatrix{
k' & k' \ar[l]^1 & \\
k' \ar[u]^\tau & \kappa(r) \ar[lu]^\sigma & k \ar[l]^-s \ar[lu]_i \\
& k \ar[lu]^i \ar[u]_t
}
$$
where $i : k \to k'$ is the embedding of $k$ into $k'$,
the maps $s, t : k \to \kappa(r)$ are induced by $s, t : R \to U$, and
the map $\tau : k' \to k'$ is an automorphism. To produce such
a diagram we may proceed in the following way:
\begin{enumerate}
\item Pick $i : k \to k'$ a field map with $k'$ algebraically closed of
very large transcendence degree over $k$.
\item Pick an embedding $\sigma : \kappa(r) \to k'$ such that
$\sigma \circ s = i$. Such a $\sigma$ exists because we can just
choose a transcendence basis $\{x_\alpha\}_{\alpha \in A}$ of $\kappa(r)$
over $k$ and find $y_\alpha \in k'$, $\alpha \in A$ which are algebraically
independent over $i(k)$, and map $s(k)(\{x_\alpha\})$ into $k'$ by
the rules $s(\lambda) \mapsto i(\lambda)$ for $\lambda \in k$
and $x_\alpha \mapsto y_\alpha$ for $\alpha \in A$.
Then extend to $\tau : \kappa(\alpha) \to k'$ using that $k'$ is
algebraically closed.
\item Pick an automorphism $\tau : k' \to k'$ such that
$\tau \circ i = \sigma \circ t$. To do this pick a transcendence
basis $\{x_\alpha\}_{\alpha \in A}$ of $k$ over its prime field.
On the one hand, extend $\{i(x_\alpha)\}$ to a transcendence basis of
$k'$ by adding $\{y_\beta\}_{\beta \in B}$ and extend
$\{\sigma(t(x_\alpha))\}$ to a transcendence basis of $k'$ by adding
$\{z_\gamma\}_{\gamma \in C}$.
As $k'$ is algebraically closed we can extend the isomorphism
$\sigma \circ t \circ i^{-1} : i(k) \to \sigma(t(k))$
to an isomorphism $\tau' : \overline{i(k)} \to \overline{\sigma(t(k))}$
of their algebraic closures in $k'$.
As $k'$ has large transcendence degree
we see that the sets $B$ and $C$ have the same cardinality.
Thus we can use a bijection
$B \to C$ to extend $\tau'$ to an isomorphism
$$
\overline{i(k)}(\{y_\beta\})
\longrightarrow
\overline{\sigma(t(k))}(\{z_\gamma\})
$$
and then since $k'$ is the algebraic closure of both sides we
see that this extends to an automorphism $\tau : k' \to k'$
as desired.
\end{enumerate}
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-move-point}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U = \Spec(k)$ with $k$ a field.
If $r \in R$ is a point such that $s, t$ induce
isomorphisms $k \to \kappa(r)$, then the map
$$
R \longrightarrow R, \quad
x \longmapsto c(r, x)
$$
(see proof for precise notation) is an automorphism $R \to R$
which maps $e$ to $r$.
\end{lemma}

\begin{proof}
This is completely obvious if you think about groupoids in a
functorial way. But we will also spell it out completely.
Denote $a : U \to R$ the morphism with image $r$ such that
$s \circ a = \text{id}_U$ which exists by the hypothesis
that $s : k \to \kappa(r)$ is an isomorphism. Similarly, denote
$b : U \to R$ the morphism with image $r$ such that
$t \circ b = \text{id}_U$. Note that
$b = a \circ (t \circ a)^{-1}$, in particular
$a \circ s \circ b = b$.

\medskip\noindent
Consider the morphism $\Psi : R \to R$ given on $T$-valued points
by
$$
(f : T \to R) \longmapsto (c(a \circ t \circ f, f) : T \to R)
$$
To see this is defined we have to check that
$s \circ a \circ t \circ f = t \circ f$ which is obvious as $s \circ a = 1$.
Note that $\Phi(e) = a$, so that in order to prove the lemma it
suffices to show that $\Phi$ is an automorphism of $R$.
Let $\Phi : R \to R$ be the morphism given on $T$-valued points by
$$
(g : T \to R) \longmapsto (c(i \circ b \circ t \circ g, g) : T \to R).
$$
This is defined because
$s \circ i \circ b \circ t \circ g = t \circ b \circ t \circ g =
t \circ g$. We claim that $\Phi$ and $\Psi$ are inverse to
each other. To see this we compute
\begin{align*}
& c(a \circ t \circ c(i \circ b \circ t \circ g, g),
c(i \circ b \circ t \circ g, g)) \\
& =
c(a \circ t \circ i \circ b \circ t \circ g,
c(i \circ b \circ t \circ g, g)) \\
& =
c(a \circ s \circ b \circ t \circ g,
c(i \circ b \circ t \circ g, g)) \\
& =
c(b \circ t \circ g, c(i \circ b \circ t \circ g, g)) \\
& =
c(c(b \circ t \circ g, i \circ b \circ t \circ g), g)) \\
& =
c(e, g) \\
& = g
\end{align*}
where we have used the relation $a \circ s \circ b = b$ shown above.
In the other direction we have
\begin{align*}
& c(i \circ b \circ t \circ c(a \circ t \circ f, f), c(a \circ t \circ f, f)) \\
& =
c(i \circ b \circ t \circ a \circ t \circ f, c(a \circ t \circ f, f)) \\
& =
c(i \circ a \circ (t \circ a)^{-1} \circ t \circ a \circ t \circ f,
c(a \circ t \circ f, f)) \\
& =
c(i \circ a \circ t \circ f, c(a \circ t \circ f, f)) \\
& =
c(c(i \circ a \circ t \circ f, a \circ t \circ f), f) \\
& =
c(e, f) \\
& = f
\end{align*}
The lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-translate-open}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. If $U$ is the spectrum of a field, $W \subset R$ is open,
and $Z \to R$ is a morphism of schemes, then the image of the
composition $Z \times_{s, U, t} W \to R \times_{s, U, t} R \to R$ is open.
\end{lemma}

\begin{proof}
Write $U = \Spec(k)$. Consider a field extension $k \subset k'$. Denote
$U' = \Spec(k')$. Let $R'$ be the restriction of $R$ via $U' \to U$.
Set $Z' = Z \times_R R'$ and $W' = R' \times_R W$.
Consider a point $\xi = (z, w)$ of $Z \times_{s, U, t} W$.
Let $r \in R$ be the image of $z$ under $Z \to R$.
Pick $k' \supset k$ and $r' \in R'$ as in
Lemma \ref{lemma-groupoid-on-field-explain-points}.
We can choose $z' \in Z'$ mapping to $z$ and $r'$.
Then we can find $\xi' \in Z' \times_{s', U', t'} W'$
mapping to $z'$ and $\xi$. The open $c(r', W')$
(Lemma \ref{lemma-groupoid-on-field-move-point}) is
contained in the image of $Z' \times_{s', U', t'} W' \to R'$.
Observe that $Z' \times_{s', U', t'} W' = (Z \times_{s, U, t} W)
\times_{R \times_{s, U, t} R} (R' \times_{s', U', t'} R')$.
Hence the image of $Z' \times_{s', U', t'} W' \to R' \to R$
is contained in the image of $Z \times_{s, U, t} W \to R$.
As $R' \to R$ is open (Lemma \ref{lemma-restrict-groupoid-on-field})
we conclude the image contains an open neighbourhood of
the image of $\xi$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-geometrically-irreducible}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U = \Spec(k)$ with $k$ a field.
By abuse of notation denote $e \in R$ the image of the identity
morphism $e : U \to R$. Then
\begin{enumerate}
\item every local ring $\mathcal{O}_{R, r}$ of $R$ has a unique
minimal prime ideal,
\item there is exactly one irreducible component $Z$ of $R$
passing through $e$, and
\item $Z$ is geometrically irreducible over $k$ via either
$s$ or $t$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $r \in R$ be a point.
In this proof we will use the correspondence between irreducible components
of $R$ passing through a point $r$ and minimal primes of the local
ring $\mathcal{O}_{R, r}$ without further mention.
Choose $k \subset k'$ and $r' \in R'$ as in
Lemma \ref{lemma-groupoid-on-field-explain-points}.
Note that $\mathcal{O}_{R, r} \to \mathcal{O}_{R', r'}$
is faithfully flat and local, see
Lemma \ref{lemma-restrict-groupoid-on-field}.
Hence the result for $r' \in R'$ implies the result for $r \in R$.
In other words we may assume that $s, t : k \to \kappa(r)$
are isomorphisms. By
Lemma \ref{lemma-groupoid-on-field-move-point}
there exists an automorphism moving $e$ to $r$.
Hence we may assume $r = e$, i.e., part (1) follows from part (2).

\medskip\noindent
We first prove (2) in case $k$ is separably algebraically closed.
Namely, let $X, Y \subset R$ be irreducible components
passing through $e$. Then by
Varieties, Lemma \ref{varieties-lemma-bijection-irreducible-components} and
\ref{varieties-lemma-separably-closed-irreducible}
the scheme $X \times_{s, U, t} Y$ is irreducible as well.
Hence $c(X \times_{s, U, t} Y) \subset R$ is an irreducible subset.
We claim it contains both $X$ and $Y$ (as subsets of $R$).
Namely, let $T$ be the spectrum of a field. If $x : T \to X$ is a $T$-valued
point of $X$, then $c(x, e \circ s \circ x) = x$ and $e \circ s \circ x$
factors through $Y$ as $e \in Y$. Similarly for points of $Y$.
This clearly implies that $X = Y$, i.e., there is a unique irreducible
component of $R$ passing through $e$.

\medskip\noindent
Proof of (2) and (3) in general.
Let $k \subset k'$ be a separable algebraic closure, and
let $(U', R', s', t', c')$ be the restriction of
$(U, R, s, t, c)$ via $\Spec(k') \to \Spec(k)$.
By the previous paragraph there is exactly one irreducible
component $Z'$ of $R'$ passing through $e'$.
Denote $e'' \in R \times_{s, U} U'$ the base change of $e$.
As $R' \to R \times_{s, U} U'$ is faithfully flat, see
Lemma \ref{lemma-restrict-groupoid-on-field},
and $e' \mapsto e''$ we see that there is exactly one
irreducible component $Z''$ of $R \times_{s, k} k'$ passing
through $e''$. This implies, as $R \times_k k' \to R$ is faithfully
flat, that there is exactly one irreducible component $Z$ of $R$
passing through $e$. This proves (2).

\medskip\noindent
To prove (3) let $Z''' \subset R \times_k k'$ be an arbitrary
irreducible component of $Z \times_k k'$. By
Varieties, Lemma \ref{varieties-lemma-orbit-irreducible-components}
we see that $Z''' = \sigma(Z'')$ for some $\sigma \in \text{Gal}(k'/k)$.
Since $\sigma(e'') = e''$ we see that $e'' \in Z'''$ and hence
$Z''' = Z''$. This means that $Z$ is geometrically irreducible
over $\Spec(k)$ via the morphism $s$.
The same argument implies that $Z$ is geometrically irreducible
over $\Spec(k)$ via the morphism $t$.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-locally-finite-type-dimension}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U = \Spec(k)$ with $k$ a field.
Assume $s, t$ are locally of finite type.
Then
\begin{enumerate}
\item $R$ is equidimensional,
\item $\dim(R) = \dim_r(R)$ for all $r \in R$,
\item for any $r \in R$ we have
$\text{trdeg}_{s(k)}(\kappa(r)) = \text{trdeg}_{t(k)}(\kappa(r))$, and
\item for any closed point $r \in R$ we have
$\dim(R) = \dim(\mathcal{O}_{R, r})$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $r, r' \in R$.
Then $\dim_r(R) = \dim_{r'}(R)$ by
Lemma \ref{lemma-groupoid-on-field-homogeneous}
and
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}.
By
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
we have
$$
\dim_r(R) =
\dim(\mathcal{O}_{R, r}) + \text{trdeg}_{s(k)}(\kappa(r)) =
\dim(\mathcal{O}_{R, r}) + \text{trdeg}_{t(k)}(\kappa(r)).
$$
On the other hand, the dimension of $R$ (or any open subset of $R$)
is the supremum of the dimensions of the local rings of $R$, see
Properties, Lemma \ref{properties-lemma-codimension-local-ring}.
Clearly this is maximal for closed points $r$ in which case
$\text{trdeg}_k(\kappa(r)) = 0$ (by the Hilbert Nullstellensatz, see
Morphisms, Section \ref{morphisms-section-points-finite-type}).
Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-dimension-equal-stabilizer}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U = \Spec(k)$ with $k$ a field.
Assume $s, t$ are locally of finite type.
Then $\dim(R) = \dim(G)$ where $G$ is the stabilizer group scheme of $R$.
\end{lemma}

\begin{proof}
Let $Z \subset R$ be the irreducible component passing through $e$ (see
Lemma \ref{lemma-groupoid-on-field-geometrically-irreducible})
thought of as an integral closed subscheme of $R$.
Let $k'_s$, resp.\ $k'_t$ be the integral closure of
$s(k)$, resp.\ $t(k)$ in $\Gamma(Z, \mathcal{O}_Z)$.
Recall that $k'_s$ and $k'_t$ are fields, see
Varieties, Lemma \ref{varieties-lemma-integral-closure-ground-field}.
By
Varieties, Proposition \ref{varieties-proposition-unique-base-field}
we have $k'_s = k'_t$ as subrings of $\Gamma(Z, \mathcal{O}_Z)$.
As $e$ factors through $Z$ we obtain a commutative diagram
$$
\xymatrix{
k \ar[rd]_t \ar[rrd]^1 \\
& \Gamma(Z, \mathcal{O}_Z) \ar[r]^e & k \\
k \ar[ru]^s \ar[rru]_1
}
$$
This on the one hand shows that $k'_s = s(k)$, $k'_t = t(k)$, so
$s(k) = t(k)$, which combined with the diagram above implies
that $s = t$! In other words, we conclude that $Z$ is a closed
subscheme of $G = R \times_{(t, s), U \times_S U, \Delta} U$.
The lemma follows as both $G$ and $R$ are equidimensional, see
Lemma \ref{lemma-groupoid-on-field-locally-finite-type-dimension} and
Groupoids, Lemma \ref{groupoids-lemma-group-scheme-finite-type-field}.
\end{proof}

\begin{remark}
\label{remark-warn-dimension-groupoid-on-field}
Warning:
Lemma \ref{lemma-groupoid-on-field-dimension-equal-stabilizer}
is wrong without the condition that $s$ and $t$ are locally of
finite type.
An easy example is to start with the action
$$
\mathbf{G}_{m, \mathbf{Q}} \times_{\mathbf{Q}} \mathbf{A}^1_{\mathbf{Q}}
\to \mathbf{A}^1_{\mathbf{Q}}
$$
and restrict the corresponding groupoid scheme to the generic point of
$\mathbf{A}^1_{\mathbf{Q}}$. In other words restrict via the morphism
$\Spec(\mathbf{Q}(x)) \to
\Spec(\mathbf{Q}[x]) = \mathbf{A}^1_{\mathbf{Q}}$.
Then you get a groupoid scheme
$(U, R, s, t, c)$ with
$U = \Spec(\mathbf{Q}(x))$
and
$$
R = \Spec\left(
\mathbf{Q}(x)[y]\left[
\frac{1}{P(xy)}, P \in \mathbf{Q}[T], P \not = 0
\right]
\right)
$$
In this case $\dim(R) = 1$ and $\dim(G) = 0$.
\end{remark}

\begin{lemma}
\label{lemma-groupoid-characteristic-zero-smooth}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume
\begin{enumerate}
\item $U = \Spec(k)$ with $k$ a field,
\item $s, t$ are locally of finite type, and
\item the characteristic of $k$ is zero.
\end{enumerate}
Then $s, t : R \to U$ are smooth.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-sheaf-differentials}
the sheaf of differentials of $R \to U$ is free.
Hence smoothness follows from
Varieties, Lemma \ref{varieties-lemma-char-zero-differentials-free-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-reduced-group-scheme-perfect-field-characteristic-p-smooth}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume
\begin{enumerate}
\item $U = \Spec(k)$ with $k$ a field,
\item $s, t$ are locally of finite type,
\item $R$ is reduced, and
\item $k$ is perfect.
\end{enumerate}
Then $s, t : R \to U$ are smooth.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-sheaf-differentials}
the sheaf $\Omega_{R/U}$ is free. Hence the lemma follows from
Varieties, Lemma \ref{varieties-lemma-char-p-differentials-free-smooth}.
\end{proof}










\section{Morphisms of groupoids on fields}
\label{section-morphisms-groupoids-on-fields}

\noindent
This section studies morphisms between groupoids on fields.
This is slightly more general, but very akin to, studying
morphisms of groupschemes over a field.

\begin{situation}
\label{situation-morphism-groupoids-on-field}
Let $S$ be a scheme.
Let $U = \Spec(k)$ be a scheme over $S$ with $k$ a field.
Let $(U, R_1, s_1, t_1, c_1)$, $(U, R_2, s_2, t_2, c_2)$ be groupoid schemes
over $S$ with identical first component. Let $a : R_1 \to R_2$ be a morphism
such that $(\text{id}_U, a)$ defines a morphism of groupoid
schemes over $S$, see
Groupoids, Definition \ref{groupoids-definition-groupoid}.
In particular, the following diagrams commute
$$
\vcenter{
\xymatrix{
R_1 \ar[rrd]^{t_1} \ar[rdd]_{s_1} \ar[rd]_a \\
& R_2 \ar[d]^{t_2} \ar[r]_{s_2} & U \\
& U
}
}
\quad\quad
\vcenter{
\xymatrix{
R_1 \times_{s_1, U, t_1} R_1 \ar[r]_-{c_1} \ar[d]_{a \times a} &
R_1 \ar[d]^a \\
R_2 \times_{s_2, U, t_2} R_2 \ar[r]^-{c_2} &
R_2
}
}
$$
\end{situation}

\noindent
The following lemma is a generalization of
Groupoids, Lemma \ref{groupoids-lemma-open-subgroup-closed-over-field}.

\begin{lemma}
\label{lemma-open-image-is-closed}
Notation and assumptions as in
Situation \ref{situation-morphism-groupoids-on-field}.
If $a(R_1)$ is open in $R_2$, then $a(R_1)$ is closed in $R_2$.
\end{lemma}

\begin{proof}
Let $r_2 \in R_2$ be a point in the closure of $a(R_1)$.
We want to show $r_2 \in a(R_1)$. Pick $k \subset k'$ and
$r_2' \in R'_2$ adapted to $(U, R_2, s_2, t_2, c_2)$ and $r_2$ as in
Lemma \ref{lemma-groupoid-on-field-explain-points}.
Let $R_i'$ be the restriction of $R_i$ via the morphism
$U' = \Spec(k') \to U = \Spec(k)$.
Let $a' : R'_1 \to R_2'$ be the base change of $a$. The diagram
$$
\xymatrix{
R'_1 \ar[r]_{a'} \ar[d]_{p_1} & R'_2 \ar[d]^{p_2} \\
R_1 \ar[r]^a & R_2
}
$$
is a fibre square. Hence the image of $a'$ is the inverse image of
the image of $a$ via the morphism $p_2 : R'_2 \to R_2$. By
Lemma \ref{lemma-restrict-groupoid-on-field}
the map $p_2$ is surjective and open. Hence by
Topology, Lemma \ref{topology-lemma-open-morphism-quotient-topology}
we see that $r_2'$ is in the closure of $a'(R'_1)$.
This means that we may assume that $r_2 \in R_2$ has
the property that the maps $k \to \kappa(r_2)$ induced
by $s_2$ and $t_2$ are isomorphisms.

\medskip\noindent
In this case we can use
Lemma \ref{lemma-groupoid-on-field-move-point}.
This lemma implies $c(r_2, a(R_1))$ is an open neighbourhood of $r_2$.
Hence $a(R_1) \cap c(r_2, a(R_1)) \not = \emptyset$ as we assumed
that $r_2$ was a point of the closure of $a(R_1)$.
Using the inverse of $R_2$ and $R_1$ we see this means
$c_2(a(R_1), a(R_1))$ contains $r_2$.
As $c_2(a(R_1), a(R_1)) \subset a(c_1(R_1, R_1)) = a(R_1)$
we conclude $r_2 \in a(R_1)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-map-groupoids-on-field-image}
Notation and assumptions as in
Situation \ref{situation-morphism-groupoids-on-field}.
Let $Z \subset R_2$ be the reduced closed subscheme (see
Schemes, Definition \ref{schemes-definition-reduced-induced-scheme})
whose underlying topological space is the closure of the image of
$a : R_1 \to R_2$. Then
$c_2(Z \times_{s_2, U, t_2} Z) \subset Z$
set theoretically.
\end{lemma}

\begin{proof}
Consider the commutative diagram
$$
\xymatrix{
R_1 \times_{s_1, U, t_1} R_1 \ar[r] \ar[d] & R_1 \ar[d] \\
R_2 \times_{s_2, U, t_2} R_2 \ar[r] & R_2
}
$$
By
Varieties, Lemma \ref{varieties-lemma-closure-image-product-map}
the closure of the image of the left vertical arrow is (set theoretically)
$Z \times_{s_2, U, t_2} Z$.
Hence the result follows.
\end{proof}

\begin{lemma}
\label{lemma-map-groupoids-on-perfect-field-image}
Notation and assumptions as in
Situation \ref{situation-morphism-groupoids-on-field}.
Assume that $k$ is perfect.
Let $Z \subset R_2$ be the reduced closed subscheme (see
Schemes, Definition \ref{schemes-definition-reduced-induced-scheme})
whose underlying topological space is the closure of the image of
$a : R_1 \to R_2$. Then
$$
(U, Z, s_2|_Z, t_2|_Z, c_2|_Z)
$$
is a groupoid scheme over $S$.
\end{lemma}

\begin{proof}
We first explain why the statement makes sense. Since $U$ is the spectrum
of a perfect field $k$, the scheme $Z$ is geometrically reduced
over $k$ (via either projection), see
Varieties, Lemma \ref{varieties-lemma-perfect-reduced}.
Hence the scheme $Z \times_{s_2, U, t_2} Z \subset Z$
is reduced, see
Varieties, Lemma \ref{varieties-lemma-geometrically-reduced-any-base-change}.
Hence by
Lemma \ref{lemma-map-groupoids-on-field-image}
we see that $c$ induces a morphism
$Z \times_{s_2, U, t_2} Z \to Z$.
Finally, it is clear that $e_2$ factors through $Z$
and that the map $i_2 : R_2 \to R_2$ preserves $Z$. Since the morphisms
of the septuple
$(U, R_2, s_2, t_2, c_2, e_2, i_2)$
satisfies the axioms of a groupoid, it follows that after restricting
to $Z$ they satisfy the axioms.
\end{proof}

\begin{lemma}
\label{lemma-locally-closed-image-is-closed}
Notation and assumptions as in
Situation \ref{situation-morphism-groupoids-on-field}.
If the image $a(R_1)$ is a locally closed subset of $R_2$
then it is a closed subset.
\end{lemma}

\begin{proof}
Let $k \subset k'$ be a perfect closure of the field $k$.
Let $R_i'$ be the restriction of $R_i$ via the morphism
$U' = \Spec(k') \to \Spec(k)$. Note that the
morphisms $R_i' \to R_i$ are universal homeomorphisms as
compositions of base changes of the universal homeomorphism
$U' \to U$ (see diagram in statement of
Lemma \ref{lemma-restrict-groupoid-on-field}).
Hence it suffices to prove that $a'(R_1')$ is closed
in $R_2'$. In other words, we may assume that $k$ is perfect.

\medskip\noindent
If $k$ is perfect, then the closure of the image is
a groupoid scheme $Z \subset R_2$, by
Lemma \ref{lemma-map-groupoids-on-perfect-field-image}.
By the same lemma applied to
$\text{id}_{R_1} : R_1 \to R_1$
we see that $(R_2)_{red}$ is a groupoid scheme.
Thus we may apply
Lemma \ref{lemma-open-image-is-closed}
to the morphism
$a|_{(R_2)_{red}} : (R_2)_{red} \to Z$
to conclude that $Z$ equals the image of $a$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-map-groupoids-on-field-image}
Notation and assumptions as in
Situation \ref{situation-morphism-groupoids-on-field}.
Assume that $a : R_1 \to R_2$ is a quasi-compact morphism.
Let $Z \subset R_2$ be the scheme theoretic image (see
Morphisms, Definition \ref{morphisms-definition-scheme-theoretic-image})
of $a : R_1 \to R_2$. Then
$$
(U, Z, s_2|_Z, t_2|_Z, c_2|_Z)
$$
is a groupoid scheme over $S$.
\end{lemma}

\begin{proof}
The main difficulty is to show that $c_2|_{Z \times_{s_2, U, t_2} Z}$
maps into $Z$. Consider the commutative diagram
$$
\xymatrix{
R_1 \times_{s_1, U, t_1} R_1 \ar[r] \ar[d]^{a \times a} & R_1 \ar[d] \\
R_2 \times_{s_2, U, t_2} R_2 \ar[r] & R_2
}
$$
By
Varieties, Lemma \ref{varieties-lemma-scheme-theoretic-image-product-map}
we see that the scheme theoretic image of $a \times a$ is
$Z \times_{s_2, U, t_2} Z$. By the commutativity of the diagram we
conclude that $Z \times_{s_2, U, t_2} Z$ maps into $Z$ by the bottom
horizontal arrow. As in the proof of
Lemma \ref{lemma-map-groupoids-on-perfect-field-image}
it is also true that $i_2(Z) \subset Z$ and that
$e_2$ factors through $Z$. Hence we conclude as in the
proof of that lemma.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-field-image}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U$ is the spectrum of a field.
Let $Z \subset U \times_S U$ be the reduced closed subscheme (see
Schemes, Definition \ref{schemes-definition-reduced-induced-scheme})
whose underlying topological space is the closure of the image of
$j = (t, s) : R \to U \times_S U$. Then
$\text{pr}_{02}(Z \times_{\text{pr}_1, U, \text{pr}_0} Z) \subset Z$
set theoretically.
\end{lemma}

\begin{proof}
As $(U, U \times_S U, \text{pr}_1, \text{pr}_0, \text{pr}_{02})$
is a groupoid scheme over $S$ this is a special case of
Lemma \ref{lemma-map-groupoids-on-field-image}.
But we can also prove it directly as follows.

\medskip\noindent
Write $U = \Spec(k)$. Denote
$R_s$ (resp.\ $Z_s$, resp.\ $U^2_s$) the scheme
$R$ (resp.\ $Z$, resp.\ $U \times_S U$) viewed as a scheme over $k$ via
$s$ (resp.\ $\text{pr}_1|_Z$, resp.\ $\text{pr}_1$).
Similarly, denote
${}_tR$ (resp.\ ${}_tZ$, resp.\ ${}_tU^2$) the scheme
$R$ (resp.\ $Z$, resp.\ $U \times_S U$) viewed as a scheme over $k$ via
$t$ (resp.\ $\text{pr}_0|_Z$, resp.\ $\text{pr}_0$).
The morphism $j$ induces morphisms of schemes
$j_s : R_s \to U^2_s$ and ${}_tj : {}_tR \to {}_tU^2$ over $k$.
Consider the commutative diagram
$$
\xymatrix{
R_s \times_k {}_tR \ar[r]^c \ar[d]_{j_s \times {}_tj} &  R \ar[d]^j \\
U^2_s \times_k {}_tU^2 \ar[r] & U \times_S U
}
$$
By
Varieties, Lemma \ref{varieties-lemma-closure-image-product-map}
we see that the closure of the image of $j_s \times {}_tj$ is
$Z_s \times_k {}_tZ$. By the commutativity of the diagram we
conclude that $Z_s \times_k {}_tZ$ maps into $Z$ by the bottom
horizontal arrow.
\end{proof}

\begin{lemma}
\label{lemma-groupoid-on-perfect-field-image}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U$ is the spectrum of a perfect field.
Let $Z \subset U \times_S U$ be the reduced closed subscheme (see
Schemes, Definition \ref{schemes-definition-reduced-induced-scheme})
whose underlying topological space is the closure of the image of
$j = (t, s) : R \to U \times_S U$.
Then
$$
(U, Z, \text{pr}_0|_Z, \text{pr}_1|_Z,
\text{pr}_{02}|_{Z \times_{\text{pr}_1, U, \text{pr}_0} Z})
$$
is a groupoid scheme over $S$.
\end{lemma}

\begin{proof}
As $(U, U \times_S U, \text{pr}_1, \text{pr}_0, \text{pr}_{02})$
is a groupoid scheme over $S$ this is a special case of
Lemma \ref{lemma-map-groupoids-on-perfect-field-image}.
But we can also prove it directly as follows.

\medskip\noindent
We first explain why the statement makes sense. Since $U$ is the spectrum
of a perfect field $k$, the scheme $Z$ is geometrically reduced
over $k$ (via either projection), see
Varieties, Lemma \ref{varieties-lemma-perfect-reduced}.
Hence the scheme $Z \times_{\text{pr}_1, U, \text{pr}_0} Z \subset Z$
is reduced, see
Varieties, Lemma \ref{varieties-lemma-geometrically-reduced-any-base-change}.
Hence by
Lemma \ref{lemma-groupoid-on-field-image}
we see that $\text{pr}_{02}$ induces a morphism
$Z \times_{\text{pr}_1, U, \text{pr}_0} Z \to Z$.
Finally, it is clear that $\Delta_{U/S}$ factors through $Z$
and that the map
$\sigma : U \times_S U \to U \times_S U$, $(x, y) \mapsto (y, x)$
preserves $Z$. Since
$(U, U \times_S U, \text{pr}_0, \text{pr}_1, \text{pr}_{02},
\Delta_{U/S}, \sigma)$
satisfies the axioms of a groupoid, it follows that after restricting
to $Z$ they satisfy the axioms.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-groupoid-on-field-image}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme
over $S$. Assume $U$ is the spectrum of a field and
assume $R$ is quasi-compact (equivalently $s, t$ are quasi-compact).
Let $Z \subset U \times_S U$ be the scheme theoretic image (see
Morphisms, Definition \ref{morphisms-definition-scheme-theoretic-image})
of $j = (t, s) : R \to U \times_S U$.
Then
$$
(U, Z, \text{pr}_0|_Z, \text{pr}_1|_Z,
\text{pr}_{02}|_{Z \times_{\text{pr}_1, U, \text{pr}_0} Z})
$$
is a groupoid scheme over $S$.
\end{lemma}

\begin{proof}
As $(U, U \times_S U, \text{pr}_1, \text{pr}_0, \text{pr}_{02})$
is a groupoid scheme over $S$ this is a special case of
Lemma \ref{lemma-quasi-compact-map-groupoids-on-field-image}.
But we can also prove it directly as follows.

\medskip\noindent
The main difficulty is to show that
$\text{pr}_{02}|_{Z \times_{\text{pr}_1, U, \text{pr}_0} Z}$
maps into $Z$.
Write $U = \Spec(k)$. Denote
$R_s$ (resp.\ $Z_s$, resp.\ $U^2_s$) the scheme
$R$ (resp.\ $Z$, resp.\ $U \times_S U$) viewed as a scheme over $k$ via
$s$ (resp.\ $\text{pr}_1|_Z$, resp.\ $\text{pr}_1$).
Similarly, denote
${}_tR$ (resp.\ ${}_tZ$, resp.\ ${}_tU^2$) the scheme
$R$ (resp.\ $Z$, resp.\ $U \times_S U$) viewed as a scheme over $k$ via
$t$ (resp.\ $\text{pr}_0|_Z$, resp.\ $\text{pr}_0$).
The morphism $j$ induces morphisms of schemes
$j_s : R_s \to U^2_s$ and ${}_tj : {}_tR \to {}_tU^2$ over $k$.
Consider the commutative diagram
$$
\xymatrix{
R_s \times_k {}_tR \ar[r]^c \ar[d]_{j_s \times {}_tj} &  R \ar[d]^j \\
U^2_s \times_k {}_tU^2 \ar[r] & U \times_S U
}
$$
By
Varieties, Lemma \ref{varieties-lemma-scheme-theoretic-image-product-map}
we see that the scheme theoretic image of $j_s \times {}_tj$ is
$Z_s \times_k {}_tZ$. By the commutativity of the diagram we
conclude that $Z_s \times_k {}_tZ$ maps into $Z$ by the bottom
horizontal arrow. As in the proof of
Lemma \ref{lemma-groupoid-on-perfect-field-image}
it is also true that $\sigma(Z) \subset Z$ and that
$\Delta_{U/S}$ factors through $Z$. Hence we conclude as in the
proof of that lemma.
\end{proof}







\section{Slicing groupoids}
\label{section-slicing}

\noindent
The following lemma shows that we may slice a Cohen-Macaulay groupoid scheme
in order to reduce the dimension of the fibres, provided that the
dimension of the stabilizer is small. This is an essential step in
the process of improving a given presentation of a quotient stack.

\begin{situation}
\label{situation-slice}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ be a morphism of schemes.
Let $u \in U$ be a point, and let $u' \in U'$ be a point such that
$g(u') = u$. Given these data, denote $(U', R', s', t', c')$
the restriction of $(U, R, s, t, c)$ via the morphism $g$.
Denote $G \to U$ the stabilizer group scheme of $R$, which
is a locally closed subscheme of $R$.
Denote $h$ the composition
$$
h = s \circ \text{pr}_1 : U' \times_{g, U, t} R \longrightarrow U.
$$
Denote $F_u = s^{-1}(u)$ (scheme theoretic fibre), and $G_u$ the
scheme theoretic fibre of $G$ over $u$.
Similarly for $R'$ we denote $F'_{u'} = (s')^{-1}(u')$.
Because $g(u') = u$ we have
$$
F'_{u'} = h^{-1}(u) \times_{\Spec(\kappa(u))} \Spec(\kappa(u')).
$$
The point $e(u) \in R$ may be viewed as a point on $G_u$ and $F_u$ also, and
$e'(u')$ is a point of $R'$ (resp.\ $G'_{u'}$, resp.\ $F'_{u'}$) which maps
to $e(u)$ in $R$ (resp.\ $G_u$, resp.\ $F_u$).
\end{situation}

\begin{lemma}
\label{lemma-slice}
Let $S$ be a scheme.
Let $(U, R, s, t, c, e, i)$ be a groupoid scheme over $S$.
Let $G \to U$ be the stabilizer group scheme.
Assume $s$ and $t$ are Cohen-Macaulay and locally of finite presentation.
Let $u \in U$ be a finite type point of the scheme $U$, see
Morphisms, Definition \ref{morphisms-definition-finite-type-point}.
With notation as in
Situation \ref{situation-slice},
set
$$
d_1 = \dim(G_u), \quad
d_2 = \dim_{e(u)}(F_u).
$$
If $d_2 > d_1$, then there exist an affine scheme $U'$
and a morphism $g : U' \to U$ such that (with notation as in
Situation \ref{situation-slice})
\begin{enumerate}
\item $g$ is an immersion
\item $u \in U'$,
\item $g$ is locally of finite presentation,
\item the morphism $h : U' \times_{g, U, t} R \longrightarrow U$
is Cohen-Macaulay at $(u, e(u))$, and
\item we have $\dim_{e'(u)}(F'_u) = d_2 - 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\Spec(A) \subset U$ be an affine neighbourhood of $u$
such that $u$ corresponds to a closed point of $U$, see
Morphisms, Lemma \ref{morphisms-lemma-identify-finite-type-points}.
Let $\Spec(B) \subset R$ be an affine neighbourhood of $e(u)$
which maps via $j$ into the open
$\Spec(A) \times_S \Spec(A) \subset U \times_S U$.
Let $\mathfrak m \subset A$ be the maximal ideal corresponding to $u$.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $e(u)$.
Pictures:
$$
\vcenter{
\xymatrix{
B & A \ar[l]^s \\
A \ar[u]^t
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
B_{\mathfrak q} & A_{\mathfrak m} \ar[l]^s \\
A_{\mathfrak m} \ar[u]^t
}
}
$$
Note that the two induced maps
$s, t : \kappa(\mathfrak m) \to \kappa(\mathfrak q)$
are equal and isomorphisms as $s \circ e = t \circ e = \text{id}_U$.
In particular we see that $\mathfrak q$
is a maximal ideal as well. The ring maps $s, t : A \to B$ are
of finite presentation and flat. By assumption the ring
$$
\mathcal{O}_{F_u, e(u)} = B_{\mathfrak q}/s(\mathfrak m)B_{\mathfrak q}
$$
is Cohen-Macaulay of dimension $d_2$. The equality of dimension holds by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}.

\medskip\noindent
Let $R''$ be the restriction of $R$ to $u = \Spec(\kappa(u))$
via the morphism $\Spec(\kappa(u)) \to U$.
As $u \to U$ is locally of finite type,
we see that $(\Spec(\kappa(u)), R'', s'', t'', c'')$
is a groupoid scheme with $s'', t''$ locally of finite type, see
Lemma \ref{lemma-restrict-preserves-type}.
By
Lemma \ref{lemma-groupoid-on-field-dimension-equal-stabilizer}
this implies that $\dim(G'') = \dim(R'')$. We also have
$\dim(R'') = \dim_{e''}(R'') = \dim(\mathcal{O}_{R'', e''})$, see
Lemma \ref{lemma-groupoid-on-field-locally-finite-type-dimension}.
By
Groupoids, Lemma \ref{groupoids-lemma-restrict-stabilizer}
we have $G'' = G_u$. Hence we conclude that
$\dim(\mathcal{O}_{R'', e''}) = d_1$.

\medskip\noindent
As a scheme $R''$ is
$$
R'' =
R \times_{(U \times_S U)}
\Big(
\Spec(\kappa(\mathfrak m)) \times_S \Spec(\kappa(\mathfrak m))
\Big)
$$
Hence an affine open neighbourhood of $e''$ is the spectrum of the ring
$$
B \otimes_{(A \otimes A)} (\kappa(\mathfrak m) \otimes \kappa(\mathfrak m))
=
B/s(\mathfrak m)B + t(\mathfrak m)B
$$
We conclude that
$$
\mathcal{O}_{R'', e''} =
B_{\mathfrak q}/s(\mathfrak m)B_{\mathfrak q} + t(\mathfrak m)B_{\mathfrak q}
$$
and so now we know that this ring has dimension $d_1$.

\medskip\noindent
We claim this implies we can find
an element $f \in \mathfrak m$ such that
$$
\dim(B_{\mathfrak q}/(s(\mathfrak m)B_{\mathfrak q} + fB_{\mathfrak q}) < d_2
$$
Namely, suppose $\mathfrak n_j \supset s(\mathfrak m)B_{\mathfrak q}$,
$j = 1, \ldots, m$ correspond to the minimal primes of the local ring
$B_{\mathfrak q}/s(\mathfrak m)B_{\mathfrak q}$.
There are finitely many as this ring is Noetherian (since it is essentially
of finite type over a field -- but also because a Cohen-Macaulay ring is
Noetherian). By the Cohen-Macaulay condition we have
$\dim(B_{\mathfrak q}/\mathfrak n_j) = d_2$, for example by
Algebra, Lemma \ref{algebra-lemma-CM-dim-formula}.
Note that
$\dim(B_{\mathfrak q}/(\mathfrak n_j + t(\mathfrak m)B_{\mathfrak q}))
\leq d_1$
as it is a quotient of the ring
$\mathcal{O}_{R'', e''} =
B_{\mathfrak q}/s(\mathfrak m)B_{\mathfrak q} + t(\mathfrak m)B_{\mathfrak q}$
which has dimension $d_1$. As $d_1 < d_2$ this implies that
$\mathfrak m \not \subset t^{-1}(\mathfrak n_i)$.
By prime avoidance, see
Algebra, Lemma \ref{algebra-lemma-silly},
we can find $f \in \mathfrak m$ with $t(f) \not \in \mathfrak n_j$ for
$j = 1, \ldots, m$. For this choice of $f$ we have
the displayed inequality above, see
Algebra, Lemma \ref{algebra-lemma-one-equation}.

\medskip\noindent
Set $A' = A/fA$ and $U' = \Spec(A')$. Then it is clear that
$U' \to U$ is an immersion, locally of finite presentation
and that $u \in U'$. Thus (1), (2) and (3) of the lemma hold.
The morphism
$$
U' \times_{g, U, t} R \longrightarrow U
$$
factors through $\Spec(A)$ and corresponds to the ring map
$$
\xymatrix{
B/t(f)B \ar@{=}[r] & A/(f) \otimes_{A, t} B & A \ar[l]_-s
}
$$
Now, we see $t(f)$ is not a zerodivisor on
$B_{\mathfrak q}/s(\mathfrak m)B_{\mathfrak q}$ as this is a
Cohen-Macaulay ring of positive dimension and $f$ is not contained
in any minimal prime, see for example
Algebra, Lemma \ref{algebra-lemma-reformulate-CM}.
Hence by
Algebra, Lemma \ref{algebra-lemma-grothendieck-general}
we conclude that $s : A_{\mathfrak m} \to B_{\mathfrak q}/t(f)B_{\mathfrak q}$
is flat with fibre ring
$B_{\mathfrak q}/(s(\mathfrak m)B_{\mathfrak q} + t(f)B_{\mathfrak q})$
which is Cohen-Macaulay by
Algebra, Lemma \ref{algebra-lemma-reformulate-CM}
again. This implies part (4) of the lemma.
To see part (5) note that by Diagram (\ref{equation-restriction})
the fibre $F'_u$ is equal to the fibre of $h$ over $u$.
Hence
$\dim_{e'(u)}(F'_u) =
\dim(B_{\mathfrak q}/(s(\mathfrak m)B_{\mathfrak q} + t(f)B_{\mathfrak q}))$
by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
and the dimension of this ring is $d_2 - 1$ by
Algebra, Lemma \ref{algebra-lemma-reformulate-CM}
once more. This proves the final assertion of the lemma and we win.
\end{proof}

\noindent
Now that we know how to slice we can combine it with the preceding material
to get the following ``optimal'' result. It is optimal in the sense that
since $G_u$ is a locally closed subscheme of $F_u$ one always has the
inequality $\dim(G_u) = \dim_{e(u)}(G_u) \leq \dim_{e(u)}(F_u)$ so it
is not possible to slice more than in the lemma.

\begin{lemma}
\label{lemma-max-slice}
Let $S$ be a scheme.
Let $(U, R, s, t, c, e, i)$ be a groupoid scheme over $S$.
Let $G \to U$ be the stabilizer group scheme.
Assume $s$ and $t$ are Cohen-Macaulay and locally of finite presentation.
Let $u \in U$ be a finite type point of the scheme $U$, see
Morphisms, Definition \ref{morphisms-definition-finite-type-point}.
With notation as in
Situation \ref{situation-slice}
there exist an affine scheme $U'$ and a morphism $g : U' \to U$ such that
\begin{enumerate}
\item $g$ is an immersion,
\item $u \in U'$,
\item $g$ is locally of finite presentation,
\item the morphism $h : U' \times_{g, U, t} R \longrightarrow U$
is Cohen-Macaulay and locally of finite presentation,
\item the morphisms $s', t' : R' \to U'$ are Cohen-Macaulay and
locally of finite presentation, and
\item $\dim_{e(u)}(F'_u) = \dim(G'_u)$.
\end{enumerate}
\end{lemma}

\begin{proof}
As $s$ is locally of finite presentation the scheme $F_u$ is
locally of finite type over $\kappa(u)$. Hence
$\dim_{e(u)}(F_u) < \infty$ and we may argue by induction on
$\dim_{e(u)}(F_u)$.

\medskip\noindent
If $\dim_{e(u)}(F_u) = \dim(G_u)$ there is nothing to prove.
Assume $\dim_{e(u)}(F_u) > \dim(G_u)$. This means that
Lemma \ref{lemma-slice}
applies and we find a morphism $g : U' \to U$ which has
properties (1), (2), (3), instead of (6) we have
$\dim_{e(u)}(F'_u) < \dim_{e(u)}(F_u)$,
and instead of (4) and (5) we have that the composition
$$
h = s \circ \text{pr}_1 : U' \times_{g, U, t} R \longrightarrow U
$$
is Cohen-Macaulay at the point $(u, e(u))$. We apply
Remark \ref{remark-local-source-apply}
and we obtain an open subscheme $U'' \subset U'$ such that
$U'' \times_{g, U, t} R \subset U' \times_{g, U, t} R$
is the largest open subscheme on which $h$ is Cohen-Macaulay.
Since $(u, e(u)) \in U'' \times_{g, U, t} R$ we see that $u \in U''$.
Hence we may replace $U'$ by $U''$ and assume that in fact $h$ is
Cohen-Macaulay everywhere! By
Lemma \ref{lemma-restrict-property}
we conclude that $s', t'$ are locally of finite
presentation and Cohen-Macaulay (use
Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-presentation}
and
More on Morphisms, Lemma \ref{more-morphisms-lemma-base-change-CM}).

\medskip\noindent
By construction $\dim_{e'(u)}(F'_u) < \dim_{e(u)}(F_u)$,
so we may apply the induction hypothesis to $(U', R', s', t', c')$
and the point $u \in U'$. Note that $u$ is also a finite type point
of $U'$ (for example you can see this using the characterization of
finite type points from
Morphisms, Lemma \ref{morphisms-lemma-identify-finite-type-points}).
Let $g' : U'' \to U'$ and $(U'', R'', s'', t'', c'')$ be the solution
of the corresponding problem starting with $(U', R', s', t', c')$
and the point $u \in U'$. We claim that the composition
$$
g'' = g \circ g' : U'' \longrightarrow U
$$
is a solution for the original problem. Properties (1), (2), (3), (5),
and (6) are immediate. To see (4) note that the morphism
$$
h'' = s \circ \text{pr}_1 : U'' \times_{g'', U, t} R \longrightarrow U
$$
is locally of finite presentation and Cohen-Macaulay by an application of
Lemma \ref{lemma-double-restrict-property}
(use
More on Morphisms, Lemma \ref{more-morphisms-lemma-CM-local-source-and-target}
to see that Cohen-Macaulay morphisms are fppf local on the target).
\end{proof}

\noindent
In case the stabilizer group scheme has fibres of dimension 0
this leads to the following slicing lemma.

\begin{lemma}
\label{lemma-max-slice-quasi-finite}
Let $S$ be a scheme.
Let $(U, R, s, t, c, e, i)$ be a groupoid scheme over $S$.
Let $G \to U$ be the stabilizer group scheme.
Assume $s$ and $t$ are Cohen-Macaulay and locally of finite presentation.
Let $u \in U$ be a finite type point of the scheme $U$, see
Morphisms, Definition \ref{morphisms-definition-finite-type-point}.
Assume that $G \to U$ is locally quasi-finite.
With notation as in
Situation \ref{situation-slice}
there exist an affine scheme $U'$ and a morphism $g : U' \to U$ such that
\begin{enumerate}
\item $g$ is an immersion,
\item $u \in U'$,
\item $g$ is locally of finite presentation,
\item the morphism $h : U' \times_{g, U, t} R \longrightarrow U$
is flat, locally of finite presentation, and locally quasi-finite, and
\item the morphisms $s', t' : R' \to U'$ are flat,
locally of finite presentation, and locally quasi-finite.
\end{enumerate}
\end{lemma}

\begin{proof}
Take $g : U' \to U$ as in
Lemma \ref{lemma-max-slice}.
Since $h^{-1}(u) = F'_u$ we see that $h$ has relative dimension
$\leq 0$ at $(u, e(u))$. Hence, by
Remark \ref{remark-local-source-apply},
we obtain an open subscheme $U'' \subset U'$ such that
$u \in U''$ and $U'' \times_{g, U, t} R$ is the maximal open subscheme
of $U' \times_{g, U, t} R$ on which $h$ has relative dimension $\leq 0$.
After replacing $U'$ by $U''$ we see that $h$ has relative dimension $\leq 0$.
This implies that $h$ is locally quasi-finite by
Morphisms, Lemma \ref{morphisms-lemma-locally-quasi-finite-rel-dimension-0}.
Since it is still locally of finite presentation and Cohen-Macaulay we see
that it is flat, locally of finite presentation and locally quasi-finite,
i.e., (4) above holds. This implies that $s'$ is flat, locally of finite
presentation and locally quasi-finite as a base change of $h$, see
Lemma \ref{lemma-restrict-property}.
\end{proof}







\section{\'Etale localization of groupoids}
\label{section-etale-localize}

\noindent
In this section we begin applying the \'etale localization techniques of
More on Morphisms, Section \ref{more-morphisms-section-etale-localization}
to groupoid schemes. More advanced material of this kind can be found in
More on Groupoids in Spaces,
Section \ref{spaces-more-groupoids-section-etale-localize}.
Lemma \ref{lemma-quasi-finite-over-base-j-proper}
will be used to prove results on algebraic spaces
separated and quasi-finite over a scheme, namely
Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}
and its corollary
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite-separated-representable}.

\begin{lemma}
\label{lemma-quasi-finite-over-base}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $p \in S$ be a point, and let $u \in U$ be a point lying over $p$.
Assume that
\begin{enumerate}
\item $U \to S$ is locally of finite type,
\item $U \to S$ is quasi-finite at $u$,
\item $U \to S$ is separated,
\item $R \to S$ is separated,
\item $s$, $t$ are flat and locally of finite presentation, and
\item $s^{-1}(\{u\})$ is finite.
\end{enumerate}
Then there exists an \'etale neighbourhood $(S', p') \to (S, p)$ with
$\kappa(p) = \kappa(p')$ and a base change diagram
$$
\xymatrix{
R' \amalg W'
\ar@{=}[r] &
S' \times_S R
\ar[r] \ar@<2ex>[d]^{s'} \ar@<-2ex>[d]_{t'} &
R \ar@<1ex>[d]^s \ar@<-1ex>[d]_t \\
U' \amalg W
\ar@{=}[r] &
S' \times_S U
\ar[r] \ar[d] &
U \ar[d] \\
 &
S' \ar[r] &
S
}
$$
where the equal signs are decompositions into open and closed
subschemes such that
\begin{enumerate}
\item[(a)] there exists a point $u'$ of $U'$ mapping to $u$ in $U$,
\item[(b)] the fibre $(U')_{p'}$ equals $t'\big((s')^{-1}(\{u'\})\big)$
set theoretically,
\item[(c)] the fibre $(R')_{p'}$ equals $(s')^{-1}\big((U')_{p'}\big)$
set theoretically,
\item[(d)] the schemes $U'$ and $R'$ are finite over $S'$,
\item[(e)] we have $s'(R') \subset U'$ and $t'(R') \subset U'$,
\item[(f)] we have
$c'(R' \times_{s', U', t'} R') \subset R'$
where $c'$ is the base change of $c$, and
\item[(g)] the morphisms $s', t', c'$ determine a groupoid structure
by taking the system
$(U', R', s'|_{R'}, t'|_{R'}, c'|_{R' \times_{s', U', t'} R'})$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us denote $f : U \to S$ the structure morphism of $U$.
By assumption (6) we can write $s^{-1}(\{u\}) = \{r_1, \ldots, r_n\}$.
Since this set is finite, we see that $s$ is quasi-finite at each of
these finitely many inverse images, see
Morphisms, Lemma \ref{morphisms-lemma-finite-fibre}.
Hence we see that $f \circ s : R \to S$ is quasi-finite at each $r_i$
(Morphisms, Lemma \ref{morphisms-lemma-composition-quasi-finite}).
Hence $r_i$ is isolated in the fibre $R_p$, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-at-point-characterize}.
Write $t(\{r_1, \ldots, r_n\}) = \{u_1, \ldots, u_m\}$.
Note that it may happen that $m < n$ and note that
$u \in \{u_1, \ldots, u_m\}$.
Since $t$ is flat and locally of finite presentation,
the morphism of fibres $t_p : R_p \to U_p$ is flat and locally of
finite presentation (Morphisms,
Lemmas \ref{morphisms-lemma-base-change-flat} and
\ref{morphisms-lemma-base-change-finite-presentation}),
hence open (Morphisms,
Lemma \ref{morphisms-lemma-fppf-open}).
The fact that each $r_i$ is isolated in $R_p$ implies that
each $u_j = t(r_i)$ is isolated in $U_p$. Using
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-at-point-characterize}
again, we see that $f$ is quasi-finite at $u_1, \ldots, u_m$.

\medskip\noindent
Denote $F_u = s^{-1}(u)$ and $F_{u_j} = s^{-1}(u_j)$ the scheme theoretic
fibres. Note that $F_u$ is finite over $\kappa(u)$ as it is locally of finite
type over $\kappa(u)$ with finitely many points (for example it follows from
the much more general
Morphisms, Lemma
\ref{morphisms-lemma-locally-quasi-finite-qc-source-universally-bounded}).
By
Lemma \ref{lemma-two-fibres}
we see that $F_u$ and $F_{u_j}$ become isomorphic over a common
field extension of $\kappa(u)$ and $\kappa(u_j)$. Hence we see
that $F_{u_j}$ is finite over $\kappa(u_j)$. In particular we see
$s^{-1}(\{u_j\})$ is a finite set for each $j = 1, \ldots, m$.
Thus we see that assumptions (2) and (6) hold for each $u_j$ also
(above we saw that $U \to S$ is quasi-finite at $u_j$).
Hence the argument of the first paragraph applies to each $u_j$
and we see that $R \to U$ is quasi-finite at each of the points of
$$
\{r_1, \ldots, r_N\} = s^{-1}(\{u_1, \ldots, u_m\})
$$
Note that $t(\{r_1, \ldots, r_N\}) = \{u_1, \ldots, u_m\}$ and
$t^{-1}(\{u_1, \ldots, u_m\}) = \{r_1, \ldots, r_N\}$
since $R$ is a groupoid\footnote{Explanation in groupoid language:
The original set $\{r_1, \ldots, r_n\}$ was the set of arrows with
source $u$. The set $\{u_1, \ldots, u_m\}$ was the set of objects
isomorphic to $u$. And $\{r_1, \ldots, r_N\}$ is the set of all arrows
between all the objects equivalent to $u$.}. Moreover, we have
$\text{pr}_0(c^{-1}(\{r_1, \ldots, r_N\})) = \{r_1, \ldots, r_N\}$
and
$\text{pr}_1(c^{-1}(\{r_1, \ldots, r_N\})) = \{r_1, \ldots, r_N\}$.
Similarly we get $e(\{u_1, \ldots, u_m\}) \subset \{r_1, \ldots, r_N\}$
and $i(\{r_1, \ldots, r_N\}) = \{r_1, \ldots, r_N\}$.

\medskip\noindent
We may apply
More on Morphisms,
Lemma \ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical}
to the pairs
$(U \to S, \{u_1, \ldots, u_m\})$ and
$(R \to S, \{r_1, \ldots, r_N\})$
to get an \'etale neighbourhood $(S', p') \to (S, p)$
which induces an identification $\kappa(p) = \kappa(p')$
such that $S' \times_S U$ and $S' \times_S R$ decompose as
$$
S' \times_S U = U' \amalg W, \quad
S' \times_S R = R' \amalg W'
$$
with $U' \to S'$ finite and $(U')_{p'}$ mapping bijectively to
$\{u_1, \ldots, u_m\}$, and $R' \to S'$ finite and
$(R')_{p'}$ mapping bijectively to $\{r_1, \ldots, r_N\}$.
Moreover, no point of $W_{p'}$ (resp.\ $(W')_{p'}$) maps to
any of the points $u_j$ (resp.\ $r_i$). At this point (a), (b), (c), and (d)
of the lemma are satisfied. Moreover, the inclusions of (e) and (f) hold
on fibres over $p'$, i.e., $s'((R')_{p'}) \subset (U')_{p'}$,
$t'((R')_{p'}) \subset (U')_{p'}$, and
$c'((R' \times_{s', U', t'} R')_{p'}) \subset (R')_{p'}$.

\medskip\noindent
We claim that we can replace $S'$ by a Zariski open neighbourhood
of $p'$ so that the inclusions of (e) and (f) hold.
For example, consider the set $E = (s'|_{R'})^{-1}(W)$.
This is open and closed in $R'$ and does not contain any points
of $R'$ lying over $p'$. Since $R' \to S'$ is closed,
after replacing $S'$ by $S' \setminus (R' \to S')(E)$ we reach a
situation where $E$ is empty. In other words $s'$ maps $R'$ into $U'$.
Note that this property is preserved under further shrinking $S'$.
Similarly, we can arrange it so that $t'$ maps $R'$ into $U'$.
At this point (e) holds. In the same manner, consider the set
$E = (c'|_{R' \times_{s', U', t'} R'})^{-1}(W')$.
It is open and closed in the scheme $R' \times_{s', U', t'} R'$
which is finite over $S'$, and does not contain any points lying
over $p'$. Hence after replacing $S'$ by
$S' \setminus (R' \times_{s', U', t'} R' \to S')(E)$
we reach a situation where $E$ is empty. In other words we obtain
the inclusion in (f). We may repeat the argument also with the identity
$e' : S' \times_S U \to S' \times_S R$ and the inverse
$i' : S' \times_S R \to S' \times_S R$ so that we may assume
(after shrinking $S'$ some more) that $(e'|_{U'})^{-1}(W') = \emptyset$
and $(i'|_{R'})^{-1}(W') = \emptyset$.

\medskip\noindent
At this point we see that we may consider the structure
$$
(U', R', s'|_{R'}, t'|_{R'}, c'|_{R' \times_{t', U', s'} R'},
e'|_{U'}, i'|_{R'}).
$$
The axioms of a groupoid scheme over $S'$ hold
because they hold for the groupoid scheme
$(S' \times_S U, S' \times_S R, s', t', c', e', i')$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-over-base-j-proper}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $p \in S$ be a point, and let $u \in U$ be a point lying over $p$.
Assume assumptions (1) -- (6) of
Lemma \ref{lemma-quasi-finite-over-base}
hold as well as
\begin{enumerate}
\item[(7)] $j : R \to U \times_S U$ is universally closed\footnote{In view of
the other conditions this is equivalent to requiring $j$ to be proper.}.
\end{enumerate}
Then we can choose $(S', p') \to (S, p)$ and decompositions
$S' \times_S U = U' \amalg W$ and $S' \times_S R = R' \amalg W'$
and $u' \in U'$ such that (a) -- (g) of
Lemma \ref{lemma-quasi-finite-over-base}
hold as well as
\begin{enumerate}
\item[(h)] $R'$ is the restriction of $S' \times_S R$ to $U'$.
\end{enumerate}
\end{lemma}

\begin{proof}
We apply Lemma \ref{lemma-quasi-finite-over-base} for the
groupoid $(U, R, s, t, c)$ over the scheme $S$ with points $p$ and $u$.
Hence we get an \'etale neighbourhood
$(S', p') \to (S, p)$ and disjoint union decompositions
$$
S' \times_S U = U' \amalg W, \quad
S' \times_S R = R' \amalg W'
$$
and $u' \in U'$ satisfying conclusions (a), (b), (c), (d), (e), (f), and (g).
We may shrink $S'$ to a smaller neighbourhood of $p'$ without
affecting the conclusions (a) -- (g). We will show that for a suitable
shrinking conclusion (h) holds as well.
Let us denote $j'$ the base change of $j$ to $S'$.
By conclusion (e) it is clear that
$$
j'^{-1}(U' \times_{S'} U') = R' \amalg Rest
$$
for some open and closed $Rest$ piece. Since $U' \to S'$ is finite
by conclusion (d) we see that $U' \times_{S'} U'$ is finite over $S'$.
Since $j$ is universally closed, also $j'$ is universally closed, and
hence $j'|_{Rest}$ is universally closed too. By conclusions
(b) and (c) we see that the fibre of
$$
(U' \times_{S'} U' \to S') \circ j'|_{Rest} :
Rest
\longrightarrow
S'
$$
over $p'$ is empty. Hence, since $Rest \to S'$ is closed as a composition
of closed morphisms, after replacing $S'$ by
$S' \setminus \Im(Rest \to S')$, we may assume that
$Rest = \emptyset$. And this is exactly the condition that $R'$ is
the restriction of $S' \times_S R$ to the open subscheme
$U' \subset S' \times_S U$, see
Groupoids, Lemma \ref{groupoids-lemma-restrict-groupoid-relation}
and its proof.
\end{proof}






\section{Finite groupoids}
\label{section-finite-groupoids}

\noindent
A groupoid scheme $(U, R, s, t, c)$ is sometimes called {\it finite} if the
morphisms $s$ and $t$ are finite. This is potentially confusing as it doesn't
imply that $U$ or $R$ or the quotient sheaf $U/R$ are finite over anything.

\begin{lemma}
\label{lemma-finite-stratify}
Let $(U, R, s, t, c)$ be a groupoid scheme over a scheme $S$. Assume $s, t$
are finite. There exists a sequence of $R$-invariant closed subschemes
$$
U = Z_0 \supset Z_1 \supset Z_2 \supset \ldots
$$
such that $\bigcap Z_r = \emptyset$ and such that
$s^{-1}(Z_{r - 1}) \setminus s^{-1}(Z_r) \to Z_{r - 1} \setminus Z_r$
is finite locally free of rank $r$.
\end{lemma}

\begin{proof}
Let $\{Z_r\}$ be the stratification of $U$ given by the Fitting ideals
of the finite type quasi-coherent modules $s_*\mathcal{O}_R$. See
Divisors, Lemma \ref{divisors-lemma-locally-free-rank-r-pullback}.
Since the identity $e : U \to R$ is a section to $s$ we see that
$s_*\mathcal{O}_R$ contains $\mathcal{O}_S$ as a direct summand.
Hence $U = Z_{-1} = Z_0$ (details omitted).
Since formation of Fitting ideals commutes with base change
(More on Algebra, Lemma \ref{more-algebra-lemma-fitting-ideal-basics})
we find that $s^{-1}(Z_r)$ corresponds to the $r$th Fitting ideal
of $\text{pr}_{1, *}\mathcal{O}_{R \times_{s, U, t} R}$ because
the lower right square of diagram (\ref{equation-diagram}) is cartesian.
Using the fact that the lower left square is also cartesian we conclude
that $s^{-1}(Z_r) = t^{-1}(Z_r)$, in other words $Z_r$ is $R$-invariant.
The morphism
$s^{-1}(Z_{r - 1}) \setminus s^{-1}(Z_r) \to Z_{r - 1} \setminus Z_r$
is finite locally free of rank $r$ because the module
$s_*\mathcal{O}_R$ pulls back to a finite locally free module of rank $r$
on $Z_{r - 1} \setminus Z_r$ by
Divisors, Lemma \ref{divisors-lemma-locally-free-rank-r-pullback}.
\end{proof}

\begin{lemma}
\label{lemma-finite-flat-over-almost-dense-subscheme}
Let $(U, R, s, t, c)$ be a groupoid scheme over a scheme $S$. Assume $s, t$
are finite. There exists an open subscheme $W \subset U$ and a closed
subscheme $W' \subset W$ such that
\begin{enumerate}
\item $W$ and $W'$ are $R$-invariant,
\item $U = t(s^{-1}(\overline{W}))$ set theoretically,
\item $W$ is a thickening of $W'$, and
\item the maps $s'$, $t'$ of the restriction $(W', R', s', t', c')$
are finite locally free.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the stratification $U = Z_0 \supset Z_1 \supset Z_2 \supset \ldots$
of Lemma \ref{lemma-finite-stratify}.

\medskip\noindent
We will construct disjoint unions $W = \coprod_{r \geq 1} W_r$ and
$W' = \coprod_{r \geq 1} W'_r$ with each $W'_r \to W_r$ a thickening
of $R$-invariant subschemes of $U$ such that the morphisms
$s_r', t_r'$ of the restrictions $(W_r', R_r', s_r', t_r', c_r')$
are finite locally free of rank $r$. To begin we set
$W_1 = W'_1 = U \setminus Z_1$. This is an $R$-invariant open
subscheme of $U$, it is true that $W_0$ is a thickening of $W'_0$,
and the maps $s_1'$, $t_1'$ of the
restriction $(W_1', R_1', s_1', t_1', c_1')$ are isomorphisms, i.e.,
finite locally free of rank $1$.
Moreover, every point of $U \setminus Z_1$ is in $t(s^{-1}(\overline{W_1}))$.

\medskip\noindent
Assume we have found subschemes $W'_r \subset W_r \subset U$ for $r \leq n$
such that
\begin{enumerate}
\item $W_1, \ldots, W_n$ are disjoint,
\item $W_r$ and $W_r'$ are $R$-invariant,
\item $U \setminus Z_n \subset \bigcup_{r \leq n} t(s^{-1}(\overline{W_r}))$
set theoretically,
\item $W_r$ is a thickening of $W'_r$,
\item the maps $s_r'$, $t_r'$ of the restriction
$(W_r', R_r', s_r', t_r', c_r')$ are finite locally free of rank $r$.
\end{enumerate}
Then we set
$$
W_{n + 1} = Z_n \setminus
\left(
Z_{n + 1} \cup \bigcup\nolimits_{r \leq n} t(s^{-1}(\overline{W_r}))
\right)
$$
set theoretically and
$$
W'_{n + 1} = Z_n \setminus
\left(
Z_{n + 1} \cup \bigcup\nolimits_{r \leq n} t(s^{-1}(\overline{W_r}))
\right)
$$
scheme theoretically. Then $W_{n + 1}$ is an $R$-invariant open subscheme
of $U$ because $Z_{n + 1} \setminus \overline{U \setminus Z_{n + 1}}$
is open in $U$ and $\overline{U \setminus Z_{n + 1}}$ is contained
in the closed subset $\bigcup\nolimits_{r \leq n} t(s^{-1}(\overline{W_r}))$
we are removing by property (3) and the fact that $t$ is a closed morphism.
It is clear that $W'_{n + 1}$ is a closed subscheme
of $W_{n + 1}$ with the same underlying topological space.
Finally, properties (1), (2) and (3) are clear and property (5) follows from
Lemma \ref{lemma-finite-stratify}.

\medskip\noindent
By Lemma \ref{lemma-finite-stratify} we have $\bigcap Z_r = \emptyset$.
Hence every point of $U$ is contained in $U \setminus Z_n$
for some $n$. Thus we see that
$U = \bigcup_{r \geq 1} t(s^{-1}(\overline{W_r}))$
set theoretically and we see that (2) holds.
Thus $W' \subset W$ satisfy (1), (2), (3), and (4).
\end{proof}

\noindent
Let $(U, R, s, t, c)$ be a groupoid scheme. Given a point $u \in U$
the {\it $R$-orbit} of $u$ is the subset $t(s^{-1}(\{u\}))$ of $U$.

\begin{lemma}
\label{lemma-finite-flat-over-almost-dense-subscheme-addendum}
In Lemma \ref{lemma-finite-flat-over-almost-dense-subscheme}
assume in addition that $s$ and $t$ are of finite presentation.
Then
\begin{enumerate}
\item the morphism $W' \to W$ is of finite presentation, and
\item if $u \in U$ is a point whose $R$-orbit consists of
generic points of irreducible components of $U$, then $u \in W$.
\end{enumerate}
\end{lemma}

\begin{proof}
In this case the stratification
$U = Z_0 \supset Z_1 \supset Z_2 \supset \ldots$ of
Lemma \ref{lemma-finite-stratify} is given by closed immersions $Z_k \to U$
of finite presentation, see
Divisors, Lemma \ref{divisors-lemma-locally-free-rank-r-pullback}.
Part (1) follows immediately from this as $W' \to W$ is locally given
by intersecting the open $W$ by $Z_r$. To see part (2)
let $\{u_1, \ldots, u_n\}$ be the orbit of $u$.
Since the closed subschemes $Z_k$ are $R$-invariant and
$\bigcap Z_k = \emptyset$, we find an $k$ such that $u_i \in Z_k$
and $u_i \not \in Z_{k + 1}$ for all $i$.
The image of $Z_k \to U$ and $Z_{k + 1} \to U$ is locally constructible
(Morphisms, Theorem \ref{morphisms-theorem-chevalley}).
Since $u_i \in U$ is a generic point of an irreducible component
of $U$, there exists an open neighbourhood $U_i$ of $u_i$ which
is contained in $Z_k \setminus Z_{k + 1}$ set theoretically
(Properties, Lemma \ref{properties-lemma-generic-point-in-constructible}).
In the proof of Lemma \ref{lemma-finite-flat-over-almost-dense-subscheme}
we have constructed $W$ as a disjoint union $\coprod W_r$
with $W_r \subset Z_{r - 1} \setminus Z_r$ such that
$U = \bigcup t(s^{-1}(\overline{W_r}))$. As $\{u_1, \ldots, u_n\}$
is an $R$-orbit we see that $u \in t(s^{-1}(\overline{W_r}))$
implies $u_i \in \overline{W_r}$ for some $i$ which implies
$U_i \cap W_r \not = \emptyset$ which implies $r = k$.
Thus we conclude that $u$ is in
$$
W_{k + 1} = Z_k \setminus
\left(
Z_{k + 1} \cup \bigcup\nolimits_{r \leq k} t(s^{-1}(\overline{W_r}))
\right)
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-invariant-affine-open-around-generic-point}
Let $(U, R, s, t, c)$ be a groupoid scheme over a scheme $S$. Assume $s, t$
are finite and of finite presentation and $U$ quasi-separated. Let
$u_1, \ldots, u_m \in U$ be points whose orbits consist of generic points
of irreducible components of $U$. Then there exist $R$-invariant subschemes
$V' \subset V \subset U$ such that
\begin{enumerate}
\item $u_1, \ldots, u_m \in V'$,
\item $V$ is open in $U$,
\item $V'$ and $V$ are affine,
\item $V' \subset V$ is a thickening of finite presentation,
\item the morphisms $s', t'$ of the restriction $(V', R', s', t', c')$
are finite locally free.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $W' \subset W \subset U$ be as in
Lemma \ref{lemma-finite-flat-over-almost-dense-subscheme}.
By Lemma \ref{lemma-finite-flat-over-almost-dense-subscheme-addendum}
we get $u_j \in W$ and that $W' \to W$ is a thickening of finite presentation.
By Limits, Lemma \ref{limits-lemma-affines-glued-in-closed-affine}
it suffices to find an $R$-invariant affine open subscheme
$V'$ of $W'$ containing $u_j$ (because then we can let $V \subset W$
be the corresponding open subscheme which will be affine).
Thus we may replace $(U, R, s, t, c)$ by the restriction
$(W', R', s', t', c')$ to $W'$.
In other words, we may assume we have a groupoid scheme $(U, R, s, t, c)$
whose morphisms $s$ and $t$ are finite locally free.
By Properties, Lemma \ref{properties-lemma-maximal-points-affine}
we can find an affine open containing the union of the orbits of
$u_1, \ldots, u_m$. Finally, we can apply
Groupoids, Lemma \ref{groupoids-lemma-find-invariant-affine}
to conclude.
\end{proof}

\noindent
The following lemma is a special case of
Lemma \ref{lemma-invariant-affine-open-around-generic-point}
but we redo the argument as it is slightly easier in this case
(it avoids using
Lemma \ref{lemma-finite-flat-over-almost-dense-subscheme-addendum}).

\begin{lemma}
\label{lemma-invariant-affine-open-around-generic-point-Noetherian}
Let $(U, R, s, t, c)$ be a groupoid scheme over a scheme $S$.
Assume $s, t$ finite, $U$ is locally Noetherian, and $u_1, \ldots, u_m \in U$
points whose orbits consist of generic points of irreducible
components of $U$. Then there exist $R$-invariant subschemes
$V' \subset V \subset U$ such that
\begin{enumerate}
\item $u_1, \ldots, u_m \in V'$,
\item $V$ is open in $U$,
\item $V'$ and $V$ are affine,
\item $V' \subset V$ is a thickening,
\item the morphisms $s', t'$ of the restriction $(V', R', s', t', c')$
are finite locally free.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\{u_{j1}, \ldots, u_{jn_j}\}$ be the orbit of $u_j$.
Let $W' \subset W \subset U$ be as in
Lemma \ref{lemma-finite-flat-over-almost-dense-subscheme}.
Since $U = t(s^{-1}(\overline{W}))$ we see that at least
one $u_{ji} \in \overline{W}$. Since $u_{ji}$ is a generic point
of an irreducible component and $U$ locally Noetherian,
this implies that $u_{ji} \in W$. Since $W$ is $R$-invariant, we
conclude that $u_j \in W$ and in fact the whole orbit is contained in $W$.
By Cohomology of Schemes, Lemma
\ref{coherent-lemma-image-affine-finite-morphism-affine-Noetherian}
it suffices to find an $R$-invariant affine open subscheme $V'$
of $W'$ containing $u_1, \ldots, u_m$ (because then we can let $V \subset W$
be the corresponding open subscheme which will be affine).
Thus we may replace $(U, R, s, t, c)$
by the restriction $(W', R', s', t', c')$ to $W'$.
In other words, we may assume we have a groupoid scheme $(U, R, s, t, c)$
whose morphisms $s$ and $t$ are finite locally free.
By Properties, Lemma \ref{properties-lemma-maximal-points-affine}
we can find an affine open containing $\{u_{ij}\}$
(a locally Noetherian scheme is quasi-separated by
Properties, Lemma \ref{properties-lemma-locally-Noetherian-quasi-separated}).
Finally, we can apply
Groupoids, Lemma \ref{groupoids-lemma-find-invariant-affine}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-find-affine-integral}
Let $(U, R, s, t, c)$ be a groupoid scheme over a scheme $S$
with $s, t$ integral. Let $g : U' \to U$ be an integral morphism
such that every $R$-orbit in $U$ meets $g(U')$. Let $(U', R', s', t', c')$
be the restriction of $R$ to $U'$. If $u' \in U'$ is contained in an
$R'$-invariant affine open, then the image $u \in U$ is contained
in an $R$-invariant affine open of $U$.
\end{lemma}

\begin{proof}
Let $W' \subset U'$ be an $R'$-invariant affine open.
Set $\tilde R = U' \times_{g, U, t} R$ with maps
$\text{pr}_0 : \tilde R \to U'$ and $h = s \circ \text{pr}_1 : \tilde R \to U$.
Observe that $\text{pr}_0$ and $h$ are integral.
It follows that $\tilde W = \text{pr}_0^{-1}(W')$ is affine.
Since $W'$ is $R'$-invariant, the image
$W = h(\tilde W)$ is set theoretically $R$-invariant and
$\tilde W = h^{-1}(W)$ set theoretically (details omitted).
Thus, if we can show that $W$ is open, then $W$ is a scheme
and the morphism $\tilde W \to W$ is integral surjective
which implies that $W$ is affine by
Limits, Proposition \ref{limits-proposition-affine}.
However, our assumption on orbits meeting $U'$ implies
that $h : \tilde R \to U$ is surjective. Since an
integral surjective morphism is submersive
(Topology, Lemma \ref{topology-lemma-closed-morphism-quotient-topology}
and Morphisms, Lemma \ref{morphisms-lemma-integral-universally-closed})
it follows that $W$ is open.
\end{proof}

\noindent
The following technical lemma produces ``almost'' invariant
functions in the situation of a finite groupoid on a quasi-affine
scheme.

\begin{lemma}
\label{lemma-find-almost-invariant-function}
Let $(U, R, s, t, c)$ be a groupoid scheme with $s, t$ finite and of
finite presentation. Let $u_1, \ldots, u_m \in U$ be points whose $R$-orbits
consist of generic points of irreducible components of $U$.
Let $j : U \to \Spec(A)$ be an immersion.
Let $I \subset A$ be an ideal such that $j(U) \cap V(I) = \emptyset$
and $V(I) \cup j(U)$ is closed in $\Spec(A)$.
Then there exists an $h \in I$ such that $j^{-1}D(h)$
is an $R$-invariant affine open subscheme of $U$ containing
$u_1, \ldots, u_m$.
\end{lemma}

\begin{proof}
Let $u_1, \ldots, u_m \in V' \subset V \subset U$ be as in
Lemma \ref{lemma-invariant-affine-open-around-generic-point}.
Since $U \setminus V$ is closed in $U$, $j$ an immersion, and $V(I) \cup j(U)$
is closed in $\Spec(A)$, we can find an ideal
$J \subset I$ such that $V(J) = V(I) \cup j(U \setminus V)$.
For example we can take the ideal of elements of $I$ which
vanish on $j(U \setminus V)$. Thus we can replace
$(U, R, s, t, c)$, $j : U \to \Spec(A)$, and $I$ by
$(V', R', s', t', c')$, $j|_{V'} : V' \to \Spec(A)$, and $J$.
In other words, we may assume that $U$ is affine and that
$s$ and $t$ are finite locally free.
Take any $f \in I$ which does not vanish at all the
points in the $R$-orbits of $u_1, \ldots, u_m$
(Algebra, Lemma \ref{algebra-lemma-silly}). Consider
$$
g = \text{Norm}_s(t^\sharp(j^\sharp(f))) \in \Gamma(U, \mathcal{O}_U)
$$
Since $f \in I$ and since $V(I) \cup j(U)$ is closed we see that
$U \cap D(f) \to D(f)$ is a closed immersion. Hence $f^ng$ is the
image of an element $h \in I$ for some $n > 0$. We claim that $h$ works.
Namely, we have seen in
Groupoids, Lemma \ref{groupoids-lemma-determinant-trick}
that $g$ is an $R$-invariant function, hence $D(g) \subset U$
is $R$-invariant. Since $f$ does not vanish on the orbit of $u_j$,
the function $g$ does not vanish at $u_j$. Moreover, we have
$V(g) \supset V(j^\sharp(f))$ and hence $j^{-1}D(h) = D(g)$.
\end{proof}

\begin{lemma}
\label{lemma-no-specializations-map-to-same-point}
Let $(U, R, s, t, c)$ be a groupoid scheme. If $s, t$ are finite,
and $u, u' \in R$ are distinct points in the same orbit,
then $u'$ is not a specialization of $u$.
\end{lemma}

\begin{proof}
Let $r \in R$ with $s(r) = u$ and $t(r) = u'$. If $u \leadsto u'$
then we can find a nontrivial specialization $r \leadsto r'$ with
$s(r') = u'$, see 
Schemes, Lemma \ref{schemes-lemma-quasi-compact-closed}.
Set $u'' = t(r')$. Note that $u'' \not = u'$ as there are no
specializations in the fibres of a finite morphism.
Hence we can continue and find a nontrivial specialization
$r' \leadsto r''$ with $s(r'') = u''$, etc. This shows that the
orbit of $u$ contains an infinite sequence
$u \leadsto u' \leadsto u'' \leadsto \ldots$
of specializations which is nonsense as the orbit
$t(s^{-1}(\{u\}))$ is finite.
\end{proof}

\begin{lemma}
\label{lemma-get-affine}
Let $j : V \to \Spec(A)$ be a quasi-compact immersion of schemes.
Let $f \in A$ be such that $j^{-1}D(f)$ is affine and $j(V) \cap V(f)$
is closed. Then $V$ is affine.
\end{lemma}

\begin{proof}
This follows from Morphisms, Lemma \ref{morphisms-lemma-get-affine}
but we will also give a direct proof.
Let $A' = \Gamma(V, \mathcal{O}_V)$. Then $j' : V \to \Spec(A')$ is a
quasi-compact open immersion, see
Properties, Lemma \ref{properties-lemma-quasi-affine}.
Let $f' \in A'$ be the image of $f$. Then $(j')^{-1}D(f') = j^{-1}D(f)$
is affine. On the other hand, $j'(V) \cap V(f')$ is a subscheme of
$\Spec(A')$ which maps isomorphically to the closed subscheme
$j(V) \cap V(f)$ of $\Spec(A)$. Hence it is closed in $\Spec(A')$
for example by Schemes, Lemma \ref{schemes-lemma-section-immersion}.
Thus we may replace $A$ by $A'$ and assume that $j$ is an open immersion
and $A = \Gamma(V, \mathcal{O}_V)$.

\medskip\noindent
In this case we claim that $j(V) = \Spec(A)$ which finishes the proof.
If not, then we can find a principal affine open $D(g) \subset \Spec(A)$
which meets the complement and avoids the closed subset $j(V) \cap V(f)$.
Note that $j$ maps $j^{-1}D(f)$ isomorphically onto $D(f)$, see
Properties, Lemma \ref{properties-lemma-invert-f-affine}.
Hence $D(g)$ meets $V(f)$. On the other hand, $j^{-1}D(g)$
is a principal open of the affine open $j^{-1}D(f)$ hence affine.
Hence by
Properties, Lemma \ref{properties-lemma-invert-f-affine}
again we see that $D(g)$ is isomorphic to $j^{-1}D(g) \subset j^{-1}D(f)$
which implies that $D(g) \subset D(f)$. This contradiction finishes
the proof.
\end{proof}

\begin{lemma}
\label{lemma-find-affine-codimension-1}
Let $(U, R, s, t, c)$ be a groupoid scheme. Let $u \in U$. Assume
\begin{enumerate}
\item $s, t$ are finite morphisms,
\item $U$ is separated and locally Noetherian,
\item $\dim(\mathcal{O}_{U, u'}) \leq 1$ for every point $u'$
in the orbit of $u$.
\end{enumerate}
Then $u$ is contained in an $R$-invariant affine open of $U$.
\end{lemma}

\begin{proof}
The $R$-orbit of $u$ is finite. By conditions (2) and (3) it is contained
in an affine open $U'$ of $U$, see
Varieties, Proposition
\ref{varieties-proposition-finite-set-of-points-of-codim-1-in-affine}.
Then $t(s^{-1}(U \setminus U'))$ is an $R$-invariant
closed subset of $U$ which does not contain $u$. Thus
$U \setminus t(s^{-1}(U \setminus U'))$ is an $R$-invariant open
of $U'$ containing $u$.
Replacing $U$ by this open we may assume $U$ is quasi-affine.

\medskip\noindent
By Lemma \ref{lemma-find-affine-integral} we may replace $U$ by its reduction
and assume $U$ is reduced. This means $R$-invariant subschemes
$W' \subset W \subset U$ of
Lemma \ref{lemma-finite-flat-over-almost-dense-subscheme}
are equal $W' = W$. As $U = t(s^{-1}(\overline{W}))$ some point
$u'$ of the $R$-orbit of $u$ is contained in $\overline{W}$
and by Lemma \ref{lemma-find-affine-integral}
we may replace $U$ by $\overline{W}$ and $u$ by $u'$.
Hence we may assume there is
a dense open $R$-invariant subscheme $W \subset U$ such that
the morphisms $s_W, t_W$ of the restriction $(W, R_W, s_W, t_W, c_W)$ are
finite locally free.

\medskip\noindent
If $u \in W$ then we are done by
Groupoids, Lemma \ref{groupoids-lemma-find-invariant-affine}
(because $W$ is quasi-affine so any finite set of points
of $W$ is contained in an affine open, see
Properties, Lemma \ref{properties-lemma-ample-finite-set-in-affine}).
Thus we assume $u \not \in W$ and hence none of the points of the
orbit of $u$ is in $W$. Let $\xi \in U$
be a point with a nontrivial specialization to a point $u'$ in the orbit
of $u$. Since there are no specializations among the points in the
orbit of $u$ (Lemma \ref{lemma-no-specializations-map-to-same-point})
we see that $\xi$ is not in the orbit.
By assumption (3) we see that $\xi$ is a generic point of $U$
and hence $\xi \in W$.
As $U$ is Noetherian there are finitely many of these
points $\xi_1, \ldots, \xi_m \in W$. Because $s_W, t_W$ are flat the orbit
of each $\xi_j$ consists of generic points of irreducible components
of $W$ (and hence $U$).

\medskip\noindent
Let $j : U \to \Spec(A)$ be an immersion of $U$ into an affine scheme
(this is possible as $U$ is quasi-affine). Let $J \subset A$
be an ideal such that $V(J) \cap j(W) = \emptyset$ and $V(J) \cup j(W)$
is closed. Apply Lemma \ref{lemma-find-almost-invariant-function}
to the groupoid scheme $(W, R_W, s_W, t_W, c_W)$, the morphism
$j|_W : W \to \Spec(A)$, the points $\xi_j$, and the ideal $J$
to find an $f \in J$ such that $(j|_W)^{-1}D(f)$ is an $R_W$-invariant
affine open containing $\xi_j$ for all $j$. Since $f \in J$
we see that $j^{-1}D(f) \subset W$, i.e., $j^{-1}D(f)$ is
an $R$-invariant affine open of $U$ contained in $W$
containing all $\xi_j$.

\medskip\noindent
Let $Z$ be the reduced induced closed subscheme structure on
$$
U \setminus j^{-1}D(f) = j^{-1}V(f).
$$
Then $Z$ is set theoretically
$R$-invariant (but it may not be scheme theoretically $R$-invariant).
Let $(Z, R_Z, s_Z, t_Z, c_Z)$ be the restriction of $R$ to $Z$.
Since $Z \to U$ is finite, it follows that $s_Z$ and $t_Z$ are finite.
Since $u \in Z$ the orbit of $u$ is in $Z$ and agrees with the
$R_Z$-orbit of $u$ viewed as a point of $Z$. Since
$\dim(\mathcal{O}_{U, u'}) \leq 1$ and since $\xi_j \not \in Z$
for all $j$, we see that $\dim(\mathcal{O}_{Z, u'}) \leq 0$ for
all $u'$ in the orbit of $u$. In other words, the $R_Z$-orbit of $u$
consists of generic points of irreducible components of $Z$.

\medskip\noindent
Let $I \subset A$ be an ideal such that $V(I) \cap j(U) =\emptyset$
and $V(I) \cup j(U)$ is closed. Apply
Lemma \ref{lemma-find-almost-invariant-function} to
the groupoid scheme $(Z, R_Z, s_Z, t_Z, c_Z)$, the restriction $j|_Z$,
the ideal $I$, and the point $u \in Z$ to obtain $h \in I$ such that
$j^{-1}D(h) \cap Z$ is an $R_Z$-invariant open affine containing $u$.

\medskip\noindent
Consider the $R_W$-invariant (Groupoids, Lemma
\ref{groupoids-lemma-determinant-trick}) function
$$
g = 
\text{Norm}_{s_W}(t_W^\sharp(j^\sharp(h)|_W)) \in \Gamma(W, \mathcal{O}_W)
$$
(In the following we only need the restriction of $g$ to $j^{-1}D(f)$ and
in this case the norm is along a finite locally free morphism of affines.)
We claim that
$$
V = (W_g \cap j^{-1}D(f)) \cup (j^{-1}D(h) \cap Z)
$$
is an $R$-invariant affine open of $U$ which finishes the proof of the lemma.
It is set theoretically $R$-invariant by construction. As $V$ is a
constuctible set, to see that it is open it suffices to show it is
closed under generalization in $U$ (Topology, Lemma
\ref{topology-lemma-characterize-closed-Noetherian}
or the more general
Topology, Lemma
\ref{topology-lemma-constructible-stable-specialization-closed}).
Since $W_g \cap j^{-1}D(f)$ is open in $U$, it suffices to consider
a specialization $u_1 \leadsto u_2$ of $U$ with
$u_2 \in j^{-1}D(h) \cap Z$.
This means that $h$ is nonzero in $j(u_2)$ and $u_2 \in Z$.
If $u_1 \in Z$, then $j(u_1) \leadsto j(u_2)$ and since
$h$ is nonzero in $j(u_2)$ it is nonzero in $j(u_1)$ which
implies $u_1 \in V$. If $u_1 \not \in Z$ and
also not in $W_g \cap j^{-1}D(f)$, then $u_1 \in W$, $u_1 \not \in W_g$
because the complement of $Z = j^{-1}V(f)$ is contained in $W \cap j^{-1}D(f)$.
Hence there exists a point $r_1 \in R$ with $s(r_1) = u_1$
such that $h$ is zero in $t(r_1)$. Since $s$ is finite we
can find a specialization $r_1 \leadsto r_2$ with $s(r_2) = u_2$.
However, then we conclude that $f$ is zero in $u'_2 = t(r_2)$
which contradicts the fact that $j^{-1}D(h) \cap Z$
is $R$-invariant and $u_2$ is in it. Thus $V$ is open.

\medskip\noindent
Observe that $V \subset j^{-1}D(h)$ for our function $h \in I$.
Thus we obtain an immersion
$$
j' : V \longrightarrow \Spec(A_h)
$$
Let $f' \in A_h$ be the image of $f$. Then $(j')^{-1}D(f')$
is the principal open determined by $g$ in the affine
open $j^{-1}D(f)$ of $U$.
Hence $(j')^{-1}D(f)$ is affine. Finally,
$j'(V) \cap V(f') = j'(j^{-1}D(h) \cap Z)$
is closed in $\Spec(A_h/(f')) = \Spec((A/f)_h) = D(h) \cap V(f)$
by our choice of $h \in I$ and the ideal $I$. Hence we can apply
Lemma \ref{lemma-get-affine}
to conclude that $V$ is affine as claimed above.
\end{proof}







\section{Descending ind-quasi-affine morphisms}
\label{section-ind-quasi-affine}

\noindent
Ind-quasi-affine morphisms were defined in
More on Morphisms, Section \ref{more-morphisms-section-ind-quasi-affine}.
This section is the analogue of
Descent, Section \ref{descent-section-quasi-affine}
for ind-quasi-affine-morphisms.

\medskip\noindent
Let $X$ be a quasi-separated scheme. Let $E \subset X$ be a subset
which is an intersection of a nonempty family of quasi-compact opens of $X$.
Say $E = \bigcap_{i \in I} U_i$ with $U_i \subset X$ quasi-compact open
and $I$ nonempty.
By adding finite intersections we may assume that for $i, j \in I$
there exists a $k \in I$ with $U_k \subset U_i \cap U_j$.
In this situation we have
\begin{equation}
\label{equation-sections-of-intersection}
\Gamma(E, \mathcal{F}|_E) = \colim \Gamma(U_i, \mathcal{F}|_{U_i})
\end{equation}
for any sheaf $\mathcal{F}$ defined on $X$. Namely, fix $i_0 \in I$
and replace $X$ by $U_{i_0}$ and $I$ by
$\{i \in I \mid U_i \subset U_{i_0}\}$. Then $X$ is quasi-compact
and quasi-separated, hence a spectral space, see
Properties, Lemma
\ref{properties-lemma-quasi-compact-quasi-separated-spectral}.
Then we see the equality holds by
Topology, Lemma \ref{topology-lemma-make-spectral-space} and
Sheaves, Lemma \ref{sheaves-lemma-descend-opens}.
(In fact, the formula holds for higher cohomology groups
as well if $\mathcal{F}$ is abelian, see
Cohomology, Lemma \ref{cohomology-lemma-colimit}.)

\begin{lemma}
\label{lemma-sits-in-functions}
Let $X$ be an ind-quasi-affine scheme. Let $E \subset X$ be an
intersection of a nonempty family of quasi-compact opens of $X$.
Set $A = \Gamma(E, \mathcal{O}_X|_E)$ and $Y = \Spec(A)$.
Then the canonical morphism
$$
j : (E, \mathcal{O}_X|_E) \longrightarrow (Y, \mathcal{O}_Y)
$$
of Schemes, Lemma \ref{schemes-lemma-morphism-into-affine}
determines an isomorphism
$(E, \mathcal{O}_X|_E) \to (E', \mathcal{O}_Y|_{E'})$
where $E' \subset Y$ is an intersection of quasi-compact opens.
If $W \subset E$ is open in $X$, then $j(W)$ is open in $Y$.
\end{lemma}

\begin{proof}
Note that $(E, \mathcal{O}_X|_E)$ is a locally ringed space so that
Schemes, Lemma \ref{schemes-lemma-morphism-into-affine} applies
to $A \to \Gamma(E, \mathcal{O}_X|_E)$. Write $E = \bigcap_{i \in I} U_i$
with $I \not = \emptyset$ and $U_i \subset X$ quasi-compact open.
We may and do assume that for $i, j \in I$ there exists a $k \in I$ with
$U_k \subset U_i \cap U_j$. Set $A_i = \Gamma(U_i, \mathcal{O}_{U_i})$.
We obtain commutative diagrams
$$
\xymatrix{
(E, \mathcal{O}_X|_E) \ar[r] \ar[d] &
(\Spec(A), \mathcal{O}_{\Spec(A)}) \ar[d] \\
(U_i, \mathcal{O}_{U_i}) \ar[r] &
(\Spec(A_i), \mathcal{O}_{\Spec(A_i)})
}
$$
Since $U_i$ is quasi-affine, we see that $U_i \to \Spec(A_i)$
is a quasi-compact open immersion. On the other hand
$A = \colim A_i$. Hence $\Spec(A) = \lim \Spec(A_i)$ as topological
spaces (Limits, Lemma \ref{limits-lemma-topology-limit}). Since
$E = \lim U_i$ (by Topology, Lemma \ref{topology-lemma-make-spectral-space})
we see that $E \to \Spec(A)$ is a homeomorphism onto its
image $E'$ and that $E'$ is the intersection of the inverse images
of the opens $U_i \subset \Spec(A_i)$ in $\Spec(A)$. For any
$e \in E$ the local ring $\mathcal{O}_{X, e}$ is the value
of $\mathcal{O}_{U_i, e}$ which is the same as the value on $\Spec(A)$.

\medskip\noindent
To prove the final assertion of the lemma we argue as follows.
Pick $i, j \in I$ with $U_i \subset U_j$.
Consider the following commutative diagrams
$$
\xymatrix{
U_i \ar[r] \ar[d] & \Spec(A_i) \ar[d] \\
U_i \ar[r] & \Spec(A_j)
}
\quad\quad
\xymatrix{
W \ar[r] \ar[d] & \Spec(A_i) \ar[d] \\
W \ar[r] & \Spec(A_j)
}
\quad\quad
\xymatrix{
W \ar[r] \ar[d] & \Spec(A) \ar[d] \\
W \ar[r] & \Spec(A_j)
}
$$
By Properties, Lemma
\ref{properties-lemma-cartesian-diagram-quasi-affine}
the first diagram is cartesian. Hence the second is cartesian as well.
Passing to the limit we find that the third diagram
is cartesian, so the top horizontal arrow of this diagram is an open immersion.
\end{proof}

\begin{lemma}
\label{lemma-affine-base-change}
Suppose given a cartesian diagram
$$
\xymatrix{
X \ar[d]_f \ar[r] & \Spec(B) \ar[d] \\
Y \ar[r] & \Spec(A)
}
$$
of schemes. Let $E \subset Y$ be an intersection of a nonempty family
of quasi-compact opens of $Y$. Then
$$
\Gamma(f^{-1}(E), \mathcal{O}_X|_{f^{-1}(E)}) =
\Gamma(E, \mathcal{O}_Y|_E) \otimes_A B
$$
provided $Y$ is quasi-separated and $A \to B$ is flat.
\end{lemma}

\begin{proof}
Write $E = \bigcap_{i \in I} V_i$ with $V_i \subset Y$ quasi-compact open.
We may and do assume that for $i, j \in I$ there exists a $k \in I$ with
$V_k \subset V_i \cap V_j$. Then we have similarly that
$f^{-1}(E) = \bigcap_{i \in I} f^{-1}(V_i)$ in $X$.
Thus the result follows from equation (\ref{equation-sections-of-intersection})
and the corresponding result for $V_i$ and $f^{-1}(V_i)$ which is
Cohomology of Schemes, Lemma \ref{coherent-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{lemma}[Gabber]
\label{lemma-ind-quasi-affine}
Let $S$ be a scheme. Let $\{X_i \to S\}_{i\in I}$ be an fpqc covering.
Let $(V_i/X_i, \varphi_{ij})$ be a descent datum relative to
$\{X_i \to S\}$, see Descent, Definition
\ref{descent-definition-descent-datum-for-family-of-morphisms}. 
If each morphism $V_i \to X_i$ is ind-quasi-affine, then the descent datum
is effective.
\end{lemma}

\begin{proof}
Being ind-quasi-affine is a property of morphisms of schemes
which is preserved under any base change, see
More on Morphisms, Lemma
\ref{more-morphisms-lemma-base-change-ind-quasi-affine}.
Hence Descent, Lemma \ref{descent-lemma-descending-types-morphisms} applies
and it suffices to prove the statement of the lemma
in case the fpqc-covering is given by a single
$\{X \to S\}$ flat surjective morphism of affines.
Say $X = \Spec(A)$ and $S = \Spec(R)$ so
that $R \to A$ is a faithfully flat ring map.
Let $(V, \varphi)$ be a descent datum relative to $X$ over $S$
and assume that $V \to X$ is ind-quasi-affine, in other words,
$V$ is ind-quasi-affine.

\medskip\noindent
Let $(U, R, s, t, c)$ be the groupoid scheme over $S$ with
$U = X$ and $R = X \times_S X$ and $s$, $t$, $c$ as usual.
By Groupoids, Lemma \ref{groupoids-lemma-cartesian-equivalent-descent-datum}
the pair $(V, \varphi)$ corresponds to a cartesian morphism
$(U', R', s', t', c') \to (U, R, s, t, c)$ of groupoid schemes.
Let $u' \in U'$ be any point. By
Groupoids, Lemmas \ref{groupoids-lemma-constructing-invariant-opens},
\ref{groupoids-lemma-first-observation}, and
\ref{groupoids-lemma-second-observation}
we can choose $u' \in W \subset E \subset U'$
where $W$ is open and $R'$-invariant, and
$E$ is set-theoretically $R'$-invariant and
an intersection of a nonempty family of quasi-compact opens.

\medskip\noindent
Translating back to $(V, \varphi)$, for any $v \in V$ we can find
$v \in W \subset E \subset V$ with the following properties:
(a) $W$ is open and $\varphi(W \times_S X) = X \times_S W$ and
(b) $E$ an intersection of quasi-compact opens and
$\varphi(E \times_S X) = X \times_S E$ set-theoretically.
Here we use the notation $E \times_S X$ to mean the
inverse image of $E$ in $V \times_S X$ by the projection morphism and
similarly for $X \times_S E$. By Lemma \ref{lemma-affine-base-change}
this implies that $\varphi$ defines an isomorphism
\begin{align*}
\Gamma(E, \mathcal{O}_V|_E) \otimes_R A
& =
\Gamma(E \times_S X, \mathcal{O}_{V \times_S X}|_{E \times_S X}) \\
& \to
\Gamma(X \times_S E, \mathcal{O}_{X \times_S V}|_{X \times_S E}) \\
& =
A \otimes_R \Gamma(E, \mathcal{O}_V|_E)
\end{align*}
of $A \otimes_R A$-algebras which we will call $\psi$.
The cocycle condition for $\varphi$
translates into the cocycle condition for $\psi$ as in
Descent, Definition \ref{descent-definition-descent-datum-modules}
(details omitted). By Descent, Proposition
\ref{descent-proposition-descent-module}
we find an $R$-algebra $R'$ and an isomorphism
$\chi : R' \otimes_R A \to \Gamma(E, \mathcal{O}_V|_E)$
of $A$-algebras, compatible with $\psi$ and the
canonical descent datum on $R' \otimes_R A$.

\medskip\noindent
By Lemma \ref{lemma-sits-in-functions} we obtain a canonical ``embedding''
$$
j : (E, \mathcal{O}_V|_E) \longrightarrow
\Spec(\Gamma(E, \mathcal{O}_V|_E)) = \Spec(R' \otimes_R A)
$$
of locally ringed spaces. The construction of this map is canonical
and we get a commutative diagram
$$
\xymatrix{
& E \times_S X \ar[rr]_\varphi \ar[ld] \ar[rd]^{j'} & &
X \times_S E \ar[rd] \ar[ld]_{j''} \\
E \ar[rd]^j  & &
\Spec(R' \otimes_R A \otimes_R A) \ar[ld] \ar[rd] & &
E \ar[ld]_j \\
& \Spec(R' \otimes_R A) \ar[rd] && \Spec(R' \otimes_R A) \ar[ld] \\
& & \Spec(R')
}
$$
where $j'$ and $j''$ come from the same construction applied to
$E \times_S X \subset V \times_S X$ and $X \times_S E \subset X \times_S V$
via $\chi$ and the identifications used to construct $\psi$.
It follows that $j(W)$ is an open subscheme of $\Spec(R' \otimes_R A)$
whose inverse image under the two projections
$\Spec(R' \otimes_R A \otimes_R A) \to \Spec(R' \otimes_R A)$
are equal. By Descent, Lemma \ref{descent-lemma-open-fpqc-covering}
we find an open $W_0 \subset \Spec(R')$ whose base change
to $\Spec(A)$ is $j(W)$. Contemplating the diagram above
we see that the descent datum $(W, \varphi|_{W \times_S X})$
is effective. By Descent, Lemma
\ref{descent-lemma-effective-for-fpqc-is-local-upstairs}
we see that our descent datum is effective.
\end{proof}






\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
