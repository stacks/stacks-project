\input{preamble}

% OK, start here.
%
\begin{document}

\title{Derived Categories of Schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss derived categories of modules on schemes.
Most of the material discussed here can be found in
\cite{TT}, \cite{Bokstedt-Neeman}, \cite{BvdB}, and \cite{LN}.
Of course there are many other references.


\section{Conventions}
\label{section-conventions}

\noindent
If $\mathcal{A}$ is an abelian category and $M$ is an object
of $\mathcal{A}$ then we also denote $M$ the object of $K(\mathcal{A})$
and/or $D(\mathcal{A})$ corresponding to the complex which has
$M$ in degree $0$ and is zero in all other degrees.

\medskip\noindent
If we have a ring $A$, then $K(A)$ denotes the homotopy category
of complexes of $A$-modules and $D(A)$ the associated derived category.
Similarly, if we have a ringed space $(X, \mathcal{O}_X)$ the symbol
$K(\mathcal{O}_X)$ denotes the homotopy category of complexes of
$\mathcal{O}_X$-modules and $D(\mathcal{O}_X)$ the associated derived
category.










\section{Derived category of quasi-coherent modules}
\label{section-derived-quasi-coherent}

\noindent
In this section we discuss the relationship between quasi-coherent
modules and all modules on a scheme $X$. A reference is
\cite[Appendix B]{TT}. By the discussion in
Schemes, Section \ref{schemes-section-quasi-coherent}
the embedding
$\QCoh(\mathcal{O}_X) \subset \textit{Mod}(\mathcal{O}_X)$
exhibits $\QCoh(\mathcal{O}_X)$ as a weak Serre subcategory of
the category of $\mathcal{O}_X$-modules. Denote
$$
D_\QCoh(\mathcal{O}_X) \subset D(\mathcal{O}_X)
$$
the subcategory of complexes whose cohomology sheaves are quasi-coherent, see
Derived Categories, Section \ref{derived-section-triangulated-sub}.
Thus we obtain a canonical functor
\begin{equation}
\label{equation-compare}
D(\QCoh(\mathcal{O}_X))
\longrightarrow
D_\QCoh(\mathcal{O}_X)
\end{equation}
see Derived Categories, Equation (\ref{derived-equation-compare}).

\begin{lemma}
\label{lemma-quasi-coherence-direct-sums}
Let $X$ be a scheme. Then $D_\QCoh(\mathcal{O}_X)$
has direct sums.
\end{lemma}

\begin{proof}
By Injectives, Lemma \ref{injectives-lemma-derived-products}
the derived category $D(\mathcal{O}_X)$ has direct sums and
they are computed by taking termwise direct sums of any representatives.
Thus it is clear that the cohomology sheaf of a direct sum is the
direct sum of the cohomology sheaves as taking direct sums is
an exact functor (in any Grothendieck abelian category). The lemma
follows as the direct sum of quasi-coherent sheaves is quasi-coherent, see
Schemes, Section \ref{schemes-section-quasi-coherent}.
\end{proof}

\noindent
We will need some information on derived limits. We warn the reader
that in the lemma below the derived limit will typically not be
an object of $D_\QCoh$.

\begin{lemma}
\label{lemma-Rlim-quasi-coherent}
Let $X$ be a scheme. Let $(K_n)$ be an inverse system of
$D_\QCoh(\mathcal{O}_X)$ such that the maps $H^q(K_{n + 1}) \to H^q(K_n)$
are surjective for all $q \in \mathbf{Z}$ and $n \geq 1$.
Then the derived limit $K = R\lim K_n$ in $D(\mathcal{O}_X)$ has cohomology
sheaves $H^q(K) = \lim H^q(K_n)$. Moreover, $R\lim H^q(K_n) = \lim H^q(K_n)$.
\end{lemma}

\begin{proof}
This follows from Cohomology, Lemma
\ref{cohomology-lemma-derived-limit-suitable-system}.
Namely, let $\mathcal{B}$ be the set of affine opens of $X$.
The vanishing (2)(a) follows from
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
The vanishing (2)(b) of $R^1\lim$ follows because the transition maps
$H^0(U, H^q(K_{n + 1})) \to H^0(U, H^q(K_n))$ are surjective
for affine open subschemes of $X$ by
Schemes, Lemma \ref{schemes-lemma-equivalence-quasi-coherent}.
\end{proof}

\noindent
The following lemma will help us to ``compute'' a right derived functor
on an object of $D_\QCoh(\mathcal{O}_X)$.

\begin{lemma}
\label{lemma-nice-K-injective}
Let $X$ be a scheme. Let $E$ be an object of
$D_\QCoh(\mathcal{O}_X)$. Then the canonical map
$E \to R\lim \tau_{\geq -n}E$ is an isomorphism\footnote{In particular,
$E$ has a K-injective representative as in
Cohomology, Lemma \ref{cohomology-lemma-K-injective}.}.
\end{lemma}

\begin{proof}
Denote $\mathcal{H}^i = H^i(E)$ the $i$th cohomology sheaf of $E$.
Let $\mathcal{B}$ be the set of affine open subsets of $X$. Then
$H^p(U, \mathcal{H}^i) = 0$ for all $p > 0$, all $i \in \mathbf{Z}$,
and all $U \in \mathcal{B}$, see
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
Thus the lemma follows from
Cohomology, Lemma \ref{cohomology-lemma-is-limit}.
\end{proof}

\begin{lemma}
\label{lemma-application-nice-K-injective}
Let $X$ be a scheme. Let $F : \textit{Mod}(\mathcal{O}_X) \to \textit{Ab}$
be an additive functor and $N \geq 0$ an integer. Assume that
\begin{enumerate}
\item $F$ commutes with countable direct products,
\item $R^pF(\mathcal{F}) = 0$ for all $p \geq N$ and $\mathcal{F}$
quasi-coherent.
\end{enumerate}
Then for $E \in D_\QCoh(\mathcal{O}_X)$ the maps
$R^pF(E) \to R^pF(\tau_{\geq p - N + 1}E)$ are isomorphisms.
\end{lemma}

\begin{proof}
By shifting the complex we see it suffices to prove the assertion for $p = 0$.
Write $E_n = \tau_{\geq -n}E$. We have $E = R\lim E_n$, see
for $p = 0$. Write $E_n = \tau_{\geq -n}E$. We have $E = R\lim E_n$, see
Lemma \ref{lemma-nice-K-injective}. Thus
$RF(E) = R\lim RF(E_n)$ in $D(\textit{Ab})$ by Injectives, Lemma
\ref{injectives-lemma-RF-commutes-with-Rlim}. Thus we have a short
exact sequence
$$
0 \to R^1\lim R^{-1}F(E_n) \to R^0F(E) \to \lim R^0F(E_n) \to 0
$$
see More on Algebra, Remark
\ref{more-algebra-remark-compare-derived-limit}.
To finish the proof we will show that the term on the left is zero
and that the term on the right equals $R^0F(E_{N - 1})$.

\medskip\noindent
We have a distinguished triangle
$$
H^{-n}(E)[n] \to E_n \to E_{n - 1} \to H^{-n}(E)[n + 1]
$$
(Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle})
in $D(\mathcal{O}_X)$. Since $H^{-n}(E)$ is quasi-coherent we have
$$
R^pF(H^{-n}(E)[n]) = R^{p + n}F(H^{-n}(E)) = 0
$$
for $p + n \geq N$ and
$$
R^pF(H^{-n}(E)[n + 1]) = R^{p + n + 1}F(H^{-n}(E)) = 0
$$
for $p + n + 1 \geq N$. We conclude that
$$
R^pF(E_n) \to R^pF(E_{n - 1})
$$
is an isomorphism for all $n \gg p$ and an isomorphism for
$n \geq N$ for $p = 0$. Thus the systems $R^pF(E_n)$ all
satisfy the ML condition and $R^1\lim$ gives zero (see discussion
in More on Algebra, Section \ref{more-algebra-section-Rlim}).
Moreover, the system $R^0F(\tau_{\geq - n}E)$ is constant starting
with $n = N - 1$ as desired.
\end{proof}

\noindent
The following lemma is the key ingredient to many of the
results in this chapter.

\begin{lemma}
\label{lemma-affine-compare-bounded}
Let $X = \Spec(A)$ be an affine scheme. All the functors in the diagram
$$
\xymatrix{
D(\QCoh(\mathcal{O}_X)) \ar[rr]_{(\ref{equation-compare})}
& &
D_\QCoh(\mathcal{O}_X) \ar[ld]^{R\Gamma(X, -)} \\
& D(A) \ar[lu]^{\widetilde{\ \ }}
}
$$
are equivalences of triangulated categories. Moreover, for $E$ in
$D_\QCoh(\mathcal{O}_X)$ we have $H^0(X, E) = H^0(X, H^0(E))$.
\end{lemma}

\begin{proof}
The functor $R\Gamma(X, -)$ gives a functor
$D(\mathcal{O}_X) \to D(A)$ and hence by restriction a functor
\begin{equation}
\label{equation-back}
R\Gamma(X, -) : D_\QCoh(\mathcal{O}_X) \longrightarrow D(A).
\end{equation}
We will show this functor is quasi-inverse to (\ref{equation-compare})
via the equivalence between quasi-coherent modules on $X$ and
the category of $A$-modules.

\medskip\noindent
Elucidation. Denote $(Y, \mathcal{O}_Y)$ the one point space with sheaf
of rings given by $A$. Denote
$\pi : (X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$
the obvious morphism of ringed spaces.
Then $R\Gamma(X, -)$ can be identified with $R\pi_*$ and the functor
(\ref{equation-compare}) via the equivalence
$\textit{Mod}(\mathcal{O}_Y) = \text{Mod}_A = \QCoh(\mathcal{O}_X)$
can be identified with $L\pi^* = \pi^* = \widetilde{\ }$ (see
Modules, Lemma \ref{modules-lemma-construct-quasi-coherent-sheaves} and
Schemes, Lemmas \ref{schemes-lemma-compare-constructions} and
\ref{schemes-lemma-equivalence-quasi-coherent}). Thus the functors
$$
\xymatrix{
D(A) \ar@<1ex>[r] & D_\QCoh(\mathcal{O}_X) \ar@<1ex>[l]
}
$$
are adjoint (by Cohomology, Lemma \ref{cohomology-lemma-adjoint}). In
particular we obtain canonical adjunction mappings
$$
a : \widetilde{R\Gamma(X, E)} \longrightarrow E
$$
for $E$ in $D(\mathcal{O}_X)$ and
$$
b : M^\bullet \longrightarrow R\Gamma(X, \widetilde{M^\bullet})
$$
for $M^\bullet$ a complex of $A$-modules.

\medskip\noindent
Let $E$ be an object of $D_\QCoh(\mathcal{O}_X)$. We may apply
Lemma \ref{lemma-application-nice-K-injective}
to the functor $F(-) = \Gamma(X, -)$
with $N = 1$ by Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
Hence
$$
R^0\Gamma(X, E) = R^0\Gamma(X, \tau_{\geq 0}E) = \Gamma(X, H^0(E))
$$
(the last equality by definition of the canonical truncation).
Using this we will show that the adjunction mappings $a$ and $b$
induce isomorphisms $H^0(a)$ and $H^0(b)$. Thus $a$ and $b$
are quasi-isomorphisms (as the statement is invariant under shifts)
and the lemma is proved.

\medskip\noindent
In both cases we use that $\widetilde{\ }$ is an exact functor
(Schemes, Lemma \ref{schemes-lemma-spec-sheaves}). Namely, this
implies that
$$
H^0\left(\widetilde{R\Gamma(X, E)}\right) = \widetilde{R^0\Gamma(X, E)}
= \widetilde{\Gamma(X, H^0(E))}
$$
which is equal to $H^0(E)$ because $H^0(E)$ is quasi-coherent. Thus
$H^0(a)$ is an isomorphism. For the other direction we have
$$
H^0(R\Gamma(X, \widetilde{M^\bullet})) =
R^0\Gamma(X, \widetilde{M^\bullet}) =
\Gamma(X, H^0(\widetilde{M^\bullet})) =
\Gamma(X, \widetilde{H^0(M^\bullet)}) = H^0(M^\bullet)
$$
which proves that $H^0(b)$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-affine-K-flat}
Let $X = \Spec(A)$ be an affine scheme. If $K^\bullet$ is a K-flat
complex of $A$-modules, then $\widetilde{K^\bullet}$ is a K-flat
complex of $\mathcal{O}_X$-modules.
\end{lemma}

\begin{proof}
By More on Algebra, Lemma \ref{more-algebra-lemma-base-change-K-flat}
we see that $K^\bullet \otimes_A A_\mathfrak p$ is a K-flat complex
of $A_\mathfrak p$-modules for every $\mathfrak p \in \Spec(A)$.
Hence we conclude from
Cohomology, Lemma \ref{cohomology-lemma-check-K-flat-stalks}
(and
Schemes, Lemma \ref{schemes-lemma-spec-sheaves})
that $\widetilde{K^\bullet}$ is K-flat.
\end{proof}

\begin{lemma}
\label{lemma-quasi-coherence-pullback}
Let $f : Y \to X$ be a morphism of schemes.
\begin{enumerate}
\item The functor $Lf^*$ sends $D_\QCoh(\mathcal{O}_X)$
into $D_\QCoh(\mathcal{O}_Y)$.
\item If $X$ and $Y$ are affine and $f$ is given by the ring map
$A \to B$, then the diagram
$$
\xymatrix{
D(B) \ar[r] & D_\QCoh(\mathcal{O}_Y) \\
D(A) \ar[r] \ar[u]^{- \otimes_A^\mathbf{L} B} &
D_\QCoh(\mathcal{O}_X) \ar[u]_{Lf^*}
}
$$
commutes.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove the diagram
$$
\xymatrix{
D(B) \ar[r] & D(\mathcal{O}_Y) \\
D(A) \ar[r] \ar[u]^{- \otimes_A^\mathbf{L} B} &
D(\mathcal{O}_X) \ar[u]_{Lf^*}
}
$$
commutes. This is clear from Lemma \ref{lemma-affine-K-flat} and
the constructions of the functors in question. To see (1) let
$E$ be an object of $D_\QCoh(\mathcal{O}_X)$. To see that
$Lf^*E$ has quasi-coherent cohomology sheaves we may work locally on $X$.
Note that $Lf^*$ is compatible with restricting to open subschemes.
Hence we can assume that $f$ is a morphism of affine schemes as in (2).
Then we can apply Lemma \ref{lemma-affine-compare-bounded} to see that
$E$ comes from a complex of $A$-modules. By the commutativity of the first
diagram of the proof the same holds for $Lf^*E$ and we conclude (1) is true.
\end{proof}

\begin{lemma}
\label{lemma-quasi-coherence-tensor-product}
Let $X$ be a scheme.
\begin{enumerate}
\item For objects $K, L$ of $D_\QCoh(\mathcal{O}_X)$
the derived tensor product $K \otimes^\mathbf{L}_{\mathcal{O}_X} L$ is in
$D_\QCoh(\mathcal{O}_X)$.
\item If $X = \Spec(A)$ is affine then
$$
\widetilde{M^\bullet} \otimes_{\mathcal{O}_X}^\mathbf{L} \widetilde{K^\bullet}
=
\widetilde{M^\bullet \otimes_A^\mathbf{L} K^\bullet}
$$
for any pair of complexes of $A$-modules $K^\bullet$, $M^\bullet$.
\end{enumerate}
\end{lemma}

\begin{proof}
The equality of (2) follows immediately from Lemma \ref{lemma-affine-K-flat}
and the construction of the derived tensor product.
To see (1) let $K, L$ be objects of $D_\QCoh(\mathcal{O}_X)$.
To check that $K \otimes^\mathbf{L} L$ is in
$D_\QCoh(\mathcal{O}_X)$ we may work locally on $X$, hence
we may assume $X = \Spec(A)$ is affine. By
Lemma \ref{lemma-affine-compare-bounded} we may represent
$K$ and $L$ by complexes of $A$-modules. Then part (2) implies
the result.
\end{proof}





\section{Total direct image}
\label{section-total-direct-image}

\noindent
The following lemma is the analogue of
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images}.

\begin{lemma}
\label{lemma-quasi-coherence-direct-image}
Let $f : X \to S$ be a morphism of schemes.
Assume that $f$ is quasi-separated and quasi-compact.
\begin{enumerate}
\item The functor $Rf_*$ sends $D_\QCoh(\mathcal{O}_X)$
into $D_\QCoh(\mathcal{O}_S)$.
\item If $S$ is quasi-compact, there exists an integer $N = N(X, S, f)$
such that for an object $E$ of $D_\QCoh(\mathcal{O}_X)$
with $H^m(E) = 0$ for $m > 0$ we have
$H^m(Rf_*E) = 0$ for $m \geq N$.
\item In fact, if $S$ is quasi-compact we can find $N = N(X, S, f)$
such that for every morphism of schemes $S' \to S$
the same conclusion holds for the functor $R(f')_*$
where $f' : X' \to S'$ is the base change of $f$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $E$ be an object of $D_\QCoh(\mathcal{O}_X)$. To prove (1) we have to
show that $Rf_*E$ has quasi-coherent cohomology sheaves. The question is local
on $S$, hence we may assume $S$ is quasi-compact. Pick $N = N(X, S, f)$ as in
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images}.
Thus $R^pf_*\mathcal{F} = 0$ for all quasi-coherent $\mathcal{O}_X$-modules
$\mathcal{F}$ and all $p \geq N$ and the same remains true after base change.

\medskip\noindent
First, assume $E$ is bounded below. We will show (1) and (2) and (3) hold
for such $E$ with our choice of $N$. In this case we can for example use the
spectral sequence
$$
R^pf_*H^q(E) \Rightarrow R^{p + q}f_*E
$$
(Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}),
the quasi-coherence of $R^pf_*H^q(E)$, and the vanishing of $R^pf_*H^q(E)$
for $p \geq N$ to see that (1), (2), and (3) hold in this case.

\medskip\noindent
Next we prove (2) and (3). Say $H^m(E) = 0$ for $m > 0$.
Let $U \subset S$ be affine open. By Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images-application}
and our choice of $N$
we have $H^p(f^{-1}(U), \mathcal{F}) = 0$ for $p \geq N$
and any quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$.
Hence we may apply Lemma \ref{lemma-application-nice-K-injective}
to the functor $\Gamma(f^{-1}(U), -)$ to see that
$$
R\Gamma(U, Rf_*E) = R\Gamma(f^{-1}(U), E)
$$
has vanishing cohomology in degrees $\geq N$. Since this holds for
all $U \subset S$ affine open we conclude that $H^m(Rf_*E) = 0$
for $m \geq N$.

\medskip\noindent
Next, we prove (1) in the general case. Recall that there is a
distinguished triangle
$$
\tau_{\leq -n - 1}E \to E \to \tau_{\geq -n}E \to
(\tau_{\leq -n - 1}E)[1]
$$
in $D(\mathcal{O}_X)$, see Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle}.
By (2) we see that $Rf_*\tau_{\leq -n - 1}E$
has vanishing cohomology sheaves in degrees $\geq -n + N$.
Thus, given an integer $q$ we see that $R^qf_*E$ is equal
to $R^qf_*\tau_{\geq -n}E$ for some $n$ and the result
above applies.
\end{proof}

\begin{lemma}
\label{lemma-quasi-coherence-pushforward-direct-sums}
Let $f : X \to S$ be a quasi-separated and quasi-compact morphism of
schemes. Then
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_S)$
commutes with direct sums.
\end{lemma}

\begin{proof}
Let $E_i$ be a family of objects of $D_\QCoh(\mathcal{O}_X)$
and set $E = \bigoplus E_i$. We want to show that the map
$$
\bigoplus Rf_*E_i \longrightarrow Rf_*E
$$
is an isomorphism. We will show it induces an isomorphism on
cohomology sheaves in degree $0$ which will imply the lemma.
Choose an integer $N$ as in Lemma \ref{lemma-quasi-coherence-direct-image}.
Then $R^0f_*E = R^0f_*\tau_{\geq -N}E$ and
$R^0f_*E_i = R^0f_*\tau_{\geq -N}E_i$ by the lemma cited. Observe that
$\tau_{\geq -N}E = \bigoplus \tau_{\geq -N}E_i$.
Thus we may assume all of the $E_i$ have vanishing cohomology
sheaves in degrees $< -N$. Next we use the spectral sequences
$$
R^pf_*H^q(E) \Rightarrow R^{p + q}f_*E
\quad\text{and}\quad
R^pf_*H^q(E_i) \Rightarrow R^{p + q}f_*E_i
$$
(Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor})
to reduce to the case of a direct sum of quasi-coherent sheaves.
This case is handled by
Cohomology of Schemes, Lemma \ref{coherent-lemma-colimit-cohomology}.
\end{proof}









\section{Affine morphisms}
\label{section-affine-morphisms}

\noindent
In this section we collect some information about pushforward
along an affine morphism of schemes.

\begin{lemma}
\label{lemma-affine-morphism}
Let $f : X \to S$ be an affine morphism of schemes.
Then
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_S)$
reflects isomorphisms.
\end{lemma}

\begin{proof}
The statement means that a morphism $\alpha : E \to F$ of
$D_\QCoh(\mathcal{O}_X)$ is an isomorphism if
$Rf_*\alpha$ is an isomorphism. We may check this on cohomology sheaves.
In particular, the question is local on $S$. Hence we may assume $S$
and therefore $X$ is affine. In this case the statement is clear from
the description of the derived categories
$D_\QCoh(\mathcal{O}_X)$ and
$D_\QCoh(\mathcal{O}_S)$ given in
Lemma \ref{lemma-affine-compare-bounded}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-affine-morphism-pull-push}
Let $f : X \to S$ be an affine morphism of schemes.
For $E$ in $D_\QCoh(\mathcal{O}_S)$ we have
$Rf_* Lf^* E = E \otimes^\mathbf{L}_{\mathcal{O}_S} f_*\mathcal{O}_X$.
\end{lemma}

\begin{proof}
Since $f$ is affine the map $f_*\mathcal{O}_X \to Rf_*\mathcal{O}_X$
is an isomorphism
(Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-vanishing}).
There is a canonical map $E \otimes^\mathbf{L} f_*\mathcal{O}_X =
E \otimes^\mathbf{L} Rf_*\mathcal{O}_X \to Rf_* Lf^* E$
adjoint to the map
$$
Lf^*(E \otimes^\mathbf{L} Rf_*\mathcal{O}_X) =
Lf^*E \otimes^\mathbf{L} Lf^*Rf_*\mathcal{O}_X \longrightarrow
Lf^* E \otimes^\mathbf{L} \mathcal{O}_X = Lf^* E
$$
coming from $1 : Lf^*E \to Lf^*E$ and the canonical map
$Lf^*Rf_*\mathcal{O}_X \to \mathcal{O}_X$. To check the map so constructed
is an isomorphism we may work locally on $S$. Hence we may assume
$S$ and therefore $X$ is affine. In this case the statement is clear from
the description of the derived categories
$D_\QCoh(\mathcal{O}_X)$ and
$D_\QCoh(\mathcal{O}_S)$ and the functor $Lf^*$ given in
Lemmas \ref{lemma-affine-compare-bounded} and
\ref{lemma-quasi-coherence-pullback}.
Some details omitted.
\end{proof}

\noindent
Let $Y$ be a scheme. Let $\mathcal{A}$ be a sheaf of $\mathcal{O}_Y$-algebras.
We will denote $D_\QCoh(\mathcal{A})$ the inverse image of
$D_\QCoh(\mathcal{O}_X)$ under the restriction functor
$D(\mathcal{A}) \to D(\mathcal{O}_X)$. In other words, $K \in D(\mathcal{A})$
is in $D_\QCoh(\mathcal{A})$ if and only if its cohomology sheaves are
quasi-coherent as $\mathcal{O}_X$-modules. If $\mathcal{A}$ is quasi-coherent
itself this is the same as asking the cohomology sheaves to be quasi-coherent
as $\mathcal{A}$-modules, see
Morphisms, Lemma \ref{morphisms-lemma-affine-equivalence-modules}.

\begin{lemma}
\label{lemma-affine-morphism-equivalence}
Let $f : X \to Y$ be an affine morphism of schemes. Then $f_*$ induces
an equivalence
$$
\Phi : D_\QCoh(\mathcal{O}_X) \longrightarrow D_\QCoh(f_*\mathcal{O}_X)
$$
whose composition with $D_\QCoh(f_*\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$
is $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
Recall that $Rf_*$ is computed on an object $K \in D_\QCoh(\mathcal{O}_X)$
by choosing a K-injective complex $\mathcal{I}^\bullet$ of
$\mathcal{O}_X$-modules representing $K$ and taking $f_*\mathcal{I}^\bullet$.
Thus we let $\Phi(K)$ be the complex $f_*\mathcal{I}^\bullet$
viewed as a complex of $f_*\mathcal{O}_X$-modules.
Denote $g : (X, \mathcal{O}_X) \to (Y, f_*\mathcal{O}_X)$ the
obvious morphism of ringed spaces. Then $g$ is a flat morphism of
ringed spaces (see below for a description of the stalks) and
$\Phi$ is the restriction of $Rg_*$ to $D_\QCoh(\mathcal{O}_X)$.
We claim that $Lg^*$ is a quasi-inverse. First, observe that
$Lg^*$ sends $D_\QCoh(f_*\mathcal{O}_X)$ into $D_\QCoh(\mathcal{O}_X)$
because $g^*$ transforms quasi-coherent modules into quasi-coherent
modules (Modules, Lemma \ref{modules-lemma-pullback-quasi-coherent}).
To finish the proof it suffices to show that
the adjunction mappings
$$
Lg^*\Phi(K) = Lg^*Rg_*K \to K
\quad\text{and}\quad
M \to Rg_*Lg^*M = \Phi(Lg^*M)
$$
are isomorphisms for $K \in D_\QCoh(\mathcal{O}_X)$ and
$M \in D_\QCoh(f_*\mathcal{O}_X)$. This is a local question, hence
we may assume $Y$ and therefore $X$ are affine.

\medskip\noindent
Assume $Y = \Spec(B)$ and $X = \Spec(A)$. Let
$\mathfrak p = x \in \Spec(A) = X$ be a point mapping to
$\mathfrak q = y \in \Spec(B) = Y$. Then
$(f_*\mathcal{O}_X)_y = A_\mathfrak q$ and $\mathcal{O}_{X, x} = A_\mathfrak p$
hence $g$ is flat. Hence $g^*$ is exact and $H^i(Lg^*M) = g^*H^i(M)$
for any $M$ in $D(f_*\mathcal{O}_X)$.
For $K \in D_\QCoh(\mathcal{O}_X)$ we see that
$$
H^i(\Phi(K)) = H^i(Rf_*K) = f_*H^i(K)
$$
by the vanishing of higher direct images
(Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-vanishing})
and Lemma \ref{lemma-application-nice-K-injective}.
Thus it suffice to show that
$$
g^*g_*\mathcal{F} \to \mathcal{F}
\quad\text{and}\quad
\mathcal{G} \to g_*g^*\mathcal{F}
$$
are isomorphisms where $\mathcal{F}$ is
a quasi-coherent $\mathcal{O}_X$-module and $\mathcal{G}$ is
a quasi-coherent $f_*\mathcal{O}_X$-module. This follows from
Morphisms, Lemma \ref{morphisms-lemma-affine-equivalence-modules}.
\end{proof}





\section{Derived category of coherent modules}
\label{section-derived-coherent}

\noindent
Let $X$ be a locally Noetherian scheme. In this case the category
$\textit{Coh}(\mathcal{O}_X) \subset \textit{Mod}(\mathcal{O}_X)$
of coherent $\mathcal{O}_X$-modules is a weak Serre subcategory, see
Homology, Section \ref{homology-section-serre-subcategories}
and
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.
Denote
$$
D_{\textit{Coh}}(\mathcal{O}_X) \subset D(\mathcal{O}_X)
$$
the subcategory of complexes whose cohomology sheaves are coherent, see
Derived Categories, Section \ref{derived-section-triangulated-sub}.
Thus we obtain a canonical functor
\begin{equation}
\label{equation-compare-coherent}
D(\textit{Coh}(\mathcal{O}_X))
\longrightarrow
D_{\textit{Coh}}(\mathcal{O}_X)
\end{equation}
see Derived Categories, Equation (\ref{derived-equation-compare}).

\begin{lemma}
\label{lemma-direct-image-coherent}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E$ be an object of
$D^b_{\textit{Coh}}(\mathcal{O}_X)$ such that the scheme theoretic support
of $H^i(E)$ is proper over $S$ for all $i$.
Then $Rf_*E$ is an object of $D^b_{\textit{Coh}}(\mathcal{O}_S)$.
\end{lemma}

\begin{proof}
Consider the spectral sequence
$$
R^pf_*H^q(E) \Rightarrow R^{p + q}f_*E
$$
see Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
By assumption and
Cohomology of Schemes, Remark
\ref{coherent-remark-scheme-theoretic-support-proper}
the sheaves $R^pf_*H^q(E)$ are coherent. Hence
$R^{p + q}f_*E$ is coherent, i.e., $E \in D_{\textit{Coh}}(\mathcal{O}_S)$.
Boundedness from below is trivial. Boundedness from above
follows from
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images}
or from
Lemma \ref{lemma-quasi-coherence-direct-image}.
\end{proof}








\section{The coherator}
\label{section-coherator}

\noindent
Let $X$ be a scheme. The {\it coherator} is a functor
$$
Q_X :
\textit{Mod}(\mathcal{O}_X)
\longrightarrow
\QCoh(\mathcal{O}_X)
$$
which is right adjoint to the inclusion functor
$\QCoh(\mathcal{O}_X) \to \textit{Mod}(\mathcal{O}_X)$.
It exists for any scheme $X$ and moreover the adjunction mapping
$Q_X(\mathcal{F}) \to \mathcal{F}$ is an isomorphism for every
quasi-coherent module $\mathcal{F}$, see
Properties, Proposition \ref{properties-proposition-coherator}.
Since $Q_X$ is left exact (as a right adjoint) we can consider its
right derived extension
$$
RQ_X :
D(\mathcal{O}_X)
\longrightarrow
D(\QCoh(\mathcal{O}_X)).
$$
As this functor is constructed by applying $Q_X$ to a K-injective replacement
we see that $RQ_X$ is a right adjoint to the canonical functor
$D(\QCoh(\mathcal{O}_X)) \to D(\mathcal{O}_X)$.

\begin{lemma}
\label{lemma-affine-pushforward}
Let $f : X \to Y$ be an affine morphism of schemes.
Then $f_*$ defines a derived functor
$f_* : D(\QCoh(\mathcal{O}_X)) \to D(\QCoh(\mathcal{O}_Y))$.
This functor has the property that
$$
\xymatrix{
D(\QCoh(\mathcal{O}_X)) \ar[d]_{f_*} \ar[r] &
D_\QCoh(\mathcal{O}_X) \ar[d]^{Rf_*} \\
D(\QCoh(\mathcal{O}_Y)) \ar[r] &
D_\QCoh(\mathcal{O}_Y)
}
$$
commutes.
\end{lemma}

\begin{proof}
The functor
$f_* : \QCoh(\mathcal{O}_X) \to \QCoh(\mathcal{O}_Y)$
is exact, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-vanishing}.
Hence $f_*$ defines a derived functor
$f_* : D(\QCoh(\mathcal{O}_X)) \to D(\QCoh(\mathcal{O}_Y))$
by simply applying $f_*$ to any representative complex, see
Derived Categories, Lemma \ref{derived-lemma-right-derived-exact-functor}.
For any complex of $\mathcal{O}_X$-modules
$\mathcal{F}^\bullet$ there is a canonical map
$f_*\mathcal{F}^\bullet \to Rf_*\mathcal{F}^\bullet$.
To finish the proof we show this is a quasi-isomorphism when
$\mathcal{F}^\bullet$ is a complex with each $\mathcal{F}^n$
quasi-coherent. As the statement is invariant under shifts it
suffices to show that
$H^0(f_*(\mathcal{F}^\bullet)) \to R^0f_*\mathcal{F}^\bullet$
is an isomorphism. The statement is local on $Y$ hence we
may assume $Y$ affine. By
Lemma \ref{lemma-quasi-coherence-direct-image}
we have $R^0f_*\mathcal{F}^\bullet = R^0f_*\tau_{\geq -n}\mathcal{F}^\bullet$
for all sufficiently large $n$. Thus we may assume $\mathcal{F}^\bullet$
bounded below. As each $\mathcal{F}^n$ is $f_*$-acyclic by
Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-vanishing}
we see that
$f_*\mathcal{F}^\bullet \to Rf_*\mathcal{F}^\bullet$
is a quasi-isomorphism by
Leray's acyclicity lemma (Derived Categories, Lemma
\ref{derived-lemma-leray-acyclicity}).
\end{proof}

\begin{lemma}
\label{lemma-flat-pushforward-coherator}
Let $f : X \to Y$ be a morphism of schemes. Assume that
\begin{enumerate}
\item $f$ is quasi-compact, quasi-separated, and flat, and
\item denoting
$$
\Phi : D(\QCoh(\mathcal{O}_X)) \to D(\QCoh(\mathcal{O}_Y))
$$
the right derived functor of
$f_* : \QCoh(\mathcal{O}_X) \to \QCoh(\mathcal{O}_Y)$
the diagram
$$
\xymatrix{
D(\QCoh(\mathcal{O}_X)) \ar[d]_\Phi \ar[r] &
D_\QCoh(\mathcal{O}_X) \ar[d]^{Rf_*} \\
D(\QCoh(\mathcal{O}_Y)) \ar[r] &
D_\QCoh(\mathcal{O}_Y)
}
$$
commutes.
\end{enumerate}
Then $RQ_Y \circ Rf_* = \Phi \circ RQ_X$.
\end{lemma}

\begin{proof}
Since $f$ is quasi-compact and quasi-separated, we see that
$f_*$ preserve quasi-coherence, see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.
Recall that $\QCoh(\mathcal{O}_X)$ is a Grothendieck abelian category
(Properties, Proposition \ref{properties-proposition-coherator}).
Hence any $K$ in $D(\QCoh(\mathcal{O}_X))$
can be represented by a K-injective complex $\mathcal{I}^\bullet$
of $\QCoh(\mathcal{O}_X)$, see
Injectives, Theorem
\ref{injectives-theorem-K-injective-embedding-grothendieck}.
Then we can define $\Phi(K) = f_*\mathcal{I}^\bullet$.

\medskip\noindent
Since $f$ is flat, the functor $f^*$ is exact. Hence $f^*$ defines
$f^* : D(\mathcal{O}_Y) \to D(\mathcal{O}_X)$ and also
$f^* : D(\QCoh(\mathcal{O}_Y)) \to D(\QCoh(\mathcal{O}_X))$.
The functor $f^* = Lf^* : D(\mathcal{O}_Y) \to D(\mathcal{O}_X)$
is left adjoint to
$Rf_* : D(\mathcal{O}_X) \to D(\mathcal{O}_Y)$,
see Cohomology, Lemma \ref{cohomology-lemma-adjoint}.
Similarly, the functor
$f^* : D(\QCoh(\mathcal{O}_Y)) \to D(\QCoh(\mathcal{O}_X))$
is left adjoint to
$\Phi : D(\QCoh(\mathcal{O}_X)) \to D(\QCoh(\mathcal{O}_Y))$
by Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.

\medskip\noindent
Let $A$ be an object of $D(\QCoh(\mathcal{O}_Y))$ and
$E$ an object of $D(\mathcal{O}_X)$. Then
\begin{align*}
\Hom_{D(\QCoh(\mathcal{O}_Y))}(A, RQ_Y(Rf_*E))
& =
\Hom_{D(\mathcal{O}_Y)}(A, Rf_*E) \\
& =
\Hom_{D(\mathcal{O}_X)}(f^*A, E) \\
& =
\Hom_{D(\QCoh(\mathcal{O}_X))}(f^*A, RQ_X(E)) \\
& =
\Hom_{D(\QCoh(\mathcal{O}_Y))}(A, \Phi(RQ_X(E)))
\end{align*}
This implies what we want.
\end{proof}

\begin{lemma}
\label{lemma-affine-coherator}
Let $X = \Spec(A)$ be an affine scheme. Then
\begin{enumerate}
\item $Q_X : \textit{Mod}(\mathcal{O}_X) \to \QCoh(\mathcal{O}_X)$
is the functor
which sends $\mathcal{F}$ to the quasi-coherent $\mathcal{O}_X$-module
associated to the $A$-module $\Gamma(X, \mathcal{F})$,
\item $RQ_X : D(\mathcal{O}_X) \to D(\QCoh(\mathcal{O}_X))$
is the functor which sends $E$ to the complex of quasi-coherent
$\mathcal{O}_X$-modules associated to the object $R\Gamma(X, E)$ of $D(A)$,
\item restricted to $D_\QCoh(\mathcal{O}_X)$ the functor
$RQ_X$ defines a quasi-inverse to (\ref{equation-compare}).
\end{enumerate}
\end{lemma}

\begin{proof}
The functor $Q_X$ is the functor
$$
\mathcal{F} \mapsto \widetilde{\Gamma(X, \mathcal{F})}
$$
by Schemes, Lemma \ref{schemes-lemma-compare-constructions}.
This immediately implies (1) and (2). The third assertion
follows from (the proof of)
Lemma \ref{lemma-affine-compare-bounded}.
\end{proof}

\begin{definition}
\label{definition-supported-on}
Let $X$ be a scheme. Let $E$ be an object of $D(\mathcal{O}_X)$.
Let $T \subset X$ be a closed subset.
We say $E$ is {\it supported on $T$} if the
cohomology sheaves $H^i(E)$ are supported on $T$.
\end{definition}

\begin{proposition}
\label{proposition-quasi-compact-affine-diagonal}
Let $X$ be a quasi-compact scheme with affine diagonal.
Then the functor (\ref{equation-compare})
$$
D(\QCoh(\mathcal{O}_X))
\longrightarrow
D_\QCoh(\mathcal{O}_X)
$$
is an equivalence with quasi-inverse given by $RQ_X$.
\end{proposition}

\begin{proof}
In this proof we will denote $i_X : D(\QCoh(\mathcal{O}_X))
\to D_\QCoh(\mathcal{O}_X)$ the functor of the lemma.
Let $E$ be an object of $D_\QCoh(\mathcal{O}_X)$ and
let $A$ be an object of $D(\QCoh(\mathcal{O}_X))$.
We have to show that the adjunction maps
$$
RQ_X(i_X(A)) \to A
\quad\text{and}\quad
E \to i_X(RQ_X(E))
$$
are isomorphisms. We will prove this by induction on $n$:
the smallest integer $n \geq 0$ such that $E$ and $i_X(A)$
are supported on a closed subset of $X$ which
is contained in the union of $n$ affine opens of $X$.

\medskip\noindent
Base case: $n = 0$. In this case $E = 0$, hence the map
$E \to i_X(RQ_X(E))$ is an isomorphism. Similarly $i_X(A) = 0$.
Thus the cohomology sheaves of $i_X(A)$ are zero. Since the inclusion
functor $\QCoh(\mathcal{O}_X) \to \textit{Mod}(\mathcal{O}_X)$
is fully faithful and exact, we conclude that the cohomology
objects of $A$ are zero, i.e., $A = 0$ and
$RQ_X(i_X(A)) \to A$ is an isomorphism as well.

\medskip\noindent
Induction step. Suppose that $E$ and $i_X(A)$ are supported on a
closed subset $T$ of $X$ contained in $U_1 \cup \ldots \cup U_n$
with $U_i \subset X$ affine open. Set $U = U_n$. The inclusion morphism
$j : U \to X$ is flat and affine
(Morphisms, Lemma \ref{morphisms-lemma-affine-permanence}).
Consider the distinguished triangles
$$
A \to j_*(A|_U) \to A' \to A[1]
\quad\text{and}\quad
E \to Rj_*(E|_U) \to E' \to E[1]
$$
where $j_*$ is as in Lemma \ref{lemma-affine-pushforward}.
Note that $E \to Rj_*(E|_U)$ is a quasi-isomorphism over $U = U_n$.
Since $i_X \circ j_* = Rj_* \circ i_U$ by Lemma \ref{lemma-affine-pushforward}
and since $i_X(A)|_U = i_U(A|_U)$
we see that $i_X(A) \to i_X(j_*(A|_U))$ is a quasi-isomorphism over $U$.
Hence $i_X(A')$ and $E'$ are supported on the closed
subset $T \setminus U$ of $X$ which is contained in
$U_1 \cup \ldots \cup U_{n - 1}$.
By induction hypothesis the statement is true for $A'$ and $E'$. By
Derived Categories, Lemma \ref{derived-lemma-third-isomorphism-triangle}
it suffices to prove the maps
$$
RQ_X(i_X(j_*(A|_U))) \to j_*(A|_U)
\quad\text{and}\quad
Rj_*(E|_U) \to i_X(RQ_X(Rj_*E|_U))
$$
are isomorphisms. By
Lemmas \ref{lemma-affine-pushforward} and
\ref{lemma-flat-pushforward-coherator} we have
$$
RQ_X(i_X(j_*(A|_U))) = RQ_X(Rj_*(i_U(A|_U))) = j_*RQ_U(i_U(A|_U))
$$
and
$$
i_X(RQ_X(Rj_*(E|_U))) = i_X(j_*RQ_U(E|_U)) = Rj_*(i_U(RQ_U(E|_U)))
$$
Finally, the maps
$$
RQ_U(i_U(A|_U)) \to A|_U
\quad\text{and}\quad
E|_U \to i_U(RQ_U(E|_U))
$$
are isomorphisms by Lemma \ref{lemma-affine-coherator}. The result follows.
\end{proof}

\begin{remark}
\label{remark-argument-proves}
Analyzing the proof of
Proposition \ref{proposition-quasi-compact-affine-diagonal}
we see that we have shown the following.
Let $X$ be a quasi-compact and quasi-separated scheme. Suppose that
for every affine open $U \subset X$ the right derived functor
$$
\Phi : D(\QCoh(\mathcal{O}_U)) \to D(\QCoh(\mathcal{O}_X))
$$
of the left exact functor
$j_* : \QCoh(\mathcal{O}_U) \to \QCoh(\mathcal{O}_X)$
fits into a commutative diagram
$$
\xymatrix{
D(\QCoh(\mathcal{O}_U)) \ar[d]_\Phi \ar[r]_{i_U} &
D_\QCoh(\mathcal{O}_U) \ar[d]^{Rj_*} \\
D(\QCoh(\mathcal{O}_X)) \ar[r]^{i_X} &
D_\QCoh(\mathcal{O}_X)
}
$$
Then the functor (\ref{equation-compare})
$$
D(\QCoh(\mathcal{O}_X))
\longrightarrow
D_\QCoh(\mathcal{O}_X)
$$
is an equivalence with quasi-inverse given by $RQ_X$.
\end{remark}




\section{The coherator for Noetherian schemes}
\label{section-coherator-Noetherian}

\noindent
In the case of Noetherian schemes we can use the following lemma.

\begin{lemma}
\label{lemma-injective-quasi-coherent-sheaf-Noetherian}
Let $X$ be a Noetherian scheme. Let $\mathcal{J}$ be an injective
object of $\QCoh(\mathcal{O}_X)$. Then $\mathcal{J}$
is a flasque sheaf of $\mathcal{O}_X$-modules.
\end{lemma}

\begin{proof}
Let $U \subset X$ be an open subset and let $s \in \mathcal{J}(U)$
be a section. Let $\mathcal{I} \subset X$ be the quasi-coherent sheaf
of ideals defining the reduced induced scheme structure on $X \setminus U$
(see Schemes, Definition \ref{schemes-definition-reduced-induced-scheme}).
By Cohomology of Schemes, Lemma \ref{coherent-lemma-homs-over-open}
the section $s$ corresponds to a map $\sigma : \mathcal{I}^n \to \mathcal{J}$
for some $n$. As $\mathcal{J}$ is an injective object of
$\QCoh(\mathcal{O}_X)$ we can extend $\sigma$ to a map
$\tilde s : \mathcal{O}_X \to \mathcal{J}$. Then $\tilde s$ corresponds
to a global section of $\mathcal{J}$ restricting to $s$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-pushforward}
Let $f : X \to Y$ be a morphism of Noetherian schemes.
Then $f_*$ on quasi-coherent sheaves has a right derived
extension
$\Phi : D(\QCoh(\mathcal{O}_X)) \to D(\QCoh(\mathcal{O}_Y))$
such that the diagram
$$
\xymatrix{
D(\QCoh(\mathcal{O}_X)) \ar[d]_{\Phi} \ar[r] &
D_\QCoh(\mathcal{O}_X) \ar[d]^{Rf_*} \\
D(\QCoh(\mathcal{O}_Y)) \ar[r] &
D_\QCoh(\mathcal{O}_Y)
}
$$
commutes.
\end{lemma}

\begin{proof}
Since $X$ and $Y$ are Noetherian schemes the morphism is quasi-compact
and quasi-separated (see
Properties, Lemma \ref{properties-lemma-locally-Noetherian-quasi-separated}
and
Schemes, Remark \ref{schemes-remark-quasi-compact-and-quasi-separated}).
Thus $f_*$ preserve quasi-coherence, see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.
Next, Let $K$ be an object of $D(\QCoh(\mathcal{O}_X))$.
Since $\QCoh(\mathcal{O}_X)$ is a Grothendieck abelian category
(Properties, Proposition \ref{properties-proposition-coherator}), we can
represent $K$ by a K-injective complex $\mathcal{I}^\bullet$
such that each $\mathcal{I}^n$ is an injective object of
$\QCoh(\mathcal{O}_X)$, see
Injectives, Theorem
\ref{injectives-theorem-K-injective-embedding-grothendieck}.
Thus we see that the functor $\Phi$ is defined by setting
$$
\Phi(K) = f_*\mathcal{I}^\bullet
$$
where the right hand side is viewed as an object of
$D(\QCoh(\mathcal{O}_Y))$. To finish the proof of the lemma
it suffices to show that the canonical map
$$
f_*\mathcal{I}^\bullet \longrightarrow Rf_*\mathcal{I}^\bullet
$$
is an isomorphism in $D(\mathcal{O}_Y)$. To see this it suffices to
prove the map induces an isomorphism on cohomology sheaves. Pick any
$m \in \mathbf{Z}$. Let $N = N(X, Y, f)$ be as in
Lemma \ref{lemma-quasi-coherence-direct-image}.
Consider the short exact sequence
$$
0 \to \sigma_{\geq m - N - 1}\mathcal{I}^\bullet \to
\mathcal{I}^\bullet \to \sigma_{\leq m - N - 2}\mathcal{I}^\bullet \to 0
$$
of complexes of quasi-coherent sheaves on $X$. By
Lemma \ref{lemma-quasi-coherence-direct-image}
we see that the cohomology sheaves of
$Rf_*\sigma_{\leq m - N - 2}\mathcal{I}^\bullet$
are zero in degrees $\geq m - 1$. Thus we see that
$R^mf_*\mathcal{I}^\bullet$ is isomorphic to
$R^mf_*\sigma_{\geq m - N - 1}\mathcal{I}^\bullet$.
In other words, we may assume that $\mathcal{I}^\bullet$
is a bounded below complex of injective objects of
$\QCoh(\mathcal{O}_X)$.
This follows from
Leray's acyclicity lemma
(Derived Categories, Lemma \ref{derived-lemma-leray-acyclicity})
via
Cohomology, Lemma \ref{cohomology-lemma-flasque-acyclic-pushforward}
and
Lemma \ref{lemma-injective-quasi-coherent-sheaf-Noetherian}.
\end{proof}

\begin{proposition}
\label{proposition-Noetherian}
Let $X$ be a Noetherian scheme. Then the functor (\ref{equation-compare})
$$
D(\QCoh(\mathcal{O}_X))
\longrightarrow
D_\QCoh(\mathcal{O}_X)
$$
is an equivalence with quasi-inverse given by $RQ_X$.
\end{proposition}

\begin{proof}
This follows using the exact same argument as in the proof of
Proposition \ref{proposition-quasi-compact-affine-diagonal}
using Lemma \ref{lemma-Noetherian-pushforward}.
See discussion in Remark \ref{remark-argument-proves}.
\end{proof}






\section{Koszul complexes}
\label{section-koszul}

\noindent
Let $A$ be a ring and let $f_1, \ldots, f_r$ be a sequence of elements
of $A$. We have defined the Koszul complex
$K_\bullet(f_1, \ldots, f_r)$ in
More on Algebra, Definition \ref{more-algebra-definition-koszul-complex}.
It is a chain complex sitting in degrees $r, \ldots, 0$.
We turn this into a cochain complex $K^\bullet(f_1, \ldots, f_r)$
by setting $K^{-n}(f_1, \ldots, f_r) = K_n(f_1, \ldots, f_r)$
and using the same differentials. In the rest of this section all
the complexes will be cochain complexes.

\medskip\noindent
We define a complex $I^\bullet(f_1, \ldots, f_r)$
such that we have a distinguished triangle
$$
I^\bullet(f_1, \ldots, f_r) \to
A \to
K^\bullet(f_1, \ldots, f_r) \to
I^\bullet(f_1, \ldots, f_r)[1]
$$
in $K(A)$.
In other words, we set
$$
I^i(f_1, \ldots, f_r) =
\left\{
\begin{matrix}
K^{i - 1}(f_1, \ldots, f_r) & \text{if } i \leq 0 \\
0 & \text{else}
\end{matrix}
\right.
$$
and we use the negative of the differential on $K^\bullet(f_1, \ldots, f_r)$.
The maps in the distinguished triangle are the obvious ones. Note that
$I^0(f_1, \ldots, f_r) = A^{\oplus r} \to A$ is given by
multiplication by $f_i$ on the $i$th factor.
Hence $I^\bullet(f_1, \ldots, f_r) \to A$ factors as
$$
I^\bullet(f_1, \ldots, f_r) \to I \to A
$$
where $I = (f_1, \ldots, f_r)$. In fact, there is a short exact sequence
$$
0 \to H^{-1}(K^\bullet(f_1, \ldots, f_s)) \to
H^0(I^\bullet(f_1, \ldots, f_s)) \to I \to 0
$$
and for every $i < 0$ we have
$H^i(I^\bullet(f_1, \ldots, f_r)) = H^{i - 1}(K^\bullet(f_1, \ldots, f_r)$.
Observe that given a second sequence $g_1, \ldots, g_r$ of elements of $A$
there are canonical maps
$$
I^\bullet(f_1g_1, \ldots, f_rg_r) \to I^\bullet(f_1, \ldots, f_r)
\quad\text{and}\quad
K^\bullet(f_1g_1, \ldots, f_rg_r) \to K^\bullet(f_1, \ldots, f_r)
$$
compatible with the maps described above. The first of these maps is
given by multiplication by $g_i$ on the $i$th summand of
$I^0(f_1g_1, \ldots, f_rg_r) = A^{\oplus r}$. In particular, given
$f_1, \ldots, f_r$ we obtain an inverse system of complexes
\begin{equation}
\label{equation-system}
I^\bullet(f_1, \ldots, f_r) \leftarrow
I^\bullet(f_1^2, \ldots, f_r^2) \leftarrow
I^\bullet(f_1^3, \ldots, f_r^3) \leftarrow \ldots
\end{equation}
which will play an important role in that which is to follow.
To easily formulate the following lemmas we fix some notation.

\begin{situation}
\label{situation-complex}
Here $A$ is a ring and $f_1, \ldots, f_r$ is a sequence of elements of $A$.
We set $X = \Spec(A)$ and $U = D(f_1) \cup \ldots \cup D(f_r) \subset X$.
We denote $\mathcal{U} : U = \bigcup_{i = 1, \ldots, r} D(f_i)$ the
given open covering of $U$.
\end{situation}

\noindent
Our first lemma is that the complexes above can be used to compute
the cohomology of quasi-coherent sheaves on $U$. Suppose given a
complex $I^\bullet$ of $A$-modules and an $A$-module $M$. Then we
define $\Hom_A(I^\bullet, M)$ to be the complex with $n$th
term $\Hom_A(I^{-n}, M)$ and differentials given as the contragredients
of the differentials on $I^\bullet$.

\begin{lemma}
\label{lemma-alternating-cech-complex}
In Situation \ref{situation-complex}. Let $M$ be an $A$-module and
denote $\mathcal{F}$ the associated $\mathcal{O}_X$-module. Then
there is a canonical isomorphism of complexes
$$
\colim_e \Hom_A(I^\bullet(f_1^e, \ldots, f_r^e), M)
\longrightarrow
\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F})
$$
functorial in $M$.
\end{lemma}

\begin{proof}
Recall that the alternating {\v C}ech complex is the subcomplex
of the usual {\v C}ech complex given by alternating cochains, see
Cohomology, Section \ref{cohomology-section-alternating-cech}.
As usual we view a $p$-cochain in
$\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F})$
as an alternating function $s$ on $\{1, \ldots, r\}^{p + 1}$
whose value $s_{i_0\ldots i_p}$ at $(i_0, \ldots, i_p)$ lies in
$M_{f_{i_0}\ldots f_{i_p}} = \mathcal{F}(U_{i_0\ldots i_p})$.
On the other hand, a $p$-cochain $t$ in
$\Hom_A(I^\bullet(f_1^e, \ldots, f_r^e), M)$
is given by a map $t : \wedge^{p + 1}(A^{\oplus r}) \to M$.
Write $[i] \in A^{\oplus r}$ for the $i$th basis element and
write
$$
[i_0, \ldots, i_p] = [i_0] \wedge \ldots \wedge [i_p]
\in \wedge^{p + 1}(A^{\oplus r})
$$
Then we send $t$ as above to $s$ with
$$
s_{i_0\ldots i_p} = \frac{t([i_0, \ldots, i_p])}{f_{i_0}^e\ldots f_{i_p}^e}
$$
It is clear that $s$ so defined is an alternating cochain.
The construction of this map is compatible with the transition maps
of the system as the transition map
$$
I^\bullet(f_1^e, \ldots, f_r^e) \leftarrow
I^\bullet(f_1^{e + 1}, \ldots, f_r^{e + 1}),
$$
of the (\ref{equation-system}) sends $[i_0, \ldots, i_p]$
to $f_{i_0}\ldots f_{i_p}[i_0, \ldots, i_p]$.
It is clear from the description of the localizations
$M_{f_{i_0}\ldots f_{i_p}}$ in
Algebra, Lemma \ref{algebra-lemma-localization-colimit}
that these maps define an isomorphism of cochain modules in degree $p$
in the limit. To finish the proof we have to show that the map
is compatible with differentials. To see this recall that
\begin{align*}
d(s)_{i_0\ldots i_{p + 1}}
& =
\sum\nolimits_{j = 0}^{p + 1} (-1)^j
s_{i_0\ldots \hat i_j \ldots i_p} \\
& = 
\sum\nolimits_{j = 0}^{p + 1} (-1)^j
\frac{t([i_0, \ldots, \hat i_j, \ldots i_{p + 1}])}
{f_{i_0}^e\ldots \hat f_{i_j}^e \ldots f_{i_{p + 1}}^e}
\end{align*}
On the other hand, we have
\begin{align*}
\frac{d(t)([i_0, \ldots, i_{p + 1}])}{f_{i_0}^e\ldots f_{i_{p + 1}}^e}
& =
\frac{t(d[i_0, \ldots, i_{p + 1}])}{f_{i_0}^e\ldots f_{i_{p + 1}}^e} \\
& =
\frac{\sum_j (-1)^j f_{i_j}^e t([i_0, \ldots, \hat i_j, \ldots i_{p + 1}])}
{f_{i_0}^e \ldots f_{i_{p + 1}}^e}
\end{align*}
The two formulas agree by inspection.
\end{proof}

\noindent
Suppose given a finite complex $I^\bullet$ of $A$-modules and a
complex of $A$-modules $M^\bullet$. We obtain a double complex
$H^{\bullet, \bullet} = \Hom_A(I^\bullet, M^\bullet)$ where
$H^{p, q} = \Hom_A(I^p, M^q)$. The first differential comes from
the differential on $\Hom_A(I^\bullet, M^q)$ and the second
from the differential on $M^\bullet$. Associated to this double
complex is the total complex with degree $n$ term given by
$$
\bigoplus\nolimits_{p + q = n} \Hom_A(I^p, M^q)
$$
and differential as in
Homology, Definition \ref{homology-definition-associated-simple-complex}.
As our complex $I^\bullet$ has only finitely many nonzero terms, the
direct sum displayed above is finite.
The conventions for taking the total complex associated to a
{\v C}ech complex of a complex are as in
Cohomology, Section \ref{cohomology-section-cech-cohomology-of-complexes}.

\begin{lemma}
\label{lemma-alternating-cech-complex-complex}
In Situation \ref{situation-complex}. Let $M^\bullet$ be a
complex of $A$-modules and
denote $\mathcal{F}^\bullet$ the associated complex of
$\mathcal{O}_X$-modules. Then
there is a canonical isomorphism of complexes
$$
\colim_e \text{Tot}(\Hom_A(I^\bullet(f_1^e, \ldots, f_r^e), M^\bullet))
\longrightarrow
\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F}^\bullet))
$$
functorial in $M^\bullet$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-alternating-cech-complex}
and our conventions for taking associated total complexes.
\end{proof}

\begin{lemma}
\label{lemma-alternating-cech-complex-complex-computes-cohomology}
In Situation \ref{situation-complex}. Let $\mathcal{F}^\bullet$
be a complex of quasi-coherent $\mathcal{O}_X$-modules. Then
there is a canonical isomorphism
$$
\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F}^\bullet))
\longrightarrow
R\Gamma(U, \mathcal{F}^\bullet)
$$
in $D(A)$ functorial in $\mathcal{F}^\bullet$.
\end{lemma}

\begin{proof}
Let $\mathcal{B}$ be the set of affine opens of $U$. Since the higher
cohomology groups of a quasi-coherent module on an affine scheme are zero
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero})
this is a special case of
Cohomology, Lemma \ref{cohomology-lemma-alternating-cech-complex-complex-ss}.
\end{proof}

\noindent
In Situation \ref{situation-complex} denote $I_e$ the object of
$D(\mathcal{O}_X)$ corresponding to the complex of $A$-modules
$I^\bullet(f_1^e, \ldots, f_r^e)$ via the equivalence of
Lemma \ref{lemma-affine-compare-bounded}. The maps
(\ref{equation-system}) give a system
$$
I_1 \leftarrow
I_2 \leftarrow
I_3 \leftarrow \ldots
$$
Moreover, there is a compatible system of maps $I_e \to \mathcal{O}_X$
which become isomorphisms when restricted to $U$. Thus we see that for
every object $E$ of $D(\mathcal{O}_X)$ there is a canonical map
\begin{equation}
\label{equation-comparison}
\colim_e \Hom_{D(\mathcal{O}_X)}(I_e, E) \longrightarrow H^0(U, E)
\end{equation}
constructed by sending a map $I_e \to E$ to its restriction to $U$
and using that
$\Hom_{D(\mathcal{O}_U)}(\mathcal{O}_U, E|_U) = H^0(U, E)$.

\begin{proposition}
\label{proposition-represent-cohomology-class-on-open}
In Situation \ref{situation-complex}. For every object $E$
of $D_\QCoh(\mathcal{O}_X)$ the map
(\ref{equation-comparison}) is an isomorphism.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-affine-compare-bounded} we may assume that $E$
is given by a complex of quasi-coherent sheaves $\mathcal{F}^\bullet$.
Let $M^\bullet = \Gamma(X, \mathcal{F}^\bullet)$ be the corresponding
complex of $A$-modules. By
Lemmas \ref{lemma-alternating-cech-complex-complex} and
\ref{lemma-alternating-cech-complex-complex-computes-cohomology}
we have quasi-isomorphisms
$$
\colim_e \text{Tot}(\Hom_A(I^\bullet(f_1^e, \ldots, f_r^e), M^\bullet))
\longrightarrow
\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F}^\bullet))
\longrightarrow
R\Gamma(U, \mathcal{F}^\bullet)
$$
Taking $H^0$ on both sides we obtain
$$
\colim_e \Hom_{D(A)}(I^\bullet(f_1^e, \ldots, f_r^e), M^\bullet)
=
H^0(U, E)
$$
Since $\Hom_{D(A)}(I^\bullet(f_1^e, \ldots, f_r^e), M^\bullet) =
\Hom_{D(\mathcal{O}_X)}(I_e, E)$ by
Lemma \ref{lemma-affine-compare-bounded} the lemma follows.
\end{proof}

\noindent
In Situation \ref{situation-complex} denote $K_e$ the object of
$D(\mathcal{O}_X)$ corresponding to the complex of $A$-modules
$K^\bullet(f_1^e, \ldots, f_r^e)$ via the equivalence of
Lemma \ref{lemma-affine-compare-bounded}. Thus we have distinguished
triangles
$$
I_e \to \mathcal{O}_X \to K_e \to I_e[1]
$$
and a system
$$
K_1 \leftarrow
K_2 \leftarrow
K_3 \leftarrow \ldots
$$
compatible with the system $(I_e)$.
Moreover, there is a compatible system of maps
$$
K_e \to H^0(K_e) = \mathcal{O}_X/(f_1^e, \ldots, f_r^e)
$$

\begin{lemma}
\label{lemma-represent-cohomology-class-on-closed}
In Situation \ref{situation-complex}. Let $E$ be an object of
$D_\QCoh(\mathcal{O}_X)$.
Assume that $H^i(E)|_U = 0$ for $i = - r + 1, \ldots, 0$.
Then given $s \in H^0(X, E)$ there exists an $e \geq 0$ and
a morphism $K_e \to E$ such that $s$ is in the image of
$H^0(X, K_e) \to H^0(X, E)$.
\end{lemma}

\begin{proof}
Since $U$ is covered by $r$ affine opens we have $H^j(U, \mathcal{F}) = 0$
for $j \geq r$ and any quasi-coherent module
(Cohomology of Schemes, Lemma \ref{coherent-lemma-vanishing-nr-affines}).
By Lemma \ref{lemma-application-nice-K-injective} we see that $H^0(U, E)$
is equal to $H^0(U, \tau_{\geq -r + 1}E)$. There is
a spectral sequence
$$
H^j(U, H^i(\tau_{\geq -r + 1}E)) \Rightarrow H^{i + j}(U, \tau_{\geq -N}E)
$$
see Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
Hence $H^0(U, E) = 0$ by our assumed vanishing of cohomology sheaves of $E$.
We conclude that $s|_U = 0$.
Think of $s$ as a morphism $\mathcal{O}_X \to E$ in $D(\mathcal{O}_X)$.
By Proposition \ref{proposition-represent-cohomology-class-on-open}
the composition $I_e \to \mathcal{O}_X \to E$ is zero for some $e$.
By the distinguished triangle $I_e \to \mathcal{O}_X \to K_e \to I_e[1]$
we obtain a morphism $K_e \to E$ such that $s$ is the composition
$\mathcal{O}_X \to K_e \to E$.
\end{proof}


\section{Pseudo-coherent and perfect complexes}
\label{section-spell-out}

\noindent
In this section we make the connection between the general
notions defined in
Cohomology, Sections \ref{cohomology-section-strictly-perfect},
\ref{cohomology-section-pseudo-coherent},
\ref{cohomology-section-tor}, and
\ref{cohomology-section-perfect}
and the corresponding notions for complexes of modules in
More on Algebra, Sections
\ref{more-algebra-section-pseudo-coherent},
\ref{more-algebra-section-tor}, and
\ref{more-algebra-section-perfect}.

\begin{lemma}
\label{lemma-pseudo-coherent}
Let $X$ be a scheme. If $E$ is an $m$-pseudo-coherent
object of $D(\mathcal{O}_X)$, then $H^i(E)$ is a quasi-coherent
$\mathcal{O}_X$-module for $i > m$.
If $E$ is pseudo-coherent, then $E$ is an object of
$D_\QCoh(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Locally $H^i(E)$ is isomorphic to $H^i(\mathcal{E}^\bullet)$
with $\mathcal{E}^\bullet$ strictly perfect. The sheaves
$\mathcal{E}^i$ are direct summands of finite free modules,
hence quasi-coherent. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-locally-ringed-space-direct-summand-free}
Let $X$ be a locally ringed space. A direct summand of a finite free
$\mathcal{O}_X$-module is finite locally free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-pseudo-coherent-affine}
Let $X = \Spec(A)$ be an affine scheme. Let $M^\bullet$ be a
complex of $A$-modules and let $E$ be the corresponding object
of $D(\mathcal{O}_X)$. Then $E$ is an $m$-pseudo-coherent
(resp.\ pseudo-coherent) as an object of $D(\mathcal{O}_X)$
if and only if $M^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
as a complex of $A$-modules.
\end{lemma}

\begin{proof}
It is immediate from the definitions that if $M^\bullet$ is
$m$-pseudo-coherent, so is $E$. To prove the converse, assume
$E$ is $m$-pseudo-coherent. As $X = \Spec(A)$ is quasi-compact with
a basis for the topology given by standard opens, we can find a standard
open covering $X = D(f_1) \cup \ldots \cup D(f_n)$ and strictly
perfect complexes $\mathcal{E}_i^\bullet$ on $D(f_i)$ and
maps $\alpha_i : \mathcal{E}_i^\bullet \to E|_{U_i}$ inducing
isomorphisms on $H^j$ for $j > m$ and surjections on $H^m$.
By Cohomology, Lemma \ref{cohomology-lemma-local-actual}
after refining the open covering
we may assume $\alpha_i$ is given by a map of complexes
$\mathcal{E}_i^\bullet \to \widetilde{M^\bullet}|_{U_i}$
for each $i$. By Lemma \ref{lemma-locally-ringed-space-direct-summand-free}
the terms $\mathcal{E}_i^n$ are finite locally free modules.
Hence after refining the open covering we may assume each
$\mathcal{E}_i^n$ is a finite free $\mathcal{O}_{U_i}$-module.
From the definition it follows that $M^\bullet_{f_i}$ is
an $m$-pseudo-coherent complex of $A_{f_i}$-modules.
We conclude by applying
More on Algebra, Lemma \ref{more-algebra-lemma-glue-pseudo-coherent}.

\medskip\noindent
The case ``pseudo-coherent'' follows from the fact that $E$ is
pseudo-coherent if and only if $E$ is $m$-pseudo-coherent for
all $m$ (by definition) and the same is true for $M^\bullet$
by More on Algebra, Lemma \ref{more-algebra-lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-identify-pseudo-coherent-noetherian}
Let $X$ be a Noetherian scheme. Let $E$ be an object of
$D_\QCoh(\mathcal{O}_X)$. For $m \in \mathbf{Z}$ the
following are equivalent
\begin{enumerate}
\item $H^i(E)$ is coherent for $i \geq m$ and zero for $i \gg 0$, and
\item $E$ is $m$-pseudo-coherent.
\end{enumerate}
In particular, $E$ is pseudo-coherent if and only if $E$ is an object
of $D^-_{\textit{Coh}}(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
As $X$ is quasi-compact we see that in both (1) and (2) the object $E$
is bounded above. Thus the question is local on $X$ and we may assume
$X$ is affine. Say $X = \Spec(A)$ for some Noetherian ring $A$.
In this case $E$ corresponds to a complex of $A$-modules $M^\bullet$
by Lemma \ref{lemma-affine-compare-bounded}. By
Lemma \ref{lemma-pseudo-coherent-affine}
we see that $E$ is $m$-pseudo-coherent if and only if $M^\bullet$
is $m$-pseudo-coherent. On the other hand, $H^i(E)$ is coherent
if and only if $H^i(M^\bullet)$ is a finite $A$-module
(Properties, Lemma \ref{properties-lemma-finite-type-module}).
Thus the result follows from More on Algebra, Lemma
\ref{more-algebra-lemma-Noetherian-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-tor-dimension-affine}
Let $X = \Spec(A)$ be an affine scheme. Let $M^\bullet$ be a
complex of $A$-modules and let $E$ be the corresponding object
of $D(\mathcal{O}_X)$. Then
\begin{enumerate}
\item $E$ has tor amplitude in $[a, b]$ if and only if $M^\bullet$
has tor amplitude in $[a, b]$.
\item $E$ has finite tor dimension if and only if $M^\bullet$
has finite tor dimension.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) follows trivially from part (1). In the proof of (1) we will
use the equivalence $D(A) = D_\QCoh(X)$ of
Lemma \ref{lemma-affine-compare-bounded}
without further mention.
Assume $M^\bullet$ has tor amplitude in $[a, b]$. Then $K^\bullet$
is isomorphic in $D(A)$ to a complex $K^\bullet$ of flat $A$-modules
with $K^i = 0$ for $i \not \in [a, b]$, see
More on Algebra, Lemma \ref{more-algebra-lemma-tor-amplitude}.
Then $E$ is isomorphic to $\widetilde{K^\bullet}$. Since each
$\widetilde{K^i}$ is a flat $\mathcal{O}_X$-module, we see
that $E$ has tor amplitude in $[a, b]$ by
Cohomology, Lemma \ref{cohomology-lemma-tor-amplitude}.

\medskip\noindent
Assume that $E$ has tor amplitude in $[a, b]$. Then $E$ is bounded
whence $M^\bullet$ is in $K^-(A)$. Thus we may replace $M^\bullet$
by a bounded above complex of $A$-modules. We may even choose
a projective resolution and assume that $M^\bullet$ is a bounded above
complex of free $A$-modules. Then for any $A$-module $N$ we have
$$
E \otimes_{\mathcal{O}_X}^\mathbf{L} \widetilde{N}
\cong
\widetilde{M^\bullet} \otimes_{\mathcal{O}_X}^\mathbf{L} \widetilde{N}
\cong
\widetilde{M^\bullet \otimes_A N}
$$
in $D(\mathcal{O}_X)$. Thus the vanishing of cohomology sheaves of
the left hand side implies $M^\bullet$ has tor amplitude in $[a, b]$.
\end{proof}

\begin{lemma}
\label{lemma-tor-qc-qs}
Let $X$ be a quasi-separated scheme. Let $E$ be an object
of $D_\QCoh(\mathcal{O}_X)$. Let $a \leq b$. The
following are equivalent
\begin{enumerate}
\item $E$ has tor amplitude in $[a, b]$, and
\item for all $\mathcal{F}$ in $\QCoh(\mathcal{O}_X)$
we have $H^i(E \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{F}) = 0$
for $i \not \in [a, b]$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). Assume (2). Let $U \subset X$ be
an affine open. As $X$ is quasi-separated the morphism $j : U \to X$
is quasi-compact and separated, hence $j_*$ transforms quasi-coherent
modules into quasi-coherent modules
(Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}).
Thus the functor
$\QCoh(\mathcal{O}_X) \to \QCoh(\mathcal{O}_U)$
is essentially surjective. It follows that condition (2)
implies the vanishing of
$H^i(E|_U \otimes_{\mathcal{O}_U}^\mathbf{L} \mathcal{G})$
for $i \not \in [a, b]$ for all quasi-coherent $\mathcal{O}_U$-modules
$\mathcal{G}$. Write $U = \Spec(A)$ and let $M^\bullet$ be the
complex of $A$-modules corresponding to $E|_U$ by
Lemma \ref{lemma-affine-compare-bounded}.
We have just shown that $M^\bullet \otimes_A^\mathbf{L} N$
has vanishing cohomology groups outside the range $[a, b]$,
in other words $M^\bullet$ has tor amplitude in $[a, b]$.
By Lemma \ref{lemma-tor-dimension-affine}
we conclude that $E|_U$ has tor amplitude in $[a, b]$.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-perfect-affine}
Let $X = \Spec(A)$ be an affine scheme. Let $M^\bullet$ be a
complex of $A$-modules and let $E$ be the corresponding object
of $D(\mathcal{O}_X)$. Then $E$ is a perfect object of $D(\mathcal{O}_X)$
if and only if $M^\bullet$ is perfect as an object of $D(A)$.
\end{lemma}

\begin{proof}
This is a logical consequence of
Lemmas \ref{lemma-pseudo-coherent-affine} and
\ref{lemma-tor-dimension-affine},
Cohomology, Lemma \ref{cohomology-lemma-perfect}, and
More on Algebra, Lemma \ref{more-algebra-lemma-perfect}.
\end{proof}

\noindent
As a consequence of our description of pseudo-coherent
complexes on schemes we can prove certain internal homs
are quasi-coherent.

\begin{lemma}
\label{lemma-quasi-coherence-internal-hom}
Let $X$ be a scheme.
\begin{enumerate}
\item If $L$ is in $D^+_\QCoh(\mathcal{O}_X)$ and
$K$ in $D(\mathcal{O}_X)$ is pseudo-coherent, then
$R\SheafHom(K, L)$ is in $D_\QCoh^+(\mathcal{O}_X)$.
\item If $L$ is in $D_\QCoh(\mathcal{O}_X)$ and
$K$ in $D(\mathcal{O}_X)$ is perfect, then
$R\SheafHom(K, L)$ is in $D_\QCoh(\mathcal{O}_X)$.
\item If $X = \Spec(A)$ is affine and $K, L \in D(A)$ then
$$
R\SheafHom(\widetilde{K}, \widetilde{L}) = \widetilde{R\Hom(K, L)}
$$
in the following two cases
\begin{enumerate}
\item $K$ is pseudo-coherent and $L$ is bounded below,
\item $K$ is perfect and $L$ arbitrary.
\end{enumerate}
\item If $X = \Spec(A)$ and $K, L$ are in $D(A)$, then the $n$th
cohomology sheaf of $R\SheafHom(\widetilde{K}, \widetilde{L})$
is the sheaf associated to the presheaf
$$
X \supset D(f) \longmapsto \text{Ext}^n_{A_f}(K \otimes_A A_f, L \otimes_A A_f)
$$
for $f \in A$.
\end{enumerate}
\end{lemma}

\begin{proof}
The construction of the internal hom in the derived category of
$\mathcal{O}_X$ commutes with localization (see
Cohomology, Section \ref{cohomology-section-internal-hom}).
Hence to prove (1) and (2) we may replace $X$ by an affine open.
By Lemmas \ref{lemma-affine-compare-bounded},
\ref{lemma-pseudo-coherent-affine}, and
\ref{lemma-perfect-affine}
in order to prove (1) and (2) it suffices to prove (3).

\medskip\noindent
Part (3) follows from the computation of the
internal hom of Cohomology, Lemma
\ref{cohomology-lemma-Rhom-complex-of-direct-summands-finite-free}
by representing $K$ by a bounded above (resp.\ finite) complex of
finite projective $A$-modules and $L$ by a bounded below
(resp.\ arbitrary) complex of $A$-modules.

\medskip\noindent
To prove (4) recall that on any ringed space the $n$th cohomology sheaf of
$R\SheafHom(A, B)$ is the sheaf associated to the presheaf
$$
U \mapsto \Hom_{D(U)}(A|_U, B|_U[n]) =
\text{Ext}^n_{D(\mathcal{O}_U)}(A|_U, B|_U)
$$
See Cohomology, Section \ref{cohomology-section-internal-hom}.
On the other hand, the restriction of $\widetilde{K}$ to a principal
open $D(f)$ is the image of $K \otimes_A A_f$ and similarly for $L$.
Hence (4) follows from the equivalence of categories of
Lemma \ref{lemma-affine-compare-bounded}.
\end{proof}

\begin{lemma}
\label{lemma-internal-hom-evaluate-tensor-isomorphism}
Let $X$ be a scheme. Let $K, L, M$ be objects of $D_\QCoh(\mathcal{O}_X)$.
There is a canonical map
$$
K \otimes_{\mathcal{O}_X}^\mathbf{L} R\SheafHom(M, L)
\longrightarrow
R\SheafHom(M, K \otimes_{\mathcal{O}_X}^\mathbf{L} L)
$$
which is an isomorphism in the following cases
\begin{enumerate}
\item $M$ perfect, or
\item $K$ is perfect, or
\item $M$ is pseudo-coherent, $L \in D^+(\mathcal{O}_X)$, and $K$ has finite
tor dimension.
\end{enumerate}
\end{lemma}

\begin{proof}
We leave the construction of the arrow to the reader (hint: use
Cohomology, Lemmas \ref{cohomology-lemma-internal-hom-composition} and
\ref{cohomology-lemma-internal-hom-diagonal}).
Lemma \ref{lemma-quasi-coherence-internal-hom}
reduces cases (1) and (3) to the affine case which is treated in
More on Algebra, Lemma
\ref{more-algebra-lemma-internal-hom-evaluate-tensor-isomorphism}.
(You also have to use Lemmas \ref{lemma-pseudo-coherent-affine},
\ref{lemma-perfect-affine}, and \ref{lemma-tor-dimension-affine}
to do the translation into algebra.)
If $K$ is perfect but no other assumptions are made, then we
do not know that either side of the arrow is in $D_\QCoh(\mathcal{O}_X)$
but the result is still true because we can work locally and reduce
to the case that $K$ is a finite complex of finite free modules
in which case it is clear.
\end{proof}





\section{Descent finiteness properties of complexes}
\label{section-descent-finiteness}

\noindent
This section is the analogue of
Descent, Section \ref{descent-section-descent-finiteness}
for objects of the derived category of a scheme.
The easiest such result is probably the following.

\begin{lemma}
\label{lemma-tor-amplitude-descends}
Let $f : X \to Y$ be a surjective flat morphism of schemes
(or more generally locally ringed spaces).
Let $E \in D(\mathcal{O}_Y)$. Let $a, b \in \mathbf{Z}$.
Then $E$ has tor-amplitude in $[a, b]$ if and only if
$Lf^*E$ has tor-amplitude in $[a, b]$.
\end{lemma}

\begin{proof}
Pullback always preserves tor-amplitude, see
Cohomology, Lemma \ref{cohomology-lemma-tor-amplitude-pullback}.
We may check tor-amplitude in $[a, b]$ on stalks, see
Cohomology, Lemma \ref{cohomology-lemma-tor-amplitude-stalk}.
A flat local ring homomorphism is faithfully flat by
Algebra, Lemma \ref{algebra-lemma-local-flat-ff}.
Thus the result follows from
More on Algebra, Lemma
\ref{more-algebra-lemma-flat-descent-tor-amplitude}.
\end{proof}

\begin{lemma}
\label{lemma-pseudo-coherent-descends-fpqc}
Let $\{f_i : X_i \to X\}$ be an fpqc covering of schemes. Let
$E \in D_\QCoh(\mathcal{O}_X)$. Let $m \in \mathbf{Z}$.
Then $E$ is $m$-pseudo-coherent if and only if each
$Lf_i^*E$ is $m$-pseudo-coherent.
\end{lemma}

\begin{proof}
Pullback always preserves $m$-pseudo-coherence, see
Cohomology, Lemma \ref{cohomology-lemma-pseudo-coherent-pullback}.
Conversely, assume that $Lf_i^*E$ is $m$-pseudo-coherent for all $i$.
Let $U \subset X$ be an affine open. It suffices to prove that
$E|_U$ is $m$-pseudo-coherent. Since $\{f_i : X_i \to X\}$ is an
fpqc covering, we can find finitely many affine open $V_j \subset X_{a(j)}$
such that $f_{a(j)}(V_j) \subset U$ and $U = \bigcup f_{a(j)}(V_j)$.
Set $V = \coprod V_i$.
Thus we may replace $X$ by $U$ and $\{f_i : X_i \to X\}$ by
$\{V \to U\}$ and assume that $X$ is affine and our covering
is given by a single surjective flat morphism $\{f : Y \to X\}$
of affine schemes. In this case the result follows from
More on Algebra, Lemma \ref{more-algebra-lemma-flat-descent-pseudo-coherent}
via Lemmas \ref{lemma-affine-compare-bounded} and
\ref{lemma-pseudo-coherent-affine}.
\end{proof}

\begin{lemma}
\label{lemma-pseudo-coherent-descends-fppf}
Let $\{f_i : X_i \to X\}$ be an fppf covering of schemes. Let
$E \in D(\mathcal{O}_X)$. Let $m \in \mathbf{Z}$.
Then $E$ is $m$-pseudo-coherent if and only if each
$Lf_i^*E$ is $m$-pseudo-coherent.
\end{lemma}

\begin{proof}
Pullback always preserves $m$-pseudo-coherence, see
Cohomology, Lemma \ref{cohomology-lemma-pseudo-coherent-pullback}.
Conversely, assume that $Lf_i^*E$ is $m$-pseudo-coherent for all $i$.
Let $U \subset X$ be an affine open. It suffices to prove that
$E|_U$ is $m$-pseudo-coherent. Since $\{f_i : X_i \to X\}$ is an
fppf covering, we can find finitely many affine open $V_j \subset X_{a(j)}$
such that $f_{a(j)}(V_j) \subset U$ and $U = \bigcup f_{a(j)}(V_j)$.
Set $V = \coprod V_i$.
Thus we may replace $X$ by $U$ and $\{f_i : X_i \to X\}$ by
$\{V \to U\}$ and assume that $X$ is affine and our covering
is given by a single surjective flat morphism $\{f : Y \to X\}$
of finite presentation.

\medskip\noindent
Since $f$ is flat the derived functor $Lf^*$ is just given by $f^*$ and $f^*$
is exact. Hence $H^i(Lf^*E) = f^*H^i(E)$. Since $Lf^*E$ is $m$-pseudo-coherent,
we see that $Lf^*E \in D^-(\mathcal{O}_Y)$. Since $f$ is surjective and flat,
we see that $E \in D^-(\mathcal{O}_X)$. Let $i \in \mathbf{Z}$ be the largest
integer such that $H^i(E)$ is nonzero. If $i < m$, then we are done. Otherwise,
$f^*H^i(E)$ is a finite type $\mathcal{O}_Y$-module by
Cohomology, Lemma \ref{cohomology-lemma-finite-cohomology}.
Then by Descent, Lemma \ref{descent-lemma-finite-type-descends-fppf}
the $\mathcal{O}_X$-module $H^i(E)$ is of finite type.
Thus, after replacing $X$ by the members of a finite affine open covering,
we may assume there exists a map
$$
\alpha : \mathcal{O}_X^{\oplus n}[-i] \longrightarrow E
$$
such that $H^i(\alpha)$ is a surjection. Let $C$ be the cone of $\alpha$
in $D(\mathcal{O}_X)$. Pulling back to $Y$ and using
Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}
we find that $Lf^*C$ is $m$-pseudo-coherent. Moreover $H^j(C) = 0$
for $j \geq i$. Thus by induction on $i$ we see that $C$ is
$m$-pseudo-coherent. Using
Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}
again we conclude.
\end{proof}

\begin{lemma}
\label{lemma-perfect-descends-fpqc}
Let $\{f_i : X_i \to X\}$ be an fpqc covering of schemes. Let
$E \in D(\mathcal{O}_X)$. Then $E$ is perfect
if and only if each $Lf_i^*E$ is perfect.
\end{lemma}

\begin{proof}
Pullback always preserves perfect complexes, see
Cohomology, Lemma \ref{cohomology-lemma-perfect-pullback}.
Conversely, assume that $Lf_i^*E$ is perfect for all $i$.
Then the cohomology sheaves of each $Lf_i^*E$ are quasi-coherent, see
Lemma \ref{lemma-pseudo-coherent}
and
Cohomology, Lemma \ref{cohomology-lemma-perfect}.
Since the morphisms $f_i$ is flat we see that $H^p(Lf_i^*E) = f_i^*H^p(E)$.
Thus the cohomology sheaves of $E$ are quasi-coherent by
Descent, Proposition \ref{descent-proposition-fpqc-descent-quasi-coherent}.
Having said this the lemma follows formally from
Cohomology, Lemma \ref{cohomology-lemma-perfect}
and
Lemmas \ref{lemma-tor-amplitude-descends} and
\ref{lemma-pseudo-coherent-descends-fpqc}.
\end{proof}

\begin{lemma}
\label{lemma-closed-push-pseudo-coherent}
Let $i : Z \to X$ be a morphism of ringed spaces such that
$i$ is a closed immersion of underlying topological spaces and such that
$i_*\mathcal{O}_Z$ is pseudo-coherent as an $\mathcal{O}_X$-module.
Let $E \in D(\mathcal{O}_Z)$. Then $E$ is $m$-pseudo-coherent
if and only if $Ri_*E$ is $m$-pseudo-coherent.
\end{lemma}

\begin{proof}
Throughout this proof we will use that $i_*$ is an exact functor, and
hence that $Ri_* = i_*$, see Modules, Lemma \ref{modules-lemma-i-star-exact}.

\medskip\noindent
Assume $E$ is $m$-pseudo-coherent. Let $x \in X$. We will find a neighbourhood
of $x$ such that $i_*E$ is $m$-peudo-coherent on it. If $x \not \in Z$
then this is clear. Thus we may assume $x \in Z$. We will use
that $U \cap Z$ for $x \in U \subset X$ open form a fundamental system of
neighbourhoods of $x$ in $Z$. After shrinking $X$ we may assume $E$ is
bounded above. We will argue by induction on
the largest integer $p$ such that $H^p(E)$ is nonzero. If $p < m$, then
there is nothing to prove. If $p \geq m$, then $H^p(E)$ is an
$\mathcal{O}_Z$-module of finite type, see
Cohomology, Lemma \ref{cohomology-lemma-finite-cohomology}.
Thus we may choose, after shrinking $X$, a map
$\mathcal{O}_Z^{\oplus n}[-p] \to E$ which induces a surjection
$\mathcal{O}_Z^{\oplus n} \to H^p(E)$. Choose a distinguished triangle
$$
\mathcal{O}_Z^{\oplus n}[-p] \to E \to C \to \mathcal{O}_Z^{\oplus n}[-p + 1]
$$
We see that $H^j(C) = 0$ for $j \geq p$ and that $C$ is $m$-pseudo-coherent
by Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}.
By induction we see that $i_*C$ is $m$-pseudo-coherent on $X$.
Since $i_*\mathcal{O}_Z$ is $m$-pseudo-coherent on $X$ as well, we conclude
from the distinguished triangle
$$
i_*\mathcal{O}_Z^{\oplus n}[-p] \to i_*E \to i_*C \to
i_*\mathcal{O}_Z^{\oplus n}[-p + 1]
$$
and 
Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}
that $i_*E$ is $m$-pseudo-coherent.

\medskip\noindent
Assume that $i_*E$ is $m$-pseudo-coherent. Let $z \in Z$.
We will find a neighbourhood of $z$ such that $E$
is $m$-peudo-coherent on it. We will use
that $U \cap Z$ for $z \in U \subset X$ open form a fundamental system of
neighbourhoods of $z$ in $Z$. After shrinking $X$ we may assume $i_*E$
and hence $E$ is bounded above. We will argue by induction on
the largest integer $p$ such that $H^p(E)$ is nonzero. If $p < m$, then
there is nothing to prove. If $p \geq m$, then $H^p(i_*E) = i_*H^p(E)$
is an $\mathcal{O}_X$-module of finite type, see
Cohomology, Lemma \ref{cohomology-lemma-finite-cohomology}.
Choose a complex $\mathcal{E}^\bullet$ of $\mathcal{O}_Z$-modules
representing $E$. We may choose, after shrinking $X$,
a map $\alpha : \mathcal{O}_X^{\oplus n}[-p] \to i_*\mathcal{E}^\bullet$
which induces a surjection
$\mathcal{O}_X^{\oplus n} \to i_*H^p(\mathcal{E}^\bullet)$.
By adjunction we find a map
$\alpha : \mathcal{O}_Z^{\oplus n}[-p] \to \mathcal{E}^\bullet$
which induces a surjection
$\mathcal{O}_Z^{\oplus n} \to H^p(\mathcal{E}^\bullet)$.
Choose a distinguished triangle
$$
\mathcal{O}_Z^{\oplus n}[-p] \to E \to C \to \mathcal{O}_Z^{\oplus n}[-p + 1]
$$
We see that $H^j(C) = 0$ for $j \geq p$. From the distinguished triangle
$$
i_*\mathcal{O}_Z^{\oplus n}[-p] \to i_*E \to i_*C \to
i_*\mathcal{O}_Z^{\oplus n}[-p + 1]
$$
the fact that $i_*\mathcal{O}_Z$ is pseudo-coherent
and 
Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}
we conclude that $i_*C$ is $m$-pseudo-coherent.
By induction we conclude that $C$ is $m$-pseudo-coherent.
By Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}
again we conclude that $E$ is $m$-pseudo-coherent.
\end{proof}

\begin{lemma}
\label{lemma-finite-push-pseudo-coherent}
Let $f : X \to Y$ be a finite morphism of schemes such that
$f_*\mathcal{O}_X$ is pseudo-coherent as an
$\mathcal{O}_Y$-module\footnote{This means that $f$ is pseudo-coherent, see
More on Morphisms, Lemma
\ref{more-morphisms-lemma-finite-pseudo-coherent}.}.
Let $E \in D_\QCoh(\mathcal{O}_X)$. Then $E$ is $m$-pseudo-coherent
if and only if $Rf_*E$ is $m$-pseudo-coherent.
\end{lemma}

\begin{proof}
This is a translation of
More on Algebra, Lemma \ref{more-algebra-lemma-finite-push-pseudo-coherent}
into the language of schemes. To do the translation, use
Lemmas \ref{lemma-affine-compare-bounded} and
\ref{lemma-pseudo-coherent-affine}.
\end{proof}


\section{Lifting complexes}
\label{section-lift}

\noindent
Let $U \subset X$ be an open subspace of a ringed space
and denote $j : U \to X$ the inclusion morphism. The functor
$D(\mathcal{O}_X) \to D(\mathcal{O}_U)$ is essentially surjective as
$Rj_*$ is a right inverse to restriction.
In this section we extend this to complexes with quasi-coherent cohomology
sheaves, etc.

\begin{lemma}
\label{lemma-lift-quasi-coherent}
Let $X$ be a scheme and let $j : U \to X$ be a quasi-compact
open immersion. The functors
$$
D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_U)
\quad\text{and}\quad
D^+_\QCoh(\mathcal{O}_X) \to D^+_\QCoh(\mathcal{O}_U)
$$
are essentially surjective. If $X$ is quasi-compact, then the functors
$$
D^-_\QCoh(\mathcal{O}_X) \to D^-_\QCoh(\mathcal{O}_U)
\quad\text{and}\quad
D^b_\QCoh(\mathcal{O}_X) \to D^b_\QCoh(\mathcal{O}_U)
$$
are essentially surjective.
\end{lemma}

\begin{proof}
The argument preceding the lemma applies for the first case because $Rj_*$
maps $D_\QCoh(\mathcal{O}_U)$ into $D_\QCoh(\mathcal{O}_X)$
by Lemma \ref{lemma-quasi-coherence-direct-image}.
It is clear that $Rj_*$ maps
$D^+_\QCoh(\mathcal{O}_U)$ into
$D^+_\QCoh(\mathcal{O}_X)$
which implies the statement on bounded below complexes.
Finally, Lemma \ref{lemma-quasi-coherence-direct-image}
guarantees that $Rj_*$ maps
$D^-_\QCoh(\mathcal{O}_U)$ into
$D^-_\QCoh(\mathcal{O}_X)$
if $X$ is quasi-compact. Combining these two we obtain the last statement.
\end{proof}

\begin{lemma}
\label{lemma-lift-pseudo-coherent}
Let $X$ be an affine scheme and let $U \subset X$ be a quasi-compact
open subscheme. For any pseudo-coherent object $E$ of $D(\mathcal{O}_U)$
there exists a bounded above complex of finite free $\mathcal{O}_X$-modules 
whose restriction to $U$ is isomorphic to $E$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-pseudo-coherent} we see that $E$ is an object of
$D_\QCoh(\mathcal{O}_U)$. By
Lemma \ref{lemma-lift-quasi-coherent}
we may assume $E = E'|U$ for some object $E'$ of
$D_\QCoh(\mathcal{O}_X)$.
Write $X = \Spec(A)$. By Lemma \ref{lemma-affine-compare-bounded}
we can find a complex $M^\bullet$ of $A$-modules whose associated
complex of $\mathcal{O}_X$-modules is a representative of $E'$.

\medskip\noindent
Choose $f_1, \ldots, f_r \in A$ such that $U = D(f_1) \cup \ldots \cup D(f_r)$.
By Lemma \ref{lemma-pseudo-coherent-affine} the complexes
$M^\bullet_{f_j}$ are pseudo-coherent complexes of $A_{f_j}$-modules.
Let $n$ be an integer. Assume we have a map of complexes
$\alpha : F^\bullet \to M^\bullet$ where $F^\bullet$ is
bounded above, $F^i = 0$ for $i < n$, each $F^i$ is a finite free
$R$-module, such that
$$
H^i(\alpha_{f_j}) : H^i(F^\bullet_{f_j}) \to H^i(M^\bullet_{f_j})
$$
is an isomorphism for $i > n$ and surjective for $i = n$. Picture
$$
\xymatrix{
& F^n \ar[r] \ar[d]^\alpha & F^{n + 1} \ar[d]^\alpha \ar[r] & \ldots \\
M^{n-1} \ar[r] & M^n \ar[r] & M^{n + 1} \ar[r] & \ldots
}
$$
Since each $M^\bullet_{f_j}$ has vanishing cohomology
in large degrees we can find such a map for $n \gg 0$.
By induction on $n$ we are going to extend this to a map
of complexes $F^\bullet \to M^\bullet$
such that $H^i(\alpha_{f_j})$ is an isomorphism
for all $i$. The lemma will follow by taking $\widetilde{F^\bullet}$.

\medskip\noindent
The induction step will be to extend the diagram
above by adding $F^{n - 1}$. Let $C^\bullet$ be the cone on $\alpha$
(Derived Categories, Definition \ref{derived-definition-cone}).
The long exact sequence of cohomology shows that
$H^i(C^\bullet_{f_j}) = 0$ for $i \geq n$. By
More on Algebra, Lemma \ref{more-algebra-lemma-cone-pseudo-coherent}
we see that $C^\bullet_{f_j}$ is $(n - 1)$-pseudo-coherent. By
More on Algebra, Lemma \ref{more-algebra-lemma-finite-cohomology}
we see that $H^{-1}(C^\bullet_{f_j})$ is a finite $A_{f_j}$-module.
Choose a finite free $A$-module $F^{n - 1}$ and an $A$-module
$\beta : F^{n - 1} \to C^{-1}$ such that the composition
$F^{n - 1} \to C^{n - 1} \to C^n$ is zero and such that
$F^{n - 1}_{f_j}$ surjects onto $H^{n - 1}(C^\bullet_{f_j})$.
(Some details omitted; hint: clear denominators.)
Since $C^{n - 1} = M^{n - 1} \oplus F^n$
we can write $\beta = (\alpha^{n - 1}, -d^{n - 1})$. The vanishing of the
composition $F^{n - 1} \to C^{n - 1} \to C^n$ implies
these maps fit into a morphism of complexes
$$
\xymatrix{
& F^{n - 1} \ar[d]^{\alpha^{n - 1}} \ar[r]_{d^{n - 1}} &
F^n \ar[r] \ar[d]^\alpha &
F^{n + 1} \ar[d]^\alpha \ar[r] & \ldots \\
\ldots \ar[r] &
M^{n - 1} \ar[r] & M^n \ar[r] & M^{n + 1} \ar[r] & \ldots
}
$$
Moreover, these maps define a morphism of distinguished triangles
$$
\xymatrix{
(F^n \to \ldots) \ar[r] \ar[d] &
(F^{n-1} \to \ldots) \ar[r] \ar[d] &
F^{n-1} \ar[r] \ar[d]_\beta &
(F^n \to \ldots)[1] \ar[d] \\
(F^n \to \ldots) \ar[r] &
M^\bullet \ar[r] &
C^\bullet \ar[r] &
(F^n \to \ldots)[1]
}
$$
Hence our choice of $\beta$ implies that the map of complexes
$(F^{-1} \to \ldots) \to M^\bullet$ induces an isomorphism on
cohomology localized at $f_j$ in degrees $\geq n$ and a surjection
in degree $-1$. This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-ext}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $E \in D^b_\QCoh(\mathcal{O}_X)$.
There exists an integer $n_0 > 0$ such that
$\text{Ext}^n_{D(\mathcal{O}_X)}(\mathcal{E}, E) = 0$
for every finite locally free
$\mathcal{O}_X$-module $\mathcal{E}$ and every $n \geq n_0$.
\end{lemma}

\begin{proof}
Recall that $\text{Ext}^n_{D(\mathcal{O}_X)}(\mathcal{E}, E) =
\Hom_{D(\mathcal{O}_X)}(\mathcal{E}, E[n])$. We have
Mayer-Vietoris for morphisms in the derived category, see
Cohomology, Lemma \ref{cohomology-lemma-mayer-vietoris-hom}.
Thus if $X = U \cup V$ and the result of the lemma holds
for $E|_U$, $E|_V$, and $E|_{U \cap V}$ for some bound $n_0$,
then the result holds for $E$ with bound $n_0 + 1$.
Thus it suffices to prove the lemma when $X$ is affine, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}.

\medskip\noindent
Assume $X = \Spec(A)$ is affine. Choose a complex of $A$-modules
$M^\bullet$ whose associated complex of quasi-coherent modules
represents $E$, see Lemma \ref{lemma-affine-compare-bounded}.
Write $\mathcal{E} = \widetilde{P}$ for some $A$-module $P$.
Since $\mathcal{E}$ is finite locally free, we see that $P$
is a finite projective $A$-module. We have
\begin{align*}
\Hom_{D(\mathcal{O}_X)}(\mathcal{E}, E[n])
& = 
\Hom_{D(A)}(P, M^\bullet[n]) \\
& =
\Hom_{K(A)}(P, M^\bullet[n]) \\
& =
\Hom_A(P, H^n(M^\bullet))
\end{align*}
The first equality by Lemma \ref{lemma-affine-compare-bounded},
the second equality by
Derived Categories, Lemma
\ref{derived-lemma-morphisms-from-projective-complex}, and
the final equality because $\Hom_A(P, -)$ is an exact functor.
As $E$ and hence $M^\bullet$ is bounded
we get zero for all sufficiently large $n$.
\end{proof}

\begin{lemma}
\label{lemma-lift-perfect-complex-plus-locally-free}
Let $X$ be an affine scheme. Let $U \subset X$ be a quasi-compact open.
For every perfect object $E$ of $D(\mathcal{O}_U)$ there exists an integer
$r$ and a finite locally free sheaf $\mathcal{F}$ on $U$ such that
$\mathcal{F}[-r] \oplus E$ is the restriction of a perfect object of
$D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Say $X = \Spec(A)$. Recall that a perfect complex is
pseudo-coherent, see
Cohomology, Lemma \ref{cohomology-lemma-perfect}.
By Lemma \ref{lemma-lift-pseudo-coherent} we can find a bounded above complex
$\mathcal{F}^\bullet$ of finite free $A$-modules such that $E$ is
isomorphic to $\mathcal{F}^\bullet|_U$ in $D(\mathcal{O}_U)$.
By Cohomology, Lemma \ref{cohomology-lemma-perfect} and since
$U$ is quasi-compact, we see that $E$ has finite tor dimension, say
$E$ has tor amplitude in $[a, b]$. Pick $r < a$ and set
$$
\mathcal{F} = \Ker(\mathcal{F}^{r} \to \mathcal{F}^{r + 1})
= \Im(\mathcal{F}^{r - 1} \to \mathcal{F}^r).
$$
Since $E$ has tor amplitude in $[a, b]$ we see that $\mathcal{F}|_U$ is
flat (Cohomology, Lemma \ref{cohomology-lemma-last-one-flat}).
Hence $\mathcal{F}|_U$ is flat and of finite presentation, thus finite
locally free (Properties, Lemma \ref{properties-lemma-finite-locally-free}).
It follows that
$$
(\mathcal{F} \to \mathcal{F}^r \to \mathcal{F}^{r + 1} \to \ldots )|_U
$$
is a strictly perfect complex on $U$ representing $E$.
We obtain a distinguished triangle
$$
\mathcal{F}|_U[- r - 1] \to E \to
(\mathcal{F}^r \to \mathcal{F}^{r + 1} \to \ldots )|_U \to
\mathcal{F}|_U[- r]
$$
Note that $(\mathcal{F}^r \to \mathcal{F}^{r + 1} \to \ldots )$ is
a perfect complex on $X$. To finish the proof it suffices to pick $r$
such that the map
$\mathcal{F}|_U[- r - 1] \to E$ is zero in $D(\mathcal{O}_U)$, see
Derived Categories, Lemma \ref{derived-lemma-split}. By
Lemma \ref{lemma-vanishing-ext} this holds if $r \ll 0$.
\end{proof}

\begin{lemma}
\label{lemma-lift-map}
Let $X$ be an affine scheme. Let $U \subset X$ be a quasi-compact open.
Let $E, E'$ be objects of $D_\QCoh(\mathcal{O}_X)$ with $E$ perfect.
For every map $\alpha : E|_U \to E'|_U$ there exist maps
$$
E \xleftarrow{\beta} E_1 \xrightarrow{\gamma} E'
$$
of perfect complexes on $X$ such that $\beta : E_1 \to E$ restricts to an
isomorphism on $U$ and such that $\alpha = \gamma|_U \circ \beta|_U^{-1}$.
Moreover we can assume $E_1 = E \otimes_{\mathcal{O}_X}^\mathbf{L} I$
for some perfect complex $I$ on $X$.
\end{lemma}

\begin{proof}
Write $X = \Spec(A)$. Write $U = D(f_1) \cup \ldots \cup D(f_r)$. Choose
finite complex of finite projective $A$-modules $M^\bullet$ representing
$E$ (Lemma \ref{lemma-perfect-affine}). Choose a complex of $A$-modules
$(M')^\bullet$ representing $E'$ (Lemma \ref{lemma-affine-compare-bounded}).
In this case the complex $H^\bullet = \Hom_A(M^\bullet, (M')^\bullet)$
is a complex of $A$-modules whose associated complex of quasi-coherent
$\mathcal{O}_X$-modules represents $R\SheafHom(E, E')$, see
Cohomology, Lemma \ref{cohomology-lemma-Rhom-strictly-perfect}.
Then $\alpha$ determines an element $s$ of $H^0(U, R\SheafHom(E, E'))$, see
Cohomology, Lemma \ref{cohomology-lemma-section-RHom-over-U}.
There exists an $e$ and a map
$$
\xi : I^\bullet(f_1^e, \ldots, f_r^e) \to \Hom_A(M^\bullet, (M')^\bullet)
$$
corresponding to $s$, see
Proposition \ref{proposition-represent-cohomology-class-on-open}.
Letting $E_1$ be the object corresponding to
complex of quasi-coherent $\mathcal{O}_X$-modules
associated to
$$
\text{Tot}(I^\bullet(f_1^e, \ldots, f_r^e) \otimes_A M^\bullet)
$$
we obtain $E_1 \to E$ using the canonical map
$I^\bullet(f_1^e, \ldots, f_r^e) \to A$ and $E_1 \to E'$
using $\xi$ and
Cohomology, Lemma \ref{cohomology-lemma-section-RHom-over-U}.
\end{proof}

\begin{lemma}
\label{lemma-lift-perfect-complex-plus-shift}
Let $X$ be an affine scheme. Let $U \subset X$ be a quasi-compact open.
For every perfect object $F$ of $D(\mathcal{O}_U)$
the object $F \oplus F[1]$ is the restriction of
a perfect object of $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-lift-perfect-complex-plus-locally-free}
we can find a perfect object $E$ of $D(\mathcal{O}_X)$
such that $E|_U = \mathcal{F}[r] \oplus F$ for some finite locally
free $\mathcal{O}_U$-module $\mathcal{F}$.
By Lemma \ref{lemma-lift-map} we can find a morphism of
perfect complexes $\alpha : E_1 \to E$ such that $(E_1)|_U \cong E|_U$
and such that $\alpha|_U$ is the map
$$
\left(
\begin{matrix}
\text{id}_{\mathcal{F}[r]} & 0 \\
0 & 0
\end{matrix}
\right)
:
\mathcal{F}[r] \oplus F \to \mathcal{F}[r] \oplus F
$$
Then the cone on $\alpha$ is a solution.
\end{proof}

\begin{lemma}
\label{lemma-perfect-into-support-on-T}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $f \in \Gamma(X, \mathcal{O}_X)$.
For any morphism $\alpha : E \to E'$ in
$D_\QCoh(\mathcal{O}_X)$ such that
\begin{enumerate}
\item $E$ is perfect, and
\item $E'$ is supported on $T = V(f)$
\end{enumerate}
there exists an $n \geq 0$ such that $f^n \alpha  = 0$.
\end{lemma}

\begin{proof}
We have Mayer-Vietoris for morphisms in the derived category, see
Cohomology, Lemma \ref{cohomology-lemma-mayer-vietoris-hom}.
Thus if $X = U \cup V$ and the result of the lemma holds
for $f|_U$, $f|_V$, and $f|_{U \cap V}$, then the result holds for $f$.
Thus it suffices to prove the lemma when $X$ is affine, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}.

\medskip\noindent
Let $X = \Spec(A)$. Then $f \in A$. We will
use the equivalence $D(A) = D_\QCoh(X)$ of
Lemma \ref{lemma-affine-compare-bounded}
without further mention.
Represent $E$ by a finite complex of finite projective $A$-modules
$P^\bullet$. This is possible by Lemma \ref{lemma-perfect-affine}.
Let $t$ be the largest integer such that $P^t$ is nonzero.
The distinguished triangle
$$
P^t[-t] \to P^\bullet \to \sigma_{\leq t - 1}P^\bullet \to P^t[-t + 1]
$$
shows that by induction on the length of the complex $P^\bullet$
we can reduce to the case where $P^\bullet$ has a single nonzero term.
This and the shift functor reduces us to the case where $P^\bullet$
consists of a single finite projective $A$-module $P$ in degree $0$.
Represent $E'$ by a complex $M^\bullet$ of $A$-modules.
Then $\alpha$ corresponds to a map $P \to H^0(M^\bullet)$.
Since the module $H^0(M^\bullet)$ is supported on $V(f)$ by assumption (2)
we see that every element of $H^0(M^\bullet)$ is annihilated by a power
of $f$. Since $P$ is a finite $A$-module the map
$f^n\alpha : P \to H^0(M^\bullet)$ is zero for some $n$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-lift-perfect-complex-plus-shift-support}
Let $X$ be an affine scheme. Let $T \subset X$ be a closed subset
such that $X \setminus T$ is quasi-compact. Let $U \subset X$ be a
quasi-compact open. For every perfect object $F$ of $D(\mathcal{O}_U)$
supported on $T \cap U$ the object $F \oplus F[1]$ is the restriction of
a perfect object $E$ of $D(\mathcal{O}_X)$ supported in $T$.
\end{lemma}

\begin{proof}
Say $T = V(g_1, \ldots, g_s)$. After replacing $g_j$ by a power we
may assume multiplication by $g_j$ is zero on $F$, see
Lemma \ref{lemma-perfect-into-support-on-T}. Choose $E$ as in
Lemma \ref{lemma-lift-perfect-complex-plus-shift}.
Note that $g_j : E \to E$ restricts to zero on $U$.
Choose a distinguished triangle
$$
E \xrightarrow{g_1} E \to C_1 \to E[1]
$$
By Derived Categories, Lemma \ref{derived-lemma-split}
the object $C_1$ restricts to
$F \oplus F[1] \oplus F[1] \oplus F[2]$ on $U$.
Moreover, $g_1 : C_1 \to C_1$ has square zero by
Derived Categories, Lemma \ref{derived-lemma-third-map-square-zero}.
Namely, the diagram
$$
\xymatrix{
E \ar[r] \ar[d]_0 & C_1 \ar[d]_{g_1} \ar[r] & E[1] \ar[d]_0 \\
E \ar[r] & C_1 \ar[r] & E[1]
}
$$
is commutative since the compositions $E \xrightarrow{g_1} E \to C_1$ and
$C_1 \to E[1] \xrightarrow{g_1} E[1]$ are zero. Continuing, setting
$C_{i + 1}$ equal to the cone of the map $g_i : C_i \to C_i$ we obtain
a perfect complex $C_s$ on $X$ supported on $T$
whose restriction to $U$ gives
$$
F \oplus F[1]^{\oplus s} \oplus F[2]^{\oplus {s \choose 2}}
\oplus \ldots \oplus F[s]
$$
Choose morphisms of perfect complexes $\beta : C' \to C_s$
and $\gamma : C' \to C_s$ as in Lemma \ref{lemma-lift-map}
such that $\beta|_U$ is an isomorphism and such that
$\gamma|_U \circ \beta|_U^{-1}$ is the morphism
$$
F \oplus F[1]^{\oplus s} \oplus F[2]^{\oplus {s \choose 2}}
\oplus \ldots \oplus F[s]
\to
F \oplus F[1]^{\oplus s} \oplus F[2]^{\oplus {s \choose 2}}
\oplus \ldots \oplus F[s]
$$
which is the identity on all summands except for $F$ where it is zero.
By Lemma \ref{lemma-lift-map} we also have
$C' = C_s \otimes^\mathbf{L} I$ for some perfect complex
$I$ on $X$. Hence the nullity of $g_j^2\text{id}_{C_s}$ implies the
same thing for $C'$. Thus $C'$ is supported on $T$ as well.
Then $\text{Cone}(\gamma)$ is a solution.
\end{proof}

\noindent
A special case of the following lemma can be found in
\cite{Neeman-Grothendieck}.

\begin{lemma}
\label{lemma-lift-map-from-perfect-complex-with-support}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $U \subset X$ be a quasi-compact open. Let $T \subset X$
be a closed subset with $X \setminus T$ retro-compact in $X$.
Let $E$ be an object of $D_\QCoh(\mathcal{O}_X)$.
Let $\alpha : P \to E|_U$ be a map where $P$ is a perfect object of
$D(\mathcal{O}_U)$ supported on $T \cap U$. Then there exists a map
$\beta : R \to E$ where $R$ is a perfect object of $D(\mathcal{O}_X)$
supported on $T$ such that $P$ is a direct summand of $R|_U$ in
$D(\mathcal{O}_U)$ compatible $\alpha$ and $\beta|_U$.
\end{lemma}

\begin{proof}
Since $X$ is quasi-compact there exists an integer $m$ such that
$X = U \cup V_1 \cup \ldots \cup V_m$ for some affine opens $V_j$ of $X$.
Arguing by induction on $m$ we see that we may assume $m = 1$. In other
words, we may assume that $X = U \cup V$ with $V$ affine. By
Lemma \ref{lemma-lift-perfect-complex-plus-shift-support}
we can choose a perfect object $Q$ in $D(\mathcal{O}_V)$
supported on $T \cap V$ and an isomorphism
$Q|_{U \cap V} \to (P \oplus P[1])|_{U \cap V}$.
By Lemma \ref{lemma-lift-map} we can replace $Q$ by
$Q \otimes^\mathbf{L} I$ (still supported on $T \cap V$)
and assume that the map
$$
Q|_{U \cap V} \to (P \oplus P[1])|_{U \cap V}
\longrightarrow P|_{U \cap V}
\longrightarrow
E|_{U \cap V}
$$
lifts to $Q \to E|_V$. By
Cohomology, Lemma \ref{cohomology-lemma-glue}
we find an morphism $a : R \to E$ of $D(\mathcal{O}_X)$
such that $a|_U$ is isomorphic to $P \oplus P[1] \to E|_U$
and $a|_V$ isomorphic to $Q \to E|_V$.
Thus $R$ is perfect and supported on $T$ as desired.
\end{proof}

\begin{remark}
\label{remark-addendum}
The proof of Lemma \ref{lemma-lift-map-from-perfect-complex-with-support}
shows that
$$
R|_U = P \oplus P^{\oplus n_1}[1] \oplus \ldots \oplus P^{\oplus n_m}[m]
$$
for some $m \geq 0$ and $n_j \geq 0$. Thus the highest degree cohomology sheaf
of $R|_U$ equals that of $P$. By repeating the construction for the map
$P^{\oplus n_1}[1] \oplus \ldots \oplus P^{\oplus n_m}[m] \to R|_U$, taking
cones, and using induction we can achieve equality of cohomology sheaves
of $R|_U$ and $P$ above any given degree.
\end{remark}



\section{Approximation by perfect complexes}
\label{section-approximation}

\noindent
In this section we discuss the observation, due to Neeman and Lipman,
that a pseudo-coherent complex can be ``approximated'' by perfect complexes.

\begin{definition}
\label{definition-approximation-holds}
Let $X$ be a scheme. Consider triples $(T, E, m)$ where
\begin{enumerate}
\item $T \subset X$ is a closed subset,
\item $E$ is an object of $D_\QCoh(\mathcal{O}_X)$, and
\item $m \in \mathbf{Z}$.
\end{enumerate}
We say {\it approximation holds for the triple} $(T, E, m)$ if
there exists a perfect object $P$ of $D(\mathcal{O}_X)$ supported on $T$
and a map $\alpha : P \to E$ which induces isomorphisms $H^i(P) \to H^i(E)$
for $i > m$ and a surjection $H^m(P) \to H^m(E)$.
\end{definition}

\noindent
Approximation cannot hold for every triple. Namely, it is clear that if
approximation holds for the triple $(T, E, m)$, then
\begin{enumerate}
\item $E$ is $m$-pseudo-coherent, see
Cohomology, Definition \ref{cohomology-definition-pseudo-coherent}, and
\item the cohomology sheaves $H^i(E)$ are supported on $T$ for $i \geq m$.
\end{enumerate}
Moreover, the ``support'' of a perfect complex is a closed subscheme
whose complement is retrocompact in $X$ (details omitted). Hence we cannot
expect approximation to hold without this assumption on $T$.
This partly explains the conditions in the following definition.

\begin{definition}
\label{definition-approximation}
Let $X$ be a scheme. We say {\it approximation by perfect complexes holds}
on $X$ if for any closed subset $T \subset X$ with $X \setminus T$
retro-compact in $X$ there exists an integer $r$ such that
for every triple $(T, E, m)$ as in
Definition \ref{definition-approximation-holds} with
\begin{enumerate}
\item $E$ is $(m - r)$-pseudo-coherent, and
\item $H^i(E)$ is supported on $T$ for $i \geq m - r$
\end{enumerate}
approximation holds.
\end{definition}

\noindent
We will prove that approximation by perfect complexes holds for
quasi-compact and quasi-separated schemes. It seems that the second
condition is necessary for our method of proof. It is possible that the
first condition may be weakened to ``$E$ is $m$-pseudo-coherent''
by carefuly analyzing the arguments below.

\begin{lemma}
\label{lemma-open}
Let $X$ be a scheme. Let $U \subset X$ be an open subscheme.
Let $(T, E, m)$ be a triple as in
Definition \ref{definition-approximation-holds}.
If
\begin{enumerate}
\item $T \subset U$,
\item approximation holds for $(T, E|_U, m)$, and
\item the sheaves $H^i(E)$ for $i \geq m$ are supported on $T$,
\end{enumerate}
then approximation holds for $(T, E, m)$.
\end{lemma}

\begin{proof}
Let $j : U \to X$ be the inclusion morphism.
If $P \to E|_U$ is an approximation of the triple $(T, E|_U, m)$
over $U$, then $j_!P = Rj_*P \to j_!(E|_U) \to E$ is an approximation
of $(T, E, m)$ over $X$.
See Cohomology, Lemmas \ref{cohomology-lemma-pushforward-restriction} and
\ref{cohomology-lemma-pushforward-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-approximation-affine}
Let $X$ be an affine scheme. Then approximation holds for every
triple $(T, E, m)$ as in Definition \ref{definition-approximation-holds}
such that there exists an integer $r \geq 0$ with
\begin{enumerate}
\item $E$ is $m$-pseudo-coherent,
\item $H^i(E)$ is supported on $T$ for $i \geq m - r + 1$,
\item $X \setminus T$ is the union of $r$ affine opens.
\end{enumerate}
In particular, approximation by perfect complexes holds for affine schemes.
\end{lemma}

\begin{proof}
Say $X = \Spec(A)$. Write $T = V(f_1, \ldots, f_r)$.
(The case $r = 0$, i.e., $T = X$ follows immediately from
Lemma \ref{lemma-pseudo-coherent-affine} and the definitions.)
Let $(T, E, m)$ be a triple as in the lemma.
Let $t$ be the largest integer such that $H^t(E)$ is nonzero.
We will proceed by induction on $t$. The base case is $t < m$; in
this case the result is trivial. Now suppose that $t \geq m$. By
Cohomology, Lemma \ref{cohomology-lemma-finite-cohomology}
the sheaf $H^t(E)$ is of finite type. Since it is quasi-coherent
it is generated by finitely many sections
(Properties, Lemma \ref{properties-lemma-finite-type-module}).
For every $s \in \Gamma(X, H^t(E)) = H^t(X, E)$
(see proof of Lemma \ref{lemma-affine-compare-bounded})
we can find an $e > 0$ and a morphism $K_e[-t] \to E$
such that $s$ is in the image of
$H^0(K_e) = H^t(K_e[-t]) \to H^t(E)$, see
Lemma \ref{lemma-represent-cohomology-class-on-closed}.
Taking a finite direct sum of these maps we obtain a map
$P \to E$ where $P$ is a perfect complex supported on $T$,
where $H^i(P) = 0$ for $i > t$, and where $H^t(P) \to E$ is
surjective. Choose a distinguished triangle
$$
P \to E \to E' \to P[1]
$$
Then $E'$ is $m$-pseudo-coherent
(Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}),
$H^i(E') = 0$ for $i \geq t$, and
$H^i(E')$ is supported on $T$ for $i \geq m - r + 1$.
By induction we find an approximation $P' \to E'$
of $(T, E', m)$. Fit the composition $P' \to E' \to P[1]$
into a distringuished triangle $P \to P'' \to P' \to P[1]$
and extend the morphisms $P' \to E'$ and $P[1] \to P[1]$ into
a morphism of distinguished triangles
$$
\xymatrix{
P \ar[r] \ar[d] & P'' \ar[d] \ar[r] & P' \ar[d] \ar[r] & P[1] \ar[d] \\
P \ar[r] &  E \ar[r] & E' \ar[r] & P[1]
}
$$
using TR3. Then $P''$ is a perfect complex
(Cohomology, Lemma \ref{cohomology-lemma-two-out-of-three-perfect})
supported on $T$.
An easy diagram chase shows that $P'' \to E$ is the desired
approximation.
\end{proof}

\begin{lemma}
\label{lemma-induction-step}
Let $X$ be a scheme. Let $X = U \cup V$ be an open covering
with $U$ quasi-compact, $V$ affine, and $U \cap V$ quasi-compact.
If approximation by perfect complexes holds on $U$,
then approximation holds on $X$.
\end{lemma}

\begin{proof}
Let $T \subset X$ be a closed subset with $X \setminus T$ retro-compact
in $X$. Let $r_U$ be the integer of Definition \ref{definition-approximation}
adapted to the pair $(U, T \cap U)$.
Set $T' = T \setminus U$. Note that
$T' \subset V$ and that $V \setminus T' = (X \setminus T) \cap U \cap V$
is quasi-compact by our assumption on $T$.
Let $r'$ be the number of affines needed to cover $V \setminus T'$.
We claim that $r = \max(r_U, r')$ works for the pair $(X, T)$.

\medskip\noindent
To see this choose a triple $(T, E, m)$ such that $E$ is
$(m - r)$-pseudo-coherent and $H^i(E)$ is supported on $T$ for
$i \geq m - r$. Let $t$ be the largest integer such that
$H^t(E)|_U$ is nonzero. (Such an integer exists as $U$ is quasi-compact
and $E|_U$ is $(m - r)$-pseudo-coherent.)
We will prove that $E$ can be approximated by induction on $t$.

\medskip\noindent
Base case: $t \leq m - r'$. This means that $H^i(E)$ is supported
on $T'$ for $i \geq m - r'$. Hence
Lemma \ref{lemma-approximation-affine}
guarantees the existence of an approximation
$P \to E|_V$ of $(T', E|_V, m)$ on $V$.
Applying Lemma \ref{lemma-open} we see that
$(T', E, m)$ can be approximated. Such an approximation
is also an approximation of $(T, E, m)$.

\medskip\noindent
Induction step. Choose an approximation $P \to E|_U$
of $(T \cap U, E|_U, m)$. This in particular gives a surjection
$H^t(P) \to H^t(E|_U)$. By
Lemma \ref{lemma-lift-perfect-complex-plus-shift-support}
we can choose a perfect object $Q$ in $D(\mathcal{O}_V)$
supported on $T \cap V$ and an isomorphism
$Q|_{U \cap V} \to (P \oplus P[1])|_{U \cap V}$.
By Lemma \ref{lemma-lift-map} we can replace $Q$ by
$Q \otimes^\mathbf{L} I$
and assume that the map
$$
Q|_{U \cap V} \to (P \oplus P[1])|_{U \cap V}
\longrightarrow P|_{U \cap V}
\longrightarrow
E|_{U \cap V}
$$
lifts to $Q \to E|_V$. By
Cohomology, Lemma \ref{cohomology-lemma-glue}
we find an morphism $a : R \to E$ of $D(\mathcal{O}_X)$
such that $a|_U$ is isomorphic to $P \oplus P[1] \to E|_U$
and $a|_V$ isomorphic to $Q \to E|_V$.
Thus $R$ is perfect and supported on $T$
and the map $H^t(R) \to H^t(E)$ is surjective on restriction to $U$.
Choose a distinguised triangle
$$
R \to E \to E' \to R[1]
$$
Then $E'$ is $(m - r)$-pseudo-coherent
(Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}),
$H^i(E')|_U = 0$ for $i \geq t$, and
$H^i(E')$ is supported on $T$ for $i \geq m - r$.
By induction we find an approximation $R' \to E'$
of $(T, E', m)$. Fit the composition $R' \to E' \to R[1]$
into a distringuished triangle $R \to R'' \to R' \to R[1]$
and extend the morphisms $R' \to E'$ and $R[1] \to R[1]$ into
a morphism of distinguished triangles
$$
\xymatrix{
R \ar[r] \ar[d] & R'' \ar[d] \ar[r] & R' \ar[d] \ar[r] & R[1] \ar[d] \\
R \ar[r] &  E \ar[r] & E' \ar[r] & R[1]
}
$$
using TR3. Then $R''$ is a perfect complex
(Cohomology, Lemma \ref{cohomology-lemma-two-out-of-three-perfect})
supported on $T$.
An easy diagram chase shows that $R'' \to E$ is the desired
approximation.
\end{proof}

\begin{theorem}
\label{theorem-approximation}
Let $X$ be a quasi-compact and quasi-separated scheme.
Then approximation by perfect complexes holds on $X$.
\end{theorem}

\begin{proof}
This follows from the induction principle of
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}
and Lemmas \ref{lemma-induction-step} and \ref{lemma-approximation-affine}.
\end{proof}






\section{Generating derived categories}
\label{section-generating}

\noindent
In this section we prove that the derived category
$D_\QCoh(\mathcal{O}_X)$ of a quasi-compact
and quasi-separated scheme can be generated by a single perfect object.
We urge the reader to read the proof of this result in the wonderful paper by
Bondal and van den Bergh, see \cite{BvdB}.

\begin{lemma}
\label{lemma-direct-summand-of-a-restriction}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $U$ be a quasi-compact open subscheme.
Let $P$ be a perfect object of $D(\mathcal{O}_U)$.
Then $P$ is a direct summand of the restriction of a perfect
object of $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Special case of Lemma \ref{lemma-lift-map-from-perfect-complex-with-support}.
\end{proof}

\begin{lemma}
\label{lemma-orthogonal-koszul-complex}
\begin{reference}
\cite[Proposition 6.1]{Bokstedt-Neeman}
\end{reference}
In Situation \ref{situation-complex} denote $j : U \to X$ the open
immersion and let $K$ be the perfect object of $D(\mathcal{O}_X)$
corresponding to the Koszul complex on $f_1, \ldots, f_r$ over $A$.
For $E \in D_\QCoh(\mathcal{O}_X)$ the following are equivalent
\begin{enumerate}
\item $E = Rj_*(E|_U)$, and
\item $\Hom_{D(\mathcal{O}_X)}(K[n], E) = 0$ for all $n \in \mathbf{Z}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a distinguished triangle $E \to Rj_*(E|_U) \to N \to E[1]$.
Observe that
$$
\Hom_{D(\mathcal{O}_X)}(K[n], Rj_*(E|_U)) =
\Hom_{D(\mathcal{O}_U)}(K|_U[n], E) = 0
$$
for all $n$ as $K|_U = 0$. Thus it suffices to prove the result for
$N$. In other words, we may assume that $E$ restricts to zero on $U$.
Observe that there are distinguished triangles
$$
K^\bullet(f_1^{e_1}, \ldots, f_i^{e'_i}, \ldots, f_r^{e_r}) \to
K^\bullet(f_1^{e_1}, \ldots, f_i^{e'_i + e''_i}, \ldots, f_r^{e_r}) \to
K^\bullet(f_1^{e_1}, \ldots, f_i^{e''_i}, \ldots, f_r^{e_r}) \to \ldots
$$
of Koszul complexes, see
More on Algebra, Lemma \ref{more-algebra-lemma-koszul-mult}.
Hence if $\Hom_{D(\mathcal{O}_X)}(K[n], E) = 0$ for all $n \in \mathbf{Z}$
then the same thing is true for the $K$ replaced by
$K_e$ as in Lemma \ref{lemma-represent-cohomology-class-on-closed}.
Thus our lemma follows immediately from that one and the fact that $E$
is determined by the complex of $A$-modules $R\Gamma(X, E)$, see
Lemma \ref{lemma-affine-compare-bounded}.
\end{proof}

\begin{theorem}
\label{theorem-bondal-van-den-Bergh}
Let $X$ be a quasi-compact and quasi-separated scheme. The category
$D_\QCoh(\mathcal{O}_X)$ can be generated by a single
perfect object. More precisely, there exists a perfect object
$P$ of $D(\mathcal{O}_X)$ such that for 
$E \in D_\QCoh(\mathcal{O}_X)$ the following are equivalent
\begin{enumerate}
\item $E = 0$, and
\item $\Hom_{D(\mathcal{O}_X)}(P[n], E) = 0$ for all $n \in \mathbf{Z}$.
\end{enumerate}
\end{theorem}

\begin{proof}
We will prove this using the induction principle of
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}.

\medskip\noindent
If $X$ is affine, then $\mathcal{O}_X$ is a perfect generator.
This follows from Lemma \ref{lemma-affine-compare-bounded}.

\medskip\noindent
Assume that $X = U \cup V$ is an open covering with $U$ quasi-compact
such that the theorem holds for $U$ and $V$ is an affine open.
Let $P$ be a perfect object of $D(\mathcal{O}_U)$ which is a generator
for $D_\QCoh(\mathcal{O}_U)$. Using
Lemma \ref{lemma-direct-summand-of-a-restriction} we may
choose a perfect object
$Q$ of $D(\mathcal{O}_X)$ whose restriction to $U$ is a direct sum one
of whose summands is $P$. Say $V = \Spec(A)$. Let $Z = X \setminus U$.
This is a closed subset of $V$ with $V \setminus Z$ quasi-compact.
Choose $f_1, \ldots, f_r \in A$ such that
$Z = V(f_1, \ldots, f_r)$. Let $K \in D(\mathcal{O}_V)$ be the perfect
object corresponding to the Koszul complex on $f_1, \ldots, f_r$ over $A$.
Note that since $K$ is supported on $Z \subset V$ closed, the pushforward
$K' = R(V \to X)_*K$ is a perfect object of $D(\mathcal{O}_X)$ whose
restriction to $V$ is $K$ (see
Cohomology, Lemma \ref{cohomology-lemma-pushforward-perfect}).
We claim that $Q \oplus K'$ is a generator for
$D_\QCoh(\mathcal{O}_X)$.

\medskip\noindent
Let $E$ be an object of $D_\QCoh(\mathcal{O}_X)$ such that
there are no nontrivial maps from any shift of $Q \oplus K'$ into $E$.
By Cohomology, Lemma \ref{cohomology-lemma-pushforward-restriction}
we have $K' =  R(V \to X)_! K$ and hence
$$
\Hom_{D(\mathcal{O}_X)}(K'[n], E) = \Hom_{D(\mathcal{O}_V)}(K[n], E|_V)
$$
Thus by Lemma \ref{lemma-orthogonal-koszul-complex} the vanishing of
these groups implies that $E|_V$ is isomorphic to
$R(U \cap V \to V)_*E|_{U \cap V}$. This implies that $E = R(U \to X)_*E|_U$
(small detail omitted). If this is the case then
$$
\Hom_{D(\mathcal{O}_X)}(Q[n], E) = \Hom_{D(\mathcal{O}_U)}(Q|_U[n], E|_U)
$$
which contains $\Hom_{D(\mathcal{O}_U)}(P[n], E|_U)$ as a direct summand.
Thus by our choice of $P$ the vanishing of these groups implies that $E|_U$
is zero. Whence $E$ is zero.
\end{proof}

\noindent
The following result is an strengthening of
Theorem \ref{theorem-bondal-van-den-Bergh}
proved using exactly the same methods.
Let $T \subset X$ be a closed subset of a scheme $X$.
Let's denote $D_T(\mathcal{O}_X)$ the strictly full, saturated,
triangulated subcategory consisting of complexes whose
cohomology sheaves are supported on $T$.

\begin{lemma}
\label{lemma-generator-with-support}
\begin{reference}
\cite[Theorem 6.8]{Rouquier-dimensions}
\end{reference}
Let $X$ be a quasi-compact and quasi-separated scheme. Let $T \subset X$ be a
closed subset such that $X \setminus T$ is quasi-compact. With notation
as above, the category $D_{\QCoh, T}(\mathcal{O}_X)$ is generated by a
single perfect object.
\end{lemma}

\begin{proof}
We will prove this using the induction principle of
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}.

\medskip\noindent
Assume $X = \Spec(A)$ is affine. In this case there exist
$f_1, \ldots, f_r \in A$ such that $T = V(f_1, \ldots, f_r)$.
Let $K$ be the Koszul complex on $f_1, \ldots, f_r$ as in
Lemma \ref{lemma-orthogonal-koszul-complex}.
Then $K$ is a perfect object with cohomology supported on
$T$ and hence a perfect object of $D_{\QCoh, T}(\mathcal{O}_X)$.
On the other hand, if $E \in D_{\QCoh, T}(\mathcal{O}_X)$ and
$\Hom(K, E[n]) = 0$ for all $n$, then
Lemma \ref{lemma-orthogonal-koszul-complex}
tells us that $E = Rj_*(E|_{X \setminus T}) = 0$.
Hence $K$ generates $D_{\QCoh, T}(\mathcal{O}_X)$,
(by our definition of generators of triangulated categories in
Derived Categories, Definition \ref{derived-definition-generators}).

\medskip\noindent
Assume that $X = U \cup V$ is an open covering with $U$ quasi-compact
such that the lemma holds for $U$ and $V$ is an affine open.
Let $P$ be a perfect object of $D(\mathcal{O}_U)$ supported on $T \cap U$
which is a generator for $D_{\QCoh, T \cap U}(\mathcal{O}_U)$. Using
Lemma \ref{lemma-lift-map-from-perfect-complex-with-support}
we may choose a perfect object $Q$ of $D(\mathcal{O}_X)$ supported on $T$
whose restriction to $U$ is a direct sum one of whose summands is $P$.
Write $V = \Spec(B)$. Let $Z = X \setminus U$. Then $Z$ is a closed subset
of $V$ such that $V \setminus Z$ is quasi-compact. As $X$ is quasi-separated,
it follows that $Z \cap T$ is a closed subset of $V$ such that
$W = V \setminus (Z \cap T)$ is quasi-compact. Thus we can choose
$g_1, \ldots, g_s \in B$ such that $Z \cap T = V(g_1, \ldots, g_r)$.
Let $K \in D(\mathcal{O}_V)$ be the perfect object corresponding to the
Koszul complex on $g_1, \ldots, g_s$ over $B$. Note that since $K$ is
supported on $(Z \cap T) \subset V$ closed, the pushforward
$K' = R(V \to X)_*K$ is a perfect object of $D(\mathcal{O}_X)$ whose
restriction to $V$ is $K$ (see
Cohomology, Lemma \ref{cohomology-lemma-pushforward-perfect}).
We claim that $Q \oplus K'$ is a generator for
$D_{\QCoh, T}(\mathcal{O}_X)$.

\medskip\noindent
Let $E$ be an object of $D_{\QCoh, T}(\mathcal{O}_X)$ such that
there are no nontrivial maps from any shift of $Q \oplus K'$ into $E$.
By Cohomology, Lemma \ref{cohomology-lemma-pushforward-restriction}
we have $K' =  R(V \to X)_! K$ and hence
$$
\Hom_{D(\mathcal{O}_X)}(K'[n], E) = \Hom_{D(\mathcal{O}_V)}(K[n], E|_V)
$$
Thus by Lemma \ref{lemma-orthogonal-koszul-complex} we have
$E|_V = Rj_*E|_W$ where $j : W \to V$ is the inclusion. Picture
$$
\xymatrix{
W \ar[r]_j & V & Z \cap T \ar[l] \ar[d] \\
U \cap V \ar[u]^{j'} \ar[ru]_{j''} & & Z \ar[lu]
}
$$
Since $E$ is supported on $T$ we see that $E|_W$ is supported on
$T \cap W = T \cap U \cap V$ which is closed in $W$.
We conclude that
$$
E|_V = Rj_*(E|_W) = Rj_*(Rj'_*(E|_{U \cap V})) = Rj''_*(E|_{U \cap V})
$$
where the second equality is part (1) of
Cohomology, Lemma \ref{cohomology-lemma-pushforward-restriction}.
This implies that $E = R(U \to X)_*E|_U$ (small detail omitted). If
this is the case then
$$
\Hom_{D(\mathcal{O}_X)}(Q[n], E) = \Hom_{D(\mathcal{O}_U)}(Q|_U[n], E|_U)
$$
which contains $\Hom_{D(\mathcal{O}_U)}(P[n], E|_U)$ as a direct summand.
Thus by our choice of $P$ the vanishing of these groups implies that $E|_U$
is zero. Whence $E$ is zero.
\end{proof}



\section{An example generator}
\label{section-example-generator}

\noindent
In this section we prove that the derived category of a projective
scheme over a ring is generated by a vector bundle, in fact a direct
sum of shifts of the structure sheaf.

\medskip\noindent
The following lemma says that $\bigoplus_{n \geq 0} \mathcal{L}^{\otimes -n}$
is a generator if $\mathcal{L}$ is ample.

\begin{lemma}
\label{lemma-nonzero-some-cohomology}
Let $X$ be a scheme and $\mathcal{L}$ an ample invertible
$\mathcal{O}_X$-module. If $K$ is a nonzero object of
$D_\QCoh(\mathcal{O}_X)$, then for some $n \geq 0$ and $p \in \mathbf{Z}$
the cohomology group
$H^p(X, K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{L}^{\otimes n})$
is nonzero.
\end{lemma}

\begin{proof}
Recall that as $X$ has an ample invertible sheaf, it is quasi-compact
and separated (Properties, Definition \ref{properties-definition-ample} and
Lemma \ref{properties-lemma-affine-s-opens-cover-quasi-separated}).
Thus we may apply
Proposition \ref{proposition-quasi-compact-affine-diagonal}
and represent $K$ by a complex $\mathcal{F}^\bullet$ of
quasi-coherent modules. Pick any $p$ such that
$\mathcal{H}^p = \Ker(\mathcal{F}^p \to \mathcal{F}^{p + 1})/
\Im(\mathcal{F}^{p - 1} \to \mathcal{F}^p)$ is nonzero.
Choose a point $x \in X$ such that the stalk $\mathcal{H}^p_x$ is
nonzero. Choose an $n \geq 0$ and $s \in \Gamma(X, \mathcal{L}^{\otimes n})$
such that $X_s$ is an affine open neighbourhood of $x$.
Choose $\tau \in \mathcal{H}^p(X_s)$ which maps to a nonzero
element of the stalk $\mathcal{H}^p_x$; this is possible
as $\mathcal{H}^p$ is quasi-coherent and $X_s$ is affine.
Since taking sections over $X_s$ is an exact functor on
quasi-coherent modules, we can find a section $\tau' \in \mathcal{F}^p(X_s)$
mapping to zero in $\mathcal{F}^{p + 1}(X_s)$ and mapping to
$\tau$ in $\mathcal{H}^p(X_s)$. By
Properties, Lemma \ref{properties-lemma-invert-s-sections}
there exists an $m$ such that $\tau' \otimes s^{\otimes m}$
is the image of a section
$\tau'' \in \Gamma(X, \mathcal{F}^p \otimes \mathcal{L}^{\otimes mn})$.
Applying the same lemma once more, we find $l \geq 0$ such that
$\tau'' \otimes s^{\otimes l}$ maps to zero in
$\mathcal{F}^{p + 1} \otimes \mathcal{L}^{\otimes (m + l)n}$.
Then $\tau''$ gives a nonzero class in
$H^p(X, K \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{L}^{(m + l)n})$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-construct-the-next-one}
Let $A$ be a ring. Let $X = \mathbf{P}^n_A$. For every $a \in \mathbf{Z}$
there exists an exact complex
$$
0 \to \mathcal{O}_X(a) \to \ldots
\to \mathcal{O}_X(a + i)^{\oplus {n + 1 \choose i}} \to
\ldots \to \mathcal{O}_X(a + n + 1) \to 0
$$
of vectorbundles on $X$.
\end{lemma}

\begin{proof}
Recall that $\mathbf{P}^n_A$ is $\text{Proj}(A[X_0, \ldots, X_n])$, see
Constructions, Definition \ref{constructions-definition-projective-space}.
Consider the Koszul complex
$$
K_\bullet = K_\bullet(A[X_0, \ldots, X_n], X_0, \ldots, X_n)
$$
over $S = A[X_0, \ldots, X_n]$ on $X_0, \ldots, X_n$.
Since $X_0, \ldots, X_n$ is clearly a regular sequence in the
polynomial ring $S$, we see that
(More on Algebra, Lemma \ref{more-algebra-lemma-regular-koszul-regular})
that the Koszul complex $K_\bullet$ is exact, except in degree $0$
where the cohomology is $S/(X_0, \ldots, X_n)$.
Note that $K_\bullet$ becomes a complex of graded modules if we
put the generators of $K_i$ in degree $+i$. In other words an
exact complex
$$
0 \to S(-n - 1) \to \ldots \to S(-n - 1 + i)^{\oplus {n \choose i}} \to \ldots
\to S \to S/(X_0, \ldots, X_n) \to 0
$$
Applying the exact functor $\tilde{\ }$ functor of Constructions, 
Lemma \ref{constructions-lemma-proj-sheaves} and using that
the last term is in the kernel of this functor,
we obtain the exact complex
$$
0 \to \mathcal{O}_X(-n - 1) \to \ldots
\to \mathcal{O}_X(-n - 1 + i)^{\oplus {n + 1 \choose i}} \to
\ldots \to \mathcal{O}_X \to 0
$$
Twisting by the invertible sheaves $\mathcal{O}_X(n + a)$
we get the exact complexes of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-generator-P1}
Let $A$ be a ring. Let $X = \mathbf{P}^n_A$. Then
$$
E =
\mathcal{O}_X \oplus \mathcal{O}_X(-1) \oplus \ldots \oplus \mathcal{O}_X(-n)
$$
is a generator
(Derived Categories, Definition \ref{derived-definition-generators})
of $D_\QCoh(X)$.
\end{lemma}

\begin{proof}
Let $K \in D_\QCoh(\mathcal{O}_X)$. Assume
$\Hom(E, K[p]) = 0$ for all $p \in \mathbf{Z}$.
We have to show that $K = 0$.
By Derived Categories, Lemma
\ref{derived-lemma-right-orthogonal}
we see that $\Hom(E', K[p])$ is zero for all $E' \in \langle E \rangle$
and $p \in \mathbf{Z}$.
By Lemma \ref{lemma-construct-the-next-one}
applied with $a = -n - 1$
we see that $\mathcal{O}_X(-n - 1) \in \langle E \rangle$
because it is quasi-isomorphic to a finite complex
whose terms are finite direct sums of summands of $E$.
Repeating the argument with $a = -n - 2$ we see that
$\mathcal{O}_X(-n - 2) \in \langle E \rangle$.
Arguing by induction we find that $\mathcal{O}_X(-m) \in \langle E \rangle$
for all $m \geq 0$.
Since
$$
\Hom(\mathcal{O}_X(-m), K[p]) =
H^p(X, K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_X(m)) =
H^p(X, K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{O}_X(1)^{\otimes m})
$$
we conclude that $K = 0$ by Lemma \ref{lemma-nonzero-some-cohomology}.
(This also uses that $\mathcal{O}_X(1)$ is an ample
invertible sheaf on $X$ which follows from
Properties, Lemma \ref{properties-lemma-open-in-proj-ample}.)
\end{proof}

\begin{remark}
\label{remark-pullback-generator}
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated schemes.
Let $E \in D_\QCoh(\mathcal{O}_Y)$ be a generator
(see Theorem \ref{theorem-bondal-van-den-Bergh}).
Then the following are equivalent
\begin{enumerate}
\item for $K \in D_\QCoh(\mathcal{O}_X)$ we have
$Rf_*K = 0$ if and only if $K = 0$,
\item $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$
reflects isomorphisms, and
\item $Lf^*E$ is a generator for $D_\QCoh(\mathcal{O}_X)$.
\end{enumerate}
The equivalence between (1) and (2) is a formal consequence of the fact that
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ is an
exact functor of triangulated categories. Similarly, the equivalence
between (1) and (3) follows formally from the fact that $Lf^*$
is the left adjoint to $Rf_*$.
These conditions hold if $f$ is affine (Lemma \ref{lemma-affine-morphism})
or if $f$ is an open immersion, or if $f$ is a composition of such.
We conclude that
\begin{enumerate}
\item if $X$ is a quasi-affine scheme then $\mathcal{O}_X$ is a generator
for $D_\QCoh(\mathcal{O}_X)$,
\item if $X \subset \mathbf{P}^n_A$ is a quasi-compact
locally closed subscheme, then
$\mathcal{O}_X \oplus \mathcal{O}_X(-1) \oplus \ldots \oplus \mathcal{O}_X(-n)$
is a generator for $D_\QCoh(\mathcal{O}_X)$ by
Lemma \ref{lemma-generator-P1}.
\end{enumerate}
\end{remark}




\section{Compact and perfect objects}
\label{section-compact}

\noindent
Let $X$ be a Noetherian scheme of finite dimension. By
Cohomology, Proposition \ref{cohomology-proposition-vanishing-Noetherian}
and
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-when-jshriek-compact}
the sheaves of modules $j_!\mathcal{O}_U$ are compact objects
of $D(\mathcal{O}_X)$ for all opens $U \subset X$.
These sheaves are typically not quasi-coherent, hence these
do not give perfect object of the derived category $D(\mathcal{O}_X)$.
However, if we restrict ourselves to complexes with quasi-coherent
cohomology sheaves, then this does not happen.
Here is the precise statement.

\begin{proposition}
\label{proposition-compact-is-perfect}
Let $X$ be a quasi-compact and quasi-separated scheme.
An object of $D_\QCoh(\mathcal{O}_X)$ is compact
if and only if it is perfect.
\end{proposition}

\begin{proof}
By Cohomology, Lemma \ref{cohomology-lemma-perfect-is-compact}
the perfect objects define compact objects of $D(\mathcal{O}_X)$.
Conversely, let $K$ be a compact object of $D_\QCoh(\mathcal{O}_X)$.
To show that $K$ is perfect, it suffices to show that
$K|_U$ is perfect for every affine open $U \subset X$, see
Cohomology, Lemma \ref{cohomology-lemma-perfect-independent-representative}.
Observe that $j : U \to X$ is a quasi-compact and separated morphism.
Hence
$Rj_* : D_\QCoh(\mathcal{O}_U) \to D_\QCoh(\mathcal{O}_X)$
commutes with direct sums, see
Lemma \ref{lemma-quasi-coherence-pushforward-direct-sums}.
Thus the adjointness of restriction to $U$ and $Rj_*$ implies that
$K|_U$ is a compact object of $D_\QCoh(\mathcal{O}_U)$.
Hence we reduce to the case that $X$ is affine.

\medskip\noindent
Assume $X = \Spec(A)$ is affine. By Lemma \ref{lemma-affine-compare-bounded}
the problem is translated into the same problem for $D(A)$.
For $D(A)$ the result is
More on Algebra, Proposition \ref{more-algebra-proposition-perfect-is-compact}.
\end{proof}

\noindent
The following result is a strengthening of
Proposition \ref{proposition-compact-is-perfect}.
Let $T \subset X$ be a closed subset of a scheme $X$. As before
$D_T(\mathcal{O}_X)$ denotes the the strictly full, saturated,
triangulated subcategory consisting of complexes whose
cohomology sheaves are supported on $T$. Since taking direct
sums commutes with taking cohomology sheaves, it follows
that $D_T(\mathcal{O}_X)$ has direct sums and that they are equal
to direct sums in $D(\mathcal{O}_X)$.

\begin{lemma}
\label{lemma-compact-is-perfect-with-support}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $T \subset X$ be a closed subset such that $X \setminus T$
is quasi-compact. An object of $D_{\QCoh, T}(\mathcal{O}_X)$ is compact
if and only if it is perfect as an object of $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
We observe that $D_{\QCoh, T}(\mathcal{O}_X)$ is a triangulated
category with direct sums by the remark preceding the lemma.
By Cohomology, Lemma \ref{cohomology-lemma-perfect-is-compact}
the perfect objects define compact objects of $D(\mathcal{O}_X)$
hence a fortiori of any subcategory preserved under taking direct
sums. For the converse we will use there exists a generator
$E \in D_{\QCoh, T}(\mathcal{O}_X)$ which is a perfect complex
of $\mathcal{O}_X$-modules, see
Lemma \ref{lemma-generator-with-support}.
Hence by the above, $E$ is compact. Then it follows from
Derived Categories, Proposition
\ref{derived-proposition-generator-versus-classical-generator}
that $E$ is a classical generator of the full subcategory
of compact objects of $D_{\QCoh, T}(\mathcal{O}_X)$.
Thus any compact object can be constructed out of $E$ by
a finite sequence of operations consisting of
(a) taking shifts, (b) taking finite direct sums, (c) taking cones, and
(d) taking direct summands. Each of these operations preserves
the property of being perfect and the result follows.
\end{proof}

\noindent
The following lemma is an application of the ideas that go into
the proof of the preceding lemma.

\begin{lemma}
\label{lemma-map-from-pseudo-coherent-to-complex-with-support}
Let $X$ be a quasi-compact and quasi-separated scheme. Let $T \subset X$
be a closed subset such that $U = X \setminus T$ is quasi-compact.
Let $\alpha : P \to E$ be a morphism of $D_\QCoh(\mathcal{O}_X)$ with
either
\begin{enumerate}
\item $P$ is perfect and $E$ supported on $T$, or
\item $P$ pseudo-coherent, $E$ supported on $T$, and $E$ bounded below.
\end{enumerate}
Then there exists a perfect complex of $\mathcal{O}_X$-modules $I$
and a map $I \to \mathcal{O}_X[0]$ such that
$I \otimes^\mathbf{L} P \to E$ is zero and such that
$I|_U \to \mathcal{O}_U[0]$ is an
isomorphism.
\end{lemma}

\begin{proof}
Set $\mathcal{D} = D_{\QCoh, T}(\mathcal{O}_X)$. In both cases the complex
$K = R\SheafHom(P, E)$ is an object of $\mathcal{D}$. See
Lemma \ref{lemma-quasi-coherence-internal-hom} for quasi-coherence.
It is clear that $K$ is supported on $T$ as formation of $R\SheafHom$
commutes with restriction to opens.
The map $\alpha$ defines an element of
$H^0(K) = \Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X[0], K)$.
Then it suffices to prove the result for the map
$\alpha : \mathcal{O}_X[0] \to K$.

\medskip\noindent
Let $E \in \mathcal{D}$ be a perfect generator, see
Lemma \ref{lemma-generator-with-support}. Write
$$
K = \text{hocolim} K_n
$$
as in Derived Categories, Lemma \ref{derived-lemma-write-as-colimit}
using the generator $E$. Since the functor $\mathcal{D} \to D(\mathcal{O}_X)$
commutes with direct sums, we see that $K = \text{hocolim} K_n$
also in $D(\mathcal{O}_X)$. Since $\mathcal{O}_X$ is a compact
object of $D(\mathcal{O}_X)$ we find an $n$ and a morphism
$\alpha_n : \mathcal{O}_X \to K_n$ which gives rise to $\alpha$.
By Derived Categories, Lemma \ref{derived-lemma-factor-through}
applied to the morphism $\mathcal{O}_X[0] \to K_n$ in the ambient
category $D(\mathcal{O}_X)$ we see that $\alpha_n$ factors as
$\mathcal{O}_X[0] \to Q \to K_n$ where $Q$ is an object
of $\langle E \rangle$. We conclude that $Q$ is a perfect complex
supported on $T$.

\medskip\noindent
Choose a distinguished triangle
$$
I \to \mathcal{O}_X[0] \to Q \to I[1]
$$
By construction $I$ is perfect, the map $I \to \mathcal{O}_X[0]$
restricts to an isomorphism over $U$, and the composition
$I \to K$ is zero as $\alpha$ factors through $Q$.
This proves the lemma.
\end{proof}



\section{Derived categories as module categories}
\label{section-derived-is-dga}

\noindent
In this section we draw some conclusions of what has gone before.
Before we do so we need a couple more lemmas.

\begin{lemma}
\label{lemma-tensor-with-QCoh-complex}
Let $X$ be a scheme. Let $K^\bullet$ be a complex of $\mathcal{O}_X$-modules
whose cohomology sheaves are quasi-coherent. Let
$(E, d) = \Hom_{\text{Comp}^{dg}(\mathcal{O}_X)}(K^\bullet, K^\bullet)$
be the endomorphism differential graded algebra. Then the functor
$$
- \otimes_E^\mathbf{L} K^\bullet :
D(E, \text{d}) \longrightarrow D(\mathcal{O}_X)
$$
of
Differential Graded Algebra, Lemma
\ref{dga-lemma-tensor-with-complex-derived}
has image contained in $D_\QCoh(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Let $P$ be a differential graded $E$-module with property (P)
and let $F_\bullet$ be a filtration on $P$ as in
Differential Graded Algebra, Section \ref{dga-section-P-resolutions}.
Then we have
$$
P \otimes_E K^\bullet = \text{hocolim}\ F_iP \otimes_E K^\bullet
$$
Each of the $F_iP$ has a finite filtration whose graded pieces
are direct sums of $E[k]$. The result follows easily.
\end{proof}

\noindent
The following lemma can be strengthened (there is a uniformity
in the vanishing over all $L$ with nonzero cohomology sheaves
only in a fixed range).

\begin{lemma}
\label{lemma-ext-from-perfect-into-bounded-QCoh}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $K$, $L$ be objects of $D(\mathcal{O}_X)$ with
$K$ perfect and $L$ in $D^b_\QCoh(\mathcal{O}_X)$.
Then $\text{Ext}^n_{D(\mathcal{O}_X)}(K, L)$ is nonzero
for only a finite number of $n$.
\end{lemma}

\begin{proof}
Since $K$ is perfect we have
$$
\text{Ext}^i_{D(\mathcal{O}_X)}(K, L) =
H^i(X, K^\vee \otimes_{\mathcal{O}_X}^\mathbf{L} L)
$$
where $K^\vee$ is the ``dual'' perfect complex to $K$, see
Cohomology, Lemma \ref{cohomology-lemma-dual-perfect-complex}.
Note that $P = K^\vee \otimes_{\mathcal{O}_X}^\mathbf{L} L$
is in $D_\QCoh(X)$ by
Lemmas \ref{lemma-quasi-coherence-tensor-product} and
\ref{lemma-pseudo-coherent} (to see that a perfect complex
has quasi-coherent cohomology sheaves). On the other hand,
the spectral sequence
$$
E_1^{p, q} = H^p(K^\vee \otimes_{\mathcal{O}_X}^\mathbf{L} H^q(L))
\Rightarrow
H^{p + q}(K^\vee \otimes_{\mathcal{O}_X}^\mathbf{L} L) = H^{p + q}(P),
$$
the boundedness of $L$, and the finite tor amplitude of $K^\vee$
show that $P$ has only finitely many nonzero cohomology sheaves.
It follows that $H^n(X, P) = 0$ for $n \ll 0$.
But also $H^n(X, P) = 0$ for $n \gg 0$ by
Cohomology of Schemes, Lemma
\ref{coherent-lemma-vanishing-nr-affines-quasi-separated}
and the spectral sequence expressing $H^n(X, P^\bullet)$
in terms of $H^p(X, H^q(P^\bullet))$ using that the cohomology
sheaves of $P$ are quasi-coherent.
\end{proof}

\noindent
The following result is taken from \cite{BvdB}.

\begin{theorem}
\label{theorem-DQCoh-is-Ddga}
Let $X$ be a quasi-compact and quasi-separated scheme.
Then there exist a differential graded algebra $(E, \text{d})$
with only a finite number of nonzero cohomology groups $H^i(E)$
such that $D_\QCoh(\mathcal{O}_X)$ is equivalent
to $D(E, \text{d})$.
\end{theorem}

\begin{proof}
Let $K^\bullet$ be a K-injective complex of $\mathcal{O}$-modules which
is perfect and generates $D_\QCoh(\mathcal{O}_X)$. Such a
thing exists by Theorem \ref{theorem-bondal-van-den-Bergh}
and the existence of K-injective resolutions. We will show the
theorem holds with
$$
(E, \text{d}) = \Hom_{\text{Comp}^{dg}(\mathcal{O}_X)}(K^\bullet, K^\bullet)
$$
where $\text{Comp}^{dg}(\mathcal{O}_X)$ is the differential graded category
of complexes of $\mathcal{O}$-modules. Please see
Differential Graded Algebra, Section \ref{dga-section-variant-base-change}.
Since $K^\bullet$ is K-injective we
have
\begin{equation}
\label{equation-E-is-OK}
H^n(E) = \text{Ext}^n_{D(\mathcal{O}_X)}(K^\bullet, K^\bullet)
\end{equation}
for all $n \in \mathbf{Z}$. Only a finite number of these Exts
are nonzero by Lemma \ref{lemma-ext-from-perfect-into-bounded-QCoh}.
Consider the functor
$$
- \otimes_E^\mathbf{L} K^\bullet :
D(E, \text{d}) \longrightarrow D(\mathcal{O}_X)
$$
of
Differential Graded Algebra, Lemma
\ref{dga-lemma-tensor-with-complex-derived}.
Since $K^\bullet$ is perfect, it defines a compact object of
$D(\mathcal{O}_X)$, see Proposition \ref{proposition-compact-is-perfect}.
Combined with (\ref{equation-E-is-OK}) the functor above is fully
faithful as follows from
Differential Graded Algebra, Lemmas
\ref{dga-lemma-fully-faithful-in-compact-case}. It has a right adjoint
$$
R\Hom(K^\bullet, - ) : D(\mathcal{O}_X) \longrightarrow D(E, \text{d})
$$
by Differential Graded Algebra, Lemmas
\ref{dga-lemma-tensor-with-complex-hom-adjoint}
which is a left quasi-inverse functor by generalities on adjoint
functors. On the other hand, it follows from
Lemma \ref{lemma-tensor-with-QCoh-complex} that we obtain
$$
- \otimes_E^\mathbf{L} K^\bullet :
D(E, \text{d}) \longrightarrow D_\QCoh(\mathcal{O}_X)
$$
and by our choice of $K^\bullet$ as a generator of
$D_\QCoh(\mathcal{O}_X)$ the kernel of the adjoint
restricted to $D_\QCoh(\mathcal{O}_X)$ is zero.
A formal argument shows that we obtain the desired equivalence, see
Derived Categories, Lemma
\ref{derived-lemma-fully-faithful-adjoint-kernel-zero}.
\end{proof}

\begin{remark}
\label{remark-indepedence-choice}
Let $X$ be a quasi-compact and quasi-separated scheme over a ring $R$.
By the construction of the proof of
Theorem \ref{theorem-DQCoh-is-Ddga}
there exists a differential graded algebra $(A, \text{d})$ over $R$
such that $D_\QCoh(X)$ is $R$-linearly equivalent to
$D(A, \text{d})$ as a triangulated category.
One may ask: how unique is $(A, \text{d})$?
The answer is (only) slightly better than just saying that
$(A, \text{d})$ is well defined up to derived equivalence.
Namely, suppose that $(B, \text{d})$ is a second such pair.
Then we have
$$
(A, \text{d}) = \Hom_{\text{Comp}^{dg}(\mathcal{O}_X)}(K^\bullet, K^\bullet)
$$
and
$$
(B, \text{d}) = \Hom_{\text{Comp}^{dg}(\mathcal{O}_X)}(L^\bullet, L^\bullet)
$$
for some K-injective complexes $K^\bullet$ and $L^\bullet$
of $\mathcal{O}_X$-modules corresponding to perfect generators
of $D_\QCoh(\mathcal{O}_X)$. Set
$$
\Omega = \Hom_{\text{Comp}^{dg}(\mathcal{O}_X)}(K^\bullet, L^\bullet)
\quad
\Omega' = \Hom_{\text{Comp}^{dg}(\mathcal{O}_X)}(L^\bullet, K^\bullet)
$$
Then $\Omega$ is a differential graded $B^{opp} \otimes_R A$-module
and $\Omega'$ is a differential graded $A^{opp} \otimes_R B$-module.
Moreover, the equivalence
$$
D(A, \text{d}) \to D_\QCoh(\mathcal{O}_X) \to
D(B, \text{d})
$$
is given by the functor $- \otimes_A^\mathbf{L} \Omega'$ and
similarly for the quasi-inverse. Thus we are in the situation
of Differential Graded Algebra, Remark \ref{dga-remark-hochschild-cohomology}.
If we ever need this remark we will provide a precise statement
with a detailed proof here.
\end{remark}

\begin{example}
\label{example-Pn-module-category}
Let $A$ be a ring. Let $X = \mathbf{P}^n_A = \text{Proj}(S)$
where $S = A[X_0, \ldots, X_n]$. By Lemma \ref{lemma-generator-P1}
we know that
$$
P =
\mathcal{O}_X \oplus \mathcal{O}_X(-1) \oplus \ldots \oplus \mathcal{O}_X(-n)
$$
is a perfect generator of $D_\QCoh(\mathcal{O}_X)$.
Thus we can apply the arguments in the proof of
Theorem \ref{theorem-DQCoh-is-Ddga}
to $P$. This produces a differential graded $A$-algebra $(E, d)$
such that $D_\QCoh(\mathcal{O}_X)$ is equivalent ot $D(E, d)$
and such that
$$
H^i(E) = \text{Ext}^i_X(P, P)
$$
for all $i \in \mathbf{Z}$. As in the proof of
Lemma \ref{lemma-ext-from-perfect-into-bounded-QCoh}
we see that
$$
\text{Ext}^i_X(P, P) = H^i(X, P^\wedge \otimes P) =
\bigoplus\nolimits_{0 \leq a, b \leq n} H^i(X, \mathcal{O}_X(a - b))
$$
By the computation of cohomology of projective space
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring})
we find that
these $\text{Ext}$-groups are zero unless $i = 0$. For $i = 0$
we get the (noncommutative) $A$-algebra
$$
R = \Hom_{D(\mathcal{O}_X)}(P, P) =
\left(
\begin{matrix}
S_0 & S_1 & S_2 & \ldots & \ldots \\
0 & S_0 & S_1 & \ldots & \ldots\\
0 & 0 & S_0 & \ldots & \ldots \\
\ldots & \ldots & \ldots & \ldots & \ldots \\
0 & \ldots & \ldots & \ldots & S_0
\end{matrix}
\right)
$$
with obvious multiplication and addition.
By Differential Graded Algebra, Lemma \ref{dga-lemma-rickard}
we find that $D(R)$ is equivalent to $D(E, d)$ as an $A$-linear
triangulated category and hence that
$$
D_\QCoh(\mathcal{O}_X) \cong D(R)
$$
In words: the derived category of quasi-coherent modules on
projective space is equivalent to the derived category of modules
over a (noncommutative) algebra.
This property of projective space appears to be quite unusual among
all projective schemes over $A$.
\end{example}











\section{Cohomology and base change, IV}
\label{section-cohomology-and-base-change-perfect}

\noindent
This section continues the discussion of
Cohomology of Schemes, Section
\ref{coherent-section-cohomology-and-base-change-perfect}.
First, we have a very general version of the projection
formula for quasi-compact and quasi-separated morphisms of schemes 
and complexes with quasi-coherent cohomology sheaves.

\begin{lemma}
\label{lemma-cohomology-base-change}
Let $f : X \to Y$ be a quasi-compact and quasi-separated morphism
of schemes. For $E$ in $D_\QCoh(\mathcal{O}_X)$ and
$K$ in $D_\QCoh(\mathcal{O}_Y)$ the map
$$
Rf_*(E) \otimes_{\mathcal{O}_Y}^\mathbf{L} K
\longrightarrow
Rf_*(E \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*K)
$$
defined in
Cohomology, Equation (\ref{cohomology-equation-projection-formula-map})
is an isomorphism.
\end{lemma}

\begin{proof}
To check the map is an isomorphism we may work locally on $Y$.
Hence we reduce to the case that $Y$ is affine.

\medskip\noindent
Suppose that $K = \bigoplus K_i$ is a direct
sum of some complexes $K_i \in D_\QCoh(\mathcal{O}_Y)$.
If the statement holds for each $K_i$, then it holds for $K$.
Namely, the functors $Lf^*$ and $\otimes^\mathbf{L}$ preserve
direct sums by construction and $Rf_*$ commutes with direct sums
(for complexes with quasi-coherent cohomology sheaves) by
Lemma \ref{lemma-quasi-coherence-pushforward-direct-sums}.
Moreover, suppose that $K \to L \to M \to K[1]$ is a distinguished
triangle in $D_\QCoh(Y)$. Then if the statement of the
lemma holds for two of $K, L, M$, then it holds for the third
(as the functors involved are exact functors of triangulated categories).

\medskip\noindent
Assume $Y$ affine, say $Y = \Spec(A)$. The functor
$\widetilde{\ } : D(A) \to D_\QCoh(\mathcal{O}_Y)$ is an equivalence
(Lemma \ref{lemma-affine-compare-bounded}).
Let $T$ be the property for $K \in D(A)$ that
the statement of the lemma holds for $\widetilde{K}$.
The discussion above and
More on Algebra, Remark \ref{more-algebra-remark-P-resolution}
shows that it suffices to prove $T$ holds for $A[k]$.
This finishes the proof, as the statement of the lemma
is clear for shifts of the structure sheaf.
\end{proof}

\begin{definition}
\label{definition-tor-independent}
Let $S$ be a scheme. Let $X$, $Y$ be schemes over $S$. We say $X$ and
$Y$ are {\it Tor independent over $S$} if for every $x \in X$ and
$y \in Y$ mapping to the same point $s \in S$ the rings
$\mathcal{O}_{X, x}$ and $\mathcal{O}_{Y, y}$ are Tor independent
over $\mathcal{O}_{S, s}$ (see
More on Algebra, Definition \ref{more-algebra-definition-tor-independent}).
\end{definition}

\begin{lemma}
\label{lemma-compare-base-change}
Let $g : S' \to S$ be a morphism of schemes.
Let $f : X \to S$ be quasi-compact and quasi-separated.
Consider the base change diagram
$$
\xymatrix{
X' \ar[r]_h \ar[d]_{f'} &
X \ar[d]^f \\
S' \ar[r]^g &
S
}
$$
If $X$ and $S'$ are Tor independent over $S$, then for all
$E \in D_\QCoh(\mathcal{O}_X)$ we have
$Rf'_*Lh^*E = Lg^*Rf_*E$.
\end{lemma}

\begin{proof}
For any object $E$ of $D(\mathcal{O}_X)$ we can use
Cohomology, Remark \ref{cohomology-remark-base-change} to get a
canonical base change map $Lg^*Rf_*E \to Rf'_*Lh^*E$. To check this
is an isomorphism we may work locally on $S'$. Hence we may assume
$g : S' \to S$ is a morphism of affine schemes. In particular, $g$
is affine and it suffices to show that
$$
Rg_*Lg^*Rf_*E \to Rg_*Rf'_*Lh^*E = Rf_*(Rh_* Lh^* E)
$$
is an isomorphism, see Lemma \ref{lemma-affine-morphism}
(and use Lemmas \ref{lemma-quasi-coherence-pullback},
\ref{lemma-quasi-coherence-tensor-product}, and
\ref{lemma-quasi-coherence-direct-image}
to see that the objects $Rf'_*Lh^*E$ and $Lg^*Rf_*E$
have quasi-coherent cohomology sheaves). Note that $h$ is
affine as well (Morphisms, Lemma \ref{morphisms-lemma-base-change-affine}).
By Lemma \ref{lemma-affine-morphism-pull-push} the map becomes a map
$$
Rf_*E \otimes_{\mathcal{O}_S}^\mathbf{L} g_*\mathcal{O}_{S'}
\longrightarrow
Rf_*(E \otimes_{\mathcal{O}_X}^\mathbf{L} h_*\mathcal{O}_{X'})
$$
Observe that $h_*\mathcal{O}_{X'} = f^*g_*\mathcal{O}_{S'}$. Thus by
Lemma \ref{lemma-cohomology-base-change} it suffices to prove that
$Lf^*g_*\mathcal{O}_{S'} = f^*g_*\mathcal{O}_{S'}$. This follows from our
assumption that $X$ and $S'$ are Tor independent over $S$. Namely, to
check it we may work locally on $X$, hence we may also assume $X$ is affine.
Say $X = \Spec(A)$, $S = \Spec(R)$ and $S' = \Spec(R')$. Our assumption
implies that $A$ and $R'$ are Tor independent over $R$
(More on Algebra, Lemma \ref{more-algebra-lemma-tor-independent}), i.e.,
$\text{Tor}_i^R(A, R') = 0$ for $i > 0$. In other words
$A \otimes_R^\mathbf{L} R' = A \otimes_R R'$ which exactly means
that $Lf^*g_*\mathcal{O}_{S'} = f^*g_*\mathcal{O}_{S'}$
(use Lemma \ref{lemma-quasi-coherence-pullback}).
\end{proof}

\noindent
The following two lemmas remain true if we replace $\mathcal{G}$ with a
bounded complex of quasi-coherent $\mathcal{O}_X$-modules each flat over $S$.

\begin{lemma}
\label{lemma-base-change-tensor}
Let $f : X \to S$ be a quasi-compact and quasi-separated morphism of
schemes. Let $E \in D_\QCoh(\mathcal{O}_X)$. Let $\mathcal{G}$
be a quasi-coherent $\mathcal{O}_X$-module flat over $S$.
Then formation of
$$
Rf_*(E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})
$$
commutes with arbitrary base change (see proof for precise statement).
\end{lemma}

\begin{proof}
The statement means the following. Let $g : S' \to S$ be a morphism of
schemes and consider the base change diagram
$$
\xymatrix{
X' \ar[r]_h \ar[d]_{f'} &
X \ar[d]^f \\
S' \ar[r]^g &
S
}
$$
in other words $X' = S' \times_S X$. Set $E' = Lh^*E$ and
$\mathcal{G}' = h^*\mathcal{G}$ (here we do {\bf not} use the derived
pullback). The lemma asserts that we have
$$
Lg^*Rf_*(E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G}) =
Rf'_*(E' \otimes^\mathbf{L}_{\mathcal{O}_{X'}} \mathcal{G}')
$$
To prove this, note that in
Cohomology, Remark \ref{cohomology-remark-base-change}
we have constructed an arrow
$$
Lg^*Rf_*(E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})
\longrightarrow
R(f')_*(Lh^*(E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})) =
R(f')_*(E' \otimes^\mathbf{L}_{\mathcal{O}_X} Lh^*\mathcal{G})
$$
which we can compose with the map $Lh^*\mathcal{G} \to h^*\mathcal{G}$
to get a canonical map
$$
Lg^*Rf_*(E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})
\longrightarrow
Rf'_*(E' \otimes^\mathbf{L}_{\mathcal{O}_{X'}} \mathcal{G}')
$$
To check this map is an isomorphism we may work locally on $S'$.
Hence we may assume $g : S' \to S$ is a morphism of affine schemes.
In this case, we will use the induction principle to prove this map
is always an isomorphism for any quasi-compact and quasi-separated $X$
over $S$
(Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}).

\medskip\noindent
Suppose $X = \Spec(A)$ is affine. The functor
$\widetilde{\ } : D(A) \to D_\QCoh(\mathcal{O}_X)$ is an equivalence
(Lemma \ref{lemma-affine-compare-bounded}).
Let $T$ be the property for $K \in D(A)$ that
the canonical arrow above is an isomorphism for $E = \widetilde{K}$.
If we have $T(K_i)$ for a family of objects
$K_i$, then we have $T(\bigoplus K_i)$. Namely, derived tensor product
and derived pullback commute with direct sums and the same holds for
total direct image in this case by
Lemma \ref{lemma-quasi-coherence-pushforward-direct-sums}.
Moreover, if $T$ holds for two out of three
objects of a distinguished triangle, then it holds for the third
(Derived Categories, Lemma \ref{derived-lemma-third-isomorphism-triangle}).
By More on Algebra, Remark \ref{more-algebra-remark-P-resolution}
this shows that it suffices to prove $T$ holds for $A[k]$.
This reduces us to the case $E = \mathcal{O}_X$. In this case
we are saying that $Lg^*f_*\mathcal{G} = g^*f_*\mathcal{G}$
(by flatness of $\mathcal{G}$ over $S$)
equals $f'_*h^*\mathcal{G}$ which holds by
Cohomology of Schemes, Lemma \ref{coherent-lemma-affine-base-change}.

\medskip\noindent
The induction step. Suppose that $X = U \cup V$ is an open covering
with $U$, $V$, $U \cap V$
quasi-compact such that the result holds for the restriction of $E$ and
$\mathcal{G}$ to $U$, $V$, and $U \cap V$. Denote $a = f|_U$,
$b = f|_V$ and $c = f|_{U \cap V}$. Let $a' : U' \to S'$, $b' : V' \to S'$
and $c' : U' \cap V' \to S'$ be the base changes of $a$, $b$, and $c$.
Note that formation of $- \otimes^\mathbf{L} -$ commutes with restriction
to opens. Set $H = E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G}$ and
$H' = E' \otimes^\mathbf{L}_{\mathcal{O}_{X'}} \mathcal{G}'$.
Using the distinguished triangles from relative Mayer-Vietoris
(Cohomology, Lemma \ref{cohomology-lemma-unbounded-relative-mayer-vietoris})
we obtain a commutative diagram
$$
\xymatrix{
Lg^*Rf_* H \ar[r] \ar[d] &
Rf'_* H' \ar[d] \\
Lg^*Ra_* H|_U \oplus
Lg^*Rb_* H|_V \ar[r] \ar[d] &
Ra'_* H'|_{U'} \oplus
Rb'_* H'|_{V'} \ar[d] \\
Lg^*Rc_* H|_{U \cap V} \ar[r] \ar[d] &
Rc'_* H'|_{U' \cap V'} \ar[d] \\
Lg^*Rf_* H[1] \ar[r] &
Rf'_* H'[1]
}
$$
Since the 2nd and 3rd horizontal arrows are isomorphisms so is the first
(Derived Categories, Lemma \ref{derived-lemma-third-isomorphism-triangle})
and the proof of the lemma is finished.
\end{proof}

\begin{lemma}
\label{lemma-base-change-RHom}
Let $f : X \to S$ be a quasi-compact and quasi-separated morphism of schemes.
Let $E \in D(\mathcal{O}_X)$ be perfect. Let $\mathcal{G}$ be a quasi-coherent
$\mathcal{O}_X$-module flat over $S$. Then formation of
$$
Rf_*R\SheafHom(E, \mathcal{G})
$$
commutes with arbitrary base change (see proof for precise statement).
\end{lemma}

\begin{proof}
The statement means the following. Let $g : S' \to S$ be a morphism of
schemes and consider the base change diagram
$$
\xymatrix{
X' \ar[r]_h \ar[d]_{f'} &
X \ar[d]^f \\
S' \ar[r]^g &
S
}
$$
in other words $X' = S' \times_S X$. Set $E' = Lh^*E$ and
$\mathcal{G}' = h^*\mathcal{G}$ (here we do {\bf not} use the derived
pullback). The lemma asserts that we have
$$
Lg^*Rf_*R\SheafHom(E, \mathcal{G}) = Rf'_*R\SheafHom(E', \mathcal{G}')
$$
To prove this, note that in
Cohomology, Remark \ref{cohomology-remark-fancy-base-change}
we have constructed an arrow
$$
Lg^*Rf_*R\SheafHom(E, \mathcal{G})
\longrightarrow
R(f')_*R\SheafHom(Lh^*E, Lh^*\mathcal{G})
$$
which we can compose with the map $Lh^*\mathcal{G} \to h^*\mathcal{G}$
to get a canonical map
$$
Lg^*Rf_*R\SheafHom(E, \mathcal{G}) \to Rf'_*R\SheafHom(E', \mathcal{G}')
$$
With these preliminaries out of the way, we deduce the result from
Lemma \ref{lemma-base-change-tensor}. Namely, since $E$ is a perfect
complex there exists a dual perfect complex $E_{dual}$, see
Cohomology, Lemma \ref{cohomology-lemma-dual-perfect-complex}, such
that $R\SheafHom(E, \mathcal{G}) =
E_{dual} \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{G}$.
We omit the verification that the base change map of
Lemma \ref{lemma-base-change-tensor} for $E_{dual}$ agrees with the
base change map for $E$ constructed above.
\end{proof}

\noindent
The following lemma will be used in the chapter on dualizing complexes.

\begin{lemma}
\label{lemma-affine-morphism-and-hom-out-of-perfect}
Consider a cartesian square
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
S' \ar[r]^g & S
}
$$
of quasi-compact and quasi-separated schemes with $g$ and $f$ Tor independent.
Assume $S = \Spec(R)$ and $S' = \Spec(R')$ affine. We have
$$
R\Hom(M, K \otimes^\mathbf{L}_{\mathcal{O}_X} g'_*\mathcal{O}_{X'}) =
R\Hom(M, K) \otimes^\mathbf{L}_R R'
$$
(see Cohomology, Section \ref{cohomology-section-global-RHom} for notation)
in the following two cases
\begin{enumerate}
\item $M \in D(\mathcal{O}_X)$ is perfect and $K \in D_\QCoh(X)$, or
\item $M \in D(\mathcal{O}_X)$ is pseudo-coherent,
$K \in D_\QCoh^+(X)$, and $R'$ has finite tor dimension over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof in case (1). The complex $R\SheafHom(M, K)$ is an object of
$D_\QCoh(\mathcal{O}_X)$ by Lemma \ref{lemma-quasi-coherence-internal-hom}.
There is a natural map
$$
R\SheafHom(M, K) \otimes_{\mathcal{O}_X}^\mathbf{L} g'_*\mathcal{O}_{X'}
\longrightarrow
R\SheafHom(M, K \otimes_{\mathcal{O}_X}^\mathbf{L} g'_*\mathcal{O}_{X'})
$$
which is an isomorphism, see
Lemma \ref{lemma-internal-hom-evaluate-tensor-isomorphism}.
Hence, by replacing $K$ by $R\SheafHom(M, K)$ we reduce to proving
$$
R\Gamma(X, K \otimes^\mathbf{L}_{\mathcal{O}_X} g'_*\mathcal{O}_{X'})
= R\Gamma(X, K) \otimes^\mathbf{L}_A A'
$$
Note that the left hand side is equal to $R\Gamma(X', L(g')^*K)$
by Lemma \ref{lemma-affine-morphism-pull-push}.
Hence the result follows from
Lemma \ref{lemma-compare-base-change}.

\medskip\noindent
Proof in case (2). The exact same argument works; the only change is that
we have to verify that
Lemma \ref{lemma-internal-hom-evaluate-tensor-isomorphism} applies.
We have $g'_*\mathcal{O}_{X'} = Rg'_*\mathcal{O}_{X'} =
Lf^*g_*\mathcal{O}_X$ the second equality by
Lemma \ref{lemma-compare-base-change}.
Using Lemma \ref{lemma-tor-dimension-affine} and
Cohomology, Lemma \ref{cohomology-lemma-tor-amplitude-pullback}
we conclude that $g'_*\mathcal{O}_{X'}$ has finite Tor dimension
as desired.
\end{proof}



\section{Producing perfect complexes}
\label{section-producing-perfect}

\noindent
The following lemma is our main technical tool for producing
perfect complexes. Later versions of this result will reduce to
this by Noetherian approximation, see
Section \ref{section-cohomology-and-base-change-final}.

\begin{lemma}
\label{lemma-perfect-direct-image}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E \in D(\mathcal{O}_X)$ such that
\begin{enumerate}
\item $E \in D^b_{\textit{Coh}}(\mathcal{O}_X)$,
\item the scheme theoretic support of $H^i(E)$ is proper over $S$ for all $i$,
\item $E$ has finite tor dimension as an object of $D(f^{-1}\mathcal{O}_S)$.
\end{enumerate}
Then $Rf_*E$ is a perfect object of $D(\mathcal{O}_S)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-direct-image-coherent} we see that $Rf_*E$ is an object of
$D^b_{\textit{Coh}}(\mathcal{O}_S)$. Hence $Rf_*E$ is pseudo-coherent
(Lemma \ref{lemma-identify-pseudo-coherent-noetherian}).
Hence it suffices to show that $Rf_*E$ has finite tor dimension, see
Cohomology, Lemma \ref{cohomology-lemma-perfect}.
By Lemma \ref{lemma-tor-qc-qs} it suffices to check that
$Rf_*(E) \otimes_{\mathcal{O}_S}^\mathbf{L} \mathcal{F}$
has universally bounded cohomology for all quasi-coherent
sheaves $\mathcal{F}$ on $S$. Bounded from above is clear as $Rf_*(E)$
is bounded from above. Let $T \subset X$ be the union of the supports
of $H^i(E)$ for all $i$. Then $T$ is proper over $S$ by assumptions (1)
and (2). In particular there exists a quasi-compact open
$X' \subset X$ containing $T$. Setting $f' = f|_{X'}$ we have
$Rf_*(E) = Rf'_*(E|_{X'})$ because $E$ restricts to zero on $X \setminus T$.
Thus we may replace $X$ by $X'$ and assume $f$ is quasi-compact.
Moreover, $f$ is quasi-separated by Morphisms, Lemma
\ref{morphisms-lemma-finite-type-Noetherian-quasi-separated}. Now
$$
Rf_*(E) \otimes_{\mathcal{O}_S}^\mathbf{L} \mathcal{F} =
Rf_*\left(E \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*\mathcal{F}\right) =
Rf_*\left(E \otimes_{f^{-1}\mathcal{O}_S}^\mathbf{L} f^{-1}\mathcal{F}\right)
$$
by
Lemma \ref{lemma-cohomology-base-change}
and
Cohomology, Lemma \ref{cohomology-lemma-variant-derived-pullback}.
By assumption (3) the complex
$E \otimes_{f^{-1}\mathcal{O}_S}^\mathbf{L} f^{-1}\mathcal{F}$
has cohomology sheaves in a
given finite range, say $[a, b]$. Then $Rf_*$ of it
has cohomology in the range $[a, \infty)$ and we win.
\end{proof}

\noindent
We will generalize the following lemma to flat and proper morphisms
over general bases in
Lemma \ref{lemma-flat-proper-perfect-direct-image-general}
and to perfect proper morphisms in
More on Morphisms, Lemma
\ref{more-morphisms-lemma-perfect-proper-perfect-direct-image}.

\begin{lemma}
\label{lemma-flat-proper-perfect-direct-image}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a flat proper
morphism of schemes. Let $E \in D(\mathcal{O}_X)$ be perfect. Then
$Rf_*E$ is a perfect object of $D(\mathcal{O}_S)$.
\end{lemma}

\begin{proof}
We claim that Lemma \ref{lemma-perfect-direct-image} applies.
Conditions (1) and (2) are immediate. Condition (3) is local
on $X$. Thus we may assume $X$ and $S$ affine and $E$
represented by a strictly perfect complex of $\mathcal{O}_X$-modules.
Since $\mathcal{O}_X$ is flat as a sheaf of $f^{-1}\mathcal{O}_S$-modules
we find that condition (3) is satisfied.
\end{proof}






\section{Cohomology, Ext groups, and base change}
\label{section-ext}

\noindent
The results in this section will be used to verify one of Artin's criteria
for Quot functors, Hilbert schemes, and other moduli problems.

\begin{lemma}
\label{lemma-compute-tensor-perfect}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E \in D(\mathcal{O}_X)$ be perfect.
Let $\mathcal{G}$ be a coherent $\mathcal{O}_X$-module flat over $S$
with scheme theoretic support proper over $S$. Then
$K = Rf_*(E \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{G})$ is a perfect
object of $D(\mathcal{O}_S)$ and there are functorial isomorphisms
$$
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F})
\longrightarrow
H^i(X, E \otimes_{\mathcal{O}_X}^\mathbf{L}
(\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}))
$$
for $\mathcal{F}$ quasi-coherent on $S$
compatible with boundary maps (see proof).
\end{lemma}

\begin{proof}
We have
$$
\mathcal{G} \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*\mathcal{F} =
\mathcal{G} \otimes_{f^{-1}\mathcal{O}_S}^\mathbf{L} f^{-1}\mathcal{F} =
\mathcal{G} \otimes_{f^{-1}\mathcal{O}_S} f^{-1}\mathcal{F} =
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}
$$
the first equality by
Cohomology, Lemma \ref{cohomology-lemma-variant-derived-pullback},
the second as $\mathcal{G}$ is a flat $f^{-1}\mathcal{O}_S$-module, and
the third by definition of pullbacks. Hence we obtain
\begin{align*}
H^i(X, E \otimes^\mathbf{L}_{\mathcal{O}_X}
(\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}))
& =
H^i(X, E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G}
\otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*\mathcal{F}) \\
& =
H^i(S,
Rf_*(E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G}
\otimes^\mathbf{L}_{\mathcal{O}_X} Lf^*\mathcal{F})) \\
& =
H^i(S, Rf_*(E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})
\otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}) \\
& =
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}) 
\end{align*}
The first equality by the above, the second by Leray
(Cohomology, Lemma \ref{cohomology-lemma-before-Leray}), and
the third equality by Lemma \ref{lemma-cohomology-base-change}.
The object $K$ is perfect by Lemma \ref{lemma-perfect-direct-image}.
We check the lemma applies: Locally $E$ is isomorphic to a finite complex
of finite free $\mathcal{O}_X$-modules. Hence locally
$E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G}$ is isomorphic
to a finite complex whose terms are finite direct sums of copies
$\mathcal{G}$. This immediately implies the hypotheses on the
cohomology sheaves $H^i(E \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})$.
The hypothesis on the tor dimension also follows as $\mathcal{G}$
is flat over $f^{-1}\mathcal{O}_S$.

\medskip\noindent
The statement on boundary maps means the following: Given a short
exact sequence $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
of quasi-coherent $\mathcal{O}_S$-modules, the isomorphisms fit into
commutative diagrams
$$
\xymatrix{
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_3)
\ar[r] \ar[d]_\delta &
H^i(X, E \otimes^\mathbf{L}_{\mathcal{O}_X}
(\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_3)) \ar[d]^\delta \\
H^{i + 1}(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1)
\ar[r] &
H^{i + 1}(X, E \otimes^\mathbf{L}_{\mathcal{O}_X}
(\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_1))
}
$$
where the boundary maps come from the distinguished triangle
$$
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_2 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_3 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1[1]
$$
and the distinguished triangle in $D(\mathcal{O}_X)$ associated to
the short exact sequence
$$
0 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_1 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_2 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_3 \to 0
$$
This sequence is exact because $\mathcal{G}$ is flat over $S$.
We omit the verification of the commutativity of the displayed diagram.
\end{proof}

\begin{lemma}
\label{lemma-compute-ext-perfect}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E \in D(\mathcal{O}_X)$ be perfect.
Let $\mathcal{G}$ be a coherent $\mathcal{O}_X$-module flat over $S$
with scheme theoretic support proper over $S$.
Then $K = Rf_*R\SheafHom(E, \mathcal{G})$ is a perfect object of
$D(\mathcal{O}_S)$ and there are functorial isomorphisms
$$
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F})
\longrightarrow
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
$$
for $\mathcal{F}$ quasi-coherent on $S$
compatible with boundary maps (see proof).
\end{lemma}

\begin{proof}
Since $E$ is a perfect complex there exists a dual perfect complex
$E_{dual}$, see Cohomology, Lemma \ref{cohomology-lemma-dual-perfect-complex}.
Observe that $R\SheafHom(E, \mathcal{G}) =
E_{dual} \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G}$ and that
$$
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
=
H^i(X, E_{dual} \otimes^\mathbf{L}_{\mathcal{O}_X}
(\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}))
$$
by construction of $E_{dual}$. Thus the perfectness of $K$ and
the isomorphisms follow from the corresponding results of
Lemma \ref{lemma-compute-tensor-perfect} applied to $E_{dual}$
and $\mathcal{G}$.

\medskip\noindent
The statement on boundary maps means the following: Given a short
exact sequence $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
then the isomorphisms fit into commutative diagrams
$$
\xymatrix{
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_3)
\ar[r] \ar[d]_\delta &
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_3) \ar[d]^\delta \\
H^{i + 1}(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1)
\ar[r] &
\text{Ext}^{i + 1}_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_1)
}
$$
where the boundary maps come from the distinguished triangle
$$
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_2 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_3 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1[1]
$$
and the distinguished triangle in $D(\mathcal{O}_X)$ associated to
the short exact sequence
$$
0 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_1 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_2 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_3 \to 0
$$
This sequence is exact because $\mathcal{G}$ is flat over $S$.
We omit the verification of the commutativity of the displayed diagram.
\end{proof}

\begin{lemma}
\label{lemma-compute-ext}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E \in D(\mathcal{O}_X)$
and $\mathcal{G}$ an $\mathcal{O}_X$-module. Assume
\begin{enumerate}
\item $E \in D^-_{\textit{Coh}}(\mathcal{O}_X)$, and
\item $\mathcal{G}$ is a coherent $\mathcal{O}_X$-module flat over $S$
with scheme theoretic support is proper over $S$.
\end{enumerate}
Then for every $m \in \mathbf{Z}$ there exists a perfect object $K$
of $D(\mathcal{O}_S)$ and functorial maps
$$
\alpha^i_\mathcal{F} :
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
\longrightarrow
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F})
$$
for $\mathcal{F}$ quasi-coherent on $S$
compatible with boundary maps (see proof)
such that $\alpha^i_\mathcal{F}$ is an isomorphism for $i \leq m$.
\end{lemma}

\begin{proof}
We may replace $X$ by a quasi-compact open neighbourhood of
the support of $\mathcal{G}$, hence we may assume $X$ is Noetherian.
In this case $X$ and $f$ are quasi-compact and quasi-separated.
Choose an approximation $P \to E$ by a perfect complex $P$ of $(X, E, -m - 1)$
(possible by Theorem \ref{theorem-approximation}).
Then the induced map
$$
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
\longrightarrow
\text{Ext}^i_{\mathcal{O}_X}(P,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
$$
is an isomorphism for $i \leq m$. Namely, the kernel, resp.\ cokernel of this
map is a quotient, resp.\ submodule of
$$
\text{Ext}^i_{\mathcal{O}_X}(C,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
\quad\text{resp.}\quad
\text{Ext}^{i + 1}_{\mathcal{O}_X}(C,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
$$
where $C$ is the cone of $P \to E$. Since $C$ has vanishing cohomology
sheaves in degrees $\geq -m - 1$ these $\text{Ext}$-groups are zero
for $i \leq m + 1$ by
Derived Categories, Lemma \ref{derived-lemma-negative-exts}.
This reduces us to the case that
$E$ is a perfect complex which is Lemma \ref{lemma-compute-ext-perfect}.

\medskip\noindent
The statement on boundaries is explained in the proof of
Lemma \ref{lemma-compute-ext-perfect}.
\end{proof}







\section{Limits and derived categories}
\label{section-limits}

\noindent
In this section we collect some results about the derived category
of a scheme which is the limit of an inverse system of schemes.
More precisely, we will work in the following setting.

\begin{situation}
\label{situation-descent}
Let $S = \lim_{i \in I} S_i$ be a limit of a directed system of schemes
over $S$ with affine transition morphisms $f_{i'i} : S_{i'} \to S_i$.
We assume that $S_i$ is quasi-compact and quasi-separated for all $i \in I$.
We denote $f_i : S \to S_i$ the projection. We also fix an element $0 \in I$.
\end{situation}

\begin{lemma}
\label{lemma-descend-homomorphisms}
In Situation \ref{situation-descent}.
Let $E_0$ and $K_0$ be objects of
$D(\mathcal{O}_{S_0})$.
Set $E_i = Lf_{i0}^*E_0$ and $K_i = Lf_{i0}^*K_0$ for $i \geq 0$
and set $E = Lf_0^*E_0$ and $K = Lf_0^*K_0$. Then the map
$$
\colim_{i \geq 0} \Hom_{D(\mathcal{O}_{S_i})}(E_i, K_i)
\longrightarrow
\Hom_{D(\mathcal{O}_S)}(E, K)
$$
is an isomorphism if either
\begin{enumerate}
\item $E_0$ is perfect and $K_0 \in D_\QCoh(\mathcal{O}_{S_0})$, or
\item $E_0$ is pseudo-coherent and
$K_0 \in D_\QCoh(\mathcal{O}_{S_0})$ has finite tor dimension.
\end{enumerate}
\end{lemma}

\begin{proof}
For every open $U_0 \subset S_0$ consider the condition $P$ that the canonical
map
$$
\colim_{i \geq 0} \Hom_{D(\mathcal{O}_{U_i})}(E_i|_{U_i}, K_i|_{U_i})
\longrightarrow
\Hom_{D(\mathcal{O}_U)}(E|_U, K|_U)
$$
is an isomorphism, where $U = f_0^{-1}(U_0)$ and $U_i = f_{i0}^{-1}(U_0)$.
We will prove $P$ holds for all quasi-compact opens $U_0$
by the induction principle of
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}.
Condition (2) of this lemma follows immediately from Mayer-Vietoris
for hom in the derived category, see
Cohomology, Lemma \ref{cohomology-lemma-mayer-vietoris-hom}.
Thus it suffices to prove the lemma when $S_0$ is affine.

\medskip\noindent
Assume $S_0$ is affine. Say $S_0 = \Spec(A_0)$, $S_i = \Spec(A_i)$, and
$S = \Spec(A)$. We will use Lemma \ref{lemma-affine-compare-bounded}
without further mention.

\medskip\noindent
In case (1) the object $E_0^\bullet$ corresponds to a finite complex
of finite projective $A_0$-modules, see Lemma \ref{lemma-perfect-affine}.
We may represent the object $K_0$ by a K-flat complex $K_0^\bullet$
of $A_0$-modules. In this situation we are trying to prove
$$
\colim_{i \geq 0} \Hom_{D(A_i)}(E_0^\bullet \otimes_{A_0} A_i,
K_0^\bullet \otimes_{A_0} A_i)
\longrightarrow
\Hom_{D(A)}(E_0^\bullet \otimes_{A_0} A, K_0^\bullet \otimes_{A_0} A)
$$
Because $E_0^\bullet$ is a bounded above complex of projective modules
we can rewrite this as
$$
\colim_{i \geq 0} \Hom_{K(A_0)}(E_0^\bullet,
K_0^\bullet \otimes_{A_0} A_i)
\longrightarrow
\Hom_{K(A_0)}(E_0^\bullet, K_0^\bullet \otimes_{A_0} A)
$$
Since there are only a finite number of nonzero modules
$E_0^n$ and since these are all finitely presented modules, this
map is an isomorphism.

\medskip\noindent
In case (2) the object $E_0$ corresponds to a
bounded above complex $E_0^\bullet$ of finite free $A_0$-modules,
see Lemma \ref{lemma-pseudo-coherent-affine}.
We may represent $K_0$ by a finite complex $K_0^\bullet$
of flat $A_0$-modules, see Lemma \ref{lemma-tor-dimension-affine}
and
More on Algebra, Lemma \ref{more-algebra-lemma-tor-amplitude}.
In particular $K_0^\bullet$ is K-flat and we can argue as before
to arrive at the map
$$
\colim_{i \geq 0} \Hom_{K(A_0)}(E_0^\bullet,
K_0^\bullet \otimes_{A_0} A_i)
\longrightarrow
\Hom_{K(A_0)}(E_0^\bullet, K_0^\bullet \otimes_{A_0} A)
$$
It is clear that this map is an isomorphism (only a finite number of
terms are involved since $K_0^\bullet$ is bounded).
\end{proof}

\begin{lemma}
\label{lemma-descend-perfect}
In Situation \ref{situation-descent} the category of perfect
objects of $D(\mathcal{O}_S)$ is the colimit of the categories
of perfect objects of $D(\mathcal{O}_{S_i})$.
\end{lemma}

\begin{proof}
For every open $U_0 \subset S_0$ consider the condition $P$ that
the functor
$$
\colim_{i \geq 0} D_{perf}(\mathcal{O}_{U_i})
\longrightarrow
D_{perf}(\mathcal{O}_U)
$$
is an equivalence where ${}_{perf}$ indicates the full subcategory of
perfect objects and where $U = f_0^{-1}(U_0)$ and $U_i = f_{i0}^{-1}(U_0)$.
We will prove $P$ holds for all quasi-compact opens $U_0$
by the induction principle of
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}.
First, we observe that we already know the functor is fully faithful
by Lemma \ref{lemma-descend-homomorphisms}. Thus it suffices to prove
essential surjectivity.

\medskip\noindent
We first check condition (2) of the induction principle. Thus suppose
that we have $S_0 = U_0 \cup V_0$ and that $P$ holds for
$U_0$, $V_0$, and $U_0 \cap V_0$. Let $E$ be a perfect object
of $D(\mathcal{O}_S)$. We can find $i \geq 0$ and $E_{U, i}$ perfect on $U_i$
and $E_{V, i}$ perfect on $V_i$ whose pullback to $U$ and $V$ are isomorphic
to $E|_U$ and $E|_V$. Denote
$$
a : E_{U, i} \to (Rf_{i, *}E)|_{U_i}
\quad\text{and}\quad
b : E_{V, i} \to (Rf_{i, *}E)|_{V_i}
$$
the maps adjoint to the isomorphisms $Lf_i^*E_{U, i} \to E|_U$
and $Lf_i^*E_{V, i} \to E|_V$.
By fully faithfulness, after increasing $i$,
we can find an isomorphism
$c : E_{U, i}|_{U_i \cap V_i} \to E_{V, i}|_{U_i \cap V_i}$
which pulls back to the identifications 
$$
Lf_i^*E_{U, i}|_{U \cap V} \to E|_{U \cap V} \to Lf_i^*E_{V, i}|_{U \cap V}.
$$
Apply Cohomology, Lemma \ref{cohomology-lemma-glue}
to get an object $E_i$ on $S_i$ and a map $d : E_i \to Rf_{i, *}E$
which restricts to the maps $a$ and $b$ over $U_i$ and $V_i$.
Then it is clear that $E_i$ is perfect and that
$d$ is adjoint to an isomorphism $Lf_i^*E_i \to E$.

\medskip\noindent
Finally, we check condition (1) of the induction principle, in other
words, we check the lemma holds when $S_0$ is affine.
Say $S_0 = \Spec(A_0)$, $S_i = \Spec(A_i)$, and
$S = \Spec(A)$. Using Lemmas \ref{lemma-affine-compare-bounded}
and \ref{lemma-perfect-affine} we see that we have to show that
$$
D_{perf}(A) = \colim D_{perf}(A_i)
$$
This is clear from the fact that perfect complexes over rings are
given by finite complexes of finite projective (hence finitely presented)
modules. See More on Algebra, Lemma
\ref{more-algebra-lemma-colimit-perfect-complexes} for details.
\end{proof}





\section{Cohomology and base change, V}
\label{section-cohomology-and-base-change-final}

\noindent
A final section on cohomology and base change continueing
the discussion of Sections
\ref{section-cohomology-and-base-change-perfect}
and \ref{section-producing-perfect}.
An easy to grok special case is given in
Remark \ref{remark-explain-perfect-direct-image}.

\begin{lemma}
\label{lemma-base-change-tensor-perfect}
Let $f : X \to S$ be a morphism of finite presentation.
Let $E \in D(\mathcal{O}_X)$ be a perfect object. Let $\mathcal{G}$ be a
finitely presented $\mathcal{O}_X$-module, flat over $S$, with support
proper over $S$. Then
$$
K = Rf_*(E \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{G})
$$
is a perfect object of $D(\mathcal{O}_S)$ and its formation
commutes with arbitrary base change.
\end{lemma}

\begin{proof}
The statement on base change is Lemma \ref{lemma-base-change-tensor}.
Thus it suffices to show that $K$ is a perfect object. If $S$ is
Noetherian, then this follows from
Lemma \ref{lemma-compute-tensor-perfect}.
We will reduce to this case by Noetherian approximation.
We encourage the reader to skip the rest of this proof.

\medskip\noindent
The question is local on $S$, hence we may assume $S$ is affine.
Say $S = \Spec(R)$. We write $R = \colim R_i$ as a filtered colimit
of Noetherian rings $R_i$. By Limits, Lemma
\ref{limits-lemma-descend-finite-presentation}
there exists an $i$ and a scheme $X_i$ of finite presentation over $R_i$
whose base change to $R$ is $X$. By
Limits, Lemma \ref{limits-lemma-descend-modules-finite-presentation}
we may assume after increasing $i$, that there exists a finitely
presented $\mathcal{O}_{X_i}$-module $\mathcal{G}_i$ whose
pullback to $X$ is $\mathcal{G}$. After increasing $i$
we may assume $\mathcal{G}_i$ is flat over $R_i$, see
Limits, Lemma \ref{limits-lemma-descend-module-flat-finite-presentation}.
After increasing $i$ we may assume the support of $\mathcal{G}_i$
is proper over $R_i$, see
Limits, Lemma \ref{limits-lemma-eventually-proper-support}.
Finally, by Lemma \ref{lemma-descend-perfect}
we may, after increasing $i$, assume there exists a perfect
object $E_i$ of $D(\mathcal{O}_{X_i})$ whose pullback to
$X$ is $E$. Applying Lemma \ref{lemma-compute-tensor-perfect}
to $X_i \to \Spec(R_i)$, $E_i$, $\mathcal{G}_i$ and using the
base change property already shown we obtain the result.
\end{proof}

\begin{lemma}
\label{lemma-flat-proper-perfect-direct-image-general}
Let $S$ be a scheme. Let $f : X \to S$ be a flat proper
morphism of finite presentation.
\begin{enumerate}
\item Let $E \in D(\mathcal{O}_X)$ be perfect. Then
$Rf_*E$ is a perfect object of $D(\mathcal{O}_S)$ and its formation
commutes with arbitrary base change.
\item Let $\mathcal{G}$ be an $\mathcal{O}_X$-module of finite presentation,
flat over $S$. Then $Rf_*\mathcal{G}$ is a perfect object of
$D(\mathcal{O}_S)$ and its formation commutes with arbitrary base change.
\end{enumerate}
\end{lemma}

\begin{proof}
Special cases of
Lemma \ref{lemma-base-change-tensor-perfect} applied with
$\mathcal{G} = \mathcal{O}_X$ and $E = \mathcal{O}_X$.
\end{proof}

\begin{remark}
\label{remark-explain-perfect-direct-image}
Let $R$ be a ring. Let $X$ be a scheme of finite presentation over
$R$. Let $\mathcal{G}$ be a finitely presented $\mathcal{O}_X$-module
flat over $R$ with scheme theoretic support proper over $R$. By
Lemma \ref{lemma-base-change-tensor-perfect}
there exists a finite complex of finite projective $R$-modules
$M^\bullet$ such that we have
$$
R\Gamma(X_{R'}, \mathcal{G}_{R'}) = M^\bullet \otimes_R R'
$$
functorially in the $R$-algebra $R'$.
\end{remark}

\begin{lemma}
\label{lemma-base-change-RHom-perfect}
Let $f : X \to S$ be a morphism of finite presentation.
Let $E \in D(\mathcal{O}_X)$ be a perfect object. Let $\mathcal{G}$ be a
finitely presented $\mathcal{O}_X$-module, flat over $S$, with support
proper over $S$. Then
$$
K = Rf_*R\SheafHom(E, \mathcal{G})
$$
is a perfect object of $D(\mathcal{O}_S)$ and its formation
commutes with arbitrary base change.
\end{lemma}

\begin{proof}
The statement on base change is Lemma \ref{lemma-base-change-RHom}.
Thus it suffices to show that $K$ is a perfect object. If $S$ is
Noetherian, then this follows from
Lemma \ref{lemma-compute-ext-perfect}.
We will reduce to this case by Noetherian approximation.
We encourage the reader to skip the rest of this proof.

\medskip\noindent
The question is local on $S$, hence we may assume $S$ is affine.
Say $S = \Spec(R)$. We write $R = \colim R_i$ as a filtered colimit
of Noetherian rings $R_i$. By Limits, Lemma
\ref{limits-lemma-descend-finite-presentation}
there exists an $i$ and a scheme $X_i$ of finite presentation over $R_i$
whose base change to $R$ is $X$. By
Limits, Lemma \ref{limits-lemma-descend-modules-finite-presentation}
we may assume after increasing $i$, that there exists a finitely
presented $\mathcal{O}_{X_i}$-module $\mathcal{G}_i$ whose
pullback to $X$ is $\mathcal{G}$. After increasing $i$
we may assume $\mathcal{G}_i$ is flat over $R_i$, see
Limits, Lemma \ref{limits-lemma-descend-module-flat-finite-presentation}.
After increasing $i$ we may assume the support of $\mathcal{G}_i$
is proper over $R_i$, see
Limits, Lemma \ref{limits-lemma-eventually-proper-support}.
Finally, by Lemma \ref{lemma-descend-perfect}
we may, after increasing $i$, assume there exists a perfect
object $E_i$ of $D(\mathcal{O}_{X_i})$ whose pullback to
$X$ is $E$. Applying Lemma \ref{lemma-compute-ext-perfect}
to $X_i \to \Spec(R_i)$, $E_i$, $\mathcal{G}_i$ and using the
base change property already shown we obtain the result.
\end{proof}









\section{Perfect complexes}
\label{section-perfect-complexes}

\noindent
We first talk about jumping loci for betti numbers of perfect complexes.
Given a complex $E$ on a scheme $X$ and a point $x$ of $X$ we often write
$E \otimes_{\mathcal{O}_X}^\mathbf{L} \kappa(x)$ instead of the more correct
$Li_x^*E$, where $i_x : x \to X$ is the canonical morphism.

\begin{lemma}
\label{lemma-jump-loci}
Let $X$ be a scheme. Let $E \in D(\mathcal{O}_X)$ be perfect.
For any $i \in \mathbf{Z}$ consider the function
$$
\beta_i : X \longrightarrow \{0, 1, 2, \ldots\},\quad
x \longmapsto
\dim_{\kappa(x)}
H^i(E \otimes_{\mathcal{O}_X}^\mathbf{L} \kappa(x))
$$
Then we have
\begin{enumerate}
\item formation of $\beta_i$ commutes with arbitrary base change,
\item the functions $\beta_i$ are upper semi-continuous, and
\item the level sets of $\beta_i$ are locally constructible in $X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider a morphism of schemes $f : Y \to X$ and a point $y \in Y$.
Let $x$ be the image of $y$ and consider the commutative diagram
$$
\xymatrix{
y \ar[r]_j \ar[d]_g & Y \ar[d]^f \\
x \ar[r]^i & X
}
$$
Then we see that $Lg^* \circ Li^* = Lj^* \circ Lf^*$. This implies that
the function $\beta'_i$ associated to the perfect complex $Lf^*K$
is the pullback of the function $\beta_i$, in a formula:
$\beta'_i = \beta_i \circ f$. This is the meaning of (1).

\medskip\noindent
Let $x \in X$. By More on Algebra, Lemma
\ref{more-algebra-lemma-lift-perfect-from-residue-field}
there exists an affine open neighbourhood $U$ of $x$ and
$a \leq b$ such that $K|_U$ is represented by a complex
$$
\ldots \to 0 \to \mathcal{O}_U^{\oplus \beta_a(x)}
\to \mathcal{O}_U^{\oplus \beta_{a + 1}(x)} \to
\ldots \to
\mathcal{O}_U^{\oplus \beta_{b - 1}(x)} \to
\mathcal{O}_U^{\oplus \beta_b(x)} \to 0
\to \ldots
$$
(This also uses earlier results to turn the problem into algebra, for example
Lemmas \ref{lemma-affine-compare-bounded} and
\ref{lemma-perfect-affine}.)
It follows immediately that $\beta_i(x') \leq \beta_i(x)$
for all $x' \in U$. This proves that $\beta_i$ is upper
semi-continuous.

\medskip\noindent
To prove (3) we may assume that $X$ is affine and
$K$ is given by a complex of finite
free $\mathcal{O}_X$-modules (for example by arguing as in the previous
paragraph, or by using Cohomology, Lemma
\ref{cohomology-lemma-perfect-on-locally-ringed}).
Thus we have to show that given a complex
$$
\mathcal{O}_X^{\oplus a} \to
\mathcal{O}_X^{\oplus b} \to
\mathcal{O}_X^{\oplus c}
$$
the function associated to a point $x \in X$ the dimension of the cohomology
of $\kappa_x^{\oplus a} \to \kappa_x^{\oplus b} \to \kappa_x^{\oplus c}$
in the middle has constructible level sets. Let
$A \in \text{Mat}(a \times b, \Gamma(X, \mathcal{O}_X))$ be the matrix
of the first arrow. The rank of the image of $A$ in
$\text{Mat}(a \times b, \kappa(x))$ is equal to $r$ if all
$(r + 1) \times (r + 1)$-minors of $A$ vanish at $x$ and there is some
$r \times r$-minor of $A$ which does not vanish at $x$. Thus the set
of points where the rank is $r$ is a constructible locally closed set.
Arguing similarly for the second arrow and putting everything together
we obtain the desired result.
\end{proof}

\begin{lemma}
\label{lemma-chi-locally-constant}
Let $X$ be a scheme. Let $E \in D(\mathcal{O}_X)$ be perfect.
The function
$$
\chi_E : X \longrightarrow \mathbf{Z},\quad
x \longmapsto \sum (-1)^i
\dim_{\kappa(x)} H^i(E \otimes_{\mathcal{O}_X}^\mathbf{L} \kappa(x))
$$
is locally constant on $X$.
\end{lemma}

\begin{proof}
By Cohomology, Lemma
\ref{cohomology-lemma-perfect-on-locally-ringed}
we see that we can, locally on $X$, represent $E$ by a finite
complex $\mathcal{E}^\bullet$ of finite free $\mathcal{O}_X$-modules.
On such an open the function $\chi_E$ is constant with value
$\sum (-1)^i \text{rank}(\mathcal{E}^i)$.
\end{proof}

\begin{lemma}
\label{lemma-open-where-cohomology-in-degree-i-rank-r}
Let $X$ be a scheme. Let $E \in D(\mathcal{O}_X)$ be perfect.
Given $i, r \in \mathbf{Z}$, there exists an
open subscheme $U \subset X$ characterized by the following
\begin{enumerate}
\item $E|_U \cong H^i(E|_U)[-i]$ and $H^i(E|_U)$ is a locally free
$\mathcal{O}_U$-module of rank $r$,
\item a morphism $f : Y \to X$ factors through $U$ if and only if
$Lf^*E$ is isomorphic to a locally free module of rank $r$
placed in degree $i$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\beta_j : X \to \{0, 1, 2, \ldots\}$ for $j \in \mathbf{Z}$
be the functions of Lemma \ref{lemma-jump-loci}. Then the set
$$
W = \{x \in X \mid \beta_j(x) \leq 0\text{ for all }j \not = i\}
$$
is open in $X$ and its formation commutes with pullback to any
$Y$ over $X$. This follows from the lemma using that
apriori in a neighbourhood of any point only a finite number
of the $\beta_j$ are nonzero. Thus we may replace $X$ by $W$
and assume that $\beta_j(x) = 0$ for all $x \in X$ and all $j \not = i$.
In this case $H^i(E)$ is a finite locally free module and
$E \cong H^i(E)[-i]$, see for example 
More on Algebra, Lemma
\ref{more-algebra-lemma-lift-perfect-from-residue-field}.
Thus $X$ is the disjoint union of the open subschemes where the
rank of $H^i(E)$ is fixed and we win.
\end{proof}

\begin{lemma}
\label{lemma-locally-closed-where-H0-invertible}
Let $X$ be a scheme. Let $E \in D(\mathcal{O}_X)$ be perfect
of tor-amplitude in $[a, b]$ for some $a, b \in \mathbf{Z}$.
Then there exists a locally closed subscheme $j : Z \to X$
characterized by the following
\begin{enumerate}
\item $H^a(Lj^*E)$ is an invertible $\mathcal{O}_Z$-module, and
\item a morphism $f : Y \to X$ factors through $Z$ if and only if
$H^a(Lf^*E)$ is an invertible $\mathcal{O}_Y$-module.
\end{enumerate}
Moreover, if $f : Y \to X$ factors as $Y \xrightarrow{g} Z \to X$, then
$H^a(Lf^*E) = g^*H^a(Lj^*E)$.
\end{lemma}

\begin{proof}
First, let $U \subset X$ be the open subscheme where the function
$\beta_a$ of Lemma \ref{lemma-jump-loci} has values $\leq 1$.
Since every $f$ as in (2) factors through $U$, we may replace
$X$ by $U$ and assume that $\beta_a(x) \in \{0, 1\}$ for all $x \in X$.
We will show that in this case $Z$ is a closed subscheme.
Namely, if $x \in X$ and $\beta_a(x) = 0$, then there is an
open neighbourhood of $x$ where $\beta_a = 0$. In this way we
see that set theoretically at least the result is true.

\medskip\noindent
To get a scheme theoretic structure, consider a point $x \in X$
with $\beta_a(x) = 1$. Set $\beta = \beta_{a + 1}(x)$.
By More on Algebra, Lemma
\ref{more-algebra-lemma-lift-perfect-from-residue-field}
there exists an affine open neighbourhood $U$ of $x$ and
such that $K|_U$ is represented by a complex
$$
\ldots \to 0 \to \mathcal{O}_U
\xrightarrow{f_1, \ldots, f_\beta} \mathcal{O}_U^{\oplus \beta} \to
\ldots \to
\mathcal{O}_U^{\oplus \beta_{b - 1}(x)} \to
\mathcal{O}_U^{\oplus \beta_b(x)} \to 0
\to \ldots
$$
(This also uses earlier results to turn the problem into algebra, for example
Lemmas \ref{lemma-affine-compare-bounded} and
\ref{lemma-perfect-affine}.) Now, if $g : Y \to U$ is any morphism
of schemes such that $g^\sharp(f_j)$ is nonzero for some $j$, then
$H^0(Lg^*E)$ is not an invertible $\mathcal{O}_Y$-module (since it is
annihilated by a nonzero function).
And trivially it is an invertible $\mathcal{O}_Y$-module if
$g^\sharp(f_j) = 0$ for all $j$. Thus we see that over $U$ the
closed subscheme cut out by $f_1, \ldots, f_\beta$ works.
This finishes the proof as the characterization of $Z$ shows
that the locally constructed patches glue (details omitted).
\end{proof}





\section{Applications}
\label{section-applications}

\noindent
Mostly applications of cohomology and base change. In the future we may
generalize these results to the situation discussed in
Lemma \ref{lemma-base-change-tensor-perfect}.

\begin{lemma}
\label{lemma-jump-loci-geometric}
Let $f : X \to S$ be a flat, proper morphism of finite presentation.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module of finite presentation,
flat over $S$. For fixed $i \in \mathbf{Z}$ consider the function
$$
\beta_i : X \to \{0, 1, 2, \ldots\},\quad
s \longmapsto \dim_{\kappa(s)} H^i(X_s, \mathcal{F}_s)
$$
Then we have
\begin{enumerate}
\item formation of $\beta_i$ commutes with arbitrary base change,
\item the functions $\beta_i$ are upper semi-continuous, and
\item the level sets of $\beta_i$ are locally constructible in $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
By cohomology and base change (more precisely by
Lemma \ref{lemma-flat-proper-perfect-direct-image-general})
the object $K = Rf_*\mathcal{F}$ is a perfect object of the derived
category of $S$ whose formation commutes with arbitrary base change.
In particular we have
$$
H^i(X_s, \mathcal{F}_s) = H^i(K \otimes_{\mathcal{O}_S}^\mathbf{L} \kappa(s))
$$
Thus the lemma follows from
Lemma \ref{lemma-jump-loci}.
\end{proof}

\begin{lemma}
\label{lemma-chi-locally-constant-geometric}
Let $f : X \to S$ be a flat, proper morphism of finite presentation.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module of finite presentation,
flat over $S$. The function
$$
s \longmapsto \chi(X_s, \mathcal{F}_s)
$$
is locally constant on $S$. Formation of this function commutes with
base change.
\end{lemma}

\begin{proof}
By cohomology and base change (more precisely by
Lemma \ref{lemma-flat-proper-perfect-direct-image-general})
the object $K = Rf_*\mathcal{F}$ is a perfect object of the derived
category of $S$ whose formation commutes with arbitrary base change.
Thus we have to show the map
$$
s \longmapsto \sum (-1)^i \dim_{\kappa(s)}
H^i(K \otimes^\mathbf{L}_{\mathcal{O}_S} \kappa(s))
$$
is locally constant on $S$. This is Lemma \ref{lemma-chi-locally-constant}.
\end{proof}

\begin{lemma}
\label{lemma-open-where-cohomology-in-degree-i-rank-r-geometric}
Let $f : X \to S$ be a flat, proper morphism of finite presentation.
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module of finite presentation,
flat over $S$. Fix $i, r \in \mathbf{Z}$.
Then there exists an open subscheme
$U \subset S$ with the following property:
A morphism $T \to S$ factors through $U$ if and only if
$Rf_{T, *}\mathcal{F}_T$ is isomorphic to a
finite locally free module of rank $r$ placed in degree $i$.
\end{lemma}

\begin{proof}
By cohomology and base change (more precisely by
Lemma \ref{lemma-flat-proper-perfect-direct-image-general})
the object $K = Rf_*\mathcal{F}$ is a perfect object of the derived
category of $S$ whose formation commutes with arbitrary base change.
Thus this lemma follows immediately from
Lemma \ref{lemma-open-where-cohomology-in-degree-i-rank-r}.
\end{proof}






\section{Theorem of the cube}
\label{section-theorem-cube}

\noindent
The following lemma tells us that the diagonal of the Picard
functor is representable by locally closed immersions under
the assumptions made in the lemma.

\begin{lemma}
\label{lemma-diagonal-picard-flat-proper}
Let $f : X \to S$ be a flat, proper morphism of finite presentation.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
For a morphism $g : T \to S$ consider the base change diagram
$$
\xymatrix{
X_T \ar[d]_p \ar[r]_q & X \ar[d]^f \\
T \ar[r]^g & S
}
$$
Assume $\mathcal{O}_T \to p_*\mathcal{O}_{X_T}$ is an
isomorphism for all $g : T \to S$.
Then there is a locally closed subscheme $Z \subset S$ such that
a morphism $g : T \to S$ factors through $Z$ if and only if
there exists an invertible $\mathcal{O}_T$-module $\mathcal{N}$
with $p^*\mathcal{N} \cong q^*\mathcal{L}$.
\end{lemma}

\begin{proof}
Let $g : T \to S$ be a morphism. If there exists an $\mathcal{N}$
as in the lemma, then, using the projection formula
Cohomology, Lemma \ref{cohomology-lemma-projection-formula})
we see that the modules
$$
p_*(q^*\mathcal{L}) \cong
p_*(p^*\mathcal{N}) \cong
\mathcal{N} \otimes_{\mathcal{O}_S} p_*\mathcal{O}_{X_T} \cong
\mathcal{N}\quad\text{and similarly }\quad
p_*(q^*\mathcal{L}^{\otimes -1}) \cong \mathcal{N}^{\otimes -1}
$$
are invertible and we see that the map (cup product in degree $0$)
$$
p_*(q^*\mathcal{L})
\otimes_{\mathcal{O}_T}
p_*(q^*\mathcal{L}^{\otimes -1})
\longrightarrow \mathcal{O}_T
$$
is an isomorphism. Conversely, suppose that we have $g : T \to S$
such that $p_*(q^*\mathcal{L})$ and $p_*(q^*\mathcal{L}^{\otimes -1})$
are invertible and such that the cup product map displayed above is
an isomorphism. Then we see that locally on $T$ we have sections
$\sigma$ in $p_*(q^*\mathcal{L})$ and $\sigma'$ in
$p_*(q^*\mathcal{L}^{\otimes -1})$ whose product is $1$.
Thinking of $\sigma$ as a section of $q^*\mathcal{L}$ on $X_T$
and $\sigma'$ as a section of $q^*\mathcal{L}^{\otimes -1}$ on $X_T$
with $\sigma \cdot \sigma' = 1$, we conclude that
$\sigma : \mathcal{O}_{X_T} \to q^*\mathcal{L}$ is an isomorphism.
In other words, we see that $p^*p_*q^*\mathcal{L} \cong q^*\mathcal{L}$.
It is this alternative description of the condition on
$g : T \to S$ that we will show is representable by a
locally closed subscheme of $S$.

\medskip\noindent
By cohomology and base change (more precisely by
Lemma \ref{lemma-flat-proper-perfect-direct-image-general})
we see that $E = Rf_*\mathcal{L}$ is a perfect object of the
derived category of $S$ and that its formation commutes with
arbitrary change of base. Similarly for $E' = Rf_*\mathcal{L}^{\otimes -1}$.
Since there is never any cohomology in degrees $< 0$, we see that
$E$ and $E'$ have (locally) tor-amplitude in $[0, b]$ for some $b$.
By Lemma \ref{lemma-locally-closed-where-H0-invertible}
we see that there exist locally closed subschemes
$Z \subset S$ and $Z' \subset S$ over which $H^0(E)$
and $H^0(E')$ become invertible modules compatible with pullback.
After replacing $S$ by $Z \times_S Z'$ (which is a locally closed
subscheme of $X$) we may assume that $f_*\mathcal{L}$ and
$f_*\mathcal{L}^{\otimes -1}$ are invertible $\mathcal{O}_S$-modules
whose formation commutes with arbitrary change of base.
Finally, the condition that the cupproduct is nonzero picks
out an open subscheme and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-get-a-closed}
Let $f : X \to S$ and $\mathcal{L}$ be as in
Lemma \ref{lemma-diagonal-picard-flat-proper}.
If moreover the geometric fibres of $f$ are
integral, then $Z$ is closed in $S$.
\end{lemma}

\begin{proof}
We first do a standard argument to reduce to the Noetherian case.
Namely, the question is local on $S$, hence we may assume that
$S = \Spec(R)$ is affine. Then we write $R = \colim R_i$ with
$R_i$ of finite type over $\mathbf{Z}$. Set $S_i = \Spec(R_i)$.
For some $i$ there exists a flat proper morphism $f_i : X_i \to S_i$
and an invertible $\mathcal{O}_{X_i}$-module $\mathcal{L}_i$
whose base change to $S$ gives back $f : X \to S$ and $\mathcal{L}$.
See Limits, Lemmas \ref{limits-lemma-descend-finite-presentation},
\ref{limits-lemma-descend-flat-finite-presentation},
\ref{limits-lemma-eventually-proper}, and
\ref{limits-lemma-descend-invertible-modules}.
Then $Rf_{i, *}\mathcal{O}_{X_i}$ is a perfect object of
$D(\mathcal{O}_{S_i})$ whose formation commutes with arbitrary base change.
Let $T \subset S_i$ be the locally closed subscheme of $S_i$
constructed in Lemma \ref{lemma-locally-closed-where-H0-invertible}
for $Rf_{i, *}\mathcal{O}_{X_i}$ with $a = 0$.
By our assumption that $f_*\mathcal{O}_X = \mathcal{O}_S$ universally
we see that $S \to S_i$ factors through $T$.
Set $Y = X_i \times_{S_i} T \to T$ and $\mathcal{M} = \mathcal{L}_i|_Y$.
By construction the morphism $g : Y \to T$ satisfies
$g_*\mathcal{O}_Y = \mathcal{O}_T$ universally
and we have a commutative diagram
$$
\xymatrix{
\mathcal{L} & X \ar[r] \ar[d]_f & Y \ar[d]^g & \mathcal{M} \\
& S \ar[r] & T
}
$$
Thus if we can prove the lemma for $g$ and $\mathcal{M}$,
then it follows for $f$ and $\mathcal{L}$.
Since $T$ is Noetherian, we have reduced to the Noetherian case.

\medskip\noindent
Assume $S$ is Noetherian. Since $Z$ is a locally closed subscheme of a
Noetherian scheme it suffices to show that $Z$ is closed under specialization
in order to prove that it is closed. By
Properties, Lemma \ref{properties-lemma-locally-Noetherian-specialization-dvr}
and base change we see that it suffices to prove the lemma in
case $S$ is the spectrum of a dvr $A$. In other words, suppose
we have a flat proper morphism $X \to \Spec(A)$ with integral
scheme theoretic fibres $X_\eta$ (generic), $X_0$ (closed) and an invertible
$\mathcal{O}_X$-module $\mathcal{L}$ whose restriction to $X_\eta$ is
trivial. Goal: show that $\mathcal{L}$ is trivial. This follows
from Divisors, Lemma \ref{divisors-lemma-in-image-pullback}.
However, we can prove this special case directly as follows:
take a trivializing section $s \in \Gamma(X_\eta, \mathcal{L}_\eta)$.
After replacing $s$ by $\pi^n s$ if necessary ($\pi \in A$ a uniformizer)
we can assume that $s \in \Gamma(X, \mathcal{L})$.
If $s|_{X_0} = 0$, then we see
that $s$ is divisible by $\pi$ (because $X_0$ is the scheme theoretic
fibre and $X$ is flat over $A$). Thus we may assume that $s|_{X_0}$
is nonzero. Then the zero locus $Z(s)$ of $s$ is contained in $X_0$
but does not contain the generic point of $X_0$ (because $X_0$ is integral).
This means that the $Z(s)$ has codimension $\geq 2$ in $X$ which contradicts
Divisors, Lemma \ref{divisors-lemma-effective-Cartier-codimension-1}.
\end{proof}

\begin{lemma}
\label{lemma-H1-O-picard-flat-proper}
Consider a commutative diagram of schemes
$$
\xymatrix{
X' \ar[rr] \ar[dr]_{f'} & & X \ar[dl]^f \\
& S
}
$$
with $f' : X' \to S$ and $f : X \to S$ satisfying the hypotheses of
Lemma \ref{lemma-diagonal-picard-flat-proper}.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module
and let $\mathcal{L}'$ be the pullback to $X'$. Let $Z \subset S$,
resp.\ $Z' \subset S$ be the locally closed subscheme constructed
in Lemma \ref{lemma-diagonal-picard-flat-proper}
for $(f, \mathcal{L})$, resp.\ $(f', \mathcal{L}')$
so that $Z \subset Z'$. If $s \in Z$ and
$$
H^1(X_s, \mathcal{O}) \longrightarrow H^1(X'_s, \mathcal{O})
$$
is injective, then $Z \cap U = Z' \cap U$ for some open neighbourhood
$U$ of $s$.
\end{lemma}

\begin{proof}
We may replace $S$ by $Z'$. After shrinking $S$ to an affine open neighbourhood
of $s$ we may assume that $\mathcal{L}' = \mathcal{O}_{X'}$.
Let $E = Rf_*\mathcal{L}$ and $E' = Rf'_*\mathcal{L}' = Rf'_*\mathcal{O}_{X'}$.
These are perfect complexes whose formation commutes with arbitrary
change of base (Lemma \ref{lemma-flat-proper-perfect-direct-image-general}).
In particular we see that
$$
E \otimes_{\mathcal{O}_S}^\mathbf{L} \kappa(s) =
R\Gamma(X_s, \mathcal{L}_s) = R\Gamma(X_s, \mathcal{O}_{X_s})
$$
The second equality because $s \in Z$. Set
$h_i = \dim_{\kappa(s)} H^i(X_s, \mathcal{O}_{X_s})$.
After shrinking $S$ we can represent $E$ by a complex
$$
\mathcal{O}_S \to \mathcal{O}_S^{\oplus h_1} \to
\mathcal{O}_S^{\oplus h_2} \to \ldots
$$
see More on Algebra, Lemma
\ref{more-algebra-lemma-lift-perfect-from-residue-field}
(strictly speaking this also uses
Lemmas \ref{lemma-affine-compare-bounded} and
\ref{lemma-perfect-affine}). Simlarly, we may assume $E'$
is represented by a complex
$$
\mathcal{O}_S \to \mathcal{O}_S^{\oplus h'_1} \to
\mathcal{O}_S^{\oplus h'_2} \to \ldots
$$
where $h'_i = \dim_{\kappa(s)} H^i(X'_s, \mathcal{O}_{X'_s})$.
By functoriality of cohmology we have a map
$$
E \longrightarrow E'
$$
in $D(\mathcal{O}_S)$ whose formation commutes with change of base.
Since the complex representing $E$ is a finite complex of finite free
modules and since $S$ is affine, we can choose a map of complexes
$$
\xymatrix{
\mathcal{O}_S \ar[r]_d \ar[d]_a &
\mathcal{O}_S^{\oplus h_1} \ar[r] \ar[d]_b &
\mathcal{O}_S^{\oplus h_2} \ar[r] \ar[d]_c & \ldots \\
\mathcal{O}_S \ar[r]^{d'} &
\mathcal{O}_S^{\oplus h'_1} \ar[r] &
\mathcal{O}_S^{\oplus h'_2} \ar[r] & \ldots
}
$$
representing the given map $E \to E'$. Since $s \in Z$ we see that
the trivializing section of $\mathcal{L}_s$ pulls back to a trivializing
section of $\mathcal{L}'_s = \mathcal{O}_{X'_s}$. Thus
$a \otimes \kappa(s)$ is an isomorphism, hence after shrinking $S$
we see that $a$ is an isomorphism. Finally, we use the hypothesis
that $H^1(X_s, \mathcal{O}) \to H^1(X'_s, \mathcal{O})$
is injective, to see that there exists a $h_1 \times h_1$ minor of the
matrix defining $b$ which maps to a nonzero
element in $\kappa(s)$. Hence after shrinking $S$ we may assume
that $b$ is injective. Howeover, since $\mathcal{L}' = \mathcal{O}_{X'}$
we see that $d' = 0$. It follows that $d = 0$. In this way we see
that the trivializing section of $\mathcal{L}_s$ lifts to a section
of $\mathcal{L}$ over $X$. A straightforward toplogical argument (omitted)
shows that this means that $\mathcal{L}$ is trivial after possibly
shrinking $S$ a bit further.
\end{proof}

\begin{lemma}
\label{lemma-H1-O-multiple-picard-flat-proper}
Consider $n$ commutative diagrams of schemes
$$
\xymatrix{
X_i \ar[rr] \ar[dr]_{f_i} & & X \ar[dl]^f \\
& S
}
$$
with $f_i : X_i \to S$ and $f : X \to S$ satisfying the hypotheses of
Lemma \ref{lemma-diagonal-picard-flat-proper}.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module
and let $\mathcal{L}_i$ be the pullback to $X_i$. Let $Z \subset S$,
resp.\ $Z_i \subset S$ be the locally closed subscheme constructed
in Lemma \ref{lemma-diagonal-picard-flat-proper}
for $(f, \mathcal{L})$, resp.\ $(f_i, \mathcal{L}_i)$
so that $Z \subset \bigcap_{i = 1, \ldots, n} Z_i$. If $s \in Z$ and
$$
H^1(X_s, \mathcal{O}) \longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} H^1(X_{i, s}, \mathcal{O})
$$
is injective, then $Z \cap U = (\bigcap_{i = 1, \ldots, n} Z_i) \cap U$
(scheme theoretic intersection) for some open neighbourhood $U$ of $s$.
\end{lemma}

\begin{proof}
This lemma is a variant of Lemma \ref{lemma-H1-O-picard-flat-proper}
and we strongly urge the reader to read that proof first; this proof
is basically a copy of that proof with minor modifications. It follows
from the descrioption of (scheme valued) points of $Z$ and the $Z_i$
that $Z \subset \bigcap_{i = 1, \ldots, n} Z_i$ where we take the
scheme theoretic intersection. Thus we may replace $S$ by the scheme
theoretic intersection $\bigcap_{i = 1, \ldots, n} Z_i$. After shrinking
$S$ to an affine open neighbourhood of $s$ we may assume that
$\mathcal{L}_i = \mathcal{O}_{X_i}$ for $i = 1, \ldots, n$.
Let $E = Rf_*\mathcal{L}$ and
$E_i = Rf_{i, *}\mathcal{L}_i = Rf_{i, *}\mathcal{O}_{X_i}$.
These are perfect complexes whose formation commutes with arbitrary
change of base (Lemma \ref{lemma-flat-proper-perfect-direct-image-general}).
In particular we see that
$$
E \otimes_{\mathcal{O}_S}^\mathbf{L} \kappa(s) =
R\Gamma(X_s, \mathcal{L}_s) = R\Gamma(X_s, \mathcal{O}_{X_s})
$$
The second equality because $s \in Z$. Set
$h_j = \dim_{\kappa(s)} H^j(X_s, \mathcal{O}_{X_s})$.
After shrinking $S$ we can represent $E$ by a complex
$$
\mathcal{O}_S \to \mathcal{O}_S^{\oplus h_1} \to
\mathcal{O}_S^{\oplus h_2} \to \ldots
$$
see More on Algebra, Lemma
\ref{more-algebra-lemma-lift-perfect-from-residue-field}
(strictly speaking this also uses
Lemmas \ref{lemma-affine-compare-bounded} and
\ref{lemma-perfect-affine}). Simlarly, we may assume $E_i$
is represented by a complex
$$
\mathcal{O}_S \to \mathcal{O}_S^{\oplus h_{i, 1}} \to
\mathcal{O}_S^{\oplus h_{i, 2}} \to \ldots
$$
where $h_{i, j} = \dim_{\kappa(s)} H^j(X_{i, s}, \mathcal{O}_{X_{i, s}})$.
By functoriality of cohmology we have a map
$$
E \longrightarrow E_i
$$
in $D(\mathcal{O}_S)$ whose formation commutes with change of base.
Since the complex representing $E$ is a finite complex of finite free
modules and since $S$ is affine, we can choose a map of complexes
$$
\xymatrix{
\mathcal{O}_S \ar[r]_d \ar[d]_{a_i} &
\mathcal{O}_S^{\oplus h_1} \ar[r] \ar[d]_{b_i} &
\mathcal{O}_S^{\oplus h_2} \ar[r] \ar[d]_{c_i} & \ldots \\
\mathcal{O}_S \ar[r]^{d_i} &
\mathcal{O}_S^{\oplus h_{i, 1}} \ar[r] &
\mathcal{O}_S^{\oplus h_{i, 2}} \ar[r] & \ldots
}
$$
representing the given map $E \to E_i$. Since $s \in Z$ we see that
the trivializing section of $\mathcal{L}_s$ pulls back to a trivializing
section of $\mathcal{L}_{i, s} = \mathcal{O}_{X_{i, s}}$. Thus
$a_i \otimes \kappa(s)$ is an isomorphism, hence after shrinking $S$
we see that $a_i$ is an isomorphism. Finally, we use the hypothesis
that $H^1(X_s, \mathcal{O}) \to
\bigoplus_{i = 1, \ldots, n} H^1(X_{i, s}, \mathcal{O})$
is injective, to see that there exists a $h_1 \times h_1$ minor of the
matrix defining $\oplus b_i$ which maps to a nonzero
element in $\kappa(s)$. Hence after shrinking $S$ we may assume that
$(b_1, \ldots, b_n) : \mathcal{O}_S^{h_1}
\to \bigoplus_{i = 1, \ldots, n} \mathcal{O}_S^{h_{i, 1}}$
is injective. Howeover, since $\mathcal{L}_i = \mathcal{O}_{X_i}$
we see that $d_i = 0$ for $i = 1, \ldots n$. It follows that $d = 0$
because $(b_1, \ldots, b_n) \circ d = (\oplus d_i) \circ (a_1, \ldots, a_n)$.
In this way we see
that the trivializing section of $\mathcal{L}_s$ lifts to a section
of $\mathcal{L}$ over $X$. A straightforward toplogical argument (omitted)
shows that this means that $\mathcal{L}$ is trivial after possibly
shrinking $S$ a bit further.
\end{proof}

\begin{lemma}
\label{lemma-pic-of-product}
Let $f : X \to S$ and $g : Y \to S$ be morphisms of schemes
satisfying the hypotheses of Lemma \ref{lemma-diagonal-picard-flat-proper}.
Let $\sigma : S \to X$ and $\tau : S \to Y$ be sections of
$f$ and $g$. Let $s \in S$.
Let $\mathcal{L}$ be an invertible sheaf on $X \times_S Y$.
If $(1 \times \tau)^*\mathcal{L}$ on $X$, $(\sigma \times 1)^*\mathcal{L}$
on $Y$, and $\mathcal{L}|_{(X \times_S Y)_s}$ are trivial, then
there is an open neighbourhood $U$ of $s$ such that
$\mathcal{L}$ is trivial over $(X \times_S Y)_U$.
\end{lemma}

\begin{proof}
By K\"unneth (Varieties, Lemma \ref{varieties-lemma-kunneth})
the map
$$
H^1(X_s \times_{\Spec(\kappa(s)} Y_s, \mathcal{O}) \to
H^1(X_s, \mathcal{O}) \oplus H^1(Y_s, \mathcal{O})
$$
is injective. Thus we may
apply Lemma \ref{lemma-H1-O-multiple-picard-flat-proper}
to the two morphisms
$$
1 \times \tau : X \to X \times_S Y
\quad\text{and}\quad
\sigma \times 1 : Y \to X \times_S Y
$$
to conclude.
\end{proof}

\begin{theorem}[Theorem of the cube]
\label{theorem-of-the-cube}
Let $k$ be a field. Let $X, Y, Z$ be varieties with
$k$-rational points $x, y, z$. Let $\mathcal{L}$ be an invertible
module on $X \times Y \times Z$. If
\begin{enumerate}
\item $\mathcal{L}$ is trivial over
$x \times Y \times Z$, $X \times y \times Z$, and $X \times Y \times z$, and
\item $X$ and $Y$ are geometrically integral and proper over $k$,
\end{enumerate}
then $\mathcal{L}$ is trivial.
\end{theorem}

\begin{proof}
Since $X$ and $Y$ are geometrically integral and proper over $k$
the product $X \times_k Y$ is geometrically integral and proper over $k$.
This implies that $H^0(X \times Y, \mathcal{O}_{X \times Y}) = k$
and that the same remains true after any base change.
Thus we may apply Lemma \ref{lemma-diagonal-picard-flat-proper}
to the morphism
$$
p : X \times Y \times Z \longrightarrow Z
$$
and the invertible module $\mathcal{L}$ to get a locally closed
subscheme $Z' \subset Z$ such that $\mathcal{L}|_{X \times Y \times Z'}$
is the pullback of an invertible module $\mathcal{N}$ on $Z'$. By
Lemma \ref{lemma-get-a-closed}
we see that $Z' \subset Z$ is a closed subscheme.
Hence if $Z'$ contains an open neighbourhood of $z$, then
$Z' = Z$ and we see that $\mathcal{L} = p^*\mathcal{N}$.
Restricting to $x \times y \times Z$ we find that
$\mathcal{N} \cong \mathcal{O}_Z$ and $\mathcal{L}$ is trivial.
To get the desired open neighbourhood of $z$ apply
Lemma \ref{lemma-pic-of-product}
to the morphism $p$, the point $z$, and the sections
$\sigma : Z \to X \times Z$ and $\tau : Z \to Y \times Z$ given by $x$ and $y$.
\end{proof}










\section{Formal functions for a principal ideal}
\label{section-formal-functions}

\noindent
In this section we ask if completion and taking cohomology commute
for sheaves of modules on schemes over an affine base $A$ when completion
is with respect to a principal ideal in $A$. Of course, we have already
discussed the theorem on formal functions in
Cohomology of Schemes, Section \ref{coherent-section-theorem-formal-functions}.
Moreover, we will see in
Pro-\'etale Cohomology, Section \ref{proetale-section-formal-functions}
that derived completion commutes with derived cohomology in great generality.
In this section we just collect a few simple special cases of this material
that will help us with future developments.

\begin{lemma}
\label{lemma-limit-finite}
Let $A$ be a Noetherian ring complete with respect to a principal ideal $(f)$.
Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_2 \to \mathcal{F}_1 \to \mathcal{F}_0
$$
be an inverse system of $\mathcal{O}_X$-modules. Assume
\begin{enumerate}
\item $\Gamma(X, \mathcal{F}_0)$ is a finite $A$-module,
\item multiplication by $f$ on $\mathcal{F}_{n + 1}$ factors
through $\mathcal{F}_{n + 1} \to \mathcal{F}_n$ to give a
short exact sequence
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_0 \to 0$
\end{enumerate}
Then
$$
M = \lim \Gamma(X, \mathcal{F}_n)
$$
is a finite $A$-module, $f$ is a nonzerodivisor on $M$, and
$M/fM$ is the image of $M$ in $\Gamma(X, \mathcal{F}_0)$.
\end{lemma}

\begin{proof}
Assumption (2) implies that $\mathcal{F}_0$ is annihilated by $f$
and then by induction that $\mathcal{F}_n$ is annihilated by $f^{n + 1}$.
Set $M_n = \Gamma(X, \mathcal{F}_n)$. Since $f^{n + 1}$ annihilates
$M_n$ we see that $\bigcap f^nM = 0$. Since the kernel of
$f : M_{n + 1} \to M_{n + 1}$ dies in $M_n$ by (2) we see that
$f : M \to M$ is injective. The cokernel of $f : M \to M$
is the image of $M \to M_0$. Namely, if $m = (m_n)$ is an element
of $M$ with $m_0 = 0$, then each $m_{n + 1}$ is in the image of
$M_n \to M_{n + 1}$ by assumption (2).
If $m'_n \in M_n$ maps to $m_{n + 1}$ then $f(m'_n) = (m_n)$ in $M$.
Since $A$ is Noetherian and $M_0$ is finite, we see that
$M/fM \subset M_0$ is a finite module. By
Algebra, Lemma \ref{algebra-lemma-finite-over-complete-ring}
we conclude that $M$ is finite over $A$.
\end{proof}

\begin{lemma}
\label{lemma-ML}
Let $A$ be a ring. Let $f \in A$. Let $X$ be a scheme over $\Spec(A)$. Let
$$
\ldots \to \mathcal{F}_2 \to \mathcal{F}_1 \to \mathcal{F}_0
$$
be an inverse system of $\mathcal{O}_X$-modules. Assume
\begin{enumerate}
\item $H^1(X, \mathcal{F}_0)$ is an $A$-module of finite length,
\item multiplication by $f$ on $\mathcal{F}_{n + 1}$ factors
through $\mathcal{F}_{n + 1} \to \mathcal{F}_n$ to give a
short exact sequence
$0 \to \mathcal{F}_n \to \mathcal{F}_{n + 1} \to \mathcal{F}_0 \to 0$,
\end{enumerate}
Then the system $M_n = \Gamma(X, \mathcal{F}_n)$ satisfies the
Mittag-Leffler condition.
\end{lemma}

\begin{proof}
By the short exact sequences and induction we see that
$H^1_n = H^1(X, \mathcal{F}_n)$ is an $A$-module of finite
length for all $n$. Fix $n$. Our goal is to show that
$$
Q_m = \Coker(M_m \to M_n),\quad m \geq n
$$
stabilizes for $m \gg n$. Note that $Q_m \subset H^1_{m - n}$ has finite length
and that we have surjective maps $Q_{m + 1} \to Q_m$ for all $m \geq n$.
Applying cohomology to the short exact sequence
$$
0 \to \mathcal{F}_{m - n} \to \mathcal{F}_m \to \mathcal{F}_n \to 0
$$
we get an exact sequence
$$
0 \to Q_m \to H^1_{m - n} \to H^1_m \to H^1_n
$$
of finite length modules.
Set $q_m = \text{length}_A(Q_m)$ and $l_m = \text{length}_A(H^1_m)$.
Then we conclude that
$$
l_m \leq l_{m - n} - q_m + l_n
$$
Above we have seen that $q_{m + 1} \geq q_m$ for all $n$. If the sequence
does not stabilize then for some $m_0$ we have $q_m > l_n$ for all
$m \geq m_0$. Then we would get
$$
l_m \leq l_{m - n} - q_m + l_n \leq l_{m - n} - 1
$$
provided $m \geq m_0$. This would imply that the sequence
$l_{m_0}, l_{m_0 + n}, l_{m_0 + 2n}, \ldots$ is strictly decreasing
contradicting the fact that $l_m > q_m$ and the sequence $q_m$
is nondecreasing. Thus the sequence stabilizes.
\end{proof}

\begin{lemma}
\label{lemma-formal-functions}
\begin{reference}
\cite[Lemma 1.6]{Bhatt-local}
\end{reference}
Let $A$ be a ring and $f \in A$. Let $X$ be a scheme over $A$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume that $\mathcal{F}[f^n] = \Ker(f^n : \mathcal{F} \to \mathcal{F})$
stabilizes. Then
$$
R\Gamma(X, \lim \mathcal{F}/f^n\mathcal{F}) =
R\Gamma(X, \mathcal{F})^\wedge
$$
where the right hand side indicates the derived completion
with respect to the ideal $(f) \subset A$. Let $H^p$ be the
$p$th cohomology group of this complex. Then there are short
exact sequences
$$
0 \to R^1\lim H^{p - 1}(X, \mathcal{F}/f^n\mathcal{F})
\to H^p \to \lim H^p(X, \mathcal{F}/f^n\mathcal{F}) \to 0
$$
and
$$
0 \to H^0(H^p(X, \mathcal{F})^\wedge) \to H^p \to
T_f(H^{p + 1}(X, \mathcal{F})) \to 0
$$
where $T_f(-)$ denote the $f$-adic Tate module as in
More on Algebra, Example
\ref{more-algebra-example-spectral-sequence-principal}.
\end{lemma}

\begin{proof}
We start with the canonical identifications
\begin{align*}
R\Gamma(X, \mathcal{F})^\wedge
& =
R\lim R\Gamma(X, \mathcal{F}) \otimes_A^\mathbf{L} (A \xrightarrow{f^n} A) \\
& =
R\lim R\Gamma(X, \mathcal{F} \xrightarrow{f^n} \mathcal{F}) \\
& =
R\Gamma(X, R\lim (\mathcal{F} \xrightarrow{f^n} \mathcal{F}))
\end{align*}
The first equality holds by
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion-koszul}.
The second by the projection formula, see 
Cohomology, Lemma \ref{cohomology-lemma-projection-formula-perfect}.
The third by Cohomology, Lemma
\ref{cohomology-lemma-Rf-commutes-with-Rlim}.
Note that by Lemma \ref{lemma-Rlim-quasi-coherent} we have
$\lim \mathcal{F}/f^n\mathcal{F} = R\lim \mathcal{F}/f^n \mathcal{F}$.
Thus to finish the proof of the first statement of the lemma it suffices to
show that the pro-objects $(f^n : \mathcal{F} \to \mathcal{F})$
and $(\mathcal{F}/f^n \mathcal{F})$ are isomorphic. There is clearly
a map from the first system to the second. Suppose that
$\mathcal{F}[f^c] = \mathcal{F}[f^{c + 1}] = \mathcal{F}[f^{c + 2}] = \ldots$.
Then we can define an arrow of systems in $D(\mathcal{O}_X)$
in the other direction by the diagrams
$$
\xymatrix{
\mathcal{F}/\mathcal{F}[f^c] \ar[r]_-{f^{n + c}} \ar[d]_{f^c} &
\mathcal{F} \ar[d]^1 \\
\mathcal{F} \ar[r]^{f^n} & \mathcal{F}
}
$$
Since the top horizontal arrow is injective the complex
in the top row is quasi-isomorphic to $\mathcal{F}/f^{n + c}\mathcal{F}$.
Some details omitted.

\medskip\noindent
Since $R\Gamma(X, -)$ commutes with derived limits
(Injectives, Lemma \ref{injectives-lemma-RF-commutes-with-Rlim})
we see that
$$
R\Gamma(X, \lim \mathcal{F}/f^n\mathcal{F}) =
R\Gamma(X, R\lim \mathcal{F}/f^n\mathcal{F}) =
R\lim R\Gamma(X, \mathcal{F}/f^n\mathcal{F})
$$
(for first equality see first paragraph of proof).
By More on Algebra, Remark \ref{more-algebra-remark-compare-derived-limit}
we obtain exact sequences
$$
0 \to
R^1\lim H^{p - 1}(X, \mathcal{F}/f^n\mathcal{F}) \to
H^p(X, \lim \mathcal{F}/I^n\mathcal{F}) \to
\lim H^p(X, \mathcal{F}/I^n\mathcal{F}) \to 0
$$
of $A$-modules. The second set of short exact sequences follow immediately
from the discussion in More on Algebra, Example
\ref{more-algebra-example-spectral-sequence-principal}.
\end{proof}









\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}

