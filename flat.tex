\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Flatness}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter, we discuss some advanced results on flat modules and
flat morphisms of schemes. Most of these results can be
found in the paper \cite{GruRay} by Raynaud and Gruson.

\medskip\noindent
Before reading this chapter we advise the reader to take a look
at the following results (this list also serves as a pointer to
previous results):
\begin{enumerate}
\item General discussion on flat modules in
Algebra, Section \ref{algebra-section-flat}.
\item The relationship between $\text{Tor}$-groups and flatness, see
Algebra, Section \ref{algebra-section-tor}.
\item Criteria for flatness, see
Algebra, Section \ref{algebra-section-criteria-flatness}
(Noetherian case),
Algebra, Section \ref{algebra-section-flatness-artinian}
(Artinian case),
Algebra, Section \ref{algebra-section-more-flatness-criteria}
(non-Noetherian case), and finally
More on Morphisms, Section \ref{more-morphisms-section-criterion-flat-fibres}.
\item Generic flatness, see
Algebra, Section \ref{algebra-section-generic-flatness}
and
Morphisms, Section \ref{morphisms-section-generic-flatness}.
\item Openness of the flat locus, see
Algebra, Section \ref{algebra-section-open-flat}
and
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.
\item Flattening, see
More on Algebra, Sections
\ref{more-algebra-section-flattening},
\ref{more-algebra-section-flattening-artinian},
\ref{more-algebra-section-flattening-local-base},
\ref{more-algebra-section-flattening-local-source-base}, and
\ref{more-algebra-section-flattening-Noetherian-complete-local}.
\item Additional results in
More on Algebra, Sections \ref{more-algebra-section-descent-flatness-integral},
\ref{more-algebra-section-torsion-flat},
\ref{more-algebra-section-flat-finite}, and
\ref{more-algebra-section-blowup-flat}.
\end{enumerate}






\section{Lemmas on \'etale localization}
\label{section-etale-localization}

\noindent
In this section we list some lemmas on \'etale localization which will be
useful later in this chapter. Please skip this section on a first reading.

\begin{lemma}
\label{lemma-lift-etale}
Let $i : Z \to X$ be a closed immersion of affine schemes.
Let $Z' \to Z$ be an \'etale morphism with $Z'$ affine.
Then there exists an \'etale morphism $X' \to X$ with $X'$
affine such that $Z' \cong Z \times_X X'$ as schemes over $Z$.
\end{lemma}

\begin{proof}
See
Algebra, Lemma \ref{algebra-lemma-lift-etale}.
\end{proof}

\begin{lemma}
\label{lemma-etale-at-point}
Let
$$
\xymatrix{
X \ar[d] & X' \ar[l] \ar[d] \\
S & S' \ar[l]
}
$$
be a commutative diagram of schemes with $X' \to X$ and $S' \to S$ \'etale.
Let $s' \in S'$ be a point. Then
$$
X' \times_{S'} \Spec(\mathcal{O}_{S', s'})
\longrightarrow
X \times_S \Spec(\mathcal{O}_{S', s'})
$$
is \'etale.
\end{lemma}

\begin{proof}
This is true because $X' \to X_{S'}$ is \'etale as a morphism of
schemes \'etale over $X$, see
Morphisms, Lemma \ref{morphisms-lemma-etale-permanence}
and the base change of an \'etale morphism is \'etale, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-etale}.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down}
Let $X \to T \to S$ be morphisms of schemes with $T \to S$ \'etale.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ be a point. Then
$$
\mathcal{F}\text{ flat over }S\text{ at }x
\Leftrightarrow
\mathcal{F}\text{ flat over }T\text{ at }x
$$
In particular $\mathcal{F}$ is flat over $S$ if and only if $\mathcal{F}$
is flat over $T$.
\end{lemma}

\begin{proof}
As an \'etale morphism is a flat morphism (see
Morphisms, Lemma \ref{morphisms-lemma-etale-flat})
the implication ``$\Leftarrow$'' follows from
Algebra, Lemma \ref{algebra-lemma-composition-flat}.
For the converse assume that $\mathcal{F}$ is flat at $x$ over $S$.
Denote $\tilde x \in X \times_S T$ the point lying over $x$ in $X$
and over the image of $x$ in $T$ in $T$.
Then $(X \times_S T \to X)^*\mathcal{F}$ is flat at $\tilde x$ over $T$
via $\text{pr}_2 : X \times_S T \to T$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
The diagonal $\Delta_{T/S} : T \to T \times_S T$ is an open immersion;
combine
Morphisms, Lemmas \ref{morphisms-lemma-diagonal-unramified-morphism} and
\ref{morphisms-lemma-etale-smooth-unramified}.
So $X$ is identified with open subscheme of $X \times_S T$,
the restriction of $\text{pr}_2$ to this open is the given morphism $X \to T$,
the point $\tilde x$ corresponds to the point $x$ in this open, and
$(X \times_S T \to X)^*\mathcal{F}$ restricted to this open is $\mathcal{F}$.
Whence we see that $\mathcal{F}$ is flat at $x$ over $T$.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down-local-ring}
Let $T \to S$ be an \'etale morphism. Let $t \in T$ with image $s \in S$.
Let $M$ be a $\mathcal{O}_{T, t}$-module. Then
$$
M\text{ flat over }\mathcal{O}_{S, s}
\Leftrightarrow
M\text{ flat over }\mathcal{O}_{T, t}.
$$
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$ and after that
$T$ by an affine neighbourhood of $t$.
Set $\mathcal{F} = (\Spec(\mathcal{O}_{T, t}) \to T)_*\widetilde M$.
This is a quasi-coherent sheaf (see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
or argue directly)
on $T$ whose stalk at $t$ is $M$ (details omitted).
Apply
Lemma \ref{lemma-etale-flat-up-down}.
\end{proof}

\begin{lemma}
\label{lemma-flat-up-down-henselization}
Let $S$ be a scheme and $s \in S$ a point. Denote $\mathcal{O}_{S, s}^h$
(resp.\ $\mathcal{O}_{S, s}^{sh}$) the henselization (resp.\ strict
henselization), see
Algebra, Definition \ref{algebra-definition-henselization}.
Let $M^{sh}$ be a $\mathcal{O}_{S, s}^{sh}$-module.
The following are equivalent
\begin{enumerate}
\item $M^{sh}$ is flat over $\mathcal{O}_{S, s}$,
\item $M^{sh}$ is flat over $\mathcal{O}_{S, s}^h$, and
\item $M^{sh}$ is flat over $\mathcal{O}_{S, s}^{sh}$.
\end{enumerate}
If $M^{sh} = M^h \otimes_{\mathcal{O}_{S, s}^h} \mathcal{O}_{S, s}^{sh}$
this is also equivalent to
\begin{enumerate}
\item[(4)] $M^h$ is flat over $\mathcal{O}_{S, s}$, and
\item[(5)] $M^h$ is flat over $\mathcal{O}_{S, s}^h$.
\end{enumerate}
If $M^h = M \otimes_{\mathcal{O}_{S, s}} \mathcal{O}_{S, s}^h$
this is also equivalent to
\begin{enumerate}
\item[(6)] $M$ is flat over $\mathcal{O}_{S, s}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may assume that $S$ is an affine scheme. It is shown in
Algebra, Lemmas \ref{algebra-lemma-henselization-different}
and \ref{algebra-lemma-strict-henselization-different}
that $\mathcal{O}_{S, s}^h$ and $\mathcal{O}_{S, s}^{sh}$
are filtered colimits of the rings $\mathcal{O}_{T, t}$ where
$T \to S$ is \'etale and affine. Hence the local ring maps
$\mathcal{O}_{S, s} \to \mathcal{O}_{S, s}^h \to \mathcal{O}_{S, s}^{sh}$
are flat as directed colimits of \'etale ring maps, see
Algebra, Lemma \ref{algebra-lemma-colimit-flat}.
Hence (3) $\Rightarrow$ (2) $\Rightarrow$ (1) and
(5) $\Rightarrow$ (4) follow from
Algebra, Lemma \ref{algebra-lemma-composition-flat}.
Of course these maps are faithfully flat, see
Algebra, Lemma \ref{algebra-lemma-local-flat-ff}.
Hence the equivalences (6) $\Leftrightarrow$ (5) and
(5) $\Leftrightarrow$ (3) follow from
Algebra, Lemma \ref{algebra-lemma-flatness-descends}.
Thus it suffices to show that
(1) $\Rightarrow$ (2) $\Rightarrow$ (3) and
(4) $\Rightarrow$ (5).

\medskip\noindent
Assume (1). By
Lemma \ref{lemma-etale-flat-up-down-local-ring}
we see that $M^{sh}$ is flat over $\mathcal{O}_{T, t}$ for
any \'etale neighbourhood $(T, t) \to (S, s)$. Since $\mathcal{O}_{S, s}^h$
and $\mathcal{O}_{S, s}^{sh}$ are directed colimits of local rings
of the form $\mathcal{O}_{T, t}$ (see above)
we conclude that $M^{sh}$ is flat over $\mathcal{O}_{S, s}^h$
and $\mathcal{O}_{S, s}^{sh}$ by
Algebra, Lemma \ref{algebra-lemma-colimit-rings-flat}.
Thus (1) implies (2) and (3). Of course this implies also
(2) $\Rightarrow$ (3) by replacing $\mathcal{O}_{S, s}$ by
$\mathcal{O}_{S, s}^h$. The same argument applies to prove
(4) $\Rightarrow$ (5).
\end{proof}

\begin{lemma}
\label{lemma-finite-flat-weak-assassin-up-down}
Let $g : T \to S$ be a finite flat morphism of schemes.
Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_S$-module.
Let $t \in T$ be a point with image $s \in S$. Then
$$
t \in \text{WeakAss}(g^*\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(\mathcal{G})
$$
\end{lemma}

\begin{proof}
The implication ``$\Leftarrow$'' follows immediately from
Divisors, Lemma \ref{divisors-lemma-weakly-ass-pullback}.
Assume $t \in \text{WeakAss}(g^*\mathcal{G})$.
Let $\Spec(A) \subset S$ be an affine open neighbourhood of $s$.
Let $\mathcal{G}$ be the quasi-coherent sheaf associated to the $A$-module $M$.
Let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
As $g$ is finite flat we have $g^{-1}(\Spec(A)) = \Spec(B)$
for some finite flat $A$-algebra $B$. Note that
$g^*\mathcal{G}$ is the quasi-coherent $\mathcal{O}_{\Spec(B)}$-module
associated to the $B$-module $M \otimes_A B$ and $g_*g^*\mathcal{G}$ is the
quasi-coherent $\mathcal{O}_{\Spec(A)}$-module associated to the
$A$-module $M \otimes_A B$. By
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
we have $B_{\mathfrak p} \cong A_{\mathfrak p}^{\oplus n}$
for some integer $n \geq 0$. Note that $n \geq 1$ as we assumed there
exists at least one point of $T$ lying over $s$. Hence we see by
looking at stalks that
$$
s \in \text{WeakAss}(\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(g_*g^*\mathcal{G})
$$
Now the assumption that $t \in \text{WeakAss}(g^*\mathcal{G})$
implies that $s \in \text{WeakAss}(g_*g^*\mathcal{G})$ by
Divisors, Lemma \ref{divisors-lemma-weakly-associated-finite}
and hence by the above $s \in  \text{WeakAss}(\mathcal{G})$.
\end{proof}

\begin{lemma}
\label{lemma-etale-weak-assassin-up-down}
Let $h : U \to S$ be an \'etale morphism of schemes.
Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_S$-module.
Let $u \in U$ be a point with image $s \in S$. Then
$$
u \in \text{WeakAss}(h^*\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(\mathcal{G})
$$
\end{lemma}

\begin{proof}
After replacing $S$ and $U$ by affine neighbourhoods of $s$ and $u$
we may assume that $g$ is a standard \'etale morphism of affines, see
Morphisms, Lemma \ref{morphisms-lemma-etale-locally-standard-etale}.
Thus we may assume $S = \Spec(A)$ and
$X = \Spec(A[x, 1/g]/(f))$, where $f$ is monic and $f'$
is invertible in $A[x, 1/g]$.
Note that $A[x, 1/g]/(f) = (A[x]/(f))_g$ is also the localization
of the finite free $A$-algebra $A[x]/(f)$. Hence we may think of
$U$ as an open subscheme of the scheme $T = \Spec(A[x]/(f))$
which is finite locally free over $S$. This reduces us to
Lemma \ref{lemma-finite-flat-weak-assassin-up-down}
above.
\end{proof}





\section{The local structure of a finite type module}
\label{section-local-structure-module}

\noindent
The key technical lemma that makes a lot of the arguments in this
chapter work is the geometric
Lemma \ref{lemma-elementary-devissage}.

\begin{lemma}
\label{lemma-sheaf-lives-on-subscheme}
Let $f : X \to S$ be a finite type morphism of affine schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$.
Then there exist a closed immersion $i : Z \to X$ of finite presentation,
and a quasi-coherent finite type $\mathcal{O}_Z$-module $\mathcal{G}$
such that $i_*\mathcal{G} = \mathcal{F}$ and
$Z_s = \text{Supp}(\mathcal{F}_s)$.
\end{lemma}

\begin{proof}
Say the morphism $f : X \to S$ is given by the ring map
$A \to B$ and that $\mathcal{F}$ is the quasi-coherent sheaf
associated to the $B$-module $M$. By
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we know that $A \to B$ is a finite type ring map, and by
Properties, Lemma \ref{properties-lemma-finite-type-module}
we know that $M$ is a finite $B$-module. In particular the
support of $\mathcal{F}$ is the closed subscheme of $\Spec(B)$
cut out by the annihilator
$I = \{x \in B \mid xm = 0\ \forall m \in M\}$ of $M$, see
Algebra, Lemma \ref{algebra-lemma-support-closed}.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $x$
and let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
Note that $X_s = \Spec(B \otimes_A \kappa(\mathfrak p))$ and
that $\mathcal{F}_s$ is the quasi-coherent sheaf associated to the
$B \otimes_A \kappa(\mathfrak p)$ module $M \otimes_A \kappa(\mathfrak p)$. By
Morphisms, Lemma \ref{morphisms-lemma-support-finite-type}
the support of $\mathcal{F}_s$ is equal to
$V(I(B \otimes_A \kappa(\mathfrak p)))$. Since
$B \otimes_A \kappa(\mathfrak p)$ is of finite type over $\kappa(\mathfrak p)$
there exist finitely many elements $f_1, \ldots, f_m \in I$
such that
$$
I(B \otimes_A \kappa(\mathfrak p)) =
(f_1, \ldots, f_n)(B \otimes_A \kappa(\mathfrak p)).
$$
Denote $i : Z \to X$ the closed subscheme cut out by
$(f_1, \ldots, f_m)$, in a formula $Z = \Spec(B/(f_1, \ldots, f_m))$.
Since $M$ is annihilated by $I$ we can think of $M$ as an
$B/(f_1, \ldots, f_m)$-module. In other words, $\mathcal{F}$ is the
pushforward of a finite type module on $Z$.
As $Z_s = \text{Supp}(\mathcal{F}_s)$ by construction, this
proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-elementary-devissage}
Let $f : X \to S$ be morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$ and
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.
Then we can construct
\begin{enumerate}
\item elementary \'etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X \ar[dd]_f & X' \ar[dd] \ar[l]^g & Z' \ar[l]^i \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S' \ar[l]_e & S' \ar@{=}[l]
}
$$
\item a point $z' \in Z'$ with $i(z') = x'$, $y' = \pi(z')$, $h(y') = s'$,
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$,
\end{enumerate}
such that the following properties hold
\begin{enumerate}
\item $X'$, $Z'$, $Y'$, $S'$ are affine schemes,
\item $i$ is a closed immersion of finite presentation,
\item $i_*(\mathcal{G}) \cong g^*\mathcal{F}$,
\item $\pi$ is finite and $\pi^{-1}(\{y'\}) = \{z'\}$,
\item the extension $\kappa(s') \subset \kappa(y')$ is purely transcendental,
\item $h$ is smooth of relative dimension $n$
with geometrically integral fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine neighbourhood of $s$.
Let $U \subset f^{-1}(V)$ be an affine neighbourhood of $x$.
Then it suffices to prove the lemma for $f|_U : U \to V$ and
$\mathcal{F}|_U$. Hence in the rest of the proof we assume that
$X$ and $S$ are affine.

\medskip\noindent
First, suppose that $X_s = \text{Supp}(\mathcal{F}_s)$, in particular
$n = \dim_x(X_s)$. Apply
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-local-local-structure-finite-type} and
\ref{more-morphisms-lemma-local-local-structure-finite-type-affine}.
This gives us a commutative diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[l]^g \ar[d]^\pi \\
& Y' \ar[d]^h  \\
S & S' \ar[l]_e
}
$$
and point $x' \in X'$. We set $Z' = X'$, $i = \text{id}$, and
$\mathcal{G} = g^*\mathcal{F}$ to obtain a solution in this case.

\medskip\noindent
In general choose a closed immersion $Z \to X$ and a sheaf
$\mathcal{G}$ on $Z$ as in
Lemma \ref{lemma-sheaf-lives-on-subscheme}.
Applying the result of the previous paragraph to $Z \to S$ and
$\mathcal{G}$ we obtain a diagram
$$
\xymatrix{
X \ar[dd]_f & Z \ar[l] \ar[dd]_{f|_Z} & Z' \ar[l]^g \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S \ar@{=}[l] & S' \ar[l]_e
}
$$
and point $z' \in Z'$ satisfying all the required properties.
We will use
Lemma \ref{lemma-lift-etale}
to embed $Z'$ into a scheme \'etale over $X$. We cannot apply the lemma directly
as we want $X'$ to be a scheme over $S'$. Instead we
consider the morphisms
$$
\xymatrix{
Z' \ar[r] & Z \times_S S' \ar[r] & X \times_S S'
}
$$
The first morphism is \'etale by
Morphisms, Lemma \ref{morphisms-lemma-etale-permanence}.
The second is a closed immersion as a base change of a closed immersion.
Finally, as $X$, $S$, $S'$, $Z$, $Z'$ are all affine we may apply
Lemma \ref{lemma-lift-etale}
to get an \'etale morphism of affine schemes $X' \to X \times_S S'$ such that
$$
Z' = (Z \times_S S') \times_{(X \times_S S')} X' = Z \times_X X'.
$$
As $Z \to X$ is a closed immersion of finite presentation, so is $Z' \to X'$.
Let $x' \in X'$ be the point corresponding to $z' \in Z'$.
Then the completed diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[dd] \ar[l] & Z' \ar[l]^i \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S' \ar[l]_e & S' \ar@{=}[l]
}
$$
is a solution of the original problem.
\end{proof}

\begin{lemma}
\label{lemma-devissage-finite-presentation}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
If $f$ is locally of finite presentation
then $\pi$ is of finite presentation.
In this case the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation
in a neighbourhood of $x$,
\item $\mathcal{G}$ is an $\mathcal{O}_{Z'}$-module of finite presentation
in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is an $\mathcal{O}_{Y'}$-module of
finite presentation in a neighbourhood of $y'$.
\end{enumerate}
Still assuming $f$ locally of finite presentation the following are
equivalent to each other
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is an $\mathcal{O}_{X, x}$-module of finite
presentation,
\item[(b)] $\mathcal{G}_{z'}$ is an $\mathcal{O}_{Z', z'}$-module of
finite presentation, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is an $\mathcal{O}_{Y', y'}$-module
of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ locally of finite presentation. Then $Z' \to S$ is locally
of finite presentation as a composition of such, see
Morphisms, Lemma \ref{morphisms-lemma-composition-finite-presentation}.
Note that $Y' \to S$ is also locally of finite presentation as a composition
of a smooth and an \'etale morphism. Hence
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}
implies $\pi$ is locally of finite presentation.
Since $\pi$ is finite we conclude that it is also separated and
quasi-compact, hence $\pi$ is actually of finite presentation.

\medskip\noindent
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is a $\mathcal{O}_{X'}$-module of finite presentation
in a neighbourhood of $x'$. The pullback of a module of finite presentation
is of finite presentation, see
Modules, Lemma \ref{modules-lemma-pullback-finite-presentation}.
Hence (1) $\Rightarrow$ (4).
The \'etale morphism $g$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$\{U' \to g(U')\}$ is an \'etale covering. Thus (4) $\Rightarrow$ (1) by
Descent, Lemma \ref{descent-lemma-finite-presentation-descends}.
Using
Descent, Lemma \ref{descent-lemma-finite-finitely-presented-module}
and some easy topological arguments (see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
we see that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the ring maps
$$
\mathcal{O}_{X, x} \to
\mathcal{O}_{X', x'} \to
\mathcal{O}_{Z', z'} \leftarrow
\mathcal{O}_{Y', y'}
$$
The first ring map is faithfully flat. Hence
$\mathcal{F}_x$ is of finite presentation over $\mathcal{O}_{X, x}$
if and only if $g^*\mathcal{F}_{x'}$ is of finite presentation over
$\mathcal{O}_{X', x'}$, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
The second ring map is surjective (hence finite) and
finitely presented by assumption, hence
$g^*\mathcal{F}_{x'}$ is of finite presentation over $\mathcal{O}_{X', x'}$
if and only if $\mathcal{G}_{z'}$ is of finite presentation over
$\mathcal{O}_{Z', z'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
Because $\pi$ is finite, of finite presentation, and
$\pi^{-1}(\{y'\}) = \{x'\}$ the ring homomorphism
$\mathcal{O}_{Y', y'} \leftarrow \mathcal{O}_{Z', z'}$ is finite
and of finite presentation, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
Hence $\mathcal{G}_{z'}$ is of finite presentation over $\mathcal{O}_{Z', z'}$
if and only if $\pi_*\mathcal{G}_{y'}$ is of finite presentation over
$\mathcal{O}_{Y', y'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
\end{proof}

\begin{lemma}
\label{lemma-devissage-flat}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ in a neighbourhood of $x$,
\item $\mathcal{G}$ is flat over $S'$ in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is flat over $S'$ in a neighbourhood of $y'$.
\end{enumerate}
The following are equivalent also
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$,
\item[(b)] $\mathcal{G}_{z'}$ is flat over $\mathcal{O}_{S', s'}$, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is flat over $\mathcal{O}_{S', s'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is flat over $S$ in a neighbourhood of $x'$.
We will use
Lemma \ref{lemma-etale-flat-up-down}
to equate flatness over $S$ and $S'$ without further mention.
The \'etale morphism $g$ is flat and open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$U' \to g(U')$ is surjective and flat.
Thus (4) $\Leftrightarrow$ (1) by
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.
Note that
$$
\Gamma(X', g^*\mathcal{F}) =
\Gamma(Z', \mathcal{G}) =
\Gamma(Y', \pi_*\mathcal{G})
$$
Hence the flatness of $g^*\mathcal{F}$, $\mathcal{G}$ and $\pi_*\mathcal{G}$
over $S'$ are all equivalent (this uses that $X'$, $Z'$, $Y'$, and
$S'$ are all affine). Some omitted topological arguments (compare
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
regarding affine neighbourhoods now show that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the commutative diagram
of local ring maps
$$
\xymatrix{
\mathcal{O}_{X', x'} \ar[r]_\iota &
\mathcal{O}_{Z', z'} &
\mathcal{O}_{Y', y'} \ar[l]^\alpha &
\mathcal{O}_{S', s'} \ar[l]^\beta \\
\mathcal{O}_{X, x} \ar[u]^\gamma & & &
\mathcal{O}_{S, s} \ar[lll]_\varphi \ar[u]_\epsilon
}
$$
We will use
Lemma \ref{lemma-etale-flat-up-down-local-ring}
to equate flatness over $\mathcal{O}_{S, s}$ and $\mathcal{O}_{S', s'}$
without further mention.
The map $\gamma$ is faithfully flat. Hence
$\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$
if and only if $g^*\mathcal{F}_{x'}$ is flat over
$\mathcal{O}_{S', s'}$, see
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}.
As $\mathcal{O}_{S', s'}$-modules the modules
$g^*\mathcal{F}_{x'}$, $\mathcal{G}_{z'}$, and
$\pi_*\mathcal{G}_{y'}$ are all isomorphic, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
This finishes the proof.
\end{proof}









\section{One step d\'evissage}
\label{section-one-step-devissage}

\noindent
In this section we explain what is a one step d\'evissage of a
module. A one step d\'evissage exist \'etale locally on base and target.
We discuss base change, Zariski shrinking and \'etale localization of
a one step d\'evissage.

\begin{definition}
\label{definition-one-step-devissage}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $s \in S$ be a point.
A {\it one step d\'evissage of $\mathcal{F}/X/S$ over $s$}
is given by morphisms of schemes over $S$
$$
\xymatrix{
X & Z \ar[l]_i \ar[r]^\pi & Y
}
$$
and a quasi-coherent $\mathcal{O}_Z$-module $\mathcal{G}$ of finite type
such that
\begin{enumerate}
\item $X$, $S$, $Z$ and $Y$ are affine,
\item $i$ is a closed immersion of finite presentation,
\item $\mathcal{F} \cong i_*\mathcal{G}$,
\item $\pi$ is finite, and
\item the structure morphism $Y \to S$ is smooth with
geometrically irreducible fibres of
dimension $\dim(\text{Supp}(\mathcal{F}_s))$.
\end{enumerate}
In this case we say $(Z, Y, i, \pi, \mathcal{G})$ is a one step
d\'evissage of $\mathcal{F}/X/S$ over $s$.
\end{definition}

\noindent
Note that such a one step d\'evissage can only exist if $X$ and $S$
are affine. In the definition above we only require $X$ to be
(locally) of finite type over $S$ and we continue working in this
setting below. In \cite{GruRay} the authors use consistently the setup
where $X \to S$ is locally of finite presentation and $\mathcal{F}$
quasi-coherent $\mathcal{O}_X$-module of finite type. The advantage
of this choice is that it ``makes sense'' to ask for $\mathcal{F}$ to
be of finite presentation as an $\mathcal{O}_X$-module, whereas in our
setting it ``does not make sense''. Please see
More on Morphisms, Section
\ref{more-morphisms-section-finite-type-finite-presentation}
for a discussion; the observations made there show that in our setup
we may consider the condition of $\mathcal{F}$ being ``locally of finite
presentation relative to $S$'', and we could work consistently with this
notion. Instead however, we will rely on the results of
Lemma \ref{lemma-devissage-finite-presentation}
and the observations in
Remark \ref{remark-finite-presentation}
to deal with this issue in an ad hoc fashion whenever it comes up.

\begin{definition}
\label{definition-one-step-devissage-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $x \in X$ be a point with image $s$ in $S$.
A {\it one step d\'evissage of $\mathcal{F}/X/S$ at $x$}
is a system $(Z, Y, i, \pi, \mathcal{G}, z, y)$, where
$(Z, Y, i, \pi, \mathcal{G})$ is a one step d\'evissage of
$\mathcal{F}/X/S$ over $s$ and
\begin{enumerate}
\item $\dim_x(\text{Supp}(\mathcal{F}_s)) = \dim(\text{Supp}(\mathcal{F}_s))$,
\item $z \in Z$ is a point with $i(z) = x$ and $\pi(z) = y$,
\item we have $\pi^{-1}(\{y\}) = \{z\}$,
\item the extension $\kappa(s) \subset \kappa(y)$ is purely
transcendental.
\end{enumerate}
\end{definition}

\noindent
A one step d\'evissage of $\mathcal{F}/X/S$ at $x$ can only exist if
$X$ and $S$ are affine. Condition (1) assures us that $Y \to S$ has
relative dimension equal to $\dim_x(\text{Supp}(\mathcal{F}_s))$
via condition (5) of
Definition \ref{definition-one-step-devissage}.

\begin{lemma}
\label{lemma-elementary-devissage-variant}
Let $f : X \to S$ be morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Then there exists a commutative diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d]_f & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l] \\
}
$$
such that $(S', s') \to (S, s)$ and $(X', x') \to (X, x)$
are elementary \'etale neighbourhoods, and such that
$g^*\mathcal{F}/X'/S'$ has a one step d\'evissage at $x'$.
\end{lemma}

\begin{proof}
This is immediate from
Definition \ref{definition-one-step-devissage-at-x}
and
Lemma \ref{lemma-elementary-devissage}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-one-step}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-one-step-devissage}.
Let $(Z, Y, i, \pi, \mathcal{G})$ be a one step d\'evissage
of $\mathcal{F}/X/S$ over $s$.
Let $(S', s') \to (S, s)$ be any morphism of pointed schemes.
Given this data let $X', Z', Y', i', \pi'$ be the base
changes of $X, Z, Y, i, \pi$ via $S' \to S$.
Let $\mathcal{F}'$ be the pullback of $\mathcal{F}$ to $X'$
and let $\mathcal{G}'$ be the pullback of $\mathcal{G}$ to $Z'$.
If $S'$ is affine, then $(Z', Y', i', \pi', \mathcal{G}')$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ over $s'$.
\end{lemma}

\begin{proof}
Fibre products of affines are affine, see
Schemes, Lemma \ref{schemes-lemma-fibre-product-affines}.
Base change preserves
closed immersions,
morphisms of finite presentation,
finite morphisms,
smooth morphisms,
morphisms with geometrically irreducible fibres, and
morphisms of relative dimension $n$, see
Morphisms, Lemmas \ref{morphisms-lemma-base-change-closed-immersion},
\ref{morphisms-lemma-base-change-finite-presentation},
\ref{morphisms-lemma-base-change-finite},
\ref{morphisms-lemma-base-change-smooth},
\ref{morphisms-lemma-base-change-relative-dimension-d}, and
More on Morphisms, Lemma
\ref{more-morphisms-lemma-base-change-fibres-geometrically-irreducible}.
We have $i'_*\mathcal{G}' \cong \mathcal{F}'$ because pushforward
along the finite morphism $i$ commutes with base change, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-affine-base-change}.
We have
$\dim(\text{Supp}(\mathcal{F}_s)) = \dim(\text{Supp}(\mathcal{F}'_{s'}))$
by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}
because
$$
\text{Supp}(\mathcal{F}_s) \times_s s' = \text{Supp}(\mathcal{F}'_{s'}).
$$
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-base-change-one-step-at-x}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$.
Let $(S', s') \to (S, s)$ be a morphism of pointed schemes
which induces an isomorphism $\kappa(s) = \kappa(s')$.
Let $(Z', Y', i', \pi', \mathcal{G}')$ be as constructed in
Lemma \ref{lemma-base-change-one-step}
and let $x' \in X'$ (resp.\ $z' \in Z'$, $y' \in Y'$) be the
unique point mapping to both $x \in X$ (resp.\ $z \in Z$, $y \in Y$)
and $s' \in S'$.
If $S'$ is affine, then $(Z', Y', i', \pi', \mathcal{G}', z', y')$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ at $x'$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-base-change-one-step}
$(Z', Y', i', \pi', \mathcal{G}')$ is a one step d\'evissage of
$\mathcal{F}'/X'/S'$ over $s'$. Properties (1) -- (4) of
Definition \ref{definition-one-step-devissage-at-x}
hold for $(Z', Y', i', \pi', \mathcal{G}', z', y')$
as the assumption that $\kappa(s) = \kappa(s')$ insures that the fibres
$X'_{s'}$, $Z'_{s'}$, and $Y'_{s'}$ are isomorphic to
$X_s$, $Z_s$, and $Y_s$.
\end{proof}

\begin{definition}
\label{definition-shrink}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$. Let us define a
{\it standard shrinking} of this situation to be
given by standard opens $S' \subset S$, $X' \subset X$, $Z' \subset Z$,
and $Y' \subset Y$ such that $s \in S'$, $x \in X'$, $z \in Z'$, and
$y \in Y'$ and such that
$$
(Z', Y', i|_{Z'}, \pi|_{Z'}, \mathcal{G}|_{Z'}, z, y)
$$
is a one step d\'evissage of $\mathcal{F}|_{X'}/X'/S'$ at $x$.
\end{definition}

\begin{lemma}
\label{lemma-shrink}
With assumption and notation as in
Definition \ref{definition-shrink}
we have:
\begin{enumerate}
\item
\label{item-shrink-base}
If $S' \subset S$ is a standard open neighbourhood of $s$, then
setting $X' = X_{S'}$, $Z' = Z_{S'}$ and $Y' = Y_{S'}$ we obtain a
standard shrinking.
\item
\label{item-shrink-on-Y}
Let $W \subset Y$ be a standard open neighbourhood of $y$.
Then there exists a standard shrinking with $Y' = W \times_S S'$.
\item
\label{item-shrink-on-X}
Let $U \subset X$ be an open neighbourhood of $x$.
Then there exists a standard shrinking with $X' \subset U$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is immediate from
Lemma \ref{lemma-base-change-one-step-at-x}
and the fact that the inverse image of a standard open under a morphism
of affine schemes is a standard open, see
Algebra, Lemma \ref{algebra-lemma-spec-functorial}.

\medskip\noindent
Let $W \subset Y$ as in (2). Because $Y \to S$ is smooth it is open, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-open}.
Hence we can find a standard open neighbourhood $S'$ of $s$
contained in the image of $W$. Then the fibres of $W_{S'} \to S'$
are nonempty open subschemes of the fibres of $Y \to S$ over $S'$
and hence geometrically irreducible too. Setting $Y' = W_{S'}$
and $Z' = \pi^{-1}(Y')$ we see that $Z' \subset Z$ is a standard open
neighbourhood of $z$. Let $\overline{h} \in \Gamma(Z, \mathcal{O}_Z)$
be a function such that $Z' = D(\overline{h})$. As $i : Z \to X$
is a closed immersion, we can find a function $h \in \Gamma(X, \mathcal{O}_X)$
such that $i^\sharp(h) = \overline{h}$. Take $X' = D(h) \subset X$.
In this way we obtain a standard shrinking as in (2).

\medskip\noindent
Let $U \subset X$ be as in (3). We may after shrinking $U$ assume that
$U$ is a standard open. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}
there exists a standard open $W \subset Y$ neighbourhood of $y$ such
that $\pi^{-1}(W) \subset i^{-1}(U)$. Apply (2) to get a standard
shrinking $X', S', Z', Y'$ with $Y' = W_{S'}$. Since
$Z' \subset \pi^{-1}(W) \subset i^{-1}(U)$ we may replace $X'$ by
$X' \cap U$ (still a standard open as $U$ is also standard open)
without violating any of the conditions defining a standard shrinking.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-elementary-etale-neighbourhood}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$. Let
$$
\xymatrix{
(Y, y) \ar[d] & (Y', y') \ar[l] \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
be a commutative diagram of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods. Then there exists
a commutative diagram
$$
\xymatrix{
& & (X'', x'') \ar[lld] \ar[d] & (Z'', z'') \ar[l] \ar[lld] \ar[d] \\
(X, x) \ar[d] & (Z, z) \ar[l] \ar[d] &
(S'', s'') \ar[lld] & (Y'', y'') \ar[lld] \ar[l] \\
(S, s) & (Y, y) \ar[l]
}
$$
of pointed schemes with the following properties:
\begin{enumerate}
\item $(S'', s'') \to (S', s')$ is an elementary \'etale neighbourhood and
the morphism $S'' \to S$ is the composition $S'' \to S' \to S$,
\item $Y''$ is an open subscheme of $Y' \times_{S'} S''$,
\item $Z'' = Z \times_Y Y''$,
\item $(X'', x'') \to (X, x)$ is an elementary \'etale neighbourhood, and
\item $(Z'', Y'', i'', \pi'', \mathcal{G}'', z'', y'')$ is a one step
d\'evissage at $x''$ of the sheaf $\mathcal{F}''$.
\end{enumerate}
Here $\mathcal{F}''$ (resp.\ $\mathcal{G}''$) is the pullback of
$\mathcal{F}$ (resp.\ $\mathcal{G}$) via the morphism $X'' \to X$
(resp.\ $Z'' \to Z$) and $i'' : Z'' \to X''$ and $\pi'' : Z'' \to Y''$
are as in the diagram.
\end{lemma}

\begin{proof}
Let $(S'', s'') \to (S', s')$ be any elementary \'etale neighbourhood
with $S''$ affine. Let $Y'' \subset Y' \times_{S'} S''$ be any affine
open neighbourhood containing the point $y'' = (y', s'')$. Then we
obtain an affine $(Z'', z'')$ by (3). Moreover $Z_{S''} \to X_{S''}$
is a closed immersion and $Z'' \to Z_{S''}$ is an \'etale
morphism. Hence
Lemma \ref{lemma-lift-etale}
applies and we can find an \'etale morphism $X'' \to X_{S'}$ of affines
such that $Z'' \cong X'' \times_{X_{S'}} Z_{S'}$. Denote $i'' : Z'' \to X''$
the corresponding closed immersion. Setting $x'' = i''(z'')$ we obtain a
commutative diagram as in the lemma.
Properties (1), (2), (3), and (4) hold by construction.
Thus it suffices to show that (5) holds for a suitable choice of
$(S'', s'') \to (S', s')$ and $Y''$.

\medskip\noindent
We first list those properties which hold for any choice of
$(S'', s'') \to (S', s')$ and $Y''$ as in the first paragraph.
As we have $Z'' = X'' \times_X Z$ by construction we see that
$i''_*\mathcal{G}'' = \mathcal{F}''$ (with notation as in the
statement of the lemma), see
Cohomology of Schemes, Lemma \ref{coherent-lemma-affine-base-change}.
Set $n = \dim(\text{Supp}(\mathcal{F}_s)) = \dim_x(\text{Supp}(\mathcal{F}_s))$.
The morphism $Y'' \to S''$ is smooth of relative dimension $n$
(because $Y' \to S'$ is smooth of relative dimension $n$
as the composition $Y' \to Y_{S'} \to S'$ of an \'etale and
smooth morphism of relative dimension $n$ and because base change
preserves smooth morphisms of relative dimension $n$).
We have $\kappa(y'') = \kappa(y)$ and $\kappa(s) = \kappa(s'')$
hence $\kappa(y'')$ is a purely transcendental extension of $\kappa(s'')$.
The morphism of fibres $X''_{s''} \to X_s$ is an \'etale morphism of affine
schemes over $\kappa(s) = \kappa(s'')$ mapping the point $x''$ to the
point $x$ and pulling back $\mathcal{F}_s$ to $\mathcal{F}''_{s''}$.
Hence
$$
\dim(\text{Supp}(\mathcal{F}''_{s''})) =
\dim(\text{Supp}(\mathcal{F}_s)) = n =
\dim_x(\text{Supp}(\mathcal{F}_s)) =
\dim_{x''}(\text{Supp}(\mathcal{F}''_{s''}))
$$
because dimension is invariant under \'etale localization, see
Descent, Lemma \ref{descent-lemma-dimension-at-point-local}.
As $\pi'' : Z'' \to Y''$ is the base change of $\pi$ we see that
$\pi''$ is finite and as $\kappa(y) = \kappa(y'')$ we see that
$\pi^{-1}(\{y''\}) = \{z''\}$.

\medskip\noindent
At this point we have verified all the conditions of
Definition \ref{definition-one-step-devissage}
except we have not verified that $Y'' \to S''$ has geometrically
irreducible fibres. Of course in general this is not going to be
true, and it is at this point that we will use that
$\kappa(s) \subset \kappa(y)$ is purely transcendental. Namely,
let $T \subset Y'_{s'}$ be the irreducible component of
$Y'_{s'}$ containing $y' = (y, s')$. Note that $T$ is an open subscheme
of $Y'_{s'}$ as this is a smooth scheme over $\kappa(s')$. By
Varieties,
Lemma \ref{varieties-lemma-geometrically-connected-if-connected-and-point}
we see that $T$ is geometrically connected because $\kappa(s') = \kappa(s)$
is algebraically closed in $\kappa(y') = \kappa(y)$.
As $T$ is smooth we see that $T$ is geometrically irreducible. Hence
More on Morphisms,
Lemma \ref{more-morphisms-lemma-normal-morphism-irreducible}
applies and we can find an elementary \'etale morphism
$(S'', s'') \to (S', s')$ and an affine open $Y'' \subset Y'_{S''}$
such that all fibres of $Y'' \to S''$ are geometrically irreducible
and such that $T = Y''_{s''}$. After shrinking (first $Y''$ and then $S''$)
we may assume that both $Y''$ and $S''$ are affine.
This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-existence-alpha}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-one-step-devissage}.
Let $(Z, Y, i, \pi, \mathcal{G})$ be a one step d\'evissage
of $\mathcal{F}/X/S$ over $s$.
Let $\xi \in Y_s$ be the (unique) generic point.
Then there exists an integer $r > 0$ and an $\mathcal{O}_Y$-module map
$$
\alpha : \mathcal{O}_Y^{\oplus r} \longrightarrow \pi_*\mathcal{G}
$$
such that
$$
\alpha :
\kappa(\xi)^{\oplus r}
\longrightarrow
(\pi_*\mathcal{G})_\xi \otimes_{\mathcal{O}_{Y, \xi}} \kappa(\xi)
$$
is an isomorphism. Moreover, in this case we have
$$
\dim(\text{Supp}(\Coker(\alpha)_s)) < \dim(\text{Supp}(\mathcal{F}_s)).
$$
\end{lemma}

\begin{proof}
By assumption the schemes $S$ and $Y$ are affine.
Write $S = \Spec(A)$ and $Y = \Spec(B)$.
As $\pi$ is finite the $\mathcal{O}_Y$-module $\pi_*\mathcal{G}$
is a finite type quasi-coherent $\mathcal{O}_Y$-module.
Hence $\pi_*\mathcal{G} = \widetilde{N}$ for some finite $B$-module $N$.
Let $\mathfrak p \subset B$ be the prime ideal corresponding to $\xi$.
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_B \kappa(\mathfrak p)$
and pick $x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_B \kappa(\mathfrak p)$. Take $\alpha : B^{\oplus r} \to N$
to be the map given by the formula $\alpha(b_1, \ldots, b_r) = \sum b_ix_i$.
It is clear that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_B \kappa(\mathfrak p)$
is an isomorphism as desired. Finally, suppose $\alpha$ is any map with this
property. Then $N' = \Coker(\alpha)$ is a finite $B$-module
such that $N' \otimes \kappa(\mathfrak p) = 0$. By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
we see that $N'_{\mathfrak p} = 0$. Since the fibre $Y_s$ is
geometrically irreducible of dimension $n$ with generic point $\xi$
and since we have just seen that $\xi$ is not in the support of
$\Coker(\alpha)$ the last assertion of the lemma holds.
\end{proof}


\section{Complete d\'evissage}
\label{section-complete-devissage}

\noindent
In this section we explain what is a complete d\'evissage of a
module and prove that such exist. The material in this
section is mainly bookkeeping.

\begin{definition}
\label{definition-complete-devissage}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $s \in S$ be a point.
A {\it complete d\'evissage of $\mathcal{F}/X/S$ over $s$} is given by a
diagram
$$
\xymatrix{
X & Z_1 \ar[l]^{i_1} \ar[d]^{\pi_1} \\
& Y_1 & Z_2 \ar[l]^{i_2} \ar[d]^{\pi_2} \\
& & Y_2 & Z_3 \ar[l] \ar[d] \\
& & & ... & ... \ar[l] \ar[d] \\
& & & & Y_n
}
$$
of schemes over $S$, finite type quasi-coherent $\mathcal{O}_{Z_k}$-modules
$\mathcal{G}_k$, and $\mathcal{O}_{Y_k}$-module maps
$$
\alpha_k :
\mathcal{O}_{Y_k}^{\oplus r_k}
\longrightarrow
\pi_{k, *}\mathcal{G}_k,
\quad
k = 1, \ldots, n
$$
satisfying the following properties:
\begin{enumerate}
\item $(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ is a one step
d\'evissage of $\mathcal{F}/X/S$ over $s$,
\item the map $\alpha_k$ induces an isomorphism
$$
\kappa(\xi_k)^{\oplus r_k} \longrightarrow
(\pi_{k, *}\mathcal{G}_k)_{\xi_k}
\otimes_{\mathcal{O}_{Y_k, \xi_k}} \kappa(\xi_k)
$$
where $\xi_k \in (Y_k)_s$ is the unique generic point,
\item for $k = 2, \ldots, n$ the system
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k)$
is a one step d\'evissage of $\Coker(\alpha_{k - 1})/Y_{k - 1}/S$
over $s$,
\item $\Coker(\alpha_n) = 0$.
\end{enumerate}
In this case we say that
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}/X/S$ over $s$.
\end{definition}

\begin{definition}
\label{definition-complete-devissage-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $x \in X$ be a point with image $s \in S$.
A {\it complete d\'evissage of $\mathcal{F}/X/S$ at $x$} is given by a
system
$$
(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}
$$
such that $(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)$ is a
complete d\'evissage of $\mathcal{F}/X/S$ over $s$, and such that
\begin{enumerate}
\item $(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1, z_1, y_1)$ is a one step
d\'evissage of $\mathcal{F}/X/S$ at $x$,
\item for $k = 2, \ldots, n$ the system
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, z_k, y_k)$
is a one step d\'evissage of $\Coker(\alpha_{k - 1})/Y_{k - 1}/S$
at $y_{k - 1}$.
\end{enumerate}
\end{definition}

\noindent
Again we remark that a complete d\'evissage can only exist if $X$ and
$S$ are affine.

\begin{lemma}
\label{lemma-base-change-complete}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-complete-devissage}.
Let $(S', s') \to (S, s)$ be any morphism of pointed schemes.
Let $(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)_{k = 1, \ldots, n}$
be a complete d\'evissage of $\mathcal{F}/X/S$ over $s$.
Given this data let $X', Z'_k, Y'_k, i'_k, \pi'_k$ be the base
changes of $X, Z_k, Y_k, i_k, \pi_k$ via $S' \to S$.
Let $\mathcal{F}'$ be the pullback of $\mathcal{F}$ to $X'$
and let $\mathcal{G}'_k$ be the pullback of $\mathcal{G}_k$ to $Z'_k$.
Let $\alpha'_k$ be the pullback of $\alpha_k$ to $Y'_k$.
If $S'$ is affine, then
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}'/X'/S'$ over $s'$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-base-change-one-step}
we know that the base change of a one step d\'evissage is a one step
d\'evissage. Hence it suffices to prove that formation of
$\Coker(\alpha_k)$ commutes with base change and that
condition (2) of
Definition \ref{definition-complete-devissage}
is preserved by base change. The first is true as
$\pi'_{k, *}\mathcal{G}'_k$ is the pullback of
$\pi_{k, *}\mathcal{G}_k$ (by
Cohomology of Schemes, Lemma \ref{coherent-lemma-affine-base-change})
and because $\otimes$ is right exact. The second because
by the same token we have
$$
(\pi_{k, *}\mathcal{G}_k)_{\xi_k}
\otimes_{\mathcal{O}_{Y_k, \xi_k}} \kappa(\xi_k)
\otimes_{\kappa(\xi_k)} \kappa(\xi'_k)
\cong
(\pi'_{k, *}\mathcal{G}'_k)_{\xi'_k}
\otimes_{\mathcal{O}_{Y'_k, \xi'_k}} \kappa(\xi'_k)
$$
with obvious notation.
\end{proof}

\begin{lemma}
\label{lemma-base-change-complete-at-x}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-complete-devissage-at-x}.
Let $(S', s') \to (S, s)$ be a morphism of pointed schemes
which induces an isomorphism $\kappa(s) = \kappa(s')$. Let
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}$
be a complete d\'evissage of $\mathcal{F}/X/S$ at $x$.
Let
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k)_{k = 1, \ldots, n}$
be as constructed in
Lemma \ref{lemma-base-change-complete}
and let $x' \in X'$ (resp.\ $z'_k \in Z'$, $y'_k \in Y'$) be the
unique point mapping to both $x \in X$ (resp.\ $z_k \in Z_k$, $y_k \in Y_k$)
and $s' \in S'$.
If $S'$ is affine, then
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k,
z'_k, y'_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}'/X'/S'$ at $x'$.
\end{lemma}

\begin{proof}
Combine
Lemma \ref{lemma-base-change-complete}
and
Lemma \ref{lemma-base-change-one-step-at-x}.
\end{proof}

\begin{definition}
\label{definition-shrink-complete}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-complete-devissage-at-x}.
Consider a complete d\'evissage
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}$
of $\mathcal{F}/X/S$ at $x$. Let us define a
{\it standard shrinking} of this situation to be
given by standard opens $S' \subset S$, $X' \subset X$,
$Z'_k \subset Z_k$, and $Y'_k \subset Y_k$ such that $s_k \in S'$,
$x_k \in X'$, $z_k \in Z'$, and $y_k \in Y'$ and such that
$$
(Z'_k, Y'_k, i'_k, \pi'_k,
\mathcal{G}'_k, \alpha'_k, z_k, y_k)_{k = 1, \ldots, n}
$$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ at $x$ where
$\mathcal{G}'_k = \mathcal{G}_k|_{Z'_k}$ and
$\mathcal{F}' = \mathcal{F}|_{X'}$.
\end{definition}

\begin{lemma}
\label{lemma-shrink-complete}
With assumption and notation as in
Definition \ref{definition-shrink-complete}
we have:
\begin{enumerate}
\item
\label{item-shrink-base-complete}
If $S' \subset S$ is a standard open neighbourhood of $s$, then
setting $X' = X_{S'}$, $Z'_k = Z_{S'}$ and $Y'_k = Y_{S'}$ we obtain a
standard shrinking.
\item
\label{item-shrink-on-Y-complete}
Let $W \subset Y_n$ be a standard open neighbourhood of $y$.
Then there exists a standard shrinking with $Y'_n = W \times_S S'$.
\item
\label{item-shrink-on-X-complete}
Let $U \subset X$ be an open neighbourhood of $x$.
Then there exists a standard shrinking with $X' \subset U$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is immediate from
Lemmas \ref{lemma-base-change-complete-at-x} and
\ref{lemma-shrink}.

\medskip\noindent
Proof of (2). For convenience denote $X = Y_0$. We apply
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
to find a standard shrinking
$S', Y'_{n - 1}, Z'_n, Y'_n$
of the one step d\'evissage of $\Coker(\alpha_{n - 1})/Y_{n - 1}/S$
at $y_{n - 1}$ with $Y'_n = W \times_S S'$. We may repeat this procedure
and find a standard shrinking
$S'', Y''_{n - 2}, Z''_{n - 1}, Y''_{n - 1}$
of the one step d\'evissage of $\Coker(\alpha_{n - 2})/Y_{n - 2}/S$
at $y_{n - 2}$ with $Y''_{n - 1} = Y'_{n - 1} \times_S S''$.
We may continue in this manner until we obtain
$S^{(n)}, Y^{(n)}_0, Z^{(n)}_1, Y^{(n)}_1$.
At this point it is clear that we obtain our desired standard shrinking
by taking $S^{(n)}$, $X^{(n)}$, $Z_k^{(n - k)} \times_S S^{(n)}$, and
$Y_k^{(n - k)} \times_S S^{(n)}$ with the desired property.

\medskip\noindent
Proof of (3). We use induction on the length of the complete
d\'evissage. First we apply
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-X})
to find a standard shrinking
$S', X', Z'_1, Y'_1$
of the one step d\'evissage of $\mathcal{F}/X/S$ at $x$
with $X' \subset U$. If $n = 1$, then we are done.
If $n > 1$, then by induction we can find a standard shrinking
$S''$, $Y''_1$, $Z''_k$, and $Y''_k$ of the complete d\'evissage
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 2, \ldots, n}$
of $\Coker(\alpha_1)/Y_1/S$ at $x$ such that
$Y''_1 \subset Y'_1$. Using
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
we can find $S''' \subset S'$, $X''' \subset X'$, $Z'''_1$ and
$Y'''_1 = Y''_1 \times_S S'''$ which is a standard shrinking.
The solution to our problem is to take
$$
S''', X''', Z'''_1, Y'''_1, Z''_2 \times_S S''',
Y''_2 \times_S S''', \ldots, Z''_n \times_S S''', Y''_n \times_S S'''
$$
This ends the proof of the lemma.
\end{proof}

\begin{proposition}
\label{proposition-existence-complete-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $x \in X$ be a point with image $s \in S$.
There exists a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $g^*\mathcal{F}/X'/S'$ has a complete
d\'evissage at $x$.
\end{proposition}

\begin{proof}
We prove this by induction on the integer
$d = \dim_x(\text{Supp}(\mathcal{F}_s))$.
By
Lemma \ref{lemma-elementary-devissage-variant}
there exists a diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $g^*\mathcal{F}/X'/S'$ has a one step d\'evissage at $x'$.
The local nature of the problem implies that we may replace
$(X, x) \to (S, s)$ by $(X', x') \to (S', s')$. Thus after doing so
we may assume that there exists a one step d\'evissage
$(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ of $\mathcal{F}/X/S$ at $x$.

\medskip\noindent
We apply
Lemma \ref{lemma-existence-alpha}
to find a map
$$
\alpha_1 :
\mathcal{O}_{Y_1}^{\oplus r_1}
\longrightarrow
\pi_{1, *}\mathcal{G}_1
$$
which induces an isomorphism of vector spaces over $\kappa(\xi_1)$
where $\xi_1 \in Y_1$ is the unique generic point of the fibre of
$Y_1$ over $s$. Moreover
$\dim_{y_1}(\text{Supp}(\Coker(\alpha_1)_s)) < d$.
It may happen that the stalk of $\Coker(\alpha_1)_s$
at $y_1$ is zero. In this case we may shrink $Y_1$ by
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
and assume that $\Coker(\alpha_1) = 0$ so we obtain a
complete d\'evissage of length zero.

\medskip\noindent
Assume now that the stalk of $\Coker(\alpha_1)_s$
at $y_1$ is not zero. In this case, by induction, there exists a
commutative diagram
\begin{equation}
\label{equation-overcome-this}
\vcenter{
\xymatrix{
(Y_1, y_1) \ar[d] & (Y'_1, y'_1) \ar[l]^h \ar[d] \\
(S, s) & (S', s') \ar[l]
}
}
\end{equation}
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $h^*\Coker(\alpha_1)/Y'_1/S'$ has a complete
d\'evissage
$$
(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 2, \ldots, n}
$$
at $y'_1$. (In particular $i_2 : Z_2 \to Y'_1$ is a closed immersion into
$Y'_2$.) At this point we apply
Lemma \ref{lemma-elementary-etale-neighbourhood}
to $S, X, \mathcal{F}, x, s$, the system
$(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ and
diagram (\ref{equation-overcome-this}). We obtain a diagram
$$
\xymatrix{
& & (X'', x'') \ar[lld] \ar[d] & (Z''_1, z''_1) \ar[l] \ar[lld] \ar[d] \\
(X, x) \ar[d] & (Z_1, z_1) \ar[l] \ar[d] &
(S'', s'') \ar[lld] & (Y''_1, y''_1) \ar[lld] \ar[l] \\
(S, s) & (Y_1, y_1) \ar[l]
}
$$
with all the properties as listed in the referenced lemma.
In particular $Y''_1 \subset Y'_1 \times_{S'} S''$. Set
$X_1 = Y'_1 \times_{S'} S''$ and let $\mathcal{F}_1$ denote the
pullback of $\Coker(\alpha_1)$. By
Lemma \ref{lemma-base-change-complete-at-x}
the system
\begin{equation}
\label{equation-shrink-this}
(Z_k \times_{S'} S'',
Y_k \times_{S'} S'', i''_k, \pi''_k, \mathcal{G}''_k,
\alpha''_k, z''_k, y''_k)_{k = 2, \ldots, n}
\end{equation}
is a complete d\'evissage of $\mathcal{F}_1$
to $X_1$. Again, the nature of the problem allows
us to replace $(X, x) \to (S, s)$ by $(X'', x'') \to (S'', s'')$.
In this we see that we may assume:
\begin{enumerate}
\item[(a)] There exists a one step d\'evissage
$(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ of $\mathcal{F}/X/S$ at $x$,
\item[(b)] there exists an $\alpha_1 : \mathcal{O}_{Y_1}^{\oplus r_1}
\to \pi_{1, *}\mathcal{G}_1$ such that $\alpha \otimes \kappa(\xi_1)$
is an isomorphism,
\item[(c)] $Y_1 \subset X_1$ is open, $y_1 = x_1$, and
$\mathcal{F}_1|_{Y_1} \cong \Coker(\alpha_1)$, and
\item[(d)] there exists a complete d\'evissage
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 2, \ldots, n}$
of $\mathcal{F}_1/X_1/S$ at $x_1$.
\end{enumerate}
To finish the proof all we have to do is shrink the one step d\'evissage
and the complete d\'evissage such that they fit together to a complete
d\'evissage. (We suggest the reader do this on their own using
Lemmas \ref{lemma-shrink} and
\ref{lemma-shrink-complete}
instead of reading the proof that follows.) Since $Y_1 \subset X_1$
is an open neighbourhood of $x_1$ we may apply
Lemma \ref{lemma-shrink-complete} (\ref{item-shrink-on-X-complete})
to find a standard shrinking $S', X'_1, Z'_2, Y'_2, \ldots, Y'_n$
of the datum (d) so that $X'_1 \subset Y_1$. Note that $X'_1$ is also
a standard open of the affine scheme $Y_1$. Next, we shrink the datum
(a) as follows: first we shrink the base $S$ to $S'$, see
Lemma \ref{lemma-shrink} (\ref{item-shrink-base}) and then
we shrink the result to $S''$, $X''$, $Z''_1$, $Y''_1$ using
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
such that eventually $Y''_1 = X'_1 \times_S S''$ and $S'' \subset S'$.
Then we see that
$$
Z''_1, Y''_1, Z'_2 \times_{S'} S'', Y'_2 \times_{S'} S'', \ldots,
Y'_n \times_{S'} S''
$$
gives the complete d\'evissage we were looking for.
\end{proof}

\noindent
Some more bookkeeping gives the following consequence.

\begin{lemma}
\label{lemma-existence-complete}
Let $X \to S$ be a finite type morphism of schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$ be a point.
There exists an elementary \'etale neighbourhood
$(S', s') \to (S, s)$ and \'etale morphisms
$h_i : Y_i \to X_{S'}$, $i = 1, \ldots, n$ such that for each
$i$ there exists a complete d\'evissage of $\mathcal{F}_i/Y_i/S'$ over $s'$,
where $\mathcal{F}_i$ is the pullback of $\mathcal{F}$ to $Y_i$
and such that $X_s = (X_{S'})_{s'} \subset \bigcup h_i(Y_i)$.
\end{lemma}

\begin{proof}
For every point $x \in X_s$ we can find a diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal arrows are elementary
\'etale neighbourhoods and such that $g^*\mathcal{F}/X'/S'$ has a
complete d\'evissage at $x'$. As $X \to S$ is of finite type the
fibre $X_s$ is quasi-compact, and since each $g : X' \to X$ as above
is open we can cover $X_s$ by a finite union of $g(X'_{s'})$.
Thus we can find a finite family of such diagrams
$$
\vcenter{
\xymatrix{
(X, x) \ar[d] & (X'_i, x'_i) \ar[l]^{g_i} \ar[d] \\
(S, s) & (S'_i, s'_i) \ar[l]
}
}
\quad i = 1, \ldots, n
$$
such that $X_s = \bigcup g_i(X'_i)$. Set
$S' = S'_1 \times_S \ldots \times_S S'_n$
and let $Y_i = X_i \times_{S'_i} S'$ be the base change of $X'_i$ to $S'$. By
Lemma \ref{lemma-base-change-complete}
we see that the pullback of $\mathcal{F}$ to $Y_i$ has a complete d\'evissage
over $s$ and we win.
\end{proof}



\section{Translation into algebra}
\label{section-translation}

\noindent
It may be useful to spell out algebraically what it means to have a
complete d\'evissage. We introduce the following notion (which is not
that useful so we give it an impossibly long name).

\begin{definition}
\label{definition-elementary-etale-neighbourhood}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$ lying over
the prime $\mathfrak p$ of $R$. A {\it elementary \'etale localization of
the ring map $R \to S$ at $\mathfrak q$} is given by a commutative diagram
of rings and accompanying primes
$$
\xymatrix{
S \ar[r] & S' \\
R \ar[u] \ar[r] & R' \ar[u]
}
\quad\quad
\xymatrix{
\mathfrak q \ar@{-}[r] & \mathfrak q' \\
\mathfrak p \ar@{-}[u] \ar@{-}[r] & \mathfrak p' \ar@{-}[u]
}
$$
such that $R \to R'$ and $S \to S'$ are \'etale ring maps and
$\kappa(\mathfrak p) = \kappa(\mathfrak p')$ and
$\kappa(\mathfrak q) = \kappa(\mathfrak q')$.
\end{definition}

\begin{definition}
\label{definition-complete-devissage-algebra}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak r$ be a prime of $R$.
Let $N$ be a finite $S$-module.
A {\it complete d\'evissage of $N/S/R$ over $\mathfrak r$}
is given by $R$-algebra maps
$$
\xymatrix{
& A_1 & & A_2 & & ... & & A_n \\
S \ar[ru] & & B_1 \ar[lu] \ar[ru] & & ... \ar[lu] \ar[ru] & &
... \ar[lu] \ar[ru] & & B_n \ar[lu]
}
$$
finite $A_i$-modules $M_i$ and $B_i$-module maps
$\alpha_i : B_i^{\oplus r_i} \to M_i$ such that
\begin{enumerate}
\item $S \to A_1$ is surjective and of finite presentation,
\item $B_i \to A_{i + 1}$ is surjective and of finite presentation,
\item $B_i \to A_i$ is finite,
\item $R \to B_i$ is smooth with geometrically irreducible fibres,
\item $N \cong M_1$ as $S$-modules,
\item $\Coker(\alpha_i) \cong M_{i + 1}$ as $B_i$-modules,
\item $\alpha_i : \kappa(\mathfrak p_i)^{\oplus r_i}
\to M_i \otimes_{B_i} \kappa(\mathfrak p_i)$ is an isomorphism
where $\mathfrak p_i = \mathfrak rB_i$, and
\item $\Coker(\alpha_n) = 0$.
\end{enumerate}
In this situation we say that
$(A_i, B_i, M_i, \alpha_i)_{i = 1, \ldots, n}$
is a complete d\'evissage of $N/S/R$ over $\mathfrak r$.
\end{definition}

\begin{remark}
\label{remark-finite-presentation}
Note that the $R$-algebras $B_i$ for all $i$ and $A_i$ for $i \geq 2$
are of finite presentation over $R$. If $S$ is of finite presentation over
$R$, then it is also the case that $A_1$ is of finite presentation over
$R$. In this case all the ring maps in the complete d\'evissage are of
finite presentation. See
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
Still assuming $S$ of finite presentation over $R$
the following are equivalent
\begin{enumerate}
\item $M$ is of finite presentation over $S$,
\item $M_1$ is of finite presentation over $A_1$,
\item $M_1$ is of finite presentation over $B_1$,
\item each $M_i$ is of finite presentation both as an $A_i$-module
and as a $B_i$-module.
\end{enumerate}
The equivalences (1) $\Leftrightarrow$ (2) and (2) $\Leftrightarrow$ (3)
follow from
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
If $M_1$ is finitely presented, so is $\Coker(\alpha_1)$ (see
Algebra, Lemma \ref{algebra-lemma-extension})
and hence $M_2$, etc.
\end{remark}

\begin{definition}
\label{definition-complete-devissage-at-x-algebra}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q$ be a prime of $S$ lying over the prime $\mathfrak r$ of $R$.
Let $N$ be a finite $S$-module.
A {\it complete d\'evissage of $N/S/R$ at $\mathfrak q$} is given by a
complete d\'evissage $(A_i, B_i, M_i, \alpha_i)_{i = 1, \ldots, n}$
of $N/S/R$ over $\mathfrak r$ and prime ideals $\mathfrak q_i \subset B_i$
lying over $\mathfrak r$ such that
\begin{enumerate}
\item $\kappa(\mathfrak r) \subset \kappa(\mathfrak q_i)$ is purely
transcendental,
\item there is a unique prime $\mathfrak q'_i \subset A_i$
lying over $\mathfrak q_i \subset B_i$,
\item $\mathfrak q = \mathfrak q'_1 \cap S$ and
$\mathfrak q_i = \mathfrak q'_{i + 1} \cap A_i$,
\item $R \to B_i$ has relative dimension
$\dim_{\mathfrak q_i}(\text{Supp}(M_i \otimes_R \kappa(\mathfrak r)))$.
\end{enumerate}
\end{definition}

\begin{remark}
\label{remark-same-notion}
Let $A \to B$ be a finite type ring map and let $N$ be a finite
$B$-module. Let $\mathfrak q$ be a prime of $B$ lying over the prime
$\mathfrak r$ of $A$. Set $X = \Spec(B)$, $S = \Spec(A)$ and
$\mathcal{F} = \widetilde{N}$ on $X$. Let $x$ be the point corresponding
to $\mathfrak q$ and let $s \in S$ be the point corresponding to
$\mathfrak p$. Then
\begin{enumerate}
\item if there exists a complete d\'evissage of $\mathcal{F}/X/S$
over $s$ then there exists a complete d\'evissage of
$N/B/A$ over $\mathfrak p$, and
\item there exists a complete d\'evissage of $\mathcal{F}/X/S$
at $x$ if and only if there exists a complete d\'evissage of
$N/B/A$ at $\mathfrak q$.
\end{enumerate}
There is just a small twist in that we omitted the condition on
the relative dimension in the formulation of ``a complete d\'evissage of
$N/B/A$ over $\mathfrak p$'' which is why the implication in (1)
only goes in one direction.
The notion of a complete d\'evissage at
$\mathfrak q$ does have this condition built in. In any case we will
only use that existence for $\mathcal{F}/X/S$
implies the existence for $N/B/A$.
\end{remark}

\begin{lemma}
\label{lemma-existence-algebra}
Let $R \to S$ be a finite type ring map.
Let $M$ be a finite $S$-module.
Let $\mathfrak q$ be a prime ideal of $S$.
There exists an elementary \'etale localization
$R' \to S', \mathfrak q', \mathfrak p'$ of
the ring map $R \to S$ at $\mathfrak q$ such that
there exists a complete d\'evissage of
$(M \otimes_S S')/S'/R'$ at $\mathfrak q'$.
\end{lemma}

\begin{proof}
This is a reformulation of
Proposition \ref{proposition-existence-complete-at-x}
via
Remark \ref{remark-same-notion}
\end{proof}




\section{Localization and universally injective maps}
\label{section-localize-universally-injective}


\begin{lemma}
\label{lemma-homothety-spectrum}
Let $R \to S$ be a ring map.
Let $N$ be a $S$-module.
Assume
\begin{enumerate}
\item $R$ is a local ring with maximal ideal $\mathfrak m$,
\item $\overline{S} = S/\mathfrak m S$ is Noetherian, and
\item $\overline{N} = N/\mathfrak m_R N$ is a finite $\overline{S}$-module.
\end{enumerate}
Let $\Sigma \subset S$ be the multiplicative subset of elements which are not
a zerodivisor on $\overline{N}$. Then $\Sigma^{-1}S$ is a semi-local ring
whose spectrum consists of primes $\mathfrak q \subset S$ contained in an
element of $\text{Ass}_S(\overline{N})$. Moreover, any maximal
ideal of $\Sigma^{-1}S$ corresponds to an associated prime of
$\overline{N}$ over $\overline{S}$.
\end{lemma}

\begin{proof}
Note that
$\text{Ass}_S(\overline{N}) = \text{Ass}_{\overline{S}}(\overline{N})$, see
Algebra, Lemma \ref{algebra-lemma-ass-quotient-ring}.
This is a finite set by
Algebra, Lemma \ref{algebra-lemma-finite-ass}.
Say $\{\mathfrak q_1, \ldots, \mathfrak q_r\} = \text{Ass}_S(\overline{N})$.
We have $\Sigma = S \setminus (\bigcup \mathfrak q_i)$ by
Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}.
By the description of $\Spec(\Sigma^{-1}S)$ in
Algebra, Lemma \ref{algebra-lemma-spec-localization}
and by
Algebra, Lemma \ref{algebra-lemma-silly}
we see that the primes of $\Sigma^{-1}S$ correspond to the primes of
$S$ contained in one of the $\mathfrak q_i$.
Hence the maximal ideals of $\Sigma^{-1}S$ correspond one-to-one with the
maximal (w.r.t.\ inclusion) elements of the set
$\{\mathfrak q_1, \ldots, \mathfrak q_r\}$. This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-homothety-universally-injective}
Assumption and notation as in
Lemma \ref{lemma-homothety-spectrum}.
Assume moreover that
\begin{enumerate}
\item $S$ is local and $R \to S$ is a local homomorphism,
\item $S$ is essentially of finite presentation over $R$,
\item $N$ is finitely presented over $S$, and
\item $N$ is flat over $R$.
\end{enumerate}
Then each $s \in \Sigma$ defines a
universally injective $R$-module map $s : N \to N$, and the
map $N \to \Sigma^{-1}N$ is $R$-universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-mod-injective-general}
the sequence $0 \to N \to N \to N/sN \to 0$ is exact and
$N/sN$ is flat over $R$. This implies that $s : N \to N$
is universally injective, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
The map $N \to \Sigma^{-1}N$ is universally injective as the directed
colimit of the maps $s : N \to N$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-flat-local}
Let $R \to S$ be a ring map.
Let $N$ be an $S$-module.
Let $S \to S'$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is a local homomorphism of local rings
\item $S$ is essentially of finite presentation over $R$,
\item $N$ is of finite presentation over $S$,
\item $N$ is flat over $R$,
\item $S \to S'$ is flat, and
\item the image of $\Spec(S') \to \Spec(S)$ contains
all primes $\mathfrak q$ of $S$ lying over $\mathfrak m_R$
such that $\mathfrak q$ is an associated prime of $N/\mathfrak m_R N$.
\end{enumerate}
Then $N \to N \otimes_S S'$ is $R$-universally injective.
\end{lemma}

\begin{proof}
Set $N' = N \otimes_R S'$. Consider the commutative diagram
$$
\xymatrix{
N \ar[d] \ar[r] & N' \ar[d] \\
\Sigma^{-1}N \ar[r] & \Sigma^{-1}N'
}
$$
where $\Sigma \subset S$ is the set of elements which are not a
zerodivisor on $N/\mathfrak m_R N$. If we can show that the map
$N \to \Sigma^{-1}N'$ is universally injective, then $N \to N'$
is too (see
Algebra, Lemma \ref{algebra-lemma-universally-injective-permanence}).

\medskip\noindent
By
Lemma \ref{lemma-homothety-spectrum}
the ring $\Sigma^{-1}S$ is a semi-local ring whose maximal ideals
correspond to associated primes of $N/\mathfrak m_R N$.
Hence the image of
$\Spec(\Sigma^{-1}S') \to \Spec(\Sigma^{-1}S)$
contains all these maximal ideals by assumption. By
Algebra, Lemma \ref{algebra-lemma-ff-rings}
the ring map $\Sigma^{-1}S \to \Sigma^{-1}S'$ is faithfully flat.
Hence $\Sigma^{-1}N \to \Sigma^{-1}N'$, which is the map
$$
N \otimes_S \Sigma^{-1}S \longrightarrow N \otimes_S \Sigma^{-1}S'
$$
is universally injective, see
Algebra, Lemmas \ref{algebra-lemma-faithfully-flat-universally-injective} and
\ref{algebra-lemma-universally-injective-tensor}.
Finally, we apply
Lemma \ref{lemma-homothety-universally-injective}
to see that $N \to \Sigma^{-1}N$ is universally injective.
As the composition of universally injective module maps is universally
injective (see
Algebra, Lemma \ref{algebra-lemma-composition-universally-injective})
we conclude that $N \to \Sigma^{-1}N'$ is universally injective and we win.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-flat}
Let $R \to S$ be a ring map.
Let $N$ be an $S$-module.
Let $S \to S'$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is of finite presentation and $N$ is of finite presentation
over $S$,
\item $N$ is flat over $R$,
\item $S \to S'$ is flat, and
\item the image of $\Spec(S') \to \Spec(S)$ contains
all primes $\mathfrak q$ such that $\mathfrak q$ is an associated prime
of $N \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p$ is the inverse
image of $\mathfrak q$ in $R$.
\end{enumerate}
Then $N \to N \otimes_S S'$ is $R$-universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-universally-injective-check-stalks}
it suffices to show that $N_{\mathfrak q} \to (N \otimes_R S')_{\mathfrak q}$
is a $R_{\mathfrak p}$-universally injective for any prime $\mathfrak q$
of $S$ lying over $\mathfrak p$ in $R$. Thus we may apply
Lemma \ref{lemma-base-change-universally-flat-local}
to the ring maps
$R_{\mathfrak p} \to S_{\mathfrak q} \to S'_{\mathfrak q}$
and the module $N_{\mathfrak q}$.
\end{proof}

\noindent
The reader may want to compare the following lemma to
Algebra, Lemmas \ref{algebra-lemma-mod-injective} and
\ref{algebra-lemma-mod-injective-general} and the results of
Section \ref{section-variants-mod-injective}.
In each case the conclusion is that the map $u : M \to N$ is
universally injective with flat cokernel.

\begin{lemma}
\label{lemma-universally-injective-local}
Let $(R, \mathfrak m)$ be a local ring. Let $u : M \to N$ be an $R$-module map.
If $M$ is a projective $R$-module, $N$ is a flat $R$-module, and
$\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$ is injective
then $u$ is universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}
the module $M$ is free. If we show the result holds for every finitely
generated direct summand of $M$, then the lemma follows. Hence we may
assume that $M$ is finite free. Write $N = \colim_i N_i$ as
a directed colimit of finite free modules, see
Algebra, Theorem \ref{algebra-theorem-lazard}.
Note that $u : M \to N$ factors through $N_i$ for some $i$ (as $M$ is finite
free). Denote $u_i : M \to N_i$ the corresponding $R$-module map.
As $\overline{u}$ is injective we see that
$\overline{u_i} : M/\mathfrak mM \to N_i/\mathfrak mN_i$ is
injective and remains injective on composing with the maps
$N_i/\mathfrak mN_i \to N_{i'}/\mathfrak mN_{i'}$ for all $i' \geq i$.
As $M$ and $N_{i'}$ are finite free over the local ring $R$ this implies
that $M \to N_{i'}$ is a split injection for all $i' \geq i$. Hence
for any $R$-module $Q$ we see that $M \otimes_R Q \to N_{i'} \otimes_R Q$
is injective for all $i' \geq i$. As $- \otimes_R Q$ commutes with
colimits we conclude that $M \otimes_R Q \to N_{i'} \otimes_R Q$
is injective as desired.
\end{proof}

\begin{lemma}
\label{lemma-invert-universally-injective}
Assumption and notation as in
Lemma \ref{lemma-homothety-spectrum}.
Assume moreover that $N$ is projective as an $R$-module.
Then each $s \in \Sigma$ defines a
universally injective $R$-module map $s : N \to N$, and the
map $N \to \Sigma^{-1}N$ is $R$-universally injective.
\end{lemma}

\begin{proof}
Pick $s \in \Sigma$. By
Lemma \ref{lemma-universally-injective-local}
the map $s : N \to N$ is universally injective.
The map $N \to \Sigma^{-1}N$ is universally injective as the directed
colimit of the maps $s : N \to N$.
\end{proof}






\section{Completion and Mittag-Leffler modules}
\label{section-completion-ML}


\begin{lemma}
\label{lemma-completed-direct-sum-ML}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $A$ be a set.
Assume $R$ is Noetherian and complete with respect to $I$. The completion
$(\bigoplus\nolimits_{\alpha \in A} R)^\wedge$
is flat and Mittag-Leffler.
\end{lemma}

\begin{proof}
By
More on Algebra, Lemma
\ref{more-algebra-lemma-ui-completion-direct-sum-into-product}
the map $(\bigoplus\nolimits_{\alpha \in A} R)^\wedge
\to \prod_{\alpha \in A} R$ is universally injective.
Thus, by
Algebra, Lemmas \ref{algebra-lemma-ui-flat-domain} and
\ref{algebra-lemma-pure-submodule-ML}
it suffices to show that $\prod_{\alpha \in A} R$ is flat and Mittag-Leffler.
By
Algebra, Proposition \ref{algebra-proposition-characterize-coherent}
(and
Algebra, Lemma \ref{algebra-lemma-Noetherian-coherent})
we see that $\prod_{\alpha \in A} R$ is flat.
Thus we conclude because a product of copies of $R$ is Mittag-Leffler, see
Algebra, Lemma \ref{algebra-lemma-product-over-Noetherian-ring}.
\end{proof}

\begin{lemma}
\label{lemma-lift-ML}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian and $I$-adically complete,
\item $M$ is flat over $R$, and
\item $M/IM$ is a projective $R/I$-module.
\end{enumerate}
Then the $I$-adic completion $M^\wedge$ is a flat Mittag-Leffler
$R$-module.
\end{lemma}

\begin{proof}
Choose a surjection $F \to M$ where $F$ is a free $R$-module. By
Algebra, Lemma \ref{algebra-lemma-split-completed-sequence}
the module $M^\wedge$ is a direct summand of the module $F^\wedge$.
Hence it suffices to prove the lemma for $F$.
In this case the lemma follows from
Lemma \ref{lemma-completed-direct-sum-ML}.
\end{proof}

\noindent
In
Lemmas \ref{lemma-universally-injective-to-completion} and
\ref{lemma-universally-injective-to-completion-flat}
the assumption that $S$ be Noetherian holds if $R \to S$ is of finite type, see
Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}.

\begin{lemma}
\label{lemma-universally-injective-to-completion}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $N$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $N$ is a finite $S$-module, and
\item for any finite $R$-module $Q$, any
$\mathfrak q \in \text{Ass}_S(Q \otimes_R N)$
satisfies $IS + \mathfrak q \not = S$.
\end{enumerate}
Then the map $N \to N^\wedge$ of $N$ into the $I$-adic completion of $N$
is universally injective as a map of $R$-modules.
\end{lemma}

\begin{proof}
We have to show that for any finite $R$-module $Q$ the map
$Q \otimes_R N \to Q \otimes_R N^\wedge$ is injective, see
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
As there is a canonical map $Q \otimes_R N^\wedge \to (Q \otimes_R N)^\wedge$
it suffices to prove that the canonical map
$Q \otimes_R N \to (Q \otimes_R N)^\wedge$ is injective.
Hence we may replace $N$ by $Q \otimes_R N$ and it suffices to prove the
injectivity for the map $N \to N^\wedge$.

\medskip\noindent
Let $K = \Ker(N \to N^\wedge)$. It suffices to show that
$K_{\mathfrak q} = 0$ for $\mathfrak q \in \text{Ass}(N)$ as $N$ is a
submodule of $\prod_{\mathfrak q \in \text{Ass}(N)} N_{\mathfrak q}$, see
Algebra, Lemma \ref{algebra-lemma-zero-at-ass-zero}.
Pick $\mathfrak q \in \text{Ass}(N)$. By the last assumption we see that
there exists a prime $\mathfrak q' \supset IS + \mathfrak q$.
Since $K_{\mathfrak q}$ is a localization of $K_{\mathfrak q'}$
it suffices to prove the vanishing of $K_{\mathfrak q'}$.
Note that $K = \bigcap I^nN$, hence
$K_{\mathfrak q'} \subset \bigcap I^nN_{\mathfrak q'}$.
Hence $K_{\mathfrak q'} = 0$ by
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-to-completion-flat}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $N$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $N$ is a finite $S$-module,
\item $N$ is flat over $R$, and
\item for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p = R \cap \mathfrak q$
we have $IS + \mathfrak q \not = S$.
\end{enumerate}
Then the map $N \to N^\wedge$ of $N$ into the $I$-adic completion of $N$
is universally injective as a map of $R$-modules.
\end{lemma}

\begin{proof}
This follows from
Lemma \ref{lemma-universally-injective-to-completion}
because
Algebra, Lemma
\ref{algebra-lemma-bourbaki-fibres} and
Remark \ref{algebra-remark-bourbaki}
guarantee that the set of associated primes of tensor products
$N \otimes_R Q$ are contained in the set of associated primes of
the modules $N \otimes_R \kappa(\mathfrak p)$.
\end{proof}




\section{Projective modules}
\label{section-projective}

\noindent
The following lemma can be used to prove projectivity by
Noetherian induction on the base, see
Lemma \ref{lemma-fibres-irreducible-flat-projective}.

\begin{lemma}
\label{lemma-flat-pure-over-complete-projective}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $N$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian and $I$-adically complete,
\item $R \to S$ is of finite type,
\item $N$ is a finite $S$-module,
\item $N$ is flat over $R$,
\item $N/IN$ is projective as a $R/I$-module, and
\item for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p = R \cap \mathfrak q$
we have $IS + \mathfrak q \not = S$.
\end{enumerate}
Then $N$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-universally-injective-to-completion-flat}
the map $N \to N^\wedge$ is universally injective.
By
Lemma \ref{lemma-lift-ML}
the module $N^\wedge$ is Mittag-Leffler.
By
Algebra, Lemma \ref{algebra-lemma-pure-submodule-ML}
we conclude that $N$ is Mittag-Leffler.
Hence $N$ is countably generated, flat and Mittag-Leffler as an $R$-module,
whence projective by
Algebra, Lemma \ref{algebra-lemma-countgen-projective}.
\end{proof}

\begin{lemma}
\label{lemma-fibres-irreducible-flat-projective}
Let $R$ be a ring.
Let $R \to S$ be a ring map.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type and flat, and
\item every fibre ring $S \otimes_R \kappa(\mathfrak p)$ is
geometrically integral over $\kappa(\mathfrak p)$.
\end{enumerate}
Then $S$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
Consider the set
$$
\{I \subset R \mid S/IS\text{ not projective as }R/I\text{-module}\}
$$
We have to show this set is empty. To get a contradiction assume it is
nonempty. Then it contains a maximal element $I$.
Let $J = \sqrt{I}$ be its radical. If $I \not = J$, then
$S/JS$ is projective as a $R/J$-module, and $S/IS$ is flat over $R/I$
and $J/I$ is a nilpotent ideal in $R/I$. Applying
Algebra, Lemma \ref{algebra-lemma-lift-projective}
we see that $S/IS$ is a projective $R/I$-module, which is a contradiction.
Hence we may assume that $I$ is a radical ideal. In other words we
are reduced to proving the lemma in case $R$ is a reduced ring and
$S/IS$ is a projective $R/I$-module for every nonzero ideal $I$
of $R$.

\medskip\noindent
Assume $R$ is a reduced ring and $S/IS$ is a projective $R/I$-module
for every nonzero ideal $I$ of $R$. By generic flatness,
Algebra, Lemma \ref{algebra-lemma-generic-flatness-Noetherian}
(applied to a localization $R_g$ which is a domain) or the more general
Algebra, Lemma \ref{algebra-lemma-generic-flatness-reduced}
there exists a nonzero $f \in R$ such that $S_f$ is free as an
$R_f$-module. Denote $R^\wedge = \lim R/(f^n)$ the $(f)$-adic completion
of $R$. Note that the ring map
$$
R \longrightarrow R_f \times R^\wedge
$$
is a faithfully flat ring map, see
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
Hence by faithfully flat descent of projectivity, see
Algebra, Theorem \ref{algebra-theorem-ffdescent-projectivity}
it suffices to prove that $S \otimes_R R^\wedge$ is a projective
$R^\wedge$-module. To see this we will use the criterion of
Lemma \ref{lemma-flat-pure-over-complete-projective}.
First of all, note that $S/fS = (S \otimes_R R^\wedge)/f(S \otimes_R R^\wedge)$
is a projective $R/(f)$-module and that $S \otimes_R R^\wedge$ is flat
and of finite type over $R^\wedge$ as a base change of such.
Next, suppose that $\mathfrak p^\wedge$ is a prime ideal
of $R^\wedge$. Let $\mathfrak p \subset R$ be the corresponding prime
of $R$. As $R \to S$ has geometrically integral fibre rings, the
same is true for the fibre rings of any base change. Hence
$\mathfrak q^\wedge = \mathfrak p^\wedge(S \otimes_R R^\wedge)$,
is a prime ideals lying over $\mathfrak p^\wedge$
and it is the unique associated prime of
$S \otimes_R \kappa(\mathfrak p^\wedge)$. Thus we win if
$f(S \otimes_R R^\wedge) + \mathfrak q^\wedge \not = S \otimes_R R^\wedge$.
This is true because $\mathfrak p^\wedge + fR^\wedge \not = R^\wedge$
as $f$ lies in the radical of the $f$-adically complete ring $R^\wedge$
and because $R^\wedge \to S \otimes_R R^\wedge$ is surjective on spectra
as its fibres are nonempty (irreducible spaces are nonempty).
\end{proof}

\begin{lemma}
\label{lemma-fibres-irreducible-flat-projective-nonnoetherian}
Let $R$ be a ring. Let $R \to S$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is of finite presentation and flat, and
\item every fibre ring $S \otimes_R \kappa(\mathfrak p)$ is
geometrically integral over $\kappa(\mathfrak p)$.
\end{enumerate}
Then $S$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
We can find a cocartesian diagram of rings
$$
\xymatrix{
S_0 \ar[r] & S \\
R_0 \ar[u] \ar[r] & R \ar[u]
}
$$
such that $R_0$ is of finite type over $\mathbf{Z}$, the map
$R_0 \to S_0$ is of finite type and flat with geometrically integral
fibres, see
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-Noetherian-approximation-flat},
\ref{more-morphisms-lemma-Noetherian-approximation-geometrically-reduced},
\ref{more-morphisms-lemma-Noetherian-approximation-geometrically-irreducible},
and \ref{more-morphisms-lemma-Noetherian-approximation-combine}.
By
Lemma \ref{lemma-fibres-irreducible-flat-projective}
we see that $S_0$ is a projective $R_0$-module. Hence $S = S_0 \otimes_{R_0} R$
is a projective $R$-module, see
Algebra, Lemma \ref{algebra-lemma-ascend-properties-modules}.
\end{proof}

\begin{remark}
\label{remark-how-in-RG}
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}
is a key step in the development of results in this chapter. The analogue
of this lemma in \cite{GruRay} is \cite[I Proposition 3.3.1]{GruRay}:
If $R \to S$ is smooth with geometrically integral fibres, then $S$
is projective as an $R$-module. This is a special case of
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian},
but as we will later improve on this lemma anyway, we do not gain much
from having a stronger result at this point.
We briefly sketch the proof of this as it is given in \cite{GruRay}.
\begin{enumerate}
\item First reduce to the case where $R$ is Noetherian as above.
\item Since projectivity descends through faithfully flat ring maps, see
Algebra, Theorem \ref{algebra-theorem-ffdescent-projectivity}
we may work locally in the fppf topology on $R$, hence we may assume
that $R \to S$ has a section $\sigma : S \to R$. (Just by the usual trick of
base changing to $S$.) Set $I = \Ker(S \to R)$.
\item Localizing a bit more on $R$ we may assume that $I/I^2$ is a free
$R$-module and that the completion $S^\wedge$ of $S$ with respect to $I$
is isomorphic to $R[[t_1, \ldots, t_n]]$, see
Morphisms, Lemma \ref{morphisms-lemma-section-smooth-morphism}.
Here we are using that $R \to S$ is smooth.
\item To prove that $S$ is projective as an $R$-module, it suffices to
prove that $S$ is flat, countably generated and Mittag-Leffler as an
$R$-module, see
Algebra, Lemma \ref{algebra-lemma-countgen-projective}.
The first two properties are evident. Thus it suffices to prove that $S$
is Mittag-Leffler as an $R$-module. By
Algebra, Lemma \ref{algebra-lemma-power-series-ML}
the module $R[[t_1, \ldots, t_n]]$ is Mittag-Leffler over $R$. Hence
Algebra, Lemma \ref{algebra-lemma-pure-submodule-ML}
shows that it suffices to show that the
$S \to S^\wedge$ is universally injective as a map of $R$-modules.
\item Apply
Lemma \ref{lemma-base-change-universally-flat}
to see that $S \to S^\wedge$ is $R$-universally injective.
Namely, as $R \to S$ has geometrically integral fibres, any associated
point of any fibre ring is just the generic point of the fibre ring which
is in the image of $\Spec(S^\wedge) \to \Spec(S)$.
\end{enumerate}
There is an analogy between the proof as sketched just now, and the
development of the arguments leading to the proof of
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
In both a completion plays an essential role, and both times the
assumption of having geometrically integral fibres assures one that the
map from $S$ to the completion of $S$ is $R$-universally injective.
\end{remark}













\section{Flat finite type modules, Part I}
\label{section-finite-type-flat-I}

\noindent
In some cases given a ring map $R \to S$ of finite presentation and
a finite $S$-module $N$ the flatness of $N$ over $R$ implies that $N$
is of finite presentation. In this section we prove this is true
``pointwise''. We remark that the first proof of
Proposition \ref{proposition-finite-type-flat-at-point}
uses the geometric results of
Section \ref{section-local-structure-module}
but not the existence of a complete d\'evissage.

\begin{lemma}
\label{lemma-induction-step}
Let $(R, \mathfrak m)$ be a local ring. Let $R \to S$ be a finitely presented
flat ring map with geometrically integral fibres. Write
$\mathfrak p = \mathfrak mS$. Let $\mathfrak q \subset S$ be a prime ideal
lying over $\mathfrak m$. Let $N$ be a finite $S$-module.
There exist $r \geq 0$ and an $S$-module map
$$
\alpha : S^{\oplus r} \longrightarrow N
$$
such that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_S \kappa(\mathfrak p)$
is an isomorphism. For any such $\alpha$ the following are equivalent:
\begin{enumerate}
\item $N_{\mathfrak q}$ is $R$-flat,
\item $\alpha$ is $R$-universally injective and
$\Coker(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha$ is injective and
$\Coker(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha_{\mathfrak p}$ is an isomorphism and
$\Coker(\alpha)_{\mathfrak q}$ is $R$-flat, and
\item $\alpha_{\mathfrak q}$ is injective and
$\Coker(\alpha)_{\mathfrak q}$ is $R$-flat.
\end{enumerate}
\end{lemma}

\begin{proof}
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_S \kappa(\mathfrak p)$ and pick
$x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_S \kappa(\mathfrak p)$. Define
$\alpha(s_1, \ldots, s_r) = \sum s_i x_i$. This proves the existence.

\medskip\noindent
Fix an $\alpha$. The most interesting implication is
(1) $\Rightarrow$ (2) which we prove first. Assume (1).
Because $S/\mathfrak mS$ is a domain with fraction field $\kappa(\mathfrak p)$
we see that
$(S/\mathfrak mS)^{\oplus r} \to
N_{\mathfrak p}/\mathfrak mN_{\mathfrak p} = N \otimes_S \kappa(\mathfrak p)$
is injective. Hence by
Lemmas \ref{lemma-universally-injective-local} and
\ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
the map $S^{\oplus r} \to N_{\mathfrak p}$ is $R$-universally injective.
It follows that $S^{\oplus r} \to N$ is $R$-universally injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-permanence}.
Then also the localization $\alpha_{\mathfrak q}$ is $R$-universally
injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-localize}.
We conclude that $\Coker(\alpha)_{\mathfrak q}$ is $R$-flat by
Algebra, Lemma \ref{algebra-lemma-ui-flat-domain}.

\medskip\noindent
The implication (2) $\Rightarrow$ (3) is immediate. If (3) holds, then
$\alpha_{\mathfrak p}$ is injective as a localization of an injective
module map. By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
$\alpha_{\mathfrak p}$ is surjective too. Hence (3) $\Rightarrow$ (4).
If (4) holds, then $\alpha_{\mathfrak p}$ is an isomorphism, so
$\alpha$ is injective as $S_{\mathfrak q} \to S_{\mathfrak p}$ is injective.
Namely, elements of $S \setminus \mathfrak p$ are nonzerodivisors on $S$
by a combination of
Lemmas \ref{lemma-invert-universally-injective} and
\ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
Hence (4) $\Rightarrow$ (5). Finally, if (5) holds, then
$N_{\mathfrak q}$ is $R$-flat as an extension of flat modules, see
Algebra, Lemma \ref{algebra-lemma-flat-ses}.
Hence (5) $\Rightarrow$ (1) and the proof is finished.
\end{proof}

\begin{lemma}
\label{lemma-complete-devissage-flat-finite-type-module}
Let $(R, \mathfrak m)$ be a local ring.
Let $R \to S$ be a ring map of finite presentation.
Let $N$ be a finite $S$-module.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak m$.
Assume that $N_{\mathfrak q}$ is flat over $R$, and
assume there exists a complete d\'evissage of $N/S/R$ at $\mathfrak q$.
Then $N$ is a finitely presented $S$-module, free as an $R$-module,
and there exists an isomorphism
$$
N \cong B_1^{\oplus r_1} \oplus \ldots \oplus B_n^{\oplus r_n}
$$
as $R$-modules where each $B_i$ is a smooth $R$-algebra with geometrically
irreducible fibres.
\end{lemma}

\begin{proof}
Let $(A_i, B_i, M_i, \alpha_i, \mathfrak q_i)_{i = 1, \ldots, n}$
be the given complete d\'evissage. We prove the lemma by induction on $n$.
Note that $N$ is finitely presented as an $S$-module if and only if
$M_1$ is finitely presented as an $B_1$-module, see
Remark \ref{remark-finite-presentation}.
Note that $N_{\mathfrak q} \cong (M_1)_{\mathfrak q_1}$ as $R$-modules
because (a) $N_{\mathfrak q} \cong (M_1)_{\mathfrak q'_1}$ where
$\mathfrak q'_1$ is the unique prime in $A_1$ lying over $\mathfrak q_1$
and (b) $(A_1)_{\mathfrak q'_1} = (A_1)_{\mathfrak q_1}$ by
Algebra, Lemma \ref{algebra-lemma-unique-prime-over-localize-below},
so (c) $(M_1)_{\mathfrak q'_1} \cong (M_1)_{\mathfrak q_1}$.
Hence $(M_1)_{\mathfrak q_1}$ is a flat $R$-module. Thus we may replace
$(S, N)$ by $(B_1, M_1)$ in order to prove the lemma. By
Lemma \ref{lemma-induction-step}
the map $\alpha_1 : B_1^{\oplus r_1} \to M_1$ is $R$-universally injective
and $\Coker(\alpha_1)_{\mathfrak q}$ is $R$-flat.
Note that $(A_i, B_i, M_i, \alpha_i, \mathfrak q_i)_{i = 2, \ldots, n}$
is a complete d\'evissage of $\Coker(\alpha_1)/B_1/R$ at
$\mathfrak q_1$. Hence the induction hypothesis
implies that $\Coker(\alpha_1)$ is finitely presented as a
$B_1$-module, free as an $R$-module, and has a decomposition as in the lemma.
This implies that $M_1$ is finitely presented as a $B_1$-module, see
Algebra, Lemma \ref{algebra-lemma-extension}.
It further implies that
$M_1 \cong B_1^{\oplus r_1} \oplus \Coker(\alpha_1)$
as $R$-modules, hence a decomposition as in the lemma.
Finally, $B_1$ is projective as an $R$-module by
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}
hence free as an $R$-module by
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}.
This finishes the proof.
\end{proof}

\begin{proposition}
\label{proposition-finite-type-flat-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $x \in X$ with image $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat at $x$ over $S$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and an open subscheme
$$
V \subset X \times_S \Spec(\mathcal{O}_{S', s'})
$$
which contains the unique point of
$X \times_S \Spec(\mathcal{O}_{S', s'})$ mapping to $x$
such that the pullback of $\mathcal{F}$ to $V$ is an $\mathcal{O}_V$-module
of finite presentation and flat over $\mathcal{O}_{S', s'}$.
\end{proposition}

\begin{proof}[First proof]
This proof is longer but does not use the existence of a complete d\'evissage.
The problem is local around $x$ and $s$, hence we may assume that $X$
and $S$ are affine. During the proof we will finitely many times replace
$S$ by an elementary \'etale neighbourhood of $(S, s)$. The goal is then to find
(after such a replacement) an open
$V \subset X \times_S \Spec(\mathcal{O}_{S, s})$ containing $x$
such that $\mathcal{F}|_V$ is flat over $S$ and finitely presented.
Of course we may also replace $S$ by $\Spec(\mathcal{O}_{S, s})$
at any point of the proof, i.e., we may assume $S$ is a local scheme.
We will prove the lemma by induction on the integer
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.

\medskip\noindent
We can choose
\begin{enumerate}
\item elementary \'etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X \ar[dd]_f & X' \ar[dd] \ar[l]^g & Z' \ar[l]^i \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S' \ar[l]_e & S' \ar@{=}[l]
}
$$
\item a point $z' \in Z'$ with $i(z') = x'$, $y' = \pi(z')$, $h(y') = s'$,
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$,
\end{enumerate}
as in
Lemma \ref{lemma-elementary-devissage}.
We are going to replace $S$ by $\Spec(\mathcal{O}_{S', s'})$, see
remarks in first paragraph of the proof. Consider the diagram
$$
\xymatrix{
X_{\mathcal{O}_{S', s'}} \ar[ddr]_f &
X'_{\mathcal{O}_{S', s'}} \ar[dd] \ar[l]^g &
Z'_{\mathcal{O}_{S', s'}} \ar[l]^i \ar[d]^\pi \\
& & Y'_{\mathcal{O}_{S', s'}} \ar[dl]^h \\
& \Spec(\mathcal{O}_{S', s'})
}
$$
Here we have base changed the schemes $X', Z', Y'$ over $S'$ via
$\Spec(\mathcal{O}_{S', s'}) \to S'$ and the scheme $X$ over $S$ via
$\Spec(\mathcal{O}_{S', s'}) \to S$. It is still the case that
$g$ is \'etale, see
Lemma \ref{lemma-etale-at-point}.
After replacing $X$ by $X_{\mathcal{O}_{S', s'}}$,
$X'$ by $X'_{\mathcal{O}_{S', s'}}$,
$Z'$ by $Z'_{\mathcal{O}_{S', s'}}$, and
$Y'$ by $Y'_{\mathcal{O}_{S', s'}}$
we may assume we have a diagram as
Lemma \ref{lemma-elementary-devissage}
where in addition $S = S'$ is a local scheme with closed point $s$. By
Lemmas \ref{lemma-devissage-finite-presentation} and
\ref{lemma-devissage-flat}
the result for $Y' \to S$, the sheaf $\pi_*\mathcal{G}$, and the
point $y'$ implies the result for $X \to S$, $\mathcal{F}$ and $x$.
Hence we may assume that $S$ is local and $X \to S$ is a smooth morphism
of affines with geometrically irreducible fibres of dimension $n$.

\medskip\noindent
The base case of the induction: $n = 0$.
As $X \to S$ is smooth with geometrically
irreducible fibres of dimension $0$ we see that $X \to S$ is an open
immersion, see
Descent, Lemma \ref{descent-lemma-universally-injective-etale-open-immersion}.
As $S$ is local and the closed point is in the image of $X \to S$
we conclude that $X = S$. Thus we see that $\mathcal{F}$ corresponds
to a finite flat $\mathcal{O}_{S, s}$ module. In this case the result
follows from
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
which tells us that $\mathcal{F}$ is in fact finite free.

\medskip\noindent
The induction step. Assume the result holds whenever the dimension
of the support in the closed fibre is $< n$. Write $S = \Spec(A)$,
$X = \Spec(B)$ and $\mathcal{F} = \widetilde{N}$ for some $B$-module
$N$. Note that $A$ is a local ring; denote its maximal ideal $\mathfrak m$.
Then $\mathfrak p = \mathfrak mB$ is the unique minimal prime lying over
$\mathfrak m$ as $X \to S$ has geometrically irreducible fibres. Finally,
let $\mathfrak q \subset B$ be the prime corresponding to $x$. By
Lemma \ref{lemma-induction-step}
we can choose a map
$$
\alpha : B^{\oplus r} \to N
$$
such that $\kappa(\mathfrak p)^{\oplus r} \to N \otimes_B \kappa(\mathfrak p)$
is an isomorphism. Moreover, as $N_{\mathfrak q}$ is $A$-flat the lemma
also shows that $\alpha$ is injective and that
$\Coker(\alpha)_{\mathfrak q}$ is $A$-flat.
Set $Q = \Coker(\alpha)$. Note that the support of $Q/\mathfrak mQ$
does not contain $\mathfrak p$. Hence it is certainly the case that
$\dim_{\mathfrak q}(\text{Supp}(Q/\mathfrak mQ)) < n$.
Combining everything we know about $Q$ we see
that the induction hypothesis applies to $Q$. It follows that there exists
an elementary \'etale morphism $(S', s) \to (S, s)$ such that the conclusion
holds for $Q \otimes_A A'$ over $B \otimes_A A'$ where
$A' = \mathcal{O}_{S', s'}$. After replacing $A$ by $A'$ we have an
exact sequence
$$
0 \to B^{\oplus r} \to N \to Q \to 0
$$
(here we use that $\alpha$ is injective as mentioned above)
of finite $B$-modules and we also get an element
$g \in B$, $g \not \in \mathfrak q$ such that
$Q_g$ is finitely presented over $B_g$ and flat over $A$. Since localization
is exact we see that
$$
0 \to B_g^{\oplus r} \to N_g \to Q_g \to 0
$$
is still exact. As $B_g$ and $Q_g$ are flat over $A$ we conclude that
$N_g$ is flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-flat-ses},
and as $B_g$ and $Q_g$ are finitely presented over $B_g$ the same holds
for $N_g$, see
Algebra, Lemma \ref{algebra-lemma-extension}.
\end{proof}

\begin{proof}[Second proof]
We apply
Proposition \ref{proposition-existence-complete-at-x}
to find a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $g^*\mathcal{F}/X'/S'$ has a complete
d\'evissage at $x$.
(In particular $S'$ and $X'$ are affine.) By
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}
we see that $g^*\mathcal{F}$ is flat at $x'$ over $S$ and by
Lemma \ref{lemma-etale-flat-up-down}
we see that it is flat at $x'$ over $S'$. Via
Remark \ref{remark-same-notion}
we deduce that
$$
\Gamma(X', g^*\mathcal{F})/
\Gamma(X', \mathcal{O}_{X'})/
\Gamma(S', \mathcal{O}_{S'})
$$
has a complete d\'evissage at the prime of $\Gamma(X', \mathcal{O}_{X'})$
corresponding to $x'$. We may base change this complete
d\'evissage to the local ring $\mathcal{O}_{S', s'}$
of $\Gamma(S', \mathcal{O}_{S'})$ at the prime corresponding to
$s'$. Thus
Lemma \ref{lemma-complete-devissage-flat-finite-type-module}
implies that
$$
\Gamma(X', \mathcal{F}')
\otimes_{\Gamma(S', \mathcal{O}_{S'})}
\mathcal{O}_{S', s'}
$$
is flat over $\mathcal{O}_{S', s'}$ and of finite presentation over
$\Gamma(X', \mathcal{O}_{X'})
\otimes_{\Gamma(S', \mathcal{O}_{S'})} \mathcal{O}_{S', s'}$.
In other words, the restriction of $\mathcal{F}$ to
$X' \times_{S'} \Spec(\mathcal{O}_{S', s'})$
is of finite presentation and flat over $\mathcal{O}_{S', s'}$.
Since the morphism
$X' \times_{S'} \Spec(\mathcal{O}_{S', s'})
\to X \times_S \Spec(\mathcal{O}_{S', s'})$
is \'etale
(Lemma \ref{lemma-etale-at-point})
its image $V \subset X \times_S \Spec(\mathcal{O}_{S', s'})$
is an open subscheme, and by \'etale descent the restriction
of $\mathcal{F}$ to $V$ is of finite presentation and flat over
$\mathcal{O}_{S', s'}$. (Results used:
Morphisms, Lemma \ref{morphisms-lemma-etale-open},
Descent, Lemma \ref{descent-lemma-finite-presentation-descends}, and
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.)
\end{proof}

\begin{lemma}
\label{lemma-open-in-fibre-where-flat}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $s \in S$. Then the set
$$
\{x \in X_s \mid \mathcal{F} \text{ flat over }S\text{ at }x\}
$$
is open in the fibre $X_s$.
\end{lemma}

\begin{proof}
Suppose $x \in U$. Choose an elementary \'etale neighbourhood
$(S', s') \to (S, s)$ and open
$V \subset X \times_S \Spec(\mathcal{O}_{S', s'})$ as in
Proposition \ref{proposition-finite-type-flat-at-point}.
Note that $X_{s'} = X_s$ as $\kappa(s) = \kappa(s')$.
If $x' \in V \cap X_{s'}$, then the pullback of $\mathcal{F}$ to
$X \times_S S'$ is flat over $S'$ at $x'$. Hence $\mathcal{F}$ is
flat at $x'$ over $S$, see
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.
In other words $X_s \cap V \subset U$ is an open neighbourhood
of $x$ in $U$.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $x \in X$ with image $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat at $x$ over $S$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and an open subscheme
$$
V \subset X \times_S \Spec(\mathcal{O}_{S', s'})
$$
which contains the unique point of
$X \times_S \Spec(\mathcal{O}_{S', s'})$ mapping to $x$
such that the pullback of $\mathcal{F}$ to $V$ is flat over
$\mathcal{O}_{S', s'}$.
\end{lemma}

\begin{proof}
(The only difference between this and
Proposition \ref{proposition-finite-type-flat-at-point}
is that we do not assume $f$ is of finite presentation.)
The question is local on $X$ and $S$, hence we may assume $X$ and $S$
are affine. Write $X = \Spec(B)$, $S = \Spec(A)$ and write
$B = A[x_1, \ldots, x_n]/I$. In other words we obtain a closed immersion
$i : X \to \mathbf{A}^n_S$. Denote $t = i(x) \in \mathbf{A}^n_S$.
We may apply
Proposition \ref{proposition-finite-type-flat-at-point}
to $\mathbf{A}^n_S \to S$, the sheaf $i_*\mathcal{F}$
and the point $t$. We obtain an elementary
\'etale neighbourhood $(S', s') \to (S, s)$ and an open subscheme
$$
W \subset \mathbf{A}^n_{\mathcal{O}_{S', s'}}
$$
such that the pullback of $i_*\mathcal{F}$ to $W$ is flat over
$\mathcal{O}_{S', s'}$. This means that
$V := W \cap \big(X \times_S \Spec(\mathcal{O}_{S', s'})\big)$
is the desired open subscheme.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-along-fibre}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is of finite presentation,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat over $S$ at every point of the fibre $X_s$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and an open subscheme
$$
V \subset X \times_S \Spec(\mathcal{O}_{S', s'})
$$
which contains the fibre $X_s = X \times_S s'$ such that the pullback
of $\mathcal{F}$ to $V$ is an $\mathcal{O}_V$-module
of finite presentation and flat over $\mathcal{O}_{S', s'}$.
\end{lemma}

\begin{proof}
For every point $x \in X_s$ we can use
Proposition \ref{proposition-finite-type-flat-at-point}
to find an elementary \'etale neighbourhood $(S_x, s_x) \to (S, s)$
and an open $V_x \subset X \times_S \Spec(\mathcal{O}_{S_x, s_x})$
such that $x \in X_s = X \times_S s_x$ is contained in $V_x$ and such that
the pullback of $\mathcal{F}$ to $V_x$ is an
$\mathcal{O}_{V_x}$-module of finite presentation and flat over
$\mathcal{O}_{S_x, s_x}$. In particular we may view the fibre
$(V_x)_{s_x}$ as an open neighbourhood of $x$ in $X_s$.
Because $X_s$ is quasi-compact we can find a finite number of points
$x_1, \ldots, x_n \in X_s$ such that $X_s$ is the union of
the $(V_{x_i})_{s_{x_i}}$. Choose an elementary \'etale neighbourhood
$(S' , s') \to (S, s)$ which dominates each of the neighbourhoods
$(S_{x_i}, s_{x_i})$, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-elementary-etale-neighbourhoods}.
Set $V = \bigcup V_i$ where $V_i$ is the inverse images of the open
$V_{x_i}$ via the morphism
$$
X \times_S \Spec(\mathcal{O}_{S', s'})
\longrightarrow
X \times_S \Spec(\mathcal{O}_{S_{x_i}, s_{x_i}})
$$
By construction $V$ contains $X_s$ and by construction the pullback
of $\mathcal{F}$ to $V$ is an $\mathcal{O}_V$-module
of finite presentation and flat over $\mathcal{O}_{S', s'}$.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-along-fibre-variant}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is of finite type,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat over $S$ at every point of the fibre $X_s$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and an open subscheme
$$
V \subset X \times_S \Spec(\mathcal{O}_{S', s'})
$$
which contains the fibre $X_s = X \times_S s'$ such that the pullback
of $\mathcal{F}$ to $V$ is flat over $\mathcal{O}_{S', s'}$.
\end{lemma}

\begin{proof}
(The only difference between this and
Lemma \ref{lemma-finite-type-flat-along-fibre}
is that we do not assume $f$ is of finite presentation.)
For every point $x \in X_s$ we can use
Lemma \ref{lemma-finite-type-flat-at-point}
to find an elementary \'etale neighbourhood $(S_x, s_x) \to (S, s)$
and an open $V_x \subset X \times_S \Spec(\mathcal{O}_{S_x, s_x})$
such that $x \in X_s = X \times_S s_x$ is contained in $V_x$ and such that
the pullback of $\mathcal{F}$ to $V_x$ is flat over
$\mathcal{O}_{S_x, s_x}$. In particular we may view the fibre
$(V_x)_{s_x}$ as an open neighbourhood of $x$ in $X_s$.
Because $X_s$ is quasi-compact we can find a finite number of points
$x_1, \ldots, x_n \in X_s$ such that $X_s$ is the union of
the $(V_{x_i})_{s_{x_i}}$. Choose an elementary \'etale neighbourhood
$(S' , s') \to (S, s)$ which dominates each of the neighbourhoods
$(S_{x_i}, s_{x_i})$, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-elementary-etale-neighbourhoods}.
Set $V = \bigcup V_i$ where $V_i$ is the inverse images of the open
$V_{x_i}$ via the morphism
$$
X \times_S \Spec(\mathcal{O}_{S', s'})
\longrightarrow
X \times_S \Spec(\mathcal{O}_{S_{x_i}, s_{x_i}})
$$
By construction $V$ contains $X_s$ and by construction the pullback
of $\mathcal{F}$ to $V$ is flat over $\mathcal{O}_{S', s'}$.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point-X}
Let $S$ be a scheme. Let $X$ be locally of finite type over $S$.
Let $x \in X$ with image $s \in S$.
If $X$ is flat at $x$ over $S$, then there exists an elementary
\'etale neighbourhood $(S', s') \to (S, s)$ and an open subscheme
$$
V \subset X \times_S \Spec(\mathcal{O}_{S', s'})
$$
which contains the unique point of
$X \times_S \Spec(\mathcal{O}_{S', s'})$ mapping to $x$
such that $V \to \Spec(\mathcal{O}_{S', s'})$
is flat and of finite presentation.
\end{lemma}

\begin{proof}
The question is local on $X$ and $S$, hence we may assume $X$ and $S$
are affine. Write $X = \Spec(B)$, $S = \Spec(A)$ and write
$B = A[x_1, \ldots, x_n]/I$. In other words we obtain a closed immersion
$i : X \to \mathbf{A}^n_S$. Denote $t = i(x) \in \mathbf{A}^n_S$.
We may apply
Proposition \ref{proposition-finite-type-flat-at-point}
to $\mathbf{A}^n_S \to S$, the sheaf $\mathcal{F} = i_*\mathcal{O}_X$
and the point $t$. We obtain an elementary
\'etale neighbourhood $(S', s') \to (S, s)$ and an open subscheme
$$
W \subset \mathbf{A}^n_{\mathcal{O}_{S', s'}}
$$
such that the pullback of $i_*\mathcal{O}_X$ is flat and of finite
presentation. This means that
$V := W \cap \big(X \times_S \Spec(\mathcal{O}_{S', s'})\big)$
is the desired open subscheme.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point-local}
Let $f : X \to S$ be a morphism which is locally of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
If $x \in X$ and $\mathcal{F}$ is flat at $x$ over $S$, then
$\mathcal{F}_x$ is an $\mathcal{O}_{X, x}$-module of finite presentation.
\end{lemma}

\begin{proof}
Let $s = f(x)$. By
Proposition \ref{proposition-finite-type-flat-at-point}
there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
such that the pullback of $\mathcal{F}$ to
$X \times_S \Spec(\mathcal{O}_{S', s'})$ is of
finite presentation in a neighbourhood of the point $x' \in X_{s'} = X_s$
corresponding to $x$. The ring map
$$
\mathcal{O}_{X, x} \longrightarrow
\mathcal{O}_{X \times_S \Spec(\mathcal{O}_{S', s'}), x'}
=
\mathcal{O}_{X \times_S S', x'}
$$
is flat and local as a localization of an \'etale ring map. Hence
$\mathcal{F}_x$ is of finite presentation over $\mathcal{O}_{X, x}$
by descent, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}
(and also that a flat local ring map is faithfully flat, see
Algebra, Lemma \ref{algebra-lemma-local-flat-ff}).
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point-local-X}
Let $f : X \to S$ be a morphism which is locally of finite type.
Let $x \in X$ with image $s \in S$. If $f$ is flat at $x$ over $S$, then
$\mathcal{O}_{X, x}$ is essentially of finite presentation over
$\mathcal{O}_{S, s}$.
\end{lemma}

\begin{proof}
We may assume $X$ and $S$ affine. Write $X = \Spec(B)$,
$S = \Spec(A)$ and write $B = A[x_1, \ldots, x_n]/I$.
In other words we obtain a closed immersion $i : X \to \mathbf{A}^n_S$.
Denote $t = i(x) \in \mathbf{A}^n_S$. We may apply
Lemma \ref{lemma-finite-type-flat-at-point-local}
to $\mathbf{A}^n_S \to S$, the sheaf $\mathcal{F} = i_*\mathcal{O}_X$
and the point $t$. We conclude that $\mathcal{O}_{X, x}$ is
of finite presentation over $\mathcal{O}_{\mathbf{A}^n_S, t}$
which implies what we want.
\end{proof}







\section{Extending properties from an open}
\label{section-extending-properties}

\noindent
In this section we collect a number of results of the form: If $f : X \to S$
is a flat morphism of schemes and $f$ satisfies some property over a dense
open of $S$, then $f$ satisfies the same property over all of $S$.

\begin{lemma}
\label{lemma-flat-finite-type-finitely-presented-over-dense-open}
\begin{slogan}
$S$-flat and finite type extensions of finitely presented modules
on a (good) open are also $X$-finitely presented.
\end{slogan}
Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a
quasi-coherent $\mathcal{O}_X$-module. Let $U \subset S$ be open.
Assume
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is of finite type and flat over $S$,
\item $U \subset S$ is retrocompact and scheme theoretically dense,
\item $\mathcal{F}|_{f^{-1}U}$ is of finite presentation.
\end{enumerate}
Then $\mathcal{F}$ is of finite presentation.
\end{lemma}

\begin{proof}
The problem is local on $X$ and $S$, hence we may assume $X$ and $S$ affine.
Write $S = \Spec(A)$ and $X = \Spec(B)$. Let $N$ be a finite $B$-module such
that $\mathcal{F}$ is the quasi-coherent sheaf associated to $N$.
We have $U = D(f_1) \cup \ldots \cup D(f_n)$ for some $f_i \in A$, see
Algebra, Lemma \ref{algebra-lemma-qc-open}.
As $U$ is schematically dense the map
$A \to A_{f_1} \times \ldots \times A_{f_n}$ is injective.
Pick a prime $\mathfrak q \subset B$ lying over $\mathfrak p \subset A$
corresponding to $x \in X$ mapping to $s \in S$.
By Lemma \ref{lemma-finite-type-flat-at-point-local}
the module $N_\mathfrak q$ is of finite presentation over $B_\mathfrak q$.
Choose a surjection $\varphi : B^{\oplus m} \to N$ of $B$-modules.
Choose $k_1, \ldots, k_t \in \Ker(\varphi)$ and
set $N' = B^{\oplus m}/\sum Bk_j$. There is a canonical surjection
$N' \to N$ and $N$ is the filtered colimit of the $B$-modules $N'$
constructed in this manner. Thus we see that we can choose
$k_1, \ldots, k_t$ such that (a) $N'_{f_i} \cong N_{f_i}$, $i = 1, \ldots, n$
and (b) $N'_\mathfrak q \cong N_\mathfrak q$.
This in particular implies that $N'_\mathfrak q$ is flat over $A$.
By openness of flatness, see
Algebra, Theorem \ref{algebra-theorem-openness-flatness}
we conclude that there exists a $g \in B$, $g \not \in \mathfrak q$
such that $N'_g$ is flat over $A$. Consider the commutative diagram
$$
\xymatrix{
N'_g \ar[r] \ar[d] & N_g \ar[d] \\
\prod N'_{gf_i} \ar[r] & \prod N_{gf_i}
}
$$
The bottom arrow is an isomorphism by choice of $k_1, \ldots, k_t$.
The left vertical arrow is an injective map as
$A \to \prod A_{f_i}$ is injective and $N'_g$ is flat over $A$.
Hence the top horizontal arrow is injective, hence an isomorphism.
This proves that $N_g$ is of finite presentation over $B_g$.
We conclude by applying
Algebra, Lemma \ref{algebra-lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-type-finitely-presented-over-dense-open-X}
Let $f : X \to S$ be a morphism of schemes. Let $U \subset S$ be open.
Assume
\begin{enumerate}
\item $f$ is locally of finite type and flat,
\item $U \subset S$ is retrocompact and scheme theoretically dense,
\item $f|_{f^{-1}U} : f^{-1}U \to U$ is locally of finite presentation.
\end{enumerate}
Then $f$ is of locally of finite presentation.
\end{lemma}

\begin{proof}
The question is local on $X$ and $S$, hence we may assume $X$ and
$S$ affine. Choose a closed immersion $i : X \to \mathbf{A}^n_S$
and apply
Lemma \ref{lemma-flat-finite-type-finitely-presented-over-dense-open}
to $i_*\mathcal{O}_X$. Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-dimension-over-dense-open}
Let $f : X \to S$ be a morphism of schemes which is flat and locally
of finite type. Let $U \subset S$ be a dense open such that
$X_U \to U$ has relative dimension $\leq e$, see
Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}.
If also either
\begin{enumerate}
\item $f$ is locally of finite presentation, or
\item $U \subset S$ is retrocompact,
\end{enumerate}
then $f$ has relative dimension $\leq e$.
\end{lemma}

\begin{proof}
Proof in case (1). Let $W \subset X$ be the open subscheme constructed
and studied in More on Morphisms, Lemmas
\ref{more-morphisms-lemma-flat-finite-presentation-CM-open} and
\ref{more-morphisms-lemma-flat-finite-presentation-CM-pieces}.
Note that every generic point of every fibre is contained in $W$,
hence it suffices to prove the result for $W$. Since
$W = \bigcup_{d \geq 0} U_d$, it suffices to prove that $U_d = \emptyset$
for $d > e$. Since $f$ is flat and locally of finite presentation it is open
hence $f(U_d)$ is open (Morphisms, Lemma \ref{morphisms-lemma-fppf-open}).
Thus if $U_d$ is not empty, then $f(U_d) \cap U \not = \emptyset$ as
desired.

\medskip\noindent
Proof in case (2). We may replace $S$ by its reduction. Then $U$ is
scheme theoretically dense. Hence $f$ is locally of finite presentation
by Lemma \ref{lemma-flat-finite-type-finitely-presented-over-dense-open-X}.
In this way we reduce to case (1).
\end{proof}

\begin{lemma}
\label{lemma-proper-flat-finite-over-dense-open}
Let $f : X \to S$ be a morphism of schemes which is flat and proper.
Let $U \subset S$ be a dense open such that $X_U \to U$ is finite.
If also either $f$ is locally of finite presentation or
$U \subset S$ is retrocompact, then $f$ is finite.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-finite-presentation-dimension-over-dense-open}
the fibres of $f$ have dimension zero.
Hence $f$ is quasi-finite
(Morphisms, Lemma \ref{morphisms-lemma-locally-quasi-finite-rel-dimension-0})
whence has finite fibres
(Morphisms, Lemma \ref{morphisms-lemma-quasi-finite}).
Hence $f$ is finite by
More on Morphisms, Lemma \ref{more-morphisms-lemma-characterize-finite}.
\end{proof}

\begin{lemma}
\label{lemma-zariski}
Let $f : X \to S$ be a morphism of schemes and $U \subset S$ an open. If
\begin{enumerate}
\item $f$ is separated, locally of finite type, and flat,
\item $f^{-1}(U) \to U$ is an isomorphism, and
\item $U \subset S$ is retrocompact and scheme theoretically dense,
\end{enumerate}
then $f$ is an open immersion.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-finite-type-finitely-presented-over-dense-open-X}
the morphism $f$ is locally of finite presentation.
The image $f(X) \subset S$ is open
(Morphisms, Lemma \ref{morphisms-lemma-fppf-open})
hence we may replace $S$ by $f(X)$. Thus we have to prove that
$f$ is an isomorphism. We may assume $S$ is affine. We can reduce
to the case that $X$ is quasi-compact because it suffices to show
that any quasi-compact open $X' \subset X$ whose image is $S$
maps isomorphically to $S$. Thus we may assume $f$ is quasi-compact.
All the fibers of $f$ have dimension $0$, see
Lemma \ref{lemma-flat-finite-presentation-dimension-over-dense-open}.
Hence $f$ is quasi-finite, see
Morphisms, Lemma \ref{morphisms-lemma-locally-quasi-finite-rel-dimension-0}.
Let $s \in S$. Choose an elementary \'etale
neighbourhood $g : (T, t) \to (S, s)$ such that $X \times_S T = V \amalg W$
with $V \to T$ finite and $W_t = \emptyset$, see
More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part}.
Denote $\pi : V \amalg W \to T$ the given morphism. Since $\pi$ is
flat and locally of finite presentation, we see that $\pi(V)$ is
open in $T$ (Morphisms, Lemma \ref{morphisms-lemma-fppf-open}).
After shrinking $T$ we may assume that $T = \pi(V)$.
Since $f$ is an isomorphism over $U$ we see that $\pi$ is an
isomorphism over $g^{-1}U$. Since $\pi(V) = T$ this implies
that $\pi^{-1}g^{-1}U$ is contained in $V$. 
By Morphisms, Lemma
\ref{morphisms-lemma-flat-morphism-scheme-theoretically-dense-open}
we see that $\pi^{-1}g^{-1}U \subset V \amalg W$ is scheme theoretically
dense. Hence we deduce that $W = \emptyset$.
Thus $X \times_S T = V$ is finite over $T$. Shrinking $T$ once more
we may assume $T$ is affine. Then $V$ is affine too and we see
that
$$
\Gamma(T, \mathcal{O}_T) = \Gamma(g^{-1}U, \mathcal{O}_T) =
\Gamma(\pi^{-1}g^{-1}U, \mathcal{O}_V) = \Gamma(V, \mathcal{O}_V)
$$
because the inverse image of $U$ is schematically dense in both
$T$ and $V$ (see above). Thus $X \times_S T \to T$ is an isomorphism.
This implies that $f$ is an isomorphism, for example by
Descent, Lemma \ref{descent-lemma-descending-property-isomorphism}.
\end{proof}





\section{Flat finitely presented modules}
\label{section-finitely-presented-flat}

\noindent
In some cases given a ring map $R \to S$ of finite presentation and
a finitely presented $S$-module $N$ the flatness of $N$ over $R$ implies
that $N$ is projective as an $R$-module, at least after replacing $S$
by an \'etale extension. In this section we collect a some results
of this nature.

\begin{lemma}
\label{lemma-induction-step-fp}
Let $R$ be a ring. Let $R \to S$ be a finitely presented
flat ring map with geometrically integral fibres. Let
$\mathfrak q \subset S$ be a prime ideal lying over the prime
$\mathfrak r \subset R$. Set $\mathfrak p = \mathfrak r S$.
Let $N$ be a finitely presented $S$-module.
There exists $r \geq 0$ and an $S$-module map
$$
\alpha : S^{\oplus r} \longrightarrow N
$$
such that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_S \kappa(\mathfrak p)$
is an isomorphism. For any such $\alpha$ the following are equivalent:
\begin{enumerate}
\item $N_{\mathfrak q}$ is $R$-flat,
\item there exists an $f \in R$, $f \not \in \mathfrak r$ such that
$\alpha_f : S_f^{\oplus r} \to N_f$ is $R_f$-universally injective and
a $g \in S$, $g \not \in \mathfrak q$ such that $\Coker(\alpha)_g$
is $R$-flat,
\item $\alpha_{\mathfrak r}$ is $R_{\mathfrak r}$-universally injective and
$\Coker(\alpha)_{\mathfrak q}$ is $R$-flat
\item $\alpha_{\mathfrak r}$ is injective and
$\Coker(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha_{\mathfrak p}$ is an isomorphism and
$\Coker(\alpha)_{\mathfrak q}$ is $R$-flat, and
\item $\alpha_{\mathfrak q}$ is injective and
$\Coker(\alpha)_{\mathfrak q}$ is $R$-flat.
\end{enumerate}
\end{lemma}

\begin{proof}
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_S \kappa(\mathfrak p)$ and pick
$x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_S \kappa(\mathfrak p)$. Define
$\alpha(s_1, \ldots, s_r) = \sum s_i x_i$. This proves the existence.

\medskip\noindent
Fix a choice of $\alpha$.
We may apply
Lemma \ref{lemma-induction-step}
to the map
$\alpha_{\mathfrak r} : S_{\mathfrak r}^{\oplus r} \to N_{\mathfrak r}$.
Hence we see that (1), (3), (4), (5), and (6) are all equivalent.
Since it is also clear that (2) implies (3) we see that all we have to
do is show that (1) implies (2).

\medskip\noindent
Assume (1). By openness of flatness, see
Algebra, Theorem \ref{algebra-theorem-openness-flatness},
the set
$$
U_1 = \{\mathfrak q' \subset S \mid N_{\mathfrak q'}\text{ is flat over }R\}
$$
is open in $\Spec(S)$. It contains $\mathfrak q$ by assumption
and hence $\mathfrak p$. Because $S^{\oplus r}$ and $N$ are finitely presented
$S$-modules the set
$$
U_2 = \{\mathfrak q' \subset S \mid
\alpha_{\mathfrak q'}\text{ is an isomorphism}\}
$$
is open in $\Spec(S)$, see
Algebra, Lemma \ref{algebra-lemma-map-between-finitely-presented}.
It contains $\mathfrak p$ by (5). As $R \to S$
is finitely presented and flat the map
$\Phi : \Spec(S) \to \Spec(R)$ is open, see
Algebra, Proposition \ref{algebra-proposition-fppf-open}.
For any prime $\mathfrak r' \in \Phi(U_1 \cap U_2)$ we see that
there exists a prime $\mathfrak q'$ lying over $\mathfrak r'$ such that
$N_{\mathfrak q'}$ is flat and such that $\alpha_{\mathfrak q'}$ is
an isomorphism, which implies that $\alpha \otimes \kappa(\mathfrak p')$
is an isomorphism where $\mathfrak p' = \mathfrak r' S$. Thus
$\alpha_{\mathfrak r'}$ is $R_{\mathfrak r'}$-universally injective
by the implication (1) $\Rightarrow$ (3).
Hence if we pick $f \in R$, $f \not \in \mathfrak r$ such that
$D(f) \subset \Phi(U_1 \cap U_2)$ then we conclude that
$\alpha_f$ is $R_f$-universally injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-check-stalks}.
The same reasoning also shows that for any
$\mathfrak q' \in U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$
the module $\Coker(\alpha)_{\mathfrak q'}$ is $R$-flat.
Note that $\mathfrak q \in U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$.
Hence we can find a $g \in S$, $g \not \in \mathfrak q$ such
that $D(g) \subset U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-complete-devissage-flat-finitely-presented-module}
Let $R \to S$ be a ring map of finite presentation.
Let $N$ be a finitely presented $S$-module flat over $R$.
Let $\mathfrak r \subset R$ be a prime ideal.
Assume there exists a complete d\'evissage of $N/S/R$ over $\mathfrak r$.
Then there exists an $f \in R$, $f \not \in \mathfrak r$
such that
$$
N_f \cong B_1^{\oplus r_1} \oplus \ldots \oplus B_n^{\oplus r_n}
$$
as $R$-modules where each $B_i$ is a smooth $R_f$-algebra with geometrically
irreducible fibres. Moreover, $N_f$ is projective as an $R_f$-module.
\end{lemma}

\begin{proof}
Let $(A_i, B_i, M_i, \alpha_i)_{i = 1, \ldots, n}$ be the given
complete d\'evissage. We prove the lemma by induction on $n$.
Note that the assertions of the lemma are entirely about the structure
of $N$ as an $R$-module. Hence we may replace $N$ by $M_1$, and we
may think of $M_1$ as a $B_1$-module. See
Remark \ref{remark-finite-presentation}
in order to see why $M_1$ is of finite presentation as a $B_1$-module. By
Lemma \ref{lemma-induction-step-fp}
we may, after replacing $R$ by $R_f$ for some
$f \in R$, $f \not \in \mathfrak r$, assume
the map $\alpha_1 : B_1^{\oplus r_1} \to M_1$ is $R$-universally injective.
Since $M_1$ and $B_1^{\oplus r_1}$ are $R$-flat and finitely presented as
$B_1$-modules we see that $\Coker(\alpha_1)$ is $R$-flat
(Algebra, Lemma \ref{algebra-lemma-ui-flat-domain})
and finitely presented as a $B_1$-module. Note that
$(A_i, B_i, M_i, \alpha_i)_{i = 2, \ldots, n}$ is a complete
d\'evissage of $\Coker(\alpha_1)$. Hence the induction hypothesis
implies that, after replacing
$R$ by $R_f$ for some $f \in R$, $f \not \in \mathfrak r$,
we may assume that $\Coker(\alpha_1)$ has a decomposition
as in the lemma and is projective. In particular
$M_1 = B_1^{\oplus r_1} \oplus \Coker(\alpha_1)$.
This proves the statement regarding the decomposition.
The statement on projectivity follows as $B_1$ is projective as
an $R$-module by
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
\end{proof}

\begin{remark}
\label{remark-complete-devissage-flat-finitely-presented-module}
There is a variant of
Lemma \ref{lemma-complete-devissage-flat-finitely-presented-module}
where we weaken the flatness condition by assuming only that $N$
is flat at some given prime $\mathfrak q$ lying over $\mathfrak r$
but where we strengthen the d\'evissage condition by assuming
the existence of a complete d\'evissage {\it at $\mathfrak q$}. Compare with
Lemma \ref{lemma-complete-devissage-flat-finite-type-module}.
\end{remark}

\noindent
The following is the main result of this section.

\begin{proposition}
\label{proposition-finite-presentation-flat-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $x \in X$ with image $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is of finite presentation, and
\item $\mathcal{F}$ is flat at $x$ over $S$.
\end{enumerate}
Then there exists a commutative diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
whose horizontal arrows are elementary \'etale neighbourhoods
such that $X'$, $S'$ are affine and such that
$\Gamma(X', g^*\mathcal{F})$ is a projective
$\Gamma(S', \mathcal{O}_{S'})$-module.
\end{proposition}

\begin{proof}
By openness of flatness, see
More on Morphisms, Theorem \ref{more-morphisms-theorem-openness-flatness}
we may replace $X$ by an open neighbourhood of $x$ and assume that
$\mathcal{F}$ is flat over $S$. Next, we apply
Proposition \ref{proposition-existence-complete-at-x}
to find a diagram as in the statement of the proposition such
that $g^*\mathcal{F}/X'/S'$ has a complete d\'evissage over $s'$.
(In particular $S'$ and $X'$ are affine.) By
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}
we see that $g^*\mathcal{F}$ is flat over $S$ and by
Lemma \ref{lemma-etale-flat-up-down}
we see that it is flat over $S'$. Via
Remark \ref{remark-same-notion}
we deduce that
$$
\Gamma(X', g^*\mathcal{F})/
\Gamma(X', \mathcal{O}_{X'})/
\Gamma(S', \mathcal{O}_{S'})
$$
has a complete d\'evissage over the prime of $\Gamma(S', \mathcal{O}_{S'})$
corresponding to $s'$. Thus
Lemma \ref{lemma-complete-devissage-flat-finitely-presented-module}
implies that the result of the proposition holds after replacing
$S'$ by a standard open neighbourhood of $s'$.
\end{proof}

\noindent
In the rest of this section we prove a number of variants
on this result. The first is a ``global'' version.

\begin{lemma}
\label{lemma-finite-presentation-flat-along-fibre}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is of finite presentation,
\item $\mathcal{F}$ is of finite presentation, and
\item $\mathcal{F}$ is flat over $S$ at every point of the fibre $X_s$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood
$(S', s') \to (S, s)$ and a commutative diagram of schemes
$$
\xymatrix{
X \ar[d] & X' \ar[l]^g \ar[d] \\
S & S' \ar[l]
}
$$
such that $g$ is \'etale, $X_s \subset g(X')$, the schemes
$X'$, $S'$ are affine, and such that
$\Gamma(X', g^*\mathcal{F})$ is a projective
$\Gamma(S', \mathcal{O}_{S'})$-module.
\end{lemma}

\begin{proof}
For every point $x \in X_s$ we can use
Proposition \ref{proposition-finite-presentation-flat-at-point}
to find a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (Y_x, y_x) \ar[l]^{g_x} \ar[d] \\
(S, s) & (S_x, s_x) \ar[l]
}
$$
whose horizontal arrows are elementary \'etale neighbourhoods
such that $Y_x$, $S_x$ are affine and such that
$\Gamma(Y_x, g_x^*\mathcal{F})$ is a projective
$\Gamma(S_x, \mathcal{O}_{S_x})$-module. In particular
$g_x(Y_x) \cap X_s$ is an open neighbourhood of $x$ in $X_s$.
Because $X_s$ is quasi-compact we can find a finite number of points
$x_1, \ldots, x_n \in X_s$ such that $X_s$ is the union of
the $g_{x_i}(Y_{x_i}) \cap X_s$. Choose an elementary \'etale neighbourhood
$(S' , s') \to (S, s)$ which dominates each of the neighbourhoods
$(S_{x_i}, s_{x_i})$, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-elementary-etale-neighbourhoods}.
We may also assume that $S'$ is affine.
Set $X' = \coprod Y_{x_i} \times_{S_{x_i}} S'$ and endow it with the
obvious morphism $g : X' \to X$.
By construction $g(X')$ contains $X_s$ and
$$
\Gamma(X', g^*\mathcal{F})
=
\bigoplus \Gamma(Y_{x_i}, g_{x_i}^*\mathcal{F})
\otimes_{\Gamma(S_{x_i}, \mathcal{O}_{S_{x_i}})}
\Gamma(S', \mathcal{O}_{S'}).
$$
This is a projective $\Gamma(S', \mathcal{O}_{S'})$-module, see
Algebra, Lemma \ref{algebra-lemma-ascend-properties-modules}.
\end{proof}

\noindent
The following two lemmas are reformulations of the results
above in case $\mathcal{F} = \mathcal{O}_X$.

\begin{lemma}
\label{lemma-finite-presentation-flat-at-point-X}
Let $f : X \to S$ be locally of finite presentation.
Let $x \in X$ with image $s \in S$.
If $f$ is flat at $x$ over $S$, then there exists a commutative
diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
whose horizontal arrows are elementary \'etale neighbourhoods
such that $X'$, $S'$ are affine and such that
$\Gamma(X', \mathcal{O}_{X'})$ is a projective
$\Gamma(S', \mathcal{O}_{S'})$-module.
\end{lemma}

\begin{proof}
This is a special case of
Proposition \ref{proposition-finite-presentation-flat-at-point}.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-flat-along-fibre-X}
Let $f : X \to S$ be of finite presentation.
Let $s \in S$.
If $X$ is flat over $S$ at all points of $X_s$, then
there exists an elementary \'etale neighbourhood
$(S', s') \to (S, s)$ and a commutative diagram of schemes
$$
\xymatrix{
X \ar[d] & X' \ar[l]^g \ar[d] \\
S & S' \ar[l]
}
$$
with $g$ \'etale, $X_s \subset g(X')$, such that $X'$, $S'$
are affine, and such that
$\Gamma(X', \mathcal{O}_{X'})$ is a projective
$\Gamma(S', \mathcal{O}_{S'})$-module.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-finite-presentation-flat-along-fibre}.
\end{proof}

\noindent
The following lemmas explain consequences of
Proposition \ref{proposition-finite-presentation-flat-at-point}
in case we only assume the morphism and the sheaf are of finite type
(and not necessarily of finite presentation).

\begin{lemma}
\label{lemma-finite-type-flat-at-point-free}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $x \in X$ with image $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat at $x$ over $S$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and a commutative diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (\Spec(\mathcal{O}_{S', s'}), s') \ar[l]
}
$$
such that $X' \to X \times_S \Spec(\mathcal{O}_{S', s'})$
is \'etale, $\kappa(x) = \kappa(x')$, the scheme $X'$ is
affine of finite presentation over $\mathcal{O}_{S', s'}$,
the sheaf $g^*\mathcal{F}$ is of finite presentation over $\mathcal{O}_{X'}$,
and such that $\Gamma(X', g^*\mathcal{F})$ is a free
$\mathcal{O}_{S', s'}$-module.
\end{lemma}

\begin{proof}
To prove the lemma we may replace $(S, s)$ by any elementary \'etale
neighbourhood, and we may also replace $S$ by
$\Spec(\mathcal{O}_{S, s})$. Hence by
Proposition \ref{proposition-finite-type-flat-at-point}
we may assume that $\mathcal{F}$ is finitely presented and flat over
$S$ in a neighbourhood of $x$. In this case the result follows from
Proposition \ref{proposition-finite-presentation-flat-at-point}
because
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}
assures us that projective $=$ free over a local ring.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point-free-variant}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $x \in X$ with image $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat at $x$ over $S$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and a commutative diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (\Spec(\mathcal{O}_{S', s'}), s') \ar[l]
}
$$
such that $X' \to X \times_S \Spec(\mathcal{O}_{S', s'})$
is \'etale, $\kappa(x) = \kappa(x')$, the scheme $X'$ is
affine, and such that $\Gamma(X', g^*\mathcal{F})$ is a free
$\mathcal{O}_{S', s'}$-module.
\end{lemma}

\begin{proof}
(The only difference with
Lemma \ref{lemma-finite-type-flat-at-point-free}
is that we do not assume $f$ is of finite presentation.)
The problem is local on $X$ and $S$. Hence we may assume $X$ and
$S$ are affine, say $X = \Spec(B)$ and $S = \Spec(A)$.
Since $B$ is a finite type $A$-algebra we can find a surjection
$A[x_1, \ldots, x_n] \to B$. In other words, we can choose a closed
immersion $i : X \to \mathbf{A}^n_S$. Set $t = i(x)$ and
$\mathcal{G} = i_*\mathcal{F}$. Note that $\mathcal{G}_t \cong \mathcal{F}_x$
are $\mathcal{O}_{S, s}$-modules. Hence $\mathcal{G}$ is flat over $S$ at $t$.
We apply
Lemma \ref{lemma-finite-type-flat-at-point-free}
to the morphism $\mathbf{A}^n_S \to S$, the point $t$, and the
sheaf $\mathcal{G}$. Thus we can find an
elementary \'etale neighbourhood $(S', s') \to (S, s)$
and a commutative diagram of pointed schemes
$$
\xymatrix{
(\mathbf{A}^n_S, t) \ar[d] & (Y, y) \ar[l]^h \ar[d] \\
(S, s) & (\Spec(\mathcal{O}_{S', s'}), s') \ar[l]
}
$$
such that $Y \to \mathbf{A}^n_{\mathcal{O}_{S', s'}}$
is \'etale, $\kappa(t) = \kappa(y)$, the scheme $Y$ is
affine, and such that $\Gamma(Y, h^*\mathcal{G})$ is a projective
$\mathcal{O}_{S', s'}$-module. Then a solution to the original
problem is given by the closed subscheme
$X' = Y \times_{\mathbf{A}^n_S} X$ of $Y$.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-along-fibre-free}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is of finite presentation,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat over $S$ at all points of $X_s$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and a commutative diagram of schemes
$$
\xymatrix{
X \ar[d] & X' \ar[l]^g \ar[d] \\
S & \Spec(\mathcal{O}_{S', s'}) \ar[l]
}
$$
such that $X' \to X \times_S \Spec(\mathcal{O}_{S', s'})$
is \'etale, $X_s = g((X')_{s'})$, the scheme $X'$ is
affine of finite presentation over $\mathcal{O}_{S', s'}$,
the sheaf $g^*\mathcal{F}$ is of finite presentation over $\mathcal{O}_{X'}$,
and such that $\Gamma(X', g^*\mathcal{F})$ is a free
$\mathcal{O}_{S', s'}$-module.
\end{lemma}

\begin{proof}
For every point $x \in X_s$ we can use
Lemma \ref{lemma-finite-type-flat-at-point-free}
to find an elementary \'etale neighbourhood $(S_x , s_x) \to (S, s)$
and a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (Y_x, y_x) \ar[l]^{g_x} \ar[d] \\
(S, s) & (\Spec(\mathcal{O}_{S_x, s_x}), s_x) \ar[l]
}
$$
such that $Y_x \to X \times_S \Spec(\mathcal{O}_{S_x, s_x})$
is \'etale, $\kappa(x) = \kappa(y_x)$, the scheme $Y_x$ is affine
of finite presentation over $\mathcal{O}_{S_x, s_x}$, the sheaf
$g_x^*\mathcal{F}$ is of finite presentation over $\mathcal{O}_{Y_x}$, and
such that $\Gamma(Y_x, g_x^*\mathcal{F})$ is a free
$\mathcal{O}_{S_x, s_x}$-module. In particular
$g_x((Y_x)_{s_x})$ is an open neighbourhood of $x$ in $X_s$.
Because $X_s$ is quasi-compact we can find a finite number of points
$x_1, \ldots, x_n \in X_s$ such that $X_s$ is the union of
the $g_{x_i}((Y_{x_i})_{s_{x_i}})$. Choose an elementary \'etale neighbourhood
$(S' , s') \to (S, s)$ which dominates each of the neighbourhoods
$(S_{x_i}, s_{x_i})$, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-elementary-etale-neighbourhoods}.
Set
$$
X' = \coprod Y_{x_i} \times_{\Spec(\mathcal{O}_{S_{x_i}, s_{x_i}})}
\Spec(\mathcal{O}_{S', s'})
$$
and endow it with the obvious morphism $g : X' \to X$.
By construction $X_s = g(X'_{s'})$ and
$$
\Gamma(X', g^*\mathcal{F})
=
\bigoplus \Gamma(Y_{x_i}, g_{x_i}^*\mathcal{F})
\otimes_{\mathcal{O}_{S_{x_i}, s_{x_i}}}
\mathcal{O}_{S', s'}.
$$
This is a free $\mathcal{O}_{S', s'}$-module as a direct sum
of base changes of free modules. Some minor details omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-along-fibre-free-variant}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is of finite type,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat over $S$ at all points of $X_s$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and a commutative diagram of schemes
$$
\xymatrix{
X \ar[d] & X' \ar[l]^g \ar[d] \\
S & \Spec(\mathcal{O}_{S', s'}) \ar[l]
}
$$
such that $X' \to X \times_S \Spec(\mathcal{O}_{S', s'})$
is \'etale, $X_s = g((X')_{s'})$, the scheme $X'$ is affine,
and such that $\Gamma(X', g^*\mathcal{F})$ is a free
$\mathcal{O}_{S', s'}$-module.
\end{lemma}

\begin{proof}
(The only difference with
Lemma \ref{lemma-finite-type-flat-along-fibre-free}
is that we do not assume $f$ is of finite presentation.)
For every point $x \in X_s$ we can use
Lemma \ref{lemma-finite-type-flat-at-point-free-variant}
to find an elementary \'etale neighbourhood $(S_x , s_x) \to (S, s)$
and a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (Y_x, y_x) \ar[l]^{g_x} \ar[d] \\
(S, s) & (\Spec(\mathcal{O}_{S_x, s_x}), s_x) \ar[l]
}
$$
such that $Y_x \to X \times_S \Spec(\mathcal{O}_{S_x, s_x})$
is \'etale, $\kappa(x) = \kappa(y_x)$, the scheme $Y_x$ is affine, and
such that $\Gamma(Y_x, g_x^*\mathcal{F})$ is a free
$\mathcal{O}_{S_x, s_x}$-module. In particular
$g_x((Y_x)_{s_x})$ is an open neighbourhood of $x$ in $X_s$.
Because $X_s$ is quasi-compact we can find a finite number of points
$x_1, \ldots, x_n \in X_s$ such that $X_s$ is the union of
the $g_{x_i}((Y_{x_i})_{s_{x_i}})$. Choose an elementary \'etale neighbourhood
$(S' , s') \to (S, s)$ which dominates each of the neighbourhoods
$(S_{x_i}, s_{x_i})$, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-elementary-etale-neighbourhoods}.
Set
$$
X' = \coprod Y_{x_i} \times_{\Spec(\mathcal{O}_{S_{x_i}, s_{x_i}})}
\Spec(\mathcal{O}_{S', s'})
$$
and endow it with the obvious morphism $g : X' \to X$.
By construction $X_s = g(X'_{s'})$ and
$$
\Gamma(X', g^*\mathcal{F})
=
\bigoplus \Gamma(Y_{x_i}, g_{x_i}^*\mathcal{F})
\otimes_{\mathcal{O}_{S_{x_i}, s_{x_i}}}
\mathcal{O}_{S', s'}.
$$
This is a free $\mathcal{O}_{S', s'}$-module as a direct sum
of base changes of free modules.
\end{proof}




\section{Flat finite type modules, Part II}
\label{section-finite-type-flat-II}

\noindent
The following lemma will be superseded by the stronger
Lemma \ref{lemma-weak-bourbaki}
below.

\begin{lemma}
\label{lemma-weak-bourbaki-pre}
Let $(R, \mathfrak m)$ be a local ring.
Let $R \to S$ be of finite presentation.
Let $N$ be a finitely presented $S$-module which is free as an $R$-module.
Let $M$ be an $R$-module.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak m$.
Then
\begin{enumerate}
\item if $\mathfrak q \in \text{WeakAss}_S(M \otimes_R N)$
then $\mathfrak m \in \text{WeakAss}_R(M)$ and
$\overline{\mathfrak q} \in \text{Ass}_{\overline{S}}(\overline{N})$,
\item if $\mathfrak m \in \text{WeakAss}_R(M)$ and
$\overline{\mathfrak q} \in \text{Ass}_{\overline{S}}(\overline{N})$
is a maximal element then $\mathfrak q \in \text{WeakAss}_S(M \otimes_R N)$.
\end{enumerate}
Here $\overline{S} = S/\mathfrak m S$,
$\overline{\mathfrak q} = \mathfrak q \overline{S}$, and
$\overline{N} = N/\mathfrak m N$.
\end{lemma}

\begin{proof}
Suppose that
$\overline{\mathfrak q} \not \in \text{Ass}_{\overline{S}}(\overline{N})$.
By
Algebra, Lemmas \ref{algebra-lemma-ass-zero-divisors},
\ref{algebra-lemma-finite-ass}, and
\ref{algebra-lemma-silly}
there exists an element $\overline{g} \in \overline{\mathfrak q}$
which is not a zerodivisor on $\overline{N}$. Let $g \in \mathfrak q$
be an element which maps to $\overline{g}$ in $\overline{\mathfrak q}$. By
Lemma \ref{lemma-invert-universally-injective}
the map $g : N \to N$ is $R$-universally injective. In particular
we see that $g : M \otimes_R N \to M \otimes_R N$ is injective.
Clearly this implies that
$\mathfrak q \not \in \text{WeakAss}_S(M \otimes_R N)$.
We conclude that $\mathfrak q \in \text{WeakAss}_S(M \otimes_R N)$ implies
$\overline{\mathfrak q} \in \text{Ass}_{\overline{S}}(\overline{N})$.

\medskip\noindent
Assume $\mathfrak q \in \text{WeakAss}_S(M \otimes_R N)$.
Let $z \in M \otimes_R N$ be an element whose annihilator in $S$
has radical $\mathfrak q$. As $N$ is a free $R$-module, we can find
a finite free direct summand $F \subset N$ such that
$z \in M \otimes_R F$. The radical of the annihilator of
$z \in M \otimes_R F$ in $R$ is $\mathfrak m$ (by our assumption on $z$
and because $\mathfrak q$ lies over $\mathfrak m$). Hence we see that
$\mathfrak m \in \text{WeakAss}(M \otimes_R F)$ which implies
that $\mathfrak m \in \text{WeakAss}(M)$ by
Algebra, Lemma \ref{algebra-lemma-weakly-ass}.
This finishes the proof of (1).

\medskip\noindent
Assume that $\mathfrak m \in \text{WeakAss}_R(M)$ and
$\overline{\mathfrak q} \in \text{Ass}_{\overline{S}}(\overline{N})$
is a maximal element.
Let $y \in M$ be an element whose annihilator $I = \text{Ann}_R(y)$
has radical $\mathfrak m$. Then $R/I \subset M$ and by flatness of $N$
over $R$ we get $N/IN = R/I \otimes_R N \subset M \otimes_R N$. Hence
it is enough to show that $\mathfrak q \in \text{WeakAss}(N/IN)$.
Write $\overline{\mathfrak q} = (\overline{g}_1, \ldots, \overline{g}_n)$
for some $\overline{g}_i \in \overline{S}$. Choose lifts
$g_i \in \mathfrak q$. Consider the map
$$
\Psi : N/IN \longrightarrow N/IN^{\oplus n}, \quad
z \longmapsto (g_1z, \ldots, g_nz).
$$
We may think of this as a map of free $R/I$-modules. As the ring
$R/I$ is auto-associated (since $\mathfrak m/I$ is locally nilpotent)
and since $\Psi \otimes R/\mathfrak m$ isn't injective (since
$\overline{\mathfrak q} \in \text{Ass}(\overline{N})$) we see by
More on Algebra, Lemma \ref{more-algebra-lemma-P-fPD-zero}
that $\Psi$ isn't injective. Pick $z \in N/IN$ nonzero in the kernel
of $\Psi$. The annihilator of $z$ contains $I$ and $g_i$, whence
its radical $J = \sqrt{\text{Ann}_S(z)}$ contains $\mathfrak q$.
Let $\mathfrak q' \supset J$ be a minimal prime over $J$.
Then $\mathfrak q' \in \text{WeakAss}(M \otimes_R N)$ (by definition)
and by (1) we see that
$\overline{\mathfrak q}' \in \text{Ass}(\overline{N})$.
Then since $\mathfrak q \subset \mathfrak q'$ by construction the
maximality of $\overline{\mathfrak q}$ implies $\mathfrak q = \mathfrak q'$
whence $\mathfrak q \in \text{WeakAss}(M \otimes_R N)$.
This proves part (2) of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-bourbaki-finite-type-general-base-at-point}
Let $S$ be a scheme.
Let $f : X \to S$ be locally of finite type.
Let $x \in X$ with image $s \in S$.
Let $\mathcal{F}$ be a finite type quasi-coherent sheaf on $X$.
Let $\mathcal{G}$ be a quasi-coherent sheaf on $S$.
If $\mathcal{F}$ is flat at $x$ over $S$, then
$$
x \in \text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}_S(\mathcal{G})
\text{ and }
x \in \text{Ass}_{X_s}(\mathcal{F}_s).
$$
\end{lemma}

\begin{proof}
The question is local on $X$ and $S$, hence we may assume $X$ and $S$
are affine. Write $X = \Spec(B)$, $S = \Spec(A)$ and write
$B = A[x_1, \ldots, x_n]/I$. In other words we obtain a closed immersion
$i : X \to \mathbf{A}^n_S$ over $S$. Denote $t = i(x) \in \mathbf{A}^n_S$.
Note that $i_*\mathcal{F}$ is a finite type quasi-coherent sheaf on
$\mathbf{A}^n_S$ which is flat at $t$ over $S$ and note that
$$
i_*(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}) =
i_*\mathcal{F} \otimes_{\mathcal{O}_{\mathbf{A}^n_S}} p^*\mathcal{G}
$$
where $p : \mathbf{A}^n_S \to S$ is the projection. Note that
$t$ is a weakly associated point of
$i_*(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})$
if and only if $x$ is a weakly associated point of
$\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}$, see
Divisors, Lemma \ref{divisors-lemma-weakly-associated-finite}.
Similarly $x \in \text{Ass}_{X_s}(\mathcal{F}_s)$ if and only
if $t \in \text{Ass}_{\mathbf{A}^n_s}((i_*\mathcal{F})_s)$ (see
Algebra, Lemma \ref{algebra-lemma-ass-quotient-ring}).
Hence it suffices to prove the lemma in case $X = \mathbf{A}^n_S$.
In particular we may assume that $X \to S$ is of finite presentation.

\medskip\noindent
Recall that $\text{Ass}_{X_s}(\mathcal{F}_s)$ is a locally finite subset
of the locally Noetherian scheme $X_s$, see
Divisors, Lemma \ref{divisors-lemma-finite-ass}.
After replacing $X$ by a suitable affine neighbourhood of $x$ we may
assume that
\begin{itemize}
\item[$(*)$] if $x' \in \text{Ass}_{X_s}(\mathcal{F}_s)$ and $x \leadsto x'$
then $x = x'$.
\end{itemize}
(Proof omitted. Hint: using
Algebra, Lemma \ref{algebra-lemma-silly}
invert a function which does not vanish at $x$ but does vanish
in all the finitely many points of $\text{Ass}_{X_s}(\mathcal{F}_s)$
which are specializations of $x$ but not equal to $x$.)
In words, no point of $\text{Ass}_{X_s}(\mathcal{F}_s)$
is a proper specialization of $x$.

\medskip\noindent
Suppose given a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]_e
}
$$
of pointed schemes whose horizontal arrows are elementary \'etale
neighbourhoods. Then it suffices to prove the statement for
$x'$, $s'$, $g^*\mathcal{F}$ and $e^*\mathcal{G}$, see
Lemma \ref{lemma-etale-weak-assassin-up-down}.
Note that property $(*)$ is preserved by such an \'etale localization
by the same lemma (if there is a proper specialization
$x' \leadsto x''$ on $X'_{s'}$ then this maps to a proper
specialization on $X_s$ because the fibres of an \'etale morphism
are discrete). We may also replace $S$ by the spectrum of its local ring
as the condition of being an associated point of a quasi-coherent sheaf
depends only on the stalk of the sheaf. Again property $(*)$ is
preserved by this as well. Thus we may first apply
Proposition \ref{proposition-finite-type-flat-at-point}
to reduce to the case where $\mathcal{F}$ is of finite presentation
and flat over $S$, whereupon we may use
Proposition \ref{proposition-finite-presentation-flat-at-point}
to reduce to the case that $X \to S$ is a morphism of affines
and $\Gamma(X, \mathcal{F})$ is a finitely presented
$\Gamma(X, \mathcal{O}_X)$-module which is projective as a
$\Gamma(S, \mathcal{O}_S)$-module. Localizing $S$ once more we
may assume that $\Gamma(S, \mathcal{O}_S)$ is a local ring such that
$s$ corresponds to the maximal ideal. In this case
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}
guarantees that $\Gamma(X, \mathcal{F})$ is free as an
$\Gamma(S, \mathcal{O}_S)$-module. The implication
$x \in \text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})
\Rightarrow
s \in \text{WeakAss}_S(\mathcal{G})
\text{ and }
x \in \text{Ass}_{X_s}(\mathcal{F}_s)$ follows from part (1) of
Lemma \ref{lemma-weak-bourbaki-pre}.
The converse implication follows from
part (2) of Lemma \ref{lemma-weak-bourbaki-pre}
as property $(*)$ insures that the prime corresponding
to $x$ gives rise to a maximal element of
$\text{Ass}_{\overline{S}}(\overline{N})$ exactly as in the statement
of part (2) of
Lemma \ref{lemma-weak-bourbaki-pre}.
\end{proof}

\begin{lemma}
\label{lemma-weak-bourbaki}
Let $R \to S$ be a ring map which is essentially of finite type.
Let $N$ be a localization of a finite $S$-module flat over $R$.
Let $M$ be an $R$-module. Then
$$
\text{WeakAss}_S(M \otimes_R N)
=
\bigcup\nolimits_{\mathfrak p \in \text{WeakAss}_R(M)}
\text{Ass}_{S \otimes_R \kappa(\mathfrak p)}(N \otimes_R \kappa(\mathfrak p))
$$
\end{lemma}

\begin{proof}
This lemma is a translation of
Lemma \ref{lemma-bourbaki-finite-type-general-base-at-point}
into algebra. Details of translation omitted.
\end{proof}

\begin{lemma}
\label{lemma-bourbaki-finite-type-general-base}
Let $f : X \to S$ be a morphism which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent sheaf on $X$
which is flat over $S$. Let $\mathcal{G}$ be a quasi-coherent sheaf on $S$.
Then we have
$$
\text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}) =
\bigcup\nolimits_{s \in \text{WeakAss}_S(\mathcal{G})}
\text{Ass}_{X_s}(\mathcal{F}_s)
$$
\end{lemma}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-bourbaki-finite-type-general-base-at-point}.
\end{proof}

\begin{theorem}
\label{theorem-finite-type-flat}
\begin{slogan}
The flat locus is open (non-Noetherian version).
\end{slogan}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X \to S$ is locally of finite presentation,
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite type, and
\item the set of weakly associated points of $S$ is locally finite in $S$.
\end{enumerate}
Then $U = \{x \in X \mid \mathcal{F}\text{ flat at }x\text{ over }S\}$
is open in $X$ and $\mathcal{F}|_U$ is an $\mathcal{O}_U$-module
of finite presentation and flat over $S$.
\end{theorem}

\begin{proof}
Let $x \in X$ be such that $\mathcal{F}$ is flat at $x$ over $S$.
We have to find an open neighbourhood of $x$ such that $\mathcal{F}$ restricts
to a $S$-flat finitely presented module on this neighbourhood.
The problem is local on $X$ and $S$, hence we may assume that $X$ and $S$
are affine. As $\mathcal{F}_x$ is a finitely presented
$\mathcal{O}_{X, x}$-module by
Lemma \ref{lemma-finite-type-flat-at-point-local}
we conclude from
Algebra, Lemma \ref{algebra-lemma-construct-fp-module-from-stalk}
there exists a finitely presented $\mathcal{O}_X$-module $\mathcal{F}'$
and a map $\varphi : \mathcal{F}' \to \mathcal{F}$ which induces
an isomorphism $\varphi_x : \mathcal{F}'_x \to \mathcal{F}_x$. In particular
we see that $\mathcal{F}'$ is flat over $S$ at $x$, hence by openness
of flatness
More on Morphisms, Theorem \ref{more-morphisms-theorem-openness-flatness}
we see that after shrinking $X$ we may assume that
$\mathcal{F}'$ is flat over $S$. As $\mathcal{F}$ is of finite type
after shrinking $X$ we may assume that $\varphi$ is surjective, see
Modules, Lemma \ref{modules-lemma-finite-type-surjective-on-stalk}
or alternatively use Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK}).
By
Lemma \ref{lemma-bourbaki-finite-type-general-base}
we have
$$
\text{WeakAss}_X(\mathcal{F}') \subset
\bigcup\nolimits_{s \in \text{WeakAss}(S)} \text{Ass}_{X_s}(\mathcal{F}'_s)
$$
As $\text{WeakAss}(S)$ is finite by assumption and since
$\text{Ass}_{X_s}(\mathcal{F}'_s)$ is finite by
Divisors, Lemma \ref{divisors-lemma-finite-ass}
we conclude that $\text{WeakAss}_X(\mathcal{F}')$ is finite. Using
Algebra, Lemma \ref{algebra-lemma-silly}
we may, after shrinking $X$ once more, assume that
$\text{WeakAss}_X(\mathcal{F}')$ is contained in the generalization
of $x$. Now consider $\mathcal{K} = \Ker(\varphi)$. We have
$\text{WeakAss}_X(\mathcal{K}) \subset \text{WeakAss}_X(\mathcal{F}')$
(by
Divisors, Lemma \ref{divisors-lemma-ses-weakly-ass})
but on the other hand, $\varphi_x$ is an isomorphism, also $\varphi_{x'}$
is an isomorphism for all $x' \leadsto x$. We conclude that
$\text{WeakAss}_X(\mathcal{K}) = \emptyset$ whence
$\mathcal{K} = 0$ by
Divisors, Lemma \ref{divisors-lemma-weakly-ass-zero}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-algebra}
Let $R \to S$ be a ring map of finite presentation.
Let $M$ be a finite $S$-module. Assume $\text{WeakAss}_S(S)$ is finite.
Then
$$
U = \{\mathfrak q \subset S \mid M_{\mathfrak q}\text{ flat over }R\}
$$
is open in $\Spec(S)$ and for every $g \in S$ such that
$D(g) \subset U$ the localization $M_g$ is a finitely presented
$S_g$-module flat over $R$.
\end{lemma}

\begin{proof}
Follows immediately from
Theorem \ref{theorem-finite-type-flat}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-X}
Let $f : X \to S$ be a morphism of schemes which is locally of finite
type. Assume the set of weakly associated points of $S$ is locally finite
in $S$. Then the set of points $x \in X$ where $f$ is flat is an open
subscheme $U \subset X$ and $U \to S$ is flat and locally of finite
presentation.
\end{lemma}

\begin{proof}
The problem is local on $X$ and $S$, hence we may assume that
$X$ and $S$ are affine. Then $X \to S$ corresponds to a finite type
ring map $A \to B$. Choose a surjection $A[x_1, \ldots, x_n] \to B$
and consider $B$ as an $A[x_1, \ldots, x_n]$-module. An application of
Lemma \ref{lemma-finite-type-flat-algebra}
finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-over-integral}
Let $f : X \to S$ be a morphism of schemes which is
locally of finite type and flat. If $S$ is integral, then $f$
is locally of finite presentation.
\end{lemma}

\begin{proof}
Special case of
Lemma \ref{lemma-finite-type-flat-X}.
\end{proof}

\begin{proposition}
\label{proposition-flat-finite-type-finite-presentation-domain}
Let $R$ be a domain. Let $R \to S$ be a ring map of finite type.
Let $M$ be a finite $S$-module.
\begin{enumerate}
\item If $S$ is flat over $R$, then $S$ is a finitely presented $R$-algebra.
\item If $M$ is flat as an $R$-module, then $M$ is finitely presented
as an $S$-module.
\end{enumerate}
\end{proposition}

\begin{proof}
Part (1) is a special case of
Lemma \ref{lemma-finite-type-flat-over-integral}.
For Part (2) choose a surjection $R[x_1, \ldots, x_n] \to S$.
By Lemma \ref{lemma-finite-type-flat-algebra} we find that $M$
is finitely presented as an $R[x_1, \ldots, x_n]$-module.
We conclude by Algebra, Lemma
\ref{algebra-lemma-finitely-presented-over-subring}.
\end{proof}

\begin{remark}[Finite type version of Theorem \ref{theorem-finite-type-flat}]
\label{remark-finite-type-flat}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X \to S$ is locally of finite type,
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite type, and
\item the set of weakly associated points of $S$ is locally finite in $S$.
\end{enumerate}
Then $U = \{x \in X \mid \mathcal{F}\text{ flat at }x\text{ over }S\}$
is open in $X$ and $\mathcal{F}|_U$ is flat over $S$ and locally
finitely presented relative to $S$ (see
More on Morphisms, Definition
\ref{more-morphisms-definition-relatively-finitely-presented-sheaf}).
If we ever need this result in the Stacks project we will convert
this remark into a lemma with a proof.
\end{remark}

\begin{remark}[Algebra version of Remark \ref{remark-finite-type-flat}]
\label{remark-finite-type-flat-algebra}
Let $R \to S$ be a ring map of finite type.
Let $M$ be a finite $S$-module.
Assume $\text{WeakAss}_S(S)$ is finite.
Then
$$
U = \{\mathfrak q \subset S \mid M_{\mathfrak q}\text{ flat over }R\}
$$
is open in $\Spec(S)$ and for every $g \in S$ such that
$D(g) \subset U$ the localization $M_g$ is flat over $R$ and
an $S_g$-module finitely presented relative to $R$ (see
More on Algebra, Definition
\ref{more-algebra-definition-relatively-finitely-presented}).
If we ever need this result in the Stacks project we will convert
this remark into a lemma with a proof.
\end{remark}









\section{Examples of relatively pure modules}
\label{section-examples-pure-modules}

\noindent
In the short section we discuss some examples of results that will serve
as motivation for the notion of a {\it relatively pure module} and the
concept of an {\it impurity} which we will introduce later. Each of the
examples is stated as a lemma. Note the similarity with the condition on
associated primes to the conditions appearing in
Lemmas \ref{lemma-base-change-universally-flat},
\ref{lemma-universally-injective-to-completion},
\ref{lemma-universally-injective-to-completion-flat}, and
\ref{lemma-flat-pure-over-complete-projective}.
See also
Algebra, Lemma \ref{algebra-lemma-compare-relative-assassins}
for a discussion.

\begin{lemma}
\label{lemma-explain-why-pure}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
Assume
\begin{enumerate}
\item $N$ is projective as an $R$-module, and
\item $S/\mathfrak mS$ is Noetherian and $N/\mathfrak mN$ is a finite
$S/\mathfrak mS$-module.
\end{enumerate}
Then for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p = R \cap \mathfrak q$
we have $\mathfrak q + \mathfrak m S \not = S$.
\end{lemma}

\begin{proof}
Note that the hypotheses of
Lemmas \ref{lemma-homothety-spectrum} and
\ref{lemma-invert-universally-injective}
are satisfied. We will use the conclusions of these lemmas without further
mention. Let $\Sigma \subset S$ be the multiplicative set of elements
which are not zerodivisors on $N/\mathfrak mN$. The map
$N \to \Sigma^{-1}N$ is $R$-universally injective. Hence we see that
any $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R \kappa(\mathfrak p)$ is also an associated prime of
$\Sigma^{-1}N \otimes_R \kappa(\mathfrak p)$. Clearly this implies that
$\mathfrak q$ corresponds to a prime of $\Sigma^{-1}S$.
Thus $\mathfrak q \subset \mathfrak q'$ where $\mathfrak q'$
corresponds to an associated prime of $N/\mathfrak mN$ and we win.
\end{proof}

\noindent
The following lemma gives another (slightly silly) example of this phenomenon.

\begin{lemma}
\label{lemma-explain-why-pure-complete}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
If $N$ is $I$-adically complete, then for any $R$-module $M$ and
for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R M$ we have $\mathfrak q + I S \not = S$.
\end{lemma}

\begin{proof}
Let $S^\wedge$ denote the $I$-adic completion of $S$.
Note that $N$ is an $S^\wedge$-module, hence also
$N \otimes_R M$ is an $S^\wedge$-module.
Let $z \in N \otimes_R M$ be an element such that
$\mathfrak q = \text{Ann}_S(z)$. Since $z \not = 0$ we see
that $\text{Ann}_{S^\wedge}(z) \not = S^\wedge$. Hence
$\mathfrak q S^\wedge \not = S^\wedge$. Hence there exists a
maximal ideal $\mathfrak m \subset S^\wedge$ with
$\mathfrak q S^\wedge \subset \mathfrak m$. Since
$IS^\wedge \subset \mathfrak m$ by
Algebra, Lemma \ref{algebra-lemma-radical-completion}
we win.
\end{proof}

\noindent
Note that the following lemma gives an alternative proof of
Lemma \ref{lemma-explain-why-pure}
as a projective module over a local ring is free, see
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}.

\begin{lemma}
\label{lemma-explain-why-pure-direct-sum-finite-modules}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
Assume $N$ is isomorphic as an $R$-module to a direct
sum of finite $R$-modules. Then for any $R$-module $M$ and
for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R M$ we have $\mathfrak q + \mathfrak m S \not = S$.
\end{lemma}

\begin{proof}
Write $N = \bigoplus_{i \in I} M_i$ with each $M_i$ a finite $R$-module.
Let $M$ be an $R$-module and let $\mathfrak q \subset S$ be an associated
prime of $N \otimes_R M$ such that $\mathfrak q + \mathfrak m S = S$. Let
$z \in N \otimes_R M$ be an element with $\mathfrak q = \text{Ann}_S(z)$.
After modifying the direct sum decomposition a little bit we may assume that
$z \in M_1 \otimes_R M$ for some element $1 \in I$. Write
$1 = f + \sum x_j g_j$ for some $f \in \mathfrak q$, $x_j \in \mathfrak m$,
and $g_j \in S$. For any $g \in S$ denote $g'$ the $R$-linear map
$$
M_1 \to N \xrightarrow{g} N \to M_1
$$
where the first arrow is the inclusion map, the second arrow is multiplication
by $g$ and the third arrow is the projection map. Because each $x_j \in R$
we obtain the equality
$$
f' + \sum x_j g'_j = \text{id}_{M_1} \in \text{End}_R(M_1)
$$
By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
we see that $f'$ is surjective, hence by
Algebra, Lemma \ref{algebra-lemma-fun}
we see that $f'$ is an isomorphism. In particular the map
$$
M_1 \otimes_R M \to N \otimes_R M \xrightarrow{f} N \otimes_R M
\to M_1 \otimes_R M
$$
is an isomorphism. This contradicts the assumption that $fz = 0$.
\end{proof}

\begin{lemma}
\label{lemma-explain-why-pure-ML}
Let $R$ be a henselian local ring with maximal ideal $\mathfrak m$.
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
Assume $N$ is countably generated and Mittag-Leffler as an $R$-module.
Then for any $R$-module $M$ and for any prime $\mathfrak q \subset S$
which is an associated prime of $N \otimes_R M$ we have
$\mathfrak q + \mathfrak m S \not = S$.
\end{lemma}

\begin{proof}
This lemma reduces to
Lemma \ref{lemma-explain-why-pure-direct-sum-finite-modules}
by
Algebra, Lemma \ref{algebra-lemma-split-ML-henselian}.
\end{proof}

\noindent
Suppose $f : X \to S$ is a morphism of schemes and
$\mathcal{F}$ is a quasi-coherent module on $X$.
Let $\xi \in \text{Ass}_{X/S}(\mathcal{F})$ and let $Z = \overline{\{\xi\}}$.
Picture
$$
\xymatrix{
\xi \ar@{|->}[d] & Z \ar[r] \ar[rd] & X \ar[d]^f \\
f(\xi) & & S
}
$$
Note that $f(Z) \subset \overline{\{f(\xi)\}}$ and that $f(Z)$ is closed
if and only if equality holds, i.e., $f(Z) = \overline{\{f(\xi)\}}$.
It follows from
Lemma \ref{lemma-explain-why-pure}
that if $S$, $X$ are affine, the fibres $X_s$ are Noetherian,
$\mathcal{F}$ is of finite type, and $\Gamma(X, \mathcal{F})$
is a projective $\Gamma(S, \mathcal{O}_S)$-module, then
$f(Z) = \overline{\{f(\xi)\}}$ is a closed subset.
Slightly different analogous statements holds for the cases described in
Lemmas \ref{lemma-explain-why-pure-complete},
\ref{lemma-explain-why-pure-direct-sum-finite-modules}, and
\ref{lemma-explain-why-pure-ML}.




\section{Impurities}
\label{section-impure}

\noindent
We want to formalize the phenomenon of which we gave examples in
Section \ref{section-examples-pure-modules}
in terms of specializations of points of $\text{Ass}_{X/S}(\mathcal{F})$.
We also want to work locally around a point $s \in S$. In order to do so we
make the following definitions.

\begin{situation}
\label{situation-pre-pure}
Here $S$, $X$ are schemes and $f : X \to S$ is a finite type morphism.
Also, $\mathcal{F}$ is a finite type quasi-coherent $\mathcal{O}_X$-module.
Finally $s$ is a point of $S$.
\end{situation}

\noindent
In this situation consider a morphism $g : T \to S$, a point $t \in T$
with $g(t) = s$, a specialization $t' \leadsto t$, and a point
$\xi \in X_T$ in the base change of $X$ lying over $t'$. Picture
\begin{equation}
\label{equation-impurity}
\vcenter{
\xymatrix{
\xi \ar@{|->}[d] & \\
t' \ar@{~>}[r] & t \ar@{|->}[d] \\
& s
}
}
\quad\quad
\vcenter{
\xymatrix{
X_T \ar[d] \ar[r] & X \ar[d] \\
T \ar[d]^g \ar[r]^g & S \\
S
}
}
\end{equation}
Moreover, denote $\mathcal{F}_T$ the pullback of $\mathcal{F}$ to $X_T$.

\begin{definition}
\label{definition-impurity}
In
Situation \ref{situation-pre-pure}
we say a diagram (\ref{equation-impurity}) defines an
{\it impurity of $\mathcal{F}$ above $s$}
if $\xi \in \text{Ass}_{X_T/T}(\mathcal{F}_T)$ and
$\overline{\{\xi\}} \cap X_t = \emptyset$. We will indicate
this by saying ``let $(g : T \to S, t' \leadsto t, \xi)$ be
an impurity of $\mathcal{F}$ above $s$''.
\end{definition}

\begin{lemma}
\label{lemma-impure-finite-presentation}
In Situation \ref{situation-pre-pure}.
If there exists an impurity of $\mathcal{F}$ above $s$, then
there exists an impurity $(g : T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $g$ is locally of finite
presentation and $t$ a closed point of the fibre of $g$ above $s$.
\end{lemma}

\begin{proof}
Let $(g : T \to S, t' \leadsto t, \xi)$ be any impurity of
$\mathcal{F}$ above $s$. We apply
Limits, Lemma \ref{limits-lemma-separate}
to $t \in T$ and $Z = \overline{\{\xi\}}$ to obtain an open neighbourhood
$V \subset T$ of $t$, a commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r]_a & T' \ar[d]^b \\
T \ar[r]^g & S,
}
$$
and a closed subscheme $Z' \subset X_{T'}$ such that
\begin{enumerate}
\item the morphism $b : T' \to S$ is locally of finite presentation,
\item we have $Z' \cap X_{a(t)} = \emptyset$, and
\item $Z \cap X_V$ maps into $Z'$ via the morphism $X_V \to X_{T'}$.
\end{enumerate}
As $t'$ specializes to $t$ we may replace $T$ by the open neighbourhood
$V$ of $t$. Thus we have a commutative diagram
$$
\xymatrix{
X_T \ar[d] \ar[r] &
X_{T'} \ar[d] \ar[r] &
X \ar[d] \\
T \ar[r]^a & T' \ar[r]^b & S
}
$$
where $b \circ a = g$. Let $\xi' \in X_{T'}$ denote the
image of $\xi$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin}
we see that $\xi' \in \text{Ass}_{X_{T'}/T'}(\mathcal{F}_{T'})$.
Moreover, by construction the closure of $\overline{\{\xi'\}}$
is contained in the closed subset $Z'$ which avoids the fibre
$X_{a(t)}$. In this way we see that $(T' \to S, a(t') \leadsto a(t), \xi')$
is an impurity of $\mathcal{F}$ above $s$.

\medskip\noindent
Thus we may assume that $g : T \to S$ is locally of finite presentation.
Let $Z = \overline{\{\xi\}}$. By assumption $Z_t = \emptyset$. By
More on Morphisms, Lemma \ref{more-morphisms-lemma-empty-generic-fibre}
this means that $Z_{t''} = \emptyset$ for $t''$ in an open subset
of $\overline{\{t\}}$. Since the fibre of
$T \to S$ over $s$ is a Jacobson scheme, see
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-Jacobson-schemes}
we find that there exist a closed point $t'' \in \overline{\{t\}}$ such that
$Z_{t''} = \emptyset$. Then $(g : T \to S, t' \leadsto t'', \xi)$ is the
desired impurity.
\end{proof}

\begin{lemma}
\label{lemma-impure-limit}
In Situation \ref{situation-pre-pure}.
Let $(g : T \to S, t' \leadsto t, \xi)$ be an impurity of
$\mathcal{F}$ above $s$. Assume $S$ is affine and that $T$
is written $T = \lim_{i \in I} T_i$ as a directed colimit
of affine schemes over $S$. Then for some $i$ the triple
$(T_i \to S, t'_i \leadsto t_i, \xi_i)$ is an impurity of
$\mathcal{F}$ above $s$.
\end{lemma}

\begin{proof}
The notation in the statement means this: Let $f_i : T \to T_i$
be the projection morphisms, let $t_i = f_i(t)$ and $t'_i = f_i(t')$.
Finally $\xi_i \in X_{T_i}$ is the image of $\xi$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin}
it is true that $\xi_i$ is a point of the relative
assassin of $\mathcal{F}_{T_i}$ over $T_i$. Thus the only point is to
show that $\overline{\{\xi_i\}} \cap X_{t_i} = \emptyset$ for some
$i$. Set $Z = \overline{\{\xi\}}$. Apply
Limits, Lemma \ref{limits-lemma-separate}
to this situation to obtain an open neighbourhood
$V \subset T$ of $t$, a commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r]_a & T' \ar[d]^b \\
T \ar[r]^g & S,
}
$$
and a closed subscheme $Z' \subset X_{T'}$ such that
\begin{enumerate}
\item the morphism $b : T' \to S$ is locally of finite presentation,
\item we have $Z' \cap X_{a(t)} = \emptyset$, and
\item $Z \cap X_V$ maps into $Z'$ via the morphism $X_V \to X_{T'}$.
\end{enumerate}
We may assume $V$ is an affine open of $T$, hence by
Limits, Lemmas \ref{limits-lemma-descend-opens} and
\ref{limits-lemma-limit-affine}
we can find an $i$ and an affine open $V_i \subset T_i$ with
$V = f_i^{-1}(V_i)$. By
Limits,
Proposition \ref{limits-proposition-characterize-locally-finite-presentation}
after possibly increasing $i$ a bit we can find a morphism
$a_i : V_i \to T'$ such that $a = a_i \circ f_i|_V$.
The induced morphism $X_{T_i} \to X_{T'}$ maps $\xi_i$ into
$Z'$. As $Z' \cap X_{a(t)} = \emptyset$ we conclude that
$(T_i \to S, t'_i \leadsto t_i, \xi_i)$ is an impurity of
$\mathcal{F}$ above $s$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-impurity-elementary}
In Situation \ref{situation-pre-pure}.
If there exists an impurity $(g : T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ with $g$ quasi-finite at $t$, then there
exists an impurity $(g : T \to S, t' \leadsto t, \xi)$ such that
$(T, t) \to (S, s)$ is an elementary \'etale neighbourhood.
\end{lemma}

\begin{proof}
Let $(g : T \to S, t' \leadsto t, \xi)$ be an impurity of
$\mathcal{F}$ above $s$ such that $g$ is quasi-finite at $t$.
After shrinking $T$ we may assume that $g$ is locally of finite type.
Apply
More on Morphisms,
Lemma \ref{more-morphisms-lemma-etale-makes-quasi-finite-finite-at-point}
to $T \to S$ and $t \mapsto s$. This gives us a diagram
$$
\xymatrix{
T \ar[d] & T \times_S U \ar[l] \ar[d] & V \ar[l] \ar[ld] \\
S & U \ar[l]
}
$$
where $(U, u) \to (S, s)$ is an elementary \'etale neighbourhood
and $V \subset T \times_S U$ is an open neighbourhood of $v = (t, u)$
such that $V \to U$ is finite and such that $v$ is the unique point of $V$
lying over $u$. Since the morphism $V \to T$ is \'etale
hence flat we see that there exists a specialization $v' \leadsto v$ such
that $v' \mapsto t'$. Note that $\kappa(t') \subset \kappa(v')$
is finite separable. Pick any point $\zeta \in X_{v'}$ mapping to
$\xi \in X_{t'}$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin}
we see that $\zeta \in \text{Ass}_{X_V/V}(\mathcal{F}_V)$.
Moreover, the closure $\overline{\{\zeta\}}$ does not meet
the fibre $X_v$ as by assumption the closure $\overline{\{\xi\}}$
does not meet $X_t$. In other words $(V \to S, v' \leadsto v, \zeta)$
is an impurity of $\mathcal{F}$ above $S$.

\medskip\noindent
Next, let $u' \in U'$ be the image of $v'$ and let
$\theta \in X_U$ be the image of $\zeta$.
Then $\theta \mapsto u'$ and $u' \leadsto u$.
By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin}
we see that $\theta \in \text{Ass}_{X_U/U}(\mathcal{F})$.
Moreover, as $\pi : X_V \to X_U$ is finite we see that
$\pi\big(\overline{\{\zeta\}}\big) = \overline{\{\pi(\zeta)\}}$. Since
$v$ is the unique point of $V$ lying over $u$ we see that
$X_u \cap \overline{\{\pi(\zeta)\}} = \emptyset$ because
$X_v \cap \overline{\{\zeta\}} = \emptyset$. In this way we conclude that
$(U \to S, u' \leadsto u, \theta)$ is an impurity of
$\mathcal{F}$ above $s$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-impurity-quasi-finite}
In Situation \ref{situation-pre-pure}.
Assume that $S$ is locally Noetherian.
If there exists an impurity of $\mathcal{F}$ above $s$, then
there exists an impurity $(g : T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $g$ is quasi-finite at $t$.
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$. By
Lemma \ref{lemma-impure-finite-presentation}
we may assume that we have an impurity $(g : T \to S, t' \leadsto t, \xi)$
of such that $g$ is locally of finite type and $t$ a closed point of the
fibre of $g$ above $s$. We may replace $T$ by the reduced induced
scheme structure on $\overline{\{t'\}}$. Let
$Z = \overline{\{\xi\}} \subset X_T$. By assumption $Z_t = \emptyset$
and the image of $Z \to T$ contains $t'$. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-relative-assassin-in-neighbourhood}
there exists a nonempty open $V \subset Z$ such that for any
$w \in f(V)$ any generic point $\xi'$ of $V_w$ is in
$\text{Ass}_{X_T/T}(\mathcal{F}_T)$. By
More on Morphisms, Lemma \ref{more-morphisms-lemma-nonempty-generic-fibre}
there exists a nonempty open $W \subset T$ with $W \subset f(V)$. By
More on Morphisms, Lemma
\ref{more-morphisms-lemma-quasi-finite-quasi-section-meeting-nearby-open-X}
there exists a closed subscheme $T' \subset T$ such that
$t \in T'$, $T' \to S$ is quasi-finite at $t$, and there exists a point
$z \in T' \cap W$, $z \leadsto t$ which does not map to $s$.
Choose any generic point $\xi'$ of the nonempty scheme $V_z$.
Then $(T' \to S, z \leadsto t, \xi')$ is the desired impurity.
\end{proof}

\noindent
In the following we will use the henselization
$S^h = \Spec(\mathcal{O}_{S, s}^h)$
of $S$ at $s$, see
\'Etale Cohomology,
Definition \ref{etale-cohomology-definition-etale-local-rings}.
Since $S^h \to S$ maps to closed point of $S^h$ to $s$ and
induces an isomorphism of residue fields, we will indicate
$s \in S^h$ this closed point also. Thus $(S^h, s) \to (S, s)$ is
a morphism of pointed schemes.

\begin{lemma}
\label{lemma-impurity-on-henselization}
In Situation \ref{situation-pre-pure}.
If there exists an impurity $(S^h \to S, s' \leadsto s, \xi)$
of $\mathcal{F}$ above $s$ then there exists an impurity
$(T \to S, t' \leadsto t, \xi)$ of $\mathcal{F}$ above $s$
where $(T, t) \to (S, s)$ is an elementary \'etale neighbourhood.
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$.
Say $S = \Spec(A)$ and $s$ corresponds to the prime
$\mathfrak p \subset A$. Then
$\mathcal{O}_{S, s}^h = \colim_{(T, t)} \Gamma(T, \mathcal{O}_T)$
where the limit is over the opposite of the
cofiltered category of affine elementary \'etale neighbourhoods
$(T, t)$ of $(S, s)$, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-describe-henselization}
and its proof. Hence $S^h = \lim_i T_i$ and we win by
Lemma \ref{lemma-impure-limit}.
\end{proof}

\begin{lemma}
\label{lemma-pure-along-X-s}
In Situation \ref{situation-pre-pure} the following
are equivalent
\begin{enumerate}
\item there exists an impurity $(S^h \to S, s' \leadsto s, \xi)$
of $\mathcal{F}$ above $s$ where $S^h$ is the henselization of $S$ at $s$,
\item there exists an impurity $(T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $(T, t) \to (S, s)$ is an
elementary \'etale neighbourhood, and
\item there exists an impurity $(T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $T \to S$ is quasi-finite at $t$.
\end{enumerate}
\end{lemma}

\begin{proof}
As an \'etale morphism is locally quasi-finite it is clear that
(2) implies (3). We have seen that (3) implies (2) in
Lemma \ref{lemma-quasi-finite-impurity-elementary}.
We have seen that (1) implies (2) in
Lemma \ref{lemma-impurity-on-henselization}.
Finally, if $(T \to S, t' \leadsto t, \xi)$ is an impurity
of $\mathcal{F}$ above $s$ such that $(T, t) \to (S, s)$ is an
elementary \'etale neighbourhood, then we can choose a factorization
$S^h \to T \to S$ of the structure morphism $S^h \to S$.
Choose any point $s' \in S^h$ mapping to $t'$ and choose any
$\xi' \in X_{s'}$ mapping to $\xi \in X_{t'}$. Then
$(S^h \to S, s' \leadsto s, \xi')$ is an impurity of
$\mathcal{F}$ above $s$. We omit the details.
\end{proof}





\section{Relatively pure modules}
\label{section-pure}

\noindent
The notion of a module pure relative to a base was introduced in \cite{GruRay}.

\begin{definition}
\label{definition-pure}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item Let $s \in S$. We say $\mathcal{F}$ is {\it pure along $X_s$}
if there is no impurity $(g : T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ with $(T, t) \to (S, s)$ an
elementary \'etale neighbourhood.
\item We say $\mathcal{F}$ is {\it universally pure along $X_s$}
if there does not exist any impurity of $\mathcal{F}$ above $s$.
\item We say that $X$ is {\it pure along $X_s$} if $\mathcal{O}_X$
is pure along $X_s$.
\item We say $\mathcal{F}$ is {\it universally $S$-pure}, or
{\it universally pure relative to $S$} if $\mathcal{F}$ is universally
pure along $X_s$ for every $s \in S$.
\item We say $\mathcal{F}$ is {\it $S$-pure}, or
{\it pure relative to $S$} if $\mathcal{F}$ is pure along $X_s$
for every $s \in S$.
\item We say that $X$ is {\it $S$-pure} or {\it pure relative to $S$}
if $\mathcal{O}_X$ is pure relative to $S$.
\end{enumerate}
\end{definition}

\noindent
We intentionally restrict ourselves here to morphisms which are
of finite type and not just morphisms which are locally of
finite type, see
Remark \ref{remark-discuss-finite-type}
for a discussion. In the situation of the definition
Lemma \ref{lemma-pure-along-X-s}
tells us that the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is pure along $X_s$,
\item there is no impurity $(g : T \to S, t' \leadsto t, \xi)$ with $g$
quasi-finite at $t$,
\item there does not exist any impurity of the form
$(S^h \to S, s' \leadsto s, \xi)$, where $S^h$ is the henselization
of $S$ at $s$.
\end{enumerate}
If we denote $X^h = X \times_S S^h$ and $\mathcal{F}^h$ the pullback
of $\mathcal{F}$ to $X^h$, then we can formulate the last condition
in the following more positive way:
\begin{enumerate}
\item[(4)] All points of $\text{Ass}_{X^h/S^h}(\mathcal{F}^h)$ specialize
to points of $X_s$.
\end{enumerate}
In particular, it is clear that $\mathcal{F}$ is pure along $X_s$
if and only if the pullback of $\mathcal{F}$ to
$X \times_S \Spec(\mathcal{O}_{S, s})$ is pure along $X_s$.

\begin{remark}
\label{remark-discuss-finite-type}
Let $f : X \to S$ be a morphism which is locally of finite type
and $\mathcal{F}$ a quasi-coherent finite type $\mathcal{O}_X$-module.
In this case it is still true that (1) and (2) above are equivalent
because the proof of
Lemma \ref{lemma-quasi-finite-impurity-elementary}
does not use that $f$ is quasi-compact. It is also clear that
(3) and (4) are equivalent. However, we don't know if (1) and (3) are
equivalent. In this case it may sometimes be more convenient to define
purity using the equivalent conditions (3) and (4) as is done in \cite{GruRay}.
On the other hand, for many applications it seems that the correct notion
is really that of being universally pure.
\end{remark}

\noindent
A natural question to ask is if the property of being pure relative to
the base is preserved by base change, i.e., if being pure is the same
thing as being universally pure. It turns out that this is true
over Noetherian base schemes (see
Lemma \ref{lemma-Noetherian-base-change}),
or if the sheaf is flat (see
Lemmas \ref{lemma-finite-type-flat-pure-along-fibre-is-universal} and
\ref{lemma-finite-type-flat-pure-is-universal}).
It is not true in general, even if the morphism and the sheaf are of
finite presentation, see
Examples, Section \ref{examples-section-pure-not-universally}
for a counter example. First we match our usage of ``universally''
to the usual notion.

\begin{lemma}
\label{lemma-base-change-universally}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$. The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is universally pure along $X_s$, and
\item for every morphism of pointed schemes $(S', s') \to (S, s)$
the pullback $\mathcal{F}_{S'}$ is pure along $X_{s'}$.
\end{enumerate}
In particular, $\mathcal{F}$ is universally pure relative to $S$ if and
only if every base change $\mathcal{F}_{S'}$ of $\mathcal{F}$ is
pure relative to $S'$.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-base-change}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$. Let $(S', s') \to (S, s)$ be a morphism of pointed schemes.
If $S' \to S$ is quasi-finite at $s'$ and $\mathcal{F}$ is pure along $X_s$,
then $\mathcal{F}_{S'}$ is pure along $X_{s'}$.
\end{lemma}

\begin{proof}
It $(T \to S', t' \leadsto t, \xi)$ is an impurity of
$\mathcal{F}_{S'}$ above $s'$ with $T \to S'$ quasi-finite at $t$,
then $(T \to S, t' \to t, \xi)$ is an impurity of $\mathcal{F}$
above $s$ with $T \to S$ quasi-finite at $t$, see
Morphisms, Lemma \ref{morphisms-lemma-composition-quasi-finite}.
Hence the lemma follows immediately from the characterization (2)
of purity given following
Definition \ref{definition-pure}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-base-change}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$. If $\mathcal{O}_{S, s}$ is Noetherian then
$\mathcal{F}$ is pure along $X_s$ if and only if $\mathcal{F}$
is universally pure along $X_s$.
\end{lemma}

\begin{proof}
First we may replace $S$ by $\Spec(\mathcal{O}_{S, s})$, i.e.,
we may assume that $S$ is Noetherian. Next, use
Lemma \ref{lemma-Noetherian-impurity-quasi-finite}
and characterization (2) of purity given in discussion following
Definition \ref{definition-pure}
to conclude.
\end{proof}

\noindent
Purity satisfies flat descent.

\begin{lemma}
\label{lemma-flat-descend-pure}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$. Let $(S', s') \to (S, s)$ be a morphism of pointed schemes.
Assume $S' \to S$ is flat at $s'$.
\begin{enumerate}
\item If $\mathcal{F}_{S'}$ is pure along $X_{s'}$,
then $\mathcal{F}$ is pure along $X_s$.
\item If $\mathcal{F}_{S'}$ is universally pure along $X_{s'}$,
then $\mathcal{F}$ is universally pure along $X_s$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $(T \to S, t' \leadsto t, \xi)$ be an impurity of
$\mathcal{F}$ above $s$. Set $T_1 = T \times_S S'$, and let $t_1$
be the unique point of $T_1$ mapping to $t$ and $s'$. Since
$T_1 \to T$ is flat at $t_1$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-flat},
there exists a specialization $t'_1 \leadsto t_1$ lying over
$t' \leadsto t$, see
Algebra, Section \ref{algebra-section-going-up}.
Choose a point $\xi_1 \in X_{t'_1}$ which corresponds to a generic
point of $\Spec(\kappa(t'_1) \otimes_{\kappa(t')} \kappa(\xi))$, see
Schemes, Lemma \ref{schemes-lemma-points-fibre-product}.
By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin}
we see that $\xi_1 \in \text{Ass}_{X_{T_1}/T_1}(\mathcal{F}_{T_1})$.
As the Zariski closure of $\{\xi_1\}$ in $X_{T_1}$ maps into the
Zariski closure of $\{\xi\}$ in $X_T$ we conclude that
this closure is disjoint from $X_{t_1}$. Hence
$(T_1 \to S', t'_1 \leadsto t_1, \xi_1)$
is an impurity of $\mathcal{F}_{S'}$ above $s'$.
In other words we have proved the contrapositive to part (2) of the
lemma. Finally, if $(T, t) \to (S, s)$ is an elementary
\'etale neighbourhood, then $(T_1, t_1) \to (S', s')$ is an
elementary \'etale neighbourhood too, and in this way we see that (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-supported-on-closed}
Let $i : Z \to X$ be a closed immersion of schemes of finite type over
a scheme $S$. Let $s \in S$. Let $\mathcal{F}$ be a
finite type, quasi-coherent sheaf on $Z$. Then $\mathcal{F}$ is
(universally) pure along $Z_s$ if and only if $i_*\mathcal{F}$
is (universally) pure along $X_s$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}








\section{Examples of relatively pure sheaves}
\label{section-examples-pure-sheaves}

\noindent
Here are some example cases where it is possible to see what purity means.

\begin{lemma}
\label{lemma-proper-pure}
Let $f : X \to S$ be a proper morphism of schemes.
Then every finite type, quasi-coherent $\mathcal{O}_X$-module
$\mathcal{F}$ is universally pure relative to $S$. In particular
$X$ is universally pure relative to $S$.
\end{lemma}

\begin{proof}
Let $(g : T \to S, t' \leadsto t, \xi)$ be an impurity of $\mathcal{F}$
above $s \in S$. Since $f$ is proper, it is universally closed. Hence
$f_T : X_T \to T$ is closed. Since $f_T(\xi) = t'$ this implies that
$t \in f(\overline{\{\xi\}})$ which is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-pure}
Let $f : X \to S$ be a separated, finite type morphism of schemes.
Let $\mathcal{F}$ be a finite type, quasi-coherent $\mathcal{O}_X$-module.
Assume that $\text{Supp}(\mathcal{F}_s)$ is finite for every $s \in S$.
Then the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is pure relative to $S$,
\item the scheme theoretic support of $\mathcal{F}$ is finite over $S$, and
\item $\mathcal{F}$ is universally pure relative to $S$.
\end{enumerate}
In particular, given a quasi-finite separated morphism $X \to S$ we see
that $X$ is pure relative to $S$ if and only if $X \to S$ is finite.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be the scheme theoretic support of $\mathcal{F}$, see
Morphisms, Definition \ref{morphisms-definition-scheme-theoretic-support}.
Then $Z \to S$ is a separated, finite type morphism of schemes with
finite fibres. Hence it is separated and quasi-finite, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite}.
By
Lemma \ref{lemma-supported-on-closed}
it suffices to prove the lemma for $Z \to S$ and the sheaf $\mathcal{F}$
viewed as a finite type quasi-coherent module on $Z$. Hence we may
assume that $X \to S$ is separated and quasi-finite and that
$\text{Supp}(\mathcal{F}) = X$.

\medskip\noindent
It follows from
Lemma \ref{lemma-proper-pure}
and
Morphisms, Lemma \ref{morphisms-lemma-finite-proper}
that (2) implies (3). Trivially (3) implies (1). Assume (1) holds.
We will prove that (2) holds. It is clear that we may assume $S$ is affine. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-quasi-finite-separated-pass-through-finite}
we can find a diagram
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_j & & T \ar[ld]^\pi \\
& S &
}
$$
with $\pi$ finite and $j$ a quasi-compact open immersion.
If we show that $j$ is closed, then $j$ is a closed immersion
and we conclude that $f = \pi \circ j$ is finite.
To show that $j$ is closed it suffices to show that specializations
lift along $j$, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-closed}.
Let $x \in X$, set $t' = j(x)$ and let $t' \leadsto t$ be a specialization.
We have to show $t \in j(X)$. Set $s' = f(x)$ and $s = \pi(t)$ so
$s' \leadsto s$. By
More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical}
we can find an elementary \'etale neighbourhood
$(U, u) \to (S, s)$ and a decomposition
$$
T_U = T \times_S U = V \amalg W
$$
into open and closed subschemes, such that $V \to U$ is finite and
there exists a unique point $v$ of $V$ mapping to $u$, and such that
$v$ maps to $t$ in $T$. As $V \to T$ is \'etale, we can lift
generalizations, see
Morphisms, Lemmas \ref{morphisms-lemma-generalizations-lift-flat} and
\ref{morphisms-lemma-etale-flat}.
Hence there exists a specialization $v' \leadsto v$ such that $v'$
maps to $t' \in T$. In particular we see that $v' \in X_U \subset T_U$.
Denote $u' \in U$ the image of $t'$. Note that
$v' \in \text{Ass}_{X_U/U}(\mathcal{F})$ because $X_{u'}$ is a finite
discrete set and $X_{u'} = \text{Supp}(\mathcal{F}_{u'})$.
As $\mathcal{F}$ is pure relative to $S$ we see that $v'$ must
specialize to a point in $X_u$. Since $v$ is the only point of
$V$ lying over $u$ (and since no point of $W$ can be a specialization
of $v'$) we see that $v \in X_u$. Hence $t \in X$.
\end{proof}

\begin{lemma}
\label{lemma-flat-geometrically-integral-fibres-pure}
Let $f : X \to S$ be a finite type, flat morphism of schemes
with geometrically integral fibres. Then $X$ is universally pure
over $S$.
\end{lemma}

\begin{proof}
Let $\xi \in X$ with $s' = f(\xi)$ and $s' \leadsto s$ a specialization
of $S$. If $\xi$ is an associated point of $X_{s'}$, then $\xi$ is the
unique generic point because $X_{s'}$ is an integral scheme. Let
$\xi_0$ be the unique generic point of $X_s$. As $X \to S$ is flat
we can lift $s' \leadsto s$ to a specialization
$\xi' \leadsto \xi_0$ in $X$, see
Morphisms, Lemma \ref{morphisms-lemma-generalizations-lift-flat}.
The $\xi \leadsto \xi'$ because $\xi$ is the generic point of $X_{s'}$
hence $\xi \leadsto \xi_0$. This means that $(\text{id}_S, s' \to s, \xi)$
is not an impurity of $\mathcal{O}_X$ above $s$. Since the assumption
that $f$ is finite type, flat with geometrically integral fibres
is preserved under base change, we see that there doesn't exist an
impurity after any base change. In this way we see that $X$ is
universally $S$-pure.
\end{proof}

\begin{lemma}
\label{lemma-affine-locally-projective-pure}
Let $f : X \to S$ be a finite type, affine morphism of schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module
such that $f_*\mathcal{F}$ is locally projective on $S$, see
Properties, Definition \ref{properties-definition-locally-projective}.
Then $\mathcal{F}$ is universally pure over $S$.
\end{lemma}

\begin{proof}
After reducing to the case where $S$ is the spectrum of a henselian
local ring this follows from
Lemma \ref{lemma-explain-why-pure}.
\end{proof}




\section{A criterion for purity}
\label{section-criterion-purity}

\noindent
We first prove that given a flat family of finite type
quasi-coherent sheaves the points in the relative assassin
specialize to points in the relative assassins of nearby fibres
(if they specialize at all).

\begin{lemma}
\label{lemma-associated-point-specializes}
Let $f : X \to S$ be a morphism of schemes of finite type.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $s \in S$.
Assume that $\mathcal{F}$ is flat over $S$ at all points of $X_s$.
Let $x' \in \text{Ass}_{X/S}(\mathcal{F})$ with $f(x') = s'$
such that $s' \leadsto s$ is a specialization in $S$. If
$x'$ specializes to a point of $X_s$, then $x' \leadsto x$
with $x \in \text{Ass}_{X_s}(\mathcal{F}_s)$.
\end{lemma}

\begin{proof}
Let $x' \leadsto t$ be a specialization with $t \in X_s$.
We may replace $X$ by an affine neighbourhood of $t$ and $S$ by an
affine neighbourhood of $s$. Choose a closed immersion
$i : X \to \mathbf{A}^n_S$. Then it suffices to prove the lemma
for the module $i_*\mathcal{F}$ on $\mathbf{A}^n_S$ and the point $i(x')$.
Hence we may assume $X \to S$ is of finite presentation.

\medskip\noindent
Let $x' \leadsto t$ be a specialization with $t \in X_s$.
Set $A = \mathcal{O}_{S, s}$, $B = \mathcal{O}_{X, t}$, and
$N = \mathcal{F}_t$. Note that $B$ is essentially of finite presentation
over $A$ and that $N$ is a finite $B$-module flat over $A$.
Also $N$ is a finitely presented $B$-module by
Lemma \ref{lemma-finite-type-flat-at-point-local}.
Let $\mathfrak q' \subset B$ be the prime ideal corresponding to $x'$
and let $\mathfrak p' \subset A$ be the prime ideal corresponding to $s'$.
The assumption $x' \in \text{Ass}_{X/S}(\mathcal{F})$ means that
$\mathfrak q'$ is an associated prime of $N \otimes_A \kappa(\mathfrak p')$.
Let $\Sigma \subset B$ be the multiplicative subset of elements which are
not zerodivisors on $N/\mathfrak m_A N$. By
Lemma \ref{lemma-homothety-universally-injective}
the map $N \to \Sigma^{-1}N$ is universally injective.
In particular, we see that
$N \otimes_A \kappa(\mathfrak p') \to
\Sigma^{-1}N \otimes_A \kappa(\mathfrak p')$
is injective which implies that $\mathfrak q'$ is an associated
prime of $\Sigma^{-1}N \otimes_A \kappa(\mathfrak p')$ and hence
$\mathfrak q'$ is in the image of
$\Spec(\Sigma^{-1}B) \to \Spec(B)$. Thus
Lemma \ref{lemma-homothety-spectrum}
implies that $\mathfrak q' \subset \mathfrak q$ for some prime
$\mathfrak q \in \text{Ass}_B(N/\mathfrak m_A N)$ (which in particular implies
that $\mathfrak m_A = A \cap \mathfrak q$). If $x \in X_s$
denotes the point corresponding to $\mathfrak q$, then
$x \in \text{Ass}_{X_s}(\mathcal{F}_s)$ and $x' \leadsto x$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-criterion}
Let $f : X \to S$ be a morphism of schemes of finite type.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
of finite type. Let $s \in S$. Let $(S', s') \to (S, s)$ be an
elementary \'etale neighbourhood and let
$$
\xymatrix{
X \ar[d] & X' \ar[l]^g \ar[d] \\
S & S' \ar[l]
}
$$
be a commutative diagram of morphisms of schemes. Assume
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ at all points of $X_s$,
\item $X' \to S'$ is of finite type,
\item $g^*\mathcal{F}$ is pure along $X'_{s'}$,
\item $g : X' \to X$ is \'etale, and
\item $g(X')$ contains $\text{Ass}_{X_s}(\mathcal{F}_s)$.
\end{enumerate}
In this situation $\mathcal{F}$ is pure along $X_s$ if and only
if the image of $X' \to X \times_S S'$ contains the points of
$\text{Ass}_{X \times_S S'/S'}(\mathcal{F} \times_S S')$
lying over points in $S'$ which specialize to $s'$.
\end{lemma}

\begin{proof}
Since the morphism $S' \to S$ is \'etale, we see that if $\mathcal{F}$
is pure along $X_s$, then $\mathcal{F} \times_S S'$ is pure along
$X_s$, see
Lemma \ref{lemma-quasi-finite-base-change}.
Since purity satisfies flat descent, see
Lemma \ref{lemma-flat-descend-pure},
we see that if $\mathcal{F} \times_S S'$ is pure along $X_{s'}$, then
$\mathcal{F}$ is pure along $X_s$. Hence we may replace $S$ by $S'$
and assume that $S = S'$ so that $g : X' \to X$ is an \'etale morphism
between schemes of finite type over $S$. Moreover, we may replace
$S$ by $\Spec(\mathcal{O}_{S, s})$ and assume that $S$ is local.

\medskip\noindent
First, assume that $\mathcal{F}$ is pure along $X_s$.
In this case every point of $\text{Ass}_{X/S}(\mathcal{F})$
specializes to a point of $X_s$ by purity. Hence by
Lemma \ref{lemma-associated-point-specializes}
we see that every point of $\text{Ass}_{X/S}(\mathcal{F})$
specializes to a point of $\text{Ass}_{X_s}(\mathcal{F}_s)$.
Thus every point of $\text{Ass}_{X/S}(\mathcal{F})$ is in the
image of $g$ (as the image is open and contains
$\text{Ass}_{X_s}(\mathcal{F}_s)$).

\medskip\noindent
Conversely, assume that $g(X')$ contains $\text{Ass}_{X/S}(\mathcal{F})$.
Let $S^h = \Spec(\mathcal{O}_{S, s}^h)$ be the henselization
of $S$ at $s$. Denote $g^h : (X')^h \to X^h$ the base change of $g$
by $S^h \to S$, and denote $\mathcal{F}^h$ the pullback of $\mathcal{F}$
to $X^h$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin} and
Remark \ref{divisors-remark-base-change-relative-assassin}
the relative assassin $\text{Ass}_{X^h/S^h}(\mathcal{F}^h)$
is the inverse image of $\text{Ass}_{X/S}(\mathcal{F})$ via the projection
$X^h \to X$. As we have assumed that $g(X')$ contains
$\text{Ass}_{X/S}(\mathcal{F})$ we conclude that the base change
$g^h((X')^h) = g(X') \times_S S^h$ contains
$\text{Ass}_{X^h/S^h}(\mathcal{F}^h)$. In this way
we reduce to the case where $S$ is the spectrum of a henselian local ring.
Let $x \in \text{Ass}_{X/S}(\mathcal{F})$. To finish the proof of the
lemma we have to show that $x$ specializes to a point of $X_s$, see
criterion (4) for purity in discussion following
Definition \ref{definition-pure}.
By assumption there exists a $x' \in X'$ such that $g(x') = x$.
As $g : X' \to X$ is \'etale, we see that
$x' \in \text{Ass}_{X'/S}(g^*\mathcal{F})$, see
Lemma \ref{lemma-etale-weak-assassin-up-down} (applied to
the morphism of fibres $X'_w \to X_w$ where $w \in S$ is the image of $x'$).
Since $g^*\mathcal{F}$ is pure along $X'_s$ we see that $x' \leadsto y$
for some $y \in X'_s$. Hence $x = g(x') \leadsto g(y)$ and
$g(y) \in X_s$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-pure-along-fibre-is-universal}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$.
Assume
\begin{enumerate}
\item $f$ is of finite type,
\item $\mathcal{F}$ is of finite type,
\item $\mathcal{F}$ is flat over $S$ at all points of $X_s$, and
\item $\mathcal{F}$ is pure along $X_s$.
\end{enumerate}
Then $\mathcal{F}$ is universally pure along $X_s$.
\end{lemma}

\begin{proof}
We first make a preliminary remark. Suppose that $(S', s') \to (S, s)$
is an elementary \'etale neighbourhood. Denote $\mathcal{F}'$ the
pullback of $\mathcal{F}$ to $X' = X \times_S S'$.
By the discussion following
Definition \ref{definition-pure}
we see that $\mathcal{F}'$ is pure along $X'_{s'}$. Moreover, $\mathcal{F}'$
is flat over $S'$ along $X'_{s'}$. Then it suffices to prove
that $\mathcal{F}'$ is universally pure along $X'_{s'}$. Namely, given
any morphism $(T, t) \to (S, s)$ of pointed schemes
the fibre product $(T', t') = (T \times_S S', (t, s'))$ is flat over $(T, t)$
and hence if $\mathcal{F}_{T'}$ is pure along $X_{t'}$ then
$\mathcal{F}_T$ is pure along $X_t$ by
Lemma \ref{lemma-flat-descend-pure}.
Thus during the proof we may always replace $(s, S)$ by an elementary
\'etale neighbourhood.
We may also replace $S$ by $\Spec(\mathcal{O}_{S, s})$
due to the local nature of the problem.

\medskip\noindent
Choose an elementary \'etale neighbourhood $(S', s') \to (S, s)$ and
a commutative diagram
$$
\xymatrix{
X \ar[d] & X' \ar[l]^g \ar[d] \\
S & \Spec(\mathcal{O}_{S', s'}) \ar[l]
}
$$
such that $X' \to X \times_S \Spec(\mathcal{O}_{S', s'})$
is \'etale, $X_s = g((X')_{s'})$, the scheme $X'$ is affine,
and such that $\Gamma(X', g^*\mathcal{F})$ is a free
$\mathcal{O}_{S', s'}$-module, see
Lemma \ref{lemma-finite-type-flat-along-fibre-free-variant}.
Note that $X' \to \Spec(\mathcal{O}_{S', s'})$ is of finite type
(as a quasi-compact morphism which is the composition of an \'etale morphism
and the base change of a finite type morphism).
By our preliminary remarks in the first paragraph of the proof
we may replace $S$ by $\Spec(\mathcal{O}_{S', s'})$. Hence
we may assume there exists a commutative diagram
$$
\xymatrix{
X \ar[dr] & & X' \ar[ll]^g \ar[ld] \\
& S &
}
$$
of schemes of finite type over $S$, where $g$ is \'etale, $X_s \subset g(X')$,
with $S$ local with closed point $s$, with $X'$ affine, and with
$\Gamma(X', g^*\mathcal{F})$ a free $\Gamma(S, \mathcal{O}_S)$-module.
Note that in this case $g^*\mathcal{F}$ is universally pure over $S$, see
Lemma \ref{lemma-affine-locally-projective-pure}.

\medskip\noindent
In this situation we apply
Lemma \ref{lemma-criterion}
to deduce that $\text{Ass}_{X/S}(\mathcal{F}) \subset g(X')$
from our assumption that $\mathcal{F}$ is pure along $X_s$
and flat over $S$ along $X_s$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin} and
Remark \ref{divisors-remark-base-change-relative-assassin}
we see that for any morphism of pointed schemes
$(T, t) \to (S, s)$ we have
$$
\text{Ass}_{X_T/T}(\mathcal{F}_T) \subset
(X_T \to X)^{-1}(\text{Ass}_{X/S}(\mathcal{F})) \subset
g(X') \times_S T = g_T(X'_T).
$$
Hence by
Lemma \ref{lemma-criterion}
applied to the base change of our displayed diagram to $(T, t)$
we conclude that $\mathcal{F}_T$ is pure along $X_t$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-pure-is-universal}
Let $f : X \to S$ be a finite type morphism of schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Assume $\mathcal{F}$ is flat over $S$. In this case
$\mathcal{F}$ is pure relative to $S$ if and only if $\mathcal{F}$
is universally pure relative to $S$.
\end{lemma}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-finite-type-flat-pure-along-fibre-is-universal}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-limit-purity}
Let $I$ be a directed partially ordered set.
Let $(S_i, g_{ii'})$ be an inverse system of affine schemes over $I$.
Set $S = \lim_i S_i$ and $s \in S$.
Denote $g_i : S \to S_i$ the projections and set $s_i = g_i(s)$.
Suppose that $f : X \to S$ is a morphism of finite presentation,
$\mathcal{F}$ a quasi-coherent $\mathcal{O}_X$-module of finite presentation
which is pure along $X_s$ and flat over $S$ at all points of $X_s$.
Then there exists an $i \in I$, a morphism of finite presentation
$X_i \to S_i$, a quasi-coherent $\mathcal{O}_{X_i}$-module $\mathcal{F}_i$
of finite presentation which is pure along $(X_i)_{s_i}$ and flat over $S_i$
at all points of $(X_i)_{s_i}$ such that $X \cong X_i \times_{S_i} S$
and such that the pullback of $\mathcal{F}_i$ to $X$ is isomorphic
to $\mathcal{F}$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be the set of points where $\mathcal{F}$ is
flat over $S$. By
More on Morphisms, Theorem \ref{more-morphisms-theorem-openness-flatness}
this is an open subscheme of $X$. By assumption $X_s \subset U$.
As $X_s$ is quasi-compact, we can find a quasi-compact open
$U' \subset U$ with $X_s \subset U'$. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i \in I$ and a morphism of finite presentation
$f_i : X_i \to S_i$ whose base change to $S$ is isomorphic to $f_i$.
Fix such a choice and set $X_{i'} = X_i \times_{S_i} S_{i'}$.
Then $X = \lim_{i'} X_{i'}$ with affine transition morphisms. By
Limits, Lemma \ref{limits-lemma-descend-modules-finite-presentation}
we can, after possible increasing $i$ assume there exists a
quasi-coherent $\mathcal{O}_{X_i}$-module $\mathcal{F}_i$
of finite presentation whose base change to $S$ is isomorphic to
$\mathcal{F}$. By
Limits, Lemma \ref{limits-lemma-descend-opens}
after possibly increasing $i$ we may assume there exists an
open $U'_i \subset X_i$ whose inverse image in $X$ is $U'$.
Note that in particular $(X_i)_{s_i} \subset U'_i$. By
Limits, Lemma \ref{limits-lemma-descend-module-flat-finite-presentation}
(after increasing $i$ once more)
we may assume that $\mathcal{F}_i$ is flat on $U'_i$.
In particular we see that $\mathcal{F}_i$ is flat along $(X_i)_{s_i}$.

\medskip\noindent
Next, we use
Lemma \ref{lemma-finite-presentation-flat-along-fibre}
to choose an elementary \'etale neighbourhood
$(S_i', s_i') \to (S_i, s_i)$ and a commutative diagram of schemes
$$
\xymatrix{
X_i \ar[d] & X_i' \ar[l]^{g_i} \ar[d] \\
S_i & S_i' \ar[l]
}
$$
such that $g_i$ is \'etale, $(X_i)_{s_i} \subset g_i(X_i')$, the schemes
$X_i'$, $S_i'$ are affine, and such that
$\Gamma(X_i', g_i^*\mathcal{F}_i)$ is a projective
$\Gamma(S_i', \mathcal{O}_{S_i'})$-module.
Note that $g_i^*\mathcal{F}_i$ is universally pure over $S'_i$, see
Lemma \ref{lemma-affine-locally-projective-pure}.
We may base change the diagram above to a diagram with morphisms
$(S'_{i'}, s'_{i'}) \to (S_{i'}, s_{i'})$ and
$g_{i'} : X'_{i'} \to X_{i'}$ over $S_{i'}$
for any $i' \geq i$ and we may base change the diagram to a diagram
with morphisms $(S', s') \to (S, s)$ and $g : X' \to X$ over $S$.

\medskip\noindent
At this point we can use our criterion for purity.
Set $W'_i \subset X_i \times_{S_i} S'_i$ equal to the image of the
\'etale morphism $X'_i \to X_i \times_{S_i} S'_i$. For every $i' \geq i$
we have similarly the image $W'_{i'} \subset X_{i'} \times_{S_{i'}} S'_{i'}$
and we have the image $W' \subset X \times_S S'$. Taking images commutes
with base change, hence $W'_{i'} = W'_i \times_{S'_i} S'_{i'}$ and
$W' = W_i \times_{S'_i} S'$. Because
$\mathcal{F}$ is pure along $X_s$ the
Lemma \ref{lemma-criterion}
implies that
\begin{equation}
\label{equation-inclusion}
f^{-1}(\Spec(\mathcal{O}_{S', s'})) \cap
\text{Ass}_{X \times_S S'/S'}(\mathcal{F} \times_S S') \subset W'
\end{equation}
By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-relative-assassin-constructible}
we see that
$$
E = \{t \in S' \mid \text{Ass}_{X_t}(\mathcal{F}_t) \subset W' \}
\quad\text{and}\quad
E_{i'} = \{t \in S'_{i'} \mid
\text{Ass}_{X_t}(\mathcal{F}_{i', t}) \subset W'_{i'} \}
$$
are locally constructible subsets of $S'$ and $S'_{i'}$. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-base-change-assassin-in-U}
we see that $E_{i'}$ is the inverse image of $E_i$ under the morphism
$S'_{i'} \to S'_i$ and that $E$ is the inverse image of $E_i$ under
the morphism $S' \to S'_i$. Thus
Equation (\ref{equation-inclusion})
is equivalent to the assertion that
$\Spec(\mathcal{O}_{S', s'})$ maps into $E_i$. As
$\mathcal{O}_{S', s'} =
\colim_{i' \geq i} \mathcal{O}_{S'_{i'}, s'_{i'}}$
we see that $\Spec(\mathcal{O}_{S'_{i'}, s'_{i'}})$
maps into $E_i$ for some $i' \geq i$, see
Limits, Lemma \ref{limits-lemma-limit-contained-in-constructible}.
Then, applying
Lemma \ref{lemma-criterion}
to the situation over $S_{i'}$,
we conclude that $\mathcal{F}_{i'}$ is pure along $(X_{i'})_{s_{i'}}$.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-purity-open}
Let $f : X \to S$ be a morphism of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
of finite presentation flat over $S$. Then the set
$$
U = \{s \in S \mid \mathcal{F}\text{ is pure along }X_s\}
$$
is open in $S$.
\end{lemma}

\begin{proof}
Let $s \in U$. Using
Lemma \ref{lemma-finite-presentation-flat-along-fibre}
we can find an elementary \'etale neighbourhood
$(S', s') \to (S, s)$ and a commutative diagram
$$
\xymatrix{
X \ar[d] & X' \ar[l]^g \ar[d] \\
S & S' \ar[l]
}
$$
such that $g$ is \'etale, $X_s \subset g(X')$, the schemes
$X'$, $S'$ are affine, and such that $\Gamma(X', g^*\mathcal{F})$
is a projective $\Gamma(S', \mathcal{O}_{S'})$-module.
Note that $g^*\mathcal{F}$ is universally pure over $S'$, see
Lemma \ref{lemma-affine-locally-projective-pure}.
Set $W' \subset X \times_S S'$ equal to the image of the \'etale morphism
$X' \to X \times_S S'$. Note that $W$ is open and quasi-compact over
$S'$. Set
$$
E = \{t \in S' \mid \text{Ass}_{X_t}(\mathcal{F}_t) \subset W' \}.
$$
By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-relative-assassin-constructible}
$E$ is a constructible subset of $S'$. By
Lemma \ref{lemma-criterion}
we see that $\Spec(\mathcal{O}_{S', s'}) \subset E$.
By
Morphisms, Lemma \ref{morphisms-lemma-constructible-containing-open}
we see that $E$ contains an open neighbourhood $V'$ of $s'$.
Applying
Lemma \ref{lemma-criterion}
once more we see that for any point $s_1$ in the image of $V'$ in $S$
the sheaf $\mathcal{F}$ is pure along $X_{s_1}$. Since
$S' \to S$ is \'etale the image of $V'$ in $S$ is open and we win.
\end{proof}


\section{How purity is used}
\label{section-applications-purity}

\noindent
Here are some examples of how purity can be used. The first lemma
actually uses a slightly weaker form of purity.

\begin{lemma}
\label{lemma-injectivity-map-source-flat-pure}
Let $f : X \to S$ be a morphism of finite type.
Let $\mathcal{F}$ be a quasi-coherent sheaf of finite type on $X$.
Assume $S$ is local with closed point $s$.
Assume $\mathcal{F}$ is pure along $X_s$ and
that $\mathcal{F}$ is flat over $S$.
Let $\varphi : \mathcal{F} \to \mathcal{G}$ of quasi-coherent
$\mathcal{O}_X$-modules. Then the following are equivalent
\begin{enumerate}
\item the map on stalks $\varphi_x$ is injective for all
$x \in \text{Ass}_{X_s}(\mathcal{F}_s)$, and
\item $\varphi$ is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathcal{K} = \Ker(\varphi)$. Our goal is to prove that
$\mathcal{K} = 0$. In order to do this it suffices to prove that
$\text{WeakAss}_X(\mathcal{K}) = \emptyset$, see
Divisors, Lemma \ref{divisors-lemma-weakly-ass-zero}.
We have
$\text{WeakAss}_X(\mathcal{K}) \subset \text{WeakAss}_X(\mathcal{F})$, see
Divisors, Lemma \ref{divisors-lemma-ses-weakly-ass}.
As $\mathcal{F}$ is flat we see from
Lemma \ref{lemma-bourbaki-finite-type-general-base}
that $\text{WeakAss}_X(\mathcal{F}) \subset \text{Ass}_{X/S}(\mathcal{F})$.
By purity any point $x'$ of $\text{Ass}_{X/S}(\mathcal{F})$
is a generalization of a point of $X_s$, and hence is the
specialization of a point $x \in \text{Ass}_{X_s}(\mathcal{F}_s)$, by
Lemma \ref{lemma-associated-point-specializes}.
Hence the injectivity of $\varphi_x$ implies the injectivity of
$\varphi_{x'}$, whence $\mathcal{K}_{x'} = 0$.
\end{proof}

\begin{proposition}
\label{proposition-finite-presentation-flat-pure-is-projective}
Let $f : X \to S$ be an affine, finitely presented morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of
finite presentation, flat over $S$. Then the following
are equivalent
\begin{enumerate}
\item $f_*\mathcal{F}$ is locally projective on $S$, and
\item $\mathcal{F}$ is pure relative to $S$.
\end{enumerate}
In particular, given a ring map $A \to B$ of finite presentation and
a finitely presented $B$-module $N$ flat over $A$ we have:
$N$ is projective as an $A$-module if and only if $\widetilde{N}$
on $\Spec(B)$ is pure relative to $\Spec(A)$.
\end{proposition}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is
Lemma \ref{lemma-affine-locally-projective-pure}.
Assume $\mathcal{F}$ is pure relative to $S$.
Note that by
Lemma \ref{lemma-finite-type-flat-pure-along-fibre-is-universal}
this implies $\mathcal{F}$ remains pure after any base change. By
Descent, Lemma \ref{descent-lemma-locally-projective-descends}
it suffices to prove $f_*\mathcal{F}$ is fpqc locally projective on $S$.
Pick $s \in S$. We will prove that the restriction of
$f_*\mathcal{F}$ to an \'etale neighbourhood of $s$ is locally projective.
Namely, by
Lemma \ref{lemma-finite-presentation-flat-along-fibre},
after replacing $S$ by an affine elementary \'etale
neighbourhood of $s$, we may assume there exists a diagram
$$
\xymatrix{
X \ar[dr] & & X' \ar[ll]^g \ar[ld] \\
& S &
}
$$
of schemes affine and of finite presentation over $S$,
where $g$ is \'etale, $X_s \subset g(X')$, and with
$\Gamma(X', g^*\mathcal{F})$ a projective $\Gamma(S, \mathcal{O}_S)$-module.
Note that in this case $g^*\mathcal{F}$ is universally pure over $S$, see
Lemma \ref{lemma-affine-locally-projective-pure}.
Hence by
Lemma \ref{lemma-criterion}
we see that the open $g(X')$ contains the points of
$\text{Ass}_{X/S}(\mathcal{F})$ lying over $\Spec(\mathcal{O}_{S, s})$.
Set
$$
E = \{t \in S \mid \text{Ass}_{X_t}(\mathcal{F}_t) \subset g(X') \}.
$$
By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-relative-assassin-constructible}
$E$ is a constructible subset of $S$. We have seen that
$\Spec(\mathcal{O}_{S, s}) \subset E$. By
Morphisms, Lemma \ref{morphisms-lemma-constructible-containing-open}
we see that $E$ contains an open neighbourhood of $s$. Hence after
replacing $S$ by an affine neighbourhood of $s$ we may assume that
$\text{Ass}_{X/S}(\mathcal{F}) \subset g(X')$.
By
Lemma \ref{lemma-base-change-universally-flat}
this means that
$$
\Gamma(X, \mathcal{F}) \longrightarrow \Gamma(X', g^*\mathcal{F})
$$
is $\Gamma(S, \mathcal{O}_S)$-universally injective.
By Algebra, Lemma \ref{algebra-lemma-pure-submodule-ML}
we conclude that $\Gamma(X, \mathcal{F})$ is Mittag-Leffler as an
$\Gamma(S, \mathcal{O}_S)$-module. Since
$\Gamma(X, \mathcal{F})$ is countably generated and flat as a
$\Gamma(S, \mathcal{O}_S)$-module, we conclude
it is projective by
Algebra, Lemma \ref{algebra-lemma-countgen-projective}.
\end{proof}

\noindent
We can use the proposition to improve some of our earlier results.
The following lemma is an improvement of
Proposition \ref{proposition-finite-presentation-flat-at-point}.

\begin{lemma}
\label{lemma-flat-finite-presentation-affine-neighbourhood-projective}
Let $f : X \to S$ be a morphism which is locally of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module which is
of finite presentation. Let $x \in X$ with $s = f(x) \in S$.
If $\mathcal{F}$ is flat at $x$ over $S$ there exists an affine
elementary \'etale neighbourhood $(S', s') \to (S, s)$ and
an affine open $U' \subset X \times_S S'$ which contains $x' = (x, s')$
such that $\Gamma(U', \mathcal{F}|_{U'})$ is a projective
$\Gamma(S', \mathcal{O}_{S'})$-module.
\end{lemma}

\begin{proof}
During the proof we may replace $X$ by an open neighbourhood of $x$
and we may replace $S$ by an elementary \'etale neighbourhood of $s$.
Hence, by openness of flatness (see
More on Morphisms, Theorem \ref{more-morphisms-theorem-openness-flatness})
we may assume that $\mathcal{F}$ is flat over $S$.
We may assume $S$ and $X$ are affine.
After shrinking $X$ some more we may assume that any
point of $\text{Ass}_{X_s}(\mathcal{F}_s)$ is a generalization of $x$.
This property is preserved on replacing $(S, s)$ by an elementary
\'etale neighbourhood. Hence we may apply
Lemma \ref{lemma-finite-presentation-flat-along-fibre}
to arrive at the situation where there exists a diagram
$$
\xymatrix{
X \ar[dr] & & X' \ar[ll]^g \ar[ld] \\
& S &
}
$$
of schemes affine and of finite presentation over $S$,
where $g$ is \'etale, $X_s \subset g(X')$, and with
$\Gamma(X', g^*\mathcal{F})$ a projective $\Gamma(S, \mathcal{O}_S)$-module.
Note that in this case $g^*\mathcal{F}$ is universally pure over $S$, see
Lemma \ref{lemma-affine-locally-projective-pure}.

\medskip\noindent
Let $U \subset g(X')$ be an affine open neighbourhood of $x$.
We claim that $\mathcal{F}|_U$ is pure along $U_s$. If we prove this, then
the lemma follows because $\mathcal{F}|_U$ will be pure relative to $S$
after shrinking $S$, see
Lemma \ref{lemma-flat-finite-presentation-purity-open},
whereupon the projectivity follows from
Proposition \ref{proposition-finite-presentation-flat-pure-is-projective}.
To prove the claim we have to show, after replacing $(S, s)$
by an arbitrary elementary \'etale neighbourhood, that any point $\xi$ of
$\text{Ass}_{U/S}(\mathcal{F}|_U)$ lying over some
$s' \in S$, $s' \leadsto s$ specializes to a point of $U_s$.
Since $U \subset g(X')$ we can find a $\xi' \in X'$ with
$g(\xi') = \xi$. Because $g^*\mathcal{F}$ is pure over $S$, using
Lemma \ref{lemma-associated-point-specializes},
we see there exists a specialization $\xi' \leadsto x'$ with
$x' \in \text{Ass}_{X'_s}(g^*\mathcal{F}_s)$. Then
$g(x') \in \text{Ass}_{X_s}(\mathcal{F}_s)$ (see for example
Lemma \ref{lemma-etale-weak-assassin-up-down}
applied to the \'etale morphism $X'_s \to X_s$ of Noetherian schemes)
and hence $g(x') \leadsto x$ by our choice of $X$ above! Since
$x \in U$ we conclude that $g(x') \in U$. Thus
$\xi = g(\xi') \leadsto g(x') \in U_s$ as desired.
\end{proof}

\noindent
The following lemma is an improvement of
Lemma \ref{lemma-finite-type-flat-at-point-free-variant}.

\begin{lemma}
\label{lemma-flat-finite-type-affine-neighbourhood-projective}
Let $f : X \to S$ be a morphism which is locally of finite type.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module which is
of finite type. Let $x \in X$ with $s = f(x) \in S$.
If $\mathcal{F}$ is flat at $x$ over $S$ there exists an affine
elementary \'etale neighbourhood $(S', s') \to (S, s)$ and
an affine open $U' \subset X \times_S \Spec(\mathcal{O}_{S', s'})$
which contains $x' = (x, s')$ such that
$\Gamma(U', \mathcal{F}|_{U'})$ is a free
$\mathcal{O}_{S', s'}$-module.
\end{lemma}

\begin{proof}
The question is Zariski local on $X$ and $S$. Hence we may assume
that $X$ and $S$ are affine. Then we can find a closed immersion
$i : X \to \mathbf{A}^n_S$ over $S$. It is clear that it suffices to
prove the lemma for the sheaf $i_*\mathcal{F}$ on $\mathbf{A}^n_S$
and the point $i(x)$. In this way we reduce to the case where $X \to S$ is
of finite presentation. After replacing $S$ by
$\Spec(\mathcal{O}_{S', s'})$ and $X$ by an open of
$X \times_S \Spec(\mathcal{O}_{S', s'})$ we may assume that
$\mathcal{F}$ is of finite presentation, see
Proposition \ref{proposition-finite-type-flat-at-point}.
In this case we may appeal to
Lemma \ref{lemma-flat-finite-presentation-affine-neighbourhood-projective}
and
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-type-local-colimit-free}
Let $A \to B$ be a local ring map of local rings which is essentially of
finite type. Let $N$ be a finite $B$-module which is flat as an $A$-module.
If $A$ is henselian, then $N$ is a filtered colimit
$$
N = \colim_i F_i
$$
of free $A$-modules $F_i$ such that all transition maps
$u_i : F_i \to F_{i'}$ of the system induce injective maps
$\overline{u}_i : F_i/\mathfrak m_AF_i \to F_{i'}/\mathfrak m_AF_{i'}$.
Also, $N$ is a Mittag-Leffler $A$-module.
\end{lemma}

\begin{proof}
We can find a morphism of finite type $X \to S = \Spec(A)$
and a point $x \in X$ lying over the closed point $s$ of $S$ and a finite
type quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ such that
$\mathcal{F}_x \cong N$ as an $A$-module. After shrinking $X$
we may assume that each point of $\text{Ass}_{X_s}(\mathcal{F}_s)$ specializes
to $x$. By
Lemma \ref{lemma-flat-finite-type-affine-neighbourhood-projective}
we see that there exists a fundamental system of affine open neighbourhoods
$U_i \subset X$ of $x$ such that $\Gamma(U_i, \mathcal{F})$ is
a free $A$-module $F_i$. Note that if $U_{i'} \subset U_i$, then
$$
F_i/\mathfrak m_AF_i = \Gamma(U_{i, s}, \mathcal{F}_s)
\longrightarrow
\Gamma(U_{i', s}, \mathcal{F}_s) = F_{i'}/\mathfrak m_AF_{i'}
$$
is injective because a section of the kernel would be supported at
a closed subset of $X_s$ not meeting $x$ which is a contradiction
to our choice of $X$ above. Since the maps $F_i \to F_{i'}$ are
$A$-universally injective (Lemma \ref{lemma-universally-injective-local})
it follows that $N$ is
Mittag-Leffler by
Algebra, Lemma \ref{algebra-lemma-colimit-universally-injective-ML}.
\end{proof}

\noindent
The following lemma should be skipped if reading through for the first time.

\begin{lemma}
\label{lemma-flat-finite-type-local-valuation-ring-has-content}
Let $A \to B$ be a local ring map of local rings which is essentially of
finite type. Let $N$ be a finite $B$-module which is flat as an $A$-module.
If $A$ is a valuation ring, then any element of $N$ has a content ideal
$I \subset A$ (More on Algebra, Definition
\ref{more-algebra-definition-content-ideal}).
\end{lemma}

\begin{proof}
Let $A \subset A^h$ be the henselization. Let $B'$ be the localization
of $B \otimes_A A^h$ at the maximal ideal
$\mathfrak m_B \otimes A^h + B \otimes \mathfrak m_{A^h}$.
Then $B \to B'$ is flat, hence faithfully flat.
Let $N' = N \otimes_B B'$.
Let $x \in N$ and let $x' \in N'$ be the image.
We claim that for an ideal $I \subset A$ we have
$x \in IN \Leftrightarrow x' \in IN'$.
Namely, $N/IN \to N'/IN'$ is the tensor product of $B \to B'$
with $N/IN$ and $B \to B'$ is universally injective by
Algebra, Lemma \ref{algebra-lemma-faithfully-flat-universally-injective}.
By More on Algebra, Lemma \ref{more-algebra-lemma-henselization-valuation-ring}
and Algebra, Lemma \ref{algebra-lemma-ideals-valuation-ring}
the map $A \to A^h$ defines an inclusion preserving
bijection $I \mapsto IA^h$ on sets of ideals. We conclude that
$x$ has a content ideal in $A$ if and only if $x'$ has a content
ideal in $A^h$. The assertion for $x' \in N'$ follows from
Lemma \ref{lemma-flat-finite-type-local-colimit-free} and
Algebra, Lemma \ref{algebra-lemma-minimal-contains}.
\end{proof}





\section{Flattening functors}
\label{section-flattening-functors}

\noindent
Let $S$ be a scheme. Recall that a functor
$F : (\Sch/S)^{opp} \to \textit{Sets}$ is called limit preserving
if for every directed inverse system
$\{T_i\}_{i \in I}$ of affine schemes with limit $T$ we have
$F(T) = \colim_i F(T_i)$.

\begin{situation}
\label{situation-iso}
Let $f : X \to S$ be a morphism of schemes.
Let $u : \mathcal{F} \to \mathcal{G}$ be a homomorphism of
quasi-coherent $\mathcal{O}_X$-modules. For any scheme $T$ over
$S$ we will denote $u_T : \mathcal{F}_T \to \mathcal{G}_T$ the
base change of $u$ to $T$, in other words, $u_T$ is the pullback
of $u$ via the projection morphism $X_T = X \times_S T \to X$.
In this situation we can consider the functor
\begin{equation}
\label{equation-iso}
F_{iso} : (\Sch/S)^{opp} \longrightarrow \textit{Sets}, \quad
T \longrightarrow \left\{
\begin{matrix}
\{*\} & \text{if} & u_T \text{ is an isomorphism}, \\
\emptyset & \text{else.} &
\end{matrix}
\right.
\end{equation}
There are variants $F_{inj}$, $F_{surj}$, $F_{zero}$ where we ask that
$u_T$ is injective, surjective, or zero.
\end{situation}

\begin{lemma}
\label{lemma-iso-sheaf}
In Situation \ref{situation-iso}.
\begin{enumerate}
\item Each of the functors $F_{iso}$, $F_{inj}$, $F_{surj}$, $F_{zero}$
satisfies the sheaf property for the fpqc topology.
\item If $f$ is quasi-compact and $\mathcal{G}$ is of finite type,
then $F_{surj}$ is limit preserving.
\item If $f$ is quasi-compact and $\mathcal{F}$ of finite type, then
$F_{zero}$ is limit preserving.
\item If $f$ is quasi-compact, $\mathcal{F}$ is of finite type, and
$\mathcal{G}$ is of finite presentation, then $F_{iso}$ is limit preserving.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\{T_i \to T\}_{i \in I}$ be an fpqc covering of schemes over $S$.
Set $X_i = X_{T_i} = X \times_S T_i$ and $u_i = u_{T_i}$.
Note that $\{X_i \to X_T\}_{i \in I}$ is an fpqc covering of $X_T$, see
Topologies, Lemma \ref{topologies-lemma-fpqc}.
In particular, for every $x \in X_T$ there exists an $i \in I$
and an $x_i \in X_i$ mapping to $x$. Since
$\mathcal{O}_{X_T, x} \to \mathcal{O}_{X_i, x_i}$ is flat, hence
faithfully flat (see
Algebra, Lemma \ref{algebra-lemma-local-flat-ff})
we conclude that $(u_i)_{x_i}$ is injective, surjective, bijective, or zero
if and only if $(u_T)_x$ is injective, surjective, bijective, or zero.
Whence part (1) of the lemma.

\medskip\noindent
Proof of (2). Assume $f$ quasi-compact and $\mathcal{G}$ of finite type.
Let $T = \lim_{i \in I} T_i$ be a directed limit of affine $S$-schemes
and assume that $u_T$ is surjective.
Set $X_i = X_{T_i} = X \times_S T_i$ and
$u_i = u_{T_i} : \mathcal{F}_i = \mathcal{F}_{T_i}
\to \mathcal{G}_i = \mathcal{G}_{T_i}$.
To prove part (2) we have to show that $u_i$ is surjective for some $i$.
Pick $i_0 \in I$ and replace $I$ by $\{i \mid i \geq i_0\}$.
Since $f$ is quasi-compact the scheme $X_{i_0}$ is quasi-compact.
Hence we may choose affine opens $W_1, \ldots, W_m \subset X$
and an affine open covering
$X_{i_0} = U_{1, i_0} \cup \ldots \cup U_{m, i_0}$ such that
$U_{j, i_0}$ maps into $W_j$ under the projection morphism $X_{i_0} \to X$.
For any $i \in I$ let $U_{j, i}$ be the inverse image of $U_{j, i_0}$.
Setting $U_j = \lim_i U_{j, i}$ we see that $X_T = U_1 \cup \ldots \cup U_m$
is an affine open covering of $X_T$. Now it suffices to show, for a given
$j \in \{1, \ldots, m\}$ that $u_i|_{U_{j, i}}$ is surjective for some
$i = i(j) \in I$. Using
Properties, Lemma \ref{properties-lemma-finite-type-module}
this translates into the following algebra problem:
Let $A$ be a ring and let $u : M \to N$ be an $A$-module map.
Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit
of $A$-algebras. If $N$ is a finite $A$-module and if
$u \otimes 1 : M \otimes_A R \to N \otimes_A R$ is surjective, then
for some $i$ the map
$u \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$ is surjective.
This is
Algebra, Lemma \ref{algebra-lemma-module-map-property-in-colimit} part (2).

\medskip\noindent
Proof of (3). Exactly the same arguments as given in the proof of (2)
reduces this to the following algebra problem:
Let $A$ be a ring and let $u : M \to N$ be an $A$-module map.
Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit
of $A$-algebras. If $M$ is a finite $A$-module and if
$u \otimes 1 : M \otimes_A R \to N \otimes_A R$ is zero, then
for some $i$ the map
$u \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$ is zero.
This is
Algebra, Lemma \ref{algebra-lemma-module-map-property-in-colimit} part (1).

\medskip\noindent
Proof of (4).
Assume $f$ quasi-compact and $\mathcal{F}, \mathcal{G}$ of finite presentation.
Arguing in exactly the same manner as in the previous paragraph
(using in addition also
Properties, Lemma \ref{properties-lemma-finite-presentation-module})
part (3) translates into the following algebra statement:
Let $A$ be a ring and let $u : M \to N$ be an $A$-module map.
Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit
of $A$-algebras. Assume $M$ is a finite $A$-module, $N$ is a finitely
presented $A$-module, and
$u \otimes 1 : M \otimes_A R \to N \otimes_A R$ is an isomorphism.
Then for some $i$ the map
$u \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$ is an isomorphism.
This is
Algebra, Lemma \ref{algebra-lemma-module-map-property-in-colimit} part (3).
\end{proof}

\begin{situation}
\label{situation-flat-at-point}
Let $(A, \mathfrak m_A)$ be a local ring.
Denote $\mathcal{C}$ the category whose objects are $A$-algebras
$A'$ which are local rings such that the algebra structure
$A \to A'$ is a local homomorphism of local rings.
A morphism between objects $A', A''$ of $\mathcal{C}$ is a
local homomorphism $A' \to A''$ of $A$-algebras.
Let $A \to B$ be a local ring map of local rings and let $M$ be a $B$-module.
If $A'$ is an object of $\mathcal{C}$ we set $B' = B \otimes_A A'$
and we set $M' = M \otimes_A A'$ as a $B'$-module.
Given $A' \in \Ob(\mathcal{C})$, consider the condition
\begin{equation}
\label{equation-flat-at-primes}
\forall \mathfrak q \in V(\mathfrak m_{A'}B' + \mathfrak m_B B')
\subset \Spec(B') :
M'_{\mathfrak q}\text{ is flat over }A'.
\end{equation}
Note the similarity with
More on Algebra, Equation (\ref{more-algebra-equation-flat-at-primes}).
In particular, if $A' \to A''$ is a morphism of $\mathcal{C}$ and
(\ref{equation-flat-at-primes}) holds for $A'$, then it holds for $A''$, see
More on Algebra,
Lemma \ref{more-algebra-lemma-base-change-flat-at-primes}.
Hence we obtain a functor
\begin{equation}
\label{equation-flat-at-point}
F_{lf} : \mathcal{C} \longrightarrow \textit{Sets}, \quad
A' \longrightarrow \left\{
\begin{matrix}
\{*\} & \text{if }(\ref{equation-flat-at-primes})\text{ holds}, \\
\emptyset & \text{else.} &
\end{matrix}
\right.
\end{equation}
\end{situation}

\begin{lemma}
\label{lemma-flat-at-point}
In Situation \ref{situation-flat-at-point}.
\begin{enumerate}
\item If $A' \to A''$ is a flat morphism in $\mathcal{C}$
then $F_{fl}(A') = F_{lf}(A'')$.
\item If $A \to B$ is essentially of finite presentation and
$M$ is a $B$-module of finite presentation, then $F_{fl}$ is limit
preserving: If $\{A_i\}_{i \in I}$ is a
directed system of objects of $\mathcal{C}$, then
$F_{fl}(\colim_i A_i) = \colim_i F_{fl}(A_i)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is a special case of
More on Algebra,
Lemma \ref{more-algebra-lemma-flat-descent-flat-at-primes}.
Part (2) is a special case of
More on Algebra,
Lemma \ref{more-algebra-lemma-limit-preserving-flat-at-primes}.
\end{proof}

\begin{lemma}
\label{lemma-flat-at-point-finite}
In
Situation \ref{situation-flat-at-point}
suppose that $B \to C$ is a local map of local $A$-algebras
and that $M \cong N$ as $B$-modules.
Denote $F'_{lf} : \mathcal{C} \to \textit{Sets}$ the
functor associated to the pair $(C, N)$.
If $B \to C$ is finite, then $F_{lf} = F'_{lf}$.
\end{lemma}

\begin{proof}
Let $A'$ be an object of $\mathcal{C}$. Set $C' = C \otimes_A A'$
and $N' = N \otimes_A A'$ similarly to the definitions of $B'$, $M'$ in
Situation \ref{situation-flat-at-point}.
Note that $M' \cong N'$ as $B'$-modules.
The assumption that $B \to C$ is finite has two consequences:
(a) $\mathfrak m_C = \sqrt{\mathfrak m_B C}$ and (b)
$B' \to C'$ is finite. Consequence (a) implies that
$$
V(\mathfrak m_{A'}C' + \mathfrak m_C C')
=
\left(
\Spec(C') \to \Spec(B')
\right)^{-1}V(\mathfrak m_{A'}B' + \mathfrak m_B B').
$$
Suppose $\mathfrak q \subset V(\mathfrak m_{A'}B' + \mathfrak m_B B')$.
Then $M'_{\mathfrak q}$ is flat over $A'$ if and only if
the $C'_{\mathfrak q}$-module $N'_{\mathfrak q}$ is flat over $A'$
(because these are isomorphic as $A'$-modules) if and only if
for every maximal ideal $\mathfrak r$ of $C'_{\mathfrak q}$
the module $N'_{\mathfrak r}$ is flat over $A'$ (see
Algebra, Lemma \ref{algebra-lemma-flat-localization}).
As $B'_{\mathfrak q} \to C'_{\mathfrak q}$ is finite by (b),
the maximal ideals of $C'_{\mathfrak q}$ correspond exactly
to the primes of $C'$ lying over $\mathfrak q$ (see
Algebra, Lemma \ref{algebra-lemma-integral-going-up})
and these primes are all contained in
$V(\mathfrak m_{A'}C' + \mathfrak m_C C')$ by
the displayed equation above. Thus the result of the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-flat-at-point-go-up}
In
Situation \ref{situation-flat-at-point}
suppose that $B \to C$ is a flat local homomorphism of local
rings. Set $N = M \otimes_B C$. Denote
$F'_{lf} : \mathcal{C} \to \textit{Sets}$ the functor associated
to the pair $(C, N)$. Then $F_{lf} = F'_{lf}$.
\end{lemma}

\begin{proof}
Let $A'$ be an object of $\mathcal{C}$. Set $C' = C \otimes_A A'$
and $N' = N \otimes_A A' = M' \otimes_{B'} C'$ similarly to the definitions
of $B'$, $M'$ in
Situation \ref{situation-flat-at-point}. Note that
$$
V(\mathfrak m_{A'}B' + \mathfrak m_B B')
=
\Spec( \kappa(\mathfrak m_B) \otimes_A \kappa(\mathfrak m_{A'}) )
$$
and similarly for $V(\mathfrak m_{A'}C' + \mathfrak m_C C')$.
The ring map
$$
\kappa(\mathfrak m_B) \otimes_A \kappa(\mathfrak m_{A'})
\longrightarrow
\kappa(\mathfrak m_C) \otimes_A \kappa(\mathfrak m_{A'})
$$
is faithfully flat, hence
$V(\mathfrak m_{A'}C' + \mathfrak m_C C') \to
V(\mathfrak m_{A'}B' + \mathfrak m_B B')$ is surjective.
Finally, if $\mathfrak r \in V(\mathfrak m_{A'}C' + \mathfrak m_C C')$
maps to $\mathfrak q \in V(\mathfrak m_{A'}B' + \mathfrak m_B B')$, then
$M'_{\mathfrak q}$ is flat over $A'$ if and only if
$N'_{\mathfrak r}$ is flat over $A'$ because $B' \to C'$ is flat, see
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}.
The lemma follows formally from these remarks.
\end{proof}

\begin{situation}
\label{situation-free-at-generic-points}
Let $f : X \to S$ be a smooth morphism with geometrically irreducible
fibres. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of
finite type. For any scheme $T$ over $S$ we will denote
$\mathcal{F}_T$ the base change of $\mathcal{F}$ to $T$, in other
words, $\mathcal{F}_T$ is the pullback of $\mathcal{F}$ via the
projection morphism $X_T = X \times_S T \to X$. Note that $X_T \to T$
is smooth with geometrically irreducible fibres, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-smooth} and
More on Morphisms,
Lemma \ref{more-morphisms-lemma-base-change-fibres-geometrically-irreducible}.
Let $p \geq 0$ be an integer. Given a point $t \in T$ consider the
condition
\begin{equation}
\label{equation-free-at-generic-point-fibre}
\mathcal{F}_T \text{ is free of rank }p\text{ in a neighbourhood of }\xi_t
\end{equation}
where $\xi_t$ is the generic point of the fibre $X_t$. This condition
for all $t \in T$ is stable under base change, and hence we obtain a functor
\begin{equation}
\label{equation-free-at-generic-points}
H_p : (\Sch/S)^{opp} \longrightarrow \textit{Sets}, \quad
T \longrightarrow \left\{
\begin{matrix}
\{*\} & \text{if }\mathcal{F}_T\text{ satisfies
(\ref{equation-free-at-generic-point-fibre}) }\forall t\in T, \\
\emptyset & \text{else.}
\end{matrix}
\right.
\end{equation}
\end{situation}

\begin{lemma}
\label{lemma-free-at-generic-points}
In Situation \ref{situation-free-at-generic-points}.
\begin{enumerate}
\item The functor $H_p$ satisfies the sheaf property for the fpqc topology.
\item If $\mathcal{F}$ is of finite presentation, then functor $H_p$ is
limit preserving.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\{T_i \to T\}_{i \in I}$ be an fpqc\footnote{It is quite easy to
show that $H_p$
is a sheaf for the fppf topology using that flat morphisms of finite
presentation are open. This is all we really need later on. But it is kind
of fun to prove directly that it also satisfies the sheaf condition
for the fpqc topology.} covering of schemes over $S$.
Set $X_i = X_{T_i} = X \times_S T_i$ and denote $\mathcal{F}_i$ the
pullback of $\mathcal{F}$ to $X_i$. Assume that $\mathcal{F}_i$ satisfies
(\ref{equation-free-at-generic-point-fibre}) for all $i$.
Pick $t \in T$ and let $\xi_t \in X_T$ denote the generic point of $X_t$.
We have to show that $\mathcal{F}$ is free in a neighbourhood of $\xi_t$.
For some $i \in I$ we can find a $t_i \in T_i$ mapping to $t$.
Let $\xi_i \in X_i$ denote the generic point of $X_{t_i}$, so that
$\xi_i$ maps to $\xi_t$. The fact that $\mathcal{F}_i$ is free of rank
$p$ in a neighbourhood of $\xi_i$ implies that
$(\mathcal{F}_i)_{x_i} \cong \mathcal{O}_{X_i, x_i}^{\oplus p}$
which implies that
$\mathcal{F}_{T, \xi_t} \cong \mathcal{O}_{X_T, \xi_t}^{\oplus p}$
as $\mathcal{O}_{X_T, \xi_t} \to \mathcal{O}_{X_i, x_i}$ is flat, see
for example
Algebra, Lemma \ref{algebra-lemma-finite-projective-descends}.
Thus there exists an affine neighbourhood $U$ of $\xi_t$ in $X_T$
and a surjection
$\mathcal{O}_U^{\oplus p} \to \mathcal{F}_U = \mathcal{F}_T|_U$, see
Modules, Lemma \ref{modules-lemma-finite-type-surjective-on-stalk}.
After shrinking $T$ we may assume that $U \to T$ is surjective. Hence
$U \to T$ is a smooth morphism of affines with geometrically irreducible
fibres. Moreover, for every $t' \in T$ we see that the induced map
$$
\alpha :
\mathcal{O}_{U, \xi_{t'}}^{\oplus p}
\longrightarrow
\mathcal{F}_{U, \xi_{t'}}
$$
is an isomorphism (since by the same argument as before the module on the right
is free of rank $p$). It follows from
Lemma \ref{lemma-induction-step}
that
$$
\Gamma(U, \mathcal{O}_U^{\oplus p})
\otimes_{\Gamma(T, \mathcal{O}_T)} \mathcal{O}_{T, t'}
\longrightarrow
\Gamma(U, \mathcal{F}_U)
\otimes_{\Gamma(T, \mathcal{O}_T)} \mathcal{O}_{T, t'}
$$
is injective for every $t' \in T$. Hence we see the surjection $\alpha$ is an
isomorphism. This finishes the proof of (1).

\medskip\noindent
Assume that $\mathcal{F}$ is of finite presentation.
Let $T = \lim_{i \in I} T_i$ be a directed limit of affine $S$-schemes
and assume that $\mathcal{F}_T$ satisfies
(\ref{equation-free-at-generic-point-fibre}).
Set $X_i = X_{T_i} = X \times_S T_i$ and denote $\mathcal{F}_i$ the
pullback of $\mathcal{F}$ to $X_i$.
Let $U \subset X_T$ denote the open subscheme of points where
$\mathcal{F}_T$ is flat over $T$, see
More on Morphisms, Theorem \ref{more-morphisms-theorem-openness-flatness}.
By assumption every generic point of every fibre is a point of $U$, i.e.,
$U \to T$ is a smooth surjective morphism with geometrically irreducible
fibres. We may shrink $U$ a bit and assume that $U$ is quasi-compact.
Using
Limits, Lemma \ref{limits-lemma-descend-opens}
we can find an $i \in I$ and a quasi-compact open $U_i \subset X_i$
whose inverse image in $X_T$ is $U$. After increasing $i$ we may
assume that $\mathcal{F}_i|_{U_i}$ is flat over $T_i$, see
Limits, Lemma \ref{limits-lemma-descend-module-flat-finite-presentation}.
In particular, $\mathcal{F}_i|_{U_i}$ is finite locally free
hence defines a locally constant
rank function $\rho : U_i \to \{0, 1, 2, \ldots \}$.
Let $(U_i)_p \subset U_i$ denote the open and closed
subset where $\rho$ has value $p$. Let $V_i \subset T_i$ be the
image of $(U_i)_p$; note that $V_i$ is open and quasi-compact.
By assumption the image of $T \to T_i$ is contained in $V_i$.
Hence there exists an $i' \geq i$ such that $T_{i'} \to T_i$ factors
through $V_i$ by
Limits, Lemma \ref{limits-lemma-descend-opens}.
Then $\mathcal{F}_{i'}$ satisfies (\ref{equation-free-at-generic-point-fibre})
as desired. Some details omitted.
\end{proof}

\begin{situation}
\label{situation-flat-dimension-n}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite
type. For any scheme $T$ over $S$ we will denote $\mathcal{F}_T$ the
base change of $\mathcal{F}$ to $T$, in other words, $\mathcal{F}_T$
is the pullback of $\mathcal{F}$ via the projection morphism
$X_T = X \times_S T \to X$. Note that $X_T \to T$ is of finite type
and that $\mathcal{F}_T$ is an $\mathcal{O}_{X_T}$-module
of finite type, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-type} and
Modules, Lemma \ref{modules-lemma-pullback-finite-type}.
Let $n \geq 0$. We say that
{\it $\mathcal{F}_T$ is flat over $T$ in dimensions $\geq n$}
if for every $t \in T$ the closed subset $Z \subset X_t$ of points
where $\mathcal{F}_T$ is not flat over $T$ (see
Lemma \ref{lemma-open-in-fibre-where-flat})
satisfies $\dim(Z) < n$ for all $t \in T$. Note that if this is the
case, and if $T' \to T$ is a morphism, then $\mathcal{F}_{T'}$ is also
flat in dimensions $\geq n$ over $T'$, see
Morphisms, Lemmas \ref{morphisms-lemma-base-change-module-flat} and
\ref{morphisms-lemma-dimension-fibre-after-base-change}.
Hence we obtain a functor
\begin{equation}
\label{equation-flat-dimension-n}
F_n : (\Sch/S)^{opp} \longrightarrow \textit{Sets}, \quad
T \longrightarrow \left\{
\begin{matrix}
\{*\} & \text{if }\mathcal{F}_T\text{ is flat over }T\text{ in }\dim \geq n, \\
\emptyset & \text{else.}
\end{matrix}
\right.
\end{equation}
\end{situation}

\begin{lemma}
\label{lemma-flat-dimension-n}
In Situation \ref{situation-flat-dimension-n}.
\begin{enumerate}
\item The functor $F_n$ satisfies the sheaf property for the fpqc topology.
\item If $f$ is quasi-compact and locally of finite presentation
and $\mathcal{F}$ is of finite presentation, then the functor $F_n$ is
limit preserving.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\{T_i \to T\}_{i \in I}$ be an fpqc covering of schemes over $S$.
Set $X_i = X_{T_i} = X \times_S T_i$ and denote $\mathcal{F}_i$ the
pullback of $\mathcal{F}$ to $X_i$. Assume that $\mathcal{F}_i$
is flat over $T_i$ in dimensions $\geq n$ for all $i$. Let $t \in T$.
Choose an index $i$ and a point $t_i \in T_i$ mapping to $t$.
Consider the cartesian diagram
$$
\xymatrix{
X_{\Spec(\mathcal{O}_{T, t})} \ar[d] &
X_{\Spec(\mathcal{O}_{T_i, t_i})} \ar[d] \ar[l] \\
\Spec(\mathcal{O}_{T, t}) &
\Spec(\mathcal{O}_{T_i, t_i}) \ar[l]
}
$$
As the lower horizontal morphism is flat we see from
More on Morphisms, Lemma \ref{more-morphisms-lemma-flat-locus-base-change}
that the set $Z_i \subset X_{t_i}$ where $\mathcal{F}_i$ is not flat
over $T_i$ and the set $Z \subset X_t$ where $\mathcal{F}_T$ is not flat
over $T$ are related by the rule $Z_i = Z_{\kappa(t_i)}$. Hence we see
that $\mathcal{F}_T$ is flat over $T$ in dimensions $\geq n$ by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}.

\medskip\noindent
Assume that $f$ is quasi-compact and locally of finite presentation and
that $\mathcal{F}$ is of finite presentation.
In this paragraph we first reduce the proof of (2) to the case where
$f$ is of finite presentation.
Let $T = \lim_{i \in I} T_i$ be a directed limit of
affine $S$-schemes and assume that $\mathcal{F}_T$ is flat in dimensions
$\geq n$. Set $X_i = X_{T_i} = X \times_S T_i$ and denote $\mathcal{F}_i$
the pullback of $\mathcal{F}$ to $X_i$. We have to show that
$\mathcal{F}_i$ is flat in dimensions $\geq n$ for some $i$.
Pick $i_0 \in I$ and replace $I$ by $\{i \mid i \geq i_0\}$.
Since $T_{i_0}$ is affine (hence quasi-compact) there exist finitely
many affine opens $W_j \subset S$, $j = 1, \ldots, m$ and an affine open
overing $T_{i_0} = \bigcup_{j = 1, \ldots, m} V_{j, i_0}$
such that $T_{i_0} \to S$ maps $V_{j, i_0}$ into $W_j$.
For $i \geq i_0$ denote $V_{j, i}$ the inverse image of $V_{j, i_0}$
in $T_i$. If we can show, for each $j$, that there exists an $i$ such that
$\mathcal{F}_{V_{j, i_0}}$ is flat in dimensions $\geq n$, then
we win. In this way we reduce to the case that $S$ is affine.
In this case $X$ is quasi-compact and we can choose a finite
affine open covering $X = W_1 \cup \ldots \cup W_m$. In this case
the result for $(X \to S, \mathcal{F})$ is equivalent to the result for
$(\coprod W_j, \coprod \mathcal{F}|_{W_j})$. Hence we may assume that
$f$ is of finite presentation.

\medskip\noindent
Assume $f$ is of finite presentation and $\mathcal{F}$ is of finite
presentation. Let $U \subset X_T$ denote the open subscheme of points where
$\mathcal{F}_T$ is flat over $T$, see
More on Morphisms, Theorem \ref{more-morphisms-theorem-openness-flatness}.
By assumption the dimension of every fibre of $Z = X_T \setminus U$ over
$T$ has dimension $\leq n$. By
Limits, Lemma \ref{limits-lemma-approximate-given-relative-dimension}
we can find a closed subscheme $Z \subset Z' \subset X_T$
such that $\dim(Z'_t) < n$ for all $t \in T$ and such that
$Z' \to X_T$ is of finite presentation. By
Limits, Lemmas \ref{limits-lemma-descend-finite-presentation} and
\ref{limits-lemma-descend-closed-immersion-finite-presentation}
there exists an $i \in I$ and a closed subscheme $Z'_i \subset X_i$
of finite presentation whose base change to $T$ is $Z'$. By
Limits, Lemma \ref{limits-lemma-limit-dimension}
we may assume all fibres of $Z'_i \to T_i$ have dimension $< n$. By
Limits, Lemma \ref{limits-lemma-descend-module-flat-finite-presentation}
we may assume that $\mathcal{F}_i|_{X_i \setminus T'_i}$
is flat over $T_i$. This implies that $\mathcal{F}_i$ is
flat in dimensions $\geq n$; here we use that $Z' \to X_T$ is of finite
presentation, and hence the complement $X_T \setminus Z'$ is quasi-compact!
Thus part (2) is proved and the proof of the lemma is complete.
\end{proof}

\begin{situation}
\label{situation-flat}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
For any scheme $T$ over $S$ we will denote $\mathcal{F}_T$ the
base change of $\mathcal{F}$ to $T$, in other words, $\mathcal{F}_T$
is the pullback of $\mathcal{F}$ via the projection morphism
$X_T = X \times_S T \to X$. Since the base change of a flat module
is flat we obtain a functor
\begin{equation}
\label{equation-flat}
F_{flat} : (\Sch/S)^{opp} \longrightarrow \textit{Sets}, \quad
T \longrightarrow \left\{
\begin{matrix}
\{*\} & \text{if } \mathcal{F}_T \text{ is flat over }T, \\
\emptyset & \text{else.}
\end{matrix}
\right.
\end{equation}
\end{situation}

\begin{lemma}
\label{lemma-flat}
In Situation \ref{situation-flat}.
\begin{enumerate}
\item The functor $F_{flat}$ satisfies the sheaf property for the fpqc topology.
\item If $f$ is quasi-compact and locally of finite presentation
and $\mathcal{F}$ is of finite presentation, then the functor
$F_{flat}$ is limit preserving.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from the following statement: If $T' \to T$ is a surjective
flat morphism of schemes over $S$, then $\mathcal{F}_{T'}$ is flat over $T'$
if and only if $\mathcal{F}_T$ is flat over $T$, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-flat-locus-base-change}.
Part (2) follows from
Limits, Lemma \ref{limits-lemma-descend-module-flat-finite-presentation}
after reducing to the case where $X$ and $S$ are affine (compare with
the proof of
Lemma \ref{lemma-flat-dimension-n}).
\end{proof}




\section{Flattening stratifications}
\label{section-flattening}

\noindent
Just the definitions and an important baby case.

\begin{definition}
\label{definition-flattening}
Let $X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
We say that the {\it universal flattening of $\mathcal{F}$ exists}
if the functor $F_{flat}$ defined in Situation \ref{situation-flat}
is representable by a scheme $S'$ over $S$.
We say that the {\it universal flattening of $X$ exists}
if the universal flattening of $\mathcal{O}_X$ exists.
\end{definition}

\noindent
Note that if the universal flattening $S'$\footnote{The scheme $S'$ is sometimes
called the {\it universal flatificator}. In \cite{GruRay} it is called
the {\it platificateur universel}. Existence of the universal flattening
should not be confused with the type of results discussed in
More on Algebra, Section \ref{more-algebra-section-blowup-flat}.} of
$\mathcal{F}$ exists, then the morphism $S' \to S$ is a monomorphism of schemes
such that $\mathcal{F}_{S'}$ is flat over $S'$ and such that a
morphism $T \to S$ factors through $S'$ if and only if $\mathcal{F}_T$
is flat over $T$.

\medskip\noindent
We define (compare with
Topology, Remark \ref{topology-remark-locally-finite-stratification})
a (locally finite, scheme theoretic) {\it stratification} of a scheme $S$
to be given by closed subschemes $Z_i \subset S$ indexed by a partially
ordered set $I$ such that
$S = \bigcup Z_i$ (set theoretically), such that every point of $S$ has
a neighbourhood meeting only a finite number of $Z_i$, and such that
$$
Z_i \cap Z_j = \bigcup\nolimits_{k \leq i, j} Z_k.
$$
Setting $S_i = Z_i \setminus \bigcup_{j < i} Z_j$ the actual
stratification is the decomposition $S = \coprod S_i$ into
locally closed subschemes. We often only indicate the strata
$S_i$ and leave the construction of the closed subschemes $Z_i$
to the reader. Given a stratification we obtain a monomorphism
$$
S' = \coprod\nolimits_{i \in I} S_i \longrightarrow S.
$$
We will call this the {\it monomorphism associated to the stratification}.
With this terminology we can define what it means to have a flattening
stratification.

\begin{definition}
\label{definition-flattening-stratification}
Let $X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
We say that $\mathcal{F}$ has a {\it flattening stratification}
if the functor $F_{flat}$ defined in Situation \ref{situation-flat}
is representable by a monomorphism $S' \to S$ associated
to a stratification of $S$ by locally closed subschemes.
We say that $X$ has a {\it flattening stratification}
if $\mathcal{O}_X$ has a flattening stratification.
\end{definition}

\noindent
When a flattening stratification exists, it is often important
to understand the index set labeling the strata and its partial ordering.
This often has to do with ranks of modules, as in the baby case below.

\begin{lemma}
\label{lemma-locally-free-rank-r-pullback}
Let $S$ be a scheme. Let $\mathcal{F}$ be a finite type, quasi-coherent
$\mathcal{O}_S$-module. The closed subschemes
$$
S = Z_{-1} \supset Z_0 \supset Z_1 \supset Z_2 \ldots
$$
defined by the Fitting ideals of $\mathcal{F}$ have the following
properties
\begin{enumerate}
\item The intersection $\bigcap Z_r$ is empty.
\item The functor $(\Sch/S)^{opp} \to \textit{Sets}$ defined by the rule
$$
T \longmapsto
\left\{
\begin{matrix}
\{*\} & \text{if }\mathcal{F}_T\text{ is locally generated by }
\leq r\text{ sections} \\
\emptyset & \text{otherwise}
\end{matrix}
\right.
$$
is representable by the open subscheme $S \setminus Z_r$.
\item The functor $F_r : (\Sch/S)^{opp} \to \textit{Sets}$ defined by the rule
$$
T \longmapsto
\left\{
\begin{matrix}
\{*\} & \text{if }\mathcal{F}_T\text{ locally free rank }r\\
\emptyset & \text{otherwise}
\end{matrix}
\right.
$$
is representable by the locally closed subscheme $Z_{r - 1} \setminus Z_r$
of $S$.
\end{enumerate}
If $\mathcal{F}$ is of finite presentation, then
$Z_r \to S$, $S \setminus Z_r \to S$, and $Z_{r - 1} \setminus Z_r \to S$
are of finite presentation.
\end{lemma}

\begin{proof}
We refer to More on Algebra, Section \ref{more-algebra-section-fitting-ideals}
for the construction of the {\it Fitting ideals} in the algebraic
setting. Here we will construct the sequence
$$
0 = \mathcal{I}_{-1} \subset \mathcal{I}_0 \subset \mathcal{I}_1 \subset
\ldots \subset \mathcal{O}_S
$$
of Fitting ideals of $\mathcal{F}$ as an $\mathcal{O}_S$-module.
Namely, if $U \subset X$ is open, and
$$
\bigoplus\nolimits_{i \in I} \mathcal{O}_U \to
\mathcal{O}_U^{\oplus n} \to \mathcal{F}|_U \to 0
$$
is a presentation of $\mathcal{F}$ over $U$, then
$\mathcal{I}_r|_U$ is generated by the $(n - r) \times (n - r)$-minors
of the matrix defining the first arrow of the presentation.
In particular, $\mathcal{I}_r$ is locally generated by sections, whence
quasi-coherent. If $U = \Spec(A)$ and $\mathcal{F}|_U = \widetilde{M}$, then
$\mathcal{I}_r|_U$ is the ideal sheaf associated to the fitting
ideal $\text{Fit}_r(M)$ as in
More on Algebra, Definition \ref{more-algebra-definition-fitting-ideal}.
Let $Z_r \subset S$ be the closed subscheme corresponding to $\mathcal{I}_r$.

\medskip\noindent
For any morphism $g : T \to S$ we see from
More on Algebra, Lemma \ref{more-algebra-lemma-fitting-ideal-generate-locally}
that $\mathcal{F}_T$ is locally generated by $\leq r$ sections if and only if
$\mathcal{I}_r \cdot \mathcal{O}_T = \mathcal{O}_T$.
This proves (2).

\medskip\noindent
For any morphism $g : T \to S$ we see from
More on Algebra, Lemma
\ref{more-algebra-lemma-fitting-ideal-finite-locally-free}
that $\mathcal{F}_T$ is free of rank $r$ if and only if
$\mathcal{I}_r \cdot \mathcal{O}_T = \mathcal{O}_T$ and
$\mathcal{I}_{r - 1} \cdot \mathcal{O}_T = 0$.
This proves (3).

\medskip\noindent
The final statement of the lemma follows from the fact that if
$\mathcal{F}$ is of finite presentation, then each of the morphisms
$Z_r \to S$ is of finite presentation as $\mathcal{I}_r$ is locally
generated by finitely many minors. This implies that
$Z_{r - 1} \setminus Z_r$ is a retrocompact open in $Z_r$
and hence the morphism $Z_{r - 1} \setminus Z_r \to Z_r$
is of finite presentation as well.
\end{proof}

\noindent
Lemma \ref{lemma-locally-free-rank-r-pullback} notwithstanding
the following lemma does not hold if $\mathcal{F}$ is a finite type
quasi-coherent module. Namely, the stratification still exists but
it isn't true that it represents the functor $F_{flat}$ in general.

\begin{lemma}
\label{lemma-finite-presentation-module}
Let $S$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent
$\mathcal{O}_S$-module of finite presentation.
There exists a flattening stratification $S' = \coprod_{r \geq 0} S_r$
for $\mathcal{F}$ (relative to $\text{id}_S : S \to S$) such that
$\mathcal{F}|_{S_r}$ is locally free of rank $r$. Moreover, each
$S_r \to S$ is of finite presentation.
\end{lemma}

\begin{proof}
Suppose that $g : T \to S$ is a morphism of schemes such that the pullback
$\mathcal{F}_T = g^*\mathcal{F}$ is flat. Then $\mathcal{F}_T$ is a flat
$\mathcal{O}_T$-module of finite presentation. Hence
$\mathcal{F}_T$ is finite locally free, see
Properties, Lemma \ref{properties-lemma-finite-locally-free}.
Thus $T = \coprod_{r \geq 0} T_r$, where $\mathcal{F}_T|_{T_r}$ is locally
free of rank $r$. This implies that
$$
F_{flat} = \coprod\nolimits_{r \geq 0} F_r
$$
in the category of Zariski sheaves on $\Sch/S$ where $F_r$ is as in
Lemma \ref{lemma-locally-free-rank-r-pullback}. It follows
that $F_{flat}$ is represented by
$\coprod_{r \geq 0} (Z_{r - 1} \setminus Z_r)$ where
$Z_r$ is as in
Lemma \ref{lemma-locally-free-rank-r-pullback}.
\end{proof}

\noindent
We end this section showing that if we do not insist on a canonical
stratification, then we can use generic flatness to construct some
stratification such that our sheaf is flat over the strata.

\begin{lemma}[Generic flatness stratification]
\label{lemma-generic-flatness-stratification}
Let $f : X \to S$ be a morphism of finite presentation between quasi-compact
and quasi-separated schemes. Let $\mathcal{F}$ be an $\mathcal{O}_X$-module
of finite presentation. Then there exists a $t \geq 0$ and closed
subschemes
$$
S \supset S_0 \supset S_1 \supset \ldots \supset S_t = \emptyset
$$
such that $S_i \to S$ is defined by a finite type ideal sheaf,
$S_0 \subset S$ is a thickening, and $\mathcal{F}$ pulled back to
$X \times_S (S_i \setminus S_{i + 1})$ is flat over $S_i \setminus S_{i + 1}$.
\end{lemma}

\begin{proof}
We can find a cartesian diagram
$$
\xymatrix{
X \ar[d] \ar[r] & X_0 \ar[d] \\
S \ar[r] & S_0
}
$$
and a finitely presented $\mathcal{O}_{X_0}$-module $\mathcal{F}_0$
which pulls back to $\mathcal{F}$ such that $X_0$ and $S_0$ are of
finite type over $\mathbf{Z}$. See
Limits, Proposition \ref{limits-proposition-approximate} and
Lemmas \ref{limits-lemma-descend-finite-presentation} and
\ref{limits-lemma-descend-modules-finite-presentation}.
Thus we may assume $X$ and $S$ are of finite type over $\mathbf{Z}$
and $\mathcal{F}$ is a coherent $\mathcal{O}_X$-module.

\medskip\noindent
Assume $X$ and $S$ are of finite type over $\mathbf{Z}$
and $\mathcal{F}$ is a coherent $\mathcal{O}_X$-module.
In this case every quasi-coherent ideal is of finite type, hence
we do not have to check the condition that $S_i$ is cut out
by a finite type ideal. Set $S_0 = S_{red}$ equal to the reduction of $S$.
By generic flatness as stated in Morphisms, Proposition
\ref{morphisms-proposition-generic-flatness-reduced}
there is a dense open $U_0 \subset S_0$ such that $\mathcal{F}$
pulled back to $X \times_S U_0$ is flat over $U_0$.
Let $S_1 \subset S_0$ be the reduced closed subscheme whose
underlying closed subset is $S \setminus U_0$. We continue in this
way, provided $S_1 \not = \emptyset$, to find
$S_0 \supset S_1 \supset \ldots$. Because $S$
is Noetherian any descending chain of closed subsets stabilizes
hence we see that $S_t = \emptyset$ for some $t \geq 0$.
\end{proof}




\section{Flattening stratification over an Artinian ring}
\label{section-flattening-artinian}

\noindent
A flatting stratification exists when the base scheme is the spectrum
of an Artinian ring.

\begin{lemma}
\label{lemma-flattening-stratification-artinian}
Let $S$ be the spectrum of an Artinian ring.
For any scheme $X$ over $S$, and any quasi-coherent $\mathcal{O}_X$-module
there exists a universal flattening. In fact the universal flattening
is given by a closed immersion $S' \to S$, and hence is a flattening
stratification for $\mathcal{F}$ as well.
\end{lemma}

\begin{proof}
Choose an affine open covering $X = \bigcup U_i$.
Then $F_{flat}$ is the product of the functors associated to
each of the pairs $(U_i, \mathcal{F}|_{U_i})$.
Hence it suffices to prove the result for each
$(U_i, \mathcal{F}|_{U_i})$.
In the affine case the lemma follows immediately from
More on Algebra,
Lemma \ref{more-algebra-lemma-flattening-artinian-universal-property}.
\end{proof}






\section{Flattening a map}
\label{section-fattening-map}

\noindent
Theorem \ref{theorem-flattening-map}
is the key to further flattening statements.

\begin{lemma}
\label{lemma-universally-separating}
Let $S$ be a scheme.
Let $g : X' \to X$ be a flat morphism of schemes over $S$
with $X$ locally of finite type over $S$.
Let $\mathcal{F}$ be a finite type $\mathcal{O}_X$-module
which is flat over $S$. If $\text{Ass}_{X/S}(\mathcal{F}) \subset g(X')$
then the canonical map
$$
\mathcal{F} \longrightarrow g_*g^*\mathcal{F}
$$
is injective, and remains injective after any base change.
\end{lemma}

\begin{proof}
The final assertion means that $\mathcal{F}_T \to (g_T)_*g_T^*\mathcal{F}_T$
is injective for any morphism $T \to S$. The assumption
$\text{Ass}_{X/S}(\mathcal{F}) \subset g(X')$ is preserved by base change, see
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin} and
Remark \ref{divisors-remark-base-change-relative-assassin}.
The same holds for the assumption of flatness and finite type.
Hence it suffices to prove the injectivity of the displayed arrow.
Let $\mathcal{K} = \Ker(\mathcal{F} \to g_*g^*\mathcal{F})$.
Our goal is to prove that $\mathcal{K} = 0$.
In order to do this it suffices to prove that
$\text{WeakAss}_X(\mathcal{K}) = \emptyset$, see
Divisors, Lemma \ref{divisors-lemma-weakly-ass-zero}.
We have
$\text{WeakAss}_X(\mathcal{K}) \subset \text{WeakAss}_X(\mathcal{F})$, see
Divisors, Lemma \ref{divisors-lemma-ses-weakly-ass}.
As $\mathcal{F}$ is flat we see from
Lemma \ref{lemma-bourbaki-finite-type-general-base}
that $\text{WeakAss}_X(\mathcal{F}) \subset \text{Ass}_{X/S}(\mathcal{F})$.
By assumption any point $x$ of $\text{Ass}_{X/S}(\mathcal{F})$
is the image of some $x' \in X'$. Since $g$ is flat the
local ring map $\mathcal{O}_{X, x} \to \mathcal{O}_{X', x'}$
is faithfully flat, hence the map
$$
\mathcal{F}_x
\longrightarrow
g^*\mathcal{F}_{x'} =
\mathcal{F}_x \otimes_{\mathcal{O}_{X, x}} \mathcal{O}_{X', x'}
$$
is injective (see
Algebra, Lemma \ref{algebra-lemma-faithfully-flat-universally-injective}).
This implies that $\mathcal{K}_x = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-flattening-module-map}
Let $A$ be a ring. Let $u : M \to N$ be a surjective map of $A$-modules.
If $M$ is projective as an $A$-module, then there exists an ideal
$I \subset A$ such that for any ring map $\varphi : A \to B$
the following are equivalent
\begin{enumerate}
\item $u \otimes 1 : M \otimes_A B \to N \otimes_A B$ is an
isomorphism, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
As $M$ is projective we can find a projective $A$-module $C$
such that $F = M \oplus C$ is a free $R$-module.
By replacing $u$ by $u \oplus 1 : F = M \oplus C \to N \oplus C$
we see that we may assume $M$ is free. In this case let $I$ be
the ideal of $A$ generated by coefficients of all the elements of
$\Ker(u)$ with respect to some (fixed) basis of $M$.
The reason this works is that, since $u$ is surjective and
$\otimes_A B$ is right exact, $\Ker(u \otimes 1)$ is
the image of $\Ker(u) \otimes_A B$ in $M \otimes_A B$.
\end{proof}

\begin{theorem}
\label{theorem-flattening-map}
In
Situation \ref{situation-iso}
assume
\begin{enumerate}
\item $f$ is of finite presentation,
\item $\mathcal{F}$ is of finite presentation, flat over $S$, and
pure relative to $S$, and
\item $u$ is surjective.
\end{enumerate}
Then $F_{iso}$ is representable by a closed immersion $Z \to S$.
Moreover $Z \to S$ is of finite presentation if $\mathcal{G}$ is
of finite presentation.
\end{theorem}

\begin{proof}
We will use without further mention that $\mathcal{F}$ is universally pure
over $S$, see
Lemma \ref{lemma-finite-type-flat-pure-along-fibre-is-universal}.
By
Lemma \ref{lemma-iso-sheaf}
and
Descent, Lemmas \ref{descent-lemma-closed-immersion} and
\ref{descent-lemma-descent-data-sheaves}
the question is local for the \'etale topology on $S$.
Hence it suffices to prove, given $s \in S$, that there exists
an \'etale neighbourhood of $(S, s)$ so that the theorem holds.

\medskip\noindent
Using
Lemma \ref{lemma-finite-presentation-flat-along-fibre}
and after replacing $S$ by an elementary \'etale neighbourhood of $s$
we may assume there exists a commutative diagram
$$
\xymatrix{
X \ar[dr] & & X' \ar[ll]^g \ar[ld] \\
& S &
}
$$
of schemes of finite presentation over $S$,
where $g$ is \'etale, $X_s \subset g(X')$, the schemes $X'$ and $S$ are affine,
$\Gamma(X', g^*\mathcal{F})$ a projective $\Gamma(S, \mathcal{O}_S)$-module.
Note that $g^*\mathcal{F}$ is universally pure over $S$, see
Lemma \ref{lemma-affine-locally-projective-pure}.
Hence by
Lemma \ref{lemma-criterion}
we see that the open $g(X')$ contains the points of
$\text{Ass}_{X/S}(\mathcal{F})$ lying over $\Spec(\mathcal{O}_{S, s})$.
Set
$$
E = \{t \in S \mid \text{Ass}_{X_t}(\mathcal{F}_t) \subset g(X') \}.
$$
By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-relative-assassin-constructible}
$E$ is a constructible subset of $S$. We have seen that
$\Spec(\mathcal{O}_{S, s}) \subset E$. By
Morphisms, Lemma \ref{morphisms-lemma-constructible-containing-open}
we see that $E$ contains an open neighbourhood of $s$. Hence after
replacing $S$ by a smaller affine neighbourhood of $s$ we may assume that
$\text{Ass}_{X/S}(\mathcal{F}) \subset g(X')$.

\medskip\noindent
Since we have assumed that $u$ is surjective we have $F_{iso} = F_{inj}$. From
Lemma \ref{lemma-universally-separating}
it follows that $u : \mathcal{F} \to \mathcal{G}$ is injective if and only if
$g^*u : g^*\mathcal{F} \to g^*\mathcal{G}$ is injective, and the same remains
true after any base change. Hence we have reduced to the case where,
in addition to the assumptions in the theorem, $X \to S$ is a morphism of
affine schemes and $\Gamma(X, \mathcal{F})$ is a projective
$\Gamma(S, \mathcal{O}_S)$-module. This case follows immediately from
Lemma \ref{lemma-flattening-module-map}.

\medskip\noindent
To see that $Z$ is of finite presentation if $\mathcal{G}$ is of finite
presentation, combine
Lemma \ref{lemma-iso-sheaf} part (4)
with
Limits, Remark \ref{limits-remark-limit-preserving}.
\end{proof}

\begin{lemma}
\label{lemma-Weil-restriction-closed-subschemes}
Let $f:X\to S$ be a morphism of schemes which is of finite presentation,
flat, and pure. Let $Y$ be a closed subscheme of $X$. Let $F=f_*Y$ be the
Weil restriction functor of $Y$ along $f$, defined by
$$
F : (\Sch/S)^{opp} \to \textit{Sets}, \quad
T \mapsto
\left\{
\begin{matrix}
\{*\} & \text{if} & Y_T\to X_T \text{ is an isomorphism, }\\
\emptyset & \text{else.} &
\end{matrix}
\right.
$$
Then $F$ is representable by a closed immersion $Z\to S$. Moreover
$Z\to S$ is of finite presentation if $Y\to S$ is.
\end{lemma}

\begin{proof}
Let $\mathcal{I}$ be the ideal sheaf defining $Y$ in $X$ and let
$u:\mathcal{O}_X\to\mathcal{O}_X/\mathcal{I}$ be the surjection.
Then for an $S$-scheme $T$, the closed immersion $Y_T\to X_T$
is an isomorphism if and only if $u_T$ is an isomorphism. Hence
the result follows from
Theorem \ref{theorem-flattening-map}.
\end{proof}



\section{Flattening in the local case}
\label{section-flattening-local}

\noindent
In this section we start applying the earlier material to obtain a
shadow of the flattening stratification.

\begin{theorem}
\label{theorem-flattening-local}
In
Situation \ref{situation-flat-at-point}
assume $A$ is henselian, $B$ is essentially of finite type over $A$, and
$M$ is a finite $B$-module. Then there exists an ideal
$I \subset A$ such that $A/I$ corepresents the functor $F_{lf}$ on the category
$\mathcal{C}$. In other words given a local homomorphism of local rings
$\varphi : A \to A'$ with $B' = B \otimes_A A'$ and $M' = M \otimes_A A'$
the following are equivalent:
\begin{enumerate}
\item $\forall \mathfrak q \in V(\mathfrak m_{A'}B' + \mathfrak m_B B')
\subset \Spec(B') :
M'_{\mathfrak q}\text{ is flat over }A'$, and
\item $\varphi(I) = 0$.
\end{enumerate}
If $B$ is essentially of finite presentation over $A$ and $M$
of finite presentation over $B$, then $I$ is a finitely generated ideal.
\end{theorem}

\begin{proof}
Choose a finite type ring map $A \to C$ and a finite $C$-module $N$
and a prime $\mathfrak q$ of $C$ such that $B = C_{\mathfrak q}$
and $M = N_{\mathfrak q}$. In the following, when we say
``the theorem holds for $(N/C/A, \mathfrak q)$ we mean that
it holds for $(A \to B, M)$ where $B = C_{\mathfrak q}$ and
$M = N_{\mathfrak q}$. By
Lemma \ref{lemma-flat-at-point-go-up}
the functor $F_{lf}$ is unchanged if we replace $B$ by a local ring
flat over $B$. Hence, since $A$ is henselian, we may apply
Lemma \ref{lemma-existence-algebra}
and assume that there exists a complete d\'evissage of
$N/C/A$ at $\mathfrak q$.

\medskip\noindent
Let $(A_i, B_i, M_i, \alpha_i, \mathfrak q_i)_{i = 1, \ldots, n}$
be such a complete d\'evissage of $N/C/A$ at $\mathfrak q$. Let
$\mathfrak q'_i \subset A_i$ be the unique prime lying over
$\mathfrak q_i \subset B_i$ as in
Definition \ref{definition-complete-devissage-at-x-algebra}.
Since $C \to A_1$ is surjective and $N \cong M_1$ as $C$-modules,
we see by
Lemma \ref{lemma-flat-at-point-finite}
it suffices to prove the theorem holds for $(M_1/A_1/A, \mathfrak q'_1)$.
Since $B_1 \to A_1$ is finite and $\mathfrak q_1$ is the only prime
of $B_1$ over $\mathfrak q'_1$ we see that
$(A_1)_{\mathfrak q'_1} \to (B_1)_{\mathfrak q_1}$ is finite (see
Algebra, Lemma \ref{algebra-lemma-unique-prime-over-localize-below} or
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}).
Hence by
Lemma \ref{lemma-flat-at-point-finite}
it suffices to prove the theorem holds for $(M_1/B_1/A, \mathfrak q_1)$.

\medskip\noindent
At this point we may assume, by induction on the length $n$ of the
d\'evissage, that the theorem holds for $(M_2/B_2/A, \mathfrak q_2)$.
(If $n = 1$, then $M_2 = 0$ which is flat over $A$.)
Reversing the last couple of steps of the previous paragraph, using
that $M_2 \cong \Coker(\alpha_2)$ as $B_1$-modules, we see
that the theorem holds for $(\Coker(\alpha_1)/B_1/A, \mathfrak q_1)$.

\medskip\noindent
Let $A'$ be an object of $\mathcal{C}$. At this point we use
Lemma \ref{lemma-induction-step}
to see that if $(M_1 \otimes_A A')_{\mathfrak q'}$ is flat
over $A'$ for a prime $\mathfrak q'$ of $B_1 \otimes_A A'$
lying over $\mathfrak m_{A'}$, then
$(\Coker(\alpha_1) \otimes_A A')_{\mathfrak q'}$ is flat over $A'$.
Hence we conclude that $F_{lf}$ is a subfunctor of the
functor $F'_{lf}$ associated to the module
$\Coker(\alpha_1)_{\mathfrak q_1}$ over $(B_1)_{\mathfrak q_1}$.
By the previous paragraph we know $F'_{lf}$ is corepresented by
$A/J$ for some ideal $J \subset A$. Hence we may replace $A$ by
$A/J$ and assume that $\Coker(\alpha_1)_{\mathfrak q_1}$ is
flat over $A$.

\medskip\noindent
Since $\Coker(\alpha_1)$ is a $B_1$-module for which
there exist a complete d\'evissage of $N_1/B_1/A$ at $\mathfrak q_1$
and since $\Coker(\alpha_1)_{\mathfrak q_1}$ is
flat over $A$ by
Lemma \ref{lemma-complete-devissage-flat-finite-type-module}
we see that $\Coker(\alpha_1)$ is free as an $A$-module, in particular
flat as an $A$-module. Hence
Lemma \ref{lemma-induction-step}
implies $F_{lf}(A')$ is nonempty if and only if $\alpha \otimes 1_{A'}$
is injective. Let $N_1 = \Im(\alpha_1) \subset M_1$ so that
we have exact sequences
$$
0 \to N_1 \to M_1 \to \Coker(\alpha_1) \to 0
\quad\text{and}\quad
B_1^{\oplus r_1} \to N_1 \to 0
$$
The flatness of $\Coker(\alpha_1)$ implies the first sequence
is universally exact (see
Algebra, Lemma \ref{algebra-lemma-flat-universally-injective}).
Hence $\alpha \otimes 1_{A'}$ is injective if and only if
$B_1^{\oplus r_1} \otimes_A A' \to N_1 \otimes_A A'$
is an isomorphism. Finally,
Theorem \ref{theorem-flattening-map}
applies to show this functor is corepresentable by $A/I$ for some ideal $I$
and we conclude $F_{lf}$ is corepresentable by $A/I$ also.

\medskip\noindent
To prove the final statement, suppose that $A \to B$ is essentially of finite
presentation and $M$ of finite presentation over $B$. Let $I \subset A$
be the ideal such that $F_{lf}$ is corepresented by $A/I$.
Write $I = \bigcup I_\lambda$ where $I_\lambda$ ranges over the finitely
generated ideals contained in $I$. Then, since $F_{lf}(A/I) = \{*\}$
we see that $F_{lf}(A/I_\lambda) = \{*\}$ for some $\lambda$, see
Lemma \ref{lemma-flat-at-point} part (2).
Clearly this implies that $I = I_\lambda$.
\end{proof}

\begin{remark}
\label{remark-flattening-local-scheme-theoretic}
Here is a scheme theoretic reformulation of
Theorem \ref{theorem-flattening-local}.
Let $(X, x) \to (S, s)$ be a morphism of pointed schemes
which is locally of finite type. Let $\mathcal{F}$ be a finite
type quasi-coherent $\mathcal{O}_X$-module.
Assume $S$ henselian local with closed point $s$.
There exists a closed subscheme $Z \subset S$ with the following property:
for any morphism of pointed schemes $(T, t) \to (S, s)$ the following
are equivalent
\begin{enumerate}
\item $\mathcal{F}_T$ is flat over $T$ at all points of the fibre
$X_t$ which map to $x \in X_s$, and
\item $\Spec(\mathcal{O}_{T, t}) \to S$ factors through $Z$.
\end{enumerate}
Moreover, if $X \to S$ is of finite presentation at $x$ and $\mathcal{F}_x$
of finite presentation over $\mathcal{O}_{X, x}$, then $Z \to S$
is of finite presentation.
\end{remark}

\noindent
At this point we can obtain some very general results completely
for free from the result above. Note that perhaps the most interesting
case is when $E = X_s$!

\begin{lemma}
\label{lemma-freebie}
Let $S$ be the spectrum of a henselian local ring with closed point $s$.
Let $X \to S$ be a morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $E \subset X_s$ be a subset. There exists a closed subscheme
$Z \subset S$ with the following property: for any morphism of pointed
schemes $(T, t) \to (S, s)$ the following are equivalent
\begin{enumerate}
\item $\mathcal{F}_T$ is flat over $T$ at all points of the fibre
$X_t$ which map to a point of $E \subset X_s$, and
\item $\Spec(\mathcal{O}_{T, t}) \to S$ factors through $Z$.
\end{enumerate}
Moreover, if $X \to S$ is locally of finite presentation,
$\mathcal{F}$ is of finite presentation, and $E \subset X_s$ is
closed and quasi-compact, then $Z \to S$ is of finite presentation.
\end{lemma}

\begin{proof}
For $x \in X_s$ denote $Z_x \subset S$ the closed subscheme we found in
Remark \ref{remark-flattening-local-scheme-theoretic}.
Then it is clear that $Z = \bigcap_{x \in E} Z_x$ works!

\medskip\noindent
To prove the final statement assume $X$ locally of finite presentation,
$\mathcal{F}$ of finite presentation and $Z$ closed and quasi-compact.
First, choose finitely many affine opens $W_j \subset X$ such that
$E \subset \bigcup W_j$. It clearly suffices to prove the
result for each morphism $W_j \to S$ with sheaf $\mathcal{F}|_{X_j}$
and closed subset $E \cap W_j$. Hence we may assume $X$ is affine.
In this case,
More on Algebra, Lemma \ref{more-algebra-lemma-limit-preserving-flat-at-primes}
shows that the functor defined by (1) is ``limit preserving''.
Hence we can show that $Z \to S$ is of finite presentation exactly
as in the last part of the proof of
Theorem \ref{theorem-flattening-local}.
\end{proof}

\begin{remark}
\label{remark-flattening-complete-noetherian}
Tracing the proof of
Lemma \ref{lemma-freebie}
to its origins we find a long and winding road. But if we assume that
\begin{enumerate}
\item $f$ is of finite type,
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module,
\item $E = X_s$, and
\item $S$ is the spectrum of a Noetherian complete local ring.
\end{enumerate}
then there is a proof relying completely on more elementary algebra as
follows: first we reduce to the case where $X$ is affine by taking
a finite affine open cover. In this case $Z$ exists by
More on Algebra,
Lemma \ref{more-algebra-lemma-flattening-complete-local-universal-property}.
The key step in this proof is constructing the closed subscheme $Z$
step by step inside the truncations
$\Spec(\mathcal{O}_{S, s}/\mathfrak m_s^n)$.
This relies on the fact that flattening stratifications always exist
when the base is Artinian, and the fact that
$\mathcal{O}_{S, s} = \lim \mathcal{O}_{S, s}/\mathfrak m_s^n$.
\end{remark}




\section{Variants of a lemma}
\label{section-variants-mod-injective}

\noindent
In this section we discuss variants of
Algebra, Lemmas \ref{algebra-lemma-mod-injective-general} and
\ref{algebra-lemma-mod-injective}.
The most general version is
Proposition \ref{proposition-finite-type-injective-into-flat-mod-m};
this was stated as \cite[Lemma 4.2.2]{GruRay} but the proof in
loc.cit.\ only gives the weaker result as stated in
Lemma \ref{lemma-upstairs-finite-type-injective-into-flat-mod-m}.
The intricate proof of
Proposition \ref{proposition-finite-type-injective-into-flat-mod-m}
is due to Ofer Gabber. As we currently have no application for
the proposition we encourage the reader to skip to the next section
after reading the proof of
Lemma \ref{lemma-upstairs-finite-type-injective-into-flat-mod-m};
this lemma will be used in the next section to prove
Theorem \ref{theorem-check-flatness-at-associated-points}.

\begin{situation}
\label{situation-mod-injective}
Let $\varphi : A \to B$ be a local ring homomorphism of local rings
which is essentially of finite type. Let $M$ be a flat $A$-module,
$N$ a finite $B$-module and $u : N \to M$ an $A$-module map such that
$\overline{u} : N/\mathfrak m_AN \to M/\mathfrak m_AM$ is injective.
\end{situation}

\noindent
In this situation it is our goal to show that $u$ is $A$-universally injective,
$N$ is of finite presentation over $B$, and $N$ is flat as an $A$-module.
If this is true, we will say {\it the lemma holds} in the given situation.

\begin{lemma}
\label{lemma-Noetherian-finite-type-injective-into-flat-mod-m}
If in Situation \ref{situation-mod-injective} the ring $A$ is Noetherian
then the lemma holds.
\end{lemma}

\begin{proof}
Applying Algebra, Lemma \ref{algebra-lemma-mod-injective} we see that
$u$ is injective and that $N/u(M)$ is flat over $A$. Then $u$ is
$A$-universally injective
(Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}) and $N$ is $A$-flat
(Algebra, Lemma \ref{algebra-lemma-flat-ses}). Since $B$ is Noetherian
in this case we see that $N$ is of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-reduce-finite-type-injective-into-flat-mod-m}
Let $A_0$ be a local ring. If the lemma holds for every
Situation \ref{situation-mod-injective} with $A = A_0$, with $B$ a
localization of a polynomial algebra over $A$, and $N$ of finite presentation
over $B$, then the lemma holds for every
Situation \ref{situation-mod-injective} with $A = A_0$.
\end{lemma}

\begin{proof}
Let $A \to B$, $u : N \to M$ be as in Situation \ref{situation-mod-injective}.
Write $B = C/I$ where $C$ is the localization of a polynomial algebra
over $A$ at a prime. If we can show that $N$ is finitely presented as
a $C$-module, then a fortiori this shows that $N$ is finitely presented
as a $B$-module (see
Algebra, Lemma \ref{algebra-lemma-finitely-presented-over-subring}).
Hence we may assume that $B$ is the localization of a polynomial algebra.
Next, write $N = B^{\oplus n}/K$ for some submodule $K \subset B^{\oplus n}$.
Since $B/\mathfrak m_AB$ is Noetherian (as it is essentially of finite type
over a field), there exist finitely many elements $k_1, \ldots, k_s \in K$
such that for $K' = \sum Bk_i$ and $N' = B^{\oplus n}/K'$ the
canonical surjection $N' \to N$ induces an isomorphism
$N'/\mathfrak m_AN' \cong N/\mathfrak m_AN$.
Now, if the lemma holds for the composition $u' : N' \to M$,
then $u'$ is injective, hence $N' = N$ and $u' = u$. Thus the lemma holds for
the original situation.
\end{proof}

\begin{lemma}
\label{lemma-henselian-finite-type-injective-into-flat-mod-m}
If in Situation \ref{situation-mod-injective} the ring $A$ is henselian
then the lemma holds.
\end{lemma}

\begin{proof}
It suffices to prove this when $B$ is essentially of finite presentation
over $A$ and $N$ is of finite presentation over $B$, see
Lemma \ref{lemma-reduce-finite-type-injective-into-flat-mod-m}.
Let us temporarily make the additional assumption that $N$ is flat over $A$.
Then $N$ is a filtered colimit $N = \colim_i F_i$
of free $A$-modules $F_i$ such that the transition maps
$u_{ii'} : F_i \to F_{i'}$ are injective modulo $\mathfrak m_A$, see
Lemma \ref{lemma-flat-finite-type-local-colimit-free}.
Each of the compositions $u_i : F_i \to M$ is $A$-universally
injective by
Lemma \ref{lemma-universally-injective-local}
wherefore $u = \colim u_i$ is $A$-universally injective as desired.

\medskip\noindent
Assume $A$ is a henselian local ring, $B$ is essentially
of finite presentation over $A$, $N$ of finite presentation over $B$. By
Theorem \ref{theorem-flattening-local}
there exists a finitely generated ideal $I \subset A$ such that
$N/IN$ is flat over $A/I$ and such that $N/I^2N$ is not flat over
$A/I^2$ unless $I = 0$. The result of the previous paragraph shows that
the lemma holds for $u \bmod I : N/IN \to M/IM$ over $A/I$.
Consider the commutative diagram
$$
\xymatrix{
0 \ar[r] &
M \otimes_A I/I^2 \ar[r] &
M/I^2M \ar[r] &
M/IM \ar[r] & 0 \\
&
N \otimes_A I/I^2 \ar[r] \ar[u]^u &
N/I^2N \ar[r] \ar[u]^u &
N/IN \ar[r] \ar[u]^u & 0
}
$$
whose rows are exact by right exactness of $\otimes$ and the fact that
$M$ is flat over $A$. Note that the left vertical arrow is the map
$N/IN \otimes_{A/I} I/I^2 \to M/IM \otimes_{A/I} I/I^2$, hence is
injective. A diagram chase shows that the lower left arrow is injective,
i.e., $\text{Tor}^1_{A/I^2}(I/I^2, M/I^2) = 0$ see
Algebra, Remark \ref{algebra-remark-Tor-ring-mod-ideal}.
Hence $N/I^2N$ is flat over $A/I^2$ by
Algebra, Lemma \ref{algebra-lemma-what-does-it-mean}
a contradiction unless $I = 0$.
\end{proof}

\noindent
The following lemma discusses the special case of
Situation \ref{situation-mod-injective} where $M$ has
a $B$-module structure and $u$ is $B$-linear. This is the case most
often used in practice and it is significantly easier to prove
than the general case.

\begin{lemma}
\label{lemma-upstairs-finite-type-injective-into-flat-mod-m}
Let $A \to B$ be a local ring homomorphism of local rings which is
essentially of finite type. Let $u : N \to M$ be a $B$-module map.
If $N$ is a finite $B$-module, $M$ is flat over $A$, and
$\overline{u} : N/\mathfrak m_A N \to M/\mathfrak m_A M$ is injective,
then $u$ is $A$-universally injective, $N$ is of finite presentation over
$B$, and $N$ is flat over $A$.
\end{lemma}

\begin{proof}
Let $A \to A^h$ be the henselization of $A$. Let $B'$ be the localization
of $B \otimes_A A^h$ at the maximal ideal
$\mathfrak m_B \otimes A^h + B \otimes \mathfrak m_{A^h}$.
Since $B \to B'$ is flat (hence faithfully flat, see
Algebra, Lemma \ref{algebra-lemma-local-flat-ff}),
we may replace $A \to B$ with $A^h \to B'$,
the module $M$ by $M \otimes_B B'$, the module $N$ by $N \otimes_B B'$,
and $u$ by $u \otimes \text{id}_{B'}$, see
Algebra, Lemmas \ref{algebra-lemma-descend-properties-modules} and
\ref{algebra-lemma-flatness-descends-more-general}.
Thus we may assume that $A$ is a henselian local ring.
In this case our lemma follows from the more general
Lemma \ref{lemma-henselian-finite-type-injective-into-flat-mod-m}.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-finite-type-injective-into-flat-mod-m}
If in Situation \ref{situation-mod-injective} the ring $A$ is a
valuation ring then the lemma holds.
\end{lemma}

\begin{proof}
Recall that an $A$-module is flat if and only if it is torsion free, see
More on Algebra, Lemma
\ref{more-algebra-lemma-valuation-ring-torsion-free-flat}.
Let $T \subset N$ be the $A$-torsion. Then $u(T) = 0$ and 
$N/T$ is $A$-flat. Hence $N/T$ is finitely presented over $B$, see
More on Algebra, Lemma
\ref{more-algebra-lemma-flat-finite-type-valuation-ring-finite-presentation}.
Thus $T$ is a finite $B$-module, see
Algebra, Lemma \ref{algebra-lemma-extension}.
Since $N/T$ is $A$-flat we see that
$T/\mathfrak m_A T \subset N/\mathfrak m_A N$, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
As $\overline{u}$ is injective but $u(T) = 0$, we conclude that
$T/\mathfrak m_A T = 0$. Hence $T = 0$ by Nakayama's lemma, see
Algebra, Lemma \ref{algebra-lemma-NAK}. At this point we have
proved two out of the three assertions ($N$ is $A$-flat and
of finite presentation over $B$) and what is left is to show that
$u$ is universally injective.

\medskip\noindent
By Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}
it suffices to show that $N \otimes_A Q \to M \otimes_A Q$ is injective
for every finitely presented $A$-module $Q$. By
More on Algebra, Lemma
\ref{more-algebra-lemma-generalized-valuation-ring-modules}
we may assume $Q = A/(a)$ with $a \in \mathfrak m_A$ nonzero.
Thus it suffices to show that $N/aN \to M/aM$ is injective.
Let $x \in N$ with $u(x) \in aM$. By
Lemma \ref{lemma-flat-finite-type-local-valuation-ring-has-content}
we know that $x$ has a content ideal $I \subset A$. Since
$I$ is finitely generated
(More on Algebra, Lemma \ref{more-algebra-lemma-content-finitely-generated})
and $A$ is a valuation ring, we have $I = (b)$ for some $b$
(by Algebra, Lemma \ref{algebra-lemma-characterize-valuation-ring}).
By More on Algebra, Lemma \ref{more-algebra-lemma-equal-content}
the element $u(x)$ has content ideal $I$ as well.
Since $u(x) \in aM$ we see that $(b) \subset (a)$
by More on Algebra, Definition \ref{more-algebra-definition-content-ideal}.
Since $x \in bN$ we conclude $x \in aN$ as desired.
\end{proof}

\noindent
Consider the following situation
\begin{equation}
\label{equation-star}
\begin{matrix}
A \to B\text{ of finite presentation, }S \subset B
\text{ a multiplicative subset, and }\\
N\text{ a finitely presented }S^{-1}B\text{-module}
\end{matrix}
\end{equation}
In this situation a {\it pure spreadout} is an affine open
$U \subset \Spec(B)$ with $\Spec(S^{-1}B) \subset U$ and a
finitely presented $\mathcal{O}(U)$-module $N'$ extending $N$
such that $N'$ is $A$-projective and $N' \to N = S^{-1}N'$
is $A$-universally injective.

\medskip\noindent
In (\ref{equation-star}) if $A \to A_1$ is a ring map, then we
can base change: take $B_1 = B \otimes_A A_1$, let $S_1 \subset B_1$
be the image of $S$, and let $N_1 = N \otimes_A A_1$. This works
because $S_1^{-1}B_1 = S^{-1}B \otimes_A A_1$. We will use this
without further mention in the following.

\begin{lemma}
\label{lemma-properties-pure-spreadout}
In (\ref{equation-star}) if there exists a pure spreadout, then
\begin{enumerate}
\item elements of $N$ have content ideals in $A$, and
\item if $u : N \to M$ is a morphism to a flat $A$-module $M$
such that $N/\mathfrak m N \to M/\mathfrak m M$ is injective
for all maximal ideals $\mathfrak m$ of $A$, then $u$ is
$A$-universally injective.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose $U$, $N'$ as in the definition of a pure spreadout.
Any element $x' \in N'$ has a content ideal in $A$ because
$N'$ is $A$-projective (this can easily be seen directly, but
it also follows from More on Algebra, Lemma
\ref{more-algebra-lemma-content-exists-flat-Mittag-Leffler} and
Algebra, Example \ref{algebra-example-ML}).
Since $N' \to N$ is $A$-universally injective, we see that
the image $x \in N$ of any $x' \in N'$ has a content ideal in $A$
(it is the same as the content ideal of $x'$).
For a general $x \in N$ we choose $s \in S$ such that
$s x$ is in the image of $N' \to N$ and we use that $x$ and $sx$
have the same content ideal.

\medskip\noindent
Let $u : N \to M$ be as in (2). To show that $u$ is $A$-universally
injective, we may replace $A$ by a localization at a maximal ideal
(small detail omitted). Assume $A$ is local with maximal ideal $\mathfrak m$.
Pick $s \in S$ and consider the composition
$$
N' \to N \xrightarrow{1/s} N \xrightarrow{u} M
$$
Each of these maps is injective modulo $\mathfrak m$, hence the composition
is $A$-universally injective by
Lemma \ref{lemma-universally-injective-local}.
Since $N = \colim_{s \in S} (1/s)N'$ we conclude that $u$
is $A$-inversally injective as a colimit of universally injective maps.
\end{proof}

\begin{lemma}
\label{lemma-find-pure-spreadout}
In (\ref{equation-star}) for every $\mathfrak p \in \Spec(A)$
there is a finitely generated ideal $I \subset \mathfrak pA_\mathfrak p$
such that over $A_\mathfrak p/I$ we have a pure spreadout.
\end{lemma}

\begin{proof}
We may replace $A$ by $A_\mathfrak p$. Thus we may asume $A$ is
local and $\mathfrak p$ is the maximal ideal $\mathfrak m$ of $A$.
We may write $N = S^{-1}N'$ for some finitely presented $B$-module $N'$
by clearing denominators in a presentation of $N$ over $S^{-1}B$.
Since $B/\mathfrak m B$ is Noetherian, the kernel $K$ of
$N'/\mathfrak m N' \to N/\mathfrak m N$ is finitely generated.
Thus we can pick $s \in S$ such that $K$ is annihilated by $s$.
After replacing $B$ by $B_s$ which is allowed as it just means passing
to an affine open subscheme of $\Spec(B)$, we find that the elements of $S$
are injective on $N'/\mathfrak m N'$. At this point we choose
a local subring $A_0 \subset A$ essentially of finite type over $\mathbf{Z}$,
a finite type ring map $A_0 \to B_0$ such that $B = A \otimes_{A_0} B_0$,
and a finite $B_0$-module $N'_0$ such that
$N' = B \otimes_{B_0} N'_0 = A \otimes_{A_0} N'_0$.
We claim that $I = \mathfrak m_{A_0} A$ works.
Namely, we have
$$
N'/IN' = N'_0/\mathfrak m_{A_0} N'_0 \otimes_{\kappa_{A_0}} A/I
$$
which is free over $A/I$. Multiplication by the elements of $S$
is injective after dividing out by the maximal ideal, hence
$N'/IN' \to N/IN$ is universally injective for example by
Lemma \ref{lemma-invert-universally-injective}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-if-flat}
In (\ref{equation-star}) assume $N$ is $A$-flat, $M$ is a flat $A$-module,
and $u : N \to M$ is an $A$-module map such that
$u \otimes \text{id}_{\kappa(\mathfrak p)}$ is injective for all
$\mathfrak p \in \Spec(A)$. Then $u$ is $A$-universally injective. 
\end{lemma}

\begin{proof}
By Algebra, Lemma \ref{algebra-lemma-check-universally-injective-into-flat}
it suffices to check that $N/IN \to M/IM$ is injective for every
ideal $I \subset A$. After replacing $A$ by $A/I$ we see that it suffices
to prove that $u$ is injective.

\medskip\noindent
Proof that $u$ is injective. Let $x \in N$ be a nonzero element of the
kernel of $u$. Then there exists a weakly associated prime $\mathfrak p$
of the module $Ax$, see Algebra, Lemma \ref{algebra-lemma-weakly-ass-zero}.
Replacing $A$ by $A_\mathfrak p$ we may assume $A$ is local and
we find a nonzero element $y \in Ax$ whose annihilator has radical
equal to $\mathfrak m_A$, see
Algebra, Lemma \ref{algebra-lemma-weakly-ass-local}.
Thus $\text{Supp}(y) \subset \Spec(S^{-1}B)$ is nonempty and
contained in the closed fibre of $\Spec(S^{-1}B) \to \Spec(A)$.
Let $I \subset \mathfrak m_A$ be a
finitely generated ideal so that we have a pure spreadout over $A/I$, see
Lemma \ref{lemma-find-pure-spreadout}. Then $I^n y = 0$ for some $n$. Now
$y \in \text{Ann}_M(I^n) = \text{Ann}_A(I^n) \otimes_R N$ by flatness.
Thus, to get the desired contradiction, it suffices to show that
$$
\text{Ann}_A(I^n) \otimes_R N
\longrightarrow
\text{Ann}_A(I^n) \otimes_R M
$$
is injective. Since $N$ and $M$ are flat and since $\text{Ann}_A(I^n)$
is annihilated by $I^n$, it suffices to show that
$Q \otimes_A N \to Q \otimes_A M$ is injective for every $A$-module
$Q$ annihilated by $I$. This holds by our choice of $I$ and
Lemma \ref{lemma-properties-pure-spreadout} part (2).
\end{proof}

\begin{lemma}
\label{lemma-big-intersection-is-zero}
Let $A$ be a local domain. Let $S$ be a set of finitely generated ideals
of $A$. Assume that $S$ is closed under products and such that
$\bigcap_{I \in S} V(I)$ is the complement of the generic point of $\Spec(A)$.
Then $\bigcap_{I \in S} I = (0)$.
\end{lemma}

\begin{proof}
Let $f \in A$ be nonzero. Then $V(f) \subset \bigcup_{I \in S} V(I)$.
Since the constructible topology on $V(f)$ is quasi-compact
(Topology, Lemma \ref{topology-lemma-constructible-hausdorff-quasi-compact}
and
Algebra, Lemma \ref{algebra-lemma-spec-spectral})
we find that $V(f) \subset V(I_1) \cup \ldots \cup V(I_n)$
for some $I_j \in S$. Because $I_1 \ldots I_n \in S$ we see that
$V(f) \subset V(I)$ for some $I$. As $I$ is finitely generated
this implies that $I^m \subset (f)$ for some $m$ and since
$S$ is closed under products we see that $I \subset (f^2)$ for
some $I \in S$. Then it is not possible to have $f \in I$.
\end{proof}

\begin{lemma}
\label{lemma-closed-points-complement}
Let $A$ be a local ring. Let $I, J \subset A$ be ideals.
If $J$ is finitely generated and $I \subset J^n$ for all $n \geq 1$,
then $V(I)$ contains the closed points of $\Spec(A) \setminus V(J)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset A$ be a closed point of $\Spec(A) \setminus V(J)$.
We want to show that $I \subset \mathfrak p$. If not, then some $f \in I$
maps to a nonzero element of $A/\mathfrak p$. Note that
$V(J) \cap \Spec(A/\mathfrak p)$ is the set of non-generic points.
Hence by Lemma \ref{lemma-big-intersection-is-zero} applied
to the collection of ideals $J^nA/\mathfrak p$ we conclude that
the image of $f$ is zero in $A/\mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-make-smaller-flatness-ideal}
Let $A$ be a local ring. Let $I \subset A$ be an ideal.
Let $U \subset \Spec(A)$ be quasi-compact open.
Let $M$ be an $A$-module. Assume that
\begin{enumerate}
\item $M/IM$ is flat over $A/I$,
\item $M$ is flat over $U$,
\end{enumerate}
Then $M/I_2M$ is flat over $A/I_2$ where
$I_2 = \Ker(I \to \Gamma(U, I/I^2))$.
\end{lemma}

\begin{proof}
It suffices to show that
$M \otimes_A I/I_2 \to IM/I_2M$ is injective, see
Algebra, Lemma \ref{algebra-lemma-what-does-it-mean-again}.
This is true over $U$ by assumption (2). Thus it suffices to show
that $M \otimes_A I/I_2$ injects into its sections over $U$.
We have $M \otimes_A I/I_2 = M/IM \otimes_A I/I_2$ and
$M/IM$ is a filtered colimit of finite free $A/I$-modules
(Algebra, Theorem \ref{algebra-theorem-lazard}).
Hence it suffices to show that $I/I_2$ injects into its sections
over $U$, which follows from the construction of $I_2$.
\end{proof}

\begin{proposition}
\label{proposition-finite-type-injective-into-flat-mod-m}
Let $A \to B$ be a local ring homomorphism of local rings
which is essentially of finite type. Let $M$ be a flat $A$-module,
$N$ a finite $B$-module and $u : N \to M$ an $A$-module map such that
$\overline{u} : N/\mathfrak m_AN \to M/\mathfrak m_AM$ is injective.
Then $u$ is $A$-universally injective, $N$ is of finite presentation over
$B$, and $N$ is flat over $A$.
\end{proposition}

\begin{proof}
We may assume that $B$ is the localization of a finitely presented
$A$-algebra $B_0$ and that $N$ is the localization of a
finitely presented $B_0$-module $M_0$, see
Lemma \ref{lemma-reduce-finite-type-injective-into-flat-mod-m}.
By Lemma \ref{lemma-generic-flatness-stratification}
there exists a ``generic flatness stratification''
for $\widetilde{M_0}$ on $\Spec(B_0)$ over $\Spec(A)$.
Translating back to $N$ we find a sequence of closed subschemes
$$
S = \Spec(A) \supset S_0 \supset S_1 \supset \ldots \supset S_t = \emptyset
$$
with $S_i \subset S$ cut out by a finitely generated ideal of $A$
such that the pullback of $\widetilde{N}$ to
$\Spec(B) \times_S (S_i \setminus S_{i + 1})$ is flat over
$S_i \setminus S_{i + 1}$. We will prove the proposition by
induction on $t$ (the base case $t = 1$ will be proved in parallel
with the other steps). Let $\Spec(A/J_i)$ be the scheme theoretic
closure of $S_i \setminus S_{i + 1}$.

\medskip\noindent
{\bf Claim 1.} $N/J_iN$ is flat over $A/J_i$. This is immediate for
$i = t - 1$ and follows from the induction hypothesis for $i > 0$.
Thus we may assume $t > 1$, $S_{t - 1} \not = \emptyset$, and
$J_0 = 0$ and we have to prove that $N$ is flat. Let $J \subset A$
be the ideal defining $S_1$. By induction on $t$ again, we also
have flatness modulo powers of $J$. Let $A^h$ be the henselization of $A$
and let $B'$ be the localization of $B \otimes_A A^h$ at the maximal ideal
$\mathfrak m_B \otimes A^h + B \otimes \mathfrak m_{A^h}$. Then $B \to B'$
is faithfully flat. Set $N' = N \otimes_B B'$. Note that $N'$
is $A^h$-flat if and only if $N$ is $A$-flat. By
Theorem \ref{theorem-flattening-local} there is a smallest ideal
$I \subset A^h$ such that $N'/IN'$ is flat over $A^h/I$, and
$I$ is finitely generated. By the above $I \subset J^nA^h$ for
all $n \geq 1$. Let $S_i^h \subset \Spec(A^h)$ be the inverse image
of $S_i \subset \Spec(A)$. By Lemma \ref{lemma-closed-points-complement}
we see that $V(I)$ contains the closed points of $U = \Spec(A^h) - S_1^h$.
By construction $N'$ is $A^h$-flat over $U$.
By Lemma \ref{lemma-make-smaller-flatness-ideal} we see that $N'/I_2N'$
is flat over $A/I_2$, where
$I_2 = \Ker(I \to \Gamma(U, I/I^2))$. Hence $I = I_2$ by minimality
of $I$. This implies that $I = I^2$ locally on $U$, i.e.,
we have $I\mathcal{O}_{U, u} = (0)$ or $I\mathcal{O}_{U, u} = (1)$
for all $u \in U$. Since $V(I)$ contains the closed points of $U$
we see that $I = 0$ on $U$. Since $U \subset \Spec(A^h)$ is scheme
theoretically dense (because replaced $A$ by $A/J_0$ in the beginning
of this paragraph), we see that $I = 0$. Thus $N'$ is $A^h$-flat
and hence Claim 1 holds.

\medskip\noindent
We return to the situation as laid out before Claim 1. With
$A^h$ the henselization of $A$, with $B'$ the localization
of $B \otimes_A A^h$ at the maximal ideal
$\mathfrak m_B \otimes A^h + B \otimes \mathfrak m_{A^h}$, and with
$N' = N \otimes_B B'$ we now see that the flattening ideal $I \subset A^h$
of Theorem \ref{theorem-flattening-local} is nilpotent.
If $nil(A^h)$ denotes the ideal of nilpotent elements, then
$nil(A^h) = nil(A) A^h$
(More on Algebra, Lemma \ref{more-algebra-lemma-henselization-nil}).
Hence there exists a finitely generated
nilpotent ideal $I_0 \subset A$ such that $N/I_0N$ is flat over $A/I_0$.

\medskip\noindent
{\bf Claim 2.} For every prime ideal $\mathfrak p \subset A$
the map
$\kappa(\mathfrak p) \otimes_A N \to \kappa(\mathfrak p) \otimes_A M$
is injective. We say $\mathfrak p$ is bad it this is false.
Suppose that $C$ is a nonempty chain of bad primes and set
$\mathfrak p^* = \bigcup_{\mathfrak p \in C} \mathfrak p$.
By Lemma \ref{lemma-find-pure-spreadout}
there is a finitely generated ideal
$\mathfrak a \subset \mathfrak p^*A_{\mathfrak p^*}$
such that there is a pure spreadout over $V(\mathfrak a)$.
If $\mathfrak p^*$ were good, then it would follow from
Lemma \ref{lemma-properties-pure-spreadout}
that the points of $V(\mathfrak a)$ are good.
However, since $\mathfrak a$ is finitely generated and since
$\mathfrak p^*A_{\mathfrak p^*} = \bigcup_{\mathfrak p \in C}A_{\mathfrak p^*}$
we see that $V(\mathfrak a)$ contains a $\mathfrak p \in C$, contradiction.
Hence $\mathfrak p^*$ is bad. By Zorn's lemma, if there exists a
bad prime, there exists a maximal one, say $\mathfrak p$.
In other words, we may assume every $\mathfrak p' \supset \mathfrak p$,
$\mathfrak p' \not = \mathfrak p$ is good.
In this case we see that for every $f \in A$, $f \not \in \mathfrak p$
the map $u \otimes \text{id}_{A/(\mathfrak p + f)}$ is universally
injective, see Lemma \ref{lemma-universally-injective-if-flat}.
Thus it suffices to show that $N/\mathfrak p N$ is separated
for the topology defined by the submodules $f(N/\mathfrak pN)$.
Since $B \to B'$ is faithfully flat, it is enough to prove the
same for the module $N'/\mathfrak p N'$.
By Lemma \ref{lemma-flat-finite-type-local-colimit-free} and
More on Algebra, Lemma
\ref{more-algebra-lemma-content-exists-flat-Mittag-Leffler}
elements of $N'/\mathfrak pN'$ have content ideals in $A^h/\mathfrak pA^h$.
Thus it suffices to show that
$\bigcap_{f \in A, f \not \in \mathfrak p} f(A^h/\mathfrak p A^h) = 0$.
Then it suffices to show the same for
$A^h/\mathfrak q A^h$ for every prime $\mathfrak q \subset A^h$
minimal over $\mathfrak p A^h$. Because $A \to A^h$ is the henselization,
every $\mathfrak q$ contracts to $\mathfrak p$ and every
$\mathfrak q' \supset \mathfrak q$, $\mathfrak q' \not = \mathfrak q$
contracts to a prime $\mathfrak p'$ which strictly contains $\mathfrak p$.
Thus we get the vanishing of the intersections from
Lemma \ref{lemma-big-intersection-is-zero}.

\medskip\noindent
At this point we can put everything together. Namely, using
Claim 1 and Claim 2 we see that $N/I_0 N \to M/I_0M$ is
$A/I_0$-universally injective by
Lemma \ref{lemma-universally-injective-if-flat}.
Then the diagrams
$$
\xymatrix{
N \otimes_A (I_0^n/I_0^{n + 1}) \ar[r] \ar[d] &
M \otimes_A (I_0^n/I_0^{n + 1}) \ar@{=}[d] \\
I_0^n N /I_0^{n + 1} N \ar[r] &
I_0^n M /I_0^{n + 1} M
}
$$
show that the left vertical arrows are injective. Hence by
Algebra, Lemma \ref{algebra-lemma-what-does-it-mean-again}
we see that $N$ is flat. In a similar way the
universal injectivity of $u$ can be reduced (even without
proving flatness of $N$ first) to the one modulo $I_0$. This finishes
the proof.
\end{proof}


\section{Flat finite type modules, Part III}
\label{section-finite-type-flat-III}

\noindent
The following result is one of the main results of this chapter.

\begin{theorem}
\label{theorem-check-flatness-at-associated-points}
Let $f : X \to S$ be locally of finite type.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $x \in X$ with image $s \in S$.
The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is flat at $x$ over $S$, and
\item for every $x' \in \text{Ass}_{X_s}(\mathcal{F}_s)$ which
specializes to $x$ we have that $\mathcal{F}$ is flat at $x'$ over $S$.
\end{enumerate}
\end{theorem}

\begin{proof}
It is clear that (1) implies (2) as $\mathcal{F}_{x'}$ is a localization
of $\mathcal{F}_x$ for every point which specializes to $x$.
Set $A = \mathcal{O}_{S, s}$, $B = \mathcal{O}_{X, x}$ and
$N = \mathcal{F}_x$. Let $\Sigma \subset B$ be the multiplicative
subset of $B$ of elements which act as nonzerodivisors on $N/\mathfrak m_AN$.
Assumption (2) implies that $\Sigma^{-1}N$ is $A$-flat by the description
of $\Spec(\Sigma^{-1}N)$ in
Lemma \ref{lemma-homothety-spectrum}.
On the other hand, the map $N \to \Sigma^{-1}N$ is injective modulo
$\mathfrak m_A$ by construction. Hence applying
Lemma \ref{lemma-upstairs-finite-type-injective-into-flat-mod-m}
we win.
\end{proof}

\noindent
Now we apply this directly to obtain the following useful results.

\begin{lemma}
\label{lemma-check-along-closed-fibre}
Let $S$ be a local scheme with closed point $s$.
Let $f : X \to S$ be locally of finite type.
Let $\mathcal{F}$ be a finite type $\mathcal{O}_X$-module.
Assume that
\begin{enumerate}
\item every point of $\text{Ass}_{X/S}(\mathcal{F})$ specializes
to a point of the closed fibre $X_s$\footnote{For example this holds if
$f$ is finite type and $\mathcal{F}$ is pure along $X_s$, or
if $f$ is proper.},
\item $\mathcal{F}$ is flat over $S$ at every point of $X_s$.
\end{enumerate}
Then $\mathcal{F}$ is flat over $S$.
\end{lemma}

\begin{proof}
This is immediate from the fact that it suffices to check for
flatness at points of the relative assassin of $\mathcal{F}$
over $S$ by
Theorem \ref{theorem-check-flatness-at-associated-points}.
\end{proof}











\section{Universal flattening}
\label{section-flattening-final}

\noindent
If $f : X \to S$ is a proper, finitely presented morphism
of schemes then one can find a universal flattening of $f$.
In this section we discuss this and some of its variants.

\begin{lemma}
\label{lemma-free-at-generic-points-representable}
In Situation \ref{situation-free-at-generic-points}.
For each $p \geq 0$ the functor $H_p$
(\ref{equation-free-at-generic-points}) is representable
by a locally closed immersion $S_p \to S$. If $\mathcal{F}$
is of finite presentation, then $S_p \to S$ is of finite presentation.
\end{lemma}

\begin{proof}
For each $S$ we will prove the statement for all $p \geq 0$ concurrently.
The functor $H_p$ is a sheaf for the fppf topology by
Lemma \ref{lemma-free-at-generic-points}.
Hence combining
Descent, Lemma \ref{descent-lemma-descent-data-sheaves},
More on Morphisms, Lemma
\ref{more-morphisms-lemma-separated-locally-quasi-finite-morphisms-fppf-descend}
, and
Descent, Lemma \ref{descent-lemma-descending-fppf-property-immersion}
we see that the question is local for the \'etale topology on $S$.
In particular, the question is Zariski local on $S$.

\medskip\noindent
For $s \in S$ denote $\xi_s$ the unique generic point of the fibre $X_s$.
Note that for every $s \in S$ the restriction $\mathcal{F}_s$ of
$\mathcal{F}$ is locally free of some rank $p(s) \geq 0$ in some
neighbourhood of $\xi_s$. (As $X_s$ is irreducible
and smooth this follows from generic flatness for $\mathcal{F}_s$ over
$X_s$, see
Algebra, Lemma \ref{algebra-lemma-generic-flatness-Noetherian}
although this is overkill.) For future reference we note that
$$
p(s) =
\dim_{\kappa(\xi_s)}(
\mathcal{F}_{\xi_s} \otimes_{\mathcal{O}_{X, \xi_s}} \kappa(\xi_s)
).
$$
In particular $H_{p(s)}(s)$ is nonempty and $H_q(s)$ is empty
if $q \not = p(s)$.

\medskip\noindent
Let $U \subset X$ be an open subscheme.
As $f : X \to S$ is smooth, it is open.
It is immediate from (\ref{equation-free-at-generic-points})
that the functor $H_p$ for the pair $(f|_U : U \to f(U), \mathcal{F}|_U)$
and the functor $H_p$ for the pair
$(f|_{f^{-1}(f(U))}, \mathcal{F}|_{f^{-1}(f(U))})$
are the same. Hence to prove the existence of $S_p$ over $f(U)$ we may
always replace $X$ by $U$.

\medskip\noindent
Pick $s \in S$. There exists an affine open neighbourhood $U$
of $\xi_s$ such that $\mathcal{F}|_U$ can be generated by at most
$p(s)$ elements. By the arguments above we see that in order to prove
the statement for $H_{p(s)}$ in an neighbourhood of $s$ we may assume
that $\mathcal{F}$ is generated by $p(s)$ elements, i.e., that there exists
a surjection
$$
u : \mathcal{O}_X^{\oplus p(s)} \longrightarrow \mathcal{F}
$$
In this case it is clear that $H_{p(s)}$ is equal to $F_{iso}$
(\ref{equation-iso}) for the map $u$ (this follows immediately from
Lemma \ref{lemma-injectivity-map-source-flat-pure}
but also from
Lemma \ref{lemma-induction-step-fp}
after shrinking a bit more so that both $S$ and $X$ are affine.)
Thus we may apply
Theorem \ref{theorem-flattening-map}
to see that $H_{p(s)}$ is representable by a closed immersion in a
neighbourhood of $s$.

\medskip\noindent
The result follows formally from the above.
Namely, the arguments above show that locally on $S$ the function
$s \mapsto p(s)$ is bounded. Hence we may use induction
on $p = \max_{s \in S} p(s)$. The functor $H_p$ is representable
by a closed immersion $S_p \to S$ by the above. Replace $S$ by
$S \setminus S_p$ which drops the maximum by at least one and
we win by induction hypothesis.

\medskip\noindent
To see that $S_p \to S$ is of finite presentation if $\mathcal{F}$
is of finite presentation combine
Lemma \ref{lemma-free-at-generic-points} part (2)
with
Limits, Remark \ref{limits-remark-limit-preserving}.
\end{proof}

\begin{lemma}
\label{lemma-localize-flat-dimension-n}
In Situation \ref{situation-flat-dimension-n}.
Let $h : X' \to X$ be an \'etale morphism.
Set $\mathcal{F}' = h^*\mathcal{F}$ and $f' = f \circ h$.
Let $F_n'$ be (\ref{equation-flat-dimension-n})
associated to $(f' : X' \to S, \mathcal{F}')$.
Then $F_n$ is a subfunctor of $F_n'$ and if
$h(X') \supset \text{Ass}_{X/S}(\mathcal{F})$, then $F_n = F'_n$.
\end{lemma}

\begin{proof}
Let $T \to S$ be any morphism. Then $h_T : X'_T \to X_T$ is \'etale as a
base change of the \'etale morphism $g$. For $t \in T$ denote
$Z \subset X_t$ the set of points where $\mathcal{F}_T$ is not
flat over $T$, and similarly denote $Z' \subset X'_t$ the set of
points where $\mathcal{F}'_T$ is not flat over $T$. As
$\mathcal{F}'_T = h_T^*\mathcal{F}_T$ we see that
$Z' = h_t^{-1}(Z)$, see
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.
Hence $Z' \to Z$ is an \'etale morphism, so $\dim(Z') \leq \dim(Z)$
(for example by
Descent, Lemma \ref{descent-lemma-dimension-at-point-local}
or just because an \'etale morphism is smooth of relative dimension $0$).
This implies that $F_n \subset F_n'$.

\medskip\noindent
Finally, suppose that $h(X') \supset \text{Ass}_{X/S}(\mathcal{F})$
and that $T \to S$ is a morphism such that $F_n'(T)$ is nonempty, i.e.,
such that $\mathcal{F}'_T$ is flat in dimensions $\geq n$ over $T$.
Pick a point $t \in T$ and let $Z \subset X_t$ and $Z' \subset X'_t$
be as above. To get a contradiction assume that $\dim(Z) \geq n$.
Pick a generic point $\xi \in Z$ corresponding to a component
of dimension $\geq n$. Let $x \in \text{Ass}_{X_t}(\mathcal{F}_t)$
be a generalization of $\xi$. Then $x$ maps to a point of
$\text{Ass}_{X/S}(\mathcal{F})$ by
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin} and
Remark \ref{divisors-remark-base-change-relative-assassin}.
Thus we see that $x$ is in the image of $h_T$, say
$x = h_T(x')$ for some $x' \in X'_T$. But $x' \not \in Z'$
as $x \leadsto \xi$ and $\dim(Z') < n$. Hence $\mathcal{F}'_T$
is flat over $T$ at $x'$ which implies that $\mathcal{F}_T$ is flat
at $x$ over $T$ (by
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}).
Since this holds for every such $x$ we conclude
that $\mathcal{F}_T$ is flat over $T$ at $\xi$ by
Theorem \ref{theorem-check-flatness-at-associated-points}
which is the desired contradiction.
\end{proof}

\begin{lemma}
\label{lemma-compare-H-F}
Assume that $X \to S$ is a smooth morphism of affine schemes
with geometrically irreducible fibres of dimension $d$ and that
$\mathcal{F}$ is a quasi-coherent $\mathcal{O}_X$-module of finite
presentation. Then $F_d = \coprod_{p = 0, \ldots, c} H_p$
for some $c \geq 0$ with $F_d$ as in
(\ref{equation-flat-dimension-n}) and $H_p$ as in
(\ref{equation-free-at-generic-points}).
\end{lemma}

\begin{proof}
As $X$ is affine and $\mathcal{F}$ is quasi-coherent of finite presentation
we know that $\mathcal{F}$ can be generated by $c \geq 0$ elements.
Then $\dim_{\kappa(x)}(\mathcal{F}_x \otimes \kappa(x))$
in any point $x \in X$ never exceeds $c$. In particular $H_p = \emptyset$
for $p > c$. Moreover, note that there certainly is an inclusion
$\coprod H_p \to F_d$. Having said this the content
of the lemma is that, if a base change $\mathcal{F}_T$ is flat in
dimensions $\geq d$ over $T$ and if $t \in T$, then $\mathcal{F}_T$ is
free of some rank $r$ in an open neighbourhood $U \subset X_T$
of the unique generic point $\xi$ of $X_t$. Namely, then $H_r$
contains the image of $U$ which is an open neighbourhood of $t$.
The existence of $U$ follows from
More on Morphisms, Lemma
\ref{more-morphisms-lemma-flat-and-free-at-point-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-flat-dimension-n-representable}
In Situation \ref{situation-flat-dimension-n}.
Let $s \in S$ let $d \geq 0$. Assume
\begin{enumerate}
\item there exists a complete d\'evissage
of $\mathcal{F}/X/S$ over some point $s \in S$,
\item $X$ is of finite presentation over $S$,
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation, and
\item $\mathcal{F}$ is flat in dimensions $\geq d + 1$ over $S$.
\end{enumerate}
Then after possibly replacing $S$ by an open neighbourhood
of $s$ the functor $F_d$ (\ref{equation-flat-dimension-n})
is representable by a monomorphism $Z_d \to S$ of finite presentation.
\end{lemma}

\begin{proof}
A preliminary remark is that $X$, $S$ are affine schemes and that it
suffices to prove $F_d$ is representable by a closed subscheme on the
category of affine schemes over $S$. Hence throughout the proof of
the lemma we work in the category of affine schemes over $S$.

\medskip\noindent
Let $(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)_{k = 1, \ldots, n}$
be a complete d\'evissage of $\mathcal{F}/X/S$ over $s$, see
Definition \ref{definition-complete-devissage}.
We will use induction on the length $n$ of the d\'evissage.
Recall that $Y_k \to S$ is smooth with geometrically irreducible fibres, see
Definition \ref{definition-one-step-devissage}.
Let $d_k$ be the relative dimension of $Y_k$ over $S$.
Recall that $i_{k, *}\mathcal{G}_k = \Coker(\alpha_k)$ and
that $i_k$ is a closed immersion.
By the definitions referenced above we have
$d_1 = \dim(\text{Supp}(\mathcal{F}_s))$ and
$$
d_k = \dim(\text{Supp}(\Coker(\alpha_{k - 1})_s))
= \dim(\text{Supp}(\mathcal{G}_{k, s}))
$$
for $k = 2, \ldots, n$. It follows that $d_1 > d_2 > \ldots > d_n \geq 0$
because $\alpha_k$ is an isomorphism in the generic point of $(Y_k)_s$.

\medskip\noindent
Note that $i_1$ is a closed immersion and
$\mathcal{F} = i_{1, *}\mathcal{G}_1$.
Hence for any morphism of schemes $T \to S$ with $T$ affine,
we have $\mathcal{F}_T = i_{1, T, *}\mathcal{G}_{1, T}$ and
$i_{1, T}$ is still a closed immersion of schemes over $T$.
Thus $\mathcal{F}_T$ is flat in dimensions $\geq d$ over $T$
if and only if $\mathcal{G}_{1, T}$ is flat in dimensions $\geq d$ over $T$.
Because $\pi_1 : Z_1 \to Y_1$ is finite we see in the same manner that
$\mathcal{G}_{1, T}$ is flat in dimensions $\geq d$ over $T$
if and only if $\pi_{1, T, *}\mathcal{G}_{1, T}$ is flat in dimensions
$\geq d$ over $T$. The same arguments work for
``flat in dimensions $\geq d + 1$'' and we conclude in particular that
$\pi_{1, *}\mathcal{G}_1$ is flat over $S$ in dimensions $\geq d + 1$
by our assumption on $\mathcal{F}$.

\medskip\noindent
Suppose that $d_1 > d$. It follows from the discussion above that
in particular $\pi_{1, *}\mathcal{G}_1$ is flat over $S$ at
the generic point of $(Y_1)_s$. By
Lemma \ref{lemma-induction-step-fp}
we may replace $S$ by an affine neighbourhood of $s$ and assume that
$\alpha_1$ is $S$-universally injective. Because $\alpha_1$ is
$S$-universally injective, for any morphism $T \to S$ with $T$ affine,
we have a short exact sequence
$$
0 \to \mathcal{O}_{Y_{1, T}}^{\oplus r_1}
\to \pi_{1, T, *}\mathcal{G}_{1, T} \to \Coker(\alpha_1)_T \to 0
$$
and still the first arrow is $T$-universally injective. Hence the set
of points of $(Y_1)_T$ where $\pi_{1, T, *}\mathcal{G}_{1, T}$ is flat over
$T$ is the same as the set of points of $(Y_1)_T$ where
$\Coker(\alpha_1)_T$ is flat over $S$. In this way the question
reduces to the sheaf $\Coker(\alpha_1)$ which has a complete
d\'evissage of length $n - 1$ and we win by induction.

\medskip\noindent
If $d_1 < d$ then $F_d$ is represented by $S$ and we win.

\medskip\noindent
The last case is the case $d_1 = d$. This case follows from a combination of
Lemma \ref{lemma-compare-H-F}
and
Lemma \ref{lemma-free-at-generic-points-representable}.
\end{proof}

\begin{theorem}
\label{theorem-flat-dimension-n-representable}
In Situation \ref{situation-flat-dimension-n}.
Assume moreover that $f$ is of finite presentation, that
$\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation,
and that $\mathcal{F}$ is pure relative to $S$.
Then $F_n$ is representable by a monomorphism
$Z_n \to S$ of finite presentation.
\end{theorem}

\begin{proof}
The functor $F_n$ is a sheaf for the fppf topology by
Lemma \ref{lemma-flat-dimension-n}.
Hence combining
Descent, Lemma \ref{descent-lemma-descent-data-sheaves},
More on Morphisms, Lemma
\ref{more-morphisms-lemma-separated-locally-quasi-finite-morphisms-fppf-descend}
, and
Descent, Lemmas \ref{descent-lemma-descending-property-monomorphism} and
\ref{descent-lemma-descending-property-finite-presentation}
we see that the question is local for the \'etale topology on $S$.

\medskip\noindent
In particular the situation is local for the Zariski topology on $S$
and we may assume that $S$ is affine. In this case the dimension of the
fibres of $f$ is bounded above, hence we see that $F_n$ is representable
for $n$ large enough. Thus we may use descending induction on $n$.
Suppose that we know $F_{n + 1}$ is representable by a monomorphism
$Z_{n + 1} \to S$ of finite presentation. Consider the base change
$X_{n + 1} = Z_{n + 1} \times_S X$ and the pullback $\mathcal{F}_{n + 1}$
of $\mathcal{F}$ to $X_{n + 1}$. The morphism $Z_{n + 1} \to S$ is
quasi-finite as it is a monomorphism of finite presentation, hence
Lemma \ref{lemma-quasi-finite-base-change}
implies that $\mathcal{F}_{n + 1}$ is pure relative to $Z_{n + 1}$.
Since $F_n$ is a subfunctor of $F_{n + 1}$ we conclude that in order
to prove the result for $F_n$ it suffices to prove the result for the
corresponding functor for the situation
$\mathcal{F}_{n + 1}/X_{n + 1}/Z_{n + 1}$.
In this way we reduce to proving the result for $F_n$ in case
$S_{n + 1} = S$, i.e., we may assume that $\mathcal{F}$ is flat
in dimensions $\geq n + 1$ over $S$.

\medskip\noindent
Fix $n$ and assume $\mathcal{F}$ is flat in dimensions $\geq n + 1$
over $S$. To finish the proof we have to show that $F_n$ is representable
by a monomorphism $Z_n \to S$ of finite presentation.
Since the question is local in the \'etale topology on $S$ it suffices to
show that for every $s \in S$ there exists an elementary \'etale neighbourhood
$(S', s') \to (S, s)$ such that the result holds after base change to $S'$.
Thus by
Lemma \ref{lemma-existence-complete}
we may assume there exist \'etale morphisms $h_j : Y_j \to X$,
$j = 1, \ldots, m$ such that for each $i$ there exists a complete
d\'evissage of $\mathcal{F}_j/Y_j/S$ over $s$,
where $\mathcal{F}_j$ is the pullback of $\mathcal{F}$ to $Y_j$
and such that $X_s \subset \bigcup h_j(Y_j)$. Note that by
Lemma \ref{lemma-localize-flat-dimension-n}
the sheaves $\mathcal{F}_j$ are still flat over in
dimensions $\geq n + 1$ over $S$.
Set $W = \bigcup h_j(Y_j)$, which is a quasi-compact open of $X$.
As $\mathcal{F}$ is pure along $X_s$ we see that
$$
E = \{t \in S \mid \text{Ass}_{X_t}(\mathcal{F}_t) \subset W \}.
$$
contains all generalizations of $s$. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-relative-assassin-constructible}
$E$ is a constructible subset of $S$. We have seen that
$\Spec(\mathcal{O}_{S, s}) \subset E$. By
Morphisms, Lemma \ref{morphisms-lemma-constructible-containing-open}
we see that $E$ contains an open neighbourhood of $s$.
Hence after shrinking $S$ we may assume that $E = S$.
It follows from
Lemma \ref{lemma-localize-flat-dimension-n}
that it suffices to prove the lemma for the functor $F_n$ associated to
$X = \coprod Y_j$ and $\mathcal{F} = \coprod \mathcal{F}_j$.
If $F_{j, n}$ denotes the functor for $Y_j \to S$ and the sheaf
$\mathcal{F}_i$ we see that $F_n = \prod F_{j, n}$. Hence it suffices
to prove each $F_{j, n}$ is representable by some monomorphism
$Z_{j, n} \to S$ of finite presentation, since then
$$
Z_n = Z_{1, n} \times_S \ldots \times_S Z_{m, n}
$$
Thus we have reduced the theorem to the special case handled in
Lemma \ref{lemma-flat-dimension-n-representable}.
\end{proof}

\noindent
We make explicit what the theorem means in terms of universal
flattenings in the following lemma.

\begin{lemma}
\label{lemma-when-universal-flattening}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item If $f$ is of finite presentation, $\mathcal{F}$ is an
$\mathcal{O}_X$-module of finite presentation, and $\mathcal{F}$ is
pure relative to $S$, then there exists a universal flattening
$S' \to S$ of $\mathcal{F}$. Moreover $S' \to S$ is a monomorphism
of finite presentation.
\item If $f$ is of finite presentation and $X$ is pure relative to $S$,
then there exists a universal flattening $S' \to S$ of $X$.
Moreover $S' \to S$ is a monomorphism of finite presentation.
\item If $f$ is proper and of finite presentation and $\mathcal{F}$ is an
$\mathcal{O}_X$-module of finite presentation, then there exists a
universal flattening $S' \to S$ of $\mathcal{F}$. Moreover $S' \to S$ is
a monomorphism of finite presentation.
\item If $f$ is proper and of finite presentation
then there exists a universal flattening $S' \to S$ of $X$.
\end{enumerate}
\end{lemma}

\begin{proof}
These statements follow immediately from
Theorem \ref{theorem-flat-dimension-n-representable}
applied to $F_0 = F_{flat}$
and the fact that if $f$ is proper then $\mathcal{F}$ is automatically
pure over the base, see
Lemma \ref{lemma-proper-pure}.
\end{proof}







\section{Blowing up and flatness}
\label{section-blowup-flat}

\noindent
In this section we begin our discussion of results of the form: ``After a
blowup the strict transform becomes flat''. We will use the following
(more or less standard) notation in this section. If $X \to S$ is
a morphism of schemes, $\mathcal{F}$ is a quasi-coherent module
on $X$, and $T \to S$ is a morphism of schemes, then we denote
$\mathcal{F}_T$ the pullback of $\mathcal{F}$ to the base change
$X_T = X \times_S T$.

\begin{remark}
\label{remark-successive-blowups}
Let $S$ be a quasi-compact and quasi-separated scheme. Let $f : X \to S$
be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent module on $X$.
Let $U \subset S$ be a quasi-compact open subscheme. Given a $U$-admissible
blowup $S' \to S$ we denote $X'$ the strict transform of $X$ and $\mathcal{F}'$
the strict transform of $\mathcal{F}$ which we think of as a quasi-coherent
module on $X'$ (via Divisors, Lemma \ref{divisors-lemma-strict-transform}).
Let $P$ be a property of $\mathcal{F}/X/S$ which is stable under strict
transform (as above) for $U$-admissible blowups. The general problem in
this section is: Show (under auxiliary conditions on $\mathcal{F}/X/S$)
there exists a $U$-admissible blowup $S' \to S$
such that the strict transform $\mathcal{F}'/X'/S'$ has $P$.

\medskip\noindent
The general strategy will be to use that a composition of
$U$-admissible blowups is a $U$-admissible blowup, see
Divisors, Lemma \ref{divisors-lemma-composition-admissible-blowups}.
In fact, we will make use of the more precise
Divisors, Lemma \ref{divisors-lemma-composition-finite-type-blowups}
and combine it with
Divisors, Lemma \ref{divisors-lemma-strict-transform-composition-blowups}.
The result is that it suffices to find a sequence of $U$-admissible
blowups
$$
S = S_0 \leftarrow S_1 \leftarrow \ldots \leftarrow S_n
$$
such that, setting $\mathcal{F}_0 = \mathcal{F}$ and $X_0 = X$ and setting
$\mathcal{F}_i/X_i$ equal to the strict transform of
$\mathcal{F}_{i - 1}/X_{i - 1}$, we
arrive at $\mathcal{F}_n/X_n/S_n$ with property $P$.

\medskip\noindent
In particular, choose a finite type quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_S$ such that $V(\mathcal{I}) = S \setminus U$,
see Properties, Lemma \ref{properties-lemma-quasi-coherent-finite-type-ideals}.
Let $S' \to S$ be the blowup in $\mathcal{I}$ and let $E \subset S'$
be the exceptional divisor (Divisors, Lemma
\ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}).
Then we see that we've reduced the
problem to the case where there exists an effective Cartier divisor
$D \subset S$ whose support is $X \setminus U$. In particular we may
assume $U$ is scheme theoretically dense in $S$
(Divisors, Lemma \ref{divisors-lemma-complement-effective-Cartier-divisor}).

\medskip\noindent
Suppose that $P$ is local on $S$: If $S = \bigcup S_i$ is a finite open
covering by quasi-compact opens and $P$ holds for
$\mathcal{F}_{S_i}/X_{S_i}/S_i$ then $P$ holds for $\mathcal{F}/X/S$.
In this case the general problem above is local on $S$ as well, i.e.,
if given $s \in S$ we can find a quasi-compact open neighbourhood $W$ of $s$
such that the problem for $\mathcal{F}_W/X_W/W$ is solvable, then the
problem is solvable for $\mathcal{F}/X/S$. This follows from
Divisors, Lemmas \ref{divisors-lemma-extend-admissible-blowups} and
\ref{divisors-lemma-dominate-admissible-blowups}.
\end{remark}

\begin{lemma}
\label{lemma-helper-blowup-affine-space}
Let $R$ be a ring and let $f \in R$. Let $r, d \geq 0$ be integers.
Let $R \to S$ be a ring map and let $M$ be an $S$-module. Assume
\begin{enumerate}
\item $R \to S$ is of finite presentation and flat,
\item every fibre ring $S \otimes_R \kappa(\mathfrak p)$ is
geometrically integral over $R$,
\item $M$ is a finite $S$-module,
\item $M_f$ is a finitely presented $S_f$-module,
\item for all $\mathfrak p \in R$, $f \not \in \mathfrak p$ with
$\mathfrak q = \mathfrak pS$ the module $M_{\mathfrak q}$ is free
of rank $r$ over $S_\mathfrak q$.
\end{enumerate}
Then there exists a finitely generated ideal $I \subset R$ with
$V(f) = V(I)$ such that for all $a \in I$ with $R' = R[\frac{I}{a}]$
the quotient
$$
M' = (M \otimes_R R')/a\text{-power torsion}
$$
over $S' = S \otimes_R R'$ satisfies the following: for every prime
$\mathfrak p' \subset R'$ there exists a $g \in S'$,
$g \not \in \mathfrak p'S'$ such that $M'_g$ is a free $S'_g$-module
of rank $r$.
\end{lemma}

\begin{proof}
This lemma is a generalization of
More on Algebra, Lemma \ref{more-algebra-lemma-blowup-module};
we urge the reader to read that proof first.
Choose a surjection $S^{\oplus n} \to M$, which is possible by (1).
Choose a finite submodule $K \subset \Ker(S^{\oplus n} \to M)$
such that $S^{\oplus n}/K \to M$ becomes an isomorphism after inverting $f$.
This is possible by (4). Set $M_1 = S^{\oplus n}/K$ and suppose we can
prove the lemma for $M_1$. Say $I \subset R$ is the corresponding ideal.
Then for $a \in I$ the map
$$
M_1' = (M_1 \otimes_R R')/a\text{-power torsion}
\longrightarrow
M' = (M \otimes_R R')/a\text{-power torsion}
$$
is surjective. It is also an isomorphism after inverting $a$ in $R'$
as $R'_a = R_f$, see Algebra, Lemma \ref{algebra-lemma-blowup-in-principal}.
But $a$ is a nonzerodivisor on $M'_1$, whence the displayed map is an
isomorphism. Thus it suffices to prove the lemma in case $M$ is a finitely
presented $S$-module.

\medskip\noindent
Assume $M$ is a finitely presented $S$-module satisfying (3).
Then $J = \text{Fit}_r(M) \subset S$ is a finitely generated ideal.
By Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}
we can write $S$ as a direct summand of a free
$R$-module: $\bigoplus_{\alpha \in A} R = S \oplus C$.
For any element $h \in S$ writing $h = \sum a_\alpha$ in the
decomposition above, we say that the $a_\alpha$ are the coefficents of $h$.
Let $I' \subset R$ be the ideal of coefficients
of elements of $J$. Multiplication by an element of $S$ defines
an $R$-linear map $S \to S$, hence $I'$ is generated by the coefficients
of the generators of $J$, i.e., $I'$ is a finitely generated ideal.
We claim that $I = fI'$ works.

\medskip\noindent
We first check that $V(f) = V(I)$. The inclusion $V(f) \subset V(I)$ is
clear. Conversely, if $f \not \in \mathfrak p$, then
$\mathfrak q =  \mathfrak p S$ is not an element of $V(J)$ by
property (3) and the fact that formation of Fitting ideals commute with
base change
(More on Algebra, Lemma \ref{more-algebra-lemma-fitting-ideal-basics}).
Hence there is an
element of $J$ which does not map to zero in $S \otimes_R \kappa(\mathfrak p)$.
Thus there exists an element of $I'$ which is not contained in
$\mathfrak p$, so $\mathfrak p \not \in V(fI') = V(I)$.

\medskip\noindent
Let $a \in I$ and set $R' = R[\frac{I}{a}]$. We may write $a = fa'$
for some $a' \in I'$. By Algebra, Lemmas \ref{algebra-lemma-affine-blowup} and
\ref{algebra-lemma-blowup-add-principal} we see that $I' R' = a'R'$
and $a'$ is a nonzerodivisor in $R'$. Set $S' = S \otimes_S R'$.
Every element $g$ of $JS' = \text{Fit}_r(M \otimes_S S')$ can be
written as $g = \sum_\alpha c_\alpha$ for some $c_\alpha \in I'R'$.
Since $I'R' = a'R'$ we can write $c_\alpha = a'c'_\alpha$ for some
$c'_\alpha \in R'$ and $g = (\sum c'_\alpha)a' = g' a'$ in $S'$.
Moreover, there is an $g_0 \in J$ such that $a' = c_\alpha$
for some $\alpha$. For this element we have $g_0 = g'_0 a'$ in $S'$
where $g'_0$ is a unit in $S'$.
Let $\mathfrak p' \subset R'$ be
a prime ideal and $\mathfrak q' = \mathfrak p'S'$.
By the above we see that $JS'_{\mathfrak q'}$ is the
principal ideal generated by the nonzerodivisor $a'$.
It follows from More on Algebra, Lemma
\ref{more-algebra-lemma-principal-fitting-ideal}
that $M'_{\mathfrak q'}$ can be generated by $r$ elements.
Since $M'$ is finite, there exist $m_1, \ldots, m_r \in M'$ and
$g \in S'$, $g \not \in \mathfrak q'$ such that the corresponding map
$(S')^{\oplus r} \to M'$ becomes surjective after inverting $g$.

\medskip\noindent
Finally, consider the ideal $J' = \text{Fit}_{k - 1}(M')$.
Note that $J'S'_g$ is generated by the coefficients of relations between
$m_1, \ldots, m_r$ (compatibility of Fitting ideal with base change).
Thus it suffices to show that $J' = 0$, see
More on Algebra, Lemma
\ref{more-algebra-lemma-fitting-ideal-finite-locally-free}.
Since $R'_a = R_f$ (Algebra, Lemma \ref{algebra-lemma-blowup-in-principal})
and $M'_a = M_f$ we see from (3)
that $J'_a$ maps to zero in $S_{\mathfrak q''}$ for any prime
$\mathfrak q'' \subset S'$ of the form $\mathfrak q'' = \mathfrak p''S'$
where $\mathfrak p'' \subset R'_a$. Since
$S'_a \subset \prod_{\mathfrak q''\text{ as above}} S'_{\mathfrak q''}$
(as $(S'_a)_{\mathfrak p''} \subset S'_{\mathfrak q''}$ by
Lemma \ref{lemma-base-change-universally-flat})
we see that $J'R'_a = 0$. Since $a$ is a nonzerodivisor in $R'$ we
conclude that $J' = 0$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-flatten-module-pre}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent module on $X$.
Let $U \subset S$ be a quasi-compact open. Assume
\begin{enumerate}
\item $X \to S$ is affine, of finite presentation, flat,
geometrically integral fibres,
\item $\mathcal{F}$ is a module of finite type,
\item $\mathcal{F}_U$ is of finite presentation,
\item $\mathcal{F}$ is flat over $S$ at all generic points of
fibres lying over points of $U$.
\end{enumerate}
Then there exists a $U$-admissible blowup $S' \to S$
and an open subscheme $V \subset X_{S'}$
such that (a) the strict transform $\mathcal{F}'$ of $\mathcal{F}$
restricts to a finitely locally free $\mathcal{O}_V$-module and
(b) $V \to S'$ is surjective.
\end{lemma}

\begin{proof}
Given $\mathcal{F}/X/S$ and $U \subset S$ with hypotheses as
in the lemma, denote $P$ the property ``$\mathcal{F}$ is flat over $S$ at
all generic points of fibres''. It is clear that $P$ is preserved under
strict transform, see
Divisors, Lemma \ref{divisors-lemma-strict-transform-flat}
and Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
It is also clear that $P$ is local on $S$. Hence any and all observations
of Remark \ref{remark-successive-blowups} apply to the problem posed by
the lemma.

\medskip\noindent
Consider the function $r : U \to \mathbf{Z}_{\geq 0}$ which assigns to
$u \in U$ the integer
$$
r(u) = \dim_{\kappa(\xi_u)}(\mathcal{F}_{\xi_u} \otimes \kappa(\xi_u))
$$
where $\xi_u$ is the generic point of the fibre $X_u$.
By More on Morphisms, Lemma
\ref{more-morphisms-lemma-flat-and-free-at-point-fibre}
and the fact that the image of an open in $X_S$ in $S$ is open,
we see that $r(u)$ is locally constant. Accordingly
$U = U_0 \amalg U_1 \amalg \ldots \amalg U_c$ is a finite disjoint
union of open and closed subschemes where $r$ is constant with value
$i$ on $U_i$. By
Divisors, Lemma \ref{divisors-lemma-separate-disjoint-opens-by-blowing-up}
we can find a $U$-admissible blowup to decompose $S$ into
the disjoint union of two schemes, the first containing $U_0$ and
the second $U_1 \cup \ldots \cup U_c$. Repeating this $c - 1$
more times we may assume that $S$ is a disjoint union
$S = S_0 \amalg S_1 \amalg \ldots \amalg S_c$ with $U_i \subset S_i$.
Thus we may assume the function $r$ defined above is constant, say
with value $r$.

\medskip\noindent
By Remark \ref{remark-successive-blowups} we see that we may assume that
we have an effective Cartier divisor $D \subset S$ whose support is
$S \setminus U$. Another application of Remark \ref{remark-successive-blowups}
combined with
Divisors, Lemma \ref{divisors-lemma-characterize-effective-Cartier-divisor}
tells us we may assume that
$S = \Spec(R)$ and $D = \Spec(R/(f))$ for some nonzerodivisor
$f \in R$. This case is handled by
Lemma \ref{lemma-helper-blowup-affine-space}.
\end{proof}

\begin{lemma}
\label{lemma-trick-fitting-ideal}
Let $A \to C$ be a finite locally free ring map of rank $d$.
Let $h \in C$ be an element such that $C_h$ is \'etale over $A$.
Let $J \subset C$ be an ideal. Set $I = \text{Fit}_0(C/J)$ where we
think of $C/J$ as a finite $A$-module. Then $IC_h = JJ'$ for some ideal
$J' \subset C_h$. If $J$ is finitely generated so are $I$ and $J'$.
\end{lemma}

\begin{proof}
We will use basic properties of Fitting ideals, see
More on Algebra, Lemma \ref{more-algebra-lemma-fitting-ideal-basics}.
Then $IC$ is the Fitting ideal of $C/J \otimes_A C$.
Note that $C \to C \otimes_A C$, $c \mapsto 1 \otimes c$ has a section
(the multiplication map). By assumption $C \to C \otimes_A C$ is \'etale
at every prime in the image of $\Spec(C_h)$ under this section.
Hence the multiplication map $C \otimes_A C_h \to C_h$ is \'etale
in particular flat, see Algebra, Lemma \ref{algebra-lemma-map-between-etale}.
Hence there exists a $C_h$-algebra such that
$C \otimes_A C_h \cong C_h \oplus C'$ as $C_h$-algebras, see
Algebra, Lemma \ref{algebra-lemma-surjective-flat-finitely-presented}.
Thus $(C/J) \otimes_A C_h \cong (C_h/J_h) \oplus C'/I'$ as
$C_h$-modules for some ideal $I' \subset C'$.
Hence $IC_h = JJ'$ with $J' = \text{Fit}_0(C'/I')$ where we view
$C'/J'$ as a $C_h$-module.
\end{proof}

\begin{lemma}
\label{lemma-push-ideal}
Let $A \to B$ be an \'etale ring map. Let $a \in A$ be a nonzerodivisor.
Let $J \subset B$ be a finite type ideal with $V(J) \subset V(aB)$.
For every $\mathfrak q \subset B$ there exists a finite type ideal
$I \subset A$ with $V(I) \subset V(a)$ and
$g \in B$, $g \not \in \mathfrak q$ such that
$IB_g = JJ'$ for some finite type ideal $J' \subset B_g$.
\end{lemma}

\begin{proof}
We may replace $B$ by a principal localization at
an element $g \in B$, $g \not \in \mathfrak q$. Thus we may assume
that $B$ is standard \'etale, see
Algebra, Proposition \ref{algebra-proposition-etale-locally-standard}.
Thus we may assume $B$ is a localization
of $C = A[x]/(f)$ for some monic $f \in A[x]$ of some degree $d$.
Say $B = C_h$ for some $h \in C$. Choose elements $h_1, \ldots, h_n \in C$
which generate $J$
over $B$. The condition $V(J) \subset V(aB)$ signifies that
$a^m = \sum b_i h_i$ in $B$ for some large $m$. Set $h_{n + 1} = a^m$.
As in Lemma \ref{lemma-trick-fitting-ideal} we take
$I = \text{Fit}_0(C/(h_1, \ldots, h_{r + 1}))$.
Since the module $C/(h_1, \ldots, h_{r + 1})$
is annihilated by $a^m$ we see that $a^{dm} \in I$ which implies
that $V(I) \subset V(a)$.
\end{proof}

\begin{lemma}
\label{lemma-flatten-module-etale-localize}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent module on $X$.
Let $U \subset S$ be a quasi-compact open.
Assume there exist finitely many commutative diagrams
$$
\xymatrix{
& X_i \ar[r]_{j_i} \ar[d] & X \ar[d] \\
S_i^* \ar[r] & S_i \ar[r]^{e_i} & S
}
$$
where
\begin{enumerate}
\item $e_i : S_i \to S$ are quasi-compact \'etale morphisms and
$S = \bigcup e_i(S_i)$,
\item $j_i : X_i \to X$ are \'etale morphisms and
$X = \bigcup j_i(X_i)$,
\item $S^*_i \to S_i$ is an $e_i^{-1}(U)$-admissible blowup
such that the strict transform $\mathcal{F}_i^*$ of $j_i^*\mathcal{F}$
is flat over $S^*_i$.
\end{enumerate}
Then there exists a $U$-admissible blowup $S' \to S$ such that
the strict transform of $\mathcal{F}$ is flat over $S'$.
\end{lemma}

\begin{proof}
We claim that the hypotheses of the lemma are preserved under $U$-admissible
blowups. Namely, suppose $b : S' \to S$ is a $U$-admissible blowup in
the quasi-coherent sheaf of ideals $\mathcal{I}$. Moreover, let $S'_i \to S_i$
be the blowup in the quasi-coherent sheaf of ideals $\mathcal{J}_i$.
Then the collection of morphisms $e'_i : S'_i = S_i \times_S S' \to S'$
and $j'_i : X_i' = X_i \times_S S' \to X \times_S S'$ satisfy conditions
(1), (2), (3) for the strict transform $\mathcal{F}'$ of $\mathcal{F}$
relative to the blowup $S' \to S$. First, observe that $S_i'$ is the
blowup of $S_i$ in the pullback of $\mathcal{I}$, see
Divisors, Lemma \ref{divisors-lemma-flat-base-change-blowing-up}.
Second, consider the blowup
$S_i^{\prime *} \to S_i'$ of $S_i'$ in the pullback of the ideal
$\mathcal{J}_i$.
By Divisors, Lemma \ref{divisors-lemma-blowing-up-two-ideals}
we get a commutative diagram
$$
\xymatrix{
S_i^{\prime *} \ar[r] \ar[rd] \ar[d] & S'_i \ar[d] \\
S_i^* \ar[r] & S_i
}
$$
and all the morphisms in the diagram above are blowups. Hence by
Divisors, Lemmas \ref{divisors-lemma-strict-transform-flat} and
\ref{divisors-lemma-strict-transform-composition-blowups}
we see
\begin{align*}
& \text{ the strict transform of }(j'_i)^*\mathcal{F}'\text{ under }
S_i^{\prime *} \to S_i' \\
= &
\text{ the strict transform of }j_i^*\mathcal{F}\text{ under }
S_i^{\prime *} \to S_i \\
= &
\text{ the strict transform of }\mathcal{F}_i'\text{ under }
S_i^{\prime *} \to S_i' \\
= &
\text{ the pullback of }\mathcal{F}_i^*\text{ via }
X_i \times_{S_i} S_i^{\prime *} \to X_i
\end{align*}
which is therefore flat over $S_i^{\prime *}$
(Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}).
Having said this, we see that all observations of
Remark \ref{remark-successive-blowups} apply to the
problem of finding a $U$-admissible blowup such that the
strict transform of $\mathcal{F}$ becomes flat over the base
under assumptions as in the lemma. In particular, we may assume
that $S \setminus U$ is the support of an effective Cartier divisor
$D \subset S$. Another application of Remark \ref{remark-successive-blowups}
combined with
Divisors, Lemma \ref{divisors-lemma-characterize-effective-Cartier-divisor}
shows we may assume that $S = \Spec(A)$ and $D = \Spec(A/(a))$
for some nonzerodivisor $a \in A$.

\medskip\noindent
Pick an $i$ and $s \in S_i$. Lemma \ref{lemma-push-ideal}
implies we can find an open neighbourhood $s \in W_i \subset S_i$
and a finite type quasi-coherent ideal $\mathcal{I} \subset \mathcal{O}_S$
such that $\mathcal{I} \cdot \mathcal{O}_{W_i} = \mathcal{J}_i \mathcal{J}'_i$
for some finite type quasi-coherent ideal
$\mathcal{J}'_i \subset \mathcal{O}_{W_i}$
and such that $V(\mathcal{I}) \subset V(a) = S \setminus U$.
Since $S_i$ is quasi-compact we can replace $S_i$ by a finite collection
$W_1, \ldots, W_n$ of these opens and assume that for each $i$ there exists
a quasi-coherent sheaf of ideals $\mathcal{I}_i \subset \mathcal{O}_S$ such
that $\mathcal{I}_i \cdot \mathcal{O}_{S_i} = \mathcal{J}_i \mathcal{J}'_i$
for some finite type quasi-coherent ideal
$\mathcal{J}'_i \subset \mathcal{O}_{S_i}$.
As in the discussion of the first paragraph of the proof, consider the
blowup $S'$ of $S$ in the product $\mathcal{I}_1 \ldots \mathcal{I}_n$
(this blowup is $U$-admissible by construction). The base change of $S' \to S$
to $S_i$ is the blowup in
$$
\mathcal{J}_i \cdot
\mathcal{J}'_i \mathcal{I}_1 \ldots \hat{\mathcal{I}_i} \ldots \mathcal{I}_n
$$
which factors through the given blowup $S_i^* \to S_i$
(Divisors, Lemma \ref{divisors-lemma-blowing-up-two-ideals}). In the notation
of the diagram above this means that $S_i^{\prime *} = S_i'$. Hence
after replacing $S$ by $S'$ we arrive in the situation that
$j_i^*\mathcal{F}$ is flat over $S_i$. Hence $j_i^*\mathcal{F}$ is flat
over $S$, see
Lemma \ref{lemma-etale-flat-up-down}.
By Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}
we see that $\mathcal{F}$ is flat over $S$.
\end{proof}

\begin{theorem}
\label{theorem-flatten-module}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $X$ be a scheme over $S$.
Let $\mathcal{F}$ be a quasi-coherent module on $X$.
Let $U \subset S$ be a quasi-compact open. Assume
\begin{enumerate}
\item $X$ is quasi-compact,
\item $X$ is locally of finite presentation over $S$,
\item $\mathcal{F}$ is a module of finite type,
\item $\mathcal{F}_U$ is of finite presentation, and
\item $\mathcal{F}_U$ is flat over $U$.
\end{enumerate}
Then there exists a $U$-admissible blowup $S' \to S$ such that the
strict transform $\mathcal{F}'$ of $\mathcal{F}$ is an
$\mathcal{O}_{X \times_S S'}$-module of finite presentation and
flat over $S'$.
\end{theorem}

\begin{proof}
We first prove that we can find a $U$-admissible blowup such that the
strict transform is flat. The question is \'etale local on the source
and the target, see
Lemma \ref{lemma-flatten-module-etale-localize} for a precise statement.
In particular, we may assume that $S = \Spec(R)$ and $X = \Spec(A)$
are affine. For $s \in S$ write $\mathcal{F}_s = \mathcal{F}|_{X_s}$
(pullback of $\mathcal{F}$ to the fibre). As $X \to S$ is of finite type
$d = \max_{s \in S} \dim(\text{Supp}(\mathcal{F}_s))$
is an integer. We will do induction on $d$.

\medskip\noindent
Let $x \in X$ be a point of $X$ lying over $s \in S$ with
$\dim_x(\text{Supp}(\mathcal{F}_s)) = d$.
Apply Lemma \ref{lemma-elementary-devissage} to get
$g : X' \to X$, $e : S' \to S$, $i : Z' \to X'$, and $\pi : Z' \to Y'$.
Observe that $Y' \to S'$ is
a smooth morphism of affines with geometrically irreducible fibres
of dimension $d$. Because the problem is \'etale local it suffices
to prove the theorem for $g^*\mathcal{F}/X'/S'$. Because $i : Z' \to X'$
is a closed immersion of finite presentation (and since strict transform
commutes with affine pushforward, see
Divisors, Lemma \ref{divisors-lemma-strict-transform-affine})
it suffices to prove the flattening result for $\mathcal{G}$.
Since $\pi$ is finite (hence also affine) it suffices to prove the
flattening result for $\pi_*\mathcal{G}/Y'/S'$. Thus we may assume
that $X \to S$ is a smooth morphism of affines with geometrically
irreducible fibres of dimension $d$.

\medskip\noindent
Next, we apply a blow up as in Lemma \ref{lemma-flatten-module-pre}.
Doing so we reach the situation where there exists an
open $V \subset X$ surjecting onto $S$ such that $\mathcal{F}|_V$
is finite locally free. Let $\xi \in X$ be the generic point of $X_s$. Let
$r = \dim_{\kappa(\xi)} \mathcal{F}_\xi \otimes \kappa(\xi)$.
Choose a map $\alpha : \mathcal{O}_X^{\oplus r} \to \mathcal{F}$
which induces an isomorphism
$\kappa(\xi)^{\oplus r} \to \mathcal{F}_\xi \otimes \kappa(\xi)$.
Because $\mathcal{F}$ is locally free over $V$ we find an open neighbourhood
$W$ of $\xi$ where $\alpha$ is an isomorphism. Shrink $S$ to an affine open
neighbourhood of $s$ such that $W \to S$ is surjective. Say $\mathcal{F}$
is the quasi-coherent module associated to the $A$-module $N$. Since
$\mathcal{F}$ is flat over $S$ at all generic points of fibres
(in fact at all points of $W$), we see that
$$
\alpha_\mathfrak p : A_\mathfrak p^{\oplus r} \to N_\mathfrak p
$$
is universally injective for all primes $\mathfrak p$ of $R$, see
Lemma \ref{lemma-induction-step}. Hence $\alpha$ is universally injective,
see Algebra, Lemma \ref{algebra-lemma-universally-injective-check-stalks}.
Set $\mathcal{H} = \Coker(\alpha)$.
By Divisors, Lemma \ref{divisors-lemma-strict-transform-universally-injective}
we see that, given a $U$-admissible blowup $S' \to S$
the strict transforms of $\mathcal{F}'$ and $\mathcal{H}'$
fit into an exact sequence
$$
0 \to \mathcal{O}_{X \times_S S'}^{\oplus r} \to \mathcal{F}'
\to \mathcal{H}' \to 0
$$
Hence Lemma \ref{lemma-induction-step} also shows that $\mathcal{F}'$
is flat at a point $x'$ if and only if
$\mathcal{H}'$ is flat at that point. In particular $\mathcal{H}_U$ is
flat over $U$ and $\mathcal{H}_U$ is a module of finite presentation.
We may apply the induction hypothesis to $\mathcal{H}$ to see that
there exists a $U$-admissible blowup such that the strict transform
$\mathcal{H}'$ is flat as desired.

\medskip\noindent
To finish the proof of the theorem we still have to show that $\mathcal{F}'$
is a module of finite presentation (after possibly another
$U$-admissible blowup). This follows from
Lemma \ref{lemma-flat-finite-type-finitely-presented-over-dense-open}
as we can assume $U \subset S$ is scheme theoretically dense (see
third paragraph of Remark \ref{remark-successive-blowups}).
This finishes the proof of the theorem.
\end{proof}





\section{Applications}
\label{section-applications}

\noindent
In this section we apply some of the results above.

\begin{lemma}
\label{lemma-flat-after-blowing-up}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $X$ be a scheme over $S$.
Let $U \subset S$ be a quasi-compact open.
Assume
\begin{enumerate}
\item $X \to S$ is of finite type and quasi-separated, and
\item $X_U \to U$ is flat and locally of finite presentation.
\end{enumerate}
Then there exists a $U$-admissible blowup $S' \to S$ such that
the strict transform of $X$ is flat and of finite presentation
over $S'$.
\end{lemma}

\begin{proof}
Since $X \to S$ is quasi-compact and quasi-separated by assumption,
the strict transform of $X$ with respect to a blowing up $S' \to S$
is also quasi-compact and quasi-separated. Hence to prove the lemma
it suffices to find a $U$-admissible blowup such that the strict
transform is flat and locally of finite presentation.
Let $X = W_1 \cup \ldots \cup W_n$ be a finite affine open covering.
If we can find a $U$-admissible blowup $S_i \to S$ such that the
strict transform of $W_i$ is flat and locally of finite presentation,
then there exists a $U$-admissble blowing up $S' \to S$ dominating
all $S_i \to S$ which does the job (see
Divisors, Lemma \ref{divisors-lemma-dominate-admissible-blowups};
see also Remark \ref{remark-successive-blowups}).
Hence we may assume $X$ is affine.

\medskip\noindent
Assume $X$ is affine. By
Morphisms, Lemma \ref{morphisms-lemma-quasi-affine-finite-type-over-S}
we can choose an immersion $j : X \to \mathbf{A}^n_S$ over $S$.
Let $V \subset \mathbf{A}^n_S$ be a quasi-compact open subscheme
such that $j$ induces a closed immersion $i : X \to V$ over $S$. Apply
Theorem \ref{theorem-flatten-module}
to $V \to S$ and the quasi-coherent module $i_*\mathcal{O}_X$
to obtain a $U$-admissible blowup $S' \to S$ such that the strict
transform of $i_*\mathcal{O}_X$ is flat over $S'$ and of finite presentation
over $\mathcal{O}_{V \times_S S'}$. Let $X'$ be the strict transform
of $X$ with respect to $S' \to S$. Let $i' : X' \to V \times_S S'$
be the induced morphism.
Since taking strict transform commutes with pushforward along affine
morphisms (Divisors, Lemma \ref{divisors-lemma-strict-transform-affine}),
we see that $i'_*\mathcal{O}_{X'}$ is flat over $S$ and of
finite presentation as a $\mathcal{O}_{V \times_S S'}$-module.
This implies the lemma.
\end{proof}

\begin{lemma}
\label{lemma-finite-after-blowing-up}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $X$ be a scheme over $S$.
Let $U \subset S$ be a quasi-compact open.
Assume
\begin{enumerate}
\item $X \to S$ is proper, and
\item $X_U \to U$ is finite locally free.
\end{enumerate}
Then there exists a $U$-admissible blowup $S' \to S$ such that
the strict transform of $X$ is finite locally free over $S'$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-after-blowing-up} we may assume that
$X \to S$ is flat and of finite presentation. After replacing
$S$ by a $U$-admissible blow up if necessary, we may assume
that $U \subset S$ is scheme theoretically dense. Then $f$ is
finite by Lemma \ref{lemma-proper-flat-finite-over-dense-open}.
Hence $f$ is finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
\end{proof}

\begin{lemma}
\label{lemma-zariski-after-blowup}
Let $\varphi : X \to S$ be a separated morphism of finite type with
$S$ quasi-compact and quasi-separated. Let $U \subset S$ be a
quasi-compact open such that $\varphi^{-1}U \to U$ is an isomorphism.
Then there exists a $U$-admissible blowup $S' \to S$ such that
the strict transform $X'$ of $X$ is isomorphic to an open subscheme
of $S'$.
\end{lemma}

\begin{proof}
The discussion in Remark \ref{remark-successive-blowups} applies.
Thus we may do a first $U$-admissible blowup and assume the complement
$S \setminus U$ is the support of an effective Cartier divisor $D$.
In particular $U$ is scheme theoretically dense in $S$.
Next, we do another $U$-admissible blowup to get to the situation where
$X \to S$ is flat and of finite presentation, see
Lemma \ref{lemma-flat-after-blowing-up}.
In this case the result follows from Lemma \ref{lemma-zariski}.
\end{proof}

\noindent
The following lemma says that a proper modification can be dominated
by a blowup.

\begin{lemma}
\label{lemma-dominate-modification-by-blowup}
Let $\varphi : X \to S$ be a proper morphism with
$S$ quasi-compact and quasi-separated. Let $U \subset S$ be a
quasi-compact open such that $\varphi^{-1}U \to U$ is an isomorphism.
Then there exists a $U$-admissible blowup $S' \to S$
which dominates $X$, i.e., such that there exists a factorization
$S' \to X \to S$ of the blowup morphism.
\end{lemma}

\begin{proof}
The discussion in Remark \ref{remark-successive-blowups} applies.
Thus we may do a first $U$-admissible blowup and assume the complement
$S \setminus U$ is the support of an effective Cartier divisor $D$.
In particular $U$ is scheme theoretically dense in $S$.
Choose another $U$-admissible blowup $S' \to S$ such that the strict
transform $X'$ of $X$ is an open subscheme of $S'$, see
Lemma \ref{lemma-zariski-after-blowup}.
Since $X' \to S'$ is proper, and
$U \subset S'$ is dense, we see that $X' = S'$. Some details omitted.
\end{proof}















\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
